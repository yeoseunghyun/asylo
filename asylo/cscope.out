cscope 15 $HOME/asylo/sdk/asylo -q 0000012026 0004102622
	@../asylo/bazel/application_wrapper/application_wrapper.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

27 
mes§ge
 
	gCommªdLšeArgs
 {

29 
»³©ed
 
¡ršg
 
	g¬gum’ts
 = 1;

32 
ex‹nd
 
	gEnşaveCÚfig
 {

34 
İtiÚ®
 
CommªdLšeArgs
 
	gcommªd_lše_¬gs
 = 215413541;

37 
ex‹nd
 
	gEnşaveOuut
 {

39 
İtiÚ®
 
št64
 
	gmaš_»tuº_v®ue
 = 215413541;

	@../asylo/bazel/test_shim_enclave.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

24 
mes§ge
 
	gTe¡ShimEnşaveCÚfig
 {

26 
İtiÚ®
 
¡ršg
 
	gouut_fe
 = 1;

28 
İtiÚ®
 
¡ršg
 
	g‹¡_tmpdœ
 = 2;

30 
İtiÚ®
 
boŞ
 
	g‹¡_š_š™Ÿlize
 = 3;

33 
ex‹nd
 
	gEnşaveCÚfig
 {

34 
İtiÚ®
 
Te¡ShimEnşaveCÚfig
 
	g‹¡_shim_’şave_cÚfig
 = 190514714;

	@../asylo/crypto/algorithms.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	eHashAlgÜ™hm
 {

22 
	mUNKNOWN_HASH_ALGORITHM
 = 0;

25 
	mSHA224
 = 1;

26 
	mSHA256
 = 2;

27 
	mSHA384
 = 3;

28 
	mSHA512
 = 4;

31 
	eA—dScheme
 {

32 
	mUNKNOWN_AEAD_SCHEME
 = 0;

34 
	mAES128_GCM
 = 1;

35 
	mAES256_GCM
 = 2;

37 
	mAES128_GCM_SIV
 = 3;

38 
	mAES256_GCM_SIV
 = 4;

41 
	eSigÇtu»Scheme
 {

42 
	mUNKNOWN_SIGNATURE_SCHEME
 = 0;

44 
	mECDSA_P256_SHA256
 = 1;

47 
	eAsymm‘ricEnüy±iÚScheme
 {

48 
	mUNKNOWN_ASYMMETRIC_ENCRYPTION_SCHEME
 = 0;

50 
	mRSA2048_OAEP
 = 1;

51 
	mRSA3072_OAEP
 = 2;

54 
	eAsymm‘ricKeyEncodšg
 {

55 
	mUNKNOWN_ASYMMETRIC_KEY_ENCODING
 = 0;

57 
	mASYMMETRIC_KEY_PEM
 = 1;

58 
	mASYMMETRIC_KEY_DER
 = 2;

	@../asylo/crypto/certificate.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

22 
mes§ge
 
	gC”tifiÿ‹SignšgReque¡
 {

24 
	eC”tifiÿ‹SignšgReque¡FÜm©
 {

25 
	gUNKNOWN
 = 0;

28 
	gPKCS10_DER
 = 1;

31 
	gPKCS10_PEM
 = 2;

35 
İtiÚ®
 
C”tifiÿ‹SignšgReque¡FÜm©
 
	gfÜm©
 = 1;

38 
İtiÚ®
 
by‹s
 
	gd©a
 = 2;

42 
mes§ge
 
	gC”tifiÿ‹
 {

44 
	eC”tifiÿ‹FÜm©
 {

45 
	gUNKNOWN
 = 0;

48 
	gX509_DER
 = 1;

51 
	gX509_PEM
 = 2;

55 
İtiÚ®
 
C”tifiÿ‹FÜm©
 
	gfÜm©
 = 1;

58 
İtiÚ®
 
by‹s
 
	gd©a
 = 2;

77 
mes§ge
 
	gC”tifiÿ‹Chaš
 {

79 
»³©ed
 
C”tifiÿ‹
 
	gû¹ifiÿ‹s
 = 1;

83 
mes§ge
 
	gC”tifiÿ‹RevoÿtiÚLi¡
 {

85 
	eC”tifiÿ‹RevoÿtiÚLi¡FÜm©
 {

86 
	gUNKNOWN
 = 0;

89 
	gX509_DER
 = 1;

92 
	gX509_PEM
 = 2;

96 
İtiÚ®
 
C”tifiÿ‹RevoÿtiÚLi¡FÜm©
 
	gfÜm©
 = 1;

99 
İtiÚ®
 
by‹s
 
	gd©a
 = 2;

	@../asylo/crypto/keys.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/crypto/algorithms.proto";

24 
mes§ge
 
	gAsymm‘ricEnüy±iÚKeyPrÙo
 {

25 
	eKeyTy³
 {

26 
	gUNKNOWN
 = 0;

27 
	gENCRYPTION_KEY
 = 1;

28 
	gDECRYPTION_KEY
 = 2;

32 
İtiÚ®
 
KeyTy³
 
	gkey_ty³
 = 1;

35 
İtiÚ®
 
Asymm‘ricEnüy±iÚScheme
 
	g’üy±iÚ_scheme
 = 2;

38 
İtiÚ®
 
Asymm‘ricKeyEncodšg
 
	g’codšg
 = 3;

41 
İtiÚ®
 
by‹s
 
	gkey
 = 4;

45 
mes§ge
 
	gAsymm‘ricSignšgKeyPrÙo
 {

46 
	eKeyTy³
 {

47 
	gUNKNOWN
 = 0;

48 
	gSIGNING_KEY
 = 1;

49 
	gVERIFYING_KEY
 = 2;

53 
İtiÚ®
 
KeyTy³
 
	gkey_ty³
 = 1;

56 
İtiÚ®
 
SigÇtu»Scheme
 
	gsigÇtu»_scheme
 = 2;

59 
İtiÚ®
 
Asymm‘ricKeyEncodšg
 
	g’codšg
 = 3;

62 
İtiÚ®
 
by‹s
 
	gkey
 = 4;

	@../asylo/daemon/identity/attestation_domain_service.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
mes§ge
 
	gG‘A‰e¡©iÚDomašReque¡
 {

25 
mes§ge
 
	gG‘A‰e¡©iÚDomašRe¥Ú£
 {

27 
İtiÚ®
 
by‹s
 
	g©‹¡©iÚ_domaš
 = 1;

30 
£rviû
 
	gA‰e¡©iÚDomašS”viû
 {

33 
½c
 
G‘A‰e¡©iÚDomaš
(
G‘A‰e¡©iÚDomašReque¡
)

34 
»tuºs
 (
G‘A‰e¡©iÚDomašRe¥Ú£
) {}

	@../asylo/enclave.proto

17 
	gsyÁax
 = "proto2";

28 
·ckage
 
	gasylo
;

30 
	gimpÜt
 "asylo/identity/enclave_assertion_authority_config.proto";

31 
	gimpÜt
 "asylo/util/status.proto";

35 
mes§ge
 
	gHo¡CÚfig
 {

37 
İtiÚ®
 
¡ršg
 
	gloÿl_©‹¡©iÚ_domaš
 = 1;

42 
mes§ge
 
	gEnvœÚm’tV¬ŸbË
 {

44 
İtiÚ®
 
¡ršg
 
	gÇme
 = 1;

50 
İtiÚ®
 
¡ršg
 
	gv®ue
 = 2;

54 
mes§ge
 
	gLoggšgCÚfig
 {

57 
İtiÚ®
 
št32
 
	gvlog_Ëv–
 = 1 [ = 0];

60 
İtiÚ®
 
¡ršg
 
	glog_dœeùÜy
 = 2;

67 
mes§ge
 
	gEnşaveCÚfig
 {

70 
İtiÚ®
 
št32
 
	g¡dš_fd
 = 3 [ = 0];

74 
İtiÚ®
 
št32
 
	g¡dout_fd
 = 4 [ = 1];

78 
İtiÚ®
 
št32
 
	g¡d”r_fd
 = 5 [ = 2];

81 
İtiÚ®
 
¡ršg
 
	gho¡_Çme
 = 6;

84 
İtiÚ®
 
¡ršg
 
	gcu¼’t_wÜkšg_dœeùÜy
 = 7;

88 
İtiÚ®
 
Ho¡CÚfig
 
	gho¡_cÚfig
 = 8;

93 
»³©ed
 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
	g’şave_as£¹iÚ_authÜ™y_cÚfigs
 =

97 
»³©ed
 
EnvœÚm’tV¬ŸbË
 
	g’vœÚm’t_v¬ŸbËs
 = 10;

100 
İtiÚ®
 
LoggšgCÚfig
 
	gloggšg_cÚfig
 = 11;

104 
İtiÚ®
 
boŞ
 
	g’abË_fÜk
 = 12 [ = 
çl£
];

107 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

111 
mes§ge
 
	gEnşaveIÅut
 {

113 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

117 
mes§ge
 
	gEnşaveFš®
 {

119 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

123 
mes§ge
 
	gEnşaveSigÇl
 {

125 
İtiÚ®
 
št32
 
	gsignum
 = 1;

129 
İtiÚ®
 
št32
 
	gcode
 = 2;

133 
»³©ed
 
ušt64
 
	gg»gs
 = 3;

139 
mes§ge
 
	gEnşaveOuut
 {

142 
İtiÚ®
 
StusPrÙo
 
	g¡©us
 = 1;

145 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

	@../asylo/examples/grpc_server/grpc_server_config.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gexam¶es
.
	gg½c_£rv”
;

21 
	gimpÜt
 "asylo/enclave.proto";

23 
ex‹nd
 
	gasylo
.
	gEnşaveCÚfig
 {

26 
İtiÚ®
 
¡ršg
 
	g£rv”_add»ss
 = 205739939;

30 
İtiÚ®
 
št32
 
	g£rv”_max_liãtime
 = 225604125;

33 
İtiÚ®
 
št32
 
	gpÜt
 = 253106740;

	@../asylo/examples/grpc_server/translator_server.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gexam¶es
.
	gg½c_£rv”
;

22 
mes§ge
 
	gShutdownReque¡
 {}

25 
mes§ge
 
	gShutdownRe¥Ú£
 {}

28 
mes§ge
 
	gG‘T¿n¦©iÚReque¡
 {

29 
İtiÚ®
 
¡ršg
 
	gšput_wÜd
 = 1;

34 
mes§ge
 
	gG‘T¿n¦©iÚRe¥Ú£
 {

35 
İtiÚ®
 
¡ršg
 
	gŒª¦©ed_wÜd
 = 1;

38 
£rviû
 
	gT¿n¦©Ü
 {

40 
½c
 
G‘T¿n¦©iÚ
(
G‘T¿n¦©iÚReque¡
è
»tuºs
 (
G‘T¿n¦©iÚRe¥Ú£
) {

45 
½c
 
Shutdown
(
ShutdownReque¡
è
»tuºs
 (
ShutdownRe¥Ú£
) {}

	@../asylo/examples/hello_world/hello.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gh–lo_wÜld
;

21 
	gimpÜt
 "asylo/enclave.proto";

24 
mes§ge
 
	gH–loIÅut
 {

25 
İtiÚ®
 
¡ršg
 
	gto_g»‘
 = 1;

28 
mes§ge
 
	gH–loOuut
 {

29 
İtiÚ®
 
¡ršg
 
	gg»‘šg_mes§ge
 = 1;

32 
ex‹nd
 
	gasylo
.
	gEnşaveIÅut
 {

33 
İtiÚ®
 
H–loIÅut
 
	g’şave_šput_h–lo
 = 8086;

36 
ex‹nd
 
	gasylo
.
	gEnşaveOuut
 {

37 
İtiÚ®
 
H–loOuut
 
	g’şave_ouut_h–lo
 = 8087;

	@../asylo/examples/quickstart/demo.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gguide
.
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

24 
mes§ge
 
	gDemo
 {

26 
İtiÚ®
 
¡ršg
 
	gv®ue
 = 1;

31 
	gex‹nd
 .
	gasylo
.
	gEnşaveIÅut
 {

32 
İtiÚ®
 
Demo
 
	gquick¡¬t_šput
 = 9001;

37 
	gex‹nd
 .
	gasylo
.
	gEnşaveOuut
 {

38 
İtiÚ®
 
Demo
 
	gquick¡¬t_ouut
 = 9001;

	@../asylo/examples/quickstart/solution/demo.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gguide
.
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

24 
mes§ge
 
	gDemo
 {

26 
İtiÚ®
 
¡ršg
 
	gv®ue
 = 1;

27 
	eAùiÚ
 {

28 
	gUNKNOWN
 = 0;

29 
	gENCRYPT
 = 1;

30 
	gDECRYPT
 = 2;

32 
İtiÚ®
 
AùiÚ
 
	gaùiÚ
 = 2;

37 
	gex‹nd
 .
	gasylo
.
	gEnşaveIÅut
 {

38 
İtiÚ®
 
Demo
 
	gquick¡¬t_šput
 = 9001;

43 
	gex‹nd
 .
	gasylo
.
	gEnşaveOuut
 {

44 
İtiÚ®
 
Demo
 
	gquick¡¬t_ouut
 = 9001;

	@../asylo/grpc/auth/core/handshake.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/identity/identity.proto";

31 
	eHªdshakeMes§geTy³
 {

32 
	mUNKNOWN_HANDSHAKE_MESSAGE
 = 0;

33 
	mABORT
 = 100;

34 
	mCLIENT_PRECOMMIT
 = 101;

35 
	mSERVER_PRECOMMIT
 = 102;

36 
	mCLIENT_ID
 = 103;

37 
	mSERVER_ID
 = 104;

38 
	mSERVER_FINISH
 = 105;

39 
	mCLIENT_FINISH
 = 106;

44 
	eHªdshakeCh”
 {

45 
	mUNKNOWN_HANDSHAKE_CIPHER
 = 0;

51 
	mCURVE25519_SHA256
 = 1;

56 
	eRecÜdPrÙocŞ
 {

57 
	mUNKNOWN_RECORD_PROTOCOL
 = 0;

60 
	mSEAL_AES128_GCM
 = 1;

65 
mes§ge
 
	gAdd™iÚ®Auth’tiÿ‹dD©a
 {

66 
İtiÚ®
 
by‹s
 
	gd©a
 = 1;

70 
mes§ge
 
	gEk•V”siÚ
 {

71 
İtiÚ®
 
¡ršg
 
	gÇme
 = 1;

82 
mes§ge
 
	gAbÜt
 {

83 
	eE¼ÜCode
 {

84 
	gUNKNOWN_ERROR_CODE
 = 0;

89 
	gBAD_MESSAGE
 = 1;

92 
	gDESERIALIZATION_FAILED
 = 2;

96 
	gBAD_PROTOCOL_VERSION
 = 3;

100 
	gBAD_HANDSHAKE_CIPHER
 = 4;

104 
	gBAD_RECORD_PROTOCOL
 = 5;

107 
	gBAD_AUTHENTICATOR
 = 6;

111 
	gBAD_ASSERTION_TYPE
 = 7;

114 
	gBAD_ASSERTION
 = 8;

118 
	gPROTOCOL_ERROR
 = 9;

122 
	gINTERNAL_ERROR
 = 10;

124 
İtiÚ®
 
E¼ÜCode
 
	gcode
 = 1;

128 
İtiÚ®
 
¡ršg
 
	gmes§ge
 = 2;

133 
mes§ge
 
	gCl›ÁP»comm™
 {

136 
»³©ed
 
Ek•V”siÚ
 
	gavaabË_ek•_v”siÚs
 = 1;

140 
»³©ed
 
HªdshakeCh”
 
	gavaabË_ch”_su™es
 = 2;

144 
»³©ed
 
RecÜdPrÙocŞ
 
	gavaabË_»cÜd_´ÙocŞs
 = 3;

147 
İtiÚ®
 
Add™iÚ®Auth’tiÿ‹dD©a
 
	gİtiÚs
 = 4;

150 
»³©ed
 
As£¹iÚOfãr
 
	gş›Á_ofãrs
 = 5;

154 
»³©ed
 
As£¹iÚReque¡
 
	gş›Á_»que¡s
 = 6;

159 
İtiÚ®
 
by‹s
 
	gch®Ënge
 = 7;

163 
mes§ge
 
	gS”v”P»comm™
 {

164 
İtiÚ®
 
Ek•V”siÚ
 
	g£Ëùed_ek•_v”siÚ
 = 1;

165 
İtiÚ®
 
HªdshakeCh”
 
	g£Ëùed_ch”_su™e
 = 2;

166 
İtiÚ®
 
RecÜdPrÙocŞ
 
	g£Ëùed_»cÜd_´ÙocŞ
 = 3;

169 
İtiÚ®
 
Add™iÚ®Auth’tiÿ‹dD©a
 
	gİtiÚs
 = 4;

173 
»³©ed
 
As£¹iÚOfãr
 
	g£rv”_ofãrs
 = 5;

178 
»³©ed
 
As£¹iÚReque¡
 
	g£rv”_»que¡s
 = 6;

183 
İtiÚ®
 
by‹s
 
	gch®Ënge
 = 7;

187 
mes§ge
 
	gCl›ÁId
 {

190 
İtiÚ®
 
by‹s
 
	gdh_public_key
 = 1;

193 
»³©ed
 
As£¹iÚ
 
	gas£¹iÚs
 = 2;

197 
mes§ge
 
	gS”v”Id
 {

200 
İtiÚ®
 
by‹s
 
	gdh_public_key
 = 1;

203 
»³©ed
 
As£¹iÚ
 
	gas£¹iÚs
 = 2;

207 
mes§ge
 
	gS”v”Fšish
 {

220 
İtiÚ®
 
by‹s
 
	ghªdshake_auth’tiÿtÜ
 = 1;

225 
mes§ge
 
	gCl›ÁFšish
 {

238 
İtiÚ®
 
by‹s
 
	ghªdshake_auth’tiÿtÜ
 = 1;

	@../asylo/grpc/util/enclave_server.proto

17 
	gsyÁax
 = "proto2";

24 
·ckage
 
	gasylo
;

26 
	gimpÜt
 "asylo/enclave.proto";

29 
mes§ge
 
	gS”v”CÚfig
 {

31 
İtiÚ®
 
¡ršg
 
	gho¡
 = 1;

35 
İtiÚ®
 
št32
 
	gpÜt
 = 2;

38 
ex‹nd
 
	gEnşaveCÚfig
 {

40 
İtiÚ®
 
S”v”CÚfig
 
	g£rv”_šput_cÚfig
 = 174238459;

43 
ex‹nd
 
	gEnşaveOuut
 {

47 
İtiÚ®
 
S”v”CÚfig
 
	g£rv”_ouut_cÚfig
 = 196851825;

	@../asylo/identity/enclave_assertion_authority_config.proto

17 
	gsyÁax
 = "proto2";

24 
·ckage
 
	gasylo
;

26 
	gimpÜt
 "asylo/identity/identity.proto";

30 
mes§ge
 
	gEnşaveAs£¹iÚAuthÜ™yCÚfig
 {

32 
İtiÚ®
 
As£¹iÚDesütiÚ
 
	gdesütiÚ
 = 1;

37 
İtiÚ®
 
by‹s
 
	gcÚfig
 = 2;

	@../asylo/identity/identity.proto

17 
	gsyÁax
 = "proto2";

24 
·ckage
 
	gasylo
;

27 
	eEnşaveId’t™yTy³
 {

28 
	mUNKNOWN_IDENTITY
 = 0;

31 
	mNULL_IDENTITY
 = 1;

36 
	mCODE_IDENTITY
 = 2;

40 
	mCERT_IDENTITY
 = 3;

44 
mes§ge
 
	gEnşaveId’t™yDesütiÚ
 {

46 
İtiÚ®
 
EnşaveId’t™yTy³
 
	gid’t™y_ty³
 = 1;

52 
İtiÚ®
 
¡ršg
 
	gauthÜ™y_ty³
 = 2;

60 
mes§ge
 
	gEnşaveId’t™y
 {

62 
İtiÚ®
 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
 = 1;

66 
İtiÚ®
 
by‹s
 
	gid’t™y
 = 2;

70 
mes§ge
 
	gEnşaveId’t™›s
 {

71 
»³©ed
 
EnşaveId’t™y
 
	gid’t™›s
 = 1;

80 
mes§ge
 
	gEnşaveId’t™yEx³ù©iÚ
 {

86 
İtiÚ®
 
EnşaveId’t™y
 
	g»ã»nû_id’t™y
 = 1;

91 
İtiÚ®
 
by‹s
 
	gm©ch_¥ec
 = 2;

95 
mes§ge
 
	gAs£¹iÚDesütiÚ
 {

97 
İtiÚ®
 
EnşaveId’t™yTy³
 
	gid’t™y_ty³
 = 1;

117 
İtiÚ®
 
¡ršg
 
	gauthÜ™y_ty³
 = 2;

125 
mes§ge
 
	gAs£¹iÚOfãr
 {

130 
İtiÚ®
 
As£¹iÚDesütiÚ
 
	gdesütiÚ
 = 1;

144 
İtiÚ®
 
by‹s
 
	gadd™iÚ®_šfÜm©iÚ
 = 2;

152 
mes§ge
 
	gAs£¹iÚReque¡
 {

157 
İtiÚ®
 
As£¹iÚDesütiÚ
 
	gdesütiÚ
 = 1;

170 
İtiÚ®
 
by‹s
 
	gadd™iÚ®_šfÜm©iÚ
 = 2;

174 
mes§ge
 
	gAs£¹iÚ
 {

178 
İtiÚ®
 
As£¹iÚDesütiÚ
 
	gdesütiÚ
 = 1;

184 
İtiÚ®
 
by‹s
 
	gas£¹iÚ
 = 2;

	@../asylo/identity/identity_acl.proto

17 
	gsyÁax
 = "proto2";

43 
·ckage
 
	gasylo
;

45 
	gimpÜt
 "asylo/identity/identity.proto";

48 
mes§ge
 
	gId’t™yAşP»diÿ‹
 {

49 
Úeof
 
	g™em
 {

50 
Id’t™yAşGroup
 
	gaş_group
 = 1;

51 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 2;

56 
mes§ge
 
	gId’t™yAşGroup
 {

58 
»³©ed
 
Id’t™yAşP»diÿ‹
 
	g´ediÿ‹s
 = 1;

62 
	eGroupTy³
 {

64 
	gOR
 = 0;

67 
	gAND
 = 1;

71 
	gNOT
 = 2;

75 
İtiÚ®
 
GroupTy³
 
	gty³
 = 2 [ = 
OR
];

	@../asylo/identity/null_identity/null_assertion.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

27 
mes§ge
 
	gNuÎAs£¹iÚ
 {

29 
İtiÚ®
 
by‹s
 
	gu£r_d©a
 = 1;

	@../asylo/identity/sealed_secret.proto

17 
	gsyÁax
 = "proto2";

30 
·ckage
 
	gasylo
;

32 
	gimpÜt
 "asylo/identity/identity.proto";

33 
	gimpÜt
 "asylo/identity/identity_acl.proto";

36 
	eS—lšgRoÙTy³
 {

39 
	mLOCAL
 = 1;

43 
	mREMOTE
 = 2;

49 
mes§ge
 
	gS—lšgRoÙInfÜm©iÚ
 {

53 
İtiÚ®
 
S—lšgRoÙTy³
 
	g£®šg_roÙ_ty³
 = 1;

58 
İtiÚ®
 
¡ršg
 
	g£®šg_roÙ_Çme
 = 2;

63 
İtiÚ®
 
Id’t™yAşP»diÿ‹
 
	g£®šg_roÙ_aş
 = 3;

71 
İtiÚ®
 
by‹s
 
	gadd™iÚ®_šfo
 = 4;

74 
mes§ge
 
	gS—ËdSeü‘H—d”
 {

79 
İtiÚ®
 
¡ršg
 
	g£ü‘_Çme
 = 1;

85 
İtiÚ®
 
¡ršg
 
	g£ü‘_v”siÚ
 = 2;

91 
İtiÚ®
 
¡ršg
 
	g£ü‘_pu½o£
 = 3;

96 
İtiÚ®
 
S—lšgRoÙInfÜm©iÚ
 
	groÙ_šfo
 = 4;

103 
»³©ed
 
EnşaveId’t™y
 
	gauthÜ
 = 5;

109 
İtiÚ®
 
Id’t™yAşP»diÿ‹
 
	gş›Á_aş
 = 6;

116 
İtiÚ®
 
by‹s
 
	g£ü‘_hªdlšg_pŞicy
 = 7;

119 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

122 
mes§ge
 
	gS—ËdSeü‘
 {

127 
İtiÚ®
 
by‹s
 
	giv
 = 1;

131 
İtiÚ®
 
by‹s
 
	g£®ed_£ü‘_h—d”
 = 2;

134 
İtiÚ®
 
by‹s
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
 = 3;

137 
İtiÚ®
 
by‹s
 
	g£ü‘_ch”‹xt
 = 4;

141 
İtiÚ®
 
by‹s
 
	g£®šg_roÙ_bookk“pšg_šfo
 = 5;

146 
mes§ge
 
	gUn£®edSeü‘
 {

149 
İtiÚ®
 
S—ËdSeü‘H—d”
 
	g£ü‘_h—d”
 = 1;

153 
İtiÚ®
 
by‹s
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
 = 2;

156 
İtiÚ®
 
by‹s
 
	g£ü‘_¶aš‹xt
 = 3;

	@../asylo/identity/sgx/attestation_key.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

21 
	gimpÜt
 "asylo/crypto/keys.proto";

25 
mes§ge
 
	gA‰e¡©iÚPublicKey
 {

28 
İtiÚ®
 
Asymm‘ricSignšgKeyPrÙo
 
	g©‹¡©iÚ_public_key
 = 1;

31 
İtiÚ®
 
¡ršg
 
	gv”siÚ
 = 2;

34 
İtiÚ®
 
¡ršg
 
	gpu½o£
 = 3;

40 
mes§ge
 
	gPûSignR•ÜtPaylßd
 {

42 
İtiÚ®
 
A‰e¡©iÚPublicKey
 
	g©‹¡©iÚ_public_key
 = 1;

45 
İtiÚ®
 
¡ršg
 
	gv”siÚ
 = 2;

	@../asylo/identity/sgx/attributes.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

28 
mes§ge
 
	gA‰ribu‹s
 {

32 
İtiÚ®
 
ušt64
 
	gæags
 = 1;

38 
İtiÚ®
 
ušt64
 
	gxäm
 = 2;

	@../asylo/identity/sgx/code_identity.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

21 
	gimpÜt
 "asylo/identity/sgx/attributes.proto";

22 
	gimpÜt
 "asylo/identity/util/sha256_hash.proto";

28 
mes§ge
 
	gSigÃrAssigÃdId’t™y
 {

30 
İtiÚ®
 
Sha256HashPrÙo
 
	gmrsigÃr
 = 1;

33 
İtiÚ®
 
ušt32
 
	gisv´odid
 = 2;

37 
İtiÚ®
 
ušt32
 
	gisvsvn
 = 3;

47 
mes§ge
 
	gCodeId’t™y
 {

51 
İtiÚ®
 
Sha256HashPrÙo
 
	gm»nşave
 = 1;

55 
İtiÚ®
 
SigÃrAssigÃdId’t™y
 
	gsigÃr_assigÃd_id’t™y
 = 2;

59 
İtiÚ®
 
ušt32
 
	gmisc£Ëù
 = 3;

64 
İtiÚ®
 
A‰ribu‹s
 
	g©Œibu‹s
 = 4;

68 
mes§ge
 
	gCodeId’t™yM©chS³c
 {

70 
İtiÚ®
 
boŞ
 
	gis_m»nşave_m©ch_»quœed
 = 1;

73 
İtiÚ®
 
boŞ
 
	gis_mrsigÃr_m©ch_»quœed
 = 2;

80 
İtiÚ®
 
ušt32
 
	gmisc£Ëù_m©ch_mask
 = 4;

86 
İtiÚ®
 
A‰ribu‹s
 
	g©Œibu‹s_m©ch_mask
 = 6;

91 
mes§ge
 
	gCodeId’t™yEx³ù©iÚ
 {

94 
İtiÚ®
 
CodeId’t™y
 
	g»ã»nû_id’t™y
 = 1;

97 
İtiÚ®
 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
 = 2;

	@../asylo/identity/sgx/local_assertion.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

24 
mes§ge
 
	gLoÿlAs£¹iÚReque¡Add™iÚ®Info
 {

30 
İtiÚ®
 
by‹s
 
	gloÿl_©‹¡©iÚ_domaš
 = 1;

36 
İtiÚ®
 
by‹s
 
	grg‘šfo
 = 2;

43 
mes§ge
 
	gLoÿlAs£¹iÚOfãrAdd™iÚ®Info
 {

49 
İtiÚ®
 
by‹s
 
	gloÿl_©‹¡©iÚ_domaš
 = 1;

55 
mes§ge
 
	gLoÿlAs£¹iÚ
 {

59 
İtiÚ®
 
by‹s
 
	g»pÜt
 = 1;

	@../asylo/identity/sgx/local_sealed_secret.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

22 
	eCh”Su™e
 {

23 
	mUNKNOWN_CIPHER_SUITE
 = 0;

24 
	mAES256_GCM_SIV
 = 1;

30 
mes§ge
 
	gS—ËdSeü‘Add™iÚ®Info
 {

34 
İtiÚ®
 
by‹s
 
	gıusvn
 = 1;

37 
İtiÚ®
 
Ch”Su™e
 
	gch”_su™e
 = 2;

	@../asylo/identity/sgx/miscselect.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

24 
mes§ge
 
	gMisc£Ëù
 {

25 
İtiÚ®
 
ušt32
 
	gv®ue
 = 1;

	@../asylo/identity/sgx/platform_provisioning.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

38 
mes§ge
 
	gPpid
 {

40 
İtiÚ®
 
by‹s
 
	gv®ue
 = 1;

45 
mes§ge
 
	gCpuSvn
 {

47 
İtiÚ®
 
by‹s
 
	gv®ue
 = 1;

51 
mes§ge
 
	gPûSvn
 {

54 
İtiÚ®
 
ušt32
 
	gv®ue
 = 1;

59 
mes§ge
 
	gPûId
 {

61 
İtiÚ®
 
ušt32
 
	gv®ue
 = 1;

65 
mes§ge
 
	gFm¥c
 {

67 
İtiÚ®
 
by‹s
 
	gv®ue
 = 1;

72 
mes§ge
 
	gR•ÜtPrÙo
 {

75 
İtiÚ®
 
by‹s
 
	gv®ue
 = 1;

81 
mes§ge
 
	gT¬g‘InfoPrÙo
 {

84 
İtiÚ®
 
by‹s
 
	gv®ue
 = 1;

	@../asylo/identity/sgx/remote_assertion.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	gsgx
;

21 
	gimpÜt
 "asylo/crypto/algorithms.proto";

22 
	gimpÜt
 "asylo/crypto/certificate.proto";

23 
	gimpÜt
 "asylo/identity/sgx/code_identity.proto";

26 
mes§ge
 
	gRemÙeAs£¹iÚPaylßd
 {

28 
İtiÚ®
 
¡ršg
 
	gv”siÚ
 = 1;

31 
İtiÚ®
 
SigÇtu»Scheme
 
	gsigÇtu»_scheme
 = 2;

34 
İtiÚ®
 
CodeId’t™y
 
	gid’t™y
 = 3;

37 
İtiÚ®
 
by‹s
 
	gu£r_d©a
 = 4;

42 
mes§ge
 
	gRemÙeAs£¹iÚ
 {

52 
İtiÚ®
 
by‹s
 
	g·ylßd
 = 1;

55 
İtiÚ®
 
SigÇtu»Scheme
 
	gsigÇtu»_scheme
 = 2;

58 
İtiÚ®
 
by‹s
 
	gsigÇtu»
 = 3;

62 
»³©ed
 
C”tifiÿ‹Chaš
 
	gû¹ifiÿ‹_chašs
 = 4;

	@../asylo/identity/sgx/sgx_local_assertion_authority_config.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

22 
mes§ge
 
	gSgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 {

25 
İtiÚ®
 
by‹s
 
	g©‹¡©iÚ_domaš
 = 1;

	@../asylo/identity/sgx/tcb.proto

1 
	gsyÁax
 = "proto2";

3 
·ckage
 
	gasylo
.
	gsgx
;

5 
	gimpÜt
 "google/protobuf/timestamp.proto";

6 
	gimpÜt
 "asylo/identity/sgx/platform_provisioning.proto";

12 
mes§ge
 
	gTcb
 {

14 
İtiÚ®
 
by‹s
 
	gcompÚ’ts
 = 1;

17 
İtiÚ®
 
PûSvn
 
	gpû_svn
 = 2;

21 
mes§ge
 
	gRawTcb
 {

23 
İtiÚ®
 
CpuSvn
 
	gıu_svn
 = 1;

26 
İtiÚ®
 
PûSvn
 
	gpû_svn
 = 2;

30 
mes§ge
 
	gTcbStus
 {

31 
	eStusTy³
 {

32 
	gINVALID
 = 0;

35 
	gUP_TO_DATE
 = 1;

38 
	gOUT_OF_DATE
 = 2;

42 
	gCONFIGURATION_NEEDED
 = 3;

45 
	gREVOKED
 = 4;

47 
Úeof
 
	gv®ue
 {

50 
StusTy³
 
	gknown_¡©us
 = 1;

58 
¡ršg
 
	gunknown_¡©us
 = 2;

63 
mes§ge
 
	gTcbLev–
 {

65 
İtiÚ®
 
Tcb
 
	gtcb
 = 1;

68 
İtiÚ®
 
TcbStus
 
	g¡©us
 = 2;

72 
mes§ge
 
	gTcbInfoIm¶
 {

74 
İtiÚ®
 
št32
 
	gv”siÚ
 = 1;

77 
İtiÚ®
 
	ggoogË
.
	g´Ùobuf
.
Time¡amp
 
	gissue_d©e
 = 2;

80 
İtiÚ®
 
	ggoogË
.
	g´Ùobuf
.
Time¡amp
 
	gÃxt_upd©e
 = 3;

83 
İtiÚ®
 
Fm¥c
 
	gfm¥c
 = 4;

86 
İtiÚ®
 
PûId
 
	gpû_id
 = 5;

88 
»³©ed
 
TcbLev–
 
	gtcb_Ëv–s
 = 6;

96 
mes§ge
 
	gTcbInfo
 {

97 
Úeof
 
	gv®ue
 {

98 
TcbInfoIm¶
 
	gim¶
 = 1;

	@../asylo/identity/util/sha256_hash.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

23 
mes§ge
 
	gSha256HashPrÙo
 {

24 
»quœed
 
by‹s
 
	ghash
 = 1;

	@../asylo/platform/arch/fork.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

25 
mes§ge
 
	gSÇpshÙLayoutEÁry
 {

27 
İtiÚ®
 
ušt64
 
	gch”‹xt_ba£
 = 1;

30 
İtiÚ®
 
ušt64
 
	gch”‹xt_size
 = 2;

33 
İtiÚ®
 
ušt64
 
	gnÚû_ba£
 = 3;

36 
İtiÚ®
 
ušt64
 
	gnÚû_size
 = 4;

42 
mes§ge
 
	gSÇpshÙLayout
 {

44 
»³©ed
 
SÇpshÙLayoutEÁry
 
	gd©a
 = 1;

47 
»³©ed
 
SÇpshÙLayoutEÁry
 
	gbss
 = 2;

50 
»³©ed
 
SÇpshÙLayoutEÁry
 
	gh—p
 = 3;

53 
»³©ed
 
SÇpshÙLayoutEÁry
 
	gth»ad
 = 4;

56 
»³©ed
 
SÇpshÙLayoutEÁry
 
	g¡ack
 = 5;

61 
mes§ge
 
	gFÜkHªdshakeCÚfig
 {

64 
İtiÚ®
 
boŞ
 
	gis_·»Á
 = 1;

67 
İtiÚ®
 
št32
 
	gsock‘
 = 2;

71 
mes§ge
 
	gEnüy±edSÇpshÙKey
 {

73 
İtiÚ®
 
by‹s
 
	gch”‹xt
 = 1;

75 
İtiÚ®
 
by‹s
 
	gnÚû
 = 2;

78 
ex‹nd
 
	gEnşaveOuut
 {

79 
İtiÚ®
 
SÇpshÙLayout
 
	g¢­shÙ
 = 238362825;

	@../asylo/platform/arch/sgx/host_calls_generator/host_calls.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gthœd_·¹y
.
	gasylo
.
	g¶©fÜm
.
	g¬ch
.
	gsgx
.
	gcodeg’
;

22 
mes§ge
 
	gPoš‹rA‰ribu‹PrÙo
 {

23 
	eA‰ribu‹
 {

27 
	gIN
 = 1;

33 
	gOUT
 = 2;

39 
	gSTRING
 = 3;

44 
	gSIZE
 = 4;

49 
	gUSER_CHECK
 = 5;

51 
»quœed
 
A‰ribu‹
 
	g©Œibu‹
 = 1;

59 
İtiÚ®
 
¡ršg
 
	g©Œibu‹_ex´essiÚ
 = 2;

63 
mes§ge
 
	gFÜm®P¬am‘”PrÙo
 {

64 
»quœed
 
¡ršg
 
	gÇme
 = 1;

65 
»quœed
 
¡ršg
 
	gty³
 = 2;

66 
»³©ed
 
Poš‹rA‰ribu‹PrÙo
 
	gpoš‹r_©Œibu‹s
 = 3;

70 
mes§ge
 
	gHo¡C®lPrÙo
 {

71 
»quœed
 
¡ršg
 
	gÇme
 = 1;

72 
»quœed
 
¡ršg
 
	g»tuº_ty³
 = 2;

77 
İtiÚ®
 
¡ršg
 
	gçu»_»tuº_ex´essiÚ
 = 3 [ = "-1"];

82 
İtiÚ®
 
boŞ
 
	gçu»_£ts_”ºo
 = 4 [ = 
Œue
];

84 
»³©ed
 
FÜm®P¬am‘”PrÙo
 
	g·¿m‘”s
 = 5;

88 
mes§ge
 
	gHo¡C®lsPrÙo
 {

89 
»³©ed
 
Ho¡C®lPrÙo
 
	gho¡_ÿÎs
 = 2;

	@../asylo/platform/common/bridge_proto_types.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
mes§ge
 
	gSockaddrPrÙo
 {

22 
mes§ge
 
	gSockaddrIn
 {

23 
İtiÚ®
 
ušt32
 
	gsš_pÜt
 = 1;

24 
İtiÚ®
 
ušt32
 
	gsš_addr
 = 2;

26 
mes§ge
 
	gSockaddrIn6
 {

27 
İtiÚ®
 
ušt32
 
	gsš6_pÜt
 = 1;

28 
İtiÚ®
 
ušt32
 
	gsš6_æowšfo
 = 2;

29 
İtiÚ®
 
by‹s
 
	gsš6_addr
 = 3;

30 
İtiÚ®
 
ušt32
 
	gsš6_scİe_id
 = 4;

32 
Úeof
 
	gçmy
 {

33 
SockaddrIn
 
	gsockaddr_š
 = 1;

34 
SockaddrIn6
 
	gsockaddr_š6
 = 2;

38 
mes§ge
 
	gAddršfoPrÙo
 {

39 
İtiÚ®
 
št32
 
	gai_æags
 = 1;

40 
İtiÚ®
 
št32
 
	gai_çmy
 = 2;

41 
İtiÚ®
 
št32
 
	gai_sockty³
 = 3;

42 
İtiÚ®
 
št32
 
	gai_´ÙocŞ
 = 4;

44 
İtiÚ®
 
SockaddrPrÙo
 
	gai_addr
 = 6;

45 
İtiÚ®
 
¡ršg
 
	gai_ÿnÚÇme
 = 7;

48 
mes§ge
 
	gAddršfosPrÙo
 {

49 
»³©ed
 
AddršfoPrÙo
 
	gaddršfos
 = 1;

52 
mes§ge
 
	gIfAddrPrÙo
 {

53 
	eIfAddrFÏg
 {

54 
	gDEFAULT
 = 0;

55 
	gPROTO_UP
 = 1;

56 
	gPROTO_BROADCAST
 = 2;

57 
	gPROTO_DEBUG
 = 3;

58 
	gPROTO_LOOPBACK
 = 4;

59 
	gPROTO_POINTOPOINT
 = 5;

60 
	gPROTO_NOTRAILERS
 = 6;

61 
	gPROTO_RUNNING
 = 7;

62 
	gPROTO_NOARP
 = 8;

63 
	gPROTO_PROMISC
 = 9;

64 
	gPROTO_ALLMULTI
 = 10;

65 
	gPROTO_MULTICAST
 = 11;

67 
İtiÚ®
 
¡ršg
 
	giç_Çme
 = 1;

68 
»³©ed
 
IfAddrFÏg
 
	giç_æags
 = 2;

69 
İtiÚ®
 
SockaddrPrÙo
 
	giç_addr
 = 3;

70 
İtiÚ®
 
SockaddrPrÙo
 
	giç_Ãtmask
 = 4;

71 
İtiÚ®
 
SockaddrPrÙo
 
	giç_ifu
 = 5;

74 
mes§ge
 
	gIfAddrsPrÙo
 {

75 
»³©ed
 
IfAddrPrÙo
 
	giçddrs
 = 1;

78 
mes§ge
 
	gEpŞlEv’t
 {

79 
	eEpŞlEv’tFÏg
 {

80 
	gDEFAULT
 = 0;

81 
	gPROTO_IN
 = 1;

82 
	gPROTO_PRI
 = 2;

83 
	gPROTO_OUT
 = 3;

84 
	gPROTO_RDNORM
 = 4;

85 
	gPROTO_RDBAND
 = 5;

86 
	gPROTO_WRNORM
 = 6;

87 
	gPROTO_WRBAND
 = 7;

88 
	gPROTO_MSG
 = 8;

89 
	gPROTO_ERR
 = 9;

90 
	gPROTO_HUP
 = 10;

91 
	gPROTO_RDHUP
 = 11;

92 
	gPROTO_WAKEUP
 = 12;

93 
	gPROTO_ONESHOT
 = 13;

94 
	gPROTO_ET
 = 14;

96 
»³©ed
 
EpŞlEv’tFÏg
 
	gev’t_æags
 = 1;

97 
İtiÚ®
 
ušt64
 
	gd©a
 = 2;

100 
mes§ge
 
	gEpŞlEv’tLi¡
 {

101 
»³©ed
 
EpŞlEv’t
 
	gev’ts
 = 1;

104 
mes§ge
 
	gEpŞlCArgs
 {

105 
	eEpŞlCOp
 {

106 
	gUNSUPPORTED
 = 0;

107 
	gPROTO_CTL_ADD
 = 1;

108 
	gPROTO_CTL_DEL
 = 2;

109 
	gPROTO_CTL_MOD
 = 3;

111 
İtiÚ®
 
št32
 
	g•fd
 = 4;

112 
İtiÚ®
 
EpŞlCOp
 
	gİ
 = 5;

113 
İtiÚ®
 
št32
 
	gho¡fd
 = 6;

114 
İtiÚ®
 
EpŞlEv’t
 
	gev’t
 = 7;

117 
mes§ge
 
	gEpŞlWa™Args
 {

118 
İtiÚ®
 
št32
 
	g•fd
 = 1;

119 
İtiÚ®
 
št32
 
	gmaxev’ts
 = 2;

120 
İtiÚ®
 
št32
 
	gtimeout
 = 3;

123 
	eInÙifyFÏg
 {

124 
	mDEFAULT
 = 0;

125 
	mPROTO_ACCESS
 = 1;

126 
	mPROTO_ATTRIB
 = 2;

127 
	mPROTO_CLOSE_WRITE
 = 3;

128 
	mPROTO_CLOSE_NOWRITE
 = 4;

129 
	mPROTO_CREATE
 = 5;

130 
	mPROTO_DELETE
 = 6;

131 
	mPROTO_DELETE_SELF
 = 7;

132 
	mPROTO_MODIFY
 = 8;

133 
	mPROTO_MOVE_SELF
 = 9;

134 
	mPROTO_MOVED_FROM
 = 10;

135 
	mPROTO_MOVED_TO
 = 11;

136 
	mPROTO_OPEN
 = 12;

137 
	mPROTO_DONT_FOLLOW
 = 13;

138 
	mPROTO_EXCL_UNLINK
 = 14;

139 
	mPROTO_MASK_ADD
 = 15;

140 
	mPROTO_ONESHOT
 = 16;

141 
	mPROTO_ONLYDIR
 = 17;

142 
	mPROTO_IGNORED
 = 18;

143 
	mPROTO_ISDIR
 = 19;

144 
	mPROTO_Q_OVERFLOW
 = 20;

145 
	mPROTO_UNMOUNT
 = 21;

148 
mes§ge
 
	gInÙifyAddW©chArgs
 {

149 
İtiÚ®
 
št32
 
	gfd
 = 1;

150 
İtiÚ®
 
¡ršg
 
	g·thÇme
 = 2;

151 
»³©ed
 
InÙifyFÏg
 
	gmask
 = 3;

154 
mes§ge
 
	gInÙifyRmW©chArgs
 {

155 
İtiÚ®
 
št32
 
	gfd
 = 1;

156 
İtiÚ®
 
št32
 
	gwd
 = 2;

159 
mes§ge
 
	gInÙifyEv’t
 {

160 
İtiÚ®
 
št32
 
	gwd
 = 1;

161 
»³©ed
 
InÙifyFÏg
 
	gmask
 = 2;

162 
İtiÚ®
 
ušt32
 
	gcook›
 = 3;

163 
İtiÚ®
 
by‹s
 
	gÇme
 = 4;

166 
mes§ge
 
	gInÙifyEv’tLi¡
 {

167 
»³©ed
 
InÙifyEv’t
 
	gev’ts
 = 1;

170 
	eRecvS’dFÏgs
 {

171 
	mPROTO_DEFAULT
 = 0;

172 
	mPROTO_OOB
 = 1;

173 
	mPROTO_PEEK
 = 2;

174 
	mPROTO_DONTROUTE
 = 3;

175 
	mPROTO_CTRUNC
 = 4;

176 
	mPROTO_PROXY
 = 5;

177 
	mPROTO_TRUNC
 = 6;

178 
	mPROTO_DONTWAIT
 = 7;

179 
	mPROTO_EOR
 = 8;

180 
	mPROTO_WAITALL
 = 9;

181 
	mPROTO_FIN
 = 10;

182 
	mPROTO_SYN
 = 11;

183 
	mPROTO_CONFIRM
 = 12;

184 
	mPROTO_RST
 = 13;

185 
	mPROTO_ERRQUEUE
 = 14;

186 
	mPROTO_NOSIGNAL
 = 15;

187 
	mPROTO_MORE
 = 16;

188 
	mPROTO_WAITFORONE
 = 17;

189 
	mPROTO_FASTOPEN
 = 18;

190 
	mPROTO_CMSG_CLOEXEC
 = 19;

192 
mes§ge
 
	gRecvFromArgs
 {

193 
İtiÚ®
 
št32
 
	gsockfd
 = 1;

194 
İtiÚ®
 
ušt64
 
	gËn
 = 2;

195 
»³©ed
 
RecvS’dFÏgs
 
	gæags
 = 3;

198 
mes§ge
 
	gRecvFromSrcAddr
 {

199 
İtiÚ®
 
SockaddrPrÙo
 
	g¤c_addr
 = 1;

	@../asylo/platform/core/test/proto_test.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

23 
mes§ge
 
	gEnşaveApiTe¡
 {

24 
İtiÚ®
 
¡ršg
 
	g‹¡_¡ršg
 = 1;

25 
İtiÚ®
 
št32
 
	g‹¡_št
 = 2;

26 
»³©ed
 
¡ršg
 
	g‹¡_»³©ed
 = 3;

29 
ex‹nd
 
	gEnşaveIÅut
 {

30 
İtiÚ®
 
EnşaveApiTe¡
 
	g’şave_­i_‹¡_šput
 = 157851293;

33 
ex‹nd
 
	gEnşaveOuut
 {

34 
İtiÚ®
 
EnşaveApiTe¡
 
	g’şave_­i_‹¡_ouut
 = 157239766;

	@../asylo/platform/posix/fork_security_test.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

25 
mes§ge
 
	gFÜkSecur™yTe¡IÅut
 {

27 
İtiÚ®
 
boŞ
 
	g»que¡_fÜk
 = 1;

30 
ex‹nd
 
	gEnşaveIÅut
 {

31 
İtiÚ®
 
FÜkSecur™yTe¡IÅut
 
	gfÜk_£cur™y_‹¡_šput
 = 243359234;

	@../asylo/platform/posix/sockets/socket_test.proto

20 
	gsyÁax
 = "proto2";

22 
·ckage
 
	gasylo
;

24 
	gimpÜt
 "asylo/enclave.proto";

27 
mes§ge
 
	gSock‘Te¡IÅut
 {

28 
	eSock‘AùiÚ
 {

29 
	gUNKNOWN
 = 0;

30 
	gRUNSERVER
 = 1;

31 
	gRUNCLIENT
 = 2;

32 
	gINITSERVER
 = 3;

33 
	gINITCLIENT
 = 4;

34 
	gSTATSERVER
 = 5;

35 
	gSTATCLIENT
 = 6;

38 
İtiÚ®
 
Sock‘AùiÚ
 
	gaùiÚ
 = 1;

39 
İtiÚ®
 
¡ršg
 
	gsock‘_Çme
 = 2;

40 
İtiÚ®
 
št32
 
	g£rv”_pÜt
 = 3;

41 
İtiÚ®
 
št32
 
	gbuf_Ën
 = 4;

42 
İtiÚ®
 
št32
 
	ground_Œ
 = 5;

43 
İtiÚ®
 
boŞ
 
	gu£_·th_Ën
 = 6;

47 
mes§ge
 
	gSock‘Te¡Ouut
 {

48 
İtiÚ®
 
št32
 
	g£rv”_pÜt
 = 1;

53 
mes§ge
 
	gAddrInfoTe¡IÅut
 {

54 
	eTe¡Mode
 {

55 
	gUNKNOWN
 = 0;

56 
	gNO_HINTS
 = 1;

57 
	gUNSPEC_HINTS
 = 2;

58 
	gIP_HINTS
 = 3;

61 
»quœed
 
Te¡Mode
 
	gmode
 = 1;

64 
ex‹nd
 
	gEnşaveIÅut
 {

65 
İtiÚ®
 
Sock‘Te¡IÅut
 
	gsock‘_‹¡_šput
 = 161587976;

66 
İtiÚ®
 
AddrInfoTe¡IÅut
 
	gaddršfo_‹¡_šput
 = 161587977;

69 
ex‹nd
 
	gEnşaveOuut
 {

70 
İtiÚ®
 
Sock‘Te¡Ouut
 
	gsock‘_‹¡_ouut
 = 191972549;

	@../asylo/platform/posix/syscalls_test.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

25 
mes§ge
 
	gSysÿÎsTe¡IÅut
 {

27 
»quœed
 
¡ršg
 
	g‹¡_rg‘
 = 1;

30 
İtiÚ®
 
¡ršg
 
	g·th_Çme
 = 2;

33 
İtiÚ®
 
boŞ
 
	g´ovide_bufãr
 = 3;

36 
İtiÚ®
 
št32
 
	gbufãr_size
 = 4;

40 
mes§ge
 
	gSysÿÎsTe¡Ouut
 {

42 
İtiÚ®
 
št64
 
	gšt_sysÿÎ_»tuº
 = 1;

45 
İtiÚ®
 
¡ršg
 
	g¡ršg_sysÿÎ_»tuº
 = 2;

48 
»³©ed
 
ušt64
 
	gb™_mask_sysÿÎ_ouŒ
 = 3;

50 
	eE¼noV®ue
 {

51 
	gUNSUPPORTED
 = 0;

52 
	gERRNO_ZERO
 = 1;

53 
	gERRNO_EINVAL
 = 2;

57 
İtiÚ®
 
E¼noV®ue
 
	g”ºo_sysÿÎ_v®ue
 = 4;

59 
mes§ge
 
	gStV®ue
 {

60 
İtiÚ®
 
št64
 
	g¡_dev
 = 1;

61 
İtiÚ®
 
št64
 
	g¡_šo
 = 2;

62 
İtiÚ®
 
št64
 
	g¡_mode
 = 3;

63 
İtiÚ®
 
št64
 
	g¡_Æšk
 = 4;

64 
İtiÚ®
 
št64
 
	g¡_uid
 = 5;

65 
İtiÚ®
 
št64
 
	g¡_gid
 = 6;

66 
İtiÚ®
 
št64
 
	g¡_rdev
 = 7;

67 
İtiÚ®
 
št64
 
	g¡_size
 = 8;

68 
İtiÚ®
 
št64
 
	g¡_©ime_v®
 = 9;

69 
İtiÚ®
 
št64
 
	g¡_mtime_v®
 = 10;

70 
İtiÚ®
 
št64
 
	g¡_ùime_v®
 = 11;

71 
İtiÚ®
 
št64
 
	g¡_blksize
 = 12;

72 
İtiÚ®
 
št64
 
	g¡_blocks
 = 13;

76 
İtiÚ®
 
StV®ue
 
	g¡©_bufãr_sysÿÎ_»tuº
 = 5;

80 
İtiÚ®
 
by‹s
 
	g£rŸlized_´Ùo_»tuº
 = 6;

82 
mes§ge
 
	gUtsName
 {

83 
İtiÚ®
 
¡ršg
 
	gsy¢ame
 = 1;

84 
İtiÚ®
 
¡ršg
 
	gnod’ame
 = 2;

85 
İtiÚ®
 
¡ršg
 
	g»Ëa£
 = 3;

86 
İtiÚ®
 
¡ršg
 
	gv”siÚ
 = 4;

87 
İtiÚ®
 
¡ršg
 
	gmachše
 = 5;

88 
İtiÚ®
 
¡ršg
 
	gdomašÇme
 = 6;

92 
İtiÚ®
 
UtsName
 
	gut¢ame_sysÿÎ_»tuº
 = 7;

94 
mes§ge
 
	gPassWd
 {

95 
İtiÚ®
 
¡ršg
 
	gpw_Çme
 = 1;

96 
İtiÚ®
 
¡ršg
 
	gpw_·sswd
 = 2;

97 
İtiÚ®
 
št64
 
	gpw_uid
 = 3;

98 
İtiÚ®
 
št64
 
	gpw_gid
 = 4;

99 
İtiÚ®
 
¡ršg
 
	gpw_gecos
 = 5;

100 
İtiÚ®
 
¡ršg
 
	gpw_dœ
 = 6;

101 
İtiÚ®
 
¡ršg
 
	gpw_sh–l
 = 7;

105 
İtiÚ®
 
PassWd
 
	g·sswd_sysÿÎ_»tuº
 = 8;

108 
ex‹nd
 
	gEnşaveIÅut
 {

109 
İtiÚ®
 
SysÿÎsTe¡IÅut
 
	gsysÿÎs_‹¡_šput
 = 168889258;

112 
ex‹nd
 
	gEnşaveOuut
 {

113 
İtiÚ®
 
SysÿÎsTe¡Ouut
 
	gsysÿÎs_‹¡_ouut
 = 168889258;

	@../asylo/test/grpc/client_enclave.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

23 
ex‹nd
 
	gEnşaveIÅut
 {

24 
İtiÚ®
 
Cl›ÁEnşaveIÅut
 
	gş›Á_’şave_šput
 = 225075181;

27 
ex‹nd
 
	gEnşaveOuut
 {

29 
İtiÚ®
 
¡ršg
 
	g½c_»suÉ
 = 200746417;

33 
	eG½cC»d’tŸlsO±iÚsTy³
 {

34 
	mUNKNOWN_GRPC_CREDENTIALS_OPTIONS
 = 0;

35 
	mNULL_GRPC_CREDENTIALS_OPTIONS
 = 1;

36 
	mSGX_LOCAL_GRPC_CREDENTIALS_OPTIONS
 = 2;

40 
mes§ge
 
	gCl›ÁEnşaveIÅut
 {

42 
»³©ed
 
G½cC»d’tŸlsO±iÚsTy³
 
	g£lf_g½c_üeds_İtiÚs
 = 1;

43 
»³©ed
 
G½cC»d’tŸlsO±iÚsTy³
 
	g³”_g½c_üeds_İtiÚs
 = 2;

46 
İtiÚ®
 
¡ršg
 
	g£rv”_add»ss
 = 3;

49 
İtiÚ®
 
¡ršg
 
	g½c_šput
 = 4;

52 
İtiÚ®
 
št64
 
	gcÚÃùiÚ_d—dlše_mli£cÚds
 = 5;

	@../asylo/test/grpc/service.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
.
	g‹¡
;

27 
£rviû
 
	gMes£ng”1
 {

30 
½c
 
H–lo
(
H–loReque¡
è
»tuºs
 (
H–loRe¥Ú£
) {

35 
£rviû
 
	gMes£ng”2
 {

38 
½c
 
H–lo
(
H–loReque¡
è
»tuºs
 (
H–loRe¥Ú£
) {

43 
£rviû
 
	gMes£ng”3
 {

46 
½c
 
H–lo
(
H–loReque¡
è
»tuºs
 (
H–loRe¥Ú£
) {

50 
mes§ge
 
	gH–loReque¡
 {

51 
İtiÚ®
 
¡ršg
 
	gÇme
 = 1;

54 
mes§ge
 
	gH–loRe¥Ú£
 {

55 
İtiÚ®
 
¡ršg
 
	gmes§ge
 = 1;

	@../asylo/test/misc/block_enclave_entries_test.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

25 
mes§ge
 
	gBlockEnşaveEÁr›sTe¡IÅut
 {

26 
	eTh»adTy³
 {

27 
	gUNSUPPORTED
 = 0;

29 
	gBLOCK
 = 1;

31 
	gCHECK
 = 2;

34 
İtiÚ®
 
Th»adTy³
 
	gth»ad_ty³
 = 1;

38 
İtiÚ®
 
št32
 
	gsock‘
 = 2;

41 
ex‹nd
 
	gEnşaveIÅut
 {

42 
İtiÚ®
 
BlockEnşaveEÁr›sTe¡IÅut
 
	gblock_’şave_’Œ›s_‹¡_šput
 =

	@../asylo/test/misc/enclave_entry_count_test.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

25 
mes§ge
 
	gEnşaveEÁryCouÁTe¡IÅut
 {

26 
	eTh»adTy³
 {

27 
	gUNSUPPORTED
 = 0;

29 
	gDONOTHING
 = 1;

31 
	gWAIT
 = 2;

33 
	gCOUNT
 = 3;

36 
İtiÚ®
 
Th»adTy³
 
	gth»ad_ty³
 = 1;

39 
İtiÚ®
 
ušt32
 
	gex³ùed_’Œ›s
 = 2;

42 
ex‹nd
 
	gEnşaveIÅut
 {

43 
İtiÚ®
 
EnşaveEÁryCouÁTe¡IÅut
 
	g’şave_’Œy_couÁ_‹¡_šput
 =

47 
ex‹nd
 
	gEnşaveOuut
 {

48 
İtiÚ®
 
ušt32
 
	gnumb”_’Œ›s
 = 244056756;

	@../asylo/test/misc/signal_test.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

24 
mes§ge
 
	gSigÇlTe¡IÅut
 {

25 
	eSigÇlTe¡Ty³
 {

26 
	gUNSUPPORTED
 = 0;

29 
	gHANDLER
 = 1;

32 
	gSIGACTION
 = 2;

34 
	gSIGMASK
 = 3;

36 
	gSIGNAL
 = 4;

39 
	gSIGACTIONMASK
 = 5;

42 
	gRESETHANDLER
 = 6;

45 
İtiÚ®
 
SigÇlTe¡Ty³
 
	gsigÇl_‹¡_ty³
 = 1;

48 
ex‹nd
 
	gEnşaveIÅut
 {

49 
İtiÚ®
 
SigÇlTe¡IÅut
 
	gsigÇl_‹¡_šput
 = 196854770;

52 
ex‹nd
 
	gEnşaveOuut
 {

53 
İtiÚ®
 
boŞ
 
	gsigÇl_»ûived
 = 196854770;

	@../asylo/test/util/test_string.proto

17 
	gsyÁax
 = "proto2";

19 
·ckage
 
	gasylo
;

21 
	gimpÜt
 "asylo/enclave.proto";

23 
mes§ge
 
	gEnşaveTe¡SŒšg
 {

24 
İtiÚ®
 
¡ršg
 
	g‹¡_¡ršg
 = 1;

27 
ex‹nd
 
	gEnşaveCÚfig
 {

28 
İtiÚ®
 
EnşaveTe¡SŒšg
 
	g’şave_cÚfig_‹¡_¡ršg
 = 157658776;

31 
ex‹nd
 
	gEnşaveIÅut
 {

32 
İtiÚ®
 
EnşaveTe¡SŒšg
 
	g’şave_šput_‹¡_¡ršg
 = 157658777;

35 
ex‹nd
 
	gEnşaveFš®
 {

36 
İtiÚ®
 
EnşaveTe¡SŒšg
 
	g’şave_fš®_‹¡_¡ršg
 = 157658778;

39 
ex‹nd
 
	gEnşaveOuut
 {

40 
İtiÚ®
 
EnşaveTe¡SŒšg
 
	g’şave_ouut_‹¡_¡ršg
 = 158466505;

	@../asylo/util/status.proto

17 
	gsyÁax
 = "proto2";

24 
·ckage
 
	gasylo
;

27 
mes§ge
 
	gStusPrÙo
 {

29 
İtiÚ®
 
št32
 
	gcode
 = 1;

32 
İtiÚ®
 
¡ršg
 
	g”rÜ_mes§ge
 = 2;

35 
İtiÚ®
 
¡ršg
 
	g¥aû
 = 3;

38 
İtiÚ®
 
št32
 
	gÿnÚiÿl_code
 = 4;

	@bazel/application_wrapper/application_wrapper_driver.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”_driv”_maš.h
"

20 
	~"asylo/ş›Á.h
"

21 
	~"asylo/’şave_mªag”.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/ut/¡©usÜ.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkSeùiÚName
[] = "enclave";

32 
cÚ¡ex´
 
	gkEnşaveName
[] = "application_enclave";

37 
	$maš
(
¬gc
, *
¬gv
[]) {

39 
asylo
::
Stus
 
¡©us
 =

40 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

41 
	`LOG_IF
(
FATAL
, !
¡©us
.
	`ok
())

42 << "FaedØcÚfigu» EnşaveMªag”: " << 
¡©us
;

45 
asylo
::
SgxEmbeddedLßd”
 
	`lßd”
×sylo::
kSeùiÚName
, 
Œue
);

48 autØ
maš_»tuº
 = 
asylo
::
	`AµliÿtiÚW¿µ”Driv”Maš
(

49 
lßd”
, 
asylo
::
kEnşaveName
, 
¬gc
, 
¬gv
);

50 
	`LOG_IF
(
FATAL
, !
maš_»tuº
.
	`ok
())

52 << 
maš_»tuº
.
	`¡©us
();

55  
maš_»tuº
.
	`V®ueOrD›
();

56 
	}
}

	@bazel/application_wrapper/application_wrapper_driver.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”_driv”_maš.h
"

20 
	~"asylo/ş›Á.h
"

21 
	~"asylo/’şave_mªag”.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/ut/¡©usÜ.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkSeùiÚName
[] = "enclave";

32 
cÚ¡ex´
 
	gkEnşaveName
[] = "application_enclave";

37 
	$maš
(
¬gc
, *
¬gv
[]) {

39 
asylo
::
Stus
 
¡©us
 =

40 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

41 
	`LOG_IF
(
FATAL
, !
¡©us
.
	`ok
())

42 << "FaedØcÚfigu» EnşaveMªag”: " << 
¡©us
;

45 
asylo
::
SgxEmbeddedLßd”
 
	`lßd”
×sylo::
kSeùiÚName
, 
Œue
);

48 autØ
maš_»tuº
 = 
asylo
::
	`AµliÿtiÚW¿µ”Driv”Maš
(

49 
lßd”
, 
asylo
::
kEnşaveName
, 
¬gc
, 
¬gv
);

50 
	`LOG_IF
(
FATAL
, !
maš_»tuº
.
	`ok
())

52 << 
maš_»tuº
.
	`¡©us
();

55  
maš_»tuº
.
	`V®ueOrD›
();

56 
	}
}

	@bazel/application_wrapper/application_wrapper_driver_main.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”_driv”_maš.h
"

21 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

22 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/ut/ş—nup.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
	gStusOr
<> 
AµliÿtiÚW¿µ”Driv”Maš
(cÚ¡ 
EnşaveLßd”
 &
lßd”
,

32 cÚ¡ 
¡d
::
¡ršg
 &
’şave_Çme
,

33 
¬gc
, *
¬gv
[]) {

35 
EnşaveMªag”
 *
	gmªag”
;

36 
ASYLO_ASSIGN_OR_RETURN
(
mªag”
, 
EnşaveMªag”
::
In¡ªû
());

39 
EnşaveCÚfig
 
	gcÚfig
 = 
G‘AµliÿtiÚCÚfig
();

40 
	gArgv
::
Wr™eArgvToR•—‹dSŒšgF›ld
(

41 
¬gc
, 
¬gv
,

42 
cÚfig
.
MubËEx‹nsiÚ
(
commªd_lše_¬gs
)->
mubË_¬gum’ts
());

43 
	gcÚfig
.
£t_’abË_fÜk
(
Œue
);

46 
ASYLO_RETURN_IF_ERROR
(
mªag”
->
LßdEnşave
(
’şave_Çme
, 
lßd”
, 
cÚfig
));

47 
EnşaveCl›Á
 *
	gş›Á
 = 
mªag”
->
G‘Cl›Á
(
’şave_Çme
);

51 
CËªup
 
de¡roy_’şave
([
mªag”
, 
ş›Á
]() {

54 
Stus
 
¡©us
 = 
mªag”
->
De¡royEnşave
(
ş›Á
, 
EnşaveFš®
());

55 
LOG_IF
(
ERROR
, !
¡©us
.
ok
())

56 << "FaedØde¡royh­¶iÿtiÚƒnşave: " << 
¡©us
;

60 
EnşaveOuut
 
	gouut
;

61 
ASYLO_RETURN_IF_ERROR
(
ş›Á
->
EÁ”AndRun
(
EnşaveIÅut
(), &
ouut
));

62 ià(!
	gouut
.
HasEx‹nsiÚ
(
maš_»tuº_v®ue
)) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

66 
	gmaš_»tuº
 = 
ouut
.
G‘Ex‹nsiÚ
(
maš_»tuº_v®ue
);

69 
	gde¡roy_’şave
.
»Ëa£
();

70 
ASYLO_RETURN_IF_ERROR
(
mªag”
->
De¡royEnşave
(
ş›Á
, 
EnşaveFš®
()));

72  
	gmaš_»tuº
;

	@bazel/application_wrapper/application_wrapper_driver_main.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”_driv”_maš.h
"

21 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

22 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/ut/ş—nup.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
	gStusOr
<> 
AµliÿtiÚW¿µ”Driv”Maš
(cÚ¡ 
EnşaveLßd”
 &
lßd”
,

32 cÚ¡ 
¡d
::
¡ršg
 &
’şave_Çme
,

33 
¬gc
, *
¬gv
[]) {

35 
EnşaveMªag”
 *
	gmªag”
;

36 
ASYLO_ASSIGN_OR_RETURN
(
mªag”
, 
EnşaveMªag”
::
In¡ªû
());

39 
EnşaveCÚfig
 
	gcÚfig
 = 
G‘AµliÿtiÚCÚfig
();

40 
	gArgv
::
Wr™eArgvToR•—‹dSŒšgF›ld
(

41 
¬gc
, 
¬gv
,

42 
cÚfig
.
MubËEx‹nsiÚ
(
commªd_lše_¬gs
)->
mubË_¬gum’ts
());

43 
	gcÚfig
.
£t_’abË_fÜk
(
Œue
);

46 
ASYLO_RETURN_IF_ERROR
(
mªag”
->
LßdEnşave
(
’şave_Çme
, 
lßd”
, 
cÚfig
));

47 
EnşaveCl›Á
 *
	gş›Á
 = 
mªag”
->
G‘Cl›Á
(
’şave_Çme
);

51 
CËªup
 
de¡roy_’şave
([
mªag”
, 
ş›Á
]() {

54 
Stus
 
¡©us
 = 
mªag”
->
De¡royEnşave
(
ş›Á
, 
EnşaveFš®
());

55 
LOG_IF
(
ERROR
, !
¡©us
.
ok
())

56 << "FaedØde¡royh­¶iÿtiÚƒnşave: " << 
¡©us
;

60 
EnşaveOuut
 
	gouut
;

61 
ASYLO_RETURN_IF_ERROR
(
ş›Á
->
EÁ”AndRun
(
EnşaveIÅut
(), &
ouut
));

62 ià(!
	gouut
.
HasEx‹nsiÚ
(
maš_»tuº_v®ue
)) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

66 
	gmaš_»tuº
 = 
ouut
.
G‘Ex‹nsiÚ
(
maš_»tuº_v®ue
);

69 
	gde¡roy_’şave
.
»Ëa£
();

70 
ASYLO_RETURN_IF_ERROR
(
mªag”
->
De¡royEnşave
(
ş›Á
, 
EnşaveFš®
()));

72  
	gmaš_»tuº
;

	@bazel/application_wrapper/application_wrapper_driver_main.h

19 #iâdeà
ASYLO_BAZEL_APPLICATION_WRAPPER_APPLICATION_WRAPPER_DRIVER_MAIN_H_


20 
	#ASYLO_BAZEL_APPLICATION_WRAPPER_APPLICATION_WRAPPER_DRIVER_MAIN_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/’şave.pb.h
"

25 
	~"asylo/’şave_mªag”.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

30 "C" 
asylo
::
EnşaveCÚfig
 
G‘AµliÿtiÚCÚfig
();

32 
Çme¥aû
 
	gasylo
 {

40 
	gStusOr
<> 
AµliÿtiÚW¿µ”Driv”Maš
(cÚ¡ 
EnşaveLßd”
 &
lßd”
,

41 cÚ¡ 
¡d
::
¡ršg
 &
’şave_Çme
,

42 
¬gc
, *
¬gv
[]);

	@bazel/application_wrapper/application_wrapper_driver_main_test.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”_driv”_maš.h
"

21 
	~<uni¡d.h
>

22 
	~<¬¿y
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

30 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

31 
	~"asylo/ş›Á.h
"

32 
	~"asylo/’şave_mªag”.h
"

33 
	~"asylo/‹¡/ut/çke_’şave_lßd”.h
"

34 
	~"asylo/‹¡/ut/mock_’şave_ş›Á.h
"

35 
	~"asylo/‹¡/ut/ouut_cŞËùÜ.h
"

36 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

40 
asylo
::
EnşaveCÚfig
 
cÚfig
;

41 
cÚfig
.
	`£t_¡dš_fd
(2);

42 
cÚfig
.
	`£t_¡dout_fd
(3);

43 
cÚfig
.
	`£t_¡d”r_fd
(5);

44  
cÚfig
;

45 
	}
}

47 
Çme¥aû
 
asylo
 {

48 
Çme¥aû
 {

50 
usšg
 ::
‹¡šg
::
_
;

51 
usšg
 ::
‹¡šg
::
DoAÎ
;

52 
usšg
 ::
‹¡šg
::
HasSub¡r
;

53 
usšg
 ::
‹¡šg
::
InSequ’û
;

54 
usšg
 ::
‹¡šg
::
R‘uº
;

55 
usšg
 ::
‹¡šg
::
S‘ArgPoš‹e
;

56 
usšg
 ::
‹¡šg
::
SŒiùMock
;

59 şas 
	cAµliÿtiÚW¿µ”Driv”MašTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

60 
´Ùeùed
:

61 
AµliÿtiÚW¿µ”Driv”MašTe¡
()

62 : 
ş›Á_owÃd_
(
Ãw
 
SŒiùMock
<
MockEnşaveCl›Á
>) {

63 
ş›Á_
 = 
ş›Á_owÃd_
.
g‘
();

66 
S‘UpTe¡Su™e
() {

67 
ASYLO_ASSERT_OK
(
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
()));

71 
FakeEnşaveLßd”
 
Lßd”
() {

72  
FakeEnşaveLßd”
(
¡d
::
move
(
ş›Á_owÃd_
));

76 
SŒiùMock
<
MockEnşaveCl›Á
> *
ş›Á_
;

78 
´iv©e
:

79 
¡d
::
unique_±r
<
SŒiùMock
<
MockEnşaveCl›Á
>> 
ş›Á_owÃd_
;

82 
InSequ’û
 
’fÜû_ÿÎ_Üd”_
;

88 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

89 
C®lsLßdEnşaveTh’EÁ”AndRunTh’De¡royEnşave
) {

90 
EnşaveOuut
 
’şave_ouut
;

91 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

93 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

94 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

95 .
WlOnû
(

96 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

97 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

98 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

100 *
¬g
 = 
nuÎ±r
;

101 
EXPECT_THAT
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "normal_workflow",

102  0, &
¬g
),

103 
IsOkAndHŞds
(0));

108 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
FÜw¬dsFau»StusFromLßdEnşave
) {

109 cÚ¡ 
Stus
 
lßd_’şave_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

111 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
))

112 .
WlOnû
(
R‘uº
(
lßd_’şave_çu»
));

113 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _)).
Times
(0);

114 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
)).
Times
(0);

115 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

117 *
¬g
 = 
nuÎ±r
;

118 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "load_failure", 0,

119  &
¬g
)

120 .
¡©us
(),

121 
lßd_’şave_çu»
);

126 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
FÜw¬dsFau»StusFromEÁ”AndRun
) {

127 cÚ¡ 
Stus
 
’‹r_ªd_run_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

130 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

131 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

132 .
WlOnû
(
R‘uº
(
’‹r_ªd_run_çu»
));

133 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

134 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

136 *
¬g
 = 
nuÎ±r
;

137 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "run_failure", 0,

138  &
¬g
)

139 .
¡©us
(),

140 
’‹r_ªd_run_çu»
);

145 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

146 
R‘uºsE¼ÜIfNoMašR‘uºV®ueEx‹nsiÚ
) {

147 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

148 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _));

149 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

150 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

152 *
¬g
 = 
nuÎ±r
;

153 
EXPECT_THAT
(

154 
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "no_extension", 0,

155  &
¬g
)

156 .
¡©us
(),

157 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

163 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

164 
LogsE¼ÜMes§geIfDe¡royEnşaveFasDuršgE¼ÜProûssšg
) {

165 cÚ¡ 
Stus
 
’‹r_ªd_run_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

166 cÚ¡ 
Stus
 
de¡roy_’şave_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "bazzle");

168 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

169 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

170 .
WlOnû
(
R‘uº
(
’‹r_ªd_run_çu»
));

171 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
))

172 .
WlOnû
(
R‘uº
(
de¡roy_’şave_çu»
));

173 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

175 *
¬g
 = 
nuÎ±r
;

176 
OuutCŞËùÜ
 
cŞËù_¡d”r
(
kCŞËùStd”r
);

177 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "double_failure", 0,

178  &
¬g
)

179 .
¡©us
(),

180 
’‹r_ªd_run_çu»
);

181 
EXPECT_THAT
(
cŞËù_¡d”r
.
CŞËùAÎOuutAndRe¡Üe
(),

182 
IsOkAndHŞds
(
HasSub¡r
(

183 
ab¦
::
SŒC©
("Failedo destroyhe‡pplicationƒnclave: ",

184 
de¡roy_’şave_çu»
.
ToSŒšg
()))));

189 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

190 
FÜw¬dsFau»StusFromDe¡royEnşave
) {

191 cÚ¡ 
Stus
 
de¡roy_’şave_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

193 
EnşaveOuut
 
’şave_ouut
;

194 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

196 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

197 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

198 .
WlOnû
(

199 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

200 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
))

201 .
WlOnû
(
R‘uº
(
de¡roy_’şave_çu»
));

202 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

204 *
¬g
 = 
nuÎ±r
;

205 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "destory_failure",

206  0, &
¬g
)

207 .
¡©us
(),

208 
de¡roy_’şave_çu»
);

213 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
Prİag©esAµliÿtiÚCÚfig
) {

214 
EnşaveCÚfig
 
ex³ùed_cÚfig
 = 
G‘AµliÿtiÚCÚfig
();

216 
EnşaveOuut
 
’şave_ouut
;

217 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

219 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
P¬tŸÎy
(
ex³ùed_cÚfig
)));

220 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

221 .
WlOnû
(

222 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

223 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

224 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

226 *
¬g
 = 
nuÎ±r
;

227 
EXPECT_THAT
(

228 
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "custom_config", 0,

229  &
¬g
),

230 
IsOkAndHŞds
(0));

235 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
Prİag©esCommªdLšeArgs
) {

236 cÚ¡ 
¡d
::
¬¿y
<¡d::
¡ršg
, 9> 
kTe¡Args
 = {

239 
EnşaveCÚfig
 
ex³ùed_cÚfig
;

240 
CommªdLšeArgs
 *
´Ùo_¬gs
 =

241 
ex³ùed_cÚfig
.
MubËEx‹nsiÚ
(
commªd_lše_¬gs
);

242 cÚ¡ 
¡d
::
¡ršg
 &
¬gum’t
 : 
kTe¡Args
) {

243 
´Ùo_¬gs
->
add_¬gum’ts
(
¬gum’t
);

246 
EnşaveOuut
 
’şave_ouut
;

247 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

249 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
P¬tŸÎy
(
ex³ùed_cÚfig
)));

250 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

251 .
WlOnû
(

252 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

253 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

254 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

256 
Argv
 
c_¬gs
(
kTe¡Args
);

257 
¬gc
 = 
c_¬gs
.argc();

258 **
¬gv
 = 
c_¬gs
.argv();

259 
EXPECT_THAT
(

260 
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "commªd_lše_¬gs", 
¬gc
, 
¬gv
),

261 
IsOkAndHŞds
(0));

266 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
Prİag©esMašR‘uºV®ue
) {

267 
cÚ¡ex´
 
kTe¡MašR‘uºV®ue
 = 42;

269 
EnşaveOuut
 
’şave_ouut
;

270 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 
kTe¡MašR‘uºV®ue
);

272 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

273 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

274 .
WlOnû
(

275 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

276 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

277 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

279 *
¬g
 = 
nuÎ±r
;

280 
EXPECT_THAT
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "main_return", 0,

281  &
¬g
),

282 
IsOkAndHŞds
(
kTe¡MašR‘uºV®ue
));

	@bazel/application_wrapper/application_wrapper_driver_main_test.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”_driv”_maš.h
"

21 
	~<uni¡d.h
>

22 
	~<¬¿y
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

30 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

31 
	~"asylo/ş›Á.h
"

32 
	~"asylo/’şave_mªag”.h
"

33 
	~"asylo/‹¡/ut/çke_’şave_lßd”.h
"

34 
	~"asylo/‹¡/ut/mock_’şave_ş›Á.h
"

35 
	~"asylo/‹¡/ut/ouut_cŞËùÜ.h
"

36 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

40 
asylo
::
EnşaveCÚfig
 
cÚfig
;

41 
cÚfig
.
	`£t_¡dš_fd
(2);

42 
cÚfig
.
	`£t_¡dout_fd
(3);

43 
cÚfig
.
	`£t_¡d”r_fd
(5);

44  
cÚfig
;

45 
	}
}

47 
Çme¥aû
 
asylo
 {

48 
Çme¥aû
 {

50 
usšg
 ::
‹¡šg
::
_
;

51 
usšg
 ::
‹¡šg
::
DoAÎ
;

52 
usšg
 ::
‹¡šg
::
HasSub¡r
;

53 
usšg
 ::
‹¡šg
::
InSequ’û
;

54 
usšg
 ::
‹¡šg
::
R‘uº
;

55 
usšg
 ::
‹¡šg
::
S‘ArgPoš‹e
;

56 
usšg
 ::
‹¡šg
::
SŒiùMock
;

59 şas 
	cAµliÿtiÚW¿µ”Driv”MašTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

60 
´Ùeùed
:

61 
AµliÿtiÚW¿µ”Driv”MašTe¡
()

62 : 
ş›Á_owÃd_
(
Ãw
 
SŒiùMock
<
MockEnşaveCl›Á
>) {

63 
ş›Á_
 = 
ş›Á_owÃd_
.
g‘
();

66 
S‘UpTe¡Su™e
() {

67 
ASYLO_ASSERT_OK
(
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
()));

71 
FakeEnşaveLßd”
 
Lßd”
() {

72  
FakeEnşaveLßd”
(
¡d
::
move
(
ş›Á_owÃd_
));

76 
SŒiùMock
<
MockEnşaveCl›Á
> *
ş›Á_
;

78 
´iv©e
:

79 
¡d
::
unique_±r
<
SŒiùMock
<
MockEnşaveCl›Á
>> 
ş›Á_owÃd_
;

82 
InSequ’û
 
’fÜû_ÿÎ_Üd”_
;

88 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

89 
C®lsLßdEnşaveTh’EÁ”AndRunTh’De¡royEnşave
) {

90 
EnşaveOuut
 
’şave_ouut
;

91 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

93 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

94 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

95 .
WlOnû
(

96 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

97 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

98 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

100 *
¬g
 = 
nuÎ±r
;

101 
EXPECT_THAT
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "normal_workflow",

102  0, &
¬g
),

103 
IsOkAndHŞds
(0));

108 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
FÜw¬dsFau»StusFromLßdEnşave
) {

109 cÚ¡ 
Stus
 
lßd_’şave_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

111 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
))

112 .
WlOnû
(
R‘uº
(
lßd_’şave_çu»
));

113 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _)).
Times
(0);

114 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
)).
Times
(0);

115 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

117 *
¬g
 = 
nuÎ±r
;

118 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "load_failure", 0,

119  &
¬g
)

120 .
¡©us
(),

121 
lßd_’şave_çu»
);

126 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
FÜw¬dsFau»StusFromEÁ”AndRun
) {

127 cÚ¡ 
Stus
 
’‹r_ªd_run_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

130 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

131 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

132 .
WlOnû
(
R‘uº
(
’‹r_ªd_run_çu»
));

133 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

134 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

136 *
¬g
 = 
nuÎ±r
;

137 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "run_failure", 0,

138  &
¬g
)

139 .
¡©us
(),

140 
’‹r_ªd_run_çu»
);

145 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

146 
R‘uºsE¼ÜIfNoMašR‘uºV®ueEx‹nsiÚ
) {

147 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

148 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _));

149 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

150 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

152 *
¬g
 = 
nuÎ±r
;

153 
EXPECT_THAT
(

154 
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "no_extension", 0,

155  &
¬g
)

156 .
¡©us
(),

157 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

163 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

164 
LogsE¼ÜMes§geIfDe¡royEnşaveFasDuršgE¼ÜProûssšg
) {

165 cÚ¡ 
Stus
 
’‹r_ªd_run_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

166 cÚ¡ 
Stus
 
de¡roy_’şave_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "bazzle");

168 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

169 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

170 .
WlOnû
(
R‘uº
(
’‹r_ªd_run_çu»
));

171 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
))

172 .
WlOnû
(
R‘uº
(
de¡roy_’şave_çu»
));

173 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

175 *
¬g
 = 
nuÎ±r
;

176 
OuutCŞËùÜ
 
cŞËù_¡d”r
(
kCŞËùStd”r
);

177 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "double_failure", 0,

178  &
¬g
)

179 .
¡©us
(),

180 
’‹r_ªd_run_çu»
);

181 
EXPECT_THAT
(
cŞËù_¡d”r
.
CŞËùAÎOuutAndRe¡Üe
(),

182 
IsOkAndHŞds
(
HasSub¡r
(

183 
ab¦
::
SŒC©
("Failedo destroyhe‡pplicationƒnclave: ",

184 
de¡roy_’şave_çu»
.
ToSŒšg
()))));

189 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
,

190 
FÜw¬dsFau»StusFromDe¡royEnşave
) {

191 cÚ¡ 
Stus
 
de¡roy_’şave_çu»
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "foobar");

193 
EnşaveOuut
 
’şave_ouut
;

194 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

196 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

197 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

198 .
WlOnû
(

199 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

200 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
))

201 .
WlOnû
(
R‘uº
(
de¡roy_’şave_çu»
));

202 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

204 *
¬g
 = 
nuÎ±r
;

205 
EXPECT_EQ
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "destory_failure",

206  0, &
¬g
)

207 .
¡©us
(),

208 
de¡roy_’şave_çu»
);

213 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
Prİag©esAµliÿtiÚCÚfig
) {

214 
EnşaveCÚfig
 
ex³ùed_cÚfig
 = 
G‘AµliÿtiÚCÚfig
();

216 
EnşaveOuut
 
’şave_ouut
;

217 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

219 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
P¬tŸÎy
(
ex³ùed_cÚfig
)));

220 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

221 .
WlOnû
(

222 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

223 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

224 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

226 *
¬g
 = 
nuÎ±r
;

227 
EXPECT_THAT
(

228 
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "custom_config", 0,

229  &
¬g
),

230 
IsOkAndHŞds
(0));

235 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
Prİag©esCommªdLšeArgs
) {

236 cÚ¡ 
¡d
::
¬¿y
<¡d::
¡ršg
, 9> 
kTe¡Args
 = {

239 
EnşaveCÚfig
 
ex³ùed_cÚfig
;

240 
CommªdLšeArgs
 *
´Ùo_¬gs
 =

241 
ex³ùed_cÚfig
.
MubËEx‹nsiÚ
(
commªd_lše_¬gs
);

242 cÚ¡ 
¡d
::
¡ršg
 &
¬gum’t
 : 
kTe¡Args
) {

243 
´Ùo_¬gs
->
add_¬gum’ts
(
¬gum’t
);

246 
EnşaveOuut
 
’şave_ouut
;

247 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 0);

249 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
P¬tŸÎy
(
ex³ùed_cÚfig
)));

250 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

251 .
WlOnû
(

252 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

253 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

254 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

256 
Argv
 
c_¬gs
(
kTe¡Args
);

257 
¬gc
 = 
c_¬gs
.argc();

258 **
¬gv
 = 
c_¬gs
.argv();

259 
EXPECT_THAT
(

260 
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "commªd_lše_¬gs", 
¬gc
, 
¬gv
),

261 
IsOkAndHŞds
(0));

266 
TEST_F
(
AµliÿtiÚW¿µ”Driv”MašTe¡
, 
Prİag©esMašR‘uºV®ue
) {

267 
cÚ¡ex´
 
kTe¡MašR‘uºV®ue
 = 42;

269 
EnşaveOuut
 
’şave_ouut
;

270 
’şave_ouut
.
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 
kTe¡MašR‘uºV®ue
);

272 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndIn™Ÿlize
(
_
));

273 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndRun
(
_
, _))

274 .
WlOnû
(

275 
DoAÎ
(
S‘ArgPoš‹e
<1>(
’şave_ouut
), 
R‘uº
(
Stus
::
OkStus
())));

276 
EXPECT_CALL
(*
ş›Á_
, 
EÁ”AndFš®ize
(
_
));

277 
EXPECT_CALL
(*
ş›Á_
, 
De¡royEnşave
());

279 *
¬g
 = 
nuÎ±r
;

280 
EXPECT_THAT
(
AµliÿtiÚW¿µ”Driv”Maš
(
Lßd”
(), "main_return", 0,

281  &
¬g
),

282 
IsOkAndHŞds
(
kTe¡MašR‘uºV®ue
));

	@bazel/application_wrapper/application_wrapper_enclave.cc

19 
	~<©omic
>

20 
	~<¡ršg
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

24 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

25 
	~"asylo/ut/loggšg.h
"

26 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
maš
(
¬gc
, *
¬gv
[]);

31 
Çme¥aû
 
	gasylo
 {

35 şas 
	cAµliÿtiÚW¿µ”Enşave
 
	gfš®
 : 
public
 
Tru¡edAµliÿtiÚ
 {

36 
public
:

37 
AµliÿtiÚW¿µ”Enşave
(è: 
has_run_
(
çl£
) {}

42 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
ov”ride
 {

43 ià(!
cÚfig
.
HasEx‹nsiÚ
(
commªd_lše_¬gs
)) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

47 
	g¬gs_unm¬sh®”_
 =

48 
Argv
(
cÚfig
.
G‘Ex‹nsiÚ
(
commªd_lše_¬gs
).
¬gum’ts
());

50  
	gStus
::
OkStus
();

58 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

60 ià(
	ghas_run_
.
exchªge
(
Œue
)) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

66 
	g¬gc
 = 
¬gs_unm¬sh®”_
.
¬gc
();

67 **
	g¬gv
 = 
¬gs_unm¬sh®”_
.
¬gv
();

70 
	gouut
->
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 
maš
(
¬gc
, 
¬gv
));

72  
	gStus
::
OkStus
();

76 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
è
	gov”ride
 {

77 cÚ¡ *
	gdebug_­¶iÿtiÚ_Çme
 = 
¬gs_unm¬sh®”_
.
¬gc
() > 0

78 ? 
¬gs_unm¬sh®”_
.
¬gv
()[0]

81 
LOG_IF
(
WARNING
, !
has_run_
.
lßd
())

82 << 
	gab¦
::
SŒC©
(
debug_­¶iÿtiÚ_Çme
,

85  
	gStus
::
OkStus
();

88 
	g´iv©e
:

90 
¡d
::
©omic_boŞ
 
has_run_
;

93 
Argv
 
	g¬gs_unm¬sh®”_
;

96 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

97  
Ãw
 
AµliÿtiÚW¿µ”Enşave
;

98 
	}
}

	@bazel/application_wrapper/application_wrapper_enclave.cc

19 
	~<©omic
>

20 
	~<¡ršg
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

24 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

25 
	~"asylo/ut/loggšg.h
"

26 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
maš
(
¬gc
, *
¬gv
[]);

31 
Çme¥aû
 
	gasylo
 {

35 şas 
	cAµliÿtiÚW¿µ”Enşave
 
	gfš®
 : 
public
 
Tru¡edAµliÿtiÚ
 {

36 
public
:

37 
AµliÿtiÚW¿µ”Enşave
(è: 
has_run_
(
çl£
) {}

42 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
ov”ride
 {

43 ià(!
cÚfig
.
HasEx‹nsiÚ
(
commªd_lše_¬gs
)) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

47 
	g¬gs_unm¬sh®”_
 =

48 
Argv
(
cÚfig
.
G‘Ex‹nsiÚ
(
commªd_lše_¬gs
).
¬gum’ts
());

50  
	gStus
::
OkStus
();

58 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

60 ià(
	ghas_run_
.
exchªge
(
Œue
)) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

66 
	g¬gc
 = 
¬gs_unm¬sh®”_
.
¬gc
();

67 **
	g¬gv
 = 
¬gs_unm¬sh®”_
.
¬gv
();

70 
	gouut
->
S‘Ex‹nsiÚ
(
maš_»tuº_v®ue
, 
maš
(
¬gc
, 
¬gv
));

72  
	gStus
::
OkStus
();

76 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
è
	gov”ride
 {

77 cÚ¡ *
	gdebug_­¶iÿtiÚ_Çme
 = 
¬gs_unm¬sh®”_
.
¬gc
() > 0

78 ? 
¬gs_unm¬sh®”_
.
¬gv
()[0]

81 
LOG_IF
(
WARNING
, !
has_run_
.
lßd
())

82 << 
	gab¦
::
SŒC©
(
debug_­¶iÿtiÚ_Çme
,

85  
	gStus
::
OkStus
();

88 
	g´iv©e
:

90 
¡d
::
©omic_boŞ
 
has_run_
;

93 
Argv
 
	g¬gs_unm¬sh®”_
;

96 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

97  
Ãw
 
AµliÿtiÚW¿µ”Enşave
;

98 
	}
}

	@bazel/application_wrapper/application_wrapper_enclave_test.cc

19 
	~<®gÜ™hm
>

20 
	~<funùiÚ®
>

21 
	~<¡ršg
>

22 
	~<th»ad
>

23 
	~<ut™y
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"ab¦/¡ršgs/¡r_još.h
"

30 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

31 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

32 
	~"asylo/ş›Á.h
"

33 
	~"asylo/’şave.pb.h
"

34 
	~"asylo/’şave_mªag”.h
"

35 
	~"gæags/gæags.h
"

36 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

37 
	~"asylo/ut/fd_uts.h
"

38 
	~"asylo/ut/¡©us.h
"

40 
DEFINE_¡ršg
(
’şave_£ùiÚ
, "", "The ELF sectiono†oadheƒnclave from");

42 
Çme¥aû
 
	gasylo
 {

43 
	gÇme¥aû
 {

45 
	gusšg
 ::
‹¡šg
::
HasSub¡r
;

46 
	gusšg
 ::
‹¡šg
::
M©ch”
;

47 
	gusšg
 ::
‹¡šg
::
UnÜd”edEËm’tsA»A¼ay
;

50 
cÚ¡ex´
 
	gkEnşaveName
[] = "enclave";

53 şas 
	cAµliÿtiÚW¿µ”EnşaveTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

54 
public
:

62 
Stus
 
RunEnşave
() {

63 
¡d
::
¡ršg
 
ex³ùed_¡dout
 = 
ab¦
::
SŒJoš
(
¬gs_
, "\n");

64 ià(!
	g¬gs_
.
em±y
()) {

65 
	gab¦
::
SŒAµ’d
(&
ex³ùed_¡dout
, "\n");

67 
	gab¦
::
SŒAµ’d
(&
ex³ùed_¡dout
,

68 
ab¦
::
SŒJoš
(
’vœÚm’t_v¬ŸbËs_
, "\n",

69 
EnvœÚm’tV¬ŸbËFÜm©‹r
()));

70 ià(!
	g’vœÚm’t_v¬ŸbËs_
.
em±y
()) {

71 
	gab¦
::
SŒAµ’d
(&
ex³ùed_¡dout
, "\n");

74 
EnşaveOuut
 
	gouut
;

75 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
EnşaveIÅut
(), &
ouut
);

76 
CheckStdout
(
¡©us
.
ok
(è? 
ex³ùed_¡dout
 : "", 
ouut
);

77  
	g¡©us
;

80 
	g´Ùeùed
:

82 
S‘UpTe¡Su™e
() {

83 
ASYLO_ASSERT_OK
(
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
()));

84 
ASYLO_ASSERT_OK_AND_ASSIGN
(
mªag”_
, 
EnşaveMªag”
::
In¡ªû
());

87 
S‘Up
(è
	gov”ride
 {

88 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’şave_¡dout_
, 
Pe
::
C»©ePe
());

94 
Stus
 
LßdEnşave
(
¡d
::
veùÜ
<¡d::
¡ršg
> 
¬gv
,

95 
¡d
::
veùÜ
<¡d::
·œ
<¡d::
¡ršg
, std::¡ršg>> 
’vp
) {

97 
¬gs_
 = 
¡d
::
move
(
¬gv
);

98 
	g’vœÚm’t_v¬ŸbËs_
 = 
¡d
::
move
(
’vp
);

102 
EnşaveCÚfig
 
	gcÚfig
;

103 
	gcÚfig
.
£t_¡dout_fd
(
’şave_¡dout_
.
wr™e_fd
());

104 
CommªdLšeArgs
 *
	g¬gs
 = 
cÚfig
.
MubËEx‹nsiÚ
(
commªd_lše_¬gs
);

105 cÚ¡ 
	g¡d
::
¡ršg
 &
¬gum’t
 : 
¬gs_
) {

106 
¬gs
->
add_¬gum’ts
(
¬gum’t
);

108 cÚ¡‡utØ&
	g·œ
 : 
’vœÚm’t_v¬ŸbËs_
) {

109 
EnvœÚm’tV¬ŸbË
 *
v¬ŸbË
 = 
cÚfig
.
add_’vœÚm’t_v¬ŸbËs
();

110 
	gv¬ŸbË
->
£t_Çme
(
·œ
.
fœ¡
);

111 
	gv¬ŸbË
->
£t_v®ue
(
·œ
.
£cÚd
);

115 
SgxEmbeddedLßd”
 
lßd”
(
FLAGS_’şave_£ùiÚ
, 
Œue
);

116 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
(
kEnşaveName
, 
lßd”
, 
cÚfig
);

118 ià(
	g¡©us
.
ok
()) {

119 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
(
kEnşaveName
);

122  
	g¡©us
;

127 
Stus
 
De¡royEnşave
() {

128  
	gmªag”_
->
De¡royEnşave
(
ş›Á_
, 
EnşaveFš®
());

131 
EnşaveMªag”
 *
	gmªag”_
;

133 
EnşaveCl›Á
 *
	gş›Á_
;

135 
Pe
 
	g’şave_¡dout_
;

137 
	g´iv©e
:

145 
CheckStdout
(cÚ¡ 
¡d
::
¡ršg
 &
ex³ùed_¡dout
,

146 cÚ¡ 
EnşaveOuut
 &
’şave_ouut
) {

148 
	g¡d
::
¡ršg
 
pe_ouut
;

149 
ASYLO_ASSERT_OK
(
’şave_¡dout_
.
Clo£Wr™eFd
());

150 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe_ouut
, 
R—dAÎ
(
’şave_¡dout_
.
»ad_fd
()));

153 
EXPECT_EQ
(
pe_ouut
, 
ex³ùed_¡dout
);

157 ià(!
	gex³ùed_¡dout
.
em±y
()) {

158 
ASSERT_TRUE
(
’şave_ouut
.
HasEx‹nsiÚ
(
maš_»tuº_v®ue
));

159 
EXPECT_EQ
(
’şave_ouut
.
G‘Ex‹nsiÚ
(
maš_»tuº_v®ue
), 
¬gs_
.
size
());

163 
	sEnvœÚm’tV¬ŸbËFÜm©‹r
 {

164 
İ”©Ü
()(
	g¡d
::
¡ršg
 *
out
,

165 
	g¡d
::
·œ
<
¡d
::
¡ršg
, std::¡ršg> 
v¬ŸbË
) {

166 
out
->
­³nd
(
ab¦
::
SŒC©
(
v¬ŸbË
.
fœ¡
, "=\"", v¬ŸbË.
£cÚd
, "\""));

170 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gs_
;

171 
	g¡d
::
veùÜ
<
¡d
::
·œ
<¡d::
¡ršg
, std::¡ršg>> 
’vœÚm’t_v¬ŸbËs_
;

174 
EnşaveMªag”
 *
	gAµliÿtiÚW¿µ”EnşaveTe¡
::
mªag”_
 = 
nuÎ±r
;

178 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoArgs
) {

179 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {}));

180 
ASYLO_EXPECT_OK
(
RunEnşave
());

181 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

186 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
OÃArg
) {

187 
ASYLO_ASSERT_OK
(
LßdEnşave
( {"foo"}, {}));

188 
ASYLO_EXPECT_OK
(
RunEnşave
());

189 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

194 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
MªyArgs
) {

195 
ASYLO_ASSERT_OK
(
LßdEnşave
(

199 
ASYLO_EXPECT_OK
(
RunEnşave
());

200 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

205 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoArgsAndEnvœÚm’tV¬ŸbËs
) {

206 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {{"FOO", "foooo"}}));

207 
ASYLO_EXPECT_OK
(
RunEnşave
());

208 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

213 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
MªyArgsAndEnvœÚm’tV¬ŸbËs
) {

214 
ASYLO_ASSERT_OK
(
LßdEnşave
(

218 
ASYLO_EXPECT_OK
(
RunEnşave
());

219 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

224 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoArgsEx‹nsiÚ
) {

225 
SgxEmbeddedLßd”
 
lßd”
(
FLAGS_’şave_£ùiÚ
, 
Œue
);

226 
EXPECT_THAT
(

227 
mªag”_
->
LßdEnşave
(
kEnşaveName
, 
lßd”
),

228 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

234 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoMuÉËRun
) {

235 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {}));

236 
ASYLO_EXPECT_OK
(
RunEnşave
());

237 
EXPECT_THAT
(
RunEnşave
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

239 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

245 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoMuÉËRunFromMuÉËTh»ads
) {

247 
cÚ¡ex´
 
	gkNumTe¡Th»ads
 = 25;

252 cÚ¡ 
Stus
 
dummy_¡©us
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
,

257 
	gM©ch”
<cÚ¡ 
	gStus
 &> 
	g®»ady_run_¡©us_m©ch”
 = 
StusIs
(

258 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Application has‡lready„un");

259 
	g¡d
::
veùÜ
<
M©ch”
<cÚ¡ 
Stus
 &>> 
ex³ùed_¡©u£s
(

260 
kNumTe¡Th»ads
 - 1, 
®»ady_run_¡©us_m©ch”
);

261 
	gex³ùed_¡©u£s
.
push_back
(
IsOk
());

263 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {}));

267 
	g¡d
::
veùÜ
<
Stus
> 
run_¡©u£s
(
kNumTe¡Th»ads
, 
dummy_¡©us
);

269 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
run_th»ads
;

270 
	grun_th»ads
.
»£rve
(
kNumTe¡Th»ads
);

271 
	gi
 = 0; i < 
	gkNumTe¡Th»ads
; ++i) {

272 
	grun_th»ads
.
em¶aû_back
(

273 [
i
, &
run_¡©u£s
](
AµliÿtiÚW¿µ”EnşaveTe¡
 *
‹¡_fixtu»
) {

274 
Stus
 
¡©us
 = 
‹¡_fixtu»
->
RunEnşave
();

275 
run_¡©u£s
[
i
] = 
¡©us
;

277 
this
);

279 autØ&
	gth»ad
 : 
run_th»ads
) {

280 
th»ad
.
još
();

285 
EXPECT_THAT
(
run_¡©u£s
, 
UnÜd”edEËm’tsA»A¼ay
(
ex³ùed_¡©u£s
));

286 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

292 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
Fš®izeLogsW¬nšgIfNoRun
) {

293 
cÚ¡ex´
 
	gkTe¡AµliÿtiÚName
[] = "Jean-Luc Picard";

295 
ASYLO_ASSERT_OK
(
LßdEnşave
Ğ{
kTe¡AµliÿtiÚName
}, {}));

296 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

298 
ASYLO_ASSERT_OK
(
’şave_¡dout_
.
Clo£Wr™eFd
());

299 
EXPECT_THAT
(
R—dAÎ
(
’şave_¡dout_
.
»ad_fd
()),

300 
IsOkAndHŞds
(
HasSub¡r
(
ab¦
::
SŒC©
(

301 
kTe¡AµliÿtiÚName
,

	@bazel/application_wrapper/application_wrapper_enclave_test.cc

19 
	~<®gÜ™hm
>

20 
	~<funùiÚ®
>

21 
	~<¡ršg
>

22 
	~<th»ad
>

23 
	~<ut™y
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"ab¦/¡ršgs/¡r_još.h
"

30 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

31 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/­¶iÿtiÚ_w¿µ”.pb.h
"

32 
	~"asylo/ş›Á.h
"

33 
	~"asylo/’şave.pb.h
"

34 
	~"asylo/’şave_mªag”.h
"

35 
	~"gæags/gæags.h
"

36 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

37 
	~"asylo/ut/fd_uts.h
"

38 
	~"asylo/ut/¡©us.h
"

40 
DEFINE_¡ršg
(
’şave_£ùiÚ
, "", "The ELF sectiono†oadheƒnclave from");

42 
Çme¥aû
 
	gasylo
 {

43 
	gÇme¥aû
 {

45 
	gusšg
 ::
‹¡šg
::
HasSub¡r
;

46 
	gusšg
 ::
‹¡šg
::
M©ch”
;

47 
	gusšg
 ::
‹¡šg
::
UnÜd”edEËm’tsA»A¼ay
;

50 
cÚ¡ex´
 
	gkEnşaveName
[] = "enclave";

53 şas 
	cAµliÿtiÚW¿µ”EnşaveTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

54 
public
:

62 
Stus
 
RunEnşave
() {

63 
¡d
::
¡ršg
 
ex³ùed_¡dout
 = 
ab¦
::
SŒJoš
(
¬gs_
, "\n");

64 ià(!
	g¬gs_
.
em±y
()) {

65 
	gab¦
::
SŒAµ’d
(&
ex³ùed_¡dout
, "\n");

67 
	gab¦
::
SŒAµ’d
(&
ex³ùed_¡dout
,

68 
ab¦
::
SŒJoš
(
’vœÚm’t_v¬ŸbËs_
, "\n",

69 
EnvœÚm’tV¬ŸbËFÜm©‹r
()));

70 ià(!
	g’vœÚm’t_v¬ŸbËs_
.
em±y
()) {

71 
	gab¦
::
SŒAµ’d
(&
ex³ùed_¡dout
, "\n");

74 
EnşaveOuut
 
	gouut
;

75 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
EnşaveIÅut
(), &
ouut
);

76 
CheckStdout
(
¡©us
.
ok
(è? 
ex³ùed_¡dout
 : "", 
ouut
);

77  
	g¡©us
;

80 
	g´Ùeùed
:

82 
S‘UpTe¡Su™e
() {

83 
ASYLO_ASSERT_OK
(
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
()));

84 
ASYLO_ASSERT_OK_AND_ASSIGN
(
mªag”_
, 
EnşaveMªag”
::
In¡ªû
());

87 
S‘Up
(è
	gov”ride
 {

88 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’şave_¡dout_
, 
Pe
::
C»©ePe
());

94 
Stus
 
LßdEnşave
(
¡d
::
veùÜ
<¡d::
¡ršg
> 
¬gv
,

95 
¡d
::
veùÜ
<¡d::
·œ
<¡d::
¡ršg
, std::¡ršg>> 
’vp
) {

97 
¬gs_
 = 
¡d
::
move
(
¬gv
);

98 
	g’vœÚm’t_v¬ŸbËs_
 = 
¡d
::
move
(
’vp
);

102 
EnşaveCÚfig
 
	gcÚfig
;

103 
	gcÚfig
.
£t_¡dout_fd
(
’şave_¡dout_
.
wr™e_fd
());

104 
CommªdLšeArgs
 *
	g¬gs
 = 
cÚfig
.
MubËEx‹nsiÚ
(
commªd_lše_¬gs
);

105 cÚ¡ 
	g¡d
::
¡ršg
 &
¬gum’t
 : 
¬gs_
) {

106 
¬gs
->
add_¬gum’ts
(
¬gum’t
);

108 cÚ¡‡utØ&
	g·œ
 : 
’vœÚm’t_v¬ŸbËs_
) {

109 
EnvœÚm’tV¬ŸbË
 *
v¬ŸbË
 = 
cÚfig
.
add_’vœÚm’t_v¬ŸbËs
();

110 
	gv¬ŸbË
->
£t_Çme
(
·œ
.
fœ¡
);

111 
	gv¬ŸbË
->
£t_v®ue
(
·œ
.
£cÚd
);

115 
SgxEmbeddedLßd”
 
lßd”
(
FLAGS_’şave_£ùiÚ
, 
Œue
);

116 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
(
kEnşaveName
, 
lßd”
, 
cÚfig
);

118 ià(
	g¡©us
.
ok
()) {

119 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
(
kEnşaveName
);

122  
	g¡©us
;

127 
Stus
 
De¡royEnşave
() {

128  
	gmªag”_
->
De¡royEnşave
(
ş›Á_
, 
EnşaveFš®
());

131 
EnşaveMªag”
 *
	gmªag”_
;

133 
EnşaveCl›Á
 *
	gş›Á_
;

135 
Pe
 
	g’şave_¡dout_
;

137 
	g´iv©e
:

145 
CheckStdout
(cÚ¡ 
¡d
::
¡ršg
 &
ex³ùed_¡dout
,

146 cÚ¡ 
EnşaveOuut
 &
’şave_ouut
) {

148 
	g¡d
::
¡ršg
 
pe_ouut
;

149 
ASYLO_ASSERT_OK
(
’şave_¡dout_
.
Clo£Wr™eFd
());

150 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe_ouut
, 
R—dAÎ
(
’şave_¡dout_
.
»ad_fd
()));

153 
EXPECT_EQ
(
pe_ouut
, 
ex³ùed_¡dout
);

157 ià(!
	gex³ùed_¡dout
.
em±y
()) {

158 
ASSERT_TRUE
(
’şave_ouut
.
HasEx‹nsiÚ
(
maš_»tuº_v®ue
));

159 
EXPECT_EQ
(
’şave_ouut
.
G‘Ex‹nsiÚ
(
maš_»tuº_v®ue
), 
¬gs_
.
size
());

163 
	sEnvœÚm’tV¬ŸbËFÜm©‹r
 {

164 
İ”©Ü
()(
	g¡d
::
¡ršg
 *
out
,

165 
	g¡d
::
·œ
<
¡d
::
¡ršg
, std::¡ršg> 
v¬ŸbË
) {

166 
out
->
­³nd
(
ab¦
::
SŒC©
(
v¬ŸbË
.
fœ¡
, "=\"", v¬ŸbË.
£cÚd
, "\""));

170 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gs_
;

171 
	g¡d
::
veùÜ
<
¡d
::
·œ
<¡d::
¡ršg
, std::¡ršg>> 
’vœÚm’t_v¬ŸbËs_
;

174 
EnşaveMªag”
 *
	gAµliÿtiÚW¿µ”EnşaveTe¡
::
mªag”_
 = 
nuÎ±r
;

178 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoArgs
) {

179 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {}));

180 
ASYLO_EXPECT_OK
(
RunEnşave
());

181 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

186 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
OÃArg
) {

187 
ASYLO_ASSERT_OK
(
LßdEnşave
( {"foo"}, {}));

188 
ASYLO_EXPECT_OK
(
RunEnşave
());

189 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

194 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
MªyArgs
) {

195 
ASYLO_ASSERT_OK
(
LßdEnşave
(

199 
ASYLO_EXPECT_OK
(
RunEnşave
());

200 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

205 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoArgsAndEnvœÚm’tV¬ŸbËs
) {

206 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {{"FOO", "foooo"}}));

207 
ASYLO_EXPECT_OK
(
RunEnşave
());

208 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

213 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
MªyArgsAndEnvœÚm’tV¬ŸbËs
) {

214 
ASYLO_ASSERT_OK
(
LßdEnşave
(

218 
ASYLO_EXPECT_OK
(
RunEnşave
());

219 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

224 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoArgsEx‹nsiÚ
) {

225 
SgxEmbeddedLßd”
 
lßd”
(
FLAGS_’şave_£ùiÚ
, 
Œue
);

226 
EXPECT_THAT
(

227 
mªag”_
->
LßdEnşave
(
kEnşaveName
, 
lßd”
),

228 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

234 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoMuÉËRun
) {

235 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {}));

236 
ASYLO_EXPECT_OK
(
RunEnşave
());

237 
EXPECT_THAT
(
RunEnşave
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

239 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

245 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
NoMuÉËRunFromMuÉËTh»ads
) {

247 
cÚ¡ex´
 
	gkNumTe¡Th»ads
 = 25;

252 cÚ¡ 
Stus
 
dummy_¡©us
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
,

257 
	gM©ch”
<cÚ¡ 
	gStus
 &> 
	g®»ady_run_¡©us_m©ch”
 = 
StusIs
(

258 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Application has‡lready„un");

259 
	g¡d
::
veùÜ
<
M©ch”
<cÚ¡ 
Stus
 &>> 
ex³ùed_¡©u£s
(

260 
kNumTe¡Th»ads
 - 1, 
®»ady_run_¡©us_m©ch”
);

261 
	gex³ùed_¡©u£s
.
push_back
(
IsOk
());

263 
ASYLO_ASSERT_OK
(
LßdEnşave
( {}, {}));

267 
	g¡d
::
veùÜ
<
Stus
> 
run_¡©u£s
(
kNumTe¡Th»ads
, 
dummy_¡©us
);

269 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
run_th»ads
;

270 
	grun_th»ads
.
»£rve
(
kNumTe¡Th»ads
);

271 
	gi
 = 0; i < 
	gkNumTe¡Th»ads
; ++i) {

272 
	grun_th»ads
.
em¶aû_back
(

273 [
i
, &
run_¡©u£s
](
AµliÿtiÚW¿µ”EnşaveTe¡
 *
‹¡_fixtu»
) {

274 
Stus
 
¡©us
 = 
‹¡_fixtu»
->
RunEnşave
();

275 
run_¡©u£s
[
i
] = 
¡©us
;

277 
this
);

279 autØ&
	gth»ad
 : 
run_th»ads
) {

280 
th»ad
.
još
();

285 
EXPECT_THAT
(
run_¡©u£s
, 
UnÜd”edEËm’tsA»A¼ay
(
ex³ùed_¡©u£s
));

286 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

292 
TEST_F
(
AµliÿtiÚW¿µ”EnşaveTe¡
, 
Fš®izeLogsW¬nšgIfNoRun
) {

293 
cÚ¡ex´
 
	gkTe¡AµliÿtiÚName
[] = "Jean-Luc Picard";

295 
ASYLO_ASSERT_OK
(
LßdEnşave
Ğ{
kTe¡AµliÿtiÚName
}, {}));

296 
ASYLO_EXPECT_OK
(
De¡royEnşave
());

298 
ASYLO_ASSERT_OK
(
’şave_¡dout_
.
Clo£Wr™eFd
());

299 
EXPECT_THAT
(
R—dAÎ
(
’şave_¡dout_
.
»ad_fd
()),

300 
IsOkAndHŞds
(
HasSub¡r
(
ab¦
::
SŒC©
(

301 
kTe¡AµliÿtiÚName
,

	@bazel/application_wrapper/argv.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gArgv
::
Argv
(è{ 
In™ŸlizeArgvCSŒ
(); }

25 
	gArgv
::
Argv
(cÚ¡ Argv &
Ùh”
è: 
¬gv_
(Ùh”.¬gv_è{ 
In™ŸlizeArgvCSŒ
(); }

27 
	gArgv
 &Argv::
İ”©Ü
=(cÚ¡ 
Argv
 &
Ùh”
) {

28 
¬gv_
 = 
Ùh”
.argv_;

29 
In™ŸlizeArgvCSŒ
();

30  *
	gthis
;

33 
	gArgv
::
Wr™eArgvToR•—‹dSŒšgF›ld
(

34 
¬gc
, cÚ¡ *cÚ¡ *
¬gv
,

35 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
¡d
::
¡ršg
> *
f›ld
) {

36 
i
 = 0; 
	gi
 < 
	g¬gc
; ++i) {

37 *
	gf›ld
->
Add
(èğ
¬gv
[
i
];

41 
	gArgv
::
¬gc
(ècÚ¡ {  
¬gv_
.
size
(); }

43 **
	gArgv
::
¬gv
(è{  
¬gv_c_¡r_
.
d©a
(); }

45 
	gArgv
::
In™ŸlizeArgvCSŒ
() {

46 
¬gv_c_¡r_
.
ş—r
();

47 
	g¬gv_c_¡r_
.
»£rve
(
¬gv_
.
size
() + 1);

48 
	g¡d
::
¡ršg
 &
¬gum’t
 : 
¬gv_
) {

49 
¬gv_c_¡r_
.
push_back
(&
¬gum’t
[0]);

51 
	g¬gv_c_¡r_
.
push_back
(
nuÎ±r
);

	@bazel/application_wrapper/argv.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gArgv
::
Argv
(è{ 
In™ŸlizeArgvCSŒ
(); }

25 
	gArgv
::
Argv
(cÚ¡ Argv &
Ùh”
è: 
¬gv_
(Ùh”.¬gv_è{ 
In™ŸlizeArgvCSŒ
(); }

27 
	gArgv
 &Argv::
İ”©Ü
=(cÚ¡ 
Argv
 &
Ùh”
) {

28 
¬gv_
 = 
Ùh”
.argv_;

29 
In™ŸlizeArgvCSŒ
();

30  *
	gthis
;

33 
	gArgv
::
Wr™eArgvToR•—‹dSŒšgF›ld
(

34 
¬gc
, cÚ¡ *cÚ¡ *
¬gv
,

35 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
¡d
::
¡ršg
> *
f›ld
) {

36 
i
 = 0; 
	gi
 < 
	g¬gc
; ++i) {

37 *
	gf›ld
->
Add
(èğ
¬gv
[
i
];

41 
	gArgv
::
¬gc
(ècÚ¡ {  
¬gv_
.
size
(); }

43 **
	gArgv
::
¬gv
(è{  
¬gv_c_¡r_
.
d©a
(); }

45 
	gArgv
::
In™ŸlizeArgvCSŒ
() {

46 
¬gv_c_¡r_
.
ş—r
();

47 
	g¬gv_c_¡r_
.
»£rve
(
¬gv_
.
size
() + 1);

48 
	g¡d
::
¡ršg
 &
¬gum’t
 : 
¬gv_
) {

49 
¬gv_c_¡r_
.
push_back
(&
¬gum’t
[0]);

51 
	g¬gv_c_¡r_
.
push_back
(
nuÎ±r
);

	@bazel/application_wrapper/argv.h

19 #iâdeà
ASYLO_BAZEL_APPLICATION_WRAPPER_ARGV_H_


20 
	#ASYLO_BAZEL_APPLICATION_WRAPPER_ARGV_H_


	)

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<googË/´Ùobuf/»³©ed_f›ld.h
>

26 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

28 
Çme¥aû
 
	gasylo
 {

34 şas 
	cArgv
 {

35 
	gpublic
:

37 
Argv
();

41 
Argv
(cÚ¡ Argv &
Ùh”
);

42 
	gArgv
 &
	gİ”©Ü
=(cÚ¡ 
Argv
 &
Ùh”
);

44 
Argv
(Argv &&
Ùh”
) = ;

45 
	gArgv
 &
	gİ”©Ü
=(
Argv
 &&
Ùh”
) = ;

50 
	g‹m¶©e
 <
ty³Çme
 
	gSŒšgV›wI‹¿bËT
>

51 
ex¶ic™
 
Argv
(cÚ¡ 
SŒšgV›wI‹¿bËT
 &
¬gum’ts
) {

52 
	g¬gv_
.
»£rve
(
¬gum’ts
.
size
());

53 
	gab¦
::
¡ršg_v›w
 
¬gum’t
 : 
¬gum’ts
) {

54 
¬gv_
.
push_back
(
¡d
::
¡ršg
(
¬gum’t
));

56 
In™ŸlizeArgvCSŒ
();

60 
¬gc
() const;

67 **
¬gv
();

71 
Wr™eArgvToR•—‹dSŒšgF›ld
(

72 
¬gc
, cÚ¡ *cÚ¡ *
¬gv
,

73 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
¡d
::
¡ršg
> *
f›ld
);

75 
	g´iv©e
:

77 
In™ŸlizeArgvCSŒ
();

80 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gv_
;

84 
	g¡d
::
veùÜ
<*> 
¬gv_c_¡r_
;

	@bazel/application_wrapper/argv_test.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

21 
	~<¬¿y
>

22 
	~<¡ršg
>

24 
	~<googË/´Ùobuf/»³©ed_f›ld.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/ba£/maüos.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

32 
cÚ¡ex´
 
	gkTe¡Args
[][9] = {"the", "quick", "brown", "fox", "jumps",

38 
TEST
(
ArgvTe¡
, 
ArgcArgvToR•—‹dSŒšgF›ld
) {

39 
	g¡d
::
¬¿y
<cÚ¡ *, 
ABSL_ARRAYSIZE
(
kTe¡Args
)> 
	g‹¡_¬gv
;

40 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kTe¡Args
); ++i) {

41 
	g‹¡_¬gv
[
i
] = 
kTe¡Args
[i];

44 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
¡d
::
¡ršg
> 
»³©ed_¡ršg_f›ld
;

45 
	gArgv
::
Wr™eArgvToR•—‹dSŒšgF›ld
(
‹¡_¬gv
.
size
(),e¡_¬gv.
d©a
(),

46 &
»³©ed_¡ršg_f›ld
);

48 
ASSERT_EQ
(
»³©ed_¡ršg_f›ld
.
size
(), 
‹¡_¬gv
.size());

49 
	gi
 = 0; i < 
	g»³©ed_¡ršg_f›ld
.
size
(); ++i) {

50 
EXPECT_EQ
(
»³©ed_¡ršg_f›ld
[
i
], 
‹¡_¬gv
[i]);

56 
TEST
(
ArgvTe¡
, 
R•—‹dSŒšgF›ldToArgcArgv
) {

57 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
¡d
::
¡ršg
> 
»³©ed_¡ršg_f›ld
;

58 
	g»³©ed_¡ršg_f›ld
.
Re£rve
(
ABSL_ARRAYSIZE
(
kTe¡Args
));

59 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kTe¡Args
); ++i) {

60 *
	g»³©ed_¡ršg_f›ld
.
Add
(èğ
kTe¡Args
[
i
];

63 
Argv
 
¬gum’ts
(
»³©ed_¡ršg_f›ld
);

64 
	g¬gc
 = 
¬gum’ts
.
¬gc
();

65 **
	g¬gv
 = 
¬gum’ts
.
¬gv
();

67 
ASSERT_EQ
(
¬gc
, 
»³©ed_¡ršg_f›ld
.
size
());

68 
	gi
 = 0; i < 
	g¬gc
; ++i) {

69 
EXPECT_EQ
(
¬gv
[
i
], 
»³©ed_¡ršg_f›ld
[i]);

71 
EXPECT_EQ
(
¬gv
[
¬gc
], 
nuÎ±r
);

	@bazel/application_wrapper/argv_test.cc

19 
	~"asylo/baz–/­¶iÿtiÚ_w¿µ”/¬gv.h
"

21 
	~<¬¿y
>

22 
	~<¡ršg
>

24 
	~<googË/´Ùobuf/»³©ed_f›ld.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/ba£/maüos.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

32 
cÚ¡ex´
 
	gkTe¡Args
[][9] = {"the", "quick", "brown", "fox", "jumps",

38 
TEST
(
ArgvTe¡
, 
ArgcArgvToR•—‹dSŒšgF›ld
) {

39 
	g¡d
::
¬¿y
<cÚ¡ *, 
ABSL_ARRAYSIZE
(
kTe¡Args
)> 
	g‹¡_¬gv
;

40 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kTe¡Args
); ++i) {

41 
	g‹¡_¬gv
[
i
] = 
kTe¡Args
[i];

44 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
¡d
::
¡ršg
> 
»³©ed_¡ršg_f›ld
;

45 
	gArgv
::
Wr™eArgvToR•—‹dSŒšgF›ld
(
‹¡_¬gv
.
size
(),e¡_¬gv.
d©a
(),

46 &
»³©ed_¡ršg_f›ld
);

48 
ASSERT_EQ
(
»³©ed_¡ršg_f›ld
.
size
(), 
‹¡_¬gv
.size());

49 
	gi
 = 0; i < 
	g»³©ed_¡ršg_f›ld
.
size
(); ++i) {

50 
EXPECT_EQ
(
»³©ed_¡ršg_f›ld
[
i
], 
‹¡_¬gv
[i]);

56 
TEST
(
ArgvTe¡
, 
R•—‹dSŒšgF›ldToArgcArgv
) {

57 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
¡d
::
¡ršg
> 
»³©ed_¡ršg_f›ld
;

58 
	g»³©ed_¡ršg_f›ld
.
Re£rve
(
ABSL_ARRAYSIZE
(
kTe¡Args
));

59 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kTe¡Args
); ++i) {

60 *
	g»³©ed_¡ršg_f›ld
.
Add
(èğ
kTe¡Args
[
i
];

63 
Argv
 
¬gum’ts
(
»³©ed_¡ršg_f›ld
);

64 
	g¬gc
 = 
¬gum’ts
.
¬gc
();

65 **
	g¬gv
 = 
¬gum’ts
.
¬gv
();

67 
ASSERT_EQ
(
¬gc
, 
»³©ed_¡ršg_f›ld
.
size
());

68 
	gi
 = 0; i < 
	g¬gc
; ++i) {

69 
EXPECT_EQ
(
¬gv
[
i
], 
»³©ed_¡ršg_f›ld
[i]);

71 
EXPECT_EQ
(
¬gv
[
¬gc
], 
nuÎ±r
);

	@bazel/application_wrapper/default_config.cc

19 
	~"asylo/’şave.pb.h
"

22 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

23  
asylo
::
	`EnşaveCÚfig
();

24 
	}
}

	@bazel/application_wrapper/default_config.cc

19 
	~"asylo/’şave.pb.h
"

22 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

23  
asylo
::
	`EnşaveCÚfig
();

24 
	}
}

	@bazel/application_wrapper/test_application.cc

19 #iâdeà
_GNU_SOURCE


20 
	#_GNU_SOURCE


	)

23 
	~<uni¡d.h
>

25 
	~<û¼no
>

26 
	~<c¡dio
>

27 
	~<c¡ršg
>

28 
	~<¡ršg
>

30 
	~"asylo/ut/loggšg.h
"

38 
	$maš
(
¬gc
, *
¬gv
[]) {

39 
i
 = 0; i < 
¬gc
; ++i) {

40 
	`´štf
("%s\n", 
¬gv
[
i
]);

43 #ifdeà
__ASYLO__


44 **
v¬ŸbË
 = 
’vœÚ
; *v¬ŸbË !ğ
nuÎ±r
; ++variable) {

45 cÚ¡ *
equ®s_sign
 = 
	`CHECK_NOTNULL
(
	`¡rchr
(*
v¬ŸbË
, '='));

46 cÚ¡ *
Çme_¡¬t
 = *
v¬ŸbË
;

47 
Çme_Ëngth
 = 
equ®s_sign
 - *
v¬ŸbË
;

48 cÚ¡ *
v®ue_¡¬t
 = 
equ®s_sign
 + 1;

49 
¡d
::
¡ršg
 
	`Çme
(
Çme_¡¬t
, 
Çme_Ëngth
);

50 
	`´štf
("%s=\"%s\"\n", 
Çme
.
	`c_¡r
(), 
v®ue_¡¬t
);

54 
	`CHECK_EQ
(
	`fæush
(
¡dout
), 0è<< 
	`¡»¼Ü
(
”ºo
);

56  
¬gc
;

57 
	}
}

	@bazel/application_wrapper/test_application.cc

19 #iâdeà
_GNU_SOURCE


20 
	#_GNU_SOURCE


	)

23 
	~<uni¡d.h
>

25 
	~<û¼no
>

26 
	~<c¡dio
>

27 
	~<c¡ršg
>

28 
	~<¡ršg
>

30 
	~"asylo/ut/loggšg.h
"

38 
	$maš
(
¬gc
, *
¬gv
[]) {

39 
i
 = 0; i < 
¬gc
; ++i) {

40 
	`´štf
("%s\n", 
¬gv
[
i
]);

43 #ifdeà
__ASYLO__


44 **
v¬ŸbË
 = 
’vœÚ
; *v¬ŸbË !ğ
nuÎ±r
; ++variable) {

45 cÚ¡ *
equ®s_sign
 = 
	`CHECK_NOTNULL
(
	`¡rchr
(*
v¬ŸbË
, '='));

46 cÚ¡ *
Çme_¡¬t
 = *
v¬ŸbË
;

47 
Çme_Ëngth
 = 
equ®s_sign
 - *
v¬ŸbË
;

48 cÚ¡ *
v®ue_¡¬t
 = 
equ®s_sign
 + 1;

49 
¡d
::
¡ršg
 
	`Çme
(
Çme_¡¬t
, 
Çme_Ëngth
);

50 
	`´štf
("%s=\"%s\"\n", 
Çme
.
	`c_¡r
(), 
v®ue_¡¬t
);

54 
	`CHECK_EQ
(
	`fæush
(
¡dout
), 0è<< 
	`¡»¼Ü
(
”ºo
);

56  
¬gc
;

57 
	}
}

	@bazel/application_wrapper/test_config.cc

19 
	~"asylo/’şave.pb.h
"

22 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

23 
asylo
::
EnşaveCÚfig
 
cÚfig
;

24 
asylo
::
EnvœÚm’tV¬ŸbË
 *
foo
 = 
cÚfig
.
	`add_’vœÚm’t_v¬ŸbËs
();

25 
foo
->
	`£t_Çme
("FOO");

26 
foo
->
	`£t_v®ue
("foooo");

27  
cÚfig
;

28 
	}
}

	@bazel/application_wrapper/test_config.cc

19 
	~"asylo/’şave.pb.h
"

22 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

23 
asylo
::
EnşaveCÚfig
 
cÚfig
;

24 
asylo
::
EnvœÚm’tV¬ŸbË
 *
foo
 = 
cÚfig
.
	`add_’vœÚm’t_v¬ŸbËs
();

25 
foo
->
	`£t_Çme
("FOO");

26 
foo
->
	`£t_v®ue
("foooo");

27  
cÚfig
;

28 
	}
}

	@bazel/gtest_test.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~<gmock/gmock.h
>

22 
	gÇme¥aû
 {

24 
	gusšg
 ::
‹¡šg
::
Eq
;

27 
TEST
(
G‹¡Te¡
, 
Smoke
è{ 
EXPECT_THAT
(1, 
Eq
(1)); }

	@bazel/gtest_test.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~<gmock/gmock.h
>

22 
	gÇme¥aû
 {

24 
	gusšg
 ::
‹¡šg
::
Eq
;

27 
TEST
(
G‹¡Te¡
, 
Smoke
è{ 
EXPECT_THAT
(1, 
Eq
(1)); }

	@bazel/test_shim_enclave.cc

19 
	~<¡ršg
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/baz–/‹¡_shim_’şave.pb.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
	~"asylo/‹¡/ut/‹¡_æags.h
"

27 
Çme¥aû
 
	gasylo
 {

30 şas 
	cTe¡ShimEnşave
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Te¡ShimEnşave
() = ;

34 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
	gov”ride
 {

36 
Te¡ShimEnşaveCÚfig
 
	gshim_cÚfig
 =

37 
cÚfig
.
G‘Ex‹nsiÚ
(
‹¡_shim_’şave_cÚfig
);

39 ià(
	gshim_cÚfig
.
has_ouut_fe
()) {

40 ::
‹¡šg
::
GTEST_FLAG
(
ouut
èğ
shim_cÚfig
.
ouut_fe
().
c_¡r
();

43 ià(
	gshim_cÚfig
.
has_‹¡_tmpdœ
()) {

44 
	gFLAGS_‹¡_tmpdœ
 = 
shim_cÚfig
.
‹¡_tmpdœ
();

47 ià(
	gshim_cÚfig
.
has_‹¡_š_š™Ÿlize
() &&

48 
	gshim_cÚfig
.
‹¡_š_š™Ÿlize
()) {

49 
	g‹¡_š_š™Ÿlize_
 = 
Œue
;

50 
EnşaveRunAÎTe¡s
();

52 
	g‹¡_š_š™Ÿlize_
 = 
çl£
;

55  
	gStus
::
OkStus
();

58 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

59 ià(!
	g‹¡_š_š™Ÿlize_
) {

60 
EnşaveRunAÎTe¡s
();

62  
	gStus
::
OkStus
();

65 
	g´iv©e
:

66 
EnşaveRunAÎTe¡s
() {

67 
¬gc
 = 1;

68 
	g¬gv0
[] = "placeholder";

69 *
	g¬gv
[] = {
¬gv0
, 
nuÎ±r
};

70 ::
‹¡šg
::
In™GoogËTe¡
(&
¬gc
, 
¬gv
);

71 
CHECK_EQ
(
RUN_ALL_TESTS
(), 0);

74 
boŞ
 
	g‹¡_š_š™Ÿlize_
;

77 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Te¡ShimEnşave
; 
	}
}

	@bazel/test_shim_enclave.cc

19 
	~<¡ršg
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/baz–/‹¡_shim_’şave.pb.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
	~"asylo/‹¡/ut/‹¡_æags.h
"

27 
Çme¥aû
 
	gasylo
 {

30 şas 
	cTe¡ShimEnşave
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Te¡ShimEnşave
() = ;

34 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
	gov”ride
 {

36 
Te¡ShimEnşaveCÚfig
 
	gshim_cÚfig
 =

37 
cÚfig
.
G‘Ex‹nsiÚ
(
‹¡_shim_’şave_cÚfig
);

39 ià(
	gshim_cÚfig
.
has_ouut_fe
()) {

40 ::
‹¡šg
::
GTEST_FLAG
(
ouut
èğ
shim_cÚfig
.
ouut_fe
().
c_¡r
();

43 ià(
	gshim_cÚfig
.
has_‹¡_tmpdœ
()) {

44 
	gFLAGS_‹¡_tmpdœ
 = 
shim_cÚfig
.
‹¡_tmpdœ
();

47 ià(
	gshim_cÚfig
.
has_‹¡_š_š™Ÿlize
() &&

48 
	gshim_cÚfig
.
‹¡_š_š™Ÿlize
()) {

49 
	g‹¡_š_š™Ÿlize_
 = 
Œue
;

50 
EnşaveRunAÎTe¡s
();

52 
	g‹¡_š_š™Ÿlize_
 = 
çl£
;

55  
	gStus
::
OkStus
();

58 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

59 ià(!
	g‹¡_š_š™Ÿlize_
) {

60 
EnşaveRunAÎTe¡s
();

62  
	gStus
::
OkStus
();

65 
	g´iv©e
:

66 
EnşaveRunAÎTe¡s
() {

67 
¬gc
 = 1;

68 
	g¬gv0
[] = "placeholder";

69 *
	g¬gv
[] = {
¬gv0
, 
nuÎ±r
};

70 ::
‹¡šg
::
In™GoogËTe¡
(&
¬gc
, 
¬gv
);

71 
CHECK_EQ
(
RUN_ALL_TESTS
(), 0);

74 
boŞ
 
	g‹¡_š_š™Ÿlize_
;

77 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Te¡ShimEnşave
; 
	}
}

	@bazel/test_shim_loader.cc

19 
	~<c¡dlib
>

21 
	~"asylo/baz–/‹¡_shim_’şave.pb.h
"

22 
	~"asylo/ş›Á.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/‹¡/ut/‹¡_æags.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

28 
DEFINE_boŞ
(
‹¡_š_š™Ÿlize
, 
çl£
,

30 
DEFINE_št32
(
v
, 0, "Logging verbosity†evel");

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkEnşaveName
[] = "/test_shim_enclave";

38 
	$maš
(
¬gc
, *
¬gv
[]) {

39 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

42 
asylo
::
EnşaveCÚfig
 
cÚfig
;

43 
cÚfig
.
	`mubË_loggšg_cÚfig
()->
	`£t_vlog_Ëv–
(
FLAGS_v
);

44 *
ouut_fe
 = 
¡d
::
	`g‘’v
("GTEST_OUTPUT");

45 ià(
ouut_fe
 !ğ
nuÎ±r
 && output_file[0] != '\0') {

46 
asylo
::
Te¡ShimEnşaveCÚfig
 *
shim_cÚfig
 =

47 
cÚfig
.
	`MubËEx‹nsiÚ
(
asylo
::
‹¡_shim_’şave_cÚfig
);

48 
shim_cÚfig
->
	`£t_ouut_fe
(
ouut_fe
);

52 ià(!
FLAGS_‹¡_tmpdœ
.
	`em±y
()) {

53 
asylo
::
Te¡ShimEnşaveCÚfig
 *
shim_cÚfig
 =

54 
cÚfig
.
	`MubËEx‹nsiÚ
(
asylo
::
‹¡_shim_’şave_cÚfig
);

55 
shim_cÚfig
->
	`£t_‹¡_tmpdœ
(
FLAGS_‹¡_tmpdœ
);

59 
asylo
::
Te¡ShimEnşaveCÚfig
 *
shim_cÚfig
 =

60 
cÚfig
.
	`MubËEx‹nsiÚ
(
asylo
::
‹¡_shim_’şave_cÚfig
);

61 
shim_cÚfig
->
	`£t_‹¡_š_š™Ÿlize
(
FLAGS_‹¡_š_š™Ÿlize
);

64 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

65 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

66 ià(!
mªag”_»suÉ
.
	`ok
()) {

67 
	`LOG
(
QFATAL
è<< "In¡ªû„‘uºed stus: " << 
mªag”_»suÉ
.
	`¡©us
();

69 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

70 
asylo
::
SgxLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

71 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
(
kEnşaveName
, 
lßd”
, 
cÚfig
);

72 ià(!
¡©us
.
	`ok
()) {

73 
	`LOG
(
QFATAL
è<< "LßdEnşav»tuºed stus: " << 
¡©us
;

77 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
(
kEnşaveName
);

78 
asylo
::
EnşaveIÅut
 
šput
;

79 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, 
nuÎ±r
);

80 ià(!
¡©us
.
	`ok
()) {

81 
	`LOG
(
QFATAL
è<< "EÁ”AndRuÀ»tuºed stus: " << 
¡©us
;

85 
asylo
::
EnşaveFš®
 
fš®_šput
;

86 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
fš®_šput
);

87 ià(!
¡©us
.
	`ok
()) {

88 
	`LOG
(
QFATAL
è<< "De¡royEnşav»tuºed stus: " << 
¡©us
;

92 
	}
}

	@bazel/test_shim_loader.cc

19 
	~<c¡dlib
>

21 
	~"asylo/baz–/‹¡_shim_’şave.pb.h
"

22 
	~"asylo/ş›Á.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/‹¡/ut/‹¡_æags.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

28 
DEFINE_boŞ
(
‹¡_š_š™Ÿlize
, 
çl£
,

30 
DEFINE_št32
(
v
, 0, "Logging verbosity†evel");

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkEnşaveName
[] = "/test_shim_enclave";

38 
	$maš
(
¬gc
, *
¬gv
[]) {

39 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

42 
asylo
::
EnşaveCÚfig
 
cÚfig
;

43 
cÚfig
.
	`mubË_loggšg_cÚfig
()->
	`£t_vlog_Ëv–
(
FLAGS_v
);

44 *
ouut_fe
 = 
¡d
::
	`g‘’v
("GTEST_OUTPUT");

45 ià(
ouut_fe
 !ğ
nuÎ±r
 && output_file[0] != '\0') {

46 
asylo
::
Te¡ShimEnşaveCÚfig
 *
shim_cÚfig
 =

47 
cÚfig
.
	`MubËEx‹nsiÚ
(
asylo
::
‹¡_shim_’şave_cÚfig
);

48 
shim_cÚfig
->
	`£t_ouut_fe
(
ouut_fe
);

52 ià(!
FLAGS_‹¡_tmpdœ
.
	`em±y
()) {

53 
asylo
::
Te¡ShimEnşaveCÚfig
 *
shim_cÚfig
 =

54 
cÚfig
.
	`MubËEx‹nsiÚ
(
asylo
::
‹¡_shim_’şave_cÚfig
);

55 
shim_cÚfig
->
	`£t_‹¡_tmpdœ
(
FLAGS_‹¡_tmpdœ
);

59 
asylo
::
Te¡ShimEnşaveCÚfig
 *
shim_cÚfig
 =

60 
cÚfig
.
	`MubËEx‹nsiÚ
(
asylo
::
‹¡_shim_’şave_cÚfig
);

61 
shim_cÚfig
->
	`£t_‹¡_š_š™Ÿlize
(
FLAGS_‹¡_š_š™Ÿlize
);

64 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

65 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

66 ià(!
mªag”_»suÉ
.
	`ok
()) {

67 
	`LOG
(
QFATAL
è<< "In¡ªû„‘uºed stus: " << 
mªag”_»suÉ
.
	`¡©us
();

69 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

70 
asylo
::
SgxLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

71 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
(
kEnşaveName
, 
lßd”
, 
cÚfig
);

72 ià(!
¡©us
.
	`ok
()) {

73 
	`LOG
(
QFATAL
è<< "LßdEnşav»tuºed stus: " << 
¡©us
;

77 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
(
kEnşaveName
);

78 
asylo
::
EnşaveIÅut
 
šput
;

79 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, 
nuÎ±r
);

80 ià(!
¡©us
.
	`ok
()) {

81 
	`LOG
(
QFATAL
è<< "EÁ”AndRuÀ»tuºed stus: " << 
¡©us
;

85 
asylo
::
EnşaveFš®
 
fš®_šput
;

86 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
fš®_šput
);

87 ià(!
¡©us
.
	`ok
()) {

88 
	`LOG
(
QFATAL
è<< "De¡royEnşav»tuºed stus: " << 
¡©us
;

92 
	}
}

	@client.h

19 #iâdeà
ASYLO_CLIENT_H_


20 
	#ASYLO_CLIENT_H_


	)

22 
	~"asylo/¶©fÜm/cÜe/’şave_ş›Á.h
"

23 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/sgx_ş›Á.h
"

	@crypto/aead_cryptor.cc

18 
	~"asylo/üy±o/«ad_üy±Ü.h
"

20 
	~<c¡ddef
>

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/üy±o/¿ndom_nÚû_g’”©Ü.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gex³rim’l
 {

29 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
ušt64_t
 
	gkAesGcmMaxS—ËdMes§ges
 = 
UINT64_C
(1) << 27;

36 
cÚ¡ex´
 
size_t
 
	gkAesGcmMaxMes§geSize
 = 
¡©ic_ÿ¡
<size_t>(1) << 25;

38 
cÚ¡ex´
 
ušt64_t
 
	gkAesGcmSivMaxS—ËdMes§ges
 = 
UINT64_C
(1) << 48;

39 
cÚ¡ex´
 
size_t
 
	gkAesGcmSivMaxMes§geSize
 = 
¡©ic_ÿ¡
<size_t>(1) << 25;

43 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dCry±Ü
>> A—dCry±Ü::
C»©eAesGcmCry±Ü
(

44 
By‹CÚš”V›w
 
key
) {

45 
¡d
::
unique_±r
<
A—dKey
> 
«ad_key
;

46 
ASYLO_ASSIGN_OR_RETURN
(
«ad_key
, 
A—dKey
::
C»©eAesGcmKey
(
key
));

47  
	gab¦
::
W¿pUnique
<
A—dCry±Ü
>(
Ãw
 AeadCryptor(

48 
¡d
::
move
(
«ad_key
), 
kAesGcmMaxMes§geSize
, 
kAesGcmMaxS—ËdMes§ges
,

49 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
()));

52 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dCry±Ü
>> A—dCry±Ü::
C»©eAesGcmSivCry±Ü
(

53 
By‹CÚš”V›w
 
key
) {

54 
¡d
::
unique_±r
<
A—dKey
> 
«ad_key
;

55 
ASYLO_ASSIGN_OR_RETURN
(
«ad_key
, 
A—dKey
::
C»©eAesGcmSivKey
(
key
));

56  
	gab¦
::
W¿pUnique
<
A—dCry±Ü
>(

57 
Ãw
 
A—dCry±Ü
(
¡d
::
move
(
«ad_key
), 
kAesGcmSivMaxMes§geSize
,

58 
kAesGcmSivMaxS—ËdMes§ges
,

59 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
()));

62 
	gStusOr
<
	gsize_t
> 
	gA—dCry±Ü
::
MaxMes§geSize
(
A—dScheme
 
scheme
) {

63 
scheme
) {

64 
AES128_GCM
:

65 
AES256_GCM
:

66  
kAesGcmMaxMes§geSize
;

67 
	gAES128_GCM_SIV
:

68 
AES256_GCM_SIV
:

69  
kAesGcmSivMaxMes§geSize
;

71  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
,

76 
	gStusOr
<
	gušt64_t
> 
	gA—dCry±Ü
::
MaxS—ËdMes§ges
(
A—dScheme
 
scheme
) {

77 
scheme
) {

78 
AES128_GCM
:

79 
AES256_GCM
:

80  
kAesGcmMaxS—ËdMes§ges
;

81 
	gAES128_GCM_SIV
:

82 
AES256_GCM_SIV
:

83  
kAesGcmSivMaxS—ËdMes§ges
;

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
,

90 
size_t
 
	gA—dCry±Ü
::
MaxMes§geSize
(ècÚ¡ {  
max_mes§ge_size_
; }

92 
ušt64_t
 
	gA—dCry±Ü
::
MaxS—ËdMes§ges
(ècÚ¡ {  
max_£®ed_mes§ges_
; }

94 
size_t
 
	gA—dCry±Ü
::
MaxS—lOv”h—d
(ècÚ¡ {  
key_
->MaxSealOverhead(); }

96 
size_t
 
	gA—dCry±Ü
::
NÚûSize
(ècÚ¡ {  
nÚû_g’”©Ü_
->NonceSize(); }

98 
Stus
 
	gA—dCry±Ü
::
S—l
(
By‹CÚš”V›w
 
¶aš‹xt
,

99 
By‹CÚš”V›w
 
assocŸ‹d_d©a
,

100 
ab¦
::
S·n
<
ušt8_t
> 
nÚû
,

101 
ab¦
::
S·n
<
ušt8_t
> 
ch”‹xt
,

102 
size_t
 *
ch”‹xt_size
) {

103 ià(
	g¶aš‹xt
.
size
(è> 
	gmax_mes§ge_size_
) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
ab¦
::
SŒC©
("PÏš‹xˆsiz", 
¶aš‹xt
.
size
(),

107 
max_mes§ge_size_
, " bytes)"));

109 ià(
	gnumb”_of_£®ed_mes§ges_
 >ğ
max_£®ed_mes§ges_
) {

110  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

111 
ab¦
::
SŒC©
("Reached maximum‚umber of sealed messages (",

112 
max_£®ed_mes§ges_
, ")"));

114 
	gnÚû_g’”©Ü_
->
NextNÚû
(
nÚû
);

115 
ASYLO_RETURN_IF_ERROR
(
key_
->
S—l
(
¶aš‹xt
, 
assocŸ‹d_d©a
, 
nÚû
,

116 
ch”‹xt
, 
ch”‹xt_size
));

117 
	gnumb”_of_£®ed_mes§ges_
++;

118  
	gStus
::
OkStus
();

121 
Stus
 
	gA—dCry±Ü
::
O³n
(
By‹CÚš”V›w
 
ch”‹xt
,

122 
By‹CÚš”V›w
 
assocŸ‹d_d©a
,

123 
By‹CÚš”V›w
 
nÚû
, 
ab¦
::
S·n
<
ušt8_t
> 
¶aš‹xt
,

124 
size_t
 *
¶aš‹xt_size
) {

125  
	gkey_
->
O³n
(
ch”‹xt
, 
assocŸ‹d_d©a
, 
nÚû
, 
¶aš‹xt
,

126 
¶aš‹xt_size
);

129 
	gA—dCry±Ü
::
A—dCry±Ü
(

130 
¡d
::
unique_±r
<
A—dKey
> 
key
, 
size_t
 
max_mes§ge_size
,

131 
ušt64_t
 
max_£®ed_mes§ges
,

132 
¡d
::
unique_±r
<
NÚûG’”©ÜIÁ”çû
> 
nÚû_g’”©Ü
)

133 : 
key_
(
¡d
::
move
(
key
)),

134 
max_mes§ge_size_
(
max_mes§ge_size
),

135 
max_£®ed_mes§ges_
(
max_£®ed_mes§ges
),

136 
nÚû_g’”©Ü_
(
¡d
::
move
(
nÚû_g’”©Ü
)),

137 
numb”_of_£®ed_mes§ges_
(0) {}

	@crypto/aead_cryptor.cc

18 
	~"asylo/üy±o/«ad_üy±Ü.h
"

20 
	~<c¡ddef
>

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/üy±o/¿ndom_nÚû_g’”©Ü.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gex³rim’l
 {

29 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
ušt64_t
 
	gkAesGcmMaxS—ËdMes§ges
 = 
UINT64_C
(1) << 27;

36 
cÚ¡ex´
 
size_t
 
	gkAesGcmMaxMes§geSize
 = 
¡©ic_ÿ¡
<size_t>(1) << 25;

38 
cÚ¡ex´
 
ušt64_t
 
	gkAesGcmSivMaxS—ËdMes§ges
 = 
UINT64_C
(1) << 48;

39 
cÚ¡ex´
 
size_t
 
	gkAesGcmSivMaxMes§geSize
 = 
¡©ic_ÿ¡
<size_t>(1) << 25;

43 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dCry±Ü
>> A—dCry±Ü::
C»©eAesGcmCry±Ü
(

44 
By‹CÚš”V›w
 
key
) {

45 
¡d
::
unique_±r
<
A—dKey
> 
«ad_key
;

46 
ASYLO_ASSIGN_OR_RETURN
(
«ad_key
, 
A—dKey
::
C»©eAesGcmKey
(
key
));

47  
	gab¦
::
W¿pUnique
<
A—dCry±Ü
>(
Ãw
 AeadCryptor(

48 
¡d
::
move
(
«ad_key
), 
kAesGcmMaxMes§geSize
, 
kAesGcmMaxS—ËdMes§ges
,

49 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
()));

52 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dCry±Ü
>> A—dCry±Ü::
C»©eAesGcmSivCry±Ü
(

53 
By‹CÚš”V›w
 
key
) {

54 
¡d
::
unique_±r
<
A—dKey
> 
«ad_key
;

55 
ASYLO_ASSIGN_OR_RETURN
(
«ad_key
, 
A—dKey
::
C»©eAesGcmSivKey
(
key
));

56  
	gab¦
::
W¿pUnique
<
A—dCry±Ü
>(

57 
Ãw
 
A—dCry±Ü
(
¡d
::
move
(
«ad_key
), 
kAesGcmSivMaxMes§geSize
,

58 
kAesGcmSivMaxS—ËdMes§ges
,

59 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
()));

62 
	gStusOr
<
	gsize_t
> 
	gA—dCry±Ü
::
MaxMes§geSize
(
A—dScheme
 
scheme
) {

63 
scheme
) {

64 
AES128_GCM
:

65 
AES256_GCM
:

66  
kAesGcmMaxMes§geSize
;

67 
	gAES128_GCM_SIV
:

68 
AES256_GCM_SIV
:

69  
kAesGcmSivMaxMes§geSize
;

71  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
,

76 
	gStusOr
<
	gušt64_t
> 
	gA—dCry±Ü
::
MaxS—ËdMes§ges
(
A—dScheme
 
scheme
) {

77 
scheme
) {

78 
AES128_GCM
:

79 
AES256_GCM
:

80  
kAesGcmMaxS—ËdMes§ges
;

81 
	gAES128_GCM_SIV
:

82 
AES256_GCM_SIV
:

83  
kAesGcmSivMaxS—ËdMes§ges
;

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
,

90 
size_t
 
	gA—dCry±Ü
::
MaxMes§geSize
(ècÚ¡ {  
max_mes§ge_size_
; }

92 
ušt64_t
 
	gA—dCry±Ü
::
MaxS—ËdMes§ges
(ècÚ¡ {  
max_£®ed_mes§ges_
; }

94 
size_t
 
	gA—dCry±Ü
::
MaxS—lOv”h—d
(ècÚ¡ {  
key_
->MaxSealOverhead(); }

96 
size_t
 
	gA—dCry±Ü
::
NÚûSize
(ècÚ¡ {  
nÚû_g’”©Ü_
->NonceSize(); }

98 
Stus
 
	gA—dCry±Ü
::
S—l
(
By‹CÚš”V›w
 
¶aš‹xt
,

99 
By‹CÚš”V›w
 
assocŸ‹d_d©a
,

100 
ab¦
::
S·n
<
ušt8_t
> 
nÚû
,

101 
ab¦
::
S·n
<
ušt8_t
> 
ch”‹xt
,

102 
size_t
 *
ch”‹xt_size
) {

103 ià(
	g¶aš‹xt
.
size
(è> 
	gmax_mes§ge_size_
) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
ab¦
::
SŒC©
("PÏš‹xˆsiz", 
¶aš‹xt
.
size
(),

107 
max_mes§ge_size_
, " bytes)"));

109 ià(
	gnumb”_of_£®ed_mes§ges_
 >ğ
max_£®ed_mes§ges_
) {

110  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

111 
ab¦
::
SŒC©
("Reached maximum‚umber of sealed messages (",

112 
max_£®ed_mes§ges_
, ")"));

114 
	gnÚû_g’”©Ü_
->
NextNÚû
(
nÚû
);

115 
ASYLO_RETURN_IF_ERROR
(
key_
->
S—l
(
¶aš‹xt
, 
assocŸ‹d_d©a
, 
nÚû
,

116 
ch”‹xt
, 
ch”‹xt_size
));

117 
	gnumb”_of_£®ed_mes§ges_
++;

118  
	gStus
::
OkStus
();

121 
Stus
 
	gA—dCry±Ü
::
O³n
(
By‹CÚš”V›w
 
ch”‹xt
,

122 
By‹CÚš”V›w
 
assocŸ‹d_d©a
,

123 
By‹CÚš”V›w
 
nÚû
, 
ab¦
::
S·n
<
ušt8_t
> 
¶aš‹xt
,

124 
size_t
 *
¶aš‹xt_size
) {

125  
	gkey_
->
O³n
(
ch”‹xt
, 
assocŸ‹d_d©a
, 
nÚû
, 
¶aš‹xt
,

126 
¶aš‹xt_size
);

129 
	gA—dCry±Ü
::
A—dCry±Ü
(

130 
¡d
::
unique_±r
<
A—dKey
> 
key
, 
size_t
 
max_mes§ge_size
,

131 
ušt64_t
 
max_£®ed_mes§ges
,

132 
¡d
::
unique_±r
<
NÚûG’”©ÜIÁ”çû
> 
nÚû_g’”©Ü
)

133 : 
key_
(
¡d
::
move
(
key
)),

134 
max_mes§ge_size_
(
max_mes§ge_size
),

135 
max_£®ed_mes§ges_
(
max_£®ed_mes§ges
),

136 
nÚû_g’”©Ü_
(
¡d
::
move
(
nÚû_g’”©Ü
)),

137 
numb”_of_£®ed_mes§ges_
(0) {}

	@crypto/aead_cryptor.h

19 #iâdeà
ASYLO_CRYPTO_AEAD_CRYPTOR_H_


20 
	#ASYLO_CRYPTO_AEAD_CRYPTOR_H_


	)

22 
	~<c¡dšt
>

23 
	~<memÜy
>

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/üy±o/«ad_key.h
"

27 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

28 
	~"asylo/üy±o/nÚû_g’”©Ü_š‹rçû.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	gex³rim’l
 {

40 şas 
	cA—dCry±Ü
 {

41 
	gpublic
:

48 
StusOr
<
¡d
::
unique_±r
<
A—dCry±Ü
>> 
C»©eAesGcmCry±Ü
(

49 
By‹CÚš”V›w
 
key
);

57 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dCry±Ü
>> 
C»©eAesGcmSivCry±Ü
(

58 
By‹CÚš”V›w
 
key
);

66 
	gStusOr
<
	gsize_t
> 
MaxMes§geSize
(
A—dScheme
 
scheme
);

74 
	gStusOr
<
	gušt64_t
> 
MaxS—ËdMes§ges
(
A—dScheme
 
scheme
);

79 
size_t
 
MaxMes§geSize
() const;

85 
ušt64_t
 
MaxS—ËdMes§ges
() const;

90 
size_t
 
MaxS—lOv”h—d
() const;

95 
size_t
 
NÚûSize
() const;

113 
Stus
 
S—l
(
By‹CÚš”V›w
 
¶aš‹xt
, By‹CÚš”V›w 
assocŸ‹d_d©a
,

114 
ab¦
::
S·n
<
ušt8_t
> 
nÚû
,‡b¦::S·n<ušt8_t> 
ch”‹xt
,

115 
size_t
 *
ch”‹xt_size
);

131 
Stus
 
O³n
(
By‹CÚš”V›w
 
ch”‹xt
, By‹CÚš”V›w 
assocŸ‹d_d©a
,

132 
By‹CÚš”V›w
 
nÚû
, 
ab¦
::
S·n
<
ušt8_t
> 
¶aš‹xt
,

133 
size_t
 *
¶aš‹xt_size
);

135 
	g´iv©e
:

136 
A—dCry±Ü
(
¡d
::
unique_±r
<
A—dKey
> 
key
, 
size_t
 
max_mes§ge_size
,

137 
ušt64_t
 
max_£®ed_mes§ges
,

138 
¡d
::
unique_±r
<
NÚûG’”©ÜIÁ”çû
> 
nÚû_g’”©Ü
);

141 cÚ¡ 
	g¡d
::
unique_±r
<
A—dKey
> 
key_
;

144 cÚ¡ 
size_t
 
	gmax_mes§ge_size_
;

147 cÚ¡ 
ušt64_t
 
	gmax_£®ed_mes§ges_
;

150 cÚ¡ 
	g¡d
::
unique_±r
<
NÚûG’”©ÜIÁ”çû
> 
nÚû_g’”©Ü_
;

153 
size_t
 
	gnumb”_of_£®ed_mes§ges_
;

	@crypto/aead_cryptor_test.cc

18 
	~"asylo/üy±o/«ad_üy±Ü.h
"

20 
	~<veùÜ
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/ty³s/¥ª.h
"

24 
	~"asylo/üy±o/«ad_‹¡_veùÜ.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/ş—nsšg_ty³s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gex³rim’l
 {

30 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex256
[] = "00000000000000000000000000000000";

35 
cÚ¡ex´
 
	gkAesGcmKeyHex256
[] =

38 
cÚ¡ex´
 
	gkAesGcmNÚûHex256
[] = "000000000000000000000000";

39 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex256
[] = "cea7403d4d606b6e074ec5d3baf39d18";

40 
cÚ¡ex´
 
	gkAesGcmTagHex256
[] = "d0d1c8a799996bf0265b98b5d48ab919";

44 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex128
[] =

49 
cÚ¡ex´
 
	gkAesGcmKeyHex128
[] = "feffe9928665731c6d6a8f9467308308";

50 
cÚ¡ex´
 
	gkAesGcmAadHex128
[] = "feedfacedeadbeeffeedfacedeadbeefabaddad2";

51 
cÚ¡ex´
 
	gkAesGcmNÚûHex128
[] = "cafebabefacedbaddecaf888";

52 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex128
[] =

57 
cÚ¡ex´
 
	gkAesGcmTagHex128
[] = "5bc94fbc3221a5db94fae95ae7121a47";

61 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex128
[] =

64 cÚ¡ 
	gkAesGcmSivKeyHex128
[] = "01000000000000000000000000000000";

65 cÚ¡ 
	gkAesGcmSivNÚûHex128
[] = "030000000000000000000000";

66 cÚ¡ 
	gkAesGcmSivCh”‹xtHex128
[] =

69 cÚ¡ 
	gkAesGcmSivTagHex128
[] = "1a8e45dcd4578c667cd86847bf6155ff";

72 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex256
[] = "02000000000000000000000000000000";

73 cÚ¡ 
	gkAesGcmSivKeyHex256
[] =

76 cÚ¡ 
	gkAesGcmSivAadHex256
[] = "01";

77 cÚ¡ 
	gkAesGcmSivNÚûHex256
[] = "030000000000000000000000";

78 cÚ¡ 
	gkAesGcmSivCh”‹xtHex256
[] = "c91545823cc24f17dbb0e9e807d5ec17";

79 cÚ¡ 
	gkAesGcmSivTagHex256
[] = "b292d28ff61189e8e49f3875ef91aff7";

81 
	gusšg
 ::
‹¡šg
::
Te¡W™hP¬am
;

83 
	sA—dCry±ÜP¬am
 {

84 
	g¡d
::
funùiÚ
<
StusOr
<
¡d
::
unique_±r
<
A—dCry±Ü
>>(
By‹CÚš”V›w
)>

85 
çùÜy
;

86 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
;

89 
şass
 
	gA—dCry±ÜTe¡
 : 
public
 
Te¡W™hP¬am
<
A—dCry±ÜP¬am
> {};

91 
TEST_P
(
A—dCry±ÜTe¡
, 
EndToEndTe¡
) {

92 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
 = 
G‘P¬am
().
‹¡_veùÜ
;

93 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

94 
ASYLO_ASSERT_OK_AND_ASSIGN
(
üy±Ü
, 
G‘P¬am
().
çùÜy
(
‹¡_veùÜ
.
key
));

96 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_ch”‹xt
(
‹¡_veùÜ
.
¶aš‹xt
.
size
() +

97 
üy±Ü
->
MaxS—lOv”h—d
());

98 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_nÚû
(
üy±Ü
->
NÚûSize
());

99 
size_t
 
	gaùu®_ch”‹xt_size
;

100 
ASYLO_ASSERT_OK
(
üy±Ü
->
S—l
(

101 
‹¡_veùÜ
.
¶aš‹xt
,e¡_veùÜ.
¯d
, 
ab¦
::
MakeS·n
(
aùu®_nÚû
),

102 
ab¦
::
MakeS·n
(
aùu®_ch”‹xt
), &
aùu®_ch”‹xt_size
));

103 
	gaùu®_ch”‹xt
.
»size
(
aùu®_ch”‹xt_size
);

105 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
aùu®_¶aš‹xt
(

106 
‹¡_veùÜ
.
auth’tiÿ‹d_ch”‹xt
.
size
());

107 
size_t
 
	gaùu®_¶aš‹xt_size
;

108 
ASYLO_ASSERT_OK
(
üy±Ü
->
O³n
(
aùu®_ch”‹xt
, 
‹¡_veùÜ
.
¯d
,

109 
aùu®_nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

110 &
aùu®_¶aš‹xt_size
));

111 
	gaùu®_¶aš‹xt
.
»size
(
aùu®_¶aš‹xt_size
);

112 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ
.
¶aš‹xt
),

113 
By‹CÚš”V›w
(
aùu®_¶aš‹xt
));

116 
TEST_P
(
A—dCry±ÜTe¡
, 
O³nTe¡
) {

117 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
 = 
G‘P¬am
().
‹¡_veùÜ
;

118 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

119 
ASYLO_ASSERT_OK_AND_ASSIGN
(
üy±Ü
, 
G‘P¬am
().
çùÜy
(
‹¡_veùÜ
.
key
));

121 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
aùu®_¶aš‹xt
(

122 
‹¡_veùÜ
.
auth’tiÿ‹d_ch”‹xt
.
size
());

123 
size_t
 
	gaùu®_¶aš‹xt_size
;

124 
ASYLO_ASSERT_OK
(
üy±Ü
->
O³n
(

125 
‹¡_veùÜ
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ.
¯d
,e¡_veùÜ.
nÚû
,

126 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
), &
aùu®_¶aš‹xt_size
));

127 
	gaùu®_¶aš‹xt
.
»size
(
aùu®_¶aš‹xt_size
);

128 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ
.
¶aš‹xt
),

129 
By‹CÚš”V›w
(
aùu®_¶aš‹xt
));

132 
INSTANTIATE_TEST_SUITE_P
(

133 
AÎTe¡s
, 
A—dCry±ÜTe¡
,

134 ::
‹¡šg
::
V®ues
(

136 
A—dCry±ÜP¬am
(

137 {
A—dCry±Ü
::
C»©eAesGcmCry±Ü
,

138 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

139 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

140 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
)}),

142 
A—dCry±ÜP¬am
(

143 {
A—dCry±Ü
::
C»©eAesGcmCry±Ü
,

144 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

145  "", 
kAesGcmNÚûHex256
,

146 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
)}),

148 
A—dCry±ÜP¬am
(

149 {
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
,

150 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex256
, 
kAesGcmSivKeyHex256
,

151 
kAesGcmSivAadHex256
, 
kAesGcmSivNÚûHex256
,

152 
kAesGcmSivCh”‹xtHex256
, 
kAesGcmSivTagHex256
)}),

154 
A—dCry±ÜP¬am
({
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
,

155 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex128
,

156 
kAesGcmSivKeyHex128
,

157  "", 
kAesGcmSivNÚûHex128
,

158 
kAesGcmSivCh”‹xtHex128
,

159 
kAesGcmSivTagHex128
)})));

	@crypto/aead_cryptor_test.cc

18 
	~"asylo/üy±o/«ad_üy±Ü.h
"

20 
	~<veùÜ
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/ty³s/¥ª.h
"

24 
	~"asylo/üy±o/«ad_‹¡_veùÜ.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/ş—nsšg_ty³s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gex³rim’l
 {

30 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex256
[] = "00000000000000000000000000000000";

35 
cÚ¡ex´
 
	gkAesGcmKeyHex256
[] =

38 
cÚ¡ex´
 
	gkAesGcmNÚûHex256
[] = "000000000000000000000000";

39 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex256
[] = "cea7403d4d606b6e074ec5d3baf39d18";

40 
cÚ¡ex´
 
	gkAesGcmTagHex256
[] = "d0d1c8a799996bf0265b98b5d48ab919";

44 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex128
[] =

49 
cÚ¡ex´
 
	gkAesGcmKeyHex128
[] = "feffe9928665731c6d6a8f9467308308";

50 
cÚ¡ex´
 
	gkAesGcmAadHex128
[] = "feedfacedeadbeeffeedfacedeadbeefabaddad2";

51 
cÚ¡ex´
 
	gkAesGcmNÚûHex128
[] = "cafebabefacedbaddecaf888";

52 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex128
[] =

57 
cÚ¡ex´
 
	gkAesGcmTagHex128
[] = "5bc94fbc3221a5db94fae95ae7121a47";

61 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex128
[] =

64 cÚ¡ 
	gkAesGcmSivKeyHex128
[] = "01000000000000000000000000000000";

65 cÚ¡ 
	gkAesGcmSivNÚûHex128
[] = "030000000000000000000000";

66 cÚ¡ 
	gkAesGcmSivCh”‹xtHex128
[] =

69 cÚ¡ 
	gkAesGcmSivTagHex128
[] = "1a8e45dcd4578c667cd86847bf6155ff";

72 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex256
[] = "02000000000000000000000000000000";

73 cÚ¡ 
	gkAesGcmSivKeyHex256
[] =

76 cÚ¡ 
	gkAesGcmSivAadHex256
[] = "01";

77 cÚ¡ 
	gkAesGcmSivNÚûHex256
[] = "030000000000000000000000";

78 cÚ¡ 
	gkAesGcmSivCh”‹xtHex256
[] = "c91545823cc24f17dbb0e9e807d5ec17";

79 cÚ¡ 
	gkAesGcmSivTagHex256
[] = "b292d28ff61189e8e49f3875ef91aff7";

81 
	gusšg
 ::
‹¡šg
::
Te¡W™hP¬am
;

83 
	sA—dCry±ÜP¬am
 {

84 
	g¡d
::
funùiÚ
<
StusOr
<
¡d
::
unique_±r
<
A—dCry±Ü
>>(
By‹CÚš”V›w
)>

85 
çùÜy
;

86 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
;

89 
şass
 
	gA—dCry±ÜTe¡
 : 
public
 
Te¡W™hP¬am
<
A—dCry±ÜP¬am
> {};

91 
TEST_P
(
A—dCry±ÜTe¡
, 
EndToEndTe¡
) {

92 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
 = 
G‘P¬am
().
‹¡_veùÜ
;

93 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

94 
ASYLO_ASSERT_OK_AND_ASSIGN
(
üy±Ü
, 
G‘P¬am
().
çùÜy
(
‹¡_veùÜ
.
key
));

96 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_ch”‹xt
(
‹¡_veùÜ
.
¶aš‹xt
.
size
() +

97 
üy±Ü
->
MaxS—lOv”h—d
());

98 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_nÚû
(
üy±Ü
->
NÚûSize
());

99 
size_t
 
	gaùu®_ch”‹xt_size
;

100 
ASYLO_ASSERT_OK
(
üy±Ü
->
S—l
(

101 
‹¡_veùÜ
.
¶aš‹xt
,e¡_veùÜ.
¯d
, 
ab¦
::
MakeS·n
(
aùu®_nÚû
),

102 
ab¦
::
MakeS·n
(
aùu®_ch”‹xt
), &
aùu®_ch”‹xt_size
));

103 
	gaùu®_ch”‹xt
.
»size
(
aùu®_ch”‹xt_size
);

105 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
aùu®_¶aš‹xt
(

106 
‹¡_veùÜ
.
auth’tiÿ‹d_ch”‹xt
.
size
());

107 
size_t
 
	gaùu®_¶aš‹xt_size
;

108 
ASYLO_ASSERT_OK
(
üy±Ü
->
O³n
(
aùu®_ch”‹xt
, 
‹¡_veùÜ
.
¯d
,

109 
aùu®_nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

110 &
aùu®_¶aš‹xt_size
));

111 
	gaùu®_¶aš‹xt
.
»size
(
aùu®_¶aš‹xt_size
);

112 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ
.
¶aš‹xt
),

113 
By‹CÚš”V›w
(
aùu®_¶aš‹xt
));

116 
TEST_P
(
A—dCry±ÜTe¡
, 
O³nTe¡
) {

117 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
 = 
G‘P¬am
().
‹¡_veùÜ
;

118 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

119 
ASYLO_ASSERT_OK_AND_ASSIGN
(
üy±Ü
, 
G‘P¬am
().
çùÜy
(
‹¡_veùÜ
.
key
));

121 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
aùu®_¶aš‹xt
(

122 
‹¡_veùÜ
.
auth’tiÿ‹d_ch”‹xt
.
size
());

123 
size_t
 
	gaùu®_¶aš‹xt_size
;

124 
ASYLO_ASSERT_OK
(
üy±Ü
->
O³n
(

125 
‹¡_veùÜ
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ.
¯d
,e¡_veùÜ.
nÚû
,

126 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
), &
aùu®_¶aš‹xt_size
));

127 
	gaùu®_¶aš‹xt
.
»size
(
aùu®_¶aš‹xt_size
);

128 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ
.
¶aš‹xt
),

129 
By‹CÚš”V›w
(
aùu®_¶aš‹xt
));

132 
INSTANTIATE_TEST_SUITE_P
(

133 
AÎTe¡s
, 
A—dCry±ÜTe¡
,

134 ::
‹¡šg
::
V®ues
(

136 
A—dCry±ÜP¬am
(

137 {
A—dCry±Ü
::
C»©eAesGcmCry±Ü
,

138 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

139 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

140 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
)}),

142 
A—dCry±ÜP¬am
(

143 {
A—dCry±Ü
::
C»©eAesGcmCry±Ü
,

144 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

145  "", 
kAesGcmNÚûHex256
,

146 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
)}),

148 
A—dCry±ÜP¬am
(

149 {
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
,

150 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex256
, 
kAesGcmSivKeyHex256
,

151 
kAesGcmSivAadHex256
, 
kAesGcmSivNÚûHex256
,

152 
kAesGcmSivCh”‹xtHex256
, 
kAesGcmSivTagHex256
)}),

154 
A—dCry±ÜP¬am
({
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
,

155 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex128
,

156 
kAesGcmSivKeyHex128
,

157  "", 
kAesGcmSivNÚûHex128
,

158 
kAesGcmSivCh”‹xtHex128
,

159 
kAesGcmSivTagHex128
)})));

	@crypto/aead_key.cc

19 
	~"asylo/üy±o/«ad_key.h
"

21 
	~<İ’s¦/«ad.h
>

22 
	~<memÜy
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

27 
	~"asylo/üy±o/ut/bs¦_ut.h
"

28 
	~"asylo/ut/ş—nup.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
size_t
 
	gkAes128KeySize
 = 16;

35 
cÚ¡ex´
 
size_t
 
	gkAes256KeySize
 = 32;

38 cÚ¡ 
EVP_AEAD
 *
G‘EvpA—d
(
A—dScheme
 
«ad_scheme
) {

39 
	g«ad_scheme
) {

40 
	gAES128_GCM
:

41  
EVP_«ad_«s_128_gcm
();

42 
	gAES256_GCM
:

43  
EVP_«ad_«s_256_gcm
();

44 
	gAES128_GCM_SIV
:

45  
EVP_«ad_«s_128_gcm_siv
();

46 
	gAES256_GCM_SIV
:

47  
EVP_«ad_«s_256_gcm_siv
();

48 
	gUNKNOWN_AEAD_SCHEME
:

50  
nuÎ±r
;

55 
A—dScheme
 
G‘AesGcmA—dScheme
(
size_t
 
key_size
) {

56 ià(
	gkey_size
 =ğ
kAes128KeySize
) {

57  
AES128_GCM
;

58 } ià(
	gkey_size
 =ğ
kAes256KeySize
) {

59  
AES256_GCM
;

61  
	gUNKNOWN_AEAD_SCHEME
;

65 
A—dScheme
 
G‘AesGcmSivA—dScheme
(
size_t
 
key_size
) {

66 ià(
	gkey_size
 =ğ
kAes128KeySize
) {

67  
AES128_GCM_SIV
;

68 } ià(
	gkey_size
 =ğ
kAes256KeySize
) {

69  
AES256_GCM_SIV
;

71  
	gUNKNOWN_AEAD_SCHEME
;

76 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dKey
>> A—dKey::
C»©eAesGcmKey
(

77 
By‹CÚš”V›w
 
key
) {

78 
A—dScheme
 
scheme
 = 
G‘AesGcmA—dScheme
(
key
.
size
());

79 ià(
	gscheme
 =ğ
UNKNOWN_AEAD_SCHEME
) {

80  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

81 
ab¦
::
SŒC©
("Inv®id AES-GCM key†’gth: ", 
key
.
size
(),

84  
	gab¦
::
W¿pUnique
<
A—dKey
>(
Ãw
 A—dKey(
scheme
, 
key
));

87 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dKey
>> A—dKey::
C»©eAesGcmSivKey
(

88 
By‹CÚš”V›w
 
key
) {

89 
A—dScheme
 
scheme
 = 
G‘AesGcmSivA—dScheme
(
key
.
size
());

90 ià(
	gscheme
 =ğ
UNKNOWN_AEAD_SCHEME
) {

91  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

92 
ab¦
::
SŒC©
("Inv®id AES-GCM-SIV key†’gth: ", 
key
.
size
(),

95  
	gab¦
::
W¿pUnique
<
A—dKey
>(
Ãw
 A—dKey(
scheme
, 
key
));

98 
A—dScheme
 
	gA—dKey
::
G‘A—dScheme
(ècÚ¡ {  
«ad_scheme_
; }

100 
size_t
 
	gA—dKey
::
NÚûSize
(ècÚ¡ {  
nÚû_size_
; }

102 
size_t
 
	gA—dKey
::
MaxS—lOv”h—d
(ècÚ¡ {  
max_£®_ov”h—d_
; }

104 
Stus
 
	gA—dKey
::
S—l
(
By‹CÚš”V›w
 
¶aš‹xt
,

105 
By‹CÚš”V›w
 
assocŸ‹d_d©a
, By‹CÚš”V›w 
nÚû
,

106 
ab¦
::
S·n
<
ušt8_t
> 
ch”‹xt
, 
size_t
 *
ch”‹xt_size
) {

107 ià(
	gnÚû
.
size
(è!ğ
nÚû_size_
) {

108  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
ab¦
::
SŒC©
("Inv®id‚Úû†’gth: ", 
nÚû
.
size
(),

110 " (mu¡ b", 
nÚû_size_
, " bytes)"));

113 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

114 
CËªup
 
ş—nup_cÚ‹xt
([&
cÚ‹xt
](è{ 
EVP_AEAD_CTX_ş—nup
(&context); });

116 ià(
EVP_AEAD_CTX_š™
(&
cÚ‹xt
, 
«ad_
, 
key_
.
d©a
(), key_.
size
(),

117 
EVP_AEAD_max_g_Ën
(
«ad_
),

118  
nuÎ±r
) != 1) {

119  
Stus
(

120 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

121 
ab¦
::
SŒC©
("EVP_AEAD_CTX_š™ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

124 ià(
EVP_AEAD_CTX_£®
(&
cÚ‹xt
, 
ch”‹xt
.
d©a
(), 
ch”‹xt_size
,

125 
ch”‹xt
.
size
(), 
nÚû
.
d©a
(),‚once.size(),

126 
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
(),

127 
assocŸ‹d_d©a
.
d©a
(),‡ssocŸ‹d_d©a.
size
()) != 1) {

128  
Stus
(

129 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

130 
ab¦
::
SŒC©
("EVP_AEAD_CTX_£® faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

133  
	gStus
::
OkStus
();

136 
Stus
 
	gA—dKey
::
O³n
(
By‹CÚš”V›w
 
ch”‹xt
,

137 
By‹CÚš”V›w
 
assocŸ‹d_d©a
, By‹CÚš”V›w 
nÚû
,

138 
ab¦
::
S·n
<
ušt8_t
> 
¶aš‹xt
, 
size_t
 *
¶aš‹xt_size
) {

139 ià(
	gnÚû
.
size
(è!ğ
nÚû_size_
) {

140  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

141 
ab¦
::
SŒC©
("Inv®id‚Úû†’gth: ", 
nÚû
.
size
(),

142 " (mu¡ b", 
nÚû_size_
, " bytes)"));

145 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

146 
CËªup
 
ş—nup_cÚ‹xt
([&
cÚ‹xt
](è{ 
EVP_AEAD_CTX_ş—nup
(&context); });

147 ià(
EVP_AEAD_CTX_š™
(&
cÚ‹xt
, 
«ad_
, 
key_
.
d©a
(), key_.
size
(),

148 
EVP_AEAD_max_g_Ën
(
«ad_
),

149  
nuÎ±r
) != 1) {

150  
Stus
(

151 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

152 
ab¦
::
SŒC©
("EVP_AEAD_CTX_š™ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

155 ià(
EVP_AEAD_CTX_İ’
(&
cÚ‹xt
, 
¶aš‹xt
.
d©a
(), 
¶aš‹xt_size
,

156 
¶aš‹xt
.
size
(), 
nÚû
.
d©a
(),‚once.size(),

157 
ch”‹xt
.
d©a
(), ch”‹xt.
size
(),

158 
assocŸ‹d_d©a
.
d©a
(),‡ssocŸ‹d_d©a.
size
()) != 1) {

159  
Stus
(

160 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

161 
ab¦
::
SŒC©
("EVP_AEAD_CTX_İ’ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

164  
	gStus
::
OkStus
();

167 
	gA—dKey
::
A—dKey
(
A—dScheme
 
«ad_scheme
, 
By‹CÚš”V›w
 
key
)

168 : 
«ad_
(
G‘EvpA—d
(
«ad_scheme
)),

169 
«ad_scheme_
(
«ad_scheme
),

170 
key_
(
key
.
cbegš
(), key.
ûnd
()),

171 
max_£®_ov”h—d_
(
EVP_AEAD_max_ov”h—d
(
«ad_
)),

172 
nÚû_size_
(
EVP_AEAD_nÚû_Ëngth
(
«ad_
)) {}

	@crypto/aead_key.cc

19 
	~"asylo/üy±o/«ad_key.h
"

21 
	~<İ’s¦/«ad.h
>

22 
	~<memÜy
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

27 
	~"asylo/üy±o/ut/bs¦_ut.h
"

28 
	~"asylo/ut/ş—nup.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
size_t
 
	gkAes128KeySize
 = 16;

35 
cÚ¡ex´
 
size_t
 
	gkAes256KeySize
 = 32;

38 cÚ¡ 
EVP_AEAD
 *
G‘EvpA—d
(
A—dScheme
 
«ad_scheme
) {

39 
	g«ad_scheme
) {

40 
	gAES128_GCM
:

41  
EVP_«ad_«s_128_gcm
();

42 
	gAES256_GCM
:

43  
EVP_«ad_«s_256_gcm
();

44 
	gAES128_GCM_SIV
:

45  
EVP_«ad_«s_128_gcm_siv
();

46 
	gAES256_GCM_SIV
:

47  
EVP_«ad_«s_256_gcm_siv
();

48 
	gUNKNOWN_AEAD_SCHEME
:

50  
nuÎ±r
;

55 
A—dScheme
 
G‘AesGcmA—dScheme
(
size_t
 
key_size
) {

56 ià(
	gkey_size
 =ğ
kAes128KeySize
) {

57  
AES128_GCM
;

58 } ià(
	gkey_size
 =ğ
kAes256KeySize
) {

59  
AES256_GCM
;

61  
	gUNKNOWN_AEAD_SCHEME
;

65 
A—dScheme
 
G‘AesGcmSivA—dScheme
(
size_t
 
key_size
) {

66 ià(
	gkey_size
 =ğ
kAes128KeySize
) {

67  
AES128_GCM_SIV
;

68 } ià(
	gkey_size
 =ğ
kAes256KeySize
) {

69  
AES256_GCM_SIV
;

71  
	gUNKNOWN_AEAD_SCHEME
;

76 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dKey
>> A—dKey::
C»©eAesGcmKey
(

77 
By‹CÚš”V›w
 
key
) {

78 
A—dScheme
 
scheme
 = 
G‘AesGcmA—dScheme
(
key
.
size
());

79 ià(
	gscheme
 =ğ
UNKNOWN_AEAD_SCHEME
) {

80  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

81 
ab¦
::
SŒC©
("Inv®id AES-GCM key†’gth: ", 
key
.
size
(),

84  
	gab¦
::
W¿pUnique
<
A—dKey
>(
Ãw
 A—dKey(
scheme
, 
key
));

87 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dKey
>> A—dKey::
C»©eAesGcmSivKey
(

88 
By‹CÚš”V›w
 
key
) {

89 
A—dScheme
 
scheme
 = 
G‘AesGcmSivA—dScheme
(
key
.
size
());

90 ià(
	gscheme
 =ğ
UNKNOWN_AEAD_SCHEME
) {

91  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

92 
ab¦
::
SŒC©
("Inv®id AES-GCM-SIV key†’gth: ", 
key
.
size
(),

95  
	gab¦
::
W¿pUnique
<
A—dKey
>(
Ãw
 A—dKey(
scheme
, 
key
));

98 
A—dScheme
 
	gA—dKey
::
G‘A—dScheme
(ècÚ¡ {  
«ad_scheme_
; }

100 
size_t
 
	gA—dKey
::
NÚûSize
(ècÚ¡ {  
nÚû_size_
; }

102 
size_t
 
	gA—dKey
::
MaxS—lOv”h—d
(ècÚ¡ {  
max_£®_ov”h—d_
; }

104 
Stus
 
	gA—dKey
::
S—l
(
By‹CÚš”V›w
 
¶aš‹xt
,

105 
By‹CÚš”V›w
 
assocŸ‹d_d©a
, By‹CÚš”V›w 
nÚû
,

106 
ab¦
::
S·n
<
ušt8_t
> 
ch”‹xt
, 
size_t
 *
ch”‹xt_size
) {

107 ià(
	gnÚû
.
size
(è!ğ
nÚû_size_
) {

108  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
ab¦
::
SŒC©
("Inv®id‚Úû†’gth: ", 
nÚû
.
size
(),

110 " (mu¡ b", 
nÚû_size_
, " bytes)"));

113 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

114 
CËªup
 
ş—nup_cÚ‹xt
([&
cÚ‹xt
](è{ 
EVP_AEAD_CTX_ş—nup
(&context); });

116 ià(
EVP_AEAD_CTX_š™
(&
cÚ‹xt
, 
«ad_
, 
key_
.
d©a
(), key_.
size
(),

117 
EVP_AEAD_max_g_Ën
(
«ad_
),

118  
nuÎ±r
) != 1) {

119  
Stus
(

120 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

121 
ab¦
::
SŒC©
("EVP_AEAD_CTX_š™ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

124 ià(
EVP_AEAD_CTX_£®
(&
cÚ‹xt
, 
ch”‹xt
.
d©a
(), 
ch”‹xt_size
,

125 
ch”‹xt
.
size
(), 
nÚû
.
d©a
(),‚once.size(),

126 
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
(),

127 
assocŸ‹d_d©a
.
d©a
(),‡ssocŸ‹d_d©a.
size
()) != 1) {

128  
Stus
(

129 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

130 
ab¦
::
SŒC©
("EVP_AEAD_CTX_£® faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

133  
	gStus
::
OkStus
();

136 
Stus
 
	gA—dKey
::
O³n
(
By‹CÚš”V›w
 
ch”‹xt
,

137 
By‹CÚš”V›w
 
assocŸ‹d_d©a
, By‹CÚš”V›w 
nÚû
,

138 
ab¦
::
S·n
<
ušt8_t
> 
¶aš‹xt
, 
size_t
 *
¶aš‹xt_size
) {

139 ià(
	gnÚû
.
size
(è!ğ
nÚû_size_
) {

140  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

141 
ab¦
::
SŒC©
("Inv®id‚Úû†’gth: ", 
nÚû
.
size
(),

142 " (mu¡ b", 
nÚû_size_
, " bytes)"));

145 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

146 
CËªup
 
ş—nup_cÚ‹xt
([&
cÚ‹xt
](è{ 
EVP_AEAD_CTX_ş—nup
(&context); });

147 ià(
EVP_AEAD_CTX_š™
(&
cÚ‹xt
, 
«ad_
, 
key_
.
d©a
(), key_.
size
(),

148 
EVP_AEAD_max_g_Ën
(
«ad_
),

149  
nuÎ±r
) != 1) {

150  
Stus
(

151 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

152 
ab¦
::
SŒC©
("EVP_AEAD_CTX_š™ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

155 ià(
EVP_AEAD_CTX_İ’
(&
cÚ‹xt
, 
¶aš‹xt
.
d©a
(), 
¶aš‹xt_size
,

156 
¶aš‹xt
.
size
(), 
nÚû
.
d©a
(),‚once.size(),

157 
ch”‹xt
.
d©a
(), ch”‹xt.
size
(),

158 
assocŸ‹d_d©a
.
d©a
(),‡ssocŸ‹d_d©a.
size
()) != 1) {

159  
Stus
(

160 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

161 
ab¦
::
SŒC©
("EVP_AEAD_CTX_İ’ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

164  
	gStus
::
OkStus
();

167 
	gA—dKey
::
A—dKey
(
A—dScheme
 
«ad_scheme
, 
By‹CÚš”V›w
 
key
)

168 : 
«ad_
(
G‘EvpA—d
(
«ad_scheme
)),

169 
«ad_scheme_
(
«ad_scheme
),

170 
key_
(
key
.
cbegš
(), key.
ûnd
()),

171 
max_£®_ov”h—d_
(
EVP_AEAD_max_ov”h—d
(
«ad_
)),

172 
nÚû_size_
(
EVP_AEAD_nÚû_Ëngth
(
«ad_
)) {}

	@crypto/aead_key.h

19 #iâdeà
ASYLO_CRYPTO_AEAD_KEY_H_


20 
	#ASYLO_CRYPTO_AEAD_KEY_H_


	)

22 
	~<İ’s¦/«ad.h
>

23 
	~<c¡dšt
>

24 
	~<memÜy
>

25 
	~<veùÜ
>

27 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

29 
	~"asylo/ut/ş—nsšg_ty³s.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

33 
Çme¥aû
 
	gasylo
 {

36 şas 
	cA—dKey
 {

37 
	gpublic
:

41 
StusOr
<
¡d
::
unique_±r
<
A—dKey
>> 
C»©eAesGcmKey
(

42 
By‹CÚš”V›w
 
key
);

47 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dKey
>> 
C»©eAesGcmSivKey
(

48 
By‹CÚš”V›w
 
key
);

51 
A—dScheme
 
G‘A—dScheme
() const;

54 
size_t
 
NÚûSize
() const;

57 
size_t
 
MaxS—lOv”h—d
() const;

63 
Stus
 
S—l
(
By‹CÚš”V›w
 
¶aš‹xt
, By‹CÚš”V›w 
assocŸ‹d_d©a
,

64 
By‹CÚš”V›w
 
nÚû
, 
ab¦
::
S·n
<
ušt8_t
> 
ch”‹xt
,

65 
size_t
 *
ch”‹xt_size
);

71 
Stus
 
O³n
(
By‹CÚš”V›w
 
ch”‹xt
, By‹CÚš”V›w 
assocŸ‹d_d©a
,

72 
By‹CÚš”V›w
 
nÚû
, 
ab¦
::
S·n
<
ušt8_t
> 
¶aš‹xt
,

73 
size_t
 *
¶aš‹xt_size
);

75 
	g´iv©e
:

76 
A—dKey
(
A—dScheme
 
scheme
, 
By‹CÚš”V›w
 
key
);

79 cÚ¡ 
EVP_AEAD
 *cÚ¡ 
	g«ad_
;

82 cÚ¡ 
A—dScheme
 
	g«ad_scheme_
;

85 cÚ¡ 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey_
;

88 cÚ¡ 
size_t
 
	gmax_£®_ov”h—d_
;

91 cÚ¡ 
size_t
 
	gnÚû_size_
;

	@crypto/aead_key_test.cc

19 
	~"asylo/üy±o/«ad_key.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/esÿpšg.h
"

27 
	~"ab¦/ty³s/¥ª.h
"

28 
	~"asylo/üy±o/«ad_‹¡_veùÜ.h
"

29 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
	~"asylo/ut/¡©us.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

38 
	gusšg
 ::
‹¡šg
::
Te¡W™hP¬am
;

42 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex256
[] = "00000000000000000000000000000000";

43 
cÚ¡ex´
 
	gkAesGcmKeyHex256
[] =

46 
cÚ¡ex´
 
	gkAesGcmNÚûHex256
[] = "000000000000000000000000";

47 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex256
[] = "cea7403d4d606b6e074ec5d3baf39d18";

48 
cÚ¡ex´
 
	gkAesGcmTagHex256
[] = "d0d1c8a799996bf0265b98b5d48ab919";

52 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex128
[] =

57 
cÚ¡ex´
 
	gkAesGcmKeyHex128
[] = "feffe9928665731c6d6a8f9467308308";

58 
cÚ¡ex´
 
	gkAesGcmAadHex128
[] = "feedfacedeadbeeffeedfacedeadbeefabaddad2";

59 
cÚ¡ex´
 
	gkAesGcmNÚûHex128
[] = "cafebabefacedbaddecaf888";

60 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex128
[] =

65 
cÚ¡ex´
 
	gkAesGcmTagHex128
[] = "5bc94fbc3221a5db94fae95ae7121a47";

69 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex128
[] =

72 cÚ¡ 
	gkAesGcmSivKeyHex128
[] = "01000000000000000000000000000000";

73 cÚ¡ 
	gkAesGcmSivNÚûHex128
[] = "030000000000000000000000";

74 cÚ¡ 
	gkAesGcmSivCh”‹xtHex128
[] =

77 cÚ¡ 
	gkAesGcmSivTagHex128
[] = "1a8e45dcd4578c667cd86847bf6155ff";

80 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex256
[] = "02000000000000000000000000000000";

81 cÚ¡ 
	gkAesGcmSivKeyHex256
[] =

84 cÚ¡ 
	gkAesGcmSivAadHex256
[] = "01";

85 cÚ¡ 
	gkAesGcmSivNÚûHex256
[] = "030000000000000000000000";

86 cÚ¡ 
	gkAesGcmSivCh”‹xtHex256
[] = "c91545823cc24f17dbb0e9e807d5ec17";

87 cÚ¡ 
	gkAesGcmSivTagHex256
[] = "b292d28ff61189e8e49f3875ef91aff7";

89 
cÚ¡ex´
 
	gkAesGcmBadNÚûSŒšg
[] = "123456";

90 
cÚ¡ex´
 
	gkAesGcmBadKeySŒšg
[] = "deadbeef1337";

91 
cÚ¡ex´
 
size_t
 
	gkAesGcmNÚûSize
 = 12;

93 
	sA—dKeyP¬am
 {

94 
	g¡d
::
funùiÚ
<
StusOr
<
¡d
::
unique_±r
<
A—dKey
>>(
By‹CÚš”V›w
)> 
çùÜy
;

95 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
;

96 
A—dTe¡VeùÜ
 
	gbad_d©a_veùÜ
;

98 
A—dScheme
 
	gex³ùed_scheme
;

99 
size_t
 
	gex³ùed_nÚû_size
;

102 
şass
 
	gA—dKeyTe¡
 : 
public
 
Te¡W™hP¬am
<
A—dKeyP¬am
> {

103 
public
:

104 
S‘Up
(è
ov”ride
 {

105 
‹¡_veùÜ_
 = 
G‘P¬am
().
‹¡_veùÜ
;

106 
ASYLO_ASSERT_OK_AND_ASSIGN
(
‹¡_key_
, 
G‘P¬am
().
çùÜy
(
‹¡_veùÜ_
.
key
));

107 
	gbad_d©a_veùÜ_
 = 
G‘P¬am
().
bad_d©a_veùÜ
;

108 
ASYLO_ASSERT_OK_AND_ASSIGN
(
bad_key_
,

109 
G‘P¬am
().
çùÜy
(
bad_d©a_veùÜ_
.
key
));

112 
	g¡d
::
unique_±r
<
A—dKey
> 
‹¡_key_
;

113 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ_
;

117 
	g¡d
::
unique_±r
<
A—dKey
> 
bad_key_
;

118 
A—dTe¡VeùÜ
 
	gbad_d©a_veùÜ_
;

122 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡A—dScheme
) {

123 
EXPECT_EQ
(
‹¡_key_
->
G‘A—dScheme
(), 
G‘P¬am
().
ex³ùed_scheme
);

127 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡NÚûSize
) {

128 
EXPECT_EQ
(
‹¡_key_
->
NÚûSize
(), 
G‘P¬am
().
ex³ùed_nÚû_size
);

132 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡VeùÜ
) {

133 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_ch”‹xt
(
‹¡_veùÜ_
.
¶aš‹xt
.
size
() +

134 
‹¡_key_
->
MaxS—lOv”h—d
());

135 
size_t
 
	gaùu®_ch”‹xt_size
;

136 
ASYLO_ASSERT_OK
(
‹¡_key_
->
S—l
(

137 
‹¡_veùÜ_
.
¶aš‹xt
,e¡_veùÜ_.
¯d
,e¡_veùÜ_.
nÚû
,

138 
ab¦
::
MakeS·n
(
aùu®_ch”‹xt
), &
aùu®_ch”‹xt_size
));

139 
EXPECT_EQ
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
(),

140 
aùu®_ch”‹xt_size
);

141 
	gaùu®_ch”‹xt
.
»size
(
aùu®_ch”‹xt_size
);

142 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
),

143 
By‹CÚš”V›w
(
aùu®_ch”‹xt
));

145 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
aùu®_¶aš‹xt
(

146 
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
());

147 
size_t
 
	gaùu®_¶aš‹xt_size
;

148 
ASYLO_ASSERT_OK
(
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,

149 
‹¡_veùÜ_
.
¯d
,e¡_veùÜ_.
nÚû
,

150 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

151 &
aùu®_¶aš‹xt_size
));

152 
	gaùu®_¶aš‹xt
.
»size
(
aùu®_¶aš‹xt_size
);

153 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ_
.
¶aš‹xt
),

154 
By‹CÚš”V›w
(
aùu®_¶aš‹xt
));

158 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡Inv®idIÅutS—l
) {

159 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_ch”‹xt
(
‹¡_veùÜ_
.
¶aš‹xt
.
size
() +

160 
‹¡_key_
->
MaxS—lOv”h—d
());

161 
size_t
 
	gaùu®_ch”‹xt_size
;

164 autØ
	gbad_nÚû
 = 
ab¦
::
HexSŒšgToBy‹s
(
kAesGcmBadNÚûSŒšg
);

165 
EXPECT_THAT
(
‹¡_key_
->
S—l
(
‹¡_veùÜ_
.
¶aš‹xt
, "",

166 
bad_nÚû
, 
ab¦
::
MakeS·n
(
aùu®_ch”‹xt
),

167 &
aùu®_ch”‹xt_size
),

168 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

172 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡Inv®idIÅutO³n
) {

173 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_¶aš‹xt
(

174 
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
());

175 
size_t
 
	gaùu®_¶aš‹xt_size
;

178 autØ
	gbad_nÚû
 = 
ab¦
::
HexSŒšgToBy‹s
(
kAesGcmBadNÚûSŒšg
);

179 
EXPECT_THAT
(

180 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

181 
bad_nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

182 &
aùu®_¶aš‹xt_size
),

183 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

189 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡WrÚgInfÜm©iÚ
) {

190 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_¶aš‹xt
(

191 
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
());

192 
size_t
 
	gaùu®_¶aš‹xt_size
;

195 
EXPECT_THAT
(

196 
bad_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

197 
‹¡_veùÜ_
.
nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

198 &
aùu®_¶aš‹xt_size
),

199 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

202 
EXPECT_THAT
(

203 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

204 
bad_d©a_veùÜ_
.
nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

205 &
aùu®_¶aš‹xt_size
),

206 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

209 
EXPECT_THAT
(

210 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,

211 
bad_d©a_veùÜ_
.
¯d
, 
‹¡_veùÜ_
.
nÚû
,

212 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
), &
aùu®_¶aš‹xt_size
),

213 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

216 autØ
	guÇuth’tiÿ‹d_ch”‹xt_¡r
 =

217 
ab¦
::
HexSŒšgToBy‹s
(
kAesGcmCh”‹xtHex128
);

218 
	g¡d
::
veùÜ
<
ušt8_t
> 
uÇuth’tiÿ‹d_ch”‹xt
(

219 
uÇuth’tiÿ‹d_ch”‹xt_¡r
.
cbegš
(),

220 
uÇuth’tiÿ‹d_ch”‹xt_¡r
.
ûnd
());

221 
EXPECT_THAT
(

222 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
uÇuth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

223 
‹¡_veùÜ_
.
nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

224 &
aùu®_¶aš‹xt_size
),

225 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

229 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡Inv®idKey
) {

230 autØ
	gbad_key_»suÉ
 =

231 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
kAesGcmBadKeySŒšg
)>(

232 
kAesGcmBadKeySŒšg
);

233 
ASYLO_ASSERT_OK
(
bad_key_»suÉ
);

234 autØ
	gbad_key
 = 
bad_key_»suÉ
.
V®ueOrD›
();

236 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dKey
>> 
bad_‹¡_key_»suÉ
 =

237 
G‘P¬am
().
çùÜy
(
bad_key
);

238 
EXPECT_THAT
(
bad_‹¡_key_»suÉ
.
¡©us
(),

239 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

242 
INSTANTIATE_TEST_SUITE_P
(

243 
AÎTe¡s
, 
A—dKeyTe¡
,

244 ::
‹¡šg
::
V®ues
(

246 
A—dKeyP¬am
({
A—dKey
::
C»©eAesGcmKey
,

248 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

249 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

250 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
),

252 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

253  "", 
kAesGcmNÚûHex256
,

254 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
),

255 
A—dScheme
::
AES128_GCM
, 
kAesGcmNÚûSize
}),

257 
A—dKeyP¬am
({
A—dKey
::
C»©eAesGcmKey
,

259 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

260  "", 
kAesGcmNÚûHex256
,

261 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
),

263 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

264 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

265 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
),

266 
A—dScheme
::
AES256_GCM
, 
kAesGcmNÚûSize
}),

268 
A—dKeyP¬am
(

269 {
A—dKey
::
C»©eAesGcmSivKey
,

271 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex128
, 
kAesGcmSivKeyHex128
,

272  "", 
kAesGcmSivNÚûHex128
,

273 
kAesGcmSivCh”‹xtHex128
, 
kAesGcmSivTagHex128
),

275 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

276 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

277 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
),

278 
A—dScheme
::
AES128_GCM_SIV
, 
kAesGcmNÚûSize
}),

280 
A—dKeyP¬am
(

281 {
A—dKey
::
C»©eAesGcmSivKey
,

283 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex256
, 
kAesGcmSivKeyHex256
,

284 
kAesGcmSivAadHex256
, 
kAesGcmSivNÚûHex256
,

285 
kAesGcmSivCh”‹xtHex256
, 
kAesGcmSivTagHex256
),

287 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

288  "", 
kAesGcmNÚûHex256
,

289 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
),

290 
A—dScheme
::
AES256_GCM_SIV
, 
kAesGcmNÚûSize
})));

	@crypto/aead_key_test.cc

19 
	~"asylo/üy±o/«ad_key.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/esÿpšg.h
"

27 
	~"ab¦/ty³s/¥ª.h
"

28 
	~"asylo/üy±o/«ad_‹¡_veùÜ.h
"

29 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
	~"asylo/ut/¡©us.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

38 
	gusšg
 ::
‹¡šg
::
Te¡W™hP¬am
;

42 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex256
[] = "00000000000000000000000000000000";

43 
cÚ¡ex´
 
	gkAesGcmKeyHex256
[] =

46 
cÚ¡ex´
 
	gkAesGcmNÚûHex256
[] = "000000000000000000000000";

47 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex256
[] = "cea7403d4d606b6e074ec5d3baf39d18";

48 
cÚ¡ex´
 
	gkAesGcmTagHex256
[] = "d0d1c8a799996bf0265b98b5d48ab919";

52 
cÚ¡ex´
 
	gkAesGcmPÏš‹xtHex128
[] =

57 
cÚ¡ex´
 
	gkAesGcmKeyHex128
[] = "feffe9928665731c6d6a8f9467308308";

58 
cÚ¡ex´
 
	gkAesGcmAadHex128
[] = "feedfacedeadbeeffeedfacedeadbeefabaddad2";

59 
cÚ¡ex´
 
	gkAesGcmNÚûHex128
[] = "cafebabefacedbaddecaf888";

60 
cÚ¡ex´
 
	gkAesGcmCh”‹xtHex128
[] =

65 
cÚ¡ex´
 
	gkAesGcmTagHex128
[] = "5bc94fbc3221a5db94fae95ae7121a47";

69 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex128
[] =

72 cÚ¡ 
	gkAesGcmSivKeyHex128
[] = "01000000000000000000000000000000";

73 cÚ¡ 
	gkAesGcmSivNÚûHex128
[] = "030000000000000000000000";

74 cÚ¡ 
	gkAesGcmSivCh”‹xtHex128
[] =

77 cÚ¡ 
	gkAesGcmSivTagHex128
[] = "1a8e45dcd4578c667cd86847bf6155ff";

80 cÚ¡ 
	gkAesGcmSivPÏš‹xtHex256
[] = "02000000000000000000000000000000";

81 cÚ¡ 
	gkAesGcmSivKeyHex256
[] =

84 cÚ¡ 
	gkAesGcmSivAadHex256
[] = "01";

85 cÚ¡ 
	gkAesGcmSivNÚûHex256
[] = "030000000000000000000000";

86 cÚ¡ 
	gkAesGcmSivCh”‹xtHex256
[] = "c91545823cc24f17dbb0e9e807d5ec17";

87 cÚ¡ 
	gkAesGcmSivTagHex256
[] = "b292d28ff61189e8e49f3875ef91aff7";

89 
cÚ¡ex´
 
	gkAesGcmBadNÚûSŒšg
[] = "123456";

90 
cÚ¡ex´
 
	gkAesGcmBadKeySŒšg
[] = "deadbeef1337";

91 
cÚ¡ex´
 
size_t
 
	gkAesGcmNÚûSize
 = 12;

93 
	sA—dKeyP¬am
 {

94 
	g¡d
::
funùiÚ
<
StusOr
<
¡d
::
unique_±r
<
A—dKey
>>(
By‹CÚš”V›w
)> 
çùÜy
;

95 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ
;

96 
A—dTe¡VeùÜ
 
	gbad_d©a_veùÜ
;

98 
A—dScheme
 
	gex³ùed_scheme
;

99 
size_t
 
	gex³ùed_nÚû_size
;

102 
şass
 
	gA—dKeyTe¡
 : 
public
 
Te¡W™hP¬am
<
A—dKeyP¬am
> {

103 
public
:

104 
S‘Up
(è
ov”ride
 {

105 
‹¡_veùÜ_
 = 
G‘P¬am
().
‹¡_veùÜ
;

106 
ASYLO_ASSERT_OK_AND_ASSIGN
(
‹¡_key_
, 
G‘P¬am
().
çùÜy
(
‹¡_veùÜ_
.
key
));

107 
	gbad_d©a_veùÜ_
 = 
G‘P¬am
().
bad_d©a_veùÜ
;

108 
ASYLO_ASSERT_OK_AND_ASSIGN
(
bad_key_
,

109 
G‘P¬am
().
çùÜy
(
bad_d©a_veùÜ_
.
key
));

112 
	g¡d
::
unique_±r
<
A—dKey
> 
‹¡_key_
;

113 
A—dTe¡VeùÜ
 
	g‹¡_veùÜ_
;

117 
	g¡d
::
unique_±r
<
A—dKey
> 
bad_key_
;

118 
A—dTe¡VeùÜ
 
	gbad_d©a_veùÜ_
;

122 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡A—dScheme
) {

123 
EXPECT_EQ
(
‹¡_key_
->
G‘A—dScheme
(), 
G‘P¬am
().
ex³ùed_scheme
);

127 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡NÚûSize
) {

128 
EXPECT_EQ
(
‹¡_key_
->
NÚûSize
(), 
G‘P¬am
().
ex³ùed_nÚû_size
);

132 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡VeùÜ
) {

133 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_ch”‹xt
(
‹¡_veùÜ_
.
¶aš‹xt
.
size
() +

134 
‹¡_key_
->
MaxS—lOv”h—d
());

135 
size_t
 
	gaùu®_ch”‹xt_size
;

136 
ASYLO_ASSERT_OK
(
‹¡_key_
->
S—l
(

137 
‹¡_veùÜ_
.
¶aš‹xt
,e¡_veùÜ_.
¯d
,e¡_veùÜ_.
nÚû
,

138 
ab¦
::
MakeS·n
(
aùu®_ch”‹xt
), &
aùu®_ch”‹xt_size
));

139 
EXPECT_EQ
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
(),

140 
aùu®_ch”‹xt_size
);

141 
	gaùu®_ch”‹xt
.
»size
(
aùu®_ch”‹xt_size
);

142 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
),

143 
By‹CÚš”V›w
(
aùu®_ch”‹xt
));

145 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
aùu®_¶aš‹xt
(

146 
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
());

147 
size_t
 
	gaùu®_¶aš‹xt_size
;

148 
ASYLO_ASSERT_OK
(
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,

149 
‹¡_veùÜ_
.
¯d
,e¡_veùÜ_.
nÚû
,

150 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

151 &
aùu®_¶aš‹xt_size
));

152 
	gaùu®_¶aš‹xt
.
»size
(
aùu®_¶aš‹xt_size
);

153 
EXPECT_EQ
(
By‹CÚš”V›w
(
‹¡_veùÜ_
.
¶aš‹xt
),

154 
By‹CÚš”V›w
(
aùu®_¶aš‹xt
));

158 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡Inv®idIÅutS—l
) {

159 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_ch”‹xt
(
‹¡_veùÜ_
.
¶aš‹xt
.
size
() +

160 
‹¡_key_
->
MaxS—lOv”h—d
());

161 
size_t
 
	gaùu®_ch”‹xt_size
;

164 autØ
	gbad_nÚû
 = 
ab¦
::
HexSŒšgToBy‹s
(
kAesGcmBadNÚûSŒšg
);

165 
EXPECT_THAT
(
‹¡_key_
->
S—l
(
‹¡_veùÜ_
.
¶aš‹xt
, "",

166 
bad_nÚû
, 
ab¦
::
MakeS·n
(
aùu®_ch”‹xt
),

167 &
aùu®_ch”‹xt_size
),

168 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

172 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡Inv®idIÅutO³n
) {

173 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_¶aš‹xt
(

174 
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
());

175 
size_t
 
	gaùu®_¶aš‹xt_size
;

178 autØ
	gbad_nÚû
 = 
ab¦
::
HexSŒšgToBy‹s
(
kAesGcmBadNÚûSŒšg
);

179 
EXPECT_THAT
(

180 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

181 
bad_nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

182 &
aùu®_¶aš‹xt_size
),

183 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

189 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡WrÚgInfÜm©iÚ
) {

190 
	g¡d
::
veùÜ
<
ušt8_t
> 
aùu®_¶aš‹xt
(

191 
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
.
size
());

192 
size_t
 
	gaùu®_¶aš‹xt_size
;

195 
EXPECT_THAT
(

196 
bad_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

197 
‹¡_veùÜ_
.
nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

198 &
aùu®_¶aš‹xt_size
),

199 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

202 
EXPECT_THAT
(

203 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

204 
bad_d©a_veùÜ_
.
nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

205 &
aùu®_¶aš‹xt_size
),

206 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

209 
EXPECT_THAT
(

210 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
auth’tiÿ‹d_ch”‹xt
,

211 
bad_d©a_veùÜ_
.
¯d
, 
‹¡_veùÜ_
.
nÚû
,

212 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
), &
aùu®_¶aš‹xt_size
),

213 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

216 autØ
	guÇuth’tiÿ‹d_ch”‹xt_¡r
 =

217 
ab¦
::
HexSŒšgToBy‹s
(
kAesGcmCh”‹xtHex128
);

218 
	g¡d
::
veùÜ
<
ušt8_t
> 
uÇuth’tiÿ‹d_ch”‹xt
(

219 
uÇuth’tiÿ‹d_ch”‹xt_¡r
.
cbegš
(),

220 
uÇuth’tiÿ‹d_ch”‹xt_¡r
.
ûnd
());

221 
EXPECT_THAT
(

222 
‹¡_key_
->
O³n
(
‹¡_veùÜ_
.
uÇuth’tiÿ‹d_ch”‹xt
,e¡_veùÜ_.
¯d
,

223 
‹¡_veùÜ_
.
nÚû
, 
ab¦
::
MakeS·n
(
aùu®_¶aš‹xt
),

224 &
aùu®_¶aš‹xt_size
),

225 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

229 
TEST_P
(
A—dKeyTe¡
, 
A—dKeyTe¡Inv®idKey
) {

230 autØ
	gbad_key_»suÉ
 =

231 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
kAesGcmBadKeySŒšg
)>(

232 
kAesGcmBadKeySŒšg
);

233 
ASYLO_ASSERT_OK
(
bad_key_»suÉ
);

234 autØ
	gbad_key
 = 
bad_key_»suÉ
.
V®ueOrD›
();

236 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dKey
>> 
bad_‹¡_key_»suÉ
 =

237 
G‘P¬am
().
çùÜy
(
bad_key
);

238 
EXPECT_THAT
(
bad_‹¡_key_»suÉ
.
¡©us
(),

239 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

242 
INSTANTIATE_TEST_SUITE_P
(

243 
AÎTe¡s
, 
A—dKeyTe¡
,

244 ::
‹¡šg
::
V®ues
(

246 
A—dKeyP¬am
({
A—dKey
::
C»©eAesGcmKey
,

248 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

249 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

250 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
),

252 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

253  "", 
kAesGcmNÚûHex256
,

254 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
),

255 
A—dScheme
::
AES128_GCM
, 
kAesGcmNÚûSize
}),

257 
A—dKeyP¬am
({
A—dKey
::
C»©eAesGcmKey
,

259 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

260  "", 
kAesGcmNÚûHex256
,

261 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
),

263 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

264 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

265 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
),

266 
A—dScheme
::
AES256_GCM
, 
kAesGcmNÚûSize
}),

268 
A—dKeyP¬am
(

269 {
A—dKey
::
C»©eAesGcmSivKey
,

271 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex128
, 
kAesGcmSivKeyHex128
,

272  "", 
kAesGcmSivNÚûHex128
,

273 
kAesGcmSivCh”‹xtHex128
, 
kAesGcmSivTagHex128
),

275 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex128
, 
kAesGcmKeyHex128
,

276 
kAesGcmAadHex128
, 
kAesGcmNÚûHex128
,

277 
kAesGcmCh”‹xtHex128
, 
kAesGcmTagHex128
),

278 
A—dScheme
::
AES128_GCM_SIV
, 
kAesGcmNÚûSize
}),

280 
A—dKeyP¬am
(

281 {
A—dKey
::
C»©eAesGcmSivKey
,

283 
A—dTe¡VeùÜ
(
kAesGcmSivPÏš‹xtHex256
, 
kAesGcmSivKeyHex256
,

284 
kAesGcmSivAadHex256
, 
kAesGcmSivNÚûHex256
,

285 
kAesGcmSivCh”‹xtHex256
, 
kAesGcmSivTagHex256
),

287 
A—dTe¡VeùÜ
(
kAesGcmPÏš‹xtHex256
, 
kAesGcmKeyHex256
,

288  "", 
kAesGcmNÚûHex256
,

289 
kAesGcmCh”‹xtHex256
, 
kAesGcmTagHex256
),

290 
A—dScheme
::
AES256_GCM_SIV
, 
kAesGcmNÚûSize
})));

	@crypto/aead_test_vector.cc

19 
	~"asylo/üy±o/«ad_‹¡_veùÜ.h
"

21 
	~"ab¦/¡ršgs/esÿpšg.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

24 
	~"asylo/ut/ş—nsšg_ty³s.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

31 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
C»©eCËªsšgVeùÜFromHexSŒšg
(

32 
ab¦
::
¡ršg_v›w
 
hex_¡ršg
) {

33 
¡d
::
¡ršg
 
¡r
 = 
ab¦
::
HexSŒšgToBy‹s
(
hex_¡ršg
);

34  
	gCËªsšgVeùÜ
<
	gušt8_t
>(
	g¡r
.
cbegš
(), sŒ.
ûnd
());

39 
	gA—dTe¡VeùÜ
::
A—dTe¡VeùÜ
(
ab¦
::
¡ršg_v›w
 
¶aš‹xt_hex
,

40 
ab¦
::
¡ršg_v›w
 
key_hex
,

41 
ab¦
::
¡ršg_v›w
 
¯d_hex
,

42 
ab¦
::
¡ršg_v›w
 
nÚû_hex
,

43 
ab¦
::
¡ršg_v›w
 
ch”‹xt_hex
,

44 
ab¦
::
¡ršg_v›w
 
g_hex
)

45 : 
¯d
(
ab¦
::
HexSŒšgToBy‹s
(
¯d_hex
)),

46 
uÇuth’tiÿ‹d_ch”‹xt
(
ab¦
::
HexSŒšgToBy‹s
(
ch”‹xt_hex
)),

47 
auth’tiÿ‹d_ch”‹xt
(

48 
ab¦
::
HexSŒšgToBy‹s
×b¦::
SŒC©
(
ch”‹xt_hex
, 
g_hex
))),

49 
key
(
C»©eCËªsšgVeùÜFromHexSŒšg
(
key_hex
)),

50 
nÚû
(
ab¦
::
HexSŒšgToBy‹s
(
nÚû_hex
)),

51 
¶aš‹xt
(
C»©eCËªsšgVeùÜFromHexSŒšg
(
¶aš‹xt_hex
)) {}

	@crypto/aead_test_vector.cc

19 
	~"asylo/üy±o/«ad_‹¡_veùÜ.h
"

21 
	~"ab¦/¡ršgs/esÿpšg.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

24 
	~"asylo/ut/ş—nsšg_ty³s.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

31 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
C»©eCËªsšgVeùÜFromHexSŒšg
(

32 
ab¦
::
¡ršg_v›w
 
hex_¡ršg
) {

33 
¡d
::
¡ršg
 
¡r
 = 
ab¦
::
HexSŒšgToBy‹s
(
hex_¡ršg
);

34  
	gCËªsšgVeùÜ
<
	gušt8_t
>(
	g¡r
.
cbegš
(), sŒ.
ûnd
());

39 
	gA—dTe¡VeùÜ
::
A—dTe¡VeùÜ
(
ab¦
::
¡ršg_v›w
 
¶aš‹xt_hex
,

40 
ab¦
::
¡ršg_v›w
 
key_hex
,

41 
ab¦
::
¡ršg_v›w
 
¯d_hex
,

42 
ab¦
::
¡ršg_v›w
 
nÚû_hex
,

43 
ab¦
::
¡ršg_v›w
 
ch”‹xt_hex
,

44 
ab¦
::
¡ršg_v›w
 
g_hex
)

45 : 
¯d
(
ab¦
::
HexSŒšgToBy‹s
(
¯d_hex
)),

46 
uÇuth’tiÿ‹d_ch”‹xt
(
ab¦
::
HexSŒšgToBy‹s
(
ch”‹xt_hex
)),

47 
auth’tiÿ‹d_ch”‹xt
(

48 
ab¦
::
HexSŒšgToBy‹s
×b¦::
SŒC©
(
ch”‹xt_hex
, 
g_hex
))),

49 
key
(
C»©eCËªsšgVeùÜFromHexSŒšg
(
key_hex
)),

50 
nÚû
(
ab¦
::
HexSŒšgToBy‹s
(
nÚû_hex
)),

51 
¶aš‹xt
(
C»©eCËªsšgVeùÜFromHexSŒšg
(
¶aš‹xt_hex
)) {}

	@crypto/aead_test_vector.h

19 #iâdeà
ASYLO_CRYPTO_AEAD_TEST_VECTOR_H_


20 
	#ASYLO_CRYPTO_AEAD_TEST_VECTOR_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

25 
	~"asylo/ut/ş—nsšg_ty³s.h
"

27 
Çme¥aû
 
	gasylo
 {

32 
	sA—dTe¡VeùÜ
 {

33 
A—dTe¡VeùÜ
() = ;

38 
A—dTe¡VeùÜ
(
ab¦
::
¡ršg_v›w
 
¶aš‹xt_hex
,‡b¦::¡ršg_v›w 
key_hex
,

39 
ab¦
::
¡ršg_v›w
 
¯d_hex
,‡b¦::¡ršg_v›w 
nÚû_hex
,

40 
ab¦
::
¡ršg_v›w
 
ch”‹xt_hex
,‡b¦::¡ršg_v›w 
g_hex
);

42 
	g¡d
::
¡ršg
 
¯d
;

43 
	g¡d
::
¡ršg
 
uÇuth’tiÿ‹d_ch”‹xt
;

44 
	g¡d
::
¡ršg
 
auth’tiÿ‹d_ch”‹xt
;

45 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

46 
	g¡d
::
¡ršg
 
nÚû
;

47 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g¶aš‹xt
;

	@crypto/aes_gcm_siv.cc

19 
	~"asylo/üy±o/«s_gcm_siv.h
"

21 
	~<İ’s¦/¿nd.h
>

22 
	~<¡ršg
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"asylo/üy±o/ut/bs¦_ut.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

30 
Stus
 
	gAesGcmSivNÚûG’”©Ü
::
NextNÚû
(

31 cÚ¡ 
¡d
::
veùÜ
<
ušt8_t
> &
key_id
,

32 
AesGcmSivNÚûG’”©Ü
::
AesGcmSivNÚû
 *
nÚû
) {

33 ià(
RAND_by‹s
(
nÚû
->
d©a
(),‚Úû->
size
()) != 1) {

34  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

35 
ab¦
::
SŒC©
("RAND_by‹ çed", 
Bs¦La¡E¼ÜSŒšg
()));

37  
	gStus
::
OkStus
();

	@crypto/aes_gcm_siv.cc

19 
	~"asylo/üy±o/«s_gcm_siv.h
"

21 
	~<İ’s¦/¿nd.h
>

22 
	~<¡ršg
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"asylo/üy±o/ut/bs¦_ut.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

30 
Stus
 
	gAesGcmSivNÚûG’”©Ü
::
NextNÚû
(

31 cÚ¡ 
¡d
::
veùÜ
<
ušt8_t
> &
key_id
,

32 
AesGcmSivNÚûG’”©Ü
::
AesGcmSivNÚû
 *
nÚû
) {

33 ià(
RAND_by‹s
(
nÚû
->
d©a
(),‚Úû->
size
()) != 1) {

34  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

35 
ab¦
::
SŒC©
("RAND_by‹ çed", 
Bs¦La¡E¼ÜSŒšg
()));

37  
	gStus
::
OkStus
();

	@crypto/aes_gcm_siv.h

19 #iâdeà
ASYLO_CRYPTO_AES_GCM_SIV_H_


20 
	#ASYLO_CRYPTO_AES_GCM_SIV_H_


	)

22 
	~<İ’s¦/evp.h
>

23 
	~<İ’s¦/sha.h
>

24 
	~<memÜy
>

25 
	~<veùÜ
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/üy±o/nÚû_g’”©Ü.h
"

29 
	~"asylo/üy±o/ut/bs¦_ut.h
"

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
	~"asylo/ut/¡©us.h
"

34 
	~"asylo/ut/¡©us_maüos.h
"

35 
	~"asylo/ut/¡©usÜ.h
"

37 
Çme¥aû
 
	gasylo
 {

39 
cÚ¡ex´
 
size_t
 
	gkAesGcmSivNÚûSize
 = 12;

43 
şass
 
	gAesGcmSivNÚûG’”©Ü
 : 
public
 
NÚûG’”©Ü
<
kAesGcmSivNÚûSize
> {

44 
public
:

45 
usšg
 
AesGcmSivNÚû
 = 
Un§ãBy‹s
<
kAesGcmSivNÚûSize
>;

48 
Stus
 
NextNÚû
(cÚ¡ 
¡d
::
veùÜ
<
ušt8_t
> &
key_id
,

49 
AesGcmSivNÚû
 *
nÚû
è
	gov”ride
;

73 şas 
	cAesGcmSivCry±Ü
 {

74 
	gpublic
:

82 
AesGcmSivCry±Ü
(
size_t
 
mes§ge_size_lim™
,

83 
NÚûG’”©Ü
<
kAesGcmSivNÚûSize
> *
nÚû_g’”©Ü
)

84 : 
mes§ge_size_lim™_
{
mes§ge_size_lim™
},

85 
	gnÚû_g’”©Ü_
{
	gnÚû_g’”©Ü
} {}

86 ~
AesGcmSivCry±Ü
() = ;

104 
	g‹m¶©e
 <
ty³Çme
 
	gCÚš”T
,y³Çm
	gCÚš”U
,y³Çm
	gCÚš”V
,

105 
ty³Çme
 
	gCÚš”W
,y³Çm
	gCÚš”X
>

106 
Stus
 
S—l
(cÚ¡ 
CÚš”T
 &
key
, cÚ¡ 
CÚš”U
 &
add™iÚ®_d©a
,

107 cÚ¡ 
CÚš”V
 &
¶aš‹xt
, 
CÚš”W
 *
nÚû
,

108 
CÚš”X
 *
ch”‹xt
) {

109 
¡©ic_as£¹
(

110 (
ty³Çme
 
CÚš”T
::
v®ue_ty³
) == 1,

112 
¡©ic_as£¹
(

113 (
ty³Çme
 
CÚš”U
::
v®ue_ty³
) == 1,

115 
¡©ic_as£¹
(

116 (
ty³Çme
 
CÚš”V
::
v®ue_ty³
) == 1,

118 
¡©ic_as£¹
(

119 (
ty³Çme
 
CÚš”W
::
v®ue_ty³
) == 1,

121 
¡©ic_as£¹
(

122 (
ty³Çme
 
CÚš”X
::
v®ue_ty³
) == 1,

126 
EVP_AEAD
 cÚ¡ *
	g«ad
;

127 
ASYLO_ASSIGN_OR_RETURN
(
«ad
, 
EvpA—d
(
key
.
size
()));

129 ià(
	gadd™iÚ®_d©a
.
size
(è+ 
	g¶aš‹xt
.size(è> 
	gmes§ge_size_lim™_
) {

130  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

134 ià(
	gnÚû_g’”©Ü_
->
nÚû_size
(è!ğ
EVP_AEAD_nÚû_Ëngth
(
«ad
)) {

135  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

143 
	gUn§ãBy‹s
<
	gkAesGcmSivNÚûSize
> 
	gnÚû_cİy
;

144 
	g¡d
::
veùÜ
<
ušt8_t
> 
key_id
(
SHA256_DIGEST_LENGTH
);

145 ià(
	gnÚû_g’”©Ü_
->
u£s_key_id
()) {

146 
SHA256
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
key
.
d©a
()), key.
size
(),

147 
key_id
.
d©a
());

149 
ASYLO_RETURN_IF_ERROR
(
nÚû_g’”©Ü_
->
NextNÚû
(
key_id
, &
nÚû_cİy
));

150 
	gnÚû
->
»size
(
nÚû_cİy
.
size
());

155 ià(
	gnÚû
->
size
(è!ğ
nÚû_cİy
.size()) {

156  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

159 
	g¡d
::
cİy
(
nÚû_cİy
.
cbegš
(),‚Úû_cİy.
ûnd
(), 
nÚû
->
begš
());

161 
size_t
 
	gmax_ch”‹xt_Ëngth
 =

162 
¶aš‹xt
.
size
(è+ 
EVP_AEAD_max_ov”h—d
(
«ad
);

165 
	g¡d
::
veùÜ
<
ušt8_t
> 
tmp_ch”‹xt
(
max_ch”‹xt_Ëngth
);

168 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

169 ià(
EVP_AEAD_CTX_š™
(

170 &
cÚ‹xt
, 
«ad
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
key
.
d©a
()),

171 
key
.
size
(), 
EVP_AEAD_max_g_Ën
(
«ad
), 
nuÎ±r
) != 1) {

172  
Stus
(

173 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

174 
ab¦
::
SŒC©
("EVP_AEAD_CTX_š™ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

178 
size_t
 
	gch”‹xt_Ëngth
 = 0;

179 ià(
EVP_AEAD_CTX_£®
(

180 &
cÚ‹xt
, 
tmp_ch”‹xt
.
d©a
(), &
ch”‹xt_Ëngth
,

181 
tmp_ch”‹xt
.
size
(), 
nÚû_cİy
.
d©a
(),‚once_copy.size(),

182 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
¶aš‹xt
.
d©a
()),

183 
¶aš‹xt
.
size
(),

184 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
add™iÚ®_d©a
.
d©a
()),

185 
add™iÚ®_d©a
.
size
()) != 1) {

186 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

187  
Stus
(

188 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

189 
ab¦
::
SŒC©
("EVP_AEAD_CTX_£® faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

193 
	gtmp_ch”‹xt
.
»size
(
ch”‹xt_Ëngth
);

194 
	gch”‹xt
->
»size
(
ch”‹xt_Ëngth
);

199 ià(
	gch”‹xt
->
size
(è!ğ
ch”‹xt_Ëngth
) {

200 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

201  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

204 
	g¡d
::
cİy
(
tmp_ch”‹xt
.
cbegš
(),mp_ch”‹xt.
ûnd
(),

205 
ch”‹xt
->
begš
());

207 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

208  
	gStus
::
OkStus
();

225 
	g‹m¶©e
 <
ty³Çme
 
	gCÚš”T
,y³Çm
	gCÚš”U
,y³Çm
	gCÚš”V
,

226 
ty³Çme
 
	gCÚš”W
,y³Çm
	gCÚš”X
>

227 
Stus
 
O³n
(cÚ¡ 
CÚš”T
 &
key
, cÚ¡ 
CÚš”U
 &
add™iÚ®_d©a
,

228 cÚ¡ 
CÚš”V
 &
ch”‹xt
, cÚ¡ 
CÚš”W
 &
nÚû
,

229 
CÚš”X
 *
¶aš‹xt
) {

230 
¡©ic_as£¹
(

231 (
ty³Çme
 
CÚš”T
::
v®ue_ty³
) == 1,

233 
¡©ic_as£¹
(

234 (
ty³Çme
 
CÚš”U
::
v®ue_ty³
) == 1,

236 
¡©ic_as£¹
(

237 (
ty³Çme
 
CÚš”V
::
v®ue_ty³
) == 1,

239 
¡©ic_as£¹
(

240 (
ty³Çme
 
CÚš”W
::
v®ue_ty³
) == 1,

242 
¡©ic_as£¹
(

243 (
ty³Çme
 
CÚš”X
::
v®ue_ty³
) == 1,

245 
usšg
 
	gPÏš‹xtCÚš”T
 =

246 
ty³Çme
 
¡d
::
»move_»ã»nû
<
deşty³
(*
¶aš‹xt
)>::
ty³
;

247 
usšg
 
	gPÏš‹xtV®ueT
 = 
ty³Çme
 
PÏš‹xtCÚš”T
::
v®ue_ty³
;

248 
¡©ic_as£¹
(
¡d
::
is_§me
<
ty³Çme
 
PÏš‹xtCÚš”T
::
®loÿtÜ_ty³
,

249 
CËªsšgAÎoÿtÜ
<
PÏš‹xtV®ueT
>>::
v®ue
,

253 
EVP_AEAD
 cÚ¡ *
	g«ad
;

254 
ASYLO_ASSIGN_OR_RETURN
(
«ad
, 
EvpA—d
(
key
.
size
()));

256 ià(
	gnÚû
.
size
(è!ğ
EVP_AEAD_nÚû_Ëngth
(
«ad
)) {

257  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

264 
	g¡d
::
veùÜ
<
ušt8_t
> 
nÚû_cİy
;

265 
	gnÚû_cİy
.
»size
(
nÚû
.
size
());

266 
	g¡d
::
cİy
(
nÚû
.
cbegš
(),‚Úû.
ûnd
(), 
nÚû_cİy
.
begš
());

271 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gtmp_¶aš‹xt
;

272 
	gtmp_¶aš‹xt
.
»size
(
ch”‹xt
.
size
());

275 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

276 ià(
EVP_AEAD_CTX_š™
(

277 &
cÚ‹xt
, 
«ad
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
key
.
d©a
()),

278 
key
.
size
(), 
EVP_AEAD_max_g_Ën
(
«ad
), 
nuÎ±r
) != 1) {

279  
Stus
(

280 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

281 
ab¦
::
SŒC©
("EVP_AEAD_CTX_š™ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

285 
size_t
 
	g¶aš‹xt_Ëngth
 = 0;

286 ià(
EVP_AEAD_CTX_İ’
(

287 &
cÚ‹xt
, 
tmp_¶aš‹xt
.
d©a
(), &
¶aš‹xt_Ëngth
,

288 
tmp_¶aš‹xt
.
size
(),

289 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
nÚû
.
d©a
()),‚Úû.
size
(),

290 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
ch”‹xt
.
d©a
()),

291 
ch”‹xt
.
size
(),

292 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
add™iÚ®_d©a
.
d©a
()),

293 
add™iÚ®_d©a
.
size
()) != 1) {

294 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

295  
Stus
(

296 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

297 
ab¦
::
SŒC©
("EVP_AEAD_CTX_İ’ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

301 
	gtmp_¶aš‹xt
.
»size
(
¶aš‹xt_Ëngth
);

302 
	g¶aš‹xt
->
»size
(
¶aš‹xt_Ëngth
);

307 ià(
	g¶aš‹xt
->
size
(è!ğ
¶aš‹xt_Ëngth
) {

308 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

309  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

312 
	g¡d
::
cİy
(
tmp_¶aš‹xt
.
cbegš
(),mp_¶aš‹xt.
ûnd
(), 
¶aš‹xt
->
begš
());

314 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

315  
	gStus
::
OkStus
();

318 
	g´iv©e
:

319 
StusOr
<
EVP_AEAD
 cÚ¡ *> 
EvpA—d
(
size_t
 
key_size
) {

321 
EVP_AEAD
 cÚ¡ *cÚ¡ 
«ad_128
 = 
EVP_«ad_«s_128_gcm_siv
();

322 
EVP_AEAD
 cÚ¡ *cÚ¡ 
	g«ad_256
 = 
EVP_«ad_«s_256_gcm_siv
();

324 ià(
	gkey_size
 =ğ
EVP_AEAD_key_Ëngth
(
«ad_128
)) {

325  
«ad_128
;

326 } ià(
	gkey_size
 =ğ
EVP_AEAD_key_Ëngth
(
«ad_256
)) {

327  
«ad_256
;

329  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

330 
ab¦
::
SŒC©
("Key siz", 
key_size
, " is invalid"));

334 cÚ¡ 
size_t
 
	gmes§ge_size_lim™_
;

335 
	g¡d
::
unique_±r
<
NÚûG’”©Ü
<
kAesGcmSivNÚûSize
>> 
nÚû_g’”©Ü_
;

	@crypto/aes_gcm_siv_test.cc

19 
	~"asylo/üy±o/«s_gcm_siv.h
"

21 
	~<¡ršg
>

22 
	~<ut™y
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/esÿpšg.h
"

28 
	~"asylo/üy±o/nÚû_g’”©Ü.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/ut/¡©us.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

40 cÚ¡ 
	g¶aš‹xt1_hex
[] =

43 cÚ¡ 
	g¯d1_hex
[] = "";

44 cÚ¡ 
	gkey1_hex
[] = "01000000000000000000000000000000";

45 cÚ¡ 
	gnÚû1_hex
[] = "030000000000000000000000";

46 cÚ¡ 
	gch”‹xt1_hex
[] =

52 cÚ¡ 
	g¶aš‹xt2_hex
[] = "010000000000000000000000";

53 cÚ¡ 
	g¯d2_hex
[] = "";

54 cÚ¡ 
	gkey2_hex
[] =

57 cÚ¡ 
	gnÚû2_hex
[] = "030000000000000000000000";

58 cÚ¡ 
	gch”‹xt2_hex
[] =

61 
cÚ¡ex´
 
size_t
 
	gkMes§geSizeLim™
 = 1 << 16;

63 
şass
 
	gFixedNÚûG’”©Ü
 : 
public
 
NÚûG’”©Ü
<
kAesGcmSivNÚûSize
> {

64 
public
:

65 
usšg
 
AesGcmSivNÚû
 = 
Un§ãBy‹s
<
kAesGcmSivNÚûSize
>;

66 
ex¶ic™
 
FixedNÚûG’”©Ü
(
By‹CÚš”V›w
 
nÚû
è: 
nÚû_
{nonce} {}

69 
Stus
 
NextNÚû
(cÚ¡ 
¡d
::
veùÜ
<
ušt8_t
> &
key_id
,

70 
AesGcmSivNÚû
 *
nÚû
è
	gov”ride
 {

71 *
	gnÚû
 = 
nÚû_
;

72  
	gStus
::
OkStus
();

75 
	g´iv©e
:

76 
AesGcmSivNÚû
 
nÚû_
;

81 
TEST
(
AesGcmSivTe¡
, 
AesGcmSivTe¡VeùÜs
) {

82 autØ
	g¶aš‹xt1_»suÉ
 =

83 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
¶aš‹xt1_hex
)>(plaintext1_hex);

84 
ASYLO_ASSERT_OK
(
¶aš‹xt1_»suÉ
);

85 autØ
	g¶aš‹xt1
 = 
¶aš‹xt1_»suÉ
.
V®ueOrD›
();

86 autØ
	g¯d1
 = 
ab¦
::
HexSŒšgToBy‹s
(
¯d1_hex
);

87 autØ
	gkey1_»suÉ
 =

88 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
key1_hex
)>(key1_hex);

89 
ASYLO_ASSERT_OK
(
key1_»suÉ
);

90 autØ
	gkey1
 = 
key1_»suÉ
.
V®ueOrD›
();

91 autØ
	gnÚû1
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû1_hex
);

92 autØ
	gch”‹xt1
 = 
ab¦
::
HexSŒšgToBy‹s
(
ch”‹xt1_hex
);

94 
AesGcmSivCry±Ü
 
üy±Ü1
(
kMes§geSizeLim™
, 
Ãw
 
FixedNÚûG’”©Ü
(
nÚû1
));

96 
deşty³
(
nÚû1
è
	gtmp_nÚû1
;

97 
deşty³
(
ch”‹xt1
è
	gtmp_ch”‹xt1
;

98 
EXPECT_TRUE
(

99 
üy±Ü1
.
S—l
(
key1
, 
¯d1
, 
¶aš‹xt1
, &
tmp_nÚû1
, &
tmp_ch”‹xt1
)

100 .
ok
());

101 
EXPECT_EQ
(
nÚû1
, 
tmp_nÚû1
);

102 
EXPECT_EQ
(
ch”‹xt1
, 
tmp_ch”‹xt1
);

104 
deşty³
(
¶aš‹xt1
è
	gtmp_¶aš‹xt1
;

105 
EXPECT_TRUE
(

106 
üy±Ü1
.
O³n
(
key1
, 
¯d1
, 
ch”‹xt1
, 
nÚû1
, &
tmp_¶aš‹xt1
).
ok
());

107 
EXPECT_EQ
(
¶aš‹xt1
, 
tmp_¶aš‹xt1
);

109 autØ
	g¶aš‹xt2_»suÉ
 =

110 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
¶aš‹xt2_hex
)>(plaintext2_hex);

111 
ASYLO_ASSERT_OK
(
¶aš‹xt2_»suÉ
);

112 autØ
	g¶aš‹xt2
 = 
¶aš‹xt2_»suÉ
.
V®ueOrD›
();

113 autØ
	g¯d2
 = 
ab¦
::
HexSŒšgToBy‹s
(
¯d2_hex
);

114 autØ
	gkey2_»suÉ
 =

115 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
key2_hex
)>(key2_hex);

116 
ASYLO_ASSERT_OK
(
key2_»suÉ
);

117 autØ
	gkey2
 = 
key2_»suÉ
.
V®ueOrD›
();

118 autØ
	gnÚû2
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû2_hex
);

119 autØ
	gch”‹xt2
 = 
ab¦
::
HexSŒšgToBy‹s
(
ch”‹xt2_hex
);

121 
AesGcmSivCry±Ü
 
üy±Ü2
(
kMes§geSizeLim™
, 
Ãw
 
FixedNÚûG’”©Ü
(
nÚû2
));

123 
deşty³
(
nÚû2
è
	gtmp_nÚû2
;

124 
deşty³
(
ch”‹xt2
è
	gtmp_ch”‹xt2
;

125 
EXPECT_TRUE
(

126 
üy±Ü2
.
S—l
(
key2
, 
¯d2
, 
¶aš‹xt2
, &
tmp_nÚû2
, &
tmp_ch”‹xt2
)

127 .
ok
());

128 
EXPECT_EQ
(
nÚû2
, 
tmp_nÚû2
);

129 
EXPECT_EQ
(
ch”‹xt2
, 
tmp_ch”‹xt2
);

131 
deşty³
(
¶aš‹xt2
è
	gtmp_¶aš‹xt2
;

132 
EXPECT_TRUE
(

133 
üy±Ü2
.
O³n
(
key2
, 
¯d2
, 
ch”‹xt2
, 
nÚû2
, &
tmp_¶aš‹xt2
).
ok
());

134 
EXPECT_EQ
(
¶aš‹xt2
, 
tmp_¶aš‹xt2
);

137 
cÚ¡ex´
 
size_t
 
	gkPÏš‹xtSize
 = 23;

138 
cÚ¡ex´
 
size_t
 
	gkAdd™iÚ®D©aSize
 = 15;

141 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

142 şas 
	cTy³dAesGcmSivTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

143 
public
:

146 
usšg
 
	gUn§ãVeùÜ
 = 
¡d
::
veùÜ
<
ušt8_t
>;

147 
usšg
 
	gSaãVeùÜ
 = 
CËªsšgVeùÜ
<
ušt8_t
>;

148 
usšg
 
	gUn§ãSŒšg
 = 
¡d
::
¡ršg
;

149 
usšg
 
	gSaãSŒšg
 = 
CËªsšgSŒšg
;

150 ::
‹¡šg
::
	tTy³s
<

151 
	t¡d
::
	t·œ
<
	tUn§ãVeùÜ
, 
	tSaãVeùÜ
>, std::pair<SafeVector, SafeVector>,

152 
	t¡d
::
	t·œ
<
	tUn§ãSŒšg
, 
	tSaãSŒšg
>, std::pair<SafeString, SafeString>,

153 
	t¡d
::
	t·œ
<
	tUn§ãSŒšg
, 
	tSaãVeùÜ
>, std::·œ<
	tSaãSŒšg
, SafeVector>,

154 
	t¡d
::
	t·œ
<
	tUn§ãVeùÜ
, 
	tSaãSŒšg
>, std::·œ<
	tSaãVeùÜ
, SafeString>>

155 
	tMyTy³s
;

156 
TYPED_TEST_SUITE
(
Ty³dAesGcmSivTe¡
, 
MyTy³s
);

158 
TYPED_TEST
(
Ty³dAesGcmSivTe¡
, 
KeySize128
) {

159 
usšg
 
	gIÅutTy³
 = 
ty³Çme
 
Ty³P¬am
::
fœ¡_ty³
;

160 
usšg
 
	gOuutTy³
 = 
ty³Çme
 
Ty³P¬am
::
£cÚd_ty³
;

162 
AesGcmSivCry±Ü
 
üy±Ü
(
kMes§geSizeLim™
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

164 
IÅutTy³
 
	gkey
, 
	g¯d
, 
	g¶aš‹xt
;

165 
OuutTy³
 
	gnÚû
, 
	gch”‹xt
;

167 
	gkey
.
»size
(16);

168 
	g¯d
.
»size
(
kAdd™iÚ®D©aSize
);

169 
	g¶aš‹xt
.
»size
(
kPÏš‹xtSize
);

171 
ASSERT_THAT
(
üy±Ü
.
S—l
(
key
, 
¯d
, 
¶aš‹xt
, &
nÚû
, &
ch”‹xt
), 
IsOk
());

175 
ASSERT_EQ
(
ch”‹xt
.
size
(), 
¶aš‹xt
.size() + 16);

177 
OuutTy³
 
	gdeüy±ed
;

178 
ASSERT_THAT
(
üy±Ü
.
O³n
(
key
, 
¯d
, 
ch”‹xt
, 
nÚû
, &
deüy±ed
), 
IsOk
());

179 
EXPECT_TRUE
(

180 
¡d
::
equ®
(
¶aš‹xt
.
cbegš
(),…Ïš‹xt.
ûnd
(), 
deüy±ed
.cbegin()));

183 
TYPED_TEST
(
Ty³dAesGcmSivTe¡
, 
KeySize256
) {

184 
usšg
 
	gIÅutTy³
 = 
ty³Çme
 
Ty³P¬am
::
fœ¡_ty³
;

185 
usšg
 
	gOuutTy³
 = 
ty³Çme
 
Ty³P¬am
::
£cÚd_ty³
;

187 
AesGcmSivCry±Ü
 
üy±Ü
(
kMes§geSizeLim™
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

189 
IÅutTy³
 
	gkey
, 
	g¯d
, 
	g¶aš‹xt
;

190 
OuutTy³
 
	gnÚû
, 
	gch”‹xt
;

192 
	gkey
.
»size
(32);

193 
	g¯d
.
»size
(
kAdd™iÚ®D©aSize
);

194 
	g¶aš‹xt
.
»size
(
kPÏš‹xtSize
);

196 
	g¯d
.
»size
(
kAdd™iÚ®D©aSize
);

197 
	g¶aš‹xt
.
»size
(
kPÏš‹xtSize
);

199 
ASSERT_THAT
(
üy±Ü
.
S—l
(
key
, 
¯d
, 
¶aš‹xt
, &
nÚû
, &
ch”‹xt
), 
IsOk
());

203 
ASSERT_EQ
(
ch”‹xt
.
size
(), 
¶aš‹xt
.size() + 16);

205 
OuutTy³
 
	gdeüy±ed
;

206 
ASSERT_THAT
(
üy±Ü
.
O³n
(
key
, 
¯d
, 
ch”‹xt
, 
nÚû
, &
deüy±ed
), 
IsOk
());

207 
EXPECT_TRUE
(

208 
¡d
::
equ®
(
¶aš‹xt
.
cbegš
(),…Ïš‹xt.
ûnd
(), 
deüy±ed
.cbegin()));

	@crypto/aes_gcm_siv_test.cc

19 
	~"asylo/üy±o/«s_gcm_siv.h
"

21 
	~<¡ršg
>

22 
	~<ut™y
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/esÿpšg.h
"

28 
	~"asylo/üy±o/nÚû_g’”©Ü.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/ut/¡©us.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

40 cÚ¡ 
	g¶aš‹xt1_hex
[] =

43 cÚ¡ 
	g¯d1_hex
[] = "";

44 cÚ¡ 
	gkey1_hex
[] = "01000000000000000000000000000000";

45 cÚ¡ 
	gnÚû1_hex
[] = "030000000000000000000000";

46 cÚ¡ 
	gch”‹xt1_hex
[] =

52 cÚ¡ 
	g¶aš‹xt2_hex
[] = "010000000000000000000000";

53 cÚ¡ 
	g¯d2_hex
[] = "";

54 cÚ¡ 
	gkey2_hex
[] =

57 cÚ¡ 
	gnÚû2_hex
[] = "030000000000000000000000";

58 cÚ¡ 
	gch”‹xt2_hex
[] =

61 
cÚ¡ex´
 
size_t
 
	gkMes§geSizeLim™
 = 1 << 16;

63 
şass
 
	gFixedNÚûG’”©Ü
 : 
public
 
NÚûG’”©Ü
<
kAesGcmSivNÚûSize
> {

64 
public
:

65 
usšg
 
AesGcmSivNÚû
 = 
Un§ãBy‹s
<
kAesGcmSivNÚûSize
>;

66 
ex¶ic™
 
FixedNÚûG’”©Ü
(
By‹CÚš”V›w
 
nÚû
è: 
nÚû_
{nonce} {}

69 
Stus
 
NextNÚû
(cÚ¡ 
¡d
::
veùÜ
<
ušt8_t
> &
key_id
,

70 
AesGcmSivNÚû
 *
nÚû
è
	gov”ride
 {

71 *
	gnÚû
 = 
nÚû_
;

72  
	gStus
::
OkStus
();

75 
	g´iv©e
:

76 
AesGcmSivNÚû
 
nÚû_
;

81 
TEST
(
AesGcmSivTe¡
, 
AesGcmSivTe¡VeùÜs
) {

82 autØ
	g¶aš‹xt1_»suÉ
 =

83 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
¶aš‹xt1_hex
)>(plaintext1_hex);

84 
ASYLO_ASSERT_OK
(
¶aš‹xt1_»suÉ
);

85 autØ
	g¶aš‹xt1
 = 
¶aš‹xt1_»suÉ
.
V®ueOrD›
();

86 autØ
	g¯d1
 = 
ab¦
::
HexSŒšgToBy‹s
(
¯d1_hex
);

87 autØ
	gkey1_»suÉ
 =

88 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
key1_hex
)>(key1_hex);

89 
ASYLO_ASSERT_OK
(
key1_»suÉ
);

90 autØ
	gkey1
 = 
key1_»suÉ
.
V®ueOrD›
();

91 autØ
	gnÚû1
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû1_hex
);

92 autØ
	gch”‹xt1
 = 
ab¦
::
HexSŒšgToBy‹s
(
ch”‹xt1_hex
);

94 
AesGcmSivCry±Ü
 
üy±Ü1
(
kMes§geSizeLim™
, 
Ãw
 
FixedNÚûG’”©Ü
(
nÚû1
));

96 
deşty³
(
nÚû1
è
	gtmp_nÚû1
;

97 
deşty³
(
ch”‹xt1
è
	gtmp_ch”‹xt1
;

98 
EXPECT_TRUE
(

99 
üy±Ü1
.
S—l
(
key1
, 
¯d1
, 
¶aš‹xt1
, &
tmp_nÚû1
, &
tmp_ch”‹xt1
)

100 .
ok
());

101 
EXPECT_EQ
(
nÚû1
, 
tmp_nÚû1
);

102 
EXPECT_EQ
(
ch”‹xt1
, 
tmp_ch”‹xt1
);

104 
deşty³
(
¶aš‹xt1
è
	gtmp_¶aš‹xt1
;

105 
EXPECT_TRUE
(

106 
üy±Ü1
.
O³n
(
key1
, 
¯d1
, 
ch”‹xt1
, 
nÚû1
, &
tmp_¶aš‹xt1
).
ok
());

107 
EXPECT_EQ
(
¶aš‹xt1
, 
tmp_¶aš‹xt1
);

109 autØ
	g¶aš‹xt2_»suÉ
 =

110 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
¶aš‹xt2_hex
)>(plaintext2_hex);

111 
ASYLO_ASSERT_OK
(
¶aš‹xt2_»suÉ
);

112 autØ
	g¶aš‹xt2
 = 
¶aš‹xt2_»suÉ
.
V®ueOrD›
();

113 autØ
	g¯d2
 = 
ab¦
::
HexSŒšgToBy‹s
(
¯d2_hex
);

114 autØ
	gkey2_»suÉ
 =

115 
In¡ªtŸ‹SaãBy‹sFromHexSŒšg
<(
key2_hex
)>(key2_hex);

116 
ASYLO_ASSERT_OK
(
key2_»suÉ
);

117 autØ
	gkey2
 = 
key2_»suÉ
.
V®ueOrD›
();

118 autØ
	gnÚû2
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû2_hex
);

119 autØ
	gch”‹xt2
 = 
ab¦
::
HexSŒšgToBy‹s
(
ch”‹xt2_hex
);

121 
AesGcmSivCry±Ü
 
üy±Ü2
(
kMes§geSizeLim™
, 
Ãw
 
FixedNÚûG’”©Ü
(
nÚû2
));

123 
deşty³
(
nÚû2
è
	gtmp_nÚû2
;

124 
deşty³
(
ch”‹xt2
è
	gtmp_ch”‹xt2
;

125 
EXPECT_TRUE
(

126 
üy±Ü2
.
S—l
(
key2
, 
¯d2
, 
¶aš‹xt2
, &
tmp_nÚû2
, &
tmp_ch”‹xt2
)

127 .
ok
());

128 
EXPECT_EQ
(
nÚû2
, 
tmp_nÚû2
);

129 
EXPECT_EQ
(
ch”‹xt2
, 
tmp_ch”‹xt2
);

131 
deşty³
(
¶aš‹xt2
è
	gtmp_¶aš‹xt2
;

132 
EXPECT_TRUE
(

133 
üy±Ü2
.
O³n
(
key2
, 
¯d2
, 
ch”‹xt2
, 
nÚû2
, &
tmp_¶aš‹xt2
).
ok
());

134 
EXPECT_EQ
(
¶aš‹xt2
, 
tmp_¶aš‹xt2
);

137 
cÚ¡ex´
 
size_t
 
	gkPÏš‹xtSize
 = 23;

138 
cÚ¡ex´
 
size_t
 
	gkAdd™iÚ®D©aSize
 = 15;

141 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

142 şas 
	cTy³dAesGcmSivTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

143 
public
:

146 
usšg
 
	gUn§ãVeùÜ
 = 
¡d
::
veùÜ
<
ušt8_t
>;

147 
usšg
 
	gSaãVeùÜ
 = 
CËªsšgVeùÜ
<
ušt8_t
>;

148 
usšg
 
	gUn§ãSŒšg
 = 
¡d
::
¡ršg
;

149 
usšg
 
	gSaãSŒšg
 = 
CËªsšgSŒšg
;

150 ::
‹¡šg
::
	tTy³s
<

151 
	t¡d
::
	t·œ
<
	tUn§ãVeùÜ
, 
	tSaãVeùÜ
>, std::pair<SafeVector, SafeVector>,

152 
	t¡d
::
	t·œ
<
	tUn§ãSŒšg
, 
	tSaãSŒšg
>, std::pair<SafeString, SafeString>,

153 
	t¡d
::
	t·œ
<
	tUn§ãSŒšg
, 
	tSaãVeùÜ
>, std::·œ<
	tSaãSŒšg
, SafeVector>,

154 
	t¡d
::
	t·œ
<
	tUn§ãVeùÜ
, 
	tSaãSŒšg
>, std::·œ<
	tSaãVeùÜ
, SafeString>>

155 
	tMyTy³s
;

156 
TYPED_TEST_SUITE
(
Ty³dAesGcmSivTe¡
, 
MyTy³s
);

158 
TYPED_TEST
(
Ty³dAesGcmSivTe¡
, 
KeySize128
) {

159 
usšg
 
	gIÅutTy³
 = 
ty³Çme
 
Ty³P¬am
::
fœ¡_ty³
;

160 
usšg
 
	gOuutTy³
 = 
ty³Çme
 
Ty³P¬am
::
£cÚd_ty³
;

162 
AesGcmSivCry±Ü
 
üy±Ü
(
kMes§geSizeLim™
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

164 
IÅutTy³
 
	gkey
, 
	g¯d
, 
	g¶aš‹xt
;

165 
OuutTy³
 
	gnÚû
, 
	gch”‹xt
;

167 
	gkey
.
»size
(16);

168 
	g¯d
.
»size
(
kAdd™iÚ®D©aSize
);

169 
	g¶aš‹xt
.
»size
(
kPÏš‹xtSize
);

171 
ASSERT_THAT
(
üy±Ü
.
S—l
(
key
, 
¯d
, 
¶aš‹xt
, &
nÚû
, &
ch”‹xt
), 
IsOk
());

175 
ASSERT_EQ
(
ch”‹xt
.
size
(), 
¶aš‹xt
.size() + 16);

177 
OuutTy³
 
	gdeüy±ed
;

178 
ASSERT_THAT
(
üy±Ü
.
O³n
(
key
, 
¯d
, 
ch”‹xt
, 
nÚû
, &
deüy±ed
), 
IsOk
());

179 
EXPECT_TRUE
(

180 
¡d
::
equ®
(
¶aš‹xt
.
cbegš
(),…Ïš‹xt.
ûnd
(), 
deüy±ed
.cbegin()));

183 
TYPED_TEST
(
Ty³dAesGcmSivTe¡
, 
KeySize256
) {

184 
usšg
 
	gIÅutTy³
 = 
ty³Çme
 
Ty³P¬am
::
fœ¡_ty³
;

185 
usšg
 
	gOuutTy³
 = 
ty³Çme
 
Ty³P¬am
::
£cÚd_ty³
;

187 
AesGcmSivCry±Ü
 
üy±Ü
(
kMes§geSizeLim™
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

189 
IÅutTy³
 
	gkey
, 
	g¯d
, 
	g¶aš‹xt
;

190 
OuutTy³
 
	gnÚû
, 
	gch”‹xt
;

192 
	gkey
.
»size
(32);

193 
	g¯d
.
»size
(
kAdd™iÚ®D©aSize
);

194 
	g¶aš‹xt
.
»size
(
kPÏš‹xtSize
);

196 
	g¯d
.
»size
(
kAdd™iÚ®D©aSize
);

197 
	g¶aš‹xt
.
»size
(
kPÏš‹xtSize
);

199 
ASSERT_THAT
(
üy±Ü
.
S—l
(
key
, 
¯d
, 
¶aš‹xt
, &
nÚû
, &
ch”‹xt
), 
IsOk
());

203 
ASSERT_EQ
(
ch”‹xt
.
size
(), 
¶aš‹xt
.size() + 16);

205 
OuutTy³
 
	gdeüy±ed
;

206 
ASSERT_THAT
(
üy±Ü
.
O³n
(
key
, 
¯d
, 
ch”‹xt
, 
nÚû
, &
deüy±ed
), 
IsOk
());

207 
EXPECT_TRUE
(

208 
¡d
::
equ®
(
¶aš‹xt
.
cbegš
(),…Ïš‹xt.
ûnd
(), 
deüy±ed
.cbegin()));

	@crypto/asymmetric_encryption_key.h

19 #iâdeà
ASYLO_CRYPTO_ASYMMETRIC_ENCRYPTION_KEY_H_


20 
	#ASYLO_CRYPTO_ASYMMETRIC_ENCRYPTION_KEY_H_


	)

22 
	~<c¡dšt
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

28 
	~"asylo/ut/ş—nsšg_ty³s.h
"

29 
	~"asylo/ut/¡©us.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
Çme¥aû
 
	gasylo
 {

35 şas 
	cAsymm‘ricEnüy±iÚKey
 {

36 
	gpublic
:

37 
vœtu®
 ~
Asymm‘ricEnüy±iÚKey
() = ;

40 
vœtu®
 
Asymm‘ricEnüy±iÚScheme
 
G‘Enüy±iÚScheme
() const = 0;

44 
vœtu®
 
	gStusOr
<
	g¡d
::
¡ršg
> 
S”ŸlizeToD”
() const = 0;

48 
vœtu®
 
Stus
 
Enüy±
(
By‹CÚš”V›w
 
¶aš‹xt
,

49 
¡d
::
veùÜ
<
ušt8_t
> *
ch”‹xt
) const = 0;

53 şas 
	cAsymm‘ricDeüy±iÚKey
 {

54 
	gpublic
:

55 
vœtu®
 ~
Asymm‘ricDeüy±iÚKey
() = ;

58 
vœtu®
 
Asymm‘ricEnüy±iÚScheme
 
G‘Enüy±iÚScheme
() const = 0;

62 
vœtu®
 
Stus
 
S”ŸlizeToD”
(

63 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
) const = 0;

66 
vœtu®
 
	gStusOr
<
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
>> 
G‘Enüy±iÚKey
()

71 
vœtu®
 
Stus
 
Deüy±
(
By‹CÚš”V›w
 
ch”‹xt
,

72 
CËªsšgVeùÜ
<
ušt8_t
> *
¶aš‹xt
) const = 0;

	@crypto/certificate_util.cc

19 
	~"asylo/üy±o/û¹ifiÿ‹_ut.h
"

21 
	~"asylo/ut/¡©us_maüos.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
Stus
 
V®id©eC”tifiÿ‹SignšgReque¡
(cÚ¡ 
C”tifiÿ‹SignšgReque¡
 &
c¤
) {

26 ià(!
	gc¤
.
has_fÜm©
()) {

27  
Stus
(

28 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

31 ià(!
	gc¤
.
has_d©a
()) {

32  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

35 ià(
	gc¤
.
fÜm©
(è=ğ
asylo
::
C”tifiÿ‹SignšgReque¡
::
UNKNOWN
) {

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

40  
	gStus
::
OkStus
();

43 
Stus
 
V®id©eC”tifiÿ‹
(cÚ¡ 
C”tifiÿ‹
 &
û¹ifiÿ‹
) {

44 ià(!
	gû¹ifiÿ‹
.
has_fÜm©
()) {

45  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

48 ià(!
	gû¹ifiÿ‹
.
has_d©a
()) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

52 ià(
	gû¹ifiÿ‹
.
fÜm©
(è=ğ
asylo
::
C”tifiÿ‹
::
UNKNOWN
) {

53  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57  
	gStus
::
OkStus
();

60 
Stus
 
V®id©eC”tifiÿ‹Chaš
(cÚ¡ 
C”tifiÿ‹Chaš
 &
û¹ifiÿ‹_chaš
) {

61 cÚ¡‡utØ&
	gû¹ifiÿ‹
 : 
û¹ifiÿ‹_chaš
.
û¹ifiÿ‹s
()) {

62 
ASYLO_RETURN_IF_ERROR
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
));

65  
	gStus
::
OkStus
();

68 
Stus
 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(cÚ¡ 
C”tifiÿ‹RevoÿtiÚLi¡
 &
ül
) {

69 ià(!
	gül
.
has_fÜm©
()) {

70  
Stus
(

71 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

74 ià(!
	gül
.
has_d©a
()) {

75  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

78 ià(
	gül
.
fÜm©
(è=ğ
asylo
::
C”tifiÿ‹RevoÿtiÚLi¡
::
UNKNOWN
) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

83  
	gStus
::
OkStus
();

	@crypto/certificate_util.cc

19 
	~"asylo/üy±o/û¹ifiÿ‹_ut.h
"

21 
	~"asylo/ut/¡©us_maüos.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
Stus
 
V®id©eC”tifiÿ‹SignšgReque¡
(cÚ¡ 
C”tifiÿ‹SignšgReque¡
 &
c¤
) {

26 ià(!
	gc¤
.
has_fÜm©
()) {

27  
Stus
(

28 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

31 ià(!
	gc¤
.
has_d©a
()) {

32  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

35 ià(
	gc¤
.
fÜm©
(è=ğ
asylo
::
C”tifiÿ‹SignšgReque¡
::
UNKNOWN
) {

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

40  
	gStus
::
OkStus
();

43 
Stus
 
V®id©eC”tifiÿ‹
(cÚ¡ 
C”tifiÿ‹
 &
û¹ifiÿ‹
) {

44 ià(!
	gû¹ifiÿ‹
.
has_fÜm©
()) {

45  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

48 ià(!
	gû¹ifiÿ‹
.
has_d©a
()) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

52 ià(
	gû¹ifiÿ‹
.
fÜm©
(è=ğ
asylo
::
C”tifiÿ‹
::
UNKNOWN
) {

53  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57  
	gStus
::
OkStus
();

60 
Stus
 
V®id©eC”tifiÿ‹Chaš
(cÚ¡ 
C”tifiÿ‹Chaš
 &
û¹ifiÿ‹_chaš
) {

61 cÚ¡‡utØ&
	gû¹ifiÿ‹
 : 
û¹ifiÿ‹_chaš
.
û¹ifiÿ‹s
()) {

62 
ASYLO_RETURN_IF_ERROR
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
));

65  
	gStus
::
OkStus
();

68 
Stus
 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(cÚ¡ 
C”tifiÿ‹RevoÿtiÚLi¡
 &
ül
) {

69 ià(!
	gül
.
has_fÜm©
()) {

70  
Stus
(

71 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

74 ià(!
	gül
.
has_d©a
()) {

75  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

78 ià(
	gül
.
fÜm©
(è=ğ
asylo
::
C”tifiÿ‹RevoÿtiÚLi¡
::
UNKNOWN
) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

83  
	gStus
::
OkStus
();

	@crypto/certificate_util.h

19 #iâdeà
ASYLO_CRYPTO_CERTIFICATE_UTIL_H_


20 
	#ASYLO_CRYPTO_CERTIFICATE_UTIL_H_


	)

22 
	~"asylo/üy±o/û¹ifiÿ‹.pb.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

32 
Stus
 
V®id©eC”tifiÿ‹SignšgReque¡
(cÚ¡ 
C”tifiÿ‹SignšgReque¡
 &
c¤
);

40 
Stus
 
V®id©eC”tifiÿ‹
(cÚ¡ 
C”tifiÿ‹
 &
û¹ifiÿ‹
);

48 
Stus
 
V®id©eC”tifiÿ‹Chaš
(cÚ¡ 
C”tifiÿ‹Chaš
 &
û¹ifiÿ‹_chaš
);

55 
Stus
 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(cÚ¡ 
C”tifiÿ‹RevoÿtiÚLi¡
 &
ül
);

	@crypto/certificate_util_test.cc

19 
	~"asylo/üy±o/û¹ifiÿ‹_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/üy±o/û¹ifiÿ‹.pb.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
	~"asylo/ut/¡©us.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

32 
C”tifiÿ‹SignšgReque¡
 
C»©eV®idC”tifiÿ‹SignšgReque¡
() {

33 
C”tifiÿ‹SignšgReque¡
 
	gc¤
;

34 
	gc¤
.
£t_fÜm©
(
C”tifiÿ‹SignšgReque¡
::
PKCS10_PEM
);

35 
	gc¤
.
£t_d©a
("foobar");

36  
	gc¤
;

40 
C”tifiÿ‹
 
C»©eV®idC”tifiÿ‹
() {

41 
C”tifiÿ‹
 
	gû¹ifiÿ‹
;

42 
	gû¹ifiÿ‹
.
£t_fÜm©
(
C”tifiÿ‹
::
X509_PEM
);

43 
	gû¹ifiÿ‹
.
£t_d©a
("foobar");

44  
	gû¹ifiÿ‹
;

49 
C”tifiÿ‹Chaš
 
C»©eV®idC”tifiÿ‹Chaš
(
Ëngth
) {

50 
C”tifiÿ‹Chaš
 
	gû¹ifiÿ‹_chaš
;

51 
	gi
 = 0; i < 
	gËngth
; ++i) {

52 *
	gû¹ifiÿ‹_chaš
.
add_û¹ifiÿ‹s
(èğ
C»©eV®idC”tifiÿ‹
();

54  
	gû¹ifiÿ‹_chaš
;

59 
C”tifiÿ‹RevoÿtiÚLi¡
 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
() {

60 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
;

61 
	gül
.
£t_fÜm©
(
C”tifiÿ‹RevoÿtiÚLi¡
::
X509_PEM
);

62 
	gül
.
£t_d©a
("foobar");

63  
	gül
;

66 
TEST
(
C”tifiÿ‹UtTe¡
,

67 
V®id©eC”tifiÿ‹SignšgReque¡R‘uºsE¼ÜIfNoFÜm©
) {

68 
C”tifiÿ‹SignšgReque¡
 
	gc¤
 = 
C»©eV®idC”tifiÿ‹SignšgReque¡
();

69 
	gc¤
.
ş—r_fÜm©
();

70 
EXPECT_THAT
(
V®id©eC”tifiÿ‹SignšgReque¡
(
c¤
),

71 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

74 
TEST
(
C”tifiÿ‹UtTe¡
,

75 
V®id©eC”tifiÿ‹SignšgReque¡R‘uºsE¼ÜIfUnknownFÜm©
) {

76 
C”tifiÿ‹SignšgReque¡
 
	gc¤
 = 
C»©eV®idC”tifiÿ‹SignšgReque¡
();

77 
	gc¤
.
£t_fÜm©
(
C”tifiÿ‹SignšgReque¡
::
UNKNOWN
);

78 
EXPECT_THAT
(
V®id©eC”tifiÿ‹SignšgReque¡
(
c¤
),

79 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

82 
TEST
(
C”tifiÿ‹UtTe¡
,

83 
V®id©eC”tifiÿ‹SignšgReque¡R‘uºsE¼ÜIfNoD©a
) {

84 
C”tifiÿ‹SignšgReque¡
 
	gc¤
 = 
C»©eV®idC”tifiÿ‹SignšgReque¡
();

85 
	gc¤
.
ş—r_d©a
();

86 
EXPECT_THAT
(
V®id©eC”tifiÿ‹SignšgReque¡
(
c¤
),

87 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

90 
TEST
(
C”tifiÿ‹UtTe¡
,

91 
V®id©eC”tifiÿ‹SignšgReque¡SucûedsIfC¤IsV®id
) {

92 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹SignšgReque¡
(

93 
C»©eV®idC”tifiÿ‹SignšgReque¡
()));

96 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹R‘uºsE¼ÜIfNoFÜm©
) {

97 
C”tifiÿ‹
 
	gû¹ifiÿ‹
 = 
C»©eV®idC”tifiÿ‹
();

98 
	gû¹ifiÿ‹
.
ş—r_fÜm©
();

99 
EXPECT_THAT
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
),

100 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

103 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹R‘uºsE¼ÜIfUnknownFÜm©
) {

104 
C”tifiÿ‹
 
	gû¹ifiÿ‹
 = 
C»©eV®idC”tifiÿ‹
();

105 
	gû¹ifiÿ‹
.
£t_fÜm©
(
C”tifiÿ‹
::
UNKNOWN
);

106 
EXPECT_THAT
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
),

107 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

110 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹R‘uºsE¼ÜIfNoD©a
) {

111 
C”tifiÿ‹
 
	gû¹ifiÿ‹
 = 
C»©eV®idC”tifiÿ‹
();

112 
	gû¹ifiÿ‹
.
ş—r_d©a
();

113 
EXPECT_THAT
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
),

114 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

117 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹SucûedsIfC”tifiÿ‹IsV®id
) {

118 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹
(
C»©eV®idC”tifiÿ‹
()));

121 
TEST
(
C”tifiÿ‹UtTe¡
,

122 
V®id©eC”tifiÿ‹ChašFasIfACÚšedC”tifiÿ‹IsInv®id
) {

123 
C”tifiÿ‹Chaš
 
	gû¹ifiÿ‹_chaš
 = 
C»©eV®idC”tifiÿ‹Chaš
(1);

124 
	gû¹ifiÿ‹_chaš
.
mubË_û¹ifiÿ‹s
(0)->
ş—r_fÜm©
();

125 
EXPECT_THAT
(
V®id©eC”tifiÿ‹Chaš
(
û¹ifiÿ‹_chaš
),

126 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

128 
	gû¹ifiÿ‹_chaš
 = 
C»©eV®idC”tifiÿ‹Chaš
(5);

129 
	gû¹ifiÿ‹_chaš
.
mubË_û¹ifiÿ‹s
(1)->
ş—r_fÜm©
();

130 
EXPECT_THAT
(
V®id©eC”tifiÿ‹Chaš
(
û¹ifiÿ‹_chaš
),

131 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

134 
TEST
(
C”tifiÿ‹UtTe¡
,

135 
V®id©eC”tifiÿ‹ChašSucûedsIfC”tifiÿ‹ChašIsV®id
) {

136 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹Chaš
(
C»©eV®idC”tifiÿ‹Chaš
(0)));

137 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹Chaš
(
C»©eV®idC”tifiÿ‹Chaš
(1)));

138 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹Chaš
(
C»©eV®idC”tifiÿ‹Chaš
(27)));

141 
TEST
(
C”tifiÿ‹UtTe¡
,

142 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡R‘uºsE¼ÜIfNoFÜm©
) {

143 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
 = 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
();

144 
	gül
.
ş—r_fÜm©
();

145 
EXPECT_THAT
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(
ül
),

146 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

149 
TEST
(
C”tifiÿ‹UtTe¡
,

150 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡R‘uºsE¼ÜIfUnknownFÜm©
) {

151 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
 = 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
();

152 
	gül
.
£t_fÜm©
(
C”tifiÿ‹RevoÿtiÚLi¡
::
UNKNOWN
);

153 
EXPECT_THAT
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(
ül
),

154 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

157 
TEST
(
C”tifiÿ‹UtTe¡
,

158 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡R‘uºsE¼ÜIfNoD©a
) {

159 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
 = 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
();

160 
	gül
.
ş—r_d©a
();

161 
EXPECT_THAT
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(
ül
),

162 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

165 
TEST
(
C”tifiÿ‹UtTe¡
,

166 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡SucûedsIfC¾IsV®id
) {

167 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(

168 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
()));

	@crypto/certificate_util_test.cc

19 
	~"asylo/üy±o/û¹ifiÿ‹_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/üy±o/û¹ifiÿ‹.pb.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
	~"asylo/ut/¡©us.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

32 
C”tifiÿ‹SignšgReque¡
 
C»©eV®idC”tifiÿ‹SignšgReque¡
() {

33 
C”tifiÿ‹SignšgReque¡
 
	gc¤
;

34 
	gc¤
.
£t_fÜm©
(
C”tifiÿ‹SignšgReque¡
::
PKCS10_PEM
);

35 
	gc¤
.
£t_d©a
("foobar");

36  
	gc¤
;

40 
C”tifiÿ‹
 
C»©eV®idC”tifiÿ‹
() {

41 
C”tifiÿ‹
 
	gû¹ifiÿ‹
;

42 
	gû¹ifiÿ‹
.
£t_fÜm©
(
C”tifiÿ‹
::
X509_PEM
);

43 
	gû¹ifiÿ‹
.
£t_d©a
("foobar");

44  
	gû¹ifiÿ‹
;

49 
C”tifiÿ‹Chaš
 
C»©eV®idC”tifiÿ‹Chaš
(
Ëngth
) {

50 
C”tifiÿ‹Chaš
 
	gû¹ifiÿ‹_chaš
;

51 
	gi
 = 0; i < 
	gËngth
; ++i) {

52 *
	gû¹ifiÿ‹_chaš
.
add_û¹ifiÿ‹s
(èğ
C»©eV®idC”tifiÿ‹
();

54  
	gû¹ifiÿ‹_chaš
;

59 
C”tifiÿ‹RevoÿtiÚLi¡
 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
() {

60 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
;

61 
	gül
.
£t_fÜm©
(
C”tifiÿ‹RevoÿtiÚLi¡
::
X509_PEM
);

62 
	gül
.
£t_d©a
("foobar");

63  
	gül
;

66 
TEST
(
C”tifiÿ‹UtTe¡
,

67 
V®id©eC”tifiÿ‹SignšgReque¡R‘uºsE¼ÜIfNoFÜm©
) {

68 
C”tifiÿ‹SignšgReque¡
 
	gc¤
 = 
C»©eV®idC”tifiÿ‹SignšgReque¡
();

69 
	gc¤
.
ş—r_fÜm©
();

70 
EXPECT_THAT
(
V®id©eC”tifiÿ‹SignšgReque¡
(
c¤
),

71 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

74 
TEST
(
C”tifiÿ‹UtTe¡
,

75 
V®id©eC”tifiÿ‹SignšgReque¡R‘uºsE¼ÜIfUnknownFÜm©
) {

76 
C”tifiÿ‹SignšgReque¡
 
	gc¤
 = 
C»©eV®idC”tifiÿ‹SignšgReque¡
();

77 
	gc¤
.
£t_fÜm©
(
C”tifiÿ‹SignšgReque¡
::
UNKNOWN
);

78 
EXPECT_THAT
(
V®id©eC”tifiÿ‹SignšgReque¡
(
c¤
),

79 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

82 
TEST
(
C”tifiÿ‹UtTe¡
,

83 
V®id©eC”tifiÿ‹SignšgReque¡R‘uºsE¼ÜIfNoD©a
) {

84 
C”tifiÿ‹SignšgReque¡
 
	gc¤
 = 
C»©eV®idC”tifiÿ‹SignšgReque¡
();

85 
	gc¤
.
ş—r_d©a
();

86 
EXPECT_THAT
(
V®id©eC”tifiÿ‹SignšgReque¡
(
c¤
),

87 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

90 
TEST
(
C”tifiÿ‹UtTe¡
,

91 
V®id©eC”tifiÿ‹SignšgReque¡SucûedsIfC¤IsV®id
) {

92 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹SignšgReque¡
(

93 
C»©eV®idC”tifiÿ‹SignšgReque¡
()));

96 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹R‘uºsE¼ÜIfNoFÜm©
) {

97 
C”tifiÿ‹
 
	gû¹ifiÿ‹
 = 
C»©eV®idC”tifiÿ‹
();

98 
	gû¹ifiÿ‹
.
ş—r_fÜm©
();

99 
EXPECT_THAT
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
),

100 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

103 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹R‘uºsE¼ÜIfUnknownFÜm©
) {

104 
C”tifiÿ‹
 
	gû¹ifiÿ‹
 = 
C»©eV®idC”tifiÿ‹
();

105 
	gû¹ifiÿ‹
.
£t_fÜm©
(
C”tifiÿ‹
::
UNKNOWN
);

106 
EXPECT_THAT
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
),

107 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

110 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹R‘uºsE¼ÜIfNoD©a
) {

111 
C”tifiÿ‹
 
	gû¹ifiÿ‹
 = 
C»©eV®idC”tifiÿ‹
();

112 
	gû¹ifiÿ‹
.
ş—r_d©a
();

113 
EXPECT_THAT
(
V®id©eC”tifiÿ‹
(
û¹ifiÿ‹
),

114 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

117 
TEST
(
C”tifiÿ‹UtTe¡
, 
V®id©eC”tifiÿ‹SucûedsIfC”tifiÿ‹IsV®id
) {

118 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹
(
C»©eV®idC”tifiÿ‹
()));

121 
TEST
(
C”tifiÿ‹UtTe¡
,

122 
V®id©eC”tifiÿ‹ChašFasIfACÚšedC”tifiÿ‹IsInv®id
) {

123 
C”tifiÿ‹Chaš
 
	gû¹ifiÿ‹_chaš
 = 
C»©eV®idC”tifiÿ‹Chaš
(1);

124 
	gû¹ifiÿ‹_chaš
.
mubË_û¹ifiÿ‹s
(0)->
ş—r_fÜm©
();

125 
EXPECT_THAT
(
V®id©eC”tifiÿ‹Chaš
(
û¹ifiÿ‹_chaš
),

126 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

128 
	gû¹ifiÿ‹_chaš
 = 
C»©eV®idC”tifiÿ‹Chaš
(5);

129 
	gû¹ifiÿ‹_chaš
.
mubË_û¹ifiÿ‹s
(1)->
ş—r_fÜm©
();

130 
EXPECT_THAT
(
V®id©eC”tifiÿ‹Chaš
(
û¹ifiÿ‹_chaš
),

131 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

134 
TEST
(
C”tifiÿ‹UtTe¡
,

135 
V®id©eC”tifiÿ‹ChašSucûedsIfC”tifiÿ‹ChašIsV®id
) {

136 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹Chaš
(
C»©eV®idC”tifiÿ‹Chaš
(0)));

137 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹Chaš
(
C»©eV®idC”tifiÿ‹Chaš
(1)));

138 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹Chaš
(
C»©eV®idC”tifiÿ‹Chaš
(27)));

141 
TEST
(
C”tifiÿ‹UtTe¡
,

142 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡R‘uºsE¼ÜIfNoFÜm©
) {

143 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
 = 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
();

144 
	gül
.
ş—r_fÜm©
();

145 
EXPECT_THAT
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(
ül
),

146 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

149 
TEST
(
C”tifiÿ‹UtTe¡
,

150 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡R‘uºsE¼ÜIfUnknownFÜm©
) {

151 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
 = 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
();

152 
	gül
.
£t_fÜm©
(
C”tifiÿ‹RevoÿtiÚLi¡
::
UNKNOWN
);

153 
EXPECT_THAT
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(
ül
),

154 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

157 
TEST
(
C”tifiÿ‹UtTe¡
,

158 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡R‘uºsE¼ÜIfNoD©a
) {

159 
C”tifiÿ‹RevoÿtiÚLi¡
 
	gül
 = 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
();

160 
	gül
.
ş—r_d©a
();

161 
EXPECT_THAT
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(
ül
),

162 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

165 
TEST
(
C”tifiÿ‹UtTe¡
,

166 
V®id©eC”tifiÿ‹RevoÿtiÚLi¡SucûedsIfC¾IsV®id
) {

167 
ASYLO_EXPECT_OK
(
V®id©eC”tifiÿ‹RevoÿtiÚLi¡
(

168 
C»©eV®idC”tifiÿ‹RevoÿtiÚLi¡
()));

	@crypto/ecdsa_p256_sha256_signing_key.cc

19 
	~"asylo/üy±o/ecd§_p256_sha256_signšg_key.h
"

21 
	~<İ’s¦/by‹¡ršg.h
>

22 
	~<İ’s¦/üy±o.h
>

23 
	~<İ’s¦/ec_key.h
>

24 
	~<İ’s¦/ecd§.h
>

25 
	~<İ’s¦/mem.h
>

26 
	~<İ’s¦/nid.h
>

27 
	~<İ’s¦/³m.h
>

28 
	~<İ’s¦/x509.h
>

30 
	~<c¡dšt
>

31 
	~<ut™y
>

32 
	~<veùÜ
>

34 
	~"ab¦/memÜy/memÜy.h
"

35 
	~"asylo/üy±o/sha256_hash.h
"

36 
	~"asylo/üy±o/ut/bs¦_ut.h
"

37 
	~"asylo/ut/¡©us.h
"

38 
	~"asylo/ut/¡©us_maüos.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

44 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
EC_KEY
>> 
C»©ePublicKeyFromPriv©eKey
(

45 cÚ¡ 
EC_KEY
 *
´iv©e_key
) {

46 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
(

47 
EC_KEY_Ãw_by_curve_Çme
(
NID_X9_62_´ime256v1
));

48 ià(!
	gpublic_key
) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

51 ià(!
EC_KEY_£t_public_key
(
public_key
.
g‘
(),

52 
EC_KEY_g‘0_public_key
(
´iv©e_key
))) {

53  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

56  
	g¡d
::
move
(
public_key
);

63 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>>

64 
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

66 
ušt8_t
 cÚ¡ *
£rŸlized_key_d©a
 = 
£rŸlized_key
.
d©a
();

71 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
d2i_EC_PUBKEY
Ğ
nuÎ±r
, &
£rŸlized_key_d©a
,

72 
£rŸlized_key
.
size
()));

73 ià(!
	gkey
) {

74  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

76  
C»©e
(
¡d
::
move
(
key
));

79 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>>

80 
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromPem
(
By‹CÚš”V›w
 
£rŸlized_key
) {

82 
bs¦
::
UniquePŒ
<
BIO
> 
key_bio
(

83 
BIO_Ãw_mem_buf
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

87 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
PEM_»ad_bio_EC_PUBKEY
(

88 
key_bio
.
g‘
(), 
nuÎ±r
,‚ullptr,‚ullptr));

89 ià(!
	gkey
) {

90  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

93  
C»©e
(
¡d
::
move
(
key
));

96 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>>

97 
Ecd§P256Sha256V”ifyšgKey
::
C»©e
(
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
) {

98 ià(
EC_GROUP_g‘_curve_Çme
(
EC_KEY_g‘0_group
(
public_key
.
g‘
())) !=

99 
NID_X9_62_´ime256v1
) {

100  
Stus
(

101 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105  
	gab¦
::
W¿pUnique
<
Ecd§P256Sha256V”ifyšgKey
>(

106 
Ãw
 
Ecd§P256Sha256V”ifyšgKey
(
¡d
::
move
(
public_key
)));

109 
SigÇtu»Scheme
 
	gEcd§P256Sha256V”ifyšgKey
::
G‘SigÇtu»Scheme
() const {

110  
SigÇtu»Scheme
::
ECDSA_P256_SHA256
;

113 
	gStusOr
<
	g¡d
::
¡ršg
> 
Ecd§P256Sha256V”ifyšgKey
::
S”ŸlizeToD”
() const {

114 
ušt8_t
 *
key
 = 
nuÎ±r
;

115 
	gËngth
 = 
i2d_EC_PUBKEY
(
public_key_
.
g‘
(), &
key
);

116 ià(
	gËngth
 <= 0) {

117  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

119 
	gbs¦
::
UniquePŒ
<
ušt8_t
> 
d–‘”
(
key
);

120  
	g¡d
::
¡ršg
(
»š‹½»t_ÿ¡
<*>(
key
), 
Ëngth
);

123 
Stus
 
	gEcd§P256Sha256V”ifyšgKey
::
V”ify
(
By‹CÚš”V›w
 
mes§ge
,

124 
By‹CÚš”V›w
 
sigÇtu»
) const {

125 
Sha256Hash
 
	ghash”
;

126 
	ghash”
.
In™
();

127 
	ghash”
.
Upd©e
(
mes§ge
);

128 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

129 
ASYLO_RETURN_IF_ERROR
(
hash”
.
CumuÏtiveHash
(&
dige¡
));

131 ià(!
ECDSA_v”ify
Ğ0, 
dige¡
.
d©a
(), dige¡.
size
(), 
sigÇtu»
.data(),

132 
sigÇtu»
.
size
(), 
public_key_
.
g‘
())) {

133  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

135  
	gStus
::
OkStus
();

138 
	gEcd§P256Sha256V”ifyšgKey
::
Ecd§P256Sha256V”ifyšgKey
(

139 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
)

140 : 
public_key_
(
¡d
::
move
(
public_key
)) {}

144 
StusOr
<
¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

145 
Ecd§P256Sha256SignšgKey
::
C»©e
() {

146 
bs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
EC_KEY_Ãw_by_curve_Çme
(
NID_X9_62_´ime256v1
));

147 ià(!
	gkey
) {

148  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

151 
	g»suÉ
 = 0;

152 ià(
FIPS_mode
()) {

153 
	g»suÉ
 = 
EC_KEY_g’”©e_key_fs
(
key
.
g‘
());

155 
	g»suÉ
 = 
EC_KEY_g’”©e_key
(
key
.
g‘
());

157 ià(!
	g»suÉ
) {

158  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

161  
	gEcd§P256Sha256SignšgKey
::
C»©e
(
¡d
::
move
(
key
));

164 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

165 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

166 
CBS
 
bufãr
;

167 
CBS_š™
(&
bufãr
, 
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
());

169 
	gbs¦
::
UniquePŒ
<
EC_GROUP
> 
group
(

170 
EC_GROUP_Ãw_by_curve_Çme
(
NID_X9_62_´ime256v1
));

171 ià(!
	ggroup
) {

172  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

175 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
EC_KEY_·r£_´iv©e_key
(&
bufãr
, 
group
.
g‘
()));

176 ià(!
	gkey
) {

177  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

180  
C»©e
(
¡d
::
move
(
key
));

183 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

184 
Ecd§P256Sha256SignšgKey
::
C»©eFromPem
(
By‹CÚš”V›w
 
£rŸlized_key
) {

186 
bs¦
::
UniquePŒ
<
BIO
> 
key_bio
(

187 
BIO_Ãw_mem_buf
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

190 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
PEM_»ad_bio_ECPriv©eKey
(

191 
key_bio
.
g‘
(), 
nuÎ±r
,‚ullptr,‚ullptr));

192 ià(!
	gkey
) {

193  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

196  
C»©e
(
¡d
::
move
(
key
));

199 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

200 
Ecd§P256Sha256SignšgKey
::
C»©e
(
bs¦
::
UniquePŒ
<
EC_KEY
> 
´iv©e_key
) {

201 ià(
EC_GROUP_g‘_curve_Çme
(
EC_KEY_g‘0_group
(
´iv©e_key
.
g‘
())) !=

202 
NID_X9_62_´ime256v1
) {

203  
Stus
(

204 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

208 autØ
	gpublic_key_»suÉ
 = 
C»©ePublicKeyFromPriv©eKey
(
´iv©e_key
.
g‘
());

209 ià(!
	gpublic_key_»suÉ
.
ok
()) {

210  
	gpublic_key_»suÉ
.
¡©us
();

213  
	gab¦
::
W¿pUnique
<
Ecd§P256Sha256SignšgKey
>(

214 
Ãw
 
Ecd§P256Sha256SignšgKey
(
¡d
::
move
(
´iv©e_key
),

215 
¡d
::
move
(
public_key_»suÉ
).
V®ueOrD›
()));

218 
Stus
 
	gEcd§P256Sha256SignšgKey
::
S”ŸlizeToD”
(

219 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
) const {

220 
CBB
 
bufãr
;

221 ià(!
CBB_š™
(&
bufãr
, 0) ||

222 !
EC_KEY_m¬sh®_´iv©e_key
(&
bufãr
, 
´iv©e_key_
.
g‘
(),

223 
EC_KEY_g‘_’c_æags
(
´iv©e_key_
.
g‘
()))) {

224 
CBB_ş—nup
(&
bufãr
);

225  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

228 
ušt8_t
 *
	gkey_d©a
;

229 
size_t
 
	gkey_d©a_size
 = 0;

230 
CBB_fšish
(&
bufãr
, &
key_d©a
, &
key_d©a_size
);

232 
	g£rŸlized_key
->
assign
(
key_d©a
, key_d©¨+ 
key_d©a_size
);

234 
OPENSSL_ş—n£
(
key_d©a
, 
key_d©a_size
);

235 
OPENSSL_ä“
(
key_d©a
);

237  
	gStus
::
OkStus
();

240 
SigÇtu»Scheme
 
	gEcd§P256Sha256SignšgKey
::
G‘SigÇtu»Scheme
() const {

241  
SigÇtu»Scheme
::
ECDSA_P256_SHA256
;

244 
	gStusOr
<
	g¡d
::
unique_±r
<
V”ifyšgKey
>>

245 
Ecd§P256Sha256SignšgKey
::
G‘V”ifyšgKey
() const {

246 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key_cİy
(
EC_KEY_dup
(
public_key_
.
g‘
()));

247 ià(!
	gpublic_key_cİy
) {

248  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

251  
	gEcd§P256Sha256V”ifyšgKey
::
C»©e
(
¡d
::
move
(
public_key_cİy
));

254 
Stus
 
	gEcd§P256Sha256SignšgKey
::
Sign
(
By‹CÚš”V›w
 
mes§ge
,

255 
¡d
::
veùÜ
<
ušt8_t
> *
sigÇtu»
) const {

256 
Sha256Hash
 
hash”
;

257 
	ghash”
.
In™
();

258 
	ghash”
.
Upd©e
(
mes§ge
);

259 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

260 
ASYLO_RETURN_IF_ERROR
(
hash”
.
CumuÏtiveHash
(&
dige¡
));

262 
	gsigÇtu»
->
»size
(
ECDSA_size
(
´iv©e_key_
.
g‘
()));

263 
ušt32_t
 
	gsigÇtu»_size
 = 0;

264 ià(!
ECDSA_sign
Ğ0, 
dige¡
.
d©a
(), dige¡.
size
(), 
sigÇtu»
->data(),

265 &
sigÇtu»_size
, 
´iv©e_key_
.
g‘
())) {

266  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

268 
	gsigÇtu»
->
»size
(
sigÇtu»_size
);

269  
	gStus
::
OkStus
();

272 
	gEcd§P256Sha256SignšgKey
::
Ecd§P256Sha256SignšgKey
(

273 
bs¦
::
UniquePŒ
<
EC_KEY
> 
´iv©e_key
, bs¦::UniquePŒ<EC_KEY> 
public_key
)

274 : 
´iv©e_key_
(
¡d
::
move
(
´iv©e_key
)),

275 
public_key_
(
¡d
::
move
(
public_key
)) {}

	@crypto/ecdsa_p256_sha256_signing_key.cc

19 
	~"asylo/üy±o/ecd§_p256_sha256_signšg_key.h
"

21 
	~<İ’s¦/by‹¡ršg.h
>

22 
	~<İ’s¦/üy±o.h
>

23 
	~<İ’s¦/ec_key.h
>

24 
	~<İ’s¦/ecd§.h
>

25 
	~<İ’s¦/mem.h
>

26 
	~<İ’s¦/nid.h
>

27 
	~<İ’s¦/³m.h
>

28 
	~<İ’s¦/x509.h
>

30 
	~<c¡dšt
>

31 
	~<ut™y
>

32 
	~<veùÜ
>

34 
	~"ab¦/memÜy/memÜy.h
"

35 
	~"asylo/üy±o/sha256_hash.h
"

36 
	~"asylo/üy±o/ut/bs¦_ut.h
"

37 
	~"asylo/ut/¡©us.h
"

38 
	~"asylo/ut/¡©us_maüos.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

44 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
EC_KEY
>> 
C»©ePublicKeyFromPriv©eKey
(

45 cÚ¡ 
EC_KEY
 *
´iv©e_key
) {

46 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
(

47 
EC_KEY_Ãw_by_curve_Çme
(
NID_X9_62_´ime256v1
));

48 ià(!
	gpublic_key
) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

51 ià(!
EC_KEY_£t_public_key
(
public_key
.
g‘
(),

52 
EC_KEY_g‘0_public_key
(
´iv©e_key
))) {

53  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

56  
	g¡d
::
move
(
public_key
);

63 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>>

64 
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

66 
ušt8_t
 cÚ¡ *
£rŸlized_key_d©a
 = 
£rŸlized_key
.
d©a
();

71 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
d2i_EC_PUBKEY
Ğ
nuÎ±r
, &
£rŸlized_key_d©a
,

72 
£rŸlized_key
.
size
()));

73 ià(!
	gkey
) {

74  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

76  
C»©e
(
¡d
::
move
(
key
));

79 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>>

80 
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromPem
(
By‹CÚš”V›w
 
£rŸlized_key
) {

82 
bs¦
::
UniquePŒ
<
BIO
> 
key_bio
(

83 
BIO_Ãw_mem_buf
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

87 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
PEM_»ad_bio_EC_PUBKEY
(

88 
key_bio
.
g‘
(), 
nuÎ±r
,‚ullptr,‚ullptr));

89 ià(!
	gkey
) {

90  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

93  
C»©e
(
¡d
::
move
(
key
));

96 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>>

97 
Ecd§P256Sha256V”ifyšgKey
::
C»©e
(
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
) {

98 ià(
EC_GROUP_g‘_curve_Çme
(
EC_KEY_g‘0_group
(
public_key
.
g‘
())) !=

99 
NID_X9_62_´ime256v1
) {

100  
Stus
(

101 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105  
	gab¦
::
W¿pUnique
<
Ecd§P256Sha256V”ifyšgKey
>(

106 
Ãw
 
Ecd§P256Sha256V”ifyšgKey
(
¡d
::
move
(
public_key
)));

109 
SigÇtu»Scheme
 
	gEcd§P256Sha256V”ifyšgKey
::
G‘SigÇtu»Scheme
() const {

110  
SigÇtu»Scheme
::
ECDSA_P256_SHA256
;

113 
	gStusOr
<
	g¡d
::
¡ršg
> 
Ecd§P256Sha256V”ifyšgKey
::
S”ŸlizeToD”
() const {

114 
ušt8_t
 *
key
 = 
nuÎ±r
;

115 
	gËngth
 = 
i2d_EC_PUBKEY
(
public_key_
.
g‘
(), &
key
);

116 ià(
	gËngth
 <= 0) {

117  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

119 
	gbs¦
::
UniquePŒ
<
ušt8_t
> 
d–‘”
(
key
);

120  
	g¡d
::
¡ršg
(
»š‹½»t_ÿ¡
<*>(
key
), 
Ëngth
);

123 
Stus
 
	gEcd§P256Sha256V”ifyšgKey
::
V”ify
(
By‹CÚš”V›w
 
mes§ge
,

124 
By‹CÚš”V›w
 
sigÇtu»
) const {

125 
Sha256Hash
 
	ghash”
;

126 
	ghash”
.
In™
();

127 
	ghash”
.
Upd©e
(
mes§ge
);

128 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

129 
ASYLO_RETURN_IF_ERROR
(
hash”
.
CumuÏtiveHash
(&
dige¡
));

131 ià(!
ECDSA_v”ify
Ğ0, 
dige¡
.
d©a
(), dige¡.
size
(), 
sigÇtu»
.data(),

132 
sigÇtu»
.
size
(), 
public_key_
.
g‘
())) {

133  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

135  
	gStus
::
OkStus
();

138 
	gEcd§P256Sha256V”ifyšgKey
::
Ecd§P256Sha256V”ifyšgKey
(

139 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
)

140 : 
public_key_
(
¡d
::
move
(
public_key
)) {}

144 
StusOr
<
¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

145 
Ecd§P256Sha256SignšgKey
::
C»©e
() {

146 
bs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
EC_KEY_Ãw_by_curve_Çme
(
NID_X9_62_´ime256v1
));

147 ià(!
	gkey
) {

148  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

151 
	g»suÉ
 = 0;

152 ià(
FIPS_mode
()) {

153 
	g»suÉ
 = 
EC_KEY_g’”©e_key_fs
(
key
.
g‘
());

155 
	g»suÉ
 = 
EC_KEY_g’”©e_key
(
key
.
g‘
());

157 ià(!
	g»suÉ
) {

158  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

161  
	gEcd§P256Sha256SignšgKey
::
C»©e
(
¡d
::
move
(
key
));

164 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

165 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

166 
CBS
 
bufãr
;

167 
CBS_š™
(&
bufãr
, 
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
());

169 
	gbs¦
::
UniquePŒ
<
EC_GROUP
> 
group
(

170 
EC_GROUP_Ãw_by_curve_Çme
(
NID_X9_62_´ime256v1
));

171 ià(!
	ggroup
) {

172  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

175 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
EC_KEY_·r£_´iv©e_key
(&
bufãr
, 
group
.
g‘
()));

176 ià(!
	gkey
) {

177  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

180  
C»©e
(
¡d
::
move
(
key
));

183 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

184 
Ecd§P256Sha256SignšgKey
::
C»©eFromPem
(
By‹CÚš”V›w
 
£rŸlized_key
) {

186 
bs¦
::
UniquePŒ
<
BIO
> 
key_bio
(

187 
BIO_Ãw_mem_buf
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

190 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
key
(
PEM_»ad_bio_ECPriv©eKey
(

191 
key_bio
.
g‘
(), 
nuÎ±r
,‚ullptr,‚ullptr));

192 ià(!
	gkey
) {

193  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

196  
C»©e
(
¡d
::
move
(
key
));

199 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>>

200 
Ecd§P256Sha256SignšgKey
::
C»©e
(
bs¦
::
UniquePŒ
<
EC_KEY
> 
´iv©e_key
) {

201 ià(
EC_GROUP_g‘_curve_Çme
(
EC_KEY_g‘0_group
(
´iv©e_key
.
g‘
())) !=

202 
NID_X9_62_´ime256v1
) {

203  
Stus
(

204 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

208 autØ
	gpublic_key_»suÉ
 = 
C»©ePublicKeyFromPriv©eKey
(
´iv©e_key
.
g‘
());

209 ià(!
	gpublic_key_»suÉ
.
ok
()) {

210  
	gpublic_key_»suÉ
.
¡©us
();

213  
	gab¦
::
W¿pUnique
<
Ecd§P256Sha256SignšgKey
>(

214 
Ãw
 
Ecd§P256Sha256SignšgKey
(
¡d
::
move
(
´iv©e_key
),

215 
¡d
::
move
(
public_key_»suÉ
).
V®ueOrD›
()));

218 
Stus
 
	gEcd§P256Sha256SignšgKey
::
S”ŸlizeToD”
(

219 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
) const {

220 
CBB
 
bufãr
;

221 ià(!
CBB_š™
(&
bufãr
, 0) ||

222 !
EC_KEY_m¬sh®_´iv©e_key
(&
bufãr
, 
´iv©e_key_
.
g‘
(),

223 
EC_KEY_g‘_’c_æags
(
´iv©e_key_
.
g‘
()))) {

224 
CBB_ş—nup
(&
bufãr
);

225  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

228 
ušt8_t
 *
	gkey_d©a
;

229 
size_t
 
	gkey_d©a_size
 = 0;

230 
CBB_fšish
(&
bufãr
, &
key_d©a
, &
key_d©a_size
);

232 
	g£rŸlized_key
->
assign
(
key_d©a
, key_d©¨+ 
key_d©a_size
);

234 
OPENSSL_ş—n£
(
key_d©a
, 
key_d©a_size
);

235 
OPENSSL_ä“
(
key_d©a
);

237  
	gStus
::
OkStus
();

240 
SigÇtu»Scheme
 
	gEcd§P256Sha256SignšgKey
::
G‘SigÇtu»Scheme
() const {

241  
SigÇtu»Scheme
::
ECDSA_P256_SHA256
;

244 
	gStusOr
<
	g¡d
::
unique_±r
<
V”ifyšgKey
>>

245 
Ecd§P256Sha256SignšgKey
::
G‘V”ifyšgKey
() const {

246 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key_cİy
(
EC_KEY_dup
(
public_key_
.
g‘
()));

247 ià(!
	gpublic_key_cİy
) {

248  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

251  
	gEcd§P256Sha256V”ifyšgKey
::
C»©e
(
¡d
::
move
(
public_key_cİy
));

254 
Stus
 
	gEcd§P256Sha256SignšgKey
::
Sign
(
By‹CÚš”V›w
 
mes§ge
,

255 
¡d
::
veùÜ
<
ušt8_t
> *
sigÇtu»
) const {

256 
Sha256Hash
 
hash”
;

257 
	ghash”
.
In™
();

258 
	ghash”
.
Upd©e
(
mes§ge
);

259 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

260 
ASYLO_RETURN_IF_ERROR
(
hash”
.
CumuÏtiveHash
(&
dige¡
));

262 
	gsigÇtu»
->
»size
(
ECDSA_size
(
´iv©e_key_
.
g‘
()));

263 
ušt32_t
 
	gsigÇtu»_size
 = 0;

264 ià(!
ECDSA_sign
Ğ0, 
dige¡
.
d©a
(), dige¡.
size
(), 
sigÇtu»
->data(),

265 &
sigÇtu»_size
, 
´iv©e_key_
.
g‘
())) {

266  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

268 
	gsigÇtu»
->
»size
(
sigÇtu»_size
);

269  
	gStus
::
OkStus
();

272 
	gEcd§P256Sha256SignšgKey
::
Ecd§P256Sha256SignšgKey
(

273 
bs¦
::
UniquePŒ
<
EC_KEY
> 
´iv©e_key
, bs¦::UniquePŒ<EC_KEY> 
public_key
)

274 : 
´iv©e_key_
(
¡d
::
move
(
´iv©e_key
)),

275 
public_key_
(
¡d
::
move
(
public_key
)) {}

	@crypto/ecdsa_p256_sha256_signing_key.h

19 #iâdeà
ASYLO_CRYPTO_ECDSA_P256_SHA256_SIGNING_KEY_H_


20 
	#ASYLO_CRYPTO_ECDSA_P256_SHA256_SIGNING_KEY_H_


	)

22 
	~<İ’s¦/ba£.h
>

23 
	~<İ’s¦/ec.h
>

25 
	~<memÜy
>

27 
	~"asylo/üy±o/signšg_key.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

31 
Çme¥aû
 
	gasylo
 {

35 şas 
	cEcd§P256Sha256V”ifyšgKey
 : 
public
 
V”ifyšgKey
 {

36 
public
:

39 
StusOr
<
¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>> 
C»©eFromD”
(

40 
By‹CÚš”V›w
 
£rŸlized_key
);

44 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>> 
C»©eFromPem
(

45 
By‹CÚš”V›w
 
£rŸlized_key
);

48 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256V”ifyšgKey
>> 
C»©e
(

49 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
);

53 
SigÇtu»Scheme
 
G‘SigÇtu»Scheme
(ècÚ¡ 
	gov”ride
;

55 
	gStusOr
<
	g¡d
::
¡ršg
> 
S”ŸlizeToD”
(ècÚ¡ 
ov”ride
;

57 
Stus
 
V”ify
(
By‹CÚš”V›w
 
mes§ge
,

58 
By‹CÚš”V›w
 
sigÇtu»
ècÚ¡ 
	gov”ride
;

60 
	g´iv©e
:

61 
Ecd§P256Sha256V”ifyšgKey
(
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
);

64 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
public_key_
;

69 şas 
	cEcd§P256Sha256SignšgKey
 : 
public
 
SignšgKey
 {

70 
public
:

72 
StusOr
<
¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>> 
C»©e
();

76 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>> 
C»©eFromD”
(

77 
By‹CÚš”V›w
 
£rŸlized_key
);

81 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>> 
C»©eFromPem
(

82 
By‹CÚš”V›w
 
£rŸlized_key
);

85 
	gStusOr
<
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
>> 
C»©e
(

86 
bs¦
::
UniquePŒ
<
EC_KEY
> 
´iv©e_key
);

89 
SigÇtu»Scheme
 
G‘SigÇtu»Scheme
(ècÚ¡ 
	gov”ride
;

92 
Stus
 
S”ŸlizeToD”
(

93 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
ècÚ¡ 
	gov”ride
;

96 
	gStusOr
<
	g¡d
::
unique_±r
<
V”ifyšgKey
>> 
G‘V”ifyšgKey
(ècÚ¡ 
ov”ride
;

99 
Stus
 
Sign
(
By‹CÚš”V›w
 
mes§ge
,

100 
¡d
::
veùÜ
<
ušt8_t
> *
sigÇtu»
ècÚ¡ 
ov”ride
;

102 
	g´iv©e
:

103 
Ecd§P256Sha256SignšgKey
(
bs¦
::
UniquePŒ
<
EC_KEY
> 
´iv©e_key
,

104 
bs¦
::
UniquePŒ
<
EC_KEY
> 
public_key
);

107 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
´iv©e_key_
;

111 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
public_key_
;

	@crypto/ecdsa_p256_sha256_signing_key_test.cc

19 
	~"asylo/üy±o/ecd§_p256_sha256_signšg_key.h
"

21 
	~<İ’s¦/ba£.h
>

22 
	~<İ’s¦/ec.h
>

23 
	~<İ’s¦/nid.h
>

24 
	~<İ’s¦/¿nd.h
>

26 
	~<c¡dšt
>

27 
	~<funùiÚ®
>

28 
	~<memÜy
>

29 
	~<¡ršg
>

30 
	~<ut™y
>

31 
	~<veùÜ
>

33 
	~<gmock/gmock.h
>

34 
	~<g‹¡/g‹¡.h
>

35 
	~"ab¦/¡ršgs/esÿpšg.h
"

36 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

37 
	~"asylo/üy±o/signšg_key.h
"

38 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

39 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

40 
	~"gæags/gæags.h
"

41 
	~"asylo/ut/loggšg.h
"

42 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

43 
	~"asylo/ut/ş—nsšg_ty³s.h
"

45 
Çme¥aû
 
	gasylo
 {

46 
	gÇme¥aû
 {

48 
DEFINE_¡ršg
(
£rŸlized_signšg_key
, "", "Hex-encoded DER-format SigningKey");

50 
	gusšg
 ::
‹¡šg
::
NÙ
;

52 cÚ¡ 
	gkBadGroup
 = 
NID_£ı224r1
;

53 cÚ¡ 
	gkMes§geSize
 = 1000;

55 
cÚ¡ex´
 
	gkTe¡SignšgKeyD”
[] =

62 
cÚ¡ex´
 
	gkTe¡SignšgKeyPem
[] =

63 
R
"(-----BEGIN EC PRIVATE KEY-----

64 
MHcCAQEEIP4d1debEdG6Xy974ETYt
+78
I5b3åA8qR
/
OY3pSX
+
gwoAoGCCqGSM49


65 
AwEHoUQDQgAE6u2lED6JGU9Dv
+
DYRPPÂwAJV
/
w8kjfH6o3c1n4ix1zXURnqmqAv


66 
ds7Ky78bL
+
Yÿfye6tof4µWfWzrRo4WvQ
==

67 -----
END
 
EC
 
PRIVATE
 
KEY
-----)";

69 
cÚ¡ex´
 
ušt8_t
 
kBadKey
[] = "bad key";

71 
cÚ¡ex´
 
	gkTe¡Mes§geHex
[] = "436f66666565206973206c6966652e0a";

73 
cÚ¡ex´
 
	gkTe¡SigÇtu»Hex
[] =

77 
cÚ¡ex´
 
	gkInv®idSigÇtu»Hex
[] =

82 
cÚ¡ex´
 
	gkTe¡V”ifyšgKeyD”
[] =

88 
cÚ¡ex´
 
	gkTe¡V”ifyšgKeyPem
[] =

89 
R
"(-----BEGIN PUBLIC KEY-----

90 
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE6u2lED6JGU9Dv
+
DYRPPÂwAJV
/
w8


91 
kjfH6o3c1n4ix1zXURnqmqAvds7Ky78bL
+
Yÿfye6tof4µWfWzrRo4WvQ
==

92 -----
END
 
PUBLIC
 
KEY
-----)";

94 
	sV”ifyšgKeyP¬am
 {

95 
¡d
::
funùiÚ
<
StusOr
<¡d::
unique_±r
<
V”ifyšgKey
>>(
By‹CÚš”V›w
)>

96 
çùÜy
;

97 
	g¡d
::
¡ršg
 
key_d©a
;

102 
TEST
(
Ecd§P256Sha256V”ifyšgKeyC»©eTe¡
,

103 
C»©eV”ifyšgKeyW™hBadGroupFas
) {

104 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
bad_key
(
EC_KEY_Ãw_by_curve_Çme
(
kBadGroup
));

105 
ASSERT_EQ
(
EC_KEY_g’”©e_key
(
bad_key
.
g‘
()), 1);

106 
ASSERT_THAT
(
Ecd§P256Sha256V”ifyšgKey
::
C»©e
(
¡d
::
move
(
bad_key
)),

107 
NÙ
(
IsOk
()));

110 
şass
 
	gEcd§P256Sha256V”ifyšgKeyTe¡


111 : 
public
 ::
‹¡šg
::
Te¡W™hP¬am
<
V”ifyšgKeyP¬am
> {

112 
public
:

113 
S‘Up
(è
ov”ride
 {

114 
ASYLO_ASSERT_OK_AND_ASSIGN
(
v”ifyšg_key_
,

115 
G‘P¬am
().
çùÜy
(G‘P¬am().
key_d©a
));

117 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key_
;

121 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
,

122 
C»©eV”ifyšgKeyFromInv®idS”Ÿliz©iÚFas
) {

123 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

125 
EXPECT_THAT
(
G‘P¬am
().
çùÜy
(
£rŸlized_key
), 
NÙ
(
IsOk
()));

130 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
V”ifyšgKeyS”ŸlizeToD”
) {

131 
EXPECT_THAT
(
v”ifyšg_key_
->
S”ŸlizeToD”
(),

132 
IsOkAndHŞds
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡V”ifyšgKeyD”
)));

136 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
V”ifySucûss
) {

137 
	g¡d
::
¡ršg
 
v®id_sigÇtu»
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡SigÇtu»Hex
));

138 
	g¡d
::
¡ršg
 
v®id_mes§ge
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡Mes§geHex
));

140 
ASYLO_EXPECT_OK
(
v”ifyšg_key_
->
V”ify
(
v®id_mes§ge
, 
v®id_sigÇtu»
));

145 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
V”ifyW™hIncÜ»ùSigÇtu»Fas
) {

146 
	g¡d
::
¡ršg
 
šv®id_sigÇtu»
(
ab¦
::
HexSŒšgToBy‹s
(
kInv®idSigÇtu»Hex
));

147 
	g¡d
::
¡ršg
 
v®id_mes§ge
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡Mes§geHex
));

149 
EXPECT_THAT
(
v”ifyšg_key_
->
V”ify
(
v®id_mes§ge
, 
šv®id_sigÇtu»
),

150 
NÙ
(
IsOk
()));

155 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
SigÇtu»Scheme
) {

156 
EXPECT_EQ
(
v”ifyšg_key_
->
G‘SigÇtu»Scheme
(),

157 
SigÇtu»Scheme
::
ECDSA_P256_SHA256
);

160 
INSTANTIATE_TEST_SUITE_P
(

161 
AÎTe¡s
, 
Ecd§P256Sha256V”ifyšgKeyTe¡
,

162 ::
‹¡šg
::
V®ues
(

163 
V”ifyšgKeyP¬am
({
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromD”
,

164 
ab¦
::
HexSŒšgToBy‹s
(
kTe¡V”ifyšgKeyD”
)}),

165 
V”ifyšgKeyP¬am
({
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromPem
,

166 
kTe¡V”ifyšgKeyPem
})));

168 şas 
	cEcd§P256Sha256SignšgKeyTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

169 
public
:

170 
S‘Up
(è
ov”ride
 {

171 ià(!
FLAGS_£rŸlized_signšg_key
.
em±y
()) {

172 
¡d
::
¡ršg
 
£rŸlized_signšg_key_bš
 =

173 
ab¦
::
HexSŒšgToBy‹s
(
FLAGS_£rŸlized_signšg_key
);

175 autØ
	gsignšg_key_»suÉ
 =

176 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_signšg_key_bš
);

177 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ
);

178 
	gsignšg_key_
 = 
¡d
::
move
(
signšg_key_»suÉ
).
V®ueOrD›
();

180 
LOG
(
INFO
) << "Using…rovided SigningKey: "

181 << 
	gFLAGS_£rŸlized_signšg_key
;

183 autØ
	gsignšg_key_»suÉ
 = 
Ecd§P256Sha256SignšgKey
::
C»©e
();

184 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ
);

185 
	gsignšg_key_
 = 
¡d
::
move
(
signšg_key_»suÉ
).
V®ueOrD›
();

187 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized
;

188 
ASYLO_ASSERT_OK
(
signšg_key_
->
S”ŸlizeToD”
(&
£rŸlized
));

190 
LOG
(
INFO
) << "Using„andom SigningKey: "

191 << 
	gab¦
::
By‹sToHexSŒšg
(

192 
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
£rŸlized
));

196 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key_
;

202 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
C»©eSignšgKeyW™hBadGroupFas
) {

203 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
bad_key
(
EC_KEY_Ãw_by_curve_Çme
(
kBadGroup
));

204 
ASSERT_TRUE
(
EC_KEY_g’”©e_key
(
bad_key
.
g‘
()));

205 
ASSERT_THAT
(
Ecd§P256Sha256SignšgKey
::
C»©e
(
¡d
::
move
(
bad_key
)),

206 
NÙ
(
IsOk
()));

211 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
SigÇtu»Scheme
) {

212 
EXPECT_EQ
(
signšg_key_
->
G‘SigÇtu»Scheme
(),

213 
SigÇtu»Scheme
::
ECDSA_P256_SHA256
);

218 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
C»©eSignšgKeyFromPemM©chesD”
) {

219 
	g¡d
::
unique_±r
<
SignšgKey
> 
signšg_key_³m
;

220 
ASYLO_ASSERT_OK_AND_ASSIGN
(

221 
signšg_key_³m
,

222 
Ecd§P256Sha256SignšgKey
::
C»©eFromPem
(
kTe¡SignšgKeyPem
));

224 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_d”
;

225 
ASYLO_ASSERT_OK
(
signšg_key_³m
->
S”ŸlizeToD”
(&
£rŸlized_d”
));

227 
EXPECT_EQ
(
By‹CÚš”V›w
(
£rŸlized_d”
),

228 
By‹CÚš”V›w
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡SignšgKeyD”
)));

233 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
SignAndV”ify
) {

234 
	g¡d
::
veùÜ
<
ušt8_t
> 
mes§ge
(
kMes§geSize
);

235 
ASSERT_TRUE
(
RAND_by‹s
(
mes§ge
.
d©a
(), 
kMes§geSize
));

237 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»
;

238 
ASYLO_ASSERT_OK
(
signšg_key_
->
Sign
(
mes§ge
, &
sigÇtu»
));

240 autØ
	gv”ifyšg_key_»suÉ
 = 
signšg_key_
->
G‘V”ifyšgKey
();

241 
ASYLO_ASSERT_OK
(
v”ifyšg_key_»suÉ
);

243 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key
 =

244 
¡d
::
move
(
v”ifyšg_key_»suÉ
).
V®ueOrD›
();

245 
ASYLO_EXPECT_OK
(
v”ifyšg_key
->
V”ify
(
mes§ge
, 
sigÇtu»
));

248 
	gsigÇtu»
.
back
() ^= 1;

249 
EXPECT_THAT
(
v”ifyšg_key
->
V”ify
(
mes§ge
, 
sigÇtu»
), 
NÙ
(
IsOk
()));

256 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
S”ŸlizeToD”AndRe¡ÜeSignšgKey
) {

257 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key
;

258 
ASYLO_ASSERT_OK
(
signšg_key_
->
S”ŸlizeToD”
(&
£rŸlized_key
));

260 autØ
	gsignšg_key_»suÉ2
 =

261 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_key
);

262 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ2
);

264 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key2
 =

265 
¡d
::
move
(
signšg_key_»suÉ2
).
V®ueOrD›
();

268 
	g¡d
::
veùÜ
<
ušt8_t
> 
mes§ge
(
kMes§geSize
);

269 
ASSERT_TRUE
(
RAND_by‹s
(
mes§ge
.
d©a
(), 
kMes§geSize
));

271 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»
;

272 
ASYLO_ASSERT_OK
(
signšg_key_
->
Sign
(
mes§ge
, &
sigÇtu»
));

274 autØ
	gv”ifyšg_key_»suÉ
 = 
signšg_key2
->
G‘V”ifyšgKey
();

275 
ASYLO_ASSERT_OK
(
v”ifyšg_key_»suÉ
);

277 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key
 =

278 
¡d
::
move
(
v”ifyšg_key_»suÉ
).
V®ueOrD›
();

280 
ASYLO_EXPECT_OK
(
v”ifyšg_key
->
V”ify
(
mes§ge
, 
sigÇtu»
));

285 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
Re¡ÜeFromAndS”ŸlizeToD”SignšgKey
) {

286 
	g¡d
::
¡ršg
 
£rŸlized_key_hex
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡SignšgKeyD”
));

287 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key_bš_ex³ùed
 =

288 
CİyToBy‹CÚš”
<
CËªsšgVeùÜ
<
ušt8_t
>>(
£rŸlized_key_hex
);

290 autØ
	gsignšg_key_»suÉ2
 =

291 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_key_bš_ex³ùed
);

292 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ2
);

294 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key2
 =

295 
¡d
::
move
(
signšg_key_»suÉ2
).
V®ueOrD›
();

297 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key_bš_aùu®
;

298 
	gsignšg_key2
->
S”ŸlizeToD”
(&
£rŸlized_key_bš_aùu®
);

300 
EXPECT_EQ
(
£rŸlized_key_bš_ex³ùed
, 
£rŸlized_key_bš_aùu®
);

305 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
,

306 
C»©eSignšgKeyFromInv®idD”S”Ÿliz©iÚFas
) {

307 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

309 
EXPECT_THAT
(
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_key
),

310 
NÙ
(
IsOk
()));

315 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
,

316 
C»©eSignšgKeyFromInv®idPemS”Ÿliz©iÚFas
) {

317 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

319 
EXPECT_THAT
(
Ecd§P256Sha256SignšgKey
::
C»©eFromPem
(
£rŸlized_key
),

320 
NÙ
(
IsOk
()));

	@crypto/ecdsa_p256_sha256_signing_key_test.cc

19 
	~"asylo/üy±o/ecd§_p256_sha256_signšg_key.h
"

21 
	~<İ’s¦/ba£.h
>

22 
	~<İ’s¦/ec.h
>

23 
	~<İ’s¦/nid.h
>

24 
	~<İ’s¦/¿nd.h
>

26 
	~<c¡dšt
>

27 
	~<funùiÚ®
>

28 
	~<memÜy
>

29 
	~<¡ršg
>

30 
	~<ut™y
>

31 
	~<veùÜ
>

33 
	~<gmock/gmock.h
>

34 
	~<g‹¡/g‹¡.h
>

35 
	~"ab¦/¡ršgs/esÿpšg.h
"

36 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

37 
	~"asylo/üy±o/signšg_key.h
"

38 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

39 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

40 
	~"gæags/gæags.h
"

41 
	~"asylo/ut/loggšg.h
"

42 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

43 
	~"asylo/ut/ş—nsšg_ty³s.h
"

45 
Çme¥aû
 
	gasylo
 {

46 
	gÇme¥aû
 {

48 
DEFINE_¡ršg
(
£rŸlized_signšg_key
, "", "Hex-encoded DER-format SigningKey");

50 
	gusšg
 ::
‹¡šg
::
NÙ
;

52 cÚ¡ 
	gkBadGroup
 = 
NID_£ı224r1
;

53 cÚ¡ 
	gkMes§geSize
 = 1000;

55 
cÚ¡ex´
 
	gkTe¡SignšgKeyD”
[] =

62 
cÚ¡ex´
 
	gkTe¡SignšgKeyPem
[] =

63 
R
"(-----BEGIN EC PRIVATE KEY-----

64 
MHcCAQEEIP4d1debEdG6Xy974ETYt
+78
I5b3åA8qR
/
OY3pSX
+
gwoAoGCCqGSM49


65 
AwEHoUQDQgAE6u2lED6JGU9Dv
+
DYRPPÂwAJV
/
w8kjfH6o3c1n4ix1zXURnqmqAv


66 
ds7Ky78bL
+
Yÿfye6tof4µWfWzrRo4WvQ
==

67 -----
END
 
EC
 
PRIVATE
 
KEY
-----)";

69 
cÚ¡ex´
 
ušt8_t
 
kBadKey
[] = "bad key";

71 
cÚ¡ex´
 
	gkTe¡Mes§geHex
[] = "436f66666565206973206c6966652e0a";

73 
cÚ¡ex´
 
	gkTe¡SigÇtu»Hex
[] =

77 
cÚ¡ex´
 
	gkInv®idSigÇtu»Hex
[] =

82 
cÚ¡ex´
 
	gkTe¡V”ifyšgKeyD”
[] =

88 
cÚ¡ex´
 
	gkTe¡V”ifyšgKeyPem
[] =

89 
R
"(-----BEGIN PUBLIC KEY-----

90 
MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE6u2lED6JGU9Dv
+
DYRPPÂwAJV
/
w8


91 
kjfH6o3c1n4ix1zXURnqmqAvds7Ky78bL
+
Yÿfye6tof4µWfWzrRo4WvQ
==

92 -----
END
 
PUBLIC
 
KEY
-----)";

94 
	sV”ifyšgKeyP¬am
 {

95 
¡d
::
funùiÚ
<
StusOr
<¡d::
unique_±r
<
V”ifyšgKey
>>(
By‹CÚš”V›w
)>

96 
çùÜy
;

97 
	g¡d
::
¡ršg
 
key_d©a
;

102 
TEST
(
Ecd§P256Sha256V”ifyšgKeyC»©eTe¡
,

103 
C»©eV”ifyšgKeyW™hBadGroupFas
) {

104 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
bad_key
(
EC_KEY_Ãw_by_curve_Çme
(
kBadGroup
));

105 
ASSERT_EQ
(
EC_KEY_g’”©e_key
(
bad_key
.
g‘
()), 1);

106 
ASSERT_THAT
(
Ecd§P256Sha256V”ifyšgKey
::
C»©e
(
¡d
::
move
(
bad_key
)),

107 
NÙ
(
IsOk
()));

110 
şass
 
	gEcd§P256Sha256V”ifyšgKeyTe¡


111 : 
public
 ::
‹¡šg
::
Te¡W™hP¬am
<
V”ifyšgKeyP¬am
> {

112 
public
:

113 
S‘Up
(è
ov”ride
 {

114 
ASYLO_ASSERT_OK_AND_ASSIGN
(
v”ifyšg_key_
,

115 
G‘P¬am
().
çùÜy
(G‘P¬am().
key_d©a
));

117 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key_
;

121 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
,

122 
C»©eV”ifyšgKeyFromInv®idS”Ÿliz©iÚFas
) {

123 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

125 
EXPECT_THAT
(
G‘P¬am
().
çùÜy
(
£rŸlized_key
), 
NÙ
(
IsOk
()));

130 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
V”ifyšgKeyS”ŸlizeToD”
) {

131 
EXPECT_THAT
(
v”ifyšg_key_
->
S”ŸlizeToD”
(),

132 
IsOkAndHŞds
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡V”ifyšgKeyD”
)));

136 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
V”ifySucûss
) {

137 
	g¡d
::
¡ršg
 
v®id_sigÇtu»
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡SigÇtu»Hex
));

138 
	g¡d
::
¡ršg
 
v®id_mes§ge
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡Mes§geHex
));

140 
ASYLO_EXPECT_OK
(
v”ifyšg_key_
->
V”ify
(
v®id_mes§ge
, 
v®id_sigÇtu»
));

145 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
V”ifyW™hIncÜ»ùSigÇtu»Fas
) {

146 
	g¡d
::
¡ršg
 
šv®id_sigÇtu»
(
ab¦
::
HexSŒšgToBy‹s
(
kInv®idSigÇtu»Hex
));

147 
	g¡d
::
¡ršg
 
v®id_mes§ge
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡Mes§geHex
));

149 
EXPECT_THAT
(
v”ifyšg_key_
->
V”ify
(
v®id_mes§ge
, 
šv®id_sigÇtu»
),

150 
NÙ
(
IsOk
()));

155 
TEST_P
(
Ecd§P256Sha256V”ifyšgKeyTe¡
, 
SigÇtu»Scheme
) {

156 
EXPECT_EQ
(
v”ifyšg_key_
->
G‘SigÇtu»Scheme
(),

157 
SigÇtu»Scheme
::
ECDSA_P256_SHA256
);

160 
INSTANTIATE_TEST_SUITE_P
(

161 
AÎTe¡s
, 
Ecd§P256Sha256V”ifyšgKeyTe¡
,

162 ::
‹¡šg
::
V®ues
(

163 
V”ifyšgKeyP¬am
({
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromD”
,

164 
ab¦
::
HexSŒšgToBy‹s
(
kTe¡V”ifyšgKeyD”
)}),

165 
V”ifyšgKeyP¬am
({
Ecd§P256Sha256V”ifyšgKey
::
C»©eFromPem
,

166 
kTe¡V”ifyšgKeyPem
})));

168 şas 
	cEcd§P256Sha256SignšgKeyTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

169 
public
:

170 
S‘Up
(è
ov”ride
 {

171 ià(!
FLAGS_£rŸlized_signšg_key
.
em±y
()) {

172 
¡d
::
¡ršg
 
£rŸlized_signšg_key_bš
 =

173 
ab¦
::
HexSŒšgToBy‹s
(
FLAGS_£rŸlized_signšg_key
);

175 autØ
	gsignšg_key_»suÉ
 =

176 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_signšg_key_bš
);

177 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ
);

178 
	gsignšg_key_
 = 
¡d
::
move
(
signšg_key_»suÉ
).
V®ueOrD›
();

180 
LOG
(
INFO
) << "Using…rovided SigningKey: "

181 << 
	gFLAGS_£rŸlized_signšg_key
;

183 autØ
	gsignšg_key_»suÉ
 = 
Ecd§P256Sha256SignšgKey
::
C»©e
();

184 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ
);

185 
	gsignšg_key_
 = 
¡d
::
move
(
signšg_key_»suÉ
).
V®ueOrD›
();

187 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized
;

188 
ASYLO_ASSERT_OK
(
signšg_key_
->
S”ŸlizeToD”
(&
£rŸlized
));

190 
LOG
(
INFO
) << "Using„andom SigningKey: "

191 << 
	gab¦
::
By‹sToHexSŒšg
(

192 
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
£rŸlized
));

196 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key_
;

202 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
C»©eSignšgKeyW™hBadGroupFas
) {

203 
	gbs¦
::
UniquePŒ
<
EC_KEY
> 
bad_key
(
EC_KEY_Ãw_by_curve_Çme
(
kBadGroup
));

204 
ASSERT_TRUE
(
EC_KEY_g’”©e_key
(
bad_key
.
g‘
()));

205 
ASSERT_THAT
(
Ecd§P256Sha256SignšgKey
::
C»©e
(
¡d
::
move
(
bad_key
)),

206 
NÙ
(
IsOk
()));

211 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
SigÇtu»Scheme
) {

212 
EXPECT_EQ
(
signšg_key_
->
G‘SigÇtu»Scheme
(),

213 
SigÇtu»Scheme
::
ECDSA_P256_SHA256
);

218 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
C»©eSignšgKeyFromPemM©chesD”
) {

219 
	g¡d
::
unique_±r
<
SignšgKey
> 
signšg_key_³m
;

220 
ASYLO_ASSERT_OK_AND_ASSIGN
(

221 
signšg_key_³m
,

222 
Ecd§P256Sha256SignšgKey
::
C»©eFromPem
(
kTe¡SignšgKeyPem
));

224 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_d”
;

225 
ASYLO_ASSERT_OK
(
signšg_key_³m
->
S”ŸlizeToD”
(&
£rŸlized_d”
));

227 
EXPECT_EQ
(
By‹CÚš”V›w
(
£rŸlized_d”
),

228 
By‹CÚš”V›w
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡SignšgKeyD”
)));

233 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
SignAndV”ify
) {

234 
	g¡d
::
veùÜ
<
ušt8_t
> 
mes§ge
(
kMes§geSize
);

235 
ASSERT_TRUE
(
RAND_by‹s
(
mes§ge
.
d©a
(), 
kMes§geSize
));

237 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»
;

238 
ASYLO_ASSERT_OK
(
signšg_key_
->
Sign
(
mes§ge
, &
sigÇtu»
));

240 autØ
	gv”ifyšg_key_»suÉ
 = 
signšg_key_
->
G‘V”ifyšgKey
();

241 
ASYLO_ASSERT_OK
(
v”ifyšg_key_»suÉ
);

243 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key
 =

244 
¡d
::
move
(
v”ifyšg_key_»suÉ
).
V®ueOrD›
();

245 
ASYLO_EXPECT_OK
(
v”ifyšg_key
->
V”ify
(
mes§ge
, 
sigÇtu»
));

248 
	gsigÇtu»
.
back
() ^= 1;

249 
EXPECT_THAT
(
v”ifyšg_key
->
V”ify
(
mes§ge
, 
sigÇtu»
), 
NÙ
(
IsOk
()));

256 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
S”ŸlizeToD”AndRe¡ÜeSignšgKey
) {

257 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key
;

258 
ASYLO_ASSERT_OK
(
signšg_key_
->
S”ŸlizeToD”
(&
£rŸlized_key
));

260 autØ
	gsignšg_key_»suÉ2
 =

261 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_key
);

262 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ2
);

264 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key2
 =

265 
¡d
::
move
(
signšg_key_»suÉ2
).
V®ueOrD›
();

268 
	g¡d
::
veùÜ
<
ušt8_t
> 
mes§ge
(
kMes§geSize
);

269 
ASSERT_TRUE
(
RAND_by‹s
(
mes§ge
.
d©a
(), 
kMes§geSize
));

271 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»
;

272 
ASYLO_ASSERT_OK
(
signšg_key_
->
Sign
(
mes§ge
, &
sigÇtu»
));

274 autØ
	gv”ifyšg_key_»suÉ
 = 
signšg_key2
->
G‘V”ifyšgKey
();

275 
ASYLO_ASSERT_OK
(
v”ifyšg_key_»suÉ
);

277 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key
 =

278 
¡d
::
move
(
v”ifyšg_key_»suÉ
).
V®ueOrD›
();

280 
ASYLO_EXPECT_OK
(
v”ifyšg_key
->
V”ify
(
mes§ge
, 
sigÇtu»
));

285 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
, 
Re¡ÜeFromAndS”ŸlizeToD”SignšgKey
) {

286 
	g¡d
::
¡ršg
 
£rŸlized_key_hex
(
ab¦
::
HexSŒšgToBy‹s
(
kTe¡SignšgKeyD”
));

287 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key_bš_ex³ùed
 =

288 
CİyToBy‹CÚš”
<
CËªsšgVeùÜ
<
ušt8_t
>>(
£rŸlized_key_hex
);

290 autØ
	gsignšg_key_»suÉ2
 =

291 
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_key_bš_ex³ùed
);

292 
ASYLO_ASSERT_OK
(
signšg_key_»suÉ2
);

294 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key2
 =

295 
¡d
::
move
(
signšg_key_»suÉ2
).
V®ueOrD›
();

297 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key_bš_aùu®
;

298 
	gsignšg_key2
->
S”ŸlizeToD”
(&
£rŸlized_key_bš_aùu®
);

300 
EXPECT_EQ
(
£rŸlized_key_bš_ex³ùed
, 
£rŸlized_key_bš_aùu®
);

305 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
,

306 
C»©eSignšgKeyFromInv®idD”S”Ÿliz©iÚFas
) {

307 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

309 
EXPECT_THAT
(
Ecd§P256Sha256SignšgKey
::
C»©eFromD”
(
£rŸlized_key
),

310 
NÙ
(
IsOk
()));

315 
TEST_F
(
Ecd§P256Sha256SignšgKeyTe¡
,

316 
C»©eSignšgKeyFromInv®idPemS”Ÿliz©iÚFas
) {

317 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

319 
EXPECT_THAT
(
Ecd§P256Sha256SignšgKey
::
C»©eFromPem
(
£rŸlized_key
),

320 
NÙ
(
IsOk
()));

	@crypto/hash_interface.h

19 #iâdeà
ASYLO_CRYPTO_HASH_INTERFACE_H_


20 
	#ASYLO_CRYPTO_HASH_INTERFACE_H_


	)

22 
	~<c¡dšt
>

23 
	~<c¡dlib
>

24 
	~<veùÜ
>

26 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

40 şas 
	cHashIÁ”çû
 {

41 
	gpublic
:

42 
HashIÁ”çû
(cÚ¡ HashIÁ”çû &èğ
d–‘e
;

43 
	gHashIÁ”çû
 &
	gİ”©Ü
=(cÚ¡ 
HashIÁ”çû
 &èğ
d–‘e
;

44 
HashIÁ”çû
() = ;

45 
	gvœtu®
 ~
HashIÁ”çû
() = ;

48 
vœtu®
 
HashAlgÜ™hm
 
G‘HashAlgÜ™hm
() const = 0;

53 
vœtu®
 
size_t
 
Dige¡Size
() const = 0;

59 
vœtu®
 
In™
() = 0;

62 
vœtu®
 
Upd©e
(
By‹CÚš”V›w
 
d©a
) = 0;

69 
vœtu®
 
Stus
 
CumuÏtiveHash
(
¡d
::
veùÜ
<
ušt8_t
> *
dige¡
) const = 0;

	@crypto/nonce_generator.h

19 #iâdeà
ASYLO_CRYPTO_NONCE_GENERATOR_H_


20 
	#ASYLO_CRYPTO_NONCE_GENERATOR_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/üy±o/ut/by‹s.h
"

25 
	~"asylo/ut/¡©us.h
"

27 
Çme¥aû
 
	gasylo
 {

31 
	g‹m¶©e
 <
size_t
 
	gSize
>

32 şas 
	cNÚûG’”©Ü
 {

33 
	gpublic
:

34 
NÚûG’”©Ü
() = ;

35 
	gvœtu®
 ~
NÚûG’”©Ü
() = ;

50 
vœtu®
 
Stus
 
NextNÚû
(cÚ¡ 
¡d
::
veùÜ
<
ušt8_t
> &
key_id
,

51 
Un§ãBy‹s
<
Size
> *
nÚû
) = 0;

58 
vœtu®
 
boŞ
 
u£s_key_id
(è{  
	gçl£
; }

63 
cÚ¡ex´
 
size_t
 
nÚû_size
(è{  
	gSize
; }

	@crypto/nonce_generator_interface.h

19 #iâdeà
ASYLO_CRYPTO_NONCE_GENERATOR_INTERFACE_H_


20 
	#ASYLO_CRYPTO_NONCE_GENERATOR_INTERFACE_H_


	)

22 
	~<c¡ddef
>

23 
	~<c¡dšt
>

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

33 şas 
	cNÚûG’”©ÜIÁ”çû
 {

34 
	gpublic
:

35 
NÚûG’”©ÜIÁ”çû
() = ;

36 
	gvœtu®
 ~
NÚûG’”©ÜIÁ”çû
() = ;

39 
vœtu®
 
size_t
 
NÚûSize
() const = 0;

44 
vœtu®
 
Stus
 
NextNÚû
(
ab¦
::
S·n
<
ušt8_t
> 
nÚû
) = 0;

	@crypto/random_nonce_generator.cc

19 
	~"asylo/üy±o/¿ndom_nÚû_g’”©Ü.h
"

21 
	~<İ’s¦/¿nd.h
>

23 
	~<c¡dšt
>

24 
	~<memÜy
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/üy±o/ut/bs¦_ut.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
cÚ¡ex´
 
size_t
 
	gkAesGcmNÚûSize
 = 12;

37 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
>

38 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
() {

39  
ab¦
::
W¿pUnique
<
RªdomNÚûG’”©Ü
>(

40 
Ãw
 
RªdomNÚûG’”©Ü
(
kAesGcmNÚûSize
));

43 
size_t
 
	gRªdomNÚûG’”©Ü
::
NÚûSize
(ècÚ¡ {  
nÚû_size_
; }

45 
Stus
 
	gRªdomNÚûG’”©Ü
::
NextNÚû
(
ab¦
::
S·n
<
ušt8_t
> 
nÚû
) {

46 ià(
nÚû
.
size
(è< 
nÚû_size_
) {

47  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

48 
ab¦
::
SŒC©
("Inv®id veùÜ…¬am‘” size: ", 
nÚû
.
size
(),

49 " (veùÜ sizmu¡ b>ğ", 
nÚû_size_
, ")"));

51 ià(
RAND_by‹s
(
nÚû
.
d©a
(), 
nÚû_size_
) != 1) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

53 
ab¦
::
SŒC©
("RAND_by‹ çed: ", 
Bs¦La¡E¼ÜSŒšg
()));

55  
	gStus
::
OkStus
();

58 
	gRªdomNÚûG’”©Ü
::
RªdomNÚûG’”©Ü
(
size_t
 
size
è: 
nÚû_size_
(size) {}

	@crypto/random_nonce_generator.cc

19 
	~"asylo/üy±o/¿ndom_nÚû_g’”©Ü.h
"

21 
	~<İ’s¦/¿nd.h
>

23 
	~<c¡dšt
>

24 
	~<memÜy
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/üy±o/ut/bs¦_ut.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
cÚ¡ex´
 
size_t
 
	gkAesGcmNÚûSize
 = 12;

37 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
>

38 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
() {

39  
ab¦
::
W¿pUnique
<
RªdomNÚûG’”©Ü
>(

40 
Ãw
 
RªdomNÚûG’”©Ü
(
kAesGcmNÚûSize
));

43 
size_t
 
	gRªdomNÚûG’”©Ü
::
NÚûSize
(ècÚ¡ {  
nÚû_size_
; }

45 
Stus
 
	gRªdomNÚûG’”©Ü
::
NextNÚû
(
ab¦
::
S·n
<
ušt8_t
> 
nÚû
) {

46 ià(
nÚû
.
size
(è< 
nÚû_size_
) {

47  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

48 
ab¦
::
SŒC©
("Inv®id veùÜ…¬am‘” size: ", 
nÚû
.
size
(),

49 " (veùÜ sizmu¡ b>ğ", 
nÚû_size_
, ")"));

51 ià(
RAND_by‹s
(
nÚû
.
d©a
(), 
nÚû_size_
) != 1) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

53 
ab¦
::
SŒC©
("RAND_by‹ çed: ", 
Bs¦La¡E¼ÜSŒšg
()));

55  
	gStus
::
OkStus
();

58 
	gRªdomNÚûG’”©Ü
::
RªdomNÚûG’”©Ü
(
size_t
 
size
è: 
nÚû_size_
(size) {}

	@crypto/random_nonce_generator.h

19 #iâdeà
ASYLO_CRYPTO_RANDOM_NONCE_GENERATOR_H_


20 
	#ASYLO_CRYPTO_RANDOM_NONCE_GENERATOR_H_


	)

22 
	~<c¡dšt
>

23 
	~<memÜy
>

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/üy±o/nÚû_g’”©Ü_š‹rçû.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

34 şas 
	cRªdomNÚûG’”©Ü
 : 
public
 
NÚûG’”©ÜIÁ”çû
 {

35 
public
:

37 
¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
> 
C»©eAesGcmNÚûG’”©Ü
();

41 
size_t
 
NÚûSize
(ècÚ¡ 
	gov”ride
;

43 
Stus
 
NextNÚû
(
ab¦
::
S·n
<
ušt8_t
> 
nÚû
è
ov”ride
;

45 
	g´iv©e
:

47 
RªdomNÚûG’”©Ü
(
size_t
 
size
);

50 cÚ¡ 
size_t
 
	gnÚû_size_
;

	@crypto/random_nonce_generator_test.cc

19 
	~"asylo/üy±o/¿ndom_nÚû_g’”©Ü.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

26 
	~"ab¦/¡ršgs/¡r_još.h
"

27 
	~"ab¦/ty³s/¥ª.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
Te¡
;

35 
cÚ¡ex´
 
size_t
 
	gkAesGcmNÚûSize
 = 12;

36 
cÚ¡ex´
 
size_t
 
	gkBadNÚûSize
 = 11;

37 
cÚ¡ex´
 
size_t
 
	gkNÚûP¬tSize
 = 4;

38 
cÚ¡ex´
 
size_t
 
	gkNumb”OfG’”©edNÚûs
 = 21;

41 
TEST
(
RªdomNÚûG’”©ÜTe¡
, 
RªdomNÚûG’”©ÜNÚûSize
) {

42 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
> 
nÚû_g’”©Ü
 =

43 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
();

44 
EXPECT_EQ
(
nÚû_g’”©Ü
->
NÚûSize
(), 
kAesGcmNÚûSize
);

48 
TEST
(
RªdomNÚûG’”©ÜTe¡
, 
RªdomNÚûG’”©ÜG’”©esNoCŞlisiÚs
) {

62 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
> 
nÚû_g’”©Ü
 =

63 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
();

64 
	g¡d
::
veùÜ
<
ušt8_t
> 
nÚû
(
kAesGcmNÚûSize
);

65 
	gab¦
::
æ©_hash_£t
<
¡d
::
¡ršg
> 
g’”©ed_nÚûs
;

66 
	gi
 = 0; i < 
	gkNumb”OfG’”©edNÚûs
; i++) {

67 
ASYLO_ASSERT_OK
(
nÚû_g’”©Ü
->
NextNÚû
(
ab¦
::
MakeS·n
(
nÚû
)));

68 
	gj
 = 0; j < 
	gkAesGcmNÚûSize
; j +ğ
kNÚûP¬tSize
) {

69 
EXPECT_TRUE
(

70 
g’”©ed_nÚûs


71 .
em¶aû
(
nÚû
.
cbegš
(è+ 
j
,‚Úû.cbegš(è+ j + 
kNÚûP¬tSize
)

72 .
£cÚd
);

79 
TEST
(
RªdomNÚûG’”©ÜTe¡
, 
RªdomNÚûG’”©ÜIncÜ»ùNÚûSize
) {

80 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
> 
nÚû_g’”©Ü
 =

81 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
();

82 
	g¡d
::
veùÜ
<
ušt8_t
> 
nÚû
(
kBadNÚûSize
);

83 
EXPECT_THAT
(
nÚû_g’”©Ü
->
NextNÚû
(
ab¦
::
MakeS·n
(
nÚû
)),

84 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

	@crypto/random_nonce_generator_test.cc

19 
	~"asylo/üy±o/¿ndom_nÚû_g’”©Ü.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

26 
	~"ab¦/¡ršgs/¡r_još.h
"

27 
	~"ab¦/ty³s/¥ª.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
Te¡
;

35 
cÚ¡ex´
 
size_t
 
	gkAesGcmNÚûSize
 = 12;

36 
cÚ¡ex´
 
size_t
 
	gkBadNÚûSize
 = 11;

37 
cÚ¡ex´
 
size_t
 
	gkNÚûP¬tSize
 = 4;

38 
cÚ¡ex´
 
size_t
 
	gkNumb”OfG’”©edNÚûs
 = 21;

41 
TEST
(
RªdomNÚûG’”©ÜTe¡
, 
RªdomNÚûG’”©ÜNÚûSize
) {

42 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
> 
nÚû_g’”©Ü
 =

43 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
();

44 
EXPECT_EQ
(
nÚû_g’”©Ü
->
NÚûSize
(), 
kAesGcmNÚûSize
);

48 
TEST
(
RªdomNÚûG’”©ÜTe¡
, 
RªdomNÚûG’”©ÜG’”©esNoCŞlisiÚs
) {

62 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
> 
nÚû_g’”©Ü
 =

63 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
();

64 
	g¡d
::
veùÜ
<
ušt8_t
> 
nÚû
(
kAesGcmNÚûSize
);

65 
	gab¦
::
æ©_hash_£t
<
¡d
::
¡ršg
> 
g’”©ed_nÚûs
;

66 
	gi
 = 0; i < 
	gkNumb”OfG’”©edNÚûs
; i++) {

67 
ASYLO_ASSERT_OK
(
nÚû_g’”©Ü
->
NextNÚû
(
ab¦
::
MakeS·n
(
nÚû
)));

68 
	gj
 = 0; j < 
	gkAesGcmNÚûSize
; j +ğ
kNÚûP¬tSize
) {

69 
EXPECT_TRUE
(

70 
g’”©ed_nÚûs


71 .
em¶aû
(
nÚû
.
cbegš
(è+ 
j
,‚Úû.cbegš(è+ j + 
kNÚûP¬tSize
)

72 .
£cÚd
);

79 
TEST
(
RªdomNÚûG’”©ÜTe¡
, 
RªdomNÚûG’”©ÜIncÜ»ùNÚûSize
) {

80 
	g¡d
::
unique_±r
<
RªdomNÚûG’”©Ü
> 
nÚû_g’”©Ü
 =

81 
RªdomNÚûG’”©Ü
::
C»©eAesGcmNÚûG’”©Ü
();

82 
	g¡d
::
veùÜ
<
ušt8_t
> 
nÚû
(
kBadNÚûSize
);

83 
EXPECT_THAT
(
nÚû_g’”©Ü
->
NextNÚû
(
ab¦
::
MakeS·n
(
nÚû
)),

84 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

	@crypto/rsa_oaep_encryption_key.cc

19 
	~"asylo/üy±o/r§_ß•_’üy±iÚ_key.h
"

21 
	~<İ’s¦/bio.h
>

22 
	~<İ’s¦/bn.h
>

23 
	~<İ’s¦/³m.h
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

27 
	~"asylo/üy±o/asymm‘ric_’üy±iÚ_key.h
"

28 
	~"asylo/üy±o/ut/bs¦_ut.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

30 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
RSA
>> 
C»©eR§Key
(
numb”_of_b™s
) {

37 
bs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

38 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
e
(
BN_Ãw
());

40 ià(!
BN_£t_wÜd
(
e
.
g‘
(), 
RSA_F4
) ||

41 !
RSA_g’”©e_key_ex
(
r§
.
g‘
(), 
numb”_of_b™s
, 
e
.get(),

42  
nuÎ±r
)) {

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

45  
	g¡d
::
move
(
r§
);

48 
Asymm‘ricEnüy±iÚScheme
 
G‘Asymm‘ricEnüy±iÚScheme
(
numb”_of_b™s
) {

49 
	gnumb”_of_b™s
) {

51  
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
;

53  
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
;

55  
Asymm‘ricEnüy±iÚScheme
::
UNKNOWN_ASYMMETRIC_ENCRYPTION_SCHEME
;

59 
Stus
 
CheckKeySize
(
key_size
) {

60 ià(
	gkey_size
 !ğ2048 && 
key_size
 != 3072) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("Inv®id key size: ", 
key_size
));

64  
	gStus
::
OkStus
();

69 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>>

70 
R§O«pEnüy±iÚKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

72 
bs¦
::
UniquePŒ
<
RSA
> 
public_key
(

73 
RSA_public_key_äom_by‹s
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

74 ià(!
	gpublic_key
) {

75  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

77 
ASYLO_RETURN_IF_ERROR
(
CheckKeySize
(
RSA_b™s
(
public_key
.
g‘
())));

79  
C»©e
(
¡d
::
move
(
public_key
));

82 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>>

83 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
By‹CÚš”V›w
 
£rŸlized_key
) {

85 
bs¦
::
UniquePŒ
<
BIO
> 
key_bio
(

86 
BIO_Ãw_mem_buf
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

90 
	gbs¦
::
UniquePŒ
<
RSA
> 
public_key
(
PEM_»ad_bio_RSA_PUBKEY
(

91 
key_bio
.
g‘
(), 
nuÎ±r
,‚ullptr,‚ullptr));

92 ià(!
	gpublic_key
) {

93  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

95 
ASYLO_RETURN_IF_ERROR
(
CheckKeySize
(
RSA_b™s
(
public_key
.
g‘
())));

97  
C»©e
(
¡d
::
move
(
public_key
));

100 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>> R§O«pEnüy±iÚKey::
C»©e
(

101 
bs¦
::
UniquePŒ
<
RSA
> 
public_key
) {

102 cÚ¡ 
BIGNUM
 *
n
;

103 cÚ¡ 
BIGNUM
 *
	ge
;

104 
RSA_g‘0_key
(
public_key
.
g‘
(), &
n
, &
e
, 
nuÎ±r
);

105 ià(
	gn
 =ğ
nuÎ±r
 || 
e
 ==‚ullptr) {

106  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

110  
	gab¦
::
W¿pUnique
<
R§O«pEnüy±iÚKey
>(

111 
Ãw
 
R§O«pEnüy±iÚKey
(
¡d
::
move
(
public_key
)));

114 cÚ¡ 
RSA
 *
	gR§O«pEnüy±iÚKey
::
G‘R§PublicKey
() const {

115  
public_key_
.
g‘
();

118 
Asymm‘ricEnüy±iÚScheme
 
	gR§O«pEnüy±iÚKey
::
G‘Enüy±iÚScheme
() const {

119  
G‘Asymm‘ricEnüy±iÚScheme
(
RSA_b™s
(
public_key_
.
g‘
()));

122 
	gStusOr
<
	g¡d
::
¡ršg
> 
R§O«pEnüy±iÚKey
::
S”ŸlizeToD”
() const {

123 
ušt8_t
 *
bufãr
 = 
nuÎ±r
;

124 
size_t
 
	gout_Ën
;

125 ià(
RSA_public_key_to_by‹s
(&
bufãr
, &
out_Ën
, 
public_key_
.
g‘
()) != 1) {

126  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

128 
	gbs¦
::
UniquePŒ
<
ušt8_t
> 
d–‘”
(
bufãr
);

129  
	gCİyToBy‹CÚš”
<
	g¡d
::
¡ršg
>({
bufãr
, 
	gout_Ën
});

132 
Stus
 
	gR§O«pEnüy±iÚKey
::
Enüy±
(
By‹CÚš”V›w
 
¶aš‹xt
,

133 
¡d
::
veùÜ
<
ušt8_t
> *
ch”‹xt
) const {

134 
size_t
 
out_Ën
;

135 
	gch”‹xt
->
»size
(
RSA_size
(
public_key_
.
g‘
()));

136 ià(
RSA_’üy±
(
public_key_
.
g‘
(), &
out_Ën
, 
ch”‹xt
->
d©a
(),

137 
ch”‹xt
->
size
(), 
¶aš‹xt
.
d©a
(),…laintext.size(),

138 
RSA_PKCS1_OAEP_PADDING
) != 1) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

141 
	gch”‹xt
->
»size
(
out_Ën
);

142  
	gStus
::
OkStus
();

145 
	gR§O«pEnüy±iÚKey
::
R§O«pEnüy±iÚKey
(
bs¦
::
UniquePŒ
<
RSA
> 
public_key
)

146 : 
public_key_
(
¡d
::
move
(
public_key
)) {}

148 
StusOr
<
¡d
::
unique_±r
<
R§O«pDeüy±iÚKey
>>

149 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
() {

150 
bs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key
(
RSA_Ãw
());

151 
ASYLO_ASSIGN_OR_RETURN
(
´iv©e_key
, 
C»©eR§Key
( 3072));

152  
	gab¦
::
W¿pUnique
<
R§O«pDeüy±iÚKey
>(

153 
Ãw
 
R§O«pDeüy±iÚKey
(
¡d
::
move
(
´iv©e_key
)));

156 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pDeüy±iÚKey
>>

157 
R§O«pDeüy±iÚKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

159 
bs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key
(

160 
RSA_´iv©e_key_äom_by‹s
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

161 ià(!
	g´iv©e_key
) {

162  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

164 
ASYLO_RETURN_IF_ERROR
(
CheckKeySize
(
RSA_b™s
(
´iv©e_key
.
g‘
())));

166  
	gab¦
::
W¿pUnique
<
R§O«pDeüy±iÚKey
>(

167 
Ãw
 
R§O«pDeüy±iÚKey
(
¡d
::
move
(
´iv©e_key
)));

170 
Asymm‘ricEnüy±iÚScheme
 
	gR§O«pDeüy±iÚKey
::
G‘Enüy±iÚScheme
() const {

171  
G‘Asymm‘ricEnüy±iÚScheme
(
RSA_b™s
(
´iv©e_key_
.
g‘
()));

174 
Stus
 
	gR§O«pDeüy±iÚKey
::
S”ŸlizeToD”
(

175 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
) const {

176 
ušt8_t
 *
bufãr
 = 
nuÎ±r
;

177 
size_t
 
	gout_Ën
;

178 ià(
RSA_´iv©e_key_to_by‹s
(&
bufãr
, &
out_Ën
, 
´iv©e_key_
.
g‘
()) != 1) {

179  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

181 
	gbs¦
::
UniquePŒ
<
ušt8_t
> 
d–‘”
(
bufãr
);

182 
	g£rŸlized_key
->
assign
(
bufãr
, bufã¸+ 
out_Ën
);

183  
	gStus
::
OkStus
();

186 
	gStusOr
<
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
>>

187 
R§O«pDeüy±iÚKey
::
G‘Enüy±iÚKey
() const {

188 
bs¦
::
UniquePŒ
<
RSA
> 
public_key_cİy
(
RSAPublicKey_dup
(
´iv©e_key_
.
g‘
()));

189 ià(!
	gpublic_key_cİy
) {

190  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

192  
	gR§O«pEnüy±iÚKey
::
C»©e
(
¡d
::
move
(
public_key_cİy
));

195 
Stus
 
	gR§O«pDeüy±iÚKey
::
Deüy±
(

196 
By‹CÚš”V›w
 
ch”‹xt
, 
CËªsšgVeùÜ
<
ušt8_t
> *
¶aš‹xt
) const {

197 
size_t
 
	gout_Ën
;

198 
	g¶aš‹xt
->
»size
(
RSA_size
(
´iv©e_key_
.
g‘
()));

199 ià(
RSA_deüy±
(
´iv©e_key_
.
g‘
(), &
out_Ën
, 
¶aš‹xt
->
d©a
(),

200 
¶aš‹xt
->
size
(), 
ch”‹xt
.
d©a
(), ciphertext.size(),

201 
RSA_PKCS1_OAEP_PADDING
) != 1) {

202  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

204 
	g¶aš‹xt
->
»size
(
out_Ën
);

205  
	gStus
::
OkStus
();

208 
	gR§O«pDeüy±iÚKey
::
R§O«pDeüy±iÚKey
(
bs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key
)

209 : 
´iv©e_key_
(
¡d
::
move
(
´iv©e_key
)) {}

	@crypto/rsa_oaep_encryption_key.cc

19 
	~"asylo/üy±o/r§_ß•_’üy±iÚ_key.h
"

21 
	~<İ’s¦/bio.h
>

22 
	~<İ’s¦/bn.h
>

23 
	~<İ’s¦/³m.h
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

27 
	~"asylo/üy±o/asymm‘ric_’üy±iÚ_key.h
"

28 
	~"asylo/üy±o/ut/bs¦_ut.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

30 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
RSA
>> 
C»©eR§Key
(
numb”_of_b™s
) {

37 
bs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

38 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
e
(
BN_Ãw
());

40 ià(!
BN_£t_wÜd
(
e
.
g‘
(), 
RSA_F4
) ||

41 !
RSA_g’”©e_key_ex
(
r§
.
g‘
(), 
numb”_of_b™s
, 
e
.get(),

42  
nuÎ±r
)) {

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

45  
	g¡d
::
move
(
r§
);

48 
Asymm‘ricEnüy±iÚScheme
 
G‘Asymm‘ricEnüy±iÚScheme
(
numb”_of_b™s
) {

49 
	gnumb”_of_b™s
) {

51  
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
;

53  
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
;

55  
Asymm‘ricEnüy±iÚScheme
::
UNKNOWN_ASYMMETRIC_ENCRYPTION_SCHEME
;

59 
Stus
 
CheckKeySize
(
key_size
) {

60 ià(
	gkey_size
 !ğ2048 && 
key_size
 != 3072) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("Inv®id key size: ", 
key_size
));

64  
	gStus
::
OkStus
();

69 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>>

70 
R§O«pEnüy±iÚKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

72 
bs¦
::
UniquePŒ
<
RSA
> 
public_key
(

73 
RSA_public_key_äom_by‹s
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

74 ià(!
	gpublic_key
) {

75  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

77 
ASYLO_RETURN_IF_ERROR
(
CheckKeySize
(
RSA_b™s
(
public_key
.
g‘
())));

79  
C»©e
(
¡d
::
move
(
public_key
));

82 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>>

83 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
By‹CÚš”V›w
 
£rŸlized_key
) {

85 
bs¦
::
UniquePŒ
<
BIO
> 
key_bio
(

86 
BIO_Ãw_mem_buf
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

90 
	gbs¦
::
UniquePŒ
<
RSA
> 
public_key
(
PEM_»ad_bio_RSA_PUBKEY
(

91 
key_bio
.
g‘
(), 
nuÎ±r
,‚ullptr,‚ullptr));

92 ià(!
	gpublic_key
) {

93  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

95 
ASYLO_RETURN_IF_ERROR
(
CheckKeySize
(
RSA_b™s
(
public_key
.
g‘
())));

97  
C»©e
(
¡d
::
move
(
public_key
));

100 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>> R§O«pEnüy±iÚKey::
C»©e
(

101 
bs¦
::
UniquePŒ
<
RSA
> 
public_key
) {

102 cÚ¡ 
BIGNUM
 *
n
;

103 cÚ¡ 
BIGNUM
 *
	ge
;

104 
RSA_g‘0_key
(
public_key
.
g‘
(), &
n
, &
e
, 
nuÎ±r
);

105 ià(
	gn
 =ğ
nuÎ±r
 || 
e
 ==‚ullptr) {

106  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

110  
	gab¦
::
W¿pUnique
<
R§O«pEnüy±iÚKey
>(

111 
Ãw
 
R§O«pEnüy±iÚKey
(
¡d
::
move
(
public_key
)));

114 cÚ¡ 
RSA
 *
	gR§O«pEnüy±iÚKey
::
G‘R§PublicKey
() const {

115  
public_key_
.
g‘
();

118 
Asymm‘ricEnüy±iÚScheme
 
	gR§O«pEnüy±iÚKey
::
G‘Enüy±iÚScheme
() const {

119  
G‘Asymm‘ricEnüy±iÚScheme
(
RSA_b™s
(
public_key_
.
g‘
()));

122 
	gStusOr
<
	g¡d
::
¡ršg
> 
R§O«pEnüy±iÚKey
::
S”ŸlizeToD”
() const {

123 
ušt8_t
 *
bufãr
 = 
nuÎ±r
;

124 
size_t
 
	gout_Ën
;

125 ià(
RSA_public_key_to_by‹s
(&
bufãr
, &
out_Ën
, 
public_key_
.
g‘
()) != 1) {

126  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

128 
	gbs¦
::
UniquePŒ
<
ušt8_t
> 
d–‘”
(
bufãr
);

129  
	gCİyToBy‹CÚš”
<
	g¡d
::
¡ršg
>({
bufãr
, 
	gout_Ën
});

132 
Stus
 
	gR§O«pEnüy±iÚKey
::
Enüy±
(
By‹CÚš”V›w
 
¶aš‹xt
,

133 
¡d
::
veùÜ
<
ušt8_t
> *
ch”‹xt
) const {

134 
size_t
 
out_Ën
;

135 
	gch”‹xt
->
»size
(
RSA_size
(
public_key_
.
g‘
()));

136 ià(
RSA_’üy±
(
public_key_
.
g‘
(), &
out_Ën
, 
ch”‹xt
->
d©a
(),

137 
ch”‹xt
->
size
(), 
¶aš‹xt
.
d©a
(),…laintext.size(),

138 
RSA_PKCS1_OAEP_PADDING
) != 1) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

141 
	gch”‹xt
->
»size
(
out_Ën
);

142  
	gStus
::
OkStus
();

145 
	gR§O«pEnüy±iÚKey
::
R§O«pEnüy±iÚKey
(
bs¦
::
UniquePŒ
<
RSA
> 
public_key
)

146 : 
public_key_
(
¡d
::
move
(
public_key
)) {}

148 
StusOr
<
¡d
::
unique_±r
<
R§O«pDeüy±iÚKey
>>

149 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
() {

150 
bs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key
(
RSA_Ãw
());

151 
ASYLO_ASSIGN_OR_RETURN
(
´iv©e_key
, 
C»©eR§Key
( 3072));

152  
	gab¦
::
W¿pUnique
<
R§O«pDeüy±iÚKey
>(

153 
Ãw
 
R§O«pDeüy±iÚKey
(
¡d
::
move
(
´iv©e_key
)));

156 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pDeüy±iÚKey
>>

157 
R§O«pDeüy±iÚKey
::
C»©eFromD”
(
By‹CÚš”V›w
 
£rŸlized_key
) {

159 
bs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key
(

160 
RSA_´iv©e_key_äom_by‹s
(
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()));

161 ià(!
	g´iv©e_key
) {

162  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

164 
ASYLO_RETURN_IF_ERROR
(
CheckKeySize
(
RSA_b™s
(
´iv©e_key
.
g‘
())));

166  
	gab¦
::
W¿pUnique
<
R§O«pDeüy±iÚKey
>(

167 
Ãw
 
R§O«pDeüy±iÚKey
(
¡d
::
move
(
´iv©e_key
)));

170 
Asymm‘ricEnüy±iÚScheme
 
	gR§O«pDeüy±iÚKey
::
G‘Enüy±iÚScheme
() const {

171  
G‘Asymm‘ricEnüy±iÚScheme
(
RSA_b™s
(
´iv©e_key_
.
g‘
()));

174 
Stus
 
	gR§O«pDeüy±iÚKey
::
S”ŸlizeToD”
(

175 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
) const {

176 
ušt8_t
 *
bufãr
 = 
nuÎ±r
;

177 
size_t
 
	gout_Ën
;

178 ià(
RSA_´iv©e_key_to_by‹s
(&
bufãr
, &
out_Ën
, 
´iv©e_key_
.
g‘
()) != 1) {

179  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

181 
	gbs¦
::
UniquePŒ
<
ušt8_t
> 
d–‘”
(
bufãr
);

182 
	g£rŸlized_key
->
assign
(
bufãr
, bufã¸+ 
out_Ën
);

183  
	gStus
::
OkStus
();

186 
	gStusOr
<
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
>>

187 
R§O«pDeüy±iÚKey
::
G‘Enüy±iÚKey
() const {

188 
bs¦
::
UniquePŒ
<
RSA
> 
public_key_cİy
(
RSAPublicKey_dup
(
´iv©e_key_
.
g‘
()));

189 ià(!
	gpublic_key_cİy
) {

190  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

192  
	gR§O«pEnüy±iÚKey
::
C»©e
(
¡d
::
move
(
public_key_cİy
));

195 
Stus
 
	gR§O«pDeüy±iÚKey
::
Deüy±
(

196 
By‹CÚš”V›w
 
ch”‹xt
, 
CËªsšgVeùÜ
<
ušt8_t
> *
¶aš‹xt
) const {

197 
size_t
 
	gout_Ën
;

198 
	g¶aš‹xt
->
»size
(
RSA_size
(
´iv©e_key_
.
g‘
()));

199 ià(
RSA_deüy±
(
´iv©e_key_
.
g‘
(), &
out_Ën
, 
¶aš‹xt
->
d©a
(),

200 
¶aš‹xt
->
size
(), 
ch”‹xt
.
d©a
(), ciphertext.size(),

201 
RSA_PKCS1_OAEP_PADDING
) != 1) {

202  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

204 
	g¶aš‹xt
->
»size
(
out_Ën
);

205  
	gStus
::
OkStus
();

208 
	gR§O«pDeüy±iÚKey
::
R§O«pDeüy±iÚKey
(
bs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key
)

209 : 
´iv©e_key_
(
¡d
::
move
(
´iv©e_key
)) {}

	@crypto/rsa_oaep_encryption_key.h

19 #iâdeà
ASYLO_CRYPTO_RSA_OAEP_ENCRYPTION_KEY_H_


20 
	#ASYLO_CRYPTO_RSA_OAEP_ENCRYPTION_KEY_H_


	)

22 
	~<İ’s¦/ba£.h
>

23 
	~<İ’s¦/r§.h
>

25 
	~<c¡dšt
>

26 
	~<memÜy
>

27 
	~<¡ršg
>

28 
	~<veùÜ
>

30 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

31 
	~"asylo/üy±o/asymm‘ric_’üy±iÚ_key.h
"

32 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

33 
	~"asylo/ut/¡©us.h
"

34 
	~"asylo/ut/¡©usÜ.h
"

36 
Çme¥aû
 
	gasylo
 {

53 şas 
	cR§O«pEnüy±iÚKey
 : 
public
 
Asymm‘ricEnüy±iÚKey
 {

54 
public
:

57 
StusOr
<
¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>> 
C»©eFromD”
(

58 
By‹CÚš”V›w
 
£rŸlized_key
);

62 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>> 
C»©eFromPem
(

63 
By‹CÚš”V›w
 
£rŸlized_key
);

66 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
>> 
C»©e
(

67 
bs¦
::
UniquePŒ
<
RSA
> 
public_key
);

69 cÚ¡ 
RSA
 *
G‘R§PublicKey
() const;

73 
Asymm‘ricEnüy±iÚScheme
 
G‘Enüy±iÚScheme
(ècÚ¡ 
	gov”ride
;

75 
	gStusOr
<
	g¡d
::
¡ršg
> 
S”ŸlizeToD”
(ècÚ¡ 
ov”ride
;

77 
Stus
 
Enüy±
(
By‹CÚš”V›w
 
¶aš‹xt
,

78 
¡d
::
veùÜ
<
ušt8_t
> *
ch”‹xt
ècÚ¡ 
ov”ride
;

80 
	g´iv©e
:

81 
R§O«pEnüy±iÚKey
(
bs¦
::
UniquePŒ
<
RSA
> 
public_key
);

84 
	gbs¦
::
UniquePŒ
<
RSA
> 
public_key_
;

89 şas 
	cR§O«pDeüy±iÚKey
 : 
public
 
Asymm‘ricDeüy±iÚKey
 {

90 
public
:

93 
StusOr
<
¡d
::
unique_±r
<
R§O«pDeüy±iÚKey
>>

94 
C»©eR§3072O«pDeüy±iÚKey
();

98 
	gStusOr
<
	g¡d
::
unique_±r
<
R§O«pDeüy±iÚKey
>> 
C»©eFromD”
(

99 
By‹CÚš”V›w
 
£rŸlized_key
);

103 
Asymm‘ricEnüy±iÚScheme
 
G‘Enüy±iÚScheme
(ècÚ¡ 
	gov”ride
;

105 
Stus
 
S”ŸlizeToD”
(

106 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
ècÚ¡ 
	gov”ride
;

108 
	gStusOr
<
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
>> 
G‘Enüy±iÚKey
()

109 cÚ¡ 
ov”ride
;

111 
Stus
 
Deüy±
(
By‹CÚš”V›w
 
ch”‹xt
,

112 
CËªsšgVeùÜ
<
ušt8_t
> *
¶aš‹xt
ècÚ¡ 
	gov”ride
;

114 
	g´iv©e
:

115 
R§O«pDeüy±iÚKey
(
bs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key
);

118 
	gbs¦
::
UniquePŒ
<
RSA
> 
´iv©e_key_
;

	@crypto/rsa_oaep_encryption_key_test.cc

19 
	~"asylo/üy±o/r§_ß•_’üy±iÚ_key.h
"

21 
	~<İ’s¦/ba£.h
>

22 
	~<İ’s¦/bn.h
>

23 
	~<İ’s¦/r§.h
>

25 
	~<c¡dšt
>

26 
	~<memÜy
>

27 
	~<¡ršg
>

28 
	~<veùÜ
>

30 
	~<gmock/gmock.h
>

31 
	~<g‹¡/g‹¡.h
>

32 
	~"ab¦/¡ršgs/esÿpšg.h
"

33 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

34 
	~"asylo/üy±o/asymm‘ric_’üy±iÚ_key.h
"

35 
	~"asylo/üy±o/ut/bs¦_ut.h
"

36 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

38 
	~"asylo/ut/ş—nsšg_ty³s.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

43 
	gusšg
 ::
‹¡šg
::
Eq
;

44 
	gusšg
 ::
‹¡šg
::
Te¡
;

46 
cÚ¡ex´
 
	gkPÏš‹xt
[] = "secret message";

48 
cÚ¡ex´
 
	gkR§3072PublicKeyPem
[] =

49 
R
"(-----BEGIN PUBLIC KEY-----

50 
MIIBojANBgkqhkiG9w0BAQEFAAOCAY8AMIIBigKCAYEAvxMDugH2cYvUWzjQhSgR


51 
D4nT5Gj
/2d2
NHK3eZ52hzOfwn7Rv7PvNIzKWZWsI0SWäOyZ3cZvuqRLvuUp3ouk


52 
NPBfTMDGd6aUXK1U8ujgIIrSIY
/
Xq88tKoh3b63TuTgaMZuQhe
+
Yi5ME
/
JVMsHuc


53 
SiY9SmCNJSLWJbNDnY8tM²MLo027EN7gBIPšTQJK6IeqDkdsoxFXuydpC367bJ


54 
qYSWSEbEgRpzrs4UUgdVMBc
/
fJU9zRqB50pFcVzbccFaB7XYiqZŒdqU07eÜbpd


55 
XINBBPFdãPByVdiUW6zfsxf8eUXLVXk9TioF1MqcJcVuHMndry2Ç28vQG9ZNH4


56 
GÌb332S4
+
gfHYOTv5PJxL‹IrWfyR¡WxzuegpUcmrGSjgrMdjcuUOJjCnDJ2bW


57 0
r0UE9um8JQodJKpILtTpq1rV
+
Ql£UPu90ZID3OTk5PSÃ6NtJe7bN
+9
WeJ¥QO


58 
C5xYNu944AfU3z0ºYRx0fEkiáBTiuÄAioOA5jMQFHAgMBAAE
=

59 -----
END
 
PUBLIC
 
KEY
-----)";

61 
cÚ¡ex´
 
kR§2048PublicKeyPem
[] =

62 
R
"(-----BEGIN PUBLIC KEY-----

63 
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA¿SmrCLtäx6PegYeGCP


64 
GlsUG¿a26UrykBj0Aw88oX´3TivLoC1w2SQúg0
+
DKL93dJGqxp1if02YUdc1b


65 
TibUpVc6NqofTXOn68üKeGw8QVh
+
l5VtgÄ655yzNFJzu6F4bV64KdaZizsAzPR


66 
bd5US
+
MHlUB8cB18dQUOKxp
+
Glyi2ßJ9gzX3hr6nBScdwjGXmJFI68zd663CmLq


67 
JH9MvEnvHx8vG9znVVDZH1FmDXoDabt5nBFJUNroQ0q9kyoOGgmR1zkybMMdup92


68 
HvoTOkINnS7okRbyÅM
/
XwC
+
qCMW
+
xVoJ1kQrwNeVikds7T9LG010j2RszY
/86
Z
+

69 
LwIDAQAB


70 -----
END
 
PUBLIC
 
KEY
-----)";

72 
cÚ¡ex´
 
kR§1024PublicKeyPem
[] =

73 
R
"(-----BEGIN PUBLIC KEY-----

74 
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDYnYrGRm3xBDGNiviKgWg7LgNß


75 
EjkU18VTqQidk2
/
Fywd2ZM
/
fk2sKNaY4zy
/9
RTaLeC8zrErqPoztQ8ETuVfgYZ
/+3

76 
j11zrxTT4MUeI4YTtYGP6XYEi2noWbP9Ui1t
+
r9vvdfuB19JdZCyYjEMHwby4Aifo


77 
iUUOItX7JXuQTSQIDAQAB


78 -----
END
 
PUBLIC
 
KEY
-----)";

80 
cÚ¡ex´
 
kBadPublicKeyPem
[] =

81 
R
"(-----BEGIN PUBLIC KEY-----

82 
MIIBojANBgkqhkiG9w0BAQEFAAOCAY8AMIIBigKCAYEAvxMDugH2cYvUWzjQhSgR


83 -----
END
 
PUBLIC
 
KEY
-----)";

85 
cÚ¡ex´
 
kR§1024Priv©eKeyD”
[] =

104 
cÚ¡ex´
 
ušt8_t
 
	gkBadKey
[] = "bad key";

106 
V”ifyEnüy±iÚDeüy±iÚSucûss
(

107 cÚ¡ 
Asymm‘ricEnüy±iÚKey
 &
’üy±iÚ_key
,

108 cÚ¡ 
Asymm‘ricDeüy±iÚKey
 &
deüy±iÚ_key
) {

109 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
;

110 
ASYLO_ASSERT_OK
(
’üy±iÚ_key
.
Enüy±
(
kPÏš‹xt
, &
ch”‹xt
));

111 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g¶aš‹xt
;

112 
ASYLO_ASSERT_OK
(
deüy±iÚ_key
.
Deüy±
(
ch”‹xt
, &
¶aš‹xt
));

113 
	g¡d
::
¡ršg
 
deüy±ed_‹xt
 =

114 
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>({
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
()});

115 
EXPECT_THAT
(
deüy±ed_‹xt
, 
Eq
(
kPÏš‹xt
));

118 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡C»©eFromPemS”Ÿliz©iÚSucûss
) {

119 
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
> 
’üy±iÚ_key
;

120 
ASYLO_ASSERT_OK_AND_ASSIGN
(

121 
’üy±iÚ_key
,

122 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§3072PublicKeyPem
));

123 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
;

124 
ASYLO_ASSERT_OK
(
’üy±iÚ_key
->
Enüy±
(
kPÏš‹xt
, &
ch”‹xt
));

127 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡G‘Asymm‘ricEnüy±iÚKeySchemeO«p3072
) {

128 
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
> 
’üy±iÚ_key
;

129 
ASYLO_ASSERT_OK_AND_ASSIGN
(

130 
’üy±iÚ_key
,

131 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§3072PublicKeyPem
));

132 
EXPECT_THAT
(
RSA_b™s
(
’üy±iÚ_key
->
G‘R§PublicKey
()), 
Eq
(3072));

133 
EXPECT_THAT
(
’üy±iÚ_key
->
G‘Enüy±iÚScheme
(),

134 
Eq
(
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
));

137 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡G‘Asymm‘ricEnüy±iÚKeySchemeO«p2048
) {

138 
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
> 
’üy±iÚ_key
;

139 
ASYLO_ASSERT_OK_AND_ASSIGN
(

140 
’üy±iÚ_key
,

141 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§2048PublicKeyPem
));

142 
EXPECT_THAT
(
RSA_b™s
(
’üy±iÚ_key
->
G‘R§PublicKey
()), 
Eq
(2048));

143 
EXPECT_THAT
(
’üy±iÚ_key
->
G‘Enüy±iÚScheme
(),

144 
Eq
(
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
));

147 
TEST
(
R§O«pEnüy±iÚKeyTe¡
,

148 
Te¡C»©eAsymm‘ricEnüy±iÚKeyW™hInv®idSizeFas
) {

149 
EXPECT_THAT
(

150 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§1024PublicKeyPem
).
¡©us
(),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid key size: 1024"));

154 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡C»©eFromInv®idPemS”Ÿliz©iÚFas
) {

155 
EXPECT_THAT
(
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kBadPublicKeyPem
).
¡©us
(),

156 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

159 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Deüy±Inv®idIÅutFas
) {

160 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

161 
ASYLO_ASSERT_OK_AND_ASSIGN
(

162 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

164 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

165 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

166 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

167 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
;

168 
ASYLO_ASSERT_OK
(
’üy±iÚ_key
->
Enüy±
(
kPÏš‹xt
, &
ch”‹xt
));

171 
	gch”‹xt
[0] ^= 1;

172 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g¶aš‹xt
;

173 
EXPECT_THAT
(
deüy±iÚ_key
->
Deüy±
(
ch”‹xt
, &
¶aš‹xt
),

174 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

177 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Enüy±Deüy±Sucûss
) {

178 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

179 
ASYLO_ASSERT_OK_AND_ASSIGN
(

180 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

182 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

183 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

184 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

186 
V”ifyEnüy±iÚDeüy±iÚSucûss
(*
’üy±iÚ_key
, *
deüy±iÚ_key
);

189 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Enüy±iÚKeyS”ŸlizeAndRe¡ÜeSucûss
) {

190 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

191 
ASYLO_ASSERT_OK_AND_ASSIGN
(

192 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

194 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

195 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

196 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

198 
	g¡d
::
¡ršg
 
£rŸlized_key
;

199 
ASYLO_ASSERT_OK_AND_ASSIGN
(
£rŸlized_key
, 
’üy±iÚ_key
->
S”ŸlizeToD”
());

200 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
»¡Üed_’üy±iÚ_key
;

201 
ASYLO_ASSERT_OK_AND_ASSIGN
(

202 
»¡Üed_’üy±iÚ_key
,

203 
R§O«pEnüy±iÚKey
::
C»©eFromD”
(
£rŸlized_key
));

205 
V”ifyEnüy±iÚDeüy±iÚSucûss
(*
»¡Üed_’üy±iÚ_key
, *
deüy±iÚ_key
);

208 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Deüy±iÚKeyS”ŸlizeAndRe¡ÜeSucûss
) {

209 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

210 
ASYLO_ASSERT_OK_AND_ASSIGN
(

211 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

213 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

214 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

215 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

217 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key
;

218 
ASYLO_ASSERT_OK
(
deüy±iÚ_key
->
S”ŸlizeToD”
(&
£rŸlized_key
));

219 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
»¡Üed_deüy±iÚ_key
;

220 
ASYLO_ASSERT_OK_AND_ASSIGN
(

221 
»¡Üed_deüy±iÚ_key
,

222 
R§O«pDeüy±iÚKey
::
C»©eFromD”
(

223 {
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()}));

225 
V”ifyEnüy±iÚDeüy±iÚSucûss
(*
’üy±iÚ_key
, *
»¡Üed_deüy±iÚ_key
);

228 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡C»©eFromInv®idD”S”Ÿliz©iÚFas
) {

229 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

230 
EXPECT_THAT
(
R§O«pDeüy±iÚKey
::
C»©eFromD”
(
£rŸlized_key
).
¡©us
(),

231 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

234 
TEST
(
R§O«pEnüy±iÚKeyTe¡
,

235 
Te¡C»©eAsymm‘ricDeüy±iÚKeyW™hInv®idKeySizeFas
) {

236 
EXPECT_THAT
(

237 
R§O«pDeüy±iÚKey
::
C»©eFromD”
(

238 
ab¦
::
HexSŒšgToBy‹s
(
kR§1024Priv©eKeyD”
))

239 .
¡©us
(),

240 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid key size: 1024"));

	@crypto/rsa_oaep_encryption_key_test.cc

19 
	~"asylo/üy±o/r§_ß•_’üy±iÚ_key.h
"

21 
	~<İ’s¦/ba£.h
>

22 
	~<İ’s¦/bn.h
>

23 
	~<İ’s¦/r§.h
>

25 
	~<c¡dšt
>

26 
	~<memÜy
>

27 
	~<¡ršg
>

28 
	~<veùÜ
>

30 
	~<gmock/gmock.h
>

31 
	~<g‹¡/g‹¡.h
>

32 
	~"ab¦/¡ršgs/esÿpšg.h
"

33 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

34 
	~"asylo/üy±o/asymm‘ric_’üy±iÚ_key.h
"

35 
	~"asylo/üy±o/ut/bs¦_ut.h
"

36 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

38 
	~"asylo/ut/ş—nsšg_ty³s.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

43 
	gusšg
 ::
‹¡šg
::
Eq
;

44 
	gusšg
 ::
‹¡šg
::
Te¡
;

46 
cÚ¡ex´
 
	gkPÏš‹xt
[] = "secret message";

48 
cÚ¡ex´
 
	gkR§3072PublicKeyPem
[] =

49 
R
"(-----BEGIN PUBLIC KEY-----

50 
MIIBojANBgkqhkiG9w0BAQEFAAOCAY8AMIIBigKCAYEAvxMDugH2cYvUWzjQhSgR


51 
D4nT5Gj
/2d2
NHK3eZ52hzOfwn7Rv7PvNIzKWZWsI0SWäOyZ3cZvuqRLvuUp3ouk


52 
NPBfTMDGd6aUXK1U8ujgIIrSIY
/
Xq88tKoh3b63TuTgaMZuQhe
+
Yi5ME
/
JVMsHuc


53 
SiY9SmCNJSLWJbNDnY8tM²MLo027EN7gBIPšTQJK6IeqDkdsoxFXuydpC367bJ


54 
qYSWSEbEgRpzrs4UUgdVMBc
/
fJU9zRqB50pFcVzbccFaB7XYiqZŒdqU07eÜbpd


55 
XINBBPFdãPByVdiUW6zfsxf8eUXLVXk9TioF1MqcJcVuHMndry2Ç28vQG9ZNH4


56 
GÌb332S4
+
gfHYOTv5PJxL‹IrWfyR¡WxzuegpUcmrGSjgrMdjcuUOJjCnDJ2bW


57 0
r0UE9um8JQodJKpILtTpq1rV
+
Ql£UPu90ZID3OTk5PSÃ6NtJe7bN
+9
WeJ¥QO


58 
C5xYNu944AfU3z0ºYRx0fEkiáBTiuÄAioOA5jMQFHAgMBAAE
=

59 -----
END
 
PUBLIC
 
KEY
-----)";

61 
cÚ¡ex´
 
kR§2048PublicKeyPem
[] =

62 
R
"(-----BEGIN PUBLIC KEY-----

63 
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA¿SmrCLtäx6PegYeGCP


64 
GlsUG¿a26UrykBj0Aw88oX´3TivLoC1w2SQúg0
+
DKL93dJGqxp1if02YUdc1b


65 
TibUpVc6NqofTXOn68üKeGw8QVh
+
l5VtgÄ655yzNFJzu6F4bV64KdaZizsAzPR


66 
bd5US
+
MHlUB8cB18dQUOKxp
+
Glyi2ßJ9gzX3hr6nBScdwjGXmJFI68zd663CmLq


67 
JH9MvEnvHx8vG9znVVDZH1FmDXoDabt5nBFJUNroQ0q9kyoOGgmR1zkybMMdup92


68 
HvoTOkINnS7okRbyÅM
/
XwC
+
qCMW
+
xVoJ1kQrwNeVikds7T9LG010j2RszY
/86
Z
+

69 
LwIDAQAB


70 -----
END
 
PUBLIC
 
KEY
-----)";

72 
cÚ¡ex´
 
kR§1024PublicKeyPem
[] =

73 
R
"(-----BEGIN PUBLIC KEY-----

74 
MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDYnYrGRm3xBDGNiviKgWg7LgNß


75 
EjkU18VTqQidk2
/
Fywd2ZM
/
fk2sKNaY4zy
/9
RTaLeC8zrErqPoztQ8ETuVfgYZ
/+3

76 
j11zrxTT4MUeI4YTtYGP6XYEi2noWbP9Ui1t
+
r9vvdfuB19JdZCyYjEMHwby4Aifo


77 
iUUOItX7JXuQTSQIDAQAB


78 -----
END
 
PUBLIC
 
KEY
-----)";

80 
cÚ¡ex´
 
kBadPublicKeyPem
[] =

81 
R
"(-----BEGIN PUBLIC KEY-----

82 
MIIBojANBgkqhkiG9w0BAQEFAAOCAY8AMIIBigKCAYEAvxMDugH2cYvUWzjQhSgR


83 -----
END
 
PUBLIC
 
KEY
-----)";

85 
cÚ¡ex´
 
kR§1024Priv©eKeyD”
[] =

104 
cÚ¡ex´
 
ušt8_t
 
	gkBadKey
[] = "bad key";

106 
V”ifyEnüy±iÚDeüy±iÚSucûss
(

107 cÚ¡ 
Asymm‘ricEnüy±iÚKey
 &
’üy±iÚ_key
,

108 cÚ¡ 
Asymm‘ricDeüy±iÚKey
 &
deüy±iÚ_key
) {

109 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
;

110 
ASYLO_ASSERT_OK
(
’üy±iÚ_key
.
Enüy±
(
kPÏš‹xt
, &
ch”‹xt
));

111 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g¶aš‹xt
;

112 
ASYLO_ASSERT_OK
(
deüy±iÚ_key
.
Deüy±
(
ch”‹xt
, &
¶aš‹xt
));

113 
	g¡d
::
¡ršg
 
deüy±ed_‹xt
 =

114 
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>({
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
()});

115 
EXPECT_THAT
(
deüy±ed_‹xt
, 
Eq
(
kPÏš‹xt
));

118 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡C»©eFromPemS”Ÿliz©iÚSucûss
) {

119 
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
> 
’üy±iÚ_key
;

120 
ASYLO_ASSERT_OK_AND_ASSIGN
(

121 
’üy±iÚ_key
,

122 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§3072PublicKeyPem
));

123 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
;

124 
ASYLO_ASSERT_OK
(
’üy±iÚ_key
->
Enüy±
(
kPÏš‹xt
, &
ch”‹xt
));

127 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡G‘Asymm‘ricEnüy±iÚKeySchemeO«p3072
) {

128 
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
> 
’üy±iÚ_key
;

129 
ASYLO_ASSERT_OK_AND_ASSIGN
(

130 
’üy±iÚ_key
,

131 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§3072PublicKeyPem
));

132 
EXPECT_THAT
(
RSA_b™s
(
’üy±iÚ_key
->
G‘R§PublicKey
()), 
Eq
(3072));

133 
EXPECT_THAT
(
’üy±iÚ_key
->
G‘Enüy±iÚScheme
(),

134 
Eq
(
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
));

137 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡G‘Asymm‘ricEnüy±iÚKeySchemeO«p2048
) {

138 
	g¡d
::
unique_±r
<
R§O«pEnüy±iÚKey
> 
’üy±iÚ_key
;

139 
ASYLO_ASSERT_OK_AND_ASSIGN
(

140 
’üy±iÚ_key
,

141 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§2048PublicKeyPem
));

142 
EXPECT_THAT
(
RSA_b™s
(
’üy±iÚ_key
->
G‘R§PublicKey
()), 
Eq
(2048));

143 
EXPECT_THAT
(
’üy±iÚ_key
->
G‘Enüy±iÚScheme
(),

144 
Eq
(
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
));

147 
TEST
(
R§O«pEnüy±iÚKeyTe¡
,

148 
Te¡C»©eAsymm‘ricEnüy±iÚKeyW™hInv®idSizeFas
) {

149 
EXPECT_THAT
(

150 
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kR§1024PublicKeyPem
).
¡©us
(),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid key size: 1024"));

154 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡C»©eFromInv®idPemS”Ÿliz©iÚFas
) {

155 
EXPECT_THAT
(
R§O«pEnüy±iÚKey
::
C»©eFromPem
(
kBadPublicKeyPem
).
¡©us
(),

156 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

159 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Deüy±Inv®idIÅutFas
) {

160 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

161 
ASYLO_ASSERT_OK_AND_ASSIGN
(

162 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

164 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

165 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

166 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

167 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
;

168 
ASYLO_ASSERT_OK
(
’üy±iÚ_key
->
Enüy±
(
kPÏš‹xt
, &
ch”‹xt
));

171 
	gch”‹xt
[0] ^= 1;

172 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g¶aš‹xt
;

173 
EXPECT_THAT
(
deüy±iÚ_key
->
Deüy±
(
ch”‹xt
, &
¶aš‹xt
),

174 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

177 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Enüy±Deüy±Sucûss
) {

178 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

179 
ASYLO_ASSERT_OK_AND_ASSIGN
(

180 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

182 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

183 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

184 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

186 
V”ifyEnüy±iÚDeüy±iÚSucûss
(*
’üy±iÚ_key
, *
deüy±iÚ_key
);

189 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Enüy±iÚKeyS”ŸlizeAndRe¡ÜeSucûss
) {

190 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

191 
ASYLO_ASSERT_OK_AND_ASSIGN
(

192 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

194 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

195 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

196 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

198 
	g¡d
::
¡ršg
 
£rŸlized_key
;

199 
ASYLO_ASSERT_OK_AND_ASSIGN
(
£rŸlized_key
, 
’üy±iÚ_key
->
S”ŸlizeToD”
());

200 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
»¡Üed_’üy±iÚ_key
;

201 
ASYLO_ASSERT_OK_AND_ASSIGN
(

202 
»¡Üed_’üy±iÚ_key
,

203 
R§O«pEnüy±iÚKey
::
C»©eFromD”
(
£rŸlized_key
));

205 
V”ifyEnüy±iÚDeüy±iÚSucûss
(*
»¡Üed_’üy±iÚ_key
, *
deüy±iÚ_key
);

208 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡Deüy±iÚKeyS”ŸlizeAndRe¡ÜeSucûss
) {

209 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
deüy±iÚ_key
;

210 
ASYLO_ASSERT_OK_AND_ASSIGN
(

211 
deüy±iÚ_key
, 
R§O«pDeüy±iÚKey
::
C»©eR§3072O«pDeüy±iÚKey
());

213 
	g¡d
::
unique_±r
<
Asymm‘ricEnüy±iÚKey
> 
’üy±iÚ_key
;

214 
ASYLO_ASSERT_OK_AND_ASSIGN
(
’üy±iÚ_key
,

215 
deüy±iÚ_key
->
G‘Enüy±iÚKey
());

217 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£rŸlized_key
;

218 
ASYLO_ASSERT_OK
(
deüy±iÚ_key
->
S”ŸlizeToD”
(&
£rŸlized_key
));

219 
	g¡d
::
unique_±r
<
Asymm‘ricDeüy±iÚKey
> 
»¡Üed_deüy±iÚ_key
;

220 
ASYLO_ASSERT_OK_AND_ASSIGN
(

221 
»¡Üed_deüy±iÚ_key
,

222 
R§O«pDeüy±iÚKey
::
C»©eFromD”
(

223 {
£rŸlized_key
.
d©a
(), s”Ÿlized_key.
size
()}));

225 
V”ifyEnüy±iÚDeüy±iÚSucûss
(*
’üy±iÚ_key
, *
»¡Üed_deüy±iÚ_key
);

228 
TEST
(
R§O«pEnüy±iÚKeyTe¡
, 
Te¡C»©eFromInv®idD”S”Ÿliz©iÚFas
) {

229 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
(
kBadKey
, kBadKey + (kBadKey));

230 
EXPECT_THAT
(
R§O«pDeüy±iÚKey
::
C»©eFromD”
(
£rŸlized_key
).
¡©us
(),

231 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

234 
TEST
(
R§O«pEnüy±iÚKeyTe¡
,

235 
Te¡C»©eAsymm‘ricDeüy±iÚKeyW™hInv®idKeySizeFas
) {

236 
EXPECT_THAT
(

237 
R§O«pDeüy±iÚKey
::
C»©eFromD”
(

238 
ab¦
::
HexSŒšgToBy‹s
(
kR§1024Priv©eKeyD”
))

239 .
¡©us
(),

240 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid key size: 1024"));

	@crypto/sha256_hash.cc

19 
	~"asylo/üy±o/sha256_hash.h
"

21 
	~<İ’s¦/sha.h
>

23 
	~"asylo/üy±o/ut/bs¦_ut.h
"

24 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gSha256Hash
::
Sha256Hash
(è{ 
In™
(); }

30 
HashAlgÜ™hm
 
	gSha256Hash
::
G‘HashAlgÜ™hm
() const {

31  
HashAlgÜ™hm
::
SHA256
;

34 
size_t
 
	gSha256Hash
::
Dige¡Size
(ècÚ¡ {  
SHA256_DIGEST_LENGTH
; }

36 
	gSha256Hash
::
In™
(è{ 
SHA256_In™
(&
cÚ‹xt_
); }

38 
	gSha256Hash
::
Upd©e
(
By‹CÚš”V›w
 
d©a
) {

39 
SHA256_Upd©e
(&
cÚ‹xt_
, 
d©a
.d©a(), d©a.
size
());

42 
Stus
 
	gSha256Hash
::
CumuÏtiveHash
(
¡d
::
veùÜ
<
ušt8_t
> *
dige¡
) const {

46 
SHA256_CTX
 
cÚ‹xt_¢­shÙ
 = 
cÚ‹xt_
;

47 
	gdige¡
->
»size
(
SHA256_DIGEST_LENGTH
);

48 ià(
SHA256_Fš®
(
dige¡
->
d©a
(), &
cÚ‹xt_¢­shÙ
) != 1) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

51  
	gStus
::
OkStus
();

	@crypto/sha256_hash.cc

19 
	~"asylo/üy±o/sha256_hash.h
"

21 
	~<İ’s¦/sha.h
>

23 
	~"asylo/üy±o/ut/bs¦_ut.h
"

24 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gSha256Hash
::
Sha256Hash
(è{ 
In™
(); }

30 
HashAlgÜ™hm
 
	gSha256Hash
::
G‘HashAlgÜ™hm
() const {

31  
HashAlgÜ™hm
::
SHA256
;

34 
size_t
 
	gSha256Hash
::
Dige¡Size
(ècÚ¡ {  
SHA256_DIGEST_LENGTH
; }

36 
	gSha256Hash
::
In™
(è{ 
SHA256_In™
(&
cÚ‹xt_
); }

38 
	gSha256Hash
::
Upd©e
(
By‹CÚš”V›w
 
d©a
) {

39 
SHA256_Upd©e
(&
cÚ‹xt_
, 
d©a
.d©a(), d©a.
size
());

42 
Stus
 
	gSha256Hash
::
CumuÏtiveHash
(
¡d
::
veùÜ
<
ušt8_t
> *
dige¡
) const {

46 
SHA256_CTX
 
cÚ‹xt_¢­shÙ
 = 
cÚ‹xt_
;

47 
	gdige¡
->
»size
(
SHA256_DIGEST_LENGTH
);

48 ià(
SHA256_Fš®
(
dige¡
->
d©a
(), &
cÚ‹xt_¢­shÙ
) != 1) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

51  
	gStus
::
OkStus
();

	@crypto/sha256_hash.h

19 #iâdeà
ASYLO_CRYPTO_SHA256_HASH_H_


20 
	#ASYLO_CRYPTO_SHA256_HASH_H_


	)

22 
	~<İ’s¦/sha.h
>

24 
	~<veùÜ
>

26 
	~"asylo/üy±o/hash_š‹rçû.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

33 şas 
	cSha256Hash
 
	gfš®
 : 
public
 
HashIÁ”çû
 {

34 
public
:

35 
Sha256Hash
();

38 
HashAlgÜ™hm
 
G‘HashAlgÜ™hm
(ècÚ¡ 
	gov”ride
;

39 
size_t
 
Dige¡Size
(ècÚ¡ 
	gov”ride
;

40 
In™
(è
	gov”ride
;

41 
Upd©e
(
By‹CÚš”V›w
 
d©a
è
	gov”ride
;

42 
Stus
 
CumuÏtiveHash
(
¡d
::
veùÜ
<
ušt8_t
> *
dige¡
ècÚ¡ 
ov”ride
;

44 
	g´iv©e
:

45 
SHA256_CTX
 
cÚ‹xt_
;

	@crypto/sha256_hash_test.cc

19 
	~"asylo/üy±o/sha256_hash.h
"

21 
	~<İ’s¦/sha.h
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/¡ršgs/esÿpšg.h
"

30 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

31 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

40 
cÚ¡ex´
 
	gkTe¡VeùÜ1
[] = "abc";

41 
cÚ¡ex´
 
	gkResuÉ1
[] =

44 
cÚ¡ex´
 
	gkTe¡VeùÜ2
[] =

46 
cÚ¡ex´
 
	gkResuÉ2
[] =

50 
cÚ¡ex´
 
	gkSuffix
[] =

53 
TEST
(
Sha256HashTe¡
, 
AlgÜ™hm
) {

54 
Sha256Hash
 
	ghash
;

55 
EXPECT_EQ
(
hash
.
G‘HashAlgÜ™hm
(), 
HashAlgÜ™hm
::
SHA256
);

58 
TEST
(
Sha256HashTe¡
, 
Dige¡Size
) {

59 
Sha256Hash
 
	ghash
;

60 
EXPECT_EQ
(
hash
.
Dige¡Size
(), 
SHA256_DIGEST_LENGTH
);

66 
TEST
(
Sha256HashTe¡
, 
Te¡VeùÜ1
) {

67 
Sha256Hash
 
	ghash
;

68 
	ghash
.
Upd©e
(
kTe¡VeùÜ1
);

69 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

70 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

71 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

72 
kResuÉ1
);

75 
TEST
(
Sha256HashTe¡
, 
Te¡VeùÜ2
) {

76 
Sha256Hash
 
	ghash
;

77 
	ghash
.
Upd©e
(
kTe¡VeùÜ2
);

78 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

79 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

80 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

81 
kResuÉ2
);

86 
TEST
(
Sha256HashTe¡
, 
In™B‘w“nUpd©es
) {

87 
Sha256Hash
 
	ghash
;

88 
	ghash
.
Upd©e
(
kTe¡VeùÜ1
);

90 
	ghash
.
In™
();

92 
	ghash
.
Upd©e
(
kTe¡VeùÜ2
);

93 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

94 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

95 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

96 
kResuÉ2
);

101 
TEST
(
Sha256HashTe¡
, 
MuÉËUpd©es
) {

102 
Sha256Hash
 
	ghash
;

103 
	ghash
.
Upd©e
(
kTe¡VeùÜ1
);

104 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

105 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

106 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

107 
kResuÉ1
);

109 
	ghash
.
Upd©e
(
kSuffix
);

110 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

111 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

112 
kResuÉ2
);

	@crypto/sha256_hash_test.cc

19 
	~"asylo/üy±o/sha256_hash.h
"

21 
	~<İ’s¦/sha.h
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/¡ršgs/esÿpšg.h
"

30 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

31 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

40 
cÚ¡ex´
 
	gkTe¡VeùÜ1
[] = "abc";

41 
cÚ¡ex´
 
	gkResuÉ1
[] =

44 
cÚ¡ex´
 
	gkTe¡VeùÜ2
[] =

46 
cÚ¡ex´
 
	gkResuÉ2
[] =

50 
cÚ¡ex´
 
	gkSuffix
[] =

53 
TEST
(
Sha256HashTe¡
, 
AlgÜ™hm
) {

54 
Sha256Hash
 
	ghash
;

55 
EXPECT_EQ
(
hash
.
G‘HashAlgÜ™hm
(), 
HashAlgÜ™hm
::
SHA256
);

58 
TEST
(
Sha256HashTe¡
, 
Dige¡Size
) {

59 
Sha256Hash
 
	ghash
;

60 
EXPECT_EQ
(
hash
.
Dige¡Size
(), 
SHA256_DIGEST_LENGTH
);

66 
TEST
(
Sha256HashTe¡
, 
Te¡VeùÜ1
) {

67 
Sha256Hash
 
	ghash
;

68 
	ghash
.
Upd©e
(
kTe¡VeùÜ1
);

69 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

70 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

71 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

72 
kResuÉ1
);

75 
TEST
(
Sha256HashTe¡
, 
Te¡VeùÜ2
) {

76 
Sha256Hash
 
	ghash
;

77 
	ghash
.
Upd©e
(
kTe¡VeùÜ2
);

78 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

79 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

80 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

81 
kResuÉ2
);

86 
TEST
(
Sha256HashTe¡
, 
In™B‘w“nUpd©es
) {

87 
Sha256Hash
 
	ghash
;

88 
	ghash
.
Upd©e
(
kTe¡VeùÜ1
);

90 
	ghash
.
In™
();

92 
	ghash
.
Upd©e
(
kTe¡VeùÜ2
);

93 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

94 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

95 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

96 
kResuÉ2
);

101 
TEST
(
Sha256HashTe¡
, 
MuÉËUpd©es
) {

102 
Sha256Hash
 
	ghash
;

103 
	ghash
.
Upd©e
(
kTe¡VeùÜ1
);

104 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

105 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

106 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

107 
kResuÉ1
);

109 
	ghash
.
Upd©e
(
kSuffix
);

110 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

111 
EXPECT_EQ
(
ab¦
::
By‹sToHexSŒšg
(
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
dige¡
)),

112 
kResuÉ2
);

	@crypto/signing_key.h

19 #iâdeà
ASYLO_CRYPTO_SIGNING_KEY_H_


20 
	#ASYLO_CRYPTO_SIGNING_KEY_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

25 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

26 
	~"asylo/ut/ş—nsšg_ty³s.h
"

27 
	~"asylo/ut/¡©us.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

33 şas 
	cV”ifyšgKey
 {

34 
	gpublic
:

35 
vœtu®
 ~
V”ifyšgKey
() = ;

38 
vœtu®
 
SigÇtu»Scheme
 
G‘SigÇtu»Scheme
() const = 0;

42 
vœtu®
 
	gStusOr
<
	g¡d
::
¡ršg
> 
S”ŸlizeToD”
() const = 0;

48 
vœtu®
 
Stus
 
V”ify
(
By‹CÚš”V›w
 
mes§ge
,

49 
By‹CÚš”V›w
 
sigÇtu»
) const = 0;

53 şas 
	cSignšgKey
 {

54 
	gpublic
:

55 
vœtu®
 ~
SignšgKey
() = ;

58 
vœtu®
 
SigÇtu»Scheme
 
G‘SigÇtu»Scheme
() const = 0;

62 
vœtu®
 
Stus
 
S”ŸlizeToD”
(

63 
CËªsšgVeùÜ
<
ušt8_t
> *
£rŸlized_key
) const = 0;

67 
vœtu®
 
	gStusOr
<
	g¡d
::
unique_±r
<
V”ifyšgKey
>> 
G‘V”ifyšgKey
() const = 0;

72 
vœtu®
 
Stus
 
Sign
(
By‹CÚš”V›w
 
mes§ge
,

73 
¡d
::
veùÜ
<
ušt8_t
> *
sigÇtu»
) const = 0;

	@crypto/util/bssl_util.cc

19 
	~"asylo/üy±o/ut/bs¦_ut.h
"

21 
	~<¡ršg
>

23 
Çme¥aû
 
	gasylo
 {

25 
	g¡d
::
¡ršg
 
Bs¦La¡E¼ÜSŒšg
() {

26 
cÚ¡ex´
 
kE¼ÜSŒšgBufãrL’gth
 = 256;

27 
	gbufãr
[
kE¼ÜSŒšgBufãrL’gth
];

28 
ERR_”rÜ_¡ršg_n
(
ERR_g‘_”rÜ
(), 
bufãr
, (buffer));

29 
ERR_ş—r_”rÜ
();

30  
	g¡d
::
¡ršg
(
bufãr
);

	@crypto/util/bssl_util.cc

19 
	~"asylo/üy±o/ut/bs¦_ut.h
"

21 
	~<¡ršg
>

23 
Çme¥aû
 
	gasylo
 {

25 
	g¡d
::
¡ršg
 
Bs¦La¡E¼ÜSŒšg
() {

26 
cÚ¡ex´
 
kE¼ÜSŒšgBufãrL’gth
 = 256;

27 
	gbufãr
[
kE¼ÜSŒšgBufãrL’gth
];

28 
ERR_”rÜ_¡ršg_n
(
ERR_g‘_”rÜ
(), 
bufãr
, (buffer));

29 
ERR_ş—r_”rÜ
();

30  
	g¡d
::
¡ršg
(
bufãr
);

	@crypto/util/bssl_util.h

19 #iâdeà
ASYLO_CRYPTO_UTIL_BSSL_UTIL_H_


20 
	#ASYLO_CRYPTO_UTIL_BSSL_UTIL_H_


	)

22 
	~<İ’s¦/”r.h
>

23 
	~<¡ršg
>

25 
Çme¥aû
 
	gasylo
 {

28 
	g¡d
::
¡ršg
 
Bs¦La¡E¼ÜSŒšg
();

	@crypto/util/byte_container_util.h

19 #iâdeà
ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_UTIL_H_


20 
	#ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_UTIL_H_


	)

22 
	~<veùÜ
>

24 
	~"asylo/üy±o/ut/by‹_cÚš”_ut_š‹º®.h
"

25 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

34 
	g‹m¶©e
 <
şass
 
	gBy‹CÚš”T
, 
	gty³Çme
... 
	gArgs
>

35 
Stus
 
Aµ’dS”ŸlizedBy‹CÚš”s
(
By‹CÚš”T
 *
£rŸlized
,

36 
Args
... 
¬gs
) {

37 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
v›ws
 =

38 
š‹º®
::
C»©eBy‹CÚš”V›wVeùÜ
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

39  
	gš‹º®
::
Aµ’dS”ŸlizedBy‹CÚš”s
(
v›ws
, 
£rŸlized
);

46 
	g‹m¶©e
 <
şass
 
	gBy‹CÚš”T
, 
	gty³Çme
... 
	gArgs
>

47 
Stus
 
S”ŸlizeBy‹CÚš”s
(
By‹CÚš”T
 *
£rŸlized
, 
Args
... 
¬gs
) {

48 
	g£rŸlized
->
ş—r
();

49 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
v›ws
 =

50 
š‹º®
::
C»©eBy‹CÚš”V›wVeùÜ
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

51  
	gš‹º®
::
Aµ’dS”ŸlizedBy‹CÚš”s
(
v›ws
, 
£rŸlized
);

60 
	g‹m¶©e
 <
şass
 
	gBy‹CÚš”T
>

61 
By‹CÚš”T
 
CİyToBy‹CÚš”
(
By‹CÚš”V›w
 
v›w
) {

62 
¡©ic_as£¹
(

63 (
ty³Çme
 
By‹CÚš”T
::
v®ue_ty³
) == 1,

65  
By‹CÚš”T
(
v›w
.
begš
(), v›w.
’d
());

72 
	g‹m¶©e
 <
şass
 
	gCÚ¡V›wT
>

73 
CÚ¡V›wT
 
MakeV›w
(
By‹CÚš”V›w
 
v›w
) {

74 
¡©ic_as£¹
((
ty³Çme
 
CÚ¡V›wT
::
v®ue_ty³
) == 1,

76  
CÚ¡V›wT
(

77 
»š‹½»t_ÿ¡
<cÚ¡ 
ty³Çme
 
CÚ¡V›wT
::
v®ue_ty³
 *>(
v›w
.
d©a
()),

78 
v›w
.
size
());

83 
šlše
 
boŞ
 
SaãCom·»By‹CÚš”s
(
By‹CÚš”V›w
 
lhs
,

84 
By‹CÚš”V›w
 
rhs
) {

85  
	glhs
.
SaãEqu®s
(
rhs
);

	@crypto/util/byte_container_util_internal.h

19 #iâdeà
ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_UTIL_INTERNAL_H_


20 
	#ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_UTIL_INTERNAL_H_


	)

22 
	~<®gÜ™hm
>

23 
	~<c¡dšt
>

24 
	~<™”©Ü
>

25 
	~<lim™s
>

26 
	~<¡ršg
>

27 
	~<veùÜ
>

29 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

30 
	~"asylo/ut/¡©us.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	gš‹º®
 {

37 
	g‹m¶©e
 <
şass
 
	gBy‹CÚš”T
>

38 
šlše
 
Aµ’dL™eEndŸnIÁ
(
size_t
 
v®ue
, 
By‹CÚš”T
 *
bufãr
) {

40 #ifdeà
__x86_64__


41 
	g¡d
::
ušt32_t
 
size
 = 
v®ue
;

42 
	g¡d
::
cİy
(
»š‹½»t_ÿ¡
<*>(&
size
),

43 
»š‹½»t_ÿ¡
<*>(&
size
 + 1), 
¡d
::
back_š£¹”
(*
bufãr
));

61 
	g‹m¶©e
 <
şass
 
	gBy‹CÚš”T
>

62 
Stus
 
Aµ’dS”ŸlizedBy‹CÚš”s
(

63 cÚ¡ 
¡d
::
veùÜ
<
By‹CÚš”V›w
> &
v›ws
, 
By‹CÚš”T
 *
£rŸlized
) {

64 
¡©ic_as£¹
((
ty³Çme
 
By‹CÚš”T
::
v®ue_ty³
) == 1,

67 cÚ¡ 
	gBy‹CÚš”V›w
 &
	gv›w
 : 
v›ws
) {

68 ià(
v›w
.
size
(è> 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
()) {

69  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

72 
	gš‹º®
::
Aµ’dL™eEndŸnIÁ
(
v›w
.
size
(), 
£rŸlized
);

73 
	g¡d
::
cİy
(
v›w
.
cbegš
(), v›w.
ûnd
(), 
¡d
::
back_š£¹”
(*
£rŸlized
));

76  
	gStus
::
OkStus
();

84 
šlše
 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
() {

85  
¡d
::
veùÜ
<
By‹CÚš”V›w
>();

88 
šlše
 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
(

89 
By‹CÚš”V›w
 
v›w
) {

90  
¡d
::
veùÜ
<
By‹CÚš”V›w
>({
v›w
});

93 
šlše
 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
(

94 
By‹CÚš”V›w
 
v›w1
, By‹CÚš”V›w 
v›w2
) {

95  
	g¡d
::
veùÜ
<
By‹CÚš”V›w
>({
v›w1
, 
	gv›w2
});

98 
šlše
 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
(

99 
By‹CÚš”V›w
 
v›w1
, By‹CÚš”V›w 
v›w2
, By‹CÚš”V›w 
v›w3
) {

100  
	g¡d
::
veùÜ
<
By‹CÚš”V›w
>({
v›w1
, 
	gv›w2
, 
	gv›w3
});

103 
šlše
 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
(

104 
By‹CÚš”V›w
 
v›w1
, By‹CÚš”V›w 
v›w2
, By‹CÚš”V›w 
v›w3
,

105 
By‹CÚš”V›w
 
v›w4
) {

106  
	g¡d
::
veùÜ
<
By‹CÚš”V›w
>({
v›w1
, 
	gv›w2
, 
	gv›w3
, 
	gv›w4
});

109 
šlše
 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
(

110 
By‹CÚš”V›w
 
v›w1
, By‹CÚš”V›w 
v›w2
, By‹CÚš”V›w 
v›w3
,

111 
By‹CÚš”V›w
 
v›w4
, By‹CÚš”V›w 
v›w5
) {

112  
	g¡d
::
veùÜ
<
By‹CÚš”V›w
>({
v›w1
, 
	gv›w2
, 
	gv›w3
, 
	gv›w4
, 
	gv›w5
});

115 
šlše
 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
(

116 
By‹CÚš”V›w
 
v›w1
, By‹CÚš”V›w 
v›w2
, By‹CÚš”V›w 
v›w3
,

117 
By‹CÚš”V›w
 
v›w4
, By‹CÚš”V›w 
v›w5
, By‹CÚš”V›w 
v›w6
) {

118  
	g¡d
::
veùÜ
<
By‹CÚš”V›w
>(

119 {
v›w1
, 
	gv›w2
, 
	gv›w3
, 
	gv›w4
, 
	gv›w5
, 
	gv›w6
});

122 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

123 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
C»©eBy‹CÚš”V›wVeùÜ
(

124 
By‹CÚš”V›w
 
v›w1
, By‹CÚš”V›w 
v›w2
, By‹CÚš”V›w 
v›w3
,

125 
By‹CÚš”V›w
 
v›w4
, By‹CÚš”V›w 
v›w5
, By‹CÚš”V›w 
v›w6
,

126 
Args
... 
¬gs
) {

127 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
vec1
 =

128 
C»©eBy‹CÚš”V›wVeùÜ
(
v›w1
, 
v›w2
, 
v›w3
, 
v›w4
, 
v›w5
, 
v›w6
);

129 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
vec2
 =

130 
C»©eBy‹CÚš”V›wVeùÜ
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

131 
	gvec1
.
»£rve
(
vec1
.
size
(è+ 
vec2
.size());

132 cÚ¡‡utØ&
	gv›w
 : 
vec2
) {

133 
vec1
.
em¶aû_back
(
v›w
);

135  
	gvec1
;

	@crypto/util/byte_container_util_test.cc

19 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

28 
	~"ab¦/ty³s/¥ª.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
cÚ¡ex´
 
	gkSŒ1
[] = "foo";

37 
cÚ¡ex´
 
	gkSŒ2
[] = "bar";

38 
cÚ¡ex´
 
	gkSŒ3
[] = "baz";

39 
cÚ¡ex´
 
	gkSŒ4
[] = "foobar";

42 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

43 şas 
	cBy‹CÚš”UtTy³dTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

47 
ušt32_t
 
EncodeL™eEndŸn
(
size_t
 
v®ue
) {

48 #ifdeà
__x86_64__


49  
	gv®ue
;

56 ::
‹¡šg
::
	tTy³s
<
	t¡d
::
	t¡ršg
, std::
	tveùÜ
<
	tušt8_t
>, std::string,

57 
	tCËªsšgSŒšg
, 
	tCËªsšgVeùÜ
<
	tušt8_t
>>

58 
	tOuutTy³s
;

60 
TYPED_TEST_SUITE
(
By‹CÚš”UtTy³dTe¡
, 
OuutTy³s
);

63 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
Em±yS”Ÿliz©iÚ
) {

64 
Ty³P¬am
 
ouut
(
kSŒ4
, kStr4 + (kStr4) - 1);

65 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut
), 
IsOk
());

66 
EXPECT_EQ
(0, 
ouut
.
size
());

71 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
Em±yS”Ÿliz©iÚAµ’d
) {

72 
Ty³P¬am
 
ouut
(
kSŒ4
, kStr4 + (kStr4) - 1);

73 
EXPECT_THAT
(
Aµ’dS”ŸlizedBy‹CÚš”s
(&
ouut
), 
IsOk
());

74 
EXPECT_EQ
(
By‹CÚš”V›w
(
kSŒ4
), (
ouut
));

79 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
S”Ÿliz©iÚCÚšsAÎBy‹CÚš”s
) {

80 
Ty³P¬am
 
	gouut1
;

81 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut1
, 
kSŒ1
, 
kSŒ2
, 
kSŒ3
), 
IsOk
());

83 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
šputs
 = {
kSŒ1
, 
kSŒ2
, 
kSŒ3
};

84 
	gšdex
 = 0;

85 cÚ¡‡utØ&
	gšput
 : 
šputs
) {

86 
ušt32_t
 
size
 = 
EncodeL™eEndŸn
(
šput
.size());

87 
ASSERT_EQ
(0, 
memcmp
(
ouut1
.
d©a
(è+ 
šdex
, &
size
, (size)));

88 
	gšdex
 +ğ(
size
);

89 
EXPECT_EQ
(0, 
memcmp
(
ouut1
.
d©a
(è+ 
šdex
, 
šput
.d©a(), 
size
));

90 
	gšdex
 +ğ
size
;

93 
Ty³P¬am
 
	gouut2
;

94 cÚ¡‡utØ&
	gšput
 : 
šputs
) {

95 
EXPECT_THAT
(
Aµ’dS”ŸlizedBy‹CÚš”s
(&
ouut2
, 
šput
), 
IsOk
());

99 
EXPECT_EQ
(
By‹CÚš”V›w
(
ouut1
), By‹CÚš”V›w(
ouut2
));

104 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
S”ŸlizeL¬geNumb”OfIÅuts
) {

105 
Ty³P¬am
 
	gouut1
;

106 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut1
, 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
,

107 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
, kStr1, kStr2,

108 
kSŒ3
, 
kSŒ4
, 
kSŒ1
, 
kSŒ2
, kStr3, kStr4),

109 
IsOk
());

111 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
šputs
 = {

112 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
, kStr1, kStr2, kStr3, kStr4,

113 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
, kStr1, kStr2, kStr3, kStr4};

115 
Ty³P¬am
 
	gouut2
;

116 cÚ¡‡utØ&
	gšput
 : 
šputs
) {

117 
EXPECT_THAT
(
Aµ’dS”ŸlizedBy‹CÚš”s
(&
ouut2
, 
šput
), 
IsOk
());

121 
EXPECT_EQ
(
By‹CÚš”V›w
(
ouut1
), By‹CÚš”V›w(
ouut2
));

126 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
S”Ÿliz©iÚsA»Unique
) {

127 
Ty³P¬am
 
	gouut1
;

128 
Ty³P¬am
 
	gouut2
;

131 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut1
, 
kSŒ1
, 
kSŒ2
, 
kSŒ3
), 
IsOk
());

134 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut2
, 
kSŒ4
, 
kSŒ3
), 
IsOk
());

137 
EXPECT_NE
(
By‹CÚš”V›w
(
ouut1
), By‹CÚš”V›w(
ouut2
));

141 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
CİyToBy‹CÚš”
) {

142 
Ty³P¬am
 
	gcÚš”
 = 
CİyToBy‹CÚš”
<Ty³P¬am>(
kSŒ1
);

143 
EXPECT_EQ
(
By‹CÚš”V›w
(
cÚš”
), By‹CÚš”V›w(
kSŒ1
));

146 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
SaãCom·»Pos™ive
) {

147 
Ty³P¬am
 
cÚš”
(
kSŒ1
, kStr1 + (kStr1) - 1);

148 
EXPECT_TRUE
(
SaãCom·»By‹CÚš”s
(
cÚš”
, 
kSŒ1
));

151 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
SaãCom·»Neg©ive
) {

152 
Ty³P¬am
 
cÚš”
(
kSŒ1
, kStr1 + (kStr1) - 1);

153 
EXPECT_FALSE
(
SaãCom·»By‹CÚš”s
(
cÚš”
, 
kSŒ2
));

156 
TEST
(
By‹CÚš”UtTe¡
, 
MakeSŒšgV›w
) {

157 
	gab¦
::
¡ršg_v›w
 
v›w1
 = 
MakeV›w
<
ab¦
::¡ršg_v›w>(
kSŒ1
);

158 
	gab¦
::
¡ršg_v›w
 
v›w2
(
kSŒ1
);

160 
EXPECT_EQ
(
v›w1
.
d©a
(), 
v›w2
.data());

161 
EXPECT_EQ
(
v›w1
.
size
(), 
v›w2
.size());

164 
TEST
(
By‹CÚš”UtTe¡
, 
MakeS·n
) {

165 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a
 =

166 
CİyToBy‹CÚš”
<
¡d
::
veùÜ
<
ušt8_t
>>(
kSŒ1
);

167 autØ
	g¥ª1
 = 
MakeV›w
<
ab¦
::
S·n
<cÚ¡ 
ušt8_t
>>(
d©a
);

168 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
¥ª2
(
d©a
);

170 
EXPECT_EQ
(
¥ª1
.
d©a
(), 
¥ª2
.data());

171 
EXPECT_EQ
(
¥ª1
.
size
(), 
¥ª2
.size());

	@crypto/util/byte_container_util_test.cc

19 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

28 
	~"ab¦/ty³s/¥ª.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
cÚ¡ex´
 
	gkSŒ1
[] = "foo";

37 
cÚ¡ex´
 
	gkSŒ2
[] = "bar";

38 
cÚ¡ex´
 
	gkSŒ3
[] = "baz";

39 
cÚ¡ex´
 
	gkSŒ4
[] = "foobar";

42 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

43 şas 
	cBy‹CÚš”UtTy³dTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

47 
ušt32_t
 
EncodeL™eEndŸn
(
size_t
 
v®ue
) {

48 #ifdeà
__x86_64__


49  
	gv®ue
;

56 ::
‹¡šg
::
	tTy³s
<
	t¡d
::
	t¡ršg
, std::
	tveùÜ
<
	tušt8_t
>, std::string,

57 
	tCËªsšgSŒšg
, 
	tCËªsšgVeùÜ
<
	tušt8_t
>>

58 
	tOuutTy³s
;

60 
TYPED_TEST_SUITE
(
By‹CÚš”UtTy³dTe¡
, 
OuutTy³s
);

63 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
Em±yS”Ÿliz©iÚ
) {

64 
Ty³P¬am
 
ouut
(
kSŒ4
, kStr4 + (kStr4) - 1);

65 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut
), 
IsOk
());

66 
EXPECT_EQ
(0, 
ouut
.
size
());

71 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
Em±yS”Ÿliz©iÚAµ’d
) {

72 
Ty³P¬am
 
ouut
(
kSŒ4
, kStr4 + (kStr4) - 1);

73 
EXPECT_THAT
(
Aµ’dS”ŸlizedBy‹CÚš”s
(&
ouut
), 
IsOk
());

74 
EXPECT_EQ
(
By‹CÚš”V›w
(
kSŒ4
), (
ouut
));

79 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
S”Ÿliz©iÚCÚšsAÎBy‹CÚš”s
) {

80 
Ty³P¬am
 
	gouut1
;

81 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut1
, 
kSŒ1
, 
kSŒ2
, 
kSŒ3
), 
IsOk
());

83 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
šputs
 = {
kSŒ1
, 
kSŒ2
, 
kSŒ3
};

84 
	gšdex
 = 0;

85 cÚ¡‡utØ&
	gšput
 : 
šputs
) {

86 
ušt32_t
 
size
 = 
EncodeL™eEndŸn
(
šput
.size());

87 
ASSERT_EQ
(0, 
memcmp
(
ouut1
.
d©a
(è+ 
šdex
, &
size
, (size)));

88 
	gšdex
 +ğ(
size
);

89 
EXPECT_EQ
(0, 
memcmp
(
ouut1
.
d©a
(è+ 
šdex
, 
šput
.d©a(), 
size
));

90 
	gšdex
 +ğ
size
;

93 
Ty³P¬am
 
	gouut2
;

94 cÚ¡‡utØ&
	gšput
 : 
šputs
) {

95 
EXPECT_THAT
(
Aµ’dS”ŸlizedBy‹CÚš”s
(&
ouut2
, 
šput
), 
IsOk
());

99 
EXPECT_EQ
(
By‹CÚš”V›w
(
ouut1
), By‹CÚš”V›w(
ouut2
));

104 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
S”ŸlizeL¬geNumb”OfIÅuts
) {

105 
Ty³P¬am
 
	gouut1
;

106 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut1
, 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
,

107 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
, kStr1, kStr2,

108 
kSŒ3
, 
kSŒ4
, 
kSŒ1
, 
kSŒ2
, kStr3, kStr4),

109 
IsOk
());

111 
	g¡d
::
veùÜ
<
By‹CÚš”V›w
> 
šputs
 = {

112 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
, kStr1, kStr2, kStr3, kStr4,

113 
kSŒ1
, 
kSŒ2
, 
kSŒ3
, 
kSŒ4
, kStr1, kStr2, kStr3, kStr4};

115 
Ty³P¬am
 
	gouut2
;

116 cÚ¡‡utØ&
	gšput
 : 
šputs
) {

117 
EXPECT_THAT
(
Aµ’dS”ŸlizedBy‹CÚš”s
(&
ouut2
, 
šput
), 
IsOk
());

121 
EXPECT_EQ
(
By‹CÚš”V›w
(
ouut1
), By‹CÚš”V›w(
ouut2
));

126 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
S”Ÿliz©iÚsA»Unique
) {

127 
Ty³P¬am
 
	gouut1
;

128 
Ty³P¬am
 
	gouut2
;

131 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut1
, 
kSŒ1
, 
kSŒ2
, 
kSŒ3
), 
IsOk
());

134 
EXPECT_THAT
(
S”ŸlizeBy‹CÚš”s
(&
ouut2
, 
kSŒ4
, 
kSŒ3
), 
IsOk
());

137 
EXPECT_NE
(
By‹CÚš”V›w
(
ouut1
), By‹CÚš”V›w(
ouut2
));

141 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
CİyToBy‹CÚš”
) {

142 
Ty³P¬am
 
	gcÚš”
 = 
CİyToBy‹CÚš”
<Ty³P¬am>(
kSŒ1
);

143 
EXPECT_EQ
(
By‹CÚš”V›w
(
cÚš”
), By‹CÚš”V›w(
kSŒ1
));

146 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
SaãCom·»Pos™ive
) {

147 
Ty³P¬am
 
cÚš”
(
kSŒ1
, kStr1 + (kStr1) - 1);

148 
EXPECT_TRUE
(
SaãCom·»By‹CÚš”s
(
cÚš”
, 
kSŒ1
));

151 
TYPED_TEST
(
By‹CÚš”UtTy³dTe¡
, 
SaãCom·»Neg©ive
) {

152 
Ty³P¬am
 
cÚš”
(
kSŒ1
, kStr1 + (kStr1) - 1);

153 
EXPECT_FALSE
(
SaãCom·»By‹CÚš”s
(
cÚš”
, 
kSŒ2
));

156 
TEST
(
By‹CÚš”UtTe¡
, 
MakeSŒšgV›w
) {

157 
	gab¦
::
¡ršg_v›w
 
v›w1
 = 
MakeV›w
<
ab¦
::¡ršg_v›w>(
kSŒ1
);

158 
	gab¦
::
¡ršg_v›w
 
v›w2
(
kSŒ1
);

160 
EXPECT_EQ
(
v›w1
.
d©a
(), 
v›w2
.data());

161 
EXPECT_EQ
(
v›w1
.
size
(), 
v›w2
.size());

164 
TEST
(
By‹CÚš”UtTe¡
, 
MakeS·n
) {

165 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a
 =

166 
CİyToBy‹CÚš”
<
¡d
::
veùÜ
<
ušt8_t
>>(
kSŒ1
);

167 autØ
	g¥ª1
 = 
MakeV›w
<
ab¦
::
S·n
<cÚ¡ 
ušt8_t
>>(
d©a
);

168 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
¥ª2
(
d©a
);

170 
EXPECT_EQ
(
¥ª1
.
d©a
(), 
¥ª2
.data());

171 
EXPECT_EQ
(
¥ª1
.
size
(), 
¥ª2
.size());

	@crypto/util/byte_container_view.h

19 #iâdeà
ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_VIEW_H_


20 
	#ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_VIEW_H_


	)

22 
	~<İ’s¦/mem.h
>

23 
	~<¡ršg.h
>

24 
	~<c¡dšt
>

25 
	~<c¡dlib
>

26 
	~<™”©Ü
>

27 
	~<ty³_Œa™s
>

29 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

30 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w_š‹º®.h
"

31 
	~"asylo/ut/loggšg.h
"

33 
Çme¥aû
 
	gasylo
 {

65 şas 
	cBy‹CÚš”V›w
 {

66 
	gpublic
:

67 
usšg
 
v®ue_ty³
 = cÚ¡ 
ušt8_t
;

68 
usšg
 
	gcÚ¡_™”©Ü
 = cÚ¡ 
ušt8_t
 *;

69 
usšg
 
	gcÚ¡_»v”£_™”©Ü
 = 
¡d
::
»v”£_™”©Ü
<
cÚ¡_™”©Ü
>;

70 
usšg
 
	g™”©Ü
 = 
cÚ¡_™”©Ü
;

71 
usšg
 
	g»v”£_™”©Ü
 = 
cÚ¡_»v”£_™”©Ü
;

73 
By‹CÚš”V›w
(èğ
d–‘e
;

75 
By‹CÚš”V›w
(cÚ¡ *
d©a
, 
size_t
 
size
)

76 : 
d©a_
{
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
d©a
)}, 
	gsize_
{
	gsize
} {}

78 
By‹CÚš”V›w
(
ab¦
::
¡ršg_v›w
 
v
)

79 : 
d©a_
{
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
v
.
d©a
())}, 
	gsize_
{
	gv
.
size
()} {}

81 
By‹CÚš”V›w
(cÚ¡ *
c¡r
)

82 : 
d©a_
{
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
c¡r
)},

83 
	gsize_
{
	gc¡r
 ? 
¡¾’
(
c¡r
) : 0} {}

85 
‹m¶©e
 <

86 
ty³Çme
 
By‹CÚš”T
,

87 
ty³Çme
 
	gE
 =y³Çm
¡d
::
’abË_if
<

88 
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
By‹CÚš”T
>::
v®ue
>::
ty³
>

89 
By‹CÚš”V›w
(cÚ¡ 
By‹CÚš”T
 &
cÚš”
)

90 : 
d©a_
{
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
cÚš”
.
d©a
())},

91 
	gsize_
{
	gcÚš”
.
size
()} {}

93 cÚ¡ 
ušt8_t
 *
d©a
(ècÚ¡ {  
	gd©a_
; }

94 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

95 
boŞ
 
em±y
(ècÚ¡ {  
	gsize_
 == 0; }

97 
cÚ¡_™”©Ü
 
begš
(ècÚ¡ {  
	gd©a_
; }

98 
cÚ¡_™”©Ü
 
’d
(ècÚ¡ {  
	gd©a_
 + 
	gsize_
; }

99 
cÚ¡_™”©Ü
 
cbegš
(ècÚ¡ {  
	gd©a_
; }

100 
cÚ¡_™”©Ü
 
ûnd
(ècÚ¡ {  
	gd©a_
 + 
	gsize_
; }

102 
cÚ¡_»v”£_™”©Ü
 
rbegš
() const {

103  
cÚ¡_»v”£_™”©Ü
(
’d
());

105 
cÚ¡_»v”£_™”©Ü
 
»nd
() const {

106  
cÚ¡_»v”£_™”©Ü
(
begš
());

108 
cÚ¡_»v”£_™”©Ü
 
übegš
() const {

109  
cÚ¡_»v”£_™”©Ü
(
ûnd
());

111 
cÚ¡_»v”£_™”©Ü
 
ü’d
() const {

112  
cÚ¡_»v”£_™”©Ü
(
cbegš
());

117 cÚ¡ 
	gušt8_t
 &
	gİ”©Ü
[](
size_t
 
	goff£t
ècÚ¡ {  
	gd©a_
[
off£t
]; }

121 cÚ¡ 
	gušt8_t
 &
©
(
size_t
 
off£t
) const {

122 ià(
	goff£t
 >ğ
size_
) {

123 
LOG
(
FATAL
) << "Index out of bounds.";

125  
	gd©a_
[
off£t
];

130 cÚ¡ 
	gušt8_t
 &
äÚt
(ècÚ¡ {  
	gd©a_
[0]; }

134 cÚ¡ 
	gušt8_t
 &
back
(ècÚ¡ {  
	gd©a_
[
size_
 - 1]; }

138 
boŞ
 
	gİ”©Ü
==(
By‹CÚš”V›w
 
Ùh”
) const {

139  (
size_
 =ğ
Ùh”
.size_è&& (
memcmp
(
d©a_
, other.data_, size_) == 0);

144 
boŞ
 
	gİ”©Ü
!=(
By‹CÚš”V›w
 
Ùh”
ècÚ¡ {  !
İ”©Ü
==(other); }

149 
boŞ
 
SaãEqu®s
(
By‹CÚš”V›w
 
Ùh”
) const {

150  (
	gsize_
 =ğ
Ùh”
.
size_
) &&

151 (
CRYPTO_memcmp
(
d©a_
, 
Ùh”
.d©a_, 
size_
) == 0);

154 
	g´iv©e
:

155 cÚ¡ 
ušt8_t
 *
d©a_
;

156 
size_t
 
	gsize_
;

	@crypto/util/byte_container_view_internal.h

19 #iâdeà
ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_VIEW_INTERNAL_H_


20 
	#ASYLO_CRYPTO_UTIL_BYTE_CONTAINER_VIEW_INTERNAL_H_


	)

22 
	~<ty³_Œa™s
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gš‹º®
 {

31 
	g‹m¶©e
 <
ty³Çme
 
	gBy‹CÚš”T
>

32 
	sis_ro_by‹_cÚš”_ty³
 {

33 
	g´iv©e
:

37 
‹m¶©e
 <
ty³Çme
 
By‹CÚš”U
,

38 
ty³Çme
 
	gE
 =y³Çm
¡d
::
’abË_if
<

39 (
ty³Çme
 
By‹CÚš”U
::
v®ue_ty³
è=ğ1>::
ty³
>

40 
¡d
::
Œue_ty³
 
CheckSize
(cÚ¡ 
By‹CÚš”U
 *
u
);

44 
	g‹m¶©e
 <
ty³Çme
 
	gBy‹CÚš”U
>

45 
	g¡d
::
çl£_ty³
 
CheckSize
(...);

47 
usšg
 
	gsize_ty³
 = 
deşty³
(

48 
CheckSize
<
By‹CÚš”T
>(
¡©ic_ÿ¡
<const ByteContainerT *>(0)));

53 
	g‹m¶©e
 <
ty³Çme
 
	gBy‹CÚš”U
>

54 autØ
CheckApi
(cÚ¡ 
By‹CÚš”U
 *
u
)

55 -> 
deşty³
(
u
->
d©a
(), u->
size
(), u->
begš
(), u->
’d
(), u->
cbegš
(),

56 
u
->
ûnd
(), u->
rbegš
(), u->
»nd
(), u->
übegš
(), u->
ü’d
(),

57 
u
->
©
(0), u->
İ”©Ü
[](0),

58 
ty³Çme
 
By‹CÚš”U
::
™”©Ü
(),

59 
ty³Çme
 
By‹CÚš”U
::
cÚ¡_™”©Ü
(),

60 
ty³Çme
 
By‹CÚš”U
::
»v”£_™”©Ü
(),

61 
ty³Çme
 
By‹CÚš”U
::
cÚ¡_»v”£_™”©Ü
(),

62 
¡d
::
Œue_ty³
());

67 
	g‹m¶©e
 <
ty³Çme
 
	gBy‹CÚš”U
>

68 
	g¡d
::
çl£_ty³
 
CheckApi
(...);

70 
usšg
 
	g­i_ty³
 = 
deşty³
(

71 
CheckApi
<
By‹CÚš”T
>(
¡©ic_ÿ¡
<const ByteContainerT *>(0)));

73 
	gpublic
:

74 
cÚ¡ex´
 
boŞ
 
v®ue
 = 
­i_ty³
::v®u& 
size_ty³
::value;

	@crypto/util/byte_container_view_test.cc

19 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

21 
	~<™”©Ü
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w_š‹º®.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

30 
	~"asylo/ut/¡©us.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
	gkD©a1
[] =

37 
cÚ¡ex´
 
size_t
 
	gkSize1
 = (
kD©a1
) - 1;

38 
cÚ¡ex´
 
	gkD©a2
[] = "Mary had‡ big…ig,‡nd it had‚o fleece";

41 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

42 şas 
	cTy³dBy‹CÚš”V›wTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

43 
public
:

46 ::
‹¡šg
::
	tTy³s
<
	tSaãBy‹s
<
	tkSize1
>, 
	tUn§ãBy‹s
<kSize1>,

47 
	t¡d
::
	tveùÜ
<
	tušt8_t
>, std::veùÜ<>, std::
	t¡ršg
,

48 
	t¡d
::
	tbasic_¡ršg
<
	tušt8_t
, std::
	tch¬_Œa™s
<uint8_t>>>

49 
	tMyTy³s
;

50 
TYPED_TEST_SUITE
(
Ty³dBy‹CÚš”V›wTe¡
, 
MyTy³s
);

52 
TYPED_TEST
(
Ty³dBy‹CÚš”V›wTe¡
, 
D©aM‘hod
) {

53 
Ty³P¬am
 
cÚš”
(
kD©a1
, kD©a1 + 
kSize1
);

54 
By‹CÚš”V›w
 
v›w
(
cÚš”
);

56 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(
v›w
.
d©a
()),

57 
¡©ic_ÿ¡
<cÚ¡ *>(
cÚš”
.
d©a
()));

60 
TYPED_TEST
(
Ty³dBy‹CÚš”V›wTe¡
, 
SizeM‘hod
) {

61 
Ty³P¬am
 
cÚš”
(
kD©a1
, kD©a1 + 
kSize1
);

62 
By‹CÚš”V›w
 
v›w
(
cÚš”
);

64 
EXPECT_EQ
(
v›w
.
size
(), 
cÚš”
.size());

72 
TEST
(
By‹CÚš”V›wTe¡
, 
V”ifyT¿™sCÜ»ùÃss
) {

73 
¡©ic_as£¹
(

74 
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
By‹CÚš”V›w
>::
v®ue
,

76 
¡©ic_as£¹
(
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
¡d
::
¡ršg
>::
v®ue
,

78 
¡©ic_as£¹
(

79 
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
¡d
::
veùÜ
<
ušt8_t
>>::
v®ue
,

81 
¡©ic_as£¹
(

82 !
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
¡d
::
veùÜ
<
ušt32_t
>>::
v®ue
,

85 
¡©ic_as£¹
(!
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
Stus
>::
v®ue
,

89 
TEST
(
By‹CÚš”V›wTe¡
, 
Em±yM‘hodPos™ive
) {

90 
EXPECT_TRUE
(
By‹CÚš”V›w
("").
em±y
());

93 
TEST
(
By‹CÚš”V›wTe¡
, 
Em±yM‘hodNeg©ive
) {

94 
EXPECT_FALSE
(
By‹CÚš”V›w
(
kD©a1
).
em±y
());

97 
TEST
(
By‹CÚš”V›wTe¡
, 
SubsütO³¿tÜ
) {

98 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

100 
	gi
 = 0; i < 
	gv›w
.
size
(); i++) {

101 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&
v›w
[
i
]),

102 
¡©ic_ÿ¡
<cÚ¡ *>(&
kD©a1
[
i
]));

106 
TEST
(
By‹CÚš”V›wTe¡
, 
AtM‘hod
) {

107 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

109 
	gi
 = 0; i < 
	gv›w
.
size
(); i++) {

110 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&
v›w
.
©
(
i
)),

111 
¡©ic_ÿ¡
<cÚ¡ *>(&
kD©a1
[
i
]));

115 
TEST
(
By‹CÚš”V›wTe¡
, 
FrÚtM‘hod
) {

116 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

118 autØ
	g±r
 = &
v›w
.
äÚt
();

119 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(
±r
), stic_ÿ¡<cÚ¡ *>(
kD©a1
));

120 
EXPECT_EQ
(
v›w
.
äÚt
(), 
¡d
::
¡ršg
(
kD©a1
).front());

123 
TEST
(
By‹CÚš”V›wTe¡
, 
BackM‘hod
) {

124 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

126 autØ
	g±r
 = &
v›w
.
back
();

127 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(
±r
),

128 
¡©ic_ÿ¡
<cÚ¡ *>(
kD©a1
 + 
kSize1
 - 1));

129 
EXPECT_EQ
(
v›w
.
back
(), 
¡d
::
¡ršg
(
kD©a1
).back());

132 
TEST
(
By‹CÚš”V›wTe¡
, 
I‹¿tÜ
) {

133 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

134 autØ
	g™1
 = 
v›w
.
begš
();

135 cÚ¡ *
	g™2
 = 
kD©a1
;

137 
	g™1
 !ğ
v›w
.
’d
()) {

138 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

139 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

140 ++
	g™1
;

141 ++
	g™2
;

145 
TEST
(
By‹CÚš”V›wTe¡
, 
CÚ¡I‹¿tÜ
) {

146 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

147 autØ
	g™1
 = 
v›w
.
cbegš
();

148 cÚ¡ *
	g™2
 = 
kD©a1
;

150 
	g™1
 !ğ
v›w
.
ûnd
()) {

151 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

152 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

153 ++
	g™1
;

154 ++
	g™2
;

158 
TEST
(
By‹CÚš”V›wTe¡
, 
Rev”£I‹¿tÜ
) {

159 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

160 autØ
	g™1
 = 
v›w
.
rbegš
();

161 autØ
	g™2
 = 
¡d
::
»v”£_™”©Ü
<cÚ¡ *>(&
kD©a1
[
kSize1
]);

163 
	g™1
 !ğ
v›w
.
»nd
()) {

164 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

165 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

166 ++
	g™1
;

167 ++
	g™2
;

171 
TEST
(
By‹CÚš”V›wTe¡
, 
CÚ¡Rev”£I‹¿tÜ
) {

172 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

173 autØ
	g™1
 = 
v›w
.
übegš
();

174 autØ
	g™2
 = 
¡d
::
»v”£_™”©Ü
<cÚ¡ *>(&
kD©a1
[
kSize1
]);

176 
	g™1
 !ğ
v›w
.
ü’d
()) {

177 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

178 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

179 ++
	g™1
;

180 ++
	g™2
;

184 
TEST
(
By‹CÚš”V›wTe¡
, 
Equ®™yO³¿tÜPos™ive
) {

185 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

186 
By‹CÚš”V›w
 
v›w2
(
kD©a1
);

188 
EXPECT_TRUE
(
v›w1
 =ğ
v›w2
);

191 
TEST
(
By‹CÚš”V›wTe¡
, 
Equ®™yO³¿tÜNeg©ive
) {

192 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

193 
By‹CÚš”V›w
 
v›w2
(
kD©a2
);

195 
EXPECT_FALSE
(
v›w1
 =ğ
v›w2
);

198 
TEST
(
By‹CÚš”V›wTe¡
, 
IÃqu®™yO³¿tÜPos™ive
) {

199 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

200 
By‹CÚš”V›w
 
v›w2
(
kD©a1
);

202 
EXPECT_FALSE
(
v›w1
 !ğ
v›w2
);

205 
TEST
(
By‹CÚš”V›wTe¡
, 
IÃqu®™yO³¿tÜNeg©ive
) {

206 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

207 
By‹CÚš”V›w
 
v›w2
(
kD©a2
);

209 
EXPECT_TRUE
(
v›w1
 !ğ
v›w2
);

212 
TEST
(
By‹CÚš”V›wTe¡
, 
SaãEqu®sPos™ive
) {

213 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

214 
By‹CÚš”V›w
 
v›w2
(
kD©a1
);

216 
EXPECT_TRUE
(
v›w1
.
SaãEqu®s
(
v›w2
));

219 
TEST
(
By‹CÚš”V›wTe¡
, 
SaãEqu®sNeg©ive
) {

220 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

221 
By‹CÚš”V›w
 
v›w2
(
kD©a2
);

223 
EXPECT_FALSE
(
v›w1
.
SaãEqu®s
(
v›w2
));

	@crypto/util/byte_container_view_test.cc

19 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

21 
	~<™”©Ü
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w_š‹º®.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

30 
	~"asylo/ut/¡©us.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
	gkD©a1
[] =

37 
cÚ¡ex´
 
size_t
 
	gkSize1
 = (
kD©a1
) - 1;

38 
cÚ¡ex´
 
	gkD©a2
[] = "Mary had‡ big…ig,‡nd it had‚o fleece";

41 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

42 şas 
	cTy³dBy‹CÚš”V›wTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

43 
public
:

46 ::
‹¡šg
::
	tTy³s
<
	tSaãBy‹s
<
	tkSize1
>, 
	tUn§ãBy‹s
<kSize1>,

47 
	t¡d
::
	tveùÜ
<
	tušt8_t
>, std::veùÜ<>, std::
	t¡ršg
,

48 
	t¡d
::
	tbasic_¡ršg
<
	tušt8_t
, std::
	tch¬_Œa™s
<uint8_t>>>

49 
	tMyTy³s
;

50 
TYPED_TEST_SUITE
(
Ty³dBy‹CÚš”V›wTe¡
, 
MyTy³s
);

52 
TYPED_TEST
(
Ty³dBy‹CÚš”V›wTe¡
, 
D©aM‘hod
) {

53 
Ty³P¬am
 
cÚš”
(
kD©a1
, kD©a1 + 
kSize1
);

54 
By‹CÚš”V›w
 
v›w
(
cÚš”
);

56 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(
v›w
.
d©a
()),

57 
¡©ic_ÿ¡
<cÚ¡ *>(
cÚš”
.
d©a
()));

60 
TYPED_TEST
(
Ty³dBy‹CÚš”V›wTe¡
, 
SizeM‘hod
) {

61 
Ty³P¬am
 
cÚš”
(
kD©a1
, kD©a1 + 
kSize1
);

62 
By‹CÚš”V›w
 
v›w
(
cÚš”
);

64 
EXPECT_EQ
(
v›w
.
size
(), 
cÚš”
.size());

72 
TEST
(
By‹CÚš”V›wTe¡
, 
V”ifyT¿™sCÜ»ùÃss
) {

73 
¡©ic_as£¹
(

74 
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
By‹CÚš”V›w
>::
v®ue
,

76 
¡©ic_as£¹
(
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
¡d
::
¡ršg
>::
v®ue
,

78 
¡©ic_as£¹
(

79 
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
¡d
::
veùÜ
<
ušt8_t
>>::
v®ue
,

81 
¡©ic_as£¹
(

82 !
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
¡d
::
veùÜ
<
ušt32_t
>>::
v®ue
,

85 
¡©ic_as£¹
(!
š‹º®
::
is_ro_by‹_cÚš”_ty³
<
Stus
>::
v®ue
,

89 
TEST
(
By‹CÚš”V›wTe¡
, 
Em±yM‘hodPos™ive
) {

90 
EXPECT_TRUE
(
By‹CÚš”V›w
("").
em±y
());

93 
TEST
(
By‹CÚš”V›wTe¡
, 
Em±yM‘hodNeg©ive
) {

94 
EXPECT_FALSE
(
By‹CÚš”V›w
(
kD©a1
).
em±y
());

97 
TEST
(
By‹CÚš”V›wTe¡
, 
SubsütO³¿tÜ
) {

98 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

100 
	gi
 = 0; i < 
	gv›w
.
size
(); i++) {

101 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&
v›w
[
i
]),

102 
¡©ic_ÿ¡
<cÚ¡ *>(&
kD©a1
[
i
]));

106 
TEST
(
By‹CÚš”V›wTe¡
, 
AtM‘hod
) {

107 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

109 
	gi
 = 0; i < 
	gv›w
.
size
(); i++) {

110 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&
v›w
.
©
(
i
)),

111 
¡©ic_ÿ¡
<cÚ¡ *>(&
kD©a1
[
i
]));

115 
TEST
(
By‹CÚš”V›wTe¡
, 
FrÚtM‘hod
) {

116 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

118 autØ
	g±r
 = &
v›w
.
äÚt
();

119 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(
±r
), stic_ÿ¡<cÚ¡ *>(
kD©a1
));

120 
EXPECT_EQ
(
v›w
.
äÚt
(), 
¡d
::
¡ršg
(
kD©a1
).front());

123 
TEST
(
By‹CÚš”V›wTe¡
, 
BackM‘hod
) {

124 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

126 autØ
	g±r
 = &
v›w
.
back
();

127 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(
±r
),

128 
¡©ic_ÿ¡
<cÚ¡ *>(
kD©a1
 + 
kSize1
 - 1));

129 
EXPECT_EQ
(
v›w
.
back
(), 
¡d
::
¡ršg
(
kD©a1
).back());

132 
TEST
(
By‹CÚš”V›wTe¡
, 
I‹¿tÜ
) {

133 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

134 autØ
	g™1
 = 
v›w
.
begš
();

135 cÚ¡ *
	g™2
 = 
kD©a1
;

137 
	g™1
 !ğ
v›w
.
’d
()) {

138 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

139 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

140 ++
	g™1
;

141 ++
	g™2
;

145 
TEST
(
By‹CÚš”V›wTe¡
, 
CÚ¡I‹¿tÜ
) {

146 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

147 autØ
	g™1
 = 
v›w
.
cbegš
();

148 cÚ¡ *
	g™2
 = 
kD©a1
;

150 
	g™1
 !ğ
v›w
.
ûnd
()) {

151 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

152 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

153 ++
	g™1
;

154 ++
	g™2
;

158 
TEST
(
By‹CÚš”V›wTe¡
, 
Rev”£I‹¿tÜ
) {

159 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

160 autØ
	g™1
 = 
v›w
.
rbegš
();

161 autØ
	g™2
 = 
¡d
::
»v”£_™”©Ü
<cÚ¡ *>(&
kD©a1
[
kSize1
]);

163 
	g™1
 !ğ
v›w
.
»nd
()) {

164 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

165 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

166 ++
	g™1
;

167 ++
	g™2
;

171 
TEST
(
By‹CÚš”V›wTe¡
, 
CÚ¡Rev”£I‹¿tÜ
) {

172 
By‹CÚš”V›w
 
v›w
(
kD©a1
);

173 autØ
	g™1
 = 
v›w
.
übegš
();

174 autØ
	g™2
 = 
¡d
::
»v”£_™”©Ü
<cÚ¡ *>(&
kD©a1
[
kSize1
]);

176 
	g™1
 !ğ
v›w
.
ü’d
()) {

177 
EXPECT_EQ
(
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™1
)),

178 
¡©ic_ÿ¡
<cÚ¡ *>(&(*
™2
)));

179 ++
	g™1
;

180 ++
	g™2
;

184 
TEST
(
By‹CÚš”V›wTe¡
, 
Equ®™yO³¿tÜPos™ive
) {

185 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

186 
By‹CÚš”V›w
 
v›w2
(
kD©a1
);

188 
EXPECT_TRUE
(
v›w1
 =ğ
v›w2
);

191 
TEST
(
By‹CÚš”V›wTe¡
, 
Equ®™yO³¿tÜNeg©ive
) {

192 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

193 
By‹CÚš”V›w
 
v›w2
(
kD©a2
);

195 
EXPECT_FALSE
(
v›w1
 =ğ
v›w2
);

198 
TEST
(
By‹CÚš”V›wTe¡
, 
IÃqu®™yO³¿tÜPos™ive
) {

199 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

200 
By‹CÚš”V›w
 
v›w2
(
kD©a1
);

202 
EXPECT_FALSE
(
v›w1
 !ğ
v›w2
);

205 
TEST
(
By‹CÚš”V›wTe¡
, 
IÃqu®™yO³¿tÜNeg©ive
) {

206 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

207 
By‹CÚš”V›w
 
v›w2
(
kD©a2
);

209 
EXPECT_TRUE
(
v›w1
 !ğ
v›w2
);

212 
TEST
(
By‹CÚš”V›wTe¡
, 
SaãEqu®sPos™ive
) {

213 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

214 
By‹CÚš”V›w
 
v›w2
(
kD©a1
);

216 
EXPECT_TRUE
(
v›w1
.
SaãEqu®s
(
v›w2
));

219 
TEST
(
By‹CÚš”V›wTe¡
, 
SaãEqu®sNeg©ive
) {

220 
By‹CÚš”V›w
 
v›w1
(
kD©a1
);

221 
By‹CÚš”V›w
 
v›w2
(
kD©a2
);

223 
EXPECT_FALSE
(
v›w1
.
SaãEqu®s
(
v›w2
));

	@crypto/util/bytes.h

19 #iâdeà
ASYLO_CRYPTO_UTIL_BYTES_H_


20 
	#ASYLO_CRYPTO_UTIL_BYTES_H_


	)

22 
	~<İ’s¦/mem.h
>

23 
	~<®gÜ™hm
>

24 
	~<c¡dlib
>

25 
	~<c¡ršg
>

26 
	~<™”©Ü
>

28 
	~"ab¦/ba£/©Œibu‹s.h
"

29 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

30 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/ut/ş—nsšg_®loÿtÜ.h
"

33 
	~"asylo/ut/¡©us_maüos.h
"

34 
	~"asylo/ut/¡©usÜ.h
"

36 
Çme¥aû
 
	gasylo
 {

44 şas 
	cD©aSaãty
 { 
	gSAFE
, 
	gUNSAFE
 };

49 
	sSaãPŞicy
 {

50 
usšg
 
	g®loÿtÜ_ty³
 = 
CËªsšgAÎoÿtÜ
<
ušt8_t
>;

51 
cÚ¡ex´
 
D©aSaãty
 
	gpŞicy
 = D©aSaãty::
SAFE
;

58 
	sUn§ãPŞicy
 {

59 
usšg
 
	g®loÿtÜ_ty³
 = 
¡d
::
®loÿtÜ
<
ušt8_t
>;

60 
cÚ¡ex´
 
D©aSaãty
 
	gpŞicy
 = D©aSaãty::
UNSAFE
;

83 
	g‹m¶©e
 <
size_t
 
	gSize
, 
ty³Çme
 
	gPŞicy
,y³Çm
	gBy‹sT
>

84 şas 
	cBy‹s
 {

85 
	gpublic
:

86 
¡©ic_as£¹
(
¡d
::
is_§me
<
PŞicy
, 
SaãPŞicy
>::
v®ue
 ||

87 
¡d
::
is_§me
<
PŞicy
, 
Un§ãPŞicy
>::
v®ue
,

89 
usšg
 
	gv®ue_ty³
 = 
ušt8_t
;

99 
usšg
 
	g®loÿtÜ_ty³
 = 
ty³Çme
 
PŞicy
::
®loÿtÜ_ty³
;

100 
usšg
 
	gpŞicy_ty³
 = 
PŞicy
;

101 
usšg
 
	g™”©Ü
 = 
ušt8_t
 *;

102 
usšg
 
	gcÚ¡_™”©Ü
 = cÚ¡ 
ušt8_t
 *;

103 
usšg
 
	g»v”£_™”©Ü
 = 
¡d
::
»v”£_™”©Ü
<
™”©Ü
>;

104 
usšg
 
	gcÚ¡_»v”£_™”©Ü
 = 
¡d
::
»v”£_™”©Ü
<
cÚ¡_™”©Ü
>;

110 
	g‹m¶©e
 <
ty³Çme
 
	gCÚš”T
>

111 
By‹sT
 *
PÏû
(
CÚš”T
 *
cÚš”
, 
size_t
 
off£t
) {

112 
P”fÜmSticChecks
();

114 
¡©ic_as£¹
(

115 (
ty³Çme
 
CÚš”T
::
v®ue_ty³
) == (value_type),

117 
¡©ic_as£¹
(

118 !
¡d
::
is_§me
<
®loÿtÜ_ty³
, 
CËªsšgAÎoÿtÜ
<
v®ue_ty³
>>::
v®ue
 ||

119 
¡d
::
is_§me
<

120 
ty³Çme
 
CÚš”T
::
®loÿtÜ_ty³
,

121 
CËªsšgAÎoÿtÜ
<
ty³Çme
 
CÚš”T
::
v®ue_ty³
>>::
v®ue
,

126 
size_t
 
	goff£t_’d
 = 
off£t
 + 
Size
;

127 ià(
	goff£t_’d
 < 
	goff£t
 || off£t_’d > 
	gcÚš”
->
size
()) {

128  
	gnuÎ±r
;

131  
Ãw
 (
cÚš”
->
d©a
(è+ 
off£t
è
	gBy‹sT
;

135 
™”©Ü
 
begš
(è{  
	gd©a_
; }

136 
™”©Ü
 
’d
(è{  
	gd©a_
 + 
	gSize
; }

137 
»v”£_™”©Ü
 
rbegš
(è{ „ev”£_™”©Ü(
’d
()); }

138 
»v”£_™”©Ü
 
»nd
(è{ „ev”£_™”©Ü(
begš
()); }

141 
cÚ¡_™”©Ü
 
begš
(ècÚ¡ {  
cbegš
(); }

142 
cÚ¡_™”©Ü
 
’d
(ècÚ¡ {  
ûnd
(); }

143 
cÚ¡_»v”£_™”©Ü
 
rbegš
(ècÚ¡ {  
übegš
(); }

144 
cÚ¡_»v”£_™”©Ü
 
»nd
(ècÚ¡ {  
ü’d
(); }

147 
cÚ¡_™”©Ü
 
cbegš
(ècÚ¡ {  
	gd©a_
; }

148 
cÚ¡_™”©Ü
 
ûnd
(ècÚ¡ {  
	gd©a_
 + 
	gSize
; }

149 
cÚ¡_»v”£_™”©Ü
 
übegš
() const {

150  
cÚ¡_»v”£_™”©Ü
(
ûnd
());

152 
cÚ¡_»v”£_™”©Ü
 
ü’d
() const {

153  
cÚ¡_»v”£_™”©Ü
(
cbegš
());

157 
fl
(
ušt8_t
 
v®ue
è{ 
»¶aû
(0, v®ue, 
Size
); }

161 
size_t
 
assign
(
By‹CÚš”V›w
 
v›w
) {

162  
assign
(
v›w
.
d©a
(), v›w.
size
());

167 
size_t
 
assign
(cÚ¡ *
±r
, size_ˆ
couÁ
) {

168  
»¶aû
(0, 
±r
, 
couÁ
);

175 
size_t
 
»¶aû
(size_ˆ
pos
, 
By‹CÚš”V›w
 
v›w
) {

176  
»¶aû
(
pos
, 
v›w
.
d©a
(), v›w.
size
());

182 
size_t
 
»¶aû
(size_ˆ
pos
, cÚ¡ *
±r
, size_ˆ
couÁ
) {

183 ià(
	gpos
 >ğ
Size
) {

186 
ssize_t
 
	g»¶aû_size
 = 
¡d
::
mš
(
Size
 - 
pos
, 
couÁ
);

187 
memıy
(
d©a_
 + 
pos
, 
±r
, 
»¶aû_size
);

188  
	g»¶aû_size
;

195 
size_t
 
»¶aû
(size_ˆ
pos
, 
ušt8_t
 
ch
, size_ˆ
couÁ
) {

196 ià(
	gpos
 >ğ
Size
) {

199 
ssize_t
 
	g»¶aû_size
 = 
¡d
::
mš
(
Size
 - 
pos
, 
couÁ
);

200 
mem£t
(
d©a_
 + 
pos
, 
ch
, 
»¶aû_size
);

201  
	g»¶aû_size
;

204 
ušt8_t
 *
d©a
(è{  
	gd©a_
; }

205 cÚ¡ 
ušt8_t
 *
d©a
(ècÚ¡ {  
	gd©a_
; }

208 
šlše
 
	gušt8_t
 &
	gİ”©Ü
[](
size_t
 
	gpos
è{  
	gd©a_
[
pos
]; }

209 
šlše
 cÚ¡ 
	gušt8_t
 &
	gİ”©Ü
[](
size_t
 
	gpos
ècÚ¡ {  
	gd©a_
[
pos
]; }

212 
šlše
 
	gušt8_t
 &
©
(
size_t
 
pos
) {

213 ià(
	gpos
 < 0 ||…o >ğ
Size
) {

214 
LOG
(
FATAL
) << "Index out of bounds.";

216  
	gthis
->
	gİ”©Ü
[](
	gpos
);

218 
šlše
 cÚ¡ 
	gušt8_t
 &
©
(
size_t
 
pos
) const {

219 ià(
	gpos
 < 0 ||…o >ğ
Size
) {

220 
LOG
(
FATAL
) << "Index out of bounds.";

222  
	gthis
->
	gİ”©Ü
[](
	gpos
);

228 
CËª£
(è{ 
OPENSSL_ş—n£
(
d©a_
, 
Size
); }

234 
boŞ
 
Equ®s
(cÚ¡ *
d©a
, 
size_t
 
size
) const {

235 ià(
	gSize
 !ğ
size
) {

236  
çl£
;

238 ià(
	gPŞicy
::
pŞicy
 =ğ
D©aSaãty
::
SAFE
) {

241  (
CRYPTO_memcmp
(
d©a_
, 
d©a
, 
Size
) == 0);

245  (
memcmp
(
d©a_
, 
d©a
, 
Size
) == 0);

255 
»size
(
size_t
 
Ãw_size
) const { ; }

256 
cÚ¡ex´
 
size_t
 
size
(è{  
	gSize
; }

257 
cÚ¡ex´
 
D©aSaãty
 
pŞicy
(è{  
	gPŞicy
::policy; }

259 
ušt8_t
 
	gd©a_
[
Size
];

261 
	g´Ùeùed
:

263 
By‹s
() = ;

268 
By‹s
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
size
) {

269 
P”fÜmSticChecks
();

270 
assign
(
d©a
, 
size
);

276 
By‹s
(
By‹CÚš”V›w
 
v›w
) {

277 
P”fÜmSticChecks
();

278 
assign
(
v›w
.
d©a
(), v›w.
size
());

283 
	g‹m¶©e
 <
ty³Çme
 
	gI‹¿tÜ
>

284 
By‹s
(
I‹¿tÜ
 
¡¬t
, I‹¿tÜ 
’d
) {

285 
P”fÜmSticChecks
();

287 ià(
	g’d
 < 
	g¡¬t
) {

291 
I‹¿tÜ
 
	gÃw_’d
 = 
¡¬t
 + 
¡d
::
mš
(
Size
, 
¡©ic_ÿ¡
<
size_t
>(
’d
 - start));

292 
	g¡d
::
cİy
(
¡¬t
, 
Ãw_’d
, 
d©a_
);

295 
	g´iv©e
:

296 
P”fÜmSticChecks
() {

297 
¡©ic_as£¹
((
By‹s
è=ğ
Size
,

299 
¡©ic_as£¹
(
off£tof
(
By‹s
, 
d©a_
) == 0,

302 } 
	gABSL_ATTRIBUTE_PACKED
;

305 
	g‹m¶©e
 <
size_t
 
	gSize
>

306 
şass
 
SaãBy‹s
 
	gfš®
 : 
public
 
By‹s
<
Size
, 
	gSaãPŞicy
, 
	gSaãBy‹s
<
	gSize
>> {

307 
	gpublic
:

309 
usšg
 
ba£_ty³
 = 
By‹s
<
Size
, 
	gSaãPŞicy
, 
	gSaãBy‹s
<
	gSize
>>;

312 
usšg
 
	gv®ue_ty³
 = 
ty³Çme
 
ba£_ty³
::
v®ue_ty³
;

313 
usšg
 
	g®loÿtÜ_ty³
 = 
ty³Çme
 
ba£_ty³
::
®loÿtÜ_ty³
;

314 
usšg
 
	gpŞicy_ty³
 = 
ty³Çme
 
ba£_ty³
::
®loÿtÜ_ty³
;

315 
usšg
 
	g™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
™”©Ü
;

316 
usšg
 
	gcÚ¡_™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
cÚ¡_™”©Ü
;

317 
usšg
 
	g»v”£_™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
»v”£_™”©Ü
;

318 
usšg
 
	gcÚ¡_»v”£_™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
cÚ¡_»v”£_™”©Ü
;

320 
SaãBy‹s
() = ;

327 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

328 
SaãBy‹s
(
Args
 &&... 
¬gs
)

329 : 
ba£_ty³
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {}

333 
‹m¶©e
 <
ty³Çme
 
By‹sT
>

334 
boŞ
 
İ”©Ü
==(cÚ¡ 
By‹sT
 &
Ùh”
) const {

335  
ba£_ty³
::
Equ®s
(
Ùh”
.
d©a
(), oth”.
size
());

339 
	g‹m¶©e
 <
ty³Çme
 
	gBy‹sT
>

340 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
By‹sT
 &
Ùh”
) const {

341  !(*
this
 =ğ
Ùh”
);

345 ~
SaãBy‹s
(è{ 
	gba£_ty³
::
CËª£
(); }

346 } 
	gABSL_ATTRIBUTE_PACKED
;

349 
	g‹m¶©e
 <
size_t
 
	gSize
>

350 
şass
 
Un§ãBy‹s
 
	gfš®
 : 
public
 
By‹s
<
Size
, 
	gUn§ãPŞicy
, 
	gUn§ãBy‹s
<
	gSize
>> {

351 
	gpublic
:

353 
usšg
 
ba£_ty³
 = 
By‹s
<
Size
, 
	gUn§ãPŞicy
, 
	gUn§ãBy‹s
<
	gSize
>>;

356 
usšg
 
	gv®ue_ty³
 = 
ty³Çme
 
ba£_ty³
::
v®ue_ty³
;

357 
usšg
 
	g®loÿtÜ_ty³
 = 
ty³Çme
 
ba£_ty³
::
®loÿtÜ_ty³
;

358 
usšg
 
	gpŞicy_ty³
 = 
ty³Çme
 
ba£_ty³
::
®loÿtÜ_ty³
;

359 
usšg
 
	g™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
™”©Ü
;

360 
usšg
 
	gcÚ¡_™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
cÚ¡_™”©Ü
;

361 
usšg
 
	g»v”£_™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
»v”£_™”©Ü
;

362 
usšg
 
	gcÚ¡_»v”£_™”©Ü
 = 
ty³Çme
 
ba£_ty³
::
cÚ¡_»v”£_™”©Ü
;

367 
Un§ãBy‹s
() = ;

368 
Un§ãBy‹s
(const UnsafeBytes &) = ;

369 
	gUn§ãBy‹s
 &
	gİ”©Ü
=(cÚ¡ 
Un§ãBy‹s
 &) = ;

370 
Un§ãBy‹s
(UnsafeBytes &&) = ;

371 
	gUn§ãBy‹s
 &
	gİ”©Ü
=(
Un§ãBy‹s
 &&) = ;

372 ~
Un§ãBy‹s
() = ;

379 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

380 
Un§ãBy‹s
(
Args
 &&... 
¬gs
)

381 : 
ba£_ty³
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...) {}

388 
‹m¶©e
 <
ty³Çme
 
By‹sT
>

389 
boŞ
 
İ”©Ü
==(cÚ¡ 
By‹sT
 &
Ùh”
) const {

390  
Ùh”
.
Equ®s
(
this
->
d©a
(),his->
size
());

394 
	g‹m¶©e
 <
ty³Çme
 
	gBy‹sT
>

395 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
By‹sT
 &
Ùh”
) const {

396  !(*
this
 =ğ
Ùh”
);

398 } 
	gABSL_ATTRIBUTE_PACKED
;

404 
	g‹m¶©e
 <
size_t
 
	gIÅutSize
>

405 
	gStusOr
<
	gSaãBy‹s
<(
	gIÅutSize
 - 1è/ 2>> 
	$In¡ªtŸ‹SaãBy‹sFromHexSŒšg
(

406 cÚ¡ *
by‹s_hex
) {

407 
SaãBy‹s
<(
IÅutSize
 - 1è/ 2> 
by‹s
;

408 
	`ASYLO_RETURN_IF_ERROR
(
	`S‘TrivŸlObjeùFromHexSŒšg
(

409 
¡d
::
	`¡ršg
(
by‹s_hex
, 
IÅutSize
 - 1), &
by‹s
));

410  
by‹s
;

411 
	}
}

417 
	g‹m¶©e
 <
size_t
 
	gIÅutSize
>

418 
	gStusOr
<
	gUn§ãBy‹s
<(
	gIÅutSize
 - 1è/ 2>> 
	$In¡ªtŸ‹Un§ãBy‹sFromHexSŒšg
(

419 cÚ¡ *
by‹s_hex
) {

420 
Un§ãBy‹s
<(
IÅutSize
 - 1è/ 2> 
by‹s
;

421 
	`ASYLO_RETURN_IF_ERROR
(
	`S‘TrivŸlObjeùFromHexSŒšg
(

422 
¡d
::
	`¡ršg
(
by‹s_hex
, 
IÅutSize
 - 1), &
by‹s
));

423  
by‹s
;

424 
	}
}

427 
	g‹m¶©e
 <
size_t
 
	gSize
>

428 
šlše
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
os
,

429 cÚ¡ 
	gSaãBy‹s
<
	gSize
> &
	gby‹s
) {

430  
	gos
 << 
CÚv”tTrivŸlObjeùToHexSŒšg
(
by‹s
);

434 
	g‹m¶©e
 <
size_t
 
	gSize
>

435 
šlše
 
PrštTo
(cÚ¡ 
SaãBy‹s
<
Size
> &
by‹s
, 
¡d
::
o¡»am
 *
os
) {

436 *
os
 << 
by‹s
;

441 
	g‹m¶©e
 <
size_t
 
	gSize
>

442 
šlše
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
os
,

443 cÚ¡ 
	gUn§ãBy‹s
<
	gSize
> &
	gby‹s
) {

444  
	gos
 << 
CÚv”tTrivŸlObjeùToHexSŒšg
(
by‹s
);

448 
	g‹m¶©e
 <
size_t
 
	gSize
>

449 
šlše
 
PrštTo
(cÚ¡ 
Un§ãBy‹s
<
Size
> &
by‹s
, 
¡d
::
o¡»am
 *
os
) {

450 *
os
 << 
by‹s
;

	@crypto/util/bytes_test.cc

19 
	~"asylo/üy±o/ut/by‹s.h
"

21 
	~<®gÜ™hm
>

22 
	~<ty³_Œa™s
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 
size_t
 
	gkSize
 = 11;

34 
cÚ¡ex´
 
ušt8_t
 
	gkV®ue1
[
kSize
] = {'a', 'b', 'c', 'd', 'e', 'f',

36 
cÚ¡ex´
 
ušt8_t
 
	gkV®ue2
[
kSize
] = {'a', 'b', 'c', 'd', 'e', 'f',

38 
cÚ¡ex´
 
ušt8_t
 
	gkV®ue3
[
kSize
] = {'a', 'a', 'a', 'a', 'a', 'a',

41 
cÚ¡ex´
 
size_t
 
	gkL¬geSize
 = 13;

42 
cÚ¡ex´
 
ušt8_t
 
	gkL¬geV®ue
[
kL¬geSize
] = {'a', 'b', 'c', 'd', 'e', 'f', 'g',

46 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

47 şas 
	cTy³dBy‹sTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

48 
public
:

51 ::
‹¡šg
::
	tTy³s
<
	tSaãBy‹s
<
	tkSize
>, 
	tUn§ãBy‹s
<kSize>> 
	tMyTy³s
;

52 
TYPED_TEST_SUITE
(
Ty³dBy‹sTe¡
, 
MyTy³s
);

54 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®™yO³¿tÜPos™ive1
) {

55 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

56 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

58 
EXPECT_TRUE
(
by‹s1
 =ğ
by‹s2
);

61 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®™yO³¿tÜNeg©ive2
) {

62 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

63 
Ty³P¬am
 
by‹s2
(
kV®ue2
, 
kSize
);

65 
EXPECT_FALSE
(
by‹s1
 =ğ
by‹s2
);

68 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
IÃqu®™yO³¿tÜNeg©ive1
) {

69 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

70 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

72 
EXPECT_FALSE
(
by‹s1
 !ğ
by‹s2
);

75 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
IÃqu®™yO³¿tÜPos™ive2
) {

76 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

77 
Ty³P¬am
 
by‹s2
(
kV®ue2
, 
kSize
);

79 
EXPECT_TRUE
(
by‹s1
 !ğ
by‹s2
);

82 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®sPos™ive1
) {

83 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

85 
EXPECT_TRUE
(
by‹s1
.
Equ®s
(
kV®ue1
, 
kSize
));

88 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®sNeg©ive1
) {

89 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

91 
EXPECT_FALSE
(
by‹s1
.
Equ®s
(
kV®ue1
, 
kSize
 - 2));

94 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®sNeg©ive2
) {

95 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

97 
EXPECT_FALSE
(
by‹s1
.
Equ®s
(
kV®ue2
, 
kSize
));

100 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CÚ¡ruùÜs
) {

101 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

102 
Ty³P¬am
 
by‹s2
(
kV®ue1
, kV®ue1 + 
kSize
);

104 
EXPECT_TRUE
(
by‹s1
 =ğ
by‹s2
);

107 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
T¿™s
) {

108 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
Ty³P¬am
>::
v®ue
);

110 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

111 
EXPECT_EQ
(
kSize
, (
by‹s
));

112 
EXPECT_EQ
(
kSize
, 
by‹s
.
size
());

113 
EXPECT_EQ
(
»š‹½»t_ÿ¡
<
ušŒ_t
>(&
by‹s
),

114 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
by‹s
.
d©a
()));

117 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Fl
) {

118 
Ty³P¬am
 
	gby‹s
;

120 
	gby‹s
.
fl
('a');

121 
EXPECT_EQ
(0, 
memcmp
(
by‹s
.
d©a
(), 
kV®ue3
, by‹s.
size
()));

124 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
S‘
) {

125 
Ty³P¬am
 
	gby‹s
;

127 
EXPECT_EQ
(
kSize
, 
by‹s
.
assign
(
kV®ue1
, kSize));

128 
EXPECT_EQ
(0, 
memcmp
(
by‹s
.
d©a
(), 
kV®ue1
, by‹s.
size
()));

131 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
S‘Sm®ËrIÅut
) {

132 
Ty³P¬am
 
	gby‹s
;

134 
EXPECT_EQ
(
kSize
 - 4, 
by‹s
.
assign
(
kV®ue1
, kSize - 4));

135 
EXPECT_EQ
(0, 
memcmp
(
by‹s
.
d©a
(), 
kV®ue1
, 
kSize
 - 4));

140 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
S‘L¬g”IÅut
) {

143 
	g¡d
::
veùÜ
<
ušt8_t
> 
tmp1
;

144 
	gtmp1
.
»size
(4096);

145 
mem£t
(
tmp1
.
d©a
(), 'a', 4096);

146 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
tmp1
.
d©a
()) TypeParam;

150 
	g¡d
::
veùÜ
<
ušt8_t
> 
tmp2
;

151 
	gtmp2
.
»size
(4096);

152 
mem£t
(
tmp2
.
d©a
(), 'b', 4096);

153 
EXPECT_EQ
(
by‹s
->
size
(), by‹s->
assign
(
tmp2
.
d©a
(), 4096));

157 
mem£t
(
tmp2
.
d©a
(è+ 
kSize
, 'a', 4096 - kSize);

160 
EXPECT_EQ
(
tmp2
, 
tmp1
);

165 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûPŒW™hšRªge
) {

166 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

167 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

168 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

170 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

171 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 
kV®ue2
, 
»que¡ed_»¶aû_couÁ
),

172 
ex³ùed_»¶aû_couÁ
);

174 
ušt8_t
 
	gbufãr
[
kSize
];

175 
memıy
(
bufãr
, 
kV®ue1
, 
kSize
);

176 
memıy
(
bufãr
 + 
»¶aû_pos
, 
kV®ue2
, 
ex³ùed_»¶aû_couÁ
);

177 
Ty³P¬am
 
by‹s2
(
bufãr
, 
kSize
);

179 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

184 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûV®ueW™hšRªge
) {

185 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

186 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

187 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

189 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

190 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 'a', 
»que¡ed_»¶aû_couÁ
),

191 
ex³ùed_»¶aû_couÁ
);

193 
ušt8_t
 
	gbufãr
[
kSize
];

194 
memıy
(
bufãr
, 
kV®ue1
, 
kSize
);

195 
mem£t
(
bufãr
 + 
»¶aû_pos
, 'a', 
ex³ùed_»¶aû_couÁ
);

196 
Ty³P¬am
 
by‹s2
(
bufãr
, 
kSize
);

198 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

204 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûPŒL¬geRªge
) {

205 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

206 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

207 
size_t
 
	gex³ùed_»¶aû_couÁ
 =

208 
¡d
::
mš
(
kSize
 - 
»¶aû_pos
, 
»que¡ed_»¶aû_couÁ
);

210 
ušt8_t
 
	gbufãr1
[256];

211 
mem£t
(
bufãr1
, 'x', (buffer1));

212 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
bufãr1
èTy³P¬am(
kV®ue1
, 
kSize
);

213 
EXPECT_EQ
(
by‹s
->
»¶aû
(
»¶aû_pos
, 
kV®ue2
, 
»que¡ed_»¶aû_couÁ
),

214 
ex³ùed_»¶aû_couÁ
);

216 
ušt8_t
 
	gbufãr2
[256];

217 
mem£t
(
bufãr2
, 'x', (
bufãr1
));

218 
memıy
(
bufãr2
, 
kV®ue1
, 
kSize
);

219 
memıy
(
bufãr2
 + 
»¶aû_pos
, 
kV®ue2
, 
ex³ùed_»¶aû_couÁ
);

221 
EXPECT_EQ
(
memcmp
(
bufãr1
, 
bufãr2
, (buffer1)), 0);

226 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûV®ueL¬geRªge
) {

227 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

228 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

229 
size_t
 
	gex³ùed_»¶aû_couÁ
 =

230 
¡d
::
mš
(
kSize
 - 
»¶aû_pos
, 
»que¡ed_»¶aû_couÁ
);

232 
ušt8_t
 
	gbufãr1
[256];

233 
mem£t
(
bufãr1
, 'x', (buffer1));

234 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
bufãr1
èTy³P¬am(
kV®ue1
, 
kSize
);

235 
EXPECT_EQ
(
by‹s
->
»¶aû
(
»¶aû_pos
, 'a', 
»que¡ed_»¶aû_couÁ
),

236 
ex³ùed_»¶aû_couÁ
);

238 
ušt8_t
 
	gbufãr2
[256];

239 
mem£t
(
bufãr2
, 'x', (
bufãr1
));

240 
memıy
(
bufãr2
, 
kV®ue1
, 
kSize
);

241 
mem£t
(
bufãr2
 + 
»¶aû_pos
, 'a', 
ex³ùed_»¶aû_couÁ
);

243 
EXPECT_EQ
(
memcmp
(
bufãr1
, 
bufãr2
, (buffer1)), 0);

248 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûPŒW™hL¬gePos
) {

249 
size_t
 
	g»¶aû_pos
 = 
kSize
 + 1;

250 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

251 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 0;

253 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

254 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 
kV®ue2
, 
»que¡ed_»¶aû_couÁ
),

255 
ex³ùed_»¶aû_couÁ
);

257 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

258 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

263 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûV®ueW™hL¬gePos
) {

264 
size_t
 
	g»¶aû_pos
 = 
kSize
 + 1;

265 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

266 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 0;

268 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

269 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 'a', 
»que¡ed_»¶aû_couÁ
),

270 
ex³ùed_»¶aû_couÁ
);

272 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

273 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

276 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CËª£
) {

277 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

278 
EXPECT_TRUE
(
by‹s
.
Equ®s
(
kV®ue1
, 
kSize
));

279 
	gby‹s
.
CËª£
();

280 
ušt8_t
 
	gbufãr
[
kSize
];

283 
mem£t
(
bufãr
, 0, 
kSize
);

284 
EXPECT_TRUE
(
by‹s
.
Equ®s
(
bufãr
, 
kSize
));

287 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
De¡ruùÜ
) {

288 
ušt8_t
 
	gbufãr1
[
kSize
];

291 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
bufãr1
èTy³P¬am(
kV®ue1
, 
kSize
);

293 
EXPECT_TRUE
(
by‹s
->
Equ®s
(
kV®ue1
, 
kSize
));

294 
	gby‹s
->~
Ty³P¬am
();

296 ià(
	gTy³P¬am
::
pŞicy
(è=ğ
D©aSaãty
::
SAFE
) {

300 
ušt8_t
 
bufãr2
[
kSize
];

301 
mem£t
(
bufãr2
, 0, 
kSize
);

302 
EXPECT_EQ
(0, 
memcmp
(
bufãr1
, 
bufãr2
, 
kSize
));

304 
EXPECT_EQ
(0, 
memcmp
(
bufãr1
, 
kV®ue1
, 
kSize
));

308 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
MubËI‹¿tÜBasic
) {

309 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

310 
Ty³P¬am
 
	gby‹s2
;

312 
	g¡d
::
cİy
(
by‹s1
.
begš
(), by‹s1.
’d
(), 
by‹s2
.begin());

313 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

314 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
by‹s1
.begin()));

316 
	g¡d
::
veùÜ
<
ušt8_t
> 
vec
;

317 
	gušt8_t
 &
	gch
 : 
by‹s1
) {

318 
vec
.
push_back
(
ch
);

320 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
vec
.begin()));

323 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Im¶ic™ImmubËI‹¿tÜBasic
) {

324 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

325 
Ty³P¬am
 
	gby‹s2
;

327 
	g¡d
::
cİy
(
by‹s1
.
begš
(), by‹s1.
’d
(), 
by‹s2
.begin());

328 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

329 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
by‹s1
.begin()));

331 
	g¡d
::
veùÜ
<
ušt8_t
> 
vec
;

332 cÚ¡ 
	gušt8_t
 &
	gch
 : 
by‹s1
) {

333 
vec
.
push_back
(
ch
);

335 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
vec
.begin()));

338 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Ex¶ic™ImmubËI‹¿tÜBasic
) {

339 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

340 
Ty³P¬am
 
	gby‹s2
;

342 
	g¡d
::
cİy
(
by‹s1
.
cbegš
(), by‹s1.
ûnd
(), 
by‹s2
.
begš
());

343 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

344 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
cbegš
(), by‹s2.
ûnd
(), 
by‹s1
.cbegin()));

346 
	g¡d
::
veùÜ
<
ušt8_t
> 
vec
;

347 cÚ¡ 
	gušt8_t
 &
	gch
 : 
by‹s1
) {

348 
vec
.
push_back
(
ch
);

350 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
vec
.begin()));

353 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
MubËI‹¿tÜAr™hm‘icAndCom·risÚ
) {

354 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

356 
ty³Çme
 
	gTy³P¬am
::
™”©Ü
 
™1
 = 
by‹s1
.
begš
();

357 
ty³Çme
 
	gTy³P¬am
::
™”©Ü
 
™2
 = 
™1
 + 5;

358 
EXPECT_TRUE
(
™1
 < 
™2
);

359 
EXPECT_TRUE
(
™1
 <ğ
™2
);

360 
EXPECT_TRUE
(
™1
 !ğ
™2
);

361 
EXPECT_FALSE
(
™1
 > 
™2
);

362 
EXPECT_FALSE
(
™1
 >ğ
™2
);

363 
EXPECT_FALSE
(
™1
 =ğ
™2
);

364 
EXPECT_EQ
(
™2
 - 
™1
, 5);

365 
EXPECT_EQ
(*
™2
, 
™1
[5]);

366 
EXPECT_EQ
(
™1
 - 
™2
, -5);

367 
EXPECT_EQ
(
™2
[-5], *
™1
);

369 
	g™1
++;

370 ++
	g™1
;

371 
	g™1
 += 1;

372 
	g™1
 = 
™1
 + 1;

373 
	g™1
 = 1 + 
™1
;

374 
EXPECT_FALSE
(
™1
 < 
™2
);

375 
EXPECT_TRUE
(
™1
 <ğ
™2
);

376 
EXPECT_FALSE
(
™1
 !ğ
™2
);

377 
EXPECT_FALSE
(
™1
 > 
™2
);

378 
EXPECT_TRUE
(
™1
 >ğ
™2
);

379 
EXPECT_TRUE
(
™1
 =ğ
™2
);

380 
EXPECT_EQ
(
™2
 - 
™1
, 0);

381 
EXPECT_EQ
(*
™2
, 
™1
[0]);

382 
EXPECT_EQ
(
™1
 - 
™2
, 0);

383 
EXPECT_EQ
(
™2
[0], *
™1
);

385 
	g™2
--;

386 --
	g™2
;

387 
	g™2
 -= 1;

388 
	g™2
 = 
™2
 - 2;

389 
EXPECT_FALSE
(
™1
 < 
™2
);

390 
EXPECT_FALSE
(
™1
 <ğ
™2
);

391 
EXPECT_TRUE
(
™1
 !ğ
™2
);

392 
EXPECT_TRUE
(
™1
 > 
™2
);

393 
EXPECT_TRUE
(
™1
 >ğ
™2
);

394 
EXPECT_FALSE
(
™1
 =ğ
™2
);

395 
EXPECT_EQ
(
™2
 - 
™1
, -5);

396 
EXPECT_EQ
(
™2
[5], *
™1
);

397 
EXPECT_EQ
(
™1
 - 
™2
, 5);

398 
EXPECT_EQ
(*
™2
, 
™1
[-5]);

401 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Im¶ic™ImmubËI‹¿tÜAr™hm‘icAndCom·risÚ
) {

402 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

404 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™1
 = 
by‹s1
.
begš
();

405 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™2
 = 
™1
 + 5;

406 
EXPECT_TRUE
(
™1
 < 
™2
);

407 
EXPECT_TRUE
(
™1
 <ğ
™2
);

408 
EXPECT_TRUE
(
™1
 !ğ
™2
);

409 
EXPECT_FALSE
(
™1
 > 
™2
);

410 
EXPECT_FALSE
(
™1
 >ğ
™2
);

411 
EXPECT_FALSE
(
™1
 =ğ
™2
);

412 
EXPECT_EQ
(
™2
 - 
™1
, 5);

413 
EXPECT_EQ
(*
™2
, 
™1
[5]);

414 
EXPECT_EQ
(
™1
 - 
™2
, -5);

415 
EXPECT_EQ
(
™2
[-5], *
™1
);

417 
	g™1
++;

418 ++
	g™1
;

419 
	g™1
 += 1;

420 
	g™1
 = 
™1
 + 1;

421 
	g™1
 = 1 + 
™1
;

422 
EXPECT_FALSE
(
™1
 < 
™2
);

423 
EXPECT_TRUE
(
™1
 <ğ
™2
);

424 
EXPECT_FALSE
(
™1
 !ğ
™2
);

425 
EXPECT_FALSE
(
™1
 > 
™2
);

426 
EXPECT_TRUE
(
™1
 >ğ
™2
);

427 
EXPECT_TRUE
(
™1
 =ğ
™2
);

428 
EXPECT_EQ
(
™2
 - 
™1
, 0);

429 
EXPECT_EQ
(*
™2
, 
™1
[0]);

430 
EXPECT_EQ
(
™1
 - 
™2
, 0);

431 
EXPECT_EQ
(
™2
[0], *
™1
);

433 
	g™2
--;

434 --
	g™2
;

435 
	g™2
 -= 1;

436 
	g™2
 = 
™2
 - 2;

437 
EXPECT_FALSE
(
™1
 < 
™2
);

438 
EXPECT_FALSE
(
™1
 <ğ
™2
);

439 
EXPECT_TRUE
(
™1
 !ğ
™2
);

440 
EXPECT_TRUE
(
™1
 > 
™2
);

441 
EXPECT_TRUE
(
™1
 >ğ
™2
);

442 
EXPECT_FALSE
(
™1
 =ğ
™2
);

443 
EXPECT_EQ
(
™2
 - 
™1
, -5);

444 
EXPECT_EQ
(
™2
[5], *
™1
);

445 
EXPECT_EQ
(
™1
 - 
™2
, 5);

446 
EXPECT_EQ
(*
™2
, 
™1
[-5]);

449 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Ex¶ic™ImmubËI‹¿tÜAr™hm‘icAndCom·risÚ
) {

450 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

452 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™1
 = 
by‹s1
.
cbegš
();

453 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™2
 = 
™1
 + 5;

454 
EXPECT_TRUE
(
™1
 < 
™2
);

455 
EXPECT_TRUE
(
™1
 <ğ
™2
);

456 
EXPECT_TRUE
(
™1
 !ğ
™2
);

457 
EXPECT_FALSE
(
™1
 > 
™2
);

458 
EXPECT_FALSE
(
™1
 >ğ
™2
);

459 
EXPECT_FALSE
(
™1
 =ğ
™2
);

460 
EXPECT_EQ
(
™2
 - 
™1
, 5);

461 
EXPECT_EQ
(*
™2
, 
™1
[5]);

462 
EXPECT_EQ
(
™1
 - 
™2
, -5);

463 
EXPECT_EQ
(
™2
[-5], *
™1
);

465 
	g™1
++;

466 ++
	g™1
;

467 
	g™1
 += 1;

468 
	g™1
 = 
™1
 + 1;

469 
	g™1
 = 1 + 
™1
;

470 
EXPECT_FALSE
(
™1
 < 
™2
);

471 
EXPECT_TRUE
(
™1
 <ğ
™2
);

472 
EXPECT_FALSE
(
™1
 !ğ
™2
);

473 
EXPECT_FALSE
(
™1
 > 
™2
);

474 
EXPECT_TRUE
(
™1
 >ğ
™2
);

475 
EXPECT_TRUE
(
™1
 =ğ
™2
);

476 
EXPECT_EQ
(
™2
 - 
™1
, 0);

477 
EXPECT_EQ
(*
™2
, 
™1
[0]);

478 
EXPECT_EQ
(
™1
 - 
™2
, 0);

479 
EXPECT_EQ
(
™2
[0], *
™1
);

481 
	g™2
--;

482 --
	g™2
;

483 
	g™2
 -= 1;

484 
	g™2
 = 
™2
 - 2;

485 
EXPECT_FALSE
(
™1
 < 
™2
);

486 
EXPECT_FALSE
(
™1
 <ğ
™2
);

487 
EXPECT_TRUE
(
™1
 !ğ
™2
);

488 
EXPECT_TRUE
(
™1
 > 
™2
);

489 
EXPECT_TRUE
(
™1
 >ğ
™2
);

490 
EXPECT_FALSE
(
™1
 =ğ
™2
);

491 
EXPECT_EQ
(
™2
 - 
™1
, -5);

492 
EXPECT_EQ
(
™2
[5], *
™1
);

493 
EXPECT_EQ
(
™1
 - 
™2
, 5);

494 
EXPECT_EQ
(*
™2
, 
™1
[-5]);

497 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
MubËRev”£I‹¿tÜBasic
) {

498 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

499 
Ty³P¬am
 
	gby‹s2
;

501 
	g¡d
::
cİy
(
by‹s1
.
rbegš
(), by‹s1.
»nd
(), 
by‹s2
.
begš
());

502 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
rbegš
(), by‹s2.
»nd
(), 
by‹s1
.
begš
()));

505 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Im¶ic™ImmubËRev”£I‹¿tÜBasic
) {

506 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

507 
Ty³P¬am
 
	gby‹s2
;

509 
	g¡d
::
cİy
(
by‹s1
.
rbegš
(), by‹s1.
»nd
(), 
by‹s2
.
begš
());

510 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
rbegš
(), by‹s2.
»nd
(), 
by‹s1
.
begš
()));

513 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Ex¶ic™ImmubËRev”£I‹¿tÜBasic
) {

514 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

515 
Ty³P¬am
 
	gby‹s2
;

517 
	g¡d
::
cİy
(
by‹s1
.
übegš
(), by‹s1.
ü’d
(), 
by‹s2
.
begš
());

518 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
übegš
(), by‹s2.
ü’d
(), 
by‹s1
.
cbegš
()));

522 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CİyVŸSubsütO³¿tÜ
) {

523 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

524 
Ty³P¬am
 
	gby‹s2
;

526 
	gi
 = 0; i < 
	gby‹s1
.
size
(); i++) {

527 
	gby‹s2
[
i
] = 
by‹s1
[i];

529 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

533 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CİyVŸAtM‘hod
) {

534 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

535 
Ty³P¬am
 
	gby‹s2
;

537 
	gi
 = 0; i < 
	gby‹s1
.
size
(); i++) {

538 
	gby‹s2
.
©
(
i
èğ
by‹s1
.at(i);

540 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

544 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
NewPÏûm’t
) {

545 
usšg
 
	gCom·tibËVeùÜ
 = 
¡d
::
veùÜ
<

546 , 
ty³Çme
 
	g¡d
::
®loÿtÜ_Œa™s
<ty³Çm
Ty³P¬am
::
®loÿtÜ_ty³
>::

547 
‹m¶©e
 
»bšd_®loc
<>>;

548 
usšg
 
	gSaãVeùÜ
 = 
¡d
::
veùÜ
<, 
	gCËªsšgAÎoÿtÜ
<>>;

550 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

553 
Com·tibËVeùÜ
 
vec1
(
kL¬geV®ue
, kLargeValue + (kLargeValue));

554 
Ty³P¬am
 *
	gby‹s2
;

556 
	gby‹s2
 = 
Ty³P¬am
::
PÏû
(&
vec1
, 0);

557 
ASSERT_NE
(
by‹s2
, 
nuÎ±r
);

558 
EXPECT_EQ
(
by‹s1
, *
by‹s2
);

560 
	gby‹s2
 = 
Ty³P¬am
::
PÏû
(&
vec1
, vec1.
size
() - TypeParam::size());

561 
ASSERT_NE
(
by‹s2
, 
nuÎ±r
);

563 
	gby‹s2
 = 
Ty³P¬am
::
PÏû
(&
vec1
, vec1.
size
() - TypeParam::size() + 1);

564 
EXPECT_EQ
(
by‹s2
, 
nuÎ±r
);

568 
SaãVeùÜ
 
vec2
(
kL¬geV®ue
, kLargeValue + (kLargeValue));

569 
Ty³P¬am
 *
	gby‹s3
;

571 
	gby‹s3
 = 
Ty³P¬am
::
PÏû
(&
vec2
, 0);

572 
ASSERT_NE
(
by‹s3
, 
nuÎ±r
);

573 
EXPECT_EQ
(
by‹s1
, *
by‹s3
);

575 
	gby‹s3
 = 
Ty³P¬am
::
PÏû
(&
vec2
, vec2.
size
() - TypeParam::size());

576 
ASSERT_NE
(
by‹s3
, 
nuÎ±r
);

578 
	gby‹s3
 = 
Ty³P¬am
::
PÏû
(&
vec2
, vec2.
size
() - TypeParam::size() + 1);

579 
EXPECT_EQ
(
by‹s3
, 
nuÎ±r
);

582 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
PrštTo
) {

583 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

584 
	g¡d
::
¡ršg
 
¡r1
 = ::
‹¡šg
::
PrštToSŒšg
(
by‹s
);

585 
	g¡d
::
¡ršg
 
¡r2
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
by‹s
);

586 
EXPECT_EQ
(
¡r1
, 
¡r2
);

593 
TEST
(
By‹sTe¡
, 
Un§ãBy‹sIsTrivŸl
) {

594 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_deçuÉ_cÚ¡ruùibË
<
Un§ãBy‹s
<1>>::
v®ue
);

595 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_de¡ruùibË
<
Un§ãBy‹s
<1>>::
v®ue
);

596 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_cİy_cÚ¡ruùibË
<
Un§ãBy‹s
<1>>::
v®ue
);

597 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_cİyabË
<
Un§ãBy‹s
<1>>::
v®ue
);

598 
EXPECT_TRUE
(
¡d
::
is_ŒivŸl
<
Un§ãBy‹s
<1>>::
v®ue
);

604 
TEST
(
By‹sTe¡
, 
SaãEqu®™yO³¿tÜNeg©ive1
) {

605 
	gSaãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

606 
	gSaãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

608 
EXPECT_FALSE
(
by‹s1
 =ğ
by‹s2
);

614 
TEST
(
By‹sTe¡
, 
SaãIÃqu®™yO³¿tÜPos™ive1
) {

615 
	gSaãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

616 
	gSaãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

618 
EXPECT_TRUE
(
by‹s1
 !ğ
by‹s2
);

624 
TEST
(
By‹sTe¡
, 
Un§ãEqu®™yO³¿tÜNeg©ive1
) {

625 
	gUn§ãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

626 
	gUn§ãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

628 
EXPECT_FALSE
(
by‹s1
 =ğ
by‹s2
);

634 
TEST
(
By‹sTe¡
, 
Un§ãIÃqu®™yO³¿tÜPos™ive1
) {

635 
	gUn§ãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

636 
	gUn§ãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

638 
EXPECT_TRUE
(
by‹s1
 !ğ
by‹s2
);

641 
TEST
(
By‹sTe¡
, 
SaãP¬ams
) {

642 
EXPECT_EQ
(
SaãBy‹s
<
kSize
>::
size
(), kSize);

643 
EXPECT_EQ
(
SaãBy‹s
<
kSize
>::
pŞicy
(), 
D©aSaãty
::
SAFE
);

646 
TEST
(
By‹sTe¡
, 
Un§ãP¬ams
) {

647 
EXPECT_EQ
(
Un§ãBy‹s
<
kSize
>::
size
(), kSize);

648 
EXPECT_EQ
(
Un§ãBy‹s
<
kSize
>::
pŞicy
(), 
D©aSaãty
::
UNSAFE
);

	@crypto/util/bytes_test.cc

19 
	~"asylo/üy±o/ut/by‹s.h
"

21 
	~<®gÜ™hm
>

22 
	~<ty³_Œa™s
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 
size_t
 
	gkSize
 = 11;

34 
cÚ¡ex´
 
ušt8_t
 
	gkV®ue1
[
kSize
] = {'a', 'b', 'c', 'd', 'e', 'f',

36 
cÚ¡ex´
 
ušt8_t
 
	gkV®ue2
[
kSize
] = {'a', 'b', 'c', 'd', 'e', 'f',

38 
cÚ¡ex´
 
ušt8_t
 
	gkV®ue3
[
kSize
] = {'a', 'a', 'a', 'a', 'a', 'a',

41 
cÚ¡ex´
 
size_t
 
	gkL¬geSize
 = 13;

42 
cÚ¡ex´
 
ušt8_t
 
	gkL¬geV®ue
[
kL¬geSize
] = {'a', 'b', 'c', 'd', 'e', 'f', 'g',

46 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

47 şas 
	cTy³dBy‹sTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

48 
public
:

51 ::
‹¡šg
::
	tTy³s
<
	tSaãBy‹s
<
	tkSize
>, 
	tUn§ãBy‹s
<kSize>> 
	tMyTy³s
;

52 
TYPED_TEST_SUITE
(
Ty³dBy‹sTe¡
, 
MyTy³s
);

54 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®™yO³¿tÜPos™ive1
) {

55 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

56 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

58 
EXPECT_TRUE
(
by‹s1
 =ğ
by‹s2
);

61 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®™yO³¿tÜNeg©ive2
) {

62 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

63 
Ty³P¬am
 
by‹s2
(
kV®ue2
, 
kSize
);

65 
EXPECT_FALSE
(
by‹s1
 =ğ
by‹s2
);

68 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
IÃqu®™yO³¿tÜNeg©ive1
) {

69 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

70 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

72 
EXPECT_FALSE
(
by‹s1
 !ğ
by‹s2
);

75 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
IÃqu®™yO³¿tÜPos™ive2
) {

76 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

77 
Ty³P¬am
 
by‹s2
(
kV®ue2
, 
kSize
);

79 
EXPECT_TRUE
(
by‹s1
 !ğ
by‹s2
);

82 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®sPos™ive1
) {

83 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

85 
EXPECT_TRUE
(
by‹s1
.
Equ®s
(
kV®ue1
, 
kSize
));

88 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®sNeg©ive1
) {

89 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

91 
EXPECT_FALSE
(
by‹s1
.
Equ®s
(
kV®ue1
, 
kSize
 - 2));

94 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Equ®sNeg©ive2
) {

95 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

97 
EXPECT_FALSE
(
by‹s1
.
Equ®s
(
kV®ue2
, 
kSize
));

100 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CÚ¡ruùÜs
) {

101 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

102 
Ty³P¬am
 
by‹s2
(
kV®ue1
, kV®ue1 + 
kSize
);

104 
EXPECT_TRUE
(
by‹s1
 =ğ
by‹s2
);

107 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
T¿™s
) {

108 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
Ty³P¬am
>::
v®ue
);

110 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

111 
EXPECT_EQ
(
kSize
, (
by‹s
));

112 
EXPECT_EQ
(
kSize
, 
by‹s
.
size
());

113 
EXPECT_EQ
(
»š‹½»t_ÿ¡
<
ušŒ_t
>(&
by‹s
),

114 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
by‹s
.
d©a
()));

117 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Fl
) {

118 
Ty³P¬am
 
	gby‹s
;

120 
	gby‹s
.
fl
('a');

121 
EXPECT_EQ
(0, 
memcmp
(
by‹s
.
d©a
(), 
kV®ue3
, by‹s.
size
()));

124 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
S‘
) {

125 
Ty³P¬am
 
	gby‹s
;

127 
EXPECT_EQ
(
kSize
, 
by‹s
.
assign
(
kV®ue1
, kSize));

128 
EXPECT_EQ
(0, 
memcmp
(
by‹s
.
d©a
(), 
kV®ue1
, by‹s.
size
()));

131 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
S‘Sm®ËrIÅut
) {

132 
Ty³P¬am
 
	gby‹s
;

134 
EXPECT_EQ
(
kSize
 - 4, 
by‹s
.
assign
(
kV®ue1
, kSize - 4));

135 
EXPECT_EQ
(0, 
memcmp
(
by‹s
.
d©a
(), 
kV®ue1
, 
kSize
 - 4));

140 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
S‘L¬g”IÅut
) {

143 
	g¡d
::
veùÜ
<
ušt8_t
> 
tmp1
;

144 
	gtmp1
.
»size
(4096);

145 
mem£t
(
tmp1
.
d©a
(), 'a', 4096);

146 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
tmp1
.
d©a
()) TypeParam;

150 
	g¡d
::
veùÜ
<
ušt8_t
> 
tmp2
;

151 
	gtmp2
.
»size
(4096);

152 
mem£t
(
tmp2
.
d©a
(), 'b', 4096);

153 
EXPECT_EQ
(
by‹s
->
size
(), by‹s->
assign
(
tmp2
.
d©a
(), 4096));

157 
mem£t
(
tmp2
.
d©a
(è+ 
kSize
, 'a', 4096 - kSize);

160 
EXPECT_EQ
(
tmp2
, 
tmp1
);

165 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûPŒW™hšRªge
) {

166 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

167 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

168 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

170 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

171 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 
kV®ue2
, 
»que¡ed_»¶aû_couÁ
),

172 
ex³ùed_»¶aû_couÁ
);

174 
ušt8_t
 
	gbufãr
[
kSize
];

175 
memıy
(
bufãr
, 
kV®ue1
, 
kSize
);

176 
memıy
(
bufãr
 + 
»¶aû_pos
, 
kV®ue2
, 
ex³ùed_»¶aû_couÁ
);

177 
Ty³P¬am
 
by‹s2
(
bufãr
, 
kSize
);

179 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

184 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûV®ueW™hšRªge
) {

185 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

186 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

187 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 
kSize
 - 
»¶aû_pos
 - 1;

189 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

190 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 'a', 
»que¡ed_»¶aû_couÁ
),

191 
ex³ùed_»¶aû_couÁ
);

193 
ušt8_t
 
	gbufãr
[
kSize
];

194 
memıy
(
bufãr
, 
kV®ue1
, 
kSize
);

195 
mem£t
(
bufãr
 + 
»¶aû_pos
, 'a', 
ex³ùed_»¶aû_couÁ
);

196 
Ty³P¬am
 
by‹s2
(
bufãr
, 
kSize
);

198 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

204 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûPŒL¬geRªge
) {

205 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

206 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

207 
size_t
 
	gex³ùed_»¶aû_couÁ
 =

208 
¡d
::
mš
(
kSize
 - 
»¶aû_pos
, 
»que¡ed_»¶aû_couÁ
);

210 
ušt8_t
 
	gbufãr1
[256];

211 
mem£t
(
bufãr1
, 'x', (buffer1));

212 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
bufãr1
èTy³P¬am(
kV®ue1
, 
kSize
);

213 
EXPECT_EQ
(
by‹s
->
»¶aû
(
»¶aû_pos
, 
kV®ue2
, 
»que¡ed_»¶aû_couÁ
),

214 
ex³ùed_»¶aû_couÁ
);

216 
ušt8_t
 
	gbufãr2
[256];

217 
mem£t
(
bufãr2
, 'x', (
bufãr1
));

218 
memıy
(
bufãr2
, 
kV®ue1
, 
kSize
);

219 
memıy
(
bufãr2
 + 
»¶aû_pos
, 
kV®ue2
, 
ex³ùed_»¶aû_couÁ
);

221 
EXPECT_EQ
(
memcmp
(
bufãr1
, 
bufãr2
, (buffer1)), 0);

226 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûV®ueL¬geRªge
) {

227 
size_t
 
	g»¶aû_pos
 = 
kSize
 / 2;

228 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

229 
size_t
 
	gex³ùed_»¶aû_couÁ
 =

230 
¡d
::
mš
(
kSize
 - 
»¶aû_pos
, 
»que¡ed_»¶aû_couÁ
);

232 
ušt8_t
 
	gbufãr1
[256];

233 
mem£t
(
bufãr1
, 'x', (buffer1));

234 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
bufãr1
èTy³P¬am(
kV®ue1
, 
kSize
);

235 
EXPECT_EQ
(
by‹s
->
»¶aû
(
»¶aû_pos
, 'a', 
»que¡ed_»¶aû_couÁ
),

236 
ex³ùed_»¶aû_couÁ
);

238 
ušt8_t
 
	gbufãr2
[256];

239 
mem£t
(
bufãr2
, 'x', (
bufãr1
));

240 
memıy
(
bufãr2
, 
kV®ue1
, 
kSize
);

241 
mem£t
(
bufãr2
 + 
»¶aû_pos
, 'a', 
ex³ùed_»¶aû_couÁ
);

243 
EXPECT_EQ
(
memcmp
(
bufãr1
, 
bufãr2
, (buffer1)), 0);

248 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûPŒW™hL¬gePos
) {

249 
size_t
 
	g»¶aû_pos
 = 
kSize
 + 1;

250 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

251 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 0;

253 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

254 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 
kV®ue2
, 
»que¡ed_»¶aû_couÁ
),

255 
ex³ùed_»¶aû_couÁ
);

257 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

258 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

263 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
R•ÏûV®ueW™hL¬gePos
) {

264 
size_t
 
	g»¶aû_pos
 = 
kSize
 + 1;

265 
size_t
 
	g»que¡ed_»¶aû_couÁ
 = 
kSize
;

266 
size_t
 
	gex³ùed_»¶aû_couÁ
 = 0;

268 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

269 
EXPECT_EQ
(
by‹s
.
»¶aû
(
»¶aû_pos
, 'a', 
»que¡ed_»¶aû_couÁ
),

270 
ex³ùed_»¶aû_couÁ
);

272 
Ty³P¬am
 
by‹s2
(
kV®ue1
, 
kSize
);

273 
EXPECT_EQ
(
by‹s
, 
by‹s2
);

276 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CËª£
) {

277 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

278 
EXPECT_TRUE
(
by‹s
.
Equ®s
(
kV®ue1
, 
kSize
));

279 
	gby‹s
.
CËª£
();

280 
ušt8_t
 
	gbufãr
[
kSize
];

283 
mem£t
(
bufãr
, 0, 
kSize
);

284 
EXPECT_TRUE
(
by‹s
.
Equ®s
(
bufãr
, 
kSize
));

287 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
De¡ruùÜ
) {

288 
ušt8_t
 
	gbufãr1
[
kSize
];

291 
Ty³P¬am
 *
	gby‹s
 = 
Ãw
 (
bufãr1
èTy³P¬am(
kV®ue1
, 
kSize
);

293 
EXPECT_TRUE
(
by‹s
->
Equ®s
(
kV®ue1
, 
kSize
));

294 
	gby‹s
->~
Ty³P¬am
();

296 ià(
	gTy³P¬am
::
pŞicy
(è=ğ
D©aSaãty
::
SAFE
) {

300 
ušt8_t
 
bufãr2
[
kSize
];

301 
mem£t
(
bufãr2
, 0, 
kSize
);

302 
EXPECT_EQ
(0, 
memcmp
(
bufãr1
, 
bufãr2
, 
kSize
));

304 
EXPECT_EQ
(0, 
memcmp
(
bufãr1
, 
kV®ue1
, 
kSize
));

308 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
MubËI‹¿tÜBasic
) {

309 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

310 
Ty³P¬am
 
	gby‹s2
;

312 
	g¡d
::
cİy
(
by‹s1
.
begš
(), by‹s1.
’d
(), 
by‹s2
.begin());

313 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

314 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
by‹s1
.begin()));

316 
	g¡d
::
veùÜ
<
ušt8_t
> 
vec
;

317 
	gušt8_t
 &
	gch
 : 
by‹s1
) {

318 
vec
.
push_back
(
ch
);

320 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
vec
.begin()));

323 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Im¶ic™ImmubËI‹¿tÜBasic
) {

324 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

325 
Ty³P¬am
 
	gby‹s2
;

327 
	g¡d
::
cİy
(
by‹s1
.
begš
(), by‹s1.
’d
(), 
by‹s2
.begin());

328 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

329 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
by‹s1
.begin()));

331 
	g¡d
::
veùÜ
<
ušt8_t
> 
vec
;

332 cÚ¡ 
	gušt8_t
 &
	gch
 : 
by‹s1
) {

333 
vec
.
push_back
(
ch
);

335 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
vec
.begin()));

338 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Ex¶ic™ImmubËI‹¿tÜBasic
) {

339 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

340 
Ty³P¬am
 
	gby‹s2
;

342 
	g¡d
::
cİy
(
by‹s1
.
cbegš
(), by‹s1.
ûnd
(), 
by‹s2
.
begš
());

343 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

344 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
cbegš
(), by‹s2.
ûnd
(), 
by‹s1
.cbegin()));

346 
	g¡d
::
veùÜ
<
ušt8_t
> 
vec
;

347 cÚ¡ 
	gušt8_t
 &
	gch
 : 
by‹s1
) {

348 
vec
.
push_back
(
ch
);

350 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
begš
(), by‹s2.
’d
(), 
vec
.begin()));

353 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
MubËI‹¿tÜAr™hm‘icAndCom·risÚ
) {

354 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

356 
ty³Çme
 
	gTy³P¬am
::
™”©Ü
 
™1
 = 
by‹s1
.
begš
();

357 
ty³Çme
 
	gTy³P¬am
::
™”©Ü
 
™2
 = 
™1
 + 5;

358 
EXPECT_TRUE
(
™1
 < 
™2
);

359 
EXPECT_TRUE
(
™1
 <ğ
™2
);

360 
EXPECT_TRUE
(
™1
 !ğ
™2
);

361 
EXPECT_FALSE
(
™1
 > 
™2
);

362 
EXPECT_FALSE
(
™1
 >ğ
™2
);

363 
EXPECT_FALSE
(
™1
 =ğ
™2
);

364 
EXPECT_EQ
(
™2
 - 
™1
, 5);

365 
EXPECT_EQ
(*
™2
, 
™1
[5]);

366 
EXPECT_EQ
(
™1
 - 
™2
, -5);

367 
EXPECT_EQ
(
™2
[-5], *
™1
);

369 
	g™1
++;

370 ++
	g™1
;

371 
	g™1
 += 1;

372 
	g™1
 = 
™1
 + 1;

373 
	g™1
 = 1 + 
™1
;

374 
EXPECT_FALSE
(
™1
 < 
™2
);

375 
EXPECT_TRUE
(
™1
 <ğ
™2
);

376 
EXPECT_FALSE
(
™1
 !ğ
™2
);

377 
EXPECT_FALSE
(
™1
 > 
™2
);

378 
EXPECT_TRUE
(
™1
 >ğ
™2
);

379 
EXPECT_TRUE
(
™1
 =ğ
™2
);

380 
EXPECT_EQ
(
™2
 - 
™1
, 0);

381 
EXPECT_EQ
(*
™2
, 
™1
[0]);

382 
EXPECT_EQ
(
™1
 - 
™2
, 0);

383 
EXPECT_EQ
(
™2
[0], *
™1
);

385 
	g™2
--;

386 --
	g™2
;

387 
	g™2
 -= 1;

388 
	g™2
 = 
™2
 - 2;

389 
EXPECT_FALSE
(
™1
 < 
™2
);

390 
EXPECT_FALSE
(
™1
 <ğ
™2
);

391 
EXPECT_TRUE
(
™1
 !ğ
™2
);

392 
EXPECT_TRUE
(
™1
 > 
™2
);

393 
EXPECT_TRUE
(
™1
 >ğ
™2
);

394 
EXPECT_FALSE
(
™1
 =ğ
™2
);

395 
EXPECT_EQ
(
™2
 - 
™1
, -5);

396 
EXPECT_EQ
(
™2
[5], *
™1
);

397 
EXPECT_EQ
(
™1
 - 
™2
, 5);

398 
EXPECT_EQ
(*
™2
, 
™1
[-5]);

401 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Im¶ic™ImmubËI‹¿tÜAr™hm‘icAndCom·risÚ
) {

402 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

404 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™1
 = 
by‹s1
.
begš
();

405 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™2
 = 
™1
 + 5;

406 
EXPECT_TRUE
(
™1
 < 
™2
);

407 
EXPECT_TRUE
(
™1
 <ğ
™2
);

408 
EXPECT_TRUE
(
™1
 !ğ
™2
);

409 
EXPECT_FALSE
(
™1
 > 
™2
);

410 
EXPECT_FALSE
(
™1
 >ğ
™2
);

411 
EXPECT_FALSE
(
™1
 =ğ
™2
);

412 
EXPECT_EQ
(
™2
 - 
™1
, 5);

413 
EXPECT_EQ
(*
™2
, 
™1
[5]);

414 
EXPECT_EQ
(
™1
 - 
™2
, -5);

415 
EXPECT_EQ
(
™2
[-5], *
™1
);

417 
	g™1
++;

418 ++
	g™1
;

419 
	g™1
 += 1;

420 
	g™1
 = 
™1
 + 1;

421 
	g™1
 = 1 + 
™1
;

422 
EXPECT_FALSE
(
™1
 < 
™2
);

423 
EXPECT_TRUE
(
™1
 <ğ
™2
);

424 
EXPECT_FALSE
(
™1
 !ğ
™2
);

425 
EXPECT_FALSE
(
™1
 > 
™2
);

426 
EXPECT_TRUE
(
™1
 >ğ
™2
);

427 
EXPECT_TRUE
(
™1
 =ğ
™2
);

428 
EXPECT_EQ
(
™2
 - 
™1
, 0);

429 
EXPECT_EQ
(*
™2
, 
™1
[0]);

430 
EXPECT_EQ
(
™1
 - 
™2
, 0);

431 
EXPECT_EQ
(
™2
[0], *
™1
);

433 
	g™2
--;

434 --
	g™2
;

435 
	g™2
 -= 1;

436 
	g™2
 = 
™2
 - 2;

437 
EXPECT_FALSE
(
™1
 < 
™2
);

438 
EXPECT_FALSE
(
™1
 <ğ
™2
);

439 
EXPECT_TRUE
(
™1
 !ğ
™2
);

440 
EXPECT_TRUE
(
™1
 > 
™2
);

441 
EXPECT_TRUE
(
™1
 >ğ
™2
);

442 
EXPECT_FALSE
(
™1
 =ğ
™2
);

443 
EXPECT_EQ
(
™2
 - 
™1
, -5);

444 
EXPECT_EQ
(
™2
[5], *
™1
);

445 
EXPECT_EQ
(
™1
 - 
™2
, 5);

446 
EXPECT_EQ
(*
™2
, 
™1
[-5]);

449 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Ex¶ic™ImmubËI‹¿tÜAr™hm‘icAndCom·risÚ
) {

450 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

452 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™1
 = 
by‹s1
.
cbegš
();

453 
ty³Çme
 
	gTy³P¬am
::
cÚ¡_™”©Ü
 
™2
 = 
™1
 + 5;

454 
EXPECT_TRUE
(
™1
 < 
™2
);

455 
EXPECT_TRUE
(
™1
 <ğ
™2
);

456 
EXPECT_TRUE
(
™1
 !ğ
™2
);

457 
EXPECT_FALSE
(
™1
 > 
™2
);

458 
EXPECT_FALSE
(
™1
 >ğ
™2
);

459 
EXPECT_FALSE
(
™1
 =ğ
™2
);

460 
EXPECT_EQ
(
™2
 - 
™1
, 5);

461 
EXPECT_EQ
(*
™2
, 
™1
[5]);

462 
EXPECT_EQ
(
™1
 - 
™2
, -5);

463 
EXPECT_EQ
(
™2
[-5], *
™1
);

465 
	g™1
++;

466 ++
	g™1
;

467 
	g™1
 += 1;

468 
	g™1
 = 
™1
 + 1;

469 
	g™1
 = 1 + 
™1
;

470 
EXPECT_FALSE
(
™1
 < 
™2
);

471 
EXPECT_TRUE
(
™1
 <ğ
™2
);

472 
EXPECT_FALSE
(
™1
 !ğ
™2
);

473 
EXPECT_FALSE
(
™1
 > 
™2
);

474 
EXPECT_TRUE
(
™1
 >ğ
™2
);

475 
EXPECT_TRUE
(
™1
 =ğ
™2
);

476 
EXPECT_EQ
(
™2
 - 
™1
, 0);

477 
EXPECT_EQ
(*
™2
, 
™1
[0]);

478 
EXPECT_EQ
(
™1
 - 
™2
, 0);

479 
EXPECT_EQ
(
™2
[0], *
™1
);

481 
	g™2
--;

482 --
	g™2
;

483 
	g™2
 -= 1;

484 
	g™2
 = 
™2
 - 2;

485 
EXPECT_FALSE
(
™1
 < 
™2
);

486 
EXPECT_FALSE
(
™1
 <ğ
™2
);

487 
EXPECT_TRUE
(
™1
 !ğ
™2
);

488 
EXPECT_TRUE
(
™1
 > 
™2
);

489 
EXPECT_TRUE
(
™1
 >ğ
™2
);

490 
EXPECT_FALSE
(
™1
 =ğ
™2
);

491 
EXPECT_EQ
(
™2
 - 
™1
, -5);

492 
EXPECT_EQ
(
™2
[5], *
™1
);

493 
EXPECT_EQ
(
™1
 - 
™2
, 5);

494 
EXPECT_EQ
(*
™2
, 
™1
[-5]);

497 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
MubËRev”£I‹¿tÜBasic
) {

498 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

499 
Ty³P¬am
 
	gby‹s2
;

501 
	g¡d
::
cİy
(
by‹s1
.
rbegš
(), by‹s1.
»nd
(), 
by‹s2
.
begš
());

502 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
rbegš
(), by‹s2.
»nd
(), 
by‹s1
.
begš
()));

505 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Im¶ic™ImmubËRev”£I‹¿tÜBasic
) {

506 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

507 
Ty³P¬am
 
	gby‹s2
;

509 
	g¡d
::
cİy
(
by‹s1
.
rbegš
(), by‹s1.
»nd
(), 
by‹s2
.
begš
());

510 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
rbegš
(), by‹s2.
»nd
(), 
by‹s1
.
begš
()));

513 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
Ex¶ic™ImmubËRev”£I‹¿tÜBasic
) {

514 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

515 
Ty³P¬am
 
	gby‹s2
;

517 
	g¡d
::
cİy
(
by‹s1
.
übegš
(), by‹s1.
ü’d
(), 
by‹s2
.
begš
());

518 
EXPECT_TRUE
(
¡d
::
equ®
(
by‹s2
.
übegš
(), by‹s2.
ü’d
(), 
by‹s1
.
cbegš
()));

522 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CİyVŸSubsütO³¿tÜ
) {

523 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

524 
Ty³P¬am
 
	gby‹s2
;

526 
	gi
 = 0; i < 
	gby‹s1
.
size
(); i++) {

527 
	gby‹s2
[
i
] = 
by‹s1
[i];

529 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

533 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
CİyVŸAtM‘hod
) {

534 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

535 
Ty³P¬am
 
	gby‹s2
;

537 
	gi
 = 0; i < 
	gby‹s1
.
size
(); i++) {

538 
	gby‹s2
.
©
(
i
èğ
by‹s1
.at(i);

540 
EXPECT_EQ
(
by‹s1
, 
by‹s2
);

544 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
NewPÏûm’t
) {

545 
usšg
 
	gCom·tibËVeùÜ
 = 
¡d
::
veùÜ
<

546 , 
ty³Çme
 
	g¡d
::
®loÿtÜ_Œa™s
<ty³Çm
Ty³P¬am
::
®loÿtÜ_ty³
>::

547 
‹m¶©e
 
»bšd_®loc
<>>;

548 
usšg
 
	gSaãVeùÜ
 = 
¡d
::
veùÜ
<, 
	gCËªsšgAÎoÿtÜ
<>>;

550 cÚ¡ 
Ty³P¬am
 
by‹s1
(
kV®ue1
, 
kSize
);

553 
Com·tibËVeùÜ
 
vec1
(
kL¬geV®ue
, kLargeValue + (kLargeValue));

554 
Ty³P¬am
 *
	gby‹s2
;

556 
	gby‹s2
 = 
Ty³P¬am
::
PÏû
(&
vec1
, 0);

557 
ASSERT_NE
(
by‹s2
, 
nuÎ±r
);

558 
EXPECT_EQ
(
by‹s1
, *
by‹s2
);

560 
	gby‹s2
 = 
Ty³P¬am
::
PÏû
(&
vec1
, vec1.
size
() - TypeParam::size());

561 
ASSERT_NE
(
by‹s2
, 
nuÎ±r
);

563 
	gby‹s2
 = 
Ty³P¬am
::
PÏû
(&
vec1
, vec1.
size
() - TypeParam::size() + 1);

564 
EXPECT_EQ
(
by‹s2
, 
nuÎ±r
);

568 
SaãVeùÜ
 
vec2
(
kL¬geV®ue
, kLargeValue + (kLargeValue));

569 
Ty³P¬am
 *
	gby‹s3
;

571 
	gby‹s3
 = 
Ty³P¬am
::
PÏû
(&
vec2
, 0);

572 
ASSERT_NE
(
by‹s3
, 
nuÎ±r
);

573 
EXPECT_EQ
(
by‹s1
, *
by‹s3
);

575 
	gby‹s3
 = 
Ty³P¬am
::
PÏû
(&
vec2
, vec2.
size
() - TypeParam::size());

576 
ASSERT_NE
(
by‹s3
, 
nuÎ±r
);

578 
	gby‹s3
 = 
Ty³P¬am
::
PÏû
(&
vec2
, vec2.
size
() - TypeParam::size() + 1);

579 
EXPECT_EQ
(
by‹s3
, 
nuÎ±r
);

582 
TYPED_TEST
(
Ty³dBy‹sTe¡
, 
PrštTo
) {

583 
Ty³P¬am
 
by‹s
(
kV®ue1
, 
kSize
);

584 
	g¡d
::
¡ršg
 
¡r1
 = ::
‹¡šg
::
PrštToSŒšg
(
by‹s
);

585 
	g¡d
::
¡ršg
 
¡r2
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
by‹s
);

586 
EXPECT_EQ
(
¡r1
, 
¡r2
);

593 
TEST
(
By‹sTe¡
, 
Un§ãBy‹sIsTrivŸl
) {

594 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_deçuÉ_cÚ¡ruùibË
<
Un§ãBy‹s
<1>>::
v®ue
);

595 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_de¡ruùibË
<
Un§ãBy‹s
<1>>::
v®ue
);

596 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_cİy_cÚ¡ruùibË
<
Un§ãBy‹s
<1>>::
v®ue
);

597 
EXPECT_TRUE
(
¡d
::
is_ŒivŸÎy_cİyabË
<
Un§ãBy‹s
<1>>::
v®ue
);

598 
EXPECT_TRUE
(
¡d
::
is_ŒivŸl
<
Un§ãBy‹s
<1>>::
v®ue
);

604 
TEST
(
By‹sTe¡
, 
SaãEqu®™yO³¿tÜNeg©ive1
) {

605 
	gSaãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

606 
	gSaãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

608 
EXPECT_FALSE
(
by‹s1
 =ğ
by‹s2
);

614 
TEST
(
By‹sTe¡
, 
SaãIÃqu®™yO³¿tÜPos™ive1
) {

615 
	gSaãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

616 
	gSaãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

618 
EXPECT_TRUE
(
by‹s1
 !ğ
by‹s2
);

624 
TEST
(
By‹sTe¡
, 
Un§ãEqu®™yO³¿tÜNeg©ive1
) {

625 
	gUn§ãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

626 
	gUn§ãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

628 
EXPECT_FALSE
(
by‹s1
 =ğ
by‹s2
);

634 
TEST
(
By‹sTe¡
, 
Un§ãIÃqu®™yO³¿tÜPos™ive1
) {

635 
	gUn§ãBy‹s
<
	gkSize
> 
by‹s1
(
kV®ue1
, 
kSize
);

636 
	gUn§ãBy‹s
<
	gkSize
 + 4> 
by‹s2
(
kV®ue1
, 
kSize
);

638 
EXPECT_TRUE
(
by‹s1
 !ğ
by‹s2
);

641 
TEST
(
By‹sTe¡
, 
SaãP¬ams
) {

642 
EXPECT_EQ
(
SaãBy‹s
<
kSize
>::
size
(), kSize);

643 
EXPECT_EQ
(
SaãBy‹s
<
kSize
>::
pŞicy
(), 
D©aSaãty
::
SAFE
);

646 
TEST
(
By‹sTe¡
, 
Un§ãP¬ams
) {

647 
EXPECT_EQ
(
Un§ãBy‹s
<
kSize
>::
size
(), kSize);

648 
EXPECT_EQ
(
Un§ãBy‹s
<
kSize
>::
pŞicy
(), 
D©aSaãty
::
UNSAFE
);

	@crypto/util/trivial_object_util.h

19 #iâdeà
ASYLO_CRYPTO_UTIL_TRIVIAL_OBJECT_UTIL_H_


20 
	#ASYLO_CRYPTO_UTIL_TRIVIAL_OBJECT_UTIL_H_


	)

22 
	~<İ’s¦/¿nd.h
>

23 
	~<¡ršg
>

24 
	~<ty³_Œa™s
>

26 
	~"ab¦/¡ršgs/esÿpšg.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"asylo/ut/¡©us.h
"

31 
Çme¥aû
 
	gasylo
 {

34 
	g‹m¶©e
 <
şass
 
	gT
>

35 
Stus
 
S‘TrivŸlObjeùFromHexSŒšg
(
ab¦
::
¡ršg_v›w
 
v›w
, 
T
 *
obj
) {

36 #iâdeà
__ASYLO__


37 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

42 ià(
	gobj
 =ğ
nuÎ±r
) {

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

46 ià(
	gv›w
.
size
(è!ğ(
T
) * 2) {

47  
Stus
(

48 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

49 
ab¦
::
SŒC©
("ThsizoàthouuˆcÚš”: ", (
T
),

50 " mu¡ bthsizoàth¡ršg / 2: ", 
v›w
.
size
() / 2));

52 autØ
	gch
 : 
v›w
) {

53 ià(
¡d
::
isxdig™
(
ch
) == 0) {

54  
Stus
(

55 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

59 
	gab¦
::
HexSŒšgToBy‹s
(
v›w
).
cİy
(
»š‹½»t_ÿ¡
<*>(
obj
),

60 (*
obj
));

61  
	gStus
::
OkStus
();

64 
	g‹m¶©e
 <
şass
 
	gT
>

65 
	g¡d
::
¡ršg
 
CÚv”tTrivŸlObjeùToHexSŒšg
(cÚ¡ 
T
 &
obj
) {

66 #iâdeà
__ASYLO__


67 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

70  
	gab¦
::
By‹sToHexSŒšg
(

71 
ab¦
::
¡ršg_v›w
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
obj
), (obj)));

74 
	g‹m¶©e
 <
şass
 
	gT
>

75 
T
 
TrivŸlRªdomObjeù
() {

76 #iâdeà
__ASYLO__


77 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

80 
T
 
	gtmp
;

81 
RAND_by‹s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
tmp
), (tmp));

82  
	gtmp
;

85 
	g‹m¶©e
 <
şass
 
	gT
>

86 
T
 
TrivŸlZ”oObjeù
() {

87 #iâdeà
__ASYLO__


88 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

91 
T
 
	gtmp
;

92 
mem£t
(&
tmp
, 0, (tmp));

93  
	gtmp
;

96 
	g‹m¶©e
 <
şass
 
	gT
>

97 
T
 
TrivŸlOÃsObjeù
() {

98 #iâdeà
__ASYLO__


99 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

102 
T
 
	gtmp
;

103 
mem£t
(&
tmp
, 0xff, (tmp));

104  
	gtmp
;

107 
	g‹m¶©e
 <
şass
 
	gT
>

108 
Stus
 
S‘TrivŸlObjeùFromBš¬ySŒšg
(
ab¦
::
¡ršg_v›w
 
v›w
, 
T
 *
obj
) {

109 #iâdeà
__ASYLO__


110 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

113 ià(
	gv›w
.
size
(è!ğ(*
obj
)) {

114  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

115 
ab¦
::
SŒC©
("CªnÙ s‘‡ ", (*
obj
), "byte object",

116 " from‡ sŒšg oàsiz", 
v›w
.
size
()));

118 
memıy
(
obj
, 
v›w
.
d©a
(), v›w.
size
());

119  
	gStus
::
OkStus
();

122 
	g‹m¶©e
 <
şass
 
	gT
>

123 
	g¡d
::
¡ršg
 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(cÚ¡ 
T
 &
obj
) {

124 #iâdeà
__ASYLO__


125 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

128  
	g¡d
::
¡ršg
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
obj
), (obj));

	@crypto/util/trivial_object_util_test.cc

19 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

21 
	~<cùy³
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

36 
	sTrivŸlSŒuùu»
 {

37 
	gUn§ãBy‹s
<24> 
	gfoo
;

38 
ušt64_t
 
	gb¬
;

39 
ušt8_t
 
	gbaz
[10];

43 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
TrivŸlSŒuùu»
 &
fœ¡
, cÚ¡ 
	gTrivŸlSŒuùu»
 &
	g£cÚd
) {

44  
memcmp
(&
fœ¡
, &
£cÚd
, (first)) == 0;

48 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

49 şas 
	cTy³dTrivŸlObjeùUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

50 ::
‹¡šg
::
	tTy³s
<
	tUn§ãBy‹s
<16>, Un§ãBy‹s<32>, 
	tTrivŸlSŒuùu»
,

51 
	tušt64_t
>

52 
	tMyTy³s
;

53 
TYPED_TEST_SUITE
(
Ty³dTrivŸlObjeùUtTe¡
, 
MyTy³s
);

60 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
Rªdom
) {

61 
	gab¦
::
æ©_hash_£t
<
¡d
::
¡ršg
> 
£t
;

62 
	gi
 = 0; i < 16; i++) {

63 
Ty³P¬am
 
	gobj
 = 
TrivŸlRªdomObjeù
<TypeParam>();

64 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj
);

65 
EXPECT_TRUE
(
£t
.
em¶aû
(
¡r
).
£cÚd
);

67 autØ&
	gc
 : 
¡r
) {

68 
c
 = 
¡d
::
tŞow”
(c);

70 
Ty³P¬am
 
	gobj2
;

71 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

72 
EXPECT_EQ
(
obj
, 
obj2
);

74 autØ&
	gc
 : 
¡r
) {

75 
c
 = 
¡d
::
touµ”
(c);

77 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

78 
EXPECT_EQ
(
obj
, 
obj2
);

83 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
Z”o
) {

84 
Ty³P¬am
 
	gobj
 = 
TrivŸlZ”oObjeù
<TypeParam>();

85 cÚ¡ 
ušt8_t
 *
	g±r
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(&
obj
);

86 
	gi
 = 0; i < (
	gobj
); i++) {

87 
EXPECT_EQ
(
±r
[
i
], 0);

89 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj
);

90 autØ
	gc
 : 
¡r
) {

91 
EXPECT_EQ
(
c
, '0');

93 
Ty³P¬am
 
	gobj2
;

94 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

95 
EXPECT_EQ
(
obj
, 
obj2
);

99 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
OÃs
) {

100 
Ty³P¬am
 
	gobj
 = 
TrivŸlOÃsObjeù
<TypeParam>();

101 cÚ¡ 
ušt8_t
 *
	g±r
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(&
obj
);

102 
	gi
 = 0; i < (
	gobj
); i++) {

103 
EXPECT_EQ
(
±r
[
i
], 0xff);

106 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj
);

107 autØ&
	gc
 : 
¡r
) {

108 
c
 = 
¡d
::
tŞow”
(c);

109 
EXPECT_EQ
(
c
, 'f');

111 
Ty³P¬am
 
	gobj2
;

112 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

113 
EXPECT_EQ
(
obj
, 
obj2
);

115 autØ&
	gc
 : 
¡r
) {

116 
c
 = 
¡d
::
touµ”
(c);

117 
EXPECT_EQ
(
c
, 'F');

119 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

120 
EXPECT_EQ
(
obj
, 
obj2
);

124 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
Bš¬ySŒšgCÚv”siÚs
) {

125 
Ty³P¬am
 
	gobj1
 = 
TrivŸlRªdomObjeù
<TypeParam>();

127 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
obj1
);

128 
ASSERT_EQ
(
¡r
.
size
(), (
obj1
));

130 
Ty³P¬am
 
	gobj2
;

131 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromBš¬ySŒšg
(
¡r
, &
obj2
));

132 
EXPECT_EQ
(
obj1
, 
obj2
);

134 
	g¡r
.
push_back
('a');

135 
EXPECT_THAT
(
S‘TrivŸlObjeùFromBš¬ySŒšg
(
¡r
, &
obj2
), 
NÙ
(
IsOk
()));

	@crypto/util/trivial_object_util_test.cc

19 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

21 
	~<cùy³
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

36 
	sTrivŸlSŒuùu»
 {

37 
	gUn§ãBy‹s
<24> 
	gfoo
;

38 
ušt64_t
 
	gb¬
;

39 
ušt8_t
 
	gbaz
[10];

43 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
TrivŸlSŒuùu»
 &
fœ¡
, cÚ¡ 
	gTrivŸlSŒuùu»
 &
	g£cÚd
) {

44  
memcmp
(&
fœ¡
, &
£cÚd
, (first)) == 0;

48 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

49 şas 
	cTy³dTrivŸlObjeùUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

50 ::
‹¡šg
::
	tTy³s
<
	tUn§ãBy‹s
<16>, Un§ãBy‹s<32>, 
	tTrivŸlSŒuùu»
,

51 
	tušt64_t
>

52 
	tMyTy³s
;

53 
TYPED_TEST_SUITE
(
Ty³dTrivŸlObjeùUtTe¡
, 
MyTy³s
);

60 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
Rªdom
) {

61 
	gab¦
::
æ©_hash_£t
<
¡d
::
¡ršg
> 
£t
;

62 
	gi
 = 0; i < 16; i++) {

63 
Ty³P¬am
 
	gobj
 = 
TrivŸlRªdomObjeù
<TypeParam>();

64 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj
);

65 
EXPECT_TRUE
(
£t
.
em¶aû
(
¡r
).
£cÚd
);

67 autØ&
	gc
 : 
¡r
) {

68 
c
 = 
¡d
::
tŞow”
(c);

70 
Ty³P¬am
 
	gobj2
;

71 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

72 
EXPECT_EQ
(
obj
, 
obj2
);

74 autØ&
	gc
 : 
¡r
) {

75 
c
 = 
¡d
::
touµ”
(c);

77 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

78 
EXPECT_EQ
(
obj
, 
obj2
);

83 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
Z”o
) {

84 
Ty³P¬am
 
	gobj
 = 
TrivŸlZ”oObjeù
<TypeParam>();

85 cÚ¡ 
ušt8_t
 *
	g±r
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(&
obj
);

86 
	gi
 = 0; i < (
	gobj
); i++) {

87 
EXPECT_EQ
(
±r
[
i
], 0);

89 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj
);

90 autØ
	gc
 : 
¡r
) {

91 
EXPECT_EQ
(
c
, '0');

93 
Ty³P¬am
 
	gobj2
;

94 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

95 
EXPECT_EQ
(
obj
, 
obj2
);

99 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
OÃs
) {

100 
Ty³P¬am
 
	gobj
 = 
TrivŸlOÃsObjeù
<TypeParam>();

101 cÚ¡ 
ušt8_t
 *
	g±r
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(&
obj
);

102 
	gi
 = 0; i < (
	gobj
); i++) {

103 
EXPECT_EQ
(
±r
[
i
], 0xff);

106 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj
);

107 autØ&
	gc
 : 
¡r
) {

108 
c
 = 
¡d
::
tŞow”
(c);

109 
EXPECT_EQ
(
c
, 'f');

111 
Ty³P¬am
 
	gobj2
;

112 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

113 
EXPECT_EQ
(
obj
, 
obj2
);

115 autØ&
	gc
 : 
¡r
) {

116 
c
 = 
¡d
::
touµ”
(c);

117 
EXPECT_EQ
(
c
, 'F');

119 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
<
Ty³P¬am
>(
¡r
, &
obj2
));

120 
EXPECT_EQ
(
obj
, 
obj2
);

124 
TYPED_TEST
(
Ty³dTrivŸlObjeùUtTe¡
, 
Bš¬ySŒšgCÚv”siÚs
) {

125 
Ty³P¬am
 
	gobj1
 = 
TrivŸlRªdomObjeù
<TypeParam>();

127 
	g¡d
::
¡ršg
 
¡r
 = 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
obj1
);

128 
ASSERT_EQ
(
¡r
.
size
(), (
obj1
));

130 
Ty³P¬am
 
	gobj2
;

131 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromBš¬ySŒšg
(
¡r
, &
obj2
));

132 
EXPECT_EQ
(
obj1
, 
obj2
);

134 
	g¡r
.
push_back
('a');

135 
EXPECT_THAT
(
S‘TrivŸlObjeùFromBš¬ySŒšg
(
¡r
, &
obj2
), 
NÙ
(
IsOk
()));

	@daemon/identity/attestation_domain.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

21 
	~<fú.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/ty³s.h
>

25 
	~<uni¡d.h
>

26 
	~<¬¿y
>

27 
	~<û¼no
>

28 
	~<¡ršg
>

30 
	~"ab¦/¡ršgs/ascii.h
"

31 
	~"ab¦/¡ršgs/esÿpšg.h
"

32 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

33 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

34 
	~"asylo/üy±o/ut/bs¦_ut.h
"

35 
	~"asylo/ut/loggšg.h
"

36 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 
cÚ¡ex´
 
size_t
 
	gkA‰e¡©iÚDomašSize
 = 16;

42 
cÚ¡ex´
 
size_t
 
	gkA‰e¡©iÚDomašHexSize
 = 2 * 
kA‰e¡©iÚDomašSize
;

48 
cÚ¡ex´
 
	gkMaxA‰e¡©iÚDomašR—dA‰em±s
 = 5;

52 
Stus
 
G’”©eRªdomA‰e¡©iÚDomaš
(
¡d
::
¡ršg
 *
domaš
) {

53 
¡d
::
¬¿y
<, 
	gkA‰e¡©iÚDomašSize
> 
	gdomaš_š‹º®
;

54 ià(
RAND_by‹s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
domaš_š‹º®
.
d©a
()),

55 
domaš_š‹º®
.
size
()) != 1) {

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

57 
ab¦
::
SŒC©
("RAND_by‹ çed: ", 
Bs¦La¡E¼ÜSŒšg
()));

59 
	gdomaš
->
assign
(
domaš_š‹º®
.
d©a
(), domaš_š‹º®.
size
());

60  
	gStus
::
OkStus
();

72 
Stus
 
C»©eAndWr™eNewA‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
,

73 
¡d
::
¡ršg
 *
domaš
) {

75 
fd
 = 
İ’
(
domaš_fe_·th
, 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

77 ià(
	gfd
 < 0) {

78 ià(
	g”ºo
 =ğ
EEXIST
) {

79  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EEXIST
, "File‡lreadyƒxists");

81  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

89 ià(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
) != 0) {

92 
Stus
 
¡©us
(

93 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

95 
şo£
(
fd
);

96 
uÆšk
(
domaš_fe_·th
);

97  
	g¡©us
;

101 
Stus
 
	g¡©us
 = 
G’”©eRªdomA‰e¡©iÚDomaš
(
domaš
);

102 ià(!
	g¡©us
.
ok
()) {

103 
şo£
(
fd
);

104  
	g¡©us
;

106 
	g¡d
::
¡ršg
 
domaš_hex
 = 
ab¦
::
By‹sToHexSŒšg
(*
domaš
);

107 
	g»suÉ
 = 
wr™e
(
fd
, 
domaš_hex
.
d©a
(), domaš_hex.
size
());

108 ià(
	g»suÉ
 < 0 || 
	g¡©ic_ÿ¡
<
	gsize_t
>ÔesuÉè< 
	gdomaš_hex
.
size
()) {

109 
Stus
 
	g¡©us
 = Status(

110 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

111 
ab¦
::
SŒC©
("Unexpectedƒrror while writing machine id. The file ",

112 
domaš_fe_·th
, " may be damaged.",

114 
şo£
(
fd
);

115  
	g¡©us
;

117 
şo£
(
fd
);

118  
	gStus
::
OkStus
();

124 
Stus
 
P¬£A‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
,

125 
ab¦
::
¡ršg_v›w
 
domaš_hex
,

126 
¡d
::
¡ršg
 *
domaš
) {

127 cÚ¡‡utØ
ch
 : 
domaš_hex
) {

128 ià(!
ab¦
::
ascii_isxdig™
(
ch
)) {

129  
Stus
(

130 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

131 
ab¦
::
SŒC©
("Invalid‡ttestation-domain string. Removehe file ",

132 
domaš_fe_·th
, "‡ndry‡gain."));

135 *
	gdomaš
 = 
ab¦
::
HexSŒšgToBy‹s
(
domaš_hex
);

136  
	gStus
::
OkStus
();

142 
Stus
 
R—dExi¡šgA‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
,

143 
¡d
::
¡ršg
 *
domaš
) {

144 
©‹m±
 = 0; 
	g©‹m±
 < 
	gkMaxA‰e¡©iÚDomašR—dA‰em±s
;

145 
	g©‹m±
++) {

146 
	gfd
 = 
İ’
(
domaš_fe_·th
, 
O_RDONLY
);

147 ià(
	gfd
 < 0) {

148  
Stus
(

149 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

155 
	g¡d
::
¬¿y
<, 
	gkA‰e¡©iÚDomašHexSize
 + 1> 
	gdomaš_hex
;

156 
	g»tv®
 = 
»ad
(
fd
, 
domaš_hex
.
d©a
(), domaš_hex.
size
());

157 
şo£
(
fd
);

159 ià(
	g»tv®
 < 0) {

160  
Stus
(

161 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

164 ià(
	g¡©ic_ÿ¡
<
	gsize_t
>(
	g»tv®
è< 
	gkA‰e¡©iÚDomašHexSize
) {

168 
¦“p
(1);

171 ià(
	g¡©ic_ÿ¡
<
	gsize_t
>(
	g»tv®
è> 
	gkA‰e¡©iÚDomašHexSize
) {

172  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Machine id isoo†ong");

174  
P¬£A‰e¡©iÚDomaš
(

175 
domaš_fe_·th
,

176 
ab¦
::
¡ršg_v›w
(
domaš_hex
.
d©a
(), 
kA‰e¡©iÚDomašHexSize
),

177 
domaš
);

181  
Stus
(

182 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

183 
ab¦
::
SŒC©
("Unexpectedƒrror while„eading machine id. The file ",

184 
domaš_fe_·th
, " may be damaged.",

190 
Stus
 
G‘A‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
, 
¡d
::
¡ršg
 *
domaš
) {

192 
Stus
 
¡©us
 = 
C»©eAndWr™eNewA‰e¡©iÚDomaš
(
domaš_fe_·th
, 
domaš
);

193 ià(!
	g¡©us
.
Is
(
”rÜ
::
PosixE¼Ü
::
P_EEXIST
)) {

194  
¡©us
;

198  
R—dExi¡šgA‰e¡©iÚDomaš
(
domaš_fe_·th
, 
domaš
);

	@daemon/identity/attestation_domain.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

21 
	~<fú.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/ty³s.h
>

25 
	~<uni¡d.h
>

26 
	~<¬¿y
>

27 
	~<û¼no
>

28 
	~<¡ršg
>

30 
	~"ab¦/¡ršgs/ascii.h
"

31 
	~"ab¦/¡ršgs/esÿpšg.h
"

32 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

33 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

34 
	~"asylo/üy±o/ut/bs¦_ut.h
"

35 
	~"asylo/ut/loggšg.h
"

36 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 
cÚ¡ex´
 
size_t
 
	gkA‰e¡©iÚDomašSize
 = 16;

42 
cÚ¡ex´
 
size_t
 
	gkA‰e¡©iÚDomašHexSize
 = 2 * 
kA‰e¡©iÚDomašSize
;

48 
cÚ¡ex´
 
	gkMaxA‰e¡©iÚDomašR—dA‰em±s
 = 5;

52 
Stus
 
G’”©eRªdomA‰e¡©iÚDomaš
(
¡d
::
¡ršg
 *
domaš
) {

53 
¡d
::
¬¿y
<, 
	gkA‰e¡©iÚDomašSize
> 
	gdomaš_š‹º®
;

54 ià(
RAND_by‹s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
domaš_š‹º®
.
d©a
()),

55 
domaš_š‹º®
.
size
()) != 1) {

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

57 
ab¦
::
SŒC©
("RAND_by‹ çed: ", 
Bs¦La¡E¼ÜSŒšg
()));

59 
	gdomaš
->
assign
(
domaš_š‹º®
.
d©a
(), domaš_š‹º®.
size
());

60  
	gStus
::
OkStus
();

72 
Stus
 
C»©eAndWr™eNewA‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
,

73 
¡d
::
¡ršg
 *
domaš
) {

75 
fd
 = 
İ’
(
domaš_fe_·th
, 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

77 ià(
	gfd
 < 0) {

78 ià(
	g”ºo
 =ğ
EEXIST
) {

79  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EEXIST
, "File‡lreadyƒxists");

81  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

89 ià(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
) != 0) {

92 
Stus
 
¡©us
(

93 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

95 
şo£
(
fd
);

96 
uÆšk
(
domaš_fe_·th
);

97  
	g¡©us
;

101 
Stus
 
	g¡©us
 = 
G’”©eRªdomA‰e¡©iÚDomaš
(
domaš
);

102 ià(!
	g¡©us
.
ok
()) {

103 
şo£
(
fd
);

104  
	g¡©us
;

106 
	g¡d
::
¡ršg
 
domaš_hex
 = 
ab¦
::
By‹sToHexSŒšg
(*
domaš
);

107 
	g»suÉ
 = 
wr™e
(
fd
, 
domaš_hex
.
d©a
(), domaš_hex.
size
());

108 ià(
	g»suÉ
 < 0 || 
	g¡©ic_ÿ¡
<
	gsize_t
>ÔesuÉè< 
	gdomaš_hex
.
size
()) {

109 
Stus
 
	g¡©us
 = Status(

110 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

111 
ab¦
::
SŒC©
("Unexpectedƒrror while writing machine id. The file ",

112 
domaš_fe_·th
, " may be damaged.",

114 
şo£
(
fd
);

115  
	g¡©us
;

117 
şo£
(
fd
);

118  
	gStus
::
OkStus
();

124 
Stus
 
P¬£A‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
,

125 
ab¦
::
¡ršg_v›w
 
domaš_hex
,

126 
¡d
::
¡ršg
 *
domaš
) {

127 cÚ¡‡utØ
ch
 : 
domaš_hex
) {

128 ià(!
ab¦
::
ascii_isxdig™
(
ch
)) {

129  
Stus
(

130 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

131 
ab¦
::
SŒC©
("Invalid‡ttestation-domain string. Removehe file ",

132 
domaš_fe_·th
, "‡ndry‡gain."));

135 *
	gdomaš
 = 
ab¦
::
HexSŒšgToBy‹s
(
domaš_hex
);

136  
	gStus
::
OkStus
();

142 
Stus
 
R—dExi¡šgA‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
,

143 
¡d
::
¡ršg
 *
domaš
) {

144 
©‹m±
 = 0; 
	g©‹m±
 < 
	gkMaxA‰e¡©iÚDomašR—dA‰em±s
;

145 
	g©‹m±
++) {

146 
	gfd
 = 
İ’
(
domaš_fe_·th
, 
O_RDONLY
);

147 ià(
	gfd
 < 0) {

148  
Stus
(

149 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

155 
	g¡d
::
¬¿y
<, 
	gkA‰e¡©iÚDomašHexSize
 + 1> 
	gdomaš_hex
;

156 
	g»tv®
 = 
»ad
(
fd
, 
domaš_hex
.
d©a
(), domaš_hex.
size
());

157 
şo£
(
fd
);

159 ià(
	g»tv®
 < 0) {

160  
Stus
(

161 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

164 ià(
	g¡©ic_ÿ¡
<
	gsize_t
>(
	g»tv®
è< 
	gkA‰e¡©iÚDomašHexSize
) {

168 
¦“p
(1);

171 ià(
	g¡©ic_ÿ¡
<
	gsize_t
>(
	g»tv®
è> 
	gkA‰e¡©iÚDomašHexSize
) {

172  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Machine id isoo†ong");

174  
P¬£A‰e¡©iÚDomaš
(

175 
domaš_fe_·th
,

176 
ab¦
::
¡ršg_v›w
(
domaš_hex
.
d©a
(), 
kA‰e¡©iÚDomašHexSize
),

177 
domaš
);

181  
Stus
(

182 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

183 
ab¦
::
SŒC©
("Unexpectedƒrror while„eading machine id. The file ",

184 
domaš_fe_·th
, " may be damaged.",

190 
Stus
 
G‘A‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
, 
¡d
::
¡ršg
 *
domaš
) {

192 
Stus
 
¡©us
 = 
C»©eAndWr™eNewA‰e¡©iÚDomaš
(
domaš_fe_·th
, 
domaš
);

193 ià(!
	g¡©us
.
Is
(
”rÜ
::
PosixE¼Ü
::
P_EEXIST
)) {

194  
¡©us
;

198  
R—dExi¡šgA‰e¡©iÚDomaš
(
domaš_fe_·th
, 
domaš
);

	@daemon/identity/attestation_domain.h

19 #iâdeà
ASYLO_DAEMON_IDENTITY_ATTESTATION_DOMAIN_H_


20 
	#ASYLO_DAEMON_IDENTITY_ATTESTATION_DOMAIN_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

29 
cÚ¡ex´
 
size_t
 
	gkA‰e¡©iÚDomašNameSize
 = 16;

45 
Stus
 
G‘A‰e¡©iÚDomaš
(cÚ¡ *
domaš_fe_·th
, 
¡d
::
¡ršg
 *
domaš
);

	@daemon/identity/attestation_domain_client.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_ş›Á.h
"

21 
	~<memÜy
>

23 
Çme¥aû
 
	gasylo
 {

25 
	gStusOr
<
	g¡d
::
¡ršg
> 
A‰e¡©iÚDomašCl›Á
::
G‘A‰e¡©iÚDomaš
() {

26 ::
g½c
::
Cl›ÁCÚ‹xt
 
ş›Á_cÚ‹xt
;

28 
G‘A‰e¡©iÚDomašReque¡
 
	g»que¡
;

29 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

31 ::
g½c
::
Stus
 
g½c_¡©us
 =

32 
¡ub_
->
G‘A‰e¡©iÚDomaš
(&
ş›Á_cÚ‹xt
, 
»que¡
, &
»¥Ú£
);

33 ià(!
	gg½c_¡©us
.
ok
()) {

34  
Stus
(
g½c_¡©us
);

37  
	g»¥Ú£
.
©‹¡©iÚ_domaš
();

	@daemon/identity/attestation_domain_client.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_ş›Á.h
"

21 
	~<memÜy
>

23 
Çme¥aû
 
	gasylo
 {

25 
	gStusOr
<
	g¡d
::
¡ršg
> 
A‰e¡©iÚDomašCl›Á
::
G‘A‰e¡©iÚDomaš
() {

26 ::
g½c
::
Cl›ÁCÚ‹xt
 
ş›Á_cÚ‹xt
;

28 
G‘A‰e¡©iÚDomašReque¡
 
	g»que¡
;

29 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

31 ::
g½c
::
Stus
 
g½c_¡©us
 =

32 
¡ub_
->
G‘A‰e¡©iÚDomaš
(&
ş›Á_cÚ‹xt
, 
»que¡
, &
»¥Ú£
);

33 ià(!
	gg½c_¡©us
.
ok
()) {

34  
Stus
(
g½c_¡©us
);

37  
	g»¥Ú£
.
©‹¡©iÚ_domaš
();

	@daemon/identity/attestation_domain_client.h

19 #iâdeà
ASYLO_DAEMON_IDENTITY_ATTESTATION_DOMAIN_CLIENT_H_


20 
	#ASYLO_DAEMON_IDENTITY_ATTESTATION_DOMAIN_CLIENT_H_


	)

22 
	~<memÜy
>

23 
	~<¡ršg
>

25 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû.g½c.pb.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

27 
	~"šşude/g½ıp/g½ıp.h
"

29 
Çme¥aû
 
	gasylo
 {

31 şas 
	cA‰e¡©iÚDomašCl›Á
 {

32 
	gpublic
:

34 
ex¶ic™
 
A‰e¡©iÚDomašCl›Á
(

35 cÚ¡ 
¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlIÁ”çû
> &
chªÃl
)

36 : 
¡ub_
{
A‰e¡©iÚDomašS”viû
::
NewStub
(

37 
chªÃl
, ::
g½c
::
StubO±iÚs
())} {}

40 
ex¶ic™
 
A‰e¡©iÚDomašCl›Á
(

41 
¡d
::
unique_±r
<
A‰e¡©iÚDomašS”viû
::
StubIÁ”çû
> 
¡ub
)

42 : 
¡ub_
{
¡d
::
move
(
¡ub
)} {}

45 
StusOr
<
¡d
::
¡ršg
> 
G‘A‰e¡©iÚDomaš
();

47 
	g´iv©e
:

48 
¡d
::
unique_±r
<
A‰e¡©iÚDomašS”viû
::
StubIÁ”çû
> 
¡ub_
;

	@daemon/identity/attestation_domain_client_test.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_ş›Á.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû_mock.g½c.pb.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
_
;

34 
	gusšg
 ::
‹¡šg
::
DoAÎ
;

35 
	gusšg
 ::
‹¡šg
::
R‘uº
;

36 
	gusšg
 ::
‹¡šg
::
S‘ArgPoš‹e
;

38 
cÚ¡ex´
 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

42 
TEST
(
A‰e¡©iÚDomašCl›ÁMockTe¡
, 
GeA‰e¡©iÚDomaš
) {

43 autØ
	gmock_¡ub
 =

44 
ab¦
::
make_unique
<
MockA‰e¡©iÚDomašS”viûStub
>();

46 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

47 
	g»¥Ú£
.
£t_©‹¡©iÚ_domaš
(
kA‰e¡©iÚDomaš
);

49 
EXPECT_CALL
(*
mock_¡ub
, 
G‘A‰e¡©iÚDomaš
(
_
, _, _))

50 .
WlOnû
(
DoAÎ
(
S‘ArgPoš‹e
<2>(
»¥Ú£
), 
R‘uº
(::
g½c
::
Stus
::
OK
)));

52 
A‰e¡©iÚDomašCl›Á
 
ş›Á
(

53 
¡d
::
unique_±r
<
A‰e¡©iÚDomašS”viû
::
StubIÁ”çû
>(

54 
¡d
::
move
(
mock_¡ub
)));

56 
	gStusOr
<
	g¡d
::
¡ršg
> 
domaš_»suÉ
 = 
ş›Á
.
G‘A‰e¡©iÚDomaš
();

57 
ASSERT_THAT
(
domaš_»suÉ
, 
IsOk
());

58 
EXPECT_EQ
(
domaš_»suÉ
.
V®ueOrD›
(), 
kA‰e¡©iÚDomaš
);

63 
TEST
(
A‰e¡©iÚDomašCl›ÁMockTe¡
, 
GeA‰e¡©iÚDomašFas
) {

64 autØ
	gmock_¡ub
 =

65 
ab¦
::
make_unique
<
MockA‰e¡©iÚDomašS”viûStub
>();

67 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

68 
	g»¥Ú£
.
£t_©‹¡©iÚ_domaš
(
kA‰e¡©iÚDomaš
);

70 
EXPECT_CALL
(*
mock_¡ub
, 
G‘A‰e¡©iÚDomaš
(
_
, _, _))

71 .
WlOnû
(
R‘uº
(::
g½c
::
Stus
(::g½c::
StusCode
::
DEADLINE_EXCEEDED
,

74 
A‰e¡©iÚDomašCl›Á
 
ş›Á
(

75 
¡d
::
unique_±r
<
A‰e¡©iÚDomašS”viû
::
StubIÁ”çû
>(

76 
¡d
::
move
(
mock_¡ub
)));

78 
EXPECT_THAT
(
ş›Á
.
G‘A‰e¡©iÚDomaš
().
¡©us
(),

79 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
DEADLINE_EXCEEDED
));

	@daemon/identity/attestation_domain_client_test.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_ş›Á.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû_mock.g½c.pb.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
_
;

34 
	gusšg
 ::
‹¡šg
::
DoAÎ
;

35 
	gusšg
 ::
‹¡šg
::
R‘uº
;

36 
	gusšg
 ::
‹¡šg
::
S‘ArgPoš‹e
;

38 
cÚ¡ex´
 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

42 
TEST
(
A‰e¡©iÚDomašCl›ÁMockTe¡
, 
GeA‰e¡©iÚDomaš
) {

43 autØ
	gmock_¡ub
 =

44 
ab¦
::
make_unique
<
MockA‰e¡©iÚDomašS”viûStub
>();

46 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

47 
	g»¥Ú£
.
£t_©‹¡©iÚ_domaš
(
kA‰e¡©iÚDomaš
);

49 
EXPECT_CALL
(*
mock_¡ub
, 
G‘A‰e¡©iÚDomaš
(
_
, _, _))

50 .
WlOnû
(
DoAÎ
(
S‘ArgPoš‹e
<2>(
»¥Ú£
), 
R‘uº
(::
g½c
::
Stus
::
OK
)));

52 
A‰e¡©iÚDomašCl›Á
 
ş›Á
(

53 
¡d
::
unique_±r
<
A‰e¡©iÚDomašS”viû
::
StubIÁ”çû
>(

54 
¡d
::
move
(
mock_¡ub
)));

56 
	gStusOr
<
	g¡d
::
¡ršg
> 
domaš_»suÉ
 = 
ş›Á
.
G‘A‰e¡©iÚDomaš
();

57 
ASSERT_THAT
(
domaš_»suÉ
, 
IsOk
());

58 
EXPECT_EQ
(
domaš_»suÉ
.
V®ueOrD›
(), 
kA‰e¡©iÚDomaš
);

63 
TEST
(
A‰e¡©iÚDomašCl›ÁMockTe¡
, 
GeA‰e¡©iÚDomašFas
) {

64 autØ
	gmock_¡ub
 =

65 
ab¦
::
make_unique
<
MockA‰e¡©iÚDomašS”viûStub
>();

67 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

68 
	g»¥Ú£
.
£t_©‹¡©iÚ_domaš
(
kA‰e¡©iÚDomaš
);

70 
EXPECT_CALL
(*
mock_¡ub
, 
G‘A‰e¡©iÚDomaš
(
_
, _, _))

71 .
WlOnû
(
R‘uº
(::
g½c
::
Stus
(::g½c::
StusCode
::
DEADLINE_EXCEEDED
,

74 
A‰e¡©iÚDomašCl›Á
 
ş›Á
(

75 
¡d
::
unique_±r
<
A‰e¡©iÚDomašS”viû
::
StubIÁ”çû
>(

76 
¡d
::
move
(
mock_¡ub
)));

78 
EXPECT_THAT
(
ş›Á
.
G‘A‰e¡©iÚDomaš
().
¡©us
(),

79 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
DEADLINE_EXCEEDED
));

	@daemon/identity/attestation_domain_service_impl.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû_im¶.h
"

21 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

23 
Çme¥aû
 
	gasylo
 {

25 ::
g½c
::
Stus
 
A‰e¡©iÚDomašS”viûIm¶
::
G‘A‰e¡©iÚDomaš
(

26 ::
g½c
::
S”v”CÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
G‘A‰e¡©iÚDomašReque¡
 *
»que¡
,

27 
G‘A‰e¡©iÚDomašRe¥Ú£
 *
»¥Ú£
) {

28  ::
asylo
::
G‘A‰e¡©iÚDomaš
(

29 
domaš_fe_·th_
.
c_¡r
(), 
»¥Ú£
->
mubË_©‹¡©iÚ_domaš
())

30 .
	gToOth”Stus
<::
g½c
::
Stus
>();

	@daemon/identity/attestation_domain_service_impl.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû_im¶.h
"

21 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

23 
Çme¥aû
 
	gasylo
 {

25 ::
g½c
::
Stus
 
A‰e¡©iÚDomašS”viûIm¶
::
G‘A‰e¡©iÚDomaš
(

26 ::
g½c
::
S”v”CÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
G‘A‰e¡©iÚDomašReque¡
 *
»que¡
,

27 
G‘A‰e¡©iÚDomašRe¥Ú£
 *
»¥Ú£
) {

28  ::
asylo
::
G‘A‰e¡©iÚDomaš
(

29 
domaš_fe_·th_
.
c_¡r
(), 
»¥Ú£
->
mubË_©‹¡©iÚ_domaš
())

30 .
	gToOth”Stus
<::
g½c
::
Stus
>();

	@daemon/identity/attestation_domain_service_impl.h

19 #iâdeà
ASYLO_DAEMON_IDENTITY_ATTESTATION_DOMAIN_SERVICE_IMPL_H_


20 
	#ASYLO_DAEMON_IDENTITY_ATTESTATION_DOMAIN_SERVICE_IMPL_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû.g½c.pb.h
"

25 
	~"šşude/g½ıp/g½ıp.h
"

27 
Çme¥aû
 
	gasylo
 {

29 şas 
	cA‰e¡©iÚDomašS”viûIm¶
 
	gfš®


30 : 
public
 
A‰e¡©iÚDomašS”viû
::
S”viû
 {

31 
public
:

34 
ex¶ic™
 
A‰e¡©iÚDomašS”viûIm¶
(
¡d
::
¡ršg
 
domaš_fe_·th
)

35 : 
domaš_fe_·th_
{
¡d
::
move
(
domaš_fe_·th
)} {}

39 ::
g½c
::
Stus
 
G‘A‰e¡©iÚDomaš
(

40 ::
g½c
::
S”v”CÚ‹xt
 *
cÚ‹xt
,

41 cÚ¡ 
G‘A‰e¡©iÚDomašReque¡
 *
»que¡
,

42 
G‘A‰e¡©iÚDomašRe¥Ú£
 *
»¥Ú£
è
	gov”ride
;

44 
	g´iv©e
:

45 cÚ¡ 
¡d
::
¡ršg
 
domaš_fe_·th_
;

	@daemon/identity/attestation_domain_service_impl_test.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû_im¶.h
"

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/‹¡/ut/‹¡_æags.h
"

29 
	~"šşude/g½ıp/£rv”_cÚ‹xt.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašFeName
[] =

39 
TEST
(
A‰e¡©iÚDomašS”viûIm¶Te¡
, 
G‘A‰e¡©iÚDomaš
) {

40 
	g¡d
::
¡ršg
 
domaš_fe_·th
 =

41 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
kA‰e¡©iÚDomašFeName
);

42 
A‰e¡©iÚDomašS”viûIm¶
 
im¶
(
domaš_fe_·th
);

44 
G‘A‰e¡©iÚDomašReque¡
 
	g»que¡
;

45 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

46 ::
g½c
::
S”v”CÚ‹xt
 *
£rv”_cÚ‹xt
 = 
nuÎ±r
;

47 
ASSERT_THAT
(

48 
Stus
(
im¶
.
G‘A‰e¡©iÚDomaš
(
£rv”_cÚ‹xt
, &
»que¡
, &
»¥Ú£
)),

49 
IsOk
());

51 
	g¡d
::
¡ršg
 
domaš1
 = 
»¥Ú£
.
©‹¡©iÚ_domaš
();

52 
EXPECT_EQ
(
domaš1
.
size
(), 
kA‰e¡©iÚDomašNameSize
);

54 
	g»¥Ú£
.
CË¬
();

55 
ASSERT_THAT
(

56 
Stus
(
im¶
.
G‘A‰e¡©iÚDomaš
(
£rv”_cÚ‹xt
, &
»que¡
, &
»¥Ú£
)),

57 
IsOk
());

59 
	g¡d
::
¡ršg
 
domaš2
 = 
»¥Ú£
.
©‹¡©iÚ_domaš
();

60 
EXPECT_EQ
(
domaš1
, 
domaš2
);

	@daemon/identity/attestation_domain_service_impl_test.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš_£rviû_im¶.h
"

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/‹¡/ut/‹¡_æags.h
"

29 
	~"šşude/g½ıp/£rv”_cÚ‹xt.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašFeName
[] =

39 
TEST
(
A‰e¡©iÚDomašS”viûIm¶Te¡
, 
G‘A‰e¡©iÚDomaš
) {

40 
	g¡d
::
¡ršg
 
domaš_fe_·th
 =

41 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
kA‰e¡©iÚDomašFeName
);

42 
A‰e¡©iÚDomašS”viûIm¶
 
im¶
(
domaš_fe_·th
);

44 
G‘A‰e¡©iÚDomašReque¡
 
	g»que¡
;

45 
G‘A‰e¡©iÚDomašRe¥Ú£
 
	g»¥Ú£
;

46 ::
g½c
::
S”v”CÚ‹xt
 *
£rv”_cÚ‹xt
 = 
nuÎ±r
;

47 
ASSERT_THAT
(

48 
Stus
(
im¶
.
G‘A‰e¡©iÚDomaš
(
£rv”_cÚ‹xt
, &
»que¡
, &
»¥Ú£
)),

49 
IsOk
());

51 
	g¡d
::
¡ršg
 
domaš1
 = 
»¥Ú£
.
©‹¡©iÚ_domaš
();

52 
EXPECT_EQ
(
domaš1
.
size
(), 
kA‰e¡©iÚDomašNameSize
);

54 
	g»¥Ú£
.
CË¬
();

55 
ASSERT_THAT
(

56 
Stus
(
im¶
.
G‘A‰e¡©iÚDomaš
(
£rv”_cÚ‹xt
, &
»que¡
, &
»¥Ú£
)),

57 
IsOk
());

59 
	g¡d
::
¡ršg
 
domaš2
 = 
»¥Ú£
.
©‹¡©iÚ_domaš
();

60 
EXPECT_EQ
(
domaš1
, 
domaš2
);

	@daemon/identity/attestation_domain_test.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

21 
	~<sys/fe.h
>

22 
	~<uni¡d.h
>

23 
	~<c¡dlib
>

24 
	~<¡ršg
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/esÿpšg.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"asylo/‹¡/ut/‹¡_æags.h
"

32 
Çme¥aû
 
	gasylo
 {

34 
	gusšg
 ::
‹¡šg
::
NÙ
;

36 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
	gkAÎ0
[] = "00000000000000000000000000000000";

39 
cÚ¡ex´
 
	gkAÎF
[] = "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";

40 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašTooShÜt
[] = "FFFF";

41 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašTooLÚg
[] =

43 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašBadCh¬s
[] =

45 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašFeName
[] =

49 şas 
	cA‰e¡©iÚDomašTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

50 
´Ùeùed
:

51 
A‰e¡©iÚDomašTe¡
() {

52 
domaš_fe_·th_
 = 
FLAGS_‹¡_tmpdœ
 + 
kA‰e¡©iÚDomašFeName
;

55 ~
A‰e¡©iÚDomašTe¡
(è
	gov”ride
 {

57 
uÆšk
(
domaš_fe_·th_
.
c_¡r
());

60 
	g¡d
::
¡ršg
 
domaš_fe_·th_
;

63 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašR—dAÎ0
) {

64 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

65 
ASSERT_GT
(
fd
, 0);

66 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

67 
ASSERT_EQ
(
wr™e
(
fd
, 
kAÎ0
, (kAll0) - 1), (kAll0) - 1);

68 
EXPECT_EQ
(
şo£
(
fd
), 0);

70 
	g¡d
::
¡ršg
 
domaš
;

71 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
), 
IsOk
());

72 
EXPECT_EQ
(
domaš
, 
ab¦
::
HexSŒšgToBy‹s
(
kAÎ0
));

75 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašR—dAÎF
) {

76 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

77 
ASSERT_GT
(
fd
, 0);

78 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

79 
ASSERT_EQ
(
wr™e
(
fd
, 
kAÎF
, (kAllF) - 1), (kAllF) - 1);

80 
EXPECT_EQ
(
şo£
(
fd
), 0);

82 
	g¡d
::
¡ršg
 
domaš
;

83 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
), 
IsOk
());

84 
EXPECT_EQ
(
domaš
, 
ab¦
::
HexSŒšgToBy‹s
(
kAÎF
));

87 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašC»©e
) {

88 
	g¡d
::
¡ršg
 
domaš1
;

89 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš1
),

90 
IsOk
());

91 
ASSERT_EQ
(
domaš1
.
size
(), 
kA‰e¡©iÚDomašNameSize
);

93 
	g¡d
::
¡ršg
 
domaš2
;

94 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš2
),

95 
IsOk
());

96 
EXPECT_EQ
(
domaš1
, 
domaš2
);

99 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašTooShÜt
) {

100 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

101 
ASSERT_GT
(
fd
, 0);

102 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

103 
ASSERT_EQ
(
wr™e
(
fd
, 
kA‰e¡©iÚDomašTooShÜt
,

104 (
kA‰e¡©iÚDomašTooShÜt
) - 1),

105 (
kA‰e¡©iÚDomašTooShÜt
) - 1);

106 
EXPECT_EQ
(
şo£
(
fd
), 0);

108 
	g¡d
::
¡ršg
 
domaš
;

109 
EXPECT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
),

110 
NÙ
(
IsOk
()));

113 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašTooLÚg
) {

114 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

115 
ASSERT_GT
(
fd
, 0);

116 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

117 
ASSERT_EQ
(
wr™e
(
fd
, 
kA‰e¡©iÚDomašTooLÚg
,

118 (
kA‰e¡©iÚDomašTooLÚg
) - 1),

119 (
kA‰e¡©iÚDomašTooLÚg
) - 1);

120 
EXPECT_EQ
(
şo£
(
fd
), 0);

122 
	g¡d
::
¡ršg
 
domaš
;

123 
EXPECT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
),

124 
NÙ
(
IsOk
()));

127 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašBadCh¬s
) {

128 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

129 
ASSERT_GT
(
fd
, 0);

130 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

131 
ASSERT_EQ
(
wr™e
(
fd
, 
kA‰e¡©iÚDomašBadCh¬s
,

132 (
kA‰e¡©iÚDomašBadCh¬s
) - 1),

133 (
kA‰e¡©iÚDomašBadCh¬s
) - 1);

134 
EXPECT_EQ
(
şo£
(
fd
), 0);

136 
	g¡d
::
¡ršg
 
domaš
;

137 
EXPECT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
),

138 
NÙ
(
IsOk
()));

	@daemon/identity/attestation_domain_test.cc

19 
	~"asylo/d«mÚ/id’t™y/©‹¡©iÚ_domaš.h
"

21 
	~<sys/fe.h
>

22 
	~<uni¡d.h
>

23 
	~<c¡dlib
>

24 
	~<¡ršg
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/esÿpšg.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"asylo/‹¡/ut/‹¡_æags.h
"

32 
Çme¥aû
 
	gasylo
 {

34 
	gusšg
 ::
‹¡šg
::
NÙ
;

36 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
	gkAÎ0
[] = "00000000000000000000000000000000";

39 
cÚ¡ex´
 
	gkAÎF
[] = "FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF";

40 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašTooShÜt
[] = "FFFF";

41 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašTooLÚg
[] =

43 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašBadCh¬s
[] =

45 
cÚ¡ex´
 
	gkA‰e¡©iÚDomašFeName
[] =

49 şas 
	cA‰e¡©iÚDomašTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

50 
´Ùeùed
:

51 
A‰e¡©iÚDomašTe¡
() {

52 
domaš_fe_·th_
 = 
FLAGS_‹¡_tmpdœ
 + 
kA‰e¡©iÚDomašFeName
;

55 ~
A‰e¡©iÚDomašTe¡
(è
	gov”ride
 {

57 
uÆšk
(
domaš_fe_·th_
.
c_¡r
());

60 
	g¡d
::
¡ršg
 
domaš_fe_·th_
;

63 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašR—dAÎ0
) {

64 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

65 
ASSERT_GT
(
fd
, 0);

66 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

67 
ASSERT_EQ
(
wr™e
(
fd
, 
kAÎ0
, (kAll0) - 1), (kAll0) - 1);

68 
EXPECT_EQ
(
şo£
(
fd
), 0);

70 
	g¡d
::
¡ršg
 
domaš
;

71 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
), 
IsOk
());

72 
EXPECT_EQ
(
domaš
, 
ab¦
::
HexSŒšgToBy‹s
(
kAÎ0
));

75 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašR—dAÎF
) {

76 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

77 
ASSERT_GT
(
fd
, 0);

78 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

79 
ASSERT_EQ
(
wr™e
(
fd
, 
kAÎF
, (kAllF) - 1), (kAllF) - 1);

80 
EXPECT_EQ
(
şo£
(
fd
), 0);

82 
	g¡d
::
¡ršg
 
domaš
;

83 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
), 
IsOk
());

84 
EXPECT_EQ
(
domaš
, 
ab¦
::
HexSŒšgToBy‹s
(
kAÎF
));

87 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašC»©e
) {

88 
	g¡d
::
¡ršg
 
domaš1
;

89 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš1
),

90 
IsOk
());

91 
ASSERT_EQ
(
domaš1
.
size
(), 
kA‰e¡©iÚDomašNameSize
);

93 
	g¡d
::
¡ršg
 
domaš2
;

94 
ASSERT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš2
),

95 
IsOk
());

96 
EXPECT_EQ
(
domaš1
, 
domaš2
);

99 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašTooShÜt
) {

100 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

101 
ASSERT_GT
(
fd
, 0);

102 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

103 
ASSERT_EQ
(
wr™e
(
fd
, 
kA‰e¡©iÚDomašTooShÜt
,

104 (
kA‰e¡©iÚDomašTooShÜt
) - 1),

105 (
kA‰e¡©iÚDomašTooShÜt
) - 1);

106 
EXPECT_EQ
(
şo£
(
fd
), 0);

108 
	g¡d
::
¡ršg
 
domaš
;

109 
EXPECT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
),

110 
NÙ
(
IsOk
()));

113 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašTooLÚg
) {

114 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

115 
ASSERT_GT
(
fd
, 0);

116 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

117 
ASSERT_EQ
(
wr™e
(
fd
, 
kA‰e¡©iÚDomašTooLÚg
,

118 (
kA‰e¡©iÚDomašTooLÚg
) - 1),

119 (
kA‰e¡©iÚDomašTooLÚg
) - 1);

120 
EXPECT_EQ
(
şo£
(
fd
), 0);

122 
	g¡d
::
¡ršg
 
domaš
;

123 
EXPECT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
),

124 
NÙ
(
IsOk
()));

127 
TEST_F
(
A‰e¡©iÚDomašTe¡
, 
A‰e¡©iÚDomašBadCh¬s
) {

128 
	gfd
 = 
İ’
(
domaš_fe_·th_
.
c_¡r
(), 
O_EXCL
 | 
O_CREAT
 | 
O_RDWR
);

129 
ASSERT_GT
(
fd
, 0);

130 
ASSERT_EQ
(
fchmod
(
fd
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
), 0);

131 
ASSERT_EQ
(
wr™e
(
fd
, 
kA‰e¡©iÚDomašBadCh¬s
,

132 (
kA‰e¡©iÚDomašBadCh¬s
) - 1),

133 (
kA‰e¡©iÚDomašBadCh¬s
) - 1);

134 
EXPECT_EQ
(
şo£
(
fd
), 0);

136 
	g¡d
::
¡ršg
 
domaš
;

137 
EXPECT_THAT
(
G‘A‰e¡©iÚDomaš
(
domaš_fe_·th_
.
c_¡r
(), &
domaš
),

138 
NÙ
(
IsOk
()));

	@enclave.proto

17 
	gsyÁax
 = "proto2";

28 
·ckage
 
	gasylo
;

30 
	gimpÜt
 "asylo/identity/enclave_assertion_authority_config.proto";

31 
	gimpÜt
 "asylo/util/status.proto";

35 
mes§ge
 
	gHo¡CÚfig
 {

37 
İtiÚ®
 
¡ršg
 
	gloÿl_©‹¡©iÚ_domaš
 = 1;

42 
mes§ge
 
	gEnvœÚm’tV¬ŸbË
 {

44 
İtiÚ®
 
¡ršg
 
	gÇme
 = 1;

50 
İtiÚ®
 
¡ršg
 
	gv®ue
 = 2;

54 
mes§ge
 
	gLoggšgCÚfig
 {

57 
İtiÚ®
 
št32
 
	gvlog_Ëv–
 = 1 [ = 0];

60 
İtiÚ®
 
¡ršg
 
	glog_dœeùÜy
 = 2;

67 
mes§ge
 
	gEnşaveCÚfig
 {

70 
İtiÚ®
 
št32
 
	g¡dš_fd
 = 3 [ = 0];

74 
İtiÚ®
 
št32
 
	g¡dout_fd
 = 4 [ = 1];

78 
İtiÚ®
 
št32
 
	g¡d”r_fd
 = 5 [ = 2];

81 
İtiÚ®
 
¡ršg
 
	gho¡_Çme
 = 6;

84 
İtiÚ®
 
¡ršg
 
	gcu¼’t_wÜkšg_dœeùÜy
 = 7;

88 
İtiÚ®
 
Ho¡CÚfig
 
	gho¡_cÚfig
 = 8;

93 
»³©ed
 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
	g’şave_as£¹iÚ_authÜ™y_cÚfigs
 =

97 
»³©ed
 
EnvœÚm’tV¬ŸbË
 
	g’vœÚm’t_v¬ŸbËs
 = 10;

100 
İtiÚ®
 
LoggšgCÚfig
 
	gloggšg_cÚfig
 = 11;

104 
İtiÚ®
 
boŞ
 
	g’abË_fÜk
 = 12 [ = 
çl£
];

107 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

111 
mes§ge
 
	gEnşaveIÅut
 {

113 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

117 
mes§ge
 
	gEnşaveFš®
 {

119 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

123 
mes§ge
 
	gEnşaveSigÇl
 {

125 
İtiÚ®
 
št32
 
	gsignum
 = 1;

129 
İtiÚ®
 
št32
 
	gcode
 = 2;

133 
»³©ed
 
ušt64
 
	gg»gs
 = 3;

139 
mes§ge
 
	gEnşaveOuut
 {

142 
İtiÚ®
 
StusPrÙo
 
	g¡©us
 = 1;

145 
	gex‹nsiÚs
 1000 
to
 
	gmax
;

	@enclave_manager.h

19 #iâdeà
ASYLO_ENCLAVE_MANAGER_H_


20 
	#ASYLO_ENCLAVE_MANAGER_H_


	)

22 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

	@examples/grpc_server/grpc_server_driver.cc

19 
	~"asylo/ş›Á.h
"

20 
	~"asylo/exam¶es/g½c_£rv”/g½c_£rv”_cÚfig.pb.h
"

21 
	~"gæags/gæags.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

24 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

81 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

84 
DEFINE_št32
(
£rv”_max_liãtime
, 5,

87 
DEFINE_št32
(
£rv”_liãtime
, -1, "Deprecated‡lias for server_max_lifetime");

91 
DEFINE_št32
(
pÜt
, 0, "Porthathe server†istenso");

93 
cÚ¡ex´
 
	gkS”v”Add»ss
[] = "[::1]";

94 
	gasylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout_
;

97 
	$maš
(
¬gc
, *
¬gv
[]) {

99 
googË
::
	`P¬£CommªdLšeFÏgs
(

100 &
¬gc
, &
¬gv
, 
Œue
);

104 
asylo
::
SgxLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

108 
asylo
::
EnşaveCÚfig
 
cÚfig
;

109 
cÚfig
.
	`£t_’abË_fÜk
(
Œue
);

110 
cÚfig
.
	`S‘Ex‹nsiÚ
(
exam¶es
::
g½c_£rv”
::
£rv”_add»ss
, 
kS”v”Add»ss
);

111 
cÚfig
.
	`S‘Ex‹nsiÚ
(
exam¶es
::
g½c_£rv”
::
£rv”_max_liãtime
,

112 
FLAGS_£rv”_liãtime
 >= 0 ? FLAGS_server_lifetime

113 : 
FLAGS_£rv”_max_liãtime
);

114 
cÚfig
.
	`S‘Ex‹nsiÚ
(
exam¶es
::
g½c_£rv”
::
pÜt
, 
FLAGS_pÜt
);

117 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

118 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

119 
	`LOG_IF
(
QFATAL
, !
mªag”_»suÉ
.
	`ok
())

121 << 
mªag”_»suÉ
.
	`¡©us
();

122 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

126 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
("g½c_exam¶e", 
lßd”
, 
cÚfig
);

127 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
())

128 << "Lßd " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

132 
asylo
::
SgxCl›Á
 *
ş›Á
 = 
»š‹½»t_ÿ¡
<asylo::SgxCl›Á *>(
mªag”
->
	`G‘Cl›Á
("grpc_example"));

133 
asylo
::
EnşaveIÅut
 
šput
;

134 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, 
nuÎ±r
);

135 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
())

136 << "RuÂšg " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

178 
asylo
::
EnşaveFš®
 
fš®_šput
;

179 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
fš®_šput
);

180 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
())

181 << "De¡roy " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

184 
	}
}

	@examples/grpc_server/grpc_server_driver.cc

19 
	~"asylo/ş›Á.h
"

20 
	~"asylo/exam¶es/g½c_£rv”/g½c_£rv”_cÚfig.pb.h
"

21 
	~"gæags/gæags.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

24 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

81 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

84 
DEFINE_št32
(
£rv”_max_liãtime
, 5,

87 
DEFINE_št32
(
£rv”_liãtime
, -1, "Deprecated‡lias for server_max_lifetime");

91 
DEFINE_št32
(
pÜt
, 0, "Porthathe server†istenso");

93 
cÚ¡ex´
 
	gkS”v”Add»ss
[] = "[::1]";

94 
	gasylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout_
;

97 
	$maš
(
¬gc
, *
¬gv
[]) {

99 
googË
::
	`P¬£CommªdLšeFÏgs
(

100 &
¬gc
, &
¬gv
, 
Œue
);

104 
asylo
::
SgxLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

108 
asylo
::
EnşaveCÚfig
 
cÚfig
;

109 
cÚfig
.
	`£t_’abË_fÜk
(
Œue
);

110 
cÚfig
.
	`S‘Ex‹nsiÚ
(
exam¶es
::
g½c_£rv”
::
£rv”_add»ss
, 
kS”v”Add»ss
);

111 
cÚfig
.
	`S‘Ex‹nsiÚ
(
exam¶es
::
g½c_£rv”
::
£rv”_max_liãtime
,

112 
FLAGS_£rv”_liãtime
 >= 0 ? FLAGS_server_lifetime

113 : 
FLAGS_£rv”_max_liãtime
);

114 
cÚfig
.
	`S‘Ex‹nsiÚ
(
exam¶es
::
g½c_£rv”
::
pÜt
, 
FLAGS_pÜt
);

117 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

118 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

119 
	`LOG_IF
(
QFATAL
, !
mªag”_»suÉ
.
	`ok
())

121 << 
mªag”_»suÉ
.
	`¡©us
();

122 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

126 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
("g½c_exam¶e", 
lßd”
, 
cÚfig
);

127 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
())

128 << "Lßd " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

132 
asylo
::
SgxCl›Á
 *
ş›Á
 = 
»š‹½»t_ÿ¡
<asylo::SgxCl›Á *>(
mªag”
->
	`G‘Cl›Á
("grpc_example"));

133 
asylo
::
EnşaveIÅut
 
šput
;

134 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, 
nuÎ±r
);

135 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
())

136 << "RuÂšg " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

178 
asylo
::
EnşaveFš®
 
fš®_šput
;

179 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
fš®_šput
);

180 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
())

181 << "De¡roy " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

184 
	}
}

	@examples/grpc_server/grpc_server_enclave.cc

19 
	~<chrÚo
>

20 
	~<memÜy
>

21 
	~<sys/wa™.h
>

23 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

24 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

27 
	~"ab¦/synchrÚiz©iÚ/nÙifiÿtiÚ.h
"

28 
	~"ab¦/time/time.h
"

29 
	~"asylo/exam¶es/g½c_£rv”/g½c_£rv”_cÚfig.pb.h
"

30 
	~"asylo/exam¶es/g½c_£rv”/Œª¦©Ü_£rv”_im¶.h
"

31 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

32 
	~"asylo/ut/¡©us.h
"

33 
	~"šşude/g½ıp/g½ıp.h
"

34 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

35 
	~"šşude/g½ıp/£rv”.h
"

36 
	~"šşude/g½ıp/£rv”_bud”.h
"

38 
Çme¥aû
 
	gexam¶es
 {

39 
Çme¥aû
 
	gg½c_£rv”
 {

55 şas 
	cG½cS”v”Enşave
 
	gfš®
 : 
public
 
asylo
::
Tru¡edAµliÿtiÚ
 {

56 
public
:

57 
G½cS”v”Enşave
(è: 
£rviû_
(&
shutdown_»que¡ed_
) {}

59 
asylo
::
Stus
 
In™Ÿlize
(cÚ¡‡sylo::
EnşaveCÚfig
 &
’şave_cÚfig
)

60 
LOCKS_EXCLUDED
(
£rv”_mu‹x_
è
ov”ride
;

62 
	gasylo
::
Stus
 
Run
(cÚ¡ 
asylo
::
EnşaveIÅut
 &
’şave_šput
,

63 
asylo
::
EnşaveOuut
 *
’şave_ouut
è
ov”ride
;

65 
	gasylo
::
Stus
 
Fš®ize
(cÚ¡ 
asylo
::
EnşaveFš®
 &
’şave_fš®
)

66 
LOCKS_EXCLUDED
(
£rv”_mu‹x_
è
ov”ride
;

68 
	g´iv©e
:

70 
ab¦
::
Mu‹x
 
£rv”_mu‹x_
;

73 
	g¡d
::
unique_±r
<::
g½c
::
S”v”
> 
£rv”_
 
GUARDED_BY
(
£rv”_mu‹x_
);

76 
T¿n¦©ÜS”v”Im¶
 
	g£rviû_
;

79 
	gab¦
::
NÙifiÿtiÚ
 
shutdown_»que¡ed_
;

83 
	gab¦
::
Du¿tiÚ
 
shutdown_timeout_
;

86 
	gasylo
::
Stus
 
G½cS”v”Enşave
::
In™Ÿlize
(

87 cÚ¡ 
asylo
::
EnşaveCÚfig
 &
’şave_cÚfig
è
LOCKS_EXCLUDED
(
£rv”_mu‹x_
) {

89 ià(!
’şave_cÚfig
.
HasEx‹nsiÚ
(
£rv”_add»ss
)) {

90  
asylo
::
Stus
×sylo::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

95 ià(!
	g’şave_cÚfig
.
HasEx‹nsiÚ
(
£rv”_max_liãtime
)) {

96  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

100 ià(!
	g’şave_cÚfig
.
HasEx‹nsiÚ
(
pÜt
)) {

101  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
	gshutdown_timeout_
 =

106 
ab¦
::
SecÚds
(
’şave_cÚfig
.
G‘Ex‹nsiÚ
(
£rv”_max_liãtime
));

109 
	gab¦
::
Mu‹xLock
 
lock
(&
£rv”_mu‹x_
);

112 ià(
	g£rv”_
) {

113  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
,

118 ::
g½c
::
S”v”Bud”
 
bud”
;

126 
	g£Ëùed_pÜt
;

127 
	gbud”
.
AddLi¡’šgPÜt
(

128 
ab¦
::
SŒC©
(
’şave_cÚfig
.
G‘Ex‹nsiÚ
(
£rv”_add»ss
), ":",

129 
’şave_cÚfig
.
G‘Ex‹nsiÚ
(
pÜt
)),

130 ::
g½c
::
In£cu»S”v”C»d’tŸls
(), &
£Ëùed_pÜt
);

133 
	gbud”
.
Regi¡”S”viû
(&
£rviû_
);

136 
	g£rv”_
 = 
bud”
.
BudAndS¹
();

137 ià(!
	g£rv”_
) {

138  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

142 
LOG
(
INFO
è<< "S”v” s¹ed oÀpÜˆ" << 
	g£Ëùed_pÜt
;

144  
	gasylo
::
Stus
::
OkStus
();

147 
	gasylo
::
Stus
 
G½cS”v”Enşave
::
Run
(cÚ¡ 
asylo
::
EnşaveIÅut
 &
’şave_šput
,

148 
asylo
::
EnşaveOuut
 *
’şave_ouut
) {

150 
shutdown_»que¡ed_
.
Wa™FÜNÙifiÿtiÚW™hTimeout
(
shutdown_timeout_
);

153 
pid_t
 
	gpid
 = 
fÜk
();

155 ià(
	gpid
 < 0) {

156 
abÜt
();

158 ià(
	gpid
 == 0) {

166 
¡©us
;

167 ià(
wa™
(&
¡©us
) == -1) {

168  
asylo
::
Stus
(
¡©ic_ÿ¡
<asylo::
”rÜ
::
PosixE¼Ü
>(
”ºo
),

169 
ab¦
::
SŒC©
("Error waiting for child: ",

170 
¡»¼Ü
(
”ºo
)));

173 ià(!
WIFEXITED
(
¡©us
)) {

174  
	gasylo
::
Stus
::
OkStus
();

181  
	gasylo
::
Stus
::
OkStus
();

184 
	gasylo
::
Stus
 
G½cS”v”Enşave
::
Fš®ize
(

185 cÚ¡ 
asylo
::
EnşaveFš®
 &
’şave_fš®
è
LOCKS_EXCLUDED
(
£rv”_mu‹x_
) {

187 
ab¦
::
Mu‹xLock
 
lock
(&
£rv”_mu‹x_
);

191 ià(
	g£rv”_
) {

193 
LOG
(
INFO
) << "Server shutting down";

195 
	g£rv”_
->
Shutdown
(
¡d
::
chrÚo
::
sy¡em_şock
::
now
() +

196 
¡d
::
chrÚo
::
mli£cÚds
(500));

197 
LOG
(
INFO
) << "Server shutting down1123123123.ldh";

198 
	g£rv”_
.
»£t
(
nuÎ±r
);

201  
	gasylo
::
Stus
::
OkStus
();

207 
Çme¥aû
 
	gasylo
 {

209 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

210  
Ãw
 
	gexam¶es
::
g½c_£rv”
::
G½cS”v”Enşave
;

	@examples/grpc_server/grpc_server_enclave.cc

19 
	~<chrÚo
>

20 
	~<memÜy
>

21 
	~<sys/wa™.h
>

23 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

24 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

27 
	~"ab¦/synchrÚiz©iÚ/nÙifiÿtiÚ.h
"

28 
	~"ab¦/time/time.h
"

29 
	~"asylo/exam¶es/g½c_£rv”/g½c_£rv”_cÚfig.pb.h
"

30 
	~"asylo/exam¶es/g½c_£rv”/Œª¦©Ü_£rv”_im¶.h
"

31 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

32 
	~"asylo/ut/¡©us.h
"

33 
	~"šşude/g½ıp/g½ıp.h
"

34 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

35 
	~"šşude/g½ıp/£rv”.h
"

36 
	~"šşude/g½ıp/£rv”_bud”.h
"

38 
Çme¥aû
 
	gexam¶es
 {

39 
Çme¥aû
 
	gg½c_£rv”
 {

55 şas 
	cG½cS”v”Enşave
 
	gfš®
 : 
public
 
asylo
::
Tru¡edAµliÿtiÚ
 {

56 
public
:

57 
G½cS”v”Enşave
(è: 
£rviû_
(&
shutdown_»que¡ed_
) {}

59 
asylo
::
Stus
 
In™Ÿlize
(cÚ¡‡sylo::
EnşaveCÚfig
 &
’şave_cÚfig
)

60 
LOCKS_EXCLUDED
(
£rv”_mu‹x_
è
ov”ride
;

62 
	gasylo
::
Stus
 
Run
(cÚ¡ 
asylo
::
EnşaveIÅut
 &
’şave_šput
,

63 
asylo
::
EnşaveOuut
 *
’şave_ouut
è
ov”ride
;

65 
	gasylo
::
Stus
 
Fš®ize
(cÚ¡ 
asylo
::
EnşaveFš®
 &
’şave_fš®
)

66 
LOCKS_EXCLUDED
(
£rv”_mu‹x_
è
ov”ride
;

68 
	g´iv©e
:

70 
ab¦
::
Mu‹x
 
£rv”_mu‹x_
;

73 
	g¡d
::
unique_±r
<::
g½c
::
S”v”
> 
£rv”_
 
GUARDED_BY
(
£rv”_mu‹x_
);

76 
T¿n¦©ÜS”v”Im¶
 
	g£rviû_
;

79 
	gab¦
::
NÙifiÿtiÚ
 
shutdown_»que¡ed_
;

83 
	gab¦
::
Du¿tiÚ
 
shutdown_timeout_
;

86 
	gasylo
::
Stus
 
G½cS”v”Enşave
::
In™Ÿlize
(

87 cÚ¡ 
asylo
::
EnşaveCÚfig
 &
’şave_cÚfig
è
LOCKS_EXCLUDED
(
£rv”_mu‹x_
) {

89 ià(!
’şave_cÚfig
.
HasEx‹nsiÚ
(
£rv”_add»ss
)) {

90  
asylo
::
Stus
×sylo::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

95 ià(!
	g’şave_cÚfig
.
HasEx‹nsiÚ
(
£rv”_max_liãtime
)) {

96  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

100 ià(!
	g’şave_cÚfig
.
HasEx‹nsiÚ
(
pÜt
)) {

101  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
	gshutdown_timeout_
 =

106 
ab¦
::
SecÚds
(
’şave_cÚfig
.
G‘Ex‹nsiÚ
(
£rv”_max_liãtime
));

109 
	gab¦
::
Mu‹xLock
 
lock
(&
£rv”_mu‹x_
);

112 ià(
	g£rv”_
) {

113  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
,

118 ::
g½c
::
S”v”Bud”
 
bud”
;

126 
	g£Ëùed_pÜt
;

127 
	gbud”
.
AddLi¡’šgPÜt
(

128 
ab¦
::
SŒC©
(
’şave_cÚfig
.
G‘Ex‹nsiÚ
(
£rv”_add»ss
), ":",

129 
’şave_cÚfig
.
G‘Ex‹nsiÚ
(
pÜt
)),

130 ::
g½c
::
In£cu»S”v”C»d’tŸls
(), &
£Ëùed_pÜt
);

133 
	gbud”
.
Regi¡”S”viû
(&
£rviû_
);

136 
	g£rv”_
 = 
bud”
.
BudAndS¹
();

137 ià(!
	g£rv”_
) {

138  
	gasylo
::
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

142 
LOG
(
INFO
è<< "S”v” s¹ed oÀpÜˆ" << 
	g£Ëùed_pÜt
;

144  
	gasylo
::
Stus
::
OkStus
();

147 
	gasylo
::
Stus
 
G½cS”v”Enşave
::
Run
(cÚ¡ 
asylo
::
EnşaveIÅut
 &
’şave_šput
,

148 
asylo
::
EnşaveOuut
 *
’şave_ouut
) {

150 
shutdown_»que¡ed_
.
Wa™FÜNÙifiÿtiÚW™hTimeout
(
shutdown_timeout_
);

153 
pid_t
 
	gpid
 = 
fÜk
();

155 ià(
	gpid
 < 0) {

156 
abÜt
();

158 ià(
	gpid
 == 0) {

166 
¡©us
;

167 ià(
wa™
(&
¡©us
) == -1) {

168  
asylo
::
Stus
(
¡©ic_ÿ¡
<asylo::
”rÜ
::
PosixE¼Ü
>(
”ºo
),

169 
ab¦
::
SŒC©
("Error waiting for child: ",

170 
¡»¼Ü
(
”ºo
)));

173 ià(!
WIFEXITED
(
¡©us
)) {

174  
	gasylo
::
Stus
::
OkStus
();

181  
	gasylo
::
Stus
::
OkStus
();

184 
	gasylo
::
Stus
 
G½cS”v”Enşave
::
Fš®ize
(

185 cÚ¡ 
asylo
::
EnşaveFš®
 &
’şave_fš®
è
LOCKS_EXCLUDED
(
£rv”_mu‹x_
) {

187 
ab¦
::
Mu‹xLock
 
lock
(&
£rv”_mu‹x_
);

191 ià(
	g£rv”_
) {

193 
LOG
(
INFO
) << "Server shutting down";

195 
	g£rv”_
->
Shutdown
(
¡d
::
chrÚo
::
sy¡em_şock
::
now
() +

196 
¡d
::
chrÚo
::
mli£cÚds
(500));

197 
LOG
(
INFO
) << "Server shutting down1123123123.ldh";

198 
	g£rv”_
.
»£t
(
nuÎ±r
);

201  
	gasylo
::
Stus
::
OkStus
();

207 
Çme¥aû
 
	gasylo
 {

209 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

210  
Ãw
 
	gexam¶es
::
g½c_£rv”
::
G½cS”v”Enşave
;

	@examples/grpc_server/grpc_server_test.cc

19 
	~<sys/wa™.h
>

20 
	~<io¡»am
>

21 
	~<memÜy
>

22 
	~<»gex
>

23 
	~<¡ršg
>

24 
	~<th»ad
>

25 
	~<tu¶e
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"ab¦/¡ršgs/numb”s.h
"

33 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

34 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

35 
	~"asylo/exam¶es/g½c_£rv”/Œª¦©Ü_£rv”.g½c.pb.h
"

36 
	~"gæags/gæags.h
"

37 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"šşude/g½ıp/g½ıp.h
"

41 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

42 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

44 
DEFINE_¡ršg
(
’şave_·th
, "",

47 
DEFINE_št32
(
£rv”_max_liãtime
, 10,

51 
cÚ¡ex´
 
	gkPÜtMes§geRegex
[] = "Server started on…ort [0-9]+";

53 
Çme¥aû
 
	gexam¶es
 {

54 
Çme¥aû
 
	gg½c_£rv”
 {

55 
	gÇme¥aû
 {

57 
usšg
 
	gasylo
::
IsOk
;

58 
usšg
 
	gasylo
::
StusIs
;

63 şas 
	cS”v”EnşaveExecTe¡”
 : 
public
 
asylo
::
ex³rim’l
::
ExecTe¡”
 {

64 
public
:

65 
S”v”EnşaveExecTe¡”
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gs
,

66 
ab¦
::
Mu‹x
 *
£rv”_pÜt_mu‹x
, *
£rv”_pÜt
)

67 : 
ExecTe¡”
(
¬gs
),

68 
£rv”_pÜt_found_
(
çl£
),

69 
£rv”_th»ad_¡©e_mu‹x_
(
£rv”_pÜt_mu‹x
),

70 
£rv”_pÜt_
(
£rv”_pÜt
) {}

72 
	g´Ùeùed
:

73 
boŞ
 
CheckLše
(cÚ¡ 
¡d
::
¡ršg
 &
lše
è
ov”ride


74 
LOCKS_EXCLUDED
(*
£rv”_th»ad_¡©e_mu‹x_
) {

75 cÚ¡ 
¡d
::
»gex
 
pÜt_mes§ge_»gex
(
kPÜtMes§geRegex
);

76 cÚ¡ 
	g¡d
::
»gex
 
pÜt_»gex
("[0-9]+");

80 
	g¡d
::
cm©ch
 
pÜt_mes§ge_m©ch
;

81 ià(
	g¡d
::
»gex_£¬ch
(
lše
.
c_¡r
(), 
pÜt_mes§ge_m©ch
,

82 
pÜt_mes§ge_»gex
)) {

85 
	g¡d
::
¡ršg
 
pÜt_mes§ge_m©ch_¡ršg
 = 
pÜt_mes§ge_m©ch
.
¡r
();

86 
	g¡d
::
cm©ch
 
pÜt_m©ch
;

87 
EXPECT_TRUE
(
¡d
::
»gex_£¬ch
(
pÜt_mes§ge_m©ch_¡ršg
.
c_¡r
(),

88 
pÜt_m©ch
, 
pÜt_»gex
))

89 << 
	gab¦
::
SŒC©
("Could‚ot find…ort‚umber in \"",

90 
pÜt_mes§ge_m©ch_¡ršg
, "\"");

91 
	g£rv”_pÜt_found_
 = 
Œue
;

92 
	gab¦
::
Mu‹xLock
 
lock
(
£rv”_th»ad_¡©e_mu‹x_
);

93 
EXPECT_TRUE
(
ab¦
::
Sim¶eAtoi
(
pÜt_m©ch
.
¡r
(), 
£rv”_pÜt_
))

94 << 
	gab¦
::
SŒC©
("Could‚Ù cÚv”ˆ\"", 
pÜt_m©ch
.
¡r
(),

99 
	g¡d
::
cout
 << 
lše
 << 
¡d
::
’dl
;

100  
	gŒue
;

103 
boŞ
 
Fš®Check
(boŞ 
accumuÏ‹d
è
ov”ride


104 
LOCKS_EXCLUDED
(*
£rv”_th»ad_¡©e_mu‹x_
) {

105  
	gaccumuÏ‹d
 && 
	g£rv”_pÜt_found_
;

108 
boŞ
 
	g£rv”_pÜt_found_
;

109 
	gab¦
::
Mu‹x
 *
£rv”_th»ad_¡©e_mu‹x_
;

110 *
£rv”_pÜt_
 
PT_GUARDED_BY
(*
£rv”_th»ad_¡©e_mu‹x_
);

113 şas 
	cG½cS”v”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

114 
public
:

117 
S‘Up
(è
ov”ride
 
LOCKS_EXCLUDED
(
£rv”_th»ad_¡©e_mu‹x_
) {

118 
ASSERT_NE
(
FLAGS_’şave_·th
, "");

120 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gv
({

121 
asylo
::
ex³rim’l
::
ExecTe¡”
::
BudSiblšgP©h
(

122 
FLAGS_’şave_·th
, "grpc_server_host_loader"),

123 
ab¦
::
SŒC©
("--’şave_·th=", 
FLAGS_’şave_·th
),

124 
ab¦
::
SŒC©
("--£rv”_max_liãtime=", 
FLAGS_£rv”_max_liãtime
),

127 
	g£rv”_pÜt_found_
 = 
çl£
;

133 
	gab¦
::
Mu‹xLock
 
lock
(&
£rv”_th»ad_¡©e_mu‹x_
);

134 
	g£rv”_th»ad_fšished_
 = 
çl£
;

135 
	g£rv”_pÜt_
 = -1;

139 
	g£rv”_th»ad_
 = 
ab¦
::
make_unique
<
¡d
::
th»ad
>(

140 [
this
](cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gv
) {

141 
S”v”EnşaveExecTe¡”
 
£rv”_ruÂ”
(

142 
¬gv
, &
£rv”_th»ad_¡©e_mu‹x_
, &
£rv”_pÜt_
);

143 
	g£rv”_pÜt_found_
 =

144 
£rv”_ruÂ”
.
Run
Ğ"", &
£rv”_ex™_¡©us_
);

145 
	gab¦
::
Mu‹xLock
 
lock
(&
£rv”_th»ad_¡©e_mu‹x_
);

146 
	g£rv”_th»ad_fšished_
 = 
Œue
;

148 
	g¬gv
);

151 
	gpÜt
 = 
G‘S”v”PÜt
();

152 
ASSERT_NE
(
pÜt
, -1)

156 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
üed’tŸls
 =

157 ::
g½c
::
In£cu»ChªÃlC»d’tŸls
();

158 
	g¡d
::
¡ršg
 
£rv”_add»ss
 = 
ab¦
::
SŒC©
("dns:///loÿlho¡:", 
pÜt
);

159 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl
 =

160 ::
g½c
::
C»©eChªÃl
(
£rv”_add»ss
, 
üed’tŸls
);

161 
	g¡ub_
 = 
T¿n¦©Ü
::
NewStub
(
chªÃl
);

164 
T—rDown
(è
	gov”ride
 {

165 ::
g½c
::
Cl›ÁCÚ‹xt
 
cÚ‹xt
;

166 
ShutdownReque¡
 
	g»que¡
;

167 
ShutdownRe¥Ú£
 
	g»¥Ú£
;

168 
EXPECT_THAT
(
asylo
::
Stus
(
¡ub_
->
Shutdown
(&
cÚ‹xt
, 
»que¡
, &
»¥Ú£
)),

169 
IsOk
());

171 
	g£rv”_th»ad_
->
još
();

172 
ASSERT_TRUE
(
£rv”_pÜt_found_
);

173 
ASSERT_TRUE
(
WIFEXITED
(
£rv”_ex™_¡©us_
))

174 << (
WIFSIGNALED
(
£rv”_ex™_¡©us_
)

175 ? 
	gab¦
::
SŒC©
("Server subprocess killed by signal ",

176 
WTERMSIG
(
£rv”_ex™_¡©us_
))

178 
EXPECT_EQ
(
WEXITSTATUS
(
£rv”_ex™_¡©us_
), 0)

179 << 
	gab¦
::
SŒC©
("Server subprocessƒxited with‚on-zero status ",

180 
WEXITSTATUS
(
£rv”_ex™_¡©us_
));

186 
	gasylo
::
Stus
 
MakeRpc
(cÚ¡ 
¡d
::
¡ršg
 &
šput_wÜd
,

187 
¡d
::
¡ršg
 *
Œª¦©ed_wÜd
) {

188 ::
g½c
::
Cl›ÁCÚ‹xt
 
cÚ‹xt
;

189 
G‘T¿n¦©iÚReque¡
 
	g»que¡
;

190 
G‘T¿n¦©iÚRe¥Ú£
 
	g»¥Ú£
;

192 
	g»que¡
.
£t_šput_wÜd
(
šput_wÜd
);

193 ::
g½c
::
Stus
 
¡©us
 = 
¡ub_
->
G‘T¿n¦©iÚ
(&
cÚ‹xt
, 
»que¡
, &
»¥Ú£
);

194 ià(
	g¡©us
.
ok
()) {

195 *
	gŒª¦©ed_wÜd
 = 
»¥Ú£
.
Œª¦©ed_wÜd
();

198  
	gasylo
::
Stus
(
¡©us
);

201 
	g´iv©e
:

204 
G‘S”v”PÜt
(è
LOCKS_EXCLUDED
(
£rv”_th»ad_¡©e_mu‹x_
) {

205 
¡d
::
tu¶e
<*, 
	gboŞ
 *> 
	g¬gs
 =

206 
¡d
::
make_tu¶e
(&
£rv”_pÜt_
, &
£rv”_th»ad_fšished_
);

207 
	g£rv”_th»ad_¡©e_mu‹x_
.
LockWh’
(
ab¦
::
CÚd™iÚ
(

208 +[](
¡d
::
tu¶e
<*, 
boŞ
 *> *
¬gs
) {

209 *
£rv”_pÜt
 = 
¡d
::
g‘
<0>(*
¬gs
);

210 
boŞ
 *
£rv”_th»ad_fšished
 = 
¡d
::
g‘
<1>(*
¬gs
);

211  *
£rv”_pÜt
 !ğ-1 || *
£rv”_th»ad_fšished
;

213 &
¬gs
));

214 
	g»suÉ
 = 
£rv”_pÜt_
;

215 
	g£rv”_th»ad_¡©e_mu‹x_
.
UÆock
();

216  
	g»suÉ
;

219 
	g¡d
::
unique_±r
<
¡d
::
th»ad
> 
£rv”_th»ad_
;

223 
boŞ
 
	g£rv”_pÜt_found_
;

224 
	g£rv”_ex™_¡©us_
;

226 
	gab¦
::
Mu‹x
 
£rv”_th»ad_¡©e_mu‹x_
;

227 
boŞ
 
£rv”_th»ad_fšished_
 
GUARDED_BY
(
£rv”_th»ad_¡©e_mu‹x_
);

228 
£rv”_pÜt_
 
GUARDED_BY
(
£rv”_th»ad_¡©e_mu‹x_
);

230 
	g¡d
::
unique_±r
<
T¿n¦©Ü
::
Stub
> 
¡ub_
;

233 
TEST_F
(
G½cS”v”Te¡
, 
AsyloT¿n¦©esToSªùu¬y
) {

234 
	g¡d
::
¡ršg
 
asylo_Œª¦©iÚ
;

235 
ASSERT_THAT
(
MakeRpc
("asylo", &
asylo_Œª¦©iÚ
), 
IsOk
());

236 
EXPECT_EQ
(
asylo_Œª¦©iÚ
, "sanctuary");

239 
TEST_F
(
G½cS”v”Te¡
, 
I¡ioT¿n¦©esToSa
) {

240 
	g¡d
::
¡ršg
 
i¡io_Œª¦©iÚ
;

241 
ASSERT_THAT
(
MakeRpc
("i¡io", &
i¡io_Œª¦©iÚ
), 
IsOk
());

242 
EXPECT_EQ
(
i¡io_Œª¦©iÚ
, "sail");

245 
TEST_F
(
G½cS”v”Te¡
, 
Kub”Ã‹sT¿n¦©esToH–msmª
) {

246 
	g¡d
::
¡ršg
 
kub”Ã‹s_Œª¦©iÚ
;

247 
ASSERT_THAT
(
MakeRpc
("kub”Ã‹s", &
kub”Ã‹s_Œª¦©iÚ
), 
IsOk
());

248 
EXPECT_EQ
(
kub”Ã‹s_Œª¦©iÚ
, "helmsman");

251 
TEST_F
(
G½cS”v”Te¡
, 
OrkutT¿n¦©iÚNÙFound
) {

252 
	g¡d
::
¡ršg
 
Ükut_Œª¦©iÚ
;

253 
	gasylo
::
Stus
 
¡©us
 = 
MakeRpc
("Ükut", &
Ükut_Œª¦©iÚ
);

254 
EXPECT_THAT
(
¡©us
, 
StusIs
(
asylo
::
”rÜ
::
INVALID_ARGUMENT
,

	@examples/grpc_server/grpc_server_test.cc

19 
	~<sys/wa™.h
>

20 
	~<io¡»am
>

21 
	~<memÜy
>

22 
	~<»gex
>

23 
	~<¡ršg
>

24 
	~<th»ad
>

25 
	~<tu¶e
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"ab¦/¡ršgs/numb”s.h
"

33 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

34 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

35 
	~"asylo/exam¶es/g½c_£rv”/Œª¦©Ü_£rv”.g½c.pb.h
"

36 
	~"gæags/gæags.h
"

37 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"šşude/g½ıp/g½ıp.h
"

41 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

42 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

44 
DEFINE_¡ršg
(
’şave_·th
, "",

47 
DEFINE_št32
(
£rv”_max_liãtime
, 10,

51 
cÚ¡ex´
 
	gkPÜtMes§geRegex
[] = "Server started on…ort [0-9]+";

53 
Çme¥aû
 
	gexam¶es
 {

54 
Çme¥aû
 
	gg½c_£rv”
 {

55 
	gÇme¥aû
 {

57 
usšg
 
	gasylo
::
IsOk
;

58 
usšg
 
	gasylo
::
StusIs
;

63 şas 
	cS”v”EnşaveExecTe¡”
 : 
public
 
asylo
::
ex³rim’l
::
ExecTe¡”
 {

64 
public
:

65 
S”v”EnşaveExecTe¡”
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gs
,

66 
ab¦
::
Mu‹x
 *
£rv”_pÜt_mu‹x
, *
£rv”_pÜt
)

67 : 
ExecTe¡”
(
¬gs
),

68 
£rv”_pÜt_found_
(
çl£
),

69 
£rv”_th»ad_¡©e_mu‹x_
(
£rv”_pÜt_mu‹x
),

70 
£rv”_pÜt_
(
£rv”_pÜt
) {}

72 
	g´Ùeùed
:

73 
boŞ
 
CheckLše
(cÚ¡ 
¡d
::
¡ršg
 &
lše
è
ov”ride


74 
LOCKS_EXCLUDED
(*
£rv”_th»ad_¡©e_mu‹x_
) {

75 cÚ¡ 
¡d
::
»gex
 
pÜt_mes§ge_»gex
(
kPÜtMes§geRegex
);

76 cÚ¡ 
	g¡d
::
»gex
 
pÜt_»gex
("[0-9]+");

80 
	g¡d
::
cm©ch
 
pÜt_mes§ge_m©ch
;

81 ià(
	g¡d
::
»gex_£¬ch
(
lše
.
c_¡r
(), 
pÜt_mes§ge_m©ch
,

82 
pÜt_mes§ge_»gex
)) {

85 
	g¡d
::
¡ršg
 
pÜt_mes§ge_m©ch_¡ršg
 = 
pÜt_mes§ge_m©ch
.
¡r
();

86 
	g¡d
::
cm©ch
 
pÜt_m©ch
;

87 
EXPECT_TRUE
(
¡d
::
»gex_£¬ch
(
pÜt_mes§ge_m©ch_¡ršg
.
c_¡r
(),

88 
pÜt_m©ch
, 
pÜt_»gex
))

89 << 
	gab¦
::
SŒC©
("Could‚ot find…ort‚umber in \"",

90 
pÜt_mes§ge_m©ch_¡ršg
, "\"");

91 
	g£rv”_pÜt_found_
 = 
Œue
;

92 
	gab¦
::
Mu‹xLock
 
lock
(
£rv”_th»ad_¡©e_mu‹x_
);

93 
EXPECT_TRUE
(
ab¦
::
Sim¶eAtoi
(
pÜt_m©ch
.
¡r
(), 
£rv”_pÜt_
))

94 << 
	gab¦
::
SŒC©
("Could‚Ù cÚv”ˆ\"", 
pÜt_m©ch
.
¡r
(),

99 
	g¡d
::
cout
 << 
lše
 << 
¡d
::
’dl
;

100  
	gŒue
;

103 
boŞ
 
Fš®Check
(boŞ 
accumuÏ‹d
è
ov”ride


104 
LOCKS_EXCLUDED
(*
£rv”_th»ad_¡©e_mu‹x_
) {

105  
	gaccumuÏ‹d
 && 
	g£rv”_pÜt_found_
;

108 
boŞ
 
	g£rv”_pÜt_found_
;

109 
	gab¦
::
Mu‹x
 *
£rv”_th»ad_¡©e_mu‹x_
;

110 *
£rv”_pÜt_
 
PT_GUARDED_BY
(*
£rv”_th»ad_¡©e_mu‹x_
);

113 şas 
	cG½cS”v”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

114 
public
:

117 
S‘Up
(è
ov”ride
 
LOCKS_EXCLUDED
(
£rv”_th»ad_¡©e_mu‹x_
) {

118 
ASSERT_NE
(
FLAGS_’şave_·th
, "");

120 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gv
({

121 
asylo
::
ex³rim’l
::
ExecTe¡”
::
BudSiblšgP©h
(

122 
FLAGS_’şave_·th
, "grpc_server_host_loader"),

123 
ab¦
::
SŒC©
("--’şave_·th=", 
FLAGS_’şave_·th
),

124 
ab¦
::
SŒC©
("--£rv”_max_liãtime=", 
FLAGS_£rv”_max_liãtime
),

127 
	g£rv”_pÜt_found_
 = 
çl£
;

133 
	gab¦
::
Mu‹xLock
 
lock
(&
£rv”_th»ad_¡©e_mu‹x_
);

134 
	g£rv”_th»ad_fšished_
 = 
çl£
;

135 
	g£rv”_pÜt_
 = -1;

139 
	g£rv”_th»ad_
 = 
ab¦
::
make_unique
<
¡d
::
th»ad
>(

140 [
this
](cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gv
) {

141 
S”v”EnşaveExecTe¡”
 
£rv”_ruÂ”
(

142 
¬gv
, &
£rv”_th»ad_¡©e_mu‹x_
, &
£rv”_pÜt_
);

143 
	g£rv”_pÜt_found_
 =

144 
£rv”_ruÂ”
.
Run
Ğ"", &
£rv”_ex™_¡©us_
);

145 
	gab¦
::
Mu‹xLock
 
lock
(&
£rv”_th»ad_¡©e_mu‹x_
);

146 
	g£rv”_th»ad_fšished_
 = 
Œue
;

148 
	g¬gv
);

151 
	gpÜt
 = 
G‘S”v”PÜt
();

152 
ASSERT_NE
(
pÜt
, -1)

156 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
üed’tŸls
 =

157 ::
g½c
::
In£cu»ChªÃlC»d’tŸls
();

158 
	g¡d
::
¡ršg
 
£rv”_add»ss
 = 
ab¦
::
SŒC©
("dns:///loÿlho¡:", 
pÜt
);

159 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl
 =

160 ::
g½c
::
C»©eChªÃl
(
£rv”_add»ss
, 
üed’tŸls
);

161 
	g¡ub_
 = 
T¿n¦©Ü
::
NewStub
(
chªÃl
);

164 
T—rDown
(è
	gov”ride
 {

165 ::
g½c
::
Cl›ÁCÚ‹xt
 
cÚ‹xt
;

166 
ShutdownReque¡
 
	g»que¡
;

167 
ShutdownRe¥Ú£
 
	g»¥Ú£
;

168 
EXPECT_THAT
(
asylo
::
Stus
(
¡ub_
->
Shutdown
(&
cÚ‹xt
, 
»que¡
, &
»¥Ú£
)),

169 
IsOk
());

171 
	g£rv”_th»ad_
->
još
();

172 
ASSERT_TRUE
(
£rv”_pÜt_found_
);

173 
ASSERT_TRUE
(
WIFEXITED
(
£rv”_ex™_¡©us_
))

174 << (
WIFSIGNALED
(
£rv”_ex™_¡©us_
)

175 ? 
	gab¦
::
SŒC©
("Server subprocess killed by signal ",

176 
WTERMSIG
(
£rv”_ex™_¡©us_
))

178 
EXPECT_EQ
(
WEXITSTATUS
(
£rv”_ex™_¡©us_
), 0)

179 << 
	gab¦
::
SŒC©
("Server subprocessƒxited with‚on-zero status ",

180 
WEXITSTATUS
(
£rv”_ex™_¡©us_
));

186 
	gasylo
::
Stus
 
MakeRpc
(cÚ¡ 
¡d
::
¡ršg
 &
šput_wÜd
,

187 
¡d
::
¡ršg
 *
Œª¦©ed_wÜd
) {

188 ::
g½c
::
Cl›ÁCÚ‹xt
 
cÚ‹xt
;

189 
G‘T¿n¦©iÚReque¡
 
	g»que¡
;

190 
G‘T¿n¦©iÚRe¥Ú£
 
	g»¥Ú£
;

192 
	g»que¡
.
£t_šput_wÜd
(
šput_wÜd
);

193 ::
g½c
::
Stus
 
¡©us
 = 
¡ub_
->
G‘T¿n¦©iÚ
(&
cÚ‹xt
, 
»que¡
, &
»¥Ú£
);

194 ià(
	g¡©us
.
ok
()) {

195 *
	gŒª¦©ed_wÜd
 = 
»¥Ú£
.
Œª¦©ed_wÜd
();

198  
	gasylo
::
Stus
(
¡©us
);

201 
	g´iv©e
:

204 
G‘S”v”PÜt
(è
LOCKS_EXCLUDED
(
£rv”_th»ad_¡©e_mu‹x_
) {

205 
¡d
::
tu¶e
<*, 
	gboŞ
 *> 
	g¬gs
 =

206 
¡d
::
make_tu¶e
(&
£rv”_pÜt_
, &
£rv”_th»ad_fšished_
);

207 
	g£rv”_th»ad_¡©e_mu‹x_
.
LockWh’
(
ab¦
::
CÚd™iÚ
(

208 +[](
¡d
::
tu¶e
<*, 
boŞ
 *> *
¬gs
) {

209 *
£rv”_pÜt
 = 
¡d
::
g‘
<0>(*
¬gs
);

210 
boŞ
 *
£rv”_th»ad_fšished
 = 
¡d
::
g‘
<1>(*
¬gs
);

211  *
£rv”_pÜt
 !ğ-1 || *
£rv”_th»ad_fšished
;

213 &
¬gs
));

214 
	g»suÉ
 = 
£rv”_pÜt_
;

215 
	g£rv”_th»ad_¡©e_mu‹x_
.
UÆock
();

216  
	g»suÉ
;

219 
	g¡d
::
unique_±r
<
¡d
::
th»ad
> 
£rv”_th»ad_
;

223 
boŞ
 
	g£rv”_pÜt_found_
;

224 
	g£rv”_ex™_¡©us_
;

226 
	gab¦
::
Mu‹x
 
£rv”_th»ad_¡©e_mu‹x_
;

227 
boŞ
 
£rv”_th»ad_fšished_
 
GUARDED_BY
(
£rv”_th»ad_¡©e_mu‹x_
);

228 
£rv”_pÜt_
 
GUARDED_BY
(
£rv”_th»ad_¡©e_mu‹x_
);

230 
	g¡d
::
unique_±r
<
T¿n¦©Ü
::
Stub
> 
¡ub_
;

233 
TEST_F
(
G½cS”v”Te¡
, 
AsyloT¿n¦©esToSªùu¬y
) {

234 
	g¡d
::
¡ršg
 
asylo_Œª¦©iÚ
;

235 
ASSERT_THAT
(
MakeRpc
("asylo", &
asylo_Œª¦©iÚ
), 
IsOk
());

236 
EXPECT_EQ
(
asylo_Œª¦©iÚ
, "sanctuary");

239 
TEST_F
(
G½cS”v”Te¡
, 
I¡ioT¿n¦©esToSa
) {

240 
	g¡d
::
¡ršg
 
i¡io_Œª¦©iÚ
;

241 
ASSERT_THAT
(
MakeRpc
("i¡io", &
i¡io_Œª¦©iÚ
), 
IsOk
());

242 
EXPECT_EQ
(
i¡io_Œª¦©iÚ
, "sail");

245 
TEST_F
(
G½cS”v”Te¡
, 
Kub”Ã‹sT¿n¦©esToH–msmª
) {

246 
	g¡d
::
¡ršg
 
kub”Ã‹s_Œª¦©iÚ
;

247 
ASSERT_THAT
(
MakeRpc
("kub”Ã‹s", &
kub”Ã‹s_Œª¦©iÚ
), 
IsOk
());

248 
EXPECT_EQ
(
kub”Ã‹s_Œª¦©iÚ
, "helmsman");

251 
TEST_F
(
G½cS”v”Te¡
, 
OrkutT¿n¦©iÚNÙFound
) {

252 
	g¡d
::
¡ršg
 
Ükut_Œª¦©iÚ
;

253 
	gasylo
::
Stus
 
¡©us
 = 
MakeRpc
("Ükut", &
Ükut_Œª¦©iÚ
);

254 
EXPECT_THAT
(
¡©us
, 
StusIs
(
asylo
::
”rÜ
::
INVALID_ARGUMENT
,

	@examples/grpc_server/translator_server_impl.cc

19 
	~"asylo/exam¶es/g½c_£rv”/Œª¦©Ü_£rv”_im¶.h
"

21 
	~"ab¦/¡ršgs/ascii.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"šşude/g½ıp/g½ıp.h
"

25 
Çme¥aû
 
	gexam¶es
 {

26 
Çme¥aû
 
	gg½c_£rv”
 {

28 
	gT¿n¦©ÜS”v”Im¶
::
T¿n¦©ÜS”v”Im¶
(

29 
ab¦
::
NÙifiÿtiÚ
 *
shutdown_»que¡ed
)

30 : 
S”viû
(),

32 
Œª¦©iÚ_m­_
({{"asylo", "sanctuary"},

35 
shutdown_»que¡ed_
(
shutdown_»que¡ed
) {}

37 ::
g½c
::
Stus
 
T¿n¦©ÜS”v”Im¶
::
G‘T¿n¦©iÚ
(

38 ::
g½c
::
S”v”CÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
G‘T¿n¦©iÚReque¡
 *
»que¡
,

39 
G‘T¿n¦©iÚRe¥Ú£
 *
»¥Ú£
) {

41 ià(!
	g»que¡
->
has_šput_wÜd
()) {

42  ::
g½c
::
Stus
(::g½c::
StusCode
::
INVALID_ARGUMENT
,

47 autØ
	g»¥Ú£_™”©Ü
 =

48 
Œª¦©iÚ_m­_
.
fšd
(
ab¦
::
AsciiSŒToLow”
(
»que¡
->
šput_wÜd
()));

49 ià(
	g»¥Ú£_™”©Ü
 =ğ
Œª¦©iÚ_m­_
.
’d
()) {

50  ::
g½c
::
Stus
(::g½c::
StusCode
::
INVALID_ARGUMENT
,

51 
ab¦
::
SŒC©
("No knownranslation for \"",

52 
»que¡
->
šput_wÜd
(), "\""));

56 
	g»¥Ú£
->
£t_Œª¦©ed_wÜd
(
»¥Ú£_™”©Ü
->
£cÚd
);

57  ::
g½c
::
Stus
::
OK
;

60 ::
g½c
::
Stus
 
T¿n¦©ÜS”v”Im¶
::
Shutdown
(::g½c::
S”v”CÚ‹xt
 *
cÚ‹xt
,

61 cÚ¡ 
ShutdownReque¡
 *
qu”y
,

62 
ShutdownRe¥Ú£
 *
»¥Ú£
)

63 
LOCKS_EXCLUDED
(
shutdown_»que¡ed_mu‹x_
) {

65 
	gab¦
::
Mu‹xLock
 
lock
(&
shutdown_»que¡ed_mu‹x_
);

66 ià(!
	gshutdown_»que¡ed_
->
HasB“nNÙif›d
()) {

67 
	gshutdown_»que¡ed_
->
NÙify
();

69  ::
g½c
::
Stus
::
OK
;

	@examples/grpc_server/translator_server_impl.cc

19 
	~"asylo/exam¶es/g½c_£rv”/Œª¦©Ü_£rv”_im¶.h
"

21 
	~"ab¦/¡ršgs/ascii.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"šşude/g½ıp/g½ıp.h
"

25 
Çme¥aû
 
	gexam¶es
 {

26 
Çme¥aû
 
	gg½c_£rv”
 {

28 
	gT¿n¦©ÜS”v”Im¶
::
T¿n¦©ÜS”v”Im¶
(

29 
ab¦
::
NÙifiÿtiÚ
 *
shutdown_»que¡ed
)

30 : 
S”viû
(),

32 
Œª¦©iÚ_m­_
({{"asylo", "sanctuary"},

35 
shutdown_»que¡ed_
(
shutdown_»que¡ed
) {}

37 ::
g½c
::
Stus
 
T¿n¦©ÜS”v”Im¶
::
G‘T¿n¦©iÚ
(

38 ::
g½c
::
S”v”CÚ‹xt
 *
cÚ‹xt
, cÚ¡ 
G‘T¿n¦©iÚReque¡
 *
»que¡
,

39 
G‘T¿n¦©iÚRe¥Ú£
 *
»¥Ú£
) {

41 ià(!
	g»que¡
->
has_šput_wÜd
()) {

42  ::
g½c
::
Stus
(::g½c::
StusCode
::
INVALID_ARGUMENT
,

47 autØ
	g»¥Ú£_™”©Ü
 =

48 
Œª¦©iÚ_m­_
.
fšd
(
ab¦
::
AsciiSŒToLow”
(
»que¡
->
šput_wÜd
()));

49 ià(
	g»¥Ú£_™”©Ü
 =ğ
Œª¦©iÚ_m­_
.
’d
()) {

50  ::
g½c
::
Stus
(::g½c::
StusCode
::
INVALID_ARGUMENT
,

51 
ab¦
::
SŒC©
("No knownranslation for \"",

52 
»que¡
->
šput_wÜd
(), "\""));

56 
	g»¥Ú£
->
£t_Œª¦©ed_wÜd
(
»¥Ú£_™”©Ü
->
£cÚd
);

57  ::
g½c
::
Stus
::
OK
;

60 ::
g½c
::
Stus
 
T¿n¦©ÜS”v”Im¶
::
Shutdown
(::g½c::
S”v”CÚ‹xt
 *
cÚ‹xt
,

61 cÚ¡ 
ShutdownReque¡
 *
qu”y
,

62 
ShutdownRe¥Ú£
 *
»¥Ú£
)

63 
LOCKS_EXCLUDED
(
shutdown_»que¡ed_mu‹x_
) {

65 
	gab¦
::
Mu‹xLock
 
lock
(&
shutdown_»que¡ed_mu‹x_
);

66 ià(!
	gshutdown_»que¡ed_
->
HasB“nNÙif›d
()) {

67 
	gshutdown_»que¡ed_
->
NÙify
();

69  ::
g½c
::
Stus
::
OK
;

	@examples/grpc_server/translator_server_impl.h

19 #iâdeà
ASYLO_EXAMPLES_GRPC_SERVER_TRANSLATOR_SERVER_IMPL_H_


20 
	#ASYLO_EXAMPLES_GRPC_SERVER_TRANSLATOR_SERVER_IMPL_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

25 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

26 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

27 
	~"ab¦/synchrÚiz©iÚ/nÙifiÿtiÚ.h
"

28 
	~"asylo/exam¶es/g½c_£rv”/Œª¦©Ü_£rv”.g½c.pb.h
"

29 
	~"šşude/g½ıp/g½ıp.h
"

30 
	~"šşude/g½ıp/£rv”.h
"

32 
Çme¥aû
 
	gexam¶es
 {

33 
Çme¥aû
 
	gg½c_£rv”
 {

35 şas 
	cT¿n¦©ÜS”v”Im¶
 
	gfš®
 : 
public
 
T¿n¦©Ü
::
S”viû
 {

36 
public
:

37 
ex¶ic™
 
T¿n¦©ÜS”v”Im¶
(
ab¦
::
NÙifiÿtiÚ
 *
shutdown_»que¡ed
);

39 
	g´iv©e
:

40 ::
g½c
::
Stus
 
G‘T¿n¦©iÚ
(::g½c::
S”v”CÚ‹xt
 *
cÚ‹xt
,

41 cÚ¡ 
G‘T¿n¦©iÚReque¡
 *
qu”y
,

42 
G‘T¿n¦©iÚRe¥Ú£
 *
»¥Ú£
è
	gov”ride
;

44 ::
g½c
::
Stus
 
Shutdown
(::g½c::
S”v”CÚ‹xt
 *
cÚ‹xt
,

45 cÚ¡ 
ShutdownReque¡
 *
qu”y
,

46 
ShutdownRe¥Ú£
 *
»¥Ú£
)

47 
LOCKS_EXCLUDED
(
shutdown_»que¡ed_mu‹x_
è
	gov”ride
;

50 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	g¡d
::¡ršg> 
Œª¦©iÚ_m­_
;

54 
	gab¦
::
Mu‹x
 
shutdown_»que¡ed_mu‹x_
;

57 
	gab¦
::
NÙifiÿtiÚ
 *
shutdown_»que¡ed_
 
GUARDED_BY
(
shutdown_»que¡ed_mu‹x_
);

	@examples/hello_world/enclave_config.cc

19 
	~"asylo/’şave.pb.h
"

20 
	~"asylo/ut/loggšg.h
"

21 
	~"asylo/id’t™y/desütiÚs.h
"

22 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

23 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
cÚ¡ex´
 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

28 
	gasylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

29 
asylo
::
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
as£¹iÚ_authÜ™y_cÚfig
;

30 
asylo
::
	`S‘SgxLoÿlAs£¹iÚDesütiÚ
(

31 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_desütiÚ
());

33 
asylo
::
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
;

34 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`£t_©‹¡©iÚ_domaš
(

35 
kA‰e¡©iÚDomaš
);

36 
	`CHECK
(
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`S”ŸlizeToSŒšg
(

37 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_cÚfig
()));

39 
asylo
::
EnşaveCÚfig
 
’şave_cÚfig
;

40 *
’şave_cÚfig
.
	`add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

41 
¡d
::
	`move
(
as£¹iÚ_authÜ™y_cÚfig
);

43  
’şave_cÚfig
;

44 
	}
}

	@examples/hello_world/enclave_config.cc

19 
	~"asylo/’şave.pb.h
"

20 
	~"asylo/ut/loggšg.h
"

21 
	~"asylo/id’t™y/desütiÚs.h
"

22 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

23 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
cÚ¡ex´
 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

28 
	gasylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

29 
asylo
::
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
as£¹iÚ_authÜ™y_cÚfig
;

30 
asylo
::
	`S‘SgxLoÿlAs£¹iÚDesütiÚ
(

31 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_desütiÚ
());

33 
asylo
::
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
;

34 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`£t_©‹¡©iÚ_domaš
(

35 
kA‰e¡©iÚDomaš
);

36 
	`CHECK
(
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`S”ŸlizeToSŒšg
(

37 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_cÚfig
()));

39 
asylo
::
EnşaveCÚfig
 
’şave_cÚfig
;

40 *
’şave_cÚfig
.
	`add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

41 
¡d
::
	`move
(
as£¹iÚ_authÜ™y_cÚfig
);

43  
’şave_cÚfig
;

44 
	}
}

	@examples/hello_world/hello_driver.cc

19 
	~<io¡»am
>

20 
	~<¡ršg
>

21 
	~<veùÜ
>

22 
	~<sigÇl.h
>

24 
	~"ab¦/¡ršgs/¡r_¥l™.h
"

25 
	~"asylo/ş›Á.h
"

26 
	~"asylo/exam¶es/h–lo_wÜld/h–lo.pb.h
"

27 
	~"gæags/gæags.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

31 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

33 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

34 
DEFINE_¡ršg
(
Çmes
, "",

37 
	gasylo
::
EnşaveCÚfig
 
G‘AµliÿtiÚCÚfig
();

39 
	gasylo
::
Stus
 
¡©us
;

40 
	gasylo
::
EnşaveMªag”
 *
mªag”
;

41 
	gasylo
::
EnşaveCl›Á
 *
ş›Á
;

43 
sigaùiÚ
 
	gŞd_§
;

44 
sigaùiÚ
 
	gÃw_§
;

45 
h–lo
(, ** );

46 
	gg_¬gc
;

47 **
	gg_¬gv
;

49 
	$sigÇl_hªdËr
(
signo
)

51 
	`LOG
(
INFO
)<<"SIGUSR1 Received : Restart main\n";

58 
	`h–lo
(
g_¬gc
, 
g_¬gv
);

59 
	`ex™
(0);

60 
	}
}

62 
	$maš
(
¬gc
, *
¬gv
[]){

63 
g_¬gc
 = 
¬gc
;

64 
g_¬gv
 = 
¬gv
;

65 
	`mem£t
(&
Ãw_§
, 0, (new_sa));

66 
Ãw_§
.
§_hªdËr
=&
sigÇl_hªdËr
;

67 
	`sigaùiÚ
(
SIGUSR1
,&
Ãw_§
,&
Şd_§
);

68 
	`h–lo
(
¬gc
, 
¬gv
);

69 
	}
}

71 
	$h–lo
(
¬gc
, *
¬gv
[]) {

73 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

74  
Œue
);

76 ià(
FLAGS_Çmes
.
	`em±y
()) {

77 
	`LOG
(
QFATAL
) << "Must supply‡‚on-empty†ist of‚ames with --names";

80 
¡d
::
veùÜ
<¡d::
¡ršg
> 
Çmes
 = 
ab¦
::
	`SŒS¶™
(
FLAGS_Çmes
, ',');

83 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

84 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

85 ià(!
mªag”_»suÉ
.
	`ok
()) {

86 
	`LOG
(
QFATAL
è<< "EnşaveMªag” uÇvaabË: " << 
mªag”_»suÉ
.
	`¡©us
();

88 
asylo
::
EnşaveCÚfig
 
cÚfig
 = 
	`G‘AµliÿtiÚCÚfig
();

89 
cÚfig
.
	`£t_’abË_fÜk
(
Œue
);

92 
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

93 
¡d
::
cout
 << "Lßdšg " << 
FLAGS_’şave_·th
 << std::
’dl
;

94 
asylo
::
SgxLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

95 *
addr
 = (*)0x7fdbcc000000;

96 
size_t
 
sz
 = 33554432;

97 
	`LOG
(
INFO
è<< "ba£: " << 
addr
 << " sz: " << 
sz
;

99 
¡©us
 = 
mªag”
->
	`LßdEnşave
("h–lo_’şave", 
lßd”
, 
cÚfig
, 
addr
, 
sz
);

100 ià(!
¡©us
.
	`ok
()) {

101 
	`LOG
(
QFATAL
è<< "Lßd " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

108 
ş›Á
 = 
»š‹½»t_ÿ¡
<
asylo
::
SgxCl›Á
 *>(
mªag”
->
	`G‘Cl›Á
("hello_enclave"));

110 cÚ¡‡utØ&
Çme
 : 
Çmes
) {

111 
asylo
::
EnşaveIÅut
 
šput
;

112 
šput
.
	`MubËEx‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
)

113 ->
	`£t_to_g»‘
(
Çme
);

116 
asylo
::
EnşaveOuut
* 
ouut
 = 
Ãw
‡sylo::
	`EnşaveOuut
();

117 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, 
ouut
);

119 ià(!
¡©us
.
	`ok
()) {

120 
	`LOG
(
QFATAL
è<< "EÁ”AndRuÀçed: " << 
¡©us
;

122 ià(!
ouut
->
	`HasEx‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
)) {

123 
¡d
::
cout
 << " output " <<

124 
ouut
->
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
).
	`g»‘šg_mes§ge
()

126 
šput
.
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
).
	`to_g»‘
()

127 << 
¡d
::
’dl
;

128 
	`LOG
(
QFATAL
è<< "Enşavdid‚Ù‡ssigÀª ID fÜ " << 
Çme
;

130 
¡d
::
cout
 << "Message fromƒnclave: "

131 << 
ouut
->
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
)

132 .
	`g»‘šg_mes§ge
()

133 << 
¡d
::
’dl
;

154 
asylo
::
EnşaveFš®
 
fš®_šput
;

155 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
fš®_šput
);

156 ià(!
¡©us
.
	`ok
()) {

157 
	`LOG
(
QFATAL
è<< "De¡roy " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

159 
	`LOG_IF
(
INFO
, 
¡©us
.
	`ok
()) << "FIN";

161 
	`_ex™
(0);

163 
	}
}

	@examples/hello_world/hello_driver.cc

19 
	~<io¡»am
>

20 
	~<¡ršg
>

21 
	~<veùÜ
>

22 
	~<sigÇl.h
>

24 
	~"ab¦/¡ršgs/¡r_¥l™.h
"

25 
	~"asylo/ş›Á.h
"

26 
	~"asylo/exam¶es/h–lo_wÜld/h–lo.pb.h
"

27 
	~"gæags/gæags.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

31 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

33 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

34 
DEFINE_¡ršg
(
Çmes
, "",

37 
	gasylo
::
EnşaveCÚfig
 
G‘AµliÿtiÚCÚfig
();

39 
	gasylo
::
Stus
 
¡©us
;

40 
	gasylo
::
EnşaveMªag”
 *
mªag”
;

41 
	gasylo
::
EnşaveCl›Á
 *
ş›Á
;

43 
sigaùiÚ
 
	gŞd_§
;

44 
sigaùiÚ
 
	gÃw_§
;

45 
h–lo
(, ** );

46 
	gg_¬gc
;

47 **
	gg_¬gv
;

49 
	$sigÇl_hªdËr
(
signo
)

51 
	`LOG
(
INFO
)<<"SIGUSR1 Received : Restart main\n";

58 
	`h–lo
(
g_¬gc
, 
g_¬gv
);

59 
	`ex™
(0);

60 
	}
}

62 
	$maš
(
¬gc
, *
¬gv
[]){

63 
g_¬gc
 = 
¬gc
;

64 
g_¬gv
 = 
¬gv
;

65 
	`mem£t
(&
Ãw_§
, 0, (new_sa));

66 
Ãw_§
.
§_hªdËr
=&
sigÇl_hªdËr
;

67 
	`sigaùiÚ
(
SIGUSR1
,&
Ãw_§
,&
Şd_§
);

68 
	`h–lo
(
¬gc
, 
¬gv
);

69 
	}
}

71 
	$h–lo
(
¬gc
, *
¬gv
[]) {

73 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

74  
Œue
);

76 ià(
FLAGS_Çmes
.
	`em±y
()) {

77 
	`LOG
(
QFATAL
) << "Must supply‡‚on-empty†ist of‚ames with --names";

80 
¡d
::
veùÜ
<¡d::
¡ršg
> 
Çmes
 = 
ab¦
::
	`SŒS¶™
(
FLAGS_Çmes
, ',');

83 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

84 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

85 ià(!
mªag”_»suÉ
.
	`ok
()) {

86 
	`LOG
(
QFATAL
è<< "EnşaveMªag” uÇvaabË: " << 
mªag”_»suÉ
.
	`¡©us
();

88 
asylo
::
EnşaveCÚfig
 
cÚfig
 = 
	`G‘AµliÿtiÚCÚfig
();

89 
cÚfig
.
	`£t_’abË_fÜk
(
Œue
);

92 
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

93 
¡d
::
cout
 << "Lßdšg " << 
FLAGS_’şave_·th
 << std::
’dl
;

94 
asylo
::
SgxLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

95 *
addr
 = (*)0x7fdbcc000000;

96 
size_t
 
sz
 = 33554432;

97 
	`LOG
(
INFO
è<< "ba£: " << 
addr
 << " sz: " << 
sz
;

99 
¡©us
 = 
mªag”
->
	`LßdEnşave
("h–lo_’şave", 
lßd”
, 
cÚfig
, 
addr
, 
sz
);

100 ià(!
¡©us
.
	`ok
()) {

101 
	`LOG
(
QFATAL
è<< "Lßd " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

108 
ş›Á
 = 
»š‹½»t_ÿ¡
<
asylo
::
SgxCl›Á
 *>(
mªag”
->
	`G‘Cl›Á
("hello_enclave"));

110 cÚ¡‡utØ&
Çme
 : 
Çmes
) {

111 
asylo
::
EnşaveIÅut
 
šput
;

112 
šput
.
	`MubËEx‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
)

113 ->
	`£t_to_g»‘
(
Çme
);

116 
asylo
::
EnşaveOuut
* 
ouut
 = 
Ãw
‡sylo::
	`EnşaveOuut
();

117 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, 
ouut
);

119 ià(!
¡©us
.
	`ok
()) {

120 
	`LOG
(
QFATAL
è<< "EÁ”AndRuÀçed: " << 
¡©us
;

122 ià(!
ouut
->
	`HasEx‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
)) {

123 
¡d
::
cout
 << " output " <<

124 
ouut
->
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
).
	`g»‘šg_mes§ge
()

126 
šput
.
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
).
	`to_g»‘
()

127 << 
¡d
::
’dl
;

128 
	`LOG
(
QFATAL
è<< "Enşavdid‚Ù‡ssigÀª ID fÜ " << 
Çme
;

130 
¡d
::
cout
 << "Message fromƒnclave: "

131 << 
ouut
->
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
)

132 .
	`g»‘šg_mes§ge
()

133 << 
¡d
::
’dl
;

154 
asylo
::
EnşaveFš®
 
fš®_šput
;

155 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
fš®_šput
);

156 ià(!
¡©us
.
	`ok
()) {

157 
	`LOG
(
QFATAL
è<< "De¡roy " << 
FLAGS_’şave_·th
 << " faed: " << 
¡©us
;

159 
	`LOG_IF
(
INFO
, 
¡©us
.
	`ok
()) << "FIN";

161 
	`_ex™
(0);

163 
	}
}

	@examples/hello_world/hello_enclave.cc

19 
	~<sys/wa™.h
>

20 
	~<uni¡d.h
>

21 
	~<c¡dšt
>

24 
pid_t
 
’şave_fÜk
();

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/exam¶es/h–lo_wÜld/h–lo.pb.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

31 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

32 
	~"asylo/ut/¡©us.h
"

33 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

35 
usšg
 
Çme¥aû
 
asylo
;

37 şas 
	cH–loAµliÿtiÚ
 : 
public
 
asylo
::
Tru¡edAµliÿtiÚ
 {

100 
public
:

101 
	$H–loAµliÿtiÚ
(è: 
	$vis™Ü_couÁ_
(0) {}

103 
asylo
::
Stus
 
	$Run
(cÚ¡ 
asylo
::
EnşaveIÅut
 &
šput
,

104 
asylo
::
EnşaveOuut
 *
ouut
è
ov”ride
 {

105 ià(!
šput
.
	`HasEx‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
)) {

106  
asylo
::
	`Stus
×sylo::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
¡d
::
¡ršg
 
vis™Ü
 =

110 
šput
.
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
).
	`to_g»‘
();

111 
	`LOG
(
INFO
è<< "H–lØ" << 
vis™Ü
;

112 
i
=0; i<0xffffffff;i++);

113 
i
=0; i<0xffffffff;i++);

114 
i
=0; i<0xffffffff;i++);

115 
i
=0; i<0xffffffff;i++);

116 
i
=0; i<0xffffffff;i++);

117 ià(
ouut
) {

118 
	`LOG
(
INFO
) << "Incrementing visitor count...";

119 
ouut
->
	`MubËEx‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
)

120 ->
	`£t_g»‘šg_mes§ge
(

121 
ab¦
::
	`SŒC©
("H–lØ", 
vis™Ü
, "! You‡re visitor #",

122 ++
vis™Ü_couÁ_
, "ohisƒnclave."));

124  
asylo
::
Stus
::
	`OkStus
();

125 
	}
}

127 
	g´iv©e
:

128 
ušt64_t
 
vis™Ü_couÁ_
;

131 
Çme¥aû
 
	gasylo
 {

133 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
	gH–loAµliÿtiÚ
; }

	@examples/hello_world/hello_enclave.cc

19 
	~<sys/wa™.h
>

20 
	~<uni¡d.h
>

21 
	~<c¡dšt
>

24 
pid_t
 
’şave_fÜk
();

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/exam¶es/h–lo_wÜld/h–lo.pb.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

31 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

32 
	~"asylo/ut/¡©us.h
"

33 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

35 
usšg
 
Çme¥aû
 
asylo
;

37 şas 
	cH–loAµliÿtiÚ
 : 
public
 
asylo
::
Tru¡edAµliÿtiÚ
 {

100 
public
:

101 
	$H–loAµliÿtiÚ
(è: 
	$vis™Ü_couÁ_
(0) {}

103 
asylo
::
Stus
 
	$Run
(cÚ¡ 
asylo
::
EnşaveIÅut
 &
šput
,

104 
asylo
::
EnşaveOuut
 *
ouut
è
ov”ride
 {

105 ià(!
šput
.
	`HasEx‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
)) {

106  
asylo
::
	`Stus
×sylo::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
¡d
::
¡ršg
 
vis™Ü
 =

110 
šput
.
	`G‘Ex‹nsiÚ
(
h–lo_wÜld
::
’şave_šput_h–lo
).
	`to_g»‘
();

111 
	`LOG
(
INFO
è<< "H–lØ" << 
vis™Ü
;

112 
i
=0; i<0xffffffff;i++);

113 
i
=0; i<0xffffffff;i++);

114 
i
=0; i<0xffffffff;i++);

115 
i
=0; i<0xffffffff;i++);

116 
i
=0; i<0xffffffff;i++);

117 ià(
ouut
) {

118 
	`LOG
(
INFO
) << "Incrementing visitor count...";

119 
ouut
->
	`MubËEx‹nsiÚ
(
h–lo_wÜld
::
’şave_ouut_h–lo
)

120 ->
	`£t_g»‘šg_mes§ge
(

121 
ab¦
::
	`SŒC©
("H–lØ", 
vis™Ü
, "! You‡re visitor #",

122 ++
vis™Ü_couÁ_
, "ohisƒnclave."));

124  
asylo
::
Stus
::
	`OkStus
();

125 
	}
}

127 
	g´iv©e
:

128 
ušt64_t
 
vis™Ü_couÁ_
;

131 
Çme¥aû
 
	gasylo
 {

133 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
	gH–loAµliÿtiÚ
; }

	@examples/quickstart/demo_driver.cc

19 
	~<io¡»am
>

20 
	~<¡ršg
>

22 
	~"asylo/ş›Á.h
"

23 
	~"asylo/exam¶es/quick¡¬t/demo.pb.h
"

24 
	~"gæags/gæags.h
"

25 
	~"asylo/ut/loggšg.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclave binary imageo†oad");

28 
DEFINE_¡ršg
(
mes§ge
, "", "Messageoƒncrypt");

31 
	$S‘EnşaveU£rMes§ge
(
asylo
::
EnşaveIÅut
 *
’şave_šput
,

32 cÚ¡ 
¡d
::
¡ršg
 &
u£r_mes§ge
) {

33 
guide
::
asylo
::
Demo
 *
u£r_šput
 =

34 
’şave_šput
->
	`MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
);

35 
u£r_šput
->
	`£t_v®ue
(
u£r_mes§ge
);

36 
	}
}

40 cÚ¡ 
	g¡d
::
¡ršg
 
	$G‘EnşaveOuutMes§ge
(cÚ¡ 
asylo
::
EnşaveOuut
 &
ouut
) {

41  
ouut
.
	`G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
).
	`v®ue
();

42 
	}
}

44 
	$maš
(
¬gc
, *
¬gv
[]) {

45 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

46  
Œue
);

48 
	`LOG_IF
(
QFATAL
, 
FLAGS_mes§ge
.
	`em±y
()) << "Empty --message flag";

52 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

53 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

54 
	`LOG_IF
(
QFATAL
, !
mªag”_»suÉ
.
	`ok
()) << "Could‚ot obtain EnclaveManager";

56 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

57 
asylo
::
SimLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

58 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
("demo_’şave", 
lßd”
);

59 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "LoadEnclave failed with: " << status;

63 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
("demo_enclave");

64 
asylo
::
EnşaveIÅut
 
šput
;

65 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_mes§ge
);

67 
asylo
::
EnşaveOuut
 
ouut
;

68 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

69 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

73 
asylo
::
EnşaveFš®
 
em±y_fš®_šput
;

74 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
em±y_fš®_šput
);

75 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "DestroyEnclave failed with: " << status;

78 
	}
}

	@examples/quickstart/demo_driver.cc

19 
	~<io¡»am
>

20 
	~<¡ršg
>

22 
	~"asylo/ş›Á.h
"

23 
	~"asylo/exam¶es/quick¡¬t/demo.pb.h
"

24 
	~"gæags/gæags.h
"

25 
	~"asylo/ut/loggšg.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclave binary imageo†oad");

28 
DEFINE_¡ršg
(
mes§ge
, "", "Messageoƒncrypt");

31 
	$S‘EnşaveU£rMes§ge
(
asylo
::
EnşaveIÅut
 *
’şave_šput
,

32 cÚ¡ 
¡d
::
¡ršg
 &
u£r_mes§ge
) {

33 
guide
::
asylo
::
Demo
 *
u£r_šput
 =

34 
’şave_šput
->
	`MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
);

35 
u£r_šput
->
	`£t_v®ue
(
u£r_mes§ge
);

36 
	}
}

40 cÚ¡ 
	g¡d
::
¡ršg
 
	$G‘EnşaveOuutMes§ge
(cÚ¡ 
asylo
::
EnşaveOuut
 &
ouut
) {

41  
ouut
.
	`G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
).
	`v®ue
();

42 
	}
}

44 
	$maš
(
¬gc
, *
¬gv
[]) {

45 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

46  
Œue
);

48 
	`LOG_IF
(
QFATAL
, 
FLAGS_mes§ge
.
	`em±y
()) << "Empty --message flag";

52 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

53 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

54 
	`LOG_IF
(
QFATAL
, !
mªag”_»suÉ
.
	`ok
()) << "Could‚ot obtain EnclaveManager";

56 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

57 
asylo
::
SimLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

58 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
("demo_’şave", 
lßd”
);

59 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "LoadEnclave failed with: " << status;

63 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
("demo_enclave");

64 
asylo
::
EnşaveIÅut
 
šput
;

65 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_mes§ge
);

67 
asylo
::
EnşaveOuut
 
ouut
;

68 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

69 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

73 
asylo
::
EnşaveFš®
 
em±y_fš®_šput
;

74 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
em±y_fš®_šput
);

75 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "DestroyEnclave failed with: " << status;

78 
	}
}

	@examples/quickstart/demo_enclave.cc

19 
	~<¡ršg
>

21 
	~"ab¦/¡ršgs/esÿpšg.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/üy±o/«s_gcm_siv.h
"

24 
	~"asylo/exam¶es/quick¡¬t/demo.pb.h
"

25 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/ş—nsšg_ty³s.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 #iâdeà
¬¿ysize


31 
	#¬¿ysize
(
¬r
è(×¼è/ ×¼[0]))

	)

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
size_t
 
	gkMaxMes§geSize
 = 1 << 16;

41 
cÚ¡ex´
 
ušt8_t
 
	gkAesKey128
[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05,

54 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Enüy±Mes§ge
(cÚ¡ 
¡d
::¡ršg &
mes§ge
) {

55 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

57 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

58 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

59 
CËªsšgSŒšg
 
	gnÚû
;

60 
CËªsšgSŒšg
 
	gch”‹xt
;

62 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
S—l
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

63 
mes§ge
, &
nÚû
, &
ch”‹xt
));

65  
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
SŒC©
(
nÚû
, 
ch”‹xt
));

71 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Deüy±Mes§ge
(

72 cÚ¡ 
¡d
::
¡ršg
 &
nÚû_ªd_ch”‹xt
) {

73 
¡d
::
¡ršg
 
decoded_šput
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû_ªd_ch”‹xt
);

74 
CËªsšgSŒšg
 
ş—n_šput
(
decoded_šput
.
d©a
(), decoded_šput.
size
());

76 ià(
	gş—n_šput
.
size
(è< 
	gkAesGcmSivNÚûSize
) {

77  
Stus
(

78 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

79 
ab¦
::
SŒC©
("IÅuˆtoØshÜt:ƒx³ùed‡ˆËa¡ ", 
kAesGcmSivNÚûSize
,

80 " by‹s, gÙ ", 
ş—n_šput
.
size
()));

83 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

84 
CËªsšgSŒšg
 
	gnÚû
 = 
ş—n_šput
.
sub¡r
(0, 
kAesGcmSivNÚûSize
);

85 
CËªsšgSŒšg
 
	gch”‹xt
 = 
ş—n_šput
.
sub¡r
(
kAesGcmSivNÚûSize
);

86 
CËªsšgSŒšg
 
	g¶aš‹xt
;

88 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

90 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

91 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
O³n
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

92 
ch”‹xt
, 
nÚû
, &
¶aš‹xt
));

94  
	g¡d
::
¡ršg
(
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
());

99 şas 
	cEnşaveDemo
 : 
public
 
Tru¡edAµliÿtiÚ
 {

100 
public
:

101 
EnşaveDemo
() = ;

103 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

104 
	g¡d
::
¡ršg
 
u£r_mes§ge
 = 
G‘EnşaveU£rMes§ge
(
šput
);

106 
	g¡d
::
¡ršg
 
»suÉ
;

107 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
Enüy±Mes§ge
(
u£r_mes§ge
));

109 
	g¡d
::
cout
 << "Enüy±ed mes§ge:" << 
¡d
::
’dl
 << 
»suÉ
 << std::endl;

111  
	gStus
::
OkStus
();

115 cÚ¡ 
	g¡d
::
¡ršg
 
G‘EnşaveU£rMes§ge
(cÚ¡ 
EnşaveIÅut
 &
šput
) {

116  
šput
.
G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
).
v®ue
();

121 
S‘EnşaveOuutMes§ge
(
EnşaveOuut
 *
’şave_ouut
,

122 cÚ¡ 
¡d
::
¡ršg
 &
ouut_mes§ge
) {

123 
guide
::
asylo
::
Demo
 *
ouut
 =

124 
’şave_ouut
->
MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
);

125 
	gouut
->
£t_v®ue
(
ouut_mes§ge
);

129 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveDemo
; 
	}
}

	@examples/quickstart/demo_enclave.cc

19 
	~<¡ršg
>

21 
	~"ab¦/¡ršgs/esÿpšg.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/üy±o/«s_gcm_siv.h
"

24 
	~"asylo/exam¶es/quick¡¬t/demo.pb.h
"

25 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/ş—nsšg_ty³s.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 #iâdeà
¬¿ysize


31 
	#¬¿ysize
(
¬r
è(×¼è/ ×¼[0]))

	)

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
size_t
 
	gkMaxMes§geSize
 = 1 << 16;

41 
cÚ¡ex´
 
ušt8_t
 
	gkAesKey128
[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05,

54 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Enüy±Mes§ge
(cÚ¡ 
¡d
::¡ršg &
mes§ge
) {

55 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

57 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

58 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

59 
CËªsšgSŒšg
 
	gnÚû
;

60 
CËªsšgSŒšg
 
	gch”‹xt
;

62 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
S—l
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

63 
mes§ge
, &
nÚû
, &
ch”‹xt
));

65  
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
SŒC©
(
nÚû
, 
ch”‹xt
));

71 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Deüy±Mes§ge
(

72 cÚ¡ 
¡d
::
¡ršg
 &
nÚû_ªd_ch”‹xt
) {

73 
¡d
::
¡ršg
 
decoded_šput
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû_ªd_ch”‹xt
);

74 
CËªsšgSŒšg
 
ş—n_šput
(
decoded_šput
.
d©a
(), decoded_šput.
size
());

76 ià(
	gş—n_šput
.
size
(è< 
	gkAesGcmSivNÚûSize
) {

77  
Stus
(

78 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

79 
ab¦
::
SŒC©
("IÅuˆtoØshÜt:ƒx³ùed‡ˆËa¡ ", 
kAesGcmSivNÚûSize
,

80 " by‹s, gÙ ", 
ş—n_šput
.
size
()));

83 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

84 
CËªsšgSŒšg
 
	gnÚû
 = 
ş—n_šput
.
sub¡r
(0, 
kAesGcmSivNÚûSize
);

85 
CËªsšgSŒšg
 
	gch”‹xt
 = 
ş—n_šput
.
sub¡r
(
kAesGcmSivNÚûSize
);

86 
CËªsšgSŒšg
 
	g¶aš‹xt
;

88 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

90 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

91 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
O³n
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

92 
ch”‹xt
, 
nÚû
, &
¶aš‹xt
));

94  
	g¡d
::
¡ršg
(
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
());

99 şas 
	cEnşaveDemo
 : 
public
 
Tru¡edAµliÿtiÚ
 {

100 
public
:

101 
EnşaveDemo
() = ;

103 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

104 
	g¡d
::
¡ršg
 
u£r_mes§ge
 = 
G‘EnşaveU£rMes§ge
(
šput
);

106 
	g¡d
::
¡ršg
 
»suÉ
;

107 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
Enüy±Mes§ge
(
u£r_mes§ge
));

109 
	g¡d
::
cout
 << "Enüy±ed mes§ge:" << 
¡d
::
’dl
 << 
»suÉ
 << std::endl;

111  
	gStus
::
OkStus
();

115 cÚ¡ 
	g¡d
::
¡ršg
 
G‘EnşaveU£rMes§ge
(cÚ¡ 
EnşaveIÅut
 &
šput
) {

116  
šput
.
G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
).
v®ue
();

121 
S‘EnşaveOuutMes§ge
(
EnşaveOuut
 *
’şave_ouut
,

122 cÚ¡ 
¡d
::
¡ršg
 &
ouut_mes§ge
) {

123 
guide
::
asylo
::
Demo
 *
ouut
 =

124 
’şave_ouut
->
MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
);

125 
	gouut
->
£t_v®ue
(
ouut_mes§ge
);

129 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveDemo
; 
	}
}

	@examples/quickstart/solution/demo_driver.cc

19 
	~<io¡»am
>

20 
	~<¡ršg
>

22 
	~"asylo/ş›Á.h
"

23 
	~"asylo/exam¶es/quick¡¬t/sŞutiÚ/demo.pb.h
"

24 
	~"gæags/gæags.h
"

25 
	~"asylo/ut/loggšg.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

28 
DEFINE_¡ršg
(
mes§ge1
, "", "The first messageoƒncrypt");

29 
DEFINE_¡ršg
(
mes§ge2
, "", "The second messageoƒncrypt");

30 
DEFINE_¡ršg
(
ch”‹xt
, "", "The ciphertext messageo decrypt");

33 
	$S‘EnşaveU£rMes§ge
(
asylo
::
EnşaveIÅut
 *
’şave_šput
,

34 cÚ¡ 
¡d
::
¡ršg
 &
u£r_mes§ge
,

35 
guide
::
asylo
::
Demo
::
AùiÚ
 
aùiÚ
) {

36 
guide
::
asylo
::
Demo
 *
u£r_šput
 =

37 
’şave_šput
->
	`MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
);

38 
u£r_šput
->
	`£t_v®ue
(
u£r_mes§ge
);

39 
u£r_šput
->
	`£t_aùiÚ
(
aùiÚ
);

40 
	}
}

44 cÚ¡ 
	g¡d
::
¡ršg
 
	$G‘EnşaveOuutMes§ge
(cÚ¡ 
asylo
::
EnşaveOuut
 &
ouut
) {

45  
ouut
.
	`G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
).
	`v®ue
();

46 
	}
}

48 
	$maš
(
¬gc
, *
¬gv
[]) {

49 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

50  
Œue
);

52 
	`LOG_IF
(
QFATAL
, 
FLAGS_mes§ge1
.
	`em±y
(è&& 
FLAGS_mes§ge2
.empty() &&

53 
FLAGS_ch”‹xt
.
	`em±y
())

59 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

60 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

61 
	`LOG_IF
(
QFATAL
, !
mªag”_»suÉ
.
	`ok
()) << "Could‚ot obtain EnclaveManager";

63 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

64 
asylo
::
SimLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

65 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
("demo_’şave", 
lßd”
);

66 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "LoadEnclave failed with: " << status;

70 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
("demo_enclave");

71 
asylo
::
EnşaveIÅut
 
šput
;

72 
asylo
::
EnşaveOuut
 
ouut
;

74 ià(!
FLAGS_mes§ge1
.
	`em±y
()) {

75 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_mes§ge1
, 
guide
::
asylo
::
Demo
::
ENCRYPT
);

76 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

77 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

78 
¡d
::
cout
 << "Enüy±ed mes§ge1 from driv”:" << std::
’dl


79 << 
	`G‘EnşaveOuutMes§ge
(
ouut
è<< 
¡d
::
’dl
;

82 ià(!
FLAGS_mes§ge2
.
	`em±y
()) {

83 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_mes§ge2
, 
guide
::
asylo
::
Demo
::
ENCRYPT
);

84 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

85 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

86 
¡d
::
cout
 << "Enüy±ed mes§ge2 from driv”:" << std::
’dl


87 << 
	`G‘EnşaveOuutMes§ge
(
ouut
è<< 
¡d
::
’dl
;

90 ià(!
FLAGS_ch”‹xt
.
	`em±y
()) {

91 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_ch”‹xt
,

92 
guide
::
asylo
::
Demo
::
DECRYPT
);

93 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

94 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

95 
¡d
::
cout
 << "Deüy±ed ch”‹xˆäom driv”:" << std::
’dl


96 << 
	`G‘EnşaveOuutMes§ge
(
ouut
è<< 
¡d
::
’dl
;

101 
asylo
::
EnşaveFš®
 
em±y_fš®_šput
;

102 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
em±y_fš®_šput
);

103 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "DestroyEnclave failed with: " << status;

106 
	}
}

	@examples/quickstart/solution/demo_driver.cc

19 
	~<io¡»am
>

20 
	~<¡ršg
>

22 
	~"asylo/ş›Á.h
"

23 
	~"asylo/exam¶es/quick¡¬t/sŞutiÚ/demo.pb.h
"

24 
	~"gæags/gæags.h
"

25 
	~"asylo/ut/loggšg.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

28 
DEFINE_¡ršg
(
mes§ge1
, "", "The first messageoƒncrypt");

29 
DEFINE_¡ršg
(
mes§ge2
, "", "The second messageoƒncrypt");

30 
DEFINE_¡ršg
(
ch”‹xt
, "", "The ciphertext messageo decrypt");

33 
	$S‘EnşaveU£rMes§ge
(
asylo
::
EnşaveIÅut
 *
’şave_šput
,

34 cÚ¡ 
¡d
::
¡ršg
 &
u£r_mes§ge
,

35 
guide
::
asylo
::
Demo
::
AùiÚ
 
aùiÚ
) {

36 
guide
::
asylo
::
Demo
 *
u£r_šput
 =

37 
’şave_šput
->
	`MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
);

38 
u£r_šput
->
	`£t_v®ue
(
u£r_mes§ge
);

39 
u£r_šput
->
	`£t_aùiÚ
(
aùiÚ
);

40 
	}
}

44 cÚ¡ 
	g¡d
::
¡ršg
 
	$G‘EnşaveOuutMes§ge
(cÚ¡ 
asylo
::
EnşaveOuut
 &
ouut
) {

45  
ouut
.
	`G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
).
	`v®ue
();

46 
	}
}

48 
	$maš
(
¬gc
, *
¬gv
[]) {

49 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

50  
Œue
);

52 
	`LOG_IF
(
QFATAL
, 
FLAGS_mes§ge1
.
	`em±y
(è&& 
FLAGS_mes§ge2
.empty() &&

53 
FLAGS_ch”‹xt
.
	`em±y
())

59 
asylo
::
EnşaveMªag”
::
	`CÚfigu»
×sylo::
	`EnşaveMªag”O±iÚs
());

60 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

61 
	`LOG_IF
(
QFATAL
, !
mªag”_»suÉ
.
	`ok
()) << "Could‚ot obtain EnclaveManager";

63 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

64 
asylo
::
SimLßd”
 
	`lßd”
(
FLAGS_’şave_·th
, 
Œue
);

65 
asylo
::
Stus
 
¡©us
 = 
mªag”
->
	`LßdEnşave
("demo_’şave", 
lßd”
);

66 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "LoadEnclave failed with: " << status;

70 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
("demo_enclave");

71 
asylo
::
EnşaveIÅut
 
šput
;

72 
asylo
::
EnşaveOuut
 
ouut
;

74 ià(!
FLAGS_mes§ge1
.
	`em±y
()) {

75 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_mes§ge1
, 
guide
::
asylo
::
Demo
::
ENCRYPT
);

76 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

77 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

78 
¡d
::
cout
 << "Enüy±ed mes§ge1 from driv”:" << std::
’dl


79 << 
	`G‘EnşaveOuutMes§ge
(
ouut
è<< 
¡d
::
’dl
;

82 ià(!
FLAGS_mes§ge2
.
	`em±y
()) {

83 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_mes§ge2
, 
guide
::
asylo
::
Demo
::
ENCRYPT
);

84 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

85 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

86 
¡d
::
cout
 << "Enüy±ed mes§ge2 from driv”:" << std::
’dl


87 << 
	`G‘EnşaveOuutMes§ge
(
ouut
è<< 
¡d
::
’dl
;

90 ià(!
FLAGS_ch”‹xt
.
	`em±y
()) {

91 
	`S‘EnşaveU£rMes§ge
(&
šput
, 
FLAGS_ch”‹xt
,

92 
guide
::
asylo
::
Demo
::
DECRYPT
);

93 
¡©us
 = 
ş›Á
->
	`EÁ”AndRun
(
šput
, &
ouut
);

94 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "EnterAndRun failed with: " << status;

95 
¡d
::
cout
 << "Deüy±ed ch”‹xˆäom driv”:" << std::
’dl


96 << 
	`G‘EnşaveOuutMes§ge
(
ouut
è<< 
¡d
::
’dl
;

101 
asylo
::
EnşaveFš®
 
em±y_fš®_šput
;

102 
¡©us
 = 
mªag”
->
	`De¡royEnşave
(
ş›Á
, 
em±y_fš®_šput
);

103 
	`LOG_IF
(
QFATAL
, !
¡©us
.
	`ok
()) << "DestroyEnclave failed with: " << status;

106 
	}
}

	@examples/quickstart/solution/demo_enclave.cc

19 
	~<¡ršg
>

21 
	~"ab¦/¡ršgs/esÿpšg.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/üy±o/«s_gcm_siv.h
"

24 
	~"asylo/exam¶es/quick¡¬t/sŞutiÚ/demo.pb.h
"

25 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/ş—nsšg_ty³s.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 #iâdeà
¬¿ysize


31 
	#¬¿ysize
(
¬r
è(×¼è/ ×¼[0]))

	)

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
size_t
 
	gkMaxMes§geSize
 = 1 << 16;

41 
cÚ¡ex´
 
ušt8_t
 
	gkAesKey128
[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05,

54 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Enüy±Mes§ge
(cÚ¡ 
¡d
::¡ršg &
mes§ge
) {

55 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

57 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

58 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

59 
CËªsšgSŒšg
 
	gnÚû
;

60 
CËªsšgSŒšg
 
	gch”‹xt
;

62 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
S—l
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

63 
mes§ge
, &
nÚû
, &
ch”‹xt
));

65  
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
SŒC©
(
nÚû
, 
ch”‹xt
));

71 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Deüy±Mes§ge
(

72 cÚ¡ 
¡d
::
¡ršg
 &
nÚû_ªd_ch”‹xt
) {

73 
¡d
::
¡ršg
 
decoded_šput
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû_ªd_ch”‹xt
);

74 
CËªsšgSŒšg
 
ş—n_šput
(
decoded_šput
.
d©a
(), decoded_šput.
size
());

76 ià(
	gş—n_šput
.
size
(è< 
	gkAesGcmSivNÚûSize
) {

77  
Stus
(

78 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

79 
ab¦
::
SŒC©
("IÅuˆtoØshÜt:ƒx³ùed‡ˆËa¡ ", 
kAesGcmSivNÚûSize
,

80 " by‹s, gÙ ", 
ş—n_šput
.
size
()));

83 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

84 
CËªsšgSŒšg
 
	gnÚû
 = 
ş—n_šput
.
sub¡r
(0, 
kAesGcmSivNÚûSize
);

85 
CËªsšgSŒšg
 
	gch”‹xt
 = 
ş—n_šput
.
sub¡r
(
kAesGcmSivNÚûSize
);

86 
CËªsšgSŒšg
 
	g¶aš‹xt
;

88 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

90 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

91 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
O³n
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

92 
ch”‹xt
, 
nÚû
, &
¶aš‹xt
));

94  
	g¡d
::
¡ršg
(
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
());

99 şas 
	cEnşaveDemo
 : 
public
 
Tru¡edAµliÿtiÚ
 {

100 
public
:

101 
EnşaveDemo
() = ;

103 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

104 
	g¡d
::
¡ršg
 
u£r_mes§ge
 = 
G‘EnşaveU£rMes§ge
(
šput
);

106 
	g¡d
::
¡ršg
 
»suÉ
;

107 
G‘EnşaveU£rAùiÚ
(
šput
)) {

108 
	gguide
::
asylo
::
Demo
::
ENCRYPT
:

109 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
Enüy±Mes§ge
(
u£r_mes§ge
));

111 
	gguide
::
asylo
::
Demo
::
DECRYPT
:

112 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
Deüy±Mes§ge
(
u£r_mes§ge
));

115  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

119 
S‘EnşaveOuutMes§ge
(
ouut
, 
»suÉ
);

121  
	gStus
::
OkStus
();

125 cÚ¡ 
	g¡d
::
¡ršg
 
G‘EnşaveU£rMes§ge
(cÚ¡ 
EnşaveIÅut
 &
šput
) {

126  
šput
.
G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
).
v®ue
();

130 
	gguide
::
asylo
::
Demo
::
AùiÚ
 
G‘EnşaveU£rAùiÚ
(cÚ¡ 
EnşaveIÅut
 &
šput
) {

131  
šput
.
G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
).
aùiÚ
();

136 
S‘EnşaveOuutMes§ge
(
EnşaveOuut
 *
’şave_ouut
,

137 cÚ¡ 
¡d
::
¡ršg
 &
ouut_mes§ge
) {

138 
guide
::
asylo
::
Demo
 *
ouut
 =

139 
’şave_ouut
->
MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
);

140 
	gouut
->
£t_v®ue
(
ouut_mes§ge
);

144 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveDemo
; 
	}
}

	@examples/quickstart/solution/demo_enclave.cc

19 
	~<¡ršg
>

21 
	~"ab¦/¡ršgs/esÿpšg.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/üy±o/«s_gcm_siv.h
"

24 
	~"asylo/exam¶es/quick¡¬t/sŞutiÚ/demo.pb.h
"

25 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/ş—nsšg_ty³s.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 #iâdeà
¬¿ysize


31 
	#¬¿ysize
(
¬r
è(×¼è/ ×¼[0]))

	)

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
size_t
 
	gkMaxMes§geSize
 = 1 << 16;

41 
cÚ¡ex´
 
ušt8_t
 
	gkAesKey128
[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05,

54 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Enüy±Mes§ge
(cÚ¡ 
¡d
::¡ršg &
mes§ge
) {

55 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

57 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

58 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

59 
CËªsšgSŒšg
 
	gnÚû
;

60 
CËªsšgSŒšg
 
	gch”‹xt
;

62 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
S—l
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

63 
mes§ge
, &
nÚû
, &
ch”‹xt
));

65  
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
SŒC©
(
nÚû
, 
ch”‹xt
));

71 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
Deüy±Mes§ge
(

72 cÚ¡ 
¡d
::
¡ršg
 &
nÚû_ªd_ch”‹xt
) {

73 
¡d
::
¡ršg
 
decoded_šput
 = 
ab¦
::
HexSŒšgToBy‹s
(
nÚû_ªd_ch”‹xt
);

74 
CËªsšgSŒšg
 
ş—n_šput
(
decoded_šput
.
d©a
(), decoded_šput.
size
());

76 ià(
	gş—n_šput
.
size
(è< 
	gkAesGcmSivNÚûSize
) {

77  
Stus
(

78 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

79 
ab¦
::
SŒC©
("IÅuˆtoØshÜt:ƒx³ùed‡ˆËa¡ ", 
kAesGcmSivNÚûSize
,

80 " by‹s, gÙ ", 
ş—n_šput
.
size
()));

83 
CËªsšgSŒšg
 
	gadd™iÚ®_auth’tiÿ‹d_d©a
;

84 
CËªsšgSŒšg
 
	gnÚû
 = 
ş—n_šput
.
sub¡r
(0, 
kAesGcmSivNÚûSize
);

85 
CËªsšgSŒšg
 
	gch”‹xt
 = 
ş—n_šput
.
sub¡r
(
kAesGcmSivNÚûSize
);

86 
CËªsšgSŒšg
 
	g¶aš‹xt
;

88 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
key
(
kAesKey128
, kAesKey128 + 
¬¿ysize
(kAesKey128));

90 
AesGcmSivCry±Ü
 
üy±Ü
(
kMaxMes§geSize
, 
Ãw
 
AesGcmSivNÚûG’”©Ü
());

91 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
.
O³n
(
key
, 
add™iÚ®_auth’tiÿ‹d_d©a
,

92 
ch”‹xt
, 
nÚû
, &
¶aš‹xt
));

94  
	g¡d
::
¡ršg
(
¶aš‹xt
.
d©a
(),…Ïš‹xt.
size
());

99 şas 
	cEnşaveDemo
 : 
public
 
Tru¡edAµliÿtiÚ
 {

100 
public
:

101 
EnşaveDemo
() = ;

103 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

104 
	g¡d
::
¡ršg
 
u£r_mes§ge
 = 
G‘EnşaveU£rMes§ge
(
šput
);

106 
	g¡d
::
¡ršg
 
»suÉ
;

107 
G‘EnşaveU£rAùiÚ
(
šput
)) {

108 
	gguide
::
asylo
::
Demo
::
ENCRYPT
:

109 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
Enüy±Mes§ge
(
u£r_mes§ge
));

111 
	gguide
::
asylo
::
Demo
::
DECRYPT
:

112 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
Deüy±Mes§ge
(
u£r_mes§ge
));

115  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

119 
S‘EnşaveOuutMes§ge
(
ouut
, 
»suÉ
);

121  
	gStus
::
OkStus
();

125 cÚ¡ 
	g¡d
::
¡ršg
 
G‘EnşaveU£rMes§ge
(cÚ¡ 
EnşaveIÅut
 &
šput
) {

126  
šput
.
G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
).
v®ue
();

130 
	gguide
::
asylo
::
Demo
::
AùiÚ
 
G‘EnşaveU£rAùiÚ
(cÚ¡ 
EnşaveIÅut
 &
šput
) {

131  
šput
.
G‘Ex‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_šput
).
aùiÚ
();

136 
S‘EnşaveOuutMes§ge
(
EnşaveOuut
 *
’şave_ouut
,

137 cÚ¡ 
¡d
::
¡ršg
 &
ouut_mes§ge
) {

138 
guide
::
asylo
::
Demo
 *
ouut
 =

139 
’şave_ouut
->
MubËEx‹nsiÚ
(
guide
::
asylo
::
quick¡¬t_ouut
);

140 
	gouut
->
£t_v®ue
(
ouut_mes§ge
);

144 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveDemo
; 
	}
}

	@examples/redis/redis_enclave_config.cc

19 
	~"asylo/’şave.pb.h
"

20 
	~"asylo/ut/loggšg.h
"

21 
	~"asylo/id’t™y/desütiÚs.h
"

22 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

23 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
cÚ¡ex´
 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

28 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

29 
asylo
::
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
as£¹iÚ_authÜ™y_cÚfig
;

30 
asylo
::
	`S‘SgxLoÿlAs£¹iÚDesütiÚ
(

31 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_desütiÚ
());

33 
asylo
::
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
;

34 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`£t_©‹¡©iÚ_domaš
(

35 
kA‰e¡©iÚDomaš
);

36 
	`CHECK
(
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`S”ŸlizeToSŒšg
(

37 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_cÚfig
()));

39 
asylo
::
EnşaveCÚfig
 
’şave_cÚfig
;

40 *
’şave_cÚfig
.
	`add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

41 
¡d
::
	`move
(
as£¹iÚ_authÜ™y_cÚfig
);

43  
’şave_cÚfig
;

44 
	}
}

	@examples/redis/redis_enclave_config.cc

19 
	~"asylo/’şave.pb.h
"

20 
	~"asylo/ut/loggšg.h
"

21 
	~"asylo/id’t™y/desütiÚs.h
"

22 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

23 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
cÚ¡ex´
 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

28 "C" 
asylo
::
EnşaveCÚfig
 
	$G‘AµliÿtiÚCÚfig
() {

29 
asylo
::
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
as£¹iÚ_authÜ™y_cÚfig
;

30 
asylo
::
	`S‘SgxLoÿlAs£¹iÚDesütiÚ
(

31 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_desütiÚ
());

33 
asylo
::
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
;

34 
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`£t_©‹¡©iÚ_domaš
(

35 
kA‰e¡©iÚDomaš
);

36 
	`CHECK
(
sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig
.
	`S”ŸlizeToSŒšg
(

37 
as£¹iÚ_authÜ™y_cÚfig
.
	`mubË_cÚfig
()));

39 
asylo
::
EnşaveCÚfig
 
’şave_cÚfig
;

40 *
’şave_cÚfig
.
	`add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

41 
¡d
::
	`move
(
as£¹iÚ_authÜ™y_cÚfig
);

43  
’şave_cÚfig
;

44 
	}
}

	@grpc/auth/core/assertion_description.cc

19 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

21 
	~"šşude/g½c/suµÜt/®loc.h
"

26 
	$as£¹iÚ_desütiÚ_š™
(
as£¹iÚ_desütiÚ
 *
desc
) {

34 
desc
->
id’t™y_ty³
 = 0;

35 
	`§ã_¡ršg_š™
(&
desc
->
authÜ™y_ty³
);

36 
	}
}

38 
	$as£¹iÚ_desütiÚ_assign
(
št32_t
 
id’t™y_ty³
,

39 cÚ¡ *
authÜ™y_ty³
,

40 
size_t
 
authÜ™y_ty³_size
,

41 
as£¹iÚ_desütiÚ
 *
desc
) {

42 
desc
->
id’t™y_ty³
 = identity_type;

43 
	`§ã_¡ršg_assign
(&
desc
->
authÜ™y_ty³
, 
authÜ™y_ty³_size
,

44 
authÜ™y_ty³
);

45 
	}
}

47 
	$as£¹iÚ_desütiÚ_cİy
(cÚ¡ 
as£¹iÚ_desütiÚ
 *
¤c
,

48 
as£¹iÚ_desütiÚ
 *
de¡
) {

49 
de¡
->
id’t™y_ty³
 = 
¤c
->identity_type;

50 
	`§ã_¡ršg_cİy
Ğ&
de¡
->
authÜ™y_ty³
,

51  &
¤c
->
authÜ™y_ty³
);

52 
	}
}

54 
	$as£¹iÚ_desütiÚ_ä“
(
as£¹iÚ_desütiÚ
 *
desc
) {

55 ià(
desc
 !ğ
nuÎ±r
) {

56 
	`§ã_¡ršg_ä“
(&
desc
->
authÜ™y_ty³
);

57 
desc
->
id’t™y_ty³
 = 0;

59 
	}
}

63 
	$as£¹iÚ_desütiÚ_¬¿y_š™
(
size_t
 
couÁ
,

64 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

69 
¬¿y
->
couÁ
 = count;

70 
¬¿y
->
desütiÚs
 = 
¡©ic_ÿ¡
<
as£¹iÚ_desütiÚ
 *>(

71 
	`g´_m®loc
(
couÁ
 * (*
¬¿y
->
desütiÚs
)));

72 
size_t
 
i
;

73 
i
 = 0; i < 
¬¿y
->
couÁ
; ++i) {

74 
	`as£¹iÚ_desütiÚ_š™
(&
¬¿y
->
desütiÚs
[
i
]);

76 
	}
}

78 
boŞ
 
	$as£¹iÚ_desütiÚ_¬¿y_assign_©
(
size_t
 
šdex
, 
št32_t
 
id’t™y_ty³
,

79 cÚ¡ *
authÜ™y_ty³
,

80 
size_t
 
authÜ™y_ty³_size
,

81 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

82 ià(
šdex
 >ğ
¬¿y
->
couÁ
) {

83  
çl£
;

86 
	`as£¹iÚ_desütiÚ_assign
(
id’t™y_ty³
, 
authÜ™y_ty³
,

87 
authÜ™y_ty³_size
,

88 &
¬¿y
->
desütiÚs
[
šdex
]);

89  
Œue
;

90 
	}
}

92 
	$as£¹iÚ_desütiÚ_¬¿y_cİy
(cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
¤c
,

93 
as£¹iÚ_desütiÚ_¬¿y
 *
de¡
) {

94 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(
de¡
);

95 
	`as£¹iÚ_desütiÚ_¬¿y_š™
(
¤c
->
couÁ
, 
de¡
);

96 
size_t
 
i
;

97 
i
 = 0; i < 
¤c
->
couÁ
; ++i) {

98 
	`as£¹iÚ_desütiÚ_cİy
(&
¤c
->
desütiÚs
[
i
], &
de¡
->descriptions[i]);

100 
	}
}

102 
	$as£¹iÚ_desütiÚ_¬¿y_ä“
(
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

103 ià((
¬¿y
 =ğ
nuÎ±r
è|| (¬¿y->
desütiÚs
 ==‚ullptr) ||

104 (
¬¿y
->
couÁ
 == 0)) {

108 
size_t
 
i
;

109 
i
 = 0; i < 
¬¿y
->
couÁ
; ++i) {

110 
	`as£¹iÚ_desütiÚ_ä“
(&
¬¿y
->
desütiÚs
[
i
]);

112 
	`g´_ä“
(
¬¿y
->
desütiÚs
);

115 
¬¿y
->
desütiÚs
 = 
nuÎ±r
;

116 
¬¿y
->
couÁ
 = 0;

117 
	}
}

	@grpc/auth/core/assertion_description.cc

19 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

21 
	~"šşude/g½c/suµÜt/®loc.h
"

26 
	$as£¹iÚ_desütiÚ_š™
(
as£¹iÚ_desütiÚ
 *
desc
) {

34 
desc
->
id’t™y_ty³
 = 0;

35 
	`§ã_¡ršg_š™
(&
desc
->
authÜ™y_ty³
);

36 
	}
}

38 
	$as£¹iÚ_desütiÚ_assign
(
št32_t
 
id’t™y_ty³
,

39 cÚ¡ *
authÜ™y_ty³
,

40 
size_t
 
authÜ™y_ty³_size
,

41 
as£¹iÚ_desütiÚ
 *
desc
) {

42 
desc
->
id’t™y_ty³
 = identity_type;

43 
	`§ã_¡ršg_assign
(&
desc
->
authÜ™y_ty³
, 
authÜ™y_ty³_size
,

44 
authÜ™y_ty³
);

45 
	}
}

47 
	$as£¹iÚ_desütiÚ_cİy
(cÚ¡ 
as£¹iÚ_desütiÚ
 *
¤c
,

48 
as£¹iÚ_desütiÚ
 *
de¡
) {

49 
de¡
->
id’t™y_ty³
 = 
¤c
->identity_type;

50 
	`§ã_¡ršg_cİy
Ğ&
de¡
->
authÜ™y_ty³
,

51  &
¤c
->
authÜ™y_ty³
);

52 
	}
}

54 
	$as£¹iÚ_desütiÚ_ä“
(
as£¹iÚ_desütiÚ
 *
desc
) {

55 ià(
desc
 !ğ
nuÎ±r
) {

56 
	`§ã_¡ršg_ä“
(&
desc
->
authÜ™y_ty³
);

57 
desc
->
id’t™y_ty³
 = 0;

59 
	}
}

63 
	$as£¹iÚ_desütiÚ_¬¿y_š™
(
size_t
 
couÁ
,

64 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

69 
¬¿y
->
couÁ
 = count;

70 
¬¿y
->
desütiÚs
 = 
¡©ic_ÿ¡
<
as£¹iÚ_desütiÚ
 *>(

71 
	`g´_m®loc
(
couÁ
 * (*
¬¿y
->
desütiÚs
)));

72 
size_t
 
i
;

73 
i
 = 0; i < 
¬¿y
->
couÁ
; ++i) {

74 
	`as£¹iÚ_desütiÚ_š™
(&
¬¿y
->
desütiÚs
[
i
]);

76 
	}
}

78 
boŞ
 
	$as£¹iÚ_desütiÚ_¬¿y_assign_©
(
size_t
 
šdex
, 
št32_t
 
id’t™y_ty³
,

79 cÚ¡ *
authÜ™y_ty³
,

80 
size_t
 
authÜ™y_ty³_size
,

81 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

82 ià(
šdex
 >ğ
¬¿y
->
couÁ
) {

83  
çl£
;

86 
	`as£¹iÚ_desütiÚ_assign
(
id’t™y_ty³
, 
authÜ™y_ty³
,

87 
authÜ™y_ty³_size
,

88 &
¬¿y
->
desütiÚs
[
šdex
]);

89  
Œue
;

90 
	}
}

92 
	$as£¹iÚ_desütiÚ_¬¿y_cİy
(cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
¤c
,

93 
as£¹iÚ_desütiÚ_¬¿y
 *
de¡
) {

94 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(
de¡
);

95 
	`as£¹iÚ_desütiÚ_¬¿y_š™
(
¤c
->
couÁ
, 
de¡
);

96 
size_t
 
i
;

97 
i
 = 0; i < 
¤c
->
couÁ
; ++i) {

98 
	`as£¹iÚ_desütiÚ_cİy
(&
¤c
->
desütiÚs
[
i
], &
de¡
->descriptions[i]);

100 
	}
}

102 
	$as£¹iÚ_desütiÚ_¬¿y_ä“
(
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

103 ià((
¬¿y
 =ğ
nuÎ±r
è|| (¬¿y->
desütiÚs
 ==‚ullptr) ||

104 (
¬¿y
->
couÁ
 == 0)) {

108 
size_t
 
i
;

109 
i
 = 0; i < 
¬¿y
->
couÁ
; ++i) {

110 
	`as£¹iÚ_desütiÚ_ä“
(&
¬¿y
->
desütiÚs
[
i
]);

112 
	`g´_ä“
(
¬¿y
->
desütiÚs
);

115 
¬¿y
->
desütiÚs
 = 
nuÎ±r
;

116 
¬¿y
->
couÁ
 = 0;

117 
	}
}

	@grpc/auth/core/assertion_description.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_ASSERTION_DESCRIPTION_H_


20 
	#ASYLO_GRPC_AUTH_CORE_ASSERTION_DESCRIPTION_H_


	)

22 
	~<¡dšt.h
>

23 
	~<¡dlib.h
>

25 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

33 
št32_t
 
	mid’t™y_ty³
;

36 
§ã_¡ršg
 
	mauthÜ™y_ty³
;

37 } 
	tas£¹iÚ_desütiÚ
;

41 
as£¹iÚ_desütiÚ_š™
(
as£¹iÚ_desütiÚ
 *
desc
);

46 
as£¹iÚ_desütiÚ_assign
(
št32_t
 
id’t™y_ty³
,

47 cÚ¡ *
authÜ™y_ty³
,

48 
size_t
 
authÜ™y_ty³_size
,

49 
as£¹iÚ_desütiÚ
 *
desc
);

53 
as£¹iÚ_desütiÚ_cİy
(cÚ¡ 
as£¹iÚ_desütiÚ
 *
¤c
,

54 
as£¹iÚ_desütiÚ
 *
de¡
);

57 
as£¹iÚ_desütiÚ_ä“
(
as£¹iÚ_desütiÚ
 *
desc
);

64 
as£¹iÚ_desütiÚ
 *
	mdesütiÚs
;

65 
size_t
 
	mcouÁ
;

66 } 
	tas£¹iÚ_desütiÚ_¬¿y
;

71 
as£¹iÚ_desütiÚ_¬¿y_š™
(
size_t
 
couÁ
,

72 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
);

77 
boŞ
 
as£¹iÚ_desütiÚ_¬¿y_assign_©
(
size_t
 
šdex
, 
št32_t
 
id’t™y_ty³
,

78 cÚ¡ *
authÜ™y_ty³
,

79 
size_t
 
authÜ™y_ty³_size
,

80 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
);

84 
as£¹iÚ_desütiÚ_¬¿y_cİy
(cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
¤c
,

85 
as£¹iÚ_desütiÚ_¬¿y
 *
de¡
);

88 
as£¹iÚ_desütiÚ_¬¿y_ä“
(
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
);

	@grpc/auth/core/assertion_description_test.cc

19 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

21 
	~<c¡dšt
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 cÚ¡ 
	gkId’t™›sTe¡PoŞSize
 = 3;

32 cÚ¡ 
	gkAuthÜ™yTy³1
[] = "Any";

33 cÚ¡ 
	gkAuthÜ™yTy³2
[] = "SGX Local";

34 cÚ¡ 
	gkAuthÜ™yTy³3
[] = "SGX Remote";

39 şas 
	cAs£¹iÚDesütiÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
´Ùeùed
:

41 
S‘Up
(è
ov”ride
 {

42 
id’t™y_ty³s_
 = {
EnşaveId’t™yTy³
::
NULL_IDENTITY
,

43 
EnşaveId’t™yTy³
::
CODE_IDENTITY
,

44 
EnşaveId’t™yTy³
::
CODE_IDENTITY
};

46 
	gauthÜ™y_ty³s_
 = {
kAuthÜ™yTy³1
, 
kAuthÜ™yTy³2
, 
kAuthÜ™yTy³3
};

49 
as£¹iÚ_desütiÚ_š™
(&
desc1_
);

50 
as£¹iÚ_desütiÚ_š™
(&
desc2_
);

53 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
¬¿y1_
);

54 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
¬¿y2_
);

57 
T—rDown
(è
	gov”ride
 {

58 
as£¹iÚ_desütiÚ_ä“
(&
desc1_
);

59 
as£¹iÚ_desütiÚ_ä“
(&
desc2_
);

61 
as£¹iÚ_desütiÚ_¬¿y_ä“
(&
¬¿y1_
);

62 
as£¹iÚ_desütiÚ_¬¿y_ä“
(&
¬¿y2_
);

67 
S‘As£¹iÚDesütiÚ
(
‹¡_poŞ_šdex
,

68 
as£¹iÚ_desütiÚ
 *
desc
) {

69 
as£¹iÚ_desütiÚ_assign
(
id’t™y_ty³s_
[
‹¡_poŞ_šdex
],

70 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
d©a
(),

71 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
size
(),

72 
desc
);

76 
CheckDesütiÚEqu®™y
(cÚ¡ 
as£¹iÚ_desütiÚ
 &
ex³ùed
,

77 cÚ¡ 
as£¹iÚ_desütiÚ
 &
aùu®
) {

78 
V”ifyAs£¹iÚDesütiÚ
(
aùu®
, 
ex³ùed
.
id’t™y_ty³
,

79 
ex³ùed
.
authÜ™y_ty³
.
d©a
,

80 
ex³ùed
.
authÜ™y_ty³
.
size
);

86 
AddAndV”ifyId’t™›s
(
num_desütiÚs
,

87 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

88 
ASSERT_LE
(
num_desütiÚs
, 
kId’t™›sTe¡PoŞSize
);

89 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ
kId’t™›sTe¡PoŞSize
, 
¬¿y
);

90 
	gi
 = 0; i < 
	gkId’t™›sTe¡PoŞSize
; ++i) {

91 
EXPECT_TRUE
(
as£¹iÚ_desütiÚ_¬¿y_assign_©
(

92  
i
, 
¡©ic_ÿ¡
<
št32_t
>(
id’t™y_ty³s_
[i]),

93 
authÜ™y_ty³s_
[
i
].
d©a
(),‡uthÜ™y_ty³s_[i].
size
(), 
¬¿y
));

94 
V”ifyAs£¹iÚDesütiÚ
Ğ
i
, 
¬¿y
->
desütiÚs
[i]);

100 
CheckA¼ayEqu®™y
(cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
ex³ùed
,

101 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
aùu®
) {

102 
ASSERT_EQ
(
ex³ùed
.
couÁ
, 
aùu®
.count);

103 
size_t
 
	gi
 = 0; i < 
	gaùu®
.
	gcouÁ
; ++i) {

104 
CheckDesütiÚEqu®™y
(
ex³ùed
.
desütiÚs
[
i
],

105 
aùu®
.
desütiÚs
[
i
]);

111 
V”ifyAs£¹iÚDesütiÚ
(
‹¡_poŞ_šdex
,

112 cÚ¡ 
as£¹iÚ_desütiÚ
 &
desc
) {

113 
V”ifyAs£¹iÚDesütiÚ
(

114 
desc
, 
¡©ic_ÿ¡
<
št32_t
>(
id’t™y_ty³s_
[
‹¡_poŞ_šdex
]),

115 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
d©a
(),

116 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
size
());

123 
V”ifyAs£¹iÚDesütiÚ
(cÚ¡ 
as£¹iÚ_desütiÚ
 &
desc
,

124 
št32_t
 
id’t™y_ty³
,

125 cÚ¡ *
authÜ™y_ty³
,

126 
size_t
 
authÜ™y_ty³_size
) {

127 
EXPECT_EQ
(
desc
.
id’t™y_ty³
, identity_type);

128 
EXPECT_EQ
(
desc
.
authÜ™y_ty³
.
size
, 
authÜ™y_ty³_size
);

129 
EXPECT_EQ
(0, 
memcmp
(
authÜ™y_ty³
, 
desc
.authÜ™y_ty³.
d©a
,

130 
desc
.
authÜ™y_ty³
.
size
));

134 
	g¡d
::
veùÜ
<
EnşaveId’t™yTy³
> 
id’t™y_ty³s_
;

137 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
authÜ™y_ty³s_
;

139 
as£¹iÚ_desütiÚ
 
	gdesc1_
;

140 
as£¹iÚ_desütiÚ
 
	gdesc2_
;

142 
as£¹iÚ_desütiÚ_¬¿y
 
	g¬¿y1_
;

143 
as£¹iÚ_desütiÚ_¬¿y
 
	g¬¿y2_
;

150 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
F»eEm±yAs£¹iÚDesütiÚ
) {

151 
as£¹iÚ_desütiÚ_ä“
(&
desc1_
);

155 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
PİuÏ‹As£¹iÚDesütiÚ
) {

157 
S‘As£¹iÚDesütiÚ
Ğ0, &
desc1_
);

158 
V”ifyAs£¹iÚDesütiÚ
Ğ0, 
desc1_
);

161 
S‘As£¹iÚDesütiÚ
Ğ1, &
desc1_
);

162 
V”ifyAs£¹iÚDesütiÚ
Ğ1, 
desc1_
);

167 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚEm±yDe¡
) {

168 
S‘As£¹iÚDesütiÚ
Ğ0, &
desc1_
);

169 
as£¹iÚ_desütiÚ_cİy
Ğ&
desc1_
, &
desc2_
);

170 
CheckDesütiÚEqu®™y
(
desc1_
, 
desc2_
);

175 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚPİuÏ‹dDe¡
) {

176 
S‘As£¹iÚDesütiÚ
Ğ0, &
desc1_
);

177 
S‘As£¹iÚDesütiÚ
Ğ1, &
desc2_
);

179 
as£¹iÚ_desütiÚ_cİy
Ğ&
desc1_
, &
desc2_
);

180 
CheckDesütiÚEqu®™y
(
desc1_
, 
desc2_
);

187 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
F»eEm±yAs£¹iÚDesütiÚsA¼ay
) {

188 
as£¹iÚ_desütiÚ_¬¿y_ä“
(&
¬¿y1_
);

192 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
Em±yA¼ayAssignAt
) {

193 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

194 &
¬¿y1_
);

199 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
PİuÏ‹dA¼ayAssignAt
) {

200 
AddAndV”ifyId’t™›s
Ğ1, &
¬¿y1_
);

201 
EXPECT_TRUE
(
as£¹iÚ_desütiÚ_¬¿y_assign_©
(

202  0, 
id’t™y_ty³s_
.
back
(), 
authÜ™y_ty³s_
.back().
d©a
(),

203 
authÜ™y_ty³s_
.
back
().
size
(), &
¬¿y1_
));

204 
V”ifyAs£¹iÚDesütiÚ
Ğ
kId’t™›sTe¡PoŞSize
 - 1,

205 
¬¿y1_
.
desütiÚs
[0]);

210 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
A¼ayAssignAtOutOfBounds
) {

211 
EXPECT_FALSE
(
as£¹iÚ_desütiÚ_¬¿y_assign_©
(

212  1, 
id’t™y_ty³s_
.
äÚt
(), 
authÜ™y_ty³s_
.äÚt().
d©a
(),

213 
authÜ™y_ty³s_
.
äÚt
().
size
(), &
¬¿y1_
));

218 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚsA¼ayEm±yDe¡
) {

219 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

220 &
¬¿y1_
);

221 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
¬¿y2_
);

223 
as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
¬¿y1_
, &
¬¿y2_
);

224 
CheckA¼ayEqu®™y
Ğ
¬¿y1_
, 
¬¿y2_
);

229 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚsA¼aySm®ËrDe¡
) {

230 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

231 &
¬¿y1_
);

232 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
 - 1,

233 &
¬¿y2_
);

235 
as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
¬¿y1_
, &
¬¿y2_
);

236 
CheckA¼ayEqu®™y
Ğ
¬¿y1_
, 
¬¿y2_
);

241 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚsA¼ayL¬g”De¡
) {

242 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
 - 1,

243 &
¬¿y1_
);

244 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

245 &
¬¿y2_
);

247 
as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
¬¿y1_
, &
¬¿y2_
);

248 
CheckA¼ayEqu®™y
Ğ
¬¿y1_
, 
¬¿y2_
);

	@grpc/auth/core/assertion_description_test.cc

19 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

21 
	~<c¡dšt
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 cÚ¡ 
	gkId’t™›sTe¡PoŞSize
 = 3;

32 cÚ¡ 
	gkAuthÜ™yTy³1
[] = "Any";

33 cÚ¡ 
	gkAuthÜ™yTy³2
[] = "SGX Local";

34 cÚ¡ 
	gkAuthÜ™yTy³3
[] = "SGX Remote";

39 şas 
	cAs£¹iÚDesütiÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
´Ùeùed
:

41 
S‘Up
(è
ov”ride
 {

42 
id’t™y_ty³s_
 = {
EnşaveId’t™yTy³
::
NULL_IDENTITY
,

43 
EnşaveId’t™yTy³
::
CODE_IDENTITY
,

44 
EnşaveId’t™yTy³
::
CODE_IDENTITY
};

46 
	gauthÜ™y_ty³s_
 = {
kAuthÜ™yTy³1
, 
kAuthÜ™yTy³2
, 
kAuthÜ™yTy³3
};

49 
as£¹iÚ_desütiÚ_š™
(&
desc1_
);

50 
as£¹iÚ_desütiÚ_š™
(&
desc2_
);

53 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
¬¿y1_
);

54 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
¬¿y2_
);

57 
T—rDown
(è
	gov”ride
 {

58 
as£¹iÚ_desütiÚ_ä“
(&
desc1_
);

59 
as£¹iÚ_desütiÚ_ä“
(&
desc2_
);

61 
as£¹iÚ_desütiÚ_¬¿y_ä“
(&
¬¿y1_
);

62 
as£¹iÚ_desütiÚ_¬¿y_ä“
(&
¬¿y2_
);

67 
S‘As£¹iÚDesütiÚ
(
‹¡_poŞ_šdex
,

68 
as£¹iÚ_desütiÚ
 *
desc
) {

69 
as£¹iÚ_desütiÚ_assign
(
id’t™y_ty³s_
[
‹¡_poŞ_šdex
],

70 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
d©a
(),

71 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
size
(),

72 
desc
);

76 
CheckDesütiÚEqu®™y
(cÚ¡ 
as£¹iÚ_desütiÚ
 &
ex³ùed
,

77 cÚ¡ 
as£¹iÚ_desütiÚ
 &
aùu®
) {

78 
V”ifyAs£¹iÚDesütiÚ
(
aùu®
, 
ex³ùed
.
id’t™y_ty³
,

79 
ex³ùed
.
authÜ™y_ty³
.
d©a
,

80 
ex³ùed
.
authÜ™y_ty³
.
size
);

86 
AddAndV”ifyId’t™›s
(
num_desütiÚs
,

87 
as£¹iÚ_desütiÚ_¬¿y
 *
¬¿y
) {

88 
ASSERT_LE
(
num_desütiÚs
, 
kId’t™›sTe¡PoŞSize
);

89 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ
kId’t™›sTe¡PoŞSize
, 
¬¿y
);

90 
	gi
 = 0; i < 
	gkId’t™›sTe¡PoŞSize
; ++i) {

91 
EXPECT_TRUE
(
as£¹iÚ_desütiÚ_¬¿y_assign_©
(

92  
i
, 
¡©ic_ÿ¡
<
št32_t
>(
id’t™y_ty³s_
[i]),

93 
authÜ™y_ty³s_
[
i
].
d©a
(),‡uthÜ™y_ty³s_[i].
size
(), 
¬¿y
));

94 
V”ifyAs£¹iÚDesütiÚ
Ğ
i
, 
¬¿y
->
desütiÚs
[i]);

100 
CheckA¼ayEqu®™y
(cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
ex³ùed
,

101 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
aùu®
) {

102 
ASSERT_EQ
(
ex³ùed
.
couÁ
, 
aùu®
.count);

103 
size_t
 
	gi
 = 0; i < 
	gaùu®
.
	gcouÁ
; ++i) {

104 
CheckDesütiÚEqu®™y
(
ex³ùed
.
desütiÚs
[
i
],

105 
aùu®
.
desütiÚs
[
i
]);

111 
V”ifyAs£¹iÚDesütiÚ
(
‹¡_poŞ_šdex
,

112 cÚ¡ 
as£¹iÚ_desütiÚ
 &
desc
) {

113 
V”ifyAs£¹iÚDesütiÚ
(

114 
desc
, 
¡©ic_ÿ¡
<
št32_t
>(
id’t™y_ty³s_
[
‹¡_poŞ_šdex
]),

115 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
d©a
(),

116 
authÜ™y_ty³s_
[
‹¡_poŞ_šdex
].
size
());

123 
V”ifyAs£¹iÚDesütiÚ
(cÚ¡ 
as£¹iÚ_desütiÚ
 &
desc
,

124 
št32_t
 
id’t™y_ty³
,

125 cÚ¡ *
authÜ™y_ty³
,

126 
size_t
 
authÜ™y_ty³_size
) {

127 
EXPECT_EQ
(
desc
.
id’t™y_ty³
, identity_type);

128 
EXPECT_EQ
(
desc
.
authÜ™y_ty³
.
size
, 
authÜ™y_ty³_size
);

129 
EXPECT_EQ
(0, 
memcmp
(
authÜ™y_ty³
, 
desc
.authÜ™y_ty³.
d©a
,

130 
desc
.
authÜ™y_ty³
.
size
));

134 
	g¡d
::
veùÜ
<
EnşaveId’t™yTy³
> 
id’t™y_ty³s_
;

137 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
authÜ™y_ty³s_
;

139 
as£¹iÚ_desütiÚ
 
	gdesc1_
;

140 
as£¹iÚ_desütiÚ
 
	gdesc2_
;

142 
as£¹iÚ_desütiÚ_¬¿y
 
	g¬¿y1_
;

143 
as£¹iÚ_desütiÚ_¬¿y
 
	g¬¿y2_
;

150 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
F»eEm±yAs£¹iÚDesütiÚ
) {

151 
as£¹iÚ_desütiÚ_ä“
(&
desc1_
);

155 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
PİuÏ‹As£¹iÚDesütiÚ
) {

157 
S‘As£¹iÚDesütiÚ
Ğ0, &
desc1_
);

158 
V”ifyAs£¹iÚDesütiÚ
Ğ0, 
desc1_
);

161 
S‘As£¹iÚDesütiÚ
Ğ1, &
desc1_
);

162 
V”ifyAs£¹iÚDesütiÚ
Ğ1, 
desc1_
);

167 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚEm±yDe¡
) {

168 
S‘As£¹iÚDesütiÚ
Ğ0, &
desc1_
);

169 
as£¹iÚ_desütiÚ_cİy
Ğ&
desc1_
, &
desc2_
);

170 
CheckDesütiÚEqu®™y
(
desc1_
, 
desc2_
);

175 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚPİuÏ‹dDe¡
) {

176 
S‘As£¹iÚDesütiÚ
Ğ0, &
desc1_
);

177 
S‘As£¹iÚDesütiÚ
Ğ1, &
desc2_
);

179 
as£¹iÚ_desütiÚ_cİy
Ğ&
desc1_
, &
desc2_
);

180 
CheckDesütiÚEqu®™y
(
desc1_
, 
desc2_
);

187 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
F»eEm±yAs£¹iÚDesütiÚsA¼ay
) {

188 
as£¹iÚ_desütiÚ_¬¿y_ä“
(&
¬¿y1_
);

192 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
Em±yA¼ayAssignAt
) {

193 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

194 &
¬¿y1_
);

199 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
PİuÏ‹dA¼ayAssignAt
) {

200 
AddAndV”ifyId’t™›s
Ğ1, &
¬¿y1_
);

201 
EXPECT_TRUE
(
as£¹iÚ_desütiÚ_¬¿y_assign_©
(

202  0, 
id’t™y_ty³s_
.
back
(), 
authÜ™y_ty³s_
.back().
d©a
(),

203 
authÜ™y_ty³s_
.
back
().
size
(), &
¬¿y1_
));

204 
V”ifyAs£¹iÚDesütiÚ
Ğ
kId’t™›sTe¡PoŞSize
 - 1,

205 
¬¿y1_
.
desütiÚs
[0]);

210 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
A¼ayAssignAtOutOfBounds
) {

211 
EXPECT_FALSE
(
as£¹iÚ_desütiÚ_¬¿y_assign_©
(

212  1, 
id’t™y_ty³s_
.
äÚt
(), 
authÜ™y_ty³s_
.äÚt().
d©a
(),

213 
authÜ™y_ty³s_
.
äÚt
().
size
(), &
¬¿y1_
));

218 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚsA¼ayEm±yDe¡
) {

219 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

220 &
¬¿y1_
);

221 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
¬¿y2_
);

223 
as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
¬¿y1_
, &
¬¿y2_
);

224 
CheckA¼ayEqu®™y
Ğ
¬¿y1_
, 
¬¿y2_
);

229 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚsA¼aySm®ËrDe¡
) {

230 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

231 &
¬¿y1_
);

232 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
 - 1,

233 &
¬¿y2_
);

235 
as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
¬¿y1_
, &
¬¿y2_
);

236 
CheckA¼ayEqu®™y
Ğ
¬¿y1_
, 
¬¿y2_
);

241 
TEST_F
(
As£¹iÚDesütiÚTe¡
, 
CİyAs£¹iÚDesütiÚsA¼ayL¬g”De¡
) {

242 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
 - 1,

243 &
¬¿y1_
);

244 
AddAndV”ifyId’t™›s
Ğ
kId’t™›sTe¡PoŞSize
,

245 &
¬¿y2_
);

247 
as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
¬¿y1_
, &
¬¿y2_
);

248 
CheckA¼ayEqu®™y
Ğ
¬¿y1_
, 
¬¿y2_
);

	@grpc/auth/core/client_ekep_handshaker.cc

19 
	~"asylo/g½c/auth/cÜe/ş›Á_ek•_hªdshak”.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/¿nd.h
>

24 
	~<®gÜ™hm
>

26 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

27 
	~"ab¦/memÜy/memÜy.h
"

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/üy±o/sha256_hash.h
"

30 
	~"asylo/ut/loggšg.h
"

31 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

32 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

33 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

34 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

35 
	~"asylo/id’t™y/id’t™y.pb.h
"

36 
	~"asylo/ut/ş—nsšg_ty³s.h
"

37 
	~"asylo/ut/¡©us_maüos.h
"

39 
Çme¥aû
 
	gasylo
 {

41 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
Cl›ÁEk•Hªdshak”
::
C»©e
(

42 cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
) {

43 
Stus
 
¡©us
 = 
İtiÚs
.
V®id©e
();

44 ià(!
	g¡©us
.
ok
()) {

45 
LOG
(
ERROR
è<< "Inv®id hªdshak” o±iÚs: " << 
	g¡©us
;

46  
	gnuÎ±r
;

48  
	gab¦
::
W¿pUnique
(
Ãw
 
Cl›ÁEk•Hªdshak”
(
İtiÚs
));

51 
	gCl›ÁEk•Hªdshak”
::
Cl›ÁEk•Hªdshak”
(cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
)

52 : 
Ek•Hªdshak”
(
İtiÚs
.
max_äame_size
),

53 
£lf_as£¹iÚs_
(
İtiÚs
.
£lf_as£¹iÚs
),

54 
acû±ed_³”_as£¹iÚs_
(
İtiÚs
.
acû±ed_³”_as£¹iÚs
),

55 
avaabË_ch”_su™es_
({
CURVE25519_SHA256
}),

56 
avaabË_»cÜd_´ÙocŞs_
({
SEAL_AES128_GCM
}),

57 
avaabË_ek•_v”siÚs_
({"EKEP v1"}),

58 
add™iÚ®_auth’tiÿ‹d_d©a_
(
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
),

59 
£Ëùed_ch”_su™e_
(
UNKNOWN_HANDSHAKE_CIPHER
),

60 
£Ëùed_»cÜd_´ÙocŞ_
(
UNKNOWN_RECORD_PROTOCOL
),

61 
ex³ùed_mes§ge_ty³_
(
SERVER_PRECOMMIT
),

62 
hªdshak”_¡©e_
(
Ek•Hªdshak”
::
HªdshakeS‹
::
NOT_STARTED
) {}

64 
boŞ
 
Cl›ÁEk•Hªdshak”
::
IsHªdshakeInProg»ss
() const {

65  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
IN_PROGRESS
;

68 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
IsHªdshakeCom¶‘ed
() const {

69  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
COMPLETED
;

72 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
IsHªdshakeAbÜ‹d
() const {

73  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
ABORTED
;

76 
HªdshakeMes§geTy³
 
	gCl›ÁEk•Hªdshak”
::
G‘Ex³ùedMes§geTy³
() const {

77 ià(!
IsHªdshakeInProg»ss
()) {

78  
UNKNOWN_HANDSHAKE_MESSAGE
;

80  
	gex³ùed_mes§ge_ty³_
;

83 
	gCl›ÁEk•Hªdshak”
::
ResuÉ
 
Cl›ÁEk•Hªdshak”
::
S¹Hªdshake
(

84 
¡d
::
¡ršg
 *
ouut
) {

85 
Stus
 
¡©us
 = 
Wr™eCl›ÁP»comm™
(
ouut
);

86 ià(!
	g¡©us
.
ok
()) {

87 
AbÜtHªdshake
(
¡©us
, 
ouut
);

88  
	gResuÉ
::
ABORTED
;

91 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
IN_PROGRESS
;

92  
	gResuÉ
::
IN_PROGRESS
;

95 
	gCl›ÁEk•Hªdshak”
::
AbÜtHªdshake
(cÚ¡ 
Stus
 &
abÜt_¡©us
,

96 
¡d
::
¡ršg
 *
ouut
) {

97 
AbÜt_E¼ÜCode
 
”rÜ_code
 =

98 
¡©ic_ÿ¡
<
AbÜt_E¼ÜCode
>(
abÜt_¡©us
.
”rÜ_code
());

99 
LOG
(
ERROR
è<< 
	gabÜt_¡©us
;

101 
AbÜt
 
	gabÜt
;

102 
	gabÜt
.
£t_code
(
”rÜ_code
);

103 
	gabÜt
.
£t_mes§ge
(
¡d
::
¡ršg
(
abÜt_¡©us
.
”rÜ_mes§ge
().
d©a
(),

104 
abÜt_¡©us
.
”rÜ_mes§ge
().
size
()));

106 
	ggoogË
::
´Ùobuf
::
io
::
SŒšgOuutSŒ—m
 
outgošg_äame
(
ouut
);

107 
Stus
 
	g¡©us
 = 
EncodeF¿me
(
ABORT
, 
abÜt
, &
outgošg_äame
);

108 ià(!
	g¡©us
.
ok
()) {

111 
LOG
(
ERROR
è<< "Encodšg oàABORT mes§gçed: " << 
	g¡©us
;

114 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

117 
	gCl›ÁEk•Hªdshak”
::
ResuÉ
 
Cl›ÁEk•Hªdshak”
::
HªdËHªdshakeMes§ge
(

118 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

119 
¡d
::
¡ršg
 *
ouut
) {

120 
Stus
 
¡©us
 = Stus::
OkStus
();

121 
	gmes§ge_ty³
) {

122 
	gSERVER_PRECOMMIT
:

123 
ex³ùed_mes§ge_ty³_
 = 
SERVER_ID
;

124 
	g¡©us
 = 
HªdËS”v”P»comm™
(
hªdshake_mes§ge
, 
ouut
);

126 
	gSERVER_ID
:

127 
ex³ùed_mes§ge_ty³_
 = 
SERVER_FINISH
;

128 
	g¡©us
 = 
HªdËS”v”Id
(
hªdshake_mes§ge
);

130 
	gSERVER_FINISH
:

131 
ex³ùed_mes§ge_ty³_
 = 
UNKNOWN_HANDSHAKE_MESSAGE
;

132 
	g¡©us
 = 
HªdËS”v”Fšish
(
hªdshake_mes§ge
, 
ouut
);

133 ià(
	g¡©us
.
ok
()) {

134 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
COMPLETED
;

140 
¡©us
 = 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

143 ià(!
	g¡©us
.
ok
()) {

144 
AbÜtHªdshake
(
¡©us
, 
ouut
);

150 ià(
IsHªdshakeCom¶‘ed
()) {

151 ià(!
D”iveAndS‘RecÜdPrÙocŞKey
(

152 
£Ëùed_ch”_su™e_
, 
£Ëùed_»cÜd_´ÙocŞ_
, 
ma¡”_£ü‘_
)

153 .
ok
()) {

154 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

158 
	ghªdshak”_¡©e_
) {

159 
	gHªdshakeS‹
::
COMPLETED
:

160  
ResuÉ
::
COMPLETED
;

161 
	gHªdshakeS‹
::
IN_PROGRESS
:

162  
ResuÉ
::
IN_PROGRESS
;

164  
ResuÉ
::
ABORTED
;

168 
	gCl›ÁEk•Hªdshak”
::
HªdËAbÜtMes§ge
(cÚ¡ 
AbÜt
 *
abÜt_mes§ge
) {

169 ià(
abÜt_mes§ge
) {

170 
LOG
(
ERROR
è<< "Reûived " << 
AbÜt_E¼ÜCode_Name
(
abÜt_mes§ge
->
code
())

171 << " from s”v”: " << 
abÜt_mes§ge
->
mes§ge
();

174 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

177 
Stus
 
	gCl›ÁEk•Hªdshak”
::
HªdËS”v”P»comm™
(

178 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
, 
¡d
::
¡ršg
 *
ouut
) {

179 cÚ¡‡utØ*
£rv”_´ecomm™_±r
 =

180 
dyÇmic_ÿ¡
<cÚ¡ 
S”v”P»comm™
 *>(&
mes§ge
);

181 ià(!
	g£rv”_´ecomm™_±r
) {

182 
LOG
(
QFATAL
) << "HandleServerPrecommit() was…assed‡‚on-ServerPrecommit "

184  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

186 cÚ¡ 
	gS”v”P»comm™
 &
	g£rv”_´ecomm™
 = *
£rv”_´ecomm™_±r
;

188 cÚ¡ 
	g¡d
::
¡ršg
 &
ek•_v”siÚ
 =

189 
£rv”_´ecomm™
.
£Ëùed_ek•_v”siÚ
().
Çme
();

190 ià(!
S‘S–eùedEk•V”siÚ
(
ek•_v”siÚ
)) {

191  
Stus
(

192 
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

193 
ab¦
::
SŒC©
("S–eùed EKEP v”siÚ i šv®id: ", 
ek•_v”siÚ
));

196 
HªdshakeCh”
 
	gch”_su™e
 = 
£rv”_´ecomm™
.
£Ëùed_ch”_su™e
();

197 ià(!
S‘S–eùedCh”Su™e
(
ch”_su™e
)) {

198  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

199 
ab¦
::
SŒC©
("Selected cipher suite is invalid: ",

200 
HªdshakeCh”_Name
(
ch”_su™e
)));

204 
	g£Ëùed_ch”_su™e_
) {

205 
	gCURVE25519_SHA256
:

206 
S‘T¿nsütHashFunùiÚ
(
Ãw
 
Sha256Hash
());

209 
LOG
(
ERROR
) << "Client handshaker has bad cipher suite configuration"

210 << 
HªdshakeCh”_Name
(
£Ëùed_ch”_su™e_
);

211  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

215 
RecÜdPrÙocŞ
 
	g»cÜd_´ÙocŞ
 = 
£rv”_´ecomm™
.
£Ëùed_»cÜd_´ÙocŞ
();

216 ià(!
S‘S–eùedRecÜdPrÙocŞ
(
»cÜd_´ÙocŞ
)) {

217  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

218 
ab¦
::
SŒC©
("Selected„ecord…rotocol is invalid: ",

219 
RecÜdPrÙocŞ_Name
(
»cÜd_´ÙocŞ
)));

223 ià(
	g£rv”_´ecomm™
.
ch®Ënge
().
size
(è!ğ
kEk•Ch®ËngeSize
) {

224  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

225 
ab¦
::
SŒC©
("Challenge has incorrect size: ",

226 
£rv”_´ecomm™
.
ch®Ënge
().
size
()));

231 ià(
	g£rv”_´ecomm™
.
£rv”_»que¡s
().
em±y
()) {

232  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

235 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
£rv”_´ecomm™
.
£rv”_»que¡s
()) {

236 ià(
FšdAs£¹iÚDesütiÚ
(
£lf_as£¹iÚs_
, 
»que¡
.
desütiÚ
()) ==

237 
£lf_as£¹iÚs_
.
ûnd
()) {

238  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

246 ià(
	g£rv”_´ecomm™
.
£rv”_ofãrs
().
em±y
()) {

247  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

250 cÚ¡ 
	gAs£¹iÚOfãr
 &
	gofãr
 : 
£rv”_´ecomm™
.
£rv”_ofãrs
()) {

251 ià(
FšdAs£¹iÚDesütiÚ
(
acû±ed_³”_as£¹iÚs_
,

252 
ofãr
.
desütiÚ
()) ==

253 
acû±ed_³”_as£¹iÚs_
.
ûnd
()) {

254  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

262 
	g¡d
::
ŒªsfÜm
(

263 
£rv”_´ecomm™
.
£rv”_ofãrs
().
cbegš
(),

264 
£rv”_´ecomm™
.
£rv”_ofãrs
().
ûnd
(),

265 
¡d
::
back_š£¹”
(
ex³ùed_³”_as£¹iÚs_
),

266 [](cÚ¡ 
As£¹iÚOfãr
 &
ofãr
è-> cÚ¡ 
As£¹iÚDesütiÚ
 & {

267  
ofãr
.
desütiÚ
();

270  
Wr™eCl›ÁId
(
£rv”_´ecomm™
.
£rv”_»que¡s
().
cbegš
(),

271 
£rv”_´ecomm™
.
£rv”_»que¡s
().
ûnd
(), 
ouut
);

274 
Stus
 
	gCl›ÁEk•Hªdshak”
::
HªdËS”v”Id
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
) {

275 cÚ¡‡utØ*
£rv”_id_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
S”v”Id
 *>(&
mes§ge
);

276 ià(!
	g£rv”_id_±r
) {

277 
LOG
(
QFATAL
) << "HandleServerId() was…assed‡‚on-ServerId handshake "

279  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

281 cÚ¡ 
	gS”v”Id
 &
	g£rv”_id
 = *
£rv”_id_±r
;

286 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

287 ià(!
MakeEk•CÚ‹xtBlob
(
£rv”_id
.
dh_public_key
(),

288 
£rv”_as£¹iÚ_Œªsüt_
, &
ek•_cÚ‹xt
)) {

289  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Failedo generate context");

292 cÚ¡ 
	gAs£¹iÚ
 &
	gas£¹iÚ
 : 
£rv”_id
.
as£¹iÚs
()) {

293 autØ
desc_™
 = 
FšdAs£¹iÚDesütiÚ
(
ex³ùed_³”_as£¹iÚs_
,

294 
as£¹iÚ
.
desütiÚ
());

295 ià(
	gdesc_™
 =ğ
ex³ùed_³”_as£¹iÚs_
.
ûnd
()) {

296  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

301 
EnşaveId’t™y
 
	gid’t™y
;

305 
Stus
 
	g¡©us
 =

306 
G‘EnşaveAs£¹iÚV”if›r
(
as£¹iÚ
.
desütiÚ
())

307 ->
V”ify
Ğ
ek•_cÚ‹xt
, 
as£¹iÚ
, &
id’t™y
);

308 ià(!
	g¡©us
.
ok
()) {

309 
LOG
(
ERROR
è<< "As£¹iÚ could‚Ù bv”if›d: " << 
	g¡©us
;

310  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

313 
AddP“rId’t™y
(
id’t™y
);

314 
	gex³ùed_³”_as£¹iÚs_
.
”a£
(
desc_™
);

317 ià(!
	gex³ùed_³”_as£¹iÚs_
.
em±y
()) {

319  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

323 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rv”_public_key
;

324 
	g¡d
::
cİy
(
£rv”_id
.
dh_public_key
().
cbegš
(),

325 
£rv”_id
.
dh_public_key
().
ûnd
(),

326 
¡d
::
back_š£¹”
(
£rv”_public_key
));

330 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

331 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

332  
D”iveSeü‘s
(
£Ëùed_ch”_su™e_
, 
Œªsüt_hash
,

333 
£rv”_public_key
, 
dh_´iv©e_key_
, &
ma¡”_£ü‘_
,

334 &
auth’tiÿtÜ_£ü‘_
);

337 
Stus
 
	gCl›ÁEk•Hªdshak”
::
HªdËS”v”Fšish
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
,

338 
¡d
::
¡ršg
 *
ouut
) {

339 cÚ¡‡utØ*
£rv”_fšish_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
S”v”Fšish
 *>(&
mes§ge
);

340 ià(!
	g£rv”_fšish_±r
) {

341 
LOG
(
QFATAL
) << "HandleServerFinish() was…assed‡‚on-ServerFinish "

343  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

345 cÚ¡ 
	gS”v”Fšish
 &
	g£rv”_fšish
 = *
£rv”_fšish_±r
;

347 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gaùu®_£rv”_hªdshake_auth’tiÿtÜ
;

348 
	g¡d
::
cİy
(
£rv”_fšish
.
hªdshake_auth’tiÿtÜ
().
cbegš
(),

349 
£rv”_fšish
.
hªdshake_auth’tiÿtÜ
().
ûnd
(),

350 
¡d
::
back_š£¹”
(
aùu®_£rv”_hªdshake_auth’tiÿtÜ
));

353 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gex³ùed_£rv”_hªdshake_auth’tiÿtÜ
;

354 
ASYLO_RETURN_IF_ERROR
(
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

355 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
,

356 &
ex³ùed_£rv”_hªdshake_auth’tiÿtÜ
));

359 ià(!
CheckMacEqu®™y
(
ex³ùed_£rv”_hªdshake_auth’tiÿtÜ
,

360 
aùu®_£rv”_hªdshake_auth’tiÿtÜ
)) {

361  
Stus
(
AbÜt_E¼ÜCode_BAD_AUTHENTICATOR
,

365  
Wr™eCl›ÁFšish
(
ouut
);

368 
Stus
 
	gCl›ÁEk•Hªdshak”
::
Wr™eCl›ÁP»comm™
(
¡d
::
¡ršg
 *
ouut
) {

369 
Cl›ÁP»comm™
 
ş›Á_´ecomm™
;

371 
	g¡d
::
cİy
(
avaabË_ch”_su™es_
.
begš
(),‡vaabË_ch”_su™es_.
’d
(),

372 
googË
::
´Ùobuf
::
R•—‹dF›ldBackIn£¹”
(

373 
ş›Á_´ecomm™
.
mubË_avaabË_ch”_su™es
()));

375 
	g¡d
::
cİy
(
avaabË_»cÜd_´ÙocŞs_
.
begš
(),

376 
avaabË_»cÜd_´ÙocŞs_
.
’d
(),

377 
googË
::
´Ùobuf
::
R•—‹dF›ldBackIn£¹”
(

378 
ş›Á_´ecomm™
.
mubË_avaabË_»cÜd_´ÙocŞs
()));

380 cÚ¡ 
	g¡d
::
¡ršg
 &
v”siÚ_Çme
 : 
avaabË_ek•_v”siÚs_
) {

381 
Ek•V”siÚ
 *
ek•_v”siÚ
 = 
ş›Á_´ecomm™
.
add_avaabË_ek•_v”siÚs
();

382 
	gek•_v”siÚ
->
£t_Çme
(
v”siÚ_Çme
);

385 ià(!
	gadd™iÚ®_auth’tiÿ‹d_d©a_
.
em±y
()) {

386 
	gş›Á_´ecomm™
.
mubË_İtiÚs
()->
£t_d©a
(

387 
add™iÚ®_auth’tiÿ‹d_d©a_
);

390 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch®Ënge
(
kEk•Ch®ËngeSize
);

391 ià(
RAND_by‹s
(
ch®Ënge
.
d©a
(), 
kEk•Ch®ËngeSize
) != 1) {

392  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

394 
	gş›Á_´ecomm™
.
£t_ch®Ënge
(
ch®Ënge
.
d©a
(), ch®Ënge.
size
());

396 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
£lf_as£¹iÚs_
) {

400 
Stus
 
¡©us
 =

401 
G‘EnşaveAs£¹iÚG’”©Ü
(
desütiÚ
)

402 ->
C»©eAs£¹iÚOfãr
(
ş›Á_´ecomm™
.
add_ş›Á_ofãrs
());

403 ià(!
	g¡©us
.
ok
()) {

404 
LOG
(
ERROR
è<< "FaedØü—‹‡s£¹iÚ ofãr: " << 
	g¡©us
;

405  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

410 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
acû±ed_³”_as£¹iÚs_
) {

414 
Stus
 
¡©us
 =

415 
G‘EnşaveAs£¹iÚV”if›r
(
desütiÚ
)

416 ->
C»©eAs£¹iÚReque¡
(
ş›Á_´ecomm™
.
add_ş›Á_»que¡s
());

417 ià(!
	g¡©us
.
ok
()) {

418 
LOG
(
ERROR
è<< "FaedØü—‹‡s£¹iÚ„eque¡: " << 
	g¡©us
;

419  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

425  
Wr™eF¿meAndUpd©eT¿nsüt
(
CLIENT_PRECOMMIT
, 
ş›Á_´ecomm™
,

426 
ouut
);

429 
Stus
 
	gCl›ÁEk•Hªdshak”
::
Wr™eCl›ÁId
(

430 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
As£¹iÚReque¡
>::
cÚ¡_™”©Ü
 
»que¡s_fœ¡
,

431 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
As£¹iÚReque¡
>::
cÚ¡_™”©Ü
 
»que¡s_Ï¡
,

432 
¡d
::
¡ršg
 *
ouut
) {

435 
£Ëùed_ch”_su™e_
) {

436 
CURVE25519_SHA256
:

437 
dh_public_key_
.
»size
(
X25519_PUBLIC_VALUE_LEN
);

438 
	gdh_´iv©e_key_
.
»size
(
X25519_PRIVATE_KEY_LEN
);

439 
X25519_key·œ
(
dh_public_key_
.
d©a
(), 
dh_´iv©e_key_
.data());

442 
LOG
(
ERROR
) << "Client handshaker has bad cipher suite configuration";

443  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

447 
Cl›ÁId
 
	gş›Á_id
;

448 
	gş›Á_id
.
£t_dh_public_key
(
dh_public_key_
.
d©a
(), dh_public_key_.
size
());

450 
	g¡d
::
¡ršg
 
public_key
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
dh_public_key_
.
d©a
()),

451 
dh_public_key_
.
size
());

457 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

458 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

462 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

463 ià(!
MakeEk•CÚ‹xtBlob
(
public_key
, 
Œªsüt_hash
, &
ek•_cÚ‹xt
)) {

464  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

468 autØ
	g™
 = 
»que¡s_fœ¡
; iˆ!ğ
»que¡s_Ï¡
; ++it) {

469 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 = *
™
;

474 
Stus
 
	g¡©us
 =

475 
G‘EnşaveAs£¹iÚG’”©Ü
(
»que¡
.
desütiÚ
())

476 ->
G’”©e
(
ek•_cÚ‹xt
, 
»que¡
, 
ş›Á_id
.
add_as£¹iÚs
());

477 ià(!
	g¡©us
.
ok
()) {

478 
LOG
(
ERROR
è<< "As£¹iÚ g’”©iÚ faed: " << 
	g¡©us
;

479  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

484 
ASYLO_RETURN_IF_ERROR
(

485 
Wr™eF¿meAndUpd©eT¿nsüt
(
CLIENT_ID
, 
ş›Á_id
, 
ouut
));

492  
G‘T¿nsütHash
(&
£rv”_as£¹iÚ_Œªsüt_
);

495 
Stus
 
	gCl›ÁEk•Hªdshak”
::
Wr™eCl›ÁFšish
(
¡d
::
¡ršg
 *
ouut
) {

496 
CËªsšgVeùÜ
<
ušt8_t
> 
hªdshake_auth’tiÿtÜ
;

497 
ASYLO_RETURN_IF_ERROR
(
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

498 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
, &
hªdshake_auth’tiÿtÜ
));

500 
Cl›ÁFšish
 
	gş›Á_fšish
;

501 
	gş›Á_fšish
.
£t_hªdshake_auth’tiÿtÜ
(
hªdshake_auth’tiÿtÜ
.
d©a
(),

502 
hªdshake_auth’tiÿtÜ
.
size
());

504  
Wr™eF¿meAndUpd©eT¿nsüt
(
CLIENT_FINISH
, 
ş›Á_fšish
, 
ouut
);

507 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
S‘S–eùedEk•V”siÚ
(

508 cÚ¡ 
¡d
::
¡ršg
 &
ek•_v”siÚ
) {

510 autØ
v”siÚ_™
 = 
¡d
::
fšd
(
avaabË_ek•_v”siÚs_
.
cbegš
(),

511 
avaabË_ek•_v”siÚs_
.
ûnd
(), 
ek•_v”siÚ
);

512 ià(
	gv”siÚ_™
 =ğ
avaabË_ek•_v”siÚs_
.
ûnd
()) {

513  
çl£
;

516 
	g£Ëùed_ek•_v”siÚ_
 = 
ek•_v”siÚ
;

517  
	gŒue
;

520 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
S‘S–eùedCh”Su™e
(

521 
HªdshakeCh”
 
ch”_su™e
) {

523 autØ
ch”_™
 = 
¡d
::
fšd
(
avaabË_ch”_su™es_
.
cbegš
(),

524 
avaabË_ch”_su™es_
.
ûnd
(), 
ch”_su™e
);

525 ià(
	gch”_™
 =ğ
avaabË_ch”_su™es_
.
ûnd
()) {

526  
çl£
;

529 
	g£Ëùed_ch”_su™e_
 = 
ch”_su™e
;

530  
	gŒue
;

533 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
S‘S–eùedRecÜdPrÙocŞ
(

534 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
) {

536 autØ
´ÙocŞ_™
 =

537 
¡d
::
fšd
(
avaabË_»cÜd_´ÙocŞs_
.
cbegš
(),

538 
avaabË_»cÜd_´ÙocŞs_
.
ûnd
(), 
»cÜd_´ÙocŞ
);

539 ià(
	g´ÙocŞ_™
 =ğ
avaabË_»cÜd_´ÙocŞs_
.
’d
()) {

540  
çl£
;

543 
	g£Ëùed_»cÜd_´ÙocŞ_
 = 
»cÜd_´ÙocŞ
;

544 
S‘RecÜdPrÙocŞ
(
£Ëùed_»cÜd_´ÙocŞ_
);

545  
	gŒue
;

	@grpc/auth/core/client_ekep_handshaker.cc

19 
	~"asylo/g½c/auth/cÜe/ş›Á_ek•_hªdshak”.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/¿nd.h
>

24 
	~<®gÜ™hm
>

26 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

27 
	~"ab¦/memÜy/memÜy.h
"

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/üy±o/sha256_hash.h
"

30 
	~"asylo/ut/loggšg.h
"

31 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

32 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

33 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

34 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

35 
	~"asylo/id’t™y/id’t™y.pb.h
"

36 
	~"asylo/ut/ş—nsšg_ty³s.h
"

37 
	~"asylo/ut/¡©us_maüos.h
"

39 
Çme¥aû
 
	gasylo
 {

41 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
Cl›ÁEk•Hªdshak”
::
C»©e
(

42 cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
) {

43 
Stus
 
¡©us
 = 
İtiÚs
.
V®id©e
();

44 ià(!
	g¡©us
.
ok
()) {

45 
LOG
(
ERROR
è<< "Inv®id hªdshak” o±iÚs: " << 
	g¡©us
;

46  
	gnuÎ±r
;

48  
	gab¦
::
W¿pUnique
(
Ãw
 
Cl›ÁEk•Hªdshak”
(
İtiÚs
));

51 
	gCl›ÁEk•Hªdshak”
::
Cl›ÁEk•Hªdshak”
(cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
)

52 : 
Ek•Hªdshak”
(
İtiÚs
.
max_äame_size
),

53 
£lf_as£¹iÚs_
(
İtiÚs
.
£lf_as£¹iÚs
),

54 
acû±ed_³”_as£¹iÚs_
(
İtiÚs
.
acû±ed_³”_as£¹iÚs
),

55 
avaabË_ch”_su™es_
({
CURVE25519_SHA256
}),

56 
avaabË_»cÜd_´ÙocŞs_
({
SEAL_AES128_GCM
}),

57 
avaabË_ek•_v”siÚs_
({"EKEP v1"}),

58 
add™iÚ®_auth’tiÿ‹d_d©a_
(
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
),

59 
£Ëùed_ch”_su™e_
(
UNKNOWN_HANDSHAKE_CIPHER
),

60 
£Ëùed_»cÜd_´ÙocŞ_
(
UNKNOWN_RECORD_PROTOCOL
),

61 
ex³ùed_mes§ge_ty³_
(
SERVER_PRECOMMIT
),

62 
hªdshak”_¡©e_
(
Ek•Hªdshak”
::
HªdshakeS‹
::
NOT_STARTED
) {}

64 
boŞ
 
Cl›ÁEk•Hªdshak”
::
IsHªdshakeInProg»ss
() const {

65  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
IN_PROGRESS
;

68 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
IsHªdshakeCom¶‘ed
() const {

69  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
COMPLETED
;

72 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
IsHªdshakeAbÜ‹d
() const {

73  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
ABORTED
;

76 
HªdshakeMes§geTy³
 
	gCl›ÁEk•Hªdshak”
::
G‘Ex³ùedMes§geTy³
() const {

77 ià(!
IsHªdshakeInProg»ss
()) {

78  
UNKNOWN_HANDSHAKE_MESSAGE
;

80  
	gex³ùed_mes§ge_ty³_
;

83 
	gCl›ÁEk•Hªdshak”
::
ResuÉ
 
Cl›ÁEk•Hªdshak”
::
S¹Hªdshake
(

84 
¡d
::
¡ršg
 *
ouut
) {

85 
Stus
 
¡©us
 = 
Wr™eCl›ÁP»comm™
(
ouut
);

86 ià(!
	g¡©us
.
ok
()) {

87 
AbÜtHªdshake
(
¡©us
, 
ouut
);

88  
	gResuÉ
::
ABORTED
;

91 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
IN_PROGRESS
;

92  
	gResuÉ
::
IN_PROGRESS
;

95 
	gCl›ÁEk•Hªdshak”
::
AbÜtHªdshake
(cÚ¡ 
Stus
 &
abÜt_¡©us
,

96 
¡d
::
¡ršg
 *
ouut
) {

97 
AbÜt_E¼ÜCode
 
”rÜ_code
 =

98 
¡©ic_ÿ¡
<
AbÜt_E¼ÜCode
>(
abÜt_¡©us
.
”rÜ_code
());

99 
LOG
(
ERROR
è<< 
	gabÜt_¡©us
;

101 
AbÜt
 
	gabÜt
;

102 
	gabÜt
.
£t_code
(
”rÜ_code
);

103 
	gabÜt
.
£t_mes§ge
(
¡d
::
¡ršg
(
abÜt_¡©us
.
”rÜ_mes§ge
().
d©a
(),

104 
abÜt_¡©us
.
”rÜ_mes§ge
().
size
()));

106 
	ggoogË
::
´Ùobuf
::
io
::
SŒšgOuutSŒ—m
 
outgošg_äame
(
ouut
);

107 
Stus
 
	g¡©us
 = 
EncodeF¿me
(
ABORT
, 
abÜt
, &
outgošg_äame
);

108 ià(!
	g¡©us
.
ok
()) {

111 
LOG
(
ERROR
è<< "Encodšg oàABORT mes§gçed: " << 
	g¡©us
;

114 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

117 
	gCl›ÁEk•Hªdshak”
::
ResuÉ
 
Cl›ÁEk•Hªdshak”
::
HªdËHªdshakeMes§ge
(

118 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

119 
¡d
::
¡ršg
 *
ouut
) {

120 
Stus
 
¡©us
 = Stus::
OkStus
();

121 
	gmes§ge_ty³
) {

122 
	gSERVER_PRECOMMIT
:

123 
ex³ùed_mes§ge_ty³_
 = 
SERVER_ID
;

124 
	g¡©us
 = 
HªdËS”v”P»comm™
(
hªdshake_mes§ge
, 
ouut
);

126 
	gSERVER_ID
:

127 
ex³ùed_mes§ge_ty³_
 = 
SERVER_FINISH
;

128 
	g¡©us
 = 
HªdËS”v”Id
(
hªdshake_mes§ge
);

130 
	gSERVER_FINISH
:

131 
ex³ùed_mes§ge_ty³_
 = 
UNKNOWN_HANDSHAKE_MESSAGE
;

132 
	g¡©us
 = 
HªdËS”v”Fšish
(
hªdshake_mes§ge
, 
ouut
);

133 ià(
	g¡©us
.
ok
()) {

134 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
COMPLETED
;

140 
¡©us
 = 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

143 ià(!
	g¡©us
.
ok
()) {

144 
AbÜtHªdshake
(
¡©us
, 
ouut
);

150 ià(
IsHªdshakeCom¶‘ed
()) {

151 ià(!
D”iveAndS‘RecÜdPrÙocŞKey
(

152 
£Ëùed_ch”_su™e_
, 
£Ëùed_»cÜd_´ÙocŞ_
, 
ma¡”_£ü‘_
)

153 .
ok
()) {

154 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

158 
	ghªdshak”_¡©e_
) {

159 
	gHªdshakeS‹
::
COMPLETED
:

160  
ResuÉ
::
COMPLETED
;

161 
	gHªdshakeS‹
::
IN_PROGRESS
:

162  
ResuÉ
::
IN_PROGRESS
;

164  
ResuÉ
::
ABORTED
;

168 
	gCl›ÁEk•Hªdshak”
::
HªdËAbÜtMes§ge
(cÚ¡ 
AbÜt
 *
abÜt_mes§ge
) {

169 ià(
abÜt_mes§ge
) {

170 
LOG
(
ERROR
è<< "Reûived " << 
AbÜt_E¼ÜCode_Name
(
abÜt_mes§ge
->
code
())

171 << " from s”v”: " << 
abÜt_mes§ge
->
mes§ge
();

174 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

177 
Stus
 
	gCl›ÁEk•Hªdshak”
::
HªdËS”v”P»comm™
(

178 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
, 
¡d
::
¡ršg
 *
ouut
) {

179 cÚ¡‡utØ*
£rv”_´ecomm™_±r
 =

180 
dyÇmic_ÿ¡
<cÚ¡ 
S”v”P»comm™
 *>(&
mes§ge
);

181 ià(!
	g£rv”_´ecomm™_±r
) {

182 
LOG
(
QFATAL
) << "HandleServerPrecommit() was…assed‡‚on-ServerPrecommit "

184  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

186 cÚ¡ 
	gS”v”P»comm™
 &
	g£rv”_´ecomm™
 = *
£rv”_´ecomm™_±r
;

188 cÚ¡ 
	g¡d
::
¡ršg
 &
ek•_v”siÚ
 =

189 
£rv”_´ecomm™
.
£Ëùed_ek•_v”siÚ
().
Çme
();

190 ià(!
S‘S–eùedEk•V”siÚ
(
ek•_v”siÚ
)) {

191  
Stus
(

192 
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

193 
ab¦
::
SŒC©
("S–eùed EKEP v”siÚ i šv®id: ", 
ek•_v”siÚ
));

196 
HªdshakeCh”
 
	gch”_su™e
 = 
£rv”_´ecomm™
.
£Ëùed_ch”_su™e
();

197 ià(!
S‘S–eùedCh”Su™e
(
ch”_su™e
)) {

198  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

199 
ab¦
::
SŒC©
("Selected cipher suite is invalid: ",

200 
HªdshakeCh”_Name
(
ch”_su™e
)));

204 
	g£Ëùed_ch”_su™e_
) {

205 
	gCURVE25519_SHA256
:

206 
S‘T¿nsütHashFunùiÚ
(
Ãw
 
Sha256Hash
());

209 
LOG
(
ERROR
) << "Client handshaker has bad cipher suite configuration"

210 << 
HªdshakeCh”_Name
(
£Ëùed_ch”_su™e_
);

211  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

215 
RecÜdPrÙocŞ
 
	g»cÜd_´ÙocŞ
 = 
£rv”_´ecomm™
.
£Ëùed_»cÜd_´ÙocŞ
();

216 ià(!
S‘S–eùedRecÜdPrÙocŞ
(
»cÜd_´ÙocŞ
)) {

217  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

218 
ab¦
::
SŒC©
("Selected„ecord…rotocol is invalid: ",

219 
RecÜdPrÙocŞ_Name
(
»cÜd_´ÙocŞ
)));

223 ià(
	g£rv”_´ecomm™
.
ch®Ënge
().
size
(è!ğ
kEk•Ch®ËngeSize
) {

224  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

225 
ab¦
::
SŒC©
("Challenge has incorrect size: ",

226 
£rv”_´ecomm™
.
ch®Ënge
().
size
()));

231 ià(
	g£rv”_´ecomm™
.
£rv”_»que¡s
().
em±y
()) {

232  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

235 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
£rv”_´ecomm™
.
£rv”_»que¡s
()) {

236 ià(
FšdAs£¹iÚDesütiÚ
(
£lf_as£¹iÚs_
, 
»que¡
.
desütiÚ
()) ==

237 
£lf_as£¹iÚs_
.
ûnd
()) {

238  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

246 ià(
	g£rv”_´ecomm™
.
£rv”_ofãrs
().
em±y
()) {

247  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

250 cÚ¡ 
	gAs£¹iÚOfãr
 &
	gofãr
 : 
£rv”_´ecomm™
.
£rv”_ofãrs
()) {

251 ià(
FšdAs£¹iÚDesütiÚ
(
acû±ed_³”_as£¹iÚs_
,

252 
ofãr
.
desütiÚ
()) ==

253 
acû±ed_³”_as£¹iÚs_
.
ûnd
()) {

254  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

262 
	g¡d
::
ŒªsfÜm
(

263 
£rv”_´ecomm™
.
£rv”_ofãrs
().
cbegš
(),

264 
£rv”_´ecomm™
.
£rv”_ofãrs
().
ûnd
(),

265 
¡d
::
back_š£¹”
(
ex³ùed_³”_as£¹iÚs_
),

266 [](cÚ¡ 
As£¹iÚOfãr
 &
ofãr
è-> cÚ¡ 
As£¹iÚDesütiÚ
 & {

267  
ofãr
.
desütiÚ
();

270  
Wr™eCl›ÁId
(
£rv”_´ecomm™
.
£rv”_»que¡s
().
cbegš
(),

271 
£rv”_´ecomm™
.
£rv”_»que¡s
().
ûnd
(), 
ouut
);

274 
Stus
 
	gCl›ÁEk•Hªdshak”
::
HªdËS”v”Id
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
) {

275 cÚ¡‡utØ*
£rv”_id_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
S”v”Id
 *>(&
mes§ge
);

276 ià(!
	g£rv”_id_±r
) {

277 
LOG
(
QFATAL
) << "HandleServerId() was…assed‡‚on-ServerId handshake "

279  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

281 cÚ¡ 
	gS”v”Id
 &
	g£rv”_id
 = *
£rv”_id_±r
;

286 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

287 ià(!
MakeEk•CÚ‹xtBlob
(
£rv”_id
.
dh_public_key
(),

288 
£rv”_as£¹iÚ_Œªsüt_
, &
ek•_cÚ‹xt
)) {

289  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Failedo generate context");

292 cÚ¡ 
	gAs£¹iÚ
 &
	gas£¹iÚ
 : 
£rv”_id
.
as£¹iÚs
()) {

293 autØ
desc_™
 = 
FšdAs£¹iÚDesütiÚ
(
ex³ùed_³”_as£¹iÚs_
,

294 
as£¹iÚ
.
desütiÚ
());

295 ià(
	gdesc_™
 =ğ
ex³ùed_³”_as£¹iÚs_
.
ûnd
()) {

296  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

301 
EnşaveId’t™y
 
	gid’t™y
;

305 
Stus
 
	g¡©us
 =

306 
G‘EnşaveAs£¹iÚV”if›r
(
as£¹iÚ
.
desütiÚ
())

307 ->
V”ify
Ğ
ek•_cÚ‹xt
, 
as£¹iÚ
, &
id’t™y
);

308 ià(!
	g¡©us
.
ok
()) {

309 
LOG
(
ERROR
è<< "As£¹iÚ could‚Ù bv”if›d: " << 
	g¡©us
;

310  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

313 
AddP“rId’t™y
(
id’t™y
);

314 
	gex³ùed_³”_as£¹iÚs_
.
”a£
(
desc_™
);

317 ià(!
	gex³ùed_³”_as£¹iÚs_
.
em±y
()) {

319  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

323 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rv”_public_key
;

324 
	g¡d
::
cİy
(
£rv”_id
.
dh_public_key
().
cbegš
(),

325 
£rv”_id
.
dh_public_key
().
ûnd
(),

326 
¡d
::
back_š£¹”
(
£rv”_public_key
));

330 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

331 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

332  
D”iveSeü‘s
(
£Ëùed_ch”_su™e_
, 
Œªsüt_hash
,

333 
£rv”_public_key
, 
dh_´iv©e_key_
, &
ma¡”_£ü‘_
,

334 &
auth’tiÿtÜ_£ü‘_
);

337 
Stus
 
	gCl›ÁEk•Hªdshak”
::
HªdËS”v”Fšish
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
,

338 
¡d
::
¡ršg
 *
ouut
) {

339 cÚ¡‡utØ*
£rv”_fšish_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
S”v”Fšish
 *>(&
mes§ge
);

340 ià(!
	g£rv”_fšish_±r
) {

341 
LOG
(
QFATAL
) << "HandleServerFinish() was…assed‡‚on-ServerFinish "

343  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

345 cÚ¡ 
	gS”v”Fšish
 &
	g£rv”_fšish
 = *
£rv”_fšish_±r
;

347 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gaùu®_£rv”_hªdshake_auth’tiÿtÜ
;

348 
	g¡d
::
cİy
(
£rv”_fšish
.
hªdshake_auth’tiÿtÜ
().
cbegš
(),

349 
£rv”_fšish
.
hªdshake_auth’tiÿtÜ
().
ûnd
(),

350 
¡d
::
back_š£¹”
(
aùu®_£rv”_hªdshake_auth’tiÿtÜ
));

353 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gex³ùed_£rv”_hªdshake_auth’tiÿtÜ
;

354 
ASYLO_RETURN_IF_ERROR
(
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

355 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
,

356 &
ex³ùed_£rv”_hªdshake_auth’tiÿtÜ
));

359 ià(!
CheckMacEqu®™y
(
ex³ùed_£rv”_hªdshake_auth’tiÿtÜ
,

360 
aùu®_£rv”_hªdshake_auth’tiÿtÜ
)) {

361  
Stus
(
AbÜt_E¼ÜCode_BAD_AUTHENTICATOR
,

365  
Wr™eCl›ÁFšish
(
ouut
);

368 
Stus
 
	gCl›ÁEk•Hªdshak”
::
Wr™eCl›ÁP»comm™
(
¡d
::
¡ršg
 *
ouut
) {

369 
Cl›ÁP»comm™
 
ş›Á_´ecomm™
;

371 
	g¡d
::
cİy
(
avaabË_ch”_su™es_
.
begš
(),‡vaabË_ch”_su™es_.
’d
(),

372 
googË
::
´Ùobuf
::
R•—‹dF›ldBackIn£¹”
(

373 
ş›Á_´ecomm™
.
mubË_avaabË_ch”_su™es
()));

375 
	g¡d
::
cİy
(
avaabË_»cÜd_´ÙocŞs_
.
begš
(),

376 
avaabË_»cÜd_´ÙocŞs_
.
’d
(),

377 
googË
::
´Ùobuf
::
R•—‹dF›ldBackIn£¹”
(

378 
ş›Á_´ecomm™
.
mubË_avaabË_»cÜd_´ÙocŞs
()));

380 cÚ¡ 
	g¡d
::
¡ršg
 &
v”siÚ_Çme
 : 
avaabË_ek•_v”siÚs_
) {

381 
Ek•V”siÚ
 *
ek•_v”siÚ
 = 
ş›Á_´ecomm™
.
add_avaabË_ek•_v”siÚs
();

382 
	gek•_v”siÚ
->
£t_Çme
(
v”siÚ_Çme
);

385 ià(!
	gadd™iÚ®_auth’tiÿ‹d_d©a_
.
em±y
()) {

386 
	gş›Á_´ecomm™
.
mubË_İtiÚs
()->
£t_d©a
(

387 
add™iÚ®_auth’tiÿ‹d_d©a_
);

390 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch®Ënge
(
kEk•Ch®ËngeSize
);

391 ià(
RAND_by‹s
(
ch®Ënge
.
d©a
(), 
kEk•Ch®ËngeSize
) != 1) {

392  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

394 
	gş›Á_´ecomm™
.
£t_ch®Ënge
(
ch®Ënge
.
d©a
(), ch®Ënge.
size
());

396 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
£lf_as£¹iÚs_
) {

400 
Stus
 
¡©us
 =

401 
G‘EnşaveAs£¹iÚG’”©Ü
(
desütiÚ
)

402 ->
C»©eAs£¹iÚOfãr
(
ş›Á_´ecomm™
.
add_ş›Á_ofãrs
());

403 ià(!
	g¡©us
.
ok
()) {

404 
LOG
(
ERROR
è<< "FaedØü—‹‡s£¹iÚ ofãr: " << 
	g¡©us
;

405  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

410 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
acû±ed_³”_as£¹iÚs_
) {

414 
Stus
 
¡©us
 =

415 
G‘EnşaveAs£¹iÚV”if›r
(
desütiÚ
)

416 ->
C»©eAs£¹iÚReque¡
(
ş›Á_´ecomm™
.
add_ş›Á_»que¡s
());

417 ià(!
	g¡©us
.
ok
()) {

418 
LOG
(
ERROR
è<< "FaedØü—‹‡s£¹iÚ„eque¡: " << 
	g¡©us
;

419  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

425  
Wr™eF¿meAndUpd©eT¿nsüt
(
CLIENT_PRECOMMIT
, 
ş›Á_´ecomm™
,

426 
ouut
);

429 
Stus
 
	gCl›ÁEk•Hªdshak”
::
Wr™eCl›ÁId
(

430 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
As£¹iÚReque¡
>::
cÚ¡_™”©Ü
 
»que¡s_fœ¡
,

431 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
As£¹iÚReque¡
>::
cÚ¡_™”©Ü
 
»que¡s_Ï¡
,

432 
¡d
::
¡ršg
 *
ouut
) {

435 
£Ëùed_ch”_su™e_
) {

436 
CURVE25519_SHA256
:

437 
dh_public_key_
.
»size
(
X25519_PUBLIC_VALUE_LEN
);

438 
	gdh_´iv©e_key_
.
»size
(
X25519_PRIVATE_KEY_LEN
);

439 
X25519_key·œ
(
dh_public_key_
.
d©a
(), 
dh_´iv©e_key_
.data());

442 
LOG
(
ERROR
) << "Client handshaker has bad cipher suite configuration";

443  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

447 
Cl›ÁId
 
	gş›Á_id
;

448 
	gş›Á_id
.
£t_dh_public_key
(
dh_public_key_
.
d©a
(), dh_public_key_.
size
());

450 
	g¡d
::
¡ršg
 
public_key
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
dh_public_key_
.
d©a
()),

451 
dh_public_key_
.
size
());

457 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

458 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

462 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

463 ià(!
MakeEk•CÚ‹xtBlob
(
public_key
, 
Œªsüt_hash
, &
ek•_cÚ‹xt
)) {

464  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

468 autØ
	g™
 = 
»que¡s_fœ¡
; iˆ!ğ
»que¡s_Ï¡
; ++it) {

469 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 = *
™
;

474 
Stus
 
	g¡©us
 =

475 
G‘EnşaveAs£¹iÚG’”©Ü
(
»que¡
.
desütiÚ
())

476 ->
G’”©e
(
ek•_cÚ‹xt
, 
»que¡
, 
ş›Á_id
.
add_as£¹iÚs
());

477 ià(!
	g¡©us
.
ok
()) {

478 
LOG
(
ERROR
è<< "As£¹iÚ g’”©iÚ faed: " << 
	g¡©us
;

479  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

484 
ASYLO_RETURN_IF_ERROR
(

485 
Wr™eF¿meAndUpd©eT¿nsüt
(
CLIENT_ID
, 
ş›Á_id
, 
ouut
));

492  
G‘T¿nsütHash
(&
£rv”_as£¹iÚ_Œªsüt_
);

495 
Stus
 
	gCl›ÁEk•Hªdshak”
::
Wr™eCl›ÁFšish
(
¡d
::
¡ršg
 *
ouut
) {

496 
CËªsšgVeùÜ
<
ušt8_t
> 
hªdshake_auth’tiÿtÜ
;

497 
ASYLO_RETURN_IF_ERROR
(
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

498 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
, &
hªdshake_auth’tiÿtÜ
));

500 
Cl›ÁFšish
 
	gş›Á_fšish
;

501 
	gş›Á_fšish
.
£t_hªdshake_auth’tiÿtÜ
(
hªdshake_auth’tiÿtÜ
.
d©a
(),

502 
hªdshake_auth’tiÿtÜ
.
size
());

504  
Wr™eF¿meAndUpd©eT¿nsüt
(
CLIENT_FINISH
, 
ş›Á_fšish
, 
ouut
);

507 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
S‘S–eùedEk•V”siÚ
(

508 cÚ¡ 
¡d
::
¡ršg
 &
ek•_v”siÚ
) {

510 autØ
v”siÚ_™
 = 
¡d
::
fšd
(
avaabË_ek•_v”siÚs_
.
cbegš
(),

511 
avaabË_ek•_v”siÚs_
.
ûnd
(), 
ek•_v”siÚ
);

512 ià(
	gv”siÚ_™
 =ğ
avaabË_ek•_v”siÚs_
.
ûnd
()) {

513  
çl£
;

516 
	g£Ëùed_ek•_v”siÚ_
 = 
ek•_v”siÚ
;

517  
	gŒue
;

520 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
S‘S–eùedCh”Su™e
(

521 
HªdshakeCh”
 
ch”_su™e
) {

523 autØ
ch”_™
 = 
¡d
::
fšd
(
avaabË_ch”_su™es_
.
cbegš
(),

524 
avaabË_ch”_su™es_
.
ûnd
(), 
ch”_su™e
);

525 ià(
	gch”_™
 =ğ
avaabË_ch”_su™es_
.
ûnd
()) {

526  
çl£
;

529 
	g£Ëùed_ch”_su™e_
 = 
ch”_su™e
;

530  
	gŒue
;

533 
boŞ
 
	gCl›ÁEk•Hªdshak”
::
S‘S–eùedRecÜdPrÙocŞ
(

534 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
) {

536 autØ
´ÙocŞ_™
 =

537 
¡d
::
fšd
(
avaabË_»cÜd_´ÙocŞs_
.
cbegš
(),

538 
avaabË_»cÜd_´ÙocŞs_
.
ûnd
(), 
»cÜd_´ÙocŞ
);

539 ià(
	g´ÙocŞ_™
 =ğ
avaabË_»cÜd_´ÙocŞs_
.
’d
()) {

540  
çl£
;

543 
	g£Ëùed_»cÜd_´ÙocŞ_
 = 
»cÜd_´ÙocŞ
;

544 
S‘RecÜdPrÙocŞ
(
£Ëùed_»cÜd_´ÙocŞ_
);

545  
	gŒue
;

	@grpc/auth/core/client_ekep_handshaker.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_CLIENT_EKEP_HANDSHAKER_H_


20 
	#ASYLO_GRPC_AUTH_CORE_CLIENT_EKEP_HANDSHAKER_H_


	)

22 
	~<c¡dšt
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

28 
	~<googË/´Ùobuf/mes§ge.h
>

29 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

30 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

31 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
Çme¥aû
 
	gasylo
 {

39 şas 
	cCl›ÁEk•Hªdshak”
 
	gfš®
 : 
public
 
Ek•Hªdshak”
 {

40 
public
:

44 
¡d
::
unique_±r
<
Ek•Hªdshak”
> 
C»©e
(

45 cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
);

47 
	g´Ùeùed
:

49 
boŞ
 
IsHªdshakeInProg»ss
(ècÚ¡ 
ov”ride
;

52 
boŞ
 
IsHªdshakeCom¶‘ed
(ècÚ¡ 
	gov”ride
;

55 
boŞ
 
IsHªdshakeAbÜ‹d
(ècÚ¡ 
	gov”ride
;

58 
HªdshakeMes§geTy³
 
G‘Ex³ùedMes§geTy³
(ècÚ¡ 
	gov”ride
;

61 
ResuÉ
 
S¹Hªdshake
(
¡d
::
¡ršg
 *
ouut
è
ov”ride
;

64 
AbÜtHªdshake
(cÚ¡ 
Stus
 &
abÜt_¡©us
, 
¡d
::
¡ršg
 *
ouut
è
ov”ride
;

67 
ResuÉ
 
HªdËHªdshakeMes§ge
(
HªdshakeMes§geTy³
 
mes§ge_ty³
,

68 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

69 
¡d
::
¡ršg
 *
ouut
è
ov”ride
;

72 
HªdËAbÜtMes§ge
(cÚ¡ 
AbÜt
 *
abÜt_mes§ge
è
	gov”ride
;

74 
	g´iv©e
:

76 
Cl›ÁEk•Hªdshak”
(cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
);

81 
Stus
 
HªdËS”v”P»comm™
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
,

82 
¡d
::
¡ršg
 *
ouut
);

85 
Stus
 
HªdËS”v”Id
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
);

90 
Stus
 
HªdËS”v”Fšish
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
,

91 
¡d
::
¡ršg
 *
ouut
);

94 
Stus
 
Wr™eCl›ÁP»comm™
(
¡d
::
¡ršg
 *
ouut
);

100 
Stus
 
Wr™eCl›ÁId
(

101 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
As£¹iÚReque¡
>::
cÚ¡_™”©Ü
 
»que¡s_fœ¡
,

102 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
As£¹iÚReque¡
>::
cÚ¡_™”©Ü
 
»que¡s_Ï¡
,

103 
¡d
::
¡ršg
 *
ouut
);

107 
Stus
 
Wr™eCl›ÁFšish
(
¡d
::
¡ršg
 *
ouut
);

111 
boŞ
 
S‘S–eùedEk•V”siÚ
(cÚ¡ 
¡d
::
¡ršg
 &
ek•_v”siÚ
);

115 
boŞ
 
S‘S–eùedCh”Su™e
(
HªdshakeCh”
 
ch”_su™e
);

120 
boŞ
 
S‘S–eùedRecÜdPrÙocŞ
(
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
);

123 cÚ¡ 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
£lf_as£¹iÚs_
;

126 cÚ¡ 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
acû±ed_³”_as£¹iÚs_
;

130 cÚ¡ 
	g¡d
::
veùÜ
<
HªdshakeCh”
> 
avaabË_ch”_su™es_
;

134 cÚ¡ 
	g¡d
::
veùÜ
<
RecÜdPrÙocŞ
> 
avaabË_»cÜd_´ÙocŞs_
;

138 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
avaabË_ek•_v”siÚs_
;

141 cÚ¡ 
	g¡d
::
¡ršg
 
add™iÚ®_auth’tiÿ‹d_d©a_
;

145 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
ex³ùed_³”_as£¹iÚs_
;

149 
HªdshakeCh”
 
	g£Ëùed_ch”_su™e_
;

154 
RecÜdPrÙocŞ
 
	g£Ëùed_»cÜd_´ÙocŞ_
;

158 
	g¡d
::
¡ršg
 
£Ëùed_ek•_v”siÚ_
;

161 
	g¡d
::
veùÜ
<
ušt8_t
> 
dh_public_key_
;

162 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gdh_´iv©e_key_
;

165 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘_
;

166 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘_
;

170 
	g¡d
::
¡ršg
 
£rv”_as£¹iÚ_Œªsüt_
;

173 
HªdshakeMes§geTy³
 
	gex³ùed_mes§ge_ty³_
;

176 
	gEk•Hªdshak”
::
HªdshakeS‹
 
hªdshak”_¡©e_
;

	@grpc/auth/core/ekep_crypto.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/dige¡.h
>

23 
	~<İ’s¦/hkdf.h
>

24 
	~<İ’s¦/hmac.h
>

25 
	~<İ’s¦/mem.h
>

26 
	~<İ’s¦/¿nd.h
>

27 
	~<İ’s¦/sha.h
>

29 
	~<c¡dšt
>

30 
	~<memÜy
>

32 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

33 
	~"asylo/üy±o/ut/bs¦_ut.h
"

34 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

35 
	~"asylo/ut/loggšg.h
"

36 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

37 
	~"asylo/ut/¡©us.h
"

39 
Çme¥aû
 
	gasylo
 {

40 
	gÇme¥aû
 {

42 
cÚ¡ex´
 
size_t
 
	gkEk•Seü‘Size
 =

43 (
kEk•Ma¡”Seü‘Size
 + 
kEk•Auth’tiÿtÜSeü‘Size
);

45 
cÚ¡ex´
 
	gkEk•HkdfS®t
[] = "EKEP Handshake v1";

46 
cÚ¡ex´
 
	gkEk•HkdfS®tRecÜdPrÙocŞ
[] = "EKEP Record Protocol v1";

47 
cÚ¡ex´
 
	gkS”v”Auth’tiÿ‹dText
[] = "EKEP Handshake v1: Server Finish";

48 
cÚ¡ex´
 
	gkCl›ÁAuth’tiÿ‹dText
[] = "EKEP Handshake v1: Client Finish";

55 
Stus
 
Hmac
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
key
,

56 
By‹CÚš”V›w
 
auth’tiÿ‹d_‹xt
,

57 
CËªsšgVeùÜ
<
ušt8_t
> *
mac
) {

58 
	gmac
->
ş—r
();

59 cÚ¡ 
EVP_MD
 *
	gdige¡
 = 
nuÎ±r
;

60 
	gch”su™e
) {

61 
	gCURVE25519_SHA256
:

62 
dige¡
 = 
EVP_sha256
();

63 
	gmac
->
»size
(
SHA256_DIGEST_LENGTH
);

66  
Stus
(

67 
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

68 "Ch”su™nÙ suµÜ‹d: " + 
HªdshakeCh”_Name
(
ch”su™e
));

71 
	gmac_size
 = 
mac
->
size
();

72 ià(!
HMAC
(
dige¡
, 
key
.
d©a
(), key.
size
(), 
auth’tiÿ‹d_‹xt
.data(),

73 
auth’tiÿ‹d_‹xt
.
size
(), 
mac
->
d©a
(), &
mac_size
)) {

74 
LOG
(
ERROR
è<< "HMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

75  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

77  
	gStus
::
OkStus
();

82 
Stus
 
D”iveSeü‘s
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
,

83 
By‹CÚš”V›w
 
Œªsüt_hash
,

84 
By‹CÚš”V›w
 
³”_dh_public_key
,

85 
By‹CÚš”V›w
 
£lf_dh_´iv©e_key
,

86 
CËªsšgVeùÜ
<
ušt8_t
> *
ma¡”_£ü‘
,

87 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ_£ü‘
) {

88 cÚ¡ 
EVP_MD
 *
	gdige¡
 = 
nuÎ±r
;

89 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gsh¬ed_£ü‘
;

93 
	gch”su™e
) {

94 
	gCURVE25519_SHA256
:

96 ià(
³”_dh_public_key
.
size
(è!ğ
X25519_PUBLIC_VALUE_LEN
) {

97  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

98 
ab¦
::
SŒC©
("Public…arameter has incorrect size: ",

99 
³”_dh_public_key
.
size
()));

101 ià(
	g£lf_dh_´iv©e_key
.
size
(è!ğ
X25519_PRIVATE_KEY_LEN
) {

102  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

103 
ab¦
::
SŒC©
("Private…arameter has incorrect size: ",

104 
£lf_dh_´iv©e_key
.
size
()));

108 
	gsh¬ed_£ü‘
.
»size
(
X25519_SHARED_KEY_LEN
);

109 ià(!
X25519
(
sh¬ed_£ü‘
.
d©a
(), 
£lf_dh_´iv©e_key
.data(),

110 
³”_dh_public_key
.
d©a
())) {

111 
LOG
(
ERROR
è<< "X25519 faed: " << 
Bs¦La¡E¼ÜSŒšg
();

112  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

116 
	gdige¡
 = 
EVP_sha256
();

119  
Stus
(

120 
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

121 "Ch”su™nÙ suµÜ‹d: " + 
HªdshakeCh”_Name
(
ch”su™e
));

125 
	g¡d
::
¡ršg
 
§É
(
kEk•HkdfS®t
);

126 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_key
;

127 
	gouut_key
.
»size
(
kEk•Seü‘Size
);

128 ià(!
HKDF
(
ouut_key
.
d©a
(), 
kEk•Seü‘Size
, 
dige¡
, 
sh¬ed_£ü‘
.data(),

129 
sh¬ed_£ü‘
.
size
(),

130 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
§É
.
d©a
()), s®t.
size
(),

131 
Œªsüt_hash
.
d©a
(),¿nsüt_hash.
size
())) {

132 
LOG
(
ERROR
è<< "HKDF faed: " << 
Bs¦La¡E¼ÜSŒšg
();

133  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

137 
	g¡d
::
cİy
(
ouut_key
.
cbegš
(), ouut_key.cbegš(è+ 
kEk•Ma¡”Seü‘Size
,

138 
¡d
::
back_š£¹”
(*
ma¡”_£ü‘
));

141 
	g¡d
::
cİy
(
ouut_key
.
cbegš
(è+ 
kEk•Ma¡”Seü‘Size
, ouut_key.
ûnd
(),

142 
¡d
::
back_š£¹”
(*
auth’tiÿtÜ_£ü‘
));

144  
	gStus
::
OkStus
();

147 
Stus
 
D”iveRecÜdPrÙocŞKey
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
,

148 cÚ¡ 
RecÜdPrÙocŞ
 &
»cÜd_´ÙocŞ
,

149 
By‹CÚš”V›w
 
Œªsüt_hash
,

150 
By‹CÚš”V›w
 
ma¡”_£ü‘
,

151 
CËªsšgVeùÜ
<
ušt8_t
> *
»cÜd_´ÙocŞ_key
) {

152 
	g»cÜd_´ÙocŞ_key
->
ş—r
();

153 cÚ¡ 
EVP_MD
 *
	gdige¡
 = 
nuÎ±r
;

154 
	gch”su™e
) {

155 
	gCURVE25519_SHA256
:

156 
dige¡
 = 
EVP_sha256
();

159  
Stus
(

160 
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

161 "Ch”su™nÙ suµÜ‹d: " + 
HªdshakeCh”_Name
(
ch”su™e
));

166 
	g»cÜd_´ÙocŞ
) {

167 
	gSEAL_AES128_GCM
:

168 
»cÜd_´ÙocŞ_key
->
»size
(
kS—lAes128GcmKeySize
);

176 
RAND_by‹s
(
»cÜd_´ÙocŞ_key
->
d©a
(),„ecÜd_´ÙocŞ_key->
size
());

179  
Stus
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
,

181 
RecÜdPrÙocŞ_Name
(
»cÜd_´ÙocŞ
));

184 
	g¡d
::
¡ršg
 
§É
(
kEk•HkdfS®tRecÜdPrÙocŞ
);

185 ià(!
HKDF
(
»cÜd_´ÙocŞ_key
->
d©a
(),„ecÜd_´ÙocŞ_key->
size
(), 
dige¡
,

186 
ma¡”_£ü‘
.
d©a
(), ma¡”_£ü‘.
size
(),

187 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
§É
.
d©a
()), s®t.
size
(),

188 
Œªsüt_hash
.
d©a
(),¿nsüt_hash.
size
())) {

189 
LOG
(
ERROR
è<< "HKDF faed: " << 
Bs¦La¡E¼ÜSŒšg
();

190  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

192  
	gStus
::
OkStus
();

195 
Stus
 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

196 cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
auth’tiÿtÜ_£ü‘
,

197 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ
) {

198 
	g¡d
::
¡ršg
 
šput
(
kCl›ÁAuth’tiÿ‹dText
);

199  
Hmac
(
ch”su™e
, 
auth’tiÿtÜ_£ü‘
, 
šput
, 
auth’tiÿtÜ
);

202 
Stus
 
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

203 cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
auth’tiÿtÜ_£ü‘
,

204 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ
) {

205 
	g¡d
::
¡ršg
 
šput
(
kS”v”Auth’tiÿ‹dText
);

206  
Hmac
(
ch”su™e
, 
auth’tiÿtÜ_£ü‘
, 
šput
, 
auth’tiÿtÜ
);

209 
boŞ
 
CheckMacEqu®™y
(
CËªsšgVeùÜ
<
ušt8_t
> 
mac1
,

210 
CËªsšgVeùÜ
<
ušt8_t
> 
mac2
) {

211 ià(
	gmac1
.
size
(è!ğ
mac2
.size()) {

212  
çl£
;

214  
CRYPTO_memcmp
(
mac1
.
d©a
(), 
mac2
.d©a(), mac1.
size
()) == 0;

	@grpc/auth/core/ekep_crypto.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/dige¡.h
>

23 
	~<İ’s¦/hkdf.h
>

24 
	~<İ’s¦/hmac.h
>

25 
	~<İ’s¦/mem.h
>

26 
	~<İ’s¦/¿nd.h
>

27 
	~<İ’s¦/sha.h
>

29 
	~<c¡dšt
>

30 
	~<memÜy
>

32 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

33 
	~"asylo/üy±o/ut/bs¦_ut.h
"

34 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

35 
	~"asylo/ut/loggšg.h
"

36 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

37 
	~"asylo/ut/¡©us.h
"

39 
Çme¥aû
 
	gasylo
 {

40 
	gÇme¥aû
 {

42 
cÚ¡ex´
 
size_t
 
	gkEk•Seü‘Size
 =

43 (
kEk•Ma¡”Seü‘Size
 + 
kEk•Auth’tiÿtÜSeü‘Size
);

45 
cÚ¡ex´
 
	gkEk•HkdfS®t
[] = "EKEP Handshake v1";

46 
cÚ¡ex´
 
	gkEk•HkdfS®tRecÜdPrÙocŞ
[] = "EKEP Record Protocol v1";

47 
cÚ¡ex´
 
	gkS”v”Auth’tiÿ‹dText
[] = "EKEP Handshake v1: Server Finish";

48 
cÚ¡ex´
 
	gkCl›ÁAuth’tiÿ‹dText
[] = "EKEP Handshake v1: Client Finish";

55 
Stus
 
Hmac
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
key
,

56 
By‹CÚš”V›w
 
auth’tiÿ‹d_‹xt
,

57 
CËªsšgVeùÜ
<
ušt8_t
> *
mac
) {

58 
	gmac
->
ş—r
();

59 cÚ¡ 
EVP_MD
 *
	gdige¡
 = 
nuÎ±r
;

60 
	gch”su™e
) {

61 
	gCURVE25519_SHA256
:

62 
dige¡
 = 
EVP_sha256
();

63 
	gmac
->
»size
(
SHA256_DIGEST_LENGTH
);

66  
Stus
(

67 
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

68 "Ch”su™nÙ suµÜ‹d: " + 
HªdshakeCh”_Name
(
ch”su™e
));

71 
	gmac_size
 = 
mac
->
size
();

72 ià(!
HMAC
(
dige¡
, 
key
.
d©a
(), key.
size
(), 
auth’tiÿ‹d_‹xt
.data(),

73 
auth’tiÿ‹d_‹xt
.
size
(), 
mac
->
d©a
(), &
mac_size
)) {

74 
LOG
(
ERROR
è<< "HMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

75  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

77  
	gStus
::
OkStus
();

82 
Stus
 
D”iveSeü‘s
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
,

83 
By‹CÚš”V›w
 
Œªsüt_hash
,

84 
By‹CÚš”V›w
 
³”_dh_public_key
,

85 
By‹CÚš”V›w
 
£lf_dh_´iv©e_key
,

86 
CËªsšgVeùÜ
<
ušt8_t
> *
ma¡”_£ü‘
,

87 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ_£ü‘
) {

88 cÚ¡ 
EVP_MD
 *
	gdige¡
 = 
nuÎ±r
;

89 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gsh¬ed_£ü‘
;

93 
	gch”su™e
) {

94 
	gCURVE25519_SHA256
:

96 ià(
³”_dh_public_key
.
size
(è!ğ
X25519_PUBLIC_VALUE_LEN
) {

97  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

98 
ab¦
::
SŒC©
("Public…arameter has incorrect size: ",

99 
³”_dh_public_key
.
size
()));

101 ià(
	g£lf_dh_´iv©e_key
.
size
(è!ğ
X25519_PRIVATE_KEY_LEN
) {

102  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

103 
ab¦
::
SŒC©
("Private…arameter has incorrect size: ",

104 
£lf_dh_´iv©e_key
.
size
()));

108 
	gsh¬ed_£ü‘
.
»size
(
X25519_SHARED_KEY_LEN
);

109 ià(!
X25519
(
sh¬ed_£ü‘
.
d©a
(), 
£lf_dh_´iv©e_key
.data(),

110 
³”_dh_public_key
.
d©a
())) {

111 
LOG
(
ERROR
è<< "X25519 faed: " << 
Bs¦La¡E¼ÜSŒšg
();

112  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

116 
	gdige¡
 = 
EVP_sha256
();

119  
Stus
(

120 
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

121 "Ch”su™nÙ suµÜ‹d: " + 
HªdshakeCh”_Name
(
ch”su™e
));

125 
	g¡d
::
¡ršg
 
§É
(
kEk•HkdfS®t
);

126 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_key
;

127 
	gouut_key
.
»size
(
kEk•Seü‘Size
);

128 ià(!
HKDF
(
ouut_key
.
d©a
(), 
kEk•Seü‘Size
, 
dige¡
, 
sh¬ed_£ü‘
.data(),

129 
sh¬ed_£ü‘
.
size
(),

130 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
§É
.
d©a
()), s®t.
size
(),

131 
Œªsüt_hash
.
d©a
(),¿nsüt_hash.
size
())) {

132 
LOG
(
ERROR
è<< "HKDF faed: " << 
Bs¦La¡E¼ÜSŒšg
();

133  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

137 
	g¡d
::
cİy
(
ouut_key
.
cbegš
(), ouut_key.cbegš(è+ 
kEk•Ma¡”Seü‘Size
,

138 
¡d
::
back_š£¹”
(*
ma¡”_£ü‘
));

141 
	g¡d
::
cİy
(
ouut_key
.
cbegš
(è+ 
kEk•Ma¡”Seü‘Size
, ouut_key.
ûnd
(),

142 
¡d
::
back_š£¹”
(*
auth’tiÿtÜ_£ü‘
));

144  
	gStus
::
OkStus
();

147 
Stus
 
D”iveRecÜdPrÙocŞKey
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
,

148 cÚ¡ 
RecÜdPrÙocŞ
 &
»cÜd_´ÙocŞ
,

149 
By‹CÚš”V›w
 
Œªsüt_hash
,

150 
By‹CÚš”V›w
 
ma¡”_£ü‘
,

151 
CËªsšgVeùÜ
<
ušt8_t
> *
»cÜd_´ÙocŞ_key
) {

152 
	g»cÜd_´ÙocŞ_key
->
ş—r
();

153 cÚ¡ 
EVP_MD
 *
	gdige¡
 = 
nuÎ±r
;

154 
	gch”su™e
) {

155 
	gCURVE25519_SHA256
:

156 
dige¡
 = 
EVP_sha256
();

159  
Stus
(

160 
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

161 "Ch”su™nÙ suµÜ‹d: " + 
HªdshakeCh”_Name
(
ch”su™e
));

166 
	g»cÜd_´ÙocŞ
) {

167 
	gSEAL_AES128_GCM
:

168 
»cÜd_´ÙocŞ_key
->
»size
(
kS—lAes128GcmKeySize
);

176 
RAND_by‹s
(
»cÜd_´ÙocŞ_key
->
d©a
(),„ecÜd_´ÙocŞ_key->
size
());

179  
Stus
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
,

181 
RecÜdPrÙocŞ_Name
(
»cÜd_´ÙocŞ
));

184 
	g¡d
::
¡ršg
 
§É
(
kEk•HkdfS®tRecÜdPrÙocŞ
);

185 ià(!
HKDF
(
»cÜd_´ÙocŞ_key
->
d©a
(),„ecÜd_´ÙocŞ_key->
size
(), 
dige¡
,

186 
ma¡”_£ü‘
.
d©a
(), ma¡”_£ü‘.
size
(),

187 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
§É
.
d©a
()), s®t.
size
(),

188 
Œªsüt_hash
.
d©a
(),¿nsüt_hash.
size
())) {

189 
LOG
(
ERROR
è<< "HKDF faed: " << 
Bs¦La¡E¼ÜSŒšg
();

190  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

192  
	gStus
::
OkStus
();

195 
Stus
 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

196 cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
auth’tiÿtÜ_£ü‘
,

197 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ
) {

198 
	g¡d
::
¡ršg
 
šput
(
kCl›ÁAuth’tiÿ‹dText
);

199  
Hmac
(
ch”su™e
, 
auth’tiÿtÜ_£ü‘
, 
šput
, 
auth’tiÿtÜ
);

202 
Stus
 
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

203 cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
auth’tiÿtÜ_£ü‘
,

204 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ
) {

205 
	g¡d
::
¡ršg
 
šput
(
kS”v”Auth’tiÿ‹dText
);

206  
Hmac
(
ch”su™e
, 
auth’tiÿtÜ_£ü‘
, 
šput
, 
auth’tiÿtÜ
);

209 
boŞ
 
CheckMacEqu®™y
(
CËªsšgVeùÜ
<
ušt8_t
> 
mac1
,

210 
CËªsšgVeùÜ
<
ušt8_t
> 
mac2
) {

211 ià(
	gmac1
.
size
(è!ğ
mac2
.size()) {

212  
çl£
;

214  
CRYPTO_memcmp
(
mac1
.
d©a
(), 
mac2
.d©a(), mac1.
size
()) == 0;

	@grpc/auth/core/ekep_crypto.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_EKEP_CRYPTO_H_


20 
	#ASYLO_GRPC_AUTH_CORE_EKEP_CRYPTO_H_


	)

22 
	~<c¡dšt
>

23 
	~<memÜy
>

24 
	~<veùÜ
>

26 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

27 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

28 
	~"asylo/ut/ş—nsšg_ty³s.h
"

29 
	~"asylo/ut/¡©us.h
"

31 
Çme¥aû
 
	gasylo
 {

33 
cÚ¡ex´
 
size_t
 
	gkEk•Ma¡”Seü‘Size
 = 64;

34 
cÚ¡ex´
 
size_t
 
	gkEk•Auth’tiÿtÜSeü‘Size
 = 64;

35 
cÚ¡ex´
 
size_t
 
	gkS—lAes128GcmKeySize
 = 16;

51 
Stus
 
D”iveSeü‘s
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
,

52 
By‹CÚš”V›w
 
Œªsüt_hash
,

53 
By‹CÚš”V›w
 
³”_dh_public_key
,

54 
By‹CÚš”V›w
 
£lf_dh_´iv©e_key
,

55 
CËªsšgVeùÜ
<
ušt8_t
> *
ma¡”_£ü‘
,

56 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ_£ü‘
);

70 
Stus
 
D”iveRecÜdPrÙocŞKey
(cÚ¡ 
HªdshakeCh”
 &
ch”su™e
,

71 cÚ¡ 
RecÜdPrÙocŞ
 &
»cÜd_´ÙocŞ
,

72 
By‹CÚš”V›w
 
Œªsüt_hash
,

73 
By‹CÚš”V›w
 
ma¡”_£ü‘
,

74 
CËªsšgVeùÜ
<
ušt8_t
> *
»cÜd_´ÙocŞ_key
);

87 
Stus
 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

88 cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
auth’tiÿtÜ_£ü‘
,

89 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ
);

91 
Stus
 
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

92 cÚ¡ 
HªdshakeCh”
 &
ch”su™e
, 
By‹CÚš”V›w
 
auth’tiÿtÜ_£ü‘
,

93 
CËªsšgVeùÜ
<
ušt8_t
> *
auth’tiÿtÜ
);

96 
boŞ
 
CheckMacEqu®™y
(
CËªsšgVeùÜ
<
ušt8_t
> 
mac1
,

97 
CËªsšgVeùÜ
<
ušt8_t
> 
mac2
);

	@grpc/auth/core/ekep_crypto_test.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/sha.h
>

24 
	~<memÜy
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

33 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

34 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

36 
Çme¥aû
 
	gasylo
 {

37 
	gÇme¥aû
 {

39 
	gusšg
 ::
‹¡šg
::
NÙ
;

46 
cÚ¡ex´
 
	gkTe¡PrivKey
[] =

49 
cÚ¡ex´
 
	gkTe¡PubKey
[] =

52 
cÚ¡ex´
 
	gkTe¡T¿nsütHash
[] =

55 
cÚ¡ex´
 
	gkTe¡Ma¡”Seü‘
[] =

59 
cÚ¡ex´
 
	gkTe¡Auth’tiÿtÜSeü‘
[] =

68 
cÚ¡ex´
 
	gkTe¡RecÜdPrÙocŞKey
[] = "c7e0f5436c0fe4efdb6327469651b9fe";

75 
cÚ¡ex´
 
	gkTe¡S”v”HªdshakeAuth’tiÿtÜ
[] =

83 
cÚ¡ex´
 
	gkTe¡Cl›ÁHªdshakeAuth’tiÿtÜ
[] =

88 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sBadCh”su™e
) {

89 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

90 
	g¡d
::
veùÜ
<
ušt8_t
> 
³”_dh_public_key
;

91 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£lf_dh_´iv©e_key
;

92 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

93 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

95 
Stus
 
	g¡©us
 = 
D”iveSeü‘s
(
UNKNOWN_HANDSHAKE_CIPHER
, 
Œªsüt_hash
,

96 
³”_dh_public_key
, 
£lf_dh_´iv©e_key
,

97 &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
);

98 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

99 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

104 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sBadPublicP¬am‘”Size
) {

105 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

108 
	g¡d
::
veùÜ
<
ušt8_t
> 
³”_dh_public_key
;

110 
	gSaãBy‹s
<
	gX25519_PRIVATE_KEY_LEN
> 
	g£lf_dh_´iv©e_key
 =

111 
TrivŸlRªdomObjeù
<
SaãBy‹s
<
X25519_PRIVATE_KEY_LEN
>>();

113 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

114 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

116 
Stus
 
	g¡©us
 =

117 
D”iveSeü‘s
(
CURVE25519_SHA256
, 
Œªsüt_hash
, 
³”_dh_public_key
,

118 
£lf_dh_´iv©e_key
, &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
);

119 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

120 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
));

125 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sBadPriv©eP¬am‘”Size
) {

126 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

129 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£lf_dh_´iv©e_key
;

131 
	gSaãBy‹s
<
	gX25519_PUBLIC_VALUE_LEN
> 
	g³”_dh_public_key
 =

132 
TrivŸlRªdomObjeù
<
SaãBy‹s
<
X25519_PUBLIC_VALUE_LEN
>>();

134 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

135 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

137 
Stus
 
	g¡©us
 =

138 
D”iveSeü‘s
(
CURVE25519_SHA256
, 
Œªsüt_hash
, 
³”_dh_public_key
,

139 
£lf_dh_´iv©e_key
, &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
);

140 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

141 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
));

146 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sW™hCurve25519Sha256
) {

147 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gŒªsüt_hash
;

148 
ASYLO_ASSERT_OK
(

149 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡T¿nsütHash
, &
Œªsüt_hash
));

151 
	gUn§ãBy‹s
<
	gX25519_PUBLIC_VALUE_LEN
> 
	g³”_dh_public_key
;

152 
ASYLO_ASSERT_OK
(

153 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡PubKey
, &
³”_dh_public_key
));

155 
	gSaãBy‹s
<
	gX25519_PRIVATE_KEY_LEN
> 
	g£lf_dh_´iv©e_key
;

156 
ASYLO_ASSERT_OK
(

157 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡PrivKey
, &
£lf_dh_´iv©e_key
));

159 
	gSaãBy‹s
<
	gkEk•Ma¡”Seü‘Size
> 
	gex³ùed_ma¡”_£ü‘
;

160 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Ma¡”Seü‘
,

161 &
ex³ùed_ma¡”_£ü‘
));

163 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gex³ùed_auth’tiÿtÜ_£ü‘
;

164 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(

165 
kTe¡Auth’tiÿtÜSeü‘
, &
ex³ùed_auth’tiÿtÜ_£ü‘
));

167 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

168 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

170 
ASSERT_TRUE
(
D”iveSeü‘s
(
CURVE25519_SHA256
, 
Œªsüt_hash
,

171 
³”_dh_public_key
, 
£lf_dh_´iv©e_key
,

172 &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
)

173 .
ok
());

176 
	gSaãBy‹s
<
	gkEk•Ma¡”Seü‘Size
> *
	gaùu®_ma¡”_£ü‘
 =

177 
SaãBy‹s
<
kEk•Ma¡”Seü‘Size
>::
PÏû
(&
ma¡”_£ü‘
,

179 
EXPECT_EQ
(*
aùu®_ma¡”_£ü‘
, 
ex³ùed_ma¡”_£ü‘
);

182 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> *
	gaùu®_auth’tiÿtÜ_£ü‘
 =

183 
SaãBy‹s
<
kEk•Auth’tiÿtÜSeü‘Size
>::
PÏû
(&
auth’tiÿtÜ_£ü‘
,

185 
EXPECT_EQ
(*
aùu®_auth’tiÿtÜ_£ü‘
, 
ex³ùed_auth’tiÿtÜ_£ü‘
);

190 
TEST
(
Ek•Cry±oTe¡
, 
D”iveRecÜdPrÙocŞKeyBadCh”su™e
) {

191 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

192 
	g¡d
::
veùÜ
<
ušt8_t
> 
ma¡”_£ü‘
;

193 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

195 
Stus
 
	g¡©us
 =

196 
D”iveRecÜdPrÙocŞKey
(
UNKNOWN_HANDSHAKE_CIPHER
, 
SEAL_AES128_GCM
,

197 
Œªsüt_hash
, 
ma¡”_£ü‘
, &
key
);

198 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

199 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

204 
TEST
(
Ek•Cry±oTe¡
, 
D”iveRecÜdPrÙocŞKeyBadRecÜdPrÙocŞ
) {

205 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

206 
	g¡d
::
veùÜ
<
ušt8_t
> 
ma¡”_£ü‘
;

207 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

209 
Stus
 
	g¡©us
 =

210 
D”iveRecÜdPrÙocŞKey
(
CURVE25519_SHA256
, 
UNKNOWN_RECORD_PROTOCOL
,

211 
Œªsüt_hash
, 
ma¡”_£ü‘
, &
key
);

212 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

213 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
));

218 
TEST
(
Ek•Cry±oTe¡
, 
D”iveRecÜdPrÙocŞKeyS—lAes128Gcm
) {

219 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gŒªsüt_hash
;

220 
ASYLO_ASSERT_OK
(

221 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡T¿nsütHash
, &
Œªsüt_hash
));

223 
	gSaãBy‹s
<
	gkEk•Ma¡”Seü‘Size
> 
	gma¡”_£ü‘
;

224 
ASYLO_ASSERT_OK
(

225 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Ma¡”Seü‘
, &
ma¡”_£ü‘
));

227 
	gSaãBy‹s
<
	gkS—lAes128GcmKeySize
> 
	gex³ùed_key
;

228 
ASYLO_ASSERT_OK
(

229 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡RecÜdPrÙocŞKey
, &
ex³ùed_key
));

231 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

233 
ASSERT_TRUE
(
D”iveRecÜdPrÙocŞKey
(
CURVE25519_SHA256
, 
SEAL_AES128_GCM
,

234 
Œªsüt_hash
, 
ma¡”_£ü‘
, &
key
)

235 .
ok
());

238 
	gSaãBy‹s
<
	gkS—lAes128GcmKeySize
> *
	gaùu®_key
 =

239 
SaãBy‹s
<
kS—lAes128GcmKeySize
>::
PÏû
(&
key
, 0);

240 
EXPECT_EQ
(*
aùu®_key
, 
ex³ùed_key
);

245 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜBadCh”Su™e
) {

246 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

247 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

248 &
auth’tiÿtÜ_£ü‘
));

250 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

252 
Stus
 
	g¡©us
 = 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

253 
UNKNOWN_HANDSHAKE_CIPHER
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
);

254 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

255 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

260 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜSha256
) {

261 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

262 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

263 &
auth’tiÿtÜ_£ü‘
));

265 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gex³ùed_auth’tiÿtÜ
;

266 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(

267 
kTe¡Cl›ÁHªdshakeAuth’tiÿtÜ
, &
ex³ùed_auth’tiÿtÜ
));

269 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

271 
ASSERT_TRUE
(
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

272 
CURVE25519_SHA256
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
)

273 .
ok
());

276 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> *
	gaùu®_auth’tiÿtÜ
 =

277 
SaãBy‹s
<
SHA256_DIGEST_LENGTH
>::
PÏû
(&
auth’tiÿtÜ
,

279 
EXPECT_EQ
(*
aùu®_auth’tiÿtÜ
, 
ex³ùed_auth’tiÿtÜ
);

284 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹S”v”HªdshakeAuth’tiÿtÜBadCh”Su™e
) {

285 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

286 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

287 &
auth’tiÿtÜ_£ü‘
));

289 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

291 
Stus
 
	g¡©us
 = 
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

292 
UNKNOWN_HANDSHAKE_CIPHER
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
);

293 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

294 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

299 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹S”v”HªdshakeAuth’tiÿtÜSha256
) {

300 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

301 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

302 &
auth’tiÿtÜ_£ü‘
));

304 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gex³ùed_auth’tiÿtÜ
;

305 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(

306 
kTe¡S”v”HªdshakeAuth’tiÿtÜ
, &
ex³ùed_auth’tiÿtÜ
));

308 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

310 
ASSERT_TRUE
(
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

311 
CURVE25519_SHA256
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
)

312 .
ok
());

315 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> *
	gaùu®_auth’tiÿtÜ
 =

316 
SaãBy‹s
<
SHA256_DIGEST_LENGTH
>::
PÏû
(&
auth’tiÿtÜ
,

318 
EXPECT_EQ
(*
aùu®_auth’tiÿtÜ
, 
ex³ùed_auth’tiÿtÜ
);

	@grpc/auth/core/ekep_crypto_test.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/sha.h
>

24 
	~<memÜy
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

33 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

34 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

36 
Çme¥aû
 
	gasylo
 {

37 
	gÇme¥aû
 {

39 
	gusšg
 ::
‹¡šg
::
NÙ
;

46 
cÚ¡ex´
 
	gkTe¡PrivKey
[] =

49 
cÚ¡ex´
 
	gkTe¡PubKey
[] =

52 
cÚ¡ex´
 
	gkTe¡T¿nsütHash
[] =

55 
cÚ¡ex´
 
	gkTe¡Ma¡”Seü‘
[] =

59 
cÚ¡ex´
 
	gkTe¡Auth’tiÿtÜSeü‘
[] =

68 
cÚ¡ex´
 
	gkTe¡RecÜdPrÙocŞKey
[] = "c7e0f5436c0fe4efdb6327469651b9fe";

75 
cÚ¡ex´
 
	gkTe¡S”v”HªdshakeAuth’tiÿtÜ
[] =

83 
cÚ¡ex´
 
	gkTe¡Cl›ÁHªdshakeAuth’tiÿtÜ
[] =

88 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sBadCh”su™e
) {

89 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

90 
	g¡d
::
veùÜ
<
ušt8_t
> 
³”_dh_public_key
;

91 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£lf_dh_´iv©e_key
;

92 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

93 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

95 
Stus
 
	g¡©us
 = 
D”iveSeü‘s
(
UNKNOWN_HANDSHAKE_CIPHER
, 
Œªsüt_hash
,

96 
³”_dh_public_key
, 
£lf_dh_´iv©e_key
,

97 &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
);

98 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

99 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

104 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sBadPublicP¬am‘”Size
) {

105 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

108 
	g¡d
::
veùÜ
<
ušt8_t
> 
³”_dh_public_key
;

110 
	gSaãBy‹s
<
	gX25519_PRIVATE_KEY_LEN
> 
	g£lf_dh_´iv©e_key
 =

111 
TrivŸlRªdomObjeù
<
SaãBy‹s
<
X25519_PRIVATE_KEY_LEN
>>();

113 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

114 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

116 
Stus
 
	g¡©us
 =

117 
D”iveSeü‘s
(
CURVE25519_SHA256
, 
Œªsüt_hash
, 
³”_dh_public_key
,

118 
£lf_dh_´iv©e_key
, &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
);

119 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

120 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
));

125 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sBadPriv©eP¬am‘”Size
) {

126 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

129 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£lf_dh_´iv©e_key
;

131 
	gSaãBy‹s
<
	gX25519_PUBLIC_VALUE_LEN
> 
	g³”_dh_public_key
 =

132 
TrivŸlRªdomObjeù
<
SaãBy‹s
<
X25519_PUBLIC_VALUE_LEN
>>();

134 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

135 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

137 
Stus
 
	g¡©us
 =

138 
D”iveSeü‘s
(
CURVE25519_SHA256
, 
Œªsüt_hash
, 
³”_dh_public_key
,

139 
£lf_dh_´iv©e_key
, &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
);

140 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

141 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
));

146 
TEST
(
Ek•Cry±oTe¡
, 
D”iveSeü‘sW™hCurve25519Sha256
) {

147 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gŒªsüt_hash
;

148 
ASYLO_ASSERT_OK
(

149 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡T¿nsütHash
, &
Œªsüt_hash
));

151 
	gUn§ãBy‹s
<
	gX25519_PUBLIC_VALUE_LEN
> 
	g³”_dh_public_key
;

152 
ASYLO_ASSERT_OK
(

153 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡PubKey
, &
³”_dh_public_key
));

155 
	gSaãBy‹s
<
	gX25519_PRIVATE_KEY_LEN
> 
	g£lf_dh_´iv©e_key
;

156 
ASYLO_ASSERT_OK
(

157 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡PrivKey
, &
£lf_dh_´iv©e_key
));

159 
	gSaãBy‹s
<
	gkEk•Ma¡”Seü‘Size
> 
	gex³ùed_ma¡”_£ü‘
;

160 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Ma¡”Seü‘
,

161 &
ex³ùed_ma¡”_£ü‘
));

163 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gex³ùed_auth’tiÿtÜ_£ü‘
;

164 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(

165 
kTe¡Auth’tiÿtÜSeü‘
, &
ex³ùed_auth’tiÿtÜ_£ü‘
));

167 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘
;

168 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘
;

170 
ASSERT_TRUE
(
D”iveSeü‘s
(
CURVE25519_SHA256
, 
Œªsüt_hash
,

171 
³”_dh_public_key
, 
£lf_dh_´iv©e_key
,

172 &
ma¡”_£ü‘
, &
auth’tiÿtÜ_£ü‘
)

173 .
ok
());

176 
	gSaãBy‹s
<
	gkEk•Ma¡”Seü‘Size
> *
	gaùu®_ma¡”_£ü‘
 =

177 
SaãBy‹s
<
kEk•Ma¡”Seü‘Size
>::
PÏû
(&
ma¡”_£ü‘
,

179 
EXPECT_EQ
(*
aùu®_ma¡”_£ü‘
, 
ex³ùed_ma¡”_£ü‘
);

182 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> *
	gaùu®_auth’tiÿtÜ_£ü‘
 =

183 
SaãBy‹s
<
kEk•Auth’tiÿtÜSeü‘Size
>::
PÏû
(&
auth’tiÿtÜ_£ü‘
,

185 
EXPECT_EQ
(*
aùu®_auth’tiÿtÜ_£ü‘
, 
ex³ùed_auth’tiÿtÜ_£ü‘
);

190 
TEST
(
Ek•Cry±oTe¡
, 
D”iveRecÜdPrÙocŞKeyBadCh”su™e
) {

191 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

192 
	g¡d
::
veùÜ
<
ušt8_t
> 
ma¡”_£ü‘
;

193 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

195 
Stus
 
	g¡©us
 =

196 
D”iveRecÜdPrÙocŞKey
(
UNKNOWN_HANDSHAKE_CIPHER
, 
SEAL_AES128_GCM
,

197 
Œªsüt_hash
, 
ma¡”_£ü‘
, &
key
);

198 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

199 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

204 
TEST
(
Ek•Cry±oTe¡
, 
D”iveRecÜdPrÙocŞKeyBadRecÜdPrÙocŞ
) {

205 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

206 
	g¡d
::
veùÜ
<
ušt8_t
> 
ma¡”_£ü‘
;

207 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

209 
Stus
 
	g¡©us
 =

210 
D”iveRecÜdPrÙocŞKey
(
CURVE25519_SHA256
, 
UNKNOWN_RECORD_PROTOCOL
,

211 
Œªsüt_hash
, 
ma¡”_£ü‘
, &
key
);

212 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

213 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
));

218 
TEST
(
Ek•Cry±oTe¡
, 
D”iveRecÜdPrÙocŞKeyS—lAes128Gcm
) {

219 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gŒªsüt_hash
;

220 
ASYLO_ASSERT_OK
(

221 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡T¿nsütHash
, &
Œªsüt_hash
));

223 
	gSaãBy‹s
<
	gkEk•Ma¡”Seü‘Size
> 
	gma¡”_£ü‘
;

224 
ASYLO_ASSERT_OK
(

225 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Ma¡”Seü‘
, &
ma¡”_£ü‘
));

227 
	gSaãBy‹s
<
	gkS—lAes128GcmKeySize
> 
	gex³ùed_key
;

228 
ASYLO_ASSERT_OK
(

229 
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡RecÜdPrÙocŞKey
, &
ex³ùed_key
));

231 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

233 
ASSERT_TRUE
(
D”iveRecÜdPrÙocŞKey
(
CURVE25519_SHA256
, 
SEAL_AES128_GCM
,

234 
Œªsüt_hash
, 
ma¡”_£ü‘
, &
key
)

235 .
ok
());

238 
	gSaãBy‹s
<
	gkS—lAes128GcmKeySize
> *
	gaùu®_key
 =

239 
SaãBy‹s
<
kS—lAes128GcmKeySize
>::
PÏû
(&
key
, 0);

240 
EXPECT_EQ
(*
aùu®_key
, 
ex³ùed_key
);

245 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜBadCh”Su™e
) {

246 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

247 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

248 &
auth’tiÿtÜ_£ü‘
));

250 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

252 
Stus
 
	g¡©us
 = 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

253 
UNKNOWN_HANDSHAKE_CIPHER
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
);

254 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

255 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

260 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜSha256
) {

261 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

262 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

263 &
auth’tiÿtÜ_£ü‘
));

265 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gex³ùed_auth’tiÿtÜ
;

266 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(

267 
kTe¡Cl›ÁHªdshakeAuth’tiÿtÜ
, &
ex³ùed_auth’tiÿtÜ
));

269 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

271 
ASSERT_TRUE
(
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

272 
CURVE25519_SHA256
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
)

273 .
ok
());

276 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> *
	gaùu®_auth’tiÿtÜ
 =

277 
SaãBy‹s
<
SHA256_DIGEST_LENGTH
>::
PÏû
(&
auth’tiÿtÜ
,

279 
EXPECT_EQ
(*
aùu®_auth’tiÿtÜ
, 
ex³ùed_auth’tiÿtÜ
);

284 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹S”v”HªdshakeAuth’tiÿtÜBadCh”Su™e
) {

285 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

286 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

287 &
auth’tiÿtÜ_£ü‘
));

289 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

291 
Stus
 
	g¡©us
 = 
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

292 
UNKNOWN_HANDSHAKE_CIPHER
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
);

293 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

294 
EXPECT_THAT
(
¡©us
, 
StusIs
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
));

299 
TEST
(
Ek•Cry±oTe¡
, 
Compu‹S”v”HªdshakeAuth’tiÿtÜSha256
) {

300 
	gSaãBy‹s
<
	gkEk•Auth’tiÿtÜSeü‘Size
> 
	gauth’tiÿtÜ_£ü‘
;

301 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kTe¡Auth’tiÿtÜSeü‘
,

302 &
auth’tiÿtÜ_£ü‘
));

304 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gex³ùed_auth’tiÿtÜ
;

305 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(

306 
kTe¡S”v”HªdshakeAuth’tiÿtÜ
, &
ex³ùed_auth’tiÿtÜ
));

308 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

310 
ASSERT_TRUE
(
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

311 
CURVE25519_SHA256
, 
auth’tiÿtÜ_£ü‘
, &
auth’tiÿtÜ
)

312 .
ok
());

315 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> *
	gaùu®_auth’tiÿtÜ
 =

316 
SaãBy‹s
<
SHA256_DIGEST_LENGTH
>::
PÏû
(&
auth’tiÿtÜ
,

318 
EXPECT_EQ
(*
aùu®_auth’tiÿtÜ
, 
ex³ùed_auth’tiÿtÜ
);

	@grpc/auth/core/ekep_error_space.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
AbÜt_E¼ÜCode
> 
g
) {

25  
	gEk•E¼ÜS·û
::
G‘In¡ªû
();

30 cÚ¡ 
	gasylo
::
”rÜ
::
E¼ÜS·û
 *
Ek•E¼ÜS·û
::
G‘In¡ªû
() {

31 cÚ¡ 
asylo
::
”rÜ
::
E¼ÜS·û
 *
š¡ªû
 = 
Ãw
 
Ek•E¼ÜS·û
();

32  
	gš¡ªû
;

35 
	gEk•E¼ÜS·û
::
Ek•E¼ÜS·û
()

36 : 
asylo
::
”rÜ
::
E¼ÜS·ûIm¶em’tiÚH–³r
<
Ek•E¼ÜS·û
>(

41 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

43 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

44 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_DESERIALIZATION_FAILED
,

46 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

47 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_PROTOCOL_VERSION
,

49 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

50 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

52 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

53 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
,

55 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

56 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_AUTHENTICATOR
, "Bad‡uthenticator",

57 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

58 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_ASSERTION_TYPE
,

60 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

61 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_ASSERTION
, "Bad‡ssertion",

62 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

63 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
, "Protocolƒrror",

64 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

65 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror",

66 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

	@grpc/auth/core/ekep_error_space.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
AbÜt_E¼ÜCode
> 
g
) {

25  
	gEk•E¼ÜS·û
::
G‘In¡ªû
();

30 cÚ¡ 
	gasylo
::
”rÜ
::
E¼ÜS·û
 *
Ek•E¼ÜS·û
::
G‘In¡ªû
() {

31 cÚ¡ 
asylo
::
”rÜ
::
E¼ÜS·û
 *
š¡ªû
 = 
Ãw
 
Ek•E¼ÜS·û
();

32  
	gš¡ªû
;

35 
	gEk•E¼ÜS·û
::
Ek•E¼ÜS·û
()

36 : 
asylo
::
”rÜ
::
E¼ÜS·ûIm¶em’tiÚH–³r
<
Ek•E¼ÜS·û
>(

41 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

43 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

44 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_DESERIALIZATION_FAILED
,

46 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

47 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_PROTOCOL_VERSION
,

49 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

50 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

52 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

53 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
,

55 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

56 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_AUTHENTICATOR
, "Bad‡uthenticator",

57 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

58 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_ASSERTION_TYPE
,

60 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

61 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_BAD_ASSERTION
, "Bad‡ssertion",

62 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

63 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
, "Protocolƒrror",

64 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

65 
AddT¿n¦©iÚM­EÁry
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror",

66 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
);

	@grpc/auth/core/ekep_error_space.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_EKEP_ERROR_SPACE_H_


20 
	#ASYLO_GRPC_AUTH_CORE_EKEP_ERROR_SPACE_H_


	)

22 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	g”rÜ
 {

30 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
AbÜt_E¼ÜCode
> 
g
);

36 
şass
 
	gEk•E¼ÜS·û


37 : 
public
 
asylo
::
”rÜ
::
E¼ÜS·ûIm¶em’tiÚH–³r
<
Ek•E¼ÜS·û
> {

38 
public
:

39 
usšg
 
code_ty³
 = 
AbÜt_E¼ÜCode
;

41 
Ek•E¼ÜS·û
(cÚ¡ Ek•E¼ÜS·û &
Ùh”
èğ
d–‘e
;

42 
	gEk•E¼ÜS·û
 &
	gİ”©Ü
=(cÚ¡ 
Ek•E¼ÜS·û
 &
Ùh”
èğ
d–‘e
;

43 
	gvœtu®
 ~
Ek•E¼ÜS·û
() = ;

46 cÚ¡ 
E¼ÜS·û
 *
G‘In¡ªû
();

48 
	g´iv©e
:

49 
Ek•E¼ÜS·û
();

	@grpc/auth/core/ekep_handshaker.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

21 
	~<c¡dšt
>

22 
	~<memÜy
>

24 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

25 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶.h
>

26 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

27 
	~"ab¦/memÜy/memÜy.h
"

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/üy±o/hash_š‹rçû.h
"

30 
	~"asylo/üy±o/ut/bs¦_ut.h
"

31 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

32 
	~"asylo/ut/loggšg.h
"

33 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

34 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

35 
	~"asylo/ut/¡©us.h
"

36 
	~"asylo/ut/¡©us_maüos.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

42 
	g¡d
::
unique_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
C»©eHªdshakeMes§ge
(

43 
HªdshakeMes§geTy³
 
mes§ge_ty³
) {

44 
mes§ge_ty³
) {

45 
CLIENT_PRECOMMIT
:

46  
ab¦
::
make_unique
<
Cl›ÁP»comm™
>();

47 
	gSERVER_PRECOMMIT
:

48  
ab¦
::
make_unique
<
S”v”P»comm™
>();

49 
	gCLIENT_ID
:

50  
ab¦
::
make_unique
<
Cl›ÁId
>();

51 
	gSERVER_ID
:

52  
ab¦
::
make_unique
<
S”v”Id
>();

53 
	gCLIENT_FINISH
:

54  
ab¦
::
make_unique
<
Cl›ÁFšish
>();

55 
	gSERVER_FINISH
:

56  
ab¦
::
make_unique
<
S”v”Fšish
>();

57 
	gABORT
:

58  
ab¦
::
make_unique
<
AbÜt
>();

60  
nuÎ±r
;

66 
	gEk•Hªdshak”
::
ResuÉ
 
Ek•Hªdshak”
::
NextHªdshakeS‹p
(

67 cÚ¡ *
šcomšg_by‹s
, 
size_t
 
šcomšg_by‹s_size
,

68 
¡d
::
¡ršg
 *
outgošg_by‹s
) {

69 
VLOG
(2è<< "Reûived " << 
šcomšg_by‹s_size
 << " bytes from…eer";

71 ià(
IsHªdshakeCom¶‘ed
()) {

72 
LOG
(
DFATAL
) << "NextHandshakeStep() was called on‡ handshakerhat was "

74  
	gResuÉ
::
COMPLETED
;

76 ià(
IsHªdshakeAbÜ‹d
()) {

77 
LOG
(
DFATAL
) << "NextHandshakeStep() was called on‡ handshakerhat was "

79  
	gResuÉ
::
ABORTED
;

82 
	goutgošg_by‹s
->
ş—r
();

84 
ResuÉ
 
	g»suÉ
;

85 ià(!
IsHªdshakeInProg»ss
()) {

86 ià(
	gšcomšg_by‹s_size
 != 0) {

88 
AbÜtHªdshake
(

89 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

91 
outgošg_by‹s
);

92  
	gResuÉ
::
ABORTED
;

95 
	g»suÉ
 = 
S¹Hªdshake
(
outgošg_by‹s
);

98 
	gšput_¡»am_
.
AddBufãr
(
šcomšg_by‹s
, 
šcomšg_by‹s_size
);

101 
	g»suÉ
 = 
DecodeAndHªdËF¿me
(
outgošg_by‹s
);

102 ià(
	g»suÉ
 !ğ
ResuÉ
::
IN_PROGRESS
) {

103  
»suÉ
;

108 } 
	gšput_¡»am_
.
RemaššgBy‹CouÁ
() != 0 &&

109 
outgošg_by‹s
->
em±y
());

112 ià(!
	goutgošg_by‹s
->
em±y
(è&& 
	gšput_¡»am_
.
RemaššgBy‹CouÁ
() != 0) {

116 
outgošg_by‹s
->
ş—r
();

117 
AbÜtHªdshake
(

118 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
, "Received unexpected bytes"),

119 
outgošg_by‹s
);

120  
	gResuÉ
::
ABORTED
;

123  
	g»suÉ
;

126 
Stus
 
	gEk•Hªdshak”
::
EncodeF¿me
(

127 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

128 
googË
::
´Ùobuf
::
io
::
Z”oCİyOuutSŒ—m
 *
ouut
) const {

129 
googË
::
´Ùobuf
::
io
::
CodedOuutSŒ—m
 
’coded_äame
(
ouut
);

131 
size_t
 
	gmes§ge_size
 = 
hªdshake_mes§ge
.
By‹SizeLÚg
();

132 ià(
	gmes§ge_size
 > 
	gmax_äame_size_
 ||

133 (
	gmes§ge_ty³
è+ 
	gmes§ge_size
 > 
	gmax_äame_size_
) {

134  
Stus
(

135 
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

136 
ab¦
::
SŒC©
(

138 
max_äame_size_
));

141 ià(
	gmes§ge_ty³
 =ğ
HªdshakeMes§geTy³
::
UNKNOWN_HANDSHAKE_MESSAGE
) {

142  
Stus
(

143 
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

148 
ušt32_t
 
	gäame_size
 = (
mes§ge_ty³
è+ 
mes§ge_size
;

149 
	g’coded_äame
.
Wr™eL™eEndŸn32
(
äame_size
);

152 
	g’coded_äame
.
Wr™eL™eEndŸn32
(
mes§ge_ty³
);

155 
	ghªdshake_mes§ge
.
S”ŸlizeW™hCachedSizes
(&
’coded_äame
);

157  
	gStus
::
OkStus
();

160 
Stus
 
	gEk•Hªdshak”
::
P¬£F¿meH—d”
(

161 
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
, 
ušt32_t
 *
mes§ge_size
,

162 
HªdshakeMes§geTy³
 *
mes§ge_ty³
) const {

163 
	ggoogË
::
´Ùobuf
::
io
::
CodedIÅutSŒ—m
 
’coded_äame
(
šput
);

166 
ušt32_t
 
	gäame_size
;

167 ià(!
	g’coded_äame
.
R—dL™eEndŸn32
(&
äame_size
)) {

168  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
, "Failedo„ead frame size");

170 ià(
	gäame_size
 < (*
	gmes§ge_ty³
è|| f¿me_siz> 
	gmax_äame_size_
) {

171  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

172 
ab¦
::
SŒC©
("Inv®id f¿msize: ", 
äame_size
));

176 
ušt32_t
 
	gmes§ge_ty³_’coded
;

177 ià(!
	g’coded_äame
.
R—dL™eEndŸn32
(&
mes§ge_ty³_’coded
)) {

178  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

181 ià(!
HªdshakeMes§geTy³_IsV®id
(
mes§ge_ty³_’coded
)) {

182  
Stus
(

183 
AbÜt_E¼ÜCode_BAD_MESSAGE
,

184 
ab¦
::
SŒC©
("Inv®id f¿mmes§gty³: ", 
mes§ge_ty³_’coded
));

186 ià(
	gmes§ge_ty³_’coded
 =ğ
HªdshakeMes§geTy³
::
UNKNOWN_HANDSHAKE_MESSAGE
) {

187  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

191 *
	gmes§ge_ty³
 = 
¡©ic_ÿ¡
<
HªdshakeMes§geTy³
>(
mes§ge_ty³_’coded
);

192 *
	gmes§ge_size
 = 
äame_size
 - (*
mes§ge_ty³
);

193  
	gStus
::
OkStus
();

196 
Stus
 
	gEk•Hªdshak”
::
P¬£F¿meMes§ge
(
ušt32_t
 
mes§ge_size
,

197 
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
,

198 
googË
::
´Ùobuf
::
Mes§ge
 *
mes§ge
) const {

199 ià(!
mes§ge
->
P¬£FromBoundedZ”oCİySŒ—m
(
šput
, 
mes§ge_size
)) {

200  
Stus
(
AbÜt_E¼ÜCode_DESERIALIZATION_FAILED
,

203  
	gStus
::
OkStus
();

206 
	gStusOr
<
	g¡d
::
¡ršg
> 
Ek•Hªdshak”
::
G‘Unu£dBy‹s
() {

207 ià(!
IsHªdshakeCom¶‘ed
()) {

208  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

212  
	gšput_¡»am_
.
RemaššgBy‹s
();

215 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveId’t™›s
>>

216 
Ek•Hªdshak”
::
G‘P“rId’t™›s
() {

217 ià(!
IsHªdshakeCom¶‘ed
()) {

218  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

223  
	g¡d
::
move
(
³”_id’t™›s_
);

226 
	gStusOr
<
	gRecÜdPrÙocŞ
> 
	gEk•Hªdshak”
::
G‘RecÜdPrÙocŞ
() {

227 ià(!
IsHªdshakeCom¶‘ed
()) {

228  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

233  
	g»cÜd_´ÙocŞ_
;

236 
	gStusOr
<
	gCËªsšgVeùÜ
<
	gušt8_t
>> 
	gEk•Hªdshak”
::
G‘RecÜdPrÙocŞKey
() {

237 ià(!
IsHªdshakeCom¶‘ed
()) {

238  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

243  
	g»cÜd_´ÙocŞ_key_
;

246 
	gEk•Hªdshak”
::
Ek•Hªdshak”
(
max_äame_size
)

247 : 
max_äame_size_
(
max_äame_size
) {

248 
³”_id’t™›s_
 = 
ab¦
::
make_unique
<
EnşaveId’t™›s
>();

251 
	gEk•Hªdshak”
::
ResuÉ
 
Ek•Hªdshak”
::
DecodeAndHªdËF¿me
(

252 
¡d
::
¡ršg
 *
ouut
) {

254 ià(
šput_¡»am_
.
RemaššgBy‹CouÁ
(è< 
kEk•F¿meH—d”Size
) {

255  
ResuÉ
::
NOT_ENOUGH_DATA
;

260 
ušt32_t
 
	gmes§ge_size
;

261 
HªdshakeMes§geTy³
 
	gmes§ge_ty³
;

262 
Stus
 
	g¡©us
 =

263 
P¬£F¿meH—d”
(&
šput_¡»am_
, &
mes§ge_size
, &
mes§ge_ty³
);

264 ià(!
	g¡©us
.
ok
()) {

265 
AbÜtHªdshake
(
¡©us
, 
ouut
);

266  
	gResuÉ
::
ABORTED
;

269 
VLOG
(2è<< "Reûived " << 
HªdshakeMes§geTy³_Name
(
mes§ge_ty³
)

272 ià((
	gmes§ge_ty³
 !ğ
G‘Ex³ùedMes§geTy³
()è&& (
mes§ge_ty³
 !ğ
ABORT
)) {

274 
AbÜtHªdshake
(
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
, "Unexpected message"),

275 
ouut
);

276  
	gResuÉ
::
ABORTED
;

279 ià(
	gšput_¡»am_
.
RemaššgBy‹CouÁ
(è< 
	gmes§ge_size
) {

282 
	gšput_¡»am_
.
Rewšd
();

283  
	gResuÉ
::
NOT_ENOUGH_DATA
;

285 
	g¡d
::
unique_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
mes§ge
 =

286 
C»©eHªdshakeMes§ge
(
mes§ge_ty³
);

290 
	g¡©us
 = 
P¬£F¿meMes§ge
(
mes§ge_size
, &
šput_¡»am_
, 
mes§ge
.
g‘
());

291 ià(!
	g¡©us
.
ok
()) {

292 ià(
	gmes§ge_ty³
 =ğ
ABORT
) {

295 
HªdËAbÜtMes§ge
(
nuÎ±r
);

296 
LOG
(
ERROR
è<< "FaedØde£rŸliz³”' AbÜt: " << 
	g¡©us
;

298 
AbÜtHªdshake
(
¡©us
, 
ouut
);

300  
	gResuÉ
::
ABORTED
;

303 
VLOG
(2è<< 
	gmes§ge
->
DebugSŒšg
();

305 ià(
	gmes§ge_ty³
 =ğ
ABORT
) {

306 cÚ¡ 
AbÜt
 *
abÜt_mes§ge
 = 
dyÇmic_ÿ¡
<cÚ¡ AbÜˆ*>(
mes§ge
.
g‘
());

307 
LOG_IF
(
DFATAL
, !
abÜt_mes§ge
) << "dynamic_cast from google::protobuf::Message * "

309 
HªdËAbÜtMes§ge
(
abÜt_mes§ge
);

310  
	gResuÉ
::
ABORTED
;

314 
Upd©eT¿nsütW™hIncomšgBy‹s
();

315 
	gšput_¡»am_
.
TrimFrÚt
();

317  
HªdËHªdshakeMes§ge
(
mes§ge_ty³
, *
mes§ge
, 
ouut
);

320 
Stus
 
	gEk•Hªdshak”
::
Wr™eF¿meAndUpd©eT¿nsüt
(

321 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

322 
¡d
::
¡ršg
 *
ouut
) {

323 
off£t
 = 
ouut
->
size
();

324 
	ggoogË
::
´Ùobuf
::
io
::
SŒšgOuutSŒ—m
 
outgošg_äame
(
ouut
);

325 
ASYLO_RETURN_IF_ERROR
(

326 
EncodeF¿me
(
mes§ge_ty³
, 
hªdshake_mes§ge
, &
outgošg_äame
));

330 
Upd©eT¿nsütW™hOutgošgBy‹s
(
ouut
->
d©a
(è+ 
off£t
,

331 
ouut
->
size
(è- 
off£t
);

332  
	gStus
::
OkStus
();

335 
	gEk•Hªdshak”
::
AddP“rId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
id’t™y
) {

336 *
³”_id’t™›s_
->
add_id’t™›s
(èğ
id’t™y
;

339 
	gEk•Hªdshak”
::
S‘RecÜdPrÙocŞ
(
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
) {

340 
»cÜd_´ÙocŞ_
 = 
»cÜd_´ÙocŞ
;

343 
Stus
 
	gEk•Hªdshak”
::
D”iveAndS‘RecÜdPrÙocŞKey
(

344 
HªdshakeCh”
 
ch”_su™e
, 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
,

345 
By‹CÚš”V›w
 
ma¡”_£ü‘
) {

346 
	g¡d
::
¡ršg
 
fš®_Œªsüt_hash
;

347 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
fš®_Œªsüt_hash
));

348  
D”iveRecÜdPrÙocŞKey
(
ch”_su™e
, 
»cÜd_´ÙocŞ
,

349 
fš®_Œªsüt_hash
, 
ma¡”_£ü‘
,

350 &
»cÜd_´ÙocŞ_key_
);

353 
boŞ
 
	gEk•Hªdshak”
::
S‘T¿nsütHashFunùiÚ
(
HashIÁ”çû
 *
hash
) {

354  
Œªsüt_
.
S‘Hash”
(
hash
);

357 
Stus
 
	gEk•Hªdshak”
::
G‘T¿nsütHash
(
¡d
::
¡ršg
 *
Œªsüt_hash
) {

358 
boŞ
 
»suÉ
 = 
Œªsüt_
.
Hash
(
Œªsüt_hash
);

359 ià(!
	g»suÉ
) {

360 
LOG
(
ERROR
) << "Transcript hash function is‚ot set";

361  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

364  
	gStus
::
OkStus
();

367 
	gEk•Hªdshak”
::
Upd©eT¿nsütW™hOutgošgBy‹s
(

368 cÚ¡ *
outgošg_by‹s
, 
outgošg_by‹s_size
) {

369 ià(
	goutgošg_by‹s_size
 > 0) {

370 
	ggoogË
::
´Ùobuf
::
io
::
A¼ayIÅutSŒ—m
 
£Á_by‹s
(
outgošg_by‹s
,

371 
outgošg_by‹s_size
);

372 
	gŒªsüt_
.
Add
(&
£Á_by‹s
);

376 
	gEk•Hªdshak”
::
Upd©eT¿nsütW™hIncomšgBy‹s
() {

377 
št64_t
 
by‹s_»ad
 = 
šput_¡»am_
.
By‹CouÁ
();

378 ià(
	gby‹s_»ad
 != 0) {

379 
šput_¡»am_
.
Rewšd
();

380 
	ggoogË
::
´Ùobuf
::
io
::
Lim™šgIÅutSŒ—m
 
cÚsumed_by‹s
(&
šput_¡»am_
, 
by‹s_»ad
);

381 
	gŒªsüt_
.
Add
(&
cÚsumed_by‹s
);

	@grpc/auth/core/ekep_handshaker.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

21 
	~<c¡dšt
>

22 
	~<memÜy
>

24 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

25 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶.h
>

26 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

27 
	~"ab¦/memÜy/memÜy.h
"

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/üy±o/hash_š‹rçû.h
"

30 
	~"asylo/üy±o/ut/bs¦_ut.h
"

31 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

32 
	~"asylo/ut/loggšg.h
"

33 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

34 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

35 
	~"asylo/ut/¡©us.h
"

36 
	~"asylo/ut/¡©us_maüos.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

42 
	g¡d
::
unique_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
C»©eHªdshakeMes§ge
(

43 
HªdshakeMes§geTy³
 
mes§ge_ty³
) {

44 
mes§ge_ty³
) {

45 
CLIENT_PRECOMMIT
:

46  
ab¦
::
make_unique
<
Cl›ÁP»comm™
>();

47 
	gSERVER_PRECOMMIT
:

48  
ab¦
::
make_unique
<
S”v”P»comm™
>();

49 
	gCLIENT_ID
:

50  
ab¦
::
make_unique
<
Cl›ÁId
>();

51 
	gSERVER_ID
:

52  
ab¦
::
make_unique
<
S”v”Id
>();

53 
	gCLIENT_FINISH
:

54  
ab¦
::
make_unique
<
Cl›ÁFšish
>();

55 
	gSERVER_FINISH
:

56  
ab¦
::
make_unique
<
S”v”Fšish
>();

57 
	gABORT
:

58  
ab¦
::
make_unique
<
AbÜt
>();

60  
nuÎ±r
;

66 
	gEk•Hªdshak”
::
ResuÉ
 
Ek•Hªdshak”
::
NextHªdshakeS‹p
(

67 cÚ¡ *
šcomšg_by‹s
, 
size_t
 
šcomšg_by‹s_size
,

68 
¡d
::
¡ršg
 *
outgošg_by‹s
) {

69 
VLOG
(2è<< "Reûived " << 
šcomšg_by‹s_size
 << " bytes from…eer";

71 ià(
IsHªdshakeCom¶‘ed
()) {

72 
LOG
(
DFATAL
) << "NextHandshakeStep() was called on‡ handshakerhat was "

74  
	gResuÉ
::
COMPLETED
;

76 ià(
IsHªdshakeAbÜ‹d
()) {

77 
LOG
(
DFATAL
) << "NextHandshakeStep() was called on‡ handshakerhat was "

79  
	gResuÉ
::
ABORTED
;

82 
	goutgošg_by‹s
->
ş—r
();

84 
ResuÉ
 
	g»suÉ
;

85 ià(!
IsHªdshakeInProg»ss
()) {

86 ià(
	gšcomšg_by‹s_size
 != 0) {

88 
AbÜtHªdshake
(

89 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

91 
outgošg_by‹s
);

92  
	gResuÉ
::
ABORTED
;

95 
	g»suÉ
 = 
S¹Hªdshake
(
outgošg_by‹s
);

98 
	gšput_¡»am_
.
AddBufãr
(
šcomšg_by‹s
, 
šcomšg_by‹s_size
);

101 
	g»suÉ
 = 
DecodeAndHªdËF¿me
(
outgošg_by‹s
);

102 ià(
	g»suÉ
 !ğ
ResuÉ
::
IN_PROGRESS
) {

103  
»suÉ
;

108 } 
	gšput_¡»am_
.
RemaššgBy‹CouÁ
() != 0 &&

109 
outgošg_by‹s
->
em±y
());

112 ià(!
	goutgošg_by‹s
->
em±y
(è&& 
	gšput_¡»am_
.
RemaššgBy‹CouÁ
() != 0) {

116 
outgošg_by‹s
->
ş—r
();

117 
AbÜtHªdshake
(

118 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
, "Received unexpected bytes"),

119 
outgošg_by‹s
);

120  
	gResuÉ
::
ABORTED
;

123  
	g»suÉ
;

126 
Stus
 
	gEk•Hªdshak”
::
EncodeF¿me
(

127 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

128 
googË
::
´Ùobuf
::
io
::
Z”oCİyOuutSŒ—m
 *
ouut
) const {

129 
googË
::
´Ùobuf
::
io
::
CodedOuutSŒ—m
 
’coded_äame
(
ouut
);

131 
size_t
 
	gmes§ge_size
 = 
hªdshake_mes§ge
.
By‹SizeLÚg
();

132 ià(
	gmes§ge_size
 > 
	gmax_äame_size_
 ||

133 (
	gmes§ge_ty³
è+ 
	gmes§ge_size
 > 
	gmax_äame_size_
) {

134  
Stus
(

135 
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

136 
ab¦
::
SŒC©
(

138 
max_äame_size_
));

141 ià(
	gmes§ge_ty³
 =ğ
HªdshakeMes§geTy³
::
UNKNOWN_HANDSHAKE_MESSAGE
) {

142  
Stus
(

143 
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

148 
ušt32_t
 
	gäame_size
 = (
mes§ge_ty³
è+ 
mes§ge_size
;

149 
	g’coded_äame
.
Wr™eL™eEndŸn32
(
äame_size
);

152 
	g’coded_äame
.
Wr™eL™eEndŸn32
(
mes§ge_ty³
);

155 
	ghªdshake_mes§ge
.
S”ŸlizeW™hCachedSizes
(&
’coded_äame
);

157  
	gStus
::
OkStus
();

160 
Stus
 
	gEk•Hªdshak”
::
P¬£F¿meH—d”
(

161 
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
, 
ušt32_t
 *
mes§ge_size
,

162 
HªdshakeMes§geTy³
 *
mes§ge_ty³
) const {

163 
	ggoogË
::
´Ùobuf
::
io
::
CodedIÅutSŒ—m
 
’coded_äame
(
šput
);

166 
ušt32_t
 
	gäame_size
;

167 ià(!
	g’coded_äame
.
R—dL™eEndŸn32
(&
äame_size
)) {

168  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
, "Failedo„ead frame size");

170 ià(
	gäame_size
 < (*
	gmes§ge_ty³
è|| f¿me_siz> 
	gmax_äame_size_
) {

171  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

172 
ab¦
::
SŒC©
("Inv®id f¿msize: ", 
äame_size
));

176 
ušt32_t
 
	gmes§ge_ty³_’coded
;

177 ià(!
	g’coded_äame
.
R—dL™eEndŸn32
(&
mes§ge_ty³_’coded
)) {

178  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

181 ià(!
HªdshakeMes§geTy³_IsV®id
(
mes§ge_ty³_’coded
)) {

182  
Stus
(

183 
AbÜt_E¼ÜCode_BAD_MESSAGE
,

184 
ab¦
::
SŒC©
("Inv®id f¿mmes§gty³: ", 
mes§ge_ty³_’coded
));

186 ià(
	gmes§ge_ty³_’coded
 =ğ
HªdshakeMes§geTy³
::
UNKNOWN_HANDSHAKE_MESSAGE
) {

187  
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

191 *
	gmes§ge_ty³
 = 
¡©ic_ÿ¡
<
HªdshakeMes§geTy³
>(
mes§ge_ty³_’coded
);

192 *
	gmes§ge_size
 = 
äame_size
 - (*
mes§ge_ty³
);

193  
	gStus
::
OkStus
();

196 
Stus
 
	gEk•Hªdshak”
::
P¬£F¿meMes§ge
(
ušt32_t
 
mes§ge_size
,

197 
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
,

198 
googË
::
´Ùobuf
::
Mes§ge
 *
mes§ge
) const {

199 ià(!
mes§ge
->
P¬£FromBoundedZ”oCİySŒ—m
(
šput
, 
mes§ge_size
)) {

200  
Stus
(
AbÜt_E¼ÜCode_DESERIALIZATION_FAILED
,

203  
	gStus
::
OkStus
();

206 
	gStusOr
<
	g¡d
::
¡ršg
> 
Ek•Hªdshak”
::
G‘Unu£dBy‹s
() {

207 ià(!
IsHªdshakeCom¶‘ed
()) {

208  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

212  
	gšput_¡»am_
.
RemaššgBy‹s
();

215 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveId’t™›s
>>

216 
Ek•Hªdshak”
::
G‘P“rId’t™›s
() {

217 ià(!
IsHªdshakeCom¶‘ed
()) {

218  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

223  
	g¡d
::
move
(
³”_id’t™›s_
);

226 
	gStusOr
<
	gRecÜdPrÙocŞ
> 
	gEk•Hªdshak”
::
G‘RecÜdPrÙocŞ
() {

227 ià(!
IsHªdshakeCom¶‘ed
()) {

228  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

233  
	g»cÜd_´ÙocŞ_
;

236 
	gStusOr
<
	gCËªsšgVeùÜ
<
	gušt8_t
>> 
	gEk•Hªdshak”
::
G‘RecÜdPrÙocŞKey
() {

237 ià(!
IsHªdshakeCom¶‘ed
()) {

238  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

243  
	g»cÜd_´ÙocŞ_key_
;

246 
	gEk•Hªdshak”
::
Ek•Hªdshak”
(
max_äame_size
)

247 : 
max_äame_size_
(
max_äame_size
) {

248 
³”_id’t™›s_
 = 
ab¦
::
make_unique
<
EnşaveId’t™›s
>();

251 
	gEk•Hªdshak”
::
ResuÉ
 
Ek•Hªdshak”
::
DecodeAndHªdËF¿me
(

252 
¡d
::
¡ršg
 *
ouut
) {

254 ià(
šput_¡»am_
.
RemaššgBy‹CouÁ
(è< 
kEk•F¿meH—d”Size
) {

255  
ResuÉ
::
NOT_ENOUGH_DATA
;

260 
ušt32_t
 
	gmes§ge_size
;

261 
HªdshakeMes§geTy³
 
	gmes§ge_ty³
;

262 
Stus
 
	g¡©us
 =

263 
P¬£F¿meH—d”
(&
šput_¡»am_
, &
mes§ge_size
, &
mes§ge_ty³
);

264 ià(!
	g¡©us
.
ok
()) {

265 
AbÜtHªdshake
(
¡©us
, 
ouut
);

266  
	gResuÉ
::
ABORTED
;

269 
VLOG
(2è<< "Reûived " << 
HªdshakeMes§geTy³_Name
(
mes§ge_ty³
)

272 ià((
	gmes§ge_ty³
 !ğ
G‘Ex³ùedMes§geTy³
()è&& (
mes§ge_ty³
 !ğ
ABORT
)) {

274 
AbÜtHªdshake
(
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
, "Unexpected message"),

275 
ouut
);

276  
	gResuÉ
::
ABORTED
;

279 ià(
	gšput_¡»am_
.
RemaššgBy‹CouÁ
(è< 
	gmes§ge_size
) {

282 
	gšput_¡»am_
.
Rewšd
();

283  
	gResuÉ
::
NOT_ENOUGH_DATA
;

285 
	g¡d
::
unique_±r
<
googË
::
´Ùobuf
::
Mes§ge
> 
mes§ge
 =

286 
C»©eHªdshakeMes§ge
(
mes§ge_ty³
);

290 
	g¡©us
 = 
P¬£F¿meMes§ge
(
mes§ge_size
, &
šput_¡»am_
, 
mes§ge
.
g‘
());

291 ià(!
	g¡©us
.
ok
()) {

292 ià(
	gmes§ge_ty³
 =ğ
ABORT
) {

295 
HªdËAbÜtMes§ge
(
nuÎ±r
);

296 
LOG
(
ERROR
è<< "FaedØde£rŸliz³”' AbÜt: " << 
	g¡©us
;

298 
AbÜtHªdshake
(
¡©us
, 
ouut
);

300  
	gResuÉ
::
ABORTED
;

303 
VLOG
(2è<< 
	gmes§ge
->
DebugSŒšg
();

305 ià(
	gmes§ge_ty³
 =ğ
ABORT
) {

306 cÚ¡ 
AbÜt
 *
abÜt_mes§ge
 = 
dyÇmic_ÿ¡
<cÚ¡ AbÜˆ*>(
mes§ge
.
g‘
());

307 
LOG_IF
(
DFATAL
, !
abÜt_mes§ge
) << "dynamic_cast from google::protobuf::Message * "

309 
HªdËAbÜtMes§ge
(
abÜt_mes§ge
);

310  
	gResuÉ
::
ABORTED
;

314 
Upd©eT¿nsütW™hIncomšgBy‹s
();

315 
	gšput_¡»am_
.
TrimFrÚt
();

317  
HªdËHªdshakeMes§ge
(
mes§ge_ty³
, *
mes§ge
, 
ouut
);

320 
Stus
 
	gEk•Hªdshak”
::
Wr™eF¿meAndUpd©eT¿nsüt
(

321 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

322 
¡d
::
¡ršg
 *
ouut
) {

323 
off£t
 = 
ouut
->
size
();

324 
	ggoogË
::
´Ùobuf
::
io
::
SŒšgOuutSŒ—m
 
outgošg_äame
(
ouut
);

325 
ASYLO_RETURN_IF_ERROR
(

326 
EncodeF¿me
(
mes§ge_ty³
, 
hªdshake_mes§ge
, &
outgošg_äame
));

330 
Upd©eT¿nsütW™hOutgošgBy‹s
(
ouut
->
d©a
(è+ 
off£t
,

331 
ouut
->
size
(è- 
off£t
);

332  
	gStus
::
OkStus
();

335 
	gEk•Hªdshak”
::
AddP“rId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
id’t™y
) {

336 *
³”_id’t™›s_
->
add_id’t™›s
(èğ
id’t™y
;

339 
	gEk•Hªdshak”
::
S‘RecÜdPrÙocŞ
(
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
) {

340 
»cÜd_´ÙocŞ_
 = 
»cÜd_´ÙocŞ
;

343 
Stus
 
	gEk•Hªdshak”
::
D”iveAndS‘RecÜdPrÙocŞKey
(

344 
HªdshakeCh”
 
ch”_su™e
, 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
,

345 
By‹CÚš”V›w
 
ma¡”_£ü‘
) {

346 
	g¡d
::
¡ršg
 
fš®_Œªsüt_hash
;

347 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
fš®_Œªsüt_hash
));

348  
D”iveRecÜdPrÙocŞKey
(
ch”_su™e
, 
»cÜd_´ÙocŞ
,

349 
fš®_Œªsüt_hash
, 
ma¡”_£ü‘
,

350 &
»cÜd_´ÙocŞ_key_
);

353 
boŞ
 
	gEk•Hªdshak”
::
S‘T¿nsütHashFunùiÚ
(
HashIÁ”çû
 *
hash
) {

354  
Œªsüt_
.
S‘Hash”
(
hash
);

357 
Stus
 
	gEk•Hªdshak”
::
G‘T¿nsütHash
(
¡d
::
¡ršg
 *
Œªsüt_hash
) {

358 
boŞ
 
»suÉ
 = 
Œªsüt_
.
Hash
(
Œªsüt_hash
);

359 ià(!
	g»suÉ
) {

360 
LOG
(
ERROR
) << "Transcript hash function is‚ot set";

361  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

364  
	gStus
::
OkStus
();

367 
	gEk•Hªdshak”
::
Upd©eT¿nsütW™hOutgošgBy‹s
(

368 cÚ¡ *
outgošg_by‹s
, 
outgošg_by‹s_size
) {

369 ià(
	goutgošg_by‹s_size
 > 0) {

370 
	ggoogË
::
´Ùobuf
::
io
::
A¼ayIÅutSŒ—m
 
£Á_by‹s
(
outgošg_by‹s
,

371 
outgošg_by‹s_size
);

372 
	gŒªsüt_
.
Add
(&
£Á_by‹s
);

376 
	gEk•Hªdshak”
::
Upd©eT¿nsütW™hIncomšgBy‹s
() {

377 
št64_t
 
by‹s_»ad
 = 
šput_¡»am_
.
By‹CouÁ
();

378 ià(
	gby‹s_»ad
 != 0) {

379 
šput_¡»am_
.
Rewšd
();

380 
	ggoogË
::
´Ùobuf
::
io
::
Lim™šgIÅutSŒ—m
 
cÚsumed_by‹s
(&
šput_¡»am_
, 
by‹s_»ad
);

381 
	gŒªsüt_
.
Add
(&
cÚsumed_by‹s
);

	@grpc/auth/core/ekep_handshaker.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_EKEP_HANDSHAKER_H_


20 
	#ASYLO_GRPC_AUTH_CORE_EKEP_HANDSHAKER_H_


	)

22 
	~<c¡dšt
>

24 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

25 
	~<googË/´Ùobuf/mes§ge.h
>

26 
	~"asylo/üy±o/hash_š‹rçû.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

28 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

29 
	~"asylo/g½c/auth/cÜe/Œªsüt.h
"

30 
	~"asylo/g½c/auth/ut/muÉi_bufãr_šput_¡»am.h
"

31 
	~"asylo/id’t™y/id’t™y.pb.h
"

32 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
	~"asylo/ut/¡©us.h
"

34 
	~"asylo/ut/¡©usÜ.h
"

36 
Çme¥aû
 
	gasylo
 {

39 cÚ¡ 
ušt32_t
 
	gkEk•F¿meH—d”Size
 = 8;

40 cÚ¡ 
ušt32_t
 
	gkEk•Ch®ËngeSize
 = 32;

72 şas 
	cEk•Hªdshak”
 {

73 
	gpublic
:

75 şas 
	cResuÉ
 {

76 
NOT_ENOUGH_DATA
 = 0,

77 
	gIN_PROGRESS
 = 1,

78 
	gCOMPLETED
 = 2,

79 
	gABORTED
 = 3,

86 
cÚ¡ex´
 
size_t
 
	gkF¿meSizeLim™
 = 1 << 30;

88 
	gvœtu®
 ~
Ek•Hªdshak”
() = ;

109 
ResuÉ
 
NextHªdshakeS‹p
(cÚ¡ *
šcomšg_by‹s
,

110 
size_t
 
šcomšg_by‹s_size
,

111 
¡d
::
¡ršg
 *
outgošg_by‹s
);

117 
Stus
 
EncodeF¿me
(
HªdshakeMes§geTy³
 
mes§ge_ty³
,

118 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

119 
googË
::
´Ùobuf
::
io
::
Z”oCİyOuutSŒ—m
 *
ouut
) const;

125 
Stus
 
P¬£F¿meH—d”
(
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
,

126 
ušt32_t
 *
mes§ge_size
,

127 
HªdshakeMes§geTy³
 *
mes§ge_ty³
) const;

133 
Stus
 
P¬£F¿meMes§ge
(
ušt32_t
 
mes§ge_size
,

134 
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
,

135 
googË
::
´Ùobuf
::
Mes§ge
 *
mes§ge
) const;

140 
	gStusOr
<
	g¡d
::
¡ršg
> 
G‘Unu£dBy‹s
();

145 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveId’t™›s
>> 
G‘P“rId’t™›s
();

150 
	gStusOr
<
	gRecÜdPrÙocŞ
> 
G‘RecÜdPrÙocŞ
();

155 
	gStusOr
<
	gCËªsšgVeùÜ
<
	gušt8_t
>> 
G‘RecÜdPrÙocŞKey
();

157 
	g´Ùeùed
:

158 şas 
	cHªdshakeS‹
 {

159 
NOT_STARTED
 = 0,

160 
	gIN_PROGRESS
 = 1,

161 
	gCOMPLETED
 = 2,

162 
	gABORTED
 = 3,

165 
Ek•Hªdshak”
(
max_äame_size
);

170 
ResuÉ
 
DecodeAndHªdËF¿me
(
¡d
::
¡ršg
 *
ouut
);

185 
Stus
 
Wr™eF¿meAndUpd©eT¿nsüt
(
HªdshakeMes§geTy³
 
mes§ge_ty³
,

186 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

187 
¡d
::
¡ršg
 *
ouut
);

190 
boŞ
 
S‘T¿nsütHashFunùiÚ
(
HashIÁ”çû
 *
hash
);

196 
Stus
 
G‘T¿nsütHash
(
¡d
::
¡ršg
 *
Œªsüt_hash
);

199 
AddP“rId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
id’t™y
);

202 
S‘RecÜdPrÙocŞ
(
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
);

206 
Stus
 
D”iveAndS‘RecÜdPrÙocŞKey
(
HªdshakeCh”
 
ch”_su™e
,

207 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
,

208 
By‹CÚš”V›w
 
ma¡”_£ü‘
);

213 
vœtu®
 
boŞ
 
IsHªdshakeInProg»ss
() const = 0;

216 
vœtu®
 
boŞ
 
IsHªdshakeCom¶‘ed
() const = 0;

219 
vœtu®
 
boŞ
 
IsHªdshakeAbÜ‹d
() const = 0;

223 
vœtu®
 
HªdshakeMes§geTy³
 
G‘Ex³ùedMes§geTy³
() const = 0;

232 
vœtu®
 
ResuÉ
 
S¹Hªdshake
(
¡d
::
¡ršg
 *
ouut
) = 0;

239 
vœtu®
 
AbÜtHªdshake
(cÚ¡ 
Stus
 &
abÜt_¡©us
,

240 
¡d
::
¡ršg
 *
ouut
) = 0;

249 
vœtu®
 
ResuÉ
 
HªdËHªdshakeMes§ge
(

250 
HªdshakeMes§geTy³
 
mes§ge_ty³
,

251 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
, 
¡d
::
¡ršg
 *
ouut
) = 0;

259 
vœtu®
 
HªdËAbÜtMes§ge
(cÚ¡ 
AbÜt
 *
abÜt_mes§ge
) = 0;

261 
	g´iv©e
:

264 
Upd©eT¿nsütW™hOutgošgBy‹s
(cÚ¡ *
outgošg_by‹s
,

265 
outgošg_by‹s_size
);

269 
Upd©eT¿nsütW™hIncomšgBy‹s
();

273 cÚ¡ 
	gmax_äame_size_
;

276 
MuÉiBufãrIÅutSŒ—m
 
	gšput_¡»am_
;

279 
T¿nsüt
 
	gŒªsüt_
;

282 
	g¡d
::
unique_±r
<
EnşaveId’t™›s
> 
³”_id’t™›s_
;

285 
RecÜdPrÙocŞ
 
	g»cÜd_´ÙocŞ_
;

288 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g»cÜd_´ÙocŞ_key_
;

	@grpc/auth/core/ekep_handshaker_util.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

23 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

24 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

26 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

31 cÚ¡ 
EnşaveAs£¹iÚG’”©Ü
 *
G‘EnşaveAs£¹iÚG’”©Ü
(

32 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

33 
	g¡d
::
¡ršg
 
authÜ™y_id
 =

34 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

35 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
())

36 .
V®ueOrD›
();

37 autØ
	g™
 = 
As£¹iÚG’”©ÜM­
::
G‘V®ue
(
authÜ™y_id
);

38  (
	g™
 =ğ
As£¹iÚG’”©ÜM­
::
v®ue_’d
()è? 
nuÎ±r
 : &*
™
;

41 cÚ¡ 
EnşaveAs£¹iÚV”if›r
 *
G‘EnşaveAs£¹iÚV”if›r
(

42 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

43 
	g¡d
::
¡ršg
 
authÜ™y_id
 =

44 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

45 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
())

46 .
V®ueOrD›
();

47 autØ
	g™
 = 
As£¹iÚV”if›rM­
::
G‘V®ue
(
authÜ™y_id
);

48  (
	g™
 =ğ
As£¹iÚV”if›rM­
::
v®ue_’d
()è? 
nuÎ±r
 : &*
™
;

51 
Stus
 
	gEk•Hªdshak”O±iÚs
::
V®id©e
() const {

52 ià(
max_äame_size
 > 
Ek•Hªdshak”
::
kF¿meSizeLim™
) {

53  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

54 
ab¦
::
SŒC©
("max_frame_size cannotƒxceed ",

55 
Ek•Hªdshak”
::
kF¿meSizeLim™
));

58 ià(
	gadd™iÚ®_auth’tiÿ‹d_d©a
.
size
(è> 
	gmax_äame_size
) {

59  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

64 ià(
	g£lf_as£¹iÚs
.
em±y
()) {

65  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

68 ià(
	gacû±ed_³”_as£¹iÚs
.
em±y
()) {

69  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
£lf_as£¹iÚs
) {

74 
StusOr
<
¡d
::
¡ršg
> 
authÜ™y_id_»suÉ
 =

75 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

76 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
());

77 ià(!
	gauthÜ™y_id_»suÉ
.
ok
()) {

78  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

82 
	g¡d
::
¡ršg
 
authÜ™y_id
 = 
authÜ™y_id_»suÉ
.
V®ueOrD›
();

83 ià(
	gAs£¹iÚG’”©ÜM­
::
G‘V®ue
(
authÜ™y_id
) ==

84 
As£¹iÚG’”©ÜM­
::
v®ue_’d
()) {

85  
Stus
(

86 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

87 
ab¦
::
SŒC©
(

89 
desütiÚ
.
ShÜtDebugSŒšg
(), "}"));

93 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
acû±ed_³”_as£¹iÚs
) {

94 
StusOr
<
¡d
::
¡ršg
> 
authÜ™y_id_»suÉ
 =

95 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

96 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
());

97 ià(!
	gauthÜ™y_id_»suÉ
.
ok
()) {

98  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

102 
	g¡d
::
¡ršg
 
authÜ™y_id
 = 
authÜ™y_id_»suÉ
.
V®ueOrD›
();

103 ià(
	gAs£¹iÚV”if›rM­
::
G‘V®ue
(
authÜ™y_id
) ==

104 
As£¹iÚV”if›rM­
::
v®ue_’d
()) {

105  
Stus
(

106 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

107 
ab¦
::
SŒC©
("Could‚ot find EnclaveAssertionVerifier†ibrary for: {",

108 
desütiÚ
.
ShÜtDebugSŒšg
(), "}"));

112  
	gStus
::
OkStus
();

115 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
>::
cÚ¡_™”©Ü
 
FšdAs£¹iÚDesütiÚ
(

116 cÚ¡ 
¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> &
li¡
,

117 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

118  
	g¡d
::
fšd_if
(

119 
li¡
.
cbegš
(),†i¡.
ûnd
(),

120 [&
desütiÚ
](cÚ¡ 
As£¹iÚDesütiÚ
 &
desc
è-> 
boŞ
 {

121  (
desc
.
id’t™y_ty³
(è=ğ
desütiÚ
.identity_type()) &&

122 (
desc
.
authÜ™y_ty³
(è=ğ
desütiÚ
.authority_type());

126 
boŞ
 
MakeEk•CÚ‹xtBlob
(cÚ¡ 
¡d
::
¡ršg
 &
public_key
,

127 cÚ¡ 
¡d
::
¡ršg
 &
Œªsüt_hash
,

128 
¡d
::
¡ršg
 *
ek•_cÚ‹xt
) {

129  
S”ŸlizeBy‹CÚš”s
(
ek•_cÚ‹xt
, 
public_key
, 
Œªsüt_hash
)

130 .
ok
();

	@grpc/auth/core/ekep_handshaker_util.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

23 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

24 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

26 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

31 cÚ¡ 
EnşaveAs£¹iÚG’”©Ü
 *
G‘EnşaveAs£¹iÚG’”©Ü
(

32 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

33 
	g¡d
::
¡ršg
 
authÜ™y_id
 =

34 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

35 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
())

36 .
V®ueOrD›
();

37 autØ
	g™
 = 
As£¹iÚG’”©ÜM­
::
G‘V®ue
(
authÜ™y_id
);

38  (
	g™
 =ğ
As£¹iÚG’”©ÜM­
::
v®ue_’d
()è? 
nuÎ±r
 : &*
™
;

41 cÚ¡ 
EnşaveAs£¹iÚV”if›r
 *
G‘EnşaveAs£¹iÚV”if›r
(

42 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

43 
	g¡d
::
¡ršg
 
authÜ™y_id
 =

44 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

45 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
())

46 .
V®ueOrD›
();

47 autØ
	g™
 = 
As£¹iÚV”if›rM­
::
G‘V®ue
(
authÜ™y_id
);

48  (
	g™
 =ğ
As£¹iÚV”if›rM­
::
v®ue_’d
()è? 
nuÎ±r
 : &*
™
;

51 
Stus
 
	gEk•Hªdshak”O±iÚs
::
V®id©e
() const {

52 ià(
max_äame_size
 > 
Ek•Hªdshak”
::
kF¿meSizeLim™
) {

53  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

54 
ab¦
::
SŒC©
("max_frame_size cannotƒxceed ",

55 
Ek•Hªdshak”
::
kF¿meSizeLim™
));

58 ià(
	gadd™iÚ®_auth’tiÿ‹d_d©a
.
size
(è> 
	gmax_äame_size
) {

59  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

64 ià(
	g£lf_as£¹iÚs
.
em±y
()) {

65  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

68 ià(
	gacû±ed_³”_as£¹iÚs
.
em±y
()) {

69  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
£lf_as£¹iÚs
) {

74 
StusOr
<
¡d
::
¡ršg
> 
authÜ™y_id_»suÉ
 =

75 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

76 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
());

77 ià(!
	gauthÜ™y_id_»suÉ
.
ok
()) {

78  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

82 
	g¡d
::
¡ršg
 
authÜ™y_id
 = 
authÜ™y_id_»suÉ
.
V®ueOrD›
();

83 ià(
	gAs£¹iÚG’”©ÜM­
::
G‘V®ue
(
authÜ™y_id
) ==

84 
As£¹iÚG’”©ÜM­
::
v®ue_’d
()) {

85  
Stus
(

86 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

87 
ab¦
::
SŒC©
(

89 
desütiÚ
.
ShÜtDebugSŒšg
(), "}"));

93 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
acû±ed_³”_as£¹iÚs
) {

94 
StusOr
<
¡d
::
¡ršg
> 
authÜ™y_id_»suÉ
 =

95 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

96 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
());

97 ià(!
	gauthÜ™y_id_»suÉ
.
ok
()) {

98  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

102 
	g¡d
::
¡ršg
 
authÜ™y_id
 = 
authÜ™y_id_»suÉ
.
V®ueOrD›
();

103 ià(
	gAs£¹iÚV”if›rM­
::
G‘V®ue
(
authÜ™y_id
) ==

104 
As£¹iÚV”if›rM­
::
v®ue_’d
()) {

105  
Stus
(

106 
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

107 
ab¦
::
SŒC©
("Could‚ot find EnclaveAssertionVerifier†ibrary for: {",

108 
desütiÚ
.
ShÜtDebugSŒšg
(), "}"));

112  
	gStus
::
OkStus
();

115 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
>::
cÚ¡_™”©Ü
 
FšdAs£¹iÚDesütiÚ
(

116 cÚ¡ 
¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> &
li¡
,

117 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

118  
	g¡d
::
fšd_if
(

119 
li¡
.
cbegš
(),†i¡.
ûnd
(),

120 [&
desütiÚ
](cÚ¡ 
As£¹iÚDesütiÚ
 &
desc
è-> 
boŞ
 {

121  (
desc
.
id’t™y_ty³
(è=ğ
desütiÚ
.identity_type()) &&

122 (
desc
.
authÜ™y_ty³
(è=ğ
desütiÚ
.authority_type());

126 
boŞ
 
MakeEk•CÚ‹xtBlob
(cÚ¡ 
¡d
::
¡ršg
 &
public_key
,

127 cÚ¡ 
¡d
::
¡ršg
 &
Œªsüt_hash
,

128 
¡d
::
¡ršg
 *
ek•_cÚ‹xt
) {

129  
S”ŸlizeBy‹CÚš”s
(
ek•_cÚ‹xt
, 
public_key
, 
Œªsüt_hash
)

130 .
ok
();

	@grpc/auth/core/ekep_handshaker_util.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_EKEP_HANDSHAKER_UTIL_H_


20 
	#ASYLO_GRPC_AUTH_CORE_EKEP_HANDSHAKER_UTIL_H_


	)

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

26 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

27 
	~"asylo/id’t™y/id’t™y.pb.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

35 
	sEk•Hªdshak”O±iÚs
 {

37 
size_t
 
	gmax_äame_size
 = 1 << 20;

40 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
£lf_as£¹iÚs
;

43 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
acû±ed_³”_as£¹iÚs
;

46 
	g¡d
::
¡ršg
 
add™iÚ®_auth’tiÿ‹d_d©a
;

60 
Stus
 
V®id©e
() const;

67 cÚ¡ 
EnşaveAs£¹iÚG’”©Ü
 *
G‘EnşaveAs£¹iÚG’”©Ü
(

68 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
);

74 cÚ¡ 
EnşaveAs£¹iÚV”if›r
 *
G‘EnşaveAs£¹iÚV”if›r
(

75 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
);

80 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
>::
cÚ¡_™”©Ü
 
FšdAs£¹iÚDesütiÚ
(

81 cÚ¡ 
¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> &
li¡
,

82 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
);

86 
boŞ
 
MakeEk•CÚ‹xtBlob
(cÚ¡ 
¡d
::
¡ršg
 &
public_key
,

87 cÚ¡ 
¡d
::
¡ršg
 &
Œªsüt_hash
,

88 
¡d
::
¡ršg
 *
ek•_cÚ‹xt
);

	@grpc/auth/core/ekep_handshaker_util_test.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

24 
	~"asylo/id’t™y/id’t™y.pb.h
"

25 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

33 cÚ¡ 
	gkBadAuthÜ™yTy³
[] = "unknown‡uthority";

35 şas 
	cEk•Hªdshak”UtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

36 
´Ùeùed
:

37 
S‘Up
(è
ov”ride
 {

38 
S‘NuÎAs£¹iÚDesütiÚ
(&
nuÎ_as£¹iÚ_desütiÚ_
);

40 
	gdeçuÉ_İtiÚs_
.
	g£lf_as£¹iÚs
 = {
nuÎ_as£¹iÚ_desütiÚ_
};

41 
	gdeçuÉ_İtiÚs_
.
	gacû±ed_³”_as£¹iÚs
 = {
nuÎ_as£¹iÚ_desütiÚ_
};

44 
As£¹iÚDesütiÚ
 
	gnuÎ_as£¹iÚ_desütiÚ_
;

45 
Ek•Hªdshak”O±iÚs
 
	gdeçuÉ_İtiÚs_
;

50 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘NuÎEnşaveAs£¹iÚG’”©Ü
) {

51 
EXPECT_NE
(
G‘EnşaveAs£¹iÚG’”©Ü
(
nuÎ_as£¹iÚ_desütiÚ_
), 
nuÎ±r
);

56 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘Inv®idEnşaveAs£¹iÚG’”©Ü
) {

57 
As£¹iÚDesütiÚ
 
	gbad_as£¹iÚ_desütiÚ
;

58 
	gbad_as£¹iÚ_desütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

59 
	gbad_as£¹iÚ_desütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

60 
EXPECT_EQ
(
G‘EnşaveAs£¹iÚG’”©Ü
(
bad_as£¹iÚ_desütiÚ
), 
nuÎ±r
);

65 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘NuÎEnşaveAs£¹iÚV”if›r
) {

66 
EXPECT_NE
(
G‘EnşaveAs£¹iÚV”if›r
(
nuÎ_as£¹iÚ_desütiÚ_
), 
nuÎ±r
);

71 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘Inv®idEnşaveAs£¹iÚV”if›r
) {

72 
As£¹iÚDesütiÚ
 
	gbad_as£¹iÚ_desütiÚ
;

73 
	gbad_as£¹iÚ_desütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

74 
	gbad_as£¹iÚ_desütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

75 
EXPECT_EQ
(
G‘EnşaveAs£¹iÚV”if›r
(
bad_as£¹iÚ_desütiÚ
), 
nuÎ±r
);

78 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eSucûss
) {

79 
EXPECT_THAT
(
deçuÉ_İtiÚs_
.
V®id©e
(), 
IsOk
());

84 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eBadF¿meSize
) {

85 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

88 
	gİtiÚs
.
	gmax_äame_size
 = 
Ek•Hªdshak”
::
kF¿meSizeLim™
 + 1;

89 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

92 
	gİtiÚs
.
	gmax_äame_size
 = -1;

93 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

98 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eBadAadSize
) {

99 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

100 
	gİtiÚs
.
	gmax_äame_size
 = 10;

101 
	gİtiÚs
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
.
»size
(
İtiÚs
.
max_äame_size
 + 1);

103 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

108 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eMissšgS–fId’t™›s
) {

109 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

110 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
ş—r
();

112 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

117 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eMissšgAcû±edP“rId’t™›s
) {

118 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

119 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
ş—r
();

121 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

126 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eInv®idS–fAs£¹iÚs
) {

127 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

129 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

130 
	gdesütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

131 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

132 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
push_back
(
desütiÚ
);

134 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

139 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eInv®idAcû±edP“rAs£¹iÚs
) {

140 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

142 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

143 
	gdesütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

144 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

145 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
push_back
(
desütiÚ
);

147 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

	@grpc/auth/core/ekep_handshaker_util_test.cc

19 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

24 
	~"asylo/id’t™y/id’t™y.pb.h
"

25 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

33 cÚ¡ 
	gkBadAuthÜ™yTy³
[] = "unknown‡uthority";

35 şas 
	cEk•Hªdshak”UtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

36 
´Ùeùed
:

37 
S‘Up
(è
ov”ride
 {

38 
S‘NuÎAs£¹iÚDesütiÚ
(&
nuÎ_as£¹iÚ_desütiÚ_
);

40 
	gdeçuÉ_İtiÚs_
.
	g£lf_as£¹iÚs
 = {
nuÎ_as£¹iÚ_desütiÚ_
};

41 
	gdeçuÉ_İtiÚs_
.
	gacû±ed_³”_as£¹iÚs
 = {
nuÎ_as£¹iÚ_desütiÚ_
};

44 
As£¹iÚDesütiÚ
 
	gnuÎ_as£¹iÚ_desütiÚ_
;

45 
Ek•Hªdshak”O±iÚs
 
	gdeçuÉ_İtiÚs_
;

50 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘NuÎEnşaveAs£¹iÚG’”©Ü
) {

51 
EXPECT_NE
(
G‘EnşaveAs£¹iÚG’”©Ü
(
nuÎ_as£¹iÚ_desütiÚ_
), 
nuÎ±r
);

56 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘Inv®idEnşaveAs£¹iÚG’”©Ü
) {

57 
As£¹iÚDesütiÚ
 
	gbad_as£¹iÚ_desütiÚ
;

58 
	gbad_as£¹iÚ_desütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

59 
	gbad_as£¹iÚ_desütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

60 
EXPECT_EQ
(
G‘EnşaveAs£¹iÚG’”©Ü
(
bad_as£¹iÚ_desütiÚ
), 
nuÎ±r
);

65 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘NuÎEnşaveAs£¹iÚV”if›r
) {

66 
EXPECT_NE
(
G‘EnşaveAs£¹iÚV”if›r
(
nuÎ_as£¹iÚ_desütiÚ_
), 
nuÎ±r
);

71 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
G‘Inv®idEnşaveAs£¹iÚV”if›r
) {

72 
As£¹iÚDesütiÚ
 
	gbad_as£¹iÚ_desütiÚ
;

73 
	gbad_as£¹iÚ_desütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

74 
	gbad_as£¹iÚ_desütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

75 
EXPECT_EQ
(
G‘EnşaveAs£¹iÚV”if›r
(
bad_as£¹iÚ_desütiÚ
), 
nuÎ±r
);

78 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eSucûss
) {

79 
EXPECT_THAT
(
deçuÉ_İtiÚs_
.
V®id©e
(), 
IsOk
());

84 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eBadF¿meSize
) {

85 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

88 
	gİtiÚs
.
	gmax_äame_size
 = 
Ek•Hªdshak”
::
kF¿meSizeLim™
 + 1;

89 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

92 
	gİtiÚs
.
	gmax_äame_size
 = -1;

93 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

98 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eBadAadSize
) {

99 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

100 
	gİtiÚs
.
	gmax_äame_size
 = 10;

101 
	gİtiÚs
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
.
»size
(
İtiÚs
.
max_äame_size
 + 1);

103 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

108 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eMissšgS–fId’t™›s
) {

109 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

110 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
ş—r
();

112 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

117 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eMissšgAcû±edP“rId’t™›s
) {

118 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

119 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
ş—r
();

121 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

126 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eInv®idS–fAs£¹iÚs
) {

127 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

129 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

130 
	gdesütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

131 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

132 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
push_back
(
desütiÚ
);

134 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

139 
TEST_F
(
Ek•Hªdshak”UtTe¡
, 
V®id©eInv®idAcû±edP“rAs£¹iÚs
) {

140 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
 = 
deçuÉ_İtiÚs_
;

142 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

143 
	gdesütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

144 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
kBadAuthÜ™yTy³
);

145 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
push_back
(
desütiÚ
);

147 
EXPECT_THAT
(
İtiÚs
.
V®id©e
(), 
NÙ
(
IsOk
()));

	@grpc/auth/core/enclave_credentials.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

21 
	~<¡ršg.h
>

23 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

24 
	~"asylo/g½c/auth/cÜe/’şave_£cur™y_cÚÃùÜ.h
"

25 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

26 
	~"šşude/g½c/suµÜt/®loc.h
"

27 
	~"šşude/g½c/suµÜt/log.h
"

28 
	~"¤c/cÜe/lib/chªÃl/chªÃl_¬gs.h
"

29 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

30 
	~"¤c/cÜe/lib/£cur™y/üed’tŸls/üed’tŸls.h
"

32 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
>

33 
	$g½c_’şave_chªÃl_üed’tŸls_ü—‹
(

34 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

35  
g½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_chªÃl_üed’tŸls
>(*
İtiÚs
);

36 
	}
}

38 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
>

39 
	$g½c_’şave_£rv”_üed’tŸls_ü—‹
(

40 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

41  
g½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_£rv”_üed’tŸls
>(*
İtiÚs
);

42 
	}
}

45 
	gg½c_’şave_chªÃl_üed’tŸls
::~
	$g½c_’şave_chªÃl_üed’tŸls
() {

46 
	`§ã_¡ršg_ä“
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

47 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
£lf_as£¹iÚs_
);

48 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
acû±ed_³”_as£¹iÚs_
);

49 
	}
}

52 
	gg½c_’şave_£rv”_üed’tŸls
::~
	$g½c_’şave_£rv”_üed’tŸls
() {

53 
	`§ã_¡ršg_ä“
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

54 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
£lf_as£¹iÚs_
);

55 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
acû±ed_³”_as£¹iÚs_
);

56 
	}
}

59 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_£cur™y_cÚÃùÜ
>

60 
g½c_’şave_chªÃl_üed’tŸls
::
ü—‹_£cur™y_cÚÃùÜ
(

61 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
ÿÎ_üeds
,

62 cÚ¡ *
rg‘
, cÚ¡ 
g½c_chªÃl_¬gs
 *
¬gs
,

63 
g½c_chªÃl_¬gs
 **
Ãw_¬gs
) {

64  
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ_ü—‹
(

65 
this
->
Ref
(), 
¡d
::
move
(
ÿÎ_üeds
), 
rg‘
);

69 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_£cur™y_cÚÃùÜ
>

70 
g½c_’şave_£rv”_üed’tŸls
::
	$ü—‹_£cur™y_cÚÃùÜ
() {

71  
	`g½c_’şave_£rv”_£cur™y_cÚÃùÜ_ü—‹
(
this
->
	`Ref
());

72 
	}
}

74 
	gg½c_’şave_chªÃl_üed’tŸls
::
	$g½c_’şave_chªÃl_üed’tŸls
(

75 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 &
İtiÚs
)

76 : 
	$g½c_chªÃl_üed’tŸls
(
GRPC_CREDENTIALS_TYPE_ENCLAVE
) {

78 
	`§ã_¡ršg_š™
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

79 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
£lf_as£¹iÚs_
);

80 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
acû±ed_³”_as£¹iÚs_
);

83 
	`§ã_¡ršg_cİy
Ğ&
add™iÚ®_auth’tiÿ‹d_d©a_
,

84  &
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
);

85 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
İtiÚs
.
£lf_as£¹iÚs
,

86  &
£lf_as£¹iÚs_
);

87 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
(

88  &
İtiÚs
.
acû±ed_³”_as£¹iÚs
,

89  &
acû±ed_³”_as£¹iÚs_
);

90 
	}
}

92 
	gg½c_’şave_£rv”_üed’tŸls
::
	$g½c_’şave_£rv”_üed’tŸls
(

93 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 &
İtiÚs
)

94 : 
	$g½c_£rv”_üed’tŸls
(
GRPC_CREDENTIALS_TYPE_ENCLAVE
) {

96 
	`§ã_¡ršg_š™
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

97 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
£lf_as£¹iÚs_
);

98 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
acû±ed_³”_as£¹iÚs_
);

101 
	`§ã_¡ršg_cİy
Ğ&
add™iÚ®_auth’tiÿ‹d_d©a_
,

102  &
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
);

103 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
İtiÚs
.
£lf_as£¹iÚs
,

104  &
£lf_as£¹iÚs_
);

105 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
(

106  &
İtiÚs
.
acû±ed_³”_as£¹iÚs
,

107  &
acû±ed_³”_as£¹iÚs_
);

108 
	}
}

	@grpc/auth/core/enclave_credentials.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

21 
	~<¡ršg.h
>

23 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

24 
	~"asylo/g½c/auth/cÜe/’şave_£cur™y_cÚÃùÜ.h
"

25 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

26 
	~"šşude/g½c/suµÜt/®loc.h
"

27 
	~"šşude/g½c/suµÜt/log.h
"

28 
	~"¤c/cÜe/lib/chªÃl/chªÃl_¬gs.h
"

29 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

30 
	~"¤c/cÜe/lib/£cur™y/üed’tŸls/üed’tŸls.h
"

32 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
>

33 
	$g½c_’şave_chªÃl_üed’tŸls_ü—‹
(

34 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

35  
g½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_chªÃl_üed’tŸls
>(*
İtiÚs
);

36 
	}
}

38 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
>

39 
	$g½c_’şave_£rv”_üed’tŸls_ü—‹
(

40 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

41  
g½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_£rv”_üed’tŸls
>(*
İtiÚs
);

42 
	}
}

45 
	gg½c_’şave_chªÃl_üed’tŸls
::~
	$g½c_’şave_chªÃl_üed’tŸls
() {

46 
	`§ã_¡ršg_ä“
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

47 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
£lf_as£¹iÚs_
);

48 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
acû±ed_³”_as£¹iÚs_
);

49 
	}
}

52 
	gg½c_’şave_£rv”_üed’tŸls
::~
	$g½c_’şave_£rv”_üed’tŸls
() {

53 
	`§ã_¡ršg_ä“
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

54 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
£lf_as£¹iÚs_
);

55 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
acû±ed_³”_as£¹iÚs_
);

56 
	}
}

59 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_£cur™y_cÚÃùÜ
>

60 
g½c_’şave_chªÃl_üed’tŸls
::
ü—‹_£cur™y_cÚÃùÜ
(

61 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
ÿÎ_üeds
,

62 cÚ¡ *
rg‘
, cÚ¡ 
g½c_chªÃl_¬gs
 *
¬gs
,

63 
g½c_chªÃl_¬gs
 **
Ãw_¬gs
) {

64  
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ_ü—‹
(

65 
this
->
Ref
(), 
¡d
::
move
(
ÿÎ_üeds
), 
rg‘
);

69 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_£cur™y_cÚÃùÜ
>

70 
g½c_’şave_£rv”_üed’tŸls
::
	$ü—‹_£cur™y_cÚÃùÜ
() {

71  
	`g½c_’şave_£rv”_£cur™y_cÚÃùÜ_ü—‹
(
this
->
	`Ref
());

72 
	}
}

74 
	gg½c_’şave_chªÃl_üed’tŸls
::
	$g½c_’şave_chªÃl_üed’tŸls
(

75 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 &
İtiÚs
)

76 : 
	$g½c_chªÃl_üed’tŸls
(
GRPC_CREDENTIALS_TYPE_ENCLAVE
) {

78 
	`§ã_¡ršg_š™
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

79 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
£lf_as£¹iÚs_
);

80 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
acû±ed_³”_as£¹iÚs_
);

83 
	`§ã_¡ršg_cİy
Ğ&
add™iÚ®_auth’tiÿ‹d_d©a_
,

84  &
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
);

85 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
İtiÚs
.
£lf_as£¹iÚs
,

86  &
£lf_as£¹iÚs_
);

87 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
(

88  &
İtiÚs
.
acû±ed_³”_as£¹iÚs
,

89  &
acû±ed_³”_as£¹iÚs_
);

90 
	}
}

92 
	gg½c_’şave_£rv”_üed’tŸls
::
	$g½c_’şave_£rv”_üed’tŸls
(

93 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 &
İtiÚs
)

94 : 
	$g½c_£rv”_üed’tŸls
(
GRPC_CREDENTIALS_TYPE_ENCLAVE
) {

96 
	`§ã_¡ršg_š™
(&
add™iÚ®_auth’tiÿ‹d_d©a_
);

97 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
£lf_as£¹iÚs_
);

98 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
acû±ed_³”_as£¹iÚs_
);

101 
	`§ã_¡ršg_cİy
Ğ&
add™iÚ®_auth’tiÿ‹d_d©a_
,

102  &
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
);

103 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
Ğ&
İtiÚs
.
£lf_as£¹iÚs
,

104  &
£lf_as£¹iÚs_
);

105 
	`as£¹iÚ_desütiÚ_¬¿y_cİy
(

106  &
İtiÚs
.
acû±ed_³”_as£¹iÚs
,

107  &
acû±ed_³”_as£¹iÚs_
);

108 
	}
}

	@grpc/auth/core/enclave_credentials.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_ENCLAVE_CREDENTIALS_H_


20 
	#ASYLO_GRPC_AUTH_CORE_ENCLAVE_CREDENTIALS_H_


	)

22 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

23 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls_İtiÚs.h
"

24 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

25 
	~"¤c/cÜe/lib/£cur™y/üed’tŸls/üed’tŸls.h
"

26 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

28 
	#GRPC_CREDENTIALS_TYPE_ENCLAVE
 "Enşave"

	)

35 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
>

36 
g½c_’şave_chªÃl_üed’tŸls_ü—‹
(

37 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
);

42 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
>

43 
g½c_’şave_£rv”_üed’tŸls_ü—‹
(

44 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
* 
İtiÚs
);

46 şas 
	cg½c_’şave_chªÃl_üed’tŸls
 
	mfš®
 : 
public
 
g½c_chªÃl_üed’tŸls
 {

47 
public
:

48 
ex¶ic™
 
g½c_’şave_chªÃl_üed’tŸls
(

49 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
& 
İtiÚs
);

50 ~
	$g½c_’şave_chªÃl_üed’tŸls
(è
ov”ride
;

52 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_£cur™y_cÚÃùÜ
>

53 
	`ü—‹_£cur™y_cÚÃùÜ
(

54 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
ÿÎ_üeds
,

55 cÚ¡ * 
rg‘
, cÚ¡ 
g½c_chªÃl_¬gs
* 
¬gs
,

56 
g½c_chªÃl_¬gs
** 
Ãw_¬gs
è
ov”ride
;

58 
§ã_¡ršg
* 
	$mubË_add™iÚ®_auth’tiÿ‹d_d©a
() {

59  &
add™iÚ®_auth’tiÿ‹d_d©a_
;

61 
as£¹iÚ_desütiÚ_¬¿y
* 
	$mubË_£lf_as£¹iÚs
() {

62  &
£lf_as£¹iÚs_
;

63 
	}
}

64 
as£¹iÚ_desütiÚ_¬¿y
* 
	$mubË_acû±ed_³”_as£¹iÚs
() {

65  &
acû±ed_³”_as£¹iÚs_
;

66 
	}
}

68 
	g´iv©e
:

70 
§ã_¡ršg
 
add™iÚ®_auth’tiÿ‹d_d©a_
;

73 
as£¹iÚ_desütiÚ_¬¿y
 
	g£lf_as£¹iÚs_
;

76 
as£¹iÚ_desütiÚ_¬¿y
 
	gacû±ed_³”_as£¹iÚs_
;

80 şas 
	cg½c_’şave_£rv”_üed’tŸls
 
	mfš®
 : 
public
 
g½c_£rv”_üed’tŸls
 {

81 
public
:

82 
ex¶ic™
 
g½c_’şave_£rv”_üed’tŸls
(

83 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
& 
İtiÚs
);

84 ~
	$g½c_’şave_£rv”_üed’tŸls
(è
ov”ride
;

86 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_£cur™y_cÚÃùÜ
>

87 
	$ü—‹_£cur™y_cÚÃùÜ
(è
ov”ride
;

89 
§ã_¡ršg
* 
	$mubË_add™iÚ®_auth’tiÿ‹d_d©a
() {

90  &
add™iÚ®_auth’tiÿ‹d_d©a_
;

92 
as£¹iÚ_desütiÚ_¬¿y
* 
	$mubË_£lf_as£¹iÚs
() {

93  &
£lf_as£¹iÚs_
;

94 
	}
}

95 
as£¹iÚ_desütiÚ_¬¿y
* 
	$mubË_acû±ed_³”_as£¹iÚs
() {

96  &
acû±ed_³”_as£¹iÚs_
;

97 
	}
}

99 
	g´iv©e
:

101 
§ã_¡ršg
 
add™iÚ®_auth’tiÿ‹d_d©a_
;

104 
as£¹iÚ_desütiÚ_¬¿y
 
	g£lf_as£¹iÚs_
;

107 
as£¹iÚ_desütiÚ_¬¿y
 
	gacû±ed_³”_as£¹iÚs_
;

	@grpc/auth/core/enclave_credentials_options.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls_İtiÚs.h
"

21 
	$g½c_’şave_üed’tŸls_İtiÚs_š™
(

22 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

23 
	`§ã_¡ršg_š™
(&
İtiÚs
->
add™iÚ®_auth’tiÿ‹d_d©a
);

24 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
İtiÚs
->
£lf_as£¹iÚs
);

25 
	`as£¹iÚ_desütiÚ_¬¿y_š™
( 0,

26 &
İtiÚs
->
acû±ed_³”_as£¹iÚs
);

27 
	}
}

29 
	$g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(

30 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

31 
	`§ã_¡ršg_ä“
(&
İtiÚs
->
add™iÚ®_auth’tiÿ‹d_d©a
);

32 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
İtiÚs
->
£lf_as£¹iÚs
);

33 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
İtiÚs
->
acû±ed_³”_as£¹iÚs
);

34 
	}
}

	@grpc/auth/core/enclave_credentials_options.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls_İtiÚs.h
"

21 
	$g½c_’şave_üed’tŸls_İtiÚs_š™
(

22 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

23 
	`§ã_¡ršg_š™
(&
İtiÚs
->
add™iÚ®_auth’tiÿ‹d_d©a
);

24 
	`as£¹iÚ_desütiÚ_¬¿y_š™
Ğ0, &
İtiÚs
->
£lf_as£¹iÚs
);

25 
	`as£¹iÚ_desütiÚ_¬¿y_š™
( 0,

26 &
İtiÚs
->
acû±ed_³”_as£¹iÚs
);

27 
	}
}

29 
	$g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(

30 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
) {

31 
	`§ã_¡ršg_ä“
(&
İtiÚs
->
add™iÚ®_auth’tiÿ‹d_d©a
);

32 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
İtiÚs
->
£lf_as£¹iÚs
);

33 
	`as£¹iÚ_desütiÚ_¬¿y_ä“
(&
İtiÚs
->
acû±ed_³”_as£¹iÚs
);

34 
	}
}

	@grpc/auth/core/enclave_credentials_options.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_ENCLAVE_CREDENTIALS_OPTIONS_H_


20 
	#ASYLO_GRPC_AUTH_CORE_ENCLAVE_CREDENTIALS_OPTIONS_H_


	)

22 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

23 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

26 
§ã_¡ršg
 
	madd™iÚ®_auth’tiÿ‹d_d©a
;

29 
as£¹iÚ_desütiÚ_¬¿y
 
	m£lf_as£¹iÚs
;

32 
as£¹iÚ_desütiÚ_¬¿y
 
	macû±ed_³”_as£¹iÚs
;

34 } 
	tg½c_’şave_üed’tŸls_İtiÚs
;

38 
g½c_’şave_üed’tŸls_İtiÚs_š™
(

39 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
);

42 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(

43 
g½c_’şave_üed’tŸls_İtiÚs
 *
İtiÚs
);

	@grpc/auth/core/enclave_grpc_security_constants.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_ENCLAVE_GRPC_SECURITY_CONSTANTS_H_


20 
	#ASYLO_GRPC_AUTH_CORE_ENCLAVE_GRPC_SECURITY_CONSTANTS_H_


	)

23 
	#GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
 \

24 "’şave_£cur™y.id’t™y_´Ùo"

	)

25 
	#GRPC_ENCLAVE_RECORD_PROTOCOL_PROPERTY_NAME
 \

26 "’şave_£cur™y.»cÜd_´ÙocŞ"

	)

30 
	#GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
 "’şave_£cur™y"

	)

	@grpc/auth/core/enclave_security_connector.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_£cur™y_cÚÃùÜ.h
"

21 
	~<¡dboŞ.h
>

22 
	~<¡ršg.h
>

24 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

25 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

26 
	~"asylo/g½c/auth/cÜe/’şave_g½c_£cur™y_cÚ¡ªts.h
"

27 
	~"asylo/g½c/auth/cÜe/’şave_Œª¥Üt_£cur™y.h
"

28 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

29 
	~"šşude/g½c/suµÜt/®loc.h
"

30 
	~"šşude/g½c/suµÜt/log.h
"

31 
	~"šşude/g½c/suµÜt/¡ršg_ut.h
"

32 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

33 
	~"¤c/cÜe/lib/iomgr/pŞl£t.h
"

34 
	~"¤c/cÜe/lib/£cur™y/cÚ‹xt/£cur™y_cÚ‹xt.h
"

35 
	~"¤c/cÜe/lib/£cur™y/üed’tŸls/üed’tŸls.h
"

36 
	~"¤c/cÜe/lib/£cur™y/Œª¥Üt/£cur™y_hªdshak”.h
"

37 
	~"¤c/cÜe/lib/surçû/­i_Œaû.h
"

38 
	~"¤c/cÜe/tsi/Œª¥Üt_£cur™y.h
"

40 
	gÇme¥aû
 {

42 
g½c_£cur™y_¡©us
 
g½c_’şave_auth_cÚ‹xt_äom_tsi_³”
(

43 cÚ¡ 
tsi_³”
 *
³”
,

44 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
) {

53 cÚ¡ 
tsi_³”_´İ”ty
 *
û¹ifiÿ‹_ty³_´İ”ty
 =

54 
tsi_³”_g‘_´İ”ty_by_Çme
(
³”
, 
TSI_CERTIFICATE_TYPE_PEER_PROPERTY
);

56 ià(
	gû¹ifiÿ‹_ty³_´İ”ty
 =ğ
nuÎ±r
) {

57 
g´_log
(
GPR_ERROR
, "Missing certificateype…eer…roperty");

58  
	gGRPC_SECURITY_ERROR
;

60 ià(
¡ºcmp
(
TSI_ENCLAVE_CERTIFICATE_TYPE
,

61 
û¹ifiÿ‹_ty³_´İ”ty
->
v®ue
.
d©a
,

62 
û¹ifiÿ‹_ty³_´İ”ty
->
v®ue
.
Ëngth
) != 0) {

63 
g´_log
(
GPR_ERROR
, "Invalid certificateype…eer…roperty");

64  
	gGRPC_SECURITY_ERROR
;

67 cÚ¡ 
tsi_³”_´İ”ty
 *
	gid’t™y_´İ”ty
 = 
tsi_³”_g‘_´İ”ty_by_Çme
(

68 
³”
, 
TSI_ENCLAVE_IDENTITIES_PROTO_PEER_PROPERTY
);

69 ià(
	gid’t™y_´İ”ty
 =ğ
nuÎ±r
) {

70 
g´_log
(
GPR_ERROR
, "Missing identity…roto…eer…roperty");

71  
	gGRPC_SECURITY_ERROR
;

74 cÚ¡ 
tsi_³”_´İ”ty
 *
	g»cÜd_´ÙocŞ_´İ”ty
 =

75 
tsi_³”_g‘_´İ”ty_by_Çme
(
³”
,

76 
TSI_ENCLAVE_RECORD_PROTOCOL_PEER_PROPERTY
);

77 ià(
	g»cÜd_´ÙocŞ_´İ”ty
 =ğ
nuÎ±r
) {

78 
g´_log
(
GPR_ERROR
, "Missing„ecord…rotocol…eer…roperty");

79  
	gGRPC_SECURITY_ERROR
;

83 *
	gauth_cÚ‹xt
 =

84 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
);

85 
g½c_auth_cÚ‹xt_add_c¡ršg_´İ”ty
(

86 
auth_cÚ‹xt
->
g‘
(), 
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
,

87 
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
);

88 
g½c_auth_cÚ‹xt_add_´İ”ty
(

89 
auth_cÚ‹xt
->
g‘
(), 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
,

90 
id’t™y_´İ”ty
->
v®ue
.
d©a
, id’t™y_´İ”ty->v®ue.
Ëngth
);

91 
g½c_auth_cÚ‹xt_add_´İ”ty
(
auth_cÚ‹xt
->
g‘
(),

92 
GRPC_ENCLAVE_RECORD_PROTOCOL_PROPERTY_NAME
,

93 
»cÜd_´ÙocŞ_´İ”ty
->
v®ue
.
d©a
,

94 
»cÜd_´ÙocŞ_´İ”ty
->
v®ue
.
Ëngth
);

96 ià(!
g½c_auth_cÚ‹xt_£t_³”_id’t™y_´İ”ty_Çme
(

97 
auth_cÚ‹xt
->
g‘
(), 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
)) {

98 
g´_log
(
GPR_ERROR
, "Error setting…eer identity…roperty‚ame");

99  
	gGRPC_SECURITY_ERROR
;

103  
	gGRPC_SECURITY_OK
;

106 
’şave_£cur™y_cÚÃùÜ_check_³”
(

107 
g½c_£cur™y_cÚÃùÜ
 *
sc
, 
tsi_³”
 
³”
,

108 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
,

109 
g½c_şosu»
 *
Ú_³”_checked
) {

110 
g½c_”rÜ
 *
	g”rÜ
 = 
GRPC_ERROR_NONE
;

111 
g½c_£cur™y_¡©us
 
	g¡©us
 =

112 
g½c_’şave_auth_cÚ‹xt_äom_tsi_³”
(&
³”
, 
auth_cÚ‹xt
);

113 
tsi_³”_de¡ruù
(&
³”
);

114 ià(
	g¡©us
 !ğ
GRPC_SECURITY_OK
) {

115 
”rÜ
 = 
GRPC_ERROR_CREATE_FROM_STATIC_STRING
(

119 
GRPC_CLOSURE_SCHED
(
Ú_³”_checked
, 
”rÜ
);

124 şas 
	cg½c_’şave_chªÃl_£cur™y_cÚÃùÜ
 
	gfš®


125 : 
public
 
g½c_chªÃl_£cur™y_cÚÃùÜ
 {

126 
public
:

127 
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ
(

128 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
chªÃl_üed’tŸls
,

129 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
»que¡_m‘ad©a_üeds
,

130 cÚ¡ *
rg‘
)

131 : 
g½c_chªÃl_£cur™y_cÚÃùÜ
Ğ
nuÎ±r
,

132 
¡d
::
move
(
chªÃl_üed’tŸls
),

133 
¡d
::
move
(
»que¡_m‘ad©a_üeds
)),

134 
rg‘_
(
g´_¡rdup
(
rg‘
)) {}

136 ~
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ
(è
	gov”ride
 {

137 
g´_ä“
(
rg‘_
);

140 
check_³”
(
tsi_³”
 
³”
, 
g½c_’dpošt
 *
•
,

141 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
,

142 
g½c_şosu»
 *
Ú_³”_checked
è
	gov”ride
 {

143 
’şave_£cur™y_cÚÃùÜ_check_³”
(
this
, 
³”
, 
auth_cÚ‹xt
,

144 
Ú_³”_checked
);

147 
boŞ
 
check_ÿÎ_ho¡
(cÚ¡ *
ho¡
, 
g½c_auth_cÚ‹xt
 *
auth_cÚ‹xt
,

148 
g½c_şosu»
 *
Ú_ÿÎ_ho¡_checked
,

149 
g½c_”rÜ
 **
”rÜ
è
	gov”ride
 {

150  
	gŒue
;

153 
ÿnûl_check_ÿÎ_ho¡
(
g½c_şosu»
 *
Ú_ÿÎ_ho¡_checked
,

154 
g½c_”rÜ
 *
”rÜ
è
	gov”ride
 {

155 
GRPC_ERROR_UNREF
(
”rÜ
);

158 
cmp
(cÚ¡ 
g½c_£cur™y_cÚÃùÜ
 * ) cÚ¡ 
	gov”ride
 {

162 
add_hªdshak”s
(

163 
g½c_pŞl£t_£t
 *
š‹»¡ed_·¹›s
,

164 
g½c_hªdshake_mªag”
 *
hªdshake_mgr
è
	gov”ride
 {

165 
tsi_hªdshak”
 *
	gtsi_hªdshak”
 = 
nuÎ±r
;

166 
g½c_’şave_chªÃl_üed’tŸls
 *
	gchªÃl_üeds
 =

167 
¡©ic_ÿ¡
<
g½c_’şave_chªÃl_üed’tŸls
 *>(

168 
this
->
mubË_chªÃl_üeds
());

169 
tsi_»suÉ
 
	g»suÉ
 = 
tsi_’şave_hªdshak”_ü—‹
(

170  
Œue
, 
chªÃl_üeds
->
mubË_£lf_as£¹iÚs
(),

171 
chªÃl_üeds
->
mubË_acû±ed_³”_as£¹iÚs
(),

172 
chªÃl_üeds
->
mubË_add™iÚ®_auth’tiÿ‹d_d©a
(),

173 &
tsi_hªdshak”
);

174 ià(
	g»suÉ
 !ğ
TSI_OK
) {

175 
g´_log
(
GPR_ERROR
, "Enclave handshaker creation failed withƒrror %s.",

176 
tsi_»suÉ_to_¡ršg
(
»suÉ
));

180 
g½c_hªdshake_mªag”_add
(

181 
hªdshake_mgr
, 
g½c_£cur™y_hªdshak”_ü—‹
(
tsi_hªdshak”
, 
this
));

184 
	g´iv©e
:

186 *
rg‘_
;

189 şas 
	cg½c_’şave_£rv”_£cur™y_cÚÃùÜ
 
	gfš®


190 : 
public
 
g½c_£rv”_£cur™y_cÚÃùÜ
 {

191 
public
:

192 
ex¶ic™
 
g½c_’şave_£rv”_£cur™y_cÚÃùÜ
(

193 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
£rv”_üed’tŸls
)

194 : 
g½c_£rv”_£cur™y_cÚÃùÜ
Ğ
nuÎ±r
,

195 
¡d
::
move
(
£rv”_üed’tŸls
)) {}

196 ~
g½c_’şave_£rv”_£cur™y_cÚÃùÜ
(è
ov”ride
 = ;

198 
check_³”
(
tsi_³”
 
³”
, 
g½c_’dpošt
 *
•
,

199 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
,

200 
g½c_şosu»
 *
Ú_³”_checked
è
	gov”ride
 {

201 
’şave_£cur™y_cÚÃùÜ_check_³”
(
this
, 
³”
, 
auth_cÚ‹xt
,

202 
Ú_³”_checked
);

205 
cmp
(cÚ¡ 
g½c_£cur™y_cÚÃùÜ
 * ) cÚ¡ 
	gov”ride
 {

209 
add_hªdshak”s
(

210 
g½c_pŞl£t_£t
 *
š‹»¡ed_·¹›s
,

211 
g½c_hªdshake_mªag”
 *
hªdshake_mgr
è
	gov”ride
 {

212 
tsi_hªdshak”
 *
	gtsi_hªdshak”
 = 
nuÎ±r
;

213 
g½c_’şave_£rv”_üed’tŸls
 *
	g£rv”_üeds
 =

214 
¡©ic_ÿ¡
<
g½c_’şave_£rv”_üed’tŸls
 *>(

215 
this
->
mubË_£rv”_üeds
());

216 
tsi_»suÉ
 
	g»suÉ
 = 
tsi_’şave_hªdshak”_ü—‹
(

217  
çl£
, 
£rv”_üeds
->
mubË_£lf_as£¹iÚs
(),

218 
£rv”_üeds
->
mubË_acû±ed_³”_as£¹iÚs
(),

219 
£rv”_üeds
->
mubË_add™iÚ®_auth’tiÿ‹d_d©a
(), &
tsi_hªdshak”
);

220 ià(
	g»suÉ
 !ğ
TSI_OK
) {

221 
g´_log
(
GPR_ERROR
, "Enclave handshaker creation failed withƒrror %s.",

222 
tsi_»suÉ_to_¡ršg
(
»suÉ
));

226 
g½c_hªdshake_mªag”_add
(

227 
hªdshake_mgr
, 
g½c_£cur™y_hªdshak”_ü—‹
(
tsi_hªdshak”
, 
this
));

233 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_£cur™y_cÚÃùÜ
>

234 
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ_ü—‹
(

235 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
chªÃl_üed’tŸls
,

236 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
»que¡_m‘ad©a_üeds
,

237 cÚ¡ *
rg‘
) {

238 
GRPC_API_TRACE
(

241 3, (
chªÃl_üed’tŸls
.
g‘
(), 
»que¡_m‘ad©a_üeds
.g‘(), 
rg‘
));

242  
	gg½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ
>(

243 
chªÃl_üed’tŸls
, 
	g»que¡_m‘ad©a_üeds
, 
	grg‘
);

246 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_£cur™y_cÚÃùÜ
>

247 
g½c_’şave_£rv”_£cur™y_cÚÃùÜ_ü—‹
(

248 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
£rv”_üed’tŸls
) {

249 
GRPC_API_TRACE
(

252 1, (
£rv”_üed’tŸls
.
g‘
()));

253  
	gg½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_£rv”_£cur™y_cÚÃùÜ
>(

254 
£rv”_üed’tŸls
);

	@grpc/auth/core/enclave_security_connector.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_£cur™y_cÚÃùÜ.h
"

21 
	~<¡dboŞ.h
>

22 
	~<¡ršg.h
>

24 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

25 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

26 
	~"asylo/g½c/auth/cÜe/’şave_g½c_£cur™y_cÚ¡ªts.h
"

27 
	~"asylo/g½c/auth/cÜe/’şave_Œª¥Üt_£cur™y.h
"

28 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

29 
	~"šşude/g½c/suµÜt/®loc.h
"

30 
	~"šşude/g½c/suµÜt/log.h
"

31 
	~"šşude/g½c/suµÜt/¡ršg_ut.h
"

32 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

33 
	~"¤c/cÜe/lib/iomgr/pŞl£t.h
"

34 
	~"¤c/cÜe/lib/£cur™y/cÚ‹xt/£cur™y_cÚ‹xt.h
"

35 
	~"¤c/cÜe/lib/£cur™y/üed’tŸls/üed’tŸls.h
"

36 
	~"¤c/cÜe/lib/£cur™y/Œª¥Üt/£cur™y_hªdshak”.h
"

37 
	~"¤c/cÜe/lib/surçû/­i_Œaû.h
"

38 
	~"¤c/cÜe/tsi/Œª¥Üt_£cur™y.h
"

40 
	gÇme¥aû
 {

42 
g½c_£cur™y_¡©us
 
g½c_’şave_auth_cÚ‹xt_äom_tsi_³”
(

43 cÚ¡ 
tsi_³”
 *
³”
,

44 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
) {

53 cÚ¡ 
tsi_³”_´İ”ty
 *
û¹ifiÿ‹_ty³_´İ”ty
 =

54 
tsi_³”_g‘_´İ”ty_by_Çme
(
³”
, 
TSI_CERTIFICATE_TYPE_PEER_PROPERTY
);

56 ià(
	gû¹ifiÿ‹_ty³_´İ”ty
 =ğ
nuÎ±r
) {

57 
g´_log
(
GPR_ERROR
, "Missing certificateype…eer…roperty");

58  
	gGRPC_SECURITY_ERROR
;

60 ià(
¡ºcmp
(
TSI_ENCLAVE_CERTIFICATE_TYPE
,

61 
û¹ifiÿ‹_ty³_´İ”ty
->
v®ue
.
d©a
,

62 
û¹ifiÿ‹_ty³_´İ”ty
->
v®ue
.
Ëngth
) != 0) {

63 
g´_log
(
GPR_ERROR
, "Invalid certificateype…eer…roperty");

64  
	gGRPC_SECURITY_ERROR
;

67 cÚ¡ 
tsi_³”_´İ”ty
 *
	gid’t™y_´İ”ty
 = 
tsi_³”_g‘_´İ”ty_by_Çme
(

68 
³”
, 
TSI_ENCLAVE_IDENTITIES_PROTO_PEER_PROPERTY
);

69 ià(
	gid’t™y_´İ”ty
 =ğ
nuÎ±r
) {

70 
g´_log
(
GPR_ERROR
, "Missing identity…roto…eer…roperty");

71  
	gGRPC_SECURITY_ERROR
;

74 cÚ¡ 
tsi_³”_´İ”ty
 *
	g»cÜd_´ÙocŞ_´İ”ty
 =

75 
tsi_³”_g‘_´İ”ty_by_Çme
(
³”
,

76 
TSI_ENCLAVE_RECORD_PROTOCOL_PEER_PROPERTY
);

77 ià(
	g»cÜd_´ÙocŞ_´İ”ty
 =ğ
nuÎ±r
) {

78 
g´_log
(
GPR_ERROR
, "Missing„ecord…rotocol…eer…roperty");

79  
	gGRPC_SECURITY_ERROR
;

83 *
	gauth_cÚ‹xt
 =

84 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
);

85 
g½c_auth_cÚ‹xt_add_c¡ršg_´İ”ty
(

86 
auth_cÚ‹xt
->
g‘
(), 
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
,

87 
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
);

88 
g½c_auth_cÚ‹xt_add_´İ”ty
(

89 
auth_cÚ‹xt
->
g‘
(), 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
,

90 
id’t™y_´İ”ty
->
v®ue
.
d©a
, id’t™y_´İ”ty->v®ue.
Ëngth
);

91 
g½c_auth_cÚ‹xt_add_´İ”ty
(
auth_cÚ‹xt
->
g‘
(),

92 
GRPC_ENCLAVE_RECORD_PROTOCOL_PROPERTY_NAME
,

93 
»cÜd_´ÙocŞ_´İ”ty
->
v®ue
.
d©a
,

94 
»cÜd_´ÙocŞ_´İ”ty
->
v®ue
.
Ëngth
);

96 ià(!
g½c_auth_cÚ‹xt_£t_³”_id’t™y_´İ”ty_Çme
(

97 
auth_cÚ‹xt
->
g‘
(), 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
)) {

98 
g´_log
(
GPR_ERROR
, "Error setting…eer identity…roperty‚ame");

99  
	gGRPC_SECURITY_ERROR
;

103  
	gGRPC_SECURITY_OK
;

106 
’şave_£cur™y_cÚÃùÜ_check_³”
(

107 
g½c_£cur™y_cÚÃùÜ
 *
sc
, 
tsi_³”
 
³”
,

108 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
,

109 
g½c_şosu»
 *
Ú_³”_checked
) {

110 
g½c_”rÜ
 *
	g”rÜ
 = 
GRPC_ERROR_NONE
;

111 
g½c_£cur™y_¡©us
 
	g¡©us
 =

112 
g½c_’şave_auth_cÚ‹xt_äom_tsi_³”
(&
³”
, 
auth_cÚ‹xt
);

113 
tsi_³”_de¡ruù
(&
³”
);

114 ià(
	g¡©us
 !ğ
GRPC_SECURITY_OK
) {

115 
”rÜ
 = 
GRPC_ERROR_CREATE_FROM_STATIC_STRING
(

119 
GRPC_CLOSURE_SCHED
(
Ú_³”_checked
, 
”rÜ
);

124 şas 
	cg½c_’şave_chªÃl_£cur™y_cÚÃùÜ
 
	gfš®


125 : 
public
 
g½c_chªÃl_£cur™y_cÚÃùÜ
 {

126 
public
:

127 
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ
(

128 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
chªÃl_üed’tŸls
,

129 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
»que¡_m‘ad©a_üeds
,

130 cÚ¡ *
rg‘
)

131 : 
g½c_chªÃl_£cur™y_cÚÃùÜ
Ğ
nuÎ±r
,

132 
¡d
::
move
(
chªÃl_üed’tŸls
),

133 
¡d
::
move
(
»que¡_m‘ad©a_üeds
)),

134 
rg‘_
(
g´_¡rdup
(
rg‘
)) {}

136 ~
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ
(è
	gov”ride
 {

137 
g´_ä“
(
rg‘_
);

140 
check_³”
(
tsi_³”
 
³”
, 
g½c_’dpošt
 *
•
,

141 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
,

142 
g½c_şosu»
 *
Ú_³”_checked
è
	gov”ride
 {

143 
’şave_£cur™y_cÚÃùÜ_check_³”
(
this
, 
³”
, 
auth_cÚ‹xt
,

144 
Ú_³”_checked
);

147 
boŞ
 
check_ÿÎ_ho¡
(cÚ¡ *
ho¡
, 
g½c_auth_cÚ‹xt
 *
auth_cÚ‹xt
,

148 
g½c_şosu»
 *
Ú_ÿÎ_ho¡_checked
,

149 
g½c_”rÜ
 **
”rÜ
è
	gov”ride
 {

150  
	gŒue
;

153 
ÿnûl_check_ÿÎ_ho¡
(
g½c_şosu»
 *
Ú_ÿÎ_ho¡_checked
,

154 
g½c_”rÜ
 *
”rÜ
è
	gov”ride
 {

155 
GRPC_ERROR_UNREF
(
”rÜ
);

158 
cmp
(cÚ¡ 
g½c_£cur™y_cÚÃùÜ
 * ) cÚ¡ 
	gov”ride
 {

162 
add_hªdshak”s
(

163 
g½c_pŞl£t_£t
 *
š‹»¡ed_·¹›s
,

164 
g½c_hªdshake_mªag”
 *
hªdshake_mgr
è
	gov”ride
 {

165 
tsi_hªdshak”
 *
	gtsi_hªdshak”
 = 
nuÎ±r
;

166 
g½c_’şave_chªÃl_üed’tŸls
 *
	gchªÃl_üeds
 =

167 
¡©ic_ÿ¡
<
g½c_’şave_chªÃl_üed’tŸls
 *>(

168 
this
->
mubË_chªÃl_üeds
());

169 
tsi_»suÉ
 
	g»suÉ
 = 
tsi_’şave_hªdshak”_ü—‹
(

170  
Œue
, 
chªÃl_üeds
->
mubË_£lf_as£¹iÚs
(),

171 
chªÃl_üeds
->
mubË_acû±ed_³”_as£¹iÚs
(),

172 
chªÃl_üeds
->
mubË_add™iÚ®_auth’tiÿ‹d_d©a
(),

173 &
tsi_hªdshak”
);

174 ià(
	g»suÉ
 !ğ
TSI_OK
) {

175 
g´_log
(
GPR_ERROR
, "Enclave handshaker creation failed withƒrror %s.",

176 
tsi_»suÉ_to_¡ršg
(
»suÉ
));

180 
g½c_hªdshake_mªag”_add
(

181 
hªdshake_mgr
, 
g½c_£cur™y_hªdshak”_ü—‹
(
tsi_hªdshak”
, 
this
));

184 
	g´iv©e
:

186 *
rg‘_
;

189 şas 
	cg½c_’şave_£rv”_£cur™y_cÚÃùÜ
 
	gfš®


190 : 
public
 
g½c_£rv”_£cur™y_cÚÃùÜ
 {

191 
public
:

192 
ex¶ic™
 
g½c_’şave_£rv”_£cur™y_cÚÃùÜ
(

193 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
£rv”_üed’tŸls
)

194 : 
g½c_£rv”_£cur™y_cÚÃùÜ
Ğ
nuÎ±r
,

195 
¡d
::
move
(
£rv”_üed’tŸls
)) {}

196 ~
g½c_’şave_£rv”_£cur™y_cÚÃùÜ
(è
ov”ride
 = ;

198 
check_³”
(
tsi_³”
 
³”
, 
g½c_’dpošt
 *
•
,

199 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_auth_cÚ‹xt
> *
auth_cÚ‹xt
,

200 
g½c_şosu»
 *
Ú_³”_checked
è
	gov”ride
 {

201 
’şave_£cur™y_cÚÃùÜ_check_³”
(
this
, 
³”
, 
auth_cÚ‹xt
,

202 
Ú_³”_checked
);

205 
cmp
(cÚ¡ 
g½c_£cur™y_cÚÃùÜ
 * ) cÚ¡ 
	gov”ride
 {

209 
add_hªdshak”s
(

210 
g½c_pŞl£t_£t
 *
š‹»¡ed_·¹›s
,

211 
g½c_hªdshake_mªag”
 *
hªdshake_mgr
è
	gov”ride
 {

212 
tsi_hªdshak”
 *
	gtsi_hªdshak”
 = 
nuÎ±r
;

213 
g½c_’şave_£rv”_üed’tŸls
 *
	g£rv”_üeds
 =

214 
¡©ic_ÿ¡
<
g½c_’şave_£rv”_üed’tŸls
 *>(

215 
this
->
mubË_£rv”_üeds
());

216 
tsi_»suÉ
 
	g»suÉ
 = 
tsi_’şave_hªdshak”_ü—‹
(

217  
çl£
, 
£rv”_üeds
->
mubË_£lf_as£¹iÚs
(),

218 
£rv”_üeds
->
mubË_acû±ed_³”_as£¹iÚs
(),

219 
£rv”_üeds
->
mubË_add™iÚ®_auth’tiÿ‹d_d©a
(), &
tsi_hªdshak”
);

220 ià(
	g»suÉ
 !ğ
TSI_OK
) {

221 
g´_log
(
GPR_ERROR
, "Enclave handshaker creation failed withƒrror %s.",

222 
tsi_»suÉ_to_¡ršg
(
»suÉ
));

226 
g½c_hªdshake_mªag”_add
(

227 
hªdshake_mgr
, 
g½c_£cur™y_hªdshak”_ü—‹
(
tsi_hªdshak”
, 
this
));

233 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_£cur™y_cÚÃùÜ
>

234 
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ_ü—‹
(

235 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
chªÃl_üed’tŸls
,

236 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
»que¡_m‘ad©a_üeds
,

237 cÚ¡ *
rg‘
) {

238 
GRPC_API_TRACE
(

241 3, (
chªÃl_üed’tŸls
.
g‘
(), 
»que¡_m‘ad©a_üeds
.g‘(), 
rg‘
));

242  
	gg½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ
>(

243 
chªÃl_üed’tŸls
, 
	g»que¡_m‘ad©a_üeds
, 
	grg‘
);

246 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_£cur™y_cÚÃùÜ
>

247 
g½c_’şave_£rv”_£cur™y_cÚÃùÜ_ü—‹
(

248 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
£rv”_üed’tŸls
) {

249 
GRPC_API_TRACE
(

252 1, (
£rv”_üed’tŸls
.
g‘
()));

253  
	gg½c_cÜe
::
MakeRefCouÁed
<
g½c_’şave_£rv”_£cur™y_cÚÃùÜ
>(

254 
£rv”_üed’tŸls
);

	@grpc/auth/core/enclave_security_connector.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_ENCLAVE_SECURITY_CONNECTOR_H_


20 
	#ASYLO_GRPC_AUTH_CORE_ENCLAVE_SECURITY_CONNECTOR_H_


	)

22 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

23 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

24 
	~"šşude/g½c/g½c_£cur™y.h
"

25 
	~"¤c/cÜe/lib/£cur™y/£cur™y_cÚÃùÜ/£cur™y_cÚÃùÜ.h
"

34 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_£cur™y_cÚÃùÜ
>

35 
g½c_’şave_chªÃl_£cur™y_cÚÃùÜ_ü—‹
(

36 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
chªÃl_üed’tŸls
,

37 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_ÿÎ_üed’tŸls
> 
»que¡_m‘ad©a_üeds
,

38 cÚ¡ *
rg‘
);

42 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_£cur™y_cÚÃùÜ
>

43 
g½c_’şave_£rv”_£cur™y_cÚÃùÜ_ü—‹
(

44 
g½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
£rv”_üed’tŸls
);

	@grpc/auth/core/enclave_transport_security.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_Œª¥Üt_£cur™y.h
"

21 
	~<®gÜ™hm
>

22 
	~<memÜy
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

27 
	~"ab¦/memÜy/memÜy.h
"

28 
	~"asylo/g½c/auth/cÜe/ş›Á_ek•_hªdshak”.h
"

29 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

30 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

31 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

32 
	~"asylo/g½c/auth/cÜe/£rv”_ek•_hªdshak”.h
"

33 
	~"asylo/id’t™y/id’t™y.pb.h
"

34 
	~"asylo/ut/ş—nsšg_ty³s.h
"

35 
	~"asylo/ut/¡©usÜ.h
"

36 
	~"šşude/g½c/suµÜt/log.h
"

37 
	~"¤c/cÜe/lib/g´/¡ršg.h
"

38 
	~"¤c/cÜe/lib/surçû/­i_Œaû.h
"

39 
	~"¤c/cÜe/tsi/®ts/äame_´ÙeùÜ/®ts_äame_´ÙeùÜ.h
"

40 
	~"¤c/cÜe/tsi/Œª¥Üt_£cur™y.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
	gÇme¥aû
 {

45 
cÚ¡ex´
 
	gkEnşaveP“rPrİ”tyCouÁ
 = 3;

48 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
C»©eAs£¹iÚDesütiÚVeùÜ
(

49 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
desütiÚs_¬¿y
) {

50 
¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
desütiÚs_veùÜ
;

51 
	gi
 = 0; i < 
	gdesütiÚs_¬¿y
.
	gcouÁ
; ++i) {

52 
	gdesütiÚs_veùÜ
.
em¶aû_back
();

55 
	gdesütiÚs_veùÜ
.
back
().
£t_id’t™y_ty³
(

56 
¡©ic_ÿ¡
<
EnşaveId’t™yTy³
>(

57 
desütiÚs_¬¿y
.
desütiÚs
[
i
].
id’t™y_ty³
));

60 cÚ¡ 
	g§ã_¡ršg
 &
	gauthÜ™y_ty³_¿w
 =

61 
desütiÚs_¬¿y
.
desütiÚs
[
i
].
authÜ™y_ty³
;

62 
	gdesütiÚs_veùÜ
.
back
().
£t_authÜ™y_ty³
(
authÜ™y_ty³_¿w
.
d©a
,

63 
authÜ™y_ty³_¿w
.
size
);

65  
	gdesütiÚs_veùÜ
;

73 şas 
	cTsiEnşaveHªdshak”ResuÉ
 {

74 
	gpublic
:

75 
TsiEnşaveHªdshak”ResuÉ
(

76 
boŞ
 
is_ş›Á
, 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
,

77 cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
»cÜd_´ÙocŞ_key
,

78 
¡d
::
unique_±r
<
EnşaveId’t™›s
> 
³”_id’t™›s
,

79 
¡d
::
¡ršg
 
unu£d_by‹s
)

80 : 
is_ş›Á_
(
is_ş›Á
),

81 
»cÜd_´ÙocŞ_
(
»cÜd_´ÙocŞ
),

82 
»cÜd_´ÙocŞ_key_
(
»cÜd_´ÙocŞ_key
),

83 
³”_id’t™›s_
(
¡d
::
move
(
³”_id’t™›s
)),

84 
unu£d_by‹s_
(
¡d
::
move
(
unu£d_by‹s
)) {}

89 
tsi_»suÉ
 
C»©eF¿mePrÙeùÜ
(
size_t
 *
max_ouut_´Ùeùed_äame_size
,

90 
tsi_äame_´ÙeùÜ
 **
´ÙeùÜ
) {

91 
	g»cÜd_´ÙocŞ_
) {

92 
	gSEAL_AES128_GCM
:

93  
®ts_ü—‹_äame_´ÙeùÜ
(

94 
»cÜd_´ÙocŞ_key_
.
d©a
(),„ecÜd_´ÙocŞ_key_.
size
(),

95 
is_ş›Á_
, 
çl£
, 
max_ouut_´Ùeùed_äame_size
,

96 
´ÙeùÜ
);

98  
TSI_INTERNAL_ERROR
;

104 
tsi_»suÉ
 
G‘Unu£dBy‹s
(cÚ¡ **
by‹s
, 
size_t
 *
by‹s_size
) {

105 *
	gby‹s_size
 = 
unu£d_by‹s_
.
size
();

106 *
	gby‹s
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
unu£d_by‹s_
.
d©a
());

107  
	gTSI_OK
;

115 
tsi_»suÉ
 
ExŒaùP“r
(
tsi_³”
 *
³”
) {

116 
tsi_»suÉ
 
	g»suÉ
 = 
tsi_cÚ¡ruù_³”
(
kEnşaveP“rPrİ”tyCouÁ
, 
³”
);

117 ià(
	g»suÉ
 !ğ
TSI_OK
) {

118  
»suÉ
;

121 
	g»suÉ
 = 
tsi_cÚ¡ruù_¡ršg_³”_´İ”ty_äom_c¡ršg
(

122 
TSI_CERTIFICATE_TYPE_PEER_PROPERTY
, 
TSI_ENCLAVE_CERTIFICATE_TYPE
,

123 &
³”
->
´İ”t›s
[0]);

124 ià(
	g»suÉ
 !ğ
TSI_OK
) {

125 
tsi_³”_de¡ruù
(
³”
);

126  
	g»suÉ
;

130 
	g¡d
::
¡ršg
 
£rŸlized_id’t™y
;

131 ià(!
	g³”_id’t™›s_
->
S”ŸlizeToSŒšg
(&
£rŸlized_id’t™y
)) {

132 
tsi_³”_de¡ruù
(
³”
);

133  
	gTSI_INTERNAL_ERROR
;

135 
	g»suÉ
 = 
tsi_cÚ¡ruù_¡ršg_³”_´İ”ty
(

136 
TSI_ENCLAVE_IDENTITIES_PROTO_PEER_PROPERTY
, 
£rŸlized_id’t™y
.
d©a
(),

137 
£rŸlized_id’t™y
.
size
(), &
³”
->
´İ”t›s
[1]);

138 ià(
	g»suÉ
 !ğ
TSI_OK
) {

139 
tsi_³”_de¡ruù
(
³”
);

140  
	g»suÉ
;

146 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_»cÜd_´ÙocŞ
((
»cÜd_´ÙocŞ_
));

147 
	ggoogË
::
´Ùobuf
::
io
::
CodedOuutSŒ—m
::
Wr™eL™eEndŸn32ToA¼ay
(

148 
»cÜd_´ÙocŞ_
, 
£rŸlized_»cÜd_´ÙocŞ
.
d©a
());

149 
	g»suÉ
 = 
tsi_cÚ¡ruù_¡ršg_³”_´İ”ty
(

150 
TSI_ENCLAVE_RECORD_PROTOCOL_PEER_PROPERTY
,

151 
»š‹½»t_ÿ¡
<cÚ¡ *>(
£rŸlized_»cÜd_´ÙocŞ
.
d©a
()),

152 
£rŸlized_»cÜd_´ÙocŞ
.
size
(), &
³”
->
´İ”t›s
[2]);

153 ià(
	g»suÉ
 !ğ
TSI_OK
) {

154 
tsi_³”_de¡ruù
(
³”
);

155  
	g»suÉ
;

157  
	g»suÉ
;

160 
	g´iv©e
:

163 
boŞ
 
is_ş›Á_
;

166 
RecÜdPrÙocŞ
 
	g»cÜd_´ÙocŞ_
;

169 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g»cÜd_´ÙocŞ_key_
;

172 
	g¡d
::
unique_±r
<
EnşaveId’t™›s
> 
³”_id’t™›s_
;

175 
	g¡d
::
¡ršg
 
unu£d_by‹s_
;

180 
	stsi_’şave_hªdshak”_»suÉ
 {

181 
tsi_hªdshak”_»suÉ
 
	gba£
;

182 
	g¡d
::
unique_±r
<
TsiEnşaveHªdshak”ResuÉ
> 
im¶
;

185 
tsi_»suÉ
 
	$’şave_hªdshak”_»suÉ_exŒaù_³”
(

186 cÚ¡ 
tsi_hªdshak”_»suÉ
 *
£lf
, 
tsi_³”
 *
³”
) {

187 cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

188 
»š‹½»t_ÿ¡
<cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

190  
»suÉ
->
im¶
->
	`ExŒaùP“r
(
³”
);

191 
	}
}

193 
tsi_»suÉ
 
	$’şave_hªdshak”_»suÉ_ü—‹_äame_´ÙeùÜ
(

194 cÚ¡ 
tsi_hªdshak”_»suÉ
 *
£lf
, 
size_t
 *
max_ouut_´Ùeùed_äame_size
,

195 
tsi_äame_´ÙeùÜ
 **
´ÙeùÜ
) {

196 cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

197 
»š‹½»t_ÿ¡
<cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

199  
»suÉ
->
im¶
->
	`C»©eF¿mePrÙeùÜ
(
max_ouut_´Ùeùed_äame_size
,

200 
´ÙeùÜ
);

201 
	}
}

203 
tsi_»suÉ
 
	$’şave_hªdshak”_»suÉ_g‘_unu£d_by‹s
(

204 cÚ¡ 
tsi_hªdshak”_»suÉ
 *
£lf
, cÚ¡ **
by‹s
,

205 
size_t
 *
by‹s_size
) {

206 cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

207 
»š‹½»t_ÿ¡
<cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

209  
»suÉ
->
im¶
->
	`G‘Unu£dBy‹s
(
by‹s
, 
by‹s_size
);

210 
	}
}

212 
	$’şave_hªdshak”_»suÉ_de¡roy
(
tsi_hªdshak”_»suÉ
 *
£lf
) {

213 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

214 
»š‹½»t_ÿ¡
<
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

215 
	`d–‘e
 (
»suÉ
);

216 
	}
}

218 cÚ¡ 
tsi_hªdshak”_»suÉ_vbË
 
	ghªdshak”_»suÉ_vbË
 = {

219 
’şave_hªdshak”_»suÉ_exŒaù_³”
,

220 
nuÎ±r
 ,

221 
’şave_hªdshak”_»suÉ_ü—‹_äame_´ÙeùÜ
,

222 
’şave_hªdshak”_»suÉ_g‘_unu£d_by‹s
,

223 
’şave_hªdshak”_»suÉ_de¡roy
,

226 
tsi_»suÉ
 
’şave_hªdshak”_»suÉ_ü—‹
(

227 
¡d
::
unique_±r
<
TsiEnşaveHªdshak”ResuÉ
> 
im¶
,

228 
tsi_hªdshak”_»suÉ
 **
hªdshak”_»suÉ
) {

229 ià(!
	gim¶
 || !
	ghªdshak”_»suÉ
) {

230  
	gTSI_INVALID_ARGUMENT
;

233 
tsi_’şave_hªdshak”_»suÉ
 *
	g»suÉ
 = 
Ãw
si_enclave_handshaker_result();

234 
	g»suÉ
->
	gba£
.
	gvbË
 = &
hªdshak”_»suÉ_vbË
;

235 
	g»suÉ
->
	gim¶
 = 
¡d
::
move
(
im¶
);

237 *
	ghªdshak”_»suÉ
 = &
»suÉ
->
ba£
;

238  
	gTSI_OK
;

245 
	stsi_’şave_hªdshak”
 {

246 
tsi_hªdshak”
 
	gba£
;

247 
boŞ
 
	gis_ş›Á
;

248 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
hªdshak”
;

249 
	g¡d
::
¡ršg
 
outgošg_by‹s
;

251 
tsi_’şave_hªdshak”
(
boŞ
 
is_ş›Á
,

252 
¡d
::
unique_±r
<
Ek•Hªdshak”
> 
ek•_hªdshak”
);

255 
	$’şave_hªdshak”_de¡roy
(
tsi_hªdshak”
 *
£lf
) {

256 
tsi_’şave_hªdshak”
 *
im¶
 =

257 
»š‹½»t_ÿ¡
<
tsi_’şave_hªdshak”
 *>(
£lf
);

258 
	`d–‘e
 (
im¶
);

259 
	}
}

261 
tsi_»suÉ
 
	$’şave_hªdshak”_Ãxt
(

262 
tsi_hªdshak”
 *
£lf
, cÚ¡ *
»ûived_by‹s
,

263 
size_t
 
»ûived_by‹s_size
, cÚ¡ **
by‹s_to_£nd
,

264 
size_t
 *
by‹s_to_£nd_size
, 
tsi_hªdshak”_»suÉ
 **
hªdshak”_»suÉ
,

265 
tsi_hªdshak”_Ú_Ãxt_dÚe_cb
 
cb
, *
u£r_d©a
) {

266 ià((
»ûived_by‹s_size
 > 0 && !
»ûived_by‹s
è|| !
by‹s_to_£nd
 ||

267 !
by‹s_to_£nd_size
 || !
hªdshak”_»suÉ
) {

268  
TSI_INVALID_ARGUMENT
;

270 
	`g´_log
(
GPR_INFO
,

274 
£lf
, 
»ûived_by‹s
, 
»ûived_by‹s_size
, 
by‹s_to_£nd
,

275 
by‹s_to_£nd_size
, 
hªdshak”_»suÉ
, 
cb
, 
u£r_d©a
);

277 
tsi_’şave_hªdshak”
 *
tsi_hªdshak”
 =

278 
»š‹½»t_ÿ¡
<
tsi_’şave_hªdshak”
 *>(
£lf
);

279 
Ek•Hªdshak”
 *
hªdshak”
 = 
tsi_hªdshak”
->hªdshak”.
	`g‘
();

282 
Ek•Hªdshak”
::
ResuÉ
 
hªdshake_¡•_»suÉ
 = 
hªdshak”
->
	`NextHªdshakeS‹p
(

283 
»š‹½»t_ÿ¡
<cÚ¡ *>(
»ûived_by‹s
), 
»ûived_by‹s_size
,

284 &
tsi_hªdshak”
->
outgošg_by‹s
);

287 ià(!
tsi_hªdshak”
->
outgošg_by‹s
.
	`em±y
()) {

288 *
by‹s_to_£nd
 = 
»š‹½»t_ÿ¡
<const *>(

289 
tsi_hªdshak”
->
outgošg_by‹s
.
	`d©a
());

290 *
by‹s_to_£nd_size
 = 
tsi_hªdshak”
->
outgošg_by‹s
.
	`size
();

293 *
hªdshak”_»suÉ
 = 
nuÎ±r
;

294 
hªdshake_¡•_»suÉ
) {

295 
Ek•Hªdshak”
::
ResuÉ
::
IN_PROGRESS
:

296  
TSI_OK
;

297 
Ek•Hªdshak”
::
ResuÉ
::
NOT_ENOUGH_DATA
:

298  
TSI_INCOMPLETE_DATA
;

299 
Ek•Hªdshak”
::
ResuÉ
::
COMPLETED
: {

301 
StusOr
<
¡d
::
¡ršg
> 
unu£d_by‹s_»suÉ
 = 
hªdshak”
->
	`G‘Unu£dBy‹s
();

302 ià(!
unu£d_by‹s_»suÉ
.
	`ok
()) {

303 
	`g´_log
(

304 
GPR_ERROR
, "Failedo„etrieve unused bytes: %s",

305 
¡d
::
	`¡ršg
(
unu£d_by‹s_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
()).
	`c_¡r
());

306  
TSI_INTERNAL_ERROR
;

309 
StusOr
<
RecÜdPrÙocŞ
> 
»cÜd_´ÙocŞ_»suÉ
 =

310 
hªdshak”
->
	`G‘RecÜdPrÙocŞ
();

311 ià(!
»cÜd_´ÙocŞ_»suÉ
.
	`ok
()) {

312 
	`g´_log
(
GPR_ERROR
, "Failedo„etrieve„ecord…rotocol: %s",

313 
¡d
::
	`¡ršg
(
»cÜd_´ÙocŞ_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
())

314 .
	`c_¡r
());

315  
TSI_INTERNAL_ERROR
;

318 
StusOr
<
CËªsšgVeùÜ
<
ušt8_t
>> 
key_»suÉ
 =

319 
hªdshak”
->
	`G‘RecÜdPrÙocŞKey
();

320 ià(!
key_»suÉ
.
	`ok
()) {

321 
	`g´_log
(
GPR_ERROR
, "Failedo„etrieve„ecord…rotocol key: %s",

322 
¡d
::
	`¡ršg
(
key_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
()).
	`c_¡r
());

323  
TSI_INTERNAL_ERROR
;

326 
StusOr
<
¡d
::
unique_±r
<
EnşaveId’t™›s
>> 
id’t™›s_»suÉ
 =

327 
hªdshak”
->
	`G‘P“rId’t™›s
();

328 ià(!
id’t™›s_»suÉ
.
	`ok
()) {

329 
	`g´_log
(

330 
GPR_ERROR
, "Failedo„etrieve…eer identities: %s",

331 
¡d
::
	`¡ršg
(
id’t™›s_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
()).
	`c_¡r
());

332  
TSI_INTERNAL_ERROR
;

336 
tsi_»suÉ
 
»suÉ
 = 
	`’şave_hªdshak”_»suÉ_ü—‹
(

337 
ab¦
::
make_unique
<
TsiEnşaveHªdshak”ResuÉ
>(

338 
tsi_hªdshak”
->
is_ş›Á
, 
»cÜd_´ÙocŞ_»suÉ
.
	`V®ueOrD›
(),

339 
key_»suÉ
.
	`V®ueOrD›
(),

340 
¡d
::
	`move
(
id’t™›s_»suÉ
).
	`V®ueOrD›
(),

341 
unu£d_by‹s_»suÉ
.
	`V®ueOrD›
()),

342 
hªdshak”_»suÉ
);

343 ià(
»suÉ
 =ğ
TSI_OK
) {

344 
£lf
->
hªdshak”_»suÉ_ü—‹d
 = 
Œue
;

346  
»suÉ
;

348 
Ek•Hªdshak”
::
ResuÉ
::
ABORTED
:

350  
TSI_PROTOCOL_FAILURE
;

352 
	}
}

354 cÚ¡ 
tsi_hªdshak”_vbË
 
	ghªdshak”_vbË
 = {

355 
nuÎ±r
 ,

356 
nuÎ±r
 ,

357 
nuÎ±r
 ,

358 
nuÎ±r
 ,

359 
nuÎ±r
 ,

360 
’şave_hªdshak”_de¡roy
, 
’şave_hªdshak”_Ãxt
,

361 
nuÎ±r
 ,

364 
	gtsi_’şave_hªdshak”
::
tsi_’şave_hªdshak”
(

365 
boŞ
 
is_ş›Á
, 
¡d
::
unique_±r
<
Ek•Hªdshak”
> 
ek•_hªdshak”
)

366 : 
is_ş›Á
(is_ş›Á), 
hªdshak”
(
¡d
::
	$move
(
ek•_hªdshak”
)) {

367 
ba£
.
hªdshak”_»suÉ_ü—‹d
 = 
çl£
;

368 
ba£
.
hªdshake_shutdown
 = 
çl£
;

369 
ba£
.
vbË
 = &
hªdshak”_vbË
;

370 
	}
}

374 
tsi_»suÉ
 
	$tsi_’şave_hªdshak”_ü—‹
(

375 
is_ş›Á
, cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
£lf_as£¹iÚs
,

376 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
acû±ed_³”_as£¹iÚs
,

377 cÚ¡ 
§ã_¡ršg
 *
add™iÚ®_auth’tiÿ‹d_d©a
,

378 
tsi_hªdshak”
 **
hªdshak”
) {

379 
	`GRPC_API_TRACE
(

384 (
is_ş›Á
, 
£lf_as£¹iÚs
, 
acû±ed_³”_as£¹iÚs
,

385 
add™iÚ®_auth’tiÿ‹d_d©a
, 
hªdshak”
));

388 
asylo
::
Ek•Hªdshak”O±iÚs
 
İtiÚs
;

389 
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
 = 
¡d
::
	`¡ršg
(

390 
add™iÚ®_auth’tiÿ‹d_d©a
->
d©a
,‡dd™iÚ®_auth’tiÿ‹d_d©a->
size
);

391 
İtiÚs
.
£lf_as£¹iÚs
 =

392 
asylo
::
	`C»©eAs£¹iÚDesütiÚVeùÜ
(*
£lf_as£¹iÚs
);

393 
İtiÚs
.
acû±ed_³”_as£¹iÚs
 =

394 
asylo
::
	`C»©eAs£¹iÚDesütiÚVeùÜ
(*
acû±ed_³”_as£¹iÚs
);

396 ià(!
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
.
	`em±y
()) {

397 
	`g´_log
(
GPR_DEBUG
, "additional‡uthenticated data: %s",

398 
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
.
	`c_¡r
());

400 cÚ¡ 
asylo
::
As£¹iÚDesütiÚ
 &
desc
 : 
İtiÚs
.
£lf_as£¹iÚs
) {

401 
	`g´_log
(
GPR_DEBUG
, "£làas£¹iÚ: (%s)", 
desc
.
	`ShÜtDebugSŒšg
().
	`c_¡r
());

403 cÚ¡ 
asylo
::
As£¹iÚDesütiÚ
 &
desc
 :

404 
İtiÚs
.
acû±ed_³”_as£¹iÚs
) {

405 
	`g´_log
(
GPR_DEBUG
, "accepted…eer‡ssertion: (%s)",

406 
desc
.
	`ShÜtDebugSŒšg
().
	`c_¡r
());

410 
¡d
::
unique_±r
<
asylo
::
Ek•Hªdshak”
> 
ek•_hªdshak”
 =

411 
is_ş›Á
 ? 
asylo
::
Cl›ÁEk•Hªdshak”
::
	`C»©e
(
İtiÚs
)

412 : 
asylo
::
S”v”Ek•Hªdshak”
::
	`C»©e
(
İtiÚs
);

413 ià(!
ek•_hªdshak”
) {

414  
TSI_INTERNAL_ERROR
;

416 
asylo
::
tsi_’şave_hªdshak”
 *
tsi_hªdshak”
 =

417 
Ãw
 
asylo
::
	`tsi_’şave_hªdshak”
(
is_ş›Á
, 
¡d
::
	`move
(
ek•_hªdshak”
));

419 *
hªdshak”
 = &
tsi_hªdshak”
->
ba£
;

420  
TSI_OK
;

421 
	}
}

	@grpc/auth/core/enclave_transport_security.cc

19 
	~"asylo/g½c/auth/cÜe/’şave_Œª¥Üt_£cur™y.h
"

21 
	~<®gÜ™hm
>

22 
	~<memÜy
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

27 
	~"ab¦/memÜy/memÜy.h
"

28 
	~"asylo/g½c/auth/cÜe/ş›Á_ek•_hªdshak”.h
"

29 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

30 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

31 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

32 
	~"asylo/g½c/auth/cÜe/£rv”_ek•_hªdshak”.h
"

33 
	~"asylo/id’t™y/id’t™y.pb.h
"

34 
	~"asylo/ut/ş—nsšg_ty³s.h
"

35 
	~"asylo/ut/¡©usÜ.h
"

36 
	~"šşude/g½c/suµÜt/log.h
"

37 
	~"¤c/cÜe/lib/g´/¡ršg.h
"

38 
	~"¤c/cÜe/lib/surçû/­i_Œaû.h
"

39 
	~"¤c/cÜe/tsi/®ts/äame_´ÙeùÜ/®ts_äame_´ÙeùÜ.h
"

40 
	~"¤c/cÜe/tsi/Œª¥Üt_£cur™y.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
	gÇme¥aû
 {

45 
cÚ¡ex´
 
	gkEnşaveP“rPrİ”tyCouÁ
 = 3;

48 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
C»©eAs£¹iÚDesütiÚVeùÜ
(

49 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
desütiÚs_¬¿y
) {

50 
¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
desütiÚs_veùÜ
;

51 
	gi
 = 0; i < 
	gdesütiÚs_¬¿y
.
	gcouÁ
; ++i) {

52 
	gdesütiÚs_veùÜ
.
em¶aû_back
();

55 
	gdesütiÚs_veùÜ
.
back
().
£t_id’t™y_ty³
(

56 
¡©ic_ÿ¡
<
EnşaveId’t™yTy³
>(

57 
desütiÚs_¬¿y
.
desütiÚs
[
i
].
id’t™y_ty³
));

60 cÚ¡ 
	g§ã_¡ršg
 &
	gauthÜ™y_ty³_¿w
 =

61 
desütiÚs_¬¿y
.
desütiÚs
[
i
].
authÜ™y_ty³
;

62 
	gdesütiÚs_veùÜ
.
back
().
£t_authÜ™y_ty³
(
authÜ™y_ty³_¿w
.
d©a
,

63 
authÜ™y_ty³_¿w
.
size
);

65  
	gdesütiÚs_veùÜ
;

73 şas 
	cTsiEnşaveHªdshak”ResuÉ
 {

74 
	gpublic
:

75 
TsiEnşaveHªdshak”ResuÉ
(

76 
boŞ
 
is_ş›Á
, 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
,

77 cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
»cÜd_´ÙocŞ_key
,

78 
¡d
::
unique_±r
<
EnşaveId’t™›s
> 
³”_id’t™›s
,

79 
¡d
::
¡ršg
 
unu£d_by‹s
)

80 : 
is_ş›Á_
(
is_ş›Á
),

81 
»cÜd_´ÙocŞ_
(
»cÜd_´ÙocŞ
),

82 
»cÜd_´ÙocŞ_key_
(
»cÜd_´ÙocŞ_key
),

83 
³”_id’t™›s_
(
¡d
::
move
(
³”_id’t™›s
)),

84 
unu£d_by‹s_
(
¡d
::
move
(
unu£d_by‹s
)) {}

89 
tsi_»suÉ
 
C»©eF¿mePrÙeùÜ
(
size_t
 *
max_ouut_´Ùeùed_äame_size
,

90 
tsi_äame_´ÙeùÜ
 **
´ÙeùÜ
) {

91 
	g»cÜd_´ÙocŞ_
) {

92 
	gSEAL_AES128_GCM
:

93  
®ts_ü—‹_äame_´ÙeùÜ
(

94 
»cÜd_´ÙocŞ_key_
.
d©a
(),„ecÜd_´ÙocŞ_key_.
size
(),

95 
is_ş›Á_
, 
çl£
, 
max_ouut_´Ùeùed_äame_size
,

96 
´ÙeùÜ
);

98  
TSI_INTERNAL_ERROR
;

104 
tsi_»suÉ
 
G‘Unu£dBy‹s
(cÚ¡ **
by‹s
, 
size_t
 *
by‹s_size
) {

105 *
	gby‹s_size
 = 
unu£d_by‹s_
.
size
();

106 *
	gby‹s
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
unu£d_by‹s_
.
d©a
());

107  
	gTSI_OK
;

115 
tsi_»suÉ
 
ExŒaùP“r
(
tsi_³”
 *
³”
) {

116 
tsi_»suÉ
 
	g»suÉ
 = 
tsi_cÚ¡ruù_³”
(
kEnşaveP“rPrİ”tyCouÁ
, 
³”
);

117 ià(
	g»suÉ
 !ğ
TSI_OK
) {

118  
»suÉ
;

121 
	g»suÉ
 = 
tsi_cÚ¡ruù_¡ršg_³”_´İ”ty_äom_c¡ršg
(

122 
TSI_CERTIFICATE_TYPE_PEER_PROPERTY
, 
TSI_ENCLAVE_CERTIFICATE_TYPE
,

123 &
³”
->
´İ”t›s
[0]);

124 ià(
	g»suÉ
 !ğ
TSI_OK
) {

125 
tsi_³”_de¡ruù
(
³”
);

126  
	g»suÉ
;

130 
	g¡d
::
¡ršg
 
£rŸlized_id’t™y
;

131 ià(!
	g³”_id’t™›s_
->
S”ŸlizeToSŒšg
(&
£rŸlized_id’t™y
)) {

132 
tsi_³”_de¡ruù
(
³”
);

133  
	gTSI_INTERNAL_ERROR
;

135 
	g»suÉ
 = 
tsi_cÚ¡ruù_¡ršg_³”_´İ”ty
(

136 
TSI_ENCLAVE_IDENTITIES_PROTO_PEER_PROPERTY
, 
£rŸlized_id’t™y
.
d©a
(),

137 
£rŸlized_id’t™y
.
size
(), &
³”
->
´İ”t›s
[1]);

138 ià(
	g»suÉ
 !ğ
TSI_OK
) {

139 
tsi_³”_de¡ruù
(
³”
);

140  
	g»suÉ
;

146 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_»cÜd_´ÙocŞ
((
»cÜd_´ÙocŞ_
));

147 
	ggoogË
::
´Ùobuf
::
io
::
CodedOuutSŒ—m
::
Wr™eL™eEndŸn32ToA¼ay
(

148 
»cÜd_´ÙocŞ_
, 
£rŸlized_»cÜd_´ÙocŞ
.
d©a
());

149 
	g»suÉ
 = 
tsi_cÚ¡ruù_¡ršg_³”_´İ”ty
(

150 
TSI_ENCLAVE_RECORD_PROTOCOL_PEER_PROPERTY
,

151 
»š‹½»t_ÿ¡
<cÚ¡ *>(
£rŸlized_»cÜd_´ÙocŞ
.
d©a
()),

152 
£rŸlized_»cÜd_´ÙocŞ
.
size
(), &
³”
->
´İ”t›s
[2]);

153 ià(
	g»suÉ
 !ğ
TSI_OK
) {

154 
tsi_³”_de¡ruù
(
³”
);

155  
	g»suÉ
;

157  
	g»suÉ
;

160 
	g´iv©e
:

163 
boŞ
 
is_ş›Á_
;

166 
RecÜdPrÙocŞ
 
	g»cÜd_´ÙocŞ_
;

169 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g»cÜd_´ÙocŞ_key_
;

172 
	g¡d
::
unique_±r
<
EnşaveId’t™›s
> 
³”_id’t™›s_
;

175 
	g¡d
::
¡ršg
 
unu£d_by‹s_
;

180 
	stsi_’şave_hªdshak”_»suÉ
 {

181 
tsi_hªdshak”_»suÉ
 
	gba£
;

182 
	g¡d
::
unique_±r
<
TsiEnşaveHªdshak”ResuÉ
> 
im¶
;

185 
tsi_»suÉ
 
	$’şave_hªdshak”_»suÉ_exŒaù_³”
(

186 cÚ¡ 
tsi_hªdshak”_»suÉ
 *
£lf
, 
tsi_³”
 *
³”
) {

187 cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

188 
»š‹½»t_ÿ¡
<cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

190  
»suÉ
->
im¶
->
	`ExŒaùP“r
(
³”
);

191 
	}
}

193 
tsi_»suÉ
 
	$’şave_hªdshak”_»suÉ_ü—‹_äame_´ÙeùÜ
(

194 cÚ¡ 
tsi_hªdshak”_»suÉ
 *
£lf
, 
size_t
 *
max_ouut_´Ùeùed_äame_size
,

195 
tsi_äame_´ÙeùÜ
 **
´ÙeùÜ
) {

196 cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

197 
»š‹½»t_ÿ¡
<cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

199  
»suÉ
->
im¶
->
	`C»©eF¿mePrÙeùÜ
(
max_ouut_´Ùeùed_äame_size
,

200 
´ÙeùÜ
);

201 
	}
}

203 
tsi_»suÉ
 
	$’şave_hªdshak”_»suÉ_g‘_unu£d_by‹s
(

204 cÚ¡ 
tsi_hªdshak”_»suÉ
 *
£lf
, cÚ¡ **
by‹s
,

205 
size_t
 *
by‹s_size
) {

206 cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

207 
»š‹½»t_ÿ¡
<cÚ¡ 
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

209  
»suÉ
->
im¶
->
	`G‘Unu£dBy‹s
(
by‹s
, 
by‹s_size
);

210 
	}
}

212 
	$’şave_hªdshak”_»suÉ_de¡roy
(
tsi_hªdshak”_»suÉ
 *
£lf
) {

213 
tsi_’şave_hªdshak”_»suÉ
 *
»suÉ
 =

214 
»š‹½»t_ÿ¡
<
tsi_’şave_hªdshak”_»suÉ
 *>(
£lf
);

215 
	`d–‘e
 (
»suÉ
);

216 
	}
}

218 cÚ¡ 
tsi_hªdshak”_»suÉ_vbË
 
	ghªdshak”_»suÉ_vbË
 = {

219 
’şave_hªdshak”_»suÉ_exŒaù_³”
,

220 
nuÎ±r
 ,

221 
’şave_hªdshak”_»suÉ_ü—‹_äame_´ÙeùÜ
,

222 
’şave_hªdshak”_»suÉ_g‘_unu£d_by‹s
,

223 
’şave_hªdshak”_»suÉ_de¡roy
,

226 
tsi_»suÉ
 
’şave_hªdshak”_»suÉ_ü—‹
(

227 
¡d
::
unique_±r
<
TsiEnşaveHªdshak”ResuÉ
> 
im¶
,

228 
tsi_hªdshak”_»suÉ
 **
hªdshak”_»suÉ
) {

229 ià(!
	gim¶
 || !
	ghªdshak”_»suÉ
) {

230  
	gTSI_INVALID_ARGUMENT
;

233 
tsi_’şave_hªdshak”_»suÉ
 *
	g»suÉ
 = 
Ãw
si_enclave_handshaker_result();

234 
	g»suÉ
->
	gba£
.
	gvbË
 = &
hªdshak”_»suÉ_vbË
;

235 
	g»suÉ
->
	gim¶
 = 
¡d
::
move
(
im¶
);

237 *
	ghªdshak”_»suÉ
 = &
»suÉ
->
ba£
;

238  
	gTSI_OK
;

245 
	stsi_’şave_hªdshak”
 {

246 
tsi_hªdshak”
 
	gba£
;

247 
boŞ
 
	gis_ş›Á
;

248 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
hªdshak”
;

249 
	g¡d
::
¡ršg
 
outgošg_by‹s
;

251 
tsi_’şave_hªdshak”
(
boŞ
 
is_ş›Á
,

252 
¡d
::
unique_±r
<
Ek•Hªdshak”
> 
ek•_hªdshak”
);

255 
	$’şave_hªdshak”_de¡roy
(
tsi_hªdshak”
 *
£lf
) {

256 
tsi_’şave_hªdshak”
 *
im¶
 =

257 
»š‹½»t_ÿ¡
<
tsi_’şave_hªdshak”
 *>(
£lf
);

258 
	`d–‘e
 (
im¶
);

259 
	}
}

261 
tsi_»suÉ
 
	$’şave_hªdshak”_Ãxt
(

262 
tsi_hªdshak”
 *
£lf
, cÚ¡ *
»ûived_by‹s
,

263 
size_t
 
»ûived_by‹s_size
, cÚ¡ **
by‹s_to_£nd
,

264 
size_t
 *
by‹s_to_£nd_size
, 
tsi_hªdshak”_»suÉ
 **
hªdshak”_»suÉ
,

265 
tsi_hªdshak”_Ú_Ãxt_dÚe_cb
 
cb
, *
u£r_d©a
) {

266 ià((
»ûived_by‹s_size
 > 0 && !
»ûived_by‹s
è|| !
by‹s_to_£nd
 ||

267 !
by‹s_to_£nd_size
 || !
hªdshak”_»suÉ
) {

268  
TSI_INVALID_ARGUMENT
;

270 
	`g´_log
(
GPR_INFO
,

274 
£lf
, 
»ûived_by‹s
, 
»ûived_by‹s_size
, 
by‹s_to_£nd
,

275 
by‹s_to_£nd_size
, 
hªdshak”_»suÉ
, 
cb
, 
u£r_d©a
);

277 
tsi_’şave_hªdshak”
 *
tsi_hªdshak”
 =

278 
»š‹½»t_ÿ¡
<
tsi_’şave_hªdshak”
 *>(
£lf
);

279 
Ek•Hªdshak”
 *
hªdshak”
 = 
tsi_hªdshak”
->hªdshak”.
	`g‘
();

282 
Ek•Hªdshak”
::
ResuÉ
 
hªdshake_¡•_»suÉ
 = 
hªdshak”
->
	`NextHªdshakeS‹p
(

283 
»š‹½»t_ÿ¡
<cÚ¡ *>(
»ûived_by‹s
), 
»ûived_by‹s_size
,

284 &
tsi_hªdshak”
->
outgošg_by‹s
);

287 ià(!
tsi_hªdshak”
->
outgošg_by‹s
.
	`em±y
()) {

288 *
by‹s_to_£nd
 = 
»š‹½»t_ÿ¡
<const *>(

289 
tsi_hªdshak”
->
outgošg_by‹s
.
	`d©a
());

290 *
by‹s_to_£nd_size
 = 
tsi_hªdshak”
->
outgošg_by‹s
.
	`size
();

293 *
hªdshak”_»suÉ
 = 
nuÎ±r
;

294 
hªdshake_¡•_»suÉ
) {

295 
Ek•Hªdshak”
::
ResuÉ
::
IN_PROGRESS
:

296  
TSI_OK
;

297 
Ek•Hªdshak”
::
ResuÉ
::
NOT_ENOUGH_DATA
:

298  
TSI_INCOMPLETE_DATA
;

299 
Ek•Hªdshak”
::
ResuÉ
::
COMPLETED
: {

301 
StusOr
<
¡d
::
¡ršg
> 
unu£d_by‹s_»suÉ
 = 
hªdshak”
->
	`G‘Unu£dBy‹s
();

302 ià(!
unu£d_by‹s_»suÉ
.
	`ok
()) {

303 
	`g´_log
(

304 
GPR_ERROR
, "Failedo„etrieve unused bytes: %s",

305 
¡d
::
	`¡ršg
(
unu£d_by‹s_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
()).
	`c_¡r
());

306  
TSI_INTERNAL_ERROR
;

309 
StusOr
<
RecÜdPrÙocŞ
> 
»cÜd_´ÙocŞ_»suÉ
 =

310 
hªdshak”
->
	`G‘RecÜdPrÙocŞ
();

311 ià(!
»cÜd_´ÙocŞ_»suÉ
.
	`ok
()) {

312 
	`g´_log
(
GPR_ERROR
, "Failedo„etrieve„ecord…rotocol: %s",

313 
¡d
::
	`¡ršg
(
»cÜd_´ÙocŞ_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
())

314 .
	`c_¡r
());

315  
TSI_INTERNAL_ERROR
;

318 
StusOr
<
CËªsšgVeùÜ
<
ušt8_t
>> 
key_»suÉ
 =

319 
hªdshak”
->
	`G‘RecÜdPrÙocŞKey
();

320 ià(!
key_»suÉ
.
	`ok
()) {

321 
	`g´_log
(
GPR_ERROR
, "Failedo„etrieve„ecord…rotocol key: %s",

322 
¡d
::
	`¡ršg
(
key_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
()).
	`c_¡r
());

323  
TSI_INTERNAL_ERROR
;

326 
StusOr
<
¡d
::
unique_±r
<
EnşaveId’t™›s
>> 
id’t™›s_»suÉ
 =

327 
hªdshak”
->
	`G‘P“rId’t™›s
();

328 ià(!
id’t™›s_»suÉ
.
	`ok
()) {

329 
	`g´_log
(

330 
GPR_ERROR
, "Failedo„etrieve…eer identities: %s",

331 
¡d
::
	`¡ršg
(
id’t™›s_»suÉ
.
	`¡©us
().
	`”rÜ_mes§ge
()).
	`c_¡r
());

332  
TSI_INTERNAL_ERROR
;

336 
tsi_»suÉ
 
»suÉ
 = 
	`’şave_hªdshak”_»suÉ_ü—‹
(

337 
ab¦
::
make_unique
<
TsiEnşaveHªdshak”ResuÉ
>(

338 
tsi_hªdshak”
->
is_ş›Á
, 
»cÜd_´ÙocŞ_»suÉ
.
	`V®ueOrD›
(),

339 
key_»suÉ
.
	`V®ueOrD›
(),

340 
¡d
::
	`move
(
id’t™›s_»suÉ
).
	`V®ueOrD›
(),

341 
unu£d_by‹s_»suÉ
.
	`V®ueOrD›
()),

342 
hªdshak”_»suÉ
);

343 ià(
»suÉ
 =ğ
TSI_OK
) {

344 
£lf
->
hªdshak”_»suÉ_ü—‹d
 = 
Œue
;

346  
»suÉ
;

348 
Ek•Hªdshak”
::
ResuÉ
::
ABORTED
:

350  
TSI_PROTOCOL_FAILURE
;

352 
	}
}

354 cÚ¡ 
tsi_hªdshak”_vbË
 
	ghªdshak”_vbË
 = {

355 
nuÎ±r
 ,

356 
nuÎ±r
 ,

357 
nuÎ±r
 ,

358 
nuÎ±r
 ,

359 
nuÎ±r
 ,

360 
’şave_hªdshak”_de¡roy
, 
’şave_hªdshak”_Ãxt
,

361 
nuÎ±r
 ,

364 
	gtsi_’şave_hªdshak”
::
tsi_’şave_hªdshak”
(

365 
boŞ
 
is_ş›Á
, 
¡d
::
unique_±r
<
Ek•Hªdshak”
> 
ek•_hªdshak”
)

366 : 
is_ş›Á
(is_ş›Á), 
hªdshak”
(
¡d
::
	$move
(
ek•_hªdshak”
)) {

367 
ba£
.
hªdshak”_»suÉ_ü—‹d
 = 
çl£
;

368 
ba£
.
hªdshake_shutdown
 = 
çl£
;

369 
ba£
.
vbË
 = &
hªdshak”_vbË
;

370 
	}
}

374 
tsi_»suÉ
 
	$tsi_’şave_hªdshak”_ü—‹
(

375 
is_ş›Á
, cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
£lf_as£¹iÚs
,

376 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
acû±ed_³”_as£¹iÚs
,

377 cÚ¡ 
§ã_¡ršg
 *
add™iÚ®_auth’tiÿ‹d_d©a
,

378 
tsi_hªdshak”
 **
hªdshak”
) {

379 
	`GRPC_API_TRACE
(

384 (
is_ş›Á
, 
£lf_as£¹iÚs
, 
acû±ed_³”_as£¹iÚs
,

385 
add™iÚ®_auth’tiÿ‹d_d©a
, 
hªdshak”
));

388 
asylo
::
Ek•Hªdshak”O±iÚs
 
İtiÚs
;

389 
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
 = 
¡d
::
	`¡ršg
(

390 
add™iÚ®_auth’tiÿ‹d_d©a
->
d©a
,‡dd™iÚ®_auth’tiÿ‹d_d©a->
size
);

391 
İtiÚs
.
£lf_as£¹iÚs
 =

392 
asylo
::
	`C»©eAs£¹iÚDesütiÚVeùÜ
(*
£lf_as£¹iÚs
);

393 
İtiÚs
.
acû±ed_³”_as£¹iÚs
 =

394 
asylo
::
	`C»©eAs£¹iÚDesütiÚVeùÜ
(*
acû±ed_³”_as£¹iÚs
);

396 ià(!
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
.
	`em±y
()) {

397 
	`g´_log
(
GPR_DEBUG
, "additional‡uthenticated data: %s",

398 
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
.
	`c_¡r
());

400 cÚ¡ 
asylo
::
As£¹iÚDesütiÚ
 &
desc
 : 
İtiÚs
.
£lf_as£¹iÚs
) {

401 
	`g´_log
(
GPR_DEBUG
, "£làas£¹iÚ: (%s)", 
desc
.
	`ShÜtDebugSŒšg
().
	`c_¡r
());

403 cÚ¡ 
asylo
::
As£¹iÚDesütiÚ
 &
desc
 :

404 
İtiÚs
.
acû±ed_³”_as£¹iÚs
) {

405 
	`g´_log
(
GPR_DEBUG
, "accepted…eer‡ssertion: (%s)",

406 
desc
.
	`ShÜtDebugSŒšg
().
	`c_¡r
());

410 
¡d
::
unique_±r
<
asylo
::
Ek•Hªdshak”
> 
ek•_hªdshak”
 =

411 
is_ş›Á
 ? 
asylo
::
Cl›ÁEk•Hªdshak”
::
	`C»©e
(
İtiÚs
)

412 : 
asylo
::
S”v”Ek•Hªdshak”
::
	`C»©e
(
İtiÚs
);

413 ià(!
ek•_hªdshak”
) {

414  
TSI_INTERNAL_ERROR
;

416 
asylo
::
tsi_’şave_hªdshak”
 *
tsi_hªdshak”
 =

417 
Ãw
 
asylo
::
	`tsi_’şave_hªdshak”
(
is_ş›Á
, 
¡d
::
	`move
(
ek•_hªdshak”
));

419 *
hªdshak”
 = &
tsi_hªdshak”
->
ba£
;

420  
TSI_OK
;

421 
	}
}

	@grpc/auth/core/enclave_transport_security.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_ENCLAVE_TRANSPORT_SECURITY_H_


20 
	#ASYLO_GRPC_AUTH_CORE_ENCLAVE_TRANSPORT_SECURITY_H_


	)

22 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

23 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

24 
	~"¤c/cÜe/tsi/Œª¥Üt_£cur™y_š‹rçû.h
"

28 
	#TSI_ENCLAVE_CERTIFICATE_TYPE
 "’şave_£cur™y"

	)

31 
	#TSI_ENCLAVE_IDENTITIES_PROTO_PEER_PROPERTY
 \

32 "’şave_£cur™y_id’t™y_´Ùo"

	)

33 
	#TSI_ENCLAVE_RECORD_PROTOCOL_PEER_PROPERTY
 \

34 "’şave_£cur™y_»cÜd_´ÙocŞ"

	)

45 
tsi_»suÉ
 
tsi_’şave_hªdshak”_ü—‹
(

46 
is_ş›Á
, cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
£lf_as£¹iÚs
,

47 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 *
acû±ed_³”_as£¹iÚs
,

48 cÚ¡ 
§ã_¡ršg
 *
add™iÚ®_auth’tiÿ‹d_d©a
,

49 
tsi_hªdshak”
 **
hªdshak”
);

	@grpc/auth/core/server_ekep_handshaker.cc

19 
	~"asylo/g½c/auth/cÜe/£rv”_ek•_hªdshak”.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/¿nd.h
>

24 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/üy±o/sha256_hash.h
"

27 
	~"asylo/ut/loggšg.h
"

28 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

29 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

30 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

31 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

32 
	~"asylo/id’t™y/id’t™y.pb.h
"

33 
	~"asylo/ut/ş—nsšg_ty³s.h
"

34 
	~"asylo/ut/¡©us_maüos.h
"

36 
Çme¥aû
 
	gasylo
 {

37 
	gÇme¥aû
 {

40 
boŞ
 
CheckEk•V”siÚEqu®™y
(cÚ¡ 
Ek•V”siÚ
 &
ek•_v”siÚ
,

41 cÚ¡ 
¡d
::
¡ršg
 &
v”siÚ_Çme
) {

42  
ek•_v”siÚ
.
Çme
(è=ğ
v”siÚ_Çme
;

47 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
S”v”Ek•Hªdshak”
::
C»©e
(

48 cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
) {

49 
Stus
 
¡©us
 = 
İtiÚs
.
V®id©e
();

50 ià(!
	g¡©us
.
ok
()) {

51 
LOG
(
ERROR
è<< "Inv®id hªdshak” o±iÚs: " << 
	g¡©us
;

52  
	gnuÎ±r
;

54  
	gab¦
::
W¿pUnique
(
Ãw
 
S”v”Ek•Hªdshak”
(
İtiÚs
));

57 
	gS”v”Ek•Hªdshak”
::
S”v”Ek•Hªdshak”
(cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
)

58 : 
Ek•Hªdshak”
(
İtiÚs
.
max_äame_size
),

59 
£lf_as£¹iÚs_
(
İtiÚs
.
£lf_as£¹iÚs
),

60 
acû±ed_³”_as£¹iÚs_
(
İtiÚs
.
acû±ed_³”_as£¹iÚs
),

61 
avaabË_ch”_su™es_
({
CURVE25519_SHA256
}),

62 
avaabË_»cÜd_´ÙocŞs_
({
SEAL_AES128_GCM
}),

63 
avaabË_ek•_v”siÚs_
({"EKEP v1"}),

64 
add™iÚ®_auth’tiÿ‹d_d©a_
(
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
),

65 
£Ëùed_ch”_su™e_
(
UNKNOWN_HANDSHAKE_CIPHER
),

66 
£Ëùed_»cÜd_´ÙocŞ_
(
UNKNOWN_RECORD_PROTOCOL
),

67 
ex³ùed_mes§ge_ty³_
(
CLIENT_PRECOMMIT
),

70 
hªdshak”_¡©e_
(
Ek•Hªdshak”
::
HªdshakeS‹
::
IN_PROGRESS
) {}

72 
boŞ
 
S”v”Ek•Hªdshak”
::
IsHªdshakeInProg»ss
() const {

73  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
IN_PROGRESS
;

76 
boŞ
 
	gS”v”Ek•Hªdshak”
::
IsHªdshakeCom¶‘ed
() const {

77  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
COMPLETED
;

80 
boŞ
 
	gS”v”Ek•Hªdshak”
::
IsHªdshakeAbÜ‹d
() const {

81  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
ABORTED
;

84 
HªdshakeMes§geTy³
 
	gS”v”Ek•Hªdshak”
::
G‘Ex³ùedMes§geTy³
() const {

85 ià(!
IsHªdshakeInProg»ss
()) {

86  
UNKNOWN_HANDSHAKE_MESSAGE
;

88  
	gex³ùed_mes§ge_ty³_
;

91 
	gS”v”Ek•Hªdshak”
::
ResuÉ
 
S”v”Ek•Hªdshak”
::
S¹Hªdshake
(

92 
¡d
::
¡ršg
 *
ouut
) {

93 
LOG
(
DFATAL
) << "StartHandshake() was called on‡ ServerEkepHandshaker";

94 
AbÜtHªdshake
(
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

96 
ouut
);

97  
	gResuÉ
::
ABORTED
;

100 
	gS”v”Ek•Hªdshak”
::
AbÜtHªdshake
(cÚ¡ 
Stus
 &
abÜt_¡©us
,

101 
¡d
::
¡ršg
 *
ouut
) {

102 
AbÜt_E¼ÜCode
 
”rÜ_code
 =

103 
¡©ic_ÿ¡
<
AbÜt_E¼ÜCode
>(
abÜt_¡©us
.
”rÜ_code
());

104 
LOG
(
ERROR
è<< 
	gabÜt_¡©us
;

106 
AbÜt
 
	gabÜt
;

107 
	gabÜt
.
£t_code
(
”rÜ_code
);

108 
	gabÜt
.
£t_mes§ge
(
¡d
::
¡ršg
(
abÜt_¡©us
.
”rÜ_mes§ge
().
d©a
(),

109 
abÜt_¡©us
.
”rÜ_mes§ge
().
size
()));

111 
	ggoogË
::
´Ùobuf
::
io
::
SŒšgOuutSŒ—m
 
outgošg_äame
(
ouut
);

112 
Stus
 
	g¡©us
 = 
EncodeF¿me
(
ABORT
, 
abÜt
, &
outgošg_äame
);

113 ià(!
	g¡©us
.
ok
()) {

116 
LOG
(
ERROR
è<< "Encodšg oàABORT mes§gçed: " << 
	g¡©us
;

119 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

122 
	gS”v”Ek•Hªdshak”
::
ResuÉ
 
S”v”Ek•Hªdshak”
::
HªdËHªdshakeMes§ge
(

123 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

124 
¡d
::
¡ršg
 *
ouut
) {

125 
Stus
 
¡©us
 = Stus::
OkStus
();

127 
	gmes§ge_ty³
) {

128 
	gCLIENT_PRECOMMIT
:

129 
ex³ùed_mes§ge_ty³_
 = 
CLIENT_ID
;

130 
	g¡©us
 = 
HªdËCl›ÁP»comm™
(
hªdshake_mes§ge
, 
ouut
);

132 
	gCLIENT_ID
:

133 
ex³ùed_mes§ge_ty³_
 = 
CLIENT_FINISH
;

134 
	g¡©us
 = 
HªdËCl›ÁId
(
hªdshake_mes§ge
, 
ouut
);

136 
	gCLIENT_FINISH
:

137 
ex³ùed_mes§ge_ty³_
 = 
UNKNOWN_HANDSHAKE_MESSAGE
;

138 
	g¡©us
 = 
HªdËCl›ÁFšish
(
hªdshake_mes§ge
);

139 ià(
	g¡©us
.
ok
()) {

140 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
COMPLETED
;

146 
¡©us
 = 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

149 ià(!
	g¡©us
.
ok
()) {

150 ià(
	gmes§ge_ty³
 !ğ
CLIENT_FINISH
) {

152 
AbÜtHªdshake
(
¡©us
, 
ouut
);

154 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

160 ià(
IsHªdshakeCom¶‘ed
()) {

161 ià(!
D”iveAndS‘RecÜdPrÙocŞKey
(

162 
£Ëùed_ch”_su™e_
, 
£Ëùed_»cÜd_´ÙocŞ_
, 
ma¡”_£ü‘_
)

163 .
ok
()) {

164 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

168 
	ghªdshak”_¡©e_
) {

169 
	gHªdshakeS‹
::
COMPLETED
:

170  
ResuÉ
::
COMPLETED
;

171 
	gHªdshakeS‹
::
IN_PROGRESS
:

172  
ResuÉ
::
IN_PROGRESS
;

174  
ResuÉ
::
ABORTED
;

178 
	gS”v”Ek•Hªdshak”
::
HªdËAbÜtMes§ge
(cÚ¡ 
AbÜt
 *
abÜt_mes§ge
) {

179 ià(
abÜt_mes§ge
) {

180 
LOG
(
ERROR
è<< "Reûived " << 
AbÜt_E¼ÜCode_Name
(
abÜt_mes§ge
->
code
())

181 << " from cl›Á: " << 
abÜt_mes§ge
->
mes§ge
();

184 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

187 
Stus
 
	gS”v”Ek•Hªdshak”
::
HªdËCl›ÁP»comm™
(

188 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
, 
¡d
::
¡ršg
 *
ouut
) {

189 cÚ¡‡utØ*
ş›Á_´ecomm™_±r
 =

190 
dyÇmic_ÿ¡
<cÚ¡ 
Cl›ÁP»comm™
 *>(&
mes§ge
);

191 ià(!
	gş›Á_´ecomm™_±r
) {

192 
LOG
(
QFATAL
) << "HandleClientPrecommit() was…assed‡‚on-ClientPrecommit "

194  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

196 cÚ¡ 
	gCl›ÁP»comm™
 &
	gş›Á_´ecomm™
 = *
ş›Á_´ecomm™_±r
;

199 ià(!
S‘S–eùedEk•V”siÚ
(
ş›Á_´ecomm™
.
avaabË_ek•_v”siÚs
())) {

200  
Stus
(
AbÜt_E¼ÜCode_BAD_PROTOCOL_VERSION
,

205 ià(!
S‘S–eùedCh”Su™e
(
ş›Á_´ecomm™
.
avaabË_ch”_su™es
())) {

206  
Stus
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

211 
	g£Ëùed_ch”_su™e_
) {

212 
	gCURVE25519_SHA256
:

213 
S‘T¿nsütHashFunùiÚ
(
Ãw
 
Sha256Hash
());

216 
LOG
(
ERROR
) << "Server handshaker has bad cipher suite configuration"

217 << 
HªdshakeCh”_Name
(
£Ëùed_ch”_su™e_
);

218  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

223 ià(!
S‘S–eùedRecÜdPrÙocŞ
(

224 
ş›Á_´ecomm™
.
avaabË_»cÜd_´ÙocŞs
())) {

225  
Stus
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
,

230 ià(
	gş›Á_´ecomm™
.
ch®Ënge
().
size
(è!ğ
kEk•Ch®ËngeSize
) {

231  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

235 cÚ¡ 
	gAs£¹iÚOfãr
 &
	gofãr
 : 
ş›Á_´ecomm™
.
ş›Á_ofãrs
()) {

236 cÚ¡ 
As£¹iÚDesütiÚ
 &
ofãr_desc
 = 
ofãr
.
desütiÚ
();

239 ià(
FšdAs£¹iÚDesütiÚ
(
acû±ed_³”_as£¹iÚs_
, 
ofãr_desc
) !=

240 
acû±ed_³”_as£¹iÚs_
.
ûnd
()) {

241 autØ
»suÉ
 = 
G‘EnşaveAs£¹iÚV”if›r
(
ofãr_desc
)->
CªV”ify
(
ofãr
);

242 ià(
	g»suÉ
.
ok
(è&&„esuÉ.
V®ueOrD›
()) {

243 
	gex³ùed_³”_as£¹iÚs_
.
push_back
(
ofãr_desc
);

247 ià(
	gex³ùed_³”_as£¹iÚs_
.
em±y
()) {

248  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION_TYPE
,

252 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
ş›Á_´ecomm™
.
ş›Á_»que¡s
()) {

253 cÚ¡ 
As£¹iÚDesütiÚ
 &
»que¡_desc
 = 
»que¡
.
desütiÚ
();

258 ià(
FšdAs£¹iÚDesütiÚ
(
£lf_as£¹iÚs_
, 
»que¡_desc
) !=

259 
£lf_as£¹iÚs_
.
ûnd
()) {

260 autØ
»suÉ
 =

261 
G‘EnşaveAs£¹iÚG’”©Ü
(
»que¡_desc
)->
CªG’”©e
(
»que¡
);

262 ià(
	g»suÉ
.
ok
(è&&„esuÉ.
V®ueOrD›
()) {

263 
	g´omi£d_as£¹iÚs_
.
push_back
(
»que¡
);

267 ià(
	g´omi£d_as£¹iÚs_
.
em±y
()) {

268  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION_TYPE
,

272  
Wr™eS”v”P»comm™
(
ouut
);

275 
Stus
 
	gS”v”Ek•Hªdshak”
::
HªdËCl›ÁId
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
,

276 
¡d
::
¡ršg
 *
ouut
) {

277 cÚ¡‡utØ*
ş›Á_id_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
Cl›ÁId
 *>(&
mes§ge
);

278 ià(!
	gş›Á_id_±r
) {

279 
LOG
(
QFATAL
) << "HandleClientId() was…assed‡‚on-ClientId handshake "

281  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

283 cÚ¡ 
	gCl›ÁId
 &
	gş›Á_id
 = *
ş›Á_id_±r
;

288 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

289 ià(!
MakeEk•CÚ‹xtBlob
(
ş›Á_id
.
dh_public_key
(),

290 
ş›Á_as£¹iÚ_Œªsüt_
, &
ek•_cÚ‹xt
)) {

291  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Failedo generate context");

294 cÚ¡ 
	gAs£¹iÚ
 &
	gas£¹iÚ
 : 
ş›Á_id
.
as£¹iÚs
()) {

295 autØ
desc_™
 = 
FšdAs£¹iÚDesütiÚ
(
ex³ùed_³”_as£¹iÚs_
,

296 
as£¹iÚ
.
desütiÚ
());

297 ià(
	gdesc_™
 =ğ
ex³ùed_³”_as£¹iÚs_
.
ûnd
()) {

298  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

303 
EnşaveId’t™y
 
	gid’t™y
;

307 
Stus
 
	g¡©us
 = 
G‘EnşaveAs£¹iÚV”if›r
(
as£¹iÚ
.
desütiÚ
())

308 ->
V”ify
(
ek•_cÚ‹xt
, 
as£¹iÚ
, &
id’t™y
);

309 ià(!
	g¡©us
.
ok
()) {

310 
LOG
(
ERROR
è<< "As£¹iÚ could‚Ù bv”if›d: " << 
	g¡©us
;

311  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

314 
AddP“rId’t™y
(
id’t™y
);

315 
	gex³ùed_³”_as£¹iÚs_
.
”a£
(
desc_™
);

318 ià(!
	gex³ùed_³”_as£¹iÚs_
.
em±y
()) {

320  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

324 
	g¡d
::
cİy
(
ş›Á_id
.
dh_public_key
().
cbegš
(),

325 
ş›Á_id
.
dh_public_key
().
ûnd
(),

326 
¡d
::
back_š£¹”
(
ş›Á_public_key_
));

328  
Wr™eS”v”Id
(
ouut
);

331 
Stus
 
	gS”v”Ek•Hªdshak”
::
HªdËCl›ÁFšish
(

332 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
) {

333 cÚ¡‡utØ*
ş›Á_fšish_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
Cl›ÁFšish
 *>(&
mes§ge
);

334 ià(!
	gş›Á_fšish_±r
) {

335 
LOG
(
DFATAL
) << "HandleClientFinish() was…assed‡‚on-ClientFinish "

337  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

339 cÚ¡ 
	gCl›ÁFšish
 &
	gş›Á_fšish
 = *
ş›Á_fšish_±r
;

341 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gaùu®_ş›Á_hªdshake_auth’tiÿtÜ
;

342 
	g¡d
::
cİy
(
ş›Á_fšish
.
hªdshake_auth’tiÿtÜ
().
cbegš
(),

343 
ş›Á_fšish
.
hªdshake_auth’tiÿtÜ
().
ûnd
(),

344 
¡d
::
back_š£¹”
(
aùu®_ş›Á_hªdshake_auth’tiÿtÜ
));

347 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gex³ùed_ş›Á_hªdshake_auth’tiÿtÜ
;

348 
ASYLO_RETURN_IF_ERROR
(
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

349 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
,

350 &
ex³ùed_ş›Á_hªdshake_auth’tiÿtÜ
));

353 ià(!
CheckMacEqu®™y
(
ex³ùed_ş›Á_hªdshake_auth’tiÿtÜ
,

354 
aùu®_ş›Á_hªdshake_auth’tiÿtÜ
)) {

355  
Stus
(
AbÜt_E¼ÜCode_BAD_AUTHENTICATOR
,

358  
	gStus
::
OkStus
();

361 
Stus
 
	gS”v”Ek•Hªdshak”
::
Wr™eS”v”P»comm™
(
¡d
::
¡ršg
 *
ouut
) {

362 
S”v”P»comm™
 
£rv”_´ecomm™
;

364 
	g£rv”_´ecomm™
.
mubË_£Ëùed_ek•_v”siÚ
()->
£t_Çme
(

365 
£Ëùed_ek•_v”siÚ_
);

366 
	g£rv”_´ecomm™
.
£t_£Ëùed_ch”_su™e
(
£Ëùed_ch”_su™e_
);

367 
	g£rv”_´ecomm™
.
£t_£Ëùed_»cÜd_´ÙocŞ
(
£Ëùed_»cÜd_´ÙocŞ_
);

369 ià(!
	gadd™iÚ®_auth’tiÿ‹d_d©a_
.
em±y
()) {

370 
	g£rv”_´ecomm™
.
mubË_İtiÚs
()->
£t_d©a
(

371 
add™iÚ®_auth’tiÿ‹d_d©a_
);

374 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch®Ënge
(
kEk•Ch®ËngeSize
);

375 ià(
RAND_by‹s
(
ch®Ënge
.
d©a
(), 
kEk•Ch®ËngeSize
) != 1) {

376  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

378 
	g£rv”_´ecomm™
.
£t_ch®Ënge
(
ch®Ënge
.
d©a
(), ch®Ënge.
size
());

380 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
´omi£d_as£¹iÚs_
) {

381 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
 = 
»que¡
.description();

385 
G‘EnşaveAs£¹iÚG’”©Ü
(
desütiÚ
)

386 ->
C»©eAs£¹iÚOfãr
(
£rv”_´ecomm™
.
add_£rv”_ofãrs
());

389 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
ex³ùed_³”_as£¹iÚs_
) {

393 
G‘EnşaveAs£¹iÚV”if›r
(
desütiÚ
)

394 ->
C»©eAs£¹iÚReque¡
(
£rv”_´ecomm™
.
add_£rv”_»que¡s
());

397 
ASYLO_RETURN_IF_ERROR
(
Wr™eF¿meAndUpd©eT¿nsüt
(

398 
SERVER_PRECOMMIT
, 
£rv”_´ecomm™
, 
ouut
));

405  
G‘T¿nsütHash
(&
ş›Á_as£¹iÚ_Œªsüt_
);

408 
Stus
 
	gS”v”Ek•Hªdshak”
::
Wr™eS”v”Id
(
¡d
::
¡ršg
 *
ouut
) {

411 
£Ëùed_ch”_su™e_
) {

412 
CURVE25519_SHA256
:

413 
dh_public_key_
.
»size
(
X25519_PUBLIC_VALUE_LEN
);

414 
	gdh_´iv©e_key_
.
»size
(
X25519_PRIVATE_KEY_LEN
);

415 
X25519_key·œ
(
dh_public_key_
.
d©a
(), 
dh_´iv©e_key_
.data());

418 
LOG
(
ERROR
) << "Server handshaker has bad cipher suite configuration";

419  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

423 
S”v”Id
 
	g£rv”_id
;

424 
	g£rv”_id
.
£t_dh_public_key
(
dh_public_key_
.
d©a
(), dh_public_key_.
size
());

426 
	g¡d
::
¡ršg
 
public_key
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
dh_public_key_
.
d©a
()),

427 
dh_public_key_
.
size
());

433 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

434 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

438 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

439 ià(!
MakeEk•CÚ‹xtBlob
(
public_key
, 
Œªsüt_hash
, &
ek•_cÚ‹xt
)) {

440  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

446 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
´omi£d_as£¹iÚs_
) {

450 
Stus
 
¡©us
 =

451 
G‘EnşaveAs£¹iÚG’”©Ü
(
»que¡
.
desütiÚ
())

452 ->
G’”©e
(
ek•_cÚ‹xt
, 
»que¡
, 
£rv”_id
.
add_as£¹iÚs
());

453 ià(!
	g¡©us
.
ok
()) {

454 
LOG
(
ERROR
è<< "As£¹iÚ g’”©iÚ faed: " << 
	g¡©us
;

455  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

460 
ASYLO_RETURN_IF_ERROR
(

461 
Wr™eF¿meAndUpd©eT¿nsüt
(
SERVER_ID
, 
£rv”_id
, 
ouut
));

463  
Wr™eS”v”Fšish
(
ouut
);

466 
Stus
 
	gS”v”Ek•Hªdshak”
::
Wr™eS”v”Fšish
(
¡d
::
¡ršg
 *
ouut
) {

472 
¡d
::
¡ršg
 
Œªsüt_hash
;

473 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

475 
ASYLO_RETURN_IF_ERROR
(
D”iveSeü‘s
(
£Ëùed_ch”_su™e_
, 
Œªsüt_hash
,

476 
ş›Á_public_key_
, 
dh_´iv©e_key_
,

477 &
ma¡”_£ü‘_
, &
auth’tiÿtÜ_£ü‘_
));

479 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

480 
ASYLO_RETURN_IF_ERROR
(
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

481 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
, &
auth’tiÿtÜ
));

483 
S”v”Fšish
 
	g£rv”_fšish
;

484 
	g£rv”_fšish
.
£t_hªdshake_auth’tiÿtÜ
(
auth’tiÿtÜ
.
d©a
(),

485 
auth’tiÿtÜ
.
size
());

487  
Wr™eF¿meAndUpd©eT¿nsüt
(
SERVER_FINISH
, 
£rv”_fšish
, 
ouut
);

490 
boŞ
 
	gS”v”Ek•Hªdshak”
::
S‘S–eùedEk•V”siÚ
(

491 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
Ek•V”siÚ
> &
ek•_v”siÚs
) {

493 autØ
v”siÚ_™
 = 
¡d
::
fšd_fœ¡_of
(

494 
ek•_v”siÚs
.
cbegš
(),ƒk•_v”siÚs.
ûnd
(),

495 
avaabË_ek•_v”siÚs_
.
cbegš
(),‡vaabË_ek•_v”siÚs_.
ûnd
(),

496 
CheckEk•V”siÚEqu®™y
);

497 ià(
	gv”siÚ_™
 =ğ
ek•_v”siÚs
.
ûnd
()) {

498  
çl£
;

501 
	g£Ëùed_ek•_v”siÚ_
 = 
v”siÚ_™
->
Çme
();

502  
	gŒue
;

505 
boŞ
 
	gS”v”Ek•Hªdshak”
::
S‘S–eùedCh”Su™e
(

506 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
ch”_su™es
) {

508 autØ
ch”_™
 = 
¡d
::
fšd_fœ¡_of
(

509 
ch”_su™es
.
cbegš
(), ch”_su™es.
ûnd
(),

510 
avaabË_ch”_su™es_
.
cbegš
(),‡vaabË_ch”_su™es_.
ûnd
());

511 ià(
	gch”_™
 =ğ
ch”_su™es
.
ûnd
()) {

512  
çl£
;

515 
	g£Ëùed_ch”_su™e_
 = 
¡©ic_ÿ¡
<
HªdshakeCh”
>(*
ch”_™
);

516  
	gŒue
;

519 
boŞ
 
	gS”v”Ek•Hªdshak”
::
S‘S–eùedRecÜdPrÙocŞ
(

520 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
»cÜd_´ÙocŞs
) {

522 autØ
´ÙocŞ_™
 = 
¡d
::
fšd_fœ¡_of
(

523 
»cÜd_´ÙocŞs
.
cbegš
(),„ecÜd_´ÙocŞs.
ûnd
(),

524 
avaabË_»cÜd_´ÙocŞs_
.
cbegš
(),‡vaabË_»cÜd_´ÙocŞs_.
ûnd
());

525 ià(
	g´ÙocŞ_™
 =ğ
»cÜd_´ÙocŞs
.
ûnd
()) {

526  
çl£
;

529 
	g£Ëùed_»cÜd_´ÙocŞ_
 = 
¡©ic_ÿ¡
<
RecÜdPrÙocŞ
>(*
´ÙocŞ_™
);

530 
S‘RecÜdPrÙocŞ
(
£Ëùed_»cÜd_´ÙocŞ_
);

531  
	gŒue
;

	@grpc/auth/core/server_ekep_handshaker.cc

19 
	~"asylo/g½c/auth/cÜe/£rv”_ek•_hªdshak”.h
"

21 
	~<İ’s¦/curve25519.h
>

22 
	~<İ’s¦/¿nd.h
>

24 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/üy±o/sha256_hash.h
"

27 
	~"asylo/ut/loggšg.h
"

28 
	~"asylo/g½c/auth/cÜe/ek•_üy±o.h
"

29 
	~"asylo/g½c/auth/cÜe/ek•_”rÜ_¥aû.h
"

30 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

31 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

32 
	~"asylo/id’t™y/id’t™y.pb.h
"

33 
	~"asylo/ut/ş—nsšg_ty³s.h
"

34 
	~"asylo/ut/¡©us_maüos.h
"

36 
Çme¥aû
 
	gasylo
 {

37 
	gÇme¥aû
 {

40 
boŞ
 
CheckEk•V”siÚEqu®™y
(cÚ¡ 
Ek•V”siÚ
 &
ek•_v”siÚ
,

41 cÚ¡ 
¡d
::
¡ršg
 &
v”siÚ_Çme
) {

42  
ek•_v”siÚ
.
Çme
(è=ğ
v”siÚ_Çme
;

47 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
S”v”Ek•Hªdshak”
::
C»©e
(

48 cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
) {

49 
Stus
 
¡©us
 = 
İtiÚs
.
V®id©e
();

50 ià(!
	g¡©us
.
ok
()) {

51 
LOG
(
ERROR
è<< "Inv®id hªdshak” o±iÚs: " << 
	g¡©us
;

52  
	gnuÎ±r
;

54  
	gab¦
::
W¿pUnique
(
Ãw
 
S”v”Ek•Hªdshak”
(
İtiÚs
));

57 
	gS”v”Ek•Hªdshak”
::
S”v”Ek•Hªdshak”
(cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
)

58 : 
Ek•Hªdshak”
(
İtiÚs
.
max_äame_size
),

59 
£lf_as£¹iÚs_
(
İtiÚs
.
£lf_as£¹iÚs
),

60 
acû±ed_³”_as£¹iÚs_
(
İtiÚs
.
acû±ed_³”_as£¹iÚs
),

61 
avaabË_ch”_su™es_
({
CURVE25519_SHA256
}),

62 
avaabË_»cÜd_´ÙocŞs_
({
SEAL_AES128_GCM
}),

63 
avaabË_ek•_v”siÚs_
({"EKEP v1"}),

64 
add™iÚ®_auth’tiÿ‹d_d©a_
(
İtiÚs
.
add™iÚ®_auth’tiÿ‹d_d©a
),

65 
£Ëùed_ch”_su™e_
(
UNKNOWN_HANDSHAKE_CIPHER
),

66 
£Ëùed_»cÜd_´ÙocŞ_
(
UNKNOWN_RECORD_PROTOCOL
),

67 
ex³ùed_mes§ge_ty³_
(
CLIENT_PRECOMMIT
),

70 
hªdshak”_¡©e_
(
Ek•Hªdshak”
::
HªdshakeS‹
::
IN_PROGRESS
) {}

72 
boŞ
 
S”v”Ek•Hªdshak”
::
IsHªdshakeInProg»ss
() const {

73  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
IN_PROGRESS
;

76 
boŞ
 
	gS”v”Ek•Hªdshak”
::
IsHªdshakeCom¶‘ed
() const {

77  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
COMPLETED
;

80 
boŞ
 
	gS”v”Ek•Hªdshak”
::
IsHªdshakeAbÜ‹d
() const {

81  
hªdshak”_¡©e_
 =ğ
HªdshakeS‹
::
ABORTED
;

84 
HªdshakeMes§geTy³
 
	gS”v”Ek•Hªdshak”
::
G‘Ex³ùedMes§geTy³
() const {

85 ià(!
IsHªdshakeInProg»ss
()) {

86  
UNKNOWN_HANDSHAKE_MESSAGE
;

88  
	gex³ùed_mes§ge_ty³_
;

91 
	gS”v”Ek•Hªdshak”
::
ResuÉ
 
S”v”Ek•Hªdshak”
::
S¹Hªdshake
(

92 
¡d
::
¡ršg
 *
ouut
) {

93 
LOG
(
DFATAL
) << "StartHandshake() was called on‡ ServerEkepHandshaker";

94 
AbÜtHªdshake
(
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

96 
ouut
);

97  
	gResuÉ
::
ABORTED
;

100 
	gS”v”Ek•Hªdshak”
::
AbÜtHªdshake
(cÚ¡ 
Stus
 &
abÜt_¡©us
,

101 
¡d
::
¡ršg
 *
ouut
) {

102 
AbÜt_E¼ÜCode
 
”rÜ_code
 =

103 
¡©ic_ÿ¡
<
AbÜt_E¼ÜCode
>(
abÜt_¡©us
.
”rÜ_code
());

104 
LOG
(
ERROR
è<< 
	gabÜt_¡©us
;

106 
AbÜt
 
	gabÜt
;

107 
	gabÜt
.
£t_code
(
”rÜ_code
);

108 
	gabÜt
.
£t_mes§ge
(
¡d
::
¡ršg
(
abÜt_¡©us
.
”rÜ_mes§ge
().
d©a
(),

109 
abÜt_¡©us
.
”rÜ_mes§ge
().
size
()));

111 
	ggoogË
::
´Ùobuf
::
io
::
SŒšgOuutSŒ—m
 
outgošg_äame
(
ouut
);

112 
Stus
 
	g¡©us
 = 
EncodeF¿me
(
ABORT
, 
abÜt
, &
outgošg_äame
);

113 ià(!
	g¡©us
.
ok
()) {

116 
LOG
(
ERROR
è<< "Encodšg oàABORT mes§gçed: " << 
	g¡©us
;

119 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

122 
	gS”v”Ek•Hªdshak”
::
ResuÉ
 
S”v”Ek•Hªdshak”
::
HªdËHªdshakeMes§ge
(

123 
HªdshakeMes§geTy³
 
mes§ge_ty³
, cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

124 
¡d
::
¡ršg
 *
ouut
) {

125 
Stus
 
¡©us
 = Stus::
OkStus
();

127 
	gmes§ge_ty³
) {

128 
	gCLIENT_PRECOMMIT
:

129 
ex³ùed_mes§ge_ty³_
 = 
CLIENT_ID
;

130 
	g¡©us
 = 
HªdËCl›ÁP»comm™
(
hªdshake_mes§ge
, 
ouut
);

132 
	gCLIENT_ID
:

133 
ex³ùed_mes§ge_ty³_
 = 
CLIENT_FINISH
;

134 
	g¡©us
 = 
HªdËCl›ÁId
(
hªdshake_mes§ge
, 
ouut
);

136 
	gCLIENT_FINISH
:

137 
ex³ùed_mes§ge_ty³_
 = 
UNKNOWN_HANDSHAKE_MESSAGE
;

138 
	g¡©us
 = 
HªdËCl›ÁFšish
(
hªdshake_mes§ge
);

139 ià(
	g¡©us
.
ok
()) {

140 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
COMPLETED
;

146 
¡©us
 = 
Stus
(
AbÜt_E¼ÜCode_BAD_MESSAGE
,

149 ià(!
	g¡©us
.
ok
()) {

150 ià(
	gmes§ge_ty³
 !ğ
CLIENT_FINISH
) {

152 
AbÜtHªdshake
(
¡©us
, 
ouut
);

154 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

160 ià(
IsHªdshakeCom¶‘ed
()) {

161 ià(!
D”iveAndS‘RecÜdPrÙocŞKey
(

162 
£Ëùed_ch”_su™e_
, 
£Ëùed_»cÜd_´ÙocŞ_
, 
ma¡”_£ü‘_
)

163 .
ok
()) {

164 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

168 
	ghªdshak”_¡©e_
) {

169 
	gHªdshakeS‹
::
COMPLETED
:

170  
ResuÉ
::
COMPLETED
;

171 
	gHªdshakeS‹
::
IN_PROGRESS
:

172  
ResuÉ
::
IN_PROGRESS
;

174  
ResuÉ
::
ABORTED
;

178 
	gS”v”Ek•Hªdshak”
::
HªdËAbÜtMes§ge
(cÚ¡ 
AbÜt
 *
abÜt_mes§ge
) {

179 ià(
abÜt_mes§ge
) {

180 
LOG
(
ERROR
è<< "Reûived " << 
AbÜt_E¼ÜCode_Name
(
abÜt_mes§ge
->
code
())

181 << " from cl›Á: " << 
abÜt_mes§ge
->
mes§ge
();

184 
	ghªdshak”_¡©e_
 = 
HªdshakeS‹
::
ABORTED
;

187 
Stus
 
	gS”v”Ek•Hªdshak”
::
HªdËCl›ÁP»comm™
(

188 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
, 
¡d
::
¡ršg
 *
ouut
) {

189 cÚ¡‡utØ*
ş›Á_´ecomm™_±r
 =

190 
dyÇmic_ÿ¡
<cÚ¡ 
Cl›ÁP»comm™
 *>(&
mes§ge
);

191 ià(!
	gş›Á_´ecomm™_±r
) {

192 
LOG
(
QFATAL
) << "HandleClientPrecommit() was…assed‡‚on-ClientPrecommit "

194  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

196 cÚ¡ 
	gCl›ÁP»comm™
 &
	gş›Á_´ecomm™
 = *
ş›Á_´ecomm™_±r
;

199 ià(!
S‘S–eùedEk•V”siÚ
(
ş›Á_´ecomm™
.
avaabË_ek•_v”siÚs
())) {

200  
Stus
(
AbÜt_E¼ÜCode_BAD_PROTOCOL_VERSION
,

205 ià(!
S‘S–eùedCh”Su™e
(
ş›Á_´ecomm™
.
avaabË_ch”_su™es
())) {

206  
Stus
(
AbÜt_E¼ÜCode_BAD_HANDSHAKE_CIPHER
,

211 
	g£Ëùed_ch”_su™e_
) {

212 
	gCURVE25519_SHA256
:

213 
S‘T¿nsütHashFunùiÚ
(
Ãw
 
Sha256Hash
());

216 
LOG
(
ERROR
) << "Server handshaker has bad cipher suite configuration"

217 << 
HªdshakeCh”_Name
(
£Ëùed_ch”_su™e_
);

218  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

223 ià(!
S‘S–eùedRecÜdPrÙocŞ
(

224 
ş›Á_´ecomm™
.
avaabË_»cÜd_´ÙocŞs
())) {

225  
Stus
(
AbÜt_E¼ÜCode_BAD_RECORD_PROTOCOL
,

230 ià(
	gş›Á_´ecomm™
.
ch®Ënge
().
size
(è!ğ
kEk•Ch®ËngeSize
) {

231  
Stus
(
AbÜt_E¼ÜCode_PROTOCOL_ERROR
,

235 cÚ¡ 
	gAs£¹iÚOfãr
 &
	gofãr
 : 
ş›Á_´ecomm™
.
ş›Á_ofãrs
()) {

236 cÚ¡ 
As£¹iÚDesütiÚ
 &
ofãr_desc
 = 
ofãr
.
desütiÚ
();

239 ià(
FšdAs£¹iÚDesütiÚ
(
acû±ed_³”_as£¹iÚs_
, 
ofãr_desc
) !=

240 
acû±ed_³”_as£¹iÚs_
.
ûnd
()) {

241 autØ
»suÉ
 = 
G‘EnşaveAs£¹iÚV”if›r
(
ofãr_desc
)->
CªV”ify
(
ofãr
);

242 ià(
	g»suÉ
.
ok
(è&&„esuÉ.
V®ueOrD›
()) {

243 
	gex³ùed_³”_as£¹iÚs_
.
push_back
(
ofãr_desc
);

247 ià(
	gex³ùed_³”_as£¹iÚs_
.
em±y
()) {

248  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION_TYPE
,

252 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
ş›Á_´ecomm™
.
ş›Á_»que¡s
()) {

253 cÚ¡ 
As£¹iÚDesütiÚ
 &
»que¡_desc
 = 
»que¡
.
desütiÚ
();

258 ià(
FšdAs£¹iÚDesütiÚ
(
£lf_as£¹iÚs_
, 
»que¡_desc
) !=

259 
£lf_as£¹iÚs_
.
ûnd
()) {

260 autØ
»suÉ
 =

261 
G‘EnşaveAs£¹iÚG’”©Ü
(
»que¡_desc
)->
CªG’”©e
(
»que¡
);

262 ià(
	g»suÉ
.
ok
(è&&„esuÉ.
V®ueOrD›
()) {

263 
	g´omi£d_as£¹iÚs_
.
push_back
(
»que¡
);

267 ià(
	g´omi£d_as£¹iÚs_
.
em±y
()) {

268  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION_TYPE
,

272  
Wr™eS”v”P»comm™
(
ouut
);

275 
Stus
 
	gS”v”Ek•Hªdshak”
::
HªdËCl›ÁId
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
,

276 
¡d
::
¡ršg
 *
ouut
) {

277 cÚ¡‡utØ*
ş›Á_id_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
Cl›ÁId
 *>(&
mes§ge
);

278 ià(!
	gş›Á_id_±r
) {

279 
LOG
(
QFATAL
) << "HandleClientId() was…assed‡‚on-ClientId handshake "

281  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

283 cÚ¡ 
	gCl›ÁId
 &
	gş›Á_id
 = *
ş›Á_id_±r
;

288 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

289 ià(!
MakeEk•CÚ‹xtBlob
(
ş›Á_id
.
dh_public_key
(),

290 
ş›Á_as£¹iÚ_Œªsüt_
, &
ek•_cÚ‹xt
)) {

291  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Failedo generate context");

294 cÚ¡ 
	gAs£¹iÚ
 &
	gas£¹iÚ
 : 
ş›Á_id
.
as£¹iÚs
()) {

295 autØ
desc_™
 = 
FšdAs£¹iÚDesütiÚ
(
ex³ùed_³”_as£¹iÚs_
,

296 
as£¹iÚ
.
desütiÚ
());

297 ià(
	gdesc_™
 =ğ
ex³ùed_³”_as£¹iÚs_
.
ûnd
()) {

298  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

303 
EnşaveId’t™y
 
	gid’t™y
;

307 
Stus
 
	g¡©us
 = 
G‘EnşaveAs£¹iÚV”if›r
(
as£¹iÚ
.
desütiÚ
())

308 ->
V”ify
(
ek•_cÚ‹xt
, 
as£¹iÚ
, &
id’t™y
);

309 ià(!
	g¡©us
.
ok
()) {

310 
LOG
(
ERROR
è<< "As£¹iÚ could‚Ù bv”if›d: " << 
	g¡©us
;

311  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

314 
AddP“rId’t™y
(
id’t™y
);

315 
	gex³ùed_³”_as£¹iÚs_
.
”a£
(
desc_™
);

318 ià(!
	gex³ùed_³”_as£¹iÚs_
.
em±y
()) {

320  
Stus
(
AbÜt_E¼ÜCode_BAD_ASSERTION
,

324 
	g¡d
::
cİy
(
ş›Á_id
.
dh_public_key
().
cbegš
(),

325 
ş›Á_id
.
dh_public_key
().
ûnd
(),

326 
¡d
::
back_š£¹”
(
ş›Á_public_key_
));

328  
Wr™eS”v”Id
(
ouut
);

331 
Stus
 
	gS”v”Ek•Hªdshak”
::
HªdËCl›ÁFšish
(

332 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
) {

333 cÚ¡‡utØ*
ş›Á_fšish_±r
 = 
dyÇmic_ÿ¡
<cÚ¡ 
Cl›ÁFšish
 *>(&
mes§ge
);

334 ià(!
	gş›Á_fšish_±r
) {

335 
LOG
(
DFATAL
) << "HandleClientFinish() was…assed‡‚on-ClientFinish "

337  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

339 cÚ¡ 
	gCl›ÁFšish
 &
	gş›Á_fšish
 = *
ş›Á_fšish_±r
;

341 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gaùu®_ş›Á_hªdshake_auth’tiÿtÜ
;

342 
	g¡d
::
cİy
(
ş›Á_fšish
.
hªdshake_auth’tiÿtÜ
().
cbegš
(),

343 
ş›Á_fšish
.
hªdshake_auth’tiÿtÜ
().
ûnd
(),

344 
¡d
::
back_š£¹”
(
aùu®_ş›Á_hªdshake_auth’tiÿtÜ
));

347 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gex³ùed_ş›Á_hªdshake_auth’tiÿtÜ
;

348 
ASYLO_RETURN_IF_ERROR
(
Compu‹Cl›ÁHªdshakeAuth’tiÿtÜ
(

349 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
,

350 &
ex³ùed_ş›Á_hªdshake_auth’tiÿtÜ
));

353 ià(!
CheckMacEqu®™y
(
ex³ùed_ş›Á_hªdshake_auth’tiÿtÜ
,

354 
aùu®_ş›Á_hªdshake_auth’tiÿtÜ
)) {

355  
Stus
(
AbÜt_E¼ÜCode_BAD_AUTHENTICATOR
,

358  
	gStus
::
OkStus
();

361 
Stus
 
	gS”v”Ek•Hªdshak”
::
Wr™eS”v”P»comm™
(
¡d
::
¡ršg
 *
ouut
) {

362 
S”v”P»comm™
 
£rv”_´ecomm™
;

364 
	g£rv”_´ecomm™
.
mubË_£Ëùed_ek•_v”siÚ
()->
£t_Çme
(

365 
£Ëùed_ek•_v”siÚ_
);

366 
	g£rv”_´ecomm™
.
£t_£Ëùed_ch”_su™e
(
£Ëùed_ch”_su™e_
);

367 
	g£rv”_´ecomm™
.
£t_£Ëùed_»cÜd_´ÙocŞ
(
£Ëùed_»cÜd_´ÙocŞ_
);

369 ià(!
	gadd™iÚ®_auth’tiÿ‹d_d©a_
.
em±y
()) {

370 
	g£rv”_´ecomm™
.
mubË_İtiÚs
()->
£t_d©a
(

371 
add™iÚ®_auth’tiÿ‹d_d©a_
);

374 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch®Ënge
(
kEk•Ch®ËngeSize
);

375 ià(
RAND_by‹s
(
ch®Ënge
.
d©a
(), 
kEk•Ch®ËngeSize
) != 1) {

376  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
, "Internalƒrror");

378 
	g£rv”_´ecomm™
.
£t_ch®Ënge
(
ch®Ënge
.
d©a
(), ch®Ënge.
size
());

380 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
´omi£d_as£¹iÚs_
) {

381 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
 = 
»que¡
.description();

385 
G‘EnşaveAs£¹iÚG’”©Ü
(
desütiÚ
)

386 ->
C»©eAs£¹iÚOfãr
(
£rv”_´ecomm™
.
add_£rv”_ofãrs
());

389 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 : 
ex³ùed_³”_as£¹iÚs_
) {

393 
G‘EnşaveAs£¹iÚV”if›r
(
desütiÚ
)

394 ->
C»©eAs£¹iÚReque¡
(
£rv”_´ecomm™
.
add_£rv”_»que¡s
());

397 
ASYLO_RETURN_IF_ERROR
(
Wr™eF¿meAndUpd©eT¿nsüt
(

398 
SERVER_PRECOMMIT
, 
£rv”_´ecomm™
, 
ouut
));

405  
G‘T¿nsütHash
(&
ş›Á_as£¹iÚ_Œªsüt_
);

408 
Stus
 
	gS”v”Ek•Hªdshak”
::
Wr™eS”v”Id
(
¡d
::
¡ršg
 *
ouut
) {

411 
£Ëùed_ch”_su™e_
) {

412 
CURVE25519_SHA256
:

413 
dh_public_key_
.
»size
(
X25519_PUBLIC_VALUE_LEN
);

414 
	gdh_´iv©e_key_
.
»size
(
X25519_PRIVATE_KEY_LEN
);

415 
X25519_key·œ
(
dh_public_key_
.
d©a
(), 
dh_´iv©e_key_
.data());

418 
LOG
(
ERROR
) << "Server handshaker has bad cipher suite configuration";

419  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

423 
S”v”Id
 
	g£rv”_id
;

424 
	g£rv”_id
.
£t_dh_public_key
(
dh_public_key_
.
d©a
(), dh_public_key_.
size
());

426 
	g¡d
::
¡ršg
 
public_key
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
dh_public_key_
.
d©a
()),

427 
dh_public_key_
.
size
());

433 
	g¡d
::
¡ršg
 
Œªsüt_hash
;

434 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

438 
	g¡d
::
¡ršg
 
ek•_cÚ‹xt
;

439 ià(!
MakeEk•CÚ‹xtBlob
(
public_key
, 
Œªsüt_hash
, &
ek•_cÚ‹xt
)) {

440  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

446 cÚ¡ 
	gAs£¹iÚReque¡
 &
	g»que¡
 : 
´omi£d_as£¹iÚs_
) {

450 
Stus
 
¡©us
 =

451 
G‘EnşaveAs£¹iÚG’”©Ü
(
»que¡
.
desütiÚ
())

452 ->
G’”©e
(
ek•_cÚ‹xt
, 
»que¡
, 
£rv”_id
.
add_as£¹iÚs
());

453 ià(!
	g¡©us
.
ok
()) {

454 
LOG
(
ERROR
è<< "As£¹iÚ g’”©iÚ faed: " << 
	g¡©us
;

455  
Stus
(
AbÜt_E¼ÜCode_INTERNAL_ERROR
,

460 
ASYLO_RETURN_IF_ERROR
(

461 
Wr™eF¿meAndUpd©eT¿nsüt
(
SERVER_ID
, 
£rv”_id
, 
ouut
));

463  
Wr™eS”v”Fšish
(
ouut
);

466 
Stus
 
	gS”v”Ek•Hªdshak”
::
Wr™eS”v”Fšish
(
¡d
::
¡ršg
 *
ouut
) {

472 
¡d
::
¡ršg
 
Œªsüt_hash
;

473 
ASYLO_RETURN_IF_ERROR
(
G‘T¿nsütHash
(&
Œªsüt_hash
));

475 
ASYLO_RETURN_IF_ERROR
(
D”iveSeü‘s
(
£Ëùed_ch”_su™e_
, 
Œªsüt_hash
,

476 
ş›Á_public_key_
, 
dh_´iv©e_key_
,

477 &
ma¡”_£ü‘_
, &
auth’tiÿtÜ_£ü‘_
));

479 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ
;

480 
ASYLO_RETURN_IF_ERROR
(
Compu‹S”v”HªdshakeAuth’tiÿtÜ
(

481 
£Ëùed_ch”_su™e_
, 
auth’tiÿtÜ_£ü‘_
, &
auth’tiÿtÜ
));

483 
S”v”Fšish
 
	g£rv”_fšish
;

484 
	g£rv”_fšish
.
£t_hªdshake_auth’tiÿtÜ
(
auth’tiÿtÜ
.
d©a
(),

485 
auth’tiÿtÜ
.
size
());

487  
Wr™eF¿meAndUpd©eT¿nsüt
(
SERVER_FINISH
, 
£rv”_fšish
, 
ouut
);

490 
boŞ
 
	gS”v”Ek•Hªdshak”
::
S‘S–eùedEk•V”siÚ
(

491 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
Ek•V”siÚ
> &
ek•_v”siÚs
) {

493 autØ
v”siÚ_™
 = 
¡d
::
fšd_fœ¡_of
(

494 
ek•_v”siÚs
.
cbegš
(),ƒk•_v”siÚs.
ûnd
(),

495 
avaabË_ek•_v”siÚs_
.
cbegš
(),‡vaabË_ek•_v”siÚs_.
ûnd
(),

496 
CheckEk•V”siÚEqu®™y
);

497 ià(
	gv”siÚ_™
 =ğ
ek•_v”siÚs
.
ûnd
()) {

498  
çl£
;

501 
	g£Ëùed_ek•_v”siÚ_
 = 
v”siÚ_™
->
Çme
();

502  
	gŒue
;

505 
boŞ
 
	gS”v”Ek•Hªdshak”
::
S‘S–eùedCh”Su™e
(

506 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
ch”_su™es
) {

508 autØ
ch”_™
 = 
¡d
::
fšd_fœ¡_of
(

509 
ch”_su™es
.
cbegš
(), ch”_su™es.
ûnd
(),

510 
avaabË_ch”_su™es_
.
cbegš
(),‡vaabË_ch”_su™es_.
ûnd
());

511 ià(
	gch”_™
 =ğ
ch”_su™es
.
ûnd
()) {

512  
çl£
;

515 
	g£Ëùed_ch”_su™e_
 = 
¡©ic_ÿ¡
<
HªdshakeCh”
>(*
ch”_™
);

516  
	gŒue
;

519 
boŞ
 
	gS”v”Ek•Hªdshak”
::
S‘S–eùedRecÜdPrÙocŞ
(

520 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
»cÜd_´ÙocŞs
) {

522 autØ
´ÙocŞ_™
 = 
¡d
::
fšd_fœ¡_of
(

523 
»cÜd_´ÙocŞs
.
cbegš
(),„ecÜd_´ÙocŞs.
ûnd
(),

524 
avaabË_»cÜd_´ÙocŞs_
.
cbegš
(),‡vaabË_»cÜd_´ÙocŞs_.
ûnd
());

525 ià(
	g´ÙocŞ_™
 =ğ
»cÜd_´ÙocŞs
.
ûnd
()) {

526  
çl£
;

529 
	g£Ëùed_»cÜd_´ÙocŞ_
 = 
¡©ic_ÿ¡
<
RecÜdPrÙocŞ
>(*
´ÙocŞ_™
);

530 
S‘RecÜdPrÙocŞ
(
£Ëùed_»cÜd_´ÙocŞ_
);

531  
	gŒue
;

	@grpc/auth/core/server_ekep_handshaker.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_SERVER_EKEP_HANDSHAKER_H_


20 
	#ASYLO_GRPC_AUTH_CORE_SERVER_EKEP_HANDSHAKER_H_


	)

22 
	~<c¡dšt
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

28 
	~<googË/´Ùobuf/mes§ge.h
>

29 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”.h
"

30 
	~"asylo/g½c/auth/cÜe/ek•_hªdshak”_ut.h
"

31 
	~"asylo/ut/ş—nsšg_ty³s.h
"

33 
Çme¥aû
 
	gasylo
 {

39 şas 
	cS”v”Ek•Hªdshak”
 
	gfš®
 : 
public
 
Ek•Hªdshak”
 {

40 
public
:

44 
¡d
::
unique_±r
<
Ek•Hªdshak”
> 
C»©e
(

45 cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
);

47 
	g´Ùeùed
:

49 
boŞ
 
IsHªdshakeInProg»ss
(ècÚ¡ 
ov”ride
;

52 
boŞ
 
IsHªdshakeCom¶‘ed
(ècÚ¡ 
	gov”ride
;

55 
boŞ
 
IsHªdshakeAbÜ‹d
(ècÚ¡ 
	gov”ride
;

58 
HªdshakeMes§geTy³
 
G‘Ex³ùedMes§geTy³
(ècÚ¡ 
	gov”ride
;

61 
ResuÉ
 
S¹Hªdshake
(
¡d
::
¡ršg
 *
ouut
è
ov”ride
;

64 
AbÜtHªdshake
(cÚ¡ 
Stus
 &
abÜt_¡©us
, 
¡d
::
¡ršg
 *
ouut
è
ov”ride
;

67 
ResuÉ
 
HªdËHªdshakeMes§ge
(
HªdshakeMes§geTy³
 
mes§ge_ty³
,

68 cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
hªdshake_mes§ge
,

69 
¡d
::
¡ršg
 *
ouut
è
ov”ride
;

72 
HªdËAbÜtMes§ge
(cÚ¡ 
AbÜt
 *
abÜt_mes§ge
è
	gov”ride
;

74 
	g´iv©e
:

76 
S”v”Ek•Hªdshak”
(cÚ¡ 
Ek•Hªdshak”O±iÚs
 &
İtiÚs
);

81 
Stus
 
HªdËCl›ÁP»comm™
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
,

82 
¡d
::
¡ršg
 *
ouut
);

87 
Stus
 
HªdËCl›ÁId
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
, 
¡d
::
¡ršg
 *
ouut
);

90 
Stus
 
HªdËCl›ÁFšish
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
);

94 
Stus
 
Wr™eS”v”P»comm™
(
¡d
::
¡ršg
 *
ouut
);

97 
Stus
 
Wr™eS”v”Id
(
¡d
::
¡ršg
 *
ouut
);

101 
Stus
 
Wr™eS”v”Fšish
(
¡d
::
¡ršg
 *
ouut
);

106 
boŞ
 
S‘S–eùedEk•V”siÚ
(

107 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
Ek•V”siÚ
> &
ek•_v”siÚs
);

112 
boŞ
 
S‘S–eùedCh”Su™e
(cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
ch”_su™es
);

117 
boŞ
 
S‘S–eùedRecÜdPrÙocŞ
(

118 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
»cÜd_´ÙocŞs
);

121 cÚ¡ 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
£lf_as£¹iÚs_
;

124 cÚ¡ 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
acû±ed_³”_as£¹iÚs_
;

127 cÚ¡ 
	g¡d
::
veùÜ
<
HªdshakeCh”
> 
avaabË_ch”_su™es_
;

130 cÚ¡ 
	g¡d
::
veùÜ
<
RecÜdPrÙocŞ
> 
avaabË_»cÜd_´ÙocŞs_
;

134 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
avaabË_ek•_v”siÚs_
;

137 cÚ¡ 
	g¡d
::
¡ršg
 
add™iÚ®_auth’tiÿ‹d_d©a_
;

141 
	g¡d
::
veùÜ
<
As£¹iÚReque¡
> 
´omi£d_as£¹iÚs_
;

145 
	g¡d
::
veùÜ
<
As£¹iÚDesütiÚ
> 
ex³ùed_³”_as£¹iÚs_
;

149 
HªdshakeCh”
 
	g£Ëùed_ch”_su™e_
;

154 
RecÜdPrÙocŞ
 
	g£Ëùed_»cÜd_´ÙocŞ_
;

158 
	g¡d
::
¡ršg
 
£Ëùed_ek•_v”siÚ_
;

161 
	g¡d
::
veùÜ
<
ušt8_t
> 
dh_public_key_
;

162 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gdh_´iv©e_key_
;

166 
	g¡d
::
veùÜ
<
ušt8_t
> 
ş›Á_public_key_
;

169 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gma¡”_£ü‘_
;

170 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gauth’tiÿtÜ_£ü‘_
;

174 
	g¡d
::
¡ršg
 
ş›Á_as£¹iÚ_Œªsüt_
;

177 
HªdshakeMes§geTy³
 
	gex³ùed_mes§ge_ty³_
;

180 
	gEk•Hªdshak”
::
HªdshakeS‹
 
hªdshak”_¡©e_
;

	@grpc/auth/core/transcript.cc

19 
	~"asylo/g½c/auth/cÜe/Œªsüt.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

26 
	~"asylo/üy±o/hash_š‹rçû.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

32 
	gT¿nsüt
::
Add
(
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
) {

33 cÚ¡ *
bufãr
;

34 
	gsize
;

35 
	gšput
->
Next
(&
bufãr
, &
size
)) {

36 
Add
(
bufãr
, 
size
);

40 
boŞ
 
	gT¿nsüt
::
S‘Hash”
(
HashIÁ”çû
 *
hash”
) {

41 ià(
hash”_
) {

42  
çl£
;

44 
	ghash”_
.
»£t
(
hash”
);

45 
	ghash”_
->
In™
();

46 
	ghash”_
->
Upd©e
(
by‹s_to_hash_
);

47 
	gby‹s_to_hash_
.
ş—r
();

48  
	gŒue
;

51 
boŞ
 
	gT¿nsüt
::
Hash
(
¡d
::
¡ršg
 *
dige¡
) {

52 ià(!
hash”_
) {

53  
çl£
;

55 
	g¡d
::
veùÜ
<
ušt8_t
> 
tmp_dige¡
;

56 
Stus
 
	g¡©us
 = 
hash”_
->
CumuÏtiveHash
(&
tmp_dige¡
);

57 ià(!
	g¡©us
.
ok
()) {

58 
LOG
(
ERROR
è<< "E¼Ü whg’”©šg¿nsüˆhash: " << 
	g¡©us
;

59  
	gçl£
;

61 *
	gdige¡
 = 
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
tmp_dige¡
);

62  
	gŒue
;

65 
	gT¿nsüt
::
Add
(cÚ¡ *
d©a
, 
size_t
 
Ën
) {

66 ià(
	ghash”_
) {

68 
	ghash”_
->
Upd©e
({
d©a
, 
Ën
});

71 
	gby‹s_to_hash_
.
­³nd
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
d©a
), 
Ën
);

	@grpc/auth/core/transcript.cc

19 
	~"asylo/g½c/auth/cÜe/Œªsüt.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

26 
	~"asylo/üy±o/hash_š‹rçû.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

32 
	gT¿nsüt
::
Add
(
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
) {

33 cÚ¡ *
bufãr
;

34 
	gsize
;

35 
	gšput
->
Next
(&
bufãr
, &
size
)) {

36 
Add
(
bufãr
, 
size
);

40 
boŞ
 
	gT¿nsüt
::
S‘Hash”
(
HashIÁ”çû
 *
hash”
) {

41 ià(
hash”_
) {

42  
çl£
;

44 
	ghash”_
.
»£t
(
hash”
);

45 
	ghash”_
->
In™
();

46 
	ghash”_
->
Upd©e
(
by‹s_to_hash_
);

47 
	gby‹s_to_hash_
.
ş—r
();

48  
	gŒue
;

51 
boŞ
 
	gT¿nsüt
::
Hash
(
¡d
::
¡ršg
 *
dige¡
) {

52 ià(!
hash”_
) {

53  
çl£
;

55 
	g¡d
::
veùÜ
<
ušt8_t
> 
tmp_dige¡
;

56 
Stus
 
	g¡©us
 = 
hash”_
->
CumuÏtiveHash
(&
tmp_dige¡
);

57 ià(!
	g¡©us
.
ok
()) {

58 
LOG
(
ERROR
è<< "E¼Ü whg’”©šg¿nsüˆhash: " << 
	g¡©us
;

59  
	gçl£
;

61 *
	gdige¡
 = 
CİyToBy‹CÚš”
<
¡d
::
¡ršg
>(
tmp_dige¡
);

62  
	gŒue
;

65 
	gT¿nsüt
::
Add
(cÚ¡ *
d©a
, 
size_t
 
Ën
) {

66 ià(
	ghash”_
) {

68 
	ghash”_
->
Upd©e
({
d©a
, 
Ën
});

71 
	gby‹s_to_hash_
.
­³nd
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
d©a
), 
Ën
);

	@grpc/auth/core/transcript.h

19 #iâdeà
ASYLO_GRPC_AUTH_CORE_TRANSCRIPT_H_


20 
	#ASYLO_GRPC_AUTH_CORE_TRANSCRIPT_H_


	)

22 
	~<c¡dlib
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

26 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

27 
	~"asylo/üy±o/hash_š‹rçû.h
"

29 
Çme¥aû
 
	gasylo
 {

47 şas 
	cT¿nsüt
 {

48 
	gpublic
:

49 
T¿nsüt
() = ;

50 
T¿nsüt
(cÚ¡ T¿nsüˆ&èğ
d–‘e
;

51 
	gT¿nsüt
 &
	gİ”©Ü
=(cÚ¡ 
T¿nsüt
 &èğ
d–‘e
;

54 
Add
(
googË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
 *
šput
);

59 
boŞ
 
S‘Hash”
(
HashIÁ”çû
 *
hash”
);

64 
boŞ
 
Hash
(
¡d
::
¡ršg
 *
dige¡
);

66 
	g´iv©e
:

68 
Add
(cÚ¡ *
d©a
, 
size_t
 
Ën
);

72 
	g¡d
::
¡ršg
 
by‹s_to_hash_
;

75 
	g¡d
::
unique_±r
<
HashIÁ”çû
> 
hash”_
;

	@grpc/auth/core/transcript_test.cc

19 
	~"asylo/g½c/auth/cÜe/Œªsüt.h
"

21 
	~<®gÜ™hm
>

22 
	~<c¡dšt
>

23 
	~<™”©Ü
>

24 
	~<memÜy
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"asylo/üy±o/hash_š‹rçû.h
"

33 
	~"asylo/üy±o/sha256_hash.h
"

34 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

35 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

36 
	~"asylo/ut/¡©us.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	gg½c
 {

40 
Çme¥aû
 
	gauth
 {

41 
	gÇme¥aû
 {

43 
usšg
 
	ggoogË
::
´Ùobuf
::
io
::
A¼ayIÅutSŒ—m
;

44 
usšg
 
	ggoogË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
;

46 
cÚ¡ex´
 
	gkD©a1
[] = "A very uninteresting string.";

47 
cÚ¡ex´
 
	gkD©a2
[] = "Enclave Key Exchange Protocol";

49 cÚ¡ 
	gkIÅutSŒ—mBlockSize
 = 4;

53 şas 
	cFakeHash
 
	gfš®
 : 
public
 
HashIÁ”çû
 {

54 
public
:

55 
HashAlgÜ™hm
 
G‘HashAlgÜ™hm
(ècÚ¡ 
ov”ride
 {

56  
HashAlgÜ™hm
::
UNKNOWN_HASH_ALGORITHM
;

58 
size_t
 
Dige¡Size
(ècÚ¡ 
	gov”ride
 {  0; }

59 
In™
(è
	gov”ride
 {}

60 
Upd©e
(
By‹CÚš”V›w
 
d©a
è
	gov”ride
 {

61 
	g¡d
::
cİy
(
d©a
.
begš
(), d©a.
’d
(), 
¡d
::
back_š£¹”
(
d©a_
));

64 
Stus
 
CumuÏtiveHash
(
¡d
::
veùÜ
<
ušt8_t
> *
dige¡
ècÚ¡ 
ov”ride
 {

65 *
dige¡
 = 
d©a_
;

66  
	gStus
::
OkStus
();

69 
	g´iv©e
:

70 
¡d
::
veùÜ
<
ušt8_t
> 
d©a_
;

75 
AddFromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, 
T¿nsüt
 *
Œªsüt
) {

76 
	g¡d
::
unique_±r
<
Z”oCİyIÅutSŒ—m
> 
¡»am
(

77 
Ãw
 
A¼ayIÅutSŒ—m
(
šput
.
d©a
(), iÅut.
size
(), 
kIÅutSŒ—mBlockSize
));

78 
	gŒªsüt
->
Add
(
¡»am
.
g‘
());

82 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

83 şas 
	cT¿nsütTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

85 ::
‹¡šg
::
	tTy³s
<
	tFakeHash
, 
	tSha256Hash
> 
	tTe¡Ty³s
;

87 
TYPED_TEST_SUITE
(
T¿nsütTe¡
, 
Te¡Ty³s
);

90 
TYPED_TEST
(
T¿nsütTe¡
, 
S‘Hash”SucûedsOnû
) {

91 
T¿nsüt
 
	gŒªsüt
;

93 
EXPECT_TRUE
(
Œªsüt
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

95 autØ
	ghash”
 = 
ab¦
::
make_unique
<
Ty³P¬am
>();

96 
EXPECT_FALSE
(
Œªsüt
.
S‘Hash”
(
hash”
.
g‘
()));

100 
TYPED_TEST
(
T¿nsütTe¡
, 
HashFasW™hNoHashFunùiÚ
) {

101 
T¿nsüt
 
	gŒªsüt
;

102 
AddFromSŒšg
(
kD©a1
, &
Œªsüt
);

104 
	g¡d
::
¡ršg
 
dige¡
;

105 
EXPECT_FALSE
(
Œªsüt
.
Hash
(&
dige¡
));

110 
TYPED_TEST
(
T¿nsütTe¡
, 
HashSameAsUnd”lyšgHash
) {

111 
Ty³P¬am
 
	ghash
;

112 
	ghash
.
Upd©e
(
kD©a1
);

113 
	ghash
.
Upd©e
(
kD©a2
);

114 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡1
;

115 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡1
), 
IsOk
());

117 
T¿nsüt
 
	gŒªsüt
;

118 
AddFromSŒšg
(
kD©a1
, &
Œªsüt
);

119 
AddFromSŒšg
(
kD©a2
, &
Œªsüt
);

120 
EXPECT_TRUE
(
Œªsüt
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

121 
	g¡d
::
¡ršg
 
dige¡2
;

122 
ASSERT_TRUE
(
Œªsüt
.
Hash
(&
dige¡2
));

124 
EXPECT_EQ
(
By‹CÚš”V›w
(
dige¡1
), By‹CÚš”V›w(
dige¡2
));

129 
TYPED_TEST
(
T¿nsütTe¡
, 
AddBy‹sAndHash
) {

130 
T¿nsüt
 
	gŒªsüt1
;

131 
T¿nsüt
 
	gŒªsüt2
;

132 
T¿nsüt
 
	gŒªsüt3
;

135 
EXPECT_TRUE
(
Œªsüt1
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

136 
AddFromSŒšg
(
kD©a1
, &
Œªsüt1
);

137 
AddFromSŒšg
(
kD©a2
, &
Œªsüt1
);

140 
AddFromSŒšg
(
kD©a1
, &
Œªsüt2
);

141 
EXPECT_TRUE
(
Œªsüt2
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

142 
AddFromSŒšg
(
kD©a2
, &
Œªsüt2
);

145 
AddFromSŒšg
(
kD©a1
, &
Œªsüt3
);

146 
AddFromSŒšg
(
kD©a2
, &
Œªsüt3
);

147 
EXPECT_TRUE
(
Œªsüt3
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

149 
	g¡d
::
¡ršg
 
ruÂšg_hash1
;

150 
	g¡d
::
¡ršg
 
ruÂšg_hash2
;

151 
	g¡d
::
¡ršg
 
ruÂšg_hash3
;

152 
ASSERT_TRUE
(
Œªsüt1
.
Hash
(&
ruÂšg_hash1
));

153 
ASSERT_TRUE
(
Œªsüt2
.
Hash
(&
ruÂšg_hash2
));

154 
ASSERT_TRUE
(
Œªsüt3
.
Hash
(&
ruÂšg_hash3
));

157 
EXPECT_EQ
(
ruÂšg_hash1
, 
ruÂšg_hash2
);

158 
EXPECT_EQ
(
ruÂšg_hash2
, 
ruÂšg_hash3
);

	@grpc/auth/core/transcript_test.cc

19 
	~"asylo/g½c/auth/cÜe/Œªsüt.h
"

21 
	~<®gÜ™hm
>

22 
	~<c¡dšt
>

23 
	~<™”©Ü
>

24 
	~<memÜy
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am_im¶_l™e.h
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"asylo/üy±o/hash_š‹rçû.h
"

33 
	~"asylo/üy±o/sha256_hash.h
"

34 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

35 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

36 
	~"asylo/ut/¡©us.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	gg½c
 {

40 
Çme¥aû
 
	gauth
 {

41 
	gÇme¥aû
 {

43 
usšg
 
	ggoogË
::
´Ùobuf
::
io
::
A¼ayIÅutSŒ—m
;

44 
usšg
 
	ggoogË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
;

46 
cÚ¡ex´
 
	gkD©a1
[] = "A very uninteresting string.";

47 
cÚ¡ex´
 
	gkD©a2
[] = "Enclave Key Exchange Protocol";

49 cÚ¡ 
	gkIÅutSŒ—mBlockSize
 = 4;

53 şas 
	cFakeHash
 
	gfš®
 : 
public
 
HashIÁ”çû
 {

54 
public
:

55 
HashAlgÜ™hm
 
G‘HashAlgÜ™hm
(ècÚ¡ 
ov”ride
 {

56  
HashAlgÜ™hm
::
UNKNOWN_HASH_ALGORITHM
;

58 
size_t
 
Dige¡Size
(ècÚ¡ 
	gov”ride
 {  0; }

59 
In™
(è
	gov”ride
 {}

60 
Upd©e
(
By‹CÚš”V›w
 
d©a
è
	gov”ride
 {

61 
	g¡d
::
cİy
(
d©a
.
begš
(), d©a.
’d
(), 
¡d
::
back_š£¹”
(
d©a_
));

64 
Stus
 
CumuÏtiveHash
(
¡d
::
veùÜ
<
ušt8_t
> *
dige¡
ècÚ¡ 
ov”ride
 {

65 *
dige¡
 = 
d©a_
;

66  
	gStus
::
OkStus
();

69 
	g´iv©e
:

70 
¡d
::
veùÜ
<
ušt8_t
> 
d©a_
;

75 
AddFromSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, 
T¿nsüt
 *
Œªsüt
) {

76 
	g¡d
::
unique_±r
<
Z”oCİyIÅutSŒ—m
> 
¡»am
(

77 
Ãw
 
A¼ayIÅutSŒ—m
(
šput
.
d©a
(), iÅut.
size
(), 
kIÅutSŒ—mBlockSize
));

78 
	gŒªsüt
->
Add
(
¡»am
.
g‘
());

82 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

83 şas 
	cT¿nsütTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

85 ::
‹¡šg
::
	tTy³s
<
	tFakeHash
, 
	tSha256Hash
> 
	tTe¡Ty³s
;

87 
TYPED_TEST_SUITE
(
T¿nsütTe¡
, 
Te¡Ty³s
);

90 
TYPED_TEST
(
T¿nsütTe¡
, 
S‘Hash”SucûedsOnû
) {

91 
T¿nsüt
 
	gŒªsüt
;

93 
EXPECT_TRUE
(
Œªsüt
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

95 autØ
	ghash”
 = 
ab¦
::
make_unique
<
Ty³P¬am
>();

96 
EXPECT_FALSE
(
Œªsüt
.
S‘Hash”
(
hash”
.
g‘
()));

100 
TYPED_TEST
(
T¿nsütTe¡
, 
HashFasW™hNoHashFunùiÚ
) {

101 
T¿nsüt
 
	gŒªsüt
;

102 
AddFromSŒšg
(
kD©a1
, &
Œªsüt
);

104 
	g¡d
::
¡ršg
 
dige¡
;

105 
EXPECT_FALSE
(
Œªsüt
.
Hash
(&
dige¡
));

110 
TYPED_TEST
(
T¿nsütTe¡
, 
HashSameAsUnd”lyšgHash
) {

111 
Ty³P¬am
 
	ghash
;

112 
	ghash
.
Upd©e
(
kD©a1
);

113 
	ghash
.
Upd©e
(
kD©a2
);

114 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡1
;

115 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡1
), 
IsOk
());

117 
T¿nsüt
 
	gŒªsüt
;

118 
AddFromSŒšg
(
kD©a1
, &
Œªsüt
);

119 
AddFromSŒšg
(
kD©a2
, &
Œªsüt
);

120 
EXPECT_TRUE
(
Œªsüt
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

121 
	g¡d
::
¡ršg
 
dige¡2
;

122 
ASSERT_TRUE
(
Œªsüt
.
Hash
(&
dige¡2
));

124 
EXPECT_EQ
(
By‹CÚš”V›w
(
dige¡1
), By‹CÚš”V›w(
dige¡2
));

129 
TYPED_TEST
(
T¿nsütTe¡
, 
AddBy‹sAndHash
) {

130 
T¿nsüt
 
	gŒªsüt1
;

131 
T¿nsüt
 
	gŒªsüt2
;

132 
T¿nsüt
 
	gŒªsüt3
;

135 
EXPECT_TRUE
(
Œªsüt1
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

136 
AddFromSŒšg
(
kD©a1
, &
Œªsüt1
);

137 
AddFromSŒšg
(
kD©a2
, &
Œªsüt1
);

140 
AddFromSŒšg
(
kD©a1
, &
Œªsüt2
);

141 
EXPECT_TRUE
(
Œªsüt2
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

142 
AddFromSŒšg
(
kD©a2
, &
Œªsüt2
);

145 
AddFromSŒšg
(
kD©a1
, &
Œªsüt3
);

146 
AddFromSŒšg
(
kD©a2
, &
Œªsüt3
);

147 
EXPECT_TRUE
(
Œªsüt3
.
S‘Hash”
(
Ãw
 
Ty³P¬am
()));

149 
	g¡d
::
¡ršg
 
ruÂšg_hash1
;

150 
	g¡d
::
¡ršg
 
ruÂšg_hash2
;

151 
	g¡d
::
¡ršg
 
ruÂšg_hash3
;

152 
ASSERT_TRUE
(
Œªsüt1
.
Hash
(&
ruÂšg_hash1
));

153 
ASSERT_TRUE
(
Œªsüt2
.
Hash
(&
ruÂšg_hash2
));

154 
ASSERT_TRUE
(
Œªsüt3
.
Hash
(&
ruÂšg_hash3
));

157 
EXPECT_EQ
(
ruÂšg_hash1
, 
ruÂšg_hash2
);

158 
EXPECT_EQ
(
ruÂšg_hash2
, 
ruÂšg_hash3
);

	@grpc/auth/enclave_auth_context.cc

19 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

21 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/g½c/auth/cÜe/’şave_g½c_£cur™y_cÚ¡ªts.h
"

24 
	~"asylo/ut/¡©us.h
"

25 
	~"¤c/cÜe/lib/£cur™y/cÚ‹xt/£cur™y_cÚ‹xt.h
"

27 
Çme¥aû
 
	gasylo
 {

29 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> EnşaveAuthCÚ‹xt::
C»©eFromS”v”CÚ‹xt
(

30 cÚ¡ ::
g½c
::
S”v”CÚ‹xt
 &
£rv”_cÚ‹xt
) {

31  
C»©eFromAuthCÚ‹xt
(*
£rv”_cÚ‹xt
.
auth_cÚ‹xt
().
g‘
());

34 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> EnşaveAuthCÚ‹xt::
C»©eFromAuthCÚ‹xt
(

35 cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
auth_cÚ‹xt
) {

36 ià(!
auth_cÚ‹xt
.
IsP“rAuth’tiÿ‹d
()) {

37  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

41 
EnşaveId’t™›s
 
	gid’t™›s
;

42 
ušt32_t
 
	g»cÜd_´ÙocŞ
 = 0;

43 autØ
	g™
 = 
auth_cÚ‹xt
.
begš
(); iˆ!ğauth_cÚ‹xt.
’d
(); ++it) {

44 ::
g½c
::
AuthPrİ”ty
 
auth_´İ”ty
 = *
™
;

46 ià(
	gauth_´İ”ty
.
	gfœ¡
 =ğ
GRPC_ENCLAVE_RECORD_PROTOCOL_PROPERTY_NAME
) {

47 
googË
::
´Ùobuf
::
io
::
CodedIÅutSŒ—m
::
R—dL™eEndŸn32FromA¼ay
(

48 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
auth_´İ”ty
.
£cÚd
.
d©a
()),

49 &
»cÜd_´ÙocŞ
);

50 } ià(
	gauth_´İ”ty
.
	gfœ¡
 ==

51 
auth_cÚ‹xt
.
G‘P“rId’t™yPrİ”tyName
()) {

52 ià(!
id’t™›s
.
P¬£FromA¼ay
(
auth_´İ”ty
.
£cÚd
.
d©a
(),

53 
auth_´İ”ty
.
£cÚd
.
Ëngth
())) {

54  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57 } ià(
	gauth_´İ”ty
.
	gfœ¡
 ==

58 
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
) {

59 ià(
auth_´İ”ty
.
£cÚd
 !ğ
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
) {

60  
Stus
(

61 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("Invalidransport securityype: ",

63 
¡d
::
¡ršg
(
auth_´İ”ty
.
£cÚd
.
d©a
(),

64 
auth_´İ”ty
.
£cÚd
.
size
()),

65 ";ƒx³ùed ", 
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
));

68 
	g¡d
::
¡ršg
 
auth_´İ”ty_Çme
 =

69 
¡d
::
¡ršg
(
auth_´İ”ty
.
fœ¡
.
d©a
(),‡uth_´İ”ty.fœ¡.
Ëngth
());

70  
Stus
(

71 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

72 
ab¦
::
SŒC©
("UÄecognized AuthPrİ”ty: ", 
auth_´İ”ty_Çme
));

76  
EnşaveAuthCÚ‹xt
(
¡d
::
move
(
id’t™›s
),

77 
¡©ic_ÿ¡
<
RecÜdPrÙocŞ
>(
»cÜd_´ÙocŞ
));

80 
	gEnşaveAuthCÚ‹xt
::
EnşaveAuthCÚ‹xt
(
EnşaveId’t™›s
 
id’t™›s
,

81 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
)

82 : 
id’t™›s_
(
¡d
::
move
(
id’t™›s
)), 
»cÜd_´ÙocŞ_
(
»cÜd_´ÙocŞ
) {}

84 
RecÜdPrÙocŞ
 
	gEnşaveAuthCÚ‹xt
::
G‘RecÜdPrÙocŞ
() const {

85  
»cÜd_´ÙocŞ_
;

88 
boŞ
 
	gEnşaveAuthCÚ‹xt
::
HasEnşaveId’t™y
(

89 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) const {

90  
FšdEnşaveId’t™y
(
desütiÚ
).
ok
();

93 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gEnşaveAuthCÚ‹xt
::
FšdEnşaveId’t™y
(

94 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) const {

95 autØ
™
 = 
¡d
::
fšd_if
(

96 
id’t™›s_
.
id’t™›s
().
cbegš
(), id’t™›s_.id’t™›s().
ûnd
(),

97 [&
desütiÚ
](cÚ¡ 
EnşaveId’t™y
 &
id’t™y
è-> 
boŞ
 {

98  
id’t™y
.
desütiÚ
().
id’t™y_ty³
() ==

99 
desütiÚ
.
id’t™y_ty³
() &&

100 
id’t™y
.
desütiÚ
().
authÜ™y_ty³
() ==

101 
desütiÚ
.
authÜ™y_ty³
();

103 ià(
	g™
 =ğ
id’t™›s_
.
id’t™›s
().
ûnd
()) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
, "No matching identity");

106  &*
	g™
;

	@grpc/auth/enclave_auth_context.cc

19 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

21 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/g½c/auth/cÜe/’şave_g½c_£cur™y_cÚ¡ªts.h
"

24 
	~"asylo/ut/¡©us.h
"

25 
	~"¤c/cÜe/lib/£cur™y/cÚ‹xt/£cur™y_cÚ‹xt.h
"

27 
Çme¥aû
 
	gasylo
 {

29 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> EnşaveAuthCÚ‹xt::
C»©eFromS”v”CÚ‹xt
(

30 cÚ¡ ::
g½c
::
S”v”CÚ‹xt
 &
£rv”_cÚ‹xt
) {

31  
C»©eFromAuthCÚ‹xt
(*
£rv”_cÚ‹xt
.
auth_cÚ‹xt
().
g‘
());

34 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> EnşaveAuthCÚ‹xt::
C»©eFromAuthCÚ‹xt
(

35 cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
auth_cÚ‹xt
) {

36 ià(!
auth_cÚ‹xt
.
IsP“rAuth’tiÿ‹d
()) {

37  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

41 
EnşaveId’t™›s
 
	gid’t™›s
;

42 
ušt32_t
 
	g»cÜd_´ÙocŞ
 = 0;

43 autØ
	g™
 = 
auth_cÚ‹xt
.
begš
(); iˆ!ğauth_cÚ‹xt.
’d
(); ++it) {

44 ::
g½c
::
AuthPrİ”ty
 
auth_´İ”ty
 = *
™
;

46 ià(
	gauth_´İ”ty
.
	gfœ¡
 =ğ
GRPC_ENCLAVE_RECORD_PROTOCOL_PROPERTY_NAME
) {

47 
googË
::
´Ùobuf
::
io
::
CodedIÅutSŒ—m
::
R—dL™eEndŸn32FromA¼ay
(

48 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
auth_´İ”ty
.
£cÚd
.
d©a
()),

49 &
»cÜd_´ÙocŞ
);

50 } ià(
	gauth_´İ”ty
.
	gfœ¡
 ==

51 
auth_cÚ‹xt
.
G‘P“rId’t™yPrİ”tyName
()) {

52 ià(!
id’t™›s
.
P¬£FromA¼ay
(
auth_´İ”ty
.
£cÚd
.
d©a
(),

53 
auth_´İ”ty
.
£cÚd
.
Ëngth
())) {

54  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57 } ià(
	gauth_´İ”ty
.
	gfœ¡
 ==

58 
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
) {

59 ià(
auth_´İ”ty
.
£cÚd
 !ğ
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
) {

60  
Stus
(

61 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("Invalidransport securityype: ",

63 
¡d
::
¡ršg
(
auth_´İ”ty
.
£cÚd
.
d©a
(),

64 
auth_´İ”ty
.
£cÚd
.
size
()),

65 ";ƒx³ùed ", 
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
));

68 
	g¡d
::
¡ršg
 
auth_´İ”ty_Çme
 =

69 
¡d
::
¡ršg
(
auth_´İ”ty
.
fœ¡
.
d©a
(),‡uth_´İ”ty.fœ¡.
Ëngth
());

70  
Stus
(

71 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

72 
ab¦
::
SŒC©
("UÄecognized AuthPrİ”ty: ", 
auth_´İ”ty_Çme
));

76  
EnşaveAuthCÚ‹xt
(
¡d
::
move
(
id’t™›s
),

77 
¡©ic_ÿ¡
<
RecÜdPrÙocŞ
>(
»cÜd_´ÙocŞ
));

80 
	gEnşaveAuthCÚ‹xt
::
EnşaveAuthCÚ‹xt
(
EnşaveId’t™›s
 
id’t™›s
,

81 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
)

82 : 
id’t™›s_
(
¡d
::
move
(
id’t™›s
)), 
»cÜd_´ÙocŞ_
(
»cÜd_´ÙocŞ
) {}

84 
RecÜdPrÙocŞ
 
	gEnşaveAuthCÚ‹xt
::
G‘RecÜdPrÙocŞ
() const {

85  
»cÜd_´ÙocŞ_
;

88 
boŞ
 
	gEnşaveAuthCÚ‹xt
::
HasEnşaveId’t™y
(

89 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) const {

90  
FšdEnşaveId’t™y
(
desütiÚ
).
ok
();

93 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gEnşaveAuthCÚ‹xt
::
FšdEnşaveId’t™y
(

94 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) const {

95 autØ
™
 = 
¡d
::
fšd_if
(

96 
id’t™›s_
.
id’t™›s
().
cbegš
(), id’t™›s_.id’t™›s().
ûnd
(),

97 [&
desütiÚ
](cÚ¡ 
EnşaveId’t™y
 &
id’t™y
è-> 
boŞ
 {

98  
id’t™y
.
desütiÚ
().
id’t™y_ty³
() ==

99 
desütiÚ
.
id’t™y_ty³
() &&

100 
id’t™y
.
desütiÚ
().
authÜ™y_ty³
() ==

101 
desütiÚ
.
authÜ™y_ty³
();

103 ià(
	g™
 =ğ
id’t™›s_
.
id’t™›s
().
ûnd
()) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
, "No matching identity");

106  &*
	g™
;

	@grpc/auth/enclave_auth_context.h

19 #iâdeà
ASYLO_GRPC_AUTH_ENCLAVE_AUTH_CONTEXT_H_


20 
	#ASYLO_GRPC_AUTH_ENCLAVE_AUTH_CONTEXT_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

27 
	~"šşude/g½ıp/£rv”_cÚ‹xt.h
"

29 
Çme¥aû
 
	gasylo
 {

37 şas 
	cEnşaveAuthCÚ‹xt
 {

38 
	gpublic
:

46 
StusOr
<
EnşaveAuthCÚ‹xt
> 
C»©eFromS”v”CÚ‹xt
(

47 cÚ¡ ::
g½c
::
S”v”CÚ‹xt
 &
£rv”_cÚ‹xt
);

53 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
C»©eFromAuthCÚ‹xt
(

54 cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
auth_cÚ‹xt
);

56 
	gvœtu®
 ~
EnşaveAuthCÚ‹xt
() = ;

62 
vœtu®
 
RecÜdPrÙocŞ
 
G‘RecÜdPrÙocŞ
() const;

69 
vœtu®
 
boŞ
 
HasEnşaveId’t™y
(

70 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) const;

77 
vœtu®
 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
FšdEnşaveId’t™y
(

78 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) const;

80 
	g´Ùeùed
:

81 
EnşaveAuthCÚ‹xt
()

82 : 
id’t™›s_
(), 
»cÜd_´ÙocŞ_
(
UNKNOWN_RECORD_PROTOCOL
) {}

84 
	g´iv©e
:

87 
EnşaveAuthCÚ‹xt
(
EnşaveId’t™›s
 
id’t™›s
,

88 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
);

91 cÚ¡ 
EnşaveId’t™›s
 
	gid’t™›s_
;

94 cÚ¡ 
RecÜdPrÙocŞ
 
	g»cÜd_´ÙocŞ_
;

	@grpc/auth/enclave_auth_context_test.cc

19 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

21 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

22 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/g½c/auth/cÜe/’şave_g½c_£cur™y_cÚ¡ªts.h
"

27 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

28 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

31 
	~"¤c/cÜe/lib/£cur™y/cÚ‹xt/£cur™y_cÚ‹xt.h
"

32 
	~"¤c/ıp/commÚ/£cu»_auth_cÚ‹xt.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
cÚ¡ex´
 
	gkId’t™y
[] = "Identity";

38 
cÚ¡ex´
 
	gkAuthÜ™yTy³1
[] = "Good Authority";

39 
cÚ¡ex´
 
	gkAuthÜ™yTy³2
[] = "Bad Authority";

41 şas 
	cEnşaveAuthCÚ‹xtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

42 
´Ùeùed
:

43 
EnşaveAuthCÚ‹xtTe¡
()

44 : 
£cu»_auth_cÚ‹xt_
(
ab¦
::
make_unique
<::
g½c
::
Secu»AuthCÚ‹xt
>(

45 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
)

46 .
g‘
())) {}

48 
S‘Up
(è
ov”ride
 {

49 
good_id’t™y_desütiÚ_
.
£t_id’t™y_ty³
(

50 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

51 
	ggood_id’t™y_desütiÚ_
.
£t_authÜ™y_ty³
(
kAuthÜ™yTy³1
);

53 
	gbad_id’t™y_desütiÚ_
.
£t_id’t™y_ty³
(

54 
EnşaveId’t™yTy³
::
CERT_IDENTITY
);

55 
	gbad_id’t™y_desütiÚ_
.
£t_authÜ™y_ty³
(
kAuthÜ™yTy³2
);

57 
EnşaveId’t™y
 *
	gid’t™y
 = 
id’t™›s_
.
add_id’t™›s
();

58 
	gid’t™y
->
£t_id’t™y
(
kId’t™y
);

59 *
	gid’t™y
->
mubË_desütiÚ
(èğ
good_id’t™y_desütiÚ_
;

62 
AddEnşaveId’t™›sPrİ”ty
(
id’t™›s_
, 
£cu»_auth_cÚ‹xt_
.
g‘
());

63 
AddRecÜdPrÙocŞPrİ”ty
(
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
,

64 
£cu»_auth_cÚ‹xt_
.
g‘
());

65 
AddT¿n¥ÜtSecur™yTy³Prİ”ty
(
£cu»_auth_cÚ‹xt_
.
g‘
());

70 
AddRecÜdPrÙocŞPrİ”ty
(

71 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
,

72 ::
g½c
::
Secu»AuthCÚ‹xt
 *
£cu»_auth_cÚ‹xt
) {

73 
¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_»cÜd_´ÙocŞ
((
»cÜd_´ÙocŞ
));

74 
	ggoogË
::
´Ùobuf
::
io
::
CodedOuutSŒ—m
::
Wr™eL™eEndŸn32ToA¼ay
(

75 
»cÜd_´ÙocŞ
, 
£rŸlized_»cÜd_´ÙocŞ
.
d©a
());

76 
	g¡d
::
¡ršg
 
»cÜd_´ÙocŞ_¡r
(

77 
»š‹½»t_ÿ¡
<cÚ¡ *>(
£rŸlized_»cÜd_´ÙocŞ
.
d©a
()),

78 
£rŸlized_»cÜd_´ÙocŞ
.
size
());

79 
	g£cu»_auth_cÚ‹xt_
->
AddPrİ”ty
(

80 
GRPC_ENCLAVE_RECORD_PROTOCOL_PROPERTY_NAME
, 
»cÜd_´ÙocŞ_¡r
);

86 
AddEnşaveId’t™›sPrİ”ty
(

87 cÚ¡ 
EnşaveId’t™›s
 &
id’t™›s
,

88 ::
g½c
::
Secu»AuthCÚ‹xt
 *
£cu»_auth_cÚ‹xt
) {

89 
¡d
::
¡ršg
 
£rŸlized_id’t™›s
;

90 
ASSERT_TRUE
(
id’t™›s
.
S”ŸlizeToSŒšg
(&
£rŸlized_id’t™›s
));

91 
	g£cu»_auth_cÚ‹xt
->
AddPrİ”ty
(

92 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
, 
£rŸlized_id’t™›s
);

93 
	g£cu»_auth_cÚ‹xt
->
S‘P“rId’t™yPrİ”tyName
(

94 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
);

99 
AddT¿n¥ÜtSecur™yTy³Prİ”ty
(

100 ::
g½c
::
Secu»AuthCÚ‹xt
 *
£cu»_auth_cÚ‹xt
) {

101 
£cu»_auth_cÚ‹xt
->
AddPrİ”ty
(
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
,

102 
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
);

105 
EnşaveId’t™yDesütiÚ
 
	ggood_id’t™y_desütiÚ_
;

106 
EnşaveId’t™yDesütiÚ
 
	gbad_id’t™y_desütiÚ_
;

107 
	g¡d
::
unique_±r
<::
g½c
::
Secu»AuthCÚ‹xt
> 
£cu»_auth_cÚ‹xt_
;

108 
EnşaveId’t™›s
 
	gid’t™›s_
;

113 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eSucûss
) {

114 
EXPECT_THAT
(
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
),

115 
IsOk
());

120 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasBadId’t™yPrÙo
) {

121 ::
g½c
::
Secu»AuthCÚ‹xt
 
£cu»_auth_cÚ‹xt
(

122 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
).
g‘
());

123 
AddRecÜdPrÙocŞPrİ”ty
(
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
,

124 &
£cu»_auth_cÚ‹xt
);

125 
AddT¿n¥ÜtSecur™yTy³Prİ”ty
(&
£cu»_auth_cÚ‹xt
);

129 
	g£cu»_auth_cÚ‹xt
.
AddPrİ”ty
(
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
,

132 
EXPECT_THAT
(

133 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
£cu»_auth_cÚ‹xt
).
¡©us
(),

134 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

139 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasBadT¿n¥ÜtSecur™yTy³
) {

140 ::
g½c
::
Secu»AuthCÚ‹xt
 
£cu»_auth_cÚ‹xt
(

141 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
).
g‘
());

142 
AddRecÜdPrÙocŞPrİ”ty
(
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
,

143 &
£cu»_auth_cÚ‹xt
);

144 
AddEnşaveId’t™›sPrİ”ty
(
id’t™›s_
, &
£cu»_auth_cÚ‹xt
);

147 
	g£cu»_auth_cÚ‹xt
.
AddPrİ”ty
(
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
,

150 
EXPECT_THAT
(

151 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
£cu»_auth_cÚ‹xt
).
¡©us
(),

152 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

157 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasUÄecognizedAuthPrİ”ty
) {

159 
	g£cu»_auth_cÚ‹xt_
->
AddPrİ”ty
("foo…roperty", "foobar");

161 
EXPECT_THAT
(

162 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
).
¡©us
(),

163 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

168 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasP“rUÇuth’tiÿ‹d
) {

171 ::
g½c
::
Secu»AuthCÚ‹xt
 
£cu»_auth_cÚ‹xt
(

172 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
).
g‘
());

174 
EXPECT_THAT
(

175 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
£cu»_auth_cÚ‹xt
).
¡©us
(),

176 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

181 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
HasEnşaveId’t™y
) {

182 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

183 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

185 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

186 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

188 
EXPECT_TRUE
(
auth_cÚ‹xt
.
HasEnşaveId’t™y
(
good_id’t™y_desütiÚ_
));

189 
EXPECT_FALSE
(
auth_cÚ‹xt
.
HasEnşaveId’t™y
(
bad_id’t™y_desütiÚ_
));

194 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
FšdEnşaveId’t™ySucûss
) {

195 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

196 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

198 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

199 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

201 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

202 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
good_id’t™y_desütiÚ_
);

203 
ASSERT_THAT
(
id’t™y_»suÉ
, 
IsOk
());

205 cÚ¡ 
EnşaveId’t™y
 *
	gid’t™y
 = 
id’t™y_»suÉ
.
V®ueOrD›
();

206 
EXPECT_EQ
(
id’t™y
->id’t™y(), 
kId’t™y
);

207 
EXPECT_THAT
(
id’t™y
->
desütiÚ
(), 
Equ®sPrÙo
(
good_id’t™y_desütiÚ_
));

212 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
FšdEnşaveId’t™yNÙFound
) {

213 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

214 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

216 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

217 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

219 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

220 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
bad_id’t™y_desütiÚ_
);

222 
EXPECT_THAT
(

223 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
bad_id’t™y_desütiÚ_
).
¡©us
(),

224 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
));

228 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
G‘RecÜdPrÙocŞ
) {

229 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

230 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

232 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

233 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

235 
EXPECT_EQ
(
auth_cÚ‹xt
.
G‘RecÜdPrÙocŞ
(), 
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
);

	@grpc/auth/enclave_auth_context_test.cc

19 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

21 
	~<googË/´Ùobuf/io/coded_¡»am.h
>

22 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/g½c/auth/cÜe/’şave_g½c_£cur™y_cÚ¡ªts.h
"

27 
	~"asylo/g½c/auth/cÜe/hªdshake.pb.h
"

28 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

31 
	~"¤c/cÜe/lib/£cur™y/cÚ‹xt/£cur™y_cÚ‹xt.h
"

32 
	~"¤c/ıp/commÚ/£cu»_auth_cÚ‹xt.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
cÚ¡ex´
 
	gkId’t™y
[] = "Identity";

38 
cÚ¡ex´
 
	gkAuthÜ™yTy³1
[] = "Good Authority";

39 
cÚ¡ex´
 
	gkAuthÜ™yTy³2
[] = "Bad Authority";

41 şas 
	cEnşaveAuthCÚ‹xtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

42 
´Ùeùed
:

43 
EnşaveAuthCÚ‹xtTe¡
()

44 : 
£cu»_auth_cÚ‹xt_
(
ab¦
::
make_unique
<::
g½c
::
Secu»AuthCÚ‹xt
>(

45 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
)

46 .
g‘
())) {}

48 
S‘Up
(è
ov”ride
 {

49 
good_id’t™y_desütiÚ_
.
£t_id’t™y_ty³
(

50 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

51 
	ggood_id’t™y_desütiÚ_
.
£t_authÜ™y_ty³
(
kAuthÜ™yTy³1
);

53 
	gbad_id’t™y_desütiÚ_
.
£t_id’t™y_ty³
(

54 
EnşaveId’t™yTy³
::
CERT_IDENTITY
);

55 
	gbad_id’t™y_desütiÚ_
.
£t_authÜ™y_ty³
(
kAuthÜ™yTy³2
);

57 
EnşaveId’t™y
 *
	gid’t™y
 = 
id’t™›s_
.
add_id’t™›s
();

58 
	gid’t™y
->
£t_id’t™y
(
kId’t™y
);

59 *
	gid’t™y
->
mubË_desütiÚ
(èğ
good_id’t™y_desütiÚ_
;

62 
AddEnşaveId’t™›sPrİ”ty
(
id’t™›s_
, 
£cu»_auth_cÚ‹xt_
.
g‘
());

63 
AddRecÜdPrÙocŞPrİ”ty
(
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
,

64 
£cu»_auth_cÚ‹xt_
.
g‘
());

65 
AddT¿n¥ÜtSecur™yTy³Prİ”ty
(
£cu»_auth_cÚ‹xt_
.
g‘
());

70 
AddRecÜdPrÙocŞPrİ”ty
(

71 
RecÜdPrÙocŞ
 
»cÜd_´ÙocŞ
,

72 ::
g½c
::
Secu»AuthCÚ‹xt
 *
£cu»_auth_cÚ‹xt
) {

73 
¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_»cÜd_´ÙocŞ
((
»cÜd_´ÙocŞ
));

74 
	ggoogË
::
´Ùobuf
::
io
::
CodedOuutSŒ—m
::
Wr™eL™eEndŸn32ToA¼ay
(

75 
»cÜd_´ÙocŞ
, 
£rŸlized_»cÜd_´ÙocŞ
.
d©a
());

76 
	g¡d
::
¡ršg
 
»cÜd_´ÙocŞ_¡r
(

77 
»š‹½»t_ÿ¡
<cÚ¡ *>(
£rŸlized_»cÜd_´ÙocŞ
.
d©a
()),

78 
£rŸlized_»cÜd_´ÙocŞ
.
size
());

79 
	g£cu»_auth_cÚ‹xt_
->
AddPrİ”ty
(

80 
GRPC_ENCLAVE_RECORD_PROTOCOL_PROPERTY_NAME
, 
»cÜd_´ÙocŞ_¡r
);

86 
AddEnşaveId’t™›sPrİ”ty
(

87 cÚ¡ 
EnşaveId’t™›s
 &
id’t™›s
,

88 ::
g½c
::
Secu»AuthCÚ‹xt
 *
£cu»_auth_cÚ‹xt
) {

89 
¡d
::
¡ršg
 
£rŸlized_id’t™›s
;

90 
ASSERT_TRUE
(
id’t™›s
.
S”ŸlizeToSŒšg
(&
£rŸlized_id’t™›s
));

91 
	g£cu»_auth_cÚ‹xt
->
AddPrİ”ty
(

92 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
, 
£rŸlized_id’t™›s
);

93 
	g£cu»_auth_cÚ‹xt
->
S‘P“rId’t™yPrİ”tyName
(

94 
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
);

99 
AddT¿n¥ÜtSecur™yTy³Prİ”ty
(

100 ::
g½c
::
Secu»AuthCÚ‹xt
 *
£cu»_auth_cÚ‹xt
) {

101 
£cu»_auth_cÚ‹xt
->
AddPrİ”ty
(
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
,

102 
GRPC_ENCLAVE_TRANSPORT_SECURITY_TYPE
);

105 
EnşaveId’t™yDesütiÚ
 
	ggood_id’t™y_desütiÚ_
;

106 
EnşaveId’t™yDesütiÚ
 
	gbad_id’t™y_desütiÚ_
;

107 
	g¡d
::
unique_±r
<::
g½c
::
Secu»AuthCÚ‹xt
> 
£cu»_auth_cÚ‹xt_
;

108 
EnşaveId’t™›s
 
	gid’t™›s_
;

113 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eSucûss
) {

114 
EXPECT_THAT
(
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
),

115 
IsOk
());

120 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasBadId’t™yPrÙo
) {

121 ::
g½c
::
Secu»AuthCÚ‹xt
 
£cu»_auth_cÚ‹xt
(

122 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
).
g‘
());

123 
AddRecÜdPrÙocŞPrİ”ty
(
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
,

124 &
£cu»_auth_cÚ‹xt
);

125 
AddT¿n¥ÜtSecur™yTy³Prİ”ty
(&
£cu»_auth_cÚ‹xt
);

129 
	g£cu»_auth_cÚ‹xt
.
AddPrİ”ty
(
GRPC_ENCLAVE_IDENTITIES_PROTO_PROPERTY_NAME
,

132 
EXPECT_THAT
(

133 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
£cu»_auth_cÚ‹xt
).
¡©us
(),

134 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

139 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasBadT¿n¥ÜtSecur™yTy³
) {

140 ::
g½c
::
Secu»AuthCÚ‹xt
 
£cu»_auth_cÚ‹xt
(

141 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
).
g‘
());

142 
AddRecÜdPrÙocŞPrİ”ty
(
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
,

143 &
£cu»_auth_cÚ‹xt
);

144 
AddEnşaveId’t™›sPrİ”ty
(
id’t™›s_
, &
£cu»_auth_cÚ‹xt
);

147 
	g£cu»_auth_cÚ‹xt
.
AddPrİ”ty
(
GRPC_TRANSPORT_SECURITY_TYPE_PROPERTY_NAME
,

150 
EXPECT_THAT
(

151 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
£cu»_auth_cÚ‹xt
).
¡©us
(),

152 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

157 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasUÄecognizedAuthPrİ”ty
) {

159 
	g£cu»_auth_cÚ‹xt_
->
AddPrİ”ty
("foo…roperty", "foobar");

161 
EXPECT_THAT
(

162 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
).
¡©us
(),

163 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

168 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
C»©eFasP“rUÇuth’tiÿ‹d
) {

171 ::
g½c
::
Secu»AuthCÚ‹xt
 
£cu»_auth_cÚ‹xt
(

172 
g½c_cÜe
::
MakeRefCouÁed
<
g½c_auth_cÚ‹xt
>Ğ
nuÎ±r
).
g‘
());

174 
EXPECT_THAT
(

175 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
£cu»_auth_cÚ‹xt
).
¡©us
(),

176 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

181 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
HasEnşaveId’t™y
) {

182 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

183 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

185 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

186 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

188 
EXPECT_TRUE
(
auth_cÚ‹xt
.
HasEnşaveId’t™y
(
good_id’t™y_desütiÚ_
));

189 
EXPECT_FALSE
(
auth_cÚ‹xt
.
HasEnşaveId’t™y
(
bad_id’t™y_desütiÚ_
));

194 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
FšdEnşaveId’t™ySucûss
) {

195 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

196 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

198 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

199 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

201 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

202 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
good_id’t™y_desütiÚ_
);

203 
ASSERT_THAT
(
id’t™y_»suÉ
, 
IsOk
());

205 cÚ¡ 
EnşaveId’t™y
 *
	gid’t™y
 = 
id’t™y_»suÉ
.
V®ueOrD›
();

206 
EXPECT_EQ
(
id’t™y
->id’t™y(), 
kId’t™y
);

207 
EXPECT_THAT
(
id’t™y
->
desütiÚ
(), 
Equ®sPrÙo
(
good_id’t™y_desütiÚ_
));

212 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
FšdEnşaveId’t™yNÙFound
) {

213 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

214 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

216 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

217 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

219 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

220 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
bad_id’t™y_desütiÚ_
);

222 
EXPECT_THAT
(

223 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
bad_id’t™y_desütiÚ_
).
¡©us
(),

224 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
));

228 
TEST_F
(
EnşaveAuthCÚ‹xtTe¡
, 
G‘RecÜdPrÙocŞ
) {

229 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

230 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(*
£cu»_auth_cÚ‹xt_
);

232 
ASSERT_THAT
(
auth_cÚ‹xt_»suÉ
, 
IsOk
());

233 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

235 
EXPECT_EQ
(
auth_cÚ‹xt
.
G‘RecÜdPrÙocŞ
(), 
RecÜdPrÙocŞ
::
SEAL_AES128_GCM
);

	@grpc/auth/enclave_channel_credentials.cc

19 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

21 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

22 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

23 
	~"¤c/ıp/ş›Á/£cu»_üed’tŸls.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
EnşaveChªÃlC»d’tŸls
(

28 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

30 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İts
;

31 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İts
);

32 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İts
);

35 autØ
	güeds
 = 
¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
>(

36 
Ãw
 ::
g½c
::
Secu»ChªÃlC»d’tŸls
(

37 
g½c_’şave_chªÃl_üed’tŸls_ü—‹
(&
c_İts
).
»Ëa£
()));

38 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(&
c_İts
);

39  
	güeds
;

	@grpc/auth/enclave_channel_credentials.cc

19 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

21 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

22 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

23 
	~"¤c/ıp/ş›Á/£cu»_üed’tŸls.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
EnşaveChªÃlC»d’tŸls
(

28 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

30 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İts
;

31 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İts
);

32 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İts
);

35 autØ
	güeds
 = 
¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
>(

36 
Ãw
 ::
g½c
::
Secu»ChªÃlC»d’tŸls
(

37 
g½c_’şave_chªÃl_üed’tŸls_ü—‹
(&
c_İts
).
»Ëa£
()));

38 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(&
c_İts
);

39  
	güeds
;

	@grpc/auth/enclave_channel_credentials.h

19 #iâdeà
ASYLO_GRPC_AUTH_ENCLAVE_CHANNEL_CREDENTIALS_H_


20 
	#ASYLO_GRPC_AUTH_ENCLAVE_CHANNEL_CREDENTIALS_H_


	)

22 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

24 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

25 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

27 
Çme¥aû
 
	gasylo
 {

42 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
EnşaveChªÃlC»d’tŸls
(

43 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
);

	@grpc/auth/enclave_credentials_options.cc

18 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

20 
Çme¥aû
 
	gasylo
 {

22 
	gEnşaveC»d’tŸlsO±iÚs
 &EnşaveC»d’tŸlsO±iÚs::
Add
(

23 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
add™iÚ®
) {

24 
£lf_as£¹iÚs
.
š£¹
(
add™iÚ®
.£lf_as£¹iÚs.
begš
(),

25 
add™iÚ®
.
£lf_as£¹iÚs
.
’d
());

26 
	gacû±ed_³”_as£¹iÚs
.
š£¹
(
add™iÚ®
.
acû±ed_³”_as£¹iÚs
.
begš
(),

27 
add™iÚ®
.
acû±ed_³”_as£¹iÚs
.
’d
());

28  *
	gthis
;

	@grpc/auth/enclave_credentials_options.cc

18 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

20 
Çme¥aû
 
	gasylo
 {

22 
	gEnşaveC»d’tŸlsO±iÚs
 &EnşaveC»d’tŸlsO±iÚs::
Add
(

23 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
add™iÚ®
) {

24 
£lf_as£¹iÚs
.
š£¹
(
add™iÚ®
.£lf_as£¹iÚs.
begš
(),

25 
add™iÚ®
.
£lf_as£¹iÚs
.
’d
());

26 
	gacû±ed_³”_as£¹iÚs
.
š£¹
(
add™iÚ®
.
acû±ed_³”_as£¹iÚs
.
begš
(),

27 
add™iÚ®
.
acû±ed_³”_as£¹iÚs
.
’d
());

28  *
	gthis
;

	@grpc/auth/enclave_credentials_options.h

19 #iâdeà
ASYLO_GRPC_AUTH_ENCLAVE_CREDENTIALS_OPTIONS_H_


20 
	#ASYLO_GRPC_AUTH_ENCLAVE_CREDENTIALS_OPTIONS_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

31 
	sEnşaveC»d’tŸlsO±iÚs
 {

37 
	gEnşaveC»d’tŸlsO±iÚs
 &
Add
(

38 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
add™iÚ®_İtiÚs
);

42 
	g¡d
::
¡ršg
 
add™iÚ®_auth’tiÿ‹d_d©a
;

45 
As£¹iÚDesütiÚHashS‘
 
	g£lf_as£¹iÚs
;

48 
As£¹iÚDesütiÚHashS‘
 
	gacû±ed_³”_as£¹iÚs
;

	@grpc/auth/enclave_credentials_options_test.cc

19 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

23 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

24 
	~"asylo/id’t™y/desütiÚs.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
Te¡
;

32 
	gusšg
 ::
‹¡šg
::
UnÜd”edEËm’tsA»
;

35 şas 
	cEnşaveC»d’tŸlsO±iÚsTe¡
 : 
public
 
Te¡
 {

36 
´Ùeùed
:

37 
EnşaveC»d’tŸlsO±iÚsTe¡
() {

38 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
sgx_loÿl_as£¹iÚ_desütiÚ_
);

39 
S‘NuÎAs£¹iÚDesütiÚ
(&
nuÎ_as£¹iÚ_desütiÚ_
);

41 
As£¹iÚDesütiÚ
 
	gsgx_loÿl_as£¹iÚ_desütiÚ_
;

42 
As£¹iÚDesütiÚ
 
	gnuÎ_as£¹iÚ_desütiÚ_
;

45 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
S–fNuÎP“rSgxLoÿl
) {

46 
EnşaveC»d’tŸlsO±iÚs
 
	g£lf_nuÎ_³”_sgx_loÿl
 =

47 
P“rSgxLoÿlC»d’tŸlsO±iÚs
().
Add
(
S–fNuÎC»d’tŸlsO±iÚs
());

48 
EXPECT_THAT
(
£lf_nuÎ_³”_sgx_loÿl
.
£lf_as£¹iÚs
,

49 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
)));

50 
EXPECT_THAT
(

51 
£lf_nuÎ_³”_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

52 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

57 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
S–fSgxLoÿlP“rSgxLoÿlSgxLoÿl
) {

58 
EnşaveC»d’tŸlsO±iÚs
 
	g£lf_sgx_loÿl_³”_sgx_loÿl_sgx_loÿl
 =

59 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
().
Add
(

60 
P“rSgxLoÿlC»d’tŸlsO±iÚs
());

61 
EXPECT_THAT
(

62 
£lf_sgx_loÿl_³”_sgx_loÿl_sgx_loÿl
.
£lf_as£¹iÚs
,

63 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

64 
EXPECT_THAT
(

65 
£lf_sgx_loÿl_³”_sgx_loÿl_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

66 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

69 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
BidœeùiÚ®NuÎ
) {

70 
EnşaveC»d’tŸlsO±iÚs
 
	gbidœeùiÚ®_nuÎ
 =

71 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
();

72 
EXPECT_THAT
(
bidœeùiÚ®_nuÎ
.
£lf_as£¹iÚs
,

73 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
)));

74 
EXPECT_THAT
(
bidœeùiÚ®_nuÎ
.
acû±ed_³”_as£¹iÚs
,

75 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
)));

78 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
BidœeùiÚ®SgxLoÿl
) {

79 
EnşaveC»d’tŸlsO±iÚs
 
	gbidœeùiÚ®_sgx_loÿl
 =

80 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
();

81 
EXPECT_THAT
(

82 
bidœeùiÚ®_sgx_loÿl
.
£lf_as£¹iÚs
,

83 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

84 
EXPECT_THAT
(

85 
bidœeùiÚ®_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

86 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

89 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
BidœeùiÚ®SgxLoÿlNuÎ
) {

90 
EnşaveC»d’tŸlsO±iÚs
 
	gbidœeùiÚ®_nuÎ_sgx_loÿl
 =

91 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
().
Add
(

92 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
());

93 
EXPECT_THAT
(

94 
bidœeùiÚ®_nuÎ_sgx_loÿl
.
£lf_as£¹iÚs
,

95 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
),

96 
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

97 
EXPECT_THAT
(

98 
bidœeùiÚ®_nuÎ_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

99 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
),

100 
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

	@grpc/auth/enclave_credentials_options_test.cc

19 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

23 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

24 
	~"asylo/id’t™y/desütiÚs.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
Te¡
;

32 
	gusšg
 ::
‹¡šg
::
UnÜd”edEËm’tsA»
;

35 şas 
	cEnşaveC»d’tŸlsO±iÚsTe¡
 : 
public
 
Te¡
 {

36 
´Ùeùed
:

37 
EnşaveC»d’tŸlsO±iÚsTe¡
() {

38 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
sgx_loÿl_as£¹iÚ_desütiÚ_
);

39 
S‘NuÎAs£¹iÚDesütiÚ
(&
nuÎ_as£¹iÚ_desütiÚ_
);

41 
As£¹iÚDesütiÚ
 
	gsgx_loÿl_as£¹iÚ_desütiÚ_
;

42 
As£¹iÚDesütiÚ
 
	gnuÎ_as£¹iÚ_desütiÚ_
;

45 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
S–fNuÎP“rSgxLoÿl
) {

46 
EnşaveC»d’tŸlsO±iÚs
 
	g£lf_nuÎ_³”_sgx_loÿl
 =

47 
P“rSgxLoÿlC»d’tŸlsO±iÚs
().
Add
(
S–fNuÎC»d’tŸlsO±iÚs
());

48 
EXPECT_THAT
(
£lf_nuÎ_³”_sgx_loÿl
.
£lf_as£¹iÚs
,

49 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
)));

50 
EXPECT_THAT
(

51 
£lf_nuÎ_³”_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

52 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

57 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
S–fSgxLoÿlP“rSgxLoÿlSgxLoÿl
) {

58 
EnşaveC»d’tŸlsO±iÚs
 
	g£lf_sgx_loÿl_³”_sgx_loÿl_sgx_loÿl
 =

59 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
().
Add
(

60 
P“rSgxLoÿlC»d’tŸlsO±iÚs
());

61 
EXPECT_THAT
(

62 
£lf_sgx_loÿl_³”_sgx_loÿl_sgx_loÿl
.
£lf_as£¹iÚs
,

63 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

64 
EXPECT_THAT
(

65 
£lf_sgx_loÿl_³”_sgx_loÿl_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

66 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

69 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
BidœeùiÚ®NuÎ
) {

70 
EnşaveC»d’tŸlsO±iÚs
 
	gbidœeùiÚ®_nuÎ
 =

71 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
();

72 
EXPECT_THAT
(
bidœeùiÚ®_nuÎ
.
£lf_as£¹iÚs
,

73 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
)));

74 
EXPECT_THAT
(
bidœeùiÚ®_nuÎ
.
acû±ed_³”_as£¹iÚs
,

75 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
)));

78 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
BidœeùiÚ®SgxLoÿl
) {

79 
EnşaveC»d’tŸlsO±iÚs
 
	gbidœeùiÚ®_sgx_loÿl
 =

80 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
();

81 
EXPECT_THAT
(

82 
bidœeùiÚ®_sgx_loÿl
.
£lf_as£¹iÚs
,

83 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

84 
EXPECT_THAT
(

85 
bidœeùiÚ®_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

86 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

89 
TEST_F
(
EnşaveC»d’tŸlsO±iÚsTe¡
, 
BidœeùiÚ®SgxLoÿlNuÎ
) {

90 
EnşaveC»d’tŸlsO±iÚs
 
	gbidœeùiÚ®_nuÎ_sgx_loÿl
 =

91 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
().
Add
(

92 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
());

93 
EXPECT_THAT
(

94 
bidœeùiÚ®_nuÎ_sgx_loÿl
.
£lf_as£¹iÚs
,

95 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
),

96 
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

97 
EXPECT_THAT
(

98 
bidœeùiÚ®_nuÎ_sgx_loÿl
.
acû±ed_³”_as£¹iÚs
,

99 
UnÜd”edEËm’tsA»
(
Equ®sPrÙo
(
nuÎ_as£¹iÚ_desütiÚ_
),

100 
Equ®sPrÙo
(
sgx_loÿl_as£¹iÚ_desütiÚ_
)));

	@grpc/auth/enclave_server_credentials.cc

19 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

21 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

22 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

23 
	~"¤c/ıp/£rv”/£cu»_£rv”_üed’tŸls.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
	g¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
EnşaveS”v”C»d’tŸls
(

28 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

30 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İts
;

31 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İts
);

32 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İts
);

35 autØ
	güeds
 = 
¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
>(

36 
Ãw
 ::
g½c
::
Secu»S”v”C»d’tŸls
(

37 
g½c_’şave_£rv”_üed’tŸls_ü—‹
(&
c_İts
).
»Ëa£
()));

38 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(&
c_İts
);

39  
	güeds
;

	@grpc/auth/enclave_server_credentials.cc

19 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

21 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

22 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

23 
	~"¤c/ıp/£rv”/£cu»_£rv”_üed’tŸls.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
	g¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
EnşaveS”v”C»d’tŸls
(

28 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

30 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İts
;

31 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İts
);

32 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İts
);

35 autØ
	güeds
 = 
¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
>(

36 
Ãw
 ::
g½c
::
Secu»S”v”C»d’tŸls
(

37 
g½c_’şave_£rv”_üed’tŸls_ü—‹
(&
c_İts
).
»Ëa£
()));

38 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(&
c_İts
);

39  
	güeds
;

	@grpc/auth/enclave_server_credentials.h

19 #iâdeà
ASYLO_GRPC_AUTH_ENCLAVE_SERVER_CREDENTIALS_H_


20 
	#ASYLO_GRPC_AUTH_ENCLAVE_SERVER_CREDENTIALS_H_


	)

22 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

24 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

25 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

27 
Çme¥aû
 
	gasylo
 {

42 
	g¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
EnşaveS”v”C»d’tŸls
(

43 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
);

	@grpc/auth/null_credentials_options.cc

19 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

21 
	~<ut™y
>

23 
	~"asylo/id’t™y/desütiÚs.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
EnşaveC»d’tŸlsO±iÚs
 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
() {

28  
S–fNuÎC»d’tŸlsO±iÚs
().
Add
(
P“rNuÎC»d’tŸlsO±iÚs
());

31 
EnşaveC»d’tŸlsO±iÚs
 
P“rNuÎC»d’tŸlsO±iÚs
() {

32 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

33 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

34 
S‘NuÎAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

35 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

36  
	gİtiÚs
;

39 
EnşaveC»d’tŸlsO±iÚs
 
S–fNuÎC»d’tŸlsO±iÚs
() {

40 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

41 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

42 
S‘NuÎAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

43 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

44  
	gİtiÚs
;

	@grpc/auth/null_credentials_options.cc

19 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

21 
	~<ut™y
>

23 
	~"asylo/id’t™y/desütiÚs.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
EnşaveC»d’tŸlsO±iÚs
 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
() {

28  
S–fNuÎC»d’tŸlsO±iÚs
().
Add
(
P“rNuÎC»d’tŸlsO±iÚs
());

31 
EnşaveC»d’tŸlsO±iÚs
 
P“rNuÎC»d’tŸlsO±iÚs
() {

32 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

33 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

34 
S‘NuÎAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

35 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

36  
	gİtiÚs
;

39 
EnşaveC»d’tŸlsO±iÚs
 
S–fNuÎC»d’tŸlsO±iÚs
() {

40 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

41 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

42 
S‘NuÎAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

43 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

44  
	gİtiÚs
;

	@grpc/auth/null_credentials_options.h

19 #iâdeà
ASYLO_GRPC_AUTH_NULL_CREDENTIALS_OPTIONS_H_


20 
	#ASYLO_GRPC_AUTH_NULL_CREDENTIALS_OPTIONS_H_


	)

22 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

24 
Çme¥aû
 
	gasylo
 {

50 
EnşaveC»d’tŸlsO±iÚs
 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
();

76 
EnşaveC»d’tŸlsO±iÚs
 
P“rNuÎC»d’tŸlsO±iÚs
();

102 
EnşaveC»d’tŸlsO±iÚs
 
S–fNuÎC»d’tŸlsO±iÚs
();

	@grpc/auth/peer_identity_util.cc

18 
	~"asylo/g½c/auth/³”_id’t™y_ut.h
"

20 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

21 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

22 
	~"asylo/id’t™y/d–eg©šg_id’t™y_ex³ù©iÚ_m©ch”.h
"

23 
	~"asylo/id’t™y/desütiÚs.h
"

24 
	~"asylo/id’t™y/id’t™y.pb.h
"

25 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
Stus
 
ExŒaùAndCheckP“rSgxCodeId’t™y
(cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
cÚ‹xt
,

32 
sgx
::
CodeId’t™y
 *
code_id’t™y
) {

33 
StusOr
<
EnşaveAuthCÚ‹xt
> 
auth_cÚ‹xt_»suÉ
 =

34 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
cÚ‹xt
);

35 ià(!
	gauth_cÚ‹xt_»suÉ
.
ok
()) {

36 
LOG
(
ERROR
) << "CreateFromServerContext failed: "

37 << 
	gauth_cÚ‹xt_»suÉ
.
¡©us
();

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

42 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

43 
EnşaveId’t™yDesütiÚ
 
	gcode_id’t™y_desütiÚ
;

44 
S‘SgxId’t™yDesütiÚ
(&
code_id’t™y_desütiÚ
);

45 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

46 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
code_id’t™y_desütiÚ
);

47 ià(!
	gid’t™y_»suÉ
.
ok
()) {

48 
LOG
(
ERROR
è<< "FšdEnşaveId’t™y faed: " << 
	gid’t™y_»suÉ
.
¡©us
();

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

52  
	gsgx
::
P¬£SgxId’t™y
(*
id’t™y_»suÉ
.
V®ueOrD›
(), 
code_id’t™y
);

55 
	gStusOr
<
	gboŞ
> 
ExŒaùAndM©chEnşaveId’t™y
(

56 cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
cÚ‹xt
,

57 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
id’t™y_ex³ù©iÚ
) {

58 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

59 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
cÚ‹xt
);

60 ià(!
	gauth_cÚ‹xt_»suÉ
.
ok
()) {

61 
LOG
(
ERROR
) << "CreateFromServerContext failed: "

62 << 
	gauth_cÚ‹xt_»suÉ
.
¡©us
();

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

67 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

68 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

69  
ExŒaùAndM©chEnşaveId’t™y
(
auth_cÚ‹xt
, 
id’t™y_ex³ù©iÚ
,

70 
m©ch”
);

73 
	gStusOr
<
	gboŞ
> 
ExŒaùAndM©chEnşaveId’t™y
(

74 cÚ¡ 
EnşaveAuthCÚ‹xt
 &
’şave_auth_cÚ‹xt
,

75 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
id’t™y_ex³ù©iÚ
,

76 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
id’t™y_ex³ù©iÚ_m©ch”
) {

77 
EnşaveId’t™yDesütiÚ
 
	gid’t™y_desütiÚ
 =

78 
id’t™y_ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
();

79 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

80 
’şave_auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
id’t™y_desütiÚ
);

81 ià(!
	gid’t™y_»suÉ
.
ok
()) {

82 
LOG
(
ERROR
è<< "FšdEnşaveId’t™y faed: " << 
	gid’t™y_»suÉ
.
¡©us
();

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

84 
ab¦
::
SŒC©
("Peer does‚ot have identity ",

85 
id’t™y_desütiÚ
.
ShÜtDebugSŒšg
()));

88 cÚ¡ 
EnşaveId’t™y
 *
	gid’t™y
 = 
id’t™y_»suÉ
.
V®ueOrD›
();

89 
	gStusOr
<
	gboŞ
> 
	gm©ch_»suÉ
 =

90 
id’t™y_ex³ù©iÚ_m©ch”
.
M©ch
(*
id’t™y
, 
id’t™y_ex³ù©iÚ
);

91 ià(!
	gm©ch_»suÉ
.
ok
()) {

92 
LOG
(
ERROR
) << "Matching identity‡ndƒxpectation failed: "

93 << 
	gm©ch_»suÉ
.
¡©us
();

94  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

97  
	gm©ch_»suÉ
.
V®ueOrD›
();

	@grpc/auth/peer_identity_util.cc

18 
	~"asylo/g½c/auth/³”_id’t™y_ut.h
"

20 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

21 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

22 
	~"asylo/id’t™y/d–eg©šg_id’t™y_ex³ù©iÚ_m©ch”.h
"

23 
	~"asylo/id’t™y/desütiÚs.h
"

24 
	~"asylo/id’t™y/id’t™y.pb.h
"

25 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
Stus
 
ExŒaùAndCheckP“rSgxCodeId’t™y
(cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
cÚ‹xt
,

32 
sgx
::
CodeId’t™y
 *
code_id’t™y
) {

33 
StusOr
<
EnşaveAuthCÚ‹xt
> 
auth_cÚ‹xt_»suÉ
 =

34 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
cÚ‹xt
);

35 ià(!
	gauth_cÚ‹xt_»suÉ
.
ok
()) {

36 
LOG
(
ERROR
) << "CreateFromServerContext failed: "

37 << 
	gauth_cÚ‹xt_»suÉ
.
¡©us
();

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

42 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

43 
EnşaveId’t™yDesütiÚ
 
	gcode_id’t™y_desütiÚ
;

44 
S‘SgxId’t™yDesütiÚ
(&
code_id’t™y_desütiÚ
);

45 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

46 
auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
code_id’t™y_desütiÚ
);

47 ià(!
	gid’t™y_»suÉ
.
ok
()) {

48 
LOG
(
ERROR
è<< "FšdEnşaveId’t™y faed: " << 
	gid’t™y_»suÉ
.
¡©us
();

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

52  
	gsgx
::
P¬£SgxId’t™y
(*
id’t™y_»suÉ
.
V®ueOrD›
(), 
code_id’t™y
);

55 
	gStusOr
<
	gboŞ
> 
ExŒaùAndM©chEnşaveId’t™y
(

56 cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
cÚ‹xt
,

57 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
id’t™y_ex³ù©iÚ
) {

58 
	gStusOr
<
	gEnşaveAuthCÚ‹xt
> 
	gauth_cÚ‹xt_»suÉ
 =

59 
EnşaveAuthCÚ‹xt
::
C»©eFromAuthCÚ‹xt
(
cÚ‹xt
);

60 ià(!
	gauth_cÚ‹xt_»suÉ
.
ok
()) {

61 
LOG
(
ERROR
) << "CreateFromServerContext failed: "

62 << 
	gauth_cÚ‹xt_»suÉ
.
¡©us
();

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

67 
EnşaveAuthCÚ‹xt
 
	gauth_cÚ‹xt
 = 
auth_cÚ‹xt_»suÉ
.
V®ueOrD›
();

68 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

69  
ExŒaùAndM©chEnşaveId’t™y
(
auth_cÚ‹xt
, 
id’t™y_ex³ù©iÚ
,

70 
m©ch”
);

73 
	gStusOr
<
	gboŞ
> 
ExŒaùAndM©chEnşaveId’t™y
(

74 cÚ¡ 
EnşaveAuthCÚ‹xt
 &
’şave_auth_cÚ‹xt
,

75 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
id’t™y_ex³ù©iÚ
,

76 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
id’t™y_ex³ù©iÚ_m©ch”
) {

77 
EnşaveId’t™yDesütiÚ
 
	gid’t™y_desütiÚ
 =

78 
id’t™y_ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
();

79 
	gStusOr
<cÚ¡ 
	gEnşaveId’t™y
 *> 
	gid’t™y_»suÉ
 =

80 
’şave_auth_cÚ‹xt
.
FšdEnşaveId’t™y
(
id’t™y_desütiÚ
);

81 ià(!
	gid’t™y_»suÉ
.
ok
()) {

82 
LOG
(
ERROR
è<< "FšdEnşaveId’t™y faed: " << 
	gid’t™y_»suÉ
.
¡©us
();

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

84 
ab¦
::
SŒC©
("Peer does‚ot have identity ",

85 
id’t™y_desütiÚ
.
ShÜtDebugSŒšg
()));

88 cÚ¡ 
EnşaveId’t™y
 *
	gid’t™y
 = 
id’t™y_»suÉ
.
V®ueOrD›
();

89 
	gStusOr
<
	gboŞ
> 
	gm©ch_»suÉ
 =

90 
id’t™y_ex³ù©iÚ_m©ch”
.
M©ch
(*
id’t™y
, 
id’t™y_ex³ù©iÚ
);

91 ià(!
	gm©ch_»suÉ
.
ok
()) {

92 
LOG
(
ERROR
) << "Matching identity‡ndƒxpectation failed: "

93 << 
	gm©ch_»suÉ
.
¡©us
();

94  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

97  
	gm©ch_»suÉ
.
V®ueOrD›
();

	@grpc/auth/peer_identity_util.h

19 #iâdeà
ASYLO_GRPC_AUTH_PEER_IDENTITY_UTIL_H_


20 
	#ASYLO_GRPC_AUTH_PEER_IDENTITY_UTIL_H_


	)

22 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

23 
	~"asylo/id’t™y/id’t™y.pb.h
"

24 
	~"asylo/id’t™y/id’t™y_ex³ù©iÚ_m©ch”.h
"

25 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

28 
	~"šşude/g½ıp/im¶/codeg’/£cur™y/auth_cÚ‹xt.h
"

30 
Çme¥aû
 
	gasylo
 {

38 
Stus
 
ExŒaùAndCheckP“rSgxCodeId’t™y
(cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
cÚ‹xt
,

39 
sgx
::
CodeId’t™y
 *
code_id’t™y
);

50 
	gStusOr
<
	gboŞ
> 
ExŒaùAndM©chEnşaveId’t™y
(

51 cÚ¡ ::
g½c
::
AuthCÚ‹xt
 &
cÚ‹xt
,

52 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
id’t™y_ex³ù©iÚ
);

57 
	gStusOr
<
	gboŞ
> 
ExŒaùAndM©chEnşaveId’t™y
(

58 cÚ¡ 
EnşaveAuthCÚ‹xt
 &
’şave_auth_cÚ‹xt
,

59 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
id’t™y_ex³ù©iÚ
,

60 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
);

	@grpc/auth/peer_identity_util_test.cc

18 
	~"asylo/g½c/auth/³”_id’t™y_ut.h
"

20 
	~<memÜy
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/g½c/auth/‹¡/mock_’şave_auth_cÚ‹xt.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

28 
	~"asylo/id’t™y/‹¡/mock_id’t™y_ex³ù©iÚ_m©ch”.h
"

29 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
	gusšg
 ::
‹¡šg
::
R‘uº
;

36 
	gusšg
 ::
‹¡šg
::
SŒiùMock
;

37 
	gusšg
 ::
‹¡šg
::
Te¡
;

39 şas 
	cP“rId’t™yUtTe¡
 : 
public
 
Te¡
 {

40 
´Ùeùed
:

41 
S‘Up
(è
ov”ride
 {

43 
sgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

44 
	gsgx
::
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
(&
code_id’t™y_ex³ù©iÚ
);

45 
ASYLO_ASSERT_OK
(
sgx
::
S”ŸlizeSgxEx³ù©iÚ
(

46 
code_id’t™y_ex³ù©iÚ
, &
’şave_id’t™y_ex³ù©iÚ_
));

48 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

49 
	gsgx
::
S‘S–fCodeId’t™y
(&
code_id’t™y
);

50 
ASYLO_ASSERT_OK
(

51 
sgx
::
S”ŸlizeSgxId’t™y
(
code_id’t™y
, &
’şave_id’t™y_
));

54 
	g´Ùeùed
:

55 
SŒiùMock
<
MockEnşaveAuthCÚ‹xt
> 
mock_’şave_auth_cÚ‹xt_
;

56 
EnşaveId’t™y
 
	g’şave_id’t™y_
;

57 
EnşaveId’t™yEx³ù©iÚ
 
	g’şave_id’t™y_ex³ù©iÚ_
;

58 
MockId’t™yEx³ù©iÚM©ch”
 
	gmock_id’t™y_ex³ù©iÚ_m©ch”_
;

61 
TEST_F
(
P“rId’t™yUtTe¡
, 
ExŒaùAndM©chEnşaveId’t™ySucûedsAndM©ches
) {

64 
EXPECT_CALL
(

65 
mock_’şave_auth_cÚ‹xt_
,

66 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

67 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

68 .
WlOnû
(
R‘uº
(&
’şave_id’t™y_
));

69 
EXPECT_CALL
(
mock_id’t™y_ex³ù©iÚ_m©ch”_
,

70 
M©ch
(
Equ®sPrÙo
(
’şave_id’t™y_
),

71 
Equ®sPrÙo
(
’şave_id’t™y_ex³ù©iÚ_
)))

72 .
WlOnû
(
R‘uº
(
Œue
));

74 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(

75 
mock_’şave_auth_cÚ‹xt_
, 
’şave_id’t™y_ex³ù©iÚ_
,

76 
mock_id’t™y_ex³ù©iÚ_m©ch”_
),

77 
IsOkAndHŞds
(
Œue
));

80 
TEST_F
(
P“rId’t™yUtTe¡
,

81 
ExŒaùAndM©chEnşaveId’t™ySucûedsAndDÛsNÙM©ch
) {

85 
EXPECT_CALL
(

86 
mock_’şave_auth_cÚ‹xt_
,

87 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

88 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

89 .
WlOnû
(
R‘uº
(&
’şave_id’t™y_
));

90 
EXPECT_CALL
(
mock_id’t™y_ex³ù©iÚ_m©ch”_
,

91 
M©ch
(
Equ®sPrÙo
(
’şave_id’t™y_
),

92 
Equ®sPrÙo
(
’şave_id’t™y_ex³ù©iÚ_
)))

93 .
WlOnû
(
R‘uº
(
çl£
));

95 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(

96 
mock_’şave_auth_cÚ‹xt_
, 
’şave_id’t™y_ex³ù©iÚ_
,

97 
mock_id’t™y_ex³ù©iÚ_m©ch”_
),

98 
IsOkAndHŞds
(
çl£
));

101 
TEST_F
(
P“rId’t™yUtTe¡
, 
ExŒaùAndM©chEnşaveId’t™yFšdId’t™yFas
) {

104 
EXPECT_CALL
(

105 
mock_’şave_auth_cÚ‹xt_
,

106 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

107 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

108 .
WlOnû
(
R‘uº
(
Stus
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
, "")));

110 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(
mock_’şave_auth_cÚ‹xt_
,

111 
’şave_id’t™y_ex³ù©iÚ_
,

112 
mock_id’t™y_ex³ù©iÚ_m©ch”_
)

113 .
¡©us
(),

114 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
));

117 
TEST_F
(
P“rId’t™yUtTe¡
, 
ExŒaùAndM©chEnşaveId’t™yM©ch”Fas
) {

119 
EXPECT_CALL
(

120 
mock_’şave_auth_cÚ‹xt_
,

121 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

122 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

123 .
WlOnû
(
R‘uº
(&
’şave_id’t™y_
));

124 
EXPECT_CALL
(
mock_id’t™y_ex³ù©iÚ_m©ch”_
,

125 
M©ch
(
Equ®sPrÙo
(
’şave_id’t™y_
),

126 
Equ®sPrÙo
(
’şave_id’t™y_ex³ù©iÚ_
)))

127 .
WlOnû
(
R‘uº
(
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "")));

129 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(
mock_’şave_auth_cÚ‹xt_
,

130 
’şave_id’t™y_ex³ù©iÚ_
,

131 
mock_id’t™y_ex³ù©iÚ_m©ch”_
)

132 .
¡©us
(),

133 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

	@grpc/auth/peer_identity_util_test.cc

18 
	~"asylo/g½c/auth/³”_id’t™y_ut.h
"

20 
	~<memÜy
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/g½c/auth/‹¡/mock_’şave_auth_cÚ‹xt.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

28 
	~"asylo/id’t™y/‹¡/mock_id’t™y_ex³ù©iÚ_m©ch”.h
"

29 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
	gusšg
 ::
‹¡šg
::
R‘uº
;

36 
	gusšg
 ::
‹¡šg
::
SŒiùMock
;

37 
	gusšg
 ::
‹¡šg
::
Te¡
;

39 şas 
	cP“rId’t™yUtTe¡
 : 
public
 
Te¡
 {

40 
´Ùeùed
:

41 
S‘Up
(è
ov”ride
 {

43 
sgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

44 
	gsgx
::
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
(&
code_id’t™y_ex³ù©iÚ
);

45 
ASYLO_ASSERT_OK
(
sgx
::
S”ŸlizeSgxEx³ù©iÚ
(

46 
code_id’t™y_ex³ù©iÚ
, &
’şave_id’t™y_ex³ù©iÚ_
));

48 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

49 
	gsgx
::
S‘S–fCodeId’t™y
(&
code_id’t™y
);

50 
ASYLO_ASSERT_OK
(

51 
sgx
::
S”ŸlizeSgxId’t™y
(
code_id’t™y
, &
’şave_id’t™y_
));

54 
	g´Ùeùed
:

55 
SŒiùMock
<
MockEnşaveAuthCÚ‹xt
> 
mock_’şave_auth_cÚ‹xt_
;

56 
EnşaveId’t™y
 
	g’şave_id’t™y_
;

57 
EnşaveId’t™yEx³ù©iÚ
 
	g’şave_id’t™y_ex³ù©iÚ_
;

58 
MockId’t™yEx³ù©iÚM©ch”
 
	gmock_id’t™y_ex³ù©iÚ_m©ch”_
;

61 
TEST_F
(
P“rId’t™yUtTe¡
, 
ExŒaùAndM©chEnşaveId’t™ySucûedsAndM©ches
) {

64 
EXPECT_CALL
(

65 
mock_’şave_auth_cÚ‹xt_
,

66 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

67 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

68 .
WlOnû
(
R‘uº
(&
’şave_id’t™y_
));

69 
EXPECT_CALL
(
mock_id’t™y_ex³ù©iÚ_m©ch”_
,

70 
M©ch
(
Equ®sPrÙo
(
’şave_id’t™y_
),

71 
Equ®sPrÙo
(
’şave_id’t™y_ex³ù©iÚ_
)))

72 .
WlOnû
(
R‘uº
(
Œue
));

74 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(

75 
mock_’şave_auth_cÚ‹xt_
, 
’şave_id’t™y_ex³ù©iÚ_
,

76 
mock_id’t™y_ex³ù©iÚ_m©ch”_
),

77 
IsOkAndHŞds
(
Œue
));

80 
TEST_F
(
P“rId’t™yUtTe¡
,

81 
ExŒaùAndM©chEnşaveId’t™ySucûedsAndDÛsNÙM©ch
) {

85 
EXPECT_CALL
(

86 
mock_’şave_auth_cÚ‹xt_
,

87 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

88 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

89 .
WlOnû
(
R‘uº
(&
’şave_id’t™y_
));

90 
EXPECT_CALL
(
mock_id’t™y_ex³ù©iÚ_m©ch”_
,

91 
M©ch
(
Equ®sPrÙo
(
’şave_id’t™y_
),

92 
Equ®sPrÙo
(
’şave_id’t™y_ex³ù©iÚ_
)))

93 .
WlOnû
(
R‘uº
(
çl£
));

95 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(

96 
mock_’şave_auth_cÚ‹xt_
, 
’şave_id’t™y_ex³ù©iÚ_
,

97 
mock_id’t™y_ex³ù©iÚ_m©ch”_
),

98 
IsOkAndHŞds
(
çl£
));

101 
TEST_F
(
P“rId’t™yUtTe¡
, 
ExŒaùAndM©chEnşaveId’t™yFšdId’t™yFas
) {

104 
EXPECT_CALL
(

105 
mock_’şave_auth_cÚ‹xt_
,

106 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

107 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

108 .
WlOnû
(
R‘uº
(
Stus
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
, "")));

110 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(
mock_’şave_auth_cÚ‹xt_
,

111 
’şave_id’t™y_ex³ù©iÚ_
,

112 
mock_id’t™y_ex³ù©iÚ_m©ch”_
)

113 .
¡©us
(),

114 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
));

117 
TEST_F
(
P“rId’t™yUtTe¡
, 
ExŒaùAndM©chEnşaveId’t™yM©ch”Fas
) {

119 
EXPECT_CALL
(

120 
mock_’şave_auth_cÚ‹xt_
,

121 
FšdEnşaveId’t™y
(
Equ®sPrÙo
(

122 
’şave_id’t™y_ex³ù©iÚ_
.
»ã»nû_id’t™y
().
desütiÚ
())))

123 .
WlOnû
(
R‘uº
(&
’şave_id’t™y_
));

124 
EXPECT_CALL
(
mock_id’t™y_ex³ù©iÚ_m©ch”_
,

125 
M©ch
(
Equ®sPrÙo
(
’şave_id’t™y_
),

126 
Equ®sPrÙo
(
’şave_id’t™y_ex³ù©iÚ_
)))

127 .
WlOnû
(
R‘uº
(
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "")));

129 
EXPECT_THAT
(
ExŒaùAndM©chEnşaveId’t™y
(
mock_’şave_auth_cÚ‹xt_
,

130 
’şave_id’t™y_ex³ù©iÚ_
,

131 
mock_id’t™y_ex³ù©iÚ_m©ch”_
)

132 .
¡©us
(),

133 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
));

	@grpc/auth/sgx_local_credentials_options.cc

19 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

21 
	~<ut™y
>

23 
	~"asylo/id’t™y/desütiÚs.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
EnşaveC»d’tŸlsO±iÚs
 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
() {

28  
S–fSgxLoÿlC»d’tŸlsO±iÚs
().
Add
(
P“rSgxLoÿlC»d’tŸlsO±iÚs
());

31 
EnşaveC»d’tŸlsO±iÚs
 
P“rSgxLoÿlC»d’tŸlsO±iÚs
() {

32 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

33 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

34 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

35 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

36  
	gİtiÚs
;

39 
EnşaveC»d’tŸlsO±iÚs
 
S–fSgxLoÿlC»d’tŸlsO±iÚs
() {

40 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

41 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

42 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

43 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

44  
	gİtiÚs
;

	@grpc/auth/sgx_local_credentials_options.cc

19 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

21 
	~<ut™y
>

23 
	~"asylo/id’t™y/desütiÚs.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
EnşaveC»d’tŸlsO±iÚs
 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
() {

28  
S–fSgxLoÿlC»d’tŸlsO±iÚs
().
Add
(
P“rSgxLoÿlC»d’tŸlsO±iÚs
());

31 
EnşaveC»d’tŸlsO±iÚs
 
P“rSgxLoÿlC»d’tŸlsO±iÚs
() {

32 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

33 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

34 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

35 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

36  
	gİtiÚs
;

39 
EnşaveC»d’tŸlsO±iÚs
 
S–fSgxLoÿlC»d’tŸlsO±iÚs
() {

40 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

41 
As£¹iÚDesütiÚ
 
	gas£¹iÚ_desütiÚ
;

42 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
as£¹iÚ_desütiÚ
);

43 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
em¶aû
(
¡d
::
move
(
as£¹iÚ_desütiÚ
));

44  
	gİtiÚs
;

	@grpc/auth/sgx_local_credentials_options.h

19 #iâdeà
ASYLO_GRPC_AUTH_SGX_LOCAL_CREDENTIALS_OPTIONS_H_


20 
	#ASYLO_GRPC_AUTH_SGX_LOCAL_CREDENTIALS_OPTIONS_H_


	)

22 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

24 
Çme¥aû
 
	gasylo
 {

49 
EnşaveC»d’tŸlsO±iÚs
 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
();

74 
EnşaveC»d’tŸlsO±iÚs
 
P“rSgxLoÿlC»d’tŸlsO±iÚs
();

99 
EnşaveC»d’tŸlsO±iÚs
 
S–fSgxLoÿlC»d’tŸlsO±iÚs
();

	@grpc/auth/test/h2_enclave_security_test.cc

19 
	~<¡ršg.h
>

21 
	~"asylo/’şave.pb.h
"

22 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

23 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls_İtiÚs.h
"

24 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

25 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

26 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

28 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

29 
	~"asylo/id’t™y/š™.h
"

30 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

31 
	~"šşude/g½c/im¶/codeg’/g½c_ty³s.h
"

32 
	~"šşude/g½c/suµÜt/®loc.h
"

33 
	~"šşude/g½c/suµÜt/log.h
"

34 
	~"¤c/cÜe/lib/g´/ho¡_pÜt.h
"

35 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

36 
	~"‹¡/cÜe/’d2’d/’d2’d_‹¡s.h
"

37 
	~"‹¡/cÜe/ut/‹¡_cÚfig.h
"

39 
Çme¥aû
 
	gasylo
 {

40 
	gÇme¥aû
 {

42 
cÚ¡ex´
 
	gkCl›ÁAdd™iÚ®Auth’tiÿ‹dD©a
[] = "EKEP client";

43 
cÚ¡ex´
 
	gkS”v”Add™iÚ®Auth’tiÿ‹dD©a
[] = "EKEP server";

44 
cÚ¡ex´
 
	gkAdd»ss
[] = "[::1]";

46 
	sEnşaveFuÎSckFixtu»D©a
 {

48 *
	gloÿl_add»ss
;

52 
boŞ
 
	gpÜt_£t
;

55 
g½c_’d2’d_‹¡_fixtu»
 
C»©eFixtu»Secu»FuÎ¡ack
(

56 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
, g½c_chªÃl_¬g *
£rv”_¬gs
) {

57 
g½c_’d2’d_‹¡_fixtu»
 
	gf
;

59 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

60 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(

61 
g´_z®loc
((*
fixtu»_d©a
)));

65 
g´_još_ho¡_pÜt
(&
fixtu»_d©a
->
loÿl_add»ss
, 
kAdd»ss
, 0);

66 
	gf
.
	gfixtu»_d©a
 = 
fixtu»_d©a
;

69 
	gf
.
	gcq
 = 
g½c_com¶‘iÚ_queue_ü—‹_fÜ_Ãxt
(
nuÎ±r
);

70 
	gf
.
	gshutdown_cq
 = 
g½c_com¶‘iÚ_queue_ü—‹_fÜ_¶uck
(
nuÎ±r
);

73 
	gf
.
	g£rv”
 = 
nuÎ±r
;

74 
	gf
.
	gş›Á
 = 
nuÎ±r
;

76  
	gf
;

81 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
In™Cl›ÁEnşaveC»d’tŸls
(

82 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

83 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İtiÚs
;

84 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İtiÚs
);

85 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İtiÚs
);

86  
g½c_’şave_chªÃl_üed’tŸls_ü—‹
(&
c_İtiÚs
);

90 
In™Cl›ÁChªÃl
(
EnşaveC»d’tŸlsO±iÚs
 
İtiÚs
,

91 
g½c_’d2’d_‹¡_fixtu»
 *
f
,

92 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

94 
	gİtiÚs
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
 = 
kCl›ÁAdd™iÚ®Auth’tiÿ‹dD©a
;

97 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
üeds
 =

98 
In™Cl›ÁEnşaveC»d’tŸls
(
İtiÚs
);

99 
GPR_ASSERT
(
üeds
 !ğ
nuÎ±r
);

101 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

102 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(
f
->
fixtu»_d©a
);

103 
GPR_ASSERT
(
fixtu»_d©a
->
pÜt_£t
);

105 
	gf
->
	gş›Á
 =

106 
g½c_£cu»_chªÃl_ü—‹
(
üeds
.
g‘
(), 
fixtu»_d©a
->
loÿl_add»ss
,

107 
ş›Á_¬gs
, 
nuÎ±r
);

108 
GPR_ASSERT
(
f
->
ş›Á
 !ğ
nuÎ±r
);

113 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎC»d’tŸls
(

114 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

117 
In™Cl›ÁChªÃl
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
(), 
f
, 
ş›Á_¬gs
);

122 
In™Cl›ÁEnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
(

123 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

126 
In™Cl›ÁChªÃl
(
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
(), 
f
, 
ş›Á_¬gs
);

132 
In™Cl›ÁEnşaveS–fSgxLoÿlP“rNuÎC»d’tŸls
(

133 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

136 
In™Cl›ÁChªÃl
(

137 
S–fSgxLoÿlC»d’tŸlsO±iÚs
().
Add
(
P“rNuÎC»d’tŸlsO±iÚs
()), 
f
,

138 
ş›Á_¬gs
);

143 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
(

144 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

147 
In™Cl›ÁChªÃl
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
().
Add
(

148 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
()),

149 
f
, 
ş›Á_¬gs
);

154 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
In™S”v”EnşaveC»d’tŸls
(

155 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

156 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İtiÚs
;

157 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İtiÚs
);

158 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İtiÚs
);

161  
g½c_’şave_£rv”_üed’tŸls_ü—‹
(&
c_İtiÚs
);

165 
In™S”v”
(
EnşaveC»d’tŸlsO±iÚs
 
İtiÚs
, 
g½c_’d2’d_‹¡_fixtu»
 *
f
,

166 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

168 
	gİtiÚs
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
 = 
kS”v”Add™iÚ®Auth’tiÿ‹dD©a
;

171 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
üeds
 =

172 
In™S”v”EnşaveC»d’tŸls
(
İtiÚs
);

173 
GPR_ASSERT
(
üeds
 !ğ
nuÎ±r
);

175 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

176 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(
f
->
fixtu»_d©a
);

177 
	gf
->
	g£rv”
 = 
g½c_£rv”_ü—‹
(
£rv”_¬gs
, 
nuÎ±r
);

178 
g½c_£rv”_»gi¡”_com¶‘iÚ_queue
(
f
->
£rv”
, f->
cq
, 
nuÎ±r
);

182 
	gpÜt
 = 
g½c_£rv”_add_£cu»_h‰p2_pÜt
(

183 
f
->
£rv”
, 
fixtu»_d©a
->
loÿl_add»ss
, 
üeds
.
g‘
());

184 
GPR_ASSERT
(
pÜt
 != 0);

185 
g´_ä“
(
fixtu»_d©a
->
loÿl_add»ss
);

186 
g´_još_ho¡_pÜt
(&
fixtu»_d©a
->
loÿl_add»ss
, 
kAdd»ss
, 
pÜt
);

187 
	gfixtu»_d©a
->
	gpÜt_£t
 = 
Œue
;

188 
g½c_£rv”_¡¬t
(
f
->
£rv”
);

193 
In™S”v”EnşaveBidœeùiÚ®NuÎC»d’tŸls
(

194 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

197 
In™S”v”
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
(), 
f
, 
£rv”_¬gs
);

202 
In™S”v”EnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
(

203 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

206 
In™S”v”
(
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
(), 
f
, 
£rv”_¬gs
);

212 
In™S”v”EnşaveS–fNuÎP“rSgxLoÿlC»d’tŸls
(

213 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

216 
In™S”v”
(
S–fNuÎC»d’tŸlsO±iÚs
().
Add
(
P“rSgxLoÿlC»d’tŸlsO±iÚs
()),

217 
f
, 
£rv”_¬gs
);

222 
In™S”v”EnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
(

223 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

226 
In™S”v”
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
().
Add
(

227 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
()),

228 
f
, 
£rv”_¬gs
);

231 
T—rDownSecu»FuÎ¡ack
(
g½c_’d2’d_‹¡_fixtu»
 *
f
) {

232 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

233 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(
f
->
fixtu»_d©a
);

234 
g´_ä“
(
fixtu»_d©a
->
loÿl_add»ss
);

235 
g´_ä“
(
fixtu»_d©a
);

240 
g½c_’d2’d_‹¡_cÚfig
 
	gcÚfigs
[] = {

243 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

244 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

245 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

246  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

247 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎC»d’tŸls
,

248 
In™S”v”EnşaveBidœeùiÚ®NuÎC»d’tŸls
, 
T—rDownSecu»FuÎ¡ack
},

252 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

253 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

254 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

255  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

256 
In™Cl›ÁEnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
,

257 
In™S”v”EnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
,

258 
T—rDownSecu»FuÎ¡ack
},

262 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

263 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

264 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

265  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

266 
In™Cl›ÁEnşaveS–fSgxLoÿlP“rNuÎC»d’tŸls
,

267 
In™S”v”EnşaveS–fNuÎP“rSgxLoÿlC»d’tŸls
, 
T—rDownSecu»FuÎ¡ack
},

271 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

272 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

273 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

274  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

275 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
,

276 
In™S”v”EnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
,

277 
T—rDownSecu»FuÎ¡ack
},

283 
	$maš
(
¬gc
, **
¬gv
) {

284 
	`g½c_‹¡_š™
(
¬gc
, 
¬gv
);

285 
	`g½c_’d2’d_‹¡s_´e_š™
();

286 
	`g½c_š™
();

289 
¡d
::
veùÜ
<
asylo
::
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
authÜ™y_cÚfigs
 = {

290 
asylo
::
	`G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
(),

291 
asylo
::
	`G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
(),

293 
	`GPR_ASSERT
(
	`In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
authÜ™y_cÚfigs
.
	`cbegš
(),

294 
authÜ™y_cÚfigs
.
	`ûnd
())

295 .
	`ok
());

297 
size_t
 
i
;

298 
i
 = 0; i < (
asylo
::
cÚfigs
) / (*asylo::configs); ++i) {

299 
	`GPR_ASSERT
(
asylo
::
cÚfigs
[
i
].
ã©u»_mask
 != 0);

300 
	`g½c_’d2’d_‹¡s
(
¬gc
, 
¬gv
, 
asylo
::
cÚfigs
[
i
]);

303 
	`g½c_shutdown
();

305 
	}
}

	@grpc/auth/test/h2_enclave_security_test.cc

19 
	~<¡ršg.h
>

21 
	~"asylo/’şave.pb.h
"

22 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls.h
"

23 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls_İtiÚs.h
"

24 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

25 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

26 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

28 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

29 
	~"asylo/id’t™y/š™.h
"

30 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

31 
	~"šşude/g½c/im¶/codeg’/g½c_ty³s.h
"

32 
	~"šşude/g½c/suµÜt/®loc.h
"

33 
	~"šşude/g½c/suµÜt/log.h
"

34 
	~"¤c/cÜe/lib/g´/ho¡_pÜt.h
"

35 
	~"¤c/cÜe/lib/g´µ/»f_couÁed_±r.h
"

36 
	~"‹¡/cÜe/’d2’d/’d2’d_‹¡s.h
"

37 
	~"‹¡/cÜe/ut/‹¡_cÚfig.h
"

39 
Çme¥aû
 
	gasylo
 {

40 
	gÇme¥aû
 {

42 
cÚ¡ex´
 
	gkCl›ÁAdd™iÚ®Auth’tiÿ‹dD©a
[] = "EKEP client";

43 
cÚ¡ex´
 
	gkS”v”Add™iÚ®Auth’tiÿ‹dD©a
[] = "EKEP server";

44 
cÚ¡ex´
 
	gkAdd»ss
[] = "[::1]";

46 
	sEnşaveFuÎSckFixtu»D©a
 {

48 *
	gloÿl_add»ss
;

52 
boŞ
 
	gpÜt_£t
;

55 
g½c_’d2’d_‹¡_fixtu»
 
C»©eFixtu»Secu»FuÎ¡ack
(

56 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
, g½c_chªÃl_¬g *
£rv”_¬gs
) {

57 
g½c_’d2’d_‹¡_fixtu»
 
	gf
;

59 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

60 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(

61 
g´_z®loc
((*
fixtu»_d©a
)));

65 
g´_još_ho¡_pÜt
(&
fixtu»_d©a
->
loÿl_add»ss
, 
kAdd»ss
, 0);

66 
	gf
.
	gfixtu»_d©a
 = 
fixtu»_d©a
;

69 
	gf
.
	gcq
 = 
g½c_com¶‘iÚ_queue_ü—‹_fÜ_Ãxt
(
nuÎ±r
);

70 
	gf
.
	gshutdown_cq
 = 
g½c_com¶‘iÚ_queue_ü—‹_fÜ_¶uck
(
nuÎ±r
);

73 
	gf
.
	g£rv”
 = 
nuÎ±r
;

74 
	gf
.
	gş›Á
 = 
nuÎ±r
;

76  
	gf
;

81 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
In™Cl›ÁEnşaveC»d’tŸls
(

82 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

83 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İtiÚs
;

84 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İtiÚs
);

85 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İtiÚs
);

86  
g½c_’şave_chªÃl_üed’tŸls_ü—‹
(&
c_İtiÚs
);

90 
In™Cl›ÁChªÃl
(
EnşaveC»d’tŸlsO±iÚs
 
İtiÚs
,

91 
g½c_’d2’d_‹¡_fixtu»
 *
f
,

92 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

94 
	gİtiÚs
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
 = 
kCl›ÁAdd™iÚ®Auth’tiÿ‹dD©a
;

97 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_chªÃl_üed’tŸls
> 
üeds
 =

98 
In™Cl›ÁEnşaveC»d’tŸls
(
İtiÚs
);

99 
GPR_ASSERT
(
üeds
 !ğ
nuÎ±r
);

101 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

102 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(
f
->
fixtu»_d©a
);

103 
GPR_ASSERT
(
fixtu»_d©a
->
pÜt_£t
);

105 
	gf
->
	gş›Á
 =

106 
g½c_£cu»_chªÃl_ü—‹
(
üeds
.
g‘
(), 
fixtu»_d©a
->
loÿl_add»ss
,

107 
ş›Á_¬gs
, 
nuÎ±r
);

108 
GPR_ASSERT
(
f
->
ş›Á
 !ğ
nuÎ±r
);

113 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎC»d’tŸls
(

114 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

117 
In™Cl›ÁChªÃl
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
(), 
f
, 
ş›Á_¬gs
);

122 
In™Cl›ÁEnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
(

123 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

126 
In™Cl›ÁChªÃl
(
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
(), 
f
, 
ş›Á_¬gs
);

132 
In™Cl›ÁEnşaveS–fSgxLoÿlP“rNuÎC»d’tŸls
(

133 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

136 
In™Cl›ÁChªÃl
(

137 
S–fSgxLoÿlC»d’tŸlsO±iÚs
().
Add
(
P“rNuÎC»d’tŸlsO±iÚs
()), 
f
,

138 
ş›Á_¬gs
);

143 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
(

144 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
ş›Á_¬gs
) {

147 
In™Cl›ÁChªÃl
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
().
Add
(

148 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
()),

149 
f
, 
ş›Á_¬gs
);

154 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
In™S”v”EnşaveC»d’tŸls
(

155 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
İtiÚs
) {

156 
g½c_’şave_üed’tŸls_İtiÚs
 
c_İtiÚs
;

157 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
c_İtiÚs
);

158 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
c_İtiÚs
);

161  
g½c_’şave_£rv”_üed’tŸls_ü—‹
(&
c_İtiÚs
);

165 
In™S”v”
(
EnşaveC»d’tŸlsO±iÚs
 
İtiÚs
, 
g½c_’d2’d_‹¡_fixtu»
 *
f
,

166 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

168 
	gİtiÚs
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
 = 
kS”v”Add™iÚ®Auth’tiÿ‹dD©a
;

171 
	gg½c_cÜe
::
RefCouÁedPŒ
<
g½c_£rv”_üed’tŸls
> 
üeds
 =

172 
In™S”v”EnşaveC»d’tŸls
(
İtiÚs
);

173 
GPR_ASSERT
(
üeds
 !ğ
nuÎ±r
);

175 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

176 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(
f
->
fixtu»_d©a
);

177 
	gf
->
	g£rv”
 = 
g½c_£rv”_ü—‹
(
£rv”_¬gs
, 
nuÎ±r
);

178 
g½c_£rv”_»gi¡”_com¶‘iÚ_queue
(
f
->
£rv”
, f->
cq
, 
nuÎ±r
);

182 
	gpÜt
 = 
g½c_£rv”_add_£cu»_h‰p2_pÜt
(

183 
f
->
£rv”
, 
fixtu»_d©a
->
loÿl_add»ss
, 
üeds
.
g‘
());

184 
GPR_ASSERT
(
pÜt
 != 0);

185 
g´_ä“
(
fixtu»_d©a
->
loÿl_add»ss
);

186 
g´_još_ho¡_pÜt
(&
fixtu»_d©a
->
loÿl_add»ss
, 
kAdd»ss
, 
pÜt
);

187 
	gfixtu»_d©a
->
	gpÜt_£t
 = 
Œue
;

188 
g½c_£rv”_¡¬t
(
f
->
£rv”
);

193 
In™S”v”EnşaveBidœeùiÚ®NuÎC»d’tŸls
(

194 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

197 
In™S”v”
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
(), 
f
, 
£rv”_¬gs
);

202 
In™S”v”EnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
(

203 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

206 
In™S”v”
(
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
(), 
f
, 
£rv”_¬gs
);

212 
In™S”v”EnşaveS–fNuÎP“rSgxLoÿlC»d’tŸls
(

213 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

216 
In™S”v”
(
S–fNuÎC»d’tŸlsO±iÚs
().
Add
(
P“rSgxLoÿlC»d’tŸlsO±iÚs
()),

217 
f
, 
£rv”_¬gs
);

222 
In™S”v”EnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
(

223 
g½c_’d2’d_‹¡_fixtu»
 *
f
, 
g½c_chªÃl_¬gs
 *
£rv”_¬gs
) {

226 
In™S”v”
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
().
Add
(

227 
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
()),

228 
f
, 
£rv”_¬gs
);

231 
T—rDownSecu»FuÎ¡ack
(
g½c_’d2’d_‹¡_fixtu»
 *
f
) {

232 
EnşaveFuÎSckFixtu»D©a
 *
	gfixtu»_d©a
 =

233 
¡©ic_ÿ¡
<
EnşaveFuÎSckFixtu»D©a
 *>(
f
->
fixtu»_d©a
);

234 
g´_ä“
(
fixtu»_d©a
->
loÿl_add»ss
);

235 
g´_ä“
(
fixtu»_d©a
);

240 
g½c_’d2’d_‹¡_cÚfig
 
	gcÚfigs
[] = {

243 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

244 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

245 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

246  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

247 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎC»d’tŸls
,

248 
In™S”v”EnşaveBidœeùiÚ®NuÎC»d’tŸls
, 
T—rDownSecu»FuÎ¡ack
},

252 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

253 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

254 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

255  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

256 
In™Cl›ÁEnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
,

257 
In™S”v”EnşaveBidœeùiÚ®SgxLoÿlC»d’tŸls
,

258 
T—rDownSecu»FuÎ¡ack
},

262 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

263 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

264 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

265  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

266 
In™Cl›ÁEnşaveS–fSgxLoÿlP“rNuÎC»d’tŸls
,

267 
In™S”v”EnşaveS–fNuÎP“rSgxLoÿlC»d’tŸls
, 
T—rDownSecu»FuÎ¡ack
},

271 
FEATURE_MASK_SUPPORTS_DELAYED_CONNECTION
 |

272 
FEATURE_MASK_SUPPORTS_CLIENT_CHANNEL
 |

273 
FEATURE_MASK_SUPPORTS_AUTHORITY_HEADER
,

274  
nuÎ±r
, 
C»©eFixtu»Secu»FuÎ¡ack
,

275 
In™Cl›ÁEnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
,

276 
In™S”v”EnşaveBidœeùiÚ®NuÎAndSgxLoÿlC»d’tŸls
,

277 
T—rDownSecu»FuÎ¡ack
},

283 
	$maš
(
¬gc
, **
¬gv
) {

284 
	`g½c_‹¡_š™
(
¬gc
, 
¬gv
);

285 
	`g½c_’d2’d_‹¡s_´e_š™
();

286 
	`g½c_š™
();

289 
¡d
::
veùÜ
<
asylo
::
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
authÜ™y_cÚfigs
 = {

290 
asylo
::
	`G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
(),

291 
asylo
::
	`G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
(),

293 
	`GPR_ASSERT
(
	`In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
authÜ™y_cÚfigs
.
	`cbegš
(),

294 
authÜ™y_cÚfigs
.
	`ûnd
())

295 .
	`ok
());

297 
size_t
 
i
;

298 
i
 = 0; i < (
asylo
::
cÚfigs
) / (*asylo::configs); ++i) {

299 
	`GPR_ASSERT
(
asylo
::
cÚfigs
[
i
].
ã©u»_mask
 != 0);

300 
	`g½c_’d2’d_‹¡s
(
¬gc
, 
¬gv
, 
asylo
::
cÚfigs
[
i
]);

303 
	`g½c_shutdown
();

305 
	}
}

	@grpc/auth/test/mock_enclave_auth_context.h

19 #iâdeà
ASYLO_GRPC_AUTH_TEST_MOCK_ENCLAVE_AUTH_CONTEXT_H_


20 
	#ASYLO_GRPC_AUTH_TEST_MOCK_ENCLAVE_AUTH_CONTEXT_H_


	)

22 
	~<gmock/gmock.h
>

23 
	~"asylo/g½c/auth/’şave_auth_cÚ‹xt.h
"

24 
	~"asylo/id’t™y/id’t™y.pb.h
"

25 
	~"asylo/ut/¡©usÜ.h
"

27 
Çme¥aû
 
	gasylo
 {

29 şas 
	cMockEnşaveAuthCÚ‹xt
 : 
public
 
EnşaveAuthCÚ‹xt
 {

30 
public
:

31 
MOCK_CONST_METHOD1
(
HasEnşaveId’t™y
,

32 
boŞ
(cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
));

34 
MOCK_CONST_METHOD1
(
FšdEnşaveId’t™y
,

35 
StusOr
<cÚ¡ 
EnşaveId’t™y
 *>(

36 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
));

	@grpc/auth/util/bridge_cpp_to_c.cc

19 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

21 
	~<c¡dšt
>

22 
	~<c¡dlib
>

24 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

25 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

32 
FromAs£¹iÚDesütiÚ
(cÚ¡ 
As£¹iÚDesütiÚ
 &
¤c
,

33 
as£¹iÚ_desütiÚ
 *
de¡
) {

34 
as£¹iÚ_desütiÚ_ä“
(
de¡
);

35 
as£¹iÚ_desütiÚ_assign
(
¡©ic_ÿ¡
<
št32_t
>(
¤c
.
id’t™y_ty³
()),

36 
¤c
.
authÜ™y_ty³
().
d©a
(),

37 
¤c
.
authÜ™y_ty³
().
size
(), 
de¡
);

42 
CİyAs£¹iÚDesütiÚs
(cÚ¡ 
As£¹iÚDesütiÚHashS‘
 &
¤c
,

43 
as£¹iÚ_desütiÚ_¬¿y
 *
de¡
) {

44 
as£¹iÚ_desütiÚ_¬¿y_ä“
(
de¡
);

45 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ
¤c
.
size
(), 
de¡
);

46 
size_t
 
	gi
 = 0;

47 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gas£¹iÚ_desütiÚ
 : 
¤c
) {

48 
FromAs£¹iÚDesütiÚ
(
as£¹iÚ_desütiÚ
, &
de¡
->
desütiÚs
[
i
]);

49 ++
	gi
;

55 
CİyEnşaveC»d’tŸlsO±iÚs
(cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
¤c
,

56 
g½c_’şave_üed’tŸls_İtiÚs
 *
de¡
) {

57 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(
de¡
);

58 
CİyAs£¹iÚDesütiÚs
(
¤c
.
£lf_as£¹iÚs
, &
de¡
->self_assertions);

59 
CİyAs£¹iÚDesütiÚs
(
¤c
.
acû±ed_³”_as£¹iÚs
,

60 &
de¡
->
acû±ed_³”_as£¹iÚs
);

61 ià(!
	g¤c
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
.
em±y
()) {

62 
§ã_¡ršg_assign
(&
de¡
->
add™iÚ®_auth’tiÿ‹d_d©a
,

63 
¤c
.
add™iÚ®_auth’tiÿ‹d_d©a
.
size
(),

64 
¤c
.
add™iÚ®_auth’tiÿ‹d_d©a
.
d©a
());

	@grpc/auth/util/bridge_cpp_to_c.cc

19 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

21 
	~<c¡dšt
>

22 
	~<c¡dlib
>

24 
	~"asylo/g½c/auth/cÜe/as£¹iÚ_desütiÚ.h
"

25 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

32 
FromAs£¹iÚDesütiÚ
(cÚ¡ 
As£¹iÚDesütiÚ
 &
¤c
,

33 
as£¹iÚ_desütiÚ
 *
de¡
) {

34 
as£¹iÚ_desütiÚ_ä“
(
de¡
);

35 
as£¹iÚ_desütiÚ_assign
(
¡©ic_ÿ¡
<
št32_t
>(
¤c
.
id’t™y_ty³
()),

36 
¤c
.
authÜ™y_ty³
().
d©a
(),

37 
¤c
.
authÜ™y_ty³
().
size
(), 
de¡
);

42 
CİyAs£¹iÚDesütiÚs
(cÚ¡ 
As£¹iÚDesütiÚHashS‘
 &
¤c
,

43 
as£¹iÚ_desütiÚ_¬¿y
 *
de¡
) {

44 
as£¹iÚ_desütiÚ_¬¿y_ä“
(
de¡
);

45 
as£¹iÚ_desütiÚ_¬¿y_š™
Ğ
¤c
.
size
(), 
de¡
);

46 
size_t
 
	gi
 = 0;

47 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gas£¹iÚ_desütiÚ
 : 
¤c
) {

48 
FromAs£¹iÚDesütiÚ
(
as£¹iÚ_desütiÚ
, &
de¡
->
desütiÚs
[
i
]);

49 ++
	gi
;

55 
CİyEnşaveC»d’tŸlsO±iÚs
(cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
¤c
,

56 
g½c_’şave_üed’tŸls_İtiÚs
 *
de¡
) {

57 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(
de¡
);

58 
CİyAs£¹iÚDesütiÚs
(
¤c
.
£lf_as£¹iÚs
, &
de¡
->self_assertions);

59 
CİyAs£¹iÚDesütiÚs
(
¤c
.
acû±ed_³”_as£¹iÚs
,

60 &
de¡
->
acû±ed_³”_as£¹iÚs
);

61 ià(!
	g¤c
.
	gadd™iÚ®_auth’tiÿ‹d_d©a
.
em±y
()) {

62 
§ã_¡ršg_assign
(&
de¡
->
add™iÚ®_auth’tiÿ‹d_d©a
,

63 
¤c
.
add™iÚ®_auth’tiÿ‹d_d©a
.
size
(),

64 
¤c
.
add™iÚ®_auth’tiÿ‹d_d©a
.
d©a
());

	@grpc/auth/util/bridge_cpp_to_c.h

19 #iâdeà
ASYLO_GRPC_AUTH_UTIL_BRIDGE_CPP_TO_C_H_


20 
	#ASYLO_GRPC_AUTH_UTIL_BRIDGE_CPP_TO_C_H_


	)

22 
	~<veùÜ
>

24 
	~"asylo/g½c/auth/cÜe/’şave_üed’tŸls_İtiÚs.h
"

25 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

26 
	~"asylo/id’t™y/id’t™y.pb.h
"

28 
Çme¥aû
 
	gasylo
 {

37 
CİyEnşaveC»d’tŸlsO±iÚs
(cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
¤c
,

38 
g½c_’şave_üed’tŸls_İtiÚs
 *
de¡
);

	@grpc/auth/util/bridge_cpp_to_c_test.cc

19 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

28 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

29 
	~"asylo/id’t™y/id’t™y.pb.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

35 
boŞ
 
As£¹iÚDesütiÚIsEqu®
(cÚ¡ 
As£¹iÚDesütiÚ
 &
ex³ùed
,

36 cÚ¡ 
as£¹iÚ_desütiÚ
 &
aùu®
) {

37 ià(
	g¡©ic_ÿ¡
<
	gšt32_t
>(
	gex³ùed
.
id’t™y_ty³
()è!ğ
aùu®
.identity_type) {

38  
çl£
;

40 ià(
	gex³ùed
.
authÜ™y_ty³
().
size
(è!ğ
aùu®
.authority_type.size) {

41  
çl£
;

43  
memcmp
(
ex³ùed
.
authÜ™y_ty³
().
d©a
(), 
aùu®
.authority_type.data,

44 
aùu®
.
authÜ™y_ty³
.
size
) == 0;

49 
boŞ
 
CÚšsEquiv®’t
(cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
¬¿y
,

50 
As£¹iÚDesütiÚ
 
ex³ùed_as£¹iÚ_desütiÚ
) {

51 
size_t
 
	gi
 = 0; i < 
	g¬¿y
.
	gcouÁ
; ++i) {

52 ià(
As£¹iÚDesütiÚIsEqu®
(
ex³ùed_as£¹iÚ_desütiÚ
,

53 
¬¿y
.
desütiÚs
[
i
])) {

54  
	gŒue
;

57  
	gçl£
;

62 
boŞ
 
As£¹iÚDesütiÚsA»Equ®
(cÚ¡ 
As£¹iÚDesütiÚHashS‘
 &
ex³ùed
,

63 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
aùu®
) {

64 ià(
	gex³ùed
.
size
(è!ğ
aùu®
.
couÁ
) {

65  
çl£
;

68 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gas£¹iÚ_desütiÚ
 : 
ex³ùed
) {

69 ià(!
CÚšsEquiv®’t
(
aùu®
, 
as£¹iÚ_desütiÚ
)) {

70  
	gçl£
;

73  
	gŒue
;

77 
boŞ
 
Add™iÚ®Auth’tiÿ‹dD©aIsEqu®
(cÚ¡ 
¡d
::
¡ršg
 &
ex³ùed
,

78 cÚ¡ 
§ã_¡ršg
 &
aùu®
) {

79 ià(
	gex³ùed
.
size
(), 
	gaùu®
.
	gsize
) {

80  
	gçl£
;

82  
¡ºcmp
(
ex³ùed
.
c_¡r
(), 
aùu®
.
d©a
,‡ùu®.
size
) == 0;

86 
boŞ
 
C»d’tŸlsO±iÚsA»Equ®
(

87 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
ex³ùed
,

88 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 &
aùu®
) {

89 ià(!
As£¹iÚDesütiÚsA»Equ®
(
ex³ùed
.
£lf_as£¹iÚs
,

90 
aùu®
.
£lf_as£¹iÚs
)) {

91  
	gçl£
;

93 ià(!
As£¹iÚDesütiÚsA»Equ®
(
ex³ùed
.
acû±ed_³”_as£¹iÚs
,

94 
aùu®
.
acû±ed_³”_as£¹iÚs
)) {

95  
	gçl£
;

97  
Add™iÚ®Auth’tiÿ‹dD©aIsEqu®
(

98 
ex³ùed
.
add™iÚ®_auth’tiÿ‹d_d©a
,

99 
aùu®
.
add™iÚ®_auth’tiÿ‹d_d©a
);

104 şas 
	cBridgeCµToCTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

105 
´Ùeùed
:

106 
S‘Up
(è
ov”ride
 {

107 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
bridge_İtiÚs_
);

110 
T—rDown
(è
	gov”ride
 {

111 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(&
bridge_İtiÚs_
);

114 
g½c_’şave_üed’tŸls_İtiÚs
 
	gbridge_İtiÚs_
;

119 
TEST_F
(
BridgeCµToCTe¡
, 
CİyEnşaveC»d’tŸlsO±iÚsNÚEm±y
) {

120 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
 = 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
();

121 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
bridge_İtiÚs_
);

123 
ASSERT_NO_FATAL_FAILURE
(
C»d’tŸlsO±iÚsA»Equ®
(
İtiÚs
, 
bridge_İtiÚs_
));

128 
TEST_F
(
BridgeCµToCTe¡
, 
CİyEnşaveC»d’tŸlsO±iÚsEm±y
) {

129 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

130 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
bridge_İtiÚs_
);

132 
ASSERT_NO_FATAL_FAILURE
(
C»d’tŸlsO±iÚsA»Equ®
(
İtiÚs
, 
bridge_İtiÚs_
));

	@grpc/auth/util/bridge_cpp_to_c_test.cc

19 
	~"asylo/g½c/auth/ut/bridge_ıp_to_c.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/g½c/auth/’şave_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

28 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

29 
	~"asylo/id’t™y/id’t™y.pb.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

35 
boŞ
 
As£¹iÚDesütiÚIsEqu®
(cÚ¡ 
As£¹iÚDesütiÚ
 &
ex³ùed
,

36 cÚ¡ 
as£¹iÚ_desütiÚ
 &
aùu®
) {

37 ià(
	g¡©ic_ÿ¡
<
	gšt32_t
>(
	gex³ùed
.
id’t™y_ty³
()è!ğ
aùu®
.identity_type) {

38  
çl£
;

40 ià(
	gex³ùed
.
authÜ™y_ty³
().
size
(è!ğ
aùu®
.authority_type.size) {

41  
çl£
;

43  
memcmp
(
ex³ùed
.
authÜ™y_ty³
().
d©a
(), 
aùu®
.authority_type.data,

44 
aùu®
.
authÜ™y_ty³
.
size
) == 0;

49 
boŞ
 
CÚšsEquiv®’t
(cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
¬¿y
,

50 
As£¹iÚDesütiÚ
 
ex³ùed_as£¹iÚ_desütiÚ
) {

51 
size_t
 
	gi
 = 0; i < 
	g¬¿y
.
	gcouÁ
; ++i) {

52 ià(
As£¹iÚDesütiÚIsEqu®
(
ex³ùed_as£¹iÚ_desütiÚ
,

53 
¬¿y
.
desütiÚs
[
i
])) {

54  
	gŒue
;

57  
	gçl£
;

62 
boŞ
 
As£¹iÚDesütiÚsA»Equ®
(cÚ¡ 
As£¹iÚDesütiÚHashS‘
 &
ex³ùed
,

63 cÚ¡ 
as£¹iÚ_desütiÚ_¬¿y
 &
aùu®
) {

64 ià(
	gex³ùed
.
size
(è!ğ
aùu®
.
couÁ
) {

65  
çl£
;

68 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gas£¹iÚ_desütiÚ
 : 
ex³ùed
) {

69 ià(!
CÚšsEquiv®’t
(
aùu®
, 
as£¹iÚ_desütiÚ
)) {

70  
	gçl£
;

73  
	gŒue
;

77 
boŞ
 
Add™iÚ®Auth’tiÿ‹dD©aIsEqu®
(cÚ¡ 
¡d
::
¡ršg
 &
ex³ùed
,

78 cÚ¡ 
§ã_¡ršg
 &
aùu®
) {

79 ià(
	gex³ùed
.
size
(), 
	gaùu®
.
	gsize
) {

80  
	gçl£
;

82  
¡ºcmp
(
ex³ùed
.
c_¡r
(), 
aùu®
.
d©a
,‡ùu®.
size
) == 0;

86 
boŞ
 
C»d’tŸlsO±iÚsA»Equ®
(

87 cÚ¡ 
EnşaveC»d’tŸlsO±iÚs
 &
ex³ùed
,

88 cÚ¡ 
g½c_’şave_üed’tŸls_İtiÚs
 &
aùu®
) {

89 ià(!
As£¹iÚDesütiÚsA»Equ®
(
ex³ùed
.
£lf_as£¹iÚs
,

90 
aùu®
.
£lf_as£¹iÚs
)) {

91  
	gçl£
;

93 ià(!
As£¹iÚDesütiÚsA»Equ®
(
ex³ùed
.
acû±ed_³”_as£¹iÚs
,

94 
aùu®
.
acû±ed_³”_as£¹iÚs
)) {

95  
	gçl£
;

97  
Add™iÚ®Auth’tiÿ‹dD©aIsEqu®
(

98 
ex³ùed
.
add™iÚ®_auth’tiÿ‹d_d©a
,

99 
aùu®
.
add™iÚ®_auth’tiÿ‹d_d©a
);

104 şas 
	cBridgeCµToCTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

105 
´Ùeùed
:

106 
S‘Up
(è
ov”ride
 {

107 
g½c_’şave_üed’tŸls_İtiÚs_š™
(&
bridge_İtiÚs_
);

110 
T—rDown
(è
	gov”ride
 {

111 
g½c_’şave_üed’tŸls_İtiÚs_de¡roy
(&
bridge_İtiÚs_
);

114 
g½c_’şave_üed’tŸls_İtiÚs
 
	gbridge_İtiÚs_
;

119 
TEST_F
(
BridgeCµToCTe¡
, 
CİyEnşaveC»d’tŸlsO±iÚsNÚEm±y
) {

120 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
 = 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
();

121 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
bridge_İtiÚs_
);

123 
ASSERT_NO_FATAL_FAILURE
(
C»d’tŸlsO±iÚsA»Equ®
(
İtiÚs
, 
bridge_İtiÚs_
));

128 
TEST_F
(
BridgeCµToCTe¡
, 
CİyEnşaveC»d’tŸlsO±iÚsEm±y
) {

129 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

130 
CİyEnşaveC»d’tŸlsO±iÚs
(
İtiÚs
, &
bridge_İtiÚs_
);

132 
ASSERT_NO_FATAL_FAILURE
(
C»d’tŸlsO±iÚsA»Equ®
(
İtiÚs
, 
bridge_İtiÚs_
));

	@grpc/auth/util/multi_buffer_input_stream.cc

19 
	~"asylo/g½c/auth/ut/muÉi_bufãr_šput_¡»am.h
"

21 
	~"asylo/ut/loggšg.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
	gMuÉiBufãrIÅutSŒ—m
::
MuÉiBufãrIÅutSŒ—m
()

26 : 
bufãrs_
(
BufãrLi¡
()),

27 
cu¼’t_
(
bufãrs_
.
cbegš
()),

28 
off£t_
(0),

29 
Œim_off£t_
(0),

30 
by‹s_»ad_
(0),

31 
Ï¡_»tuºed_size_
(0),

32 
size_
(0) {}

34 
boŞ
 
	gMuÉiBufãrIÅutSŒ—m
::
Next
(cÚ¡ **
d©a
, *
size
) {

35 ià(
	gcu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

36  
çl£
;

39 
	g¡d
::
veùÜ
<> *
bufãr
 = 
cu¼’t_
->
g‘
();

40 ià(
	gbufãr
->
size
(è=ğ
off£t_
) {

42 ià(++
cu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

44 
Ï¡_»tuºed_size_
 = 0;

45  
	gçl£
;

47 
	gbufãr
 = 
cu¼’t_
->
g‘
();

48 
	goff£t_
 = 0;

51 *
	gd©a
 = 
bufãr
->
d©a
(è+ 
off£t_
;

52 *
	gsize
 = 
bufãr
->
size
(è- 
off£t_
;

54 
	gÏ¡_»tuºed_size_
 = 
bufãr
->
size
(è- 
off£t_
;

55 
	gby‹s_»ad_
 +ğ
Ï¡_»tuºed_size_
;

56 
	goff£t_
 = 
bufãr
->
size
();

58  
	gŒue
;

61 
	gMuÉiBufãrIÅutSŒ—m
::
BackUp
(
couÁ
) {

63 ià(
Ï¡_»tuºed_size_
 == 0) {

64 
LOG
(
FATAL
) << "BackUp() can only be called‡fter‡ successful call "

69 ià(
	gcouÁ
 < 0) {

70 
LOG
(
FATAL
) << "Backup distance must be greaterhan orƒqualo 0";

74 ià(
	gcouÁ
 > 
	gÏ¡_»tuºed_size_
) {

75 
LOG
(
FATAL
) << "Backup distance must be†esshan orƒqualo "

79 
	goff£t_
 -ğ
couÁ
;

80 
	gby‹s_»ad_
 -ğ
couÁ
;

83 
	gÏ¡_»tuºed_size_
 = 0;

86 
boŞ
 
	gMuÉiBufãrIÅutSŒ—m
::
Sk
(
couÁ
) {

87 ià(
cu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

88  
çl£
;

92 
	gÏ¡_»tuºed_size_
 = 0;

94 
	gcouÁ
 > 0) {

95 ià(
	gcu¼’t_
->
g‘
()->
size
(è=ğ
off£t_
) {

97 ià(++
cu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

98  
çl£
;

100 
	goff£t_
 = 0;

103 
	gby‹s_»maššg
 = 
cu¼’t_
->
g‘
()->
size
(è- 
off£t_
;

104 
	gby‹s_to_sk
 = (
couÁ
 <ğ
by‹s_»maššg
) ? count : bytes_remaining;

106 
	goff£t_
 +ğ
by‹s_to_sk
;

107 
	gby‹s_»ad_
 +ğ
by‹s_to_sk
;

108 
	gcouÁ
 -ğ
by‹s_to_sk
;

110  
	gŒue
;

113 autØ
	gMuÉiBufãrIÅutSŒ—m
::
By‹CouÁ
() const

114 -> 
deşty³
(
¡©ic_ÿ¡
<
Z”oCİyIÅutSŒ—m
 *>(
nuÎ±r
)->
By‹CouÁ
()) {

115  
by‹s_»ad_
;

118 
	gMuÉiBufãrIÅutSŒ—m
::
AddBufãr
(cÚ¡ *
d©a
, 
size_t
 
size
) {

119 
	g¡d
::
veùÜ
<> *
bufãr
 = 
Ãw
 
¡d
::veùÜ<>(
d©a
, 
	gd©a
 + 
	gsize
);

120 
	gbufãrs_
.
em¶aû_back
(
¡d
::
unique_±r
<¡d::
veùÜ
<>>(
bufãr
));

123 ià(
	gcu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

124 
cu¼’t_
--;

128 
	gsize_
 +ğ
size
;

131 
	gMuÉiBufãrIÅutSŒ—m
::
TrimFrÚt
() {

133 
bufãrs_
.
cbegš
(è!ğ
cu¼’t_
) {

134 
bufãrs_
.
pİ_äÚt
();

137 ià(
	gcu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

139 
off£t_
 = 0;

140 
	gŒim_off£t_
 = 0;

141 } ià(
	gcu¼’t_
->
g‘
()->
size
(è=ğ
off£t_
) {

143 
cu¼’t_
++;

144 
	gbufãrs_
.
pİ_äÚt
();

147 
	goff£t_
 = 0;

148 
	gŒim_off£t_
 = 0;

153 
	gŒim_off£t_
 = 
off£t_
;

157 
	gsize_
 -ğ
by‹s_»ad_
;

160 
	gÏ¡_»tuºed_size_
 = 0;

161 
	gby‹s_»ad_
 = 0;

164 
	gMuÉiBufãrIÅutSŒ—m
::
Rewšd
() {

165 
cu¼’t_
 = 
bufãrs_
.
cbegš
();

166 
	goff£t_
 = 
Œim_off£t_
;

167 
	gÏ¡_»tuºed_size_
 = 0;

168 
	gby‹s_»ad_
 = 0;

171 
	g¡d
::
¡ršg
 
MuÉiBufãrIÅutSŒ—m
::
RemaššgBy‹s
() const {

172 
¡d
::
¡ršg
 
cÚ‹Ás
;

173 
	gBufãrLi¡
::
cÚ¡_™”©Ü
 
™
 = 
cu¼’t_
;

176 ià(
	g™
 =ğ
bufãrs_
.
ûnd
()) {

177  
cÚ‹Ás
;

181 
	g¡d
::
veùÜ
<> *
bufãr
 = 
™
->
g‘
();

182 
	gcÚ‹Ás
.
­³nd
(
bufãr
->
d©a
(è+ 
off£t_
, bufãr->
size
() - offset_);

184 ++
	g™
 !ğ
bufãrs_
.
ûnd
()) {

185 
bufãr
 = 
™
->
g‘
();

186 
	gcÚ‹Ás
.
­³nd
(
bufãr
->
d©a
(), bufãr->
size
());

188  
	gcÚ‹Ás
;

191 
	gMuÉiBufãrIÅutSŒ—m
::
RemaššgBy‹CouÁ
() const {

192  
size_
 - 
by‹s_»ad_
;

	@grpc/auth/util/multi_buffer_input_stream.cc

19 
	~"asylo/g½c/auth/ut/muÉi_bufãr_šput_¡»am.h
"

21 
	~"asylo/ut/loggšg.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
	gMuÉiBufãrIÅutSŒ—m
::
MuÉiBufãrIÅutSŒ—m
()

26 : 
bufãrs_
(
BufãrLi¡
()),

27 
cu¼’t_
(
bufãrs_
.
cbegš
()),

28 
off£t_
(0),

29 
Œim_off£t_
(0),

30 
by‹s_»ad_
(0),

31 
Ï¡_»tuºed_size_
(0),

32 
size_
(0) {}

34 
boŞ
 
	gMuÉiBufãrIÅutSŒ—m
::
Next
(cÚ¡ **
d©a
, *
size
) {

35 ià(
	gcu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

36  
çl£
;

39 
	g¡d
::
veùÜ
<> *
bufãr
 = 
cu¼’t_
->
g‘
();

40 ià(
	gbufãr
->
size
(è=ğ
off£t_
) {

42 ià(++
cu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

44 
Ï¡_»tuºed_size_
 = 0;

45  
	gçl£
;

47 
	gbufãr
 = 
cu¼’t_
->
g‘
();

48 
	goff£t_
 = 0;

51 *
	gd©a
 = 
bufãr
->
d©a
(è+ 
off£t_
;

52 *
	gsize
 = 
bufãr
->
size
(è- 
off£t_
;

54 
	gÏ¡_»tuºed_size_
 = 
bufãr
->
size
(è- 
off£t_
;

55 
	gby‹s_»ad_
 +ğ
Ï¡_»tuºed_size_
;

56 
	goff£t_
 = 
bufãr
->
size
();

58  
	gŒue
;

61 
	gMuÉiBufãrIÅutSŒ—m
::
BackUp
(
couÁ
) {

63 ià(
Ï¡_»tuºed_size_
 == 0) {

64 
LOG
(
FATAL
) << "BackUp() can only be called‡fter‡ successful call "

69 ià(
	gcouÁ
 < 0) {

70 
LOG
(
FATAL
) << "Backup distance must be greaterhan orƒqualo 0";

74 ià(
	gcouÁ
 > 
	gÏ¡_»tuºed_size_
) {

75 
LOG
(
FATAL
) << "Backup distance must be†esshan orƒqualo "

79 
	goff£t_
 -ğ
couÁ
;

80 
	gby‹s_»ad_
 -ğ
couÁ
;

83 
	gÏ¡_»tuºed_size_
 = 0;

86 
boŞ
 
	gMuÉiBufãrIÅutSŒ—m
::
Sk
(
couÁ
) {

87 ià(
cu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

88  
çl£
;

92 
	gÏ¡_»tuºed_size_
 = 0;

94 
	gcouÁ
 > 0) {

95 ià(
	gcu¼’t_
->
g‘
()->
size
(è=ğ
off£t_
) {

97 ià(++
cu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

98  
çl£
;

100 
	goff£t_
 = 0;

103 
	gby‹s_»maššg
 = 
cu¼’t_
->
g‘
()->
size
(è- 
off£t_
;

104 
	gby‹s_to_sk
 = (
couÁ
 <ğ
by‹s_»maššg
) ? count : bytes_remaining;

106 
	goff£t_
 +ğ
by‹s_to_sk
;

107 
	gby‹s_»ad_
 +ğ
by‹s_to_sk
;

108 
	gcouÁ
 -ğ
by‹s_to_sk
;

110  
	gŒue
;

113 autØ
	gMuÉiBufãrIÅutSŒ—m
::
By‹CouÁ
() const

114 -> 
deşty³
(
¡©ic_ÿ¡
<
Z”oCİyIÅutSŒ—m
 *>(
nuÎ±r
)->
By‹CouÁ
()) {

115  
by‹s_»ad_
;

118 
	gMuÉiBufãrIÅutSŒ—m
::
AddBufãr
(cÚ¡ *
d©a
, 
size_t
 
size
) {

119 
	g¡d
::
veùÜ
<> *
bufãr
 = 
Ãw
 
¡d
::veùÜ<>(
d©a
, 
	gd©a
 + 
	gsize
);

120 
	gbufãrs_
.
em¶aû_back
(
¡d
::
unique_±r
<¡d::
veùÜ
<>>(
bufãr
));

123 ià(
	gcu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

124 
cu¼’t_
--;

128 
	gsize_
 +ğ
size
;

131 
	gMuÉiBufãrIÅutSŒ—m
::
TrimFrÚt
() {

133 
bufãrs_
.
cbegš
(è!ğ
cu¼’t_
) {

134 
bufãrs_
.
pİ_äÚt
();

137 ià(
	gcu¼’t_
 =ğ
bufãrs_
.
ûnd
()) {

139 
off£t_
 = 0;

140 
	gŒim_off£t_
 = 0;

141 } ià(
	gcu¼’t_
->
g‘
()->
size
(è=ğ
off£t_
) {

143 
cu¼’t_
++;

144 
	gbufãrs_
.
pİ_äÚt
();

147 
	goff£t_
 = 0;

148 
	gŒim_off£t_
 = 0;

153 
	gŒim_off£t_
 = 
off£t_
;

157 
	gsize_
 -ğ
by‹s_»ad_
;

160 
	gÏ¡_»tuºed_size_
 = 0;

161 
	gby‹s_»ad_
 = 0;

164 
	gMuÉiBufãrIÅutSŒ—m
::
Rewšd
() {

165 
cu¼’t_
 = 
bufãrs_
.
cbegš
();

166 
	goff£t_
 = 
Œim_off£t_
;

167 
	gÏ¡_»tuºed_size_
 = 0;

168 
	gby‹s_»ad_
 = 0;

171 
	g¡d
::
¡ršg
 
MuÉiBufãrIÅutSŒ—m
::
RemaššgBy‹s
() const {

172 
¡d
::
¡ršg
 
cÚ‹Ás
;

173 
	gBufãrLi¡
::
cÚ¡_™”©Ü
 
™
 = 
cu¼’t_
;

176 ià(
	g™
 =ğ
bufãrs_
.
ûnd
()) {

177  
cÚ‹Ás
;

181 
	g¡d
::
veùÜ
<> *
bufãr
 = 
™
->
g‘
();

182 
	gcÚ‹Ás
.
­³nd
(
bufãr
->
d©a
(è+ 
off£t_
, bufãr->
size
() - offset_);

184 ++
	g™
 !ğ
bufãrs_
.
ûnd
()) {

185 
bufãr
 = 
™
->
g‘
();

186 
	gcÚ‹Ás
.
­³nd
(
bufãr
->
d©a
(), bufãr->
size
());

188  
	gcÚ‹Ás
;

191 
	gMuÉiBufãrIÅutSŒ—m
::
RemaššgBy‹CouÁ
() const {

192  
size_
 - 
by‹s_»ad_
;

	@grpc/auth/util/multi_buffer_input_stream.h

19 #iâdeà
ASYLO_GRPC_AUTH_UTIL_MULTI_BUFFER_INPUT_STREAM_H_


20 
	#ASYLO_GRPC_AUTH_UTIL_MULTI_BUFFER_INPUT_STREAM_H_


	)

22 
	~<li¡
>

23 
	~<memÜy
>

24 
	~<veùÜ
>

26 
	~<googË/´Ùobuf/io/z”o_cİy_¡»am.h
>

28 
Çme¥aû
 
	gasylo
 {

30 
usšg
 
	ggoogË
::
´Ùobuf
::
io
::
Z”oCİyIÅutSŒ—m
;

55 şas 
	cMuÉiBufãrIÅutSŒ—m
 : 
public
 
Z”oCİyIÅutSŒ—m
 {

56 
public
:

58 
MuÉiBufãrIÅutSŒ—m
();

61 
boŞ
 
Next
(cÚ¡ **
d©a
, *
size
è
	gov”ride
;

62 
BackUp
(
couÁ
è
	gov”ride
;

63 
boŞ
 
Sk
(
couÁ
è
	gov”ride
;

64 autØ
By‹CouÁ
(ècÚ¡ -> 
deşty³
(

65 
¡©ic_ÿ¡
<
Z”oCİyIÅutSŒ—m
 *>(
nuÎ±r
)->
By‹CouÁ
()è
	gov”ride
;

68 
AddBufãr
(cÚ¡ *
d©a
, 
size_t
 
size
);

74 
TrimFrÚt
();

79 
Rewšd
();

88 
	g¡d
::
¡ršg
 
RemaššgBy‹s
() const;

92 
RemaššgBy‹CouÁ
() const;

94 
	g´iv©e
:

95 
usšg
 
BufãrLi¡
 = 
¡d
::
li¡
<¡d::
unique_±r
<¡d::
veùÜ
<>>>;

97 
BufãrLi¡
 
	gbufãrs_
;

100 
	gBufãrLi¡
::
cÚ¡_™”©Ü
 
cu¼’t_
;

104 
	goff£t_
;

109 
	gŒim_off£t_
;

113 
	gby‹s_»ad_
;

116 
	gÏ¡_»tuºed_size_
;

120 
	gsize_
;

	@grpc/auth/util/safe_string.cc

19 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

20 
	~"šşude/g½c/suµÜt/®loc.h
"

22 
	$§ã_¡ršg_š™
(
§ã_¡ršg
 *
§ã_¡r
) {

23 
§ã_¡r
->
d©a
 = 
nuÎ±r
;

24 
§ã_¡r
->
size
 = 0;

25 
	}
}

27 
	$§ã_¡ršg_assign
(
§ã_¡ršg
 *
§ã_¡r
, 
size_t
 
size
, cÚ¡ *
d©a
) {

29 
	`§ã_¡ršg_ä“
(
§ã_¡r
);

30 
§ã_¡r
->
d©a
 = 
¡©ic_ÿ¡
<*>(
	`g´_m®loc
(
size
));

31 ià(
size
 > 0) {

33 
	`memıy
(
§ã_¡r
->
d©a
, d©a, 
size
);

35 
§ã_¡r
->
size
 = size;

36 
	}
}

38 
	$§ã_¡ršg_cİy
(
§ã_¡ršg
 *
de¡
, cÚ¡ saã_¡ršg *
¤c
) {

39 
	`§ã_¡ršg_assign
(
de¡
, 
¤c
->
size
, src->
d©a
);

40 
	}
}

42 
	$§ã_¡ršg_ä“
(
§ã_¡ršg
 *
§ã_¡r
) {

43 ià(
§ã_¡r
->
size
 != 0) {

44 
	`g´_ä“
(
§ã_¡r
->
d©a
);

47 
§ã_¡r
->
d©a
 = 
nuÎ±r
;

48 
§ã_¡r
->
size
 = 0;

50 
	}
}

	@grpc/auth/util/safe_string.cc

19 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

20 
	~"šşude/g½c/suµÜt/®loc.h
"

22 
	$§ã_¡ršg_š™
(
§ã_¡ršg
 *
§ã_¡r
) {

23 
§ã_¡r
->
d©a
 = 
nuÎ±r
;

24 
§ã_¡r
->
size
 = 0;

25 
	}
}

27 
	$§ã_¡ršg_assign
(
§ã_¡ršg
 *
§ã_¡r
, 
size_t
 
size
, cÚ¡ *
d©a
) {

29 
	`§ã_¡ršg_ä“
(
§ã_¡r
);

30 
§ã_¡r
->
d©a
 = 
¡©ic_ÿ¡
<*>(
	`g´_m®loc
(
size
));

31 ià(
size
 > 0) {

33 
	`memıy
(
§ã_¡r
->
d©a
, d©a, 
size
);

35 
§ã_¡r
->
size
 = size;

36 
	}
}

38 
	$§ã_¡ršg_cİy
(
§ã_¡ršg
 *
de¡
, cÚ¡ saã_¡ršg *
¤c
) {

39 
	`§ã_¡ršg_assign
(
de¡
, 
¤c
->
size
, src->
d©a
);

40 
	}
}

42 
	$§ã_¡ršg_ä“
(
§ã_¡ršg
 *
§ã_¡r
) {

43 ià(
§ã_¡r
->
size
 != 0) {

44 
	`g´_ä“
(
§ã_¡r
->
d©a
);

47 
§ã_¡r
->
d©a
 = 
nuÎ±r
;

48 
§ã_¡r
->
size
 = 0;

50 
	}
}

	@grpc/auth/util/safe_string.h

19 #iâdeà
ASYLO_GRPC_AUTH_UTIL_SAFE_STRING_H_


20 
	#ASYLO_GRPC_AUTH_UTIL_SAFE_STRING_H_


	)

22 
	~<¡ršg.h
>

46 *
	md©a
;

47 
size_t
 
	msize
;

48 } 
	t§ã_¡ršg
;

52 
§ã_¡ršg_š™
(
§ã_¡ršg
 *
§ã_¡r
);

58 
§ã_¡ršg_assign
(
§ã_¡ršg
 *
§ã_¡r
, 
size_t
 
size
, cÚ¡ *
d©a
);

62 
§ã_¡ršg_cİy
(
§ã_¡ršg
 *
de¡
, cÚ¡ saã_¡ršg *
¤c
);

65 
§ã_¡ršg_ä“
(
§ã_¡ršg
 *
§ã_¡r
);

	@grpc/auth/util/safe_string_test.cc

19 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

20 
	~<g‹¡/g‹¡.h
>

22 
Çme¥aû
 
	gasylo
 {

23 
	gÇme¥aû
 {

25 cÚ¡ 
	gkSŒšg1
[] = "foobar";

26 cÚ¡ 
size_t
 
	gkSŒšg1Size
 = 6;

28 cÚ¡ 
	gkSŒšg2
[] = "hello world";

29 cÚ¡ 
size_t
 
	gkSŒšg2Size
 = 11;

33 şas 
	cSaãSŒšgTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

34 
´Ùeùed
:

35 
S‘Up
(è
ov”ride
 {

36 
§ã_¡ršg_š™
(&
s1_
);

37 
§ã_¡ršg_š™
(&
s2_
);

40 
T—rDown
(è
	gov”ride
 {

41 
§ã_¡ršg_ä“
(&
s1_
);

42 
§ã_¡ršg_ä“
(&
s2_
);

45 
§ã_¡ršg
 
	gs1_
;

46 
§ã_¡ršg
 
	gs2_
;

49 
TEST_F
(
SaãSŒšgTe¡
, 
AssignOnû
) {

50 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

51 
EXPECT_EQ
(
kSŒšg1Size
, 
s1_
.
size
);

52 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg1
, 
s1_
.
d©a
, s1_.
size
));

55 
TEST_F
(
SaãSŒšgTe¡
, 
R—ssignL¬g”SŒšg
) {

56 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

57 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg2Size
, 
kSŒšg2
);

58 
EXPECT_EQ
(
kSŒšg2Size
, 
s1_
.
size
);

59 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg2
, 
s1_
.
d©a
, s1_.
size
));

62 
TEST_F
(
SaãSŒšgTe¡
, 
R—ssignSm®ËrSŒšg
) {

63 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg2Size
, 
kSŒšg2
);

64 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

65 
EXPECT_EQ
(
kSŒšg1Size
, 
s1_
.
size
);

66 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg1
, 
s1_
.
d©a
, s1_.
size
));

69 
TEST_F
(
SaãSŒšgTe¡
, 
R—ssignNuÎ
) {

70 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

71 
§ã_¡ršg_assign
(&
s1_
, 0, 
nuÎ±r
);

72 
EXPECT_EQ
(0, 
s1_
.
size
);

73 
EXPECT_EQ
(
nuÎ±r
, 
s1_
.
d©a
);

76 
TEST_F
(
SaãSŒšgTe¡
, 
CİySm®ËrSŒšg
) {

77 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

78 
§ã_¡ršg_assign
(&
s2_
, 
kSŒšg2Size
, 
kSŒšg2
);

79 
§ã_¡ršg_cİy
Ğ&
s2_
, &
s1_
);

80 
EXPECT_EQ
(
kSŒšg1Size
, 
s2_
.
size
);

81 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg1
, 
s2_
.
d©a
, s2_.
size
));

84 
TEST_F
(
SaãSŒšgTe¡
, 
CİyL¬g”SŒšg
) {

85 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

86 
§ã_¡ršg_assign
(&
s2_
, 
kSŒšg2Size
, 
kSŒšg2
);

87 
§ã_¡ršg_cİy
Ğ&
s1_
, &
s2_
);

88 
EXPECT_EQ
(
kSŒšg2Size
, 
s1_
.
size
);

89 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg2
, 
s1_
.
d©a
, s1_.
size
));

92 
TEST_F
(
SaãSŒšgTe¡
, 
CİyNuÎSŒšg
) {

93 
§ã_¡ršg_assign
(&
s1_
, 0, 
nuÎ±r
);

94 
§ã_¡ršg_assign
(&
s2_
, 
kSŒšg2Size
, 
kSŒšg2
);

95 
§ã_¡ršg_cİy
Ğ&
s2_
, &
s1_
);

96 
EXPECT_EQ
(0, 
s2_
.
size
);

97 
EXPECT_EQ
(
nuÎ±r
, 
s2_
.
d©a
);

100 
TEST_F
(
SaãSŒšgTe¡
, 
F»e
) {

101 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

105 
§ã_¡ršg_ä“
(&
s1_
);

106 
EXPECT_EQ
(0, 
s1_
.
size
);

107 
EXPECT_EQ
(
nuÎ±r
, 
s1_
.
d©a
);

	@grpc/auth/util/safe_string_test.cc

19 
	~"asylo/g½c/auth/ut/§ã_¡ršg.h
"

20 
	~<g‹¡/g‹¡.h
>

22 
Çme¥aû
 
	gasylo
 {

23 
	gÇme¥aû
 {

25 cÚ¡ 
	gkSŒšg1
[] = "foobar";

26 cÚ¡ 
size_t
 
	gkSŒšg1Size
 = 6;

28 cÚ¡ 
	gkSŒšg2
[] = "hello world";

29 cÚ¡ 
size_t
 
	gkSŒšg2Size
 = 11;

33 şas 
	cSaãSŒšgTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

34 
´Ùeùed
:

35 
S‘Up
(è
ov”ride
 {

36 
§ã_¡ršg_š™
(&
s1_
);

37 
§ã_¡ršg_š™
(&
s2_
);

40 
T—rDown
(è
	gov”ride
 {

41 
§ã_¡ršg_ä“
(&
s1_
);

42 
§ã_¡ršg_ä“
(&
s2_
);

45 
§ã_¡ršg
 
	gs1_
;

46 
§ã_¡ršg
 
	gs2_
;

49 
TEST_F
(
SaãSŒšgTe¡
, 
AssignOnû
) {

50 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

51 
EXPECT_EQ
(
kSŒšg1Size
, 
s1_
.
size
);

52 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg1
, 
s1_
.
d©a
, s1_.
size
));

55 
TEST_F
(
SaãSŒšgTe¡
, 
R—ssignL¬g”SŒšg
) {

56 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

57 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg2Size
, 
kSŒšg2
);

58 
EXPECT_EQ
(
kSŒšg2Size
, 
s1_
.
size
);

59 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg2
, 
s1_
.
d©a
, s1_.
size
));

62 
TEST_F
(
SaãSŒšgTe¡
, 
R—ssignSm®ËrSŒšg
) {

63 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg2Size
, 
kSŒšg2
);

64 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

65 
EXPECT_EQ
(
kSŒšg1Size
, 
s1_
.
size
);

66 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg1
, 
s1_
.
d©a
, s1_.
size
));

69 
TEST_F
(
SaãSŒšgTe¡
, 
R—ssignNuÎ
) {

70 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

71 
§ã_¡ršg_assign
(&
s1_
, 0, 
nuÎ±r
);

72 
EXPECT_EQ
(0, 
s1_
.
size
);

73 
EXPECT_EQ
(
nuÎ±r
, 
s1_
.
d©a
);

76 
TEST_F
(
SaãSŒšgTe¡
, 
CİySm®ËrSŒšg
) {

77 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

78 
§ã_¡ršg_assign
(&
s2_
, 
kSŒšg2Size
, 
kSŒšg2
);

79 
§ã_¡ršg_cİy
Ğ&
s2_
, &
s1_
);

80 
EXPECT_EQ
(
kSŒšg1Size
, 
s2_
.
size
);

81 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg1
, 
s2_
.
d©a
, s2_.
size
));

84 
TEST_F
(
SaãSŒšgTe¡
, 
CİyL¬g”SŒšg
) {

85 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

86 
§ã_¡ršg_assign
(&
s2_
, 
kSŒšg2Size
, 
kSŒšg2
);

87 
§ã_¡ršg_cİy
Ğ&
s1_
, &
s2_
);

88 
EXPECT_EQ
(
kSŒšg2Size
, 
s1_
.
size
);

89 
EXPECT_EQ
(0, 
memcmp
(
kSŒšg2
, 
s1_
.
d©a
, s1_.
size
));

92 
TEST_F
(
SaãSŒšgTe¡
, 
CİyNuÎSŒšg
) {

93 
§ã_¡ršg_assign
(&
s1_
, 0, 
nuÎ±r
);

94 
§ã_¡ršg_assign
(&
s2_
, 
kSŒšg2Size
, 
kSŒšg2
);

95 
§ã_¡ršg_cİy
Ğ&
s2_
, &
s1_
);

96 
EXPECT_EQ
(0, 
s2_
.
size
);

97 
EXPECT_EQ
(
nuÎ±r
, 
s2_
.
d©a
);

100 
TEST_F
(
SaãSŒšgTe¡
, 
F»e
) {

101 
§ã_¡ršg_assign
(&
s1_
, 
kSŒšg1Size
, 
kSŒšg1
);

105 
§ã_¡ršg_ä“
(&
s1_
);

106 
EXPECT_EQ
(0, 
s1_
.
size
);

107 
EXPECT_EQ
(
nuÎ±r
, 
s1_
.
d©a
);

	@grpc/util/enclave_server.h

19 #iâdeà
ASYLO_GRPC_UTIL_ENCLAVE_SERVER_H_


20 
	#ASYLO_GRPC_UTIL_ENCLAVE_SERVER_H_


	)

22 
	~<memÜy
>

23 
	~<¡ršg
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/g½c/ut/’şave_£rv”.pb.h
"

28 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

29 
	~"asylo/ut/mu‹x_gu¬ded.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

32 
	~"asylo/ut/¡©usÜ.h
"

33 
	~"šşude/g½ıp/im¶/codeg’/£rviû_ty³.h
"

34 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

35 
	~"šşude/g½ıp/£rv”.h
"

36 
	~"šşude/g½ıp/£rv”_bud”.h
"

38 
Çme¥aû
 
	gasylo
 {

57 şas 
	cEnşaveS”v”
 
	gfš®
 : 
public
 
Tru¡edAµliÿtiÚ
 {

58 
public
:

59 
usšg
 
G½cS”viûFaùÜy
 =

60 
¡d
::
funùiÚ
<
StusOr
<¡d::
unique_±r
<::
g½c
::
S”viû
>>()>;

62 
EnşaveS”v”
(
¡d
::
unique_±r
<::
g½c
::
S”viû
> 
£rviû
,

63 
¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
üed’tŸls
)

64 : 
£rv”_
{
nuÎ±r
},

65 
	g£rviû_
{
	g¡d
::
move
(
£rviû
)},

66 
	g£rviû_çùÜy_
{
	gNoFaùÜy
},

67 
	güed’tŸls_
{
	güed’tŸls
} {}

69 
EnşaveS”v”
(
G½cS”viûFaùÜy
 
£rviû_çùÜy
,

70 
¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
üed’tŸls
)

71 : 
£rv”_
{
nuÎ±r
},

72 
	g£rviû_çùÜy_
{
	g£rviû_çùÜy
},

73 
	güed’tŸls_
{
	güed’tŸls
} {}

75 ~
EnşaveS”v”
() = ;

79 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

80 cÚ¡ 
	gS”v”CÚfig
 &
	gcÚfig_£rv”_´Ùo
 =

81 
cÚfig
.
G‘Ex‹nsiÚ
(
£rv”_šput_cÚfig
);

82 ià(!
	gcÚfig_£rv”_´Ùo
.
has_ho¡
()) {

83  
Stus
(

84 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

87 ià(!
	gcÚfig_£rv”_´Ùo
.
has_pÜt
()) {

88  
Stus
(

89 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

92 
	gho¡_
 = 
cÚfig_£rv”_´Ùo
.
ho¡
();

93 
	gpÜt_
 = 
cÚfig_£rv”_´Ùo
.
pÜt
();

95 
LOG
(
INFO
è<< "gRPC s”v” cÚfigu»d w™h‡dd»ss: " << 
	gho¡_
 << ":"

96 << 
	gpÜt_
;

98  
In™ŸlizeS”v”
();

101 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

102 
G‘S”v”Add»ss
(
ouut
);

103  
	gStus
::
OkStus
();

106 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
’şave_fš®
) {

107 
Fš®izeS”v”
();

108  
	gStus
::
OkStus
();

111 
	g´iv©e
:

114 
Stus
 
In™ŸlizeS”v”
() {

116 autØ
£rv”_v›w
(
£rv”_
.
Lock
());

117 ià(*
	g£rv”_v›w
) {

118  
	gStus
::
OkStus
();

121 
ASYLO_ASSIGN_OR_RETURN
(*
£rv”_v›w
, 
C»©eS”v”
());

122  
	gStus
::
OkStus
();

127 
	gStusOr
<
	g¡d
::
unique_±r
<::
g½c
::
S”v”
>> 
C»©eS”v”
() {

128 
pÜt
;

129 ::
g½c
::
S”v”Bud”
 
bud”
;

130 
	gbud”
.
AddLi¡’šgPÜt
(
ab¦
::
SŒC©
(
ho¡_
, ":", 
pÜt_
), 
üed’tŸls_
,

131 &
pÜt
);

132 ià(
	g£rviû_
 =ğ
nuÎ±r
) {

133 
StusOr
<
¡d
::
unique_±r
<::
g½c
::
S”viû
>> 
£rviû_»suÉ
 =

134 
£rviû_çùÜy_
();

135 ià(!
	g£rviû_»suÉ
.
ok
()) {

136  
	g£rviû_»suÉ
.
¡©us
();

138 
	g£rviû_
 = 
¡d
::
move
(
£rviû_»suÉ
).
V®ueOrD›
();

140 ià(
	g£rviû_
 =ğ
nuÎ±r
) {

141  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "No gRPC service configured");

143 
	gbud”
.
Regi¡”S”viû
(
£rviû_
.
g‘
());

144 
	g¡d
::
unique_±r
<::
g½c
::
S”v”
> 
£rv”
 = 
bud”
.
BudAndS¹
();

145 ià(!
	g£rv”
) {

146  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

150 
	gpÜt_
 = 
pÜt
;

151 
LOG
(
INFO
è<< "gRPC s”v” i li¡’šg oÀ" << 
	gho¡_
 << ":" << 
	gpÜt_
;

153  
	g¡d
::
move
(
£rv”
);

158 
G‘S”v”Add»ss
(
EnşaveOuut
 *
ouut
) {

159 
S”v”CÚfig
 *
	gcÚfig
 = 
ouut
->
MubËEx‹nsiÚ
(
£rv”_ouut_cÚfig
);

160 
	gcÚfig
->
£t_ho¡
(
ho¡_
);

161 
	gcÚfig
->
£t_pÜt
(
pÜt_
);

165 
Fš®izeS”v”
() {

166 autØ
£rv”_v›w
(
£rv”_
.
Lock
());

167 ià(*
	g£rv”_v›w
) {

168 
LOG
(
INFO
) << "Shutting down...";

169 (*
	g£rv”_v›w
)->
Shutdown
();

170 *
	g£rv”_v›w
 = 
nuÎ±r
;

174 
	gStusOr
<
	g¡d
::
unique_±r
<::
g½c
::
S”viû
>> 
NoFaùÜy
() {

175  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "No factory configured");

179 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<::
g½c
::
S”v”
>> 
£rv”_
;

182 
	g¡d
::
¡ršg
 
ho¡_
;

183 
	gpÜt_
;

185 
	g¡d
::
unique_±r
<::
g½c
::
S”viû
> 
£rviû_
;

186 
G½cS”viûFaùÜy
 
	g£rviû_çùÜy_
;

187 
	g¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
üed’tŸls_
;

	@grpc/util/grpc_server_launcher.cc

19 
	~"asylo/g½c/ut/g½c_£rv”_Ïunch”.h
"

20 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

21 
	~"asylo/ut/loggšg.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
Stus
 
	gG½cS”v”Launch”
::
Regi¡”S”viû
(

26 
¡d
::
unique_±r
<::
g½c
::
S”viû
> 
£rviû
) {

27 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

28 ià(
	g¡©e_
 !ğ
S‹
::
NOT_LAUNCHED
) {

29  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

32 
	gbud”_
.
Regi¡”S”viû
(
£rviû
.
g‘
());

33 
	g£rviûs_
.
em¶aû_back
(
¡d
::
move
(
£rviû
));

34  
	gStus
::
OkStus
();

37 
Stus
 
	gG½cS”v”Launch”
::
AddLi¡’šgPÜt
(

38 cÚ¡ 
¡d
::
¡ršg
 &
add»ss
,

39 
¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
üeds
, *
£Ëùed_pÜt
) {

40 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

41 ià(
	g¡©e_
 !ğ
S‹
::
NOT_LAUNCHED
) {

42  
MakeStus
(

43 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

46 
	gbud”_
.
AddLi¡’šgPÜt
(
add»ss
, 
¡d
::
move
(
üeds
), 
£Ëùed_pÜt
);

47 
LOG
(
INFO
è<< "Added†i¡’šg…Üˆ\"" << 
	gadd»ss
 << "\"ohe server";

48  
	gStus
::
OkStus
();

51 
Stus
 
	gG½cS”v”Launch”
::
S¹
() {

52 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

53 ià(
	g¡©e_
 !ğ
S‹
::
NOT_LAUNCHED
) {

54  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

57 
	g£rv”_
 = 
bud”_
.
BudAndS¹
();

58 ià(!
	g£rv”_
) {

59 
	g¡©e_
 = 
S‹
::
TERMINATED
;

60  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

63 
	g¡©e_
 = 
S‹
::
LAUNCHED
;

64  
	gStus
::
OkStus
();

67 
Stus
 
	gG½cS”v”Launch”
::
Shutdown
() {

68  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

70 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

71 ià(
	g¡©e_
 !ğ
S‹
::
LAUNCHED
) {

74 
¡©e_
 = 
S‹
::
TERMINATED
;

75  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

79 
	g£rv”_
->
Shutdown
();

80 
	g¡©e_
 = 
S‹
::
TERMINATED
;

82  
	gStus
::
OkStus
();

85 
Stus
 
	gG½cS”v”Launch”
::
Wa™
() const {

90 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

91 ià(
	g¡©e_
 !ğ
S‹
::
LAUNCHED
) {

92  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

99 
	g£rv”_
->
Wa™
();

100  
	gStus
::
OkStus
();

103 
	gG½cS”v”Launch”
::
S‹
 
G½cS”v”Launch”
::
G‘S‹
() {

104 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

107  
	g¡©e_
;

	@grpc/util/grpc_server_launcher.cc

19 
	~"asylo/g½c/ut/g½c_£rv”_Ïunch”.h
"

20 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

21 
	~"asylo/ut/loggšg.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
Stus
 
	gG½cS”v”Launch”
::
Regi¡”S”viû
(

26 
¡d
::
unique_±r
<::
g½c
::
S”viû
> 
£rviû
) {

27 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

28 ià(
	g¡©e_
 !ğ
S‹
::
NOT_LAUNCHED
) {

29  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

32 
	gbud”_
.
Regi¡”S”viû
(
£rviû
.
g‘
());

33 
	g£rviûs_
.
em¶aû_back
(
¡d
::
move
(
£rviû
));

34  
	gStus
::
OkStus
();

37 
Stus
 
	gG½cS”v”Launch”
::
AddLi¡’šgPÜt
(

38 cÚ¡ 
¡d
::
¡ršg
 &
add»ss
,

39 
¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
üeds
, *
£Ëùed_pÜt
) {

40 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

41 ià(
	g¡©e_
 !ğ
S‹
::
NOT_LAUNCHED
) {

42  
MakeStus
(

43 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

46 
	gbud”_
.
AddLi¡’šgPÜt
(
add»ss
, 
¡d
::
move
(
üeds
), 
£Ëùed_pÜt
);

47 
LOG
(
INFO
è<< "Added†i¡’šg…Üˆ\"" << 
	gadd»ss
 << "\"ohe server";

48  
	gStus
::
OkStus
();

51 
Stus
 
	gG½cS”v”Launch”
::
S¹
() {

52 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

53 ià(
	g¡©e_
 !ğ
S‹
::
NOT_LAUNCHED
) {

54  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

57 
	g£rv”_
 = 
bud”_
.
BudAndS¹
();

58 ià(!
	g£rv”_
) {

59 
	g¡©e_
 = 
S‹
::
TERMINATED
;

60  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

63 
	g¡©e_
 = 
S‹
::
LAUNCHED
;

64  
	gStus
::
OkStus
();

67 
Stus
 
	gG½cS”v”Launch”
::
Shutdown
() {

68  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

70 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

71 ià(
	g¡©e_
 !ğ
S‹
::
LAUNCHED
) {

74 
¡©e_
 = 
S‹
::
TERMINATED
;

75  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

79 
	g£rv”_
->
Shutdown
();

80 
	g¡©e_
 = 
S‹
::
TERMINATED
;

82  
	gStus
::
OkStus
();

85 
Stus
 
	gG½cS”v”Launch”
::
Wa™
() const {

90 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

91 ià(
	g¡©e_
 !ğ
S‹
::
LAUNCHED
) {

92  
MakeStus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

99 
	g£rv”_
->
Wa™
();

100  
	gStus
::
OkStus
();

103 
	gG½cS”v”Launch”
::
S‹
 
G½cS”v”Launch”
::
G‘S‹
() {

104 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

107  
	g¡©e_
;

	@grpc/util/grpc_server_launcher.h

19 #iâdeà
ASYLO_GRPC_UTIL_GRPC_SERVER_LAUNCHER_H_


20 
	#ASYLO_GRPC_UTIL_GRPC_SERVER_LAUNCHER_H_


	)

22 
	~<memÜy
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

28 
	~"asylo/ut/¡©us.h
"

29 
	~"šşude/g½ıp/im¶/codeg’/£rviû_ty³.h
"

30 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

31 
	~"šşude/g½ıp/£rv”.h
"

32 
	~"šşude/g½ıp/£rv”_bud”.h
"

34 
Çme¥aû
 
	gasylo
 {

84 şas 
	cG½cS”v”Launch”
 {

85 
	gpublic
:

86 şas 
	cS‹
 { 
NOT_LAUNCHED
, 
	gLAUNCHED
, 
	gTERMINATED
 };

88 
G½cS”v”Launch”
(
¡d
::
¡ršg
 
Çme
)

89 : 
Çme_
{
¡d
::
move
(
Çme
)}, 
	g¡©e_
{
	gS‹
::
NOT_LAUNCHED
} {}

92 
Stus
 
Regi¡”S”viû
(
¡d
::
unique_±r
<::
g½c
::
S”viû
> 
£rviû
);

101 
Stus
 
AddLi¡’šgPÜt
(cÚ¡ 
¡d
::
¡ršg
 &
add»ss
,

102 
¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
üeds
,

103 *
£Ëùed_pÜt
 = 
nuÎ±r
);

106 
Stus
 
S¹
();

109 
Stus
 
Wa™
() const;

112 
Stus
 
Shutdown
();

120 
S‹
 
G‘S‹
();

122 
	g´iv©e
:

123 
Stus
 
MakeStus
(
”rÜ
::
GoogËE¼Ü
 
code
, cÚ¡ 
¡d
::
¡ršg
 &
mes§ge
) const {

124  
Stus
(
code
, 
ab¦
::
SŒC©
("S”v” ", 
Çme_
, ": ", 
mes§ge
));

128 
	g¡d
::
¡ršg
 
Çme_
;

131 
mubË
 
	gab¦
::
Mu‹x
 
mu_
;

132 
S‹
 
	g¡©e_
;

133 
	g¡d
::
veùÜ
<
¡d
::
unique_±r
<::
g½c
::
S”viû
>> 
£rviûs_
;

134 
	g¡d
::
unique_±r
<::
g½c
::
S”v”
> 
£rv”_
;

135 ::
g½c
::
S”v”Bud”
 
bud”_
;

	@grpc/util/grpc_server_launcher_test.cc

19 
	~"asylo/g½c/ut/g½c_£rv”_Ïunch”.h
"

21 
	~<th»ad
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/time/time.h
"

28 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

29 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

32 
	~"asylo/ut/¡©usÜ.h
"

33 
	~"šşude/g½ıp/g½ıp.h
"

34 
	~"šşude/g½ıp/im¶/codeg’/£rviû_ty³.h
"

35 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 
	gusšg
 ::
‹¡šg
::
NÙ
;

42 
cÚ¡ex´
 
	gkMes£ng”Cl›ÁName
[] = "GrpcServerLauncherTest";

43 
cÚ¡ex´
 
	gkLoÿlho¡Add»ss
[] = "[::1]";

46 cÚ¡ 
št64_t
 
	gkD—dlšeMiüos
 = 
ab¦
::
SecÚds
(10è/‡b¦::
Miüo£cÚds
(1);

49 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kP»ShutdownWa™
 = 
ab¦
::
Mli£cÚds
(100);

53 şas 
	cAsyncD–ayedShutdownInvok”
 {

54 
	gpublic
:

61 
ex¶ic™
 
AsyncD–ayedShutdownInvok”
(
G½cS”v”Launch”
 *
Ïunch”
)

62 : 
th»ad_
(&
D–ayedShutdown
, 
Ïunch”
) {}

64 ~
AsyncD–ayedShutdownInvok”
(è{ 
	gth»ad_
.
još
(); }

66 
	g´iv©e
:

67 
D–ayedShutdown
(
G½cS”v”Launch”
 *
Ïunch”
) {

68 
ab¦
::
SË•FÜ
(
kP»ShutdownWa™
);

69 
EXPECT_THAT
(
Ïunch”
->
Shutdown
(), 
IsOk
());

72 
	g¡d
::
th»ad
 
th»ad_
;

77 şas 
	cG½cS”v”Launch”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

78 
´Ùeùed
:

79 
G½cS”v”Launch”Te¡
()

80 : 
Ïunch”_
(::
‹¡šg
::
Un™Te¡
::
G‘In¡ªû
()

81 ->
cu¼’t_‹¡_šfo
()

82 ->
‹¡_ÿ£_Çme
()),

83 
£rv”_add»ss_
(
ab¦
::
SŒC©
(
kLoÿlho¡Add»ss
, ":", 0)) {}

85 ~
G½cS”v”Launch”Te¡
(è
	gov”ride
 {

87 
	gÏunch”_
.
Shutdown
();

93 
Stus
 
LaunchS”v”
() {

94 
ASYLO_RETURN_IF_ERROR
(

95 
Ïunch”_
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>()));

96 
ASYLO_RETURN_IF_ERROR
(

97 
Ïunch”_
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”2
>()));

99 
	gpÜt
;

100 
ASYLO_RETURN_IF_ERROR
(
Ïunch”_
.
AddLi¡’šgPÜt
(

101 
£rv”_add»ss_
, ::
g½c
::
In£cu»S”v”C»d’tŸls
(), &
pÜt
));

102 
ASYLO_RETURN_IF_ERROR
(
Ïunch”_
.
S¹
());

105 
	g£rv”_add»ss_
 = 
ab¦
::
SŒC©
(
kLoÿlho¡Add»ss
, ":", 
pÜt
);

107  
	gStus
::
OkStus
();

111 
boŞ
 
CÚÃùChªÃl
() {

112 
	gchªÃl_
 = ::
g½c
::
C»©eChªÃl
(
£rv”_add»ss_
,

113 ::
g½c
::
In£cu»ChªÃlC»d’tŸls
());

114 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 =

115 
g´_time_add
(
g´_now
(
GPR_CLOCK_REALTIME
),

116 
g´_time_äom_miüos
(
kD—dlšeMiüos
, 
GPR_TIMESPAN
));

117  
	gchªÃl_
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
);

121 
Stus
 
C®lS”viûs
() {

122 
	g‹¡
::
Mes£ng”Cl›Á1
 
mes£ng”_ş›Á1
(
chªÃl_
);

123 
	g¡d
::
¡ršg
 
»¥Ú£
;

124 
ASYLO_ASSIGN_OR_RETURN
(
»¥Ú£
,

125 
mes£ng”_ş›Á1
.
H–lo
(
kMes£ng”Cl›ÁName
));

126 
EXPECT_EQ
(
»¥Ú£
,

127 
‹¡
::
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kMes£ng”Cl›ÁName
));

129 
	g‹¡
::
Mes£ng”Cl›Á2
 
mes£ng”_ş›Á2
(
chªÃl_
);

130 
ASYLO_ASSIGN_OR_RETURN
(
»¥Ú£
,

131 
mes£ng”_ş›Á2
.
H–lo
(
kMes£ng”Cl›ÁName
));

132 
EXPECT_EQ
(
»¥Ú£
,

133 
‹¡
::
Mes£ng”S”v”2
::
Re¥Ú£SŒšg
(
kMes£ng”Cl›ÁName
));

134  
	gStus
::
OkStus
();

137 
G½cS”v”Launch”
 
	gÏunch”_
;

138 
	g¡d
::
¡ršg
 
£rv”_add»ss_
;

139 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl_
;

144 
TEST_F
(
G½cS”v”Launch”Te¡
, 
TwoS”viûSª™yTe¡
) {

145 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

146 
ASSERT_EQ
(
Ïunch”_
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
LAUNCHED
);

147 
ASSERT_TRUE
(
CÚÃùChªÃl
());

149 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

152 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

153 
ASSERT_EQ
(
Ïunch”_
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
LAUNCHED
);

154 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

155 
ASSERT_EQ
(
Ïunch”_
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
TERMINATED
);

160 
TEST_F
(
G½cS”v”Launch”Te¡
, 
ModifyAá”S¹
) {

161 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

162 
ASSERT_TRUE
(
CÚÃùChªÃl
());

164 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

167 
EXPECT_THAT
(

168 
Ïunch”_
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”3
>()),

169 
NÙ
(
IsOk
()));

171 cÚ¡ 
	g¡d
::
¡ršg
 
£rv”_add»ss
 = 
ab¦
::
SŒC©
(
kLoÿlho¡Add»ss
, ":", 0);

174 
EXPECT_THAT
(
Ïunch”_
.
AddLi¡’šgPÜt
(
£rv”_add»ss
,

175 ::
g½c
::
In£cu»S”v”C»d’tŸls
()),

176 
NÙ
(
IsOk
()));

178 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

179 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

183 
TEST_F
(
G½cS”v”Launch”Te¡
, 
P»LaunchS‹
) {

184 
G½cS”v”Launch”
 
Ïunch”
("PreLaunchState");

185 
ASSERT_EQ
(
Ïunch”
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
NOT_LAUNCHED
);

189 
TEST_F
(
G½cS”v”Launch”Te¡
, 
ShutdownBefÜeS¹
) {

190 
G½cS”v”Launch”
 
Ïunch”
("ShutdownBeforeStart");

191 
EXPECT_THAT
(
Ïunch”
.
Shutdown
(), 
NÙ
(
IsOk
()));

195 
TEST_F
(
G½cS”v”Launch”Te¡
, 
Wa™BefÜeS¹
) {

196 
G½cS”v”Launch”
 
Ïunch”
("WaitBeforeStart");

197 
EXPECT_THAT
(
Ïunch”
.
Wa™
(), 
NÙ
(
IsOk
()));

201 
TEST_F
(
G½cS”v”Launch”Te¡
, 
DoubËShutdown
) {

202 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

203 
ASSERT_TRUE
(
CÚÃùChªÃl
());

205 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

207 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

208 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

209 
EXPECT_THAT
(
Ïunch”_
.
Shutdown
(), 
NÙ
(
IsOk
()));

213 
TEST_F
(
G½cS”v”Launch”Te¡
, 
DoubËWa™
) {

214 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

215 
ASSERT_TRUE
(
CÚÃùChªÃl
());

217 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

219 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

220 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

221 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
NÙ
(
IsOk
()));

225 
TEST_F
(
G½cS”v”Launch”Te¡
, 
LaunchAá”Shutdown
) {

226 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

227 
ASSERT_TRUE
(
CÚÃùChªÃl
());

229 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

231 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

232 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

233 
EXPECT_THAT
(
Ïunch”_
.
S¹
(), 
NÙ
(
IsOk
()));

	@grpc/util/grpc_server_launcher_test.cc

19 
	~"asylo/g½c/ut/g½c_£rv”_Ïunch”.h
"

21 
	~<th»ad
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/time/time.h
"

28 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

29 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

32 
	~"asylo/ut/¡©usÜ.h
"

33 
	~"šşude/g½ıp/g½ıp.h
"

34 
	~"šşude/g½ıp/im¶/codeg’/£rviû_ty³.h
"

35 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 
	gusšg
 ::
‹¡šg
::
NÙ
;

42 
cÚ¡ex´
 
	gkMes£ng”Cl›ÁName
[] = "GrpcServerLauncherTest";

43 
cÚ¡ex´
 
	gkLoÿlho¡Add»ss
[] = "[::1]";

46 cÚ¡ 
št64_t
 
	gkD—dlšeMiüos
 = 
ab¦
::
SecÚds
(10è/‡b¦::
Miüo£cÚds
(1);

49 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kP»ShutdownWa™
 = 
ab¦
::
Mli£cÚds
(100);

53 şas 
	cAsyncD–ayedShutdownInvok”
 {

54 
	gpublic
:

61 
ex¶ic™
 
AsyncD–ayedShutdownInvok”
(
G½cS”v”Launch”
 *
Ïunch”
)

62 : 
th»ad_
(&
D–ayedShutdown
, 
Ïunch”
) {}

64 ~
AsyncD–ayedShutdownInvok”
(è{ 
	gth»ad_
.
još
(); }

66 
	g´iv©e
:

67 
D–ayedShutdown
(
G½cS”v”Launch”
 *
Ïunch”
) {

68 
ab¦
::
SË•FÜ
(
kP»ShutdownWa™
);

69 
EXPECT_THAT
(
Ïunch”
->
Shutdown
(), 
IsOk
());

72 
	g¡d
::
th»ad
 
th»ad_
;

77 şas 
	cG½cS”v”Launch”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

78 
´Ùeùed
:

79 
G½cS”v”Launch”Te¡
()

80 : 
Ïunch”_
(::
‹¡šg
::
Un™Te¡
::
G‘In¡ªû
()

81 ->
cu¼’t_‹¡_šfo
()

82 ->
‹¡_ÿ£_Çme
()),

83 
£rv”_add»ss_
(
ab¦
::
SŒC©
(
kLoÿlho¡Add»ss
, ":", 0)) {}

85 ~
G½cS”v”Launch”Te¡
(è
	gov”ride
 {

87 
	gÏunch”_
.
Shutdown
();

93 
Stus
 
LaunchS”v”
() {

94 
ASYLO_RETURN_IF_ERROR
(

95 
Ïunch”_
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>()));

96 
ASYLO_RETURN_IF_ERROR
(

97 
Ïunch”_
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”2
>()));

99 
	gpÜt
;

100 
ASYLO_RETURN_IF_ERROR
(
Ïunch”_
.
AddLi¡’šgPÜt
(

101 
£rv”_add»ss_
, ::
g½c
::
In£cu»S”v”C»d’tŸls
(), &
pÜt
));

102 
ASYLO_RETURN_IF_ERROR
(
Ïunch”_
.
S¹
());

105 
	g£rv”_add»ss_
 = 
ab¦
::
SŒC©
(
kLoÿlho¡Add»ss
, ":", 
pÜt
);

107  
	gStus
::
OkStus
();

111 
boŞ
 
CÚÃùChªÃl
() {

112 
	gchªÃl_
 = ::
g½c
::
C»©eChªÃl
(
£rv”_add»ss_
,

113 ::
g½c
::
In£cu»ChªÃlC»d’tŸls
());

114 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 =

115 
g´_time_add
(
g´_now
(
GPR_CLOCK_REALTIME
),

116 
g´_time_äom_miüos
(
kD—dlšeMiüos
, 
GPR_TIMESPAN
));

117  
	gchªÃl_
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
);

121 
Stus
 
C®lS”viûs
() {

122 
	g‹¡
::
Mes£ng”Cl›Á1
 
mes£ng”_ş›Á1
(
chªÃl_
);

123 
	g¡d
::
¡ršg
 
»¥Ú£
;

124 
ASYLO_ASSIGN_OR_RETURN
(
»¥Ú£
,

125 
mes£ng”_ş›Á1
.
H–lo
(
kMes£ng”Cl›ÁName
));

126 
EXPECT_EQ
(
»¥Ú£
,

127 
‹¡
::
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kMes£ng”Cl›ÁName
));

129 
	g‹¡
::
Mes£ng”Cl›Á2
 
mes£ng”_ş›Á2
(
chªÃl_
);

130 
ASYLO_ASSIGN_OR_RETURN
(
»¥Ú£
,

131 
mes£ng”_ş›Á2
.
H–lo
(
kMes£ng”Cl›ÁName
));

132 
EXPECT_EQ
(
»¥Ú£
,

133 
‹¡
::
Mes£ng”S”v”2
::
Re¥Ú£SŒšg
(
kMes£ng”Cl›ÁName
));

134  
	gStus
::
OkStus
();

137 
G½cS”v”Launch”
 
	gÏunch”_
;

138 
	g¡d
::
¡ršg
 
£rv”_add»ss_
;

139 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl_
;

144 
TEST_F
(
G½cS”v”Launch”Te¡
, 
TwoS”viûSª™yTe¡
) {

145 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

146 
ASSERT_EQ
(
Ïunch”_
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
LAUNCHED
);

147 
ASSERT_TRUE
(
CÚÃùChªÃl
());

149 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

152 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

153 
ASSERT_EQ
(
Ïunch”_
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
LAUNCHED
);

154 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

155 
ASSERT_EQ
(
Ïunch”_
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
TERMINATED
);

160 
TEST_F
(
G½cS”v”Launch”Te¡
, 
ModifyAá”S¹
) {

161 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

162 
ASSERT_TRUE
(
CÚÃùChªÃl
());

164 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

167 
EXPECT_THAT
(

168 
Ïunch”_
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”3
>()),

169 
NÙ
(
IsOk
()));

171 cÚ¡ 
	g¡d
::
¡ršg
 
£rv”_add»ss
 = 
ab¦
::
SŒC©
(
kLoÿlho¡Add»ss
, ":", 0);

174 
EXPECT_THAT
(
Ïunch”_
.
AddLi¡’šgPÜt
(
£rv”_add»ss
,

175 ::
g½c
::
In£cu»S”v”C»d’tŸls
()),

176 
NÙ
(
IsOk
()));

178 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

179 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

183 
TEST_F
(
G½cS”v”Launch”Te¡
, 
P»LaunchS‹
) {

184 
G½cS”v”Launch”
 
Ïunch”
("PreLaunchState");

185 
ASSERT_EQ
(
Ïunch”
.
G‘S‹
(), 
G½cS”v”Launch”
::
S‹
::
NOT_LAUNCHED
);

189 
TEST_F
(
G½cS”v”Launch”Te¡
, 
ShutdownBefÜeS¹
) {

190 
G½cS”v”Launch”
 
Ïunch”
("ShutdownBeforeStart");

191 
EXPECT_THAT
(
Ïunch”
.
Shutdown
(), 
NÙ
(
IsOk
()));

195 
TEST_F
(
G½cS”v”Launch”Te¡
, 
Wa™BefÜeS¹
) {

196 
G½cS”v”Launch”
 
Ïunch”
("WaitBeforeStart");

197 
EXPECT_THAT
(
Ïunch”
.
Wa™
(), 
NÙ
(
IsOk
()));

201 
TEST_F
(
G½cS”v”Launch”Te¡
, 
DoubËShutdown
) {

202 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

203 
ASSERT_TRUE
(
CÚÃùChªÃl
());

205 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

207 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

208 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

209 
EXPECT_THAT
(
Ïunch”_
.
Shutdown
(), 
NÙ
(
IsOk
()));

213 
TEST_F
(
G½cS”v”Launch”Te¡
, 
DoubËWa™
) {

214 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

215 
ASSERT_TRUE
(
CÚÃùChªÃl
());

217 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

219 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

220 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

221 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
NÙ
(
IsOk
()));

225 
TEST_F
(
G½cS”v”Launch”Te¡
, 
LaunchAá”Shutdown
) {

226 
ASSERT_THAT
(
LaunchS”v”
(), 
IsOk
());

227 
ASSERT_TRUE
(
CÚÃùChªÃl
());

229 
EXPECT_THAT
(
C®lS”viûs
(), 
IsOk
());

231 
AsyncD–ayedShutdownInvok”
 
shutdown_švok”
(&
Ïunch”_
);

232 
EXPECT_THAT
(
Ïunch”_
.
Wa™
(), 
IsOk
());

233 
EXPECT_THAT
(
Ïunch”_
.
S¹
(), 
NÙ
(
IsOk
()));

	@identity/additional_authenticated_data_generator.cc

19 
	~"asylo/id’t™y/add™iÚ®_auth’tiÿ‹d_d©a_g’”©Ü.h
"

21 
	~<c¡dšt
>

22 
	~<veùÜ
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"ab¦/¡ršgs/esÿpšg.h
"

26 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
	~"asylo/üy±o/sha256_hash.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

30 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

31 
	~"asylo/ut/¡©us.h
"

32 
	~"asylo/ut/¡©us_maüos.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
cÚ¡ex´
 
	gkAdd™iÚ®Auth’tiÿ‹dD©aSize
 = 64;

39 cÚ¡ 
	gkG‘PûInfoUuidHex
[] = "00000000000000000000000000000000";

40 cÚ¡ 
	gkG‘PûInfoPu½o£Hex
[] = "00000000000000000000000000000000";

42 cÚ¡ 
	gkPûSignR•ÜtUuidHex
[] = "4153594c4f205349474e5245504f5254";

43 cÚ¡ 
	gkPûSignR•ÜtPu½o£Hex
[] = "00000000000000000000000000000000";

45 cÚ¡ 
	gkEk•UuidHex
[] = "4153594c4f20454b4550000000000000";

46 cÚ¡ 
	gkEk•Pu½o£Hex
[] = "00000000000000000000000000000000";

50 
	gAdd™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
(

51 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
,

52 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
pu½o£
)

53 : 
uuid_
(
uuid
), 
pu½o£_
(
pu½o£
) {}

55 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

56 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eG‘PûInfoAadG’”©Ü
() {

57 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
;

58 
ASYLO_RETURN_IF_ERROR
(

59 
S‘TrivŸlObjeùFromHexSŒšg
(
kG‘PûInfoUuidHex
, &
uuid
));

60 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
	gpu½o£
;

61 
ASYLO_RETURN_IF_ERROR
(

62 
S‘TrivŸlObjeùFromHexSŒšg
(
kG‘PûInfoPu½o£Hex
, &
pu½o£
));

63  
	gab¦
::
make_unique
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>(
uuid
, 
	gpu½o£
);

66 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

67 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©ePûSignR•ÜtAadG’”©Ü
() {

68 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
;

69 
ASYLO_RETURN_IF_ERROR
(

70 
S‘TrivŸlObjeùFromHexSŒšg
(
kPûSignR•ÜtUuidHex
, &
uuid
));

71 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
	gpu½o£
;

72 
ASYLO_RETURN_IF_ERROR
(

73 
S‘TrivŸlObjeùFromHexSŒšg
(
kPûSignR•ÜtPu½o£Hex
, &
pu½o£
));

74  
	gab¦
::
make_unique
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>(
uuid
, 
	gpu½o£
);

77 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

78 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eEk•AadG’”©Ü
() {

79 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
;

80 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromHexSŒšg
(
kEk•UuidHex
, &
uuid
));

81 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
	gpu½o£
;

82 
ASYLO_RETURN_IF_ERROR
(

83 
S‘TrivŸlObjeùFromHexSŒšg
(
kEk•Pu½o£Hex
, &
pu½o£
));

84  
	gab¦
::
make_unique
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>(
uuid
, 
	gpu½o£
);

87 
	gStusOr
<
	g¡d
::
¡ršg
> 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
G’”©e
(

88 
ab¦
::
¡ršg_v›w
 
d©a
) {

89 
Sha256Hash
 
hash”
;

90 
	ghash”
.
In™
();

91 
	ghash”
.
Upd©e
(
d©a
);

92 
	g¡d
::
veùÜ
<
ušt8_t
> 
hash
;

93 
ASYLO_RETURN_IF_ERROR
(
hash”
.
CumuÏtiveHash
(&
hash
));

94 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aSize
> 
	g¯d
;

95 ià(
	g¯d
.
»¶aû
(0, 
hash
è!ğ
hash”
.
Dige¡Size
()) {

96  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Setting hash data failed");

98 ià(
	g¯d
.
»¶aû
(
hash”
.
Dige¡Size
(), 
pu½o£_
) !=

99 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
) {

100  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Setting…urpose data failed");

102 ià(
	g¯d
.
»¶aû
(
hash”
.
Dige¡Size
(è+ 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
,

103 
uuid_
è!ğ
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Setting UUID data failed");

106  
	gCİyToBy‹CÚš”
<
	g¡d
::
¡ršg
>(
¯d
);

	@identity/additional_authenticated_data_generator.cc

19 
	~"asylo/id’t™y/add™iÚ®_auth’tiÿ‹d_d©a_g’”©Ü.h
"

21 
	~<c¡dšt
>

22 
	~<veùÜ
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"ab¦/¡ršgs/esÿpšg.h
"

26 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
	~"asylo/üy±o/sha256_hash.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

30 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

31 
	~"asylo/ut/¡©us.h
"

32 
	~"asylo/ut/¡©us_maüos.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
cÚ¡ex´
 
	gkAdd™iÚ®Auth’tiÿ‹dD©aSize
 = 64;

39 cÚ¡ 
	gkG‘PûInfoUuidHex
[] = "00000000000000000000000000000000";

40 cÚ¡ 
	gkG‘PûInfoPu½o£Hex
[] = "00000000000000000000000000000000";

42 cÚ¡ 
	gkPûSignR•ÜtUuidHex
[] = "4153594c4f205349474e5245504f5254";

43 cÚ¡ 
	gkPûSignR•ÜtPu½o£Hex
[] = "00000000000000000000000000000000";

45 cÚ¡ 
	gkEk•UuidHex
[] = "4153594c4f20454b4550000000000000";

46 cÚ¡ 
	gkEk•Pu½o£Hex
[] = "00000000000000000000000000000000";

50 
	gAdd™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
(

51 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
,

52 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
pu½o£
)

53 : 
uuid_
(
uuid
), 
pu½o£_
(
pu½o£
) {}

55 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

56 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eG‘PûInfoAadG’”©Ü
() {

57 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
;

58 
ASYLO_RETURN_IF_ERROR
(

59 
S‘TrivŸlObjeùFromHexSŒšg
(
kG‘PûInfoUuidHex
, &
uuid
));

60 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
	gpu½o£
;

61 
ASYLO_RETURN_IF_ERROR
(

62 
S‘TrivŸlObjeùFromHexSŒšg
(
kG‘PûInfoPu½o£Hex
, &
pu½o£
));

63  
	gab¦
::
make_unique
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>(
uuid
, 
	gpu½o£
);

66 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

67 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©ePûSignR•ÜtAadG’”©Ü
() {

68 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
;

69 
ASYLO_RETURN_IF_ERROR
(

70 
S‘TrivŸlObjeùFromHexSŒšg
(
kPûSignR•ÜtUuidHex
, &
uuid
));

71 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
	gpu½o£
;

72 
ASYLO_RETURN_IF_ERROR
(

73 
S‘TrivŸlObjeùFromHexSŒšg
(
kPûSignR•ÜtPu½o£Hex
, &
pu½o£
));

74  
	gab¦
::
make_unique
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>(
uuid
, 
	gpu½o£
);

77 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

78 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eEk•AadG’”©Ü
() {

79 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
;

80 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromHexSŒšg
(
kEk•UuidHex
, &
uuid
));

81 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
	gpu½o£
;

82 
ASYLO_RETURN_IF_ERROR
(

83 
S‘TrivŸlObjeùFromHexSŒšg
(
kEk•Pu½o£Hex
, &
pu½o£
));

84  
	gab¦
::
make_unique
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>(
uuid
, 
	gpu½o£
);

87 
	gStusOr
<
	g¡d
::
¡ršg
> 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
G’”©e
(

88 
ab¦
::
¡ršg_v›w
 
d©a
) {

89 
Sha256Hash
 
hash”
;

90 
	ghash”
.
In™
();

91 
	ghash”
.
Upd©e
(
d©a
);

92 
	g¡d
::
veùÜ
<
ušt8_t
> 
hash
;

93 
ASYLO_RETURN_IF_ERROR
(
hash”
.
CumuÏtiveHash
(&
hash
));

94 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aSize
> 
	g¯d
;

95 ià(
	g¯d
.
»¶aû
(0, 
hash
è!ğ
hash”
.
Dige¡Size
()) {

96  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Setting hash data failed");

98 ià(
	g¯d
.
»¶aû
(
hash”
.
Dige¡Size
(), 
pu½o£_
) !=

99 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
) {

100  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Setting…urpose data failed");

102 ià(
	g¯d
.
»¶aû
(
hash”
.
Dige¡Size
(è+ 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
,

103 
uuid_
è!ğ
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Setting UUID data failed");

106  
	gCİyToBy‹CÚš”
<
	g¡d
::
¡ršg
>(
¯d
);

	@identity/additional_authenticated_data_generator.h

19 #iâdeà
ASYLO_IDENTITY_ADDITIONAL_AUTHENTICATED_DATA_GENERATOR_H_


20 
	#ASYLO_IDENTITY_ADDITIONAL_AUTHENTICATED_DATA_GENERATOR_H_


	)

22 
	~<memÜy
>

23 
	~<¡ršg
>

25 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

26 
	~"asylo/üy±o/ut/by‹s.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
cÚ¡ex´
 
	gkAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
 = 16;

32 
cÚ¡ex´
 
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
 = 16;

38 şas 
	cAdd™iÚ®Auth’tiÿ‹dD©aG’”©Ü
 {

39 
	gpublic
:

41 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
(

42 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid
,

43 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
pu½o£
);

47 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

48 
C»©eG‘PûInfoAadG’”©Ü
();

52 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

53 
C»©ePûSignR•ÜtAadG’”©Ü
();

57 
	gStusOr
<
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>

58 
C»©eEk•AadG’”©Ü
();

62 
	gStusOr
<
	g¡d
::
¡ršg
> 
G’”©e
(
ab¦
::
¡ršg_v›w
 
d©a
);

64 
	g´iv©e
:

66 
Un§ãBy‹s
<
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
> 
uuid_
;

69 
	gUn§ãBy‹s
<
	gkAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
> 
	gpu½o£_
;

	@identity/additional_authenticated_data_generator_test.cc

19 
	~"asylo/id’t™y/add™iÚ®_auth’tiÿ‹d_d©a_g’”©Ü.h
"

21 
	~<İ’s¦/sha.h
>

23 
	~<funùiÚ®
>

24 
	~<memÜy
>

25 
	~<¡ršg
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/¡ršgs/esÿpšg.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
	gusšg
 ::
‹¡šg
::
Te¡
;

38 cÚ¡ 
	gkG‘PûInfoUuidHex
[] = "00000000000000000000000000000000";

39 cÚ¡ 
	gkG‘PûInfoPu½o£Hex
[] = "00000000000000000000000000000000";

42 cÚ¡ 
	gkPûSignR•ÜtUuidHex
[] = "4153594c4f205349474e5245504f5254";

43 cÚ¡ 
	gkPûSignR•ÜtPu½o£Hex
[] = "00000000000000000000000000000000";

46 cÚ¡ 
	gkEk•UuidHex
[] = "4153594c4f20454b4550000000000000";

47 cÚ¡ 
	gkEk•Pu½o£Hex
[] = "00000000000000000000000000000000";

50 cÚ¡ 
	gkD©aHex
[] = "436f66666565206973206c6966652e0a";

51 cÚ¡ 
	gkD©aHashHex
[] =

54 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

55 
¡d
::
funùiÚ
<

56 
StusOr
<
¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>()>

57 
çùÜy
,

58 
¡d
::
¡ršg
 
uuid
, std::¡ršg 
pu½o£
) {

59 
¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
> 
g’”©Ü
;

60 
ASYLO_ASSERT_OK_AND_ASSIGN
(
g’”©Ü
, 
çùÜy
());

62 
	g¡d
::
¡ršg
 
¯d
;

63 
ASYLO_ASSERT_OK_AND_ASSIGN
(

64 
¯d
, 
g’”©Ü
->
G’”©e
(
ab¦
::
HexSŒšgToBy‹s
(
kD©aHex
)));

65 
ASSERT_EQ
(
¯d
.
size
(), 
SHA256_DIGEST_LENGTH
 +

66 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
 +

67 
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
);

69 
EXPECT_EQ
(
¯d
.
sub¡r
(0, 
SHA256_DIGEST_LENGTH
),

70 
ab¦
::
HexSŒšgToBy‹s
(
kD©aHashHex
));

71 
EXPECT_EQ
(

72 
¯d
.
sub¡r
(
SHA256_DIGEST_LENGTH
, 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
),

73 
pu½o£
);

74 
EXPECT_EQ
(

75 
¯d
.
sub¡r
(
SHA256_DIGEST_LENGTH
 + 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
,

76 
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
),

77 
uuid
);

82 
TEST
(
Add™iÚ®Auth’tiÿ‹dD©aG’”©ÜTe¡
, 
G‘PûInfoG’”©ÜSucûeds
) {

83 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

84 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eG‘PûInfoAadG’”©Ü
,

85 
ab¦
::
HexSŒšgToBy‹s
(
kG‘PûInfoUuidHex
),

86 
ab¦
::
HexSŒšgToBy‹s
(
kG‘PûInfoPu½o£Hex
));

91 
TEST
(
Add™iÚ®Auth’tiÿ‹dD©aG’”©ÜTe¡
,

92 
PûSigÃdR•ÜtG’”©ÜSucûeds
) {

93 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

94 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©ePûSignR•ÜtAadG’”©Ü
,

95 
ab¦
::
HexSŒšgToBy‹s
(
kPûSignR•ÜtUuidHex
),

96 
ab¦
::
HexSŒšgToBy‹s
(
kPûSignR•ÜtPu½o£Hex
));

101 
TEST
(
Add™iÚ®Auth’tiÿ‹dD©aG’”©ÜTe¡
, 
Ek•G’”©ÜSucûeds
) {

102 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

103 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eEk•AadG’”©Ü
,

104 
ab¦
::
HexSŒšgToBy‹s
(
kEk•UuidHex
),

105 
ab¦
::
HexSŒšgToBy‹s
(
kEk•Pu½o£Hex
));

	@identity/additional_authenticated_data_generator_test.cc

19 
	~"asylo/id’t™y/add™iÚ®_auth’tiÿ‹d_d©a_g’”©Ü.h
"

21 
	~<İ’s¦/sha.h
>

23 
	~<funùiÚ®
>

24 
	~<memÜy
>

25 
	~<¡ršg
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/¡ršgs/esÿpšg.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
	gusšg
 ::
‹¡šg
::
Te¡
;

38 cÚ¡ 
	gkG‘PûInfoUuidHex
[] = "00000000000000000000000000000000";

39 cÚ¡ 
	gkG‘PûInfoPu½o£Hex
[] = "00000000000000000000000000000000";

42 cÚ¡ 
	gkPûSignR•ÜtUuidHex
[] = "4153594c4f205349474e5245504f5254";

43 cÚ¡ 
	gkPûSignR•ÜtPu½o£Hex
[] = "00000000000000000000000000000000";

46 cÚ¡ 
	gkEk•UuidHex
[] = "4153594c4f20454b4550000000000000";

47 cÚ¡ 
	gkEk•Pu½o£Hex
[] = "00000000000000000000000000000000";

50 cÚ¡ 
	gkD©aHex
[] = "436f66666565206973206c6966652e0a";

51 cÚ¡ 
	gkD©aHashHex
[] =

54 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

55 
¡d
::
funùiÚ
<

56 
StusOr
<
¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
>>()>

57 
çùÜy
,

58 
¡d
::
¡ršg
 
uuid
, std::¡ršg 
pu½o£
) {

59 
¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
> 
g’”©Ü
;

60 
ASYLO_ASSERT_OK_AND_ASSIGN
(
g’”©Ü
, 
çùÜy
());

62 
	g¡d
::
¡ršg
 
¯d
;

63 
ASYLO_ASSERT_OK_AND_ASSIGN
(

64 
¯d
, 
g’”©Ü
->
G’”©e
(
ab¦
::
HexSŒšgToBy‹s
(
kD©aHex
)));

65 
ASSERT_EQ
(
¯d
.
size
(), 
SHA256_DIGEST_LENGTH
 +

66 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
 +

67 
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
);

69 
EXPECT_EQ
(
¯d
.
sub¡r
(0, 
SHA256_DIGEST_LENGTH
),

70 
ab¦
::
HexSŒšgToBy‹s
(
kD©aHashHex
));

71 
EXPECT_EQ
(

72 
¯d
.
sub¡r
(
SHA256_DIGEST_LENGTH
, 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
),

73 
pu½o£
);

74 
EXPECT_EQ
(

75 
¯d
.
sub¡r
(
SHA256_DIGEST_LENGTH
 + 
kAdd™iÚ®Auth’tiÿ‹dD©aPu½o£Size
,

76 
kAdd™iÚ®Auth’tiÿ‹dD©aUuidSize
),

77 
uuid
);

82 
TEST
(
Add™iÚ®Auth’tiÿ‹dD©aG’”©ÜTe¡
, 
G‘PûInfoG’”©ÜSucûeds
) {

83 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

84 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eG‘PûInfoAadG’”©Ü
,

85 
ab¦
::
HexSŒšgToBy‹s
(
kG‘PûInfoUuidHex
),

86 
ab¦
::
HexSŒšgToBy‹s
(
kG‘PûInfoPu½o£Hex
));

91 
TEST
(
Add™iÚ®Auth’tiÿ‹dD©aG’”©ÜTe¡
,

92 
PûSigÃdR•ÜtG’”©ÜSucûeds
) {

93 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

94 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©ePûSignR•ÜtAadG’”©Ü
,

95 
ab¦
::
HexSŒšgToBy‹s
(
kPûSignR•ÜtUuidHex
),

96 
ab¦
::
HexSŒšgToBy‹s
(
kPûSignR•ÜtPu½o£Hex
));

101 
TEST
(
Add™iÚ®Auth’tiÿ‹dD©aG’”©ÜTe¡
, 
Ek•G’”©ÜSucûeds
) {

102 
FaùÜySucûedsAndG’”©esEx³ùedV®ue
(

103 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eEk•AadG’”©Ü
,

104 
ab¦
::
HexSŒšgToBy‹s
(
kEk•UuidHex
),

105 
ab¦
::
HexSŒšgToBy‹s
(
kEk•Pu½o£Hex
));

	@identity/assertion_description_util.cc

19 
	~<funùiÚ®
>

20 
	~<¡ršg
>

22 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

23 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

24 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
size_t
 
	gAs£¹iÚDesütiÚHash”
::
İ”©Ü
()(

32 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) const {

33  
¡d
::
hash
<¡d::
¡ršg
>()(

34 
S”ŸlizeAs£¹iÚDesütiÚ
(
desütiÚ
).
V®ueOrD›
());

37 
boŞ
 
	gAs£¹iÚDesütiÚEq
::
İ”©Ü
()(cÚ¡ 
As£¹iÚDesütiÚ
 &
lhs
,

38 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	grhs
) const {

39  
	glhs
.
id’t™y_ty³
(è=ğ
rhs
.identity_type() &&

40 
lhs
.
authÜ™y_ty³
(è=ğ
rhs
.authority_type();

43 
	gStusOr
<
	g¡d
::
¡ršg
> 
S”ŸlizeAs£¹iÚDesütiÚ
(

44 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

45 
¡d
::
¡ršg
 
£rŸlized
;

46 
ASYLO_RETURN_IF_ERROR
(
S”ŸlizeBy‹CÚš”s
(

47 &
£rŸlized
, 
EnşaveId’t™yTy³_Name
(
desütiÚ
.
id’t™y_ty³
()),

48 
desütiÚ
.
authÜ™y_ty³
()));

49  
	g£rŸlized
;

	@identity/assertion_description_util.cc

19 
	~<funùiÚ®
>

20 
	~<¡ršg
>

22 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

23 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

24 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
size_t
 
	gAs£¹iÚDesütiÚHash”
::
İ”©Ü
()(

32 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) const {

33  
¡d
::
hash
<¡d::
¡ršg
>()(

34 
S”ŸlizeAs£¹iÚDesütiÚ
(
desütiÚ
).
V®ueOrD›
());

37 
boŞ
 
	gAs£¹iÚDesütiÚEq
::
İ”©Ü
()(cÚ¡ 
As£¹iÚDesütiÚ
 &
lhs
,

38 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	grhs
) const {

39  
	glhs
.
id’t™y_ty³
(è=ğ
rhs
.identity_type() &&

40 
lhs
.
authÜ™y_ty³
(è=ğ
rhs
.authority_type();

43 
	gStusOr
<
	g¡d
::
¡ršg
> 
S”ŸlizeAs£¹iÚDesütiÚ
(

44 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) {

45 
¡d
::
¡ršg
 
£rŸlized
;

46 
ASYLO_RETURN_IF_ERROR
(
S”ŸlizeBy‹CÚš”s
(

47 &
£rŸlized
, 
EnşaveId’t™yTy³_Name
(
desütiÚ
.
id’t™y_ty³
()),

48 
desütiÚ
.
authÜ™y_ty³
()));

49  
	g£rŸlized
;

	@identity/assertion_description_util.h

19 #iâdeà
ASYLO_IDENTITY_ASSERTION_DESCRIPTION_UTIL_H_


20 
	#ASYLO_IDENTITY_ASSERTION_DESCRIPTION_UTIL_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

28 
Çme¥aû
 
	gasylo
 {

33 
	sAs£¹iÚDesütiÚHash”
 {

34 
size_t
 
İ”©Ü
()(cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
) const;

40 
	sAs£¹iÚDesütiÚEq
 {

41 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	glhs
,

42 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	grhs
) const;

47 
	gStusOr
<
	g¡d
::
¡ršg
> 
S”ŸlizeAs£¹iÚDesütiÚ
(

48 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
);

50 
usšg
 
	gAs£¹iÚDesütiÚHashS‘
 =

51 
ab¦
::
æ©_hash_£t
<
As£¹iÚDesütiÚ
, 
	gAs£¹iÚDesütiÚHash”
,

52 
	gAs£¹iÚDesütiÚEq
>;

	@identity/assertion_description_util_test.cc

19 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
	gkAuthÜ™y1
[] = "Foo Authority";

29 
cÚ¡ex´
 
	gkAuthÜ™y2
[] = "Bar Authority";

31 
As£¹iÚDesütiÚ
 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
 
id’t™y_ty³
,

32 
¡d
::
¡ršg
 
authÜ™y_ty³
) {

33 
As£¹iÚDesütiÚ
 
desütiÚ
;

34 
	gdesütiÚ
.
£t_id’t™y_ty³
(
id’t™y_ty³
);

35 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
¡d
::
move
(
authÜ™y_ty³
));

36  
	gdesütiÚ
;

41 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
Equ®™yFunùÜPos™ive
) {

42 
As£¹iÚDesütiÚ
 
	gdesütiÚ
 =

43 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

44 
EXPECT_TRUE
(
As£¹iÚDesütiÚEq
()(
desütiÚ
, description));

49 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
Equ®™yFunùÜDifã»ÁId’t™yTy³
) {

50 
As£¹iÚDesütiÚ
 
	gdesütiÚ1
 =

51 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

52 
As£¹iÚDesütiÚ
 
	gdesütiÚ2
 =

53 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
NULL_IDENTITY
, 
kAuthÜ™y1
);

54 
EXPECT_FALSE
(
As£¹iÚDesütiÚEq
()(
desütiÚ1
, 
desütiÚ2
));

59 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
Equ®™yFunùÜDifã»ÁAuthÜ™yTy³
) {

60 
As£¹iÚDesütiÚ
 
	gdesütiÚ1
 =

61 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

62 
As£¹iÚDesütiÚ
 
	gdesütiÚ2
 =

63 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y2
);

64 
EXPECT_FALSE
(
As£¹iÚDesütiÚEq
()(
desütiÚ1
, 
desütiÚ2
));

69 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
UnÜd”edS‘
) {

70 
As£¹iÚDesütiÚ
 
	gdesütiÚ1
 =

71 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

72 
As£¹iÚDesütiÚ
 
	gdesütiÚ2
 =

73 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y2
);

74 
As£¹iÚDesütiÚ
 
	gdesütiÚ3
 =

75 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
NULL_IDENTITY
, 
kAuthÜ™y2
);

77 
As£¹iÚDesütiÚHashS‘
 
	gas£¹iÚ_desütiÚs
;

79 
ASSERT_TRUE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ1
).
£cÚd
);

80 
EXPECT_FALSE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ1
).
£cÚd
);

82 
ASSERT_TRUE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ2
).
£cÚd
);

83 
EXPECT_FALSE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ2
).
£cÚd
);

85 autØ
	g™”
 = 
as£¹iÚ_desütiÚs
.
fšd
(
desütiÚ1
);

86 
ASSERT_NE
(
™”
, 
as£¹iÚ_desütiÚs
.
’d
());

87 
EXPECT_THAT
(*
™”
, 
Equ®sPrÙo
(
desütiÚ1
));

89 
	g™”
 = 
as£¹iÚ_desütiÚs
.
fšd
(
desütiÚ2
);

90 
ASSERT_NE
(
™”
, 
as£¹iÚ_desütiÚs
.
’d
());

91 
EXPECT_THAT
(*
™”
, 
Equ®sPrÙo
(
desütiÚ2
));

93 
	g™”
 = 
as£¹iÚ_desütiÚs
.
fšd
(
desütiÚ3
);

94 
EXPECT_EQ
(
™”
, 
as£¹iÚ_desütiÚs
.
’d
());

	@identity/assertion_description_util_test.cc

19 
	~"asylo/id’t™y/as£¹iÚ_desütiÚ_ut.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
	gkAuthÜ™y1
[] = "Foo Authority";

29 
cÚ¡ex´
 
	gkAuthÜ™y2
[] = "Bar Authority";

31 
As£¹iÚDesütiÚ
 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
 
id’t™y_ty³
,

32 
¡d
::
¡ršg
 
authÜ™y_ty³
) {

33 
As£¹iÚDesütiÚ
 
desütiÚ
;

34 
	gdesütiÚ
.
£t_id’t™y_ty³
(
id’t™y_ty³
);

35 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
¡d
::
move
(
authÜ™y_ty³
));

36  
	gdesütiÚ
;

41 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
Equ®™yFunùÜPos™ive
) {

42 
As£¹iÚDesütiÚ
 
	gdesütiÚ
 =

43 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

44 
EXPECT_TRUE
(
As£¹iÚDesütiÚEq
()(
desütiÚ
, description));

49 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
Equ®™yFunùÜDifã»ÁId’t™yTy³
) {

50 
As£¹iÚDesütiÚ
 
	gdesütiÚ1
 =

51 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

52 
As£¹iÚDesütiÚ
 
	gdesütiÚ2
 =

53 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
NULL_IDENTITY
, 
kAuthÜ™y1
);

54 
EXPECT_FALSE
(
As£¹iÚDesütiÚEq
()(
desütiÚ1
, 
desütiÚ2
));

59 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
Equ®™yFunùÜDifã»ÁAuthÜ™yTy³
) {

60 
As£¹iÚDesütiÚ
 
	gdesütiÚ1
 =

61 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

62 
As£¹iÚDesütiÚ
 
	gdesütiÚ2
 =

63 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y2
);

64 
EXPECT_FALSE
(
As£¹iÚDesütiÚEq
()(
desütiÚ1
, 
desütiÚ2
));

69 
TEST
(
As£¹iÚDesütiÚUtTe¡
, 
UnÜd”edS‘
) {

70 
As£¹iÚDesütiÚ
 
	gdesütiÚ1
 =

71 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y1
);

72 
As£¹iÚDesütiÚ
 
	gdesütiÚ2
 =

73 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
, 
kAuthÜ™y2
);

74 
As£¹iÚDesütiÚ
 
	gdesütiÚ3
 =

75 
MakeAs£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
::
NULL_IDENTITY
, 
kAuthÜ™y2
);

77 
As£¹iÚDesütiÚHashS‘
 
	gas£¹iÚ_desütiÚs
;

79 
ASSERT_TRUE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ1
).
£cÚd
);

80 
EXPECT_FALSE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ1
).
£cÚd
);

82 
ASSERT_TRUE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ2
).
£cÚd
);

83 
EXPECT_FALSE
(
as£¹iÚ_desütiÚs
.
š£¹
(
desütiÚ2
).
£cÚd
);

85 autØ
	g™”
 = 
as£¹iÚ_desütiÚs
.
fšd
(
desütiÚ1
);

86 
ASSERT_NE
(
™”
, 
as£¹iÚ_desütiÚs
.
’d
());

87 
EXPECT_THAT
(*
™”
, 
Equ®sPrÙo
(
desütiÚ1
));

89 
	g™”
 = 
as£¹iÚ_desütiÚs
.
fšd
(
desütiÚ2
);

90 
ASSERT_NE
(
™”
, 
as£¹iÚ_desütiÚs
.
’d
());

91 
EXPECT_THAT
(*
™”
, 
Equ®sPrÙo
(
desütiÚ2
));

93 
	g™”
 = 
as£¹iÚ_desütiÚs
.
fšd
(
desütiÚ3
);

94 
EXPECT_EQ
(
™”
, 
as£¹iÚ_desütiÚs
.
’d
());

	@identity/delegating_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/d–eg©šg_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

24 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gStusOr
<
	gboŞ
> 
	gD–eg©šgId’t™yEx³ù©iÚM©ch”
::
M©ch
(

29 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

30 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) const {

33 autØ
	gm©ch”_™
 = 
Id’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

34 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(
id’t™y
.
desütiÚ
())

35 .
V®ueOrD›
());

36 ià(
	gm©ch”_™
 =ğ
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
()) {

37  
Stus
(

38 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

39 
ab¦
::
SŒC©
("No matcherƒxists for identity with description ",

40 
id’t™y
.
desütiÚ
().
ShÜtDebugSŒšg
()));

44 ià(!::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(

45 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
(),

46 
id’t™y
.
desütiÚ
())) {

51 ià(
	gId’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

52 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(

53 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
())

54 .
V®ueOrD›
()è=ğ
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
()) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

56 
ab¦
::
SŒC©
("No matcherƒxists for matchingƒxpectation "

58 
ex³ù©iÚ
.
»ã»nû_id’t™y
()

59 .
desütiÚ
()

60 .
ShÜtDebugSŒšg
()));

70  
	gçl£
;

73  
	gm©ch”_™
->
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

	@identity/delegating_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/d–eg©šg_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

24 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gStusOr
<
	gboŞ
> 
	gD–eg©šgId’t™yEx³ù©iÚM©ch”
::
M©ch
(

29 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

30 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) const {

33 autØ
	gm©ch”_™
 = 
Id’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

34 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(
id’t™y
.
desütiÚ
())

35 .
V®ueOrD›
());

36 ià(
	gm©ch”_™
 =ğ
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
()) {

37  
Stus
(

38 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

39 
ab¦
::
SŒC©
("No matcherƒxists for identity with description ",

40 
id’t™y
.
desütiÚ
().
ShÜtDebugSŒšg
()));

44 ià(!::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(

45 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
(),

46 
id’t™y
.
desütiÚ
())) {

51 ià(
	gId’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

52 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(

53 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
())

54 .
V®ueOrD›
()è=ğ
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
()) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

56 
ab¦
::
SŒC©
("No matcherƒxists for matchingƒxpectation "

58 
ex³ù©iÚ
.
»ã»nû_id’t™y
()

59 .
desütiÚ
()

60 .
ShÜtDebugSŒšg
()));

70  
	gçl£
;

73  
	gm©ch”_™
->
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

	@identity/delegating_identity_expectation_matcher.h

19 #iâdeà
ASYLO_IDENTITY_DELEGATING_IDENTITY_EXPECTATION_MATCHER_H_


20 
	#ASYLO_IDENTITY_DELEGATING_IDENTITY_EXPECTATION_MATCHER_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/id’t™y_ex³ù©iÚ_m©ch”.h
"

24 
	~"asylo/ut/¡©usÜ.h
"

26 
Çme¥aû
 
	gasylo
 {

38 şas 
	cD–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gfš®


39 : 
public
 
Id’t™yEx³ù©iÚM©ch”
 {

40 
public
:

41 
D–eg©šgId’t™yEx³ù©iÚM©ch”
() = ;

42 ~
D–eg©šgId’t™yEx³ù©iÚM©ch”
(è
	gov”ride
 = ;

43 
D–eg©šgId’t™yEx³ù©iÚM©ch”
(

44 cÚ¡ 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 &
Ùh”
) = ;

45 
D–eg©šgId’t™yEx³ù©iÚM©ch”
(

46 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 &&
Ùh”
) = ;

49 
	gStusOr
<
	gboŞ
> 
M©ch
(

50 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

51 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
ècÚ¡ 
	gov”ride
;

	@identity/descriptions.h

19 #iâdeà
ASYLO_IDENTITY_DESCRIPTIONS_H_


20 
	#ASYLO_IDENTITY_DESCRIPTIONS_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

24 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

26 
Çme¥aû
 
	gasylo
 {

29 
šlše
 
S‘NuÎAs£¹iÚDesütiÚ
(

30 
As£¹iÚDesütiÚ
 *
as£¹iÚ_desütiÚ
) {

31 
	gas£¹iÚ_desütiÚ
->
£t_id’t™y_ty³
(
EnşaveId’t™yTy³
::
NULL_IDENTITY
);

32 
	gas£¹iÚ_desütiÚ
->
£t_authÜ™y_ty³
(
kNuÎAs£¹iÚAuthÜ™y
);

36 
šlše
 
S‘NuÎId’t™yDesütiÚ
(

37 
EnşaveId’t™yDesütiÚ
 *
id’t™y_desütiÚ
) {

38 
	gid’t™y_desütiÚ
->
£t_id’t™y_ty³
(
EnşaveId’t™yTy³
::
NULL_IDENTITY
);

39 
	gid’t™y_desütiÚ
->
£t_authÜ™y_ty³
(
kNuÎAuthÜiz©iÚAuthÜ™y
);

43 
šlše
 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(

44 
As£¹iÚDesütiÚ
 *
as£¹iÚ_desütiÚ
) {

45 
	gas£¹iÚ_desütiÚ
->
£t_id’t™y_ty³
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

46 
	gas£¹iÚ_desütiÚ
->
£t_authÜ™y_ty³
(
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

50 
šlše
 
S‘SgxRemÙeAs£¹iÚDesütiÚ
(

51 
As£¹iÚDesütiÚ
 *
as£¹iÚ_desütiÚ
) {

52 
	gas£¹iÚ_desütiÚ
->
£t_id’t™y_ty³
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

53 
	gas£¹iÚ_desütiÚ
->
£t_authÜ™y_ty³
(
sgx
::
kSgxRemÙeAs£¹iÚAuthÜ™y
);

57 
šlše
 
S‘SgxId’t™yDesütiÚ
(

58 
EnşaveId’t™yDesütiÚ
 *
id’t™y_desütiÚ
) {

59 
	gid’t™y_desütiÚ
->
£t_id’t™y_ty³
(
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

60 
	gid’t™y_desütiÚ
->
£t_authÜ™y_ty³
(
sgx
::
kSgxAuthÜiz©iÚAuthÜ™y
);

	@identity/enclave_assertion_authority.h

19 #iâdeà
ASYLO_IDENTITY_ENCLAVE_ASSERTION_AUTHORITY_H_


20 
	#ASYLO_IDENTITY_ENCLAVE_ASSERTION_AUTHORITY_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

43 şas 
	cEnşaveAs£¹iÚAuthÜ™y
 {

44 
	gpublic
:

45 
vœtu®
 ~
EnşaveAs£¹iÚAuthÜ™y
() = ;

51 
vœtu®
 
Stus
 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) = 0;

57 
vœtu®
 
boŞ
 
IsIn™Ÿlized
() const = 0;

62 
vœtu®
 
EnşaveId’t™yTy³
 
Id’t™yTy³
() const = 0;

67 
vœtu®
 
	g¡d
::
¡ršg
 
AuthÜ™yTy³
() const = 0;

80 
	gStusOr
<
	g¡d
::
¡ršg
> 
G’”©eAuthÜ™yId
(

81 cÚ¡ 
EnşaveId’t™yTy³
 &
id’t™y_ty³
,

82 cÚ¡ 
¡d
::
¡ršg
 &
authÜ™y_ty³
) {

83 
¡d
::
¡ršg
 
£rŸlized
;

84 
ASYLO_RETURN_IF_ERROR
(
asylo
::
S”ŸlizeBy‹CÚš”s
(

85 &
£rŸlized
, 
EnşaveId’t™yTy³_Name
(
id’t™y_ty³
), 
authÜ™y_ty³
));

86  
	g£rŸlized
;

89 
	g´Ùeùed
:

98 
boŞ
 
IsCom·tibËAs£¹iÚDesütiÚ
(

99 cÚ¡ 
As£¹iÚDesütiÚ
 &
desütiÚ
) const {

100  (
desütiÚ
.
id’t™y_ty³
(è=ğ
Id’t™yTy³
()) &&

101 (
desütiÚ
.
authÜ™y_ty³
(è=ğ
AuthÜ™yTy³
());

	@identity/enclave_assertion_generator.h

19 #iâdeà
ASYLO_IDENTITY_ENCLAVE_ASSERTION_GENERATOR_H_


20 
	#ASYLO_IDENTITY_ENCLAVE_ASSERTION_GENERATOR_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

27 
	~"asylo/ut/¡©us.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

45 şas 
	cEnşaveAs£¹iÚG’”©Ü
 : 
public
 
EnşaveAs£¹iÚAuthÜ™y
 {

46 
public
:

54 
vœtu®
 
Stus
 
C»©eAs£¹iÚOfãr
(
As£¹iÚOfãr
 *
ofãr
) const = 0;

65 
vœtu®
 
	gStusOr
<
	gboŞ
> 
CªG’”©e
(cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const = 0;

80 
vœtu®
 
Stus
 
G’”©e
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

81 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
,

82 
As£¹iÚ
 *
as£¹iÚ
) const = 0;

86 
	g‹m¶©e
 <>

87 
	gNam”
<
	gEnşaveAs£¹iÚG’”©Ü
> {

88 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
EnşaveAs£¹iÚG’”©Ü
 &
g’”©Ü
) {

89  
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

90 
g’”©Ü
.
Id’t™yTy³
(), g’”©Ü.
AuthÜ™yTy³
())

91 .
V®ueOrD›
();

95 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
As£¹iÚG’”©ÜM­
,

96 
EnşaveAs£¹iÚG’”©Ü
);

	@identity/enclave_assertion_verifier.h

19 #iâdeà
ASYLO_IDENTITY_ENCLAVE_ASSERTION_VERIFIER_H_


20 
	#ASYLO_IDENTITY_ENCLAVE_ASSERTION_VERIFIER_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

27 
	~"asylo/ut/¡©us.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

45 şas 
	cEnşaveAs£¹iÚV”if›r
 : 
public
 
EnşaveAs£¹iÚAuthÜ™y
 {

46 
public
:

54 
vœtu®
 
Stus
 
C»©eAs£¹iÚReque¡
(
As£¹iÚReque¡
 *
»que¡
) const = 0;

63 
vœtu®
 
	gStusOr
<
	gboŞ
> 
CªV”ify
(cÚ¡ 
As£¹iÚOfãr
 &
ofãr
) const = 0;

81 
vœtu®
 
Stus
 
V”ify
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

82 cÚ¡ 
As£¹iÚ
 &
as£¹iÚ
,

83 
EnşaveId’t™y
 *
³”_id’t™y
) const = 0;

87 
	g‹m¶©e
 <>

88 
	gNam”
<
	gEnşaveAs£¹iÚV”if›r
> {

89 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
EnşaveAs£¹iÚV”if›r
 &
v”if›r
) {

90  
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

91 
v”if›r
.
Id’t™yTy³
(), v”if›r.
AuthÜ™yTy³
())

92 .
V®ueOrD›
();

96 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
As£¹iÚV”if›rM­
, 
EnşaveAs£¹iÚV”if›r
);

	@identity/identity_acl_evaluator.cc

19 
	~"asylo/id’t™y/id’t™y_aş_ev®u©Ü.h
"

21 
	~<googË/´Ùobuf/»³©ed_f›ld.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
usšg
 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
;

32 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşOrP»diÿ‹Group
(

33 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

34 cÚ¡ 
R•—‹dPŒF›ld
<
Id’t™yAşP»diÿ‹
> &
´ediÿ‹s
,

35 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

36 cÚ¡ 
	gId’t™yAşP»diÿ‹
 &
	g´ediÿ‹
 : 
´ediÿ‹s
) {

37 cÚ¡ 
StusOr
<
boŞ
> 
»suÉ
 =

38 
Ev®u©eId’t™yAş
(
id’t™›s
, 
´ediÿ‹
, 
m©ch”
);

39 ià(!
	g»suÉ
.
ok
()) {

40  
	g»suÉ
;

43 ià(
	g»suÉ
.
V®ueOrD›
()) {

44  
	gŒue
;

48  
	gçl£
;

53 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşAndP»diÿ‹Group
(

54 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

55 cÚ¡ 
R•—‹dPŒF›ld
<
Id’t™yAşP»diÿ‹
> &
´ediÿ‹s
,

56 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

57 cÚ¡ 
	gId’t™yAşP»diÿ‹
 &
	g´ediÿ‹
 : 
´ediÿ‹s
) {

58 cÚ¡ 
StusOr
<
boŞ
> 
»suÉ
 =

59 
Ev®u©eId’t™yAş
(
id’t™›s
, 
´ediÿ‹
, 
m©ch”
);

60 ià(!
	g»suÉ
.
ok
()) {

61  
	g»suÉ
;

64 ià(!
	g»suÉ
.
V®ueOrD›
()) {

65  
	gçl£
;

69  
	gŒue
;

74 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşNÙP»diÿ‹Group
(

75 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

76 cÚ¡ 
R•—‹dPŒF›ld
<
Id’t™yAşP»diÿ‹
> &
´ediÿ‹s
,

77 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

78 ià(
	g´ediÿ‹s
.
size
() != 1) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

83 cÚ¡ 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 =

84 
Ev®u©eId’t™yAş
(
id’t™›s
, 
´ediÿ‹s
[0], 
m©ch”
);

85 ià(!
	g»suÉ
.
ok
()) {

86  
	g»suÉ
;

89  !
	g»suÉ
.
V®ueOrD›
();

93 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşP»diÿ‹Group
(

94 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

95 cÚ¡ 
Id’t™yAşGroup
 &
aş_group
,

96 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

97 cÚ¡ 
	gR•—‹dPŒF›ld
<
	gId’t™yAşP»diÿ‹
> &
	g´ediÿ‹s
 =

98 
aş_group
.
´ediÿ‹s
();

100 ià(
	g´ediÿ‹s
.
em±y
()) {

101  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
	gaş_group
.
ty³
()) {

106 
	gId’t™yAşGroup
::
OR
:

107  
Ev®u©eAşOrP»diÿ‹Group
(
id’t™›s
, 
´ediÿ‹s
, 
m©ch”
);

108 
	gId’t™yAşGroup
::
AND
:

109  
Ev®u©eAşAndP»diÿ‹Group
(
id’t™›s
, 
´ediÿ‹s
, 
m©ch”
);

110 
	gId’t™yAşGroup
::
NOT
:

111  
Ev®u©eAşNÙP»diÿ‹Group
(
id’t™›s
, 
´ediÿ‹s
, 
m©ch”
);

113  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

114 
ab¦
::
SŒC©
("UnknowÀaş_grou°ty³: ", 
aş_group
.
ty³
()));

120 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşEx³ù©iÚ
(

121 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

122 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
,

123 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

124 cÚ¡ 
	gEnşaveId’t™y
 &
	gid’t™y
 : 
id’t™›s
) {

125 cÚ¡ 
StusOr
<
boŞ
> 
»suÉ
 = 
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

126 ià(!
	g»suÉ
.
ok
()) {

127  
	g»suÉ
;

130 ià(
	g»suÉ
.
V®ueOrD›
()) {

131  
	gŒue
;

135  
	gçl£
;

140 
	gStusOr
<
	gboŞ
> 
Ev®u©eId’t™yAş
(

141 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

142 cÚ¡ 
Id’t™yAşP»diÿ‹
 &
aş
,

143 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

144 
	gaş
.
™em_ÿ£
()) {

145 
	gId’t™yAşP»diÿ‹
::
kAşGroup
:

146  
Ev®u©eAşP»diÿ‹Group
(
id’t™›s
, 
aş
.
aş_group
(), 
m©ch”
);

147 
	gId’t™yAşP»diÿ‹
::
kEx³ù©iÚ
:

148  
Ev®u©eAşEx³ù©iÚ
(
id’t™›s
, 
aş
.
ex³ù©iÚ
(), 
m©ch”
);

149 
	gId’t™yAşP»diÿ‹
::
ITEM_NOT_SET
:

150  
Stus
(

151 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

154  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

155 
ab¦
::
SŒC©
("UnknowÀaş i‹m: ", 
aş
.
™em_ÿ£
()));

	@identity/identity_acl_evaluator.cc

19 
	~"asylo/id’t™y/id’t™y_aş_ev®u©Ü.h
"

21 
	~<googË/´Ùobuf/»³©ed_f›ld.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
usšg
 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
;

32 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşOrP»diÿ‹Group
(

33 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

34 cÚ¡ 
R•—‹dPŒF›ld
<
Id’t™yAşP»diÿ‹
> &
´ediÿ‹s
,

35 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

36 cÚ¡ 
	gId’t™yAşP»diÿ‹
 &
	g´ediÿ‹
 : 
´ediÿ‹s
) {

37 cÚ¡ 
StusOr
<
boŞ
> 
»suÉ
 =

38 
Ev®u©eId’t™yAş
(
id’t™›s
, 
´ediÿ‹
, 
m©ch”
);

39 ià(!
	g»suÉ
.
ok
()) {

40  
	g»suÉ
;

43 ià(
	g»suÉ
.
V®ueOrD›
()) {

44  
	gŒue
;

48  
	gçl£
;

53 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşAndP»diÿ‹Group
(

54 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

55 cÚ¡ 
R•—‹dPŒF›ld
<
Id’t™yAşP»diÿ‹
> &
´ediÿ‹s
,

56 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

57 cÚ¡ 
	gId’t™yAşP»diÿ‹
 &
	g´ediÿ‹
 : 
´ediÿ‹s
) {

58 cÚ¡ 
StusOr
<
boŞ
> 
»suÉ
 =

59 
Ev®u©eId’t™yAş
(
id’t™›s
, 
´ediÿ‹
, 
m©ch”
);

60 ià(!
	g»suÉ
.
ok
()) {

61  
	g»suÉ
;

64 ià(!
	g»suÉ
.
V®ueOrD›
()) {

65  
	gçl£
;

69  
	gŒue
;

74 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşNÙP»diÿ‹Group
(

75 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

76 cÚ¡ 
R•—‹dPŒF›ld
<
Id’t™yAşP»diÿ‹
> &
´ediÿ‹s
,

77 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

78 ià(
	g´ediÿ‹s
.
size
() != 1) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

83 cÚ¡ 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 =

84 
Ev®u©eId’t™yAş
(
id’t™›s
, 
´ediÿ‹s
[0], 
m©ch”
);

85 ià(!
	g»suÉ
.
ok
()) {

86  
	g»suÉ
;

89  !
	g»suÉ
.
V®ueOrD›
();

93 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşP»diÿ‹Group
(

94 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

95 cÚ¡ 
Id’t™yAşGroup
 &
aş_group
,

96 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

97 cÚ¡ 
	gR•—‹dPŒF›ld
<
	gId’t™yAşP»diÿ‹
> &
	g´ediÿ‹s
 =

98 
aş_group
.
´ediÿ‹s
();

100 ià(
	g´ediÿ‹s
.
em±y
()) {

101  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
	gaş_group
.
ty³
()) {

106 
	gId’t™yAşGroup
::
OR
:

107  
Ev®u©eAşOrP»diÿ‹Group
(
id’t™›s
, 
´ediÿ‹s
, 
m©ch”
);

108 
	gId’t™yAşGroup
::
AND
:

109  
Ev®u©eAşAndP»diÿ‹Group
(
id’t™›s
, 
´ediÿ‹s
, 
m©ch”
);

110 
	gId’t™yAşGroup
::
NOT
:

111  
Ev®u©eAşNÙP»diÿ‹Group
(
id’t™›s
, 
´ediÿ‹s
, 
m©ch”
);

113  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

114 
ab¦
::
SŒC©
("UnknowÀaş_grou°ty³: ", 
aş_group
.
ty³
()));

120 
	gStusOr
<
	gboŞ
> 
Ev®u©eAşEx³ù©iÚ
(

121 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

122 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
,

123 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

124 cÚ¡ 
	gEnşaveId’t™y
 &
	gid’t™y
 : 
id’t™›s
) {

125 cÚ¡ 
StusOr
<
boŞ
> 
»suÉ
 = 
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

126 ià(!
	g»suÉ
.
ok
()) {

127  
	g»suÉ
;

130 ià(
	g»suÉ
.
V®ueOrD›
()) {

131  
	gŒue
;

135  
	gçl£
;

140 
	gStusOr
<
	gboŞ
> 
Ev®u©eId’t™yAş
(

141 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

142 cÚ¡ 
Id’t™yAşP»diÿ‹
 &
aş
,

143 cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

144 
	gaş
.
™em_ÿ£
()) {

145 
	gId’t™yAşP»diÿ‹
::
kAşGroup
:

146  
Ev®u©eAşP»diÿ‹Group
(
id’t™›s
, 
aş
.
aş_group
(), 
m©ch”
);

147 
	gId’t™yAşP»diÿ‹
::
kEx³ù©iÚ
:

148  
Ev®u©eAşEx³ù©iÚ
(
id’t™›s
, 
aş
.
ex³ù©iÚ
(), 
m©ch”
);

149 
	gId’t™yAşP»diÿ‹
::
ITEM_NOT_SET
:

150  
Stus
(

151 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

154  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

155 
ab¦
::
SŒC©
("UnknowÀaş i‹m: ", 
aş
.
™em_ÿ£
()));

	@identity/identity_acl_evaluator.h

19 #iâdeà
ASYLO_IDENTITY_IDENTITY_ACL_EVALUATOR_H_


20 
	#ASYLO_IDENTITY_IDENTITY_ACL_EVALUATOR_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/id’t™y_aş.pb.h
"

24 
	~"asylo/id’t™y/id’t™y_ex³ù©iÚ_m©ch”.h
"

25 
	~"asylo/ut/¡©usÜ.h
"

27 
Çme¥aû
 
	gasylo
 {

49 
	gStusOr
<
	gboŞ
> 
Ev®u©eId’t™yAş
(

50 cÚ¡ 
¡d
::
veùÜ
<
EnşaveId’t™y
> &
id’t™›s
,

51 cÚ¡ 
Id’t™yAşP»diÿ‹
 &
aş
, cÚ¡ 
Id’t™yEx³ù©iÚM©ch”
 &
m©ch”
);

	@identity/identity_expectation_matcher.h

19 #iâdeà
ASYLO_IDENTITY_IDENTITY_EXPECTATION_MATCHER_H_


20 
	#ASYLO_IDENTITY_IDENTITY_EXPECTATION_MATCHER_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/ut/¡©usÜ.h
"

25 
Çme¥aû
 
	gasylo
 {

31 şas 
	cId’t™yEx³ù©iÚM©ch”
 {

32 
	gpublic
:

33 
Id’t™yEx³ù©iÚM©ch”
() = ;

34 
	gvœtu®
 ~
Id’t™yEx³ù©iÚM©ch”
() = ;

61 
vœtu®
 
	gStusOr
<
	gboŞ
> 
M©ch
(

62 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

63 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) const = 0;

	@identity/identity_expectation_matcher_test.cc

19 
	~"asylo/id’t™y/id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<¡ršg
>

23 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/d–eg©šg_id’t™y_ex³ù©iÚ_m©ch”.h
"

26 
	~"asylo/id’t™y/id’t™y.pb.h
"

27 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

28 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
	g‹m¶©e
 <
	gC
>

40 
EnşaveId’t™yDesütiÚ
 
MakeDesütiÚ
() {

41 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

42 
	gdesütiÚ
.
£t_id’t™y_ty³
(
UNKNOWN_IDENTITY
);

43 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
¡d
::
¡ršg
(4, 
C
));

44  
	gdesütiÚ
;

49 
	g‹m¶©e
 <
	gC
>

50 
EnşaveId’t™y
 
MakeId’t™y
(
¡d
::
¡ršg
 
id
) {

51 
EnşaveId’t™y
 
id’t™y
;

52 *
	gid’t™y
.
mubË_desütiÚ
(èğ
MakeDesütiÚ
<
C
>();

53 
	gid’t™y
.
£t_id’t™y
(
¡d
::
move
(
id
));

54  
	gid’t™y
;

60 
	g‹m¶©e
 <
	gC
>

61 
EnşaveId’t™yEx³ù©iÚ
 
MakeEx³ù©iÚ
(
¡d
::
¡ršg
 
id
) {

62 
EnşaveId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

63 *
	gex³ù©iÚ
.
mubË_»ã»nû_id’t™y
(èğ
MakeId’t™y
<
C
>(
¡d
::
move
(
id
));

64  
	gex³ù©iÚ
;

71 
	g‹m¶©e
 <
	gC
>

72 şas 
	cTe¡M©ch”
 
	gfš®
 : 
public
 
NamedId’t™yEx³ù©iÚM©ch”
 {

73 
public
:

74 
Te¡M©ch”
() = ;

75 ~
Te¡M©ch”
(è
	gov”ride
 = ;

77 
EnşaveId’t™yDesütiÚ
 
DesütiÚ
(ècÚ¡ 
	gov”ride
 {

78  
	gMakeDesütiÚ
<
	gC
>();

81 
	gStusOr
<
	gboŞ
> 
M©ch
(

82 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

83 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
ècÚ¡ 
	gov”ride
 {

84 ià(!::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
id’t™y
.
desütiÚ
(),

85 
DesütiÚ
()) ||

86 !::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(

87 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
(), 
DesütiÚ
())) {

88  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Incorrect description");

90  
	gid’t™y
.
id’t™y
(è=ğ
ex³ù©iÚ
.
»ã»nû_id’t™y
().identity();

94 
usšg
 
	gTe¡M©ch”A
 = 
Te¡M©ch”
<'A'>;

95 
usšg
 
	gTe¡M©ch”B
 = 
Te¡M©ch”
<'B'>;

98 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

99 
Te¡M©ch”A
);

102 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

103 
Te¡M©ch”B
);

107 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chIfDesütiÚsAndId’t™›sM©ch
) {

108 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

109 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'A'>("foo");

111 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

112 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
IsOkAndHŞds
(
Œue
));

117 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chFasIfId’t™yM©chFas
) {

118 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

119 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'A'>("bar");

121 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

122 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
IsOkAndHŞds
(
çl£
));

128 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chFasIfDesütiÚM©chFas
) {

129 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

130 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'B'>("foo");

132 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

133 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
IsOkAndHŞds
(
çl£
));

139 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chFasIfId’t™yDesütiÚInv®id
) {

140 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'C'>("foo");

141 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'A'>("foo");

143 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

144 
	gStusOr
<
	gboŞ
> 
	gm©ch_»suÉ
 = 
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

146 
EXPECT_THAT
(
m©ch_»suÉ
, 
NÙ
(
IsOk
()));

152 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
,

153 
M©chFasIfEx³ù©iÚDesütiÚInv®id
) {

154 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

155 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'C'>("foo");

157 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

158 
	gStusOr
<
	gboŞ
> 
	gm©ch_»suÉ
 = 
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

160 
EXPECT_THAT
(
m©ch_»suÉ
, 
NÙ
(
IsOk
()));

	@identity/identity_expectation_matcher_test.cc

19 
	~"asylo/id’t™y/id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<¡ršg
>

23 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/d–eg©šg_id’t™y_ex³ù©iÚ_m©ch”.h
"

26 
	~"asylo/id’t™y/id’t™y.pb.h
"

27 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

28 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
	g‹m¶©e
 <
	gC
>

40 
EnşaveId’t™yDesütiÚ
 
MakeDesütiÚ
() {

41 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

42 
	gdesütiÚ
.
£t_id’t™y_ty³
(
UNKNOWN_IDENTITY
);

43 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
¡d
::
¡ršg
(4, 
C
));

44  
	gdesütiÚ
;

49 
	g‹m¶©e
 <
	gC
>

50 
EnşaveId’t™y
 
MakeId’t™y
(
¡d
::
¡ršg
 
id
) {

51 
EnşaveId’t™y
 
id’t™y
;

52 *
	gid’t™y
.
mubË_desütiÚ
(èğ
MakeDesütiÚ
<
C
>();

53 
	gid’t™y
.
£t_id’t™y
(
¡d
::
move
(
id
));

54  
	gid’t™y
;

60 
	g‹m¶©e
 <
	gC
>

61 
EnşaveId’t™yEx³ù©iÚ
 
MakeEx³ù©iÚ
(
¡d
::
¡ršg
 
id
) {

62 
EnşaveId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

63 *
	gex³ù©iÚ
.
mubË_»ã»nû_id’t™y
(èğ
MakeId’t™y
<
C
>(
¡d
::
move
(
id
));

64  
	gex³ù©iÚ
;

71 
	g‹m¶©e
 <
	gC
>

72 şas 
	cTe¡M©ch”
 
	gfš®
 : 
public
 
NamedId’t™yEx³ù©iÚM©ch”
 {

73 
public
:

74 
Te¡M©ch”
() = ;

75 ~
Te¡M©ch”
(è
	gov”ride
 = ;

77 
EnşaveId’t™yDesütiÚ
 
DesütiÚ
(ècÚ¡ 
	gov”ride
 {

78  
	gMakeDesütiÚ
<
	gC
>();

81 
	gStusOr
<
	gboŞ
> 
M©ch
(

82 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

83 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
ècÚ¡ 
	gov”ride
 {

84 ià(!::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
id’t™y
.
desütiÚ
(),

85 
DesütiÚ
()) ||

86 !::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(

87 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
(), 
DesütiÚ
())) {

88  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Incorrect description");

90  
	gid’t™y
.
id’t™y
(è=ğ
ex³ù©iÚ
.
»ã»nû_id’t™y
().identity();

94 
usšg
 
	gTe¡M©ch”A
 = 
Te¡M©ch”
<'A'>;

95 
usšg
 
	gTe¡M©ch”B
 = 
Te¡M©ch”
<'B'>;

98 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

99 
Te¡M©ch”A
);

102 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

103 
Te¡M©ch”B
);

107 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chIfDesütiÚsAndId’t™›sM©ch
) {

108 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

109 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'A'>("foo");

111 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

112 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
IsOkAndHŞds
(
Œue
));

117 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chFasIfId’t™yM©chFas
) {

118 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

119 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'A'>("bar");

121 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

122 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
IsOkAndHŞds
(
çl£
));

128 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chFasIfDesütiÚM©chFas
) {

129 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

130 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'B'>("foo");

132 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

133 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
IsOkAndHŞds
(
çl£
));

139 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
, 
M©chFasIfId’t™yDesütiÚInv®id
) {

140 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'C'>("foo");

141 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'A'>("foo");

143 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

144 
	gStusOr
<
	gboŞ
> 
	gm©ch_»suÉ
 = 
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

146 
EXPECT_THAT
(
m©ch_»suÉ
, 
NÙ
(
IsOk
()));

152 
TEST
(
Id’t™yEx³ù©iÚM©ch”Te¡
,

153 
M©chFasIfEx³ù©iÚDesütiÚInv®id
) {

154 
EnşaveId’t™y
 
	gid’t™y
 = 
MakeId’t™y
<'A'>("foo");

155 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
 = 
MakeEx³ù©iÚ
<'C'>("foo");

157 
D–eg©šgId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

158 
	gStusOr
<
	gboŞ
> 
	gm©ch_»suÉ
 = 
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
);

160 
EXPECT_THAT
(
m©ch_»suÉ
, 
NÙ
(
IsOk
()));

	@identity/init.h

19 #iâdeà
ASYLO_IDENTITY_INIT_H_


20 
	#ASYLO_IDENTITY_INIT_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

26 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

27 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

28 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

29 
	~"asylo/id’t™y/š™_š‹º®.h
"

30 
	~"asylo/ut/¡©us.h
"

32 
Çme¥aû
 
	gasylo
 {

56 
	g‹m¶©e
 <
şass
 
	gCÚfigI‹¿tÜT
>

57 
Stus
 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
CÚfigI‹¿tÜT
 
cÚfigs_begš
,

58 
CÚfigI‹¿tÜT
 
cÚfigs_’d
) {

59 
boŞ
 
	gok
 = 
Œue
;

62 autØ
	g™
 = 
cÚfigs_begš
; iˆ!ğ
cÚfigs_’d
; ++it) {

63 cÚ¡ 
	gEnşaveAs£¹iÚAuthÜ™yCÚfig
 &
	gcÚfig
 = *
™
;

65 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 = 
cÚfig
.
desütiÚ
();

66 
	gStusOr
<
	g¡d
::
¡ršg
> 
authÜ™y_id_»suÉ
 =

67 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

68 
desütiÚ
.
id’t™y_ty³
(), desütiÚ.
authÜ™y_ty³
());

69 ià(!
	gauthÜ™y_id_»suÉ
.
ok
()) {

70 
	gok
 = 
çl£
;

71 
LOG
(
ERROR
è<< 
	gauthÜ™y_id_»suÉ
.
¡©us
();

75 
	g¡d
::
¡ršg
 
authÜ™y_id
 = 
authÜ™y_id_»suÉ
.
V®ueOrD›
();

77 autØ
	gg’”©Ü_™
 = 
As£¹iÚG’”©ÜM­
::
G‘V®ue
(
authÜ™y_id
);

78 ià(
	gg’”©Ü_™
 !ğ
As£¹iÚG’”©ÜM­
::
v®ue_’d
()) {

79 ià(!
š‹º®
::
TryIn™Ÿlize
(
cÚfig
.cÚfig(), 
g’”©Ü_™
).
ok
()) {

80 
ok
 = 
çl£
;

83 
	gok
 = 
çl£
;

84 
LOG
(
WARNING
è<< "CÚfig fÜ " << 
	gdesütiÚ
.
ShÜtDebugSŒšg
()

88 autØ
	gv”if›r_™
 = 
As£¹iÚV”if›rM­
::
G‘V®ue
(
authÜ™y_id
);

89 ià(
	gv”if›r_™
 !ğ
As£¹iÚV”if›rM­
::
v®ue_’d
()) {

90 ià(!
š‹º®
::
TryIn™Ÿlize
(
cÚfig
.cÚfig(), 
v”if›r_™
).
ok
()) {

91 
ok
 = 
çl£
;

94 
	gok
 = 
çl£
;

95 
LOG
(
WARNING
è<< "CÚfig fÜ " << 
	gdesütiÚ
.
ShÜtDebugSŒšg
()

101  
	gok
 ? 
	gStus
::
OkStus
()

102 : 
Stus
(

103 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

	@identity/init_internal.h

19 #iâdeà
ASYLO_IDENTITY_INIT_INTERNAL_H_


20 
	#ASYLO_IDENTITY_INIT_INTERNAL_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/ut/¡©us.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gš‹º®
 {

34 
	g‹m¶©e
 <
şass
 
	gI‹¿tÜT
>

35 
Stus
 
TryIn™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
, 
I‹¿tÜT
 
authÜ™y_™
) {

36 ià(
	gauthÜ™y_™
->
IsIn™Ÿlized
()) {

37  
	gStus
::
OkStus
();

40 
Stus
 
	g¡©us
 = 
authÜ™y_™
->
In™Ÿlize
(
cÚfig
);

41 ià(!
	g¡©us
.
ok
()) {

42 
LOG
(
ERROR
è<< 
	g¡©us
;

45  
	g¡©us
;

	@identity/init_test.cc

19 
	~"asylo/id’t™y/š™.h
"

21 
	~<veùÜ
>

23 
	~<googË/´Ùobuf/‹xt_fÜm©.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

35 
TEST
(
In™Te¡
, 
In™ŸlizeSucûedsW™hEm±yCÚfigs
) {

36 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
;

38 
EXPECT_THAT
(

39 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

40 
IsOk
());

46 
TEST
(
In™Te¡
, 
In™ŸlizeSucûedsW™hCÚfigs
) {

47 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
(1);

49 
ASSERT_TRUE
(

50 
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
("description: { "

55 &
cÚfigs
.
äÚt
()));

57 
EXPECT_THAT
(

58 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

59 
IsOk
());

64 
TEST
(
In™Te¡
, 
In™ŸlizeSucûedsR•—‹dlyAá”Fœ¡Sucûss
) {

65 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
;

67 
EXPECT_THAT
(

68 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

69 
IsOk
());

70 
EXPECT_THAT
(

71 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

72 
IsOk
());

73 
EXPECT_THAT
(

74 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

75 
IsOk
());

80 
TEST
(
In™Te¡
, 
In™ŸlizeFasW™hNÚM©chšgCÚfigs
) {

81 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
(1);

83 
ASSERT_TRUE
(

84 
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
("description: { "

89 &
cÚfigs
.
äÚt
()));

91 
EXPECT_THAT
(

92 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

93 
NÙ
(
IsOk
()));

	@identity/init_test.cc

19 
	~"asylo/id’t™y/š™.h
"

21 
	~<veùÜ
>

23 
	~<googË/´Ùobuf/‹xt_fÜm©.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

35 
TEST
(
In™Te¡
, 
In™ŸlizeSucûedsW™hEm±yCÚfigs
) {

36 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
;

38 
EXPECT_THAT
(

39 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

40 
IsOk
());

46 
TEST
(
In™Te¡
, 
In™ŸlizeSucûedsW™hCÚfigs
) {

47 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
(1);

49 
ASSERT_TRUE
(

50 
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
("description: { "

55 &
cÚfigs
.
äÚt
()));

57 
EXPECT_THAT
(

58 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

59 
IsOk
());

64 
TEST
(
In™Te¡
, 
In™ŸlizeSucûedsR•—‹dlyAá”Fœ¡Sucûss
) {

65 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
;

67 
EXPECT_THAT
(

68 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

69 
IsOk
());

70 
EXPECT_THAT
(

71 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

72 
IsOk
());

73 
EXPECT_THAT
(

74 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

75 
IsOk
());

80 
TEST
(
In™Te¡
, 
In™ŸlizeFasW™hNÚM©chšgCÚfigs
) {

81 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
cÚfigs
(1);

83 
ASSERT_TRUE
(

84 
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
("description: { "

89 &
cÚfigs
.
äÚt
()));

91 
EXPECT_THAT
(

92 
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(
cÚfigs
.
begš
(), cÚfigs.
’d
()),

93 
NÙ
(
IsOk
()));

	@identity/named_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<veùÜ
>

23 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

24 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

29 
	gStusOr
<
	g¡d
::
¡ršg
> 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(

30 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) {

31 
¡d
::
¡ršg
 
id
;

32 
ASYLO_RETURN_IF_ERROR
(
S”ŸlizeBy‹CÚš”s
(

33 &
id
, 
EnşaveId’t™yTy³_Name
(
desütiÚ
.
id’t™y_ty³
()),

34 
desütiÚ
.
authÜ™y_ty³
()));

35  
	gid
;

	@identity/named_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<veùÜ
>

23 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

24 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

29 
	gStusOr
<
	g¡d
::
¡ršg
> 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(

30 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
) {

31 
¡d
::
¡ršg
 
id
;

32 
ASYLO_RETURN_IF_ERROR
(
S”ŸlizeBy‹CÚš”s
(

33 &
id
, 
EnşaveId’t™yTy³_Name
(
desütiÚ
.
id’t™y_ty³
()),

34 
desütiÚ
.
authÜ™y_ty³
()));

35  
	gid
;

	@identity/named_identity_expectation_matcher.h

19 #iâdeà
ASYLO_IDENTITY_NAMED_IDENTITY_EXPECTATION_MATCHER_H_


20 
	#ASYLO_IDENTITY_NAMED_IDENTITY_EXPECTATION_MATCHER_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/id’t™y/id’t™y.pb.h
"

25 
	~"asylo/id’t™y/id’t™y_ex³ù©iÚ_m©ch”.h
"

26 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

37 şas 
	cNamedId’t™yEx³ù©iÚM©ch”
 : 
public
 
Id’t™yEx³ù©iÚM©ch”
 {

38 
public
:

39 
NamedId’t™yEx³ù©iÚM©ch”
() = ;

43 
NamedId’t™yEx³ù©iÚM©ch”
(

44 cÚ¡ 
NamedId’t™yEx³ù©iÚM©ch”
 &
Ùh”
èğ
d–‘e
;

45 
NamedId’t™yEx³ù©iÚM©ch”
(NamedId’t™yEx³ù©iÚM©ch” &&
Ùh”
) =

46 
d–‘e
;

47 
	gNamedId’t™yEx³ù©iÚM©ch”
 &
	gİ”©Ü
=(

48 cÚ¡ 
NamedId’t™yEx³ù©iÚM©ch”
 &
Ùh”
èğ
d–‘e
;

49 
	gNamedId’t™yEx³ù©iÚM©ch”
 &
	gİ”©Ü
=(

50 
NamedId’t™yEx³ù©iÚM©ch”
 &&
Ùh”
èğ
d–‘e
;

56 
vœtu®
 
EnşaveId’t™yDesütiÚ
 
DesütiÚ
() const = 0;

61 
	gStusOr
<
	g¡d
::
¡ršg
> 
G‘M©ch”Name
(

62 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
desütiÚ
);

65 
	g‹m¶©e
 <>

66 
	gNam”
<
	gNamedId’t™yEx³ù©iÚM©ch”
> {

67 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
NamedId’t™yEx³ù©iÚM©ch”
 &
m©ch”
) {

68  
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(

69 
m©ch”
.
DesütiÚ
())

70 .
V®ueOrD›
();

74 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

75 
NamedId’t™yEx³ù©iÚM©ch”
);

	@identity/null_identity/null_assertion_authority_test.cc

19 
	~<¡ršg
>

20 
	~<veùÜ
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/id’t™y/desütiÚs.h
"

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

26 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

27 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

28 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

29 
	~"asylo/id’t™y/id’t™y.pb.h
"

30 
	~"asylo/id’t™y/š™.h
"

31 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_g’”©Ü.h
"

32 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_v”if›r.h
"

33 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

34 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

35 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

48 
Çme¥aû
 
	gasylo
 {

49 
	gÇme¥aû
 {

51 
	gusšg
 ::
‹¡šg
::
NÙ
;

55 cÚ¡ 
	gkEk•CÚ‹xt
[] = "EKEP handshakeranscript‡nd…ublic key";

59 cÚ¡ 
	gkInv®idAuthÜ™yTy³
[] = "SGX Local";

60 cÚ¡ 
	gkInv®idAs£¹iÚOfãrAdd™iÚ®Info
[] = "offer info";

61 cÚ¡ 
	gkInv®idAs£¹iÚReque¡Add™iÚ®Info
[] = "request info";

62 cÚ¡ 
	gkInv®idAs£¹iÚ
[] = "assertion";

67 şas 
	cNuÎAs£¹iÚAuthÜ™yTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

68 
´Ùeùed
:

69 
S‘Up
(è
ov”ride
 {

70 
As£¹iÚDesütiÚ
 
nuÎ_as£¹iÚ_desütiÚ
;

71 
S‘NuÎAs£¹iÚDesütiÚ
(&
nuÎ_as£¹iÚ_desütiÚ
);

75 
	g¡d
::
¡ršg
 
m­_key
 = 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

76 
nuÎ_as£¹iÚ_desütiÚ
.
id’t™y_ty³
(),

77 
nuÎ_as£¹iÚ_desütiÚ
.
authÜ™y_ty³
())

78 .
V®ueOrD›
();

80 autØ
	gg’”©Ü
 = 
As£¹iÚG’”©ÜM­
::
G‘V®ue
(
m­_key
);

81 
ASSERT_NE
(
g’”©Ü
, 
As£¹iÚG’”©ÜM­
::
v®ue_’d
());

83 autØ
	gv”if›r
 = 
As£¹iÚV”if›rM­
::
G‘V®ue
(
m­_key
);

84 
ASSERT_NE
(
v”if›r
, 
As£¹iÚV”if›rM­
::
v®ue_’d
());

86 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
authÜ™y_cÚfigs
 = {

87 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
()

91 
ASSERT_THAT
(
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

92 
authÜ™y_cÚfigs
.
cbegš
(),‡uthÜ™y_cÚfigs.
ûnd
()),

93 
IsOk
());

100 
	gg’”©Ü_
 = &*
g’”©Ü
;

101 
	gv”if›r_
 = &*
v”if›r
;

105 cÚ¡ 
EnşaveAs£¹iÚG’”©Ü
 *
	gg’”©Ü_
;

108 cÚ¡ 
EnşaveAs£¹iÚV”if›r
 *
	gv”if›r_
;

113 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªV”ifySuûedsV”ifyAs£¹iÚOfãr
) {

114 
As£¹iÚOfãr
 
	gofãr
;

115 
ASSERT_THAT
(
g’”©Ü_
->
C»©eAs£¹iÚOfãr
(&
ofãr
), 
IsOk
());

117 
EXPECT_THAT
(
v”if›r_
->
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
Œue
));

122 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªV”ifyFasBadAs£¹iÚOfãr
) {

124 
As£¹iÚOfãr
 
	gofãr
;

125 
	gofãr
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

126 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

127 
	gofãr
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

128 
	gofãr
.
£t_add™iÚ®_šfÜm©iÚ
(
kInv®idAs£¹iÚOfãrAdd™iÚ®Info
);

130 
EXPECT_THAT
(
v”if›r_
->
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
çl£
));

133 
	gofãr
.
CË¬
();

134 
EXPECT_THAT
(
v”if›r_
->
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
çl£
));

139 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªG’”©eSuûedsV®idAs£¹iÚReque¡
) {

140 
As£¹iÚReque¡
 
	g»que¡
;

141 
ASSERT_THAT
(
v”if›r_
->
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

143 
EXPECT_THAT
(
g’”©Ü_
->
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
Œue
));

148 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªG’”©eFasBadAs£¹iÚReque¡
) {

150 
As£¹iÚReque¡
 
	g»que¡
;

151 
	g»que¡
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

152 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

153 
	g»que¡
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

154 
	g»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kInv®idAs£¹iÚReque¡Add™iÚ®Info
);

156 
EXPECT_THAT
(
g’”©Ü_
->
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
çl£
));

159 
	g»que¡
.
CË¬
();

160 
EXPECT_THAT
(
g’”©Ü_
->
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
çl£
));

165 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
G’”©eSuûedsV®idAs£¹iÚReque¡
) {

166 
As£¹iÚReque¡
 
	g»que¡
;

167 
ASSERT_THAT
(
v”if›r_
->
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

169 
As£¹iÚ
 
	gas£¹iÚ
;

170 
EXPECT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
), 
IsOk
());

175 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
G’”©eFasBadAs£¹iÚReque¡
) {

176 
As£¹iÚ
 
	gas£¹iÚ
;

179 
As£¹iÚReque¡
 
	g»que¡
;

180 
	g»que¡
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

181 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

182 
	g»que¡
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

183 
	g»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kInv®idAs£¹iÚReque¡Add™iÚ®Info
);

185 
EXPECT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
),

186 
NÙ
(
IsOk
()));

189 
	g»que¡
.
CË¬
();

190 
EXPECT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
),

191 
NÙ
(
IsOk
()));

196 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifySuûedsV®idAs£¹iÚ
) {

197 
As£¹iÚReque¡
 
	g»que¡
;

198 
ASSERT_THAT
(
v”if›r_
->
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

200 
As£¹iÚ
 
	gas£¹iÚ
;

201 
ASSERT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
), 
IsOk
());

203 
EnşaveId’t™y
 
	g³”_id’t™y
;

204 
ASSERT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, 
as£¹iÚ
, &
³”_id’t™y
),

205 
IsOk
());

206 
EXPECT_EQ
(
³”_id’t™y
.
desütiÚ
().
id’t™y_ty³
(),

207 
EnşaveId’t™yTy³
::
NULL_IDENTITY
);

208 
EXPECT_EQ
(
³”_id’t™y
.
desütiÚ
().
authÜ™y_ty³
(),

209 
kNuÎAuthÜiz©iÚAuthÜ™y
);

210 
EXPECT_EQ
(
³”_id’t™y
.
id’t™y
(), 
kNuÎId’t™y
);

214 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifyFasEm±yAs£¹iÚ
) {

215 
EnşaveId’t™y
 
	g³”_id’t™y
;

218 
EXPECT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, {}, &
³”_id’t™y
), 
NÙ
(
IsOk
()));

223 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifyFasBadAs£¹iÚReque¡
) {

224 
EnşaveId’t™y
 
	g³”_id’t™y
;

227 
As£¹iÚ
 
	gas£¹iÚ
;

228 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

229 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

230 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

231 
EXPECT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, 
as£¹iÚ
, &
³”_id’t™y
),

232 
NÙ
(
IsOk
()));

237 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifyFasBadAs£¹iÚ
) {

238 
EnşaveId’t™y
 
	g³”_id’t™y
;

241 
As£¹iÚ
 
	gas£¹iÚ
;

242 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

243 
EnşaveId’t™yTy³
::
NULL_IDENTITY
);

244 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kNuÎAs£¹iÚAuthÜ™y
);

245 
	gas£¹iÚ
.
£t_as£¹iÚ
(
kInv®idAs£¹iÚ
);

246 
EXPECT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, 
as£¹iÚ
, &
³”_id’t™y
),

247 
NÙ
(
IsOk
()));

	@identity/null_identity/null_assertion_authority_test.cc

19 
	~<¡ršg
>

20 
	~<veùÜ
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/id’t™y/desütiÚs.h
"

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

26 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

27 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

28 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

29 
	~"asylo/id’t™y/id’t™y.pb.h
"

30 
	~"asylo/id’t™y/š™.h
"

31 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_g’”©Ü.h
"

32 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_v”if›r.h
"

33 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

34 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

35 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

48 
Çme¥aû
 
	gasylo
 {

49 
	gÇme¥aû
 {

51 
	gusšg
 ::
‹¡šg
::
NÙ
;

55 cÚ¡ 
	gkEk•CÚ‹xt
[] = "EKEP handshakeranscript‡nd…ublic key";

59 cÚ¡ 
	gkInv®idAuthÜ™yTy³
[] = "SGX Local";

60 cÚ¡ 
	gkInv®idAs£¹iÚOfãrAdd™iÚ®Info
[] = "offer info";

61 cÚ¡ 
	gkInv®idAs£¹iÚReque¡Add™iÚ®Info
[] = "request info";

62 cÚ¡ 
	gkInv®idAs£¹iÚ
[] = "assertion";

67 şas 
	cNuÎAs£¹iÚAuthÜ™yTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

68 
´Ùeùed
:

69 
S‘Up
(è
ov”ride
 {

70 
As£¹iÚDesütiÚ
 
nuÎ_as£¹iÚ_desütiÚ
;

71 
S‘NuÎAs£¹iÚDesütiÚ
(&
nuÎ_as£¹iÚ_desütiÚ
);

75 
	g¡d
::
¡ršg
 
m­_key
 = 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

76 
nuÎ_as£¹iÚ_desütiÚ
.
id’t™y_ty³
(),

77 
nuÎ_as£¹iÚ_desütiÚ
.
authÜ™y_ty³
())

78 .
V®ueOrD›
();

80 autØ
	gg’”©Ü
 = 
As£¹iÚG’”©ÜM­
::
G‘V®ue
(
m­_key
);

81 
ASSERT_NE
(
g’”©Ü
, 
As£¹iÚG’”©ÜM­
::
v®ue_’d
());

83 autØ
	gv”if›r
 = 
As£¹iÚV”if›rM­
::
G‘V®ue
(
m­_key
);

84 
ASSERT_NE
(
v”if›r
, 
As£¹iÚV”if›rM­
::
v®ue_’d
());

86 
	g¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
authÜ™y_cÚfigs
 = {

87 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
()

91 
ASSERT_THAT
(
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

92 
authÜ™y_cÚfigs
.
cbegš
(),‡uthÜ™y_cÚfigs.
ûnd
()),

93 
IsOk
());

100 
	gg’”©Ü_
 = &*
g’”©Ü
;

101 
	gv”if›r_
 = &*
v”if›r
;

105 cÚ¡ 
EnşaveAs£¹iÚG’”©Ü
 *
	gg’”©Ü_
;

108 cÚ¡ 
EnşaveAs£¹iÚV”if›r
 *
	gv”if›r_
;

113 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªV”ifySuûedsV”ifyAs£¹iÚOfãr
) {

114 
As£¹iÚOfãr
 
	gofãr
;

115 
ASSERT_THAT
(
g’”©Ü_
->
C»©eAs£¹iÚOfãr
(&
ofãr
), 
IsOk
());

117 
EXPECT_THAT
(
v”if›r_
->
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
Œue
));

122 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªV”ifyFasBadAs£¹iÚOfãr
) {

124 
As£¹iÚOfãr
 
	gofãr
;

125 
	gofãr
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

126 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

127 
	gofãr
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

128 
	gofãr
.
£t_add™iÚ®_šfÜm©iÚ
(
kInv®idAs£¹iÚOfãrAdd™iÚ®Info
);

130 
EXPECT_THAT
(
v”if›r_
->
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
çl£
));

133 
	gofãr
.
CË¬
();

134 
EXPECT_THAT
(
v”if›r_
->
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
çl£
));

139 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªG’”©eSuûedsV®idAs£¹iÚReque¡
) {

140 
As£¹iÚReque¡
 
	g»que¡
;

141 
ASSERT_THAT
(
v”if›r_
->
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

143 
EXPECT_THAT
(
g’”©Ü_
->
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
Œue
));

148 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
CªG’”©eFasBadAs£¹iÚReque¡
) {

150 
As£¹iÚReque¡
 
	g»que¡
;

151 
	g»que¡
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

152 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

153 
	g»que¡
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

154 
	g»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kInv®idAs£¹iÚReque¡Add™iÚ®Info
);

156 
EXPECT_THAT
(
g’”©Ü_
->
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
çl£
));

159 
	g»que¡
.
CË¬
();

160 
EXPECT_THAT
(
g’”©Ü_
->
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
çl£
));

165 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
G’”©eSuûedsV®idAs£¹iÚReque¡
) {

166 
As£¹iÚReque¡
 
	g»que¡
;

167 
ASSERT_THAT
(
v”if›r_
->
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

169 
As£¹iÚ
 
	gas£¹iÚ
;

170 
EXPECT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
), 
IsOk
());

175 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
G’”©eFasBadAs£¹iÚReque¡
) {

176 
As£¹iÚ
 
	gas£¹iÚ
;

179 
As£¹iÚReque¡
 
	g»que¡
;

180 
	g»que¡
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

181 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

182 
	g»que¡
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

183 
	g»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kInv®idAs£¹iÚReque¡Add™iÚ®Info
);

185 
EXPECT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
),

186 
NÙ
(
IsOk
()));

189 
	g»que¡
.
CË¬
();

190 
EXPECT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
),

191 
NÙ
(
IsOk
()));

196 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifySuûedsV®idAs£¹iÚ
) {

197 
As£¹iÚReque¡
 
	g»que¡
;

198 
ASSERT_THAT
(
v”if›r_
->
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

200 
As£¹iÚ
 
	gas£¹iÚ
;

201 
ASSERT_THAT
(
g’”©Ü_
->
G’”©e
(
kEk•CÚ‹xt
, 
»que¡
, &
as£¹iÚ
), 
IsOk
());

203 
EnşaveId’t™y
 
	g³”_id’t™y
;

204 
ASSERT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, 
as£¹iÚ
, &
³”_id’t™y
),

205 
IsOk
());

206 
EXPECT_EQ
(
³”_id’t™y
.
desütiÚ
().
id’t™y_ty³
(),

207 
EnşaveId’t™yTy³
::
NULL_IDENTITY
);

208 
EXPECT_EQ
(
³”_id’t™y
.
desütiÚ
().
authÜ™y_ty³
(),

209 
kNuÎAuthÜiz©iÚAuthÜ™y
);

210 
EXPECT_EQ
(
³”_id’t™y
.
id’t™y
(), 
kNuÎId’t™y
);

214 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifyFasEm±yAs£¹iÚ
) {

215 
EnşaveId’t™y
 
	g³”_id’t™y
;

218 
EXPECT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, {}, &
³”_id’t™y
), 
NÙ
(
IsOk
()));

223 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifyFasBadAs£¹iÚReque¡
) {

224 
EnşaveId’t™y
 
	g³”_id’t™y
;

227 
As£¹iÚ
 
	gas£¹iÚ
;

228 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

229 
EnşaveId’t™yTy³
::
CODE_IDENTITY
);

230 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kInv®idAuthÜ™yTy³
);

231 
EXPECT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, 
as£¹iÚ
, &
³”_id’t™y
),

232 
NÙ
(
IsOk
()));

237 
TEST_F
(
NuÎAs£¹iÚAuthÜ™yTe¡
, 
V”ifyFasBadAs£¹iÚ
) {

238 
EnşaveId’t™y
 
	g³”_id’t™y
;

241 
As£¹iÚ
 
	gas£¹iÚ
;

242 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(

243 
EnşaveId’t™yTy³
::
NULL_IDENTITY
);

244 
	gas£¹iÚ
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
kNuÎAs£¹iÚAuthÜ™y
);

245 
	gas£¹iÚ
.
£t_as£¹iÚ
(
kInv®idAs£¹iÚ
);

246 
EXPECT_THAT
(
v”if›r_
->
V”ify
(
kEk•CÚ‹xt
, 
as£¹iÚ
, &
³”_id’t™y
),

247 
NÙ
(
IsOk
()));

	@identity/null_identity/null_assertion_generator.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_g’”©Ü.h
"

21 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ.pb.h
"

24 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

25 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

27 
Çme¥aû
 
	gasylo
 {

29 cÚ¡ *cÚ¡ 
	gNuÎAs£¹iÚG’”©Ü
::
authÜ™y_ty³_
 =

30 
kNuÎAs£¹iÚAuthÜ™y
;

32 
	gNuÎAs£¹iÚG’”©Ü
::
NuÎAs£¹iÚG’”©Ü
(è: 
š™Ÿlized_
(
çl£
) {}

34 
Stus
 
NuÎAs£¹iÚG’”©Ü
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

36 ià(
IsIn™Ÿlized
()) {

37  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

41 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

42 
	gš™Ÿlized_
 = 
Œue
;

43  
	gStus
::
OkStus
();

46 
boŞ
 
	gNuÎAs£¹iÚG’”©Ü
::
IsIn™Ÿlized
() const {

47 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

48  
	gš™Ÿlized_
;

51 
EnşaveId’t™yTy³
 
	gNuÎAs£¹iÚG’”©Ü
::
Id’t™yTy³
() const {

52  
id’t™y_ty³_
;

55 
	g¡d
::
¡ršg
 
NuÎAs£¹iÚG’”©Ü
::
AuthÜ™yTy³
() const {

56  
authÜ™y_ty³_
;

59 
Stus
 
	gNuÎAs£¹iÚG’”©Ü
::
C»©eAs£¹iÚOfãr
(

60 
As£¹iÚOfãr
 *
ofãr
) const {

62 ià(!
IsIn™Ÿlized
()) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

68 
	gofãr
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

69 
	gofãr
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

74 
	gofãr
->
£t_add™iÚ®_šfÜm©iÚ
(
kNuÎAs£¹iÚOfãrAdd™iÚ®Info
);

75  
	gStus
::
OkStus
();

78 
	gStusOr
<
	gboŞ
> 
	gNuÎAs£¹iÚG’”©Ü
::
CªG’”©e
(

79 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

81 ià(!
IsIn™Ÿlized
()) {

82  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

85  
IsV®idAs£¹iÚReque¡
(
»que¡
);

88 
Stus
 
	gNuÎAs£¹iÚG’”©Ü
::
G’”©e
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

89 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
,

90 
As£¹iÚ
 *
as£¹iÚ
) const {

92 ià(!
IsIn™Ÿlized
()) {

93  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

100 ià(!
IsV®idAs£¹iÚReque¡
(
»que¡
)) {

101  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

107 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

108 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

116 
NuÎAs£¹iÚ
 
	gnuÎ_as£¹iÚ
;

117 
	gnuÎ_as£¹iÚ
.
£t_u£r_d©a
(
u£r_d©a
);

118 ià(!
	gnuÎ_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
->
mubË_as£¹iÚ
())) {

119  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

122  
	gStus
::
OkStus
();

125 
boŞ
 
	gNuÎAs£¹iÚG’”©Ü
::
IsV®idAs£¹iÚReque¡
(

126 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

129  
IsCom·tibËAs£¹iÚDesütiÚ
(
»que¡
.
desütiÚ
()) &&

130 (
»que¡
.
add™iÚ®_šfÜm©iÚ
() ==

131 
kNuÎAs£¹iÚReque¡Add™iÚ®Info
);

135 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚG’”©ÜM­
,

136 
NuÎAs£¹iÚG’”©Ü
);

	@identity/null_identity/null_assertion_generator.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_g’”©Ü.h
"

21 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ.pb.h
"

24 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

25 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

27 
Çme¥aû
 
	gasylo
 {

29 cÚ¡ *cÚ¡ 
	gNuÎAs£¹iÚG’”©Ü
::
authÜ™y_ty³_
 =

30 
kNuÎAs£¹iÚAuthÜ™y
;

32 
	gNuÎAs£¹iÚG’”©Ü
::
NuÎAs£¹iÚG’”©Ü
(è: 
š™Ÿlized_
(
çl£
) {}

34 
Stus
 
NuÎAs£¹iÚG’”©Ü
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

36 ià(
IsIn™Ÿlized
()) {

37  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

41 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

42 
	gš™Ÿlized_
 = 
Œue
;

43  
	gStus
::
OkStus
();

46 
boŞ
 
	gNuÎAs£¹iÚG’”©Ü
::
IsIn™Ÿlized
() const {

47 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

48  
	gš™Ÿlized_
;

51 
EnşaveId’t™yTy³
 
	gNuÎAs£¹iÚG’”©Ü
::
Id’t™yTy³
() const {

52  
id’t™y_ty³_
;

55 
	g¡d
::
¡ršg
 
NuÎAs£¹iÚG’”©Ü
::
AuthÜ™yTy³
() const {

56  
authÜ™y_ty³_
;

59 
Stus
 
	gNuÎAs£¹iÚG’”©Ü
::
C»©eAs£¹iÚOfãr
(

60 
As£¹iÚOfãr
 *
ofãr
) const {

62 ià(!
IsIn™Ÿlized
()) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

68 
	gofãr
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

69 
	gofãr
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

74 
	gofãr
->
£t_add™iÚ®_šfÜm©iÚ
(
kNuÎAs£¹iÚOfãrAdd™iÚ®Info
);

75  
	gStus
::
OkStus
();

78 
	gStusOr
<
	gboŞ
> 
	gNuÎAs£¹iÚG’”©Ü
::
CªG’”©e
(

79 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

81 ià(!
IsIn™Ÿlized
()) {

82  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

85  
IsV®idAs£¹iÚReque¡
(
»que¡
);

88 
Stus
 
	gNuÎAs£¹iÚG’”©Ü
::
G’”©e
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

89 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
,

90 
As£¹iÚ
 *
as£¹iÚ
) const {

92 ià(!
IsIn™Ÿlized
()) {

93  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

100 ià(!
IsV®idAs£¹iÚReque¡
(
»que¡
)) {

101  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

107 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

108 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

116 
NuÎAs£¹iÚ
 
	gnuÎ_as£¹iÚ
;

117 
	gnuÎ_as£¹iÚ
.
£t_u£r_d©a
(
u£r_d©a
);

118 ià(!
	gnuÎ_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
->
mubË_as£¹iÚ
())) {

119  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

122  
	gStus
::
OkStus
();

125 
boŞ
 
	gNuÎAs£¹iÚG’”©Ü
::
IsV®idAs£¹iÚReque¡
(

126 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

129  
IsCom·tibËAs£¹iÚDesütiÚ
(
»que¡
.
desütiÚ
()) &&

130 (
»que¡
.
add™iÚ®_šfÜm©iÚ
() ==

131 
kNuÎAs£¹iÚReque¡Add™iÚ®Info
);

135 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚG’”©ÜM­
,

136 
NuÎAs£¹iÚG’”©Ü
);

	@identity/null_identity/null_assertion_generator.h

19 #iâdeà
ASYLO_IDENTITY_NULL_IDENTITY_NULL_ASSERTION_GENERATOR_H_


20 
	#ASYLO_IDENTITY_NULL_IDENTITY_NULL_ASSERTION_GENERATOR_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

27 
Çme¥aû
 
	gasylo
 {

35 şas 
	cNuÎAs£¹iÚG’”©Ü
 
	gfš®
 : 
public
 
EnşaveAs£¹iÚG’”©Ü
 {

36 
public
:

40 
NuÎAs£¹iÚG’”©Ü
();

46 
Stus
 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
è
ov”ride
;

48 
boŞ
 
IsIn™Ÿlized
(ècÚ¡ 
	gov”ride
;

50 
EnşaveId’t™yTy³
 
Id’t™yTy³
(ècÚ¡ 
	gov”ride
;

52 
	g¡d
::
¡ršg
 
AuthÜ™yTy³
(ècÚ¡ 
ov”ride
;

58 
Stus
 
C»©eAs£¹iÚOfãr
(
As£¹iÚOfãr
 *
ofãr
ècÚ¡ 
	gov”ride
;

60 
	gStusOr
<
	gboŞ
> 
CªG’”©e
(cÚ¡ 
As£¹iÚReque¡
 &
»que¡
ècÚ¡ 
	gov”ride
;

62 
Stus
 
G’”©e
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
, cÚ¡ 
As£¹iÚReque¡
 &
»que¡
,

63 
As£¹iÚ
 *
as£¹iÚ
ècÚ¡ 
	gov”ride
;

65 
	g´iv©e
:

68 
boŞ
 
IsV®idAs£¹iÚReque¡
(cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const;

71 
boŞ
 
š™Ÿlized_
 
GUARDED_BY
(
š™Ÿlized_mu_
);

74 
mubË
 
	gab¦
::
Mu‹x
 
š™Ÿlized_mu_
;

77 cÚ¡ *cÚ¡ 
	gauthÜ™y_ty³_
;

80 
cÚ¡ex´
 
EnşaveId’t™yTy³
 
	gid’t™y_ty³_
 = 
NULL_IDENTITY
;

	@identity/null_identity/null_assertion_verifier.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_v”if›r.h
"

21 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ.pb.h
"

24 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

25 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

26 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

28 
Çme¥aû
 
	gasylo
 {

30 cÚ¡ *cÚ¡ 
	gNuÎAs£¹iÚV”if›r
::
authÜ™y_ty³_
 =

31 
kNuÎAs£¹iÚAuthÜ™y
;

33 
	gNuÎAs£¹iÚV”if›r
::
NuÎAs£¹iÚV”if›r
(è: 
š™Ÿlized_
(
çl£
) {}

35 
Stus
 
NuÎAs£¹iÚV”if›r
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

37 ià(
IsIn™Ÿlized
()) {

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

42 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

43 
	gš™Ÿlized_
 = 
Œue
;

44  
	gStus
::
OkStus
();

47 
boŞ
 
	gNuÎAs£¹iÚV”if›r
::
IsIn™Ÿlized
() const {

48 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

49  
	gš™Ÿlized_
;

52 
EnşaveId’t™yTy³
 
	gNuÎAs£¹iÚV”if›r
::
Id’t™yTy³
() const {

53  
id’t™y_ty³_
;

56 
	g¡d
::
¡ršg
 
NuÎAs£¹iÚV”if›r
::
AuthÜ™yTy³
() const {

57  
authÜ™y_ty³_
;

60 
Stus
 
	gNuÎAs£¹iÚV”if›r
::
C»©eAs£¹iÚReque¡
(

61 
As£¹iÚReque¡
 *
»que¡
) const {

63 ià(!
IsIn™Ÿlized
()) {

64  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

69 
	g»que¡
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

70 
	g»que¡
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

75 
	g»que¡
->
£t_add™iÚ®_šfÜm©iÚ
(
kNuÎAs£¹iÚReque¡Add™iÚ®Info
);

76  
	gStus
::
OkStus
();

79 
	gStusOr
<
	gboŞ
> 
	gNuÎAs£¹iÚV”if›r
::
CªV”ify
(

80 cÚ¡ 
As£¹iÚOfãr
 &
ofãr
) const {

82 ià(!
IsIn™Ÿlized
()) {

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

88  
IsCom·tibËAs£¹iÚDesütiÚ
(
ofãr
.
desütiÚ
()) &&

89 (
	gofãr
.
add™iÚ®_šfÜm©iÚ
(è=ğ
kNuÎAs£¹iÚOfãrAdd™iÚ®Info
);

92 
Stus
 
	gNuÎAs£¹iÚV”if›r
::
V”ify
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

93 cÚ¡ 
As£¹iÚ
 &
as£¹iÚ
,

94 
EnşaveId’t™y
 *
³”_id’t™y
) const {

96 ià(!
IsIn™Ÿlized
()) {

97  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

102 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
as£¹iÚ
.
desütiÚ
())) {

103  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
NuÎAs£¹iÚ
 
	gnuÎ_as£¹iÚ
;

110 ià(!
	gnuÎ_as£¹iÚ
.
P¬£FromSŒšg
(
as£¹iÚ
.assertion())) {

111  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

114 ià(
	gnuÎ_as£¹iÚ
.
u£r_d©a
() != user_data) {

115  
Stus
(

116 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

128 
S‘NuÎId’t™yDesütiÚ
(
³”_id’t™y
->
mubË_desütiÚ
());

129 
	g³”_id’t™y
->
£t_id’t™y
(
kNuÎId’t™y
);

132  
	gStus
::
OkStus
();

136 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚV”if›rM­
,

137 
NuÎAs£¹iÚV”if›r
);

	@identity/null_identity/null_assertion_verifier.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ_v”if›r.h
"

21 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_as£¹iÚ.pb.h
"

24 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

25 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

26 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

28 
Çme¥aû
 
	gasylo
 {

30 cÚ¡ *cÚ¡ 
	gNuÎAs£¹iÚV”if›r
::
authÜ™y_ty³_
 =

31 
kNuÎAs£¹iÚAuthÜ™y
;

33 
	gNuÎAs£¹iÚV”if›r
::
NuÎAs£¹iÚV”if›r
(è: 
š™Ÿlized_
(
çl£
) {}

35 
Stus
 
NuÎAs£¹iÚV”if›r
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

37 ià(
IsIn™Ÿlized
()) {

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

42 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

43 
	gš™Ÿlized_
 = 
Œue
;

44  
	gStus
::
OkStus
();

47 
boŞ
 
	gNuÎAs£¹iÚV”if›r
::
IsIn™Ÿlized
() const {

48 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

49  
	gš™Ÿlized_
;

52 
EnşaveId’t™yTy³
 
	gNuÎAs£¹iÚV”if›r
::
Id’t™yTy³
() const {

53  
id’t™y_ty³_
;

56 
	g¡d
::
¡ršg
 
NuÎAs£¹iÚV”if›r
::
AuthÜ™yTy³
() const {

57  
authÜ™y_ty³_
;

60 
Stus
 
	gNuÎAs£¹iÚV”if›r
::
C»©eAs£¹iÚReque¡
(

61 
As£¹iÚReque¡
 *
»que¡
) const {

63 ià(!
IsIn™Ÿlized
()) {

64  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

69 
	g»que¡
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

70 
	g»que¡
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

75 
	g»que¡
->
£t_add™iÚ®_šfÜm©iÚ
(
kNuÎAs£¹iÚReque¡Add™iÚ®Info
);

76  
	gStus
::
OkStus
();

79 
	gStusOr
<
	gboŞ
> 
	gNuÎAs£¹iÚV”if›r
::
CªV”ify
(

80 cÚ¡ 
As£¹iÚOfãr
 &
ofãr
) const {

82 ià(!
IsIn™Ÿlized
()) {

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

88  
IsCom·tibËAs£¹iÚDesütiÚ
(
ofãr
.
desütiÚ
()) &&

89 (
	gofãr
.
add™iÚ®_šfÜm©iÚ
(è=ğ
kNuÎAs£¹iÚOfãrAdd™iÚ®Info
);

92 
Stus
 
	gNuÎAs£¹iÚV”if›r
::
V”ify
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

93 cÚ¡ 
As£¹iÚ
 &
as£¹iÚ
,

94 
EnşaveId’t™y
 *
³”_id’t™y
) const {

96 ià(!
IsIn™Ÿlized
()) {

97  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

102 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
as£¹iÚ
.
desütiÚ
())) {

103  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
NuÎAs£¹iÚ
 
	gnuÎ_as£¹iÚ
;

110 ià(!
	gnuÎ_as£¹iÚ
.
P¬£FromSŒšg
(
as£¹iÚ
.assertion())) {

111  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

114 ià(
	gnuÎ_as£¹iÚ
.
u£r_d©a
() != user_data) {

115  
Stus
(

116 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

128 
S‘NuÎId’t™yDesütiÚ
(
³”_id’t™y
->
mubË_desütiÚ
());

129 
	g³”_id’t™y
->
£t_id’t™y
(
kNuÎId’t™y
);

132  
	gStus
::
OkStus
();

136 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚV”if›rM­
,

137 
NuÎAs£¹iÚV”if›r
);

	@identity/null_identity/null_assertion_verifier.h

19 #iâdeà
ASYLO_IDENTITY_NULL_IDENTITY_NULL_ASSERTION_VERIFIER_H_


20 
	#ASYLO_IDENTITY_NULL_IDENTITY_NULL_ASSERTION_VERIFIER_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

25 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

27 
Çme¥aû
 
	gasylo
 {

38 şas 
	cNuÎAs£¹iÚV”if›r
 
	gfš®
 : 
public
 
EnşaveAs£¹iÚV”if›r
 {

39 
public
:

43 
NuÎAs£¹iÚV”if›r
();

49 
Stus
 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
è
ov”ride
;

51 
boŞ
 
IsIn™Ÿlized
(ècÚ¡ 
	gov”ride
;

53 
EnşaveId’t™yTy³
 
Id’t™yTy³
(ècÚ¡ 
	gov”ride
;

55 
	g¡d
::
¡ršg
 
AuthÜ™yTy³
(ècÚ¡ 
ov”ride
;

61 
Stus
 
C»©eAs£¹iÚReque¡
(
As£¹iÚReque¡
 *
»que¡
ècÚ¡ 
	gov”ride
;

63 
	gStusOr
<
	gboŞ
> 
CªV”ify
(cÚ¡ 
As£¹iÚOfãr
 &
ofãr
ècÚ¡ 
	gov”ride
;

65 
Stus
 
V”ify
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
, cÚ¡ 
As£¹iÚ
 &
as£¹iÚ
,

66 
EnşaveId’t™y
 *
³”_id’t™y
ècÚ¡ 
	gov”ride
;

68 
	g´iv©e
:

70 
boŞ
 
š™Ÿlized_
 
GUARDED_BY
(
š™Ÿlized_mu_
);

73 
mubË
 
	gab¦
::
Mu‹x
 
š™Ÿlized_mu_
;

76 cÚ¡ *cÚ¡ 
	gauthÜ™y_ty³_
;

79 
cÚ¡ex´
 
EnşaveId’t™yTy³
 
	gid’t™y_ty³_
 = 
NULL_IDENTITY
;

	@identity/null_identity/null_identity_constants.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

21 
Çme¥aû
 
	gasylo
 {

23 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚAuthÜ™y
 = "Any";

25 cÚ¡ *cÚ¡ 
	gkNuÎAuthÜiz©iÚAuthÜ™y
 = 
kNuÎAs£¹iÚAuthÜ™y
;

27 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚ
 = "EKEP Null Assertion";

29 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚOfãrAdd™iÚ®Info
 =

32 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚReque¡Add™iÚ®Info
 =

35 cÚ¡ *cÚ¡ 
	gkNuÎId’t™y
 = "Null Identity";

	@identity/null_identity/null_identity_constants.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

21 
Çme¥aû
 
	gasylo
 {

23 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚAuthÜ™y
 = "Any";

25 cÚ¡ *cÚ¡ 
	gkNuÎAuthÜiz©iÚAuthÜ™y
 = 
kNuÎAs£¹iÚAuthÜ™y
;

27 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚ
 = "EKEP Null Assertion";

29 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚOfãrAdd™iÚ®Info
 =

32 cÚ¡ *cÚ¡ 
	gkNuÎAs£¹iÚReque¡Add™iÚ®Info
 =

35 cÚ¡ *cÚ¡ 
	gkNuÎId’t™y
 = "Null Identity";

	@identity/null_identity/null_identity_constants.h

19 #iâdeà
ASYLO_IDENTITY_NULL_IDENTITY_NULL_IDENTITY_CONSTANTS_H_


20 
	#ASYLO_IDENTITY_NULL_IDENTITY_NULL_IDENTITY_CONSTANTS_H_


	)

24 
Çme¥aû
 
	gasylo
 {

27 cÚ¡ *cÚ¡ 
kNuÎAs£¹iÚAuthÜ™y
;

30 cÚ¡ *cÚ¡ 
kNuÎAuthÜiz©iÚAuthÜ™y
;

33 cÚ¡ *cÚ¡ 
kNuÎAs£¹iÚ
;

36 cÚ¡ *cÚ¡ 
kNuÎAs£¹iÚOfãrAdd™iÚ®Info
;

39 cÚ¡ *cÚ¡ 
kNuÎAs£¹iÚReque¡Add™iÚ®Info
;

42 cÚ¡ *cÚ¡ 
kNuÎId’t™y
;

	@identity/null_identity/null_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

22 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

24 
Çme¥aû
 
	gasylo
 {

26 
	gStusOr
<
	gboŞ
> 
	gNuÎId’t™yEx³ù©iÚM©ch”
::
M©ch
(

27 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

28 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) const {

31 
EnşaveId’t™yDesütiÚ
 
	g£lf_desütiÚ
 = 
DesütiÚ
();

32 ià(!::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
id’t™y
.
desütiÚ
(),

33 
£lf_desütiÚ
) ||

34 !::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(

35 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
(), 
£lf_desütiÚ
)) {

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

40  
	gid’t™y
.
id’t™y
(è=ğ
ex³ù©iÚ
.
»ã»nû_id’t™y
().identity();

43 
EnşaveId’t™yDesütiÚ
 
	gNuÎId’t™yEx³ù©iÚM©ch”
::
DesütiÚ
() const {

44 
EnşaveId’t™yDesütiÚ
 
desütiÚ
;

45 
S‘NuÎId’t™yDesütiÚ
(&
desütiÚ
);

46  
	gdesütiÚ
;

50 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

51 
NuÎId’t™yEx³ù©iÚM©ch”
);

	@identity/null_identity/null_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

22 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

24 
Çme¥aû
 
	gasylo
 {

26 
	gStusOr
<
	gboŞ
> 
	gNuÎId’t™yEx³ù©iÚM©ch”
::
M©ch
(

27 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

28 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) const {

31 
EnşaveId’t™yDesütiÚ
 
	g£lf_desütiÚ
 = 
DesütiÚ
();

32 ià(!::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
id’t™y
.
desütiÚ
(),

33 
£lf_desütiÚ
) ||

34 !::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(

35 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
(), 
£lf_desütiÚ
)) {

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

40  
	gid’t™y
.
id’t™y
(è=ğ
ex³ù©iÚ
.
»ã»nû_id’t™y
().identity();

43 
EnşaveId’t™yDesütiÚ
 
	gNuÎId’t™yEx³ù©iÚM©ch”
::
DesütiÚ
() const {

44 
EnşaveId’t™yDesütiÚ
 
desütiÚ
;

45 
S‘NuÎId’t™yDesütiÚ
(&
desütiÚ
);

46  
	gdesütiÚ
;

50 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

51 
NuÎId’t™yEx³ù©iÚM©ch”
);

	@identity/null_identity/null_identity_expectation_matcher.h

19 #iâdeà
ASYLO_IDENTITY_NULL_IDENTITY_NULL_IDENTITY_EXPECTATION_MATCHER_H_


20 
	#ASYLO_IDENTITY_NULL_IDENTITY_NULL_IDENTITY_EXPECTATION_MATCHER_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

25 
Çme¥aû
 
	gasylo
 {

29 şas 
	cNuÎId’t™yEx³ù©iÚM©ch”
 
	gfš®


30 : 
public
 
NamedId’t™yEx³ù©iÚM©ch”
 {

31 
public
:

32 
NuÎId’t™yEx³ù©iÚM©ch”
() = ;

33 ~
NuÎId’t™yEx³ù©iÚM©ch”
(è
	gov”ride
 = ;

36 
	gStusOr
<
	gboŞ
> 
M©ch
(

37 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

38 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
ècÚ¡ 
	gov”ride
;

41 
EnşaveId’t™yDesütiÚ
 
DesütiÚ
(ècÚ¡ 
	gov”ride
;

	@identity/null_identity/null_identity_expectation_matcher_test.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

24 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

36 şas 
	cNuÎId’t™yEx³ù©iÚM©ch”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

37 
´Ùeùed
:

38 
NuÎId’t™yEx³ù©iÚM©ch”Te¡
() {

39 
nuÎ_id’t™y_
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
NULL_IDENTITY
);

40 
	gnuÎ_id’t™y_
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(

41 
kNuÎAuthÜiz©iÚAuthÜ™y
);

42 
	gnuÎ_id’t™y_
.
£t_id’t™y
(
kNuÎId’t™y
);

43 *
	gnuÎ_ex³ù©iÚ_
.
mubË_»ã»nû_id’t™y
(èğ
nuÎ_id’t™y_
;

45 
	gnÚ_nuÎ_id’t™y_
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
CODE_IDENTITY
);

46 *
	gnÚ_nuÎ_ex³ù©iÚ_
.
mubË_»ã»nû_id’t™y
(èğ
nÚ_nuÎ_id’t™y_
;

49 
EnşaveId’t™y
 
	gnuÎ_id’t™y_
;

50 
EnşaveId’t™y
 
	gnÚ_nuÎ_id’t™y_
;

51 
EnşaveId’t™yEx³ù©iÚ
 
	gnuÎ_ex³ù©iÚ_
;

52 
EnşaveId’t™yEx³ù©iÚ
 
	gnÚ_nuÎ_ex³ù©iÚ_
;

57 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Exi¡sInSticM­
) {

58 autØ
	gm©ch”_™
 = 
Id’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

59 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(

60 
nuÎ_id’t™y_
.
desütiÚ
())

61 .
V®ueOrD›
());

62 
ASSERT_NE
(
m©ch”_™
, 
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
());

66 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
, 
DesütiÚCÜ»ùÃss
) {

67 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

68 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
id’t™y_ty³
(), 
NULL_IDENTITY
);

69 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
authÜ™y_ty³
(),

70 
kNuÎAuthÜiz©iÚAuthÜ™y
);

74 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
, 
M©chNuÎId’t™yToNuÎEx³ù©iÚ
) {

75 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

76 
EXPECT_THAT
(
m©ch”
.
M©ch
(
nuÎ_id’t™y_
, 
nuÎ_ex³ù©iÚ_
),

77 
IsOkAndHŞds
(
Œue
));

82 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
,

83 
M©chNuÎId’t™yToNÚNuÎEx³ù©iÚ
) {

84 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

85 
ASSERT_THAT
(
m©ch”
.
M©ch
(
nuÎ_id’t™y_
, 
nÚ_nuÎ_ex³ù©iÚ_
),

86 
NÙ
(
IsOk
()));

91 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
,

92 
M©chNÚNuÎId’t™yNuÎEx³ù©iÚ
) {

93 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

94 
EXPECT_THAT
(
m©ch”
.
M©ch
(
nÚ_nuÎ_id’t™y_
, 
nuÎ_ex³ù©iÚ_
),

95 
NÙ
(
IsOk
()));

	@identity/null_identity/null_identity_expectation_matcher_test.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

24 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

36 şas 
	cNuÎId’t™yEx³ù©iÚM©ch”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

37 
´Ùeùed
:

38 
NuÎId’t™yEx³ù©iÚM©ch”Te¡
() {

39 
nuÎ_id’t™y_
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
NULL_IDENTITY
);

40 
	gnuÎ_id’t™y_
.
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(

41 
kNuÎAuthÜiz©iÚAuthÜ™y
);

42 
	gnuÎ_id’t™y_
.
£t_id’t™y
(
kNuÎId’t™y
);

43 *
	gnuÎ_ex³ù©iÚ_
.
mubË_»ã»nû_id’t™y
(èğ
nuÎ_id’t™y_
;

45 
	gnÚ_nuÎ_id’t™y_
.
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
CODE_IDENTITY
);

46 *
	gnÚ_nuÎ_ex³ù©iÚ_
.
mubË_»ã»nû_id’t™y
(èğ
nÚ_nuÎ_id’t™y_
;

49 
EnşaveId’t™y
 
	gnuÎ_id’t™y_
;

50 
EnşaveId’t™y
 
	gnÚ_nuÎ_id’t™y_
;

51 
EnşaveId’t™yEx³ù©iÚ
 
	gnuÎ_ex³ù©iÚ_
;

52 
EnşaveId’t™yEx³ù©iÚ
 
	gnÚ_nuÎ_ex³ù©iÚ_
;

57 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Exi¡sInSticM­
) {

58 autØ
	gm©ch”_™
 = 
Id’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

59 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(

60 
nuÎ_id’t™y_
.
desütiÚ
())

61 .
V®ueOrD›
());

62 
ASSERT_NE
(
m©ch”_™
, 
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
());

66 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
, 
DesütiÚCÜ»ùÃss
) {

67 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

68 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
id’t™y_ty³
(), 
NULL_IDENTITY
);

69 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
authÜ™y_ty³
(),

70 
kNuÎAuthÜiz©iÚAuthÜ™y
);

74 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
, 
M©chNuÎId’t™yToNuÎEx³ù©iÚ
) {

75 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

76 
EXPECT_THAT
(
m©ch”
.
M©ch
(
nuÎ_id’t™y_
, 
nuÎ_ex³ù©iÚ_
),

77 
IsOkAndHŞds
(
Œue
));

82 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
,

83 
M©chNuÎId’t™yToNÚNuÎEx³ù©iÚ
) {

84 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

85 
ASSERT_THAT
(
m©ch”
.
M©ch
(
nuÎ_id’t™y_
, 
nÚ_nuÎ_ex³ù©iÚ_
),

86 
NÙ
(
IsOk
()));

91 
TEST_F
(
NuÎId’t™yEx³ù©iÚM©ch”Te¡
,

92 
M©chNÚNuÎId’t™yNuÎEx³ù©iÚ
) {

93 
NuÎId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

94 
EXPECT_THAT
(
m©ch”
.
M©ch
(
nÚ_nuÎ_id’t™y_
, 
nuÎ_ex³ù©iÚ_
),

95 
NÙ
(
IsOk
()));

	@identity/null_identity/null_identity_util.h

19 #iâdeà
ASYLO_IDENTITY_NULL_IDENTITY_NULL_IDENTITY_UTIL_H_


20 
	#ASYLO_IDENTITY_NULL_IDENTITY_NULL_IDENTITY_UTIL_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

24 
	~"asylo/id’t™y/desütiÚs.h
"

25 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

27 
Çme¥aû
 
	gasylo
 {

30 
šlše
 
boŞ
 
IsNuÎId’t™yDesütiÚ
(

31 cÚ¡ 
EnşaveId’t™yDesütiÚ
 &
id’t™y_desütiÚ
) {

32  
	gid’t™y_desütiÚ
.
id’t™y_ty³
() ==

33 
EnşaveId’t™yTy³
::
NULL_IDENTITY
 &&

34 
id’t™y_desütiÚ
.
authÜ™y_ty³
(è=ğ
kNuÎAuthÜiz©iÚAuthÜ™y
;

38 
šlše
 
S‘NuÎId’t™yEx³ù©iÚ
(

39 
EnşaveId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
) {

40 
S‘NuÎId’t™yDesütiÚ
(

41 
ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
()->
mubË_desütiÚ
());

42 
	gex³ù©iÚ
->
mubË_»ã»nû_id’t™y
()->
£t_id’t™y
(
kNuÎId’t™y
);

45 
	gex³ù©iÚ
->
ş—r_m©ch_¥ec
();

	@identity/null_identity/null_identity_util_test.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/id’t™y/id’t™y.pb.h
"

24 
	~"asylo/id’t™y/desütiÚs.h
"

25 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
TEST
(
NuÎId’t™yUtTe¡
, 
S‘NuÎId’t™yDesütiÚ
) {

31 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

32 
S‘NuÎId’t™yDesütiÚ
(&
desütiÚ
);

34 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
NULL_IDENTITY
);

35 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kNuÎAuthÜiz©iÚAuthÜ™y
);

38 
TEST
(
NuÎId’t™yUtTe¡
, 
S‘NuÎAs£¹iÚDesütiÚ
) {

39 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

40 
S‘NuÎAs£¹iÚDesütiÚ
(&
desütiÚ
);

42 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
NULL_IDENTITY
);

43 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kNuÎAs£¹iÚAuthÜ™y
);

46 
TEST
(
NuÎId’t™yUtTe¡
, 
IsNuÎId’t™yDesütiÚ
) {

47 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

48 
S‘NuÎId’t™yDesütiÚ
(&
desütiÚ
);

49 
EXPECT_TRUE
(
IsNuÎId’t™yDesütiÚ
(
desütiÚ
));

51 
	gdesütiÚ
.
CË¬
();

52 
EXPECT_FALSE
(
IsNuÎId’t™yDesütiÚ
(
desütiÚ
));

55 
TEST
(
NuÎId’t™yUtTe¡
, 
S‘NuÎId’t™yEx³ù©iÚ
) {

56 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

57 
S‘NuÎId’t™yEx³ù©iÚ
(&
ex³ù©iÚ
);

59 
EXPECT_TRUE
(
IsNuÎId’t™yDesütiÚ
(

60 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
()));

61 
EXPECT_EQ
(
ex³ù©iÚ
.
»ã»nû_id’t™y
().
id’t™y
(), 
kNuÎId’t™y
);

62 
EXPECT_EQ
(
ex³ù©iÚ
.
m©ch_¥ec
(), "");

	@identity/null_identity/null_identity_util_test.cc

19 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/id’t™y/id’t™y.pb.h
"

24 
	~"asylo/id’t™y/desütiÚs.h
"

25 
	~"asylo/id’t™y/nuÎ_id’t™y/nuÎ_id’t™y_cÚ¡ªts.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
TEST
(
NuÎId’t™yUtTe¡
, 
S‘NuÎId’t™yDesütiÚ
) {

31 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

32 
S‘NuÎId’t™yDesütiÚ
(&
desütiÚ
);

34 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
NULL_IDENTITY
);

35 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kNuÎAuthÜiz©iÚAuthÜ™y
);

38 
TEST
(
NuÎId’t™yUtTe¡
, 
S‘NuÎAs£¹iÚDesütiÚ
) {

39 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

40 
S‘NuÎAs£¹iÚDesütiÚ
(&
desütiÚ
);

42 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
NULL_IDENTITY
);

43 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kNuÎAs£¹iÚAuthÜ™y
);

46 
TEST
(
NuÎId’t™yUtTe¡
, 
IsNuÎId’t™yDesütiÚ
) {

47 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

48 
S‘NuÎId’t™yDesütiÚ
(&
desütiÚ
);

49 
EXPECT_TRUE
(
IsNuÎId’t™yDesütiÚ
(
desütiÚ
));

51 
	gdesütiÚ
.
CË¬
();

52 
EXPECT_FALSE
(
IsNuÎId’t™yDesütiÚ
(
desütiÚ
));

55 
TEST
(
NuÎId’t™yUtTe¡
, 
S‘NuÎId’t™yEx³ù©iÚ
) {

56 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

57 
S‘NuÎId’t™yEx³ù©iÚ
(&
ex³ù©iÚ
);

59 
EXPECT_TRUE
(
IsNuÎId’t™yDesütiÚ
(

60 
ex³ù©iÚ
.
»ã»nû_id’t™y
().
desütiÚ
()));

61 
EXPECT_EQ
(
ex³ù©iÚ
.
»ã»nû_id’t™y
().
id’t™y
(), 
kNuÎId’t™y
);

62 
EXPECT_EQ
(
ex³ù©iÚ
.
m©ch_¥ec
(), "");

	@identity/secret_sealer.cc

19 
	~"asylo/id’t™y/£ü‘_£®”.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

26 
	~"asylo/ut/¡©us_maüos.h
"

28 
Çme¥aû
 
	gasylo
 {

30 
Stus
 
	gSeü‘S—Ër
::
Re£®
(cÚ¡ 
S—ËdSeü‘
 &
Şd_£®ed_£ü‘
,

31 cÚ¡ 
S—ËdSeü‘H—d”
 &
Ãw_h—d”
,

32 
S—ËdSeü‘
 *
Ãw_£®ed_£ü‘
) {

33 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gun£®ed_£ü‘
;

34 
ASYLO_RETURN_IF_ERROR
(
Un£®
(
Şd_£®ed_£ü‘
, &
un£®ed_£ü‘
));

35  
S—l
(
Ãw_h—d”
, 
Şd_£®ed_£ü‘
.
add™iÚ®_auth’tiÿ‹d_d©a
(),

36 
un£®ed_£ü‘
, 
Ãw_£®ed_£ü‘
);

39 
	gStusOr
<
	g¡d
::
¡ršg
> 
Seü‘S—Ër
::
G’”©eS—ËrId
(
S—lšgRoÙTy³
 
ty³
,

40 cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

41 
¡d
::
¡ršg
 
£rŸlized
;

42 
ASYLO_RETURN_IF_ERROR
(

43 
S”ŸlizeBy‹CÚš”s
(&
£rŸlized
, 
S—lšgRoÙTy³_Name
(
ty³
), 
Çme
));

44  
	g£rŸlized
;

	@identity/secret_sealer.cc

19 
	~"asylo/id’t™y/£ü‘_£®”.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

26 
	~"asylo/ut/¡©us_maüos.h
"

28 
Çme¥aû
 
	gasylo
 {

30 
Stus
 
	gSeü‘S—Ër
::
Re£®
(cÚ¡ 
S—ËdSeü‘
 &
Şd_£®ed_£ü‘
,

31 cÚ¡ 
S—ËdSeü‘H—d”
 &
Ãw_h—d”
,

32 
S—ËdSeü‘
 *
Ãw_£®ed_£ü‘
) {

33 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gun£®ed_£ü‘
;

34 
ASYLO_RETURN_IF_ERROR
(
Un£®
(
Şd_£®ed_£ü‘
, &
un£®ed_£ü‘
));

35  
S—l
(
Ãw_h—d”
, 
Şd_£®ed_£ü‘
.
add™iÚ®_auth’tiÿ‹d_d©a
(),

36 
un£®ed_£ü‘
, 
Ãw_£®ed_£ü‘
);

39 
	gStusOr
<
	g¡d
::
¡ršg
> 
Seü‘S—Ër
::
G’”©eS—ËrId
(
S—lšgRoÙTy³
 
ty³
,

40 cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

41 
¡d
::
¡ršg
 
£rŸlized
;

42 
ASYLO_RETURN_IF_ERROR
(

43 
S”ŸlizeBy‹CÚš”s
(&
£rŸlized
, 
S—lšgRoÙTy³_Name
(
ty³
), 
Çme
));

44  
	g£rŸlized
;

	@identity/secret_sealer.h

19 #iâdeà
ASYLO_IDENTITY_SECRET_SEALER_H_


20 
	#ASYLO_IDENTITY_SECRET_SEALER_H_


	)

22 
	~<c¡dšt
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

27 
	~"asylo/id’t™y/id’t™y.pb.h
"

28 
	~"asylo/id’t™y/£®ed_£ü‘.pb.h
"

29 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

30 
	~"asylo/ut/ş—nsšg_ty³s.h
"

31 
	~"asylo/ut/¡©us.h
"

32 
	~"asylo/ut/¡©usÜ.h
"

34 
Çme¥aû
 
	gasylo
 {

36 şas 
	cSeü‘S—Ër
 {

37 
	gpublic
:

38 
Seü‘S—Ër
() = ;

39 
	gvœtu®
 ~
Seü‘S—Ër
() = ;

44 
vœtu®
 
S—lšgRoÙTy³
 
RoÙTy³
() const = 0;

49 
vœtu®
 
	g¡d
::
¡ršg
 
RoÙName
() const = 0;

54 
vœtu®
 
	g¡d
::
veùÜ
<
EnşaveId’t™yEx³ù©iÚ
> 
RoÙAş
() const = 0;

62 
vœtu®
 
Stus
 
S‘DeçuÉH—d”
(
S—ËdSeü‘H—d”
 *
h—d”
) const = 0;

76 
vœtu®
 
	gStusOr
<
	gsize_t
> 
MaxMes§geSize
(

77 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) const = 0;

92 
vœtu®
 
	gStusOr
<
	gušt64_t
> 
MaxS—ËdMes§ges
(

93 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) const = 0;

108 
vœtu®
 
Stus
 
S—l
(cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
,

109 
By‹CÚš”V›w
 
add™iÚ®_auth’tiÿ‹d_d©a
,

110 
By‹CÚš”V›w
 
£ü‘
,

111 
S—ËdSeü‘
 *
£®ed_£ü‘
) = 0;

118 
vœtu®
 
Stus
 
Un£®
(cÚ¡ 
S—ËdSeü‘
 &
£®ed_£ü‘
,

119 
CËªsšgVeùÜ
<
ušt8_t
> *
£ü‘
) = 0;

132 
vœtu®
 
Stus
 
Re£®
(cÚ¡ 
S—ËdSeü‘
 &
Şd_£®ed_£ü‘
,

133 cÚ¡ 
S—ËdSeü‘H—d”
 &
Ãw_h—d”
,

134 
S—ËdSeü‘
 *
Ãw_£®ed_£ü‘
);

144 
	gStusOr
<
	g¡d
::
¡ršg
> 
G’”©eS—ËrId
(
S—lšgRoÙTy³
 
ty³
,

145 cÚ¡ 
¡d
::
¡ršg
 &
Çme
);

149 
	g‹m¶©e
 <>

150 
	gNam”
<
	gSeü‘S—Ër
> {

151 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
Seü‘S—Ër
 &
£®”
) {

152  
Seü‘S—Ër
::
G’”©eS—ËrId
(
£®”
.
RoÙTy³
(), s—Ër.
RoÙName
())

153 .
V®ueOrD›
();

157 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
Seü‘S—ËrM­
, 
Seü‘S—Ër
)

	@identity/sgx/attributes_util.cc

22 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

24 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

25 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

30 
A‰ribu‹s
 
	gİ”©Ü
&(cÚ¡ 
	gA‰ribu‹s
 &
	glhs
, cÚ¡ A‰ribu‹ &
	grhs
) {

31 
A‰ribu‹s
 
	g»suÉ
;

32 
	g»suÉ
.
£t_æags
(
lhs
.
æags
(è& 
rhs
.flags());

33 
	g»suÉ
.
£t_xäm
(
lhs
.
xäm
(è& 
rhs
.xfrm());

34  
	g»suÉ
;

37 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
A‰ribu‹s
 &
lhs
, cÚ¡ 
	gA‰ribu‹s
 &
	grhs
) {

38  ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
lhs
, 
rhs
);

41 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
A‰ribu‹s
 &
lhs
, cÚ¡ 
	gA‰ribu‹s
 &
	grhs
) {

42  (!(
	glhs
 =ğ
rhs
));

	@identity/sgx/attributes_util.cc

22 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

24 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

25 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

30 
A‰ribu‹s
 
	gİ”©Ü
&(cÚ¡ 
	gA‰ribu‹s
 &
	glhs
, cÚ¡ A‰ribu‹ &
	grhs
) {

31 
A‰ribu‹s
 
	g»suÉ
;

32 
	g»suÉ
.
£t_æags
(
lhs
.
æags
(è& 
rhs
.flags());

33 
	g»suÉ
.
£t_xäm
(
lhs
.
xäm
(è& 
rhs
.xfrm());

34  
	g»suÉ
;

37 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
A‰ribu‹s
 &
lhs
, cÚ¡ 
	gA‰ribu‹s
 &
	grhs
) {

38  ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
lhs
, 
rhs
);

41 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
A‰ribu‹s
 &
lhs
, cÚ¡ 
	gA‰ribu‹s
 &
	grhs
) {

42  (!(
	glhs
 =ğ
rhs
));

	@identity/sgx/attributes_util.h

19 #iâdeà
ASYLO_IDENTITY_SGX_ATTRIBUTES_UTIL_H_


20 
	#ASYLO_IDENTITY_SGX_ATTRIBUTES_UTIL_H_


	)

22 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsgx
 {

31 
A‰ribu‹s
 
	gİ”©Ü
&(cÚ¡ 
	gA‰ribu‹s
 &
	glhs
, cÚ¡ A‰ribu‹ &
	grhs
);

37 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
A‰ribu‹s
 &
lhs
, cÚ¡ 
	gA‰ribu‹s
 &
	grhs
);

43 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
A‰ribu‹s
 &
lhs
, cÚ¡ 
	gA‰ribu‹s
 &
	grhs
);

	@identity/sgx/attributes_util_test.cc

19 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsgx
 {

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
ušt64_t
 
	gkCÚ¡V®1
 = 0x12345678;

29 
cÚ¡ex´
 
ušt64_t
 
	gkCÚ¡V®2
 = 0x87654321;

30 
cÚ¡ex´
 
ušt64_t
 
	gkZ”o
 = 0x0;

34 şas 
	cA‰ribu‹sTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

35 
´Ùeùed
:

38 
TEST_F
(
A‰ribu‹sTe¡
, 
Equ®™yO³¿tÜPos™ive
) {

39 
A‰ribu‹s
 
	gËá
, 
	gright
;

40 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

41 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

42 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

43 
	gright
.
£t_æags
(
kCÚ¡V®2
);

44 
EXPECT_TRUE
(
Ëá
 =ğ
right
);

47 
TEST_F
(
A‰ribu‹sTe¡
, 
Equ®™yO³¿tÜNeg©ive
) {

48 
A‰ribu‹s
 
	gËá
, 
	gright
;

49 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

50 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

51 
EXPECT_FALSE
(
Ëá
 =ğ
right
);

54 
TEST_F
(
A‰ribu‹sTe¡
, 
IÃqu®™yO³¿tÜNeg©ive
) {

55 
A‰ribu‹s
 
	gËá
, 
	gright
;

56 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

57 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

58 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

59 
	gright
.
£t_æags
(
kCÚ¡V®2
);

60 
EXPECT_FALSE
(
Ëá
 !ğ
right
);

63 
TEST_F
(
A‰ribu‹sTe¡
, 
IÃqu®™yO³¿tÜPos™ive
) {

64 
A‰ribu‹s
 
	gËá
, 
	gright
;

65 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

66 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

67 
EXPECT_TRUE
(
Ëá
 !ğ
right
);

70 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss1
) {

71 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

72 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

73 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

74 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

77 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss2
) {

78 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

79 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

80 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

81 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

82 
	gright
.
£t_æags
(
kCÚ¡V®2
);

83 
	g»suÉ
.
£t_xäm
(
kCÚ¡V®1
);

84 
	g»suÉ
.
£t_æags
(
kCÚ¡V®2
);

85 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

88 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss3
) {

89 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

90 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

91 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

92 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

93 
	g»suÉ
.
£t_xäm
(
kCÚ¡V®1
);

94 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

97 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss4
) {

98 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

99 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

100 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

101 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

104 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss5
) {

105 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

106 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

107 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

110 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss6
) {

111 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

112 
	gËá
.
£t_æags
(
kZ”o
);

113 
	gright
.
£t_xäm
(
kZ”o
);

114 
	g»suÉ
.
£t_xäm
(
kZ”o
);

115 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

	@identity/sgx/attributes_util_test.cc

19 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsgx
 {

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
ušt64_t
 
	gkCÚ¡V®1
 = 0x12345678;

29 
cÚ¡ex´
 
ušt64_t
 
	gkCÚ¡V®2
 = 0x87654321;

30 
cÚ¡ex´
 
ušt64_t
 
	gkZ”o
 = 0x0;

34 şas 
	cA‰ribu‹sTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

35 
´Ùeùed
:

38 
TEST_F
(
A‰ribu‹sTe¡
, 
Equ®™yO³¿tÜPos™ive
) {

39 
A‰ribu‹s
 
	gËá
, 
	gright
;

40 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

41 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

42 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

43 
	gright
.
£t_æags
(
kCÚ¡V®2
);

44 
EXPECT_TRUE
(
Ëá
 =ğ
right
);

47 
TEST_F
(
A‰ribu‹sTe¡
, 
Equ®™yO³¿tÜNeg©ive
) {

48 
A‰ribu‹s
 
	gËá
, 
	gright
;

49 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

50 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

51 
EXPECT_FALSE
(
Ëá
 =ğ
right
);

54 
TEST_F
(
A‰ribu‹sTe¡
, 
IÃqu®™yO³¿tÜNeg©ive
) {

55 
A‰ribu‹s
 
	gËá
, 
	gright
;

56 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

57 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

58 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

59 
	gright
.
£t_æags
(
kCÚ¡V®2
);

60 
EXPECT_FALSE
(
Ëá
 !ğ
right
);

63 
TEST_F
(
A‰ribu‹sTe¡
, 
IÃqu®™yO³¿tÜPos™ive
) {

64 
A‰ribu‹s
 
	gËá
, 
	gright
;

65 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

66 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

67 
EXPECT_TRUE
(
Ëá
 !ğ
right
);

70 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss1
) {

71 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

72 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

73 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

74 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

77 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss2
) {

78 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

79 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

80 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

81 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

82 
	gright
.
£t_æags
(
kCÚ¡V®2
);

83 
	g»suÉ
.
£t_xäm
(
kCÚ¡V®1
);

84 
	g»suÉ
.
£t_æags
(
kCÚ¡V®2
);

85 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

88 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss3
) {

89 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

90 
	gËá
.
£t_xäm
(
kCÚ¡V®1
);

91 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

92 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

93 
	g»suÉ
.
£t_xäm
(
kCÚ¡V®1
);

94 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

97 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss4
) {

98 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

99 
	gËá
.
£t_æags
(
kCÚ¡V®2
);

100 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

101 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

104 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss5
) {

105 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

106 
	gright
.
£t_xäm
(
kCÚ¡V®1
);

107 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

110 
TEST_F
(
A‰ribu‹sTe¡
, 
B™wi£AndCÜ»ùÃss6
) {

111 
A‰ribu‹s
 
	gËá
, 
	gright
, 
	g»suÉ
;

112 
	gËá
.
£t_æags
(
kZ”o
);

113 
	gright
.
£t_xäm
(
kZ”o
);

114 
	g»suÉ
.
£t_xäm
(
kZ”o
);

115 
EXPECT_TRUE
((
Ëá
 & 
right
è=ğ
»suÉ
);

	@identity/sgx/code_identity_constants.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	gsgx
 {

24 cÚ¡ *cÚ¡ 
	gkSgxLoÿlAs£¹iÚAuthÜ™y
 = "SGX Local";

26 cÚ¡ *cÚ¡ 
	gkSgxRemÙeAs£¹iÚAuthÜ™y
 = "SGX Remote";

28 cÚ¡ *cÚ¡ 
	gkSgxAuthÜiz©iÚAuthÜ™y
 = "SGX";

	@identity/sgx/code_identity_constants.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	gsgx
 {

24 cÚ¡ *cÚ¡ 
	gkSgxLoÿlAs£¹iÚAuthÜ™y
 = "SGX Local";

26 cÚ¡ *cÚ¡ 
	gkSgxRemÙeAs£¹iÚAuthÜ™y
 = "SGX Remote";

28 cÚ¡ *cÚ¡ 
	gkSgxAuthÜiz©iÚAuthÜ™y
 = "SGX";

	@identity/sgx/code_identity_constants.h

19 #iâdeà
ASYLO_IDENTITY_SGX_CODE_IDENTITY_CONSTANTS_H_


20 
	#ASYLO_IDENTITY_SGX_CODE_IDENTITY_CONSTANTS_H_


	)

22 
Çme¥aû
 
	gasylo
 {

23 
Çme¥aû
 
	gsgx
 {

26 cÚ¡ *cÚ¡ 
kSgxLoÿlAs£¹iÚAuthÜ™y
;

29 cÚ¡ *cÚ¡ 
kSgxRemÙeAs£¹iÚAuthÜ™y
;

32 cÚ¡ *cÚ¡ 
kSgxAuthÜiz©iÚAuthÜ™y
;

	@identity/sgx/code_identity_test_util.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_‹¡_ut.h
"

21 
	~"asylo/üy±o/ut/by‹s.h
"

22 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

23 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

24 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

25 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

26 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

31 
	gÇme¥aû
 {

33 
cÚ¡ex´
 
	gkInv®idAuthÜ™yTy³
[] = "INVALID_AUTHORITY";

34 
cÚ¡ex´
 
	gkInv®idSŒšg
[] = "Invalid String";

37 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

38 cÚ¡ 
T
 
RªdomS–eù
(cÚ¡ 
¡d
::
veùÜ
<T> &
choiûs
) {

39 
size_t
 
¿nd_v®
 = 
TrivŸlRªdomObjeù
<size_t>();

40 ià(
	gchoiûs
.
em±y
()) {

41 
LOG
(
FATAL
) << "Choices must have‡‚on-zero size";

43  
	gchoiûs
[
¿nd_v®
 % 
choiûs
.
size
()];

47 
boŞ
 
ShouldFuzzF›ld
(
³rûÁ
) {

49 
ušt64_t
 
	g¿nd
 = 
TrivŸlRªdomObjeù
<uint64_t>();

50 
	g¿nd
 %= 100;

51  
	g¿nd
 < 
	g³rûÁ
;

55 
	g‹m¶©e
 <
ty³Çme
 
	gPrÙoT
,y³Çm
	gF›ldT
>

56 
usšg
 
	gPrÙoF›ldS‘‹r
 = (
PrÙoT
::*)(
F›ldT
);

60 
	g‹m¶©e
 <
ty³Çme
 
	gPrÙoT
,y³Çm
	gF›ldT
>

61 
FuzzF›ld
(
³rûÁ
, 
PrÙoF›ldS‘‹r
<
PrÙoT
, 
F›ldT
> 
£t_f›ld
,

62 
PrÙoT
 *
mes§ge
) {

63 ià(
ShouldFuzzF›ld
(
³rûÁ
)) {

64 (
	gmes§ge
->*
	g£t_f›ld
)(
	gTrivŸlRªdomObjeù
<
	gF›ldT
>());

68 
	g‹m¶©e
 <
ty³Çme
 
	gPrÙoT
>

69 
FuzzF›ld
(
³rûÁ
, 
PrÙoF›ldS‘‹r
<
PrÙoT
, 
boŞ
> 
£t_f›ld
,

70 
PrÙoT
 *
mes§ge
) {

74 ià(
ShouldFuzzF›ld
(
³rûÁ
)) {

75 ià(
	gTrivŸlRªdomObjeù
<
	gušt8_t
>() & 0x1) {

76 (
	gmes§ge
->*
	g£t_f›ld
)(
	gŒue
);

78 (
	gmes§ge
->*
	g£t_f›ld
)(
	gçl£
);

85 
A‰ribu‹s
 
G‘RªdomA‰ribu‹s
(
³rûÁ
 = 100) {

86 
A‰ribu‹s
 
©Œibu‹s
;

87 
FuzzF›ld
(
³rûÁ
, &
A‰ribu‹s
::
£t_æags
, &
©Œibu‹s
);

88 
FuzzF›ld
(
³rûÁ
, &
A‰ribu‹s
::
£t_xäm
, &
©Œibu‹s
);

89  
	g©Œibu‹s
;

94 
CodeId’t™yM©chS³c
 
G‘RªdomM©chS³c
(
³rûÁ
 = 100) {

95 
CodeId’t™yM©chS³c
 
¥ec
;

96 
FuzzF›ld
(
³rûÁ
, &
CodeId’t™yM©chS³c
::
£t_is_m»nşave_m©ch_»quœed
,

97 &
¥ec
);

98 
FuzzF›ld
(
³rûÁ
, &
CodeId’t™yM©chS³c
::
£t_is_mrsigÃr_m©ch_»quœed
,

99 &
¥ec
);

100 
FuzzF›ld
(
³rûÁ
, &
CodeId’t™yM©chS³c
::
£t_misc£Ëù_m©ch_mask
, &
¥ec
);

101 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
G‘RªdomA‰ribu‹s
(
³rûÁ
);

102  
	g¥ec
;

107 
CodeId’t™y
 
G‘RªdomV®idCodeId’t™yW™hCÚ¡¿šts
(

108 cÚ¡ 
¡d
::
veùÜ
<
boŞ
> &
m»nşave_cÚ¡¿št
,

109 cÚ¡ 
¡d
::
veùÜ
<
boŞ
> &
mrsigÃr_cÚ¡¿št
) {

110 
CodeId’t™y
 
id
;

111 ià(
RªdomS–eù
(
m»nşave_cÚ¡¿št
)) {

112 autØ
	ghash
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

113 
	gid
.
mubË_m»nşave
()->
£t_hash
(
hash
.
d©a
(), hash.
size
());

116 ià(
RªdomS–eù
(
mrsigÃr_cÚ¡¿št
)) {

117 autØ
	ghash
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

118 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
mubË_mrsigÃr
()->
£t_hash
(

119 
hash
.
d©a
(), hash.
size
());

121 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isv´odid
(

122 
TrivŸlRªdomObjeù
<
ušt16_t
>());

123 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isvsvn
(

124 
TrivŸlRªdomObjeù
<
ušt16_t
>());

125 *
	gid
.
mubË_©Œibu‹s
(èğ
G‘RªdomA‰ribu‹s
();

126 
	gid
.
£t_misc£Ëù
(
TrivŸlRªdomObjeù
<
ušt32_t
>());

127  
	gid
;

130 
CodeId’t™y
 
G‘RªdomV®idCodeId’t™y
() {

131 
	g¡d
::
veùÜ
<
boŞ
> 
mr_£ËùiÚ_choiûs
{
Œue
, 
	gçl£
};

132  
G‘RªdomV®idCodeId’t™yW™hCÚ¡¿šts
(
mr_£ËùiÚ_choiûs
,

133 
mr_£ËùiÚ_choiûs
);

136 
CodeId’t™yM©chS³c
 
G‘RªdomV®idM©chS³c
() {

138  
G‘RªdomM©chS³c
();

141 
CodeId’t™yEx³ù©iÚ
 
G‘RªdomV®idEx³ù©iÚ
() {

142 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

143 *
	gex³ù©iÚ
.
mubË_m©ch_¥ec
(èğ
G‘RªdomV®idM©chS³c
();

144 
	g¡d
::
veùÜ
<
boŞ
> 
m»nşave_cÚ¡¿št
{

145 
ex³ù©iÚ
.
m©ch_¥ec
().
is_m»nşave_m©ch_»quœed
()};

146 
	g¡d
::
veùÜ
<
boŞ
> 
mrsigÃr_cÚ¡¿št
{

147 
ex³ù©iÚ
.
m©ch_¥ec
().
is_mrsigÃr_m©ch_»quœed
()};

148 *
	gex³ù©iÚ
.
mubË_»ã»nû_id’t™y
() =

149 
G‘RªdomV®idCodeId’t™yW™hCÚ¡¿šts
(
m»nşave_cÚ¡¿št
,

150 
mrsigÃr_cÚ¡¿št
);

151  
	gex³ù©iÚ
;

154 
S‘RªdomV®idG’”icId’t™y
(
EnşaveId’t™y
 *
g’”ic_id’t™y
,

155 
CodeId’t™y
 *
cÜ»¥Údšg_sgx_id’t™y
) {

156 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
CODE_IDENTITY
);

158 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(

159 
kSgxAuthÜiz©iÚAuthÜ™y
);

161 
CodeId’t™y
 
	gsgx_id’t™y
 = 
G‘RªdomV®idCodeId’t™y
();

162 
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(
g’”ic_id’t™y
->
mubË_id’t™y
());

163 *
	gcÜ»¥Údšg_sgx_id’t™y
 = 
sgx_id’t™y
;

166 
S‘RªdomInv®idG’”icId’t™y
(
EnşaveId’t™y
 *
g’”ic_id’t™y
) {

167 
boŞ
 
	gis_v®id
;

169 
	gis_v®id
 = 
Œue
;

170 
	g¡d
::
veùÜ
<
EnşaveId’t™yTy³
> 
id’t™y_ty³s
{

171 
UNKNOWN_IDENTITY
, 
	gNULL_IDENTITY
, 
	gCODE_IDENTITY
, 
	gCERT_IDENTITY
};

172 
EnşaveId’t™yTy³
 
	gid’t™y_ty³
 = 
RªdomS–eù
(
id’t™y_ty³s
);

173 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
id’t™y_ty³
);

174 
	gis_v®id
 &ğ(
id’t™y_ty³
 =ğ
CODE_IDENTITY
);

176 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
authÜ™y_ty³s
{
kSgxAuthÜiz©iÚAuthÜ™y
,

177 
	gkInv®idAuthÜ™yTy³
};

178 
	g¡d
::
¡ršg
 
authÜ™y_ty³
 = 
RªdomS–eù
(
authÜ™y_ty³s
);

179 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
authÜ™y_ty³
);

180 
	gis_v®id
 &ğ(
authÜ™y_ty³
 =ğ
kSgxAuthÜiz©iÚAuthÜ™y
);

182 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
id’t™y_¡ršgs
(3);

183 
CodeId’t™y
 
	gsgx_id’t™y
;

187 
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(&
id’t™y_¡ršgs
[0]);

191 
	gid’t™y_¡ršgs
[1] = 
kInv®idSŒšg
;

192 
	gsgx_id’t™y
 = 
G‘RªdomV®idCodeId’t™y
();

195 
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(&
id’t™y_¡ršgs
[2]);

196 
	g¡d
::
¡ršg
 
id’t™y_¡ršg
 = 
RªdomS–eù
(
id’t™y_¡ršgs
);

197 
	gg’”ic_id’t™y
->
£t_id’t™y
(
id’t™y_¡ršg
);

198 
	gis_v®id
 &ğ(
id’t™y_¡ršg
 =ğ
id’t™y_¡ršgs
[2]);

199 } 
	gis_v®id
);

202 
S‘RªdomV®idG’”icM©chS³c
(

203 
¡d
::
¡ršg
 *
g’”ic_¥ec
, 
CodeId’t™yM©chS³c
 *
cÜ»¥Údšg_sgx_¥ec
) {

204 
CodeId’t™yM©chS³c
 
	g¥ec
 = 
G‘RªdomV®idM©chS³c
();

205 
	g¥ec
.
S”ŸlizeToSŒšg
(
g’”ic_¥ec
);

206 *
	gcÜ»¥Údšg_sgx_¥ec
 = 
¥ec
;

209 
Stus
 
S‘RªdomInv®idG’”icM©chS³c
(
¡d
::
¡ršg
 *
g’”ic_¥ec
) {

210 
CodeId’t™yM©chS³c
 
¥ec
;

211 
	gcouÁ
 = 0;

213 
	g¥ec
.
CË¬
();

214 
	g¥ec
 = 
G‘RªdomM©chS³c
( 70);

219 ià(
	gcouÁ
 >= 100) {

220  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Exceeded max‡ttempts");

222 
	gcouÁ
++;

223 } 
IsV®idM©chS³c
(
¥ec
));

224 
	g¥ec
.
S”ŸlizeToSŒšg
(
g’”ic_¥ec
);

225  
	gStus
::
OkStus
();

228 
Stus
 
S‘RªdomV®idG’”icEx³ù©iÚ
(

229 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
,

230 
CodeId’t™yEx³ù©iÚ
 *
cÜ»¥Údšg_sgx_ex³ù©iÚ
) {

231 
CodeId’t™y
 
	gsgx_id’t™y
;

232 
CodeId’t™yM©chS³c
 
	gsgx_¥ec
;

233 
	gcouÁ
 = 0;

236 
S‘RªdomV®idG’”icId’t™y
(

237 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
(), &
sgx_id’t™y
);

239 
S‘RªdomV®idG’”icM©chS³c
(
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
(),

240 &
sgx_¥ec
);

242 ià(
	gcouÁ
 >= 100) {

243  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Exceeded max‡ttempts");

245 
	gcouÁ
++;

247 !
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
sgx_id’t™y
, 
sgx_¥ec
));

249 
S‘Ex³ù©iÚ
(
sgx_¥ec
, 
sgx_id’t™y
, 
cÜ»¥Údšg_sgx_ex³ù©iÚ
);

250  
	gStus
::
OkStus
();

253 
Stus
 
S‘RªdomInv®idG’”icEx³ù©iÚ
(

254 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
) {

255 
CodeId’t™y
 
	gsgx_id’t™y
;

256 
CodeId’t™yM©chS³c
 
	gsgx_¥ec
;

257 
	g¡d
::
veùÜ
<
boŞ
> 
v®id™y_choiûs
{
Œue
, 
	gçl£
};

258 
boŞ
 
	gid’t™y_ªd_¥ec_¬e_v®id
 = 
Œue
;

259 
	gcouÁ
 = 0;

261 ià(
RªdomS–eù
(
v®id™y_choiûs
)) {

262 
S‘RªdomV®idG’”icId’t™y
(

263 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
(), &
sgx_id’t™y
);

265 
S‘RªdomInv®idG’”icId’t™y
(

266 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
());

267 
	gid’t™y_ªd_¥ec_¬e_v®id
 = 
çl£
;

269 ià(
RªdomS–eù
(
v®id™y_choiûs
)) {

270 
S‘RªdomV®idG’”icM©chS³c
(
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
(),

271 &
sgx_¥ec
);

273 
ASYLO_RETURN_IF_ERROR
(
S‘RªdomInv®idG’”icM©chS³c
(

274 
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
()));

275 
	gid’t™y_ªd_¥ec_¬e_v®id
 = 
çl£
;

277 ià(
	gcouÁ
 >= 100) {

278  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Exceeded max‡ttempts");

280 
	gcouÁ
++;

281 } 
	gid’t™y_ªd_¥ec_¬e_v®id
 &&

282 
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
sgx_id’t™y
, 
sgx_¥ec
));

283  
	gStus
::
OkStus
();

	@identity/sgx/code_identity_test_util.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_‹¡_ut.h
"

21 
	~"asylo/üy±o/ut/by‹s.h
"

22 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

23 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

24 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

25 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

26 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

31 
	gÇme¥aû
 {

33 
cÚ¡ex´
 
	gkInv®idAuthÜ™yTy³
[] = "INVALID_AUTHORITY";

34 
cÚ¡ex´
 
	gkInv®idSŒšg
[] = "Invalid String";

37 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

38 cÚ¡ 
T
 
RªdomS–eù
(cÚ¡ 
¡d
::
veùÜ
<T> &
choiûs
) {

39 
size_t
 
¿nd_v®
 = 
TrivŸlRªdomObjeù
<size_t>();

40 ià(
	gchoiûs
.
em±y
()) {

41 
LOG
(
FATAL
) << "Choices must have‡‚on-zero size";

43  
	gchoiûs
[
¿nd_v®
 % 
choiûs
.
size
()];

47 
boŞ
 
ShouldFuzzF›ld
(
³rûÁ
) {

49 
ušt64_t
 
	g¿nd
 = 
TrivŸlRªdomObjeù
<uint64_t>();

50 
	g¿nd
 %= 100;

51  
	g¿nd
 < 
	g³rûÁ
;

55 
	g‹m¶©e
 <
ty³Çme
 
	gPrÙoT
,y³Çm
	gF›ldT
>

56 
usšg
 
	gPrÙoF›ldS‘‹r
 = (
PrÙoT
::*)(
F›ldT
);

60 
	g‹m¶©e
 <
ty³Çme
 
	gPrÙoT
,y³Çm
	gF›ldT
>

61 
FuzzF›ld
(
³rûÁ
, 
PrÙoF›ldS‘‹r
<
PrÙoT
, 
F›ldT
> 
£t_f›ld
,

62 
PrÙoT
 *
mes§ge
) {

63 ià(
ShouldFuzzF›ld
(
³rûÁ
)) {

64 (
	gmes§ge
->*
	g£t_f›ld
)(
	gTrivŸlRªdomObjeù
<
	gF›ldT
>());

68 
	g‹m¶©e
 <
ty³Çme
 
	gPrÙoT
>

69 
FuzzF›ld
(
³rûÁ
, 
PrÙoF›ldS‘‹r
<
PrÙoT
, 
boŞ
> 
£t_f›ld
,

70 
PrÙoT
 *
mes§ge
) {

74 ià(
ShouldFuzzF›ld
(
³rûÁ
)) {

75 ià(
	gTrivŸlRªdomObjeù
<
	gušt8_t
>() & 0x1) {

76 (
	gmes§ge
->*
	g£t_f›ld
)(
	gŒue
);

78 (
	gmes§ge
->*
	g£t_f›ld
)(
	gçl£
);

85 
A‰ribu‹s
 
G‘RªdomA‰ribu‹s
(
³rûÁ
 = 100) {

86 
A‰ribu‹s
 
©Œibu‹s
;

87 
FuzzF›ld
(
³rûÁ
, &
A‰ribu‹s
::
£t_æags
, &
©Œibu‹s
);

88 
FuzzF›ld
(
³rûÁ
, &
A‰ribu‹s
::
£t_xäm
, &
©Œibu‹s
);

89  
	g©Œibu‹s
;

94 
CodeId’t™yM©chS³c
 
G‘RªdomM©chS³c
(
³rûÁ
 = 100) {

95 
CodeId’t™yM©chS³c
 
¥ec
;

96 
FuzzF›ld
(
³rûÁ
, &
CodeId’t™yM©chS³c
::
£t_is_m»nşave_m©ch_»quœed
,

97 &
¥ec
);

98 
FuzzF›ld
(
³rûÁ
, &
CodeId’t™yM©chS³c
::
£t_is_mrsigÃr_m©ch_»quœed
,

99 &
¥ec
);

100 
FuzzF›ld
(
³rûÁ
, &
CodeId’t™yM©chS³c
::
£t_misc£Ëù_m©ch_mask
, &
¥ec
);

101 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
G‘RªdomA‰ribu‹s
(
³rûÁ
);

102  
	g¥ec
;

107 
CodeId’t™y
 
G‘RªdomV®idCodeId’t™yW™hCÚ¡¿šts
(

108 cÚ¡ 
¡d
::
veùÜ
<
boŞ
> &
m»nşave_cÚ¡¿št
,

109 cÚ¡ 
¡d
::
veùÜ
<
boŞ
> &
mrsigÃr_cÚ¡¿št
) {

110 
CodeId’t™y
 
id
;

111 ià(
RªdomS–eù
(
m»nşave_cÚ¡¿št
)) {

112 autØ
	ghash
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

113 
	gid
.
mubË_m»nşave
()->
£t_hash
(
hash
.
d©a
(), hash.
size
());

116 ià(
RªdomS–eù
(
mrsigÃr_cÚ¡¿št
)) {

117 autØ
	ghash
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

118 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
mubË_mrsigÃr
()->
£t_hash
(

119 
hash
.
d©a
(), hash.
size
());

121 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isv´odid
(

122 
TrivŸlRªdomObjeù
<
ušt16_t
>());

123 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isvsvn
(

124 
TrivŸlRªdomObjeù
<
ušt16_t
>());

125 *
	gid
.
mubË_©Œibu‹s
(èğ
G‘RªdomA‰ribu‹s
();

126 
	gid
.
£t_misc£Ëù
(
TrivŸlRªdomObjeù
<
ušt32_t
>());

127  
	gid
;

130 
CodeId’t™y
 
G‘RªdomV®idCodeId’t™y
() {

131 
	g¡d
::
veùÜ
<
boŞ
> 
mr_£ËùiÚ_choiûs
{
Œue
, 
	gçl£
};

132  
G‘RªdomV®idCodeId’t™yW™hCÚ¡¿šts
(
mr_£ËùiÚ_choiûs
,

133 
mr_£ËùiÚ_choiûs
);

136 
CodeId’t™yM©chS³c
 
G‘RªdomV®idM©chS³c
() {

138  
G‘RªdomM©chS³c
();

141 
CodeId’t™yEx³ù©iÚ
 
G‘RªdomV®idEx³ù©iÚ
() {

142 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

143 *
	gex³ù©iÚ
.
mubË_m©ch_¥ec
(èğ
G‘RªdomV®idM©chS³c
();

144 
	g¡d
::
veùÜ
<
boŞ
> 
m»nşave_cÚ¡¿št
{

145 
ex³ù©iÚ
.
m©ch_¥ec
().
is_m»nşave_m©ch_»quœed
()};

146 
	g¡d
::
veùÜ
<
boŞ
> 
mrsigÃr_cÚ¡¿št
{

147 
ex³ù©iÚ
.
m©ch_¥ec
().
is_mrsigÃr_m©ch_»quœed
()};

148 *
	gex³ù©iÚ
.
mubË_»ã»nû_id’t™y
() =

149 
G‘RªdomV®idCodeId’t™yW™hCÚ¡¿šts
(
m»nşave_cÚ¡¿št
,

150 
mrsigÃr_cÚ¡¿št
);

151  
	gex³ù©iÚ
;

154 
S‘RªdomV®idG’”icId’t™y
(
EnşaveId’t™y
 *
g’”ic_id’t™y
,

155 
CodeId’t™y
 *
cÜ»¥Údšg_sgx_id’t™y
) {

156 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
CODE_IDENTITY
);

158 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(

159 
kSgxAuthÜiz©iÚAuthÜ™y
);

161 
CodeId’t™y
 
	gsgx_id’t™y
 = 
G‘RªdomV®idCodeId’t™y
();

162 
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(
g’”ic_id’t™y
->
mubË_id’t™y
());

163 *
	gcÜ»¥Údšg_sgx_id’t™y
 = 
sgx_id’t™y
;

166 
S‘RªdomInv®idG’”icId’t™y
(
EnşaveId’t™y
 *
g’”ic_id’t™y
) {

167 
boŞ
 
	gis_v®id
;

169 
	gis_v®id
 = 
Œue
;

170 
	g¡d
::
veùÜ
<
EnşaveId’t™yTy³
> 
id’t™y_ty³s
{

171 
UNKNOWN_IDENTITY
, 
	gNULL_IDENTITY
, 
	gCODE_IDENTITY
, 
	gCERT_IDENTITY
};

172 
EnşaveId’t™yTy³
 
	gid’t™y_ty³
 = 
RªdomS–eù
(
id’t™y_ty³s
);

173 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
id’t™y_ty³
);

174 
	gis_v®id
 &ğ(
id’t™y_ty³
 =ğ
CODE_IDENTITY
);

176 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
authÜ™y_ty³s
{
kSgxAuthÜiz©iÚAuthÜ™y
,

177 
	gkInv®idAuthÜ™yTy³
};

178 
	g¡d
::
¡ršg
 
authÜ™y_ty³
 = 
RªdomS–eù
(
authÜ™y_ty³s
);

179 
	gg’”ic_id’t™y
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
authÜ™y_ty³
);

180 
	gis_v®id
 &ğ(
authÜ™y_ty³
 =ğ
kSgxAuthÜiz©iÚAuthÜ™y
);

182 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
id’t™y_¡ršgs
(3);

183 
CodeId’t™y
 
	gsgx_id’t™y
;

187 
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(&
id’t™y_¡ršgs
[0]);

191 
	gid’t™y_¡ršgs
[1] = 
kInv®idSŒšg
;

192 
	gsgx_id’t™y
 = 
G‘RªdomV®idCodeId’t™y
();

195 
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(&
id’t™y_¡ršgs
[2]);

196 
	g¡d
::
¡ršg
 
id’t™y_¡ršg
 = 
RªdomS–eù
(
id’t™y_¡ršgs
);

197 
	gg’”ic_id’t™y
->
£t_id’t™y
(
id’t™y_¡ršg
);

198 
	gis_v®id
 &ğ(
id’t™y_¡ršg
 =ğ
id’t™y_¡ršgs
[2]);

199 } 
	gis_v®id
);

202 
S‘RªdomV®idG’”icM©chS³c
(

203 
¡d
::
¡ršg
 *
g’”ic_¥ec
, 
CodeId’t™yM©chS³c
 *
cÜ»¥Údšg_sgx_¥ec
) {

204 
CodeId’t™yM©chS³c
 
	g¥ec
 = 
G‘RªdomV®idM©chS³c
();

205 
	g¥ec
.
S”ŸlizeToSŒšg
(
g’”ic_¥ec
);

206 *
	gcÜ»¥Údšg_sgx_¥ec
 = 
¥ec
;

209 
Stus
 
S‘RªdomInv®idG’”icM©chS³c
(
¡d
::
¡ršg
 *
g’”ic_¥ec
) {

210 
CodeId’t™yM©chS³c
 
¥ec
;

211 
	gcouÁ
 = 0;

213 
	g¥ec
.
CË¬
();

214 
	g¥ec
 = 
G‘RªdomM©chS³c
( 70);

219 ià(
	gcouÁ
 >= 100) {

220  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Exceeded max‡ttempts");

222 
	gcouÁ
++;

223 } 
IsV®idM©chS³c
(
¥ec
));

224 
	g¥ec
.
S”ŸlizeToSŒšg
(
g’”ic_¥ec
);

225  
	gStus
::
OkStus
();

228 
Stus
 
S‘RªdomV®idG’”icEx³ù©iÚ
(

229 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
,

230 
CodeId’t™yEx³ù©iÚ
 *
cÜ»¥Údšg_sgx_ex³ù©iÚ
) {

231 
CodeId’t™y
 
	gsgx_id’t™y
;

232 
CodeId’t™yM©chS³c
 
	gsgx_¥ec
;

233 
	gcouÁ
 = 0;

236 
S‘RªdomV®idG’”icId’t™y
(

237 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
(), &
sgx_id’t™y
);

239 
S‘RªdomV®idG’”icM©chS³c
(
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
(),

240 &
sgx_¥ec
);

242 ià(
	gcouÁ
 >= 100) {

243  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Exceeded max‡ttempts");

245 
	gcouÁ
++;

247 !
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
sgx_id’t™y
, 
sgx_¥ec
));

249 
S‘Ex³ù©iÚ
(
sgx_¥ec
, 
sgx_id’t™y
, 
cÜ»¥Údšg_sgx_ex³ù©iÚ
);

250  
	gStus
::
OkStus
();

253 
Stus
 
S‘RªdomInv®idG’”icEx³ù©iÚ
(

254 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
) {

255 
CodeId’t™y
 
	gsgx_id’t™y
;

256 
CodeId’t™yM©chS³c
 
	gsgx_¥ec
;

257 
	g¡d
::
veùÜ
<
boŞ
> 
v®id™y_choiûs
{
Œue
, 
	gçl£
};

258 
boŞ
 
	gid’t™y_ªd_¥ec_¬e_v®id
 = 
Œue
;

259 
	gcouÁ
 = 0;

261 ià(
RªdomS–eù
(
v®id™y_choiûs
)) {

262 
S‘RªdomV®idG’”icId’t™y
(

263 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
(), &
sgx_id’t™y
);

265 
S‘RªdomInv®idG’”icId’t™y
(

266 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
());

267 
	gid’t™y_ªd_¥ec_¬e_v®id
 = 
çl£
;

269 ià(
RªdomS–eù
(
v®id™y_choiûs
)) {

270 
S‘RªdomV®idG’”icM©chS³c
(
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
(),

271 &
sgx_¥ec
);

273 
ASYLO_RETURN_IF_ERROR
(
S‘RªdomInv®idG’”icM©chS³c
(

274 
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
()));

275 
	gid’t™y_ªd_¥ec_¬e_v®id
 = 
çl£
;

277 ià(
	gcouÁ
 >= 100) {

278  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Exceeded max‡ttempts");

280 
	gcouÁ
++;

281 } 
	gid’t™y_ªd_¥ec_¬e_v®id
 &&

282 
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
sgx_id’t™y
, 
sgx_¥ec
));

283  
	gStus
::
OkStus
();

	@identity/sgx/code_identity_test_util.h

19 #iâdeà
ASYLO_IDENTITY_SGX_CODE_IDENTITY_TEST_UTIL_H_


20 
	#ASYLO_IDENTITY_SGX_CODE_IDENTITY_TEST_UTIL_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

36 
CodeId’t™y
 
G‘RªdomV®idCodeId’t™yW™hCÚ¡¿šts
(

37 cÚ¡ 
¡d
::
veùÜ
<
boŞ
> &
m»nşave_cÚ¡¿št
,

38 cÚ¡ 
¡d
::
veùÜ
<
boŞ
> &
mrsigÃr_cÚ¡¿št
);

41 
CodeId’t™y
 
G‘RªdomV®idCodeId’t™y
();

45 
CodeId’t™yM©chS³c
 
G‘RªdomV®idM©chS³c
();

48 
CodeId’t™yEx³ù©iÚ
 
G‘RªdomV®idEx³ù©iÚ
();

52 
S‘RªdomV®idG’”icId’t™y
(
EnşaveId’t™y
 *
g’”ic_id’t™y
,

53 
CodeId’t™y
 *
cÜ»¥Údšg_sgx_id’t™y
);

56 
S‘RªdomInv®idG’”icId’t™y
(
EnşaveId’t™y
 *
g’”ic_id’t™y
);

61 
S‘RªdomV®idG’”icM©chS³c
(

62 
¡d
::
¡ršg
 *
g’”ic_¥ec
, 
CodeId’t™yM©chS³c
 *
cÜ»¥Údšg_sgx_¥ec
);

66 
Stus
 
S‘RªdomInv®idG’”icM©chS³c
(
¡d
::
¡ršg
 *
g’”ic_¥ec
);

71 
Stus
 
S‘RªdomV®idG’”icEx³ù©iÚ
(

72 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
,

73 
CodeId’t™yEx³ù©iÚ
 *
cÜ»¥Údšg_sgx_ex³ù©iÚ
);

77 
Stus
 
S‘RªdomInv®idG’”icEx³ù©iÚ
(

78 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
);

	@identity/sgx/code_identity_util.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

21 
	~<İ’s¦/cmac.h
>

22 
	~<lim™s
>

23 
	~<¡ršg
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/üy±o/ut/bs¦_ut.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

29 
	~"asylo/id’t™y/desütiÚs.h
"

30 
	~"asylo/id’t™y/id’t™y.pb.h
"

31 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

32 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

34 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

35 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

36 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

37 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

38 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©us_maüos.h
"

41 
	~"asylo/ut/¡©usÜ.h
"

43 
Çme¥aû
 
	gasylo
 {

44 
Çme¥aû
 
	gsgx
 {

45 
	gÇme¥aû
 {

49 
Stus
 
G‘R•ÜtKey
(cÚ¡ 
Un§ãBy‹s
<
kKey»que¡KeyidSize
> &
keyid
,

50 
H¬dw¬eKey
 *
key
) {

51 ià(!
	gAligÃdH¬dw¬eKeyPŒ
::
IsAligÃd
(
key
)) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

58 
AligÃdKey»que¡PŒ
 
	g»que¡
;

62 *
	g»que¡
 = 
TrivŸlZ”oObjeù
<
Key»que¡
>();

64 
	g»que¡
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

65 
	g»que¡
->
	gkeyid
 = 
keyid
;

69 
	g»que¡
->
	gkeypŞicy
 = 
kKeypŞicyM»nşaveB™Mask
;

70 
	g»que¡
->
	gisvsvn
 = 0;

71 
	g»que¡
->
	gıusvn
.
fl
(0);

72 
CË¬SecsA‰ribu‹S‘
(&
»que¡
->
©Œibu‹mask
);

73 
	g»que¡
->
	gmiscmask
 = 0;

75  
G‘H¬dw¬eKey
(*
»que¡
, 
key
);

80 
Çme¥aû
 
	gš‹º®
 {

82 
boŞ
 
IsId’t™yCom·tibËW™hM©chS³c
(cÚ¡ 
CodeId’t™y
 &
id’t™y
,

83 cÚ¡ 
CodeId’t™yM©chS³c
 &
¥ec
) {

84 ià(
	g¥ec
.
is_m»nşave_m©ch_»quœed
(è&& !
	gid’t™y
.
has_m»nşave
()) {

85  
	gçl£
;

87 ià(
	g¥ec
.
is_mrsigÃr_m©ch_»quœed
() &&

88 !
	gid’t™y
.
sigÃr_assigÃd_id’t™y
().
has_mrsigÃr
()) {

89  
	gçl£
;

91  
	gŒue
;

96 
	gStusOr
<
	gboŞ
> 
M©chId’t™yToEx³ù©iÚ
(

97 cÚ¡ 
CodeId’t™y
 &
id’t™y
, cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) {

98 cÚ¡ 
	gCodeId’t™y
 &
	gex³ùed
 = 
ex³ù©iÚ
.
»ã»nû_id’t™y
();

99 cÚ¡ 
	gCodeId’t™yM©chS³c
 &
	g¥ec
 = 
ex³ù©iÚ
.
m©ch_¥ec
();

101 ià(!
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
)) {

102  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 ià(!
IsV®idCodeId’t™y
(
id’t™y
)) {

106  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 ià(!
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
id’t™y
, 
¥ec
)) {

110  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

114 ià(
	g¥ec
.
is_m»nşave_m©ch_»quœed
() &&

115 
	gid’t™y
.
m»nşave
(è!ğ
ex³ùed
.mrenclave()) {

116  
çl£
;

119 cÚ¡ 
	gSigÃrAssigÃdId’t™y
 &
	ggiv’_id
 = 
id’t™y
.
sigÃr_assigÃd_id’t™y
();

120 cÚ¡ 
	gSigÃrAssigÃdId’t™y
 &
	gex³ùed_id
 =

121 
ex³ùed
.
sigÃr_assigÃd_id’t™y
();

123 ià(
	g¥ec
.
is_mrsigÃr_m©ch_»quœed
() &&

124 
	ggiv’_id
.
mrsigÃr
(è!ğ
ex³ùed_id
.mrsigner()) {

125  
çl£
;

128 ià(
	ggiv’_id
.
isv´odid
(è!ğ
ex³ùed_id
.isvprodid()) {

129  
çl£
;

131 ià(
	ggiv’_id
.
isvsvn
(è< 
	gex³ùed_id
.isvsvn()) {

132  
	gçl£
;

135 ià((
	g¥ec
.
misc£Ëù_m©ch_mask
(è& 
	gid’t™y
.
misc£Ëù
()) !=

136 (
¥ec
.
misc£Ëù_m©ch_mask
(è& 
ex³ùed
.
misc£Ëù
())) {

137  
çl£
;

140 ià((
	g¥ec
.
©Œibu‹s_m©ch_mask
(è& 
	gid’t™y
.
©Œibu‹s
()) !=

141 (
¥ec
.
©Œibu‹s_m©ch_mask
(è& 
ex³ùed
.
©Œibu‹s
())) {

142  
çl£
;

145  
	gŒue
;

148 
Stus
 
S‘Ex³ù©iÚ
(cÚ¡ 
CodeId’t™yM©chS³c
 &
m©ch_¥ec
,

149 cÚ¡ 
CodeId’t™y
 &
id’t™y
,

150 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
) {

151 ià(!
IsV®idM©chS³c
(
m©ch_¥ec
)) {

152  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

155 ià(!
IsV®idCodeId’t™y
(
id’t™y
)) {

156  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

160 *
	gex³ù©iÚ
->
mubË_m©ch_¥ec
(èğ
m©ch_¥ec
;

161 *
	gex³ù©iÚ
->
mubË_»ã»nû_id’t™y
(èğ
id’t™y
;

162  
	gStus
::
OkStus
();

165 
boŞ
 
IsV®idSigÃrAssigÃdId’t™y
(cÚ¡ 
SigÃrAssigÃdId’t™y
 &
id’t™y
) {

166  (
	gid’t™y
.
has_isv´odid
(è&& id’t™y.
has_isvsvn
());

169 
boŞ
 
IsV®idCodeId’t™y
(cÚ¡ 
CodeId’t™y
 &
id’t™y
) {

172 ià(!
	gid’t™y
.
has_sigÃr_assigÃd_id’t™y
() ||

173 !
IsV®idSigÃrAssigÃdId’t™y
(
id’t™y
.
sigÃr_assigÃd_id’t™y
())) {

174  
	gçl£
;

177  
	gid’t™y
.
has_misc£Ëù
(è&& id’t™y.
has_©Œibu‹s
();

180 
boŞ
 
IsV®idM©chS³c
(cÚ¡ 
CodeId’t™yM©chS³c
 &
m©ch_¥ec
) {

181  
	gm©ch_¥ec
.
has_is_m»nşave_m©ch_»quœed
() &&

182 
	gm©ch_¥ec
.
has_is_mrsigÃr_m©ch_»quœed
() &&

183 
	gm©ch_¥ec
.
has_misc£Ëù_m©ch_mask
() &&

184 
	gm©ch_¥ec
.
has_©Œibu‹s_m©ch_mask
();

187 
boŞ
 
IsV®idEx³ù©iÚ
(cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) {

188 cÚ¡ 
	gCodeId’t™yM©chS³c
 &
	g¥ec
 = 
ex³ù©iÚ
.
m©ch_¥ec
();

189 ià(!
IsV®idM©chS³c
(
¥ec
)) {

190  
	gçl£
;

192 cÚ¡ 
	gCodeId’t™y
 &
	gid’t™y
 = 
ex³ù©iÚ
.
»ã»nû_id’t™y
();

193 ià(!
IsV®idCodeId’t™y
(
id’t™y
)) {

194  
	gçl£
;

196  
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
id’t™y
, 
¥ec
);

199 
Stus
 
P¬£Id’t™yFromH¬dw¬eR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
,

200 
CodeId’t™y
 *
id’t™y
) {

201 
	gid’t™y
->
mubË_m»nşave
()->
£t_hash
(
»pÜt
.
m»nşave
.
d©a
(),

202 
»pÜt
.
m»nşave
.
size
());

203 
	gid’t™y
->
mubË_sigÃr_assigÃd_id’t™y
()->
mubË_mrsigÃr
()->
£t_hash
(

204 
»pÜt
.
mrsigÃr
.
d©a
(),„•Üt.mrsigÃr.
size
());

205 
	gid’t™y
->
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isv´odid
(
»pÜt
.
isv´odid
);

206 
	gid’t™y
->
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isvsvn
(
»pÜt
.
isvsvn
);

207 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
»pÜt
.
©Œibu‹s
,

208 
id’t™y
->
mubË_©Œibu‹s
())) {

209  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

212 
	gid’t™y
->
£t_misc£Ëù
(
»pÜt
.
misc£Ëù
);

213  
	gStus
::
OkStus
();

216 
Stus
 
S‘DeçuÉM©chS³c
(
CodeId’t™yM©chS³c
 *
¥ec
) {

219 
	g¥ec
->
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

222 
	g¥ec
->
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

228 
	g¥ec
->
£t_misc£Ëù_m©ch_mask
(
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
());

232  
S‘DeçuÉSecsA‰ribu‹sMask
(
¥ec
->
mubË_©Œibu‹s_m©ch_mask
());

235 
S‘SŒiùM©chS³c
(
CodeId’t™yM©chS³c
 *
¥ec
) {

237 
	g¥ec
->
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

240 
	g¥ec
->
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

243 
	g¥ec
->
£t_misc£Ëù_m©ch_mask
(
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
());

246 
S‘SŒiùSecsA‰ribu‹sMask
(
¥ec
->
mubË_©Œibu‹s_m©ch_mask
());

249 
S‘S–fCodeId’t™y
(
CodeId’t™y
 *
id’t™y
) {

251 *
	gid’t™y
 = 
G‘S–fId’t™y
()->
id’t™y
;

254 
Stus
 
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
(

255 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
) {

256 
S‘S–fCodeId’t™y
(
ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
());

257  
S‘DeçuÉM©chS³c
(
ex³ù©iÚ
->
mubË_m©ch_¥ec
());

260 
Stus
 
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
(

261 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
) {

262 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

263 
S‘SŒiùM©chS³c
(&
m©ch_¥ec
);

265 
CodeId’t™y
 
	g£lf_id’t™y
;

266 
S‘S–fCodeId’t™y
(&
£lf_id’t™y
);

268  
S‘Ex³ù©iÚ
(
m©ch_¥ec
, 
£lf_id’t™y
, 
ex³ù©iÚ
);

271 
Stus
 
P¬£SgxId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
g’”ic_id’t™y
,

272 
CodeId’t™y
 *
sgx_id’t™y
) {

273 cÚ¡ 
	gEnşaveId’t™yDesütiÚ
 &
	gdesütiÚ
 =

274 
g’”ic_id’t™y
.
desütiÚ
();

275 ià(
	gdesütiÚ
.
id’t™y_ty³
(è!ğ
CODE_IDENTITY
) {

276  
Stus
(

277 ::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

278 ::
ab¦
::
SŒC©
(

280 
EnşaveId’t™yTy³_Name
(
desütiÚ
.
id’t™y_ty³
())));

282 ià(
	gdesütiÚ
.
authÜ™y_ty³
(è!ğ
kSgxAuthÜiz©iÚAuthÜ™y
) {

283  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

284 ::
ab¦
::
SŒC©
("Invalid‡uthority_type: Expected = ",

285 
kSgxAuthÜiz©iÚAuthÜ™y
,

286 ", Aùu® = ", 
desütiÚ
.
authÜ™y_ty³
()));

288 ià(!
	gsgx_id’t™y
->
P¬£FromSŒšg
(
g’”ic_id’t™y
.
id’t™y
())) {

289  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

292 ià(!
IsV®idCodeId’t™y
(*
sgx_id’t™y
)) {

293  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

296  
	gStus
::
OkStus
();

299 
Stus
 
P¬£SgxM©chS³c
(cÚ¡ 
¡d
::
¡ršg
 &
g’”ic_m©ch_¥ec
,

300 
CodeId’t™yM©chS³c
 *
sgx_m©ch_¥ec
) {

301 ià(!
	gsgx_m©ch_¥ec
->
P¬£FromSŒšg
(
g’”ic_m©ch_¥ec
)) {

302  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

305 ià(!
IsV®idM©chS³c
(*
sgx_m©ch_¥ec
)) {

306  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

309  
	gStus
::
OkStus
();

312 
Stus
 
P¬£SgxEx³ù©iÚ
(

313 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
g’”ic_ex³ù©iÚ
,

314 
CodeId’t™yEx³ù©iÚ
 *
sgx_ex³ù©iÚ
) {

317 
ASYLO_RETURN_IF_ERROR
(

318 
P¬£SgxId’t™y
(
g’”ic_ex³ù©iÚ
.
»ã»nû_id’t™y
(),

319 
sgx_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
()));

320 
ASYLO_RETURN_IF_ERROR
(
P¬£SgxM©chS³c
(

321 
g’”ic_ex³ù©iÚ
.
m©ch_¥ec
(), 
sgx_ex³ù©iÚ
->
mubË_m©ch_¥ec
()));

322 ià(!
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(

323 
sgx_ex³ù©iÚ
->
»ã»nû_id’t™y
(),

324 
sgx_ex³ù©iÚ
->
m©ch_¥ec
())) {

325  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

328  
	gStus
::
OkStus
();

331 
Stus
 
S”ŸlizeSgxId’t™y
(cÚ¡ 
CodeId’t™y
 &
sgx_id’t™y
,

332 
EnşaveId’t™y
 *
g’”ic_id’t™y
) {

333 ià(!
IsV®idCodeId’t™y
(
sgx_id’t™y
)) {

334  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

337 
S‘SgxId’t™yDesütiÚ
(
g’”ic_id’t™y
->
mubË_desütiÚ
());

338 ià(!
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(
g’”ic_id’t™y
->
mubË_id’t™y
())) {

339  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

342  
	gStus
::
OkStus
();

345 
Stus
 
S”ŸlizeSgxM©chS³c
(cÚ¡ 
CodeId’t™yM©chS³c
 &
sgx_m©ch_¥ec
,

346 
¡d
::
¡ršg
 *
g’”ic_m©ch_¥ec
) {

347 ià(!
IsV®idM©chS³c
(
sgx_m©ch_¥ec
)) {

348  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

351 ià(!
	gsgx_m©ch_¥ec
.
S”ŸlizeToSŒšg
(
g’”ic_m©ch_¥ec
)) {

352  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

355  
	gStus
::
OkStus
();

358 
Stus
 
S”ŸlizeSgxEx³ù©iÚ
(

359 cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
sgx_ex³ù©iÚ
,

360 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
) {

361 
ASYLO_RETURN_IF_ERROR
(

362 
S”ŸlizeSgxId’t™y
(
sgx_ex³ù©iÚ
.
»ã»nû_id’t™y
(),

363 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
()));

364  
S”ŸlizeSgxM©chS³c
(
sgx_ex³ù©iÚ
.
m©ch_¥ec
(),

365 
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
());

368 
S‘T¬g‘šfoFromS–fId’t™y
(
T¬g‘šfo
 *
tšfo
) {

369 cÚ¡ 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
G‘S–fId’t™y
();

372 *
	gtšfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

375 
	gtšfo
->
	gm—su»m’t
 = 
£lf_id’t™y
->
m»nşave
;

376 
	gtšfo
->
	g©Œibu‹s
 = 
£lf_id’t™y
->
©Œibu‹s
;

377 
	gtšfo
->
	gmisc£Ëù
 = 
£lf_id’t™y
->
misc£Ëù
;

380 
Stus
 
V”ifyH¬dw¬eR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
) {

381 
AligÃdH¬dw¬eKeyPŒ
 
	g»pÜt_key
;

383 
ASYLO_RETURN_IF_ERROR
(
G‘R•ÜtKey
(
»pÜt
.
keyid
, 
»pÜt_key
.
g‘
()));

388 
cÚ¡ex´
 
size_t
 
	gkR•ÜtMacSize
 = (
»pÜt
.
mac
);

389 
¡©ic_as£¹
(
kR•ÜtMacSize
 =ğ
AES_BLOCK_SIZE
,

391 
	gSaãBy‹s
<
	gkR•ÜtMacSize
> 
	gaùu®_mac
;

392 ià(
AES_CMAC
Ğ
aùu®_mac
.
d©a
(), 
»pÜt_key
->data(),

393  
»pÜt_key
->
size
(),

394  
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
»pÜt
),

395  
off£tof
(
R•Üt
, 
keyid
)) != 1) {

396  
Stus
(

397 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

398 
ab¦
::
SŒC©
("CMAC computiÚ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

403 ià(
	gaùu®_mac
 !ğ
»pÜt
.
mac
) {

404  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "MAC verification failed");

406  
	gStus
::
OkStus
();

	@identity/sgx/code_identity_util.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

21 
	~<İ’s¦/cmac.h
>

22 
	~<lim™s
>

23 
	~<¡ršg
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/üy±o/ut/bs¦_ut.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

29 
	~"asylo/id’t™y/desütiÚs.h
"

30 
	~"asylo/id’t™y/id’t™y.pb.h
"

31 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

32 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

34 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

35 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

36 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

37 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

38 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©us_maüos.h
"

41 
	~"asylo/ut/¡©usÜ.h
"

43 
Çme¥aû
 
	gasylo
 {

44 
Çme¥aû
 
	gsgx
 {

45 
	gÇme¥aû
 {

49 
Stus
 
G‘R•ÜtKey
(cÚ¡ 
Un§ãBy‹s
<
kKey»que¡KeyidSize
> &
keyid
,

50 
H¬dw¬eKey
 *
key
) {

51 ià(!
	gAligÃdH¬dw¬eKeyPŒ
::
IsAligÃd
(
key
)) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

58 
AligÃdKey»que¡PŒ
 
	g»que¡
;

62 *
	g»que¡
 = 
TrivŸlZ”oObjeù
<
Key»que¡
>();

64 
	g»que¡
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

65 
	g»que¡
->
	gkeyid
 = 
keyid
;

69 
	g»que¡
->
	gkeypŞicy
 = 
kKeypŞicyM»nşaveB™Mask
;

70 
	g»que¡
->
	gisvsvn
 = 0;

71 
	g»que¡
->
	gıusvn
.
fl
(0);

72 
CË¬SecsA‰ribu‹S‘
(&
»que¡
->
©Œibu‹mask
);

73 
	g»que¡
->
	gmiscmask
 = 0;

75  
G‘H¬dw¬eKey
(*
»que¡
, 
key
);

80 
Çme¥aû
 
	gš‹º®
 {

82 
boŞ
 
IsId’t™yCom·tibËW™hM©chS³c
(cÚ¡ 
CodeId’t™y
 &
id’t™y
,

83 cÚ¡ 
CodeId’t™yM©chS³c
 &
¥ec
) {

84 ià(
	g¥ec
.
is_m»nşave_m©ch_»quœed
(è&& !
	gid’t™y
.
has_m»nşave
()) {

85  
	gçl£
;

87 ià(
	g¥ec
.
is_mrsigÃr_m©ch_»quœed
() &&

88 !
	gid’t™y
.
sigÃr_assigÃd_id’t™y
().
has_mrsigÃr
()) {

89  
	gçl£
;

91  
	gŒue
;

96 
	gStusOr
<
	gboŞ
> 
M©chId’t™yToEx³ù©iÚ
(

97 cÚ¡ 
CodeId’t™y
 &
id’t™y
, cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) {

98 cÚ¡ 
	gCodeId’t™y
 &
	gex³ùed
 = 
ex³ù©iÚ
.
»ã»nû_id’t™y
();

99 cÚ¡ 
	gCodeId’t™yM©chS³c
 &
	g¥ec
 = 
ex³ù©iÚ
.
m©ch_¥ec
();

101 ià(!
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
)) {

102  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 ià(!
IsV®idCodeId’t™y
(
id’t™y
)) {

106  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 ià(!
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
id’t™y
, 
¥ec
)) {

110  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

114 ià(
	g¥ec
.
is_m»nşave_m©ch_»quœed
() &&

115 
	gid’t™y
.
m»nşave
(è!ğ
ex³ùed
.mrenclave()) {

116  
çl£
;

119 cÚ¡ 
	gSigÃrAssigÃdId’t™y
 &
	ggiv’_id
 = 
id’t™y
.
sigÃr_assigÃd_id’t™y
();

120 cÚ¡ 
	gSigÃrAssigÃdId’t™y
 &
	gex³ùed_id
 =

121 
ex³ùed
.
sigÃr_assigÃd_id’t™y
();

123 ià(
	g¥ec
.
is_mrsigÃr_m©ch_»quœed
() &&

124 
	ggiv’_id
.
mrsigÃr
(è!ğ
ex³ùed_id
.mrsigner()) {

125  
çl£
;

128 ià(
	ggiv’_id
.
isv´odid
(è!ğ
ex³ùed_id
.isvprodid()) {

129  
çl£
;

131 ià(
	ggiv’_id
.
isvsvn
(è< 
	gex³ùed_id
.isvsvn()) {

132  
	gçl£
;

135 ià((
	g¥ec
.
misc£Ëù_m©ch_mask
(è& 
	gid’t™y
.
misc£Ëù
()) !=

136 (
¥ec
.
misc£Ëù_m©ch_mask
(è& 
ex³ùed
.
misc£Ëù
())) {

137  
çl£
;

140 ià((
	g¥ec
.
©Œibu‹s_m©ch_mask
(è& 
	gid’t™y
.
©Œibu‹s
()) !=

141 (
¥ec
.
©Œibu‹s_m©ch_mask
(è& 
ex³ùed
.
©Œibu‹s
())) {

142  
çl£
;

145  
	gŒue
;

148 
Stus
 
S‘Ex³ù©iÚ
(cÚ¡ 
CodeId’t™yM©chS³c
 &
m©ch_¥ec
,

149 cÚ¡ 
CodeId’t™y
 &
id’t™y
,

150 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
) {

151 ià(!
IsV®idM©chS³c
(
m©ch_¥ec
)) {

152  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

155 ià(!
IsV®idCodeId’t™y
(
id’t™y
)) {

156  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

160 *
	gex³ù©iÚ
->
mubË_m©ch_¥ec
(èğ
m©ch_¥ec
;

161 *
	gex³ù©iÚ
->
mubË_»ã»nû_id’t™y
(èğ
id’t™y
;

162  
	gStus
::
OkStus
();

165 
boŞ
 
IsV®idSigÃrAssigÃdId’t™y
(cÚ¡ 
SigÃrAssigÃdId’t™y
 &
id’t™y
) {

166  (
	gid’t™y
.
has_isv´odid
(è&& id’t™y.
has_isvsvn
());

169 
boŞ
 
IsV®idCodeId’t™y
(cÚ¡ 
CodeId’t™y
 &
id’t™y
) {

172 ià(!
	gid’t™y
.
has_sigÃr_assigÃd_id’t™y
() ||

173 !
IsV®idSigÃrAssigÃdId’t™y
(
id’t™y
.
sigÃr_assigÃd_id’t™y
())) {

174  
	gçl£
;

177  
	gid’t™y
.
has_misc£Ëù
(è&& id’t™y.
has_©Œibu‹s
();

180 
boŞ
 
IsV®idM©chS³c
(cÚ¡ 
CodeId’t™yM©chS³c
 &
m©ch_¥ec
) {

181  
	gm©ch_¥ec
.
has_is_m»nşave_m©ch_»quœed
() &&

182 
	gm©ch_¥ec
.
has_is_mrsigÃr_m©ch_»quœed
() &&

183 
	gm©ch_¥ec
.
has_misc£Ëù_m©ch_mask
() &&

184 
	gm©ch_¥ec
.
has_©Œibu‹s_m©ch_mask
();

187 
boŞ
 
IsV®idEx³ù©iÚ
(cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) {

188 cÚ¡ 
	gCodeId’t™yM©chS³c
 &
	g¥ec
 = 
ex³ù©iÚ
.
m©ch_¥ec
();

189 ià(!
IsV®idM©chS³c
(
¥ec
)) {

190  
	gçl£
;

192 cÚ¡ 
	gCodeId’t™y
 &
	gid’t™y
 = 
ex³ù©iÚ
.
»ã»nû_id’t™y
();

193 ià(!
IsV®idCodeId’t™y
(
id’t™y
)) {

194  
	gçl£
;

196  
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(
id’t™y
, 
¥ec
);

199 
Stus
 
P¬£Id’t™yFromH¬dw¬eR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
,

200 
CodeId’t™y
 *
id’t™y
) {

201 
	gid’t™y
->
mubË_m»nşave
()->
£t_hash
(
»pÜt
.
m»nşave
.
d©a
(),

202 
»pÜt
.
m»nşave
.
size
());

203 
	gid’t™y
->
mubË_sigÃr_assigÃd_id’t™y
()->
mubË_mrsigÃr
()->
£t_hash
(

204 
»pÜt
.
mrsigÃr
.
d©a
(),„•Üt.mrsigÃr.
size
());

205 
	gid’t™y
->
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isv´odid
(
»pÜt
.
isv´odid
);

206 
	gid’t™y
->
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isvsvn
(
»pÜt
.
isvsvn
);

207 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
»pÜt
.
©Œibu‹s
,

208 
id’t™y
->
mubË_©Œibu‹s
())) {

209  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

212 
	gid’t™y
->
£t_misc£Ëù
(
»pÜt
.
misc£Ëù
);

213  
	gStus
::
OkStus
();

216 
Stus
 
S‘DeçuÉM©chS³c
(
CodeId’t™yM©chS³c
 *
¥ec
) {

219 
	g¥ec
->
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

222 
	g¥ec
->
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

228 
	g¥ec
->
£t_misc£Ëù_m©ch_mask
(
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
());

232  
S‘DeçuÉSecsA‰ribu‹sMask
(
¥ec
->
mubË_©Œibu‹s_m©ch_mask
());

235 
S‘SŒiùM©chS³c
(
CodeId’t™yM©chS³c
 *
¥ec
) {

237 
	g¥ec
->
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

240 
	g¥ec
->
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

243 
	g¥ec
->
£t_misc£Ëù_m©ch_mask
(
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
());

246 
S‘SŒiùSecsA‰ribu‹sMask
(
¥ec
->
mubË_©Œibu‹s_m©ch_mask
());

249 
S‘S–fCodeId’t™y
(
CodeId’t™y
 *
id’t™y
) {

251 *
	gid’t™y
 = 
G‘S–fId’t™y
()->
id’t™y
;

254 
Stus
 
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
(

255 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
) {

256 
S‘S–fCodeId’t™y
(
ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
());

257  
S‘DeçuÉM©chS³c
(
ex³ù©iÚ
->
mubË_m©ch_¥ec
());

260 
Stus
 
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
(

261 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
) {

262 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

263 
S‘SŒiùM©chS³c
(&
m©ch_¥ec
);

265 
CodeId’t™y
 
	g£lf_id’t™y
;

266 
S‘S–fCodeId’t™y
(&
£lf_id’t™y
);

268  
S‘Ex³ù©iÚ
(
m©ch_¥ec
, 
£lf_id’t™y
, 
ex³ù©iÚ
);

271 
Stus
 
P¬£SgxId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
g’”ic_id’t™y
,

272 
CodeId’t™y
 *
sgx_id’t™y
) {

273 cÚ¡ 
	gEnşaveId’t™yDesütiÚ
 &
	gdesütiÚ
 =

274 
g’”ic_id’t™y
.
desütiÚ
();

275 ià(
	gdesütiÚ
.
id’t™y_ty³
(è!ğ
CODE_IDENTITY
) {

276  
Stus
(

277 ::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

278 ::
ab¦
::
SŒC©
(

280 
EnşaveId’t™yTy³_Name
(
desütiÚ
.
id’t™y_ty³
())));

282 ià(
	gdesütiÚ
.
authÜ™y_ty³
(è!ğ
kSgxAuthÜiz©iÚAuthÜ™y
) {

283  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

284 ::
ab¦
::
SŒC©
("Invalid‡uthority_type: Expected = ",

285 
kSgxAuthÜiz©iÚAuthÜ™y
,

286 ", Aùu® = ", 
desütiÚ
.
authÜ™y_ty³
()));

288 ià(!
	gsgx_id’t™y
->
P¬£FromSŒšg
(
g’”ic_id’t™y
.
id’t™y
())) {

289  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

292 ià(!
IsV®idCodeId’t™y
(*
sgx_id’t™y
)) {

293  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

296  
	gStus
::
OkStus
();

299 
Stus
 
P¬£SgxM©chS³c
(cÚ¡ 
¡d
::
¡ršg
 &
g’”ic_m©ch_¥ec
,

300 
CodeId’t™yM©chS³c
 *
sgx_m©ch_¥ec
) {

301 ià(!
	gsgx_m©ch_¥ec
->
P¬£FromSŒšg
(
g’”ic_m©ch_¥ec
)) {

302  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

305 ià(!
IsV®idM©chS³c
(*
sgx_m©ch_¥ec
)) {

306  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

309  
	gStus
::
OkStus
();

312 
Stus
 
P¬£SgxEx³ù©iÚ
(

313 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
g’”ic_ex³ù©iÚ
,

314 
CodeId’t™yEx³ù©iÚ
 *
sgx_ex³ù©iÚ
) {

317 
ASYLO_RETURN_IF_ERROR
(

318 
P¬£SgxId’t™y
(
g’”ic_ex³ù©iÚ
.
»ã»nû_id’t™y
(),

319 
sgx_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
()));

320 
ASYLO_RETURN_IF_ERROR
(
P¬£SgxM©chS³c
(

321 
g’”ic_ex³ù©iÚ
.
m©ch_¥ec
(), 
sgx_ex³ù©iÚ
->
mubË_m©ch_¥ec
()));

322 ià(!
	gš‹º®
::
IsId’t™yCom·tibËW™hM©chS³c
(

323 
sgx_ex³ù©iÚ
->
»ã»nû_id’t™y
(),

324 
sgx_ex³ù©iÚ
->
m©ch_¥ec
())) {

325  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

328  
	gStus
::
OkStus
();

331 
Stus
 
S”ŸlizeSgxId’t™y
(cÚ¡ 
CodeId’t™y
 &
sgx_id’t™y
,

332 
EnşaveId’t™y
 *
g’”ic_id’t™y
) {

333 ià(!
IsV®idCodeId’t™y
(
sgx_id’t™y
)) {

334  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

337 
S‘SgxId’t™yDesütiÚ
(
g’”ic_id’t™y
->
mubË_desütiÚ
());

338 ià(!
	gsgx_id’t™y
.
S”ŸlizeToSŒšg
(
g’”ic_id’t™y
->
mubË_id’t™y
())) {

339  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

342  
	gStus
::
OkStus
();

345 
Stus
 
S”ŸlizeSgxM©chS³c
(cÚ¡ 
CodeId’t™yM©chS³c
 &
sgx_m©ch_¥ec
,

346 
¡d
::
¡ršg
 *
g’”ic_m©ch_¥ec
) {

347 ià(!
IsV®idM©chS³c
(
sgx_m©ch_¥ec
)) {

348  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

351 ià(!
	gsgx_m©ch_¥ec
.
S”ŸlizeToSŒšg
(
g’”ic_m©ch_¥ec
)) {

352  
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

355  
	gStus
::
OkStus
();

358 
Stus
 
S”ŸlizeSgxEx³ù©iÚ
(

359 cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
sgx_ex³ù©iÚ
,

360 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
) {

361 
ASYLO_RETURN_IF_ERROR
(

362 
S”ŸlizeSgxId’t™y
(
sgx_ex³ù©iÚ
.
»ã»nû_id’t™y
(),

363 
g’”ic_ex³ù©iÚ
->
mubË_»ã»nû_id’t™y
()));

364  
S”ŸlizeSgxM©chS³c
(
sgx_ex³ù©iÚ
.
m©ch_¥ec
(),

365 
g’”ic_ex³ù©iÚ
->
mubË_m©ch_¥ec
());

368 
S‘T¬g‘šfoFromS–fId’t™y
(
T¬g‘šfo
 *
tšfo
) {

369 cÚ¡ 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
G‘S–fId’t™y
();

372 *
	gtšfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

375 
	gtšfo
->
	gm—su»m’t
 = 
£lf_id’t™y
->
m»nşave
;

376 
	gtšfo
->
	g©Œibu‹s
 = 
£lf_id’t™y
->
©Œibu‹s
;

377 
	gtšfo
->
	gmisc£Ëù
 = 
£lf_id’t™y
->
misc£Ëù
;

380 
Stus
 
V”ifyH¬dw¬eR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
) {

381 
AligÃdH¬dw¬eKeyPŒ
 
	g»pÜt_key
;

383 
ASYLO_RETURN_IF_ERROR
(
G‘R•ÜtKey
(
»pÜt
.
keyid
, 
»pÜt_key
.
g‘
()));

388 
cÚ¡ex´
 
size_t
 
	gkR•ÜtMacSize
 = (
»pÜt
.
mac
);

389 
¡©ic_as£¹
(
kR•ÜtMacSize
 =ğ
AES_BLOCK_SIZE
,

391 
	gSaãBy‹s
<
	gkR•ÜtMacSize
> 
	gaùu®_mac
;

392 ià(
AES_CMAC
Ğ
aùu®_mac
.
d©a
(), 
»pÜt_key
->data(),

393  
»pÜt_key
->
size
(),

394  
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
»pÜt
),

395  
off£tof
(
R•Üt
, 
keyid
)) != 1) {

396  
Stus
(

397 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

398 
ab¦
::
SŒC©
("CMAC computiÚ faed: ", 
Bs¦La¡E¼ÜSŒšg
()));

403 ià(
	gaùu®_mac
 !ğ
»pÜt
.
mac
) {

404  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "MAC verification failed");

406  
	gStus
::
OkStus
();

	@identity/sgx/code_identity_util.h

19 #iâdeà
ASYLO_IDENTITY_SGX_CODE_IDENTITY_UTIL_H_


20 
	#ASYLO_IDENTITY_SGX_CODE_IDENTITY_UTIL_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

24 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

25 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

34 
	gStusOr
<
	gboŞ
> 
M©chId’t™yToEx³ù©iÚ
(

35 cÚ¡ 
CodeId’t™y
 &
id’t™y
, cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
);

39 
Stus
 
S‘Ex³ù©iÚ
(cÚ¡ 
CodeId’t™yM©chS³c
 &
m©ch_¥ec
,

40 cÚ¡ 
CodeId’t™y
 &
id’t™y
,

41 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
);

44 
boŞ
 
IsV®idSigÃrAssigÃdId’t™y
(cÚ¡ 
SigÃrAssigÃdId’t™y
 &
id’t™y
);

47 
boŞ
 
IsV®idCodeId’t™y
(cÚ¡ 
CodeId’t™y
 &
id’t™y
);

50 
boŞ
 
IsV®idM©chS³c
(cÚ¡ 
CodeId’t™yM©chS³c
 &
m©ch_¥ec
);

53 
boŞ
 
IsV®idEx³ù©iÚ
(cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
);

57 
Stus
 
P¬£Id’t™yFromH¬dw¬eR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
,

58 
CodeId’t™y
 *
id’t™y
);

63 
Stus
 
S‘DeçuÉM©chS³c
(
CodeId’t™yM©chS³c
 *
¥ec
);

67 
S‘SŒiùM©chS³c
(
CodeId’t™yM©chS³c
 *
¥ec
);

70 
S‘S–fCodeId’t™y
(
CodeId’t™y
 *
id’t™y
);

74 
Stus
 
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
(

75 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
);

79 
Stus
 
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
(

80 
CodeId’t™yEx³ù©iÚ
 *
ex³ù©iÚ
);

83 
Stus
 
P¬£SgxId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
g’”ic_id’t™y
,

84 
CodeId’t™y
 *
sgx_id’t™y
);

88 
Stus
 
P¬£SgxM©chS³c
(cÚ¡ 
¡d
::
¡ršg
 &
g’”ic_m©ch_¥ec
,

89 
CodeId’t™yM©chS³c
 *
sgx_m©ch_¥ec
);

93 
Stus
 
P¬£SgxEx³ù©iÚ
(

94 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
g’”ic_ex³ù©iÚ
,

95 
CodeId’t™yEx³ù©iÚ
 *
sgx_ex³ù©iÚ
);

100 
Stus
 
S”ŸlizeSgxId’t™y
(cÚ¡ 
CodeId’t™y
 &
sgx_id’t™y
,

101 
EnşaveId’t™y
 *
g’”ic_id’t™y
);

105 
Stus
 
S”ŸlizeSgxM©chS³c
(cÚ¡ 
CodeId’t™yM©chS³c
 &
sgx_m©ch_¥ec
,

106 
¡d
::
¡ršg
 *
g’”ic_m©ch_¥ec
);

112 
Stus
 
S”ŸlizeSgxEx³ù©iÚ
(cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
sgx_ex³ù©iÚ
,

113 
EnşaveId’t™yEx³ù©iÚ
 *
g’”ic_ex³ù©iÚ
);

117 
S‘T¬g‘šfoFromS–fId’t™y
(
T¬g‘šfo
 *
tšfo
);

120 
Stus
 
V”ifyH¬dw¬eR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
);

122 
Çme¥aû
 
	gš‹º®
 {

126 
boŞ
 
IsId’t™yCom·tibËW™hM©chS³c
(cÚ¡ 
CodeId’t™y
 &
id’t™y
,

127 cÚ¡ 
CodeId’t™yM©chS³c
 &
¥ec
);

	@identity/sgx/code_identity_util_test.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/üy±o/ut/by‹s.h
"

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

28 
	~"asylo/id’t™y/desütiÚs.h
"

29 
	~"asylo/id’t™y/id’t™y.pb.h
"

30 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

31 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

32 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

34 
	~"asylo/id’t™y/sgx/code_id’t™y_‹¡_ut.h
"

35 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

36 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

37 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

38 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

39 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

40 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

41 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

42 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

43 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

44 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

45 
	~"asylo/ut/¡©us.h
"

46 
	~"asylo/ut/¡©usÜ.h
"

48 
Çme¥aû
 
	gasylo
 {

49 
Çme¥aû
 
	gsgx
 {

50 
	gÇme¥aû
 {

52 
	gusšg
 ::
‹¡šg
::
NÙ
;

54 
cÚ¡ex´
 
ušt32_t
 
	gkLÚgAÎ0
 = 0x0;

55 
cÚ¡ex´
 
ušt32_t
 
	gkLÚgAÎF
 = 0xFFFFFFFF;

56 
cÚ¡ex´
 
ušt32_t
 
	gkLÚgAÎ5
 = 0x55555555;

57 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎF
 = 0xFFFFFFFFFFFFFFFFULL;

58 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎA
 = 0xAAAAAAAAAAAAAAAAULL;

59 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎ5
 = 0x5555555555555555ULL;

60 
cÚ¡ex´
 
	gkInv®idSŒšg
[] = "Invalid String";

63 şas 
	cCodeId’t™yUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

64 
´Ùeùed
:

65 
S‘Up
(è
ov”ride
 {

66 
Sha256HashFromHexSŒšg
(

68 &
h_aûdçû_
);

69 
Sha256HashFromHexSŒšg
(

71 &
h_d—db“f_
);

72 
	g©Œibu‹s_®l_f_
.
£t_æags
(
kLÚgLÚgAÎF
);

73 
	g©Œibu‹s_®l_f_
.
£t_xäm
(
kLÚgLÚgAÎF
);

74 
	g©Œibu‹s_®l_5_
.
£t_æags
(
kLÚgLÚgAÎ5
);

75 
	g©Œibu‹s_®l_5_
.
£t_xäm
(
kLÚgLÚgAÎ5
);

76 
	g©Œibu‹s_®l_a_
.
£t_æags
(
kLÚgLÚgAÎA
);

77 
	g©Œibu‹s_®l_a_
.
£t_xäm
(
kLÚgLÚgAÎA
);

82 
	g’şave_
 = 
SšgËtÚ
<
FakeEnşave
, 
	gRªdomFakeEnşaveFaùÜy
>::
g‘
();

83 ià(
	gFakeEnşave
::
G‘Cu¼’tEnşave
(è=ğ
nuÎ±r
) {

84 
FakeEnşave
::
EÁ”Enşave
(*
’şave_
);

88 
SigÃrAssigÃdId’t™y
 
MakeSigÃrAssigÃdId’t™y
(

89 cÚ¡ 
Sha256HashPrÙo
 &
mrsigÃr
, 
ušt16_t
 
isv´odid
, ušt16_ˆ
isvsvn
) {

90 
SigÃrAssigÃdId’t™y
 
	gid
;

91 *
	gid
.
mubË_mrsigÃr
(èğ
mrsigÃr
;

92 
	gid
.
£t_isv´odid
(
isv´odid
);

93 
	gid
.
£t_isvsvn
(
isvsvn
);

94  
	gid
;

97 
CodeId’t™y
 
G‘Mšim®V®idCodeId’t™y
(
ušt32_t
 
misc£Ëù
,

98 cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
) {

99 
CodeId’t™y
 
	gid
;

100 
	gid
.
£t_misc£Ëù
(
misc£Ëù
);

101 *
	gid
.
mubË_©Œibu‹s
(èğ
©Œibu‹s
;

102 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isv´odid
(0);

103 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isvsvn
(0);

104  
	gid
;

107 
Sha256HashPrÙo
 
	gh_aûdçû_
;

108 
Sha256HashPrÙo
 
	gh_d—db“f_
;

109 
A‰ribu‹s
 
	g©Œibu‹s_®l_0_
;

110 
A‰ribu‹s
 
	g©Œibu‹s_®l_f_
;

111 
A‰ribu‹s
 
	g©Œibu‹s_®l_5_
;

112 
A‰ribu‹s
 
	g©Œibu‹s_®l_a_
;

113 
FakeEnşave
 *
	g’şave_
;

116 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SgxId’t™yDesütiÚ
) {

117 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

118 
S‘SgxId’t™yDesütiÚ
(&
desütiÚ
);

120 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

121 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kSgxAuthÜiz©iÚAuthÜ™y
);

124 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SgxLoÿlAs£¹iÚDesütiÚ
) {

125 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

126 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
desütiÚ
);

128 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

129 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kSgxLoÿlAs£¹iÚAuthÜ™y
);

132 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SgxRemÙeAs£¹iÚDesütiÚ
) {

133 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

134 
S‘SgxRemÙeAs£¹iÚDesütiÚ
(&
desütiÚ
);

136 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

137 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kSgxRemÙeAs£¹iÚAuthÜ™y
);

142 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yPos™ive1
) {

143 
SigÃrAssigÃdId’t™y
 
	gid
 = 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

144 
EXPECT_TRUE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

147 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yPos™ive2
) {

148 
SigÃrAssigÃdId’t™y
 
	gid
;

149 
	gid
.
£t_isv´odid
(0);

150 
	gid
.
£t_isvsvn
(0);

151 
EXPECT_TRUE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

154 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yNeg©ive1
) {

155 
SigÃrAssigÃdId’t™y
 
	gid
;

156 *
	gid
.
mubË_mrsigÃr
(èğ
h_aûdçû_
;

157 
	gid
.
£t_isvsvn
(0);

158 
EXPECT_FALSE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

161 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yNeg©ive2
) {

162 
SigÃrAssigÃdId’t™y
 
	gid
;

163 *
	gid
.
mubË_mrsigÃr
(èğ
h_aûdçû_
;

164 
	gid
.
£t_isv´odid
(0);

165 
EXPECT_FALSE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

170 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yPos™ive1
) {

171 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

172 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

173 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

174 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

175 
EXPECT_TRUE
(
IsV®idCodeId’t™y
(
id
));

178 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yPos™ive2
) {

179 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

180 
EXPECT_TRUE
(
IsV®idCodeId’t™y
(
id
));

183 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yNeg©ive1
) {

184 
CodeId’t™y
 
	gid
;

185 
EXPECT_FALSE
(
IsV®idCodeId’t™y
(
id
));

188 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yNeg©ive2
) {

189 
CodeId’t™y
 
	gid
;

190 
	gid
.
£t_misc£Ëù
(
kLÚgAÎ5
);

191 
EXPECT_FALSE
(
IsV®idCodeId’t™y
(
id
));

194 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yNeg©ive3
) {

195 
CodeId’t™y
 
	gid
;

196 *
	gid
.
mubË_©Œibu‹s
(èğ
©Œibu‹s_®l_5_
;

197 
EXPECT_FALSE
(
IsV®idCodeId’t™y
(
id
));

202 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yPos™ive
) {

203 
CodeId’t™yM©chS³c
 
	g¥ec
;

204 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

205 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

206 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

207 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

208 
EXPECT_TRUE
(
IsV®idM©chS³c
(
¥ec
));

211 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive1
) {

212 
CodeId’t™yM©chS³c
 
	g¥ec
;

213 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

214 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

215 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

216 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

219 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive2
) {

220 
CodeId’t™yM©chS³c
 
	g¥ec
;

221 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

222 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

223 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

224 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

227 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive3
) {

228 
CodeId’t™yM©chS³c
 
	g¥ec
;

229 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

230 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

231 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

232 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

235 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive4
) {

236 
CodeId’t™yM©chS³c
 
	g¥ec
;

237 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

238 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

239 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

240 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

245 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive1
) {

246 
CodeId’t™yM©chS³c
 
	g¥ec
;

247 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

248 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

249 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

250 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

252 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

253 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

254 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

255 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

257 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

258 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

259 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

262 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive2
) {

263 
CodeId’t™yM©chS³c
 
	g¥ec
;

264 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

265 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

266 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

267 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

269 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

270 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

271 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

273 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

274 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

275 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

278 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive3
) {

279 
CodeId’t™yM©chS³c
 
	g¥ec
;

280 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

281 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

282 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

283 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

285 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

286 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

288 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

289 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

290 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

293 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive4
) {

294 
CodeId’t™yM©chS³c
 
	g¥ec
;

295 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

296 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

297 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

298 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

300 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

301 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

302 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

303 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

305 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

306 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

307 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

310 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yNeg©ive1
) {

311 
CodeId’t™yM©chS³c
 
	g¥ec
;

312 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

313 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

314 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

315 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

317 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

318 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

319 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

321 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

322 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

323 
EXPECT_FALSE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

326 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yNeg©ive2
) {

327 
CodeId’t™yM©chS³c
 
	g¥ec
;

328 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

329 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

330 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

331 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

333 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

334 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

336 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

337 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

338 
EXPECT_FALSE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

345 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yS–fM©ch
) {

346 
CodeId’t™yM©chS³c
 
	g¥ec
;

347 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

348 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

349 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

350 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

352 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

353 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

354 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

355 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

357 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

358 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

360 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

361 
ASYLO_ASSERT_OK
(
»suÉ
);

362 
EXPECT_TRUE
(
»suÉ
.
V®ueOrD›
());

367 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yDifãršgDoNÙC¬eF›lds
) {

368 
CodeId’t™yM©chS³c
 
	g¥ec
;

369 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

370 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

371 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

372 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

374 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

375 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

376 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

377 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

379 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

380 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

382 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

383 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

384 
ASYLO_ASSERT_OK
(
»suÉ
);

385 
EXPECT_TRUE
(
»suÉ
.
V®ueOrD›
());

390 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yMrEnşaveMism©ch
) {

391 
CodeId’t™yM©chS³c
 
	g¥ec
;

392 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

393 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

394 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

395 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

397 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

398 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

399 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

400 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

402 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

403 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

405 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

406 *
	gid
.
mubË_m»nşave
(èğ
h_d—db“f_
;

407 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

408 
ASYLO_ASSERT_OK
(
»suÉ
);

409 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

415 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™yMism©ch1
) {

416 
CodeId’t™yM©chS³c
 
	g¥ec
;

417 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

418 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

419 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

420 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

422 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

423 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

424 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

425 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

427 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

428 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

430 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

431 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

432 
MakeSigÃrAssigÃdId’t™y
(
h_d—db“f_
, 0, 0);

433 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

434 
ASYLO_ASSERT_OK
(
»suÉ
);

435 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

441 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™yMism©ch2
) {

442 
CodeId’t™yM©chS³c
 
	g¥ec
;

443 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

444 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

445 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

446 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

448 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

449 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

450 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

451 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

453 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

454 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

456 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

457 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

458 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 1, 0);

459 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

460 
ASYLO_ASSERT_OK
(
»suÉ
);

461 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

465 
	gex³ù©iÚ
.
mubË_m©ch_¥ec
()->
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

466 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

467 
ASYLO_ASSERT_OK
(
»suÉ
);

468 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

474 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™yMism©ch3
) {

475 
CodeId’t™yM©chS³c
 
	g¥ec
;

476 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

477 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

478 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

479 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

481 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

482 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

483 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

484 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 1);

486 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

487 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

489 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

490 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

491 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

492 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

493 
ASYLO_ASSERT_OK
(
»suÉ
);

494 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

498 
	gex³ù©iÚ
.
mubË_m©ch_¥ec
()->
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

499 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

500 
ASYLO_ASSERT_OK
(
»suÉ
);

501 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

507 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™ySVNM©ch
) {

508 
CodeId’t™yM©chS³c
 
	g¥ec
;

509 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

510 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

511 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

512 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

514 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

515 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

516 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

517 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

519 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

520 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

522 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

523 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

524 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 1);

525 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

526 
ASYLO_ASSERT_OK
(
»suÉ
);

527 
EXPECT_TRUE
(
»suÉ
.
V®ueOrD›
());

532 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yMiscS–eùMism©ch
) {

533 
CodeId’t™yM©chS³c
 
	g¥ec
;

534 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

535 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

536 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

537 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

539 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

540 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

541 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

542 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

544 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

545 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

547 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ0
, 
©Œibu‹s_®l_f_
);

548 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

549 
ASYLO_ASSERT_OK
(
»suÉ
);

550 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

555 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yA‰ribu‹sMism©ch
) {

556 
CodeId’t™yM©chS³c
 
	g¥ec
;

557 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

558 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

559 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

560 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

562 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

563 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

564 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

565 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

567 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

568 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

570 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_0_
);

571 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

572 
ASYLO_ASSERT_OK
(
»suÉ
);

573 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

578 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chInv®idEx³ù©iÚ
) {

579 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

580 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

581 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

582 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

584 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

585 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

586 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

587 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

593 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chInv®idId’t™y
) {

594 
CodeId’t™yM©chS³c
 
	g¥ec
;

595 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

596 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

597 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

598 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

600 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

601 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

602 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

603 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

605 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

606 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

608 
	gid
.
CË¬
();

609 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

610 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

611 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

618 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chId’t™yMissšgM»nşave
) {

619 
CodeId’t™yM©chS³c
 
	g¥ec
;

620 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

621 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

622 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

623 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

625 
CodeId’t™y
 
	gid1
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

626 *
	gid1
.
mubË_m»nşave
(èğ
h_aûdçû_
;

627 *
	gid1
.
mubË_sigÃr_assigÃd_id’t™y
() =

628 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

630 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

631 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id1
, &
ex³ù©iÚ
));

633 
CodeId’t™y
 
	gid2
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

634 *
	gid2
.
mubË_sigÃr_assigÃd_id’t™y
() =

635 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

637 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id2
, 
ex³ù©iÚ
);

638 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

639 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

645 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chId’t™yMissšgMrsigÃr
) {

646 
CodeId’t™yM©chS³c
 
	g¥ec
;

647 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

648 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

649 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

650 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

652 
CodeId’t™y
 
	gid1
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

653 *
	gid1
.
mubË_m»nşave
(èğ
h_aûdçû_
;

654 *
	gid1
.
mubË_sigÃr_assigÃd_id’t™y
() =

655 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

657 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

658 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id1
, &
ex³ù©iÚ
));

660 
CodeId’t™y
 
	gid2
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

661 *
	gid2
.
mubË_m»nşave
(èğ
h_aûdçû_
;

663 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id2
, 
ex³ù©iÚ
);

664 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

665 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

669 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£Id’t™yFromH¬dw¬eR•Üt
) {

670 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

671 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

672 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

674 *
	gtšfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

675 *
	g»pÜtd©a
 = 
TrivŸlZ”oObjeù
<
R•Ütd©a
>();

677 
ASYLO_EXPECT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

679 
CodeId’t™y
 
	gid’t™y
;

680 
ASYLO_EXPECT_OK
(
P¬£Id’t™yFromH¬dw¬eR•Üt
(*
»pÜt
, &
id’t™y
));

681 
EXPECT_TRUE
(
¡d
::
equ®
(

682 
»pÜt
->
m»nşave
.
cbegš
(),„•Üt->m»nşave.
ûnd
(),

683 
id’t™y
.
m»nşave
().
hash
().
cbegš
(),

685 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

686 
EXPECT_TRUE
(
¡d
::
equ®
(

687 
»pÜt
->
mrsigÃr
.
cbegš
(),„•Üt->mrsigÃr.
ûnd
(),

688 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
().
cbegš
(),

690 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

691 
EXPECT_EQ
(
»pÜt
->
isv´odid
, 
id’t™y
.
sigÃr_assigÃd_id’t™y
().isvprodid());

692 
EXPECT_EQ
(
»pÜt
->
isvsvn
, 
id’t™y
.
sigÃr_assigÃd_id’t™y
().isvsvn());

694 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

695 
EXPECT_TRUE
(

696 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
id’t™y
.
©Œibu‹s
(), &attributes));

697 
EXPECT_EQ
(
»pÜt
->
©Œibu‹s
,‡ttributes);

698 
EXPECT_EQ
(
»pÜt
->
misc£Ëù
, 
id’t™y
.miscselect());

701 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘DeçuÉM©chS³c
) {

702 
CodeId’t™yM©chS³c
 
	g¥ec
;

703 
ASYLO_ASSERT_OK
(
S‘DeçuÉM©chS³c
(&
¥ec
));

704 
EXPECT_FALSE
(
¥ec
.
is_m»nşave_m©ch_»quœed
());

705 
EXPECT_TRUE
(
¥ec
.
is_mrsigÃr_m©ch_»quœed
());

706 
EXPECT_EQ
(
¥ec
.
misc£Ëù_m©ch_mask
(), 
kLÚgAÎF
);

707 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

708 
EXPECT_TRUE
(
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
©Œibu‹s
));

709 
A‰ribu‹s
 
	gdeçuÉ_©Œibu‹s_mask
;

710 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(~
©Œibu‹s
, &
deçuÉ_©Œibu‹s_mask
);

711 
EXPECT_EQ
(
¥ec
.
©Œibu‹s_m©ch_mask
(), 
deçuÉ_©Œibu‹s_mask
);

714 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SŒiùM©chS³c
) {

715 
CodeId’t™yM©chS³c
 
	g¥ec
;

716 
S‘SŒiùM©chS³c
(&
¥ec
);

717 
EXPECT_TRUE
(
¥ec
.
is_m»nşave_m©ch_»quœed
());

718 
EXPECT_TRUE
(
¥ec
.
is_mrsigÃr_m©ch_»quœed
());

719 
EXPECT_EQ
(
¥ec
.
misc£Ëù_m©ch_mask
(), 
kLÚgAÎF
);

721 
A‰ribu‹s
 
	gex³ùed_©Œibu‹s
;

722 
S‘SŒiùSecsA‰ribu‹sMask
(&
ex³ùed_©Œibu‹s
);

723 
EXPECT_EQ
(
¥ec
.
©Œibu‹s_m©ch_mask
(), 
ex³ùed_©Œibu‹s
);

726 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘S–fCodeId’t™y
) {

727 
CodeId’t™y
 
	gid’t™y
;

728 
S‘S–fCodeId’t™y
(&
id’t™y
);

729 
EXPECT_TRUE
(
¡d
::
equ®
(

730 
’şave_
->
g‘_m»nşave
().
cbegš
(),ƒnşave_->g‘_m»nşave().
ûnd
(),

731 
id’t™y
.
m»nşave
().
hash
().
cbegš
(),

733 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

734 
EXPECT_TRUE
(
¡d
::
equ®
(

735 
’şave_
->
g‘_mrsigÃr
().
cbegš
(),ƒnşave_->g‘_mrsigÃr().
ûnd
(),

736 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
().
cbegš
(),

738 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

739 
EXPECT_EQ
(
’şave_
->
g‘_isv´odid
(),

740 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isv´odid
());

741 
EXPECT_EQ
(
’şave_
->
g‘_isvsvn
(),

742 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isvsvn
());

744 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

745 
EXPECT_TRUE
(

746 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
id’t™y
.
©Œibu‹s
(), &attributes));

747 
EXPECT_EQ
(
’şave_
->
g‘_©Œibu‹s
(), 
©Œibu‹s
);

748 
EXPECT_EQ
(
’şave_
->
g‘_misc£Ëù
(), 
id’t™y
.
misc£Ëù
());

751 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
) {

752 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

753 
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
(&
ex³ù©iÚ
);

755 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

756 
S‘SŒiùM©chS³c
(&
m©ch_¥ec
);

758 
EXPECT_THAT
(
ex³ù©iÚ
.
»ã»nû_id’t™y
(),

759 
Equiv®’tPrÙo
(
G‘S–fId’t™y
()->
id’t™y
))

760 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
»ã»nû_id’t™y
())

761 << 
FÜm©PrÙo
(
G‘S–fId’t™y
()->
id’t™y
);

762 
EXPECT_THAT
(
ex³ù©iÚ
.
m©ch_¥ec
(), 
Equiv®’tPrÙo
(match_spec))

763 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
m©ch_¥ec
()) << FormatProto(match_spec);

766 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
) {

767 
CodeId’t™y
 
	gid’t™y
;

768 
S‘S–fCodeId’t™y
(&
id’t™y
);

770 
CodeId’t™yM©chS³c
 
	g¥ec
;

771 
ASYLO_EXPECT_OK
(
S‘DeçuÉM©chS³c
(&
¥ec
));

773 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

774 
ASYLO_EXPECT_OK
(
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
(&
ex³ù©iÚ
));

776 
EXPECT_THAT
(
ex³ù©iÚ
.
»ã»nû_id’t™y
(), 
Equiv®’tPrÙo
(
id’t™y
))

777 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
»ã»nû_id’t™y
()è<< FÜm©PrÙo(
id’t™y
);

778 
EXPECT_THAT
(
ex³ù©iÚ
.
m©ch_¥ec
(), 
Equiv®’tPrÙo
(
¥ec
))

779 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
m©ch_¥ec
()è<< FÜm©PrÙo(
¥ec
);

782 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxId’t™ySucûss
) {

783 
	gi
 = 0; i < 10000; i++) {

784 
EnşaveId’t™y
 
	gg’”ic_id’t™y
;

785 
CodeId’t™y
 
	gg’”©ed_sgx_id’t™y
;

786 
S‘RªdomV®idG’”icId’t™y
(&
g’”ic_id’t™y
, &
g’”©ed_sgx_id’t™y
);

787 
CodeId’t™y
 
	g·r£d_sgx_id’t™y
;

788 
ASYLO_ASSERT_OK
(
P¬£SgxId’t™y
(
g’”ic_id’t™y
, &
·r£d_sgx_id’t™y
));

789 
ASSERT_THAT
(
g’”©ed_sgx_id’t™y
, 
Equiv®’tPrÙo
(
·r£d_sgx_id’t™y
))

790 << 
FÜm©PrÙo
(
g’”©ed_sgx_id’t™y
)

791 << 
FÜm©PrÙo
(
·r£d_sgx_id’t™y
);

795 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxId’t™yFau»
) {

796 
	gi
 = 0; i < 10000; i++) {

797 
EnşaveId’t™y
 
	gg’”ic_id’t™y
;

798 
S‘RªdomInv®idG’”icId’t™y
(&
g’”ic_id’t™y
);

799 
CodeId’t™y
 
	g·r£d_sgx_id’t™y
;

800 
ASSERT_THAT
(
P¬£SgxId’t™y
(
g’”ic_id’t™y
, &
·r£d_sgx_id’t™y
),

801 
NÙ
(
IsOk
()));

805 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxM©chS³cSucûss
) {

806 
	g¡d
::
¡ršg
 
g’”ic_m©ch_¥ec
;

807 
CodeId’t™yM©chS³c
 
	gg’”©ed_sgx_¥ec
;

808 
CodeId’t™yM©chS³c
 
	g·r£d_sgx_¥ec
;

810 
	gi
 = 0; i < 10000; i++) {

811 
S‘RªdomV®idG’”icM©chS³c
(&
g’”ic_m©ch_¥ec
, &
g’”©ed_sgx_¥ec
);

812 
ASYLO_ASSERT_OK
(
P¬£SgxM©chS³c
(
g’”ic_m©ch_¥ec
, &
·r£d_sgx_¥ec
));

814 
ASSERT_THAT
(
g’”©ed_sgx_¥ec
, 
Equiv®’tPrÙo
(
·r£d_sgx_¥ec
))

815 << 
FÜm©PrÙo
(
·r£d_sgx_¥ec
è<< FÜm©PrÙo(
g’”©ed_sgx_¥ec
);

819 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxM©chS³cFau»
) {

820 
	g¡d
::
¡ršg
 
g’”ic_m©ch_¥ec
;

821 
CodeId’t™yM©chS³c
 
	g·r£d_sgx_¥ec
;

823 
	gi
 = 0; i < 10000; i++) {

824 
ASYLO_ASSERT_OK
(
S‘RªdomInv®idG’”icM©chS³c
(&
g’”ic_m©ch_¥ec
));

825 
ASSERT_THAT
(
P¬£SgxM©chS³c
(
g’”ic_m©ch_¥ec
, &
·r£d_sgx_¥ec
),

826 
NÙ
(
IsOk
()));

828 
	gg’”ic_m©ch_¥ec
 = 
kInv®idSŒšg
;

829 
EXPECT_THAT
(
P¬£SgxM©chS³c
(
g’”ic_m©ch_¥ec
, &
·r£d_sgx_¥ec
),

830 
NÙ
(
IsOk
()));

833 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxEx³ù©iÚSucûss
) {

834 
	gi
 = 0; i < 10000; i++) {

835 
EnşaveId’t™yEx³ù©iÚ
 
	gg’”ic_ex³ù©iÚ
;

836 
CodeId’t™yEx³ù©iÚ
 
	gg’”©ed_sgx_ex³ù©iÚ
;

838 
ASYLO_ASSERT_OK
(
S‘RªdomV®idG’”icEx³ù©iÚ
(

839 &
g’”ic_ex³ù©iÚ
, &
g’”©ed_sgx_ex³ù©iÚ
));

840 
CodeId’t™yEx³ù©iÚ
 
	g·r£d_sgx_ex³ù©iÚ
;

841 
ASYLO_ASSERT_OK
(

842 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, &
·r£d_sgx_ex³ù©iÚ
));

843 
ASSERT_THAT
(
g’”©ed_sgx_ex³ù©iÚ
,

844 
Equiv®’tPrÙo
(
·r£d_sgx_ex³ù©iÚ
))

845 << 
FÜm©PrÙo
(
g’”©ed_sgx_ex³ù©iÚ
)

846 << 
FÜm©PrÙo
(
·r£d_sgx_ex³ù©iÚ
);

850 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxEx³ù©iÚFau»
) {

851 
	gi
 = 0; i < 10000; i++) {

852 
EnşaveId’t™yEx³ù©iÚ
 
	gg’”ic_ex³ù©iÚ
;

854 
ASYLO_ASSERT_OK
(
S‘RªdomInv®idG’”icEx³ù©iÚ
(&
g’”ic_ex³ù©iÚ
));

855 
CodeId’t™yEx³ù©iÚ
 
	g·r£d_sgx_ex³ù©iÚ
;

856 
ASSERT_THAT
(

857 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, &
·r£d_sgx_ex³ù©iÚ
),

858 
NÙ
(
IsOk
()));

862 
TEST_F
(
CodeId’t™yUtTe¡
, 
S”ŸlizeAndP¬£SgxId’t™yEndToEnd
) {

863 
CodeId’t™y
 
	gg’”©ed_sgx_id’t™y
;

864 
EnşaveId’t™y
 
	gg’”ic_id’t™y
;

866 
EXPECT_THAT
(
S”ŸlizeSgxId’t™y
(
g’”©ed_sgx_id’t™y
, &
g’”ic_id’t™y
),

867 
NÙ
(
IsOk
()));

868 
	gg’”©ed_sgx_id’t™y
 = 
G‘RªdomV®idCodeId’t™y
();

869 
ASYLO_EXPECT_OK
(

870 
S”ŸlizeSgxId’t™y
(
g’”©ed_sgx_id’t™y
, &
g’”ic_id’t™y
));

871 
CodeId’t™y
 
	g·r£d_sgx_id’t™y
;

872 
ASYLO_ASSERT_OK
(
P¬£SgxId’t™y
(
g’”ic_id’t™y
, &
·r£d_sgx_id’t™y
));

873 
ASSERT_THAT
(
g’”©ed_sgx_id’t™y
, 
Equiv®’tPrÙo
(
·r£d_sgx_id’t™y
))

874 << 
FÜm©PrÙo
(
g’”©ed_sgx_id’t™y
)

875 << 
FÜm©PrÙo
(
·r£d_sgx_id’t™y
);

878 
TEST_F
(
CodeId’t™yUtTe¡
, 
S”ŸlizeAndP¬£SgxM©chS³cEndToEnd
) {

879 
CodeId’t™yM©chS³c
 
	gg’”©ed_sgx_¥ec
;

880 
	g¡d
::
¡ršg
 
g’”ic_¥ec
;

882 
EXPECT_THAT
(
S”ŸlizeSgxM©chS³c
(
g’”©ed_sgx_¥ec
, &
g’”ic_¥ec
),

883 
NÙ
(
IsOk
()));

884 
	gg’”©ed_sgx_¥ec
 = 
G‘RªdomV®idM©chS³c
();

885 
ASYLO_EXPECT_OK
(
S”ŸlizeSgxM©chS³c
(
g’”©ed_sgx_¥ec
, &
g’”ic_¥ec
));

886 
CodeId’t™yM©chS³c
 
	g·r£d_sgx_¥ec
;

887 
ASYLO_ASSERT_OK
(
P¬£SgxM©chS³c
(
g’”ic_¥ec
, &
·r£d_sgx_¥ec
));

888 
ASSERT_THAT
(
g’”©ed_sgx_¥ec
, 
Equiv®’tPrÙo
(
·r£d_sgx_¥ec
))

889 << 
FÜm©PrÙo
(
g’”©ed_sgx_¥ec
è<< FÜm©PrÙo(
·r£d_sgx_¥ec
);

892 
TEST_F
(
CodeId’t™yUtTe¡
, 
S”ŸlizeAndP¬£SgxEx³ù©iÚEndToEnd
) {

893 
CodeId’t™yEx³ù©iÚ
 
	gg’”©ed_sgx_ex³ù©iÚ
;

894 
EnşaveId’t™yEx³ù©iÚ
 
	gg’”ic_ex³ù©iÚ
;

896 
EXPECT_THAT
(

897 
S”ŸlizeSgxEx³ù©iÚ
(
g’”©ed_sgx_ex³ù©iÚ
, &
g’”ic_ex³ù©iÚ
),

898 
NÙ
(
IsOk
()));

899 
	gg’”©ed_sgx_ex³ù©iÚ
 = 
G‘RªdomV®idEx³ù©iÚ
();

900 
ASYLO_EXPECT_OK
(

901 
S”ŸlizeSgxEx³ù©iÚ
(
g’”©ed_sgx_ex³ù©iÚ
, &
g’”ic_ex³ù©iÚ
));

902 
CodeId’t™yEx³ù©iÚ
 
	g·r£d_sgx_ex³ù©iÚ
;

903 
ASYLO_ASSERT_OK
(

904 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, &
·r£d_sgx_ex³ù©iÚ
));

905 
ASSERT_THAT
(
g’”©ed_sgx_ex³ù©iÚ
,

906 
Equiv®’tPrÙo
(
·r£d_sgx_ex³ù©iÚ
))

907 << 
FÜm©PrÙo
(
g’”©ed_sgx_ex³ù©iÚ
)

908 << 
FÜm©PrÙo
(
·r£d_sgx_ex³ù©iÚ
);

911 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘T¬g‘šfoFromS–fId’t™y
) {

912 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

913 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

915 cÚ¡ 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
G‘S–fId’t™y
();

916 
EXPECT_EQ
(
tšfo
->
m—su»m’t
, 
£lf_id’t™y
->
m»nşave
);

917 
EXPECT_EQ
(
tšfo
->
©Œibu‹s
, 
£lf_id’t™y
->attributes);

918 
EXPECT_EQ
(
tšfo
->
misc£Ëù
, 
£lf_id’t™y
->miscselect);

919 
EXPECT_EQ
(
tšfo
->
»£rved1
,

920 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<(
tšfo
->
»£rved1
)>>());

921 
EXPECT_EQ
(
tšfo
->
»£rved2
,

922 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<(
tšfo
->
»£rved2
)>>());

925 
TEST_F
(
CodeId’t™yUtTe¡
, 
V”ifyH¬dw¬eR•ÜtPos™ive
) {

926 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

927 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

929 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

930 
AligÃdR•Ütd©aPŒ
 
	gd©a
;

931 *
	gd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

932 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
d©a
, 
»pÜt
.
g‘
()));

933 
ASYLO_EXPECT_OK
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
));

936 
TEST_F
(
CodeId’t™yUtTe¡
, 
V”ifyH¬dw¬eR•ÜtWrÚgT¬g‘
) {

937 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

938 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

939 
AligÃdR•Ütd©aPŒ
 
	gd©a
;

940 *
	gd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

943 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

944 
	gtšfo
->
	gm—su»m’t
[0] ^= 0xFFFF;

945 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
d©a
, 
»pÜt
.
g‘
()));

946 
EXPECT_THAT
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
NÙ
(
IsOk
()));

949 
TEST_F
(
CodeId’t™yUtTe¡
, 
V”ifyH¬dw¬eR•ÜtBadR•Üt
) {

950 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

951 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

953 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

954 
AligÃdR•Ütd©aPŒ
 
	gd©a
;

955 *
	gd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

956 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
d©a
, 
»pÜt
.
g‘
()));

958 
	g»pÜt
->
	gm»nşave
[0] ^= 0xFFFF;

959 
EXPECT_THAT
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
NÙ
(
IsOk
()));

	@identity/sgx/code_identity_util_test.cc

19 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/üy±o/ut/by‹s.h
"

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

28 
	~"asylo/id’t™y/desütiÚs.h
"

29 
	~"asylo/id’t™y/id’t™y.pb.h
"

30 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

31 
	~"asylo/id’t™y/sgx/©Œibu‹s_ut.h
"

32 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

34 
	~"asylo/id’t™y/sgx/code_id’t™y_‹¡_ut.h
"

35 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

36 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

37 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

38 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

39 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

40 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

41 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

42 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

43 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

44 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

45 
	~"asylo/ut/¡©us.h
"

46 
	~"asylo/ut/¡©usÜ.h
"

48 
Çme¥aû
 
	gasylo
 {

49 
Çme¥aû
 
	gsgx
 {

50 
	gÇme¥aû
 {

52 
	gusšg
 ::
‹¡šg
::
NÙ
;

54 
cÚ¡ex´
 
ušt32_t
 
	gkLÚgAÎ0
 = 0x0;

55 
cÚ¡ex´
 
ušt32_t
 
	gkLÚgAÎF
 = 0xFFFFFFFF;

56 
cÚ¡ex´
 
ušt32_t
 
	gkLÚgAÎ5
 = 0x55555555;

57 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎF
 = 0xFFFFFFFFFFFFFFFFULL;

58 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎA
 = 0xAAAAAAAAAAAAAAAAULL;

59 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎ5
 = 0x5555555555555555ULL;

60 
cÚ¡ex´
 
	gkInv®idSŒšg
[] = "Invalid String";

63 şas 
	cCodeId’t™yUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

64 
´Ùeùed
:

65 
S‘Up
(è
ov”ride
 {

66 
Sha256HashFromHexSŒšg
(

68 &
h_aûdçû_
);

69 
Sha256HashFromHexSŒšg
(

71 &
h_d—db“f_
);

72 
	g©Œibu‹s_®l_f_
.
£t_æags
(
kLÚgLÚgAÎF
);

73 
	g©Œibu‹s_®l_f_
.
£t_xäm
(
kLÚgLÚgAÎF
);

74 
	g©Œibu‹s_®l_5_
.
£t_æags
(
kLÚgLÚgAÎ5
);

75 
	g©Œibu‹s_®l_5_
.
£t_xäm
(
kLÚgLÚgAÎ5
);

76 
	g©Œibu‹s_®l_a_
.
£t_æags
(
kLÚgLÚgAÎA
);

77 
	g©Œibu‹s_®l_a_
.
£t_xäm
(
kLÚgLÚgAÎA
);

82 
	g’şave_
 = 
SšgËtÚ
<
FakeEnşave
, 
	gRªdomFakeEnşaveFaùÜy
>::
g‘
();

83 ià(
	gFakeEnşave
::
G‘Cu¼’tEnşave
(è=ğ
nuÎ±r
) {

84 
FakeEnşave
::
EÁ”Enşave
(*
’şave_
);

88 
SigÃrAssigÃdId’t™y
 
MakeSigÃrAssigÃdId’t™y
(

89 cÚ¡ 
Sha256HashPrÙo
 &
mrsigÃr
, 
ušt16_t
 
isv´odid
, ušt16_ˆ
isvsvn
) {

90 
SigÃrAssigÃdId’t™y
 
	gid
;

91 *
	gid
.
mubË_mrsigÃr
(èğ
mrsigÃr
;

92 
	gid
.
£t_isv´odid
(
isv´odid
);

93 
	gid
.
£t_isvsvn
(
isvsvn
);

94  
	gid
;

97 
CodeId’t™y
 
G‘Mšim®V®idCodeId’t™y
(
ušt32_t
 
misc£Ëù
,

98 cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
) {

99 
CodeId’t™y
 
	gid
;

100 
	gid
.
£t_misc£Ëù
(
misc£Ëù
);

101 *
	gid
.
mubË_©Œibu‹s
(èğ
©Œibu‹s
;

102 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isv´odid
(0);

103 
	gid
.
mubË_sigÃr_assigÃd_id’t™y
()->
£t_isvsvn
(0);

104  
	gid
;

107 
Sha256HashPrÙo
 
	gh_aûdçû_
;

108 
Sha256HashPrÙo
 
	gh_d—db“f_
;

109 
A‰ribu‹s
 
	g©Œibu‹s_®l_0_
;

110 
A‰ribu‹s
 
	g©Œibu‹s_®l_f_
;

111 
A‰ribu‹s
 
	g©Œibu‹s_®l_5_
;

112 
A‰ribu‹s
 
	g©Œibu‹s_®l_a_
;

113 
FakeEnşave
 *
	g’şave_
;

116 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SgxId’t™yDesütiÚ
) {

117 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

118 
S‘SgxId’t™yDesütiÚ
(&
desütiÚ
);

120 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

121 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kSgxAuthÜiz©iÚAuthÜ™y
);

124 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SgxLoÿlAs£¹iÚDesütiÚ
) {

125 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

126 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
desütiÚ
);

128 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

129 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kSgxLoÿlAs£¹iÚAuthÜ™y
);

132 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SgxRemÙeAs£¹iÚDesütiÚ
) {

133 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

134 
S‘SgxRemÙeAs£¹iÚDesütiÚ
(&
desütiÚ
);

136 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

137 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
kSgxRemÙeAs£¹iÚAuthÜ™y
);

142 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yPos™ive1
) {

143 
SigÃrAssigÃdId’t™y
 
	gid
 = 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

144 
EXPECT_TRUE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

147 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yPos™ive2
) {

148 
SigÃrAssigÃdId’t™y
 
	gid
;

149 
	gid
.
£t_isv´odid
(0);

150 
	gid
.
£t_isvsvn
(0);

151 
EXPECT_TRUE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

154 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yNeg©ive1
) {

155 
SigÃrAssigÃdId’t™y
 
	gid
;

156 *
	gid
.
mubË_mrsigÃr
(èğ
h_aûdçû_
;

157 
	gid
.
£t_isvsvn
(0);

158 
EXPECT_FALSE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

161 
TEST_F
(
CodeId’t™yUtTe¡
, 
SigÃrAssigÃdId’t™yV®id™yNeg©ive2
) {

162 
SigÃrAssigÃdId’t™y
 
	gid
;

163 *
	gid
.
mubË_mrsigÃr
(èğ
h_aûdçû_
;

164 
	gid
.
£t_isv´odid
(0);

165 
EXPECT_FALSE
(
IsV®idSigÃrAssigÃdId’t™y
(
id
));

170 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yPos™ive1
) {

171 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

172 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

173 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

174 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

175 
EXPECT_TRUE
(
IsV®idCodeId’t™y
(
id
));

178 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yPos™ive2
) {

179 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

180 
EXPECT_TRUE
(
IsV®idCodeId’t™y
(
id
));

183 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yNeg©ive1
) {

184 
CodeId’t™y
 
	gid
;

185 
EXPECT_FALSE
(
IsV®idCodeId’t™y
(
id
));

188 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yNeg©ive2
) {

189 
CodeId’t™y
 
	gid
;

190 
	gid
.
£t_misc£Ëù
(
kLÚgAÎ5
);

191 
EXPECT_FALSE
(
IsV®idCodeId’t™y
(
id
));

194 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yV®id™yNeg©ive3
) {

195 
CodeId’t™y
 
	gid
;

196 *
	gid
.
mubË_©Œibu‹s
(èğ
©Œibu‹s_®l_5_
;

197 
EXPECT_FALSE
(
IsV®idCodeId’t™y
(
id
));

202 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yPos™ive
) {

203 
CodeId’t™yM©chS³c
 
	g¥ec
;

204 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

205 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

206 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

207 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

208 
EXPECT_TRUE
(
IsV®idM©chS³c
(
¥ec
));

211 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive1
) {

212 
CodeId’t™yM©chS³c
 
	g¥ec
;

213 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

214 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

215 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

216 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

219 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive2
) {

220 
CodeId’t™yM©chS³c
 
	g¥ec
;

221 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

222 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

223 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

224 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

227 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive3
) {

228 
CodeId’t™yM©chS³c
 
	g¥ec
;

229 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

230 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

231 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

232 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

235 
TEST_F
(
CodeId’t™yUtTe¡
, 
M©chS³cV®id™yNeg©ive4
) {

236 
CodeId’t™yM©chS³c
 
	g¥ec
;

237 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

238 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

239 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

240 
EXPECT_FALSE
(
IsV®idM©chS³c
(
¥ec
));

245 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive1
) {

246 
CodeId’t™yM©chS³c
 
	g¥ec
;

247 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

248 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

249 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

250 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

252 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

253 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

254 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

255 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

257 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

258 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

259 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

262 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive2
) {

263 
CodeId’t™yM©chS³c
 
	g¥ec
;

264 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

265 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

266 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

267 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

269 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

270 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

271 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

273 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

274 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

275 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

278 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive3
) {

279 
CodeId’t™yM©chS³c
 
	g¥ec
;

280 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

281 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

282 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

283 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

285 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

286 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

288 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

289 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

290 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

293 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yPos™ive4
) {

294 
CodeId’t™yM©chS³c
 
	g¥ec
;

295 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

296 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

297 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

298 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

300 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

301 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

302 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

303 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

305 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

306 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

307 
EXPECT_TRUE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

310 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yNeg©ive1
) {

311 
CodeId’t™yM©chS³c
 
	g¥ec
;

312 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

313 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

314 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

315 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

317 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

318 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

319 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

321 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

322 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

323 
EXPECT_FALSE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

326 
TEST_F
(
CodeId’t™yUtTe¡
, 
Ex³ù©iÚV®id™yNeg©ive2
) {

327 
CodeId’t™yM©chS³c
 
	g¥ec
;

328 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

329 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

330 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

331 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

333 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

334 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

336 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

337 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

338 
EXPECT_FALSE
(
IsV®idEx³ù©iÚ
(
ex³ù©iÚ
));

345 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yS–fM©ch
) {

346 
CodeId’t™yM©chS³c
 
	g¥ec
;

347 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

348 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

349 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

350 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

352 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

353 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

354 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

355 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

357 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

358 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

360 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

361 
ASYLO_ASSERT_OK
(
»suÉ
);

362 
EXPECT_TRUE
(
»suÉ
.
V®ueOrD›
());

367 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yDifãršgDoNÙC¬eF›lds
) {

368 
CodeId’t™yM©chS³c
 
	g¥ec
;

369 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

370 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

371 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

372 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

374 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

375 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

376 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

377 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

379 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

380 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

382 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

383 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

384 
ASYLO_ASSERT_OK
(
»suÉ
);

385 
EXPECT_TRUE
(
»suÉ
.
V®ueOrD›
());

390 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yMrEnşaveMism©ch
) {

391 
CodeId’t™yM©chS³c
 
	g¥ec
;

392 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

393 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

394 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

395 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

397 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

398 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

399 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

400 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

402 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

403 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

405 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

406 *
	gid
.
mubË_m»nşave
(èğ
h_d—db“f_
;

407 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

408 
ASYLO_ASSERT_OK
(
»suÉ
);

409 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

415 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™yMism©ch1
) {

416 
CodeId’t™yM©chS³c
 
	g¥ec
;

417 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

418 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

419 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

420 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

422 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

423 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

424 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

425 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

427 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

428 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

430 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

431 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

432 
MakeSigÃrAssigÃdId’t™y
(
h_d—db“f_
, 0, 0);

433 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

434 
ASYLO_ASSERT_OK
(
»suÉ
);

435 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

441 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™yMism©ch2
) {

442 
CodeId’t™yM©chS³c
 
	g¥ec
;

443 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

444 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

445 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

446 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

448 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

449 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

450 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

451 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

453 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

454 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

456 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

457 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

458 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 1, 0);

459 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

460 
ASYLO_ASSERT_OK
(
»suÉ
);

461 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

465 
	gex³ù©iÚ
.
mubË_m©ch_¥ec
()->
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

466 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

467 
ASYLO_ASSERT_OK
(
»suÉ
);

468 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

474 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™yMism©ch3
) {

475 
CodeId’t™yM©chS³c
 
	g¥ec
;

476 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

477 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

478 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

479 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

481 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

482 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

483 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

484 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 1);

486 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

487 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

489 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

490 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

491 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

492 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

493 
ASYLO_ASSERT_OK
(
»suÉ
);

494 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

498 
	gex³ù©iÚ
.
mubË_m©ch_¥ec
()->
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

499 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

500 
ASYLO_ASSERT_OK
(
»suÉ
);

501 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

507 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™ySigÃrAssigÃdId’t™ySVNM©ch
) {

508 
CodeId’t™yM©chS³c
 
	g¥ec
;

509 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

510 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

511 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

512 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

514 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

515 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

516 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

517 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

519 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

520 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

522 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_f_
);

523 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

524 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 1);

525 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

526 
ASYLO_ASSERT_OK
(
»suÉ
);

527 
EXPECT_TRUE
(
»suÉ
.
V®ueOrD›
());

532 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yMiscS–eùMism©ch
) {

533 
CodeId’t™yM©chS³c
 
	g¥ec
;

534 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

535 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

536 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

537 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

539 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

540 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

541 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

542 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

544 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

545 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

547 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ0
, 
©Œibu‹s_®l_f_
);

548 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

549 
ASYLO_ASSERT_OK
(
»suÉ
);

550 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

555 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yA‰ribu‹sMism©ch
) {

556 
CodeId’t™yM©chS³c
 
	g¥ec
;

557 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
çl£
);

558 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

559 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎ5
);

560 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_5_
;

562 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

563 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

564 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

565 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

567 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

568 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

570 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎF
, 
©Œibu‹s_®l_0_
);

571 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

572 
ASYLO_ASSERT_OK
(
»suÉ
);

573 
EXPECT_FALSE
(
»suÉ
.
V®ueOrD›
());

578 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chInv®idEx³ù©iÚ
) {

579 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

580 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

581 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

582 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

584 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

585 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

586 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

587 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

593 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chInv®idId’t™y
) {

594 
CodeId’t™yM©chS³c
 
	g¥ec
;

595 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

596 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

597 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

598 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

600 
CodeId’t™y
 
	gid
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

601 *
	gid
.
mubË_m»nşave
(èğ
h_aûdçû_
;

602 *
	gid
.
mubË_sigÃr_assigÃd_id’t™y
() =

603 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

605 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

606 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id
, &
ex³ù©iÚ
));

608 
	gid
.
CË¬
();

609 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id
, 
ex³ù©iÚ
);

610 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

611 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

618 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chId’t™yMissšgM»nşave
) {

619 
CodeId’t™yM©chS³c
 
	g¥ec
;

620 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

621 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

622 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

623 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

625 
CodeId’t™y
 
	gid1
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

626 *
	gid1
.
mubË_m»nşave
(èğ
h_aûdçû_
;

627 *
	gid1
.
mubË_sigÃr_assigÃd_id’t™y
() =

628 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

630 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

631 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id1
, &
ex³ù©iÚ
));

633 
CodeId’t™y
 
	gid2
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

634 *
	gid2
.
mubË_sigÃr_assigÃd_id’t™y
() =

635 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

637 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id2
, 
ex³ù©iÚ
);

638 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

639 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

645 
TEST_F
(
CodeId’t™yUtTe¡
, 
CodeId’t™yM©chId’t™yMissšgMrsigÃr
) {

646 
CodeId’t™yM©chS³c
 
	g¥ec
;

647 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

648 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
Œue
);

649 
	g¥ec
.
£t_misc£Ëù_m©ch_mask
(
kLÚgAÎF
);

650 *
	g¥ec
.
mubË_©Œibu‹s_m©ch_mask
(èğ
©Œibu‹s_®l_f_
;

652 
CodeId’t™y
 
	gid1
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

653 *
	gid1
.
mubË_m»nşave
(èğ
h_aûdçû_
;

654 *
	gid1
.
mubË_sigÃr_assigÃd_id’t™y
() =

655 
MakeSigÃrAssigÃdId’t™y
(
h_aûdçû_
, 0, 0);

657 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

658 
ASYLO_EXPECT_OK
(
S‘Ex³ù©iÚ
(
¥ec
, 
id1
, &
ex³ù©iÚ
));

660 
CodeId’t™y
 
	gid2
 = 
G‘Mšim®V®idCodeId’t™y
(
kLÚgAÎ5
, 
©Œibu‹s_®l_5_
);

661 *
	gid2
.
mubË_m»nşave
(èğ
h_aûdçû_
;

663 
	gStusOr
<
	gboŞ
> 
	g»suÉ
 = 
M©chId’t™yToEx³ù©iÚ
(
id2
, 
ex³ù©iÚ
);

664 
EXPECT_EQ
(
»suÉ
.
¡©us
(),

665 
Stus
(::
asylo
::
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

669 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£Id’t™yFromH¬dw¬eR•Üt
) {

670 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

671 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

672 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

674 *
	gtšfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

675 *
	g»pÜtd©a
 = 
TrivŸlZ”oObjeù
<
R•Ütd©a
>();

677 
ASYLO_EXPECT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

679 
CodeId’t™y
 
	gid’t™y
;

680 
ASYLO_EXPECT_OK
(
P¬£Id’t™yFromH¬dw¬eR•Üt
(*
»pÜt
, &
id’t™y
));

681 
EXPECT_TRUE
(
¡d
::
equ®
(

682 
»pÜt
->
m»nşave
.
cbegš
(),„•Üt->m»nşave.
ûnd
(),

683 
id’t™y
.
m»nşave
().
hash
().
cbegš
(),

685 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

686 
EXPECT_TRUE
(
¡d
::
equ®
(

687 
»pÜt
->
mrsigÃr
.
cbegš
(),„•Üt->mrsigÃr.
ûnd
(),

688 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
().
cbegš
(),

690 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

691 
EXPECT_EQ
(
»pÜt
->
isv´odid
, 
id’t™y
.
sigÃr_assigÃd_id’t™y
().isvprodid());

692 
EXPECT_EQ
(
»pÜt
->
isvsvn
, 
id’t™y
.
sigÃr_assigÃd_id’t™y
().isvsvn());

694 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

695 
EXPECT_TRUE
(

696 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
id’t™y
.
©Œibu‹s
(), &attributes));

697 
EXPECT_EQ
(
»pÜt
->
©Œibu‹s
,‡ttributes);

698 
EXPECT_EQ
(
»pÜt
->
misc£Ëù
, 
id’t™y
.miscselect());

701 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘DeçuÉM©chS³c
) {

702 
CodeId’t™yM©chS³c
 
	g¥ec
;

703 
ASYLO_ASSERT_OK
(
S‘DeçuÉM©chS³c
(&
¥ec
));

704 
EXPECT_FALSE
(
¥ec
.
is_m»nşave_m©ch_»quœed
());

705 
EXPECT_TRUE
(
¥ec
.
is_mrsigÃr_m©ch_»quœed
());

706 
EXPECT_EQ
(
¥ec
.
misc£Ëù_m©ch_mask
(), 
kLÚgAÎF
);

707 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

708 
EXPECT_TRUE
(
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
©Œibu‹s
));

709 
A‰ribu‹s
 
	gdeçuÉ_©Œibu‹s_mask
;

710 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(~
©Œibu‹s
, &
deçuÉ_©Œibu‹s_mask
);

711 
EXPECT_EQ
(
¥ec
.
©Œibu‹s_m©ch_mask
(), 
deçuÉ_©Œibu‹s_mask
);

714 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SŒiùM©chS³c
) {

715 
CodeId’t™yM©chS³c
 
	g¥ec
;

716 
S‘SŒiùM©chS³c
(&
¥ec
);

717 
EXPECT_TRUE
(
¥ec
.
is_m»nşave_m©ch_»quœed
());

718 
EXPECT_TRUE
(
¥ec
.
is_mrsigÃr_m©ch_»quœed
());

719 
EXPECT_EQ
(
¥ec
.
misc£Ëù_m©ch_mask
(), 
kLÚgAÎF
);

721 
A‰ribu‹s
 
	gex³ùed_©Œibu‹s
;

722 
S‘SŒiùSecsA‰ribu‹sMask
(&
ex³ùed_©Œibu‹s
);

723 
EXPECT_EQ
(
¥ec
.
©Œibu‹s_m©ch_mask
(), 
ex³ùed_©Œibu‹s
);

726 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘S–fCodeId’t™y
) {

727 
CodeId’t™y
 
	gid’t™y
;

728 
S‘S–fCodeId’t™y
(&
id’t™y
);

729 
EXPECT_TRUE
(
¡d
::
equ®
(

730 
’şave_
->
g‘_m»nşave
().
cbegš
(),ƒnşave_->g‘_m»nşave().
ûnd
(),

731 
id’t™y
.
m»nşave
().
hash
().
cbegš
(),

733 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

734 
EXPECT_TRUE
(
¡d
::
equ®
(

735 
’şave_
->
g‘_mrsigÃr
().
cbegš
(),ƒnşave_->g‘_mrsigÃr().
ûnd
(),

736 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
().
cbegš
(),

738 [](cÚ¡ 
ušt8_t
 
a
, cÚ¡ 
b
) { ‡ == b; }));

739 
EXPECT_EQ
(
’şave_
->
g‘_isv´odid
(),

740 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isv´odid
());

741 
EXPECT_EQ
(
’şave_
->
g‘_isvsvn
(),

742 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isvsvn
());

744 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

745 
EXPECT_TRUE
(

746 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
id’t™y
.
©Œibu‹s
(), &attributes));

747 
EXPECT_EQ
(
’şave_
->
g‘_©Œibu‹s
(), 
©Œibu‹s
);

748 
EXPECT_EQ
(
’şave_
->
g‘_misc£Ëù
(), 
id’t™y
.
misc£Ëù
());

751 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
) {

752 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

753 
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
(&
ex³ù©iÚ
);

755 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

756 
S‘SŒiùM©chS³c
(&
m©ch_¥ec
);

758 
EXPECT_THAT
(
ex³ù©iÚ
.
»ã»nû_id’t™y
(),

759 
Equiv®’tPrÙo
(
G‘S–fId’t™y
()->
id’t™y
))

760 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
»ã»nû_id’t™y
())

761 << 
FÜm©PrÙo
(
G‘S–fId’t™y
()->
id’t™y
);

762 
EXPECT_THAT
(
ex³ù©iÚ
.
m©ch_¥ec
(), 
Equiv®’tPrÙo
(match_spec))

763 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
m©ch_¥ec
()) << FormatProto(match_spec);

766 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
) {

767 
CodeId’t™y
 
	gid’t™y
;

768 
S‘S–fCodeId’t™y
(&
id’t™y
);

770 
CodeId’t™yM©chS³c
 
	g¥ec
;

771 
ASYLO_EXPECT_OK
(
S‘DeçuÉM©chS³c
(&
¥ec
));

773 
CodeId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

774 
ASYLO_EXPECT_OK
(
S‘DeçuÉS–fCodeId’t™yEx³ù©iÚ
(&
ex³ù©iÚ
));

776 
EXPECT_THAT
(
ex³ù©iÚ
.
»ã»nû_id’t™y
(), 
Equiv®’tPrÙo
(
id’t™y
))

777 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
»ã»nû_id’t™y
()è<< FÜm©PrÙo(
id’t™y
);

778 
EXPECT_THAT
(
ex³ù©iÚ
.
m©ch_¥ec
(), 
Equiv®’tPrÙo
(
¥ec
))

779 << 
FÜm©PrÙo
(
ex³ù©iÚ
.
m©ch_¥ec
()è<< FÜm©PrÙo(
¥ec
);

782 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxId’t™ySucûss
) {

783 
	gi
 = 0; i < 10000; i++) {

784 
EnşaveId’t™y
 
	gg’”ic_id’t™y
;

785 
CodeId’t™y
 
	gg’”©ed_sgx_id’t™y
;

786 
S‘RªdomV®idG’”icId’t™y
(&
g’”ic_id’t™y
, &
g’”©ed_sgx_id’t™y
);

787 
CodeId’t™y
 
	g·r£d_sgx_id’t™y
;

788 
ASYLO_ASSERT_OK
(
P¬£SgxId’t™y
(
g’”ic_id’t™y
, &
·r£d_sgx_id’t™y
));

789 
ASSERT_THAT
(
g’”©ed_sgx_id’t™y
, 
Equiv®’tPrÙo
(
·r£d_sgx_id’t™y
))

790 << 
FÜm©PrÙo
(
g’”©ed_sgx_id’t™y
)

791 << 
FÜm©PrÙo
(
·r£d_sgx_id’t™y
);

795 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxId’t™yFau»
) {

796 
	gi
 = 0; i < 10000; i++) {

797 
EnşaveId’t™y
 
	gg’”ic_id’t™y
;

798 
S‘RªdomInv®idG’”icId’t™y
(&
g’”ic_id’t™y
);

799 
CodeId’t™y
 
	g·r£d_sgx_id’t™y
;

800 
ASSERT_THAT
(
P¬£SgxId’t™y
(
g’”ic_id’t™y
, &
·r£d_sgx_id’t™y
),

801 
NÙ
(
IsOk
()));

805 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxM©chS³cSucûss
) {

806 
	g¡d
::
¡ršg
 
g’”ic_m©ch_¥ec
;

807 
CodeId’t™yM©chS³c
 
	gg’”©ed_sgx_¥ec
;

808 
CodeId’t™yM©chS³c
 
	g·r£d_sgx_¥ec
;

810 
	gi
 = 0; i < 10000; i++) {

811 
S‘RªdomV®idG’”icM©chS³c
(&
g’”ic_m©ch_¥ec
, &
g’”©ed_sgx_¥ec
);

812 
ASYLO_ASSERT_OK
(
P¬£SgxM©chS³c
(
g’”ic_m©ch_¥ec
, &
·r£d_sgx_¥ec
));

814 
ASSERT_THAT
(
g’”©ed_sgx_¥ec
, 
Equiv®’tPrÙo
(
·r£d_sgx_¥ec
))

815 << 
FÜm©PrÙo
(
·r£d_sgx_¥ec
è<< FÜm©PrÙo(
g’”©ed_sgx_¥ec
);

819 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxM©chS³cFau»
) {

820 
	g¡d
::
¡ršg
 
g’”ic_m©ch_¥ec
;

821 
CodeId’t™yM©chS³c
 
	g·r£d_sgx_¥ec
;

823 
	gi
 = 0; i < 10000; i++) {

824 
ASYLO_ASSERT_OK
(
S‘RªdomInv®idG’”icM©chS³c
(&
g’”ic_m©ch_¥ec
));

825 
ASSERT_THAT
(
P¬£SgxM©chS³c
(
g’”ic_m©ch_¥ec
, &
·r£d_sgx_¥ec
),

826 
NÙ
(
IsOk
()));

828 
	gg’”ic_m©ch_¥ec
 = 
kInv®idSŒšg
;

829 
EXPECT_THAT
(
P¬£SgxM©chS³c
(
g’”ic_m©ch_¥ec
, &
·r£d_sgx_¥ec
),

830 
NÙ
(
IsOk
()));

833 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxEx³ù©iÚSucûss
) {

834 
	gi
 = 0; i < 10000; i++) {

835 
EnşaveId’t™yEx³ù©iÚ
 
	gg’”ic_ex³ù©iÚ
;

836 
CodeId’t™yEx³ù©iÚ
 
	gg’”©ed_sgx_ex³ù©iÚ
;

838 
ASYLO_ASSERT_OK
(
S‘RªdomV®idG’”icEx³ù©iÚ
(

839 &
g’”ic_ex³ù©iÚ
, &
g’”©ed_sgx_ex³ù©iÚ
));

840 
CodeId’t™yEx³ù©iÚ
 
	g·r£d_sgx_ex³ù©iÚ
;

841 
ASYLO_ASSERT_OK
(

842 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, &
·r£d_sgx_ex³ù©iÚ
));

843 
ASSERT_THAT
(
g’”©ed_sgx_ex³ù©iÚ
,

844 
Equiv®’tPrÙo
(
·r£d_sgx_ex³ù©iÚ
))

845 << 
FÜm©PrÙo
(
g’”©ed_sgx_ex³ù©iÚ
)

846 << 
FÜm©PrÙo
(
·r£d_sgx_ex³ù©iÚ
);

850 
TEST_F
(
CodeId’t™yUtTe¡
, 
P¬£SgxEx³ù©iÚFau»
) {

851 
	gi
 = 0; i < 10000; i++) {

852 
EnşaveId’t™yEx³ù©iÚ
 
	gg’”ic_ex³ù©iÚ
;

854 
ASYLO_ASSERT_OK
(
S‘RªdomInv®idG’”icEx³ù©iÚ
(&
g’”ic_ex³ù©iÚ
));

855 
CodeId’t™yEx³ù©iÚ
 
	g·r£d_sgx_ex³ù©iÚ
;

856 
ASSERT_THAT
(

857 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, &
·r£d_sgx_ex³ù©iÚ
),

858 
NÙ
(
IsOk
()));

862 
TEST_F
(
CodeId’t™yUtTe¡
, 
S”ŸlizeAndP¬£SgxId’t™yEndToEnd
) {

863 
CodeId’t™y
 
	gg’”©ed_sgx_id’t™y
;

864 
EnşaveId’t™y
 
	gg’”ic_id’t™y
;

866 
EXPECT_THAT
(
S”ŸlizeSgxId’t™y
(
g’”©ed_sgx_id’t™y
, &
g’”ic_id’t™y
),

867 
NÙ
(
IsOk
()));

868 
	gg’”©ed_sgx_id’t™y
 = 
G‘RªdomV®idCodeId’t™y
();

869 
ASYLO_EXPECT_OK
(

870 
S”ŸlizeSgxId’t™y
(
g’”©ed_sgx_id’t™y
, &
g’”ic_id’t™y
));

871 
CodeId’t™y
 
	g·r£d_sgx_id’t™y
;

872 
ASYLO_ASSERT_OK
(
P¬£SgxId’t™y
(
g’”ic_id’t™y
, &
·r£d_sgx_id’t™y
));

873 
ASSERT_THAT
(
g’”©ed_sgx_id’t™y
, 
Equiv®’tPrÙo
(
·r£d_sgx_id’t™y
))

874 << 
FÜm©PrÙo
(
g’”©ed_sgx_id’t™y
)

875 << 
FÜm©PrÙo
(
·r£d_sgx_id’t™y
);

878 
TEST_F
(
CodeId’t™yUtTe¡
, 
S”ŸlizeAndP¬£SgxM©chS³cEndToEnd
) {

879 
CodeId’t™yM©chS³c
 
	gg’”©ed_sgx_¥ec
;

880 
	g¡d
::
¡ršg
 
g’”ic_¥ec
;

882 
EXPECT_THAT
(
S”ŸlizeSgxM©chS³c
(
g’”©ed_sgx_¥ec
, &
g’”ic_¥ec
),

883 
NÙ
(
IsOk
()));

884 
	gg’”©ed_sgx_¥ec
 = 
G‘RªdomV®idM©chS³c
();

885 
ASYLO_EXPECT_OK
(
S”ŸlizeSgxM©chS³c
(
g’”©ed_sgx_¥ec
, &
g’”ic_¥ec
));

886 
CodeId’t™yM©chS³c
 
	g·r£d_sgx_¥ec
;

887 
ASYLO_ASSERT_OK
(
P¬£SgxM©chS³c
(
g’”ic_¥ec
, &
·r£d_sgx_¥ec
));

888 
ASSERT_THAT
(
g’”©ed_sgx_¥ec
, 
Equiv®’tPrÙo
(
·r£d_sgx_¥ec
))

889 << 
FÜm©PrÙo
(
g’”©ed_sgx_¥ec
è<< FÜm©PrÙo(
·r£d_sgx_¥ec
);

892 
TEST_F
(
CodeId’t™yUtTe¡
, 
S”ŸlizeAndP¬£SgxEx³ù©iÚEndToEnd
) {

893 
CodeId’t™yEx³ù©iÚ
 
	gg’”©ed_sgx_ex³ù©iÚ
;

894 
EnşaveId’t™yEx³ù©iÚ
 
	gg’”ic_ex³ù©iÚ
;

896 
EXPECT_THAT
(

897 
S”ŸlizeSgxEx³ù©iÚ
(
g’”©ed_sgx_ex³ù©iÚ
, &
g’”ic_ex³ù©iÚ
),

898 
NÙ
(
IsOk
()));

899 
	gg’”©ed_sgx_ex³ù©iÚ
 = 
G‘RªdomV®idEx³ù©iÚ
();

900 
ASYLO_EXPECT_OK
(

901 
S”ŸlizeSgxEx³ù©iÚ
(
g’”©ed_sgx_ex³ù©iÚ
, &
g’”ic_ex³ù©iÚ
));

902 
CodeId’t™yEx³ù©iÚ
 
	g·r£d_sgx_ex³ù©iÚ
;

903 
ASYLO_ASSERT_OK
(

904 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, &
·r£d_sgx_ex³ù©iÚ
));

905 
ASSERT_THAT
(
g’”©ed_sgx_ex³ù©iÚ
,

906 
Equiv®’tPrÙo
(
·r£d_sgx_ex³ù©iÚ
))

907 << 
FÜm©PrÙo
(
g’”©ed_sgx_ex³ù©iÚ
)

908 << 
FÜm©PrÙo
(
·r£d_sgx_ex³ù©iÚ
);

911 
TEST_F
(
CodeId’t™yUtTe¡
, 
S‘T¬g‘šfoFromS–fId’t™y
) {

912 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

913 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

915 cÚ¡ 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
G‘S–fId’t™y
();

916 
EXPECT_EQ
(
tšfo
->
m—su»m’t
, 
£lf_id’t™y
->
m»nşave
);

917 
EXPECT_EQ
(
tšfo
->
©Œibu‹s
, 
£lf_id’t™y
->attributes);

918 
EXPECT_EQ
(
tšfo
->
misc£Ëù
, 
£lf_id’t™y
->miscselect);

919 
EXPECT_EQ
(
tšfo
->
»£rved1
,

920 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<(
tšfo
->
»£rved1
)>>());

921 
EXPECT_EQ
(
tšfo
->
»£rved2
,

922 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<(
tšfo
->
»£rved2
)>>());

925 
TEST_F
(
CodeId’t™yUtTe¡
, 
V”ifyH¬dw¬eR•ÜtPos™ive
) {

926 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

927 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

929 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

930 
AligÃdR•Ütd©aPŒ
 
	gd©a
;

931 *
	gd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

932 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
d©a
, 
»pÜt
.
g‘
()));

933 
ASYLO_EXPECT_OK
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
));

936 
TEST_F
(
CodeId’t™yUtTe¡
, 
V”ifyH¬dw¬eR•ÜtWrÚgT¬g‘
) {

937 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

938 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

939 
AligÃdR•Ütd©aPŒ
 
	gd©a
;

940 *
	gd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

943 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

944 
	gtšfo
->
	gm—su»m’t
[0] ^= 0xFFFF;

945 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
d©a
, 
»pÜt
.
g‘
()));

946 
EXPECT_THAT
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
NÙ
(
IsOk
()));

949 
TEST_F
(
CodeId’t™yUtTe¡
, 
V”ifyH¬dw¬eR•ÜtBadR•Üt
) {

950 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

951 
S‘T¬g‘šfoFromS–fId’t™y
(
tšfo
.
g‘
());

953 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

954 
AligÃdR•Ütd©aPŒ
 
	gd©a
;

955 *
	gd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

956 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
d©a
, 
»pÜt
.
g‘
()));

958 
	g»pÜt
->
	gm»nşave
[0] ^= 0xFFFF;

959 
EXPECT_THAT
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
NÙ
(
IsOk
()));

	@identity/sgx/dcap_intel_architectural_enclave_interface.cc

19 
	~"asylo/id’t™y/sgx/dÿp_š‹l_¬ch™eùu¿l_’şave_š‹rçû.h
"

21 
	~<veùÜ
>

23 
	~"šşude/sgx_key.h
"

24 
	~"šşude/sgx_»pÜt.h
"

25 
	~"QuÙeG’”©iÚ/psw/pû_w¿µ”/šc/sgx_pû.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

29 
	gÇme¥aû
 {

31 
Stus
 
PûE¼ÜToStus
(
sgx_pû_”rÜ_t
 
pû_”rÜ
) {

32 
	gpû_”rÜ
) {

33 
	gSGX_PCE_SUCCESS
:

34  
Stus
::
OkStus
();

35 
	gSGX_PCE_UNEXPECTED
:

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unexpectedƒrror");

37 
	gSGX_PCE_OUT_OF_EPC
:

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

40 
	gSGX_PCE_INTERFACE_UNAVAILABLE
:

41  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Interface unavailable");

42 
	gSGX_PCE_CRYPTO_ERROR
:

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

45 
	gSGX_PCE_INVALID_PARAMETER
:

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid…arameter");

47 
	gSGX_PCE_INVALID_REPORT
:

48  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid„eport");

49 
	gSGX_PCE_INVALID_TCB
:

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid TCB");

51 
	gSGX_PCE_INVALID_PRIVILEGE
:

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "Unknownƒrror");

61 
Stus
 
	gDÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
::
G‘PûT¬g‘šfo
(

62 
T¬g‘šfo
 *
rg‘šfo
, 
ušt16_t
 *
pû_svn
) {

63 
¡©ic_as£¹
(

64 (
T¬g‘šfo
è=ğ(
sgx_rg‘_šfo_t
),

67 
sgx_pû_”rÜ_t
 
	g»suÉ
 = 
sgx_pû_g‘_rg‘
(

68 
»š‹½»t_ÿ¡
<
sgx_rg‘_šfo_t
 *>(
rg‘šfo
), 
pû_svn
);

70  
PûE¼ÜToStus
(
»suÉ
);

73 
Stus
 
	gDÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
::
G‘PûInfo
(

74 cÚ¡ 
R•Üt
 &
»pÜt
, 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
µid_’üy±iÚ_key
,

75 
ušt8_t
 
üy±o_su™e
, 
¡d
::
¡ršg
 *
µid_’üy±ed
, 
ušt16_t
 *
pû_svn
,

76 
ušt16_t
 *
pû_id
, 
ušt8_t
 *
sigÇtu»_scheme
) {

77 
¡©ic_as£¹
((
R•Üt
è=ğ(
sgx_»pÜt_t
),

80 
	g¡d
::
veùÜ
<
ušt8_t
> 
µid_’üy±ed_tmp
(
µid_’üy±ed
->
size
());

81 
ušt32_t
 
	g’üy±ed_µid_out_size
 = 0;

82 
sgx_pû_”rÜ_t
 
	g»suÉ
 = 
sgx_g‘_pû_šfo
(

83 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_»pÜt_t
 *>(&
»pÜt
),

84 
µid_’üy±iÚ_key
.
d©a
(),…pid_’üy±iÚ_key.
size
(), 
üy±o_su™e
,

85 
µid_’üy±ed_tmp
.
d©a
(),…pid_’üy±ed_tmp.
size
(),

86 &
’üy±ed_µid_out_size
, 
pû_svn
, 
pû_id
, 
sigÇtu»_scheme
);

87 ià(
	g»suÉ
 =ğ
SGX_PCE_SUCCESS
) {

88 
µid_’üy±ed_tmp
.
»size
(
’üy±ed_µid_out_size
);

89 
	gµid_’üy±ed
->
š£¹
(
µid_’üy±ed
->
begš
(), 
µid_’üy±ed_tmp
.
cbegš
(),

90 
µid_’üy±ed_tmp
.
ûnd
());

91 
	gµid_’üy±ed
->
»size
(
’üy±ed_µid_out_size
);

94  
PûE¼ÜToStus
(
»suÉ
);

97 
Stus
 
	gDÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
::
PûSignR•Üt
(

98 cÚ¡ 
R•Üt
 &
»pÜt
, 
ušt16_t
 
rg‘_pû_svn
,

99 
Un§ãBy‹s
<
kCpusvnSize
> 
rg‘_ıu_svn
, 
¡d
::
¡ršg
 *
sigÇtu»
) {

100 
¡©ic_as£¹
((
rg‘_ıu_svn
è=ğ(
sgx_ıu_svn_t
),

103 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»_tmp
(
sigÇtu»
->
size
());

104 
ušt32_t
 
	gsigÇtu»_out_size
 = 0;

105 
sgx_pû_”rÜ_t
 
	g»suÉ
 = 
sgx_pû_sign_»pÜt
(

106 &
rg‘_pû_svn
, 
»š‹½»t_ÿ¡
<
sgx_ıu_svn_t
 *>(&
rg‘_ıu_svn
),

107 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_»pÜt_t
 *>(&
»pÜt
), 
sigÇtu»_tmp
.
d©a
(),

108 
sigÇtu»_tmp
.
size
(), &
sigÇtu»_out_size
);

109 ià(
	g»suÉ
 =ğ
SGX_PCE_SUCCESS
) {

110 
sigÇtu»_tmp
.
»size
(
sigÇtu»_out_size
);

111 
	gsigÇtu»
->
š£¹
(
sigÇtu»
->
begš
(), 
sigÇtu»_tmp
.
cbegš
(),

112 
sigÇtu»_tmp
.
ûnd
());

113 
	gsigÇtu»
->
»size
(
sigÇtu»_out_size
);

116  
PûE¼ÜToStus
(
»suÉ
);

	@identity/sgx/dcap_intel_architectural_enclave_interface.cc

19 
	~"asylo/id’t™y/sgx/dÿp_š‹l_¬ch™eùu¿l_’şave_š‹rçû.h
"

21 
	~<veùÜ
>

23 
	~"šşude/sgx_key.h
"

24 
	~"šşude/sgx_»pÜt.h
"

25 
	~"QuÙeG’”©iÚ/psw/pû_w¿µ”/šc/sgx_pû.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

29 
	gÇme¥aû
 {

31 
Stus
 
PûE¼ÜToStus
(
sgx_pû_”rÜ_t
 
pû_”rÜ
) {

32 
	gpû_”rÜ
) {

33 
	gSGX_PCE_SUCCESS
:

34  
Stus
::
OkStus
();

35 
	gSGX_PCE_UNEXPECTED
:

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unexpectedƒrror");

37 
	gSGX_PCE_OUT_OF_EPC
:

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

40 
	gSGX_PCE_INTERFACE_UNAVAILABLE
:

41  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Interface unavailable");

42 
	gSGX_PCE_CRYPTO_ERROR
:

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

45 
	gSGX_PCE_INVALID_PARAMETER
:

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid…arameter");

47 
	gSGX_PCE_INVALID_REPORT
:

48  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid„eport");

49 
	gSGX_PCE_INVALID_TCB
:

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Invalid TCB");

51 
	gSGX_PCE_INVALID_PRIVILEGE
:

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "Unknownƒrror");

61 
Stus
 
	gDÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
::
G‘PûT¬g‘šfo
(

62 
T¬g‘šfo
 *
rg‘šfo
, 
ušt16_t
 *
pû_svn
) {

63 
¡©ic_as£¹
(

64 (
T¬g‘šfo
è=ğ(
sgx_rg‘_šfo_t
),

67 
sgx_pû_”rÜ_t
 
	g»suÉ
 = 
sgx_pû_g‘_rg‘
(

68 
»š‹½»t_ÿ¡
<
sgx_rg‘_šfo_t
 *>(
rg‘šfo
), 
pû_svn
);

70  
PûE¼ÜToStus
(
»suÉ
);

73 
Stus
 
	gDÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
::
G‘PûInfo
(

74 cÚ¡ 
R•Üt
 &
»pÜt
, 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
µid_’üy±iÚ_key
,

75 
ušt8_t
 
üy±o_su™e
, 
¡d
::
¡ršg
 *
µid_’üy±ed
, 
ušt16_t
 *
pû_svn
,

76 
ušt16_t
 *
pû_id
, 
ušt8_t
 *
sigÇtu»_scheme
) {

77 
¡©ic_as£¹
((
R•Üt
è=ğ(
sgx_»pÜt_t
),

80 
	g¡d
::
veùÜ
<
ušt8_t
> 
µid_’üy±ed_tmp
(
µid_’üy±ed
->
size
());

81 
ušt32_t
 
	g’üy±ed_µid_out_size
 = 0;

82 
sgx_pû_”rÜ_t
 
	g»suÉ
 = 
sgx_g‘_pû_šfo
(

83 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_»pÜt_t
 *>(&
»pÜt
),

84 
µid_’üy±iÚ_key
.
d©a
(),…pid_’üy±iÚ_key.
size
(), 
üy±o_su™e
,

85 
µid_’üy±ed_tmp
.
d©a
(),…pid_’üy±ed_tmp.
size
(),

86 &
’üy±ed_µid_out_size
, 
pû_svn
, 
pû_id
, 
sigÇtu»_scheme
);

87 ià(
	g»suÉ
 =ğ
SGX_PCE_SUCCESS
) {

88 
µid_’üy±ed_tmp
.
»size
(
’üy±ed_µid_out_size
);

89 
	gµid_’üy±ed
->
š£¹
(
µid_’üy±ed
->
begš
(), 
µid_’üy±ed_tmp
.
cbegš
(),

90 
µid_’üy±ed_tmp
.
ûnd
());

91 
	gµid_’üy±ed
->
»size
(
’üy±ed_µid_out_size
);

94  
PûE¼ÜToStus
(
»suÉ
);

97 
Stus
 
	gDÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
::
PûSignR•Üt
(

98 cÚ¡ 
R•Üt
 &
»pÜt
, 
ušt16_t
 
rg‘_pû_svn
,

99 
Un§ãBy‹s
<
kCpusvnSize
> 
rg‘_ıu_svn
, 
¡d
::
¡ršg
 *
sigÇtu»
) {

100 
¡©ic_as£¹
((
rg‘_ıu_svn
è=ğ(
sgx_ıu_svn_t
),

103 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»_tmp
(
sigÇtu»
->
size
());

104 
ušt32_t
 
	gsigÇtu»_out_size
 = 0;

105 
sgx_pû_”rÜ_t
 
	g»suÉ
 = 
sgx_pû_sign_»pÜt
(

106 &
rg‘_pû_svn
, 
»š‹½»t_ÿ¡
<
sgx_ıu_svn_t
 *>(&
rg‘_ıu_svn
),

107 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_»pÜt_t
 *>(&
»pÜt
), 
sigÇtu»_tmp
.
d©a
(),

108 
sigÇtu»_tmp
.
size
(), &
sigÇtu»_out_size
);

109 ià(
	g»suÉ
 =ğ
SGX_PCE_SUCCESS
) {

110 
sigÇtu»_tmp
.
»size
(
sigÇtu»_out_size
);

111 
	gsigÇtu»
->
š£¹
(
sigÇtu»
->
begš
(), 
sigÇtu»_tmp
.
cbegš
(),

112 
sigÇtu»_tmp
.
ûnd
());

113 
	gsigÇtu»
->
»size
(
sigÇtu»_out_size
);

116  
PûE¼ÜToStus
(
»suÉ
);

	@identity/sgx/dcap_intel_architectural_enclave_interface.h

19 #iâdeà
ASYLO_IDENTITY_SGX_DCAP_INTEL_ARCHITECTURAL_ENCLAVE_INTERFACE_H_


20 
	#ASYLO_IDENTITY_SGX_DCAP_INTEL_ARCHITECTURAL_ENCLAVE_INTERFACE_H_


	)

22 
	~<c¡dšt
>

23 
	~<¡ršg
>

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/üy±o/ut/by‹s.h
"

27 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

28 
	~"asylo/id’t™y/sgx/š‹l_¬ch™eùu¿l_’şave_š‹rçû.h
"

29 
	~"asylo/ut/¡©us.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsgx
 {

39 şas 
	cDÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû


40 : 
public
 
IÁ–Arch™eùu¿lEnşaveIÁ”çû
 {

41 
public
:

42 
DÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
() = ;

44 ~
DÿpIÁ–Arch™eùu¿lEnşaveIÁ”çû
(è
	gov”ride
 = ;

48 
Stus
 
G‘PûT¬g‘šfo
(
T¬g‘šfo
 *
rg‘šfo
, 
ušt16_t
 *
pû_svn
è
	gov”ride
;

50 
Stus
 
G‘PûInfo
(cÚ¡ 
R•Üt
 &
»pÜt
,

51 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
µid_’üy±iÚ_key
,

52 
ušt8_t
 
üy±o_su™e
, 
¡d
::
¡ršg
 *
µid_’üy±ed
,

53 
ušt16_t
 *
pû_svn
, ušt16_ˆ*
pû_id
,

54 
ušt8_t
 *
sigÇtu»_scheme
è
	gov”ride
;

56 
Stus
 
PûSignR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
, 
ušt16_t
 
rg‘_pû_svn
,

57 
Un§ãBy‹s
<
kCpusvnSize
> 
rg‘_ıu_svn
,

58 
¡d
::
¡ršg
 *
sigÇtu»
è
ov”ride
;

	@identity/sgx/fake_enclave.cc

19 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

21 
	~<İ’s¦/cmac.h
>

22 
	~<İ’s¦/¿nd.h
>

24 
	~<c¡ddef
>

25 
	~<c¡dlib
>

26 
	~<io¡»am
>

27 
	~<veùÜ
>

29 
	~"ab¦/¡ršgs/¡r_još.h
"

30 
	~"asylo/üy±o/ut/bs¦_ut.h
"

31 
	~"asylo/üy±o/ut/by‹s.h
"

32 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

33 
	~"asylo/ut/loggšg.h
"

34 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

35 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

36 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

37 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

38 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

39 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

41 
Çme¥aû
 
	gasylo
 {

42 
Çme¥aû
 
	gsgx
 {

43 
	gÇme¥aû
 {

45 
cÚ¡ex´
 
	gkH¬dcodedPkcs15PaddšgHex
[] =

59 
	g¡d
::
¡ršg
 
FÜm©A‰ribu‹S‘
(cÚ¡ 
SecsA‰ribu‹S‘
 &
£t
) {

60 
A‰ribu‹s
 
©Œibu‹s
;

63 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
£t
, &
©Œibu‹s
);

64  
FÜm©PrÙo
(
©Œibu‹s
);

69 
FakeEnşave
 *
	gFakeEnşave
::
cu¼’t_
 = 
nuÎ±r
;

71 
	gFakeEnşave
::
FakeEnşave
() {

72 
G‘AÎSecsA‰ribu‹s
(&
v®id_©Œibu‹s_
);

73 
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

74 
G‘Mu¡BeS‘SecsA‰ribu‹s
(&
»quœed_©Œibu‹s_
);

75 
	gm»nşave_
.
fl
(0);

76 
	gmrsigÃr_
.
fl
(0);

77 
	gisv´odid_
 = 0;

78 
	gisvsvn_
 = 0;

79 
	g©Œibu‹s_
 = 
»quœed_©Œibu‹s_
;

80 
	gmisc£Ëù_
 = 0;

81 
	gcÚfigsvn_
 = 0;

82 
	gisvexrodid_
.
fl
(0);

83 
	gisvçmyid_
.
fl
(0);

84 
	gcÚfigid_
.
fl
(0);

85 
	gıusvn_
.
fl
(0);

86 
	g»pÜt_keyid_
.
fl
(0);

87 
	gowÃ»poch_
.
fl
(0);

88 
	groÙ_key_
.
fl
(0);

89 
	g£®_fu£s_
.
fl
(0);

92 
FakeEnşave
 *
	gFakeEnşave
::
G‘Cu¼’tEnşave
(è{  
cu¼’t_
; }

94 
	gFakeEnşave
::
EÁ”Enşave
(cÚ¡ 
FakeEnşave
 &
’şave
) {

95 ià(
cu¼’t_
) {

99 
LOG
(
FATAL
) << "Already inside‡nƒnclave.";

101 
	gcu¼’t_
 = 
Ãw
 
FakeEnşave
(
’şave
);

104 
	gFakeEnşave
::
Ex™Enşave
() {

105 ià(!
cu¼’t_
) {

109 
LOG
(
FATAL
) << "Not inside‡nƒnclave.";

111 
d–‘e
 
	gcu¼’t_
;

112 
	gcu¼’t_
 = 
nuÎ±r
;

115 
	gFakeEnşave
::
S‘RªdomId’t™y
() {

116 
m»nşave_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

117 
	gmrsigÃr_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

118 
	gisv´odid_
 = 
TrivŸlRªdomObjeù
<
ušt16_t
>();

119 
	gisvsvn_
 = 
TrivŸlRªdomObjeù
<
ušt16_t
>();

123 
£t_©Œibu‹s
(
TrivŸlRªdomObjeù
<
SecsA‰ribu‹S‘
>());

126 
	gmisc£Ëù_
 = 
TrivŸlRªdomObjeù
<
ušt32_t
>(è& 
kMisc£ËùAÎB™s
;

130 ià(!
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
::
KSS
, 
©Œibu‹s_
)) {

131 
	gcÚfigsvn_
 = 0;

132 
	gisvexrodid_
.
fl
(0);

133 
	gisvçmyid_
.
fl
(0);

134 
	gcÚfigid_
.
fl
(0);

136 
	gcÚfigsvn_
 = 
TrivŸlRªdomObjeù
<
ušt16_t
>();

137 
	gisvçmyid_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kIsvçmyidSize
>>();

138 
	gisvexrodid_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kIsvexrodidSize
>>();

139 
	gcÚfigid_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kCÚfigidSize
>>();

143 
	gFakeEnşave
::
S‘Id’t™y
(cÚ¡ 
CodeId’t™y
 &
id’t™y
) {

144 
m»nşave_
.
assign
(
id’t™y
.
m»nşave
().
hash
());

145 
	gmrsigÃr_
.
assign
(
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
());

146 
	gisv´odid_
 = 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isv´odid
();

147 
	gisvsvn_
 = 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isvsvn
();

149 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
id’t™y
.
©Œibu‹s
(),

150 &
©Œibu‹s_
)) {

151 
LOG
(
FATAL
) << "Error while„eading‡ttributes from identity.";

153 ià((
	g©Œibu‹s_
 & 
	gv®id_©Œibu‹s_
è!ğ
©Œibu‹s_
) {

154 
LOG
(
FATAL
) << "Identity contains illegal‡ttributes. "

155 << "Id’t™y A‰ribu‹s: " << 
FÜm©A‰ribu‹S‘
(
©Œibu‹s_
)

157 << 
FÜm©A‰ribu‹S‘
(
v®id_©Œibu‹s_
);

159 ià((
	g©Œibu‹s_
 & 
	g»quœed_©Œibu‹s_
è!ğ
»quœed_©Œibu‹s_
) {

160 
LOG
(
FATAL
) << "Identity is missing„equired‡ttributes. "

161 << "Id’t™y A‰ribu‹s: " << 
FÜm©A‰ribu‹S‘
(
©Œibu‹s_
)

163 << 
FÜm©A‰ribu‹S‘
(
»quœed_©Œibu‹s_
);

165 
	gmisc£Ëù_
 = 
id’t™y
.
misc£Ëù
();

168 
	gStusOr
<
	gCodeId’t™y
> 
	gFakeEnşave
::
G‘Id’t™y
() const {

169 
CodeId’t™y
 
code_id’t™y
;

172 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_
,

173 
code_id’t™y
.
mubË_©Œibu‹s
())) {

174  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

178 
	gcode_id’t™y
.
mubË_m»nşave
()->
£t_hash
(

179 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
m»nşave_
));

181 
SigÃrAssigÃdId’t™y
 *
	gsigÃr_assigÃd_id’t™y
 =

182 
code_id’t™y
.
mubË_sigÃr_assigÃd_id’t™y
();

183 
	gsigÃr_assigÃd_id’t™y
->
mubË_mrsigÃr
()->
£t_hash
(

184 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
mrsigÃr_
));

185 
	gsigÃr_assigÃd_id’t™y
->
£t_isv´odid
(
isv´odid_
);

186 
	gsigÃr_assigÃd_id’t™y
->
£t_isvsvn
(
isvsvn_
);

188 
	gcode_id’t™y
.
£t_misc£Ëù
(
misc£Ëù_
);

190  
	gcode_id’t™y
;

193 
boŞ
 
	gFakeEnşave
::
İ”©Ü
==(cÚ¡ 
FakeEnşave
 &
Ùh”
) const {

194  (
m»nşave_
 =ğ
Ùh”
.m»nşave_ && 
mrsigÃr_
 == other.mrsigner_ &&

195 
isv´odid_
 =ğ
Ùh”
.isv´odid_ && 
isvsvn_
 == other.isvsvn_ &&

196 
©Œibu‹s_
 =ğ
Ùh”
.attributes_ &&

197 
misc£Ëù_
 =ğ
Ùh”
.misc£Ëù_ && 
ıusvn_
 == other.cpusvn_ &&

198 
»pÜt_keyid_
 =ğ
Ùh”
.report_keyid_ &&

199 
owÃ»poch_
 =ğ
Ùh”
.owÃ»poch_ && 
roÙ_key_
 == other.root_key_ &&

200 
£®_fu£s_
 =ğ
Ùh”
.seal_fuses_);

203 
boŞ
 
	gFakeEnşave
::
İ”©Ü
!=(cÚ¡ 
FakeEnşave
 &
Ùh”
) const {

204  !(*
this
 =ğ
Ùh”
);

207 
Stus
 
	gFakeEnşave
::
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
) {

208 
RAND_by‹s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
v®ue
), (*value));

209  
	gStus
::
OkStus
();

212 
Stus
 
	gFakeEnşave
::
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
,

213 
H¬dw¬eKey
 *
key
) const {

217 ià(!
	gAligÃdKey»que¡PŒ
::
IsAligÃd
(&
»que¡
) ||

218 !
AligÃdH¬dw¬eKeyPŒ
::
IsAligÃd
(
key
)) {

219 
LOG
(
FATAL
) << "Input…arameters‡re‚ot correctly‡ligned.";

227 ià(
	g»que¡
.
	g»£rved1
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(
»que¡
.
»£rved1
)>() ||

228 
»que¡
.
»£rved2
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(request.reserved2)>()) {

229 
LOG
(
FATAL
) << "Reserved fields/bits in input…arameters‡re‚ot zeroed.";

235 ià((
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyRe£rvedB™s
) != 0 ||

236 (!
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
::
KSS
, 
©Œibu‹s_
) &&

237 (
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyKssB™s
) != 0)) {

238 
LOG
(
FATAL
) << "Input…arameter KEYPOLICY is‚ot valid.";

245 
KeyD•’d’c›s
 
	gkey_d•’d’c›s
;

246 
KeyD•’d’c›sBa£
 *
	gd•’d’c›s
 = &
key_d•’d’c›s
.
d•’d’c›s
;

247 
	g»que¡
.
	gkeyÇme
) {

248 
	gKey»que¡KeyÇme
::
SEAL_KEY
:

254 ià(
»que¡
.
ıusvn
 !ğ
ıusvn_
) {

255  
Stus
(
SGX_ERROR_INVALID_CPUSVN
,

258 ià(
	g»que¡
.
	gisvsvn
 > 
	gisvsvn_
) {

259  
Stus
(
SGX_ERROR_INVALID_ISVSVN
,

262 ià(
	g»que¡
.
	gcÚfigsvn
 > 
	gcÚfigsvn_
) {

263  
Stus
(
SGX_ERROR_INVALID_ISVSVN
,

266 
	gd•’d’c›s
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
SEAL_KEY
;

267 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyIsvçmyidB™Mask
) {

268 
	gd•’d’c›s
->
	gisvçmyid
 = 
isvçmyid_
;

270 
	gd•’d’c›s
->
	gisvçmyid
.
fl
(0);

272 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyIsvexrodidB™Mask
) {

273 
	gd•’d’c›s
->
	gisvexrodid
 = 
isvexrodid_
;

275 
	gd•’d’c›s
->
	gisvexrodid
.
fl
(0);

277 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyNoisv´odidB™Mask
) {

278 
	gd•’d’c›s
->
	gisv´odid
 = 0;

280 
	gd•’d’c›s
->
	gisv´odid
 = 
isv´odid_
;

282 
	gd•’d’c›s
->
	gisvsvn
 = 
»que¡
.
isvsvn
;

283 
	gd•’d’c›s
->
	gowÃ»poch
 = 
owÃ»poch_
;

284 
	gd•’d’c›s
->
	g©Œibu‹s
 =

285 ((
kRequœedS—lšgA‰ribu‹sMask
 | 
»que¡
.
©Œibu‹mask
) &

286 
©Œibu‹s_
);

287 
	gd•’d’c›s
->
	g©Œibu‹mask
 = 
»que¡
.
©Œibu‹mask
;

288 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyM»nşaveB™Mask
) {

289 
	gd•’d’c›s
->
	gm»nşave
 = 
m»nşave_
;

291 
	gd•’d’c›s
->
	gm»nşave
.
fl
(0);

293 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyMrsigÃrB™Mask
) {

294 
	gd•’d’c›s
->
	gmrsigÃr
 = 
mrsigÃr_
;

296 
	gd•’d’c›s
->
	gmrsigÃr
.
fl
(0);

298 
	gd•’d’c›s
->
	gkeyid
 = 
»que¡
.
keyid
;

299 
	gd•’d’c›s
->
	g£®_key_fu£s
 = 
£®_fu£s_
;

300 
	gd•’d’c›s
->
	gıusvn
 = 
»que¡
.
ıusvn
;

301 
S‘TrivŸlObjeùFromHexSŒšg
(
kH¬dcodedPkcs15PaddšgHex
,

302 &
d•’d’c›s
->
·ddšg
);

303 
	gd•’d’c›s
->
	gmisc£Ëù
 = (
misc£Ëù_
 & 
»que¡
.
miscmask
);

304 
	gd•’d’c›s
->
	gmiscmask
 = 
»que¡
.
miscmask
;

305 
	gd•’d’c›s
->
	gkeypŞicy
 = 
»que¡
.
keypŞicy
;

307 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyCÚfigidB™Mask
) {

308 
	gd•’d’c›s
->
	gcÚfigid
 = 
cÚfigid_
;

309 
	gd•’d’c›s
->
	gcÚfigsvn
 = 
cÚfigsvn_
;

311 
	gd•’d’c›s
->
	gcÚfigid
.
fl
(0);

312 
	gd•’d’c›s
->
	gcÚfigsvn
 = 0;

316 
	gKey»que¡KeyÇme
::
REPORT_KEY
:

317 
d•’d’c›s
->
keyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

318 
	gd•’d’c›s
->
	gisvçmyid
.
fl
(0);

319 
	gd•’d’c›s
->
	gisvexrodid
.
fl
(0);

320 
	gd•’d’c›s
->
	gisv´odid
 = 0;

321 
	gd•’d’c›s
->
	gisvsvn
 = 0;

322 
	gd•’d’c›s
->
	gowÃ»poch
 = 
owÃ»poch_
;

323 
	gd•’d’c›s
->
	g©Œibu‹s
 = 
©Œibu‹s_
;

324 
CË¬SecsA‰ribu‹S‘
(&
d•’d’c›s
->
©Œibu‹mask
);

325 
	gd•’d’c›s
->
	gm»nşave
 = 
m»nşave_
;

326 
	gd•’d’c›s
->
	gmrsigÃr
.
fl
(0);

327 
	gd•’d’c›s
->
	gkeyid
 = 
»que¡
.
keyid
;

328 
	gd•’d’c›s
->
	g£®_key_fu£s
 = 
£®_fu£s_
;

329 
	gd•’d’c›s
->
	gıusvn
 = 
ıusvn_
;

330 
S‘TrivŸlObjeùFromHexSŒšg
(
kH¬dcodedPkcs15PaddšgHex
,

331 &
d•’d’c›s
->
·ddšg
);

332 
	gd•’d’c›s
->
	gmisc£Ëù
 = 
misc£Ëù_
;

333 
	gd•’d’c›s
->
	gmiscmask
 = 0;

334 
	gd•’d’c›s
->
	gkeypŞicy
 = 0;

335 
	gd•’d’c›s
->
	gcÚfigid
 = 
cÚfigid_
;

336 
	gd•’d’c›s
->
	gcÚfigsvn
 = 
cÚfigsvn_
;

340  
Stus
(

341 
SGX_ERROR_INVALID_KEYNAME
,

342 
ab¦
::
SŒC©
("Key‚am", 
¡©ic_ÿ¡
<
ušt64_t
>(
»que¡
.
keyÇme
),

345  
D”iveKey
(
key_d•’d’c›s
, 
key
);

348 
Stus
 
	gFakeEnşave
::
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
,

349 cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
,

350 
R•Üt
 *
»pÜt
) const {

354 ià(!
	gAligÃdT¬g‘šfoPŒ
::
IsAligÃd
(&
tšfo
) ||

355 !
AligÃdR•Ütd©aPŒ
::
IsAligÃd
(&
»pÜtd©a
) ||

356 !
AligÃdR•ÜtPŒ
::
IsAligÃd
(
»pÜt
)) {

357 
LOG
(
FATAL
) << "Parameters‡re‚ot correctly‡ligned";

365 
SecsA‰ribu‹S‘
 
	g®l_©Œibu‹s
;

366 
G‘AÎSecsA‰ribu‹s
(&
®l_©Œibu‹s
);

367 
SecsA‰ribu‹S‘
 
	g»£rved_©Œibu‹s
 = ~
®l_©Œibu‹s
;

368 
ušt32_t
 
	gmisc_£Ëù_»£rved_b™s
 = ~
kMisc£ËùAÎB™s
;

369 ià(
	gtšfo
.
	g»£rved1
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(
tšfo
.
»£rved1
)>() ||

370 
tšfo
.
»£rved2
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(tinfo.reserved2)>() ||

371 (
tšfo
.
misc£Ëù
 & 
misc_£Ëù_»£rved_b™s
) != 0 ||

372 (
tšfo
.
©Œibu‹s
 & 
»£rved_©Œibu‹s
) !=

373 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>()) {

374 
LOG
(
FATAL
) << "Reserved fields/bits in input…arameters‡re‚ot zeroed.";

377 
	g»pÜt
->
	gıusvn
 = 
ıusvn_
;

378 
	g»pÜt
->
	gmisc£Ëù
 = 
misc£Ëù_
;

379 
	g»pÜt
->
	g»£rved1
.
fl
(0);

380 
	g»pÜt
->
	gisvexrodid
 = 
isvexrodid_
;

381 
	g»pÜt
->
	g©Œibu‹s
 = 
©Œibu‹s_
;

382 
	g»pÜt
->
	gm»nşave
 = 
m»nşave_
;

383 
	g»pÜt
->
	g»£rved2
.
fl
(0);

384 
	g»pÜt
->
	gmrsigÃr
 = 
mrsigÃr_
;

385 
	g»pÜt
->
	g»£rved3
.
fl
(0);

386 
	g»pÜt
->
	gcÚfigid
 = 
cÚfigid_
;

387 
	g»pÜt
->
	gisv´odid
 = 
isv´odid_
;

388 
	g»pÜt
->
	gisvsvn
 = 
isvsvn_
;

389 
	g»pÜt
->
	gcÚfigsvn
 = 
cÚfigsvn_
;

390 
	g»pÜt
->
	g»£rved4
.
fl
(0);

391 
	g»pÜt
->
	gisvçmyid
 = 
isvçmyid_
;

392 
	g»pÜt
->
	g»pÜtd©a
 = 
»pÜtd©a
;

393 
	g»pÜt
->
	gkeyid
 = 
»pÜt_keyid_
;

398 
KeyD•’d’c›s
 
	gkey_d•’d’c›s
;

399 
KeyD•’d’c›sBa£
 *
	gd•’d’c›s
 = &
key_d•’d’c›s
.
d•’d’c›s
;

401 
	gd•’d’c›s
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

402 
	gd•’d’c›s
->
	gisvçmyid
.
fl
(0);

403 
	gd•’d’c›s
->
	gisvexrodid
.
fl
(0);

404 
	gd•’d’c›s
->
	gisv´odid
 = 0;

405 
	gd•’d’c›s
->
	gisvsvn
 = 0;

406 
	gd•’d’c›s
->
	gowÃ»poch
 = 
owÃ»poch_
;

407 
	gd•’d’c›s
->
	g©Œibu‹s
 = 
tšfo
.
©Œibu‹s
;

408 
CË¬SecsA‰ribu‹S‘
(&
d•’d’c›s
->
©Œibu‹mask
);

409 
	gd•’d’c›s
->
	gm»nşave
 = 
tšfo
.
m—su»m’t
;

410 
	gd•’d’c›s
->
	gmrsigÃr
.
fl
(0);

411 
	gd•’d’c›s
->
	gkeyid
 = 
»pÜt_keyid_
;

412 
	gd•’d’c›s
->
	g£®_key_fu£s
 = 
£®_fu£s_
;

413 
	gd•’d’c›s
->
	gıusvn
 = 
ıusvn_
;

414 
S‘TrivŸlObjeùFromHexSŒšg
(
kH¬dcodedPkcs15PaddšgHex
,

415 &
d•’d’c›s
->
·ddšg
);

416 
	gd•’d’c›s
->
	gmisc£Ëù
 = 
tšfo
.
misc£Ëù
;

417 
	gd•’d’c›s
->
	gmiscmask
 = 0;

418 
	gd•’d’c›s
->
	gkeypŞicy
 = 0;

419 
	gd•’d’c›s
->
	gcÚfigid
 = 
tšfo
.
cÚfigid
;

420 
	gd•’d’c›s
->
	gcÚfigsvn
 = 
tšfo
.
cÚfigsvn
;

422 
	gSaãBy‹s
<
	gkH¬dw¬eKeySize
> 
	g»pÜt_key
;

423 
ASYLO_RETURN_IF_ERROR
(
D”iveKey
(
key_d•’d’c›s
, &
»pÜt_key
));

428 ià(
	g»pÜt
->
	gmac
.
size
(è!ğ
AES_BLOCK_SIZE
) {

429  
Stus
(

430 
SGX_ERROR_INVALID_PARAMETER
,

434 ià(
AES_CMAC
(
»pÜt
->
mac
.
d©a
(), 
»pÜt_key
.d©a(),„•Üt_key.
size
(),

435 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
»pÜt
),

436 
off£tof
(
R•Üt
, 
keyid
)) != 1) {

438 
»pÜt
->
mac
.
CËª£
();

439  
Stus
(
SGX_ERROR_UNEXPECTED
, 
Bs¦La¡E¼ÜSŒšg
());

441  
	gStus
::
OkStus
();

444 
Stus
 
	gFakeEnşave
::
D”iveKey
(cÚ¡ 
KeyD•’d’c›s
 &
key_d•’d’c›s
,

445 
H¬dw¬eKey
 *
key
) const {

446 
¡©ic_as£¹
(
H¬dw¬eKey
::
size
(è=ğ
AES_BLOCK_SIZE
,

449 ià(
AES_CMAC
(
key
->
d©a
(), 
roÙ_key_
.d©a(),„oÙ_key_.
size
(),

450 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
key_d•’d’c›s
),

451 (
key_d•’d’c›s
)) != 1) {

453 
key
->
CËª£
();

454  
Stus
(
SGX_ERROR_UNEXPECTED
, 
Bs¦La¡E¼ÜSŒšg
());

456  
	gStus
::
OkStus
();

	@identity/sgx/fake_enclave.cc

19 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

21 
	~<İ’s¦/cmac.h
>

22 
	~<İ’s¦/¿nd.h
>

24 
	~<c¡ddef
>

25 
	~<c¡dlib
>

26 
	~<io¡»am
>

27 
	~<veùÜ
>

29 
	~"ab¦/¡ršgs/¡r_još.h
"

30 
	~"asylo/üy±o/ut/bs¦_ut.h
"

31 
	~"asylo/üy±o/ut/by‹s.h
"

32 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

33 
	~"asylo/ut/loggšg.h
"

34 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

35 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

36 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

37 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

38 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

39 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

41 
Çme¥aû
 
	gasylo
 {

42 
Çme¥aû
 
	gsgx
 {

43 
	gÇme¥aû
 {

45 
cÚ¡ex´
 
	gkH¬dcodedPkcs15PaddšgHex
[] =

59 
	g¡d
::
¡ršg
 
FÜm©A‰ribu‹S‘
(cÚ¡ 
SecsA‰ribu‹S‘
 &
£t
) {

60 
A‰ribu‹s
 
©Œibu‹s
;

63 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
£t
, &
©Œibu‹s
);

64  
FÜm©PrÙo
(
©Œibu‹s
);

69 
FakeEnşave
 *
	gFakeEnşave
::
cu¼’t_
 = 
nuÎ±r
;

71 
	gFakeEnşave
::
FakeEnşave
() {

72 
G‘AÎSecsA‰ribu‹s
(&
v®id_©Œibu‹s_
);

73 
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

74 
G‘Mu¡BeS‘SecsA‰ribu‹s
(&
»quœed_©Œibu‹s_
);

75 
	gm»nşave_
.
fl
(0);

76 
	gmrsigÃr_
.
fl
(0);

77 
	gisv´odid_
 = 0;

78 
	gisvsvn_
 = 0;

79 
	g©Œibu‹s_
 = 
»quœed_©Œibu‹s_
;

80 
	gmisc£Ëù_
 = 0;

81 
	gcÚfigsvn_
 = 0;

82 
	gisvexrodid_
.
fl
(0);

83 
	gisvçmyid_
.
fl
(0);

84 
	gcÚfigid_
.
fl
(0);

85 
	gıusvn_
.
fl
(0);

86 
	g»pÜt_keyid_
.
fl
(0);

87 
	gowÃ»poch_
.
fl
(0);

88 
	groÙ_key_
.
fl
(0);

89 
	g£®_fu£s_
.
fl
(0);

92 
FakeEnşave
 *
	gFakeEnşave
::
G‘Cu¼’tEnşave
(è{  
cu¼’t_
; }

94 
	gFakeEnşave
::
EÁ”Enşave
(cÚ¡ 
FakeEnşave
 &
’şave
) {

95 ià(
cu¼’t_
) {

99 
LOG
(
FATAL
) << "Already inside‡nƒnclave.";

101 
	gcu¼’t_
 = 
Ãw
 
FakeEnşave
(
’şave
);

104 
	gFakeEnşave
::
Ex™Enşave
() {

105 ià(!
cu¼’t_
) {

109 
LOG
(
FATAL
) << "Not inside‡nƒnclave.";

111 
d–‘e
 
	gcu¼’t_
;

112 
	gcu¼’t_
 = 
nuÎ±r
;

115 
	gFakeEnşave
::
S‘RªdomId’t™y
() {

116 
m»nşave_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

117 
	gmrsigÃr_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

118 
	gisv´odid_
 = 
TrivŸlRªdomObjeù
<
ušt16_t
>();

119 
	gisvsvn_
 = 
TrivŸlRªdomObjeù
<
ušt16_t
>();

123 
£t_©Œibu‹s
(
TrivŸlRªdomObjeù
<
SecsA‰ribu‹S‘
>());

126 
	gmisc£Ëù_
 = 
TrivŸlRªdomObjeù
<
ušt32_t
>(è& 
kMisc£ËùAÎB™s
;

130 ià(!
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
::
KSS
, 
©Œibu‹s_
)) {

131 
	gcÚfigsvn_
 = 0;

132 
	gisvexrodid_
.
fl
(0);

133 
	gisvçmyid_
.
fl
(0);

134 
	gcÚfigid_
.
fl
(0);

136 
	gcÚfigsvn_
 = 
TrivŸlRªdomObjeù
<
ušt16_t
>();

137 
	gisvçmyid_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kIsvçmyidSize
>>();

138 
	gisvexrodid_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kIsvexrodidSize
>>();

139 
	gcÚfigid_
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kCÚfigidSize
>>();

143 
	gFakeEnşave
::
S‘Id’t™y
(cÚ¡ 
CodeId’t™y
 &
id’t™y
) {

144 
m»nşave_
.
assign
(
id’t™y
.
m»nşave
().
hash
());

145 
	gmrsigÃr_
.
assign
(
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
());

146 
	gisv´odid_
 = 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isv´odid
();

147 
	gisvsvn_
 = 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
isvsvn
();

149 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
id’t™y
.
©Œibu‹s
(),

150 &
©Œibu‹s_
)) {

151 
LOG
(
FATAL
) << "Error while„eading‡ttributes from identity.";

153 ià((
	g©Œibu‹s_
 & 
	gv®id_©Œibu‹s_
è!ğ
©Œibu‹s_
) {

154 
LOG
(
FATAL
) << "Identity contains illegal‡ttributes. "

155 << "Id’t™y A‰ribu‹s: " << 
FÜm©A‰ribu‹S‘
(
©Œibu‹s_
)

157 << 
FÜm©A‰ribu‹S‘
(
v®id_©Œibu‹s_
);

159 ià((
	g©Œibu‹s_
 & 
	g»quœed_©Œibu‹s_
è!ğ
»quœed_©Œibu‹s_
) {

160 
LOG
(
FATAL
) << "Identity is missing„equired‡ttributes. "

161 << "Id’t™y A‰ribu‹s: " << 
FÜm©A‰ribu‹S‘
(
©Œibu‹s_
)

163 << 
FÜm©A‰ribu‹S‘
(
»quœed_©Œibu‹s_
);

165 
	gmisc£Ëù_
 = 
id’t™y
.
misc£Ëù
();

168 
	gStusOr
<
	gCodeId’t™y
> 
	gFakeEnşave
::
G‘Id’t™y
() const {

169 
CodeId’t™y
 
code_id’t™y
;

172 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_
,

173 
code_id’t™y
.
mubË_©Œibu‹s
())) {

174  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

178 
	gcode_id’t™y
.
mubË_m»nşave
()->
£t_hash
(

179 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
m»nşave_
));

181 
SigÃrAssigÃdId’t™y
 *
	gsigÃr_assigÃd_id’t™y
 =

182 
code_id’t™y
.
mubË_sigÃr_assigÃd_id’t™y
();

183 
	gsigÃr_assigÃd_id’t™y
->
mubË_mrsigÃr
()->
£t_hash
(

184 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
mrsigÃr_
));

185 
	gsigÃr_assigÃd_id’t™y
->
£t_isv´odid
(
isv´odid_
);

186 
	gsigÃr_assigÃd_id’t™y
->
£t_isvsvn
(
isvsvn_
);

188 
	gcode_id’t™y
.
£t_misc£Ëù
(
misc£Ëù_
);

190  
	gcode_id’t™y
;

193 
boŞ
 
	gFakeEnşave
::
İ”©Ü
==(cÚ¡ 
FakeEnşave
 &
Ùh”
) const {

194  (
m»nşave_
 =ğ
Ùh”
.m»nşave_ && 
mrsigÃr_
 == other.mrsigner_ &&

195 
isv´odid_
 =ğ
Ùh”
.isv´odid_ && 
isvsvn_
 == other.isvsvn_ &&

196 
©Œibu‹s_
 =ğ
Ùh”
.attributes_ &&

197 
misc£Ëù_
 =ğ
Ùh”
.misc£Ëù_ && 
ıusvn_
 == other.cpusvn_ &&

198 
»pÜt_keyid_
 =ğ
Ùh”
.report_keyid_ &&

199 
owÃ»poch_
 =ğ
Ùh”
.owÃ»poch_ && 
roÙ_key_
 == other.root_key_ &&

200 
£®_fu£s_
 =ğ
Ùh”
.seal_fuses_);

203 
boŞ
 
	gFakeEnşave
::
İ”©Ü
!=(cÚ¡ 
FakeEnşave
 &
Ùh”
) const {

204  !(*
this
 =ğ
Ùh”
);

207 
Stus
 
	gFakeEnşave
::
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
) {

208 
RAND_by‹s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
v®ue
), (*value));

209  
	gStus
::
OkStus
();

212 
Stus
 
	gFakeEnşave
::
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
,

213 
H¬dw¬eKey
 *
key
) const {

217 ià(!
	gAligÃdKey»que¡PŒ
::
IsAligÃd
(&
»que¡
) ||

218 !
AligÃdH¬dw¬eKeyPŒ
::
IsAligÃd
(
key
)) {

219 
LOG
(
FATAL
) << "Input…arameters‡re‚ot correctly‡ligned.";

227 ià(
	g»que¡
.
	g»£rved1
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(
»que¡
.
»£rved1
)>() ||

228 
»que¡
.
»£rved2
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(request.reserved2)>()) {

229 
LOG
(
FATAL
) << "Reserved fields/bits in input…arameters‡re‚ot zeroed.";

235 ià((
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyRe£rvedB™s
) != 0 ||

236 (!
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
::
KSS
, 
©Œibu‹s_
) &&

237 (
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyKssB™s
) != 0)) {

238 
LOG
(
FATAL
) << "Input…arameter KEYPOLICY is‚ot valid.";

245 
KeyD•’d’c›s
 
	gkey_d•’d’c›s
;

246 
KeyD•’d’c›sBa£
 *
	gd•’d’c›s
 = &
key_d•’d’c›s
.
d•’d’c›s
;

247 
	g»que¡
.
	gkeyÇme
) {

248 
	gKey»que¡KeyÇme
::
SEAL_KEY
:

254 ià(
»que¡
.
ıusvn
 !ğ
ıusvn_
) {

255  
Stus
(
SGX_ERROR_INVALID_CPUSVN
,

258 ià(
	g»que¡
.
	gisvsvn
 > 
	gisvsvn_
) {

259  
Stus
(
SGX_ERROR_INVALID_ISVSVN
,

262 ià(
	g»que¡
.
	gcÚfigsvn
 > 
	gcÚfigsvn_
) {

263  
Stus
(
SGX_ERROR_INVALID_ISVSVN
,

266 
	gd•’d’c›s
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
SEAL_KEY
;

267 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyIsvçmyidB™Mask
) {

268 
	gd•’d’c›s
->
	gisvçmyid
 = 
isvçmyid_
;

270 
	gd•’d’c›s
->
	gisvçmyid
.
fl
(0);

272 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyIsvexrodidB™Mask
) {

273 
	gd•’d’c›s
->
	gisvexrodid
 = 
isvexrodid_
;

275 
	gd•’d’c›s
->
	gisvexrodid
.
fl
(0);

277 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyNoisv´odidB™Mask
) {

278 
	gd•’d’c›s
->
	gisv´odid
 = 0;

280 
	gd•’d’c›s
->
	gisv´odid
 = 
isv´odid_
;

282 
	gd•’d’c›s
->
	gisvsvn
 = 
»que¡
.
isvsvn
;

283 
	gd•’d’c›s
->
	gowÃ»poch
 = 
owÃ»poch_
;

284 
	gd•’d’c›s
->
	g©Œibu‹s
 =

285 ((
kRequœedS—lšgA‰ribu‹sMask
 | 
»que¡
.
©Œibu‹mask
) &

286 
©Œibu‹s_
);

287 
	gd•’d’c›s
->
	g©Œibu‹mask
 = 
»que¡
.
©Œibu‹mask
;

288 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyM»nşaveB™Mask
) {

289 
	gd•’d’c›s
->
	gm»nşave
 = 
m»nşave_
;

291 
	gd•’d’c›s
->
	gm»nşave
.
fl
(0);

293 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyMrsigÃrB™Mask
) {

294 
	gd•’d’c›s
->
	gmrsigÃr
 = 
mrsigÃr_
;

296 
	gd•’d’c›s
->
	gmrsigÃr
.
fl
(0);

298 
	gd•’d’c›s
->
	gkeyid
 = 
»que¡
.
keyid
;

299 
	gd•’d’c›s
->
	g£®_key_fu£s
 = 
£®_fu£s_
;

300 
	gd•’d’c›s
->
	gıusvn
 = 
»que¡
.
ıusvn
;

301 
S‘TrivŸlObjeùFromHexSŒšg
(
kH¬dcodedPkcs15PaddšgHex
,

302 &
d•’d’c›s
->
·ddšg
);

303 
	gd•’d’c›s
->
	gmisc£Ëù
 = (
misc£Ëù_
 & 
»que¡
.
miscmask
);

304 
	gd•’d’c›s
->
	gmiscmask
 = 
»que¡
.
miscmask
;

305 
	gd•’d’c›s
->
	gkeypŞicy
 = 
»que¡
.
keypŞicy
;

307 ià(
	g»que¡
.
	gkeypŞicy
 & 
	gkKeypŞicyCÚfigidB™Mask
) {

308 
	gd•’d’c›s
->
	gcÚfigid
 = 
cÚfigid_
;

309 
	gd•’d’c›s
->
	gcÚfigsvn
 = 
cÚfigsvn_
;

311 
	gd•’d’c›s
->
	gcÚfigid
.
fl
(0);

312 
	gd•’d’c›s
->
	gcÚfigsvn
 = 0;

316 
	gKey»que¡KeyÇme
::
REPORT_KEY
:

317 
d•’d’c›s
->
keyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

318 
	gd•’d’c›s
->
	gisvçmyid
.
fl
(0);

319 
	gd•’d’c›s
->
	gisvexrodid
.
fl
(0);

320 
	gd•’d’c›s
->
	gisv´odid
 = 0;

321 
	gd•’d’c›s
->
	gisvsvn
 = 0;

322 
	gd•’d’c›s
->
	gowÃ»poch
 = 
owÃ»poch_
;

323 
	gd•’d’c›s
->
	g©Œibu‹s
 = 
©Œibu‹s_
;

324 
CË¬SecsA‰ribu‹S‘
(&
d•’d’c›s
->
©Œibu‹mask
);

325 
	gd•’d’c›s
->
	gm»nşave
 = 
m»nşave_
;

326 
	gd•’d’c›s
->
	gmrsigÃr
.
fl
(0);

327 
	gd•’d’c›s
->
	gkeyid
 = 
»que¡
.
keyid
;

328 
	gd•’d’c›s
->
	g£®_key_fu£s
 = 
£®_fu£s_
;

329 
	gd•’d’c›s
->
	gıusvn
 = 
ıusvn_
;

330 
S‘TrivŸlObjeùFromHexSŒšg
(
kH¬dcodedPkcs15PaddšgHex
,

331 &
d•’d’c›s
->
·ddšg
);

332 
	gd•’d’c›s
->
	gmisc£Ëù
 = 
misc£Ëù_
;

333 
	gd•’d’c›s
->
	gmiscmask
 = 0;

334 
	gd•’d’c›s
->
	gkeypŞicy
 = 0;

335 
	gd•’d’c›s
->
	gcÚfigid
 = 
cÚfigid_
;

336 
	gd•’d’c›s
->
	gcÚfigsvn
 = 
cÚfigsvn_
;

340  
Stus
(

341 
SGX_ERROR_INVALID_KEYNAME
,

342 
ab¦
::
SŒC©
("Key‚am", 
¡©ic_ÿ¡
<
ušt64_t
>(
»que¡
.
keyÇme
),

345  
D”iveKey
(
key_d•’d’c›s
, 
key
);

348 
Stus
 
	gFakeEnşave
::
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
,

349 cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
,

350 
R•Üt
 *
»pÜt
) const {

354 ià(!
	gAligÃdT¬g‘šfoPŒ
::
IsAligÃd
(&
tšfo
) ||

355 !
AligÃdR•Ütd©aPŒ
::
IsAligÃd
(&
»pÜtd©a
) ||

356 !
AligÃdR•ÜtPŒ
::
IsAligÃd
(
»pÜt
)) {

357 
LOG
(
FATAL
) << "Parameters‡re‚ot correctly‡ligned";

365 
SecsA‰ribu‹S‘
 
	g®l_©Œibu‹s
;

366 
G‘AÎSecsA‰ribu‹s
(&
®l_©Œibu‹s
);

367 
SecsA‰ribu‹S‘
 
	g»£rved_©Œibu‹s
 = ~
®l_©Œibu‹s
;

368 
ušt32_t
 
	gmisc_£Ëù_»£rved_b™s
 = ~
kMisc£ËùAÎB™s
;

369 ià(
	gtšfo
.
	g»£rved1
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(
tšfo
.
»£rved1
)>() ||

370 
tšfo
.
»£rved2
 !ğ
TrivŸlZ”oObjeù
<
deşty³
(tinfo.reserved2)>() ||

371 (
tšfo
.
misc£Ëù
 & 
misc_£Ëù_»£rved_b™s
) != 0 ||

372 (
tšfo
.
©Œibu‹s
 & 
»£rved_©Œibu‹s
) !=

373 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>()) {

374 
LOG
(
FATAL
) << "Reserved fields/bits in input…arameters‡re‚ot zeroed.";

377 
	g»pÜt
->
	gıusvn
 = 
ıusvn_
;

378 
	g»pÜt
->
	gmisc£Ëù
 = 
misc£Ëù_
;

379 
	g»pÜt
->
	g»£rved1
.
fl
(0);

380 
	g»pÜt
->
	gisvexrodid
 = 
isvexrodid_
;

381 
	g»pÜt
->
	g©Œibu‹s
 = 
©Œibu‹s_
;

382 
	g»pÜt
->
	gm»nşave
 = 
m»nşave_
;

383 
	g»pÜt
->
	g»£rved2
.
fl
(0);

384 
	g»pÜt
->
	gmrsigÃr
 = 
mrsigÃr_
;

385 
	g»pÜt
->
	g»£rved3
.
fl
(0);

386 
	g»pÜt
->
	gcÚfigid
 = 
cÚfigid_
;

387 
	g»pÜt
->
	gisv´odid
 = 
isv´odid_
;

388 
	g»pÜt
->
	gisvsvn
 = 
isvsvn_
;

389 
	g»pÜt
->
	gcÚfigsvn
 = 
cÚfigsvn_
;

390 
	g»pÜt
->
	g»£rved4
.
fl
(0);

391 
	g»pÜt
->
	gisvçmyid
 = 
isvçmyid_
;

392 
	g»pÜt
->
	g»pÜtd©a
 = 
»pÜtd©a
;

393 
	g»pÜt
->
	gkeyid
 = 
»pÜt_keyid_
;

398 
KeyD•’d’c›s
 
	gkey_d•’d’c›s
;

399 
KeyD•’d’c›sBa£
 *
	gd•’d’c›s
 = &
key_d•’d’c›s
.
d•’d’c›s
;

401 
	gd•’d’c›s
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

402 
	gd•’d’c›s
->
	gisvçmyid
.
fl
(0);

403 
	gd•’d’c›s
->
	gisvexrodid
.
fl
(0);

404 
	gd•’d’c›s
->
	gisv´odid
 = 0;

405 
	gd•’d’c›s
->
	gisvsvn
 = 0;

406 
	gd•’d’c›s
->
	gowÃ»poch
 = 
owÃ»poch_
;

407 
	gd•’d’c›s
->
	g©Œibu‹s
 = 
tšfo
.
©Œibu‹s
;

408 
CË¬SecsA‰ribu‹S‘
(&
d•’d’c›s
->
©Œibu‹mask
);

409 
	gd•’d’c›s
->
	gm»nşave
 = 
tšfo
.
m—su»m’t
;

410 
	gd•’d’c›s
->
	gmrsigÃr
.
fl
(0);

411 
	gd•’d’c›s
->
	gkeyid
 = 
»pÜt_keyid_
;

412 
	gd•’d’c›s
->
	g£®_key_fu£s
 = 
£®_fu£s_
;

413 
	gd•’d’c›s
->
	gıusvn
 = 
ıusvn_
;

414 
S‘TrivŸlObjeùFromHexSŒšg
(
kH¬dcodedPkcs15PaddšgHex
,

415 &
d•’d’c›s
->
·ddšg
);

416 
	gd•’d’c›s
->
	gmisc£Ëù
 = 
tšfo
.
misc£Ëù
;

417 
	gd•’d’c›s
->
	gmiscmask
 = 0;

418 
	gd•’d’c›s
->
	gkeypŞicy
 = 0;

419 
	gd•’d’c›s
->
	gcÚfigid
 = 
tšfo
.
cÚfigid
;

420 
	gd•’d’c›s
->
	gcÚfigsvn
 = 
tšfo
.
cÚfigsvn
;

422 
	gSaãBy‹s
<
	gkH¬dw¬eKeySize
> 
	g»pÜt_key
;

423 
ASYLO_RETURN_IF_ERROR
(
D”iveKey
(
key_d•’d’c›s
, &
»pÜt_key
));

428 ià(
	g»pÜt
->
	gmac
.
size
(è!ğ
AES_BLOCK_SIZE
) {

429  
Stus
(

430 
SGX_ERROR_INVALID_PARAMETER
,

434 ià(
AES_CMAC
(
»pÜt
->
mac
.
d©a
(), 
»pÜt_key
.d©a(),„•Üt_key.
size
(),

435 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
»pÜt
),

436 
off£tof
(
R•Üt
, 
keyid
)) != 1) {

438 
»pÜt
->
mac
.
CËª£
();

439  
Stus
(
SGX_ERROR_UNEXPECTED
, 
Bs¦La¡E¼ÜSŒšg
());

441  
	gStus
::
OkStus
();

444 
Stus
 
	gFakeEnşave
::
D”iveKey
(cÚ¡ 
KeyD•’d’c›s
 &
key_d•’d’c›s
,

445 
H¬dw¬eKey
 *
key
) const {

446 
¡©ic_as£¹
(
H¬dw¬eKey
::
size
(è=ğ
AES_BLOCK_SIZE
,

449 ià(
AES_CMAC
(
key
->
d©a
(), 
roÙ_key_
.d©a(),„oÙ_key_.
size
(),

450 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
key_d•’d’c›s
),

451 (
key_d•’d’c›s
)) != 1) {

453 
key
->
CËª£
();

454  
Stus
(
SGX_ERROR_UNEXPECTED
, 
Bs¦La¡E¼ÜSŒšg
());

456  
	gStus
::
OkStus
();

	@identity/sgx/fake_enclave.h

19 #iâdeà
ASYLO_IDENTITY_SGX_FAKE_ENCLAVE_H_


20 
	#ASYLO_IDENTITY_SGX_FAKE_ENCLAVE_H_


	)

22 
	~<İ’s¦/sha.h
>

24 
	~<veùÜ
>

26 
	~"ab¦/ba£/©Œibu‹s.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

29 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

30 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

31 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

32 
	~"asylo/ut/¡©us.h
"

33 
	~"asylo/ut/¡©usÜ.h
"

35 #ifdeà
__ASYLO__


40 
Çme¥aû
 
	gasylo
 {

41 
Çme¥aû
 
	gsgx
 {

44 
cÚ¡ex´
 
size_t
 
	gkOwÃrEpochSize
 = 16;

47 
cÚ¡ex´
 
size_t
 
	gkPkcs15PaddšgSize
 = 352;

53 
cÚ¡ex´
 
SecsA‰ribu‹S‘
 
	gkRequœedS—lšgA‰ribu‹sMask
 = {0x3, 0x0};

86 şas 
	cFakeEnşave
 {

87 
	gpublic
:

88 
FakeEnşave
();

89 
FakeEnşave
(cÚ¡ FakeEnşav&
Ùh”
) = ;

90 
	gFakeEnşave
 &
	gİ”©Ü
=(cÚ¡ 
FakeEnşave
 &
Ùh”
) = ;

96 
FakeEnşave
 *
G‘Cu¼’tEnşave
();

103 
EÁ”Enşave
(cÚ¡ 
FakeEnşave
 &
’şave
);

109 
Ex™Enşave
();

112 
£t_m»nşave
(cÚ¡ 
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
> &
v®ue
) {

113 
	gm»nşave_
 = 
v®ue
;

115 
£t_mrsigÃr
(cÚ¡ 
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
> &
v®ue
) {

116 
	gmrsigÃr_
 = 
v®ue
;

118 
£t_isv´odid
(
ušt16_t
 
v®ue
è{ 
	gisv´odid_
 = value; }

119 
£t_isvsvn
(
ušt16_t
 
v®ue
è{ 
	gisvsvn_
 = value; }

120 
£t_©Œibu‹s
(cÚ¡ 
SecsA‰ribu‹S‘
 &
v®ue
) {

121 
	g©Œibu‹s_
 = (
v®ue
 & 
v®id_©Œibu‹s_
è| 
»quœed_©Œibu‹s_
;

123 
£t_misc£Ëù
(
ušt32_t
 
v®ue
è{ 
	gmisc£Ëù_
 = value; }

124 
£t_cÚfigsvn
(
ušt16_t
 
v®ue
è{ 
	gcÚfigsvn_
 = value; }

125 
£t_isvçmyid
(cÚ¡ 
Un§ãBy‹s
<
kIsvçmyidSize
> &
v®ue
) {

126 
	gisvçmyid_
 = 
v®ue
;

128 
£t_isvexrodid
(cÚ¡ 
Un§ãBy‹s
<
kIsvexrodidSize
> &
v®ue
) {

129 
	gisvexrodid_
 = 
v®ue
;

131 
£t_cÚfigid
(cÚ¡ 
Un§ãBy‹s
<
kCÚfigidSize
> &
v®ue
) {

132 
	gcÚfigid_
 = 
v®ue
;

134 
£t_ıusvn
(cÚ¡ 
Un§ãBy‹s
<
kCpusvnSize
> &
v®ue
è{ 
	gıusvn_
 = value; }

135 
£t_»pÜt_keyid
(cÚ¡ 
Un§ãBy‹s
<
kR•ÜtKeyidSize
> &
v®ue
) {

136 
	g»pÜt_keyid_
 = 
v®ue
;

138 
£t_owÃ»poch
(cÚ¡ 
SaãBy‹s
<
kOwÃrEpochSize
> &
v®ue
) {

139 
	gowÃ»poch_
 = 
v®ue
;

141 
£t_roÙ_key
(cÚ¡ 
SaãBy‹s
<
SHA256_DIGEST_LENGTH
> &
v®ue
) {

142 
	groÙ_key_
 = 
v®ue
;

144 
£t_£®_fu£s
(cÚ¡ 
SaãBy‹s
<
AES_BLOCK_SIZE
> &
v®ue
) {

145 
	g£®_fu£s_
 = 
v®ue
;

147 
£t_v®id_©Œibu‹s
(cÚ¡ 
SecsA‰ribu‹S‘
 &
v®ue
) {

148 
	gv®id_©Œibu‹s_
 = 
v®ue
;

150 
add_v®id_©Œibu‹
(
SecsA‰ribu‹B™
 
b™
) {

151 
	gv®id_©Œibu‹s_
 |ğ
MakeSecsA‰ribu‹S‘
({
b™
}).
V®ueOrD›
();

153 
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
 
b™
) {

154 
	gv®id_©Œibu‹s_
 &ğ~
MakeSecsA‰ribu‹S‘
({
b™
}).
V®ueOrD›
();

156 
£t_»quœed_©Œibu‹s
(cÚ¡ 
SecsA‰ribu‹S‘
 &
v®ue
) {

157 
	g»quœed_©Œibu‹s_
 = 
v®ue
;

159 
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
 
b™
) {

160 
	g»quœed_©Œibu‹s_
 |ğ
MakeSecsA‰ribu‹S‘
({
b™
}).
V®ueOrD›
();

162 
»move_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
 
b™
) {

163 
	g»quœed_©Œibu‹s_
 &ğ~
MakeSecsA‰ribu‹S‘
({
b™
}).
V®ueOrD›
();

167 cÚ¡ 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> &
g‘_m»nşave
() const {

168  
	gm»nşave_
;

170 cÚ¡ 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> &
g‘_mrsigÃr
() const {

171  
	gmrsigÃr_
;

173 
ušt16_t
 
g‘_isv´odid
(ècÚ¡ {  
	gisv´odid_
; }

174 
ušt16_t
 
g‘_isvsvn
(ècÚ¡ {  
	gisvsvn_
; }

175 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
g‘_©Œibu‹s
(ècÚ¡ {  
	g©Œibu‹s_
; }

176 
ušt32_t
 
g‘_misc£Ëù
(ècÚ¡ {  
	gmisc£Ëù_
; }

177 
ušt16_t
 
g‘_cÚfigsvn
(ècÚ¡ {  
	gcÚfigsvn_
; }

178 cÚ¡ 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> &
g‘_isvexrodid
() const {

179  
	gisvexrodid_
;

181 cÚ¡ 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> &
g‘_isvçmyid
() const {

182  
	gisvçmyid_
;

184 cÚ¡ 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> &
g‘_cÚfigid
(ècÚ¡ {  
	gcÚfigid_
; }

185 cÚ¡ 
	gUn§ãBy‹s
<
	gkCpusvnSize
> &
g‘_ıusvn
(ècÚ¡ {  
	gıusvn_
; }

186 cÚ¡ 
	gUn§ãBy‹s
<
	gkR•ÜtKeyidSize
> &
g‘_»pÜt_keyid
() const {

187  
	g»pÜt_keyid_
;

189 cÚ¡ 
	gSaãBy‹s
<
	gkOwÃrEpochSize
> &
g‘_owÃ»poch
() const {

190  
	gowÃ»poch_
;

192 cÚ¡ 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> &
g‘_roÙ_key
() const {

193  
	groÙ_key_
;

195 cÚ¡ 
	gSaãBy‹s
<
	gAES_BLOCK_SIZE
> &
g‘_£®_fu£s
() const {

196  
	g£®_fu£s_
;

198 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
g‘_v®id_©Œibu‹s
() const {

199  
	gv®id_©Œibu‹s_
;

201 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
g‘_»quœed_©Œibu‹s
() const {

202  
	g»quœed_©Œibu‹s_
;

208 
S‘RªdomId’t™y
();

212 
S‘Id’t™y
(cÚ¡ 
CodeId’t™y
 &
id’t™y
);

215 
	gStusOr
<
	gCodeId’t™y
> 
G‘Id’t™y
() const;

218 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
FakeEnşave
 &
Ùh”
) const;

221 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
FakeEnşave
 &
Ùh”
) const;

224 
Stus
 
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
);

227 
Stus
 
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
, 
H¬dw¬eKey
 *
key
) const;

230 
Stus
 
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
,

231 cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
, 
R•Üt
 *
»pÜt
) const;

233 
	g´iv©e
:

253 
	sKeyD•’d’c›sBa£
 {

254 
Key»que¡KeyÇme
 
keyÇme
;

255 
ušt16_t
 
	gisv´odid
;

256 
ušt16_t
 
	gisvsvn
;

257 
	gSaãBy‹s
<
	gkOwÃrEpochSize
> 
	gowÃ»poch
;

258 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

259 
SecsA‰ribu‹S‘
 
	g©Œibu‹mask
;

260 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gm»nşave
;

261 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gmrsigÃr
;

262 
	gUn§ãBy‹s
<
	gkKey»que¡KeyidSize
> 
	gkeyid
;

263 
	gSaãBy‹s
<
	gAES_BLOCK_SIZE
> 
	g£®_key_fu£s
;

264 
	gUn§ãBy‹s
<
	gkCpusvnSize
> 
	gıusvn
;

265 
	gUn§ãBy‹s
<
	gkPkcs15PaddšgSize
> 
	g·ddšg
;

266 
ušt32_t
 
	gmisc£Ëù
;

267 
ušt32_t
 
	gmiscmask
;

268 
ušt16_t
 
	gkeypŞicy
;

269 
ušt16_t
 
	gcÚfigsvn
;

270 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	gisvexrodid
;

271 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	gisvçmyid
;

272 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	gcÚfigid
;

273 } 
	gABSL_ATTRIBUTE_PACKED
;

286 
usšg
 
	gKeyD•’d’c›sPaddšg
 =

287 
Un§ãBy‹s
<8192 - (
KeyD•’d’c›sBa£
)>;

289 
	sKeyD•’d’c›s
 {

290 
KeyD•’d’c›s
(è: 
·ddšg
(
TrivŸlZ”oObjeù
<
KeyD•’d’c›sPaddšg
>()) {}

292 
KeyD•’d’c›sBa£
 
d•’d’c›s
;

293 cÚ¡ 
KeyD•’d’c›sPaddšg
 
	g·ddšg
;

294 } 
	gABSL_ATTRIBUTE_PACKED
;

296 
¡©ic_as£¹
((
KeyD•’d’c›s
) == 8192,

310 
Stus
 
D”iveKey
(cÚ¡ 
KeyD•’d’c›s
 &
key_d•’d’c›s
,

311 
H¬dw¬eKey
 *
key
) const;

314 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gm»nşave_
;

317 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gmrsigÃr_
;

320 
ušt16_t
 
	gisv´odid_
;

323 
ušt16_t
 
	gisvsvn_
;

326 
SecsA‰ribu‹S‘
 
	g©Œibu‹s_
;

329 
ušt32_t
 
	gmisc£Ëù_
;

332 
ušt16_t
 
	gcÚfigsvn_
;

335 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	gisvexrodid_
;

338 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	gisvçmyid_
;

341 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	gcÚfigid_
;

344 
	gUn§ãBy‹s
<
	gkCpusvnSize
> 
	gıusvn_
;

347 
	gUn§ãBy‹s
<
	gkR•ÜtKeyidSize
> 
	g»pÜt_keyid_
;

350 
	gSaãBy‹s
<
	gkOwÃrEpochSize
> 
	gowÃ»poch_
;

355 
	gSaãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	groÙ_key_
;

360 
	gSaãBy‹s
<
	gAES_BLOCK_SIZE
> 
	g£®_fu£s_
;

364 
SecsA‰ribu‹S‘
 
	gv®id_©Œibu‹s_
;

368 
SecsA‰ribu‹S‘
 
	g»quœed_©Œibu‹s_
;

371 
FakeEnşave
 *
	gcu¼’t_
;

376 
	sRªdomFakeEnşaveFaùÜy
 {

377 
usšg
 
	gv®ue_ty³
 = 
FakeEnşave
;

378 
FakeEnşave
 *
CÚ¡ruù
() {

379 
FakeEnşave
 *
	g’şave
 = 
Ãw
 FakeEnclave();

380 
	g’şave
->
S‘RªdomId’t™y
();

381  
	g’şave
;

383 
De¡ruù
(
FakeEnşave
 *
’şave
è{ 
d–‘e
 
	g’şave
; }

	@identity/sgx/fake_hardware_interface.cc

22 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

24 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

25 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

27 #ifdeà
__ASYLO__


31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsgx
 {

33 
	gÇme¥aû
 {

35 
FakeEnşave
 *
S‘NewRªdomEnşave
() {

36 
FakeEnşave
 
	gÃw_’şave
;

37 
	gÃw_’şave
.
S‘RªdomId’t™y
();

38 
	gFakeEnşave
::
EÁ”Enşave
(
Ãw_’şave
);

39  
	gFakeEnşave
::
G‘Cu¼’tEnşave
();

44 
Stus
 
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
) {

45  
	gFakeEnşave
::
G‘H¬dw¬eRªd64
(
v®ue
);

48 
Stus
 
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
, 
H¬dw¬eKey
 *
key
) {

49 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

51 ià(
	g’şave
 =ğ
nuÎ±r
) {

52 
’şave
 = 
S‘NewRªdomEnşave
();

54  
	g’şave
->
G‘H¬dw¬eKey
(
»que¡
, 
key
);

57 
Stus
 
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
, cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
,

58 
R•Üt
 *
»pÜt
) {

59 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

61 ià(
	g’şave
 =ğ
nuÎ±r
) {

62 
’şave
 = 
S‘NewRªdomEnşave
();

65  
	g’şave
->
G‘H¬dw¬eR•Üt
(
tšfo
, 
»pÜtd©a
, 
»pÜt
);

	@identity/sgx/fake_hardware_interface.cc

22 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

24 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

25 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

27 #ifdeà
__ASYLO__


31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsgx
 {

33 
	gÇme¥aû
 {

35 
FakeEnşave
 *
S‘NewRªdomEnşave
() {

36 
FakeEnşave
 
	gÃw_’şave
;

37 
	gÃw_’şave
.
S‘RªdomId’t™y
();

38 
	gFakeEnşave
::
EÁ”Enşave
(
Ãw_’şave
);

39  
	gFakeEnşave
::
G‘Cu¼’tEnşave
();

44 
Stus
 
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
) {

45  
	gFakeEnşave
::
G‘H¬dw¬eRªd64
(
v®ue
);

48 
Stus
 
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
, 
H¬dw¬eKey
 *
key
) {

49 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

51 ià(
	g’şave
 =ğ
nuÎ±r
) {

52 
’şave
 = 
S‘NewRªdomEnşave
();

54  
	g’şave
->
G‘H¬dw¬eKey
(
»que¡
, 
key
);

57 
Stus
 
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
, cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
,

58 
R•Üt
 *
»pÜt
) {

59 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

61 ià(
	g’şave
 =ğ
nuÎ±r
) {

62 
’şave
 = 
S‘NewRªdomEnşave
();

65  
	g’şave
->
G‘H¬dw¬eR•Üt
(
tšfo
, 
»pÜtd©a
, 
»pÜt
);

	@identity/sgx/fake_hardware_interface_test.cc

19 
	~<İ’s¦/«s.h
>

20 
	~<İ’s¦/cmac.h
>

22 
	~<lim™s
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

30 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

31 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

32 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

33 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

34 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

35 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

36 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
Çme¥aû
 
	gsgx
 {

44 
	gÇme¥aû
 {

46 
	gusšg
 ::
‹¡šg
::
NÙ
;

48 
usšg
 
	gM—su»m’t
 = 
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>;

49 
usšg
 
	gKeyid
 = 
Un§ãBy‹s
<
kR•ÜtKeyidSize
>;

51 
	g‹m¶©e
 <
şass
 
	gT1
, cÏs 
	gT2
>

52 
	g¡d
::
¡ršg
 
HexDumpObjeùPaœ
(cÚ¡ *
obj1_Çme
, 
T1
 
obj1
,

53 cÚ¡ *
obj2_Çme
, 
T2
 
obj2
) {

54  
	gab¦
::
SŒC©
(
obj1_Çme
, ":\n", 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj1
),

55 "\n", 
obj2_Çme
, ":\n",

56 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj2
), "\n");

59 
FlLowFourB™s
(
ušt8_t
 *
d©a
) {

60 *
	gd©a
 ^ğ
TrivŸlRªdomObjeù
<
ušt8_t
>(è& 
¡©ic_ÿ¡
<uint8_t>(0xF);

63 şas 
	cFakeEnşaveTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

64 
´Ùeùed
:

65 
FakeEnşaveTe¡
() {

67 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
do_nÙ_ÿ»_©Œibu‹s_
);

68 
	g®ways_ÿ»_©Œibu‹s_
 = 
kRequœedS—lšgA‰ribu‹sMask
;

71 
	g’şave_
.
add_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

75 
	g’şave_
.
S‘RªdomId’t™y
();

78 *
	g£®_key_»que¡_
 = 
TrivŸlZ”oObjeù
<
Key»que¡
>();

80 
	g£®_key_»que¡_
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
SEAL_KEY
;

82 
	g£®_key_»que¡_
->
	gkeypŞicy
 =

83 
kKeypŞicyM»nşaveB™Mask
 | 
kKeypŞicyMrsigÃrB™Mask
;

87 
	g£®_key_»que¡_
->
	g©Œibu‹mask
 = ~
do_nÙ_ÿ»_©Œibu‹s_
;

89 
	g£®_key_»que¡_
->
	gkeyid
 = 
TrivŸlRªdomObjeù
<
Keyid
>();

93 
	g£®_key_»que¡_
->
	gmiscmask
 = 0xffffffff;

96 *
	g»pÜt_key_»que¡_
 = *
£®_key_»que¡_
;

97 
	g»pÜt_key_»que¡_
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

100 
ušt16_t
 
G’”©eRªdomKeypŞicy
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
) {

101 
ušt16_t
 
	gkeypŞicy_v®id_b™s
 =

102 
kKeypŞicyM»nşaveB™Mask
 | 
kKeypŞicyMrsigÃrB™Mask
;

103 ià(
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
::
KSS
, 
©Œibu‹s
)) {

104 
	gkeypŞicy_v®id_b™s
 |ğ
kKeypŞicyKssB™s
;

106  
	gTrivŸlRªdomObjeù
<
	gušt16_t
>(è& 
	gkeypŞicy_v®id_b™s
;

109 
FakeEnşave
 
	g’şave_
;

110 
AligÃdKey»que¡PŒ
 
	g£®_key_»que¡_
;

111 
AligÃdKey»que¡PŒ
 
	g»pÜt_key_»que¡_
;

112 
SecsA‰ribu‹S‘
 
	gdo_nÙ_ÿ»_©Œibu‹s_
;

113 
SecsA‰ribu‹S‘
 
	g®ways_ÿ»_©Œibu‹s_
;

118 
TEST_F
(
FakeEnşaveTe¡
, 
Cu¼’tEnşave
) {

119 
EXPECT_EQ
(
FakeEnşave
::
G‘Cu¼’tEnşave
(), 
nuÎ±r
);

120 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

122 
FakeEnşave
 *
	gcu¼’t_’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

123 
ASSERT_NE
(
cu¼’t_’şave
, 
nuÎ±r
);

126 
ASSERT_EQ
(
FakeEnşave
::
G‘Cu¼’tEnşave
(), 
cu¼’t_’şave
);

130 
EXPECT_EQ
(*
cu¼’t_’şave
, 
’şave_
è<< 
HexDumpObjeùPaœ
(

131 "LHS FakeEnşav(*cu¼’t_’şave)", *
cu¼’t_’şave
,

132 "RHS FakeEnşavÓnşave_)", 
’şave_
);

134 
	gFakeEnşave
::
Ex™Enşave
();

135 
EXPECT_EQ
(
FakeEnşave
::
G‘Cu¼’tEnşave
(), 
nuÎ±r
);

141 
TEST_F
(
FakeEnşaveTe¡
, 
G‘H¬dw¬eRªd
) {

142 
ušt64_t
 
	gfœ¡_v®ue
 = 0;

143 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eRªd64
(&
fœ¡_v®ue
));

144 
	gcŞlisiÚ_couÁ
 = 0;

145 
	gi
 = 0; i < 3; i++) {

146 
ušt64_t
 
	gÃw_v®ue
 = 0;

147 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eRªd64
(&
Ãw_v®ue
));

148 ià(
	gfœ¡_v®ue
 =ğ
Ãw_v®ue
) {

149 
cŞlisiÚ_couÁ
++;

152 
EXPECT_NE
(
cŞlisiÚ_couÁ
, 3);

156 
TEST_F
(
FakeEnşaveTe¡
, 
S‘Id’t™y
) {

157 
	g’şave_
.
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

158 
	g’şave_
.
S‘RªdomId’t™y
();

159 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

160 
CodeId’t™y
 
	gid’t™y
 = 
G‘S–fId’t™y
()->
id’t™y
;

161 
	gFakeEnşave
::
Ex™Enşave
();

163 
FakeEnşave
 
	g’şave2
;

164 
	g’şave2
.
S‘Id’t™y
(
id’t™y
);

166 
	gFakeEnşave
::
EÁ”Enşave
(
’şave2
);

167 
CodeId’t™y
 
	gid’t™y2
 = 
G‘S–fId’t™y
()->
id’t™y
;

169 
EXPECT_THAT
(
id’t™y
, 
Equ®sPrÙo
(
id’t™y2
));

170 
	gFakeEnşave
::
Ex™Enşave
();

173 
TEST_F
(
FakeEnşaveTe¡
, 
G‘Id’t™y
) {

174 
FakeEnşave
 
	g’şave1
;

175 
	g’şave1
.
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

176 
	g’şave1
.
S‘RªdomId’t™y
();

178 autØ
	gid’t™y_»suÉ
 = 
’şave1
.
G‘Id’t™y
();

179 
ASYLO_ASSERT_OK
(
id’t™y_»suÉ
.
¡©us
());

180 
CodeId’t™y
 
	gid’t™y
 = 
id’t™y_»suÉ
.
V®ueOrD›
();

182 
	gFakeEnşave
::
EÁ”Enşave
(
’şave1
);

183 
EXPECT_THAT
(
id’t™y
, 
Equ®sPrÙo
(
G‘S–fId’t™y
()->identity));

184 
	gFakeEnşave
::
Ex™Enşave
();

186 
FakeEnşave
 
	g’şave2
;

187 
	g’şave2
.
S‘Id’t™y
(
id’t™y
);

189 
EXPECT_THAT
(
’şave2
.
G‘Id’t™y
(), 
IsOkAndHŞds
(
Equ®sPrÙo
(
id’t™y
)));

191 
FakeEnşave
 
	g’şave3
;

192 
	g’şave3
.
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

193 
	g’şave3
.
S‘RªdomId’t™y
();

198 
EXPECT_THAT
(
’şave3
.
G‘Id’t™y
(), 
IsOkAndHŞds
(
NÙ
(
Equ®sPrÙo
(
id’t™y
))));

206 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyG’”©esNÚZ”oKey
) {

207 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

209 
AligÃdH¬dw¬eKeyPŒ
 
	gkey
;

210 
	gkey
->
fl
(0);

211 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
£®_key_»que¡_
, 
key
.
g‘
()));

213 
H¬dw¬eKey
 
	gz”o_key
;

214 
	gz”o_key
.
fl
(0);

215 
EXPECT_NE
(*
key
, 
z”o_key
)

216 << "G‘H¬dw¬eKey„‘uºed z”Økey." << 
	g¡d
::
’dl


217 << 
HexDumpObjeùPaœ
("Enşave", 
’şave_
, "Keyrequest",

218 *
£®_key_»que¡_
);

219 
	gFakeEnşave
::
Ex™Enşave
();

225 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hM»nşave
) {

226 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

227 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

228 
AligÃdKey»que¡PŒ
 
	g»que¡
;

229 *
	g»que¡
 = *
£®_key_»que¡_
;

230 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

232 
	gi
 = 0; i < 1000; i++) {

233 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

234 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

235 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

238 
	g’şave
->
£t_m»nşave
(
TrivŸlRªdomObjeù
<
M—su»m’t
>());

239 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

240 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

245 
boŞ
 
	gex³ù_key_chªge
 =

246 (
»que¡
->
keypŞicy
 & 
kKeypŞicyM»nşaveB™Mask
) != 0;

247 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

248 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

250 
	gFakeEnşave
::
Ex™Enşave
();

256 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hMrsigÃr
) {

257 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

258 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

259 
AligÃdKey»que¡PŒ
 
	g»que¡
;

260 *
	g»que¡
 = *
£®_key_»que¡_
;

261 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

263 
	gi
 = 0; i < 1000; i++) {

264 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

265 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

266 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

269 
	g’şave
->
£t_mrsigÃr
(
TrivŸlRªdomObjeù
<
M—su»m’t
>());

270 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

271 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

276 
boŞ
 
	gex³ù_key_chªge
 =

277 (
»que¡
->
keypŞicy
 & 
kKeypŞicyMrsigÃrB™Mask
) != 0;

278 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

279 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

281 
	gFakeEnşave
::
Ex™Enşave
();

286 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsv´odid
) {

289 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

290 
	g’şave_
.
S‘RªdomId’t™y
();

292 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

293 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

294 
AligÃdKey»que¡PŒ
 
	g»que¡
;

295 *
	g»que¡
 = *
£®_key_»que¡_
;

296 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

298 
	gi
 = 0; i < 1000; i++) {

299 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

300 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

301 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

304 
ušt16_t
 
	g´ev_isv´odid
 = 
’şave
->
g‘_isv´odid
();

305 
	g’şave
->
£t_isv´odid
(
TrivŸlRªdomObjeù
<
ušt16_t
>() & 0x0F);

306 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

307 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

311 
boŞ
 
	gex³ù_key_chªge
 =

312 (
’şave
->
g‘_isv´odid
(è!ğ
´ev_isv´odid
) &&

313 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyNoisv´odidB™Mask
) == 0);

314 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

315 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

317 
	gFakeEnşave
::
Ex™Enşave
();

321 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsvsvn
) {

322 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

323 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

324 
AligÃdKey»que¡PŒ
 
	g»que¡
;

325 *
	g»que¡
 = *
£®_key_»que¡_
;

326 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

328 
	g»que¡
->
	gisvsvn
 = 
’şave
->
g‘_isvsvn
();

329 
	gi
 = 0; i < 1000; i++) {

330 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

331 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

332 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

335 
ušt16_t
 
	g´ev_isvsvn
 = 
’şave
->
g‘_isvsvn
();

336 
ušt16_t
 
	gisvsvn
 = 
TrivŸlRªdomObjeù
<uint16_t>() & 0x0F;

337 
	g’şave
->
£t_isvsvn
(
isvsvn
);

338 
	g»que¡
->
	gisvsvn
 = 
isvsvn
;

339 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

340 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

344 
boŞ
 
	gex³ù_key_chªge
 = (
isvsvn
 !ğ
´ev_isvsvn
);

345 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

346 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

348 
	gFakeEnşave
::
Ex™Enşave
();

353 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hA‰ribu‹s
) {

354 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

355 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

356 
AligÃdKey»que¡PŒ
 
	g»que¡
;

357 *
	g»que¡
 = *
£®_key_»que¡_
;

358 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

360 
	g’şave
->
£t_©Œibu‹s
(
TrivŸlRªdomObjeù
<
SecsA‰ribu‹S‘
>());

361 
SecsA‰ribu‹S‘
 
	gÃxt
 = 
’şave
->
g‘_©Œibu‹s
();

362 
	gi
 = 0; i < 1000; i++) {

363 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

364 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

371 
SecsA‰ribu‹S‘
 
	g´ev
 = 
’şave
->
g‘_©Œibu‹s
();

372 
	g’şave
->
£t_©Œibu‹s
(
TrivŸlRªdomObjeù
<
SecsA‰ribu‹S‘
>());

373 
	gÃxt
 = 
’şave
->
g‘_©Œibu‹s
();

374 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

375 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

379 
boŞ
 
	gex³ù_key_chªge
 =

380 (
´ev
 & ~
do_nÙ_ÿ»_©Œibu‹s_
è!ğ(
Ãxt
 & ~do_not_care_attributes_);

381 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

382 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

384 
	gFakeEnşave
::
Ex™Enşave
();

389 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hMisc£Ëù
) {

390 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

391 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

392 
AligÃdKey»que¡PŒ
 
	g»que¡
;

393 *
	g»que¡
 = *
£®_key_»que¡_
;

394 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

397 
	g’şave
->
£t_misc£Ëù
(
TrivŸlRªdomObjeù
<
ušt32_t
>(è& 
kMisc£ËùAÎB™s
);

398 
	gi
 = 0; i < 100; i++) {

399 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

400 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

401 
ušt32_t
 
	g´ev
 = 
’şave
->
g‘_misc£Ëù
();

402 
	g’şave
->
£t_misc£Ëù
(
TrivŸlRªdomObjeù
<
ušt32_t
>() &

403 
kMisc£ËùAÎB™s
);

404 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

405 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

409 
boŞ
 
	gex³ù_key_chªge
 = (
´ev
 !ğ
’şave
->
g‘_misc£Ëù
());

410 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

411 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

413 
	gFakeEnşave
::
Ex™Enşave
();

418 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsvçmyid
) {

421 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

422 
	g’şave_
.
S‘RªdomId’t™y
();

424 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

425 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

426 
AligÃdKey»que¡PŒ
 
	g»que¡
;

427 *
	g»que¡
 = *
£®_key_»que¡_
;

428 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

430 
	gi
 = 0; i < 1000; i++) {

431 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

432 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

433 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

436 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	g´ev_isvçmyid
 = 
’şave
->
g‘_isvçmyid
();

437 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	gisvçmyid
 = 
´ev_isvçmyid
;

438 
FlLowFourB™s
(
isvçmyid
.
d©a
());

439 
	g’şave
->
£t_isvçmyid
(
isvçmyid
);

440 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

441 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

445 
boŞ
 
	gex³ù_key_chªge
 =

446 (
isvçmyid
 !ğ
´ev_isvçmyid
) &&

447 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyIsvçmyidB™Mask
) != 0);

448 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

449 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

451 
	gFakeEnşave
::
Ex™Enşave
();

456 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsvexrodid
) {

459 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

460 
	g’şave_
.
S‘RªdomId’t™y
();

462 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

463 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

464 
AligÃdKey»que¡PŒ
 
	g»que¡
;

465 *
	g»que¡
 = *
£®_key_»que¡_
;

466 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

468 
	gi
 = 0; i < 1000; i++) {

469 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

470 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

471 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

474 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	g´ev_isvexrodid
 =

475 
’şave
->
g‘_isvexrodid
();

476 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	gisvexrodid
 = 
´ev_isvexrodid
;

477 
FlLowFourB™s
(
isvexrodid
.
d©a
());

478 
	g’şave
->
£t_isvexrodid
(
isvexrodid
);

479 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

480 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

484 
boŞ
 
	gex³ù_key_chªge
 =

485 (
isvexrodid
 !ğ
´ev_isvexrodid
) &&

486 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyIsvexrodidB™Mask
) != 0);

487 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

488 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

490 
	gFakeEnşave
::
Ex™Enşave
();

495 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hCÚfigid
) {

498 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

499 
	g’şave_
.
S‘RªdomId’t™y
();

501 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

502 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

503 
AligÃdKey»que¡PŒ
 
	g»que¡
;

504 *
	g»que¡
 = *
£®_key_»que¡_
;

505 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

507 
	gi
 = 0; i < 1000; i++) {

508 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

509 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

510 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

513 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	g´ev_cÚfigid
 = 
’şave
->
g‘_cÚfigid
();

514 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	gcÚfigid
 = 
´ev_cÚfigid
;

515 
FlLowFourB™s
(
cÚfigid
.
d©a
());

516 
	g’şave
->
£t_cÚfigid
(
cÚfigid
);

517 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

518 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

522 
boŞ
 
	gex³ù_key_chªge
 =

523 (
cÚfigid
 !ğ
´ev_cÚfigid
) &&

524 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyCÚfigidB™Mask
) != 0);

525 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

526 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

528 
	gFakeEnşave
::
Ex™Enşave
();

533 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hCÚfigsvn
) {

536 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

537 
	g’şave_
.
S‘RªdomId’t™y
();

539 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

540 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

541 
AligÃdKey»que¡PŒ
 
	g»que¡
;

542 *
	g»que¡
 = *
£®_key_»que¡_
;

543 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

545 
	g»que¡
->
	gcÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
();

546 
	gi
 = 0; i < 1000; i++) {

547 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

548 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

549 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

552 
ušt16_t
 
	g´ev_cÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
();

553 
ušt16_t
 
	gcÚfigsvn
 = 
´ev_cÚfigsvn
;

554 
FlLowFourB™s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
cÚfigsvn
));

555 
	g’şave
->
£t_cÚfigsvn
(
cÚfigsvn
);

556 
	g»que¡
->
	gcÚfigsvn
 = 
cÚfigsvn
;

557 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

558 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

562 
boŞ
 
	gex³ù_key_chªge
 =

563 (
cÚfigsvn
 !ğ
´ev_cÚfigsvn
) &&

564 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyCÚfigidB™Mask
) != 0);

565 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

566 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

568 
	gFakeEnşave
::
Ex™Enşave
();

574 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyIsvsvnAcûssCÚŒŞ
) {

575 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

576 
AligÃdH¬dw¬eKeyPŒ
 
	gkey
;

577 
AligÃdKey»que¡PŒ
 
	g»que¡
;

578 *
	g»que¡
 = *
£®_key_»que¡_
;

579 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

582 
	g’şave
->
g‘_isvsvn
() == 0 ||

583 
’şave
->
g‘_isvsvn
(è=ğ
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
()) {

584 
’şave
->
£t_isvsvn
(
TrivŸlRªdomObjeù
<
ušt16_t
>());

588 
	g»que¡
->
	gisvsvn
 = 
’şave
->
g‘_isvsvn
() - 1;

589 
ASYLO_EXPECT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()))

590 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

593 
	g»que¡
->
	gisvsvn
 = 
’şave
->
g‘_isvsvn
() + 1;

594 
EXPECT_THAT
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()),

595 
StusIs
(
SGX_ERROR_INVALID_ISVSVN
))

596 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

597 
	gFakeEnşave
::
Ex™Enşave
();

603 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyCÚfigsvnAcûssCÚŒŞ
) {

606 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

607 
	g’şave_
.
S‘RªdomId’t™y
();

609 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

610 
AligÃdH¬dw¬eKeyPŒ
 
	gkey
;

611 
AligÃdKey»que¡PŒ
 
	g»que¡
;

612 *
	g»que¡
 = *
£®_key_»que¡_
;

613 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

616 
	g’şave
->
g‘_cÚfigsvn
() == 0 ||

617 
’şave
->
g‘_cÚfigsvn
(è=ğ
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
()) {

618 
’şave
->
£t_cÚfigsvn
(
TrivŸlRªdomObjeù
<
ušt16_t
>());

622 
	g»que¡
->
	gcÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
() - 1;

623 
ASYLO_EXPECT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()))

624 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

627 
	g»que¡
->
	gcÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
() + 1;

628 
EXPECT_THAT
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()),

629 
StusIs
(
SGX_ERROR_INVALID_ISVSVN
))

630 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

631 
	gFakeEnşave
::
Ex™Enşave
();

635 
TEST_F
(
FakeEnşaveTe¡
, 
R•Üt
) {

636 
FakeEnşave
 
	g’şave1
 = 
’şave_
;

637 
FakeEnşave
 
	g’şave2
 = 
’şave_
;

639 
	gi
 = 0; i < 100; i++) {

641 
	g’şave1
.
S‘RªdomId’t™y
();

642 
	g’şave1
.
£t_»pÜt_keyid
(
TrivŸlRªdomObjeù
<
Keyid
>());

645 
	g’şave2
.
S‘RªdomId’t™y
();

648 
	gFakeEnşave
::
EÁ”Enşave
(
’şave1
);

650 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

651 *
	g»pÜtd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

653 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

654 *
	gtšfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

655 
	gtšfo
->
	gm—su»m’t
 = 
’şave2
.
g‘_m»nşave
();

656 
	gtšfo
->
	g©Œibu‹s
 = 
’şave2
.
g‘_©Œibu‹s
();

657 
	gtšfo
->
	gmisc£Ëù
 = 
’şave2
.
g‘_misc£Ëù
();

658 
	gtšfo
->
	gcÚfigid
 = 
’şave2
.
g‘_cÚfigid
();

659 
	gtšfo
->
	gcÚfigsvn
 = 
’şave2
.
g‘_cÚfigsvn
();

661 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

662 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

665 
EXPECT_EQ
(
»pÜt
->
ıusvn
, 
’şave1
.
g‘_ıusvn
());

666 
EXPECT_EQ
(
»pÜt
->
misc£Ëù
, 
’şave1
.
g‘_misc£Ëù
());

667 
EXPECT_EQ
(
»pÜt
->
»£rved1
,

668 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved1
)>());

669 
EXPECT_EQ
(
»pÜt
->
isvexrodid
, 
’şave1
.
g‘_isvexrodid
());

670 
EXPECT_EQ
(
»pÜt
->
©Œibu‹s
, 
’şave1
.
g‘_©Œibu‹s
());

671 
EXPECT_EQ
(
»pÜt
->
m»nşave
, 
’şave1
.
g‘_m»nşave
());

672 
EXPECT_EQ
(
»pÜt
->
»£rved2
,

673 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved2
)>());

674 
EXPECT_EQ
(
»pÜt
->
mrsigÃr
, 
’şave1
.
g‘_mrsigÃr
());

675 
EXPECT_EQ
(
»pÜt
->
»£rved3
,

676 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved3
)>());

677 
EXPECT_EQ
(
»pÜt
->
cÚfigid
, 
’şave1
.
g‘_cÚfigid
());

678 
EXPECT_EQ
(
»pÜt
->
isv´odid
, 
’şave1
.
g‘_isv´odid
());

679 
EXPECT_EQ
(
»pÜt
->
isvsvn
, 
’şave1
.
g‘_isvsvn
());

680 
EXPECT_EQ
(
»pÜt
->
cÚfigsvn
, 
’şave1
.
g‘_cÚfigsvn
());

681 
EXPECT_EQ
(
»pÜt
->
»£rved4
,

682 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved4
)>());

683 
EXPECT_EQ
(
»pÜt
->
isvçmyid
, 
’şave1
.
g‘_isvçmyid
());

684 
EXPECT_EQ
(
»pÜt
->
»pÜtd©a
.
d©a
,„eportdata->data);

685 
EXPECT_EQ
(
»pÜt
->
keyid
, 
’şave1
.
g‘_»pÜt_keyid
());

688 
	gFakeEnşave
::
Ex™Enşave
();

692 
	gFakeEnşave
::
EÁ”Enşave
(
’şave2
);

693 
AligÃdKey»que¡PŒ
 
	g»que¡
;

694 *
	g»que¡
 = *
»pÜt_key_»que¡_
;

695 
	g»que¡
->
	gkeyid
 = 
»pÜt
->
keyid
;

696 
AligÃdH¬dw¬eKeyPŒ
 
	g»pÜt_key
;

698 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
»pÜt_key
.
g‘
()));

700 
	gSaãBy‹s
<
	gAES_BLOCK_SIZE
> 
	gex³ùed_mac
;

701 
EXPECT_TRUE
(
AES_CMAC
(

702 
ex³ùed_mac
.
d©a
(), 
»pÜt_key
->d©a(),„•Üt_key->
size
(),

703 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
»pÜt
.
g‘
()), 
off£tof
(
R•Üt
, 
keyid
)));

704 
EXPECT_EQ
(
»pÜt
->
mac
, 
ex³ùed_mac
)

705 << 
HexDumpObjeùPaœ
("Enşav1", 
’şave1
, "Enşav2", 
’şave2
);

708 
	gFakeEnşave
::
Ex™Enşave
();

	@identity/sgx/fake_hardware_interface_test.cc

19 
	~<İ’s¦/«s.h
>

20 
	~<İ’s¦/cmac.h
>

22 
	~<lim™s
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

30 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

31 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

32 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

33 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

34 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

35 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

36 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
Çme¥aû
 
	gsgx
 {

44 
	gÇme¥aû
 {

46 
	gusšg
 ::
‹¡šg
::
NÙ
;

48 
usšg
 
	gM—su»m’t
 = 
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>;

49 
usšg
 
	gKeyid
 = 
Un§ãBy‹s
<
kR•ÜtKeyidSize
>;

51 
	g‹m¶©e
 <
şass
 
	gT1
, cÏs 
	gT2
>

52 
	g¡d
::
¡ršg
 
HexDumpObjeùPaœ
(cÚ¡ *
obj1_Çme
, 
T1
 
obj1
,

53 cÚ¡ *
obj2_Çme
, 
T2
 
obj2
) {

54  
	gab¦
::
SŒC©
(
obj1_Çme
, ":\n", 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj1
),

55 "\n", 
obj2_Çme
, ":\n",

56 
CÚv”tTrivŸlObjeùToHexSŒšg
(
obj2
), "\n");

59 
FlLowFourB™s
(
ušt8_t
 *
d©a
) {

60 *
	gd©a
 ^ğ
TrivŸlRªdomObjeù
<
ušt8_t
>(è& 
¡©ic_ÿ¡
<uint8_t>(0xF);

63 şas 
	cFakeEnşaveTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

64 
´Ùeùed
:

65 
FakeEnşaveTe¡
() {

67 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
do_nÙ_ÿ»_©Œibu‹s_
);

68 
	g®ways_ÿ»_©Œibu‹s_
 = 
kRequœedS—lšgA‰ribu‹sMask
;

71 
	g’şave_
.
add_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

75 
	g’şave_
.
S‘RªdomId’t™y
();

78 *
	g£®_key_»que¡_
 = 
TrivŸlZ”oObjeù
<
Key»que¡
>();

80 
	g£®_key_»que¡_
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
SEAL_KEY
;

82 
	g£®_key_»que¡_
->
	gkeypŞicy
 =

83 
kKeypŞicyM»nşaveB™Mask
 | 
kKeypŞicyMrsigÃrB™Mask
;

87 
	g£®_key_»que¡_
->
	g©Œibu‹mask
 = ~
do_nÙ_ÿ»_©Œibu‹s_
;

89 
	g£®_key_»que¡_
->
	gkeyid
 = 
TrivŸlRªdomObjeù
<
Keyid
>();

93 
	g£®_key_»que¡_
->
	gmiscmask
 = 0xffffffff;

96 *
	g»pÜt_key_»que¡_
 = *
£®_key_»que¡_
;

97 
	g»pÜt_key_»que¡_
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
REPORT_KEY
;

100 
ušt16_t
 
G’”©eRªdomKeypŞicy
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
) {

101 
ušt16_t
 
	gkeypŞicy_v®id_b™s
 =

102 
kKeypŞicyM»nşaveB™Mask
 | 
kKeypŞicyMrsigÃrB™Mask
;

103 ià(
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
::
KSS
, 
©Œibu‹s
)) {

104 
	gkeypŞicy_v®id_b™s
 |ğ
kKeypŞicyKssB™s
;

106  
	gTrivŸlRªdomObjeù
<
	gušt16_t
>(è& 
	gkeypŞicy_v®id_b™s
;

109 
FakeEnşave
 
	g’şave_
;

110 
AligÃdKey»que¡PŒ
 
	g£®_key_»que¡_
;

111 
AligÃdKey»que¡PŒ
 
	g»pÜt_key_»que¡_
;

112 
SecsA‰ribu‹S‘
 
	gdo_nÙ_ÿ»_©Œibu‹s_
;

113 
SecsA‰ribu‹S‘
 
	g®ways_ÿ»_©Œibu‹s_
;

118 
TEST_F
(
FakeEnşaveTe¡
, 
Cu¼’tEnşave
) {

119 
EXPECT_EQ
(
FakeEnşave
::
G‘Cu¼’tEnşave
(), 
nuÎ±r
);

120 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

122 
FakeEnşave
 *
	gcu¼’t_’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

123 
ASSERT_NE
(
cu¼’t_’şave
, 
nuÎ±r
);

126 
ASSERT_EQ
(
FakeEnşave
::
G‘Cu¼’tEnşave
(), 
cu¼’t_’şave
);

130 
EXPECT_EQ
(*
cu¼’t_’şave
, 
’şave_
è<< 
HexDumpObjeùPaœ
(

131 "LHS FakeEnşav(*cu¼’t_’şave)", *
cu¼’t_’şave
,

132 "RHS FakeEnşavÓnşave_)", 
’şave_
);

134 
	gFakeEnşave
::
Ex™Enşave
();

135 
EXPECT_EQ
(
FakeEnşave
::
G‘Cu¼’tEnşave
(), 
nuÎ±r
);

141 
TEST_F
(
FakeEnşaveTe¡
, 
G‘H¬dw¬eRªd
) {

142 
ušt64_t
 
	gfœ¡_v®ue
 = 0;

143 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eRªd64
(&
fœ¡_v®ue
));

144 
	gcŞlisiÚ_couÁ
 = 0;

145 
	gi
 = 0; i < 3; i++) {

146 
ušt64_t
 
	gÃw_v®ue
 = 0;

147 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eRªd64
(&
Ãw_v®ue
));

148 ià(
	gfœ¡_v®ue
 =ğ
Ãw_v®ue
) {

149 
cŞlisiÚ_couÁ
++;

152 
EXPECT_NE
(
cŞlisiÚ_couÁ
, 3);

156 
TEST_F
(
FakeEnşaveTe¡
, 
S‘Id’t™y
) {

157 
	g’şave_
.
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

158 
	g’şave_
.
S‘RªdomId’t™y
();

159 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

160 
CodeId’t™y
 
	gid’t™y
 = 
G‘S–fId’t™y
()->
id’t™y
;

161 
	gFakeEnşave
::
Ex™Enşave
();

163 
FakeEnşave
 
	g’şave2
;

164 
	g’şave2
.
S‘Id’t™y
(
id’t™y
);

166 
	gFakeEnşave
::
EÁ”Enşave
(
’şave2
);

167 
CodeId’t™y
 
	gid’t™y2
 = 
G‘S–fId’t™y
()->
id’t™y
;

169 
EXPECT_THAT
(
id’t™y
, 
Equ®sPrÙo
(
id’t™y2
));

170 
	gFakeEnşave
::
Ex™Enşave
();

173 
TEST_F
(
FakeEnşaveTe¡
, 
G‘Id’t™y
) {

174 
FakeEnşave
 
	g’şave1
;

175 
	g’şave1
.
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

176 
	g’şave1
.
S‘RªdomId’t™y
();

178 autØ
	gid’t™y_»suÉ
 = 
’şave1
.
G‘Id’t™y
();

179 
ASYLO_ASSERT_OK
(
id’t™y_»suÉ
.
¡©us
());

180 
CodeId’t™y
 
	gid’t™y
 = 
id’t™y_»suÉ
.
V®ueOrD›
();

182 
	gFakeEnşave
::
EÁ”Enşave
(
’şave1
);

183 
EXPECT_THAT
(
id’t™y
, 
Equ®sPrÙo
(
G‘S–fId’t™y
()->identity));

184 
	gFakeEnşave
::
Ex™Enşave
();

186 
FakeEnşave
 
	g’şave2
;

187 
	g’şave2
.
S‘Id’t™y
(
id’t™y
);

189 
EXPECT_THAT
(
’şave2
.
G‘Id’t™y
(), 
IsOkAndHŞds
(
Equ®sPrÙo
(
id’t™y
)));

191 
FakeEnşave
 
	g’şave3
;

192 
	g’şave3
.
»move_v®id_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

193 
	g’şave3
.
S‘RªdomId’t™y
();

198 
EXPECT_THAT
(
’şave3
.
G‘Id’t™y
(), 
IsOkAndHŞds
(
NÙ
(
Equ®sPrÙo
(
id’t™y
))));

206 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyG’”©esNÚZ”oKey
) {

207 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

209 
AligÃdH¬dw¬eKeyPŒ
 
	gkey
;

210 
	gkey
->
fl
(0);

211 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
£®_key_»que¡_
, 
key
.
g‘
()));

213 
H¬dw¬eKey
 
	gz”o_key
;

214 
	gz”o_key
.
fl
(0);

215 
EXPECT_NE
(*
key
, 
z”o_key
)

216 << "G‘H¬dw¬eKey„‘uºed z”Økey." << 
	g¡d
::
’dl


217 << 
HexDumpObjeùPaœ
("Enşave", 
’şave_
, "Keyrequest",

218 *
£®_key_»que¡_
);

219 
	gFakeEnşave
::
Ex™Enşave
();

225 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hM»nşave
) {

226 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

227 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

228 
AligÃdKey»que¡PŒ
 
	g»que¡
;

229 *
	g»que¡
 = *
£®_key_»que¡_
;

230 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

232 
	gi
 = 0; i < 1000; i++) {

233 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

234 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

235 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

238 
	g’şave
->
£t_m»nşave
(
TrivŸlRªdomObjeù
<
M—su»m’t
>());

239 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

240 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

245 
boŞ
 
	gex³ù_key_chªge
 =

246 (
»que¡
->
keypŞicy
 & 
kKeypŞicyM»nşaveB™Mask
) != 0;

247 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

248 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

250 
	gFakeEnşave
::
Ex™Enşave
();

256 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hMrsigÃr
) {

257 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

258 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

259 
AligÃdKey»que¡PŒ
 
	g»que¡
;

260 *
	g»que¡
 = *
£®_key_»que¡_
;

261 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

263 
	gi
 = 0; i < 1000; i++) {

264 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

265 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

266 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

269 
	g’şave
->
£t_mrsigÃr
(
TrivŸlRªdomObjeù
<
M—su»m’t
>());

270 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

271 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

276 
boŞ
 
	gex³ù_key_chªge
 =

277 (
»que¡
->
keypŞicy
 & 
kKeypŞicyMrsigÃrB™Mask
) != 0;

278 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

279 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

281 
	gFakeEnşave
::
Ex™Enşave
();

286 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsv´odid
) {

289 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

290 
	g’şave_
.
S‘RªdomId’t™y
();

292 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

293 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

294 
AligÃdKey»que¡PŒ
 
	g»que¡
;

295 *
	g»que¡
 = *
£®_key_»que¡_
;

296 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

298 
	gi
 = 0; i < 1000; i++) {

299 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

300 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

301 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

304 
ušt16_t
 
	g´ev_isv´odid
 = 
’şave
->
g‘_isv´odid
();

305 
	g’şave
->
£t_isv´odid
(
TrivŸlRªdomObjeù
<
ušt16_t
>() & 0x0F);

306 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

307 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

311 
boŞ
 
	gex³ù_key_chªge
 =

312 (
’şave
->
g‘_isv´odid
(è!ğ
´ev_isv´odid
) &&

313 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyNoisv´odidB™Mask
) == 0);

314 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

315 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

317 
	gFakeEnşave
::
Ex™Enşave
();

321 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsvsvn
) {

322 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

323 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

324 
AligÃdKey»que¡PŒ
 
	g»que¡
;

325 *
	g»que¡
 = *
£®_key_»que¡_
;

326 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

328 
	g»que¡
->
	gisvsvn
 = 
’şave
->
g‘_isvsvn
();

329 
	gi
 = 0; i < 1000; i++) {

330 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

331 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

332 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

335 
ušt16_t
 
	g´ev_isvsvn
 = 
’şave
->
g‘_isvsvn
();

336 
ušt16_t
 
	gisvsvn
 = 
TrivŸlRªdomObjeù
<uint16_t>() & 0x0F;

337 
	g’şave
->
£t_isvsvn
(
isvsvn
);

338 
	g»que¡
->
	gisvsvn
 = 
isvsvn
;

339 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

340 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

344 
boŞ
 
	gex³ù_key_chªge
 = (
isvsvn
 !ğ
´ev_isvsvn
);

345 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

346 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

348 
	gFakeEnşave
::
Ex™Enşave
();

353 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hA‰ribu‹s
) {

354 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

355 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

356 
AligÃdKey»que¡PŒ
 
	g»que¡
;

357 *
	g»que¡
 = *
£®_key_»que¡_
;

358 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

360 
	g’şave
->
£t_©Œibu‹s
(
TrivŸlRªdomObjeù
<
SecsA‰ribu‹S‘
>());

361 
SecsA‰ribu‹S‘
 
	gÃxt
 = 
’şave
->
g‘_©Œibu‹s
();

362 
	gi
 = 0; i < 1000; i++) {

363 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

364 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

371 
SecsA‰ribu‹S‘
 
	g´ev
 = 
’şave
->
g‘_©Œibu‹s
();

372 
	g’şave
->
£t_©Œibu‹s
(
TrivŸlRªdomObjeù
<
SecsA‰ribu‹S‘
>());

373 
	gÃxt
 = 
’şave
->
g‘_©Œibu‹s
();

374 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

375 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

379 
boŞ
 
	gex³ù_key_chªge
 =

380 (
´ev
 & ~
do_nÙ_ÿ»_©Œibu‹s_
è!ğ(
Ãxt
 & ~do_not_care_attributes_);

381 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

382 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

384 
	gFakeEnşave
::
Ex™Enşave
();

389 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hMisc£Ëù
) {

390 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

391 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

392 
AligÃdKey»que¡PŒ
 
	g»que¡
;

393 *
	g»que¡
 = *
£®_key_»que¡_
;

394 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

397 
	g’şave
->
£t_misc£Ëù
(
TrivŸlRªdomObjeù
<
ušt32_t
>(è& 
kMisc£ËùAÎB™s
);

398 
	gi
 = 0; i < 100; i++) {

399 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

400 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

401 
ušt32_t
 
	g´ev
 = 
’şave
->
g‘_misc£Ëù
();

402 
	g’şave
->
£t_misc£Ëù
(
TrivŸlRªdomObjeù
<
ušt32_t
>() &

403 
kMisc£ËùAÎB™s
);

404 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

405 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

409 
boŞ
 
	gex³ù_key_chªge
 = (
´ev
 !ğ
’şave
->
g‘_misc£Ëù
());

410 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

411 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

413 
	gFakeEnşave
::
Ex™Enşave
();

418 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsvçmyid
) {

421 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

422 
	g’şave_
.
S‘RªdomId’t™y
();

424 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

425 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

426 
AligÃdKey»que¡PŒ
 
	g»que¡
;

427 *
	g»que¡
 = *
£®_key_»que¡_
;

428 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

430 
	gi
 = 0; i < 1000; i++) {

431 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

432 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

433 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

436 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	g´ev_isvçmyid
 = 
’şave
->
g‘_isvçmyid
();

437 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	gisvçmyid
 = 
´ev_isvçmyid
;

438 
FlLowFourB™s
(
isvçmyid
.
d©a
());

439 
	g’şave
->
£t_isvçmyid
(
isvçmyid
);

440 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

441 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

445 
boŞ
 
	gex³ù_key_chªge
 =

446 (
isvçmyid
 !ğ
´ev_isvçmyid
) &&

447 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyIsvçmyidB™Mask
) != 0);

448 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

449 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

451 
	gFakeEnşave
::
Ex™Enşave
();

456 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hIsvexrodid
) {

459 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

460 
	g’şave_
.
S‘RªdomId’t™y
();

462 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

463 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

464 
AligÃdKey»que¡PŒ
 
	g»que¡
;

465 *
	g»que¡
 = *
£®_key_»que¡_
;

466 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

468 
	gi
 = 0; i < 1000; i++) {

469 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

470 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

471 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

474 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	g´ev_isvexrodid
 =

475 
’şave
->
g‘_isvexrodid
();

476 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	gisvexrodid
 = 
´ev_isvexrodid
;

477 
FlLowFourB™s
(
isvexrodid
.
d©a
());

478 
	g’şave
->
£t_isvexrodid
(
isvexrodid
);

479 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

480 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

484 
boŞ
 
	gex³ù_key_chªge
 =

485 (
isvexrodid
 !ğ
´ev_isvexrodid
) &&

486 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyIsvexrodidB™Mask
) != 0);

487 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

488 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

490 
	gFakeEnşave
::
Ex™Enşave
();

495 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hCÚfigid
) {

498 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

499 
	g’şave_
.
S‘RªdomId’t™y
();

501 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

502 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

503 
AligÃdKey»que¡PŒ
 
	g»que¡
;

504 *
	g»que¡
 = *
£®_key_»que¡_
;

505 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

507 
	gi
 = 0; i < 1000; i++) {

508 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

509 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

510 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

513 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	g´ev_cÚfigid
 = 
’şave
->
g‘_cÚfigid
();

514 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	gcÚfigid
 = 
´ev_cÚfigid
;

515 
FlLowFourB™s
(
cÚfigid
.
d©a
());

516 
	g’şave
->
£t_cÚfigid
(
cÚfigid
);

517 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

518 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

522 
boŞ
 
	gex³ù_key_chªge
 =

523 (
cÚfigid
 !ğ
´ev_cÚfigid
) &&

524 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyCÚfigidB™Mask
) != 0);

525 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

526 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

528 
	gFakeEnşave
::
Ex™Enşave
();

533 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyChªgesW™hCÚfigsvn
) {

536 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

537 
	g’şave_
.
S‘RªdomId’t™y
();

539 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

540 
AligÃdH¬dw¬eKeyPŒ
 
	gkey1
, 
	gkey2
;

541 
AligÃdKey»que¡PŒ
 
	g»que¡
;

542 *
	g»que¡
 = *
£®_key_»que¡_
;

543 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

545 
	g»que¡
->
	gcÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
();

546 
	gi
 = 0; i < 1000; i++) {

547 
	g»que¡
->
	gkeypŞicy
 = 
G’”©eRªdomKeypŞicy
(
’şave
->
g‘_©Œibu‹s
());

548 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key1
.
g‘
()))

549 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

552 
ušt16_t
 
	g´ev_cÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
();

553 
ušt16_t
 
	gcÚfigsvn
 = 
´ev_cÚfigsvn
;

554 
FlLowFourB™s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
cÚfigsvn
));

555 
	g’şave
->
£t_cÚfigsvn
(
cÚfigsvn
);

556 
	g»que¡
->
	gcÚfigsvn
 = 
cÚfigsvn
;

557 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key2
.
g‘
()))

558 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

562 
boŞ
 
	gex³ù_key_chªge
 =

563 (
cÚfigsvn
 !ğ
´ev_cÚfigsvn
) &&

564 ((
»que¡
->
keypŞicy
 & 
kKeypŞicyCÚfigidB™Mask
) != 0);

565 
EXPECT_EQ
(*
key1
 !ğ*
key2
, 
ex³ù_key_chªge
)

566 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

568 
	gFakeEnşave
::
Ex™Enşave
();

574 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyIsvsvnAcûssCÚŒŞ
) {

575 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

576 
AligÃdH¬dw¬eKeyPŒ
 
	gkey
;

577 
AligÃdKey»que¡PŒ
 
	g»que¡
;

578 *
	g»que¡
 = *
£®_key_»que¡_
;

579 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

582 
	g’şave
->
g‘_isvsvn
() == 0 ||

583 
’şave
->
g‘_isvsvn
(è=ğ
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
()) {

584 
’şave
->
£t_isvsvn
(
TrivŸlRªdomObjeù
<
ušt16_t
>());

588 
	g»que¡
->
	gisvsvn
 = 
’şave
->
g‘_isvsvn
() - 1;

589 
ASYLO_EXPECT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()))

590 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

593 
	g»que¡
->
	gisvsvn
 = 
’şave
->
g‘_isvsvn
() + 1;

594 
EXPECT_THAT
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()),

595 
StusIs
(
SGX_ERROR_INVALID_ISVSVN
))

596 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

597 
	gFakeEnşave
::
Ex™Enşave
();

603 
TEST_F
(
FakeEnşaveTe¡
, 
S—lKeyCÚfigsvnAcûssCÚŒŞ
) {

606 
	g’şave_
.
add_»quœed_©Œibu‹
(
SecsA‰ribu‹B™
::
KSS
);

607 
	g’şave_
.
S‘RªdomId’t™y
();

609 
	gFakeEnşave
::
EÁ”Enşave
(
’şave_
);

610 
AligÃdH¬dw¬eKeyPŒ
 
	gkey
;

611 
AligÃdKey»que¡PŒ
 
	g»que¡
;

612 *
	g»que¡
 = *
£®_key_»que¡_
;

613 
FakeEnşave
 *
	g’şave
 = FakeEnşave::
G‘Cu¼’tEnşave
();

616 
	g’şave
->
g‘_cÚfigsvn
() == 0 ||

617 
’şave
->
g‘_cÚfigsvn
(è=ğ
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
()) {

618 
’şave
->
£t_cÚfigsvn
(
TrivŸlRªdomObjeù
<
ušt16_t
>());

622 
	g»que¡
->
	gcÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
() - 1;

623 
ASYLO_EXPECT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()))

624 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

627 
	g»que¡
->
	gcÚfigsvn
 = 
’şave
->
g‘_cÚfigsvn
() + 1;

628 
EXPECT_THAT
(
G‘H¬dw¬eKey
(*
»que¡
, 
key
.
g‘
()),

629 
StusIs
(
SGX_ERROR_INVALID_ISVSVN
))

630 << 
HexDumpObjeùPaœ
("Enşave", *
’şave
, "Key»que¡", *
»que¡
);

631 
	gFakeEnşave
::
Ex™Enşave
();

635 
TEST_F
(
FakeEnşaveTe¡
, 
R•Üt
) {

636 
FakeEnşave
 
	g’şave1
 = 
’şave_
;

637 
FakeEnşave
 
	g’şave2
 = 
’şave_
;

639 
	gi
 = 0; i < 100; i++) {

641 
	g’şave1
.
S‘RªdomId’t™y
();

642 
	g’şave1
.
£t_»pÜt_keyid
(
TrivŸlRªdomObjeù
<
Keyid
>());

645 
	g’şave2
.
S‘RªdomId’t™y
();

648 
	gFakeEnşave
::
EÁ”Enşave
(
’şave1
);

650 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

651 *
	g»pÜtd©a
 = 
TrivŸlRªdomObjeù
<
R•Ütd©a
>();

653 
AligÃdT¬g‘šfoPŒ
 
	gtšfo
;

654 *
	gtšfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

655 
	gtšfo
->
	gm—su»m’t
 = 
’şave2
.
g‘_m»nşave
();

656 
	gtšfo
->
	g©Œibu‹s
 = 
’şave2
.
g‘_©Œibu‹s
();

657 
	gtšfo
->
	gmisc£Ëù
 = 
’şave2
.
g‘_misc£Ëù
();

658 
	gtšfo
->
	gcÚfigid
 = 
’şave2
.
g‘_cÚfigid
();

659 
	gtšfo
->
	gcÚfigsvn
 = 
’şave2
.
g‘_cÚfigsvn
();

661 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

662 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
tšfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

665 
EXPECT_EQ
(
»pÜt
->
ıusvn
, 
’şave1
.
g‘_ıusvn
());

666 
EXPECT_EQ
(
»pÜt
->
misc£Ëù
, 
’şave1
.
g‘_misc£Ëù
());

667 
EXPECT_EQ
(
»pÜt
->
»£rved1
,

668 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved1
)>());

669 
EXPECT_EQ
(
»pÜt
->
isvexrodid
, 
’şave1
.
g‘_isvexrodid
());

670 
EXPECT_EQ
(
»pÜt
->
©Œibu‹s
, 
’şave1
.
g‘_©Œibu‹s
());

671 
EXPECT_EQ
(
»pÜt
->
m»nşave
, 
’şave1
.
g‘_m»nşave
());

672 
EXPECT_EQ
(
»pÜt
->
»£rved2
,

673 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved2
)>());

674 
EXPECT_EQ
(
»pÜt
->
mrsigÃr
, 
’şave1
.
g‘_mrsigÃr
());

675 
EXPECT_EQ
(
»pÜt
->
»£rved3
,

676 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved3
)>());

677 
EXPECT_EQ
(
»pÜt
->
cÚfigid
, 
’şave1
.
g‘_cÚfigid
());

678 
EXPECT_EQ
(
»pÜt
->
isv´odid
, 
’şave1
.
g‘_isv´odid
());

679 
EXPECT_EQ
(
»pÜt
->
isvsvn
, 
’şave1
.
g‘_isvsvn
());

680 
EXPECT_EQ
(
»pÜt
->
cÚfigsvn
, 
’şave1
.
g‘_cÚfigsvn
());

681 
EXPECT_EQ
(
»pÜt
->
»£rved4
,

682 
TrivŸlZ”oObjeù
<
deşty³
(
»pÜt
->
»£rved4
)>());

683 
EXPECT_EQ
(
»pÜt
->
isvçmyid
, 
’şave1
.
g‘_isvçmyid
());

684 
EXPECT_EQ
(
»pÜt
->
»pÜtd©a
.
d©a
,„eportdata->data);

685 
EXPECT_EQ
(
»pÜt
->
keyid
, 
’şave1
.
g‘_»pÜt_keyid
());

688 
	gFakeEnşave
::
Ex™Enşave
();

692 
	gFakeEnşave
::
EÁ”Enşave
(
’şave2
);

693 
AligÃdKey»que¡PŒ
 
	g»que¡
;

694 *
	g»que¡
 = *
»pÜt_key_»que¡_
;

695 
	g»que¡
->
	gkeyid
 = 
»pÜt
->
keyid
;

696 
AligÃdH¬dw¬eKeyPŒ
 
	g»pÜt_key
;

698 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eKey
(*
»que¡
, 
»pÜt_key
.
g‘
()));

700 
	gSaãBy‹s
<
	gAES_BLOCK_SIZE
> 
	gex³ùed_mac
;

701 
EXPECT_TRUE
(
AES_CMAC
(

702 
ex³ùed_mac
.
d©a
(), 
»pÜt_key
->d©a(),„•Üt_key->
size
(),

703 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
»pÜt
.
g‘
()), 
off£tof
(
R•Üt
, 
keyid
)));

704 
EXPECT_EQ
(
»pÜt
->
mac
, 
ex³ùed_mac
)

705 << 
HexDumpObjeùPaœ
("Enşav1", 
’şave1
, "Enşav2", 
’şave2
);

708 
	gFakeEnşave
::
Ex™Enşave
();

	@identity/sgx/fake_self_identity.cc

19 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

20 
	~"asylo/id’t™y/sgx/£lf_id’t™y_š‹º®.h
"

22 #ifdeà
__ASYLO__


26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

29 cÚ¡ 
S–fId’t™y
 *
G‘S–fId’t™y
() {

35 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
Ãw
 SelfIdentity();

36 *
	g£lf_id’t™y
 = 
S–fId’t™y
();

37  
	g£lf_id’t™y
;

	@identity/sgx/fake_self_identity.cc

19 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

20 
	~"asylo/id’t™y/sgx/£lf_id’t™y_š‹º®.h
"

22 #ifdeà
__ASYLO__


26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

29 cÚ¡ 
S–fId’t™y
 *
G‘S–fId’t™y
() {

35 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
Ãw
 SelfIdentity();

36 *
	g£lf_id’t™y
 = 
S–fId’t™y
();

37  
	g£lf_id’t™y
;

	@identity/sgx/hardware_interface.cc

19 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

23 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

24 
	~"šşude/sgx.h
"

41 
do_”•Üt
(cÚ¡ 
sgx_rg‘_šfo_t
 *
rg‘_šfo
,

42 cÚ¡ 
sgx_»pÜt_d©a_t
 *
»pÜt_d©a
, 
sgx_»pÜt_t
 *
»pÜt
);

52 
do_eg‘key
(cÚ¡ 
sgx_key_»que¡_t
 *
key_»que¡
, 
sgx_key_128b™_t
 *
key
);

56 
sgx_¡©us_t
 
eg‘key_¡©us_to_sgx_¡©us
(
eg‘key_¡©us
);

59 
Çme¥aû
 
asylo
 {

60 
Çme¥aû
 
sgx
 {

62 
Stus
 
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
,

67 
Stus
 
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
, 
H¬dw¬eKey
 *
key
) {

68  
Stus
(
eg‘key_¡©us_to_sgx_¡©us
(
do_eg‘key
(

69 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_key_»que¡_t
 *>(&
»que¡
),

70 
»š‹½»t_ÿ¡
<
sgx_key_128b™_t
 *>(
key
))),

74 
Stus
 
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
, cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
,

75 
R•Üt
 *
»pÜt
) {

76 
do_”•Üt
(
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_rg‘_šfo_t
 *>(&
tšfo
),

77 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_»pÜt_d©a_t
 *>(&
»pÜtd©a
),

78 
»š‹½»t_ÿ¡
<
sgx_»pÜt_t
 *>(
»pÜt
));

79  
Stus
::
OkStus
();

	@identity/sgx/hardware_interface.cc

19 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

23 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

24 
	~"šşude/sgx.h
"

41 
do_”•Üt
(cÚ¡ 
sgx_rg‘_šfo_t
 *
rg‘_šfo
,

42 cÚ¡ 
sgx_»pÜt_d©a_t
 *
»pÜt_d©a
, 
sgx_»pÜt_t
 *
»pÜt
);

52 
do_eg‘key
(cÚ¡ 
sgx_key_»que¡_t
 *
key_»que¡
, 
sgx_key_128b™_t
 *
key
);

56 
sgx_¡©us_t
 
eg‘key_¡©us_to_sgx_¡©us
(
eg‘key_¡©us
);

59 
Çme¥aû
 
asylo
 {

60 
Çme¥aû
 
sgx
 {

62 
Stus
 
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
,

67 
Stus
 
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
, 
H¬dw¬eKey
 *
key
) {

68  
Stus
(
eg‘key_¡©us_to_sgx_¡©us
(
do_eg‘key
(

69 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_key_»que¡_t
 *>(&
»que¡
),

70 
»š‹½»t_ÿ¡
<
sgx_key_128b™_t
 *>(
key
))),

74 
Stus
 
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
, cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
,

75 
R•Üt
 *
»pÜt
) {

76 
do_”•Üt
(
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_rg‘_šfo_t
 *>(&
tšfo
),

77 
»š‹½»t_ÿ¡
<cÚ¡ 
sgx_»pÜt_d©a_t
 *>(&
»pÜtd©a
),

78 
»š‹½»t_ÿ¡
<
sgx_»pÜt_t
 *>(
»pÜt
));

79  
Stus
::
OkStus
();

	@identity/sgx/hardware_interface.h

19 #iâdeà
ASYLO_IDENTITY_SGX_HARDWARE_INTERFACE_H_


20 
	#ASYLO_IDENTITY_SGX_HARDWARE_INTERFACE_H_


	)

22 
	~<İ’s¦/«s.h
>

24 
	~"ab¦/ba£/©Œibu‹s.h
"

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

34 
cÚ¡ex´
 
size_t
 
	gkH¬dw¬eKeySize
 = 
AES_BLOCK_SIZE
;

38 
usšg
 
	gH¬dw¬eKey
 = 
SaãBy‹s
<
kH¬dw¬eKeySize
>;

40 
¡©ic_as£¹
((
H¬dw¬eKey
è=ğ
kH¬dw¬eKeySize
,

45 
usšg
 
	gAligÃdH¬dw¬eKeyPŒ
 = 
AligÃdObjeùPŒ
<
H¬dw¬eKey
, 16>;

52 
ABSL_MUST_USE_RESULT
 
Stus
 
G‘H¬dw¬eRªd64
(
ušt64_t
 *
v®ue
);

61 
ABSL_MUST_USE_RESULT
 
Stus
 
G‘H¬dw¬eKey
(cÚ¡ 
Key»que¡
 &
»que¡
,

62 
H¬dw¬eKey
 *
key
);

70 
ABSL_MUST_USE_RESULT
 
Stus
 
G‘H¬dw¬eR•Üt
(cÚ¡ 
T¬g‘šfo
 &
tšfo
,

71 cÚ¡ 
R•Ütd©a
 &
»pÜtd©a
,

72 
R•Üt
 *
»pÜt
);

	@identity/sgx/identity_key_management_structs.h

19 #iâdeà
ASYLO_IDENTITY_SGX_IDENTITY_KEY_MANAGEMENT_STRUCTS_H_


20 
	#ASYLO_IDENTITY_SGX_IDENTITY_KEY_MANAGEMENT_STRUCTS_H_


	)

22 
	~<İ’s¦/«s.h
>

23 
	~<İ’s¦/sha.h
>

24 
	~<ty³_Œa™s
>

26 
	~"ab¦/ba£/©Œibu‹s.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

29 
	~"asylo/id’t™y/ut/®igÃd_objeù_±r.h
"

54 
Çme¥aû
 
	gasylo
 {

55 
Çme¥aû
 
	gsgx
 {

61 
cÚ¡ex´
 
	gkR§3072ModulusSize
 = 384;

66 
cÚ¡ex´
 
	gkSgxMacSize
 = 
AES_BLOCK_SIZE
;

69 
cÚ¡ex´
 
	gkPpidSize
 = 16;

73 
cÚ¡ex´
 
	gkCpusvnSize
 = 16;

76 
cÚ¡ex´
 
	gkFm¥cSize
 = 6;

82 
cÚ¡ex´
 
	gkSig¡ruùH—d”Size
 = 16;

85 
cÚ¡ex´
 
	gkCÚfigidSize
 = 64;

88 
cÚ¡ex´
 
	gkIsvçmyidSize
 = 16;

91 
cÚ¡ex´
 
	gkIsvexrodidSize
 = 16;

96 
	sD©e
 {

97 
ušt16_t
 
	gy—r
;

98 
ušt8_t
 
	gmÚth
;

99 
ušt8_t
 
	gday
;

100 } 
	gABSL_ATTRIBUTE_PACKED
;

102 
¡©ic_as£¹
((
D©e
) == 4, "Size of Date struct is incorrect");

109 
	sSig¡ruùH—d”
 {

110 
	gUn§ãBy‹s
<
	gkSig¡ruùH—d”Size
> 
	gh—d”1
;

111 
ušt32_t
 
	gv’dÜ
;

112 
D©e
 
	gd©e
;

113 
	gUn§ãBy‹s
<
	gkSig¡ruùH—d”Size
> 
	gh—d”2
;

114 
ušt32_t
 
	gswdefšed
;

115 
	gUn§ãBy‹s
<84> 
	g»£rved1
;

116 } 
	gABSL_ATTRIBUTE_PACKED
;

118 
¡©ic_as£¹
((
Sig¡ruùH—d”
) == 128,

126 
	sSig¡ruùBody
 {

127 
ušt32_t
 
	gmisc£Ëù
;

128 
ušt32_t
 
	gmiscmask
;

129 
	gUn§ãBy‹s
<4> 
	g»£rved1
;

130 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	gisvçmyid
;

131 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

132 
SecsA‰ribu‹S‘
 
	g©Œibu‹mask
;

133 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	g’şavehash
;

134 
	gUn§ãBy‹s
<16> 
	g»£rved2
;

135 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	gisvexrodid
;

136 
ušt16_t
 
	gisv´odid
;

137 
ušt16_t
 
	gisvsvn
;

138 } 
	gABSL_ATTRIBUTE_PACKED
;

140 
¡©ic_as£¹
((
Sig¡ruùBody
) == 128,

147 
	sR§3072PublicKey
 {

148 
	gUn§ãBy‹s
<
	gkR§3072ModulusSize
> 
	gmodulus
;

149 
ušt32_t
 
	gexpÚ’t
;

150 } 
	gABSL_ATTRIBUTE_PACKED
;

152 
¡©ic_as£¹
((
R§3072PublicKey
) == 388,

160 
	sSig¡ruùSignšgD©a
 {

161 
Sig¡ruùH—d”
 
	gh—d”
;

162 
Sig¡ruùBody
 
	gbody
;

163 } 
	gABSL_ATTRIBUTE_PACKED
;

165 
¡©ic_as£¹
((
Sig¡ruùSignšgD©a
) == 256,

171 
	sSig¡ruù
 {

172 
Sig¡ruùH—d”
 
	gh—d”
;

173 
R§3072PublicKey
 
	gpublic_key
;

174 
	gUn§ãBy‹s
<
	gkR§3072ModulusSize
> 
	gsigÇtu»
;

175 
Sig¡ruùBody
 
	gbody
;

176 
	gUn§ãBy‹s
<12> 
	g»£rved1
;

177 
	gUn§ãBy‹s
<
	gkR§3072ModulusSize
> 
	gq1
;

178 
	gUn§ãBy‹s
<
	gkR§3072ModulusSize
> 
	gq2
;

179 } 
	gABSL_ATTRIBUTE_PACKED
;

181 
¡©ic_as£¹
((
Sig¡ruù
) == 1808,

186 
usšg
 
	gAligÃdSig¡ruùPŒ
 = 
AligÃdObjeùPŒ
<
Sig¡ruù
, 4096>;

192 şas 
	cKey»que¡KeyÇme
 : 
ušt16_t
 {

193 
EINITTOKEN_KEY
 = 0,

194 
	gPROVISION_KEY
 = 1,

195 
	gPROVISION_SEAL_KEY
 = 2,

196 
	gREPORT_KEY
 = 3,

197 
	gSEAL_KEY
 = 4

201 
cÚ¡ex´
 
	gkKey»que¡KeyidSize
 = 32;

215 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyM»nşaveB™Mask
 = 0x1;

216 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyMrsigÃrB™Mask
 = 0x2;

217 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyNoisv´odidB™Mask
 = 0x4;

218 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyCÚfigidB™Mask
 = 0x8;

219 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyIsvçmyidB™Mask
 = 0x10;

220 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyIsvexrodidB™Mask
 = 0x20;

225 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyKssB™s
 =

226 
kKeypŞicyNoisv´odidB™Mask
 | 
kKeypŞicyCÚfigidB™Mask
 |

227 
kKeypŞicyIsvçmyidB™Mask
 | 
kKeypŞicyIsvexrodidB™Mask
;

230 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyAÎB™s
 =

231 
kKeypŞicyM»nşaveB™Mask
 | 
kKeypŞicyMrsigÃrB™Mask
 | 
kKeypŞicyKssB™s
;

234 
cÚ¡ex´
 
ušt16_t
 
	gkKeypŞicyRe£rvedB™s
 = ~
kKeypŞicyAÎB™s
;

239 
	sKey»que¡
 {

240 
Key»que¡KeyÇme
 
	gkeyÇme
;

241 
ušt16_t
 
	gkeypŞicy
;

242 
ušt16_t
 
	gisvsvn
;

243 
	gUn§ãBy‹s
<2> 
	g»£rved1
;

244 
	gUn§ãBy‹s
<
	gkCpusvnSize
> 
	gıusvn
;

245 
SecsA‰ribu‹S‘
 
	g©Œibu‹mask
;

246 
	gUn§ãBy‹s
<
	gkKey»que¡KeyidSize
> 
	gkeyid
;

247 
ušt32_t
 
	gmiscmask
;

248 
ušt16_t
 
	gcÚfigsvn
;

249 
	gUn§ãBy‹s
<434> 
	g»£rved2
;

250 } 
	gABSL_ATTRIBUTE_PACKED
;

252 
¡©ic_as£¹
((
Key»que¡
) == 512,

257 
usšg
 
	gAligÃdKey»que¡PŒ
 = 
AligÃdObjeùPŒ
<
Key»que¡
, 512>;

263 
	sT¬g‘šfo
 {

264 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gm—su»m’t
;

265 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

266 
	gUn§ãBy‹s
<2> 
	g»£rved1
;

267 
ušt16_t
 
	gcÚfigsvn
;

268 
ušt32_t
 
	gmisc£Ëù
;

269 
	gUn§ãBy‹s
<8> 
	g»£rved2
;

270 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	gcÚfigid
;

271 
	gUn§ãBy‹s
<384> 
	g»£rved3
;

272 } 
	gABSL_ATTRIBUTE_PACKED
;

274 
¡©ic_as£¹
((
T¬g‘šfo
) == 512,

279 
usšg
 
	gAligÃdT¬g‘šfoPŒ
 = 
AligÃdObjeùPŒ
<
T¬g‘šfo
, 512>;

282 
cÚ¡ex´
 
	gkR•Ütd©aSize
 = 64;

288 
	sR•Ütd©a
 {

289 
	gUn§ãBy‹s
<
	gkR•Ütd©aSize
> 
	gd©a
;

290 } 
	gABSL_ATTRIBUTE_PACKED
;

292 
¡©ic_as£¹
((
R•Ütd©a
è=ğ
kR•Ütd©aSize
,

297 
usšg
 
	gAligÃdR•Ütd©aPŒ
 = 
AligÃdObjeùPŒ
<
R•Ütd©a
, 128>;

300 
cÚ¡ex´
 
	gkR•ÜtKeyidSize
 = 32;

302 
¡©ic_as£¹
(
kR•ÜtKeyidSize
 =ğ
kKey»que¡KeyidSize
,

308 
	sR•Üt
 {

309 
	gUn§ãBy‹s
<
	gkCpusvnSize
> 
	gıusvn
;

310 
ušt32_t
 
	gmisc£Ëù
;

311 
	gUn§ãBy‹s
<12> 
	g»£rved1
;

312 
	gUn§ãBy‹s
<
	gkIsvexrodidSize
> 
	gisvexrodid
;

313 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

314 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gm»nşave
;

315 
	gUn§ãBy‹s
<32> 
	g»£rved2
;

316 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gmrsigÃr
;

317 
	gUn§ãBy‹s
<32> 
	g»£rved3
;

318 
	gUn§ãBy‹s
<
	gkCÚfigidSize
> 
	gcÚfigid
;

319 
ušt16_t
 
	gisv´odid
;

320 
ušt16_t
 
	gisvsvn
;

321 
ušt16_t
 
	gcÚfigsvn
;

322 
	gUn§ãBy‹s
<42> 
	g»£rved4
;

323 
	gUn§ãBy‹s
<
	gkIsvçmyidSize
> 
	gisvçmyid
;

324 
R•Ütd©a
 
	g»pÜtd©a
;

325 
	gUn§ãBy‹s
<
	gkR•ÜtKeyidSize
> 
	gkeyid
;

326 
	gUn§ãBy‹s
<
	gkSgxMacSize
> 
	gmac
;

327 } 
	gABSL_ATTRIBUTE_PACKED
;

329 
¡©ic_as£¹
((
R•Üt
) == 432, "Size of struct Report is incorrect");

333 
usšg
 
	gAligÃdR•ÜtPŒ
 = 
AligÃdObjeùPŒ
<
R•Üt
, 512>;

335 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
D©e
>::
v®ue
, "Date is‚ot‡rivialype");

336 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
Sig¡ruùH—d”
>::
v®ue
,

338 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
Sig¡ruùBody
>::
v®ue
,

340 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
R§3072PublicKey
>::
v®ue
,

342 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
Sig¡ruùSignšgD©a
>::
v®ue
,

344 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
Sig¡ruù
>::
v®ue
,

346 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
Key»que¡
>::
v®ue
,

348 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
T¬g‘šfo
>::
v®ue
,

350 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
R•Ütd©a
>::
v®ue
,

352 
¡©ic_as£¹
(
¡d
::
is_ŒivŸl
<
R•Üt
>::
v®ue
, "Report is‚ot‡rivialype");

	@identity/sgx/intel_architectural_enclave_interface.h

19 #iâdeà
ASYLO_IDENTITY_SGX_INTEL_ARCHITECTURAL_ENCLAVE_INTERFACE_H_


20 
	#ASYLO_IDENTITY_SGX_INTEL_ARCHITECTURAL_ENCLAVE_INTERFACE_H_


	)

22 
	~<c¡dšt
>

23 
	~<¡ršg
>

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/üy±o/ut/by‹s.h
"

27 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gsgx
 {

39 şas 
	cIÁ–Arch™eùu¿lEnşaveIÁ”çû
 {

40 
	gpublic
:

41 
vœtu®
 ~
IÁ–Arch™eùu¿lEnşaveIÁ”çû
() = ;

47 
vœtu®
 
Stus
 
G‘PûT¬g‘šfo
(
T¬g‘šfo
 *
rg‘šfo
,

48 
ušt16_t
 *
pû_svn
) = 0;

77 
vœtu®
 
Stus
 
G‘PûInfo
(cÚ¡ 
R•Üt
 &
»pÜt
,

78 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
µid_’üy±iÚ_key
,

79 
ušt8_t
 
üy±o_su™e
, 
¡d
::
¡ršg
 *
µid_’üy±ed
,

80 
ušt16_t
 *
pû_svn
, ušt16_ˆ*
pû_id
,

81 
ušt8_t
 *
sigÇtu»_scheme
) = 0;

90 
vœtu®
 
Stus
 
PûSignR•Üt
(cÚ¡ 
R•Üt
 &
»pÜt
, 
ušt16_t
 
rg‘_pû_svn
,

91 
Un§ãBy‹s
<
kCpusvnSize
> 
rg‘_ıu_svn
,

92 
¡d
::
¡ršg
 *
sigÇtu»
) = 0;

	@identity/sgx/intel_certs/intel_sgx_root_ca_cert.cc

19 
	~"asylo/id’t™y/sgx/š‹l_û¹s/š‹l_sgx_roÙ_ÿ_û¹.h
"

21 
Çme¥aû
 
	gasylo
 {

23 cÚ¡ *cÚ¡ 
	gkIÁ–SgxRoÙCaC”tifiÿ‹
 =

24 
R
"(-----BEGIN CERTIFICATE-----

25 
MIICjzCCAjSgAwIBAgIUImUM1lqdNInzg7SVUr9QGzknBqwwCgYIKoZIzj0EAwIw


26 
aDEaMBgGA1UEAwwRSW50ZWwgU0dYIFJvb3QgQ0ExGjAYBgNVBAoMEUludGVsIENv


27 
úBvcmF0aW9uMRQwEgYDVQQHDAtTYW50YSBDbGFyYTELMAkGA1UECAwCQ0ExCzAJ


28 
BgNVBAYTAlVTMB4XDTE4MDUyMTEwNDExMVoXDTMzMDUyMTEwNDExMFowaDEaMBgG


29 
A1UEAwwRSW50ZWwgU0dYIFJvb3QgQ0ExGjAYBgNVBAoMEUludGVsIENvúBvcmF0


30 
aW9uMRQwEgYDVQQHDAtTYW50YSBDbGFyYTELMAkGA1UECAwCQ0ExCzAJBgNVBAYT


31 
AlVTMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEC6nEwMDIYZOj
/
iPWsCzaEKi7


32 1
OiOSLRFhWGjbnBVJfVnkY4u3IjkDYYL0MxO4mqsyYjlB®TVYxFP2sJBK5zlKOB


33 
uzCBuDAfBgNVHSMEGDAWgBQiZQzWWp00ifODtJVSv1AbOScGrDBSBgNVHR8ESzBJ


34 
MEegRaBDhkFodHRwczovL2NlúRpZmljYXRlcy50úVzdGVkc2VydmljZXMuaW50


35 
ZWwuY29tL0ludGVsU0dYUm9vdENBLmNybDAdBgNVHQ4EFgQUImUM1lqdNInzg7SV


36 
Ur9QGzknBqwwDgYDVR0PAQH
/
BAQDAgEGMBIGA1UdEwEB
/
wQIMAYBAf8CAQAwCgYI


37 
KoZIzj0EAwIDSQAwRgIhAIpQ
/
KlO1XE4hH8cw5Ol
/
E0yzs8PToJe9Pşt
+
bhfLUg


38 
AiEAss0qf7FlMmAM‘
+
gbpLD97ldYy
/
wqjjmwN7yHRVr2AM
=

39 -----
END
 
CERTIFICATE
-----)";

	@identity/sgx/intel_certs/intel_sgx_root_ca_cert.cc

19 
	~"asylo/id’t™y/sgx/š‹l_û¹s/š‹l_sgx_roÙ_ÿ_û¹.h
"

21 
Çme¥aû
 
	gasylo
 {

23 cÚ¡ *cÚ¡ 
	gkIÁ–SgxRoÙCaC”tifiÿ‹
 =

24 
R
"(-----BEGIN CERTIFICATE-----

25 
MIICjzCCAjSgAwIBAgIUImUM1lqdNInzg7SVUr9QGzknBqwwCgYIKoZIzj0EAwIw


26 
aDEaMBgGA1UEAwwRSW50ZWwgU0dYIFJvb3QgQ0ExGjAYBgNVBAoMEUludGVsIENv


27 
úBvcmF0aW9uMRQwEgYDVQQHDAtTYW50YSBDbGFyYTELMAkGA1UECAwCQ0ExCzAJ


28 
BgNVBAYTAlVTMB4XDTE4MDUyMTEwNDExMVoXDTMzMDUyMTEwNDExMFowaDEaMBgG


29 
A1UEAwwRSW50ZWwgU0dYIFJvb3QgQ0ExGjAYBgNVBAoMEUludGVsIENvúBvcmF0


30 
aW9uMRQwEgYDVQQHDAtTYW50YSBDbGFyYTELMAkGA1UECAwCQ0ExCzAJBgNVBAYT


31 
AlVTMFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEC6nEwMDIYZOj
/
iPWsCzaEKi7


32 1
OiOSLRFhWGjbnBVJfVnkY4u3IjkDYYL0MxO4mqsyYjlB®TVYxFP2sJBK5zlKOB


33 
uzCBuDAfBgNVHSMEGDAWgBQiZQzWWp00ifODtJVSv1AbOScGrDBSBgNVHR8ESzBJ


34 
MEegRaBDhkFodHRwczovL2NlúRpZmljYXRlcy50úVzdGVkc2VydmljZXMuaW50


35 
ZWwuY29tL0ludGVsU0dYUm9vdENBLmNybDAdBgNVHQ4EFgQUImUM1lqdNInzg7SV


36 
Ur9QGzknBqwwDgYDVR0PAQH
/
BAQDAgEGMBIGA1UdEwEB
/
wQIMAYBAf8CAQAwCgYI


37 
KoZIzj0EAwIDSQAwRgIhAIpQ
/
KlO1XE4hH8cw5Ol
/
E0yzs8PToJe9Pşt
+
bhfLUg


38 
AiEAss0qf7FlMmAM‘
+
gbpLD97ldYy
/
wqjjmwN7yHRVr2AM
=

39 -----
END
 
CERTIFICATE
-----)";

	@identity/sgx/intel_certs/intel_sgx_root_ca_cert.h

19 #iâdeà
ASYLO_IDENTITY_SGX_INTEL_CERTS_INTEL_SGX_ROOT_CA_CERT_H_


20 
	#ASYLO_IDENTITY_SGX_INTEL_CERTS_INTEL_SGX_ROOT_CA_CERT_H_


	)

22 
Çme¥aû
 
	gasylo
 {

28 cÚ¡ *cÚ¡ 
kIÁ–SgxRoÙCaC”tifiÿ‹
;

	@identity/sgx/local_secret_sealer_helpers.cc

19 
	~"asylo/id’t™y/sgx/loÿl_£ü‘_£®”_h–³rs.h
"

21 
	~<c¡dšt
>

22 
	~<veùÜ
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/üy±o/sha256_hash.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

28 
	~"asylo/üy±o/ut/by‹s.h
"

29 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

30 
	~"asylo/id’t™y/id’t™y.pb.h
"

31 
	~"asylo/id’t™y/id’t™y_aş.pb.h
"

32 
	~"asylo/id’t™y/£®ed_£ü‘.pb.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

34 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

35 
	~"asylo/id’t™y/sgx/loÿl_£®ed_£ü‘.pb.h
"

36 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

37 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

38 
	~"asylo/ut/ş—nsšg_ty³s.h
"

39 
	~"asylo/ut/¡©us_maüos.h
"

41 
Çme¥aû
 
	gasylo
 {

42 
Çme¥aû
 
	gsgx
 {

43 
Çme¥aû
 
	gš‹º®
 {

45 
usšg
 
	gex³rim’l
::
A—dCry±Ü
;

47 cÚ¡ *cÚ¡ 
	gkSgxLoÿlSeü‘S—ËrRoÙName
 = "SGX";

49 
Stus
 
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

50 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
, 
Un§ãBy‹s
<
kCpusvnSize
> *
ıusvn
,

51 
Ch”Su™e
 *
ch”_su™e
, 
CodeId’t™yEx³ù©iÚ
 *
sgx_ex³ù©iÚ
) {

52 cÚ¡ 
	gS—lšgRoÙInfÜm©iÚ
 &
	groÙ_šfo
 = 
h—d”
.
roÙ_šfo
();

53 ià(
	groÙ_šfo
.
£®šg_roÙ_ty³
(è!ğ
LOCAL
) {

54  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57 ià(
	groÙ_šfo
.
£®šg_roÙ_Çme
(è!ğ
kSgxLoÿlSeü‘S—ËrRoÙName
) {

58  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
S—ËdSeü‘Add™iÚ®Info
 
	gšfo
;

62 ià(!
	gšfo
.
P¬£FromSŒšg
(
roÙ_šfo
.
add™iÚ®_šfo
())) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

66 ià(
	gšfo
.
ıusvn
().
size
() != cpusvn->size()) {

67  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

70 
	gıusvn
->
assign
(
šfo
.
ıusvn
().
d©a
(), info.ıusvn().
size
());

71 
ASYLO_ASSIGN_OR_RETURN
(*
ch”_su™e
,

72 
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(
h—d”
));

73 ià(
	gh—d”
.
ş›Á_aş
().
™em_ÿ£
(è!ğ
Id’t™yAşP»diÿ‹
::
kEx³ù©iÚ
) {

74  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Malformed client_acl");

76 cÚ¡ 
	gEnşaveId’t™yEx³ù©iÚ
 &
	gg’”ic_ex³ù©iÚ
 =

77 
h—d”
.
ş›Á_aş
().
ex³ù©iÚ
();

78 
ASYLO_RETURN_IF_ERROR
(

79 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, 
sgx_ex³ù©iÚ
));

80 
boŞ
 
	g»suÉ
;

81 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
,

82 
M©chId’t™yToEx³ù©iÚ
(
G‘S–fId’t™y
()->
id’t™y
,

83 *
sgx_ex³ù©iÚ
));

84 ià(!
	g»suÉ
) {

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

88  
	gStus
::
OkStus
();

91 
ušt16_t
 
CÚv”tM©chS³cToKeypŞicy
(cÚ¡ 
CodeId’t™yM©chS³c
 &
¥ec
) {

92 
ušt16_t
 
	gpŞicy
 = 0;

93 ià(
	g¥ec
.
is_m»nşave_m©ch_»quœed
()) {

94 
	gpŞicy
 |ğ
kKeypŞicyM»nşaveB™Mask
;

96 ià(
	g¥ec
.
is_mrsigÃr_m©ch_»quœed
()) {

97 
	gpŞicy
 |ğ
kKeypŞicyMrsigÃrB™Mask
;

99  
	gpŞicy
;

102 
Stus
 
G’”©eCry±ÜKey
(
Ch”Su™e
 
ch”_su™e
, cÚ¡ 
¡d
::
¡ršg
 &
key_id
,

103 cÚ¡ 
Un§ãBy‹s
<
kCpusvnSize
> &
ıusvn
,

104 cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
sgx_ex³ù©iÚ
,

105 
size_t
 
key_size
, 
CËªsšgVeùÜ
<
ušt8_t
> *
key
) {

116 
AligÃdKey»que¡PŒ
 
	g»q
;

119 *
	g»q
 = 
TrivŸlZ”oObjeù
<
Key»que¡
>();

121 
	g»q
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
SEAL_KEY
;

122 
	g»q
->
	gkeypŞicy
 = 
CÚv”tM©chS³cToKeypŞicy
(
sgx_ex³ù©iÚ
.
m©ch_¥ec
());

123 
	g»q
->
	gisvsvn
 =

124 
sgx_ex³ù©iÚ
.
»ã»nû_id’t™y
().
sigÃr_assigÃd_id’t™y
().
isvsvn
();

125 
	g»q
->
	gıusvn
 = 
ıusvn
;

126 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

127 
sgx_ex³ù©iÚ
.
m©ch_¥ec
().
©Œibu‹s_m©ch_mask
(),

128 &
»q
->
©Œibu‹mask
);

130 
	g»q
->
	gmiscmask
 = 
sgx_ex³ù©iÚ
.
m©ch_¥ec
().
misc£Ëù_m©ch_mask
();

132 
	gkey
->
»size
(0);

133 
	gkey
->
»£rve
(
key_size
);

135 
size_t
 
	g»maššg_key_by‹s
 = 
key_size
;

136 
size_t
 
	gkey_subsüt
 = 0;

137 
Sha256Hash
 
	ghash”
;

138 
	g»maššg_key_by‹s
 > 0) {

139 
	g¡d
::
veùÜ
<
ušt8_t
> 
key_šfo
;

143 
ASYLO_RETURN_IF_ERROR
(
S”ŸlizeBy‹CÚš”s
(

144 &
key_šfo
, 
S—lšgRoÙTy³_Name
(
LOCAL
), 
kSgxLoÿlSeü‘S—ËrRoÙName
,

145 
Ch”Su™e_Name
(
ch”_su™e
), 
key_id
, 
ab¦
::
SŒC©
(
key_size
),

146 
ab¦
::
SŒC©
(
key_subsüt
)));

148 
¡©ic_as£¹
(
deşty³
(
»q
->
keyid
)::
size
(è=ğ
SHA256_DIGEST_LENGTH
,

151 
	ghash”
.
In™
();

152 
	ghash”
.
Upd©e
(
key_šfo
);

153 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

154 
	ghash”
.
CumuÏtiveHash
(&
dige¡
);

155 
	g»q
->
	gkeyid
.
assign
(
dige¡
);

157 
AligÃdH¬dw¬eKeyPŒ
 
	gh¬dw¬e_key
;

158 
ASYLO_RETURN_IF_ERROR
(
G‘H¬dw¬eKey
(*
»q
, 
h¬dw¬e_key
.
g‘
()));

159 
size_t
 
	gcİy_size
 = 
¡d
::
mš
(
h¬dw¬e_key
->
size
(), 
»maššg_key_by‹s
);

160 
	g»maššg_key_by‹s
 -ğ
cİy_size
;

161 
	g¡d
::
cİy
(
h¬dw¬e_key
->
cbegš
(), h¬dw¬e_key->cbegš(è+ 
cİy_size
,

162 
¡d
::
back_š£¹”
(*
key
));

163 ++
	gkey_subsüt
;

165  
	gStus
::
OkStus
();

168 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dCry±Ü
>> 
MakeCry±Ü
(
Ch”Su™e
 
ch”_su™e
,

169 
By‹CÚš”V›w
 
key
) {

170 
	gch”_su™e
) {

171 
	gsgx
::
AES256_GCM_SIV
:

172  
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
key
);

173 
	gsgx
::
UNKNOWN_CIPHER_SUITE
:

175  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

180 
Stus
 
S—l
(
A—dCry±Ü
 *
üy±Ü
, 
By‹CÚš”V›w
 
£ü‘
,

181 
By‹CÚš”V›w
 
add™iÚ®_d©a
, 
S—ËdSeü‘
 *
£®ed_£ü‘
) {

182 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
(
£ü‘
.
size
(è+ 
üy±Ü
->
MaxS—lOv”h—d
());

183 
	g¡d
::
veùÜ
<
ušt8_t
> 
iv
(
üy±Ü
->
NÚûSize
());

185 
size_t
 
	gch”‹xt_size
 = 0;

186 
ASYLO_RETURN_IF_ERROR
(

187 
üy±Ü
->
S—l
(
£ü‘
, 
add™iÚ®_d©a
, 
ab¦
::
MakeS·n
(
iv
),

188 
ab¦
::
MakeS·n
(
ch”‹xt
), &
ch”‹xt_size
));

190 
	g£®ed_£ü‘
->
£t_£ü‘_ch”‹xt
(
ch”‹xt
.
d©a
(), 
ch”‹xt_size
);

191 
	g£®ed_£ü‘
->
£t_iv
(
iv
.
d©a
(), iv.
size
());

193  
	gStus
::
OkStus
();

196 
Stus
 
O³n
(
A—dCry±Ü
 *
üy±Ü
, cÚ¡ 
S—ËdSeü‘
 &
£®ed_£ü‘
,

197 
By‹CÚš”V›w
 
add™iÚ®_d©a
,

198 
CËªsšgVeùÜ
<
ušt8_t
> *
£ü‘
) {

199 
	g£ü‘
->
»size
(
£®ed_£ü‘
.
£ü‘_ch”‹xt
().
size
());

200 
size_t
 
	g¶aš‹xt_size
 = 0;

201 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
O³n
(

202 
£®ed_£ü‘
.
£ü‘_ch”‹xt
(), 
add™iÚ®_d©a
, s—Ëd_£ü‘.
iv
(),

203 
ab¦
::
MakeS·n
(*
£ü‘
), &
¶aš‹xt_size
));

204 
	g£ü‘
->
»size
(
¶aš‹xt_size
);

205  
	gStus
::
OkStus
();

208 
	gStusOr
<
	gCh”Su™e
> 
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(

209 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) {

210 
S—ËdSeü‘Add™iÚ®Info
 
	gšfo
;

211 ià(!
	gšfo
.
P¬£FromSŒšg
(
h—d”
.
roÙ_šfo
().
add™iÚ®_šfo
())) {

212  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

215 ià(
	gšfo
.
ch”_su™e
(è=ğ
UNKNOWN_CIPHER_SUITE
) {

216  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

219  
	gšfo
.
ch”_su™e
();

222 
A—dScheme
 
Ch”Su™eToA—dScheme
(
Ch”Su™e
 
ch”_su™e
) {

223 
	gch”_su™e
) {

224 
	gsgx
::
AES256_GCM_SIV
:

225  
A—dScheme
::
AES256_GCM_SIV
;

227  
A—dScheme
::
UNKNOWN_AEAD_SCHEME
;

	@identity/sgx/local_secret_sealer_helpers.cc

19 
	~"asylo/id’t™y/sgx/loÿl_£ü‘_£®”_h–³rs.h
"

21 
	~<c¡dšt
>

22 
	~<veùÜ
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/üy±o/sha256_hash.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

28 
	~"asylo/üy±o/ut/by‹s.h
"

29 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

30 
	~"asylo/id’t™y/id’t™y.pb.h
"

31 
	~"asylo/id’t™y/id’t™y_aş.pb.h
"

32 
	~"asylo/id’t™y/£®ed_£ü‘.pb.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

34 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

35 
	~"asylo/id’t™y/sgx/loÿl_£®ed_£ü‘.pb.h
"

36 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

37 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

38 
	~"asylo/ut/ş—nsšg_ty³s.h
"

39 
	~"asylo/ut/¡©us_maüos.h
"

41 
Çme¥aû
 
	gasylo
 {

42 
Çme¥aû
 
	gsgx
 {

43 
Çme¥aû
 
	gš‹º®
 {

45 
usšg
 
	gex³rim’l
::
A—dCry±Ü
;

47 cÚ¡ *cÚ¡ 
	gkSgxLoÿlSeü‘S—ËrRoÙName
 = "SGX";

49 
Stus
 
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

50 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
, 
Un§ãBy‹s
<
kCpusvnSize
> *
ıusvn
,

51 
Ch”Su™e
 *
ch”_su™e
, 
CodeId’t™yEx³ù©iÚ
 *
sgx_ex³ù©iÚ
) {

52 cÚ¡ 
	gS—lšgRoÙInfÜm©iÚ
 &
	groÙ_šfo
 = 
h—d”
.
roÙ_šfo
();

53 ià(
	groÙ_šfo
.
£®šg_roÙ_ty³
(è!ğ
LOCAL
) {

54  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57 ià(
	groÙ_šfo
.
£®šg_roÙ_Çme
(è!ğ
kSgxLoÿlSeü‘S—ËrRoÙName
) {

58  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
S—ËdSeü‘Add™iÚ®Info
 
	gšfo
;

62 ià(!
	gšfo
.
P¬£FromSŒšg
(
roÙ_šfo
.
add™iÚ®_šfo
())) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

66 ià(
	gšfo
.
ıusvn
().
size
() != cpusvn->size()) {

67  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

70 
	gıusvn
->
assign
(
šfo
.
ıusvn
().
d©a
(), info.ıusvn().
size
());

71 
ASYLO_ASSIGN_OR_RETURN
(*
ch”_su™e
,

72 
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(
h—d”
));

73 ià(
	gh—d”
.
ş›Á_aş
().
™em_ÿ£
(è!ğ
Id’t™yAşP»diÿ‹
::
kEx³ù©iÚ
) {

74  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Malformed client_acl");

76 cÚ¡ 
	gEnşaveId’t™yEx³ù©iÚ
 &
	gg’”ic_ex³ù©iÚ
 =

77 
h—d”
.
ş›Á_aş
().
ex³ù©iÚ
();

78 
ASYLO_RETURN_IF_ERROR
(

79 
P¬£SgxEx³ù©iÚ
(
g’”ic_ex³ù©iÚ
, 
sgx_ex³ù©iÚ
));

80 
boŞ
 
	g»suÉ
;

81 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
,

82 
M©chId’t™yToEx³ù©iÚ
(
G‘S–fId’t™y
()->
id’t™y
,

83 *
sgx_ex³ù©iÚ
));

84 ià(!
	g»suÉ
) {

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

88  
	gStus
::
OkStus
();

91 
ušt16_t
 
CÚv”tM©chS³cToKeypŞicy
(cÚ¡ 
CodeId’t™yM©chS³c
 &
¥ec
) {

92 
ušt16_t
 
	gpŞicy
 = 0;

93 ià(
	g¥ec
.
is_m»nşave_m©ch_»quœed
()) {

94 
	gpŞicy
 |ğ
kKeypŞicyM»nşaveB™Mask
;

96 ià(
	g¥ec
.
is_mrsigÃr_m©ch_»quœed
()) {

97 
	gpŞicy
 |ğ
kKeypŞicyMrsigÃrB™Mask
;

99  
	gpŞicy
;

102 
Stus
 
G’”©eCry±ÜKey
(
Ch”Su™e
 
ch”_su™e
, cÚ¡ 
¡d
::
¡ršg
 &
key_id
,

103 cÚ¡ 
Un§ãBy‹s
<
kCpusvnSize
> &
ıusvn
,

104 cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
sgx_ex³ù©iÚ
,

105 
size_t
 
key_size
, 
CËªsšgVeùÜ
<
ušt8_t
> *
key
) {

116 
AligÃdKey»que¡PŒ
 
	g»q
;

119 *
	g»q
 = 
TrivŸlZ”oObjeù
<
Key»que¡
>();

121 
	g»q
->
	gkeyÇme
 = 
Key»que¡KeyÇme
::
SEAL_KEY
;

122 
	g»q
->
	gkeypŞicy
 = 
CÚv”tM©chS³cToKeypŞicy
(
sgx_ex³ù©iÚ
.
m©ch_¥ec
());

123 
	g»q
->
	gisvsvn
 =

124 
sgx_ex³ù©iÚ
.
»ã»nû_id’t™y
().
sigÃr_assigÃd_id’t™y
().
isvsvn
();

125 
	g»q
->
	gıusvn
 = 
ıusvn
;

126 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

127 
sgx_ex³ù©iÚ
.
m©ch_¥ec
().
©Œibu‹s_m©ch_mask
(),

128 &
»q
->
©Œibu‹mask
);

130 
	g»q
->
	gmiscmask
 = 
sgx_ex³ù©iÚ
.
m©ch_¥ec
().
misc£Ëù_m©ch_mask
();

132 
	gkey
->
»size
(0);

133 
	gkey
->
»£rve
(
key_size
);

135 
size_t
 
	g»maššg_key_by‹s
 = 
key_size
;

136 
size_t
 
	gkey_subsüt
 = 0;

137 
Sha256Hash
 
	ghash”
;

138 
	g»maššg_key_by‹s
 > 0) {

139 
	g¡d
::
veùÜ
<
ušt8_t
> 
key_šfo
;

143 
ASYLO_RETURN_IF_ERROR
(
S”ŸlizeBy‹CÚš”s
(

144 &
key_šfo
, 
S—lšgRoÙTy³_Name
(
LOCAL
), 
kSgxLoÿlSeü‘S—ËrRoÙName
,

145 
Ch”Su™e_Name
(
ch”_su™e
), 
key_id
, 
ab¦
::
SŒC©
(
key_size
),

146 
ab¦
::
SŒC©
(
key_subsüt
)));

148 
¡©ic_as£¹
(
deşty³
(
»q
->
keyid
)::
size
(è=ğ
SHA256_DIGEST_LENGTH
,

151 
	ghash”
.
In™
();

152 
	ghash”
.
Upd©e
(
key_šfo
);

153 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

154 
	ghash”
.
CumuÏtiveHash
(&
dige¡
);

155 
	g»q
->
	gkeyid
.
assign
(
dige¡
);

157 
AligÃdH¬dw¬eKeyPŒ
 
	gh¬dw¬e_key
;

158 
ASYLO_RETURN_IF_ERROR
(
G‘H¬dw¬eKey
(*
»q
, 
h¬dw¬e_key
.
g‘
()));

159 
size_t
 
	gcİy_size
 = 
¡d
::
mš
(
h¬dw¬e_key
->
size
(), 
»maššg_key_by‹s
);

160 
	g»maššg_key_by‹s
 -ğ
cİy_size
;

161 
	g¡d
::
cİy
(
h¬dw¬e_key
->
cbegš
(), h¬dw¬e_key->cbegš(è+ 
cİy_size
,

162 
¡d
::
back_š£¹”
(*
key
));

163 ++
	gkey_subsüt
;

165  
	gStus
::
OkStus
();

168 
	gStusOr
<
	g¡d
::
unique_±r
<
A—dCry±Ü
>> 
MakeCry±Ü
(
Ch”Su™e
 
ch”_su™e
,

169 
By‹CÚš”V›w
 
key
) {

170 
	gch”_su™e
) {

171 
	gsgx
::
AES256_GCM_SIV
:

172  
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
key
);

173 
	gsgx
::
UNKNOWN_CIPHER_SUITE
:

175  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

180 
Stus
 
S—l
(
A—dCry±Ü
 *
üy±Ü
, 
By‹CÚš”V›w
 
£ü‘
,

181 
By‹CÚš”V›w
 
add™iÚ®_d©a
, 
S—ËdSeü‘
 *
£®ed_£ü‘
) {

182 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
(
£ü‘
.
size
(è+ 
üy±Ü
->
MaxS—lOv”h—d
());

183 
	g¡d
::
veùÜ
<
ušt8_t
> 
iv
(
üy±Ü
->
NÚûSize
());

185 
size_t
 
	gch”‹xt_size
 = 0;

186 
ASYLO_RETURN_IF_ERROR
(

187 
üy±Ü
->
S—l
(
£ü‘
, 
add™iÚ®_d©a
, 
ab¦
::
MakeS·n
(
iv
),

188 
ab¦
::
MakeS·n
(
ch”‹xt
), &
ch”‹xt_size
));

190 
	g£®ed_£ü‘
->
£t_£ü‘_ch”‹xt
(
ch”‹xt
.
d©a
(), 
ch”‹xt_size
);

191 
	g£®ed_£ü‘
->
£t_iv
(
iv
.
d©a
(), iv.
size
());

193  
	gStus
::
OkStus
();

196 
Stus
 
O³n
(
A—dCry±Ü
 *
üy±Ü
, cÚ¡ 
S—ËdSeü‘
 &
£®ed_£ü‘
,

197 
By‹CÚš”V›w
 
add™iÚ®_d©a
,

198 
CËªsšgVeùÜ
<
ušt8_t
> *
£ü‘
) {

199 
	g£ü‘
->
»size
(
£®ed_£ü‘
.
£ü‘_ch”‹xt
().
size
());

200 
size_t
 
	g¶aš‹xt_size
 = 0;

201 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
O³n
(

202 
£®ed_£ü‘
.
£ü‘_ch”‹xt
(), 
add™iÚ®_d©a
, s—Ëd_£ü‘.
iv
(),

203 
ab¦
::
MakeS·n
(*
£ü‘
), &
¶aš‹xt_size
));

204 
	g£ü‘
->
»size
(
¶aš‹xt_size
);

205  
	gStus
::
OkStus
();

208 
	gStusOr
<
	gCh”Su™e
> 
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(

209 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) {

210 
S—ËdSeü‘Add™iÚ®Info
 
	gšfo
;

211 ià(!
	gšfo
.
P¬£FromSŒšg
(
h—d”
.
roÙ_šfo
().
add™iÚ®_šfo
())) {

212  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

215 ià(
	gšfo
.
ch”_su™e
(è=ğ
UNKNOWN_CIPHER_SUITE
) {

216  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

219  
	gšfo
.
ch”_su™e
();

222 
A—dScheme
 
Ch”Su™eToA—dScheme
(
Ch”Su™e
 
ch”_su™e
) {

223 
	gch”_su™e
) {

224 
	gsgx
::
AES256_GCM_SIV
:

225  
A—dScheme
::
AES256_GCM_SIV
;

227  
A—dScheme
::
UNKNOWN_AEAD_SCHEME
;

	@identity/sgx/local_secret_sealer_helpers.h

19 #iâdeà
ASYLO_IDENTITY_SGX_LOCAL_SECRET_SEALER_HELPERS_H_


20 
	#ASYLO_IDENTITY_SGX_LOCAL_SECRET_SEALER_HELPERS_H_


	)

22 
	~"asylo/üy±o/«ad_üy±Ü.h
"

23 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

24 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/id’t™y/£®ed_£ü‘.pb.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

28 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

29 
	~"asylo/id’t™y/sgx/loÿl_£®ed_£ü‘.pb.h
"

30 
	~"asylo/ut/ş—nsšg_ty³s.h
"

31 
	~"asylo/ut/¡©us.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	gsgx
 {

35 
Çme¥aû
 
	gš‹º®
 {

37 cÚ¡ *cÚ¡ 
kSgxLoÿlSeü‘S—ËrRoÙName
;

41 
Stus
 
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

42 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
, 
Un§ãBy‹s
<
kCpusvnSize
> *
ıusvn
,

43 
Ch”Su™e
 *
ch”_su™e
, 
CodeId’t™yEx³ù©iÚ
 *
sgx_ex³ù©iÚ
);

46 
ušt16_t
 
CÚv”tM©chS³cToKeypŞicy
(cÚ¡ 
CodeId’t™yM©chS³c
 &
¥ec
);

50 
Stus
 
G’”©eCry±ÜKey
(
Ch”Su™e
 
ch”_su™e
, cÚ¡ 
¡d
::
¡ršg
 &
key_id
,

51 cÚ¡ 
Un§ãBy‹s
<
kCpusvnSize
> &
ıusvn
,

52 cÚ¡ 
CodeId’t™yEx³ù©iÚ
 &
sgx_ex³ù©iÚ
,

53 
size_t
 
key_size
, 
CËªsšgVeùÜ
<
ušt8_t
> *
key
);

57 
	gStusOr
<
	g¡d
::
unique_±r
<
ex³rim’l
::
A—dCry±Ü
>> 
MakeCry±Ü
(

58 
Ch”Su™e
 
ch”_su™e
, 
By‹CÚš”V›w
 
key
);

61 
Stus
 
S—l
(
ex³rim’l
::
A—dCry±Ü
 *
üy±Ü
, 
By‹CÚš”V›w
 
£ü‘
,

62 
By‹CÚš”V›w
 
add™iÚ®_d©a
, 
S—ËdSeü‘
 *
£®ed_£ü‘
);

65 
Stus
 
O³n
(
ex³rim’l
::
A—dCry±Ü
 *
üy±Ü
,

66 cÚ¡ 
S—ËdSeü‘
 &
£®ed_£ü‘
,

67 
By‹CÚš”V›w
 
add™iÚ®_d©a
,

68 
CËªsšgVeùÜ
<
ušt8_t
> *
£ü‘
);

72 
	gStusOr
<
	gCh”Su™e
> 
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(

73 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
);

76 
A—dScheme
 
Ch”Su™eToA—dScheme
(
Ch”Su™e
 
ch”_su™e
);

	@identity/sgx/pce_util.cc

19 
	~"asylo/id’t™y/sgx/pû_ut.h
"

21 
	~<İ’s¦/bn.h
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

26 
	~"ab¦/ba£/maüos.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

30 
	~"asylo/üy±o/ut/bs¦_ut.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/id’t™y/add™iÚ®_auth’tiÿ‹d_d©a_g’”©Ü.h
"

33 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

34 
	~"asylo/ut/¡©us.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

36 
	~"QuÙeG’”©iÚ/psw/pû_w¿µ”/šc/sgx_pû.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	gsgx
 {

41 cÚ¡ 
size_t
 
	gkR§3072S”ŸlizedExpÚ’tSize
 = 4;

43 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(

44 
Asymm‘ricEnüy±iÚScheme
 
asymm‘ric_’üy±iÚ_scheme
) {

45 
asymm‘ric_’üy±iÚ_scheme
) {

46 
RSA3072_OAEP
:

47  
¡©ic_ÿ¡
<
ušt8_t
>(
PCE_ALG_RSA_OAEP_3072
);

48 
	gRSA2048_OAEP
:

49 
ABSL_FALLTHROUGH_INTENDED
;

51  
ab¦
::
nuÎİt
;

55 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
SigÇtu»SchemeToPûSigÇtu»Scheme
(

56 
SigÇtu»Scheme
 
sigÇtu»_scheme
) {

57 
sigÇtu»_scheme
) {

58 
ECDSA_P256_SHA256
:

59  
¡©ic_ÿ¡
<
ušt8_t
>(
PCE_NIST_P256_ECDSA_SHA256
);

61  
ab¦
::
nuÎİt
;

65 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
RSA
>> 
P¬£R§3072PublicKey
(

66 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
public_key
) {

67 ià(
public_key
.
size
() !=

68 
kR§3072ModulusSize
 + 
kR§3072S”ŸlizedExpÚ’tSize
) {

69  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

70 
ab¦
::
SŒC©
("Inv®id…ubliøkey size: ", 
public_key
.
size
()));

73 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
modulus
(
BN_Ãw
());

74 ià(!
	gmodulus
) {

75  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

78 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
expÚ’t
(
BN_Ãw
());

79 ià(!
	gexpÚ’t
) {

80  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

83 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

84 ià(!
	gr§
) {

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

88 
BN_bš2bn
(
public_key
.
d©a
(), 
kR§3072ModulusSize
, 
modulus
.
g‘
());

89 
BN_bš2bn
(
public_key
.
d©a
(è+ 
kR§3072ModulusSize
,

90  
kR§3072S”ŸlizedExpÚ’tSize
, 
expÚ’t
.
g‘
());

93 ià(
RSA_£t0_key
(
r§
.
g‘
(), 
modulus
.
»Ëa£
(), 
expÚ’t
.release(),

94  
nuÎ±r
) != 1) {

95  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

98  
	gr§
;

101 
	gStusOr
<
	g¡d
::
veùÜ
<
ušt8_t
>> 
S”ŸlizeR§3072PublicKey
(cÚ¡ 
RSA
 *
r§
) {

102 
size_t
 
r§_size
 = 
RSA_size
(
r§
);

103 ià(
	gr§_size
 !ğ
kR§3072ModulusSize
) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
ab¦
::
SŒC©
("Inv®id…ubliøkey size: ", 
r§_size
));

108 cÚ¡ 
BIGNUM
 *
	gn
;

109 cÚ¡ 
BIGNUM
 *
	ge
;

112 
RSA_g‘0_key
(
r§
, &
n
, &
e
, 
nuÎ±r
);

114 
	g¡d
::
veùÜ
<
ušt8_t
> 
ouut
(
kR§3072ModulusSize
 +

115 
kR§3072S”ŸlizedExpÚ’tSize
);

116 ià(!
BN_bn2bš_·dded
(
ouut
.
d©a
(), 
kR§3072ModulusSize
, 
n
) ||

117 !
BN_bn2bš_·dded
(
ouut
.
d©a
(è+ 
kR§3072ModulusSize
,

118  
kR§3072S”ŸlizedExpÚ’tSize
, 
e
)) {

119  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

122  
	gouut
;

125 
	gStusOr
<
	gR•Ütd©a
> 
C»©eR•Ütd©aFÜG‘PûInfo
(

126 
Asymm‘ricEnüy±iÚScheme
 
asymm‘ric_’üy±iÚ_scheme
, cÚ¡ 
RSA
 *
r§
) {

127 
size_t
 
	gr§_size
 = 
RSA_size
(
r§
);

128 ià(
	gr§_size
 !ğ
kR§3072ModulusSize
) {

129  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

130 
ab¦
::
SŒC©
("Inv®id modulu size: ", 
r§_size
));

133 ià(
	gasymm‘ric_’üy±iÚ_scheme
 !=

134 
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
) {

135  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

136 
ab¦
::
SŒC©
("Unsupportedƒncryption scheme: ",

137 
Asymm‘ricEnüy±iÚScheme_Name
(

138 
asymm‘ric_’üy±iÚ_scheme
)));

141 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
üy±o_su™e
 =

142 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(

143 
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
);

144 ià(!
	güy±o_su™e
.
has_v®ue
()) {

145  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

146 
ab¦
::
SŒC©
("No conversion from AsymmetricEncryptionScheme "

148 
Asymm‘ricEnüy±iÚScheme_Name
(

149 
asymm‘ric_’üy±iÚ_scheme
)));

152 
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
> 
¯d_g’”©Ü
;

153 
ASYLO_ASSIGN_OR_RETURN
(

154 
¯d_g’”©Ü
,

155 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eG‘PûInfoAadG’”©Ü
());

156 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a_cŞËùÜ
;

157 
ASYLO_ASSIGN_OR_RETURN
(
d©a_cŞËùÜ
, 
S”ŸlizeR§3072PublicKey
(
r§
));

158 
	gd©a_cŞËùÜ
.
š£¹
(
d©a_cŞËùÜ
.
begš
(), 
üy±o_su™e
.
v®ue
());

159 
	g¡d
::
¡ršg
 
¯d_g’”©e_šput
(
d©a_cŞËùÜ
.
cbegš
(),

160 
d©a_cŞËùÜ
.
ûnd
());

161 
	g¡d
::
¡ršg
 
¯d
;

162 
ASYLO_ASSIGN_OR_RETURN
(
¯d
, 
¯d_g’”©Ü
->
G’”©e
(
¯d_g’”©e_šput
));

164 
R•Ütd©a
 
	g»pÜtd©a
;

165 
ASYLO_RETURN_IF_ERROR
(

166 
S‘TrivŸlObjeùFromBš¬ySŒšg
(
¯d
, &
»pÜtd©a
.
d©a
));

167  
	g»pÜtd©a
;

	@identity/sgx/pce_util.cc

19 
	~"asylo/id’t™y/sgx/pû_ut.h
"

21 
	~<İ’s¦/bn.h
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

26 
	~"ab¦/ba£/maüos.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

30 
	~"asylo/üy±o/ut/bs¦_ut.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/id’t™y/add™iÚ®_auth’tiÿ‹d_d©a_g’”©Ü.h
"

33 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

34 
	~"asylo/ut/¡©us.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

36 
	~"QuÙeG’”©iÚ/psw/pû_w¿µ”/šc/sgx_pû.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	gsgx
 {

41 cÚ¡ 
size_t
 
	gkR§3072S”ŸlizedExpÚ’tSize
 = 4;

43 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(

44 
Asymm‘ricEnüy±iÚScheme
 
asymm‘ric_’üy±iÚ_scheme
) {

45 
asymm‘ric_’üy±iÚ_scheme
) {

46 
RSA3072_OAEP
:

47  
¡©ic_ÿ¡
<
ušt8_t
>(
PCE_ALG_RSA_OAEP_3072
);

48 
	gRSA2048_OAEP
:

49 
ABSL_FALLTHROUGH_INTENDED
;

51  
ab¦
::
nuÎİt
;

55 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
SigÇtu»SchemeToPûSigÇtu»Scheme
(

56 
SigÇtu»Scheme
 
sigÇtu»_scheme
) {

57 
sigÇtu»_scheme
) {

58 
ECDSA_P256_SHA256
:

59  
¡©ic_ÿ¡
<
ušt8_t
>(
PCE_NIST_P256_ECDSA_SHA256
);

61  
ab¦
::
nuÎİt
;

65 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
RSA
>> 
P¬£R§3072PublicKey
(

66 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
public_key
) {

67 ià(
public_key
.
size
() !=

68 
kR§3072ModulusSize
 + 
kR§3072S”ŸlizedExpÚ’tSize
) {

69  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

70 
ab¦
::
SŒC©
("Inv®id…ubliøkey size: ", 
public_key
.
size
()));

73 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
modulus
(
BN_Ãw
());

74 ià(!
	gmodulus
) {

75  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

78 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
expÚ’t
(
BN_Ãw
());

79 ià(!
	gexpÚ’t
) {

80  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

83 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

84 ià(!
	gr§
) {

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

88 
BN_bš2bn
(
public_key
.
d©a
(), 
kR§3072ModulusSize
, 
modulus
.
g‘
());

89 
BN_bš2bn
(
public_key
.
d©a
(è+ 
kR§3072ModulusSize
,

90  
kR§3072S”ŸlizedExpÚ’tSize
, 
expÚ’t
.
g‘
());

93 ià(
RSA_£t0_key
(
r§
.
g‘
(), 
modulus
.
»Ëa£
(), 
expÚ’t
.release(),

94  
nuÎ±r
) != 1) {

95  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

98  
	gr§
;

101 
	gStusOr
<
	g¡d
::
veùÜ
<
ušt8_t
>> 
S”ŸlizeR§3072PublicKey
(cÚ¡ 
RSA
 *
r§
) {

102 
size_t
 
r§_size
 = 
RSA_size
(
r§
);

103 ià(
	gr§_size
 !ğ
kR§3072ModulusSize
) {

104  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

105 
ab¦
::
SŒC©
("Inv®id…ubliøkey size: ", 
r§_size
));

108 cÚ¡ 
BIGNUM
 *
	gn
;

109 cÚ¡ 
BIGNUM
 *
	ge
;

112 
RSA_g‘0_key
(
r§
, &
n
, &
e
, 
nuÎ±r
);

114 
	g¡d
::
veùÜ
<
ušt8_t
> 
ouut
(
kR§3072ModulusSize
 +

115 
kR§3072S”ŸlizedExpÚ’tSize
);

116 ià(!
BN_bn2bš_·dded
(
ouut
.
d©a
(), 
kR§3072ModulusSize
, 
n
) ||

117 !
BN_bn2bš_·dded
(
ouut
.
d©a
(è+ 
kR§3072ModulusSize
,

118  
kR§3072S”ŸlizedExpÚ’tSize
, 
e
)) {

119  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

122  
	gouut
;

125 
	gStusOr
<
	gR•Ütd©a
> 
C»©eR•Ütd©aFÜG‘PûInfo
(

126 
Asymm‘ricEnüy±iÚScheme
 
asymm‘ric_’üy±iÚ_scheme
, cÚ¡ 
RSA
 *
r§
) {

127 
size_t
 
	gr§_size
 = 
RSA_size
(
r§
);

128 ià(
	gr§_size
 !ğ
kR§3072ModulusSize
) {

129  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

130 
ab¦
::
SŒC©
("Inv®id modulu size: ", 
r§_size
));

133 ià(
	gasymm‘ric_’üy±iÚ_scheme
 !=

134 
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
) {

135  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

136 
ab¦
::
SŒC©
("Unsupportedƒncryption scheme: ",

137 
Asymm‘ricEnüy±iÚScheme_Name
(

138 
asymm‘ric_’üy±iÚ_scheme
)));

141 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
üy±o_su™e
 =

142 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(

143 
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
);

144 ià(!
	güy±o_su™e
.
has_v®ue
()) {

145  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

146 
ab¦
::
SŒC©
("No conversion from AsymmetricEncryptionScheme "

148 
Asymm‘ricEnüy±iÚScheme_Name
(

149 
asymm‘ric_’üy±iÚ_scheme
)));

152 
	g¡d
::
unique_±r
<
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
> 
¯d_g’”©Ü
;

153 
ASYLO_ASSIGN_OR_RETURN
(

154 
¯d_g’”©Ü
,

155 
Add™iÚ®Auth’tiÿ‹dD©aG’”©Ü
::
C»©eG‘PûInfoAadG’”©Ü
());

156 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a_cŞËùÜ
;

157 
ASYLO_ASSIGN_OR_RETURN
(
d©a_cŞËùÜ
, 
S”ŸlizeR§3072PublicKey
(
r§
));

158 
	gd©a_cŞËùÜ
.
š£¹
(
d©a_cŞËùÜ
.
begš
(), 
üy±o_su™e
.
v®ue
());

159 
	g¡d
::
¡ršg
 
¯d_g’”©e_šput
(
d©a_cŞËùÜ
.
cbegš
(),

160 
d©a_cŞËùÜ
.
ûnd
());

161 
	g¡d
::
¡ršg
 
¯d
;

162 
ASYLO_ASSIGN_OR_RETURN
(
¯d
, 
¯d_g’”©Ü
->
G’”©e
(
¯d_g’”©e_šput
));

164 
R•Ütd©a
 
	g»pÜtd©a
;

165 
ASYLO_RETURN_IF_ERROR
(

166 
S‘TrivŸlObjeùFromBš¬ySŒšg
(
¯d
, &
»pÜtd©a
.
d©a
));

167  
	g»pÜtd©a
;

	@identity/sgx/pce_util.h

19 #iâdeà
ASYLO_IDENTITY_SGX_PCE_UTIL_H_


20 
	#ASYLO_IDENTITY_SGX_PCE_UTIL_H_


	)

22 
	~<İ’s¦/ba£.h
>

23 
	~<İ’s¦/r§.h
>

25 
	~<c¡dšt
>

26 
	~<veùÜ
>

28 
	~"ab¦/ba£/©Œibu‹s.h
"

29 
	~"ab¦/ty³s/İtiÚ®.h
"

30 
	~"ab¦/ty³s/¥ª.h
"

31 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

32 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

33 
	~"asylo/ut/¡©usÜ.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	gsgx
 {

38 
ABSL_CONST_INIT
 cÚ¡ 
size_t
 
kR§3072S”ŸlizedExpÚ’tSize
;

45 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(

46 
Asymm‘ricEnüy±iÚScheme
 
asymm‘ric_’üy±iÚ_scheme
);

50 
	gab¦
::
İtiÚ®
<
ušt8_t
> 
SigÇtu»SchemeToPûSigÇtu»Scheme
(

51 
SigÇtu»Scheme
 
sigÇtu»_scheme
);

60 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
RSA
>> 
P¬£R§3072PublicKey
(

61 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
public_key
);

69 
	gStusOr
<
	g¡d
::
veùÜ
<
ušt8_t
>> 
S”ŸlizeR§3072PublicKey
(cÚ¡ 
RSA
 *
r§
);

73 
	gStusOr
<
	gR•Ütd©a
> 
C»©eR•Ütd©aFÜG‘PûInfo
(

74 
Asymm‘ricEnüy±iÚScheme
 
asymm‘ric_’üy±iÚ_scheme
, cÚ¡ 
RSA
 *
r§
);

	@identity/sgx/pce_util_test.cc

19 
	~"asylo/id’t™y/sgx/pû_ut.h
"

21 
	~<İ’s¦/ba£.h
>

22 
	~<İ’s¦/bn.h
>

23 
	~<İ’s¦/r§.h
>

25 
	~<c¡dšt
>

26 
	~<ut™y
>

27 
	~<veùÜ
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/ba£/maüos.h
"

32 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

33 
	~"ab¦/¡ršgs/esÿpšg.h
"

34 
	~"ab¦/ty³s/İtiÚ®.h
"

35 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

36 
	~"asylo/üy±o/ut/bs¦_ut.h
"

37 
	~"asylo/üy±o/ut/by‹s.h
"

38 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

39 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

40 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

41 
	~"asylo/ut/¡©us_maüos.h
"

42 
	~"QuÙeG’”©iÚ/psw/pû_w¿µ”/šc/sgx_pû.h
"

44 
Çme¥aû
 
	gasylo
 {

45 
Çme¥aû
 
	gsgx
 {

46 
	gÇme¥aû
 {

48 
cÚ¡ex´
 
	gkSeü‘Mes§ge
[] = "secret message";

51 
cÚ¡ex´
 
	gkExpÚ’tBigEndŸnHex
[] = "00010001";

54 
cÚ¡ex´
 
	gkModulusBigEndŸnHex
[] =

67 
cÚ¡ex´
 
	gkEx³ùedR•Ütd©a
[] =

71 
	gusšg
 ::
‹¡šg
::
Eq
;

72 
	gusšg
 ::
‹¡šg
::
O±iÚ®
;

73 
	gusšg
 ::
‹¡šg
::
SizeIs
;

76 
cÚ¡ex´
 
Asymm‘ricEnüy±iÚScheme
 
	gkSuµÜ‹dEnüy±iÚSchemes
[] = {

77 
RSA3072_OAEP
};

80 
cÚ¡ex´
 
ušt8_t
 
	gkT¿n¦©edEnüy±iÚSchemes
[] = {
PCE_ALG_RSA_OAEP_3072
};

83 
cÚ¡ex´
 
SigÇtu»Scheme
 
	gkSuµÜ‹dSigÇtu»Schemes
[] = {
ECDSA_P256_SHA256
};

87 
cÚ¡ex´
 
ušt8_t
 
	gkT¿n¦©edSigÇtu»Schemes
[] = {
PCE_NIST_P256_ECDSA_SHA256
};

89 şas 
	cPûUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

90 
public
:

91 
S‘Up
(è
ov”ride
 {

92 
suµÜ‹d_’üy±iÚ_schemes_
.
»£rve
(

93 
ABSL_ARRAYSIZE
(
kSuµÜ‹dEnüy±iÚSchemes
));

94 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kSuµÜ‹dEnüy±iÚSchemes
); ++i) {

95 
ASSERT_TRUE
(
suµÜ‹d_’üy±iÚ_schemes_


96 .
em¶aû
(
kSuµÜ‹dEnüy±iÚSchemes
[
i
],

97 
kT¿n¦©edEnüy±iÚSchemes
[
i
])

98 .
£cÚd
);

100 
	gi
 = 0; i < 
	gAsymm‘ricEnüy±iÚScheme_ARRAYSIZE
; ++i) {

101 ià(
Asymm‘ricEnüy±iÚScheme_IsV®id
(
i
)) {

102 
Asymm‘ricEnüy±iÚScheme
 
	gscheme
 =

103 
¡©ic_ÿ¡
<
Asymm‘ricEnüy±iÚScheme
>(
i
);

104 ià(!
	gsuµÜ‹d_’üy±iÚ_schemes_
.
cÚšs
(
scheme
)) {

105 
	gunsuµÜ‹d_’üy±iÚ_schemes_
.
push_back
(
scheme
);

110 
	gsuµÜ‹d_sigÇtu»_schemes_
.
»£rve
(

111 
ABSL_ARRAYSIZE
(
kSuµÜ‹dSigÇtu»Schemes
));

112 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kSuµÜ‹dSigÇtu»Schemes
); ++i) {

113 
ASSERT_TRUE
(
suµÜ‹d_sigÇtu»_schemes_


114 .
em¶aû
(
kSuµÜ‹dSigÇtu»Schemes
[
i
],

115 
kT¿n¦©edSigÇtu»Schemes
[
i
])

116 .
£cÚd
);

118 
	gi
 = 0; i < 
	gSigÇtu»Scheme_ARRAYSIZE
; ++i) {

119 ià(
SigÇtu»Scheme_IsV®id
(
i
)) {

120 
SigÇtu»Scheme
 
	gscheme
 = 
¡©ic_ÿ¡
<SigÇtu»Scheme>(
i
);

121 ià(!
	gsuµÜ‹d_sigÇtu»_schemes_
.
cÚšs
(
scheme
)) {

122 
	gunsuµÜ‹d_sigÇtu»_schemes_
.
push_back
(
scheme
);

127 
	g¶aš‹xt_
 =

128 
¡d
::
veùÜ
<
ušt8_t
>(
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
kSeü‘Mes§ge
),

129 
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gušt8_t
 *>(
	gkSeü‘Mes§ge
) +

130 (
	gkSeü‘Mes§ge
));

133 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
RSA
>> 
C»©eR§PublicKey
(
numb”_of_b™s
) {

134 
bs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

135 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
e
(
BN_Ãw
());

137 ià(
BN_£t_wÜd
(
e
.
g‘
(), 
RSA_F4
) != 1) {

138  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

140 ià(
RSA_g’”©e_key_ex
(
r§
.
g‘
(), 
numb”_of_b™s
, 
e
.get(),

141  
nuÎ±r
) != 1) {

142  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

144  
	gr§
;

147 
	gab¦
::
æ©_hash_m­
<
Asymm‘ricEnüy±iÚScheme
, 
	gušt8_t
>

148 
	gsuµÜ‹d_’üy±iÚ_schemes_
;

149 
	gab¦
::
æ©_hash_m­
<
SigÇtu»Scheme
, 
	gušt8_t
> 
	gsuµÜ‹d_sigÇtu»_schemes_
;

151 
	g¡d
::
veùÜ
<
Asymm‘ricEnüy±iÚScheme
> 
unsuµÜ‹d_’üy±iÚ_schemes_
;

152 
	g¡d
::
veùÜ
<
SigÇtu»Scheme
> 
unsuµÜ‹d_sigÇtu»_schemes_
;

154 
	g¡d
::
veùÜ
<
ušt8_t
> 
¶aš‹xt_
;

157 
TEST_F
(
PûUtTe¡
, 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™eSuµÜ‹d
) {

158 cÚ¡‡utØ&
	g·œ
 : 
suµÜ‹d_’üy±iÚ_schemes_
) {

159 
EXPECT_THAT
(
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(
·œ
.
fœ¡
),

160 
O±iÚ®
(
·œ
.
£cÚd
));

164 
TEST_F
(
PûUtTe¡
, 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™eUnsuµÜ‹d
) {

165 
Asymm‘ricEnüy±iÚScheme
 
	gscheme
 : 
unsuµÜ‹d_’üy±iÚ_schemes_
) {

166 
EXPECT_THAT
(
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(
scheme
),

167 
Eq
(
ab¦
::
nuÎİt
));

171 
TEST_F
(
PûUtTe¡
, 
SigÇtu»SchemeToPûSigÇtu»SchemeSuµÜ‹d
) {

172 cÚ¡‡utØ&
	g·œ
 : 
suµÜ‹d_sigÇtu»_schemes_
) {

173 
EXPECT_THAT
(
SigÇtu»SchemeToPûSigÇtu»Scheme
(
·œ
.
fœ¡
),

174 
O±iÚ®
(
·œ
.
£cÚd
));

178 
TEST_F
(
PûUtTe¡
, 
SigÇtu»SchemeToPûSigÇtu»SchemeUnsuµÜ‹d
) {

179 
SigÇtu»Scheme
 
	gscheme
 : 
unsuµÜ‹d_sigÇtu»_schemes_
) {

180 
EXPECT_THAT
(
SigÇtu»SchemeToPûSigÇtu»Scheme
(
scheme
), 
Eq
(
ab¦
::
nuÎİt
));

184 
TEST_F
(
PûUtTe¡
, 
P¬£R§3072PublicKeyInv®idSize
) {

185 
	g¡d
::
veùÜ
<
ušt8_t
> 
public_key
(0);

186 
ASSERT_THAT
(
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
public_key
)).
¡©us
(),

187 
StusIs
(
”rÜ
::
INVALID_ARGUMENT
));

193 
TEST_F
(
PûUtTe¡
, 
P¬£R§3072PublicKeySucûss
) {

194 
	g¡d
::
¡ršg
 
modulus
 = 
ab¦
::
HexSŒšgToBy‹s
(
kModulusBigEndŸnHex
);

195 
	g¡d
::
¡ršg
 
expÚ’t
 = 
ab¦
::
HexSŒšgToBy‹s
(
kExpÚ’tBigEndŸnHex
);

197 
	g¡d
::
veùÜ
<
ušt8_t
> 
public_key
;

198 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
modulus
.
cbegš
(), modulus.
ûnd
());

199 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
expÚ’t
.
cbegš
(),ƒxpÚ’t.
ûnd
());

201 autØ
	g»suÉ
 = 
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
public_key
));

202 
ASYLO_ASSERT_OK
(
»suÉ
.
¡©us
());

204 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
 = 
¡d
::
move
(
»suÉ
).
V®ueOrD›
();

206 
EXPECT_THAT
(
RSA_size
(
r§
.
g‘
()), 
modulus
.
size
());

208 cÚ¡ 
BIGNUM
 *
	gn
;

209 cÚ¡ 
BIGNUM
 *
	ge
;

212 
RSA_g‘0_key
(
r§
.
g‘
(), &
n
, &
e
, 
nuÎ±r
);

215 
EXPECT_EQ
(
BN_is_wÜd
(
e
, 
RSA_F4
), 1);

217 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
ex³ùed_n
(
BN_Ãw
());

218 
BN_bš2bn
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
modulus
.
d©a
()), modulus.
size
(),

219 
ex³ùed_n
.
g‘
());

222 
EXPECT_EQ
(
BN_cmp
(
n
, 
ex³ùed_n
.
g‘
()), 0);

227 
TEST_F
(
PûUtTe¡
, 
S”ŸlizeR§3072PublicKeySucûss
) {

228 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

229 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
, 
C»©eR§PublicKey
( 3072));

231 autØ
	g»suÉ
 = 
S”ŸlizeR§3072PublicKey
(
r§
.
g‘
());

232 
ASYLO_ASSERT_OK
(
»suÉ
);

233 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
 = 
¡d
::
move
(
»suÉ
).
V®ueOrD›
();

234 
ASSERT_THAT
(
£rŸlized_key
,

235 
SizeIs
(
RSA_size
(
r§
.
g‘
()è+ 
kR§3072S”ŸlizedExpÚ’tSize
));

237 cÚ¡ 
BIGNUM
 *
	gex³ùed_n
;

238 cÚ¡ 
BIGNUM
 *
	gex³ùed_e
;

241 
RSA_g‘0_key
(
r§
.
g‘
(), &
ex³ùed_n
, &
ex³ùed_e
, 
nuÎ±r
);

244 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
aùu®_n
(
BN_Ãw
());

245 
BN_bš2bn
(
£rŸlized_key
.
d©a
(), 
RSA_size
(
r§
.
g‘
()), 
aùu®_n
.get());

246 
EXPECT_EQ
(
BN_cmp
(
aùu®_n
.
g‘
(), 
ex³ùed_n
), 0);

248 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
aùu®_e
(
BN_Ãw
());

249 
BN_bš2bn
(
£rŸlized_key
.
d©a
(è+ 
RSA_size
(
r§
.
g‘
()),

250 
kR§3072S”ŸlizedExpÚ’tSize
, 
aùu®_e
.
g‘
());

251 
EXPECT_EQ
(
BN_cmp
(
aùu®_e
.
g‘
(), 
ex³ùed_e
), 0);

256 
TEST_F
(
PûUtTe¡
, 
P¬£R§3072PublicKeyRe¡ÜeFromS”ŸlizedKey
) {

257 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§1
(
RSA_Ãw
());

258 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§1
, 
C»©eR§PublicKey
( 3072));

260 autØ
	g»suÉ1
 = 
S”ŸlizeR§3072PublicKey
(
r§1
.
g‘
());

261 
ASYLO_ASSERT_OK
(
»suÉ1
);

263 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
 = 
¡d
::
move
(
»suÉ1
).
V®ueOrD›
();

265 autØ
	g»suÉ2
 = 
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
£rŸlized_key
));

266 
ASYLO_ASSERT_OK
(
»suÉ2
);

268 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§2
(
¡d
::
move
(
»suÉ2
).
V®ueOrD›
());

271 
EXPECT_THAT
(
RSA_size
(
r§2
.
g‘
()), 
Eq
(RSA_size(
r§1
.get())));

275 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
(
RSA_size
(
r§1
.
g‘
()));

276 
size_t
 
	gout_Ën
;

277 
ASSERT_EQ
(

278 
RSA_’üy±
(
r§2
.
g‘
(), &
out_Ën
, 
ch”‹xt
.
d©a
(), ch”‹xt.
size
(),

279 
¶aš‹xt_
.
d©a
(),…Ïš‹xt_.
size
(), 
RSA_PKCS1_OAEP_PADDING
),

281 << 
Bs¦La¡E¼ÜSŒšg
();

282 
	gch”‹xt
.
»size
(
out_Ën
);

284 
	g¡d
::
veùÜ
<
ušt8_t
> 
deüy±ed
(
RSA_size
(
r§2
.
g‘
()));

285 
ASSERT_EQ
(

286 
RSA_deüy±
(
r§1
.
g‘
(), &
out_Ën
, 
deüy±ed
.
d©a
(), deüy±ed.
size
(),

287 
ch”‹xt
.
d©a
(), ch”‹xt.
size
(), 
RSA_PKCS1_OAEP_PADDING
),

289 << 
Bs¦La¡E¼ÜSŒšg
();

290 
	gdeüy±ed
.
»size
(
out_Ën
);

292 
EXPECT_THAT
(
deüy±ed
, 
Eq
(
¶aš‹xt_
));

295 
TEST_F
(
PûUtTe¡
, 
C»©eR•Ütd©aFÜG‘PûInfoSucûss
) {

296 
	g¡d
::
¡ršg
 
modulus
 = 
ab¦
::
HexSŒšgToBy‹s
(
kModulusBigEndŸnHex
);

297 
	g¡d
::
¡ršg
 
expÚ’t
 = 
ab¦
::
HexSŒšgToBy‹s
(
kExpÚ’tBigEndŸnHex
);

299 
	g¡d
::
veùÜ
<
ušt8_t
> 
public_key
;

300 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
modulus
.
cbegš
(), modulus.
ûnd
());

301 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
expÚ’t
.
cbegš
(),ƒxpÚ’t.
ûnd
());

303 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
;

304 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
,

305 
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
public_key
)));

307 
R•Ütd©a
 
	g»pÜtd©a
;

308 
ASYLO_ASSERT_OK_AND_ASSIGN
(

309 
»pÜtd©a
, 
C»©eR•Ütd©aFÜG‘PûInfo
(

310 
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
, 
r§
.
g‘
()));

312 
R•Ütd©a
 
	gex³ùed_»pÜtd©a
;

313 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kEx³ùedR•Ütd©a
,

314 &
ex³ùed_»pÜtd©a
.
d©a
));

315 
EXPECT_THAT
(
»pÜtd©a
.
d©a
, 
Eq
(
ex³ùed_»pÜtd©a
.data));

318 
TEST_F
(
PûUtTe¡
,

319 
C»©eR•Ütd©aFÜG‘PûInfoInv®idAsymm‘ricEnüy±iÚSchemeFas
) {

320 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

321 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
, 
C»©eR§PublicKey
( 3072));

323 
EXPECT_THAT
(

324 
C»©eR•Ütd©aFÜG‘PûInfo
(
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
,

325 
r§
.
g‘
())

326 .
¡©us
(),

327 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

328 
ab¦
::
SŒC©
("Unsupportedƒncryption scheme: ",

329 
Asymm‘ricEnüy±iÚScheme_Name
(

330 
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
))));

333 
TEST_F
(
PûUtTe¡
, 
C»©eR•Ütd©aFÜG‘PûInfoInv®idR§ModulusSizeFas
) {

334 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

335 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
, 
C»©eR§PublicKey
( 2048));

337 
EXPECT_THAT
(

338 
C»©eR•Ütd©aFÜG‘PûInfo
(
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
,

339 
r§
.
g‘
())

340 .
¡©us
(),

341 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

342 
ab¦
::
SŒC©
("Inv®id modulu size: ", 
RSA_size
(
r§
.
g‘
()))));

	@identity/sgx/pce_util_test.cc

19 
	~"asylo/id’t™y/sgx/pû_ut.h
"

21 
	~<İ’s¦/ba£.h
>

22 
	~<İ’s¦/bn.h
>

23 
	~<İ’s¦/r§.h
>

25 
	~<c¡dšt
>

26 
	~<ut™y
>

27 
	~<veùÜ
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/ba£/maüos.h
"

32 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

33 
	~"ab¦/¡ršgs/esÿpšg.h
"

34 
	~"ab¦/ty³s/İtiÚ®.h
"

35 
	~"asylo/üy±o/®gÜ™hms.pb.h
"

36 
	~"asylo/üy±o/ut/bs¦_ut.h
"

37 
	~"asylo/üy±o/ut/by‹s.h
"

38 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

39 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

40 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

41 
	~"asylo/ut/¡©us_maüos.h
"

42 
	~"QuÙeG’”©iÚ/psw/pû_w¿µ”/šc/sgx_pû.h
"

44 
Çme¥aû
 
	gasylo
 {

45 
Çme¥aû
 
	gsgx
 {

46 
	gÇme¥aû
 {

48 
cÚ¡ex´
 
	gkSeü‘Mes§ge
[] = "secret message";

51 
cÚ¡ex´
 
	gkExpÚ’tBigEndŸnHex
[] = "00010001";

54 
cÚ¡ex´
 
	gkModulusBigEndŸnHex
[] =

67 
cÚ¡ex´
 
	gkEx³ùedR•Ütd©a
[] =

71 
	gusšg
 ::
‹¡šg
::
Eq
;

72 
	gusšg
 ::
‹¡šg
::
O±iÚ®
;

73 
	gusšg
 ::
‹¡šg
::
SizeIs
;

76 
cÚ¡ex´
 
Asymm‘ricEnüy±iÚScheme
 
	gkSuµÜ‹dEnüy±iÚSchemes
[] = {

77 
RSA3072_OAEP
};

80 
cÚ¡ex´
 
ušt8_t
 
	gkT¿n¦©edEnüy±iÚSchemes
[] = {
PCE_ALG_RSA_OAEP_3072
};

83 
cÚ¡ex´
 
SigÇtu»Scheme
 
	gkSuµÜ‹dSigÇtu»Schemes
[] = {
ECDSA_P256_SHA256
};

87 
cÚ¡ex´
 
ušt8_t
 
	gkT¿n¦©edSigÇtu»Schemes
[] = {
PCE_NIST_P256_ECDSA_SHA256
};

89 şas 
	cPûUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

90 
public
:

91 
S‘Up
(è
ov”ride
 {

92 
suµÜ‹d_’üy±iÚ_schemes_
.
»£rve
(

93 
ABSL_ARRAYSIZE
(
kSuµÜ‹dEnüy±iÚSchemes
));

94 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kSuµÜ‹dEnüy±iÚSchemes
); ++i) {

95 
ASSERT_TRUE
(
suµÜ‹d_’üy±iÚ_schemes_


96 .
em¶aû
(
kSuµÜ‹dEnüy±iÚSchemes
[
i
],

97 
kT¿n¦©edEnüy±iÚSchemes
[
i
])

98 .
£cÚd
);

100 
	gi
 = 0; i < 
	gAsymm‘ricEnüy±iÚScheme_ARRAYSIZE
; ++i) {

101 ià(
Asymm‘ricEnüy±iÚScheme_IsV®id
(
i
)) {

102 
Asymm‘ricEnüy±iÚScheme
 
	gscheme
 =

103 
¡©ic_ÿ¡
<
Asymm‘ricEnüy±iÚScheme
>(
i
);

104 ià(!
	gsuµÜ‹d_’üy±iÚ_schemes_
.
cÚšs
(
scheme
)) {

105 
	gunsuµÜ‹d_’üy±iÚ_schemes_
.
push_back
(
scheme
);

110 
	gsuµÜ‹d_sigÇtu»_schemes_
.
»£rve
(

111 
ABSL_ARRAYSIZE
(
kSuµÜ‹dSigÇtu»Schemes
));

112 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kSuµÜ‹dSigÇtu»Schemes
); ++i) {

113 
ASSERT_TRUE
(
suµÜ‹d_sigÇtu»_schemes_


114 .
em¶aû
(
kSuµÜ‹dSigÇtu»Schemes
[
i
],

115 
kT¿n¦©edSigÇtu»Schemes
[
i
])

116 .
£cÚd
);

118 
	gi
 = 0; i < 
	gSigÇtu»Scheme_ARRAYSIZE
; ++i) {

119 ià(
SigÇtu»Scheme_IsV®id
(
i
)) {

120 
SigÇtu»Scheme
 
	gscheme
 = 
¡©ic_ÿ¡
<SigÇtu»Scheme>(
i
);

121 ià(!
	gsuµÜ‹d_sigÇtu»_schemes_
.
cÚšs
(
scheme
)) {

122 
	gunsuµÜ‹d_sigÇtu»_schemes_
.
push_back
(
scheme
);

127 
	g¶aš‹xt_
 =

128 
¡d
::
veùÜ
<
ušt8_t
>(
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
kSeü‘Mes§ge
),

129 
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gušt8_t
 *>(
	gkSeü‘Mes§ge
) +

130 (
	gkSeü‘Mes§ge
));

133 
	gStusOr
<
	gbs¦
::
UniquePŒ
<
RSA
>> 
C»©eR§PublicKey
(
numb”_of_b™s
) {

134 
bs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

135 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
e
(
BN_Ãw
());

137 ià(
BN_£t_wÜd
(
e
.
g‘
(), 
RSA_F4
) != 1) {

138  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

140 ià(
RSA_g’”©e_key_ex
(
r§
.
g‘
(), 
numb”_of_b™s
, 
e
.get(),

141  
nuÎ±r
) != 1) {

142  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
Bs¦La¡E¼ÜSŒšg
());

144  
	gr§
;

147 
	gab¦
::
æ©_hash_m­
<
Asymm‘ricEnüy±iÚScheme
, 
	gušt8_t
>

148 
	gsuµÜ‹d_’üy±iÚ_schemes_
;

149 
	gab¦
::
æ©_hash_m­
<
SigÇtu»Scheme
, 
	gušt8_t
> 
	gsuµÜ‹d_sigÇtu»_schemes_
;

151 
	g¡d
::
veùÜ
<
Asymm‘ricEnüy±iÚScheme
> 
unsuµÜ‹d_’üy±iÚ_schemes_
;

152 
	g¡d
::
veùÜ
<
SigÇtu»Scheme
> 
unsuµÜ‹d_sigÇtu»_schemes_
;

154 
	g¡d
::
veùÜ
<
ušt8_t
> 
¶aš‹xt_
;

157 
TEST_F
(
PûUtTe¡
, 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™eSuµÜ‹d
) {

158 cÚ¡‡utØ&
	g·œ
 : 
suµÜ‹d_’üy±iÚ_schemes_
) {

159 
EXPECT_THAT
(
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(
·œ
.
fœ¡
),

160 
O±iÚ®
(
·œ
.
£cÚd
));

164 
TEST_F
(
PûUtTe¡
, 
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™eUnsuµÜ‹d
) {

165 
Asymm‘ricEnüy±iÚScheme
 
	gscheme
 : 
unsuµÜ‹d_’üy±iÚ_schemes_
) {

166 
EXPECT_THAT
(
Asymm‘ricEnüy±iÚSchemeToPûCry±oSu™e
(
scheme
),

167 
Eq
(
ab¦
::
nuÎİt
));

171 
TEST_F
(
PûUtTe¡
, 
SigÇtu»SchemeToPûSigÇtu»SchemeSuµÜ‹d
) {

172 cÚ¡‡utØ&
	g·œ
 : 
suµÜ‹d_sigÇtu»_schemes_
) {

173 
EXPECT_THAT
(
SigÇtu»SchemeToPûSigÇtu»Scheme
(
·œ
.
fœ¡
),

174 
O±iÚ®
(
·œ
.
£cÚd
));

178 
TEST_F
(
PûUtTe¡
, 
SigÇtu»SchemeToPûSigÇtu»SchemeUnsuµÜ‹d
) {

179 
SigÇtu»Scheme
 
	gscheme
 : 
unsuµÜ‹d_sigÇtu»_schemes_
) {

180 
EXPECT_THAT
(
SigÇtu»SchemeToPûSigÇtu»Scheme
(
scheme
), 
Eq
(
ab¦
::
nuÎİt
));

184 
TEST_F
(
PûUtTe¡
, 
P¬£R§3072PublicKeyInv®idSize
) {

185 
	g¡d
::
veùÜ
<
ušt8_t
> 
public_key
(0);

186 
ASSERT_THAT
(
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
public_key
)).
¡©us
(),

187 
StusIs
(
”rÜ
::
INVALID_ARGUMENT
));

193 
TEST_F
(
PûUtTe¡
, 
P¬£R§3072PublicKeySucûss
) {

194 
	g¡d
::
¡ršg
 
modulus
 = 
ab¦
::
HexSŒšgToBy‹s
(
kModulusBigEndŸnHex
);

195 
	g¡d
::
¡ršg
 
expÚ’t
 = 
ab¦
::
HexSŒšgToBy‹s
(
kExpÚ’tBigEndŸnHex
);

197 
	g¡d
::
veùÜ
<
ušt8_t
> 
public_key
;

198 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
modulus
.
cbegš
(), modulus.
ûnd
());

199 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
expÚ’t
.
cbegš
(),ƒxpÚ’t.
ûnd
());

201 autØ
	g»suÉ
 = 
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
public_key
));

202 
ASYLO_ASSERT_OK
(
»suÉ
.
¡©us
());

204 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
 = 
¡d
::
move
(
»suÉ
).
V®ueOrD›
();

206 
EXPECT_THAT
(
RSA_size
(
r§
.
g‘
()), 
modulus
.
size
());

208 cÚ¡ 
BIGNUM
 *
	gn
;

209 cÚ¡ 
BIGNUM
 *
	ge
;

212 
RSA_g‘0_key
(
r§
.
g‘
(), &
n
, &
e
, 
nuÎ±r
);

215 
EXPECT_EQ
(
BN_is_wÜd
(
e
, 
RSA_F4
), 1);

217 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
ex³ùed_n
(
BN_Ãw
());

218 
BN_bš2bn
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
modulus
.
d©a
()), modulus.
size
(),

219 
ex³ùed_n
.
g‘
());

222 
EXPECT_EQ
(
BN_cmp
(
n
, 
ex³ùed_n
.
g‘
()), 0);

227 
TEST_F
(
PûUtTe¡
, 
S”ŸlizeR§3072PublicKeySucûss
) {

228 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

229 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
, 
C»©eR§PublicKey
( 3072));

231 autØ
	g»suÉ
 = 
S”ŸlizeR§3072PublicKey
(
r§
.
g‘
());

232 
ASYLO_ASSERT_OK
(
»suÉ
);

233 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
 = 
¡d
::
move
(
»suÉ
).
V®ueOrD›
();

234 
ASSERT_THAT
(
£rŸlized_key
,

235 
SizeIs
(
RSA_size
(
r§
.
g‘
()è+ 
kR§3072S”ŸlizedExpÚ’tSize
));

237 cÚ¡ 
BIGNUM
 *
	gex³ùed_n
;

238 cÚ¡ 
BIGNUM
 *
	gex³ùed_e
;

241 
RSA_g‘0_key
(
r§
.
g‘
(), &
ex³ùed_n
, &
ex³ùed_e
, 
nuÎ±r
);

244 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
aùu®_n
(
BN_Ãw
());

245 
BN_bš2bn
(
£rŸlized_key
.
d©a
(), 
RSA_size
(
r§
.
g‘
()), 
aùu®_n
.get());

246 
EXPECT_EQ
(
BN_cmp
(
aùu®_n
.
g‘
(), 
ex³ùed_n
), 0);

248 
	gbs¦
::
UniquePŒ
<
BIGNUM
> 
aùu®_e
(
BN_Ãw
());

249 
BN_bš2bn
(
£rŸlized_key
.
d©a
(è+ 
RSA_size
(
r§
.
g‘
()),

250 
kR§3072S”ŸlizedExpÚ’tSize
, 
aùu®_e
.
g‘
());

251 
EXPECT_EQ
(
BN_cmp
(
aùu®_e
.
g‘
(), 
ex³ùed_e
), 0);

256 
TEST_F
(
PûUtTe¡
, 
P¬£R§3072PublicKeyRe¡ÜeFromS”ŸlizedKey
) {

257 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§1
(
RSA_Ãw
());

258 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§1
, 
C»©eR§PublicKey
( 3072));

260 autØ
	g»suÉ1
 = 
S”ŸlizeR§3072PublicKey
(
r§1
.
g‘
());

261 
ASYLO_ASSERT_OK
(
»suÉ1
);

263 
	g¡d
::
veùÜ
<
ušt8_t
> 
£rŸlized_key
 = 
¡d
::
move
(
»suÉ1
).
V®ueOrD›
();

265 autØ
	g»suÉ2
 = 
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
£rŸlized_key
));

266 
ASYLO_ASSERT_OK
(
»suÉ2
);

268 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§2
(
¡d
::
move
(
»suÉ2
).
V®ueOrD›
());

271 
EXPECT_THAT
(
RSA_size
(
r§2
.
g‘
()), 
Eq
(RSA_size(
r§1
.get())));

275 
	g¡d
::
veùÜ
<
ušt8_t
> 
ch”‹xt
(
RSA_size
(
r§1
.
g‘
()));

276 
size_t
 
	gout_Ën
;

277 
ASSERT_EQ
(

278 
RSA_’üy±
(
r§2
.
g‘
(), &
out_Ën
, 
ch”‹xt
.
d©a
(), ch”‹xt.
size
(),

279 
¶aš‹xt_
.
d©a
(),…Ïš‹xt_.
size
(), 
RSA_PKCS1_OAEP_PADDING
),

281 << 
Bs¦La¡E¼ÜSŒšg
();

282 
	gch”‹xt
.
»size
(
out_Ën
);

284 
	g¡d
::
veùÜ
<
ušt8_t
> 
deüy±ed
(
RSA_size
(
r§2
.
g‘
()));

285 
ASSERT_EQ
(

286 
RSA_deüy±
(
r§1
.
g‘
(), &
out_Ën
, 
deüy±ed
.
d©a
(), deüy±ed.
size
(),

287 
ch”‹xt
.
d©a
(), ch”‹xt.
size
(), 
RSA_PKCS1_OAEP_PADDING
),

289 << 
Bs¦La¡E¼ÜSŒšg
();

290 
	gdeüy±ed
.
»size
(
out_Ën
);

292 
EXPECT_THAT
(
deüy±ed
, 
Eq
(
¶aš‹xt_
));

295 
TEST_F
(
PûUtTe¡
, 
C»©eR•Ütd©aFÜG‘PûInfoSucûss
) {

296 
	g¡d
::
¡ršg
 
modulus
 = 
ab¦
::
HexSŒšgToBy‹s
(
kModulusBigEndŸnHex
);

297 
	g¡d
::
¡ršg
 
expÚ’t
 = 
ab¦
::
HexSŒšgToBy‹s
(
kExpÚ’tBigEndŸnHex
);

299 
	g¡d
::
veùÜ
<
ušt8_t
> 
public_key
;

300 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
modulus
.
cbegš
(), modulus.
ûnd
());

301 
	gpublic_key
.
š£¹
(
public_key
.
’d
(), 
expÚ’t
.
cbegš
(),ƒxpÚ’t.
ûnd
());

303 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
;

304 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
,

305 
P¬£R§3072PublicKey
(
ab¦
::
MakeS·n
(
public_key
)));

307 
R•Ütd©a
 
	g»pÜtd©a
;

308 
ASYLO_ASSERT_OK_AND_ASSIGN
(

309 
»pÜtd©a
, 
C»©eR•Ütd©aFÜG‘PûInfo
(

310 
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
, 
r§
.
g‘
()));

312 
R•Ütd©a
 
	gex³ùed_»pÜtd©a
;

313 
ASYLO_ASSERT_OK
(
S‘TrivŸlObjeùFromHexSŒšg
(
kEx³ùedR•Ütd©a
,

314 &
ex³ùed_»pÜtd©a
.
d©a
));

315 
EXPECT_THAT
(
»pÜtd©a
.
d©a
, 
Eq
(
ex³ùed_»pÜtd©a
.data));

318 
TEST_F
(
PûUtTe¡
,

319 
C»©eR•Ütd©aFÜG‘PûInfoInv®idAsymm‘ricEnüy±iÚSchemeFas
) {

320 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

321 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
, 
C»©eR§PublicKey
( 3072));

323 
EXPECT_THAT
(

324 
C»©eR•Ütd©aFÜG‘PûInfo
(
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
,

325 
r§
.
g‘
())

326 .
¡©us
(),

327 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

328 
ab¦
::
SŒC©
("Unsupportedƒncryption scheme: ",

329 
Asymm‘ricEnüy±iÚScheme_Name
(

330 
Asymm‘ricEnüy±iÚScheme
::
RSA2048_OAEP
))));

333 
TEST_F
(
PûUtTe¡
, 
C»©eR•Ütd©aFÜG‘PûInfoInv®idR§ModulusSizeFas
) {

334 
	gbs¦
::
UniquePŒ
<
RSA
> 
r§
(
RSA_Ãw
());

335 
ASYLO_ASSERT_OK_AND_ASSIGN
(
r§
, 
C»©eR§PublicKey
( 2048));

337 
EXPECT_THAT
(

338 
C»©eR•Ütd©aFÜG‘PûInfo
(
Asymm‘ricEnüy±iÚScheme
::
RSA3072_OAEP
,

339 
r§
.
g‘
())

340 .
¡©us
(),

341 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

342 
ab¦
::
SŒC©
("Inv®id modulu size: ", 
RSA_size
(
r§
.
g‘
()))));

	@identity/sgx/platform_provisioning.cc

19 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

21 
	~<lim™s
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

29 cÚ¡ 
ušt32_t
 
	gkPûSvnMaxV®ue
 = 
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
();

31 cÚ¡ 
ušt32_t
 
	gkPûIdMaxV®ue
 = 
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
();

33 
Stus
 
V®id©ePpid
(cÚ¡ 
Ppid
 &
µid
) {

34 ià(!
	gµid
.
has_v®ue
()) {

35  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

39 ià(
	gµid
.
v®ue
().
size
(è!ğ
kPpidSize
) {

40  
Stus
(

41 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 
ab¦
::
SŒC©
(

44 
kPpidSize
, " bytes)"));

47  
	gStus
::
OkStus
();

50 
Stus
 
V®id©eCpuSvn
(cÚ¡ 
CpuSvn
 &
ıu_svn
) {

51 ià(!
	gıu_svn
.
has_v®ue
()) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

56 ià(
	gıu_svn
.
v®ue
().
size
(è!ğ
kCpusvnSize
) {

57  
Stus
(

58 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

59 
ab¦
::
SŒC©
(

61 
kCpusvnSize
, " bytes)"));

64  
	gStus
::
OkStus
();

67 
Stus
 
V®id©ePûSvn
(cÚ¡ 
PûSvn
 &
pû_svn
) {

68 ià(!
	gpû_svn
.
has_v®ue
()) {

69  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 ià(
	gpû_svn
.
v®ue
(è> 
	gkPûSvnMaxV®ue
) {

74  
Stus
(

75 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 
ab¦
::
SŒC©
(

78 
kPûSvnMaxV®ue
, ")"));

81  
	gStus
::
OkStus
();

84 
Stus
 
V®id©ePûId
(cÚ¡ 
PûId
 &
pû_id
) {

85 ià(!
	gpû_id
.
has_v®ue
()) {

86  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

90 ià(
	gpû_id
.
v®ue
(è> 
	gkPûIdMaxV®ue
) {

91  
Stus
(

92 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

93 
ab¦
::
SŒC©
("PceId's \"value\" field isoo†arge (must be†esshan ",

94 
kPûIdMaxV®ue
, ")"));

97  
	gStus
::
OkStus
();

100 
Stus
 
V®id©eFm¥c
(cÚ¡ 
Fm¥c
 &
fm¥c
) {

101 ià(!
	gfm¥c
.
has_v®ue
()) {

102  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

106 ià(
	gfm¥c
.
v®ue
().
size
(è!ğ
kFm¥cSize
) {

107  
Stus
(

108 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
ab¦
::
SŒC©
("Fmspc's \"value\" has‡n invalid size (must beƒxactly ",

110 
kFm¥cSize
, " bytes)"));

113  
	gStus
::
OkStus
();

116 
Stus
 
V®id©eR•ÜtPrÙo
(cÚ¡ 
R•ÜtPrÙo
 &
»pÜt_´Ùo
) {

117  
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
();

120 
Stus
 
V®id©eT¬g‘InfoPrÙo
(cÚ¡ 
T¬g‘InfoPrÙo
 &
rg‘_šfo_´Ùo
) {

121  
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
();

124 
	gStusOr
<
	gR•Üt
> 
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(

125 cÚ¡ 
R•ÜtPrÙo
 &
»pÜt_´Ùo
) {

126 ià(!
	g»pÜt_´Ùo
.
has_v®ue
()) {

127  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

131 
R•Üt
 
	g»pÜt
;

132 
ASYLO_RETURN_IF_ERROR
(

133 
S‘TrivŸlObjeùFromBš¬ySŒšg
<
R•Üt
>(
»pÜt_´Ùo
.
v®ue
(), &
»pÜt
));

134  
	g»pÜt
;

137 
	gStusOr
<
	gT¬g‘šfo
> 
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(

138 cÚ¡ 
T¬g‘InfoPrÙo
 &
rg‘_šfo_´Ùo
) {

139 ià(!
	grg‘_šfo_´Ùo
.
has_v®ue
()) {

140  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

144 
T¬g‘šfo
 
	grg‘šfo
;

145 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
T¬g‘šfo
>(

146 
rg‘_šfo_´Ùo
.
v®ue
(), &
rg‘šfo
));

147  
	grg‘šfo
;

	@identity/sgx/platform_provisioning.cc

19 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

21 
	~<lim™s
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

29 cÚ¡ 
ušt32_t
 
	gkPûSvnMaxV®ue
 = 
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
();

31 cÚ¡ 
ušt32_t
 
	gkPûIdMaxV®ue
 = 
¡d
::
num”ic_lim™s
<
ušt16_t
>::
max
();

33 
Stus
 
V®id©ePpid
(cÚ¡ 
Ppid
 &
µid
) {

34 ià(!
	gµid
.
has_v®ue
()) {

35  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

39 ià(
	gµid
.
v®ue
().
size
(è!ğ
kPpidSize
) {

40  
Stus
(

41 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 
ab¦
::
SŒC©
(

44 
kPpidSize
, " bytes)"));

47  
	gStus
::
OkStus
();

50 
Stus
 
V®id©eCpuSvn
(cÚ¡ 
CpuSvn
 &
ıu_svn
) {

51 ià(!
	gıu_svn
.
has_v®ue
()) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

56 ià(
	gıu_svn
.
v®ue
().
size
(è!ğ
kCpusvnSize
) {

57  
Stus
(

58 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

59 
ab¦
::
SŒC©
(

61 
kCpusvnSize
, " bytes)"));

64  
	gStus
::
OkStus
();

67 
Stus
 
V®id©ePûSvn
(cÚ¡ 
PûSvn
 &
pû_svn
) {

68 ià(!
	gpû_svn
.
has_v®ue
()) {

69  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 ià(
	gpû_svn
.
v®ue
(è> 
	gkPûSvnMaxV®ue
) {

74  
Stus
(

75 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 
ab¦
::
SŒC©
(

78 
kPûSvnMaxV®ue
, ")"));

81  
	gStus
::
OkStus
();

84 
Stus
 
V®id©ePûId
(cÚ¡ 
PûId
 &
pû_id
) {

85 ià(!
	gpû_id
.
has_v®ue
()) {

86  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

90 ià(
	gpû_id
.
v®ue
(è> 
	gkPûIdMaxV®ue
) {

91  
Stus
(

92 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

93 
ab¦
::
SŒC©
("PceId's \"value\" field isoo†arge (must be†esshan ",

94 
kPûIdMaxV®ue
, ")"));

97  
	gStus
::
OkStus
();

100 
Stus
 
V®id©eFm¥c
(cÚ¡ 
Fm¥c
 &
fm¥c
) {

101 ià(!
	gfm¥c
.
has_v®ue
()) {

102  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

106 ià(
	gfm¥c
.
v®ue
().
size
(è!ğ
kFm¥cSize
) {

107  
Stus
(

108 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

109 
ab¦
::
SŒC©
("Fmspc's \"value\" has‡n invalid size (must beƒxactly ",

110 
kFm¥cSize
, " bytes)"));

113  
	gStus
::
OkStus
();

116 
Stus
 
V®id©eR•ÜtPrÙo
(cÚ¡ 
R•ÜtPrÙo
 &
»pÜt_´Ùo
) {

117  
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
();

120 
Stus
 
V®id©eT¬g‘InfoPrÙo
(cÚ¡ 
T¬g‘InfoPrÙo
 &
rg‘_šfo_´Ùo
) {

121  
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
();

124 
	gStusOr
<
	gR•Üt
> 
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(

125 cÚ¡ 
R•ÜtPrÙo
 &
»pÜt_´Ùo
) {

126 ià(!
	g»pÜt_´Ùo
.
has_v®ue
()) {

127  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

131 
R•Üt
 
	g»pÜt
;

132 
ASYLO_RETURN_IF_ERROR
(

133 
S‘TrivŸlObjeùFromBš¬ySŒšg
<
R•Üt
>(
»pÜt_´Ùo
.
v®ue
(), &
»pÜt
));

134  
	g»pÜt
;

137 
	gStusOr
<
	gT¬g‘šfo
> 
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(

138 cÚ¡ 
T¬g‘InfoPrÙo
 &
rg‘_šfo_´Ùo
) {

139 ià(!
	grg‘_šfo_´Ùo
.
has_v®ue
()) {

140  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

144 
T¬g‘šfo
 
	grg‘šfo
;

145 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
T¬g‘šfo
>(

146 
rg‘_šfo_´Ùo
.
v®ue
(), &
rg‘šfo
));

147  
	grg‘šfo
;

	@identity/sgx/platform_provisioning.h

19 #iâdeà
ASYLO_IDENTITY_SGX_PLATFORM_PROVISIONING_H_


20 
	#ASYLO_IDENTITY_SGX_PLATFORM_PROVISIONING_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

25 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

33 cÚ¡ 
ušt32_t
 
kPûSvnMaxV®ue
;

36 cÚ¡ 
ušt32_t
 
kPûIdMaxV®ue
;

40 
Stus
 
V®id©ePpid
(cÚ¡ 
Ppid
 &
µid
);

44 
Stus
 
V®id©eCpuSvn
(cÚ¡ 
CpuSvn
 &
ıu_svn
);

48 
Stus
 
V®id©ePûSvn
(cÚ¡ 
PûSvn
 &
pû_svn
);

52 
Stus
 
V®id©ePûId
(cÚ¡ 
PûId
 &
pû_id
);

56 
Stus
 
V®id©eFm¥c
(cÚ¡ 
Fm¥c
 &
fm¥c
);

60 
Stus
 
V®id©eR•ÜtPrÙo
(cÚ¡ 
R•ÜtPrÙo
 &
»pÜt_´Ùo
);

64 
Stus
 
V®id©eT¬g‘InfoPrÙo
(cÚ¡ 
T¬g‘InfoPrÙo
 &
rg‘_šfo_´Ùo
);

68 
	gStusOr
<
	gR•Üt
> 
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(

69 cÚ¡ 
R•ÜtPrÙo
 &
»pÜt_´Ùo
);

73 
	gStusOr
<
	gT¬g‘šfo
> 
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(

74 cÚ¡ 
T¬g‘InfoPrÙo
 &
rg‘_šfo_´Ùo
);

	@identity/sgx/platform_provisioning_test.cc

19 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

24 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

25 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
Eq
;

35 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
PpidW™houtV®ueF›ldIsInv®id
) {

36 
EXPECT_THAT
(
V®id©ePpid
(
Ppid
()),

37 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

40 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
PpidW™hV®ueF›ldOfBadL’gthIsInv®id
) {

41 
Ppid
 
	gµid
;

42 *
	gµid
.
mubË_v®ue
() = "short";

43 
EXPECT_THAT
(
V®id©ePpid
(
µid
),

44 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

46 *
	gµid
.
mubË_v®ue
() = "waaaaaaaaaaaaaaaaaaaaaaaaaaytoolong";

47 
EXPECT_THAT
(
V®id©ePpid
(
µid
),

48 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

51 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
V®idPpidIsV®id
) {

52 
Ppid
 
	gµid
;

53 *
	gµid
.
mubË_v®ue
() = "0123456789abcdef";

54 
ASYLO_EXPECT_OK
(
V®id©ePpid
(
µid
));

57 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
CpuSvnW™houtV®ueF›ldIsInv®id
) {

58 
EXPECT_THAT
(
V®id©eCpuSvn
(
CpuSvn
()),

59 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

62 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
CpuSvnW™hV®ueF›ldOfBadL’gthIsInv®id
) {

63 
CpuSvn
 
	gıu_svn
;

64 *
	gıu_svn
.
mubË_v®ue
() = "short";

65 
EXPECT_THAT
(
V®id©eCpuSvn
(
ıu_svn
),

66 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

68 *
	gıu_svn
.
mubË_v®ue
() = "waaaaaaaaaaaaaaaaaaaaaaaaaaytoolong";

69 
EXPECT_THAT
(
V®id©eCpuSvn
(
ıu_svn
),

70 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

73 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
V®idCpuSvnIsV®id
) {

74 
CpuSvn
 
	gıu_svn
;

75 *
	gıu_svn
.
mubË_v®ue
() = "0123456789abcdef";

76 
ASYLO_EXPECT_OK
(
V®id©eCpuSvn
(
ıu_svn
));

79 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûSvnW™houtV®ueF›ldIsInv®id
) {

80 
EXPECT_THAT
(
V®id©ePûSvn
(
PûSvn
()),

81 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

84 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûSvnW™hTooL¬geV®ueF›ldIsInv®id
) {

85 
PûSvn
 
	gpû_svn
;

86 
	gpû_svn
.
£t_v®ue
(100000);

87 
EXPECT_THAT
(
V®id©ePûSvn
(
pû_svn
),

88 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

91 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idPûSvnIsV®id
) {

92 
PûSvn
 
	gpû_svn
;

93 
	gpû_svn
.
£t_v®ue
(10000);

94 
ASYLO_EXPECT_OK
(
V®id©ePûSvn
(
pû_svn
));

97 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûIdW™houtV®ueF›ldIsInv®id
) {

98 
EXPECT_THAT
(
V®id©ePûId
(
PûId
()),

99 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

102 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûIdW™hTooL¬geV®ueF›ldIsInv®id
) {

103 
PûId
 
	gpû_id
;

104 
	gpû_id
.
£t_v®ue
(100000);

105 
EXPECT_THAT
(
V®id©ePûId
(
pû_id
),

106 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

109 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idPûIdIsV®id
) {

110 
PûId
 
	gpû_id
;

111 
	gpû_id
.
£t_v®ue
(10000);

112 
ASYLO_EXPECT_OK
(
V®id©ePûId
(
pû_id
));

115 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
Fm¥cW™houtV®ueF›ldIsInv®id
) {

116 
EXPECT_THAT
(
V®id©eFm¥c
(
Fm¥c
()),

117 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

120 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
Fm¥cW™hV®ueF›ldOfBadL’gthIsInv®id
) {

121 
Fm¥c
 
	gfm¥c
;

122 
	gfm¥c
.
£t_v®ue
("short");

123 
EXPECT_THAT
(
V®id©eFm¥c
(
fm¥c
),

124 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

126 
	gfm¥c
.
£t_v®ue
("toolong");

127 
EXPECT_THAT
(
V®id©eFm¥c
(
fm¥c
),

128 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

131 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idFm¥cIsV®id
) {

132 
Fm¥c
 
	gfm¥c
;

133 
	gfm¥c
.
£t_v®ue
("000000");

134 
ASYLO_EXPECT_OK
(
V®id©eFm¥c
(
fm¥c
));

137 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
R•ÜtPrÙoW™houtV®ueF›ldIsInv®id
) {

138 
R•ÜtPrÙo
 
	g»pÜt_´Ùo
;

139 
EXPECT_THAT
(
V®id©eR•ÜtPrÙo
(
»pÜt_´Ùo
),

140 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

141 
EXPECT_THAT
(
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
(),

142 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

145 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
R•ÜtPrÙoW™hV®ueF›ldOfBadL’gthIsInv®id
) {

146 
R•ÜtPrÙo
 
	g»pÜt_´Ùo
;

147 
	g»pÜt_´Ùo
.
£t_v®ue
("short");

148 
EXPECT_THAT
(
V®id©eR•ÜtPrÙo
(
»pÜt_´Ùo
),

149 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

150 
EXPECT_THAT
(
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
(),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

153 
R•Üt
 
	g»pÜt
 = 
TrivŸlRªdomObjeù
<Report>();

154 
	g¡d
::
¡ršg
 
»pÜt_bš
 = 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
»pÜt
);

156 
	g»pÜt_bš
.
push_back
('a');

157 
	g»pÜt_´Ùo
.
£t_v®ue
(
»pÜt_bš
);

158 
EXPECT_THAT
(
V®id©eR•ÜtPrÙo
(
»pÜt_´Ùo
),

159 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

160 
EXPECT_THAT
(
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
(),

161 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

164 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
T¬g‘InfoPrÙoW™houtV®ueF›ldIsInv®id
) {

165 
T¬g‘InfoPrÙo
 
	grg‘_šfo_´Ùo
;

166 
EXPECT_THAT
(
V®id©eT¬g‘InfoPrÙo
(
rg‘_šfo_´Ùo
),

167 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

168 
EXPECT_THAT
(
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
(),

169 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

172 
TEST
(
PÏtfÜmProvisiÚšgTe¡
,

173 
T¬g‘InfoPrÙoW™hV®ueF›ldOfBadL’gthIsInv®id
) {

174 
T¬g‘InfoPrÙo
 
	grg‘_šfo_´Ùo
;

175 
	grg‘_šfo_´Ùo
.
£t_v®ue
("short");

176 
EXPECT_THAT
(
V®id©eT¬g‘InfoPrÙo
(
rg‘_šfo_´Ùo
),

177 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

178 
EXPECT_THAT
(
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
(),

179 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

181 
T¬g‘šfo
 
	grg‘šfo
 = 
TrivŸlRªdomObjeù
<Targetinfo>();

182 
	g¡d
::
¡ršg
 
rg‘šfo_bš
 = 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
rg‘šfo
);

184 
	grg‘šfo_bš
.
push_back
('a');

185 
	grg‘_šfo_´Ùo
.
£t_v®ue
(
rg‘šfo_bš
);

186 
EXPECT_THAT
(
V®id©eT¬g‘InfoPrÙo
(
rg‘_šfo_´Ùo
),

187 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

188 
EXPECT_THAT
(
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
(),

189 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

192 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idR•ÜtCªBeCÚv”‹dToH¬dw¬eR•Üt
) {

193 
R•Üt
 
	gex³ùed
 = 
TrivŸlRªdomObjeù
<Report>();

195 
R•ÜtPrÙo
 
	g»pÜt_´Ùo
;

196 
	g»pÜt_´Ùo
.
£t_v®ue
(
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
ex³ùed
));

198 autØ
	g»pÜt_»suÉ
 = 
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
);

199 
ASYLO_ASSERT_OK
(
»pÜt_»suÉ
);

201 
	g¡d
::
¡ršg
 
ex³ùed_hex
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
<
R•Üt
>(
ex³ùed
);

202 
	g¡d
::
¡ršg
 
aùu®_hex
 =

203 
CÚv”tTrivŸlObjeùToHexSŒšg
(
»pÜt_»suÉ
.
V®ueOrD›
());

204 
EXPECT_THAT
(
aùu®_hex
, 
Eq
(
ex³ùed_hex
));

207 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idT¬g‘InfoPrÙoCªBeCÚv”‹dToT¬g‘šfo
) {

208 
T¬g‘šfo
 
	gex³ùed
 = 
TrivŸlRªdomObjeù
<Targetinfo>();

210 
T¬g‘InfoPrÙo
 
	grg‘_šfo_´Ùo
;

211 
	grg‘_šfo_´Ùo
.
£t_v®ue
(
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
ex³ùed
));

213 autØ
	grg‘šfo_»suÉ
 =

214 
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
);

215 
ASYLO_ASSERT_OK
(
rg‘šfo_»suÉ
);

217 
	g¡d
::
¡ršg
 
ex³ùed_hex
 =

218 
CÚv”tTrivŸlObjeùToHexSŒšg
<
T¬g‘šfo
>(
ex³ùed
);

219 
	g¡d
::
¡ršg
 
aùu®_hex
 =

220 
CÚv”tTrivŸlObjeùToHexSŒšg
(
rg‘šfo_»suÉ
.
V®ueOrD›
());

221 
EXPECT_THAT
(
aùu®_hex
, 
Eq
(
ex³ùed_hex
));

	@identity/sgx/platform_provisioning_test.cc

19 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

24 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

25 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
Eq
;

35 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
PpidW™houtV®ueF›ldIsInv®id
) {

36 
EXPECT_THAT
(
V®id©ePpid
(
Ppid
()),

37 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

40 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
PpidW™hV®ueF›ldOfBadL’gthIsInv®id
) {

41 
Ppid
 
	gµid
;

42 *
	gµid
.
mubË_v®ue
() = "short";

43 
EXPECT_THAT
(
V®id©ePpid
(
µid
),

44 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

46 *
	gµid
.
mubË_v®ue
() = "waaaaaaaaaaaaaaaaaaaaaaaaaaytoolong";

47 
EXPECT_THAT
(
V®id©ePpid
(
µid
),

48 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

51 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
V®idPpidIsV®id
) {

52 
Ppid
 
	gµid
;

53 *
	gµid
.
mubË_v®ue
() = "0123456789abcdef";

54 
ASYLO_EXPECT_OK
(
V®id©ePpid
(
µid
));

57 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
CpuSvnW™houtV®ueF›ldIsInv®id
) {

58 
EXPECT_THAT
(
V®id©eCpuSvn
(
CpuSvn
()),

59 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

62 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
CpuSvnW™hV®ueF›ldOfBadL’gthIsInv®id
) {

63 
CpuSvn
 
	gıu_svn
;

64 *
	gıu_svn
.
mubË_v®ue
() = "short";

65 
EXPECT_THAT
(
V®id©eCpuSvn
(
ıu_svn
),

66 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

68 *
	gıu_svn
.
mubË_v®ue
() = "waaaaaaaaaaaaaaaaaaaaaaaaaaytoolong";

69 
EXPECT_THAT
(
V®id©eCpuSvn
(
ıu_svn
),

70 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

73 
TEST
(
ProvisiÚšgPÏtfÜmTe¡
, 
V®idCpuSvnIsV®id
) {

74 
CpuSvn
 
	gıu_svn
;

75 *
	gıu_svn
.
mubË_v®ue
() = "0123456789abcdef";

76 
ASYLO_EXPECT_OK
(
V®id©eCpuSvn
(
ıu_svn
));

79 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûSvnW™houtV®ueF›ldIsInv®id
) {

80 
EXPECT_THAT
(
V®id©ePûSvn
(
PûSvn
()),

81 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

84 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûSvnW™hTooL¬geV®ueF›ldIsInv®id
) {

85 
PûSvn
 
	gpû_svn
;

86 
	gpû_svn
.
£t_v®ue
(100000);

87 
EXPECT_THAT
(
V®id©ePûSvn
(
pû_svn
),

88 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

91 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idPûSvnIsV®id
) {

92 
PûSvn
 
	gpû_svn
;

93 
	gpû_svn
.
£t_v®ue
(10000);

94 
ASYLO_EXPECT_OK
(
V®id©ePûSvn
(
pû_svn
));

97 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûIdW™houtV®ueF›ldIsInv®id
) {

98 
EXPECT_THAT
(
V®id©ePûId
(
PûId
()),

99 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

102 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
PûIdW™hTooL¬geV®ueF›ldIsInv®id
) {

103 
PûId
 
	gpû_id
;

104 
	gpû_id
.
£t_v®ue
(100000);

105 
EXPECT_THAT
(
V®id©ePûId
(
pû_id
),

106 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

109 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idPûIdIsV®id
) {

110 
PûId
 
	gpû_id
;

111 
	gpû_id
.
£t_v®ue
(10000);

112 
ASYLO_EXPECT_OK
(
V®id©ePûId
(
pû_id
));

115 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
Fm¥cW™houtV®ueF›ldIsInv®id
) {

116 
EXPECT_THAT
(
V®id©eFm¥c
(
Fm¥c
()),

117 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

120 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
Fm¥cW™hV®ueF›ldOfBadL’gthIsInv®id
) {

121 
Fm¥c
 
	gfm¥c
;

122 
	gfm¥c
.
£t_v®ue
("short");

123 
EXPECT_THAT
(
V®id©eFm¥c
(
fm¥c
),

124 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

126 
	gfm¥c
.
£t_v®ue
("toolong");

127 
EXPECT_THAT
(
V®id©eFm¥c
(
fm¥c
),

128 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

131 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idFm¥cIsV®id
) {

132 
Fm¥c
 
	gfm¥c
;

133 
	gfm¥c
.
£t_v®ue
("000000");

134 
ASYLO_EXPECT_OK
(
V®id©eFm¥c
(
fm¥c
));

137 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
R•ÜtPrÙoW™houtV®ueF›ldIsInv®id
) {

138 
R•ÜtPrÙo
 
	g»pÜt_´Ùo
;

139 
EXPECT_THAT
(
V®id©eR•ÜtPrÙo
(
»pÜt_´Ùo
),

140 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

141 
EXPECT_THAT
(
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
(),

142 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

145 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
R•ÜtPrÙoW™hV®ueF›ldOfBadL’gthIsInv®id
) {

146 
R•ÜtPrÙo
 
	g»pÜt_´Ùo
;

147 
	g»pÜt_´Ùo
.
£t_v®ue
("short");

148 
EXPECT_THAT
(
V®id©eR•ÜtPrÙo
(
»pÜt_´Ùo
),

149 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

150 
EXPECT_THAT
(
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
(),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

153 
R•Üt
 
	g»pÜt
 = 
TrivŸlRªdomObjeù
<Report>();

154 
	g¡d
::
¡ršg
 
»pÜt_bš
 = 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
»pÜt
);

156 
	g»pÜt_bš
.
push_back
('a');

157 
	g»pÜt_´Ùo
.
£t_v®ue
(
»pÜt_bš
);

158 
EXPECT_THAT
(
V®id©eR•ÜtPrÙo
(
»pÜt_´Ùo
),

159 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

160 
EXPECT_THAT
(
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
).
¡©us
(),

161 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

164 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
T¬g‘InfoPrÙoW™houtV®ueF›ldIsInv®id
) {

165 
T¬g‘InfoPrÙo
 
	grg‘_šfo_´Ùo
;

166 
EXPECT_THAT
(
V®id©eT¬g‘InfoPrÙo
(
rg‘_šfo_´Ùo
),

167 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

168 
EXPECT_THAT
(
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
(),

169 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

172 
TEST
(
PÏtfÜmProvisiÚšgTe¡
,

173 
T¬g‘InfoPrÙoW™hV®ueF›ldOfBadL’gthIsInv®id
) {

174 
T¬g‘InfoPrÙo
 
	grg‘_šfo_´Ùo
;

175 
	grg‘_šfo_´Ùo
.
£t_v®ue
("short");

176 
EXPECT_THAT
(
V®id©eT¬g‘InfoPrÙo
(
rg‘_šfo_´Ùo
),

177 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

178 
EXPECT_THAT
(
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
(),

179 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

181 
T¬g‘šfo
 
	grg‘šfo
 = 
TrivŸlRªdomObjeù
<Targetinfo>();

182 
	g¡d
::
¡ršg
 
rg‘šfo_bš
 = 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
rg‘šfo
);

184 
	grg‘šfo_bš
.
push_back
('a');

185 
	grg‘_šfo_´Ùo
.
£t_v®ue
(
rg‘šfo_bš
);

186 
EXPECT_THAT
(
V®id©eT¬g‘InfoPrÙo
(
rg‘_šfo_´Ùo
),

187 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

188 
EXPECT_THAT
(
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
).
¡©us
(),

189 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

192 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idR•ÜtCªBeCÚv”‹dToH¬dw¬eR•Üt
) {

193 
R•Üt
 
	gex³ùed
 = 
TrivŸlRªdomObjeù
<Report>();

195 
R•ÜtPrÙo
 
	g»pÜt_´Ùo
;

196 
	g»pÜt_´Ùo
.
£t_v®ue
(
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
ex³ùed
));

198 autØ
	g»pÜt_»suÉ
 = 
CÚv”tR•ÜtPrÙoToH¬dw¬eR•Üt
(
»pÜt_´Ùo
);

199 
ASYLO_ASSERT_OK
(
»pÜt_»suÉ
);

201 
	g¡d
::
¡ršg
 
ex³ùed_hex
 = 
CÚv”tTrivŸlObjeùToHexSŒšg
<
R•Üt
>(
ex³ùed
);

202 
	g¡d
::
¡ršg
 
aùu®_hex
 =

203 
CÚv”tTrivŸlObjeùToHexSŒšg
(
»pÜt_»suÉ
.
V®ueOrD›
());

204 
EXPECT_THAT
(
aùu®_hex
, 
Eq
(
ex³ùed_hex
));

207 
TEST
(
PÏtfÜmProvisiÚšgTe¡
, 
V®idT¬g‘InfoPrÙoCªBeCÚv”‹dToT¬g‘šfo
) {

208 
T¬g‘šfo
 
	gex³ùed
 = 
TrivŸlRªdomObjeù
<Targetinfo>();

210 
T¬g‘InfoPrÙo
 
	grg‘_šfo_´Ùo
;

211 
	grg‘_šfo_´Ùo
.
£t_v®ue
(
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
ex³ùed
));

213 autØ
	grg‘šfo_»suÉ
 =

214 
CÚv”tT¬g‘InfoPrÙoToT¬g‘šfo
(
rg‘_šfo_´Ùo
);

215 
ASYLO_ASSERT_OK
(
rg‘šfo_»suÉ
);

217 
	g¡d
::
¡ršg
 
ex³ùed_hex
 =

218 
CÚv”tTrivŸlObjeùToHexSŒšg
<
T¬g‘šfo
>(
ex³ùed
);

219 
	g¡d
::
¡ršg
 
aùu®_hex
 =

220 
CÚv”tTrivŸlObjeùToHexSŒšg
(
rg‘šfo_»suÉ
.
V®ueOrD›
());

221 
EXPECT_THAT
(
aùu®_hex
, 
Eq
(
ex³ùed_hex
));

	@identity/sgx/proto_format.cc

19 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~<googË/´Ùobuf/desütÜ.h
>

25 
	~<googË/´Ùobuf/‹xt_fÜm©.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"ab¦/¡ršgs/esÿpšg.h
"

28 
	~"ab¦/¡ršgs/¡r_još.h
"

29 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

30 
	~"asylo/id’t™y/sgx/misc£Ëù.pb.h
"

31 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

32 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

33 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	gsgx
 {

37 
	gÇme¥aû
 {

39 
usšg
 
	ggoogË
::
´Ùobuf
::
TextFÜm©
;

42 şas 
	cBy‹sPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

43 
public
:

44 
PrštBy‹s
(cÚ¡ 
¡d
::
¡ršg
 &
v®ue
,

45 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

46 
g’”©Ü
->
PrštSŒšg
(
ab¦
::
By‹sToHexSŒšg
(
v®ue
));

52 şas 
	cA‰ribu‹sFÏgsPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

53 
public
:

54 
PrštUIÁ64
(
ušt64_t
 
v®ue
,

55 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

56 
A‰ribu‹s
 
©Œibu‹s
;

57 
	g©Œibu‹s
.
£t_æags
(
v®ue
);

58 
	g©Œibu‹s
.
£t_xäm
(0);

60 
	gg’”©Ü
->
PrštL™”®
("[");

62 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_©Œibu‹s
;

63 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_©Œibu‹s
);

64 
	gg’”©Ü
->
PrštSŒšg
(
ab¦
::
SŒJoš
(
´šbË_©Œibu‹s
, ", "));

66 
	gg’”©Ü
->
PrštL™”®
("]");

72 şas 
	cA‰ribu‹sXämPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

73 
public
:

74 
PrštUIÁ64
(
ušt64_t
 
v®ue
,

75 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

76 
A‰ribu‹s
 
©Œibu‹s
;

77 
	g©Œibu‹s
.
£t_æags
(0);

78 
	g©Œibu‹s
.
£t_xäm
(
v®ue
);

80 
	gg’”©Ü
->
PrštL™”®
("[");

82 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_©Œibu‹s
;

83 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_©Œibu‹s
);

84 
	gg’”©Ü
->
PrštSŒšg
(
ab¦
::
SŒJoš
(
´šbË_©Œibu‹s
, ", "));

86 
	gg’”©Ü
->
PrštL™”®
("]");

92 şas 
	cMiscS–eùPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

93 
public
:

94 
PrštUIÁ32
(
ušt32_t
 
v®ue
,

95 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

96 
g’”©Ü
->
PrštL™”®
("[");

98 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_misc_£Ëù
 =

99 
G‘PršbËMisc£ËùLi¡
(
v®ue
);

100 
	gg’”©Ü
->
PrštSŒšg
(
ab¦
::
SŒJoš
(
´šbË_misc_£Ëù
, ", "));

102 
	gg’”©Ü
->
PrštL™”®
("]");

106 
	g¡d
::
unique_±r
<
TextFÜm©
::
Prš‹r
> 
C»©eSgxPrÙoPrš‹r
() {

107 autØ
´š‹r
 = 
ab¦
::
make_unique
<
TextFÜm©
::
Prš‹r
>();

108 cÚ¡ 
	ggoogË
::
´Ùobuf
::
DesütÜ
 *
desütÜ
 = 
A‰ribu‹s
::descriptor();

112 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("flags"),

113 
Ãw
 
A‰ribu‹sFÏgsPrš‹r
());

114 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("xfrm"),

115 
Ãw
 
A‰ribu‹sXämPrš‹r
());

119 
	gdesütÜ
 = 
Sha256HashPrÙo
::
desütÜ
();

120 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("hash"),

121 
Ãw
 
By‹sPrš‹r
());

125 
	gdesütÜ
 = 
Misc£Ëù
::
desütÜ
();

126 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("value"),

127 
Ãw
 
MiscS–eùPrš‹r
());

132 
	gdesütÜ
 = 
CodeId’t™y
::
desütÜ
();

133 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("miscselect"),

134 
Ãw
 
MiscS–eùPrš‹r
());

135 
	gdesütÜ
 = 
CodeId’t™yM©chS³c
::
desütÜ
();

136 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(

137 
desütÜ
->
FšdF›ldByName
("miscselect_match_mask"),

138 
Ãw
 
MiscS–eùPrš‹r
());

140  
	g´š‹r
;

145 
	g¡d
::
¡ršg
 
FÜm©PrÙo
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
) {

146 cÚ¡ 
TextFÜm©
::
Prš‹r
 *
´š‹r
 = 
C»©eSgxPrÙoPrš‹r
().
»Ëa£
();

148 
	g¡d
::
¡ršg
 
‹xt
;

149 
	g´š‹r
->
PrštToSŒšg
(
mes§ge
, &
‹xt
);

150  
	g‹xt
;

	@identity/sgx/proto_format.cc

19 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~<googË/´Ùobuf/desütÜ.h
>

25 
	~<googË/´Ùobuf/‹xt_fÜm©.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"ab¦/¡ršgs/esÿpšg.h
"

28 
	~"ab¦/¡ršgs/¡r_još.h
"

29 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

30 
	~"asylo/id’t™y/sgx/misc£Ëù.pb.h
"

31 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

32 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

33 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	gsgx
 {

37 
	gÇme¥aû
 {

39 
usšg
 
	ggoogË
::
´Ùobuf
::
TextFÜm©
;

42 şas 
	cBy‹sPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

43 
public
:

44 
PrštBy‹s
(cÚ¡ 
¡d
::
¡ršg
 &
v®ue
,

45 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

46 
g’”©Ü
->
PrštSŒšg
(
ab¦
::
By‹sToHexSŒšg
(
v®ue
));

52 şas 
	cA‰ribu‹sFÏgsPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

53 
public
:

54 
PrštUIÁ64
(
ušt64_t
 
v®ue
,

55 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

56 
A‰ribu‹s
 
©Œibu‹s
;

57 
	g©Œibu‹s
.
£t_æags
(
v®ue
);

58 
	g©Œibu‹s
.
£t_xäm
(0);

60 
	gg’”©Ü
->
PrštL™”®
("[");

62 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_©Œibu‹s
;

63 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_©Œibu‹s
);

64 
	gg’”©Ü
->
PrštSŒšg
(
ab¦
::
SŒJoš
(
´šbË_©Œibu‹s
, ", "));

66 
	gg’”©Ü
->
PrštL™”®
("]");

72 şas 
	cA‰ribu‹sXämPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

73 
public
:

74 
PrštUIÁ64
(
ušt64_t
 
v®ue
,

75 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

76 
A‰ribu‹s
 
©Œibu‹s
;

77 
	g©Œibu‹s
.
£t_æags
(0);

78 
	g©Œibu‹s
.
£t_xäm
(
v®ue
);

80 
	gg’”©Ü
->
PrštL™”®
("[");

82 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_©Œibu‹s
;

83 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_©Œibu‹s
);

84 
	gg’”©Ü
->
PrštSŒšg
(
ab¦
::
SŒJoš
(
´šbË_©Œibu‹s
, ", "));

86 
	gg’”©Ü
->
PrštL™”®
("]");

92 şas 
	cMiscS–eùPrš‹r
 : 
public
 
TextFÜm©
::
Fa¡F›ldV®uePrš‹r
 {

93 
public
:

94 
PrštUIÁ32
(
ušt32_t
 
v®ue
,

95 
TextFÜm©
::
Ba£TextG’”©Ü
 *
g’”©Ü
ècÚ¡ 
ov”ride
 {

96 
g’”©Ü
->
PrštL™”®
("[");

98 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_misc_£Ëù
 =

99 
G‘PršbËMisc£ËùLi¡
(
v®ue
);

100 
	gg’”©Ü
->
PrštSŒšg
(
ab¦
::
SŒJoš
(
´šbË_misc_£Ëù
, ", "));

102 
	gg’”©Ü
->
PrštL™”®
("]");

106 
	g¡d
::
unique_±r
<
TextFÜm©
::
Prš‹r
> 
C»©eSgxPrÙoPrš‹r
() {

107 autØ
´š‹r
 = 
ab¦
::
make_unique
<
TextFÜm©
::
Prš‹r
>();

108 cÚ¡ 
	ggoogË
::
´Ùobuf
::
DesütÜ
 *
desütÜ
 = 
A‰ribu‹s
::descriptor();

112 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("flags"),

113 
Ãw
 
A‰ribu‹sFÏgsPrš‹r
());

114 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("xfrm"),

115 
Ãw
 
A‰ribu‹sXämPrš‹r
());

119 
	gdesütÜ
 = 
Sha256HashPrÙo
::
desütÜ
();

120 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("hash"),

121 
Ãw
 
By‹sPrš‹r
());

125 
	gdesütÜ
 = 
Misc£Ëù
::
desütÜ
();

126 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("value"),

127 
Ãw
 
MiscS–eùPrš‹r
());

132 
	gdesütÜ
 = 
CodeId’t™y
::
desütÜ
();

133 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(
desütÜ
->
FšdF›ldByName
("miscselect"),

134 
Ãw
 
MiscS–eùPrš‹r
());

135 
	gdesütÜ
 = 
CodeId’t™yM©chS³c
::
desütÜ
();

136 
	g´š‹r
->
Regi¡”F›ldV®uePrš‹r
(

137 
desütÜ
->
FšdF›ldByName
("miscselect_match_mask"),

138 
Ãw
 
MiscS–eùPrš‹r
());

140  
	g´š‹r
;

145 
	g¡d
::
¡ršg
 
FÜm©PrÙo
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
) {

146 cÚ¡ 
TextFÜm©
::
Prš‹r
 *
´š‹r
 = 
C»©eSgxPrÙoPrš‹r
().
»Ëa£
();

148 
	g¡d
::
¡ršg
 
‹xt
;

149 
	g´š‹r
->
PrštToSŒšg
(
mes§ge
, &
‹xt
);

150  
	g‹xt
;

	@identity/sgx/proto_format.h

19 #iâdeà
ASYLO_IDENTITY_SGX_PROTO_FORMAT_H_


20 
	#ASYLO_IDENTITY_SGX_PROTO_FORMAT_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

35 
	g¡d
::
¡ršg
 
FÜm©PrÙo
(cÚ¡ 
googË
::
´Ùobuf
::
Mes§ge
 &
mes§ge
);

	@identity/sgx/proto_format_test.cc

19 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/esÿpšg.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

28 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

29 
	~"asylo/id’t™y/sgx/misc£Ëù.pb.h
"

30 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

31 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

32 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gsgx
 {

36 
	gÇme¥aû
 {

38 
	gusšg
 ::
‹¡šg
::
HasSub¡r
;

39 
	gusšg
 ::
‹¡šg
::
Te¡
;

41 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yHasA‰ribu‹sByName
) {

42 
CodeId’t™y
 
	gid’t™y
;

43 
S‘S–fCodeId’t™y
(&
id’t™y
);

44 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
id’t™y
);

46 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_©Œibu‹s
;

47 
G‘PršbËA‰ribu‹Li¡
(
id’t™y
.
©Œibu‹s
(), &
Çmed_©Œibu‹s
);

48 cÚ¡ 
	g¡d
::
¡ršg
 &
©Œibu‹
 : 
Çmed_©Œibu‹s
) {

49 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
©Œibu‹
));

53 
TEST
(
PrÙoFÜm©Te¡
, 
Misc£ËùB™sByName
) {

54 
Misc£Ëù
 
	gmisc£Ëù
;

55 
	gmisc£Ëù
.
£t_v®ue
(
UINT32_C
(1)

56 << 
¡©ic_ÿ¡
<
size_t
>(
SecsMisc£ËùB™
::
EXINFO
));

57 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
misc£Ëù
);

59 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_misc£Ëù_b™s
 =

60 
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
);

61 cÚ¡ 
	g¡d
::
¡ršg
 &
misc£Ëù_b™
 : 
Çmed_misc£Ëù_b™s
) {

62 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
misc£Ëù_b™
));

66 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yHasMisc£ËùB™sByName
) {

67 
CodeId’t™y
 
	gid’t™y
;

68 
S‘S–fCodeId’t™y
(&
id’t™y
);

69 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
id’t™y
);

71 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_misc£Ëù_b™s
 =

72 
G‘PršbËMisc£ËùLi¡
(
id’t™y
.
misc£Ëù
());

73 cÚ¡ 
	g¡d
::
¡ršg
 &
misc£Ëù_b™
 : 
Çmed_misc£Ëù_b™s
) {

74 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
misc£Ëù_b™
));

78 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yHasHexEncodedBy‹sF›lds
) {

79 
CodeId’t™y
 
	gid’t™y
;

80 
S‘S–fCodeId’t™y
(&
id’t™y
);

81 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
id’t™y
);

83 
EXPECT_THAT
(
‹xt
,

84 
HasSub¡r
(
ab¦
::
By‹sToHexSŒšg
(
id’t™y
.
m»nşave
().
hash
())));

85 
EXPECT_THAT
(
‹xt
,

86 
HasSub¡r
(
ab¦
::
By‹sToHexSŒšg
(

87 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
())));

90 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yM©chS³cHasA‰ribu‹sByName
) {

91 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

92 
S‘DeçuÉM©chS³c
(&
m©ch_¥ec
);

93 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
m©ch_¥ec
);

95 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_©Œibu‹s
;

96 
G‘PršbËA‰ribu‹Li¡
(
m©ch_¥ec
.
©Œibu‹s_m©ch_mask
(),

97 &
Çmed_©Œibu‹s
);

98 cÚ¡ 
	g¡d
::
¡ršg
 &
©Œibu‹
 : 
Çmed_©Œibu‹s
) {

99 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
©Œibu‹
));

103 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yM©chS³cHasMisc£ËùB™sByName
) {

104 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

105 
S‘DeçuÉM©chS³c
(&
m©ch_¥ec
);

106 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
m©ch_¥ec
);

108 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_misc£Ëù_b™s
 =

109 
G‘PršbËMisc£ËùLi¡
(
m©ch_¥ec
.
misc£Ëù_m©ch_mask
());

110 cÚ¡ 
	g¡d
::
¡ršg
 &
misc£Ëù_b™
 : 
Çmed_misc£Ëù_b™s
) {

111 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
misc£Ëù_b™
));

	@identity/sgx/proto_format_test.cc

19 
	~"asylo/id’t™y/sgx/´Ùo_fÜm©.h
"

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/esÿpšg.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

28 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

29 
	~"asylo/id’t™y/sgx/misc£Ëù.pb.h
"

30 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

31 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

32 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gsgx
 {

36 
	gÇme¥aû
 {

38 
	gusšg
 ::
‹¡šg
::
HasSub¡r
;

39 
	gusšg
 ::
‹¡šg
::
Te¡
;

41 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yHasA‰ribu‹sByName
) {

42 
CodeId’t™y
 
	gid’t™y
;

43 
S‘S–fCodeId’t™y
(&
id’t™y
);

44 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
id’t™y
);

46 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_©Œibu‹s
;

47 
G‘PršbËA‰ribu‹Li¡
(
id’t™y
.
©Œibu‹s
(), &
Çmed_©Œibu‹s
);

48 cÚ¡ 
	g¡d
::
¡ršg
 &
©Œibu‹
 : 
Çmed_©Œibu‹s
) {

49 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
©Œibu‹
));

53 
TEST
(
PrÙoFÜm©Te¡
, 
Misc£ËùB™sByName
) {

54 
Misc£Ëù
 
	gmisc£Ëù
;

55 
	gmisc£Ëù
.
£t_v®ue
(
UINT32_C
(1)

56 << 
¡©ic_ÿ¡
<
size_t
>(
SecsMisc£ËùB™
::
EXINFO
));

57 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
misc£Ëù
);

59 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_misc£Ëù_b™s
 =

60 
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
);

61 cÚ¡ 
	g¡d
::
¡ršg
 &
misc£Ëù_b™
 : 
Çmed_misc£Ëù_b™s
) {

62 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
misc£Ëù_b™
));

66 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yHasMisc£ËùB™sByName
) {

67 
CodeId’t™y
 
	gid’t™y
;

68 
S‘S–fCodeId’t™y
(&
id’t™y
);

69 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
id’t™y
);

71 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_misc£Ëù_b™s
 =

72 
G‘PršbËMisc£ËùLi¡
(
id’t™y
.
misc£Ëù
());

73 cÚ¡ 
	g¡d
::
¡ršg
 &
misc£Ëù_b™
 : 
Çmed_misc£Ëù_b™s
) {

74 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
misc£Ëù_b™
));

78 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yHasHexEncodedBy‹sF›lds
) {

79 
CodeId’t™y
 
	gid’t™y
;

80 
S‘S–fCodeId’t™y
(&
id’t™y
);

81 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
id’t™y
);

83 
EXPECT_THAT
(
‹xt
,

84 
HasSub¡r
(
ab¦
::
By‹sToHexSŒšg
(
id’t™y
.
m»nşave
().
hash
())));

85 
EXPECT_THAT
(
‹xt
,

86 
HasSub¡r
(
ab¦
::
By‹sToHexSŒšg
(

87 
id’t™y
.
sigÃr_assigÃd_id’t™y
().
mrsigÃr
().
hash
())));

90 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yM©chS³cHasA‰ribu‹sByName
) {

91 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

92 
S‘DeçuÉM©chS³c
(&
m©ch_¥ec
);

93 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
m©ch_¥ec
);

95 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_©Œibu‹s
;

96 
G‘PršbËA‰ribu‹Li¡
(
m©ch_¥ec
.
©Œibu‹s_m©ch_mask
(),

97 &
Çmed_©Œibu‹s
);

98 cÚ¡ 
	g¡d
::
¡ršg
 &
©Œibu‹
 : 
Çmed_©Œibu‹s
) {

99 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
©Œibu‹
));

103 
TEST
(
PrÙoFÜm©Te¡
, 
CodeId’t™yM©chS³cHasMisc£ËùB™sByName
) {

104 
CodeId’t™yM©chS³c
 
	gm©ch_¥ec
;

105 
S‘DeçuÉM©chS³c
(&
m©ch_¥ec
);

106 
	g¡d
::
¡ršg
 
‹xt
 = 
FÜm©PrÙo
(
m©ch_¥ec
);

108 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Çmed_misc£Ëù_b™s
 =

109 
G‘PršbËMisc£ËùLi¡
(
m©ch_¥ec
.
misc£Ëù_m©ch_mask
());

110 cÚ¡ 
	g¡d
::
¡ršg
 &
misc£Ëù_b™
 : 
Çmed_misc£Ëù_b™s
) {

111 
EXPECT_THAT
(
‹xt
, 
HasSub¡r
(
misc£Ëù_b™
));

	@identity/sgx/remote_assertion_util.cc

19 
	~"asylo/id’t™y/sgx/»mÙe_as£¹iÚ_ut.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"asylo/ut/¡©us_maüos.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsgx
 {

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
	gkRemÙeAs£¹iÚV”siÚ
[] = "Asylo SGX Remote Assertion v1";

32 
Stus
 
MakeRemÙeAs£¹iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

33 cÚ¡ 
CodeId’t™y
 &
id’t™y
,

34 cÚ¡ 
SignšgKey
 &
signšg_key
,

35 cÚ¡ 
¡d
::
veùÜ
<
C”tifiÿ‹Chaš
> &
û¹_chašs
,

36 
RemÙeAs£¹iÚ
 *
as£¹iÚ
) {

37 
	gas£¹iÚ
->
CË¬
();

38 
	gas£¹iÚ
->
£t_sigÇtu»_scheme
(
signšg_key
.
G‘SigÇtu»Scheme
());

39 cÚ¡‡utØ&
	gchaš
 : 
û¹_chašs
) {

40 *
as£¹iÚ
->
add_û¹ifiÿ‹_chašs
(èğ
chaš
;

43 
RemÙeAs£¹iÚPaylßd
 
	g·ylßd
;

44 
	g·ylßd
.
£t_v”siÚ
(
kRemÙeAs£¹iÚV”siÚ
);

45 
	g·ylßd
.
£t_sigÇtu»_scheme
(
signšg_key
.
G‘SigÇtu»Scheme
());

46 
	g·ylßd
.
£t_u£r_d©a
(
u£r_d©a
);

47 *
	g·ylßd
.
mubË_id’t™y
(èğ
id’t™y
;

49 ià(!
	g·ylßd
.
S”ŸlizeToSŒšg
(
as£¹iÚ
->
mubË_·ylßd
())) {

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Serialization failed");

53 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»
;

54 
ASYLO_RETURN_IF_ERROR
(
signšg_key
.
Sign
(
as£¹iÚ
->
·ylßd
(), &
sigÇtu»
));

55 
	gas£¹iÚ
->
£t_sigÇtu»
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
sigÇtu»
.
d©a
()),

56 
sigÇtu»
.
size
());

58  
	gStus
::
OkStus
();

61 
Stus
 
V”ifyRemÙeAs£¹iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

62 cÚ¡ 
V”ifyšgKey
 &
v”ifyšg_key
,

63 cÚ¡ 
¡d
::
veùÜ
<
C”tifiÿ‹
> &
roÙ_û¹ifiÿ‹s
,

64 cÚ¡ 
RemÙeAs£¹iÚ
 &
as£¹iÚ
,

65 
CodeId’t™y
 *
id’t™y
) {

66  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
, "Not implemented");

	@identity/sgx/remote_assertion_util.cc

19 
	~"asylo/id’t™y/sgx/»mÙe_as£¹iÚ_ut.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"asylo/ut/¡©us_maüos.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsgx
 {

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
	gkRemÙeAs£¹iÚV”siÚ
[] = "Asylo SGX Remote Assertion v1";

32 
Stus
 
MakeRemÙeAs£¹iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

33 cÚ¡ 
CodeId’t™y
 &
id’t™y
,

34 cÚ¡ 
SignšgKey
 &
signšg_key
,

35 cÚ¡ 
¡d
::
veùÜ
<
C”tifiÿ‹Chaš
> &
û¹_chašs
,

36 
RemÙeAs£¹iÚ
 *
as£¹iÚ
) {

37 
	gas£¹iÚ
->
CË¬
();

38 
	gas£¹iÚ
->
£t_sigÇtu»_scheme
(
signšg_key
.
G‘SigÇtu»Scheme
());

39 cÚ¡‡utØ&
	gchaš
 : 
û¹_chašs
) {

40 *
as£¹iÚ
->
add_û¹ifiÿ‹_chašs
(èğ
chaš
;

43 
RemÙeAs£¹iÚPaylßd
 
	g·ylßd
;

44 
	g·ylßd
.
£t_v”siÚ
(
kRemÙeAs£¹iÚV”siÚ
);

45 
	g·ylßd
.
£t_sigÇtu»_scheme
(
signšg_key
.
G‘SigÇtu»Scheme
());

46 
	g·ylßd
.
£t_u£r_d©a
(
u£r_d©a
);

47 *
	g·ylßd
.
mubË_id’t™y
(èğ
id’t™y
;

49 ià(!
	g·ylßd
.
S”ŸlizeToSŒšg
(
as£¹iÚ
->
mubË_·ylßd
())) {

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Serialization failed");

53 
	g¡d
::
veùÜ
<
ušt8_t
> 
sigÇtu»
;

54 
ASYLO_RETURN_IF_ERROR
(
signšg_key
.
Sign
(
as£¹iÚ
->
·ylßd
(), &
sigÇtu»
));

55 
	gas£¹iÚ
->
£t_sigÇtu»
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
sigÇtu»
.
d©a
()),

56 
sigÇtu»
.
size
());

58  
	gStus
::
OkStus
();

61 
Stus
 
V”ifyRemÙeAs£¹iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

62 cÚ¡ 
V”ifyšgKey
 &
v”ifyšg_key
,

63 cÚ¡ 
¡d
::
veùÜ
<
C”tifiÿ‹
> &
roÙ_û¹ifiÿ‹s
,

64 cÚ¡ 
RemÙeAs£¹iÚ
 &
as£¹iÚ
,

65 
CodeId’t™y
 *
id’t™y
) {

66  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNIMPLEMENTED
, "Not implemented");

	@identity/sgx/remote_assertion_util.h

19 #iâdeà
ASYLO_IDENTITY_SGX_REMOTE_ASSERTION_UTIL_H_


20 
	#ASYLO_IDENTITY_SGX_REMOTE_ASSERTION_UTIL_H_


	)

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"asylo/üy±o/û¹ifiÿ‹.pb.h
"

26 
	~"asylo/üy±o/signšg_key.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

28 
	~"asylo/id’t™y/sgx/»mÙe_as£¹iÚ.pb.h
"

29 
	~"asylo/ut/¡©us.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsgx
 {

38 
Stus
 
MakeRemÙeAs£¹iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

39 cÚ¡ 
CodeId’t™y
 &
id’t™y
,

40 cÚ¡ 
SignšgKey
 &
signšg_key
,

41 cÚ¡ 
¡d
::
veùÜ
<
C”tifiÿ‹Chaš
> &
û¹_chašs
,

42 
RemÙeAs£¹iÚ
 *
as£¹iÚ
);

51 
Stus
 
V”ifyRemÙeAs£¹iÚ
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

52 cÚ¡ 
V”ifyšgKey
 &
v”ifyšg_key
,

53 cÚ¡ 
¡d
::
veùÜ
<
C”tifiÿ‹
> &
roÙ_û¹ifiÿ‹s
,

54 cÚ¡ 
RemÙeAs£¹iÚ
 &
as£¹iÚ
,

55 
CodeId’t™y
 *
id’t™y
);

	@identity/sgx/remote_assertion_util_test.cc

19 
	~"asylo/id’t™y/sgx/»mÙe_as£¹iÚ_ut.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/üy±o/û¹ifiÿ‹.pb.h
"

27 
	~"asylo/üy±o/ecd§_p256_sha256_signšg_key.h
"

28 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

29 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

30 
	~"asylo/id’t™y/sgx/»mÙe_as£¹iÚ.pb.h
"

31 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gsgx
 {

36 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
	gkU£rD©a
[] = "User Data";

39 
cÚ¡ex´
 
	gkC”tifiÿ‹
[] = "Certificate";

41 
TEST
(
RemÙeAs£¹iÚUtTe¡
, 
MakeRemÙeAs£¹iÚSucûeds
) {

42 
	g¡d
::
veùÜ
<
C”tifiÿ‹Chaš
> 
û¹ifiÿ‹_chašs
;

43 
	gû¹ifiÿ‹_chašs
.
push_back
({});

44 
C”tifiÿ‹
 *
	gû¹ifiÿ‹
 = 
û¹ifiÿ‹_chašs
.
back
().
add_û¹ifiÿ‹s
();

45 
	gû¹ifiÿ‹
->
£t_fÜm©
(
C”tifiÿ‹_C”tifiÿ‹FÜm©_X509_DER
);

46 
	gû¹ifiÿ‹
->
£t_d©a
(
kC”tifiÿ‹
);

49 autØ
	gsignšg_key_»suÉ
 = 
Ecd§P256Sha256SignšgKey
::
C»©e
();

50 
EXPECT_THAT
(
signšg_key_»suÉ
, 
IsOk
());

51 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key
 =

52 
¡d
::
move
(
signšg_key_»suÉ
).
V®ueOrD›
();

55 
CodeId’t™y
 
	gid’t™y
;

56 
S‘S–fCodeId’t™y
(&
id’t™y
);

58 
RemÙeAs£¹iÚ
 
	gas£¹iÚ
;

59 
ASSERT_THAT
(
MakeRemÙeAs£¹iÚ
(
kU£rD©a
, 
id’t™y
, *
signšg_key
,

60 
û¹ifiÿ‹_chašs
, &
as£¹iÚ
),

61 
IsOk
());

62 
EXPECT_EQ
(
as£¹iÚ
.
sigÇtu»_scheme
(), 
signšg_key
->
G‘SigÇtu»Scheme
());

63 
EXPECT_EQ
(
as£¹iÚ
.
û¹ifiÿ‹_chašs_size
(), 
û¹ifiÿ‹_chašs
.
size
());

65 
RemÙeAs£¹iÚPaylßd
 
	g·ylßd
;

66 
ASSERT_TRUE
(
·ylßd
.
P¬£FromSŒšg
(
as£¹iÚ
.payload()));

67 
EXPECT_EQ
(
·ylßd
.
sigÇtu»_scheme
(), 
signšg_key
->
G‘SigÇtu»Scheme
());

68 
EXPECT_EQ
(
·ylßd
.
u£r_d©a
(), 
kU£rD©a
);

69 
EXPECT_THAT
(
·ylßd
.
id’t™y
(), 
Equ®sPrÙo
(identity));

71 autØ
	gv”ifyšg_key_»suÉ
 = 
signšg_key
->
G‘V”ifyšgKey
();

72 
ASSERT_THAT
(
v”ifyšg_key_»suÉ
, 
IsOk
());

74 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key
 =

75 
¡d
::
move
(
v”ifyšg_key_»suÉ
).
V®ueOrD›
();

76 
EXPECT_THAT
(
v”ifyšg_key
->
V”ify
(
as£¹iÚ
.
·ylßd
(),‡s£¹iÚ.
sigÇtu»
()),

77 
IsOk
());

	@identity/sgx/remote_assertion_util_test.cc

19 
	~"asylo/id’t™y/sgx/»mÙe_as£¹iÚ_ut.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/üy±o/û¹ifiÿ‹.pb.h
"

27 
	~"asylo/üy±o/ecd§_p256_sha256_signšg_key.h
"

28 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

29 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

30 
	~"asylo/id’t™y/sgx/»mÙe_as£¹iÚ.pb.h
"

31 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gsgx
 {

36 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
	gkU£rD©a
[] = "User Data";

39 
cÚ¡ex´
 
	gkC”tifiÿ‹
[] = "Certificate";

41 
TEST
(
RemÙeAs£¹iÚUtTe¡
, 
MakeRemÙeAs£¹iÚSucûeds
) {

42 
	g¡d
::
veùÜ
<
C”tifiÿ‹Chaš
> 
û¹ifiÿ‹_chašs
;

43 
	gû¹ifiÿ‹_chašs
.
push_back
({});

44 
C”tifiÿ‹
 *
	gû¹ifiÿ‹
 = 
û¹ifiÿ‹_chašs
.
back
().
add_û¹ifiÿ‹s
();

45 
	gû¹ifiÿ‹
->
£t_fÜm©
(
C”tifiÿ‹_C”tifiÿ‹FÜm©_X509_DER
);

46 
	gû¹ifiÿ‹
->
£t_d©a
(
kC”tifiÿ‹
);

49 autØ
	gsignšg_key_»suÉ
 = 
Ecd§P256Sha256SignšgKey
::
C»©e
();

50 
EXPECT_THAT
(
signšg_key_»suÉ
, 
IsOk
());

51 
	g¡d
::
unique_±r
<
Ecd§P256Sha256SignšgKey
> 
signšg_key
 =

52 
¡d
::
move
(
signšg_key_»suÉ
).
V®ueOrD›
();

55 
CodeId’t™y
 
	gid’t™y
;

56 
S‘S–fCodeId’t™y
(&
id’t™y
);

58 
RemÙeAs£¹iÚ
 
	gas£¹iÚ
;

59 
ASSERT_THAT
(
MakeRemÙeAs£¹iÚ
(
kU£rD©a
, 
id’t™y
, *
signšg_key
,

60 
û¹ifiÿ‹_chašs
, &
as£¹iÚ
),

61 
IsOk
());

62 
EXPECT_EQ
(
as£¹iÚ
.
sigÇtu»_scheme
(), 
signšg_key
->
G‘SigÇtu»Scheme
());

63 
EXPECT_EQ
(
as£¹iÚ
.
û¹ifiÿ‹_chašs_size
(), 
û¹ifiÿ‹_chašs
.
size
());

65 
RemÙeAs£¹iÚPaylßd
 
	g·ylßd
;

66 
ASSERT_TRUE
(
·ylßd
.
P¬£FromSŒšg
(
as£¹iÚ
.payload()));

67 
EXPECT_EQ
(
·ylßd
.
sigÇtu»_scheme
(), 
signšg_key
->
G‘SigÇtu»Scheme
());

68 
EXPECT_EQ
(
·ylßd
.
u£r_d©a
(), 
kU£rD©a
);

69 
EXPECT_THAT
(
·ylßd
.
id’t™y
(), 
Equ®sPrÙo
(identity));

71 autØ
	gv”ifyšg_key_»suÉ
 = 
signšg_key
->
G‘V”ifyšgKey
();

72 
ASSERT_THAT
(
v”ifyšg_key_»suÉ
, 
IsOk
());

74 
	g¡d
::
unique_±r
<
V”ifyšgKey
> 
v”ifyšg_key
 =

75 
¡d
::
move
(
v”ifyšg_key_»suÉ
).
V®ueOrD›
();

76 
EXPECT_THAT
(
v”ifyšg_key
->
V”ify
(
as£¹iÚ
.
·ylßd
(),‡s£¹iÚ.
sigÇtu»
()),

77 
IsOk
());

	@identity/sgx/secs_attributes.cc

19 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

21 
	~<c¡dšt
>

22 
	~<c¡ršg
>

23 
	~<io¡»am
>

24 
	~<lim™s
>

25 
	~<¡ršg
>

26 
	~<ut™y
>

27 
	~<veùÜ
>

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

32 #iâdeà
¬¿ysize


33 
	#¬¿ysize
(
¬r
è(×¼è/ ×¼[0]))

	)

36 
Çme¥aû
 
	gasylo
 {

37 
Çme¥aû
 
	gsgx
 {

39 
	gÇme¥aû
 {

41 
cÚ¡ex´
 
size_t
 
	gkBy‹B™s
 = 8;

42 
cÚ¡ex´
 
size_t
 
	gkNumFÏgsB™s
 =

43 (
¡©ic_ÿ¡
<
SecsA‰ribu‹S‘
 *>(
nuÎ±r
)->
æags
è* 
kBy‹B™s
;

44 
cÚ¡ex´
 
size_t
 
	gkNumXämB™s
 =

45 (
¡©ic_ÿ¡
<
SecsA‰ribu‹S‘
 *>(
nuÎ±r
)->
xäm
è* 
kBy‹B™s
;

46 
cÚ¡ex´
 
size_t
 
	gkNumSecsA‰ribu‹B™s
 = 
kNumFÏgsB™s
 + 
kNumXämB™s
;

85 
cÚ¡ex´
 
SecsA‰ribu‹B™
 
	gkDeçuÉDoNÙC¬eSecsA‰ribu‹s
[] = {

86 
SecsA‰ribu‹B™
::
FPU
, SecsA‰ribu‹B™::
SSE
,

87 
SecsA‰ribu‹B™
::
AVX
, SecsA‰ribu‹B™::
OPMASK
,

88 
SecsA‰ribu‹B™
::
ZMM_HI256
, SecsA‰ribu‹B™::
HI16_ZMM
};

91 
cÚ¡ex´
 
SecsA‰ribu‹B™
 
	gkAÎSecsA‰ribu‹s
[] = {

92 
SecsA‰ribu‹B™
::
INIT
, SecsA‰ribu‹B™::
DEBUG
,

93 
SecsA‰ribu‹B™
::
MODE64BIT
, SecsA‰ribu‹B™::
PROVISIONKEY
,

94 
SecsA‰ribu‹B™
::
INITTOKENKEY
, SecsA‰ribu‹B™::
KSS
,

95 
SecsA‰ribu‹B™
::
FPU
, SecsA‰ribu‹B™::
SSE
,

96 
SecsA‰ribu‹B™
::
AVX
, SecsA‰ribu‹B™::
BNDREG
,

97 
SecsA‰ribu‹B™
::
BNDCSR
, SecsA‰ribu‹B™::
OPMASK
,

98 
SecsA‰ribu‹B™
::
ZMM_HI256
, SecsA‰ribu‹B™::
HI16_ZMM
,

99 
SecsA‰ribu‹B™
::
PKRU
};

102 
cÚ¡ex´
 
SecsA‰ribu‹B™
 
	gkMu¡BeS‘A‰ribu‹s
[] = {

103 
SecsA‰ribu‹B™
::
INIT
, SecsA‰ribu‹B™::
FPU
, SecsA‰ribu‹B™::
SSE
};

105 
	g¡d
::
·œ
<
SecsA‰ribu‹B™
, cÚ¡ *> 
	gkPršbËSecsA‰ribu‹B™Names
[] = {

106 {
SecsA‰ribu‹B™
::
INIT
, "INIT"},

107 {
SecsA‰ribu‹B™
::
DEBUG
, "DEBUG"},

108 {
SecsA‰ribu‹B™
::
MODE64BIT
, "MODE64BIT"},

109 {
SecsA‰ribu‹B™
::
PROVISIONKEY
, "PROVISIONKEY"},

110 {
SecsA‰ribu‹B™
::
INITTOKENKEY
, "INITTOKENKEY"},

111 {
SecsA‰ribu‹B™
::
KSS
, "KSS"},

113 {
SecsA‰ribu‹B™
::
FPU
, "FPU"},

114 {
SecsA‰ribu‹B™
::
SSE
, "SSE"},

115 {
SecsA‰ribu‹B™
::
AVX
, "AVX"},

116 {
SecsA‰ribu‹B™
::
BNDREG
, "BNDREG"},

117 {
SecsA‰ribu‹B™
::
BNDCSR
, "BNDCSR"},

118 {
SecsA‰ribu‹B™
::
OPMASK
, "OPMASK"},

119 {
SecsA‰ribu‹B™
::
ZMM_HI256
, "ZMM_HI256"},

120 {
SecsA‰ribu‹B™
::
HI16_ZMM
, "HI16_ZMM"},

121 {
SecsA‰ribu‹B™
::
PKRU
, "PKRU"}};

123 cÚ¡ *
G‘A‰ribu‹Name
(
SecsA‰ribu‹B™
 
©Œibu‹
) {

124 cÚ¡ 
	g¡d
::
·œ
<
SecsA‰ribu‹B™
, cÚ¡ *> &
	g©Œibu‹_Çme_·œ
 :

125 
kPršbËSecsA‰ribu‹B™Names
) {

126 ià(
©Œibu‹_Çme_·œ
.
fœ¡
 =ğ
©Œibu‹
) {

127  
©Œibu‹_Çme_·œ
.
£cÚd
;

135 
	gStusOr
<
	gSecsA‰ribu‹S‘
> 
MakeSecsA‰ribu‹S‘
(

136 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
) {

137 
SecsA‰ribu‹S‘
 
©Œibu‹_£t
;

138 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, &
©Œibu‹_£t
)) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

142  
	g©Œibu‹_£t
;

145 
CË¬SecsA‰ribu‹S‘
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

146 
	g©Œibu‹s
->
	gæags
 = 0;

147 
	g©Œibu‹s
->
	gxäm
 = 0;

150 
SecsA‰ribu‹S‘
 
	gİ”©Ü
|(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	glhs
,

151 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

152 
SecsA‰ribu‹S‘
 
	g»suÉ
;

153 
	g»suÉ
.
	gæags
 = 
lhs
.
æags
 | 
rhs
.flags;

154 
	g»suÉ
.
	gxäm
 = 
lhs
.
xäm
 | 
rhs
.xfrm;

156  
	g»suÉ
;

159 
	gSecsA‰ribu‹S‘
 &
	gİ”©Ü
|=(
SecsA‰ribu‹S‘
 &
lhs
,

160 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

161 
	glhs
.
	gæags
 |ğ
rhs
.
æags
;

162 
	glhs
.
	gxäm
 |ğ
rhs
.
xäm
;

164  
	glhs
;

167 
SecsA‰ribu‹S‘
 
	gİ”©Ü
&(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	glhs
,

168 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

169 
SecsA‰ribu‹S‘
 
	g»suÉ
;

170 
	g»suÉ
.
	gæags
 = 
lhs
.
æags
 & 
rhs
.flags;

171 
	g»suÉ
.
	gxäm
 = 
lhs
.
xäm
 & 
rhs
.xfrm;

173  
	g»suÉ
;

176 
	gSecsA‰ribu‹S‘
 &
	gİ”©Ü
&=(
SecsA‰ribu‹S‘
 &
lhs
,

177 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

178 
	glhs
.
	gæags
 &ğ
rhs
.
æags
;

179 
	glhs
.
	gxäm
 &ğ
rhs
.
xäm
;

181  
	glhs
;

184 
SecsA‰ribu‹S‘
 
	gİ”©Ü
~(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	gv®ue
) {

185 
SecsA‰ribu‹S‘
 
	gtmp
;

186 
	gtmp
.
	gæags
 = ~
v®ue
.
æags
;

187 
	gtmp
.
	gxäm
 = ~
v®ue
.
xäm
;

188  
	gtmp
;

191 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SecsA‰ribu‹S‘
 &
lhs
, cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

192  
memcmp
(&
lhs
, &
rhs
, (lhs)) == 0;

195 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SecsA‰ribu‹S‘
 &
lhs
, cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

196  !(
	glhs
 =ğ
rhs
);

199 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

200 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

201 
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

202 
CË¬SecsA‰ribu‹S‘
(
©Œibu‹s
);

203 
SecsA‰ribu‹B™
 
	g©Œibu‹
 : 
©Œibu‹_li¡
) {

204 
size_t
 
b™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

205 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

206 
LOG
(
ERROR
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


208 << 
kNumSecsA‰ribu‹B™s
 - 1;

209  
	gçl£
;

211 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

212 
	g©Œibu‹s
->
	gæags
 |ğ(1ULL << 
b™_pos™iÚ
);

214 
	g©Œibu‹s
->
	gxäm
 |ğ(1ULL << (
b™_pos™iÚ
 - 
kNumFÏgsB™s
));

217  
	gŒue
;

220 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

221 cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
,

222 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
) {

223 
©Œibu‹_li¡
->
ş—r
();

224 
ušt32_t
 
	gi
 = 0; i < 
	gkNumFÏgsB™s
; i++) {

225 ià(
	g©Œibu‹s
.
	gæags
 & (1ULL << 
	gi
)) {

226 
	g©Œibu‹_li¡
->
push_back
(
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
));

229 
ušt32_t
 
	gi
 = 0; i < 
	gkNumXämB™s
; i++) {

230 ià(
	g©Œibu‹s
.
	gxäm
 & (1ULL << 
	gi
)) {

231 
	g©Œibu‹_li¡
->
push_back
(

232 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
 + 
kNumFÏgsB™s
));

235  
	gŒue
;

238 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

239 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

240 
A‰ribu‹s
 *
©Œibu‹s
) {

241 
	g©Œibu‹s
->
CË¬
();

242 
SecsA‰ribu‹B™
 
	g©Œibu‹
 : 
©Œibu‹_li¡
) {

243 
size_t
 
b™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

244 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

245 
LOG
(
ERROR
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


247 << 
kNumSecsA‰ribu‹B™s
 - 1;

248  
	gçl£
;

250 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

251 
	g©Œibu‹s
->
£t_æags
(
©Œibu‹s
->
æags
(è| (1ULL << 
b™_pos™iÚ
));

253 
	g©Œibu‹s
->
£t_xäm
(
©Œibu‹s
->
xäm
() |

254 (1ULL << (
b™_pos™iÚ
 - 
kNumFÏgsB™s
)));

257  
	gŒue
;

260 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

261 cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

262 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
) {

263 
©Œibu‹_li¡
->
ş—r
();

264 
ušt32_t
 
	gi
 = 0; i < 
	gkNumFÏgsB™s
; i++) {

265 ià(
	g©Œibu‹s
.
æags
(è& (1ULL << 
	gi
)) {

266 
	g©Œibu‹_li¡
->
push_back
(
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
));

269 
ušt32_t
 
	gi
 = 0; i < 
	gkNumXämB™s
; i++) {

270 ià(
	g©Œibu‹s
.
xäm
(è& (1ULL << 
	gi
)) {

271 
	g©Œibu‹_li¡
->
push_back
(

272 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
 + 
kNumFÏgsB™s
));

275  
	gŒue
;

278 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s_£t
,

279 
A‰ribu‹s
 *
©Œibu‹s
) {

280 
	g©Œibu‹s
->
£t_æags
(
©Œibu‹s_£t
.
æags
);

281 
	g©Œibu‹s
->
£t_xäm
(
©Œibu‹s_£t
.
xäm
);

282  
	gŒue
;

285 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

286 
SecsA‰ribu‹S‘
 *
©Œibu‹s_£t
) {

287 
	g©Œibu‹s_£t
->
	gæags
 = 
©Œibu‹s
.
æags
();

288 
	g©Œibu‹s_£t
->
	gxäm
 = 
©Œibu‹s
.
xäm
();

289  
	gŒue
;

292 
boŞ
 
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
 
©Œibu‹
,

293 cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s_£t
) {

294 
size_t
 
	gb™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

295 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

296 
LOG
(
INFO
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


298 << 
kNumSecsA‰ribu‹B™s
 - 1;

299  
	gçl£
;

302 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

303  (
	g©Œibu‹s_£t
.
	gæags
 & (1ULL << 
	gb™_pos™iÚ
)) != 0;

305  (
	g©Œibu‹s_£t
.
	gxäm
 & (1ULL << (
	gb™_pos™iÚ
 - 
	gkNumFÏgsB™s
))) !=

310 
boŞ
 
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
 
©Œibu‹
, cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
) {

311 
size_t
 
	gb™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

312 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

313 
LOG
(
INFO
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


315 << 
kNumSecsA‰ribu‹B™s
 - 1;

316  
	gçl£
;

319 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

320  (
	g©Œibu‹s
.
æags
(è& (1ULL << 
	gb™_pos™iÚ
)) != 0;

322  (
	g©Œibu‹s
.
xäm
(è& (1ULL << (
	gb™_pos™iÚ
 - 
	gkNumFÏgsB™s
))) != 0;

326 
boŞ
 
G‘AÎSecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

327 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

328 
kAÎSecsA‰ribu‹s
, kAÎSecsA‰ribu‹ + 
¬¿ysize
(kAllSecsAttributes));

329  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

332 
boŞ
 
G‘AÎSecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
) {

333 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

334 
kAÎSecsA‰ribu‹s
, kAÎSecsA‰ribu‹ + 
¬¿ysize
(kAllSecsAttributes));

335  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

338 
boŞ
 
G‘Mu¡BeS‘SecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

339 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

340 
kMu¡BeS‘A‰ribu‹s
,

341 
kMu¡BeS‘A‰ribu‹s
 + 
¬¿ysize
(kMustBeSetAttributes));

342  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

345 
boŞ
 
G‘Mu¡BeS‘SecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
) {

346 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

347 
kMu¡BeS‘A‰ribu‹s
,

348 
kMu¡BeS‘A‰ribu‹s
 + 
¬¿ysize
(kMustBeSetAttributes));

349  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

352 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(

353 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
) {

354 *
©Œibu‹_li¡
 = 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
>(

355 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
,

356 
	gkDeçuÉDoNÙC¬eSecsA‰ribu‹s
 +

357 
¬¿ysize
(
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
));

358  
	gŒue
;

361 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

362 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

363 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
,

364 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
 +

365 
¬¿ysize
(
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
));

366  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

369 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
) {

370 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

371 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
,

372 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
 +

373 
¬¿ysize
(
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
));

374  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

377 
Stus
 
S‘DeçuÉSecsA‰ribu‹sMask
(
A‰ribu‹s
 *
©Œibu‹s_m©ch_mask
) {

378 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

379 ià(!
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
©Œibu‹s
)) {

380  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

385 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(~
©Œibu‹s
, 
©Œibu‹s_m©ch_mask
)) {

386  
Stus
(

387 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

391  
	gStus
::
OkStus
();

394 
S‘SŒiùSecsA‰ribu‹sMask
(
A‰ribu‹s
 *
©Œibu‹s_m©ch_mask
) {

395 
	g©Œibu‹s_m©ch_mask
->
£t_æags
(
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
());

396 
	g©Œibu‹s_m©ch_mask
->
£t_xäm
(
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
());

399 
G‘PršbËA‰ribu‹Li¡
(

400 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

401 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
) {

402 
´šbË_li¡
->
ş—r
();

403 
SecsA‰ribu‹B™
 
	g©Œibu‹
 : 
©Œibu‹_li¡
) {

404 
´šbË_li¡
->
push_back
(
¡d
::
¡ršg
(
G‘A‰ribu‹Name
(
©Œibu‹
)));

408 
G‘PršbËA‰ribu‹Li¡
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
,

409 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
) {

410 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
;

411 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_li¡
);

412 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_li¡
, 
´šbË_li¡
);

415 
G‘PršbËA‰ribu‹Li¡
(cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

416 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
) {

417 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
;

418 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_li¡
);

419 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_li¡
, 
´šbË_li¡
);

	@identity/sgx/secs_attributes.cc

19 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

21 
	~<c¡dšt
>

22 
	~<c¡ršg
>

23 
	~<io¡»am
>

24 
	~<lim™s
>

25 
	~<¡ršg
>

26 
	~<ut™y
>

27 
	~<veùÜ
>

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

32 #iâdeà
¬¿ysize


33 
	#¬¿ysize
(
¬r
è(×¼è/ ×¼[0]))

	)

36 
Çme¥aû
 
	gasylo
 {

37 
Çme¥aû
 
	gsgx
 {

39 
	gÇme¥aû
 {

41 
cÚ¡ex´
 
size_t
 
	gkBy‹B™s
 = 8;

42 
cÚ¡ex´
 
size_t
 
	gkNumFÏgsB™s
 =

43 (
¡©ic_ÿ¡
<
SecsA‰ribu‹S‘
 *>(
nuÎ±r
)->
æags
è* 
kBy‹B™s
;

44 
cÚ¡ex´
 
size_t
 
	gkNumXämB™s
 =

45 (
¡©ic_ÿ¡
<
SecsA‰ribu‹S‘
 *>(
nuÎ±r
)->
xäm
è* 
kBy‹B™s
;

46 
cÚ¡ex´
 
size_t
 
	gkNumSecsA‰ribu‹B™s
 = 
kNumFÏgsB™s
 + 
kNumXämB™s
;

85 
cÚ¡ex´
 
SecsA‰ribu‹B™
 
	gkDeçuÉDoNÙC¬eSecsA‰ribu‹s
[] = {

86 
SecsA‰ribu‹B™
::
FPU
, SecsA‰ribu‹B™::
SSE
,

87 
SecsA‰ribu‹B™
::
AVX
, SecsA‰ribu‹B™::
OPMASK
,

88 
SecsA‰ribu‹B™
::
ZMM_HI256
, SecsA‰ribu‹B™::
HI16_ZMM
};

91 
cÚ¡ex´
 
SecsA‰ribu‹B™
 
	gkAÎSecsA‰ribu‹s
[] = {

92 
SecsA‰ribu‹B™
::
INIT
, SecsA‰ribu‹B™::
DEBUG
,

93 
SecsA‰ribu‹B™
::
MODE64BIT
, SecsA‰ribu‹B™::
PROVISIONKEY
,

94 
SecsA‰ribu‹B™
::
INITTOKENKEY
, SecsA‰ribu‹B™::
KSS
,

95 
SecsA‰ribu‹B™
::
FPU
, SecsA‰ribu‹B™::
SSE
,

96 
SecsA‰ribu‹B™
::
AVX
, SecsA‰ribu‹B™::
BNDREG
,

97 
SecsA‰ribu‹B™
::
BNDCSR
, SecsA‰ribu‹B™::
OPMASK
,

98 
SecsA‰ribu‹B™
::
ZMM_HI256
, SecsA‰ribu‹B™::
HI16_ZMM
,

99 
SecsA‰ribu‹B™
::
PKRU
};

102 
cÚ¡ex´
 
SecsA‰ribu‹B™
 
	gkMu¡BeS‘A‰ribu‹s
[] = {

103 
SecsA‰ribu‹B™
::
INIT
, SecsA‰ribu‹B™::
FPU
, SecsA‰ribu‹B™::
SSE
};

105 
	g¡d
::
·œ
<
SecsA‰ribu‹B™
, cÚ¡ *> 
	gkPršbËSecsA‰ribu‹B™Names
[] = {

106 {
SecsA‰ribu‹B™
::
INIT
, "INIT"},

107 {
SecsA‰ribu‹B™
::
DEBUG
, "DEBUG"},

108 {
SecsA‰ribu‹B™
::
MODE64BIT
, "MODE64BIT"},

109 {
SecsA‰ribu‹B™
::
PROVISIONKEY
, "PROVISIONKEY"},

110 {
SecsA‰ribu‹B™
::
INITTOKENKEY
, "INITTOKENKEY"},

111 {
SecsA‰ribu‹B™
::
KSS
, "KSS"},

113 {
SecsA‰ribu‹B™
::
FPU
, "FPU"},

114 {
SecsA‰ribu‹B™
::
SSE
, "SSE"},

115 {
SecsA‰ribu‹B™
::
AVX
, "AVX"},

116 {
SecsA‰ribu‹B™
::
BNDREG
, "BNDREG"},

117 {
SecsA‰ribu‹B™
::
BNDCSR
, "BNDCSR"},

118 {
SecsA‰ribu‹B™
::
OPMASK
, "OPMASK"},

119 {
SecsA‰ribu‹B™
::
ZMM_HI256
, "ZMM_HI256"},

120 {
SecsA‰ribu‹B™
::
HI16_ZMM
, "HI16_ZMM"},

121 {
SecsA‰ribu‹B™
::
PKRU
, "PKRU"}};

123 cÚ¡ *
G‘A‰ribu‹Name
(
SecsA‰ribu‹B™
 
©Œibu‹
) {

124 cÚ¡ 
	g¡d
::
·œ
<
SecsA‰ribu‹B™
, cÚ¡ *> &
	g©Œibu‹_Çme_·œ
 :

125 
kPršbËSecsA‰ribu‹B™Names
) {

126 ià(
©Œibu‹_Çme_·œ
.
fœ¡
 =ğ
©Œibu‹
) {

127  
©Œibu‹_Çme_·œ
.
£cÚd
;

135 
	gStusOr
<
	gSecsA‰ribu‹S‘
> 
MakeSecsA‰ribu‹S‘
(

136 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
) {

137 
SecsA‰ribu‹S‘
 
©Œibu‹_£t
;

138 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, &
©Œibu‹_£t
)) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

142  
	g©Œibu‹_£t
;

145 
CË¬SecsA‰ribu‹S‘
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

146 
	g©Œibu‹s
->
	gæags
 = 0;

147 
	g©Œibu‹s
->
	gxäm
 = 0;

150 
SecsA‰ribu‹S‘
 
	gİ”©Ü
|(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	glhs
,

151 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

152 
SecsA‰ribu‹S‘
 
	g»suÉ
;

153 
	g»suÉ
.
	gæags
 = 
lhs
.
æags
 | 
rhs
.flags;

154 
	g»suÉ
.
	gxäm
 = 
lhs
.
xäm
 | 
rhs
.xfrm;

156  
	g»suÉ
;

159 
	gSecsA‰ribu‹S‘
 &
	gİ”©Ü
|=(
SecsA‰ribu‹S‘
 &
lhs
,

160 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

161 
	glhs
.
	gæags
 |ğ
rhs
.
æags
;

162 
	glhs
.
	gxäm
 |ğ
rhs
.
xäm
;

164  
	glhs
;

167 
SecsA‰ribu‹S‘
 
	gİ”©Ü
&(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	glhs
,

168 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

169 
SecsA‰ribu‹S‘
 
	g»suÉ
;

170 
	g»suÉ
.
	gæags
 = 
lhs
.
æags
 & 
rhs
.flags;

171 
	g»suÉ
.
	gxäm
 = 
lhs
.
xäm
 & 
rhs
.xfrm;

173  
	g»suÉ
;

176 
	gSecsA‰ribu‹S‘
 &
	gİ”©Ü
&=(
SecsA‰ribu‹S‘
 &
lhs
,

177 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

178 
	glhs
.
	gæags
 &ğ
rhs
.
æags
;

179 
	glhs
.
	gxäm
 &ğ
rhs
.
xäm
;

181  
	glhs
;

184 
SecsA‰ribu‹S‘
 
	gİ”©Ü
~(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	gv®ue
) {

185 
SecsA‰ribu‹S‘
 
	gtmp
;

186 
	gtmp
.
	gæags
 = ~
v®ue
.
æags
;

187 
	gtmp
.
	gxäm
 = ~
v®ue
.
xäm
;

188  
	gtmp
;

191 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SecsA‰ribu‹S‘
 &
lhs
, cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

192  
memcmp
(&
lhs
, &
rhs
, (lhs)) == 0;

195 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SecsA‰ribu‹S‘
 &
lhs
, cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
) {

196  !(
	glhs
 =ğ
rhs
);

199 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

200 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

201 
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

202 
CË¬SecsA‰ribu‹S‘
(
©Œibu‹s
);

203 
SecsA‰ribu‹B™
 
	g©Œibu‹
 : 
©Œibu‹_li¡
) {

204 
size_t
 
b™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

205 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

206 
LOG
(
ERROR
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


208 << 
kNumSecsA‰ribu‹B™s
 - 1;

209  
	gçl£
;

211 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

212 
	g©Œibu‹s
->
	gæags
 |ğ(1ULL << 
b™_pos™iÚ
);

214 
	g©Œibu‹s
->
	gxäm
 |ğ(1ULL << (
b™_pos™iÚ
 - 
kNumFÏgsB™s
));

217  
	gŒue
;

220 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

221 cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
,

222 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
) {

223 
©Œibu‹_li¡
->
ş—r
();

224 
ušt32_t
 
	gi
 = 0; i < 
	gkNumFÏgsB™s
; i++) {

225 ià(
	g©Œibu‹s
.
	gæags
 & (1ULL << 
	gi
)) {

226 
	g©Œibu‹_li¡
->
push_back
(
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
));

229 
ušt32_t
 
	gi
 = 0; i < 
	gkNumXämB™s
; i++) {

230 ià(
	g©Œibu‹s
.
	gxäm
 & (1ULL << 
	gi
)) {

231 
	g©Œibu‹_li¡
->
push_back
(

232 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
 + 
kNumFÏgsB™s
));

235  
	gŒue
;

238 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

239 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

240 
A‰ribu‹s
 *
©Œibu‹s
) {

241 
	g©Œibu‹s
->
CË¬
();

242 
SecsA‰ribu‹B™
 
	g©Œibu‹
 : 
©Œibu‹_li¡
) {

243 
size_t
 
b™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

244 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

245 
LOG
(
ERROR
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


247 << 
kNumSecsA‰ribu‹B™s
 - 1;

248  
	gçl£
;

250 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

251 
	g©Œibu‹s
->
£t_æags
(
©Œibu‹s
->
æags
(è| (1ULL << 
b™_pos™iÚ
));

253 
	g©Œibu‹s
->
£t_xäm
(
©Œibu‹s
->
xäm
() |

254 (1ULL << (
b™_pos™iÚ
 - 
kNumFÏgsB™s
)));

257  
	gŒue
;

260 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

261 cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

262 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
) {

263 
©Œibu‹_li¡
->
ş—r
();

264 
ušt32_t
 
	gi
 = 0; i < 
	gkNumFÏgsB™s
; i++) {

265 ià(
	g©Œibu‹s
.
æags
(è& (1ULL << 
	gi
)) {

266 
	g©Œibu‹_li¡
->
push_back
(
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
));

269 
ušt32_t
 
	gi
 = 0; i < 
	gkNumXämB™s
; i++) {

270 ià(
	g©Œibu‹s
.
xäm
(è& (1ULL << 
	gi
)) {

271 
	g©Œibu‹_li¡
->
push_back
(

272 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(
i
 + 
kNumFÏgsB™s
));

275  
	gŒue
;

278 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s_£t
,

279 
A‰ribu‹s
 *
©Œibu‹s
) {

280 
	g©Œibu‹s
->
£t_æags
(
©Œibu‹s_£t
.
æags
);

281 
	g©Œibu‹s
->
£t_xäm
(
©Œibu‹s_£t
.
xäm
);

282  
	gŒue
;

285 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

286 
SecsA‰ribu‹S‘
 *
©Œibu‹s_£t
) {

287 
	g©Œibu‹s_£t
->
	gæags
 = 
©Œibu‹s
.
æags
();

288 
	g©Œibu‹s_£t
->
	gxäm
 = 
©Œibu‹s
.
xäm
();

289  
	gŒue
;

292 
boŞ
 
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
 
©Œibu‹
,

293 cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s_£t
) {

294 
size_t
 
	gb™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

295 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

296 
LOG
(
INFO
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


298 << 
kNumSecsA‰ribu‹B™s
 - 1;

299  
	gçl£
;

302 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

303  (
	g©Œibu‹s_£t
.
	gæags
 & (1ULL << 
	gb™_pos™iÚ
)) != 0;

305  (
	g©Œibu‹s_£t
.
	gxäm
 & (1ULL << (
	gb™_pos™iÚ
 - 
	gkNumFÏgsB™s
))) !=

310 
boŞ
 
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
 
©Œibu‹
, cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
) {

311 
size_t
 
	gb™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
©Œibu‹
);

312 ià(
	gb™_pos™iÚ
 >ğ
kNumSecsA‰ribu‹B™s
) {

313 
LOG
(
INFO
è<< "SecsA‰ribu‹B™ s³cif› ¨b™…os™iÚ " << 
b™_pos™iÚ


315 << 
kNumSecsA‰ribu‹B™s
 - 1;

316  
	gçl£
;

319 ià(
	gb™_pos™iÚ
 < 
	gkNumFÏgsB™s
) {

320  (
	g©Œibu‹s
.
æags
(è& (1ULL << 
	gb™_pos™iÚ
)) != 0;

322  (
	g©Œibu‹s
.
xäm
(è& (1ULL << (
	gb™_pos™iÚ
 - 
	gkNumFÏgsB™s
))) != 0;

326 
boŞ
 
G‘AÎSecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

327 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

328 
kAÎSecsA‰ribu‹s
, kAÎSecsA‰ribu‹ + 
¬¿ysize
(kAllSecsAttributes));

329  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

332 
boŞ
 
G‘AÎSecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
) {

333 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

334 
kAÎSecsA‰ribu‹s
, kAÎSecsA‰ribu‹ + 
¬¿ysize
(kAllSecsAttributes));

335  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

338 
boŞ
 
G‘Mu¡BeS‘SecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

339 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

340 
kMu¡BeS‘A‰ribu‹s
,

341 
kMu¡BeS‘A‰ribu‹s
 + 
¬¿ysize
(kMustBeSetAttributes));

342  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

345 
boŞ
 
G‘Mu¡BeS‘SecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
) {

346 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

347 
kMu¡BeS‘A‰ribu‹s
,

348 
kMu¡BeS‘A‰ribu‹s
 + 
¬¿ysize
(kMustBeSetAttributes));

349  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

352 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(

353 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
) {

354 *
©Œibu‹_li¡
 = 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
>(

355 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
,

356 
	gkDeçuÉDoNÙC¬eSecsA‰ribu‹s
 +

357 
¬¿ysize
(
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
));

358  
	gŒue
;

361 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
) {

362 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

363 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
,

364 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
 +

365 
¬¿ysize
(
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
));

366  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

369 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
) {

370 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
(

371 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
,

372 
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
 +

373 
¬¿ysize
(
kDeçuÉDoNÙC¬eSecsA‰ribu‹s
));

374  
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_li¡
, 
©Œibu‹s
);

377 
Stus
 
S‘DeçuÉSecsA‰ribu‹sMask
(
A‰ribu‹s
 *
©Œibu‹s_m©ch_mask
) {

378 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

379 ià(!
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
©Œibu‹s
)) {

380  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

385 ià(!
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(~
©Œibu‹s
, 
©Œibu‹s_m©ch_mask
)) {

386  
Stus
(

387 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

391  
	gStus
::
OkStus
();

394 
S‘SŒiùSecsA‰ribu‹sMask
(
A‰ribu‹s
 *
©Œibu‹s_m©ch_mask
) {

395 
	g©Œibu‹s_m©ch_mask
->
£t_æags
(
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
());

396 
	g©Œibu‹s_m©ch_mask
->
£t_xäm
(
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
());

399 
G‘PršbËA‰ribu‹Li¡
(

400 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

401 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
) {

402 
´šbË_li¡
->
ş—r
();

403 
SecsA‰ribu‹B™
 
	g©Œibu‹
 : 
©Œibu‹_li¡
) {

404 
´šbË_li¡
->
push_back
(
¡d
::
¡ršg
(
G‘A‰ribu‹Name
(
©Œibu‹
)));

408 
G‘PršbËA‰ribu‹Li¡
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
,

409 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
) {

410 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
;

411 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_li¡
);

412 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_li¡
, 
´šbË_li¡
);

415 
G‘PršbËA‰ribu‹Li¡
(cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

416 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
) {

417 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_li¡
;

418 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_li¡
);

419 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_li¡
, 
´šbË_li¡
);

	@identity/sgx/secs_attributes.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SECS_ATTRIBUTES_H_


20 
	#ASYLO_IDENTITY_SGX_SECS_ATTRIBUTES_H_


	)

22 
	~<c¡dšt
>

23 
	~<c¡ršg
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~"ab¦/ba£/©Œibu‹s.h
"

28 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

29 
	~"asylo/ut/¡©us.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	gsgx
 {

42 şas 
	cSecsA‰ribu‹B™
 {

43 
	gINIT
 = 0,

45 
	gDEBUG
 = 1,

47 
	gMODE64BIT
 = 2,

50 
	gPROVISIONKEY
 = 4,

52 
	gINITTOKENKEY
 = 5,

55 
	gKSS
 = 7,

71 
	gFPU
 = 64 + 0,

72 
	gSSE
 = 64 + 1,

73 
	gAVX
 = 64 + 2,

74 
	gBNDREG
 = 64 + 3,

75 
	gBNDCSR
 = 64 + 4,

76 
	gOPMASK
 = 64 + 5,

77 
	gZMM_HI256
 = 64 + 6,

78 
	gHI16_ZMM
 = 64 + 7,

80 
	gPKRU
 = 64 + 9

84 
	sSecsA‰ribu‹S‘
 {

85 
ušt64_t
 
	gæags
;

86 
ušt64_t
 
	gxäm
;

87 } 
	gABSL_ATTRIBUTE_PACKED
;

90 
	gStusOr
<
	gSecsA‰ribu‹S‘
> 
MakeSecsA‰ribu‹S‘
(

91 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
);

94 
CË¬SecsA‰ribu‹S‘
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
);

97 
SecsA‰ribu‹S‘
 
	gİ”©Ü
|(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	glhs
,

98 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
);

102 
	gSecsA‰ribu‹S‘
 &
	gİ”©Ü
|=(
SecsA‰ribu‹S‘
 &
lhs
,

103 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
);

106 
SecsA‰ribu‹S‘
 
	gİ”©Ü
&(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	glhs
,

107 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
);

111 
	gSecsA‰ribu‹S‘
 &
	gİ”©Ü
&=(
SecsA‰ribu‹S‘
 &
lhs
,

112 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
);

115 
SecsA‰ribu‹S‘
 
	gİ”©Ü
~(cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	gv®ue
);

118 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
SecsA‰ribu‹S‘
 &
lhs
, cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
);

121 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
SecsA‰ribu‹S‘
 &
lhs
, cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	grhs
);

124 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

125 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

126 
SecsA‰ribu‹S‘
 *
©Œibu‹s
);

129 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

130 cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
,

131 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
);

135 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

136 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

137 
A‰ribu‹s
 *
©Œibu‹s
);

141 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(

142 cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

143 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
);

146 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s_£t
,

147 
A‰ribu‹s
 *
©Œibu‹s
);

150 
boŞ
 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

151 
SecsA‰ribu‹S‘
 *
©Œibu‹s_£t
);

154 
boŞ
 
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
 
©Œibu‹
,

155 cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s_£t
);

159 
boŞ
 
Te¡A‰ribu‹
(
SecsA‰ribu‹B™
 
©Œibu‹
, cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
);

163 
boŞ
 
G‘AÎSecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
);

166 
boŞ
 
G‘AÎSecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
);

169 
boŞ
 
G‘Mu¡BeS‘SecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
);

172 
boŞ
 
G‘Mu¡BeS‘SecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
);

175 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(

176 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> *
©Œibu‹_li¡
);

179 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(
SecsA‰ribu‹S‘
 *
©Œibu‹s
);

182 
boŞ
 
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(
A‰ribu‹s
 *
©Œibu‹s
);

186 
Stus
 
S‘DeçuÉSecsA‰ribu‹sMask
(
A‰ribu‹s
 *
©Œibu‹s_m©ch_mask
);

190 
S‘SŒiùSecsA‰ribu‹sMask
(
A‰ribu‹s
 *
©Œibu‹s_m©ch_mask
);

193 
G‘PršbËA‰ribu‹Li¡
(

194 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> &
©Œibu‹_li¡
,

195 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
);

198 
G‘PršbËA‰ribu‹Li¡
(cÚ¡ 
SecsA‰ribu‹S‘
 &
©Œibu‹s
,

199 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
);

203 
G‘PršbËA‰ribu‹Li¡
(cÚ¡ 
A‰ribu‹s
 &
©Œibu‹s
,

204 
¡d
::
veùÜ
<¡d::
¡ršg
> *
´šbË_li¡
);

	@identity/sgx/secs_attributes_test.cc

19 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

21 
	~<s¡»am
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

28 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsgx
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎF
 = 0xFFFFFFFFFFFFFFFFULL;

39 şas 
	cSecsA‰ribu‹sTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
´Ùeùed
:

41 
SecsA‰ribu‹sTe¡
() {}

45 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹s_
 = {

46 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(0),

47 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(1),

48 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(2),

50 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(4),

51 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(5),

53 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(7),

55 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(64),

56 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(65),

57 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(66),

58 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(67),

59 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(68),

60 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(69),

61 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(70),

62 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(71),

64 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(73)

66 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
©Œibu‹_Çmes_
 = {

70 cÚ¡ 
	g¡d
::
veùÜ
<
SecsA‰ribu‹S‘
> 
©Œibu‹_£ts_
 = {

88 cÚ¡ 
SecsA‰ribu‹S‘
 
	g®l_©Œibu‹s_
 = {0xb7, 0x2FF};

89 cÚ¡ 
SecsA‰ribu‹B™
 
	gbad_©Œibu‹_
 = 
¡©ic_ÿ¡
<SecsAttributeBit>(129);

92 
	#EXPECT_LOG
(
TYPE
, 
MESSAGE
)

	)

95 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
CË¬SecsA‰ribu‹S‘
) {

96 
SecsA‰ribu‹S‘
 
	g£t
 : 
©Œibu‹_£ts_
) {

97 
CË¬SecsA‰ribu‹S‘
(&
£t
);

98 
EXPECT_EQ
(
£t
.
æags
, 0);

99 
EXPECT_EQ
(
£t
.
xäm
, 0);

102 
SecsA‰ribu‹S‘
 
	g£t
;

103 
	g£t
 = 
®l_©Œibu‹s_
;

104 
CË¬SecsA‰ribu‹S‘
(&
£t
);

105 
EXPECT_EQ
(
£t
.
æags
, 0);

106 
EXPECT_EQ
(
£t
.
xäm
, 0);

110 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Equ®™y
) {

111 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

112 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

113 
EXPECT_EQ
((
©Œibu‹s_
[
i
] =ğ©Œibu‹s_[
j
]), (i == j));

119 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
IÃqu®™y
) {

120 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

121 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

122 
EXPECT_EQ
((
©Œibu‹s_
[
i
] !ğ©Œibu‹s_[
j
]), (i != j));

128 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£Or
) {

129 
SecsA‰ribu‹S‘
 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

132 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

133 
»suÉ
 = 
£t
 | set;

134 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

135 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

139 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

140 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

141 
»suÉ
 =„esuÉ | 
£t
;

143 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

144 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

147 
	g»suÉ
 = 
»suÉ
 | 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

148 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

149 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

153 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£OrAssign
) {

154 
SecsA‰ribu‹S‘
 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

157 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

158 
»suÉ
 = 
£t
;

159 
	g»suÉ
 |ğ
£t
;

160 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

161 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

165 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

166 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

167 
»suÉ
 |ğ
£t
;

169 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

170 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

173 
	g»suÉ
 |ğ
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

174 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

175 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

179 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£And
) {

182 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

183 
SecsA‰ribu‹S‘
 
»suÉ
 = 
®l_©Œibu‹s_
 & 
£t
;

184 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

185 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

190 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

191 
SecsA‰ribu‹S‘
 
»suÉ
 = 
TrivŸlZ”oObjeù
<SecsA‰ribu‹S‘>(è& 
£t
;

192 
EXPECT_EQ
(
»suÉ
.
æags
, 0);

193 
EXPECT_EQ
(
»suÉ
.
xäm
, 0);

198 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£AndAssign
) {

201 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

202 
SecsA‰ribu‹S‘
 
»suÉ
 = 
®l_©Œibu‹s_
;

203 
	g»suÉ
 &ğ
£t
;

204 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

205 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

210 
SecsA‰ribu‹S‘
 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

211 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

212 
»suÉ
 &ğ
£t
;

213 
EXPECT_EQ
(
»suÉ
.
æags
, 0);

214 
EXPECT_EQ
(
»suÉ
.
xäm
, 0);

219 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£Neg©iÚ
) {

220 
SecsA‰ribu‹S‘
 
	gz”os
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

221 
SecsA‰ribu‹S‘
 
	gÚes
 = 
TrivŸlOÃsObjeù
<SecsAttributeSet>();

223 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

224 
EXPECT_EQ
(
£t
 & ~£t, 
z”os
);

225 
EXPECT_EQ
(
£t
 | ~£t, 
Úes
);

230 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToS‘
) {

231 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

232 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
©Œibu‹s_
[
i
]};

234 
SecsA‰ribu‹S‘
 
	g£t
;

235 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
£t
));

236 
EXPECT_EQ
(
£t
.
æags
, 
©Œibu‹_£ts_
[
i
].flags);

237 
EXPECT_EQ
(
£t
.
xäm
, 
©Œibu‹_£ts_
[
i
].xfrm);

240 
SecsA‰ribu‹S‘
 
	g£t
;

241 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_
, &
£t
));

242 
EXPECT_EQ
(
£t
.
æags
, 
®l_©Œibu‹s_
.flags);

243 
EXPECT_EQ
(
£t
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

247 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToS‘E¼Ü
) {

248 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
bad_©Œibu‹_
};

249 
	g¡d
::
¡ršg
 
¡r
 =

250 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

251 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

253 
EXPECT_LOG
(
ERROR
, 
¡r
);

254 
SecsA‰ribu‹S‘
 
	g£t
;

255 
EXPECT_FALSE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
£t
));

259 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘ToLi¡
) {

260 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
li¡
;

261 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

262 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
li¡
));

263 
EXPECT_EQ
(
li¡
.
size
(), 1);

264 
EXPECT_EQ
(
li¡
[0], 
©Œibu‹s_
[
i
]);

267 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
li¡
));

268 
EXPECT_EQ
(
li¡
.
size
(), 
©Œibu‹s_
.size());

269 
	gi
 = 0; i < 
	gli¡
.
size
(); i++) {

270 
EXPECT_EQ
(
li¡
[
i
], 
©Œibu‹s_
[i]);

275 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToA‰ribu‹s
) {

276 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

277 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
©Œibu‹s_
[
i
]};

279 
A‰ribu‹s
 
	g©Œibu‹s
;

280 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
©Œibu‹s
));

281 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
©Œibu‹_£ts_
[
i
].flags);

282 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
©Œibu‹_£ts_
[
i
].xfrm);

285 
A‰ribu‹s
 
	g©Œibu‹s
;

286 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

287 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
®l_©Œibu‹s_
.flags);

288 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
®l_©Œibu‹s_
.xfrm);

292 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToA‰ribu‹sE¼Ü
) {

293 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
bad_©Œibu‹_
};

294 
	g¡d
::
¡ršg
 
¡r
 =

295 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

296 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

298 
EXPECT_LOG
(
ERROR
, 
¡r
);

299 
A‰ribu‹s
 
	g©Œibu‹s
;

300 
EXPECT_FALSE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
©Œibu‹s
));

304 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
A‰ribu‹sToLi¡
) {

305 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
li¡
;

306 
A‰ribu‹s
 
	g©Œibu‹s
;

307 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

308 
	g©Œibu‹s
.
£t_æags
(
©Œibu‹_£ts_
[
i
].
æags
);

309 
	g©Œibu‹s
.
£t_xäm
(
©Œibu‹_£ts_
[
i
].
xäm
);

310 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
li¡
));

311 
EXPECT_EQ
(
li¡
.
size
(), 1);

312 
EXPECT_EQ
(
li¡
[0], 
©Œibu‹s_
[
i
]);

315 
	g©Œibu‹s
.
£t_æags
(
®l_©Œibu‹s_
.
æags
);

316 
	g©Œibu‹s
.
£t_xäm
(
®l_©Œibu‹s_
.
xäm
);

317 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
li¡
));

318 
EXPECT_EQ
(
li¡
.
size
(), 
©Œibu‹s_
.size());

319 
	gi
 = 0; i < 
	gli¡
.
size
(); i++) {

320 
EXPECT_EQ
(
li¡
[
i
], 
©Œibu‹s_
[i]);

325 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘ToA‰ribu‹s
) {

326 
A‰ribu‹s
 
	g©Œibu‹s
;

327 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

328 
A‰ribu‹s
 
	g©Œibu‹s
;

329 
EXPECT_TRUE
(

330 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
©Œibu‹s
));

331 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
©Œibu‹_£ts_
[
i
].flags);

332 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
©Œibu‹_£ts_
[
i
].xfrm);

335 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_
, &
©Œibu‹s
));

336 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
®l_©Œibu‹s_
.flags);

337 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
®l_©Œibu‹s_
.xfrm);

341 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
A‰ribu‹sToS‘
) {

342 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
li¡
;

343 
A‰ribu‹s
 
	g©Œibu‹s
;

344 
SecsA‰ribu‹S‘
 
	g©Œibu‹_£t
;

346 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

347 
	g©Œibu‹s
.
£t_æags
(
©Œibu‹_£ts_
[
i
].
æags
);

348 
	g©Œibu‹s
.
£t_xäm
(
©Œibu‹_£ts_
[
i
].
xäm
);

349 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_£t
));

350 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
©Œibu‹_£t
.flags);

351 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
©Œibu‹_£t
.xfrm);

354 
	g©Œibu‹s
.
£t_æags
(
®l_©Œibu‹s_
.
æags
);

355 
	g©Œibu‹s
.
£t_xäm
(
®l_©Œibu‹s_
.
xäm
);

356 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_£t
));

357 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
®l_©Œibu‹s_
.flags);

358 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
®l_©Œibu‹s_
.xfrm);

362 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹S‘
) {

363 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

364 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

365 
EXPECT_EQ
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
©Œibu‹_£ts_
[
i
]), (i == j));

368 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

369 
EXPECT_TRUE
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
®l_©Œibu‹s_
));

374 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹S‘E¼Ü
) {

375 
	g¡d
::
¡ršg
 
¡r
 =

376 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

377 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

380 
EXPECT_LOG
(
INFO
, 
¡r
);

382 
EXPECT_FALSE
(
Te¡A‰ribu‹
(
bad_©Œibu‹_
, 
®l_©Œibu‹s_
));

386 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹A‰ribu‹s
) {

387 
A‰ribu‹s
 
	g©Œibu‹s
;

388 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

389 
EXPECT_TRUE
(

390 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
©Œibu‹s
));

391 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

392 
EXPECT_EQ
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
©Œibu‹s
), (
i
 == j));

395 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

396 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

397 
EXPECT_TRUE
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
©Œibu‹s
));

402 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹A‰ribu‹sE¼Ü
) {

403 
	g¡d
::
¡ršg
 
¡r
 =

404 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

405 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

408 
EXPECT_LOG
(
INFO
, 
¡r
);

410 
A‰ribu‹s
 
	g©Œibu‹s
;

411 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

412 
EXPECT_FALSE
(
Te¡A‰ribu‹
(
bad_©Œibu‹_
, 
©Œibu‹s
));

416 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
MakeSecsA‰ribu‹S‘Pos™ive
) {

417 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
®l_©Œibu‹s_veùÜ
;

418 
ASSERT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
,

419 &
®l_©Œibu‹s_veùÜ
));

420 autØ
	gb™1
 : 
®l_©Œibu‹s_veùÜ
) {

421 
SecsA‰ribu‹S‘
 
©Œibu‹s
;

422 
ASYLO_ASSERT_OK_AND_ASSIGN
(
©Œibu‹s
, 
MakeSecsA‰ribu‹S‘
({
b™1
}));

423 autØ
	gb™2
 : 
®l_©Œibu‹s_veùÜ
) {

424 
EXPECT_EQ
(
Te¡A‰ribu‹
(
b™2
, 
©Œibu‹s
), (
b™1
 == bit2));

427 
EXPECT_THAT
(
MakeSecsA‰ribu‹S‘
({
bad_©Œibu‹_
}).
¡©us
(),

428 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

432 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
MakeSecsA‰ribu‹S‘Neg©ive
) {

433 
EXPECT_THAT
(
MakeSecsA‰ribu‹S‘
({
bad_©Œibu‹_
}).
¡©us
(),

434 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

439 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘DeçuÉSecsA‰ribu‹sMask
) {

440 
A‰ribu‹s
 
	g©Œibu‹s_m©ch_mask_veùÜ
;

441 
EXPECT_THAT
(
S‘DeçuÉSecsA‰ribu‹sMask
(&
©Œibu‹s_m©ch_mask_veùÜ
),

442 
IsOk
());

443 
SecsA‰ribu‹S‘
 
	g©Œibu‹s_m©ch_mask
;

444 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_m©ch_mask_veùÜ
,

445 &
©Œibu‹s_m©ch_mask
));

447 
SecsA‰ribu‹S‘
 
	gdo_nÙ_ÿ»_©Œibu‹s
;

448 
EXPECT_TRUE
(
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
do_nÙ_ÿ»_©Œibu‹s
));

450 
EXPECT_EQ
(~
©Œibu‹s_m©ch_mask
.
æags
, 
do_nÙ_ÿ»_©Œibu‹s
.flags);

451 
EXPECT_EQ
(~
©Œibu‹s_m©ch_mask
.
xäm
, 
do_nÙ_ÿ»_©Œibu‹s
.xfrm);

456 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘SŒiùSecsA‰ribu‹sMask
) {

457 
A‰ribu‹s
 
	g©Œibu‹s_m©ch_mask
;

458 
S‘SŒiùSecsA‰ribu‹sMask
(&
©Œibu‹s_m©ch_mask
);

460 
EXPECT_EQ
(
©Œibu‹s_m©ch_mask
.
æags
(), 
kLÚgLÚgAÎF
);

461 
EXPECT_EQ
(
©Œibu‹s_m©ch_mask
.
xäm
(), 
kLÚgLÚgAÎF
);

465 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
G‘PršbËA‰ribu‹Li¡FromLi¡
) {

466 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_li¡
;

468 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

469 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_b™_li¡
 = {
©Œibu‹s_
[
i
]};

470 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_b™_li¡
, &
´šbË_li¡
);

471 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 1);

472 
EXPECT_EQ
(
´šbË_li¡
[0], 
©Œibu‹_Çmes_
[
i
]);

475 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s_
, &
´šbË_li¡
);

476 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 
©Œibu‹s_
.size());

477 
	gi
 = 0; i < 
	g´šbË_li¡
.
size
(); i++) {

478 
EXPECT_EQ
(
´šbË_li¡
[
i
], 
©Œibu‹_Çmes_
[i]);

483 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
G‘PršbËA‰ribu‹Li¡FromS‘
) {

484 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_li¡
;

486 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

487 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_£ts_
[
i
], &
´šbË_li¡
);

488 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 1);

489 
EXPECT_EQ
(
´šbË_li¡
[0], 
©Œibu‹_Çmes_
[
i
]);

492 
G‘PršbËA‰ribu‹Li¡
(
®l_©Œibu‹s_
, &
´šbË_li¡
);

493 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 
©Œibu‹s_
.size());

494 
	gi
 = 0; i < 
	g´šbË_li¡
.
size
(); i++) {

495 
EXPECT_EQ
(
´šbË_li¡
[
i
], 
©Œibu‹_Çmes_
[i]);

500 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
G‘PršbËA‰ribu‹Li¡FromA‰ribu‹s
) {

501 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_li¡
;

502 
A‰ribu‹s
 
	g©Œibu‹s
;

504 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

505 
EXPECT_TRUE
(

506 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
©Œibu‹s
));

507 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_li¡
);

508 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 1);

509 
EXPECT_EQ
(
´šbË_li¡
[0], 
©Œibu‹_Çmes_
[
i
]);

512 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

513 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_li¡
);

514 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 
©Œibu‹s_
.size());

515 
	gi
 = 0; i < 
	g´šbË_li¡
.
size
(); i++) {

516 
EXPECT_EQ
(
´šbË_li¡
[
i
], 
©Œibu‹_Çmes_
[i]);

	@identity/sgx/secs_attributes_test.cc

19 
	~"asylo/id’t™y/sgx/£cs_©Œibu‹s.h
"

21 
	~<s¡»am
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

28 
	~"asylo/id’t™y/sgx/©Œibu‹s.pb.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsgx
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
ušt64_t
 
	gkLÚgLÚgAÎF
 = 0xFFFFFFFFFFFFFFFFULL;

39 şas 
	cSecsA‰ribu‹sTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
´Ùeùed
:

41 
SecsA‰ribu‹sTe¡
() {}

45 cÚ¡ 
¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹s_
 = {

46 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(0),

47 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(1),

48 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(2),

50 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(4),

51 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(5),

53 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(7),

55 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(64),

56 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(65),

57 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(66),

58 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(67),

59 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(68),

60 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(69),

61 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(70),

62 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(71),

64 
¡©ic_ÿ¡
<
SecsA‰ribu‹B™
>(73)

66 cÚ¡ 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
©Œibu‹_Çmes_
 = {

70 cÚ¡ 
	g¡d
::
veùÜ
<
SecsA‰ribu‹S‘
> 
©Œibu‹_£ts_
 = {

88 cÚ¡ 
SecsA‰ribu‹S‘
 
	g®l_©Œibu‹s_
 = {0xb7, 0x2FF};

89 cÚ¡ 
SecsA‰ribu‹B™
 
	gbad_©Œibu‹_
 = 
¡©ic_ÿ¡
<SecsAttributeBit>(129);

92 
	#EXPECT_LOG
(
TYPE
, 
MESSAGE
)

	)

95 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
CË¬SecsA‰ribu‹S‘
) {

96 
SecsA‰ribu‹S‘
 
	g£t
 : 
©Œibu‹_£ts_
) {

97 
CË¬SecsA‰ribu‹S‘
(&
£t
);

98 
EXPECT_EQ
(
£t
.
æags
, 0);

99 
EXPECT_EQ
(
£t
.
xäm
, 0);

102 
SecsA‰ribu‹S‘
 
	g£t
;

103 
	g£t
 = 
®l_©Œibu‹s_
;

104 
CË¬SecsA‰ribu‹S‘
(&
£t
);

105 
EXPECT_EQ
(
£t
.
æags
, 0);

106 
EXPECT_EQ
(
£t
.
xäm
, 0);

110 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Equ®™y
) {

111 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

112 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

113 
EXPECT_EQ
((
©Œibu‹s_
[
i
] =ğ©Œibu‹s_[
j
]), (i == j));

119 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
IÃqu®™y
) {

120 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

121 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

122 
EXPECT_EQ
((
©Œibu‹s_
[
i
] !ğ©Œibu‹s_[
j
]), (i != j));

128 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£Or
) {

129 
SecsA‰ribu‹S‘
 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

132 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

133 
»suÉ
 = 
£t
 | set;

134 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

135 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

139 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

140 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

141 
»suÉ
 =„esuÉ | 
£t
;

143 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

144 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

147 
	g»suÉ
 = 
»suÉ
 | 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

148 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

149 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

153 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£OrAssign
) {

154 
SecsA‰ribu‹S‘
 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

157 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

158 
»suÉ
 = 
£t
;

159 
	g»suÉ
 |ğ
£t
;

160 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

161 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

165 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

166 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

167 
»suÉ
 |ğ
£t
;

169 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

170 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

173 
	g»suÉ
 |ğ
TrivŸlZ”oObjeù
<
SecsA‰ribu‹S‘
>();

174 
EXPECT_EQ
(
»suÉ
.
æags
, 
®l_©Œibu‹s_
.flags);

175 
EXPECT_EQ
(
»suÉ
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

179 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£And
) {

182 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

183 
SecsA‰ribu‹S‘
 
»suÉ
 = 
®l_©Œibu‹s_
 & 
£t
;

184 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

185 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

190 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

191 
SecsA‰ribu‹S‘
 
»suÉ
 = 
TrivŸlZ”oObjeù
<SecsA‰ribu‹S‘>(è& 
£t
;

192 
EXPECT_EQ
(
»suÉ
.
æags
, 0);

193 
EXPECT_EQ
(
»suÉ
.
xäm
, 0);

198 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£AndAssign
) {

201 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

202 
SecsA‰ribu‹S‘
 
»suÉ
 = 
®l_©Œibu‹s_
;

203 
	g»suÉ
 &ğ
£t
;

204 
EXPECT_EQ
(
»suÉ
.
æags
, 
£t
.flags);

205 
EXPECT_EQ
(
»suÉ
.
xäm
, 
£t
.xfrm);

210 
SecsA‰ribu‹S‘
 
	g»suÉ
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

211 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

212 
»suÉ
 &ğ
£t
;

213 
EXPECT_EQ
(
»suÉ
.
æags
, 0);

214 
EXPECT_EQ
(
»suÉ
.
xäm
, 0);

219 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
B™wi£Neg©iÚ
) {

220 
SecsA‰ribu‹S‘
 
	gz”os
 = 
TrivŸlZ”oObjeù
<SecsAttributeSet>();

221 
SecsA‰ribu‹S‘
 
	gÚes
 = 
TrivŸlOÃsObjeù
<SecsAttributeSet>();

223 cÚ¡ 
	gSecsA‰ribu‹S‘
 &
	g£t
 : 
©Œibu‹_£ts_
) {

224 
EXPECT_EQ
(
£t
 & ~£t, 
z”os
);

225 
EXPECT_EQ
(
£t
 | ~£t, 
Úes
);

230 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToS‘
) {

231 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

232 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
©Œibu‹s_
[
i
]};

234 
SecsA‰ribu‹S‘
 
	g£t
;

235 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
£t
));

236 
EXPECT_EQ
(
£t
.
æags
, 
©Œibu‹_£ts_
[
i
].flags);

237 
EXPECT_EQ
(
£t
.
xäm
, 
©Œibu‹_£ts_
[
i
].xfrm);

240 
SecsA‰ribu‹S‘
 
	g£t
;

241 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_
, &
£t
));

242 
EXPECT_EQ
(
£t
.
æags
, 
®l_©Œibu‹s_
.flags);

243 
EXPECT_EQ
(
£t
.
xäm
, 
®l_©Œibu‹s_
.xfrm);

247 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToS‘E¼Ü
) {

248 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
bad_©Œibu‹_
};

249 
	g¡d
::
¡ršg
 
¡r
 =

250 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

251 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

253 
EXPECT_LOG
(
ERROR
, 
¡r
);

254 
SecsA‰ribu‹S‘
 
	g£t
;

255 
EXPECT_FALSE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
£t
));

259 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘ToLi¡
) {

260 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
li¡
;

261 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

262 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
li¡
));

263 
EXPECT_EQ
(
li¡
.
size
(), 1);

264 
EXPECT_EQ
(
li¡
[0], 
©Œibu‹s_
[
i
]);

267 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
li¡
));

268 
EXPECT_EQ
(
li¡
.
size
(), 
©Œibu‹s_
.size());

269 
	gi
 = 0; i < 
	gli¡
.
size
(); i++) {

270 
EXPECT_EQ
(
li¡
[
i
], 
©Œibu‹s_
[i]);

275 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToA‰ribu‹s
) {

276 
	gi
 = 0; i < 
	g©Œibu‹s_
.
size
(); i++) {

277 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
©Œibu‹s_
[
i
]};

279 
A‰ribu‹s
 
	g©Œibu‹s
;

280 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
©Œibu‹s
));

281 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
©Œibu‹_£ts_
[
i
].flags);

282 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
©Œibu‹_£ts_
[
i
].xfrm);

285 
A‰ribu‹s
 
	g©Œibu‹s
;

286 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

287 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
®l_©Œibu‹s_
.flags);

288 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
®l_©Œibu‹s_
.xfrm);

292 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Li¡ToA‰ribu‹sE¼Ü
) {

293 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
v
{
bad_©Œibu‹_
};

294 
	g¡d
::
¡ršg
 
¡r
 =

295 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

296 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

298 
EXPECT_LOG
(
ERROR
, 
¡r
);

299 
A‰ribu‹s
 
	g©Œibu‹s
;

300 
EXPECT_FALSE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
v
, &
©Œibu‹s
));

304 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
A‰ribu‹sToLi¡
) {

305 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
li¡
;

306 
A‰ribu‹s
 
	g©Œibu‹s
;

307 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

308 
	g©Œibu‹s
.
£t_æags
(
©Œibu‹_£ts_
[
i
].
æags
);

309 
	g©Œibu‹s
.
£t_xäm
(
©Œibu‹_£ts_
[
i
].
xäm
);

310 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
li¡
));

311 
EXPECT_EQ
(
li¡
.
size
(), 1);

312 
EXPECT_EQ
(
li¡
[0], 
©Œibu‹s_
[
i
]);

315 
	g©Œibu‹s
.
£t_æags
(
®l_©Œibu‹s_
.
æags
);

316 
	g©Œibu‹s
.
£t_xäm
(
®l_©Œibu‹s_
.
xäm
);

317 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
li¡
));

318 
EXPECT_EQ
(
li¡
.
size
(), 
©Œibu‹s_
.size());

319 
	gi
 = 0; i < 
	gli¡
.
size
(); i++) {

320 
EXPECT_EQ
(
li¡
[
i
], 
©Œibu‹s_
[i]);

325 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘ToA‰ribu‹s
) {

326 
A‰ribu‹s
 
	g©Œibu‹s
;

327 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

328 
A‰ribu‹s
 
	g©Œibu‹s
;

329 
EXPECT_TRUE
(

330 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
©Œibu‹s
));

331 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
©Œibu‹_£ts_
[
i
].flags);

332 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
©Œibu‹_£ts_
[
i
].xfrm);

335 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_
, &
©Œibu‹s
));

336 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
®l_©Œibu‹s_
.flags);

337 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
®l_©Œibu‹s_
.xfrm);

341 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
A‰ribu‹sToS‘
) {

342 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
li¡
;

343 
A‰ribu‹s
 
	g©Œibu‹s
;

344 
SecsA‰ribu‹S‘
 
	g©Œibu‹_£t
;

346 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

347 
	g©Œibu‹s
.
£t_æags
(
©Œibu‹_£ts_
[
i
].
æags
);

348 
	g©Œibu‹s
.
£t_xäm
(
©Œibu‹_£ts_
[
i
].
xäm
);

349 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_£t
));

350 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
©Œibu‹_£t
.flags);

351 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
©Œibu‹_£t
.xfrm);

354 
	g©Œibu‹s
.
£t_æags
(
®l_©Œibu‹s_
.
æags
);

355 
	g©Œibu‹s
.
£t_xäm
(
®l_©Œibu‹s_
.
xäm
);

356 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s
, &
©Œibu‹_£t
));

357 
EXPECT_EQ
(
©Œibu‹s
.
æags
(), 
®l_©Œibu‹s_
.flags);

358 
EXPECT_EQ
(
©Œibu‹s
.
xäm
(), 
®l_©Œibu‹s_
.xfrm);

362 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹S‘
) {

363 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

364 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

365 
EXPECT_EQ
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
©Œibu‹_£ts_
[
i
]), (i == j));

368 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

369 
EXPECT_TRUE
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
®l_©Œibu‹s_
));

374 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹S‘E¼Ü
) {

375 
	g¡d
::
¡ršg
 
¡r
 =

376 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

377 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

380 
EXPECT_LOG
(
INFO
, 
¡r
);

382 
EXPECT_FALSE
(
Te¡A‰ribu‹
(
bad_©Œibu‹_
, 
®l_©Œibu‹s_
));

386 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹A‰ribu‹s
) {

387 
A‰ribu‹s
 
	g©Œibu‹s
;

388 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

389 
EXPECT_TRUE
(

390 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
©Œibu‹s
));

391 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

392 
EXPECT_EQ
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
©Œibu‹s
), (
i
 == j));

395 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

396 
	gj
 = 0; j < 
	g©Œibu‹s_
.
size
(); j++) {

397 
EXPECT_TRUE
(
Te¡A‰ribu‹
(
©Œibu‹s_
[
j
], 
©Œibu‹s
));

402 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
Te¡A‰ribu‹A‰ribu‹sE¼Ü
) {

403 
	g¡d
::
¡ršg
 
¡r
 =

404 
ab¦
::
SŒC©
("SecsAttributeBit specifies‡ bit…osition ",

405 
¡©ic_ÿ¡
<
size_t
>(
bad_©Œibu‹_
),

408 
EXPECT_LOG
(
INFO
, 
¡r
);

410 
A‰ribu‹s
 
	g©Œibu‹s
;

411 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

412 
EXPECT_FALSE
(
Te¡A‰ribu‹
(
bad_©Œibu‹_
, 
©Œibu‹s
));

416 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
MakeSecsA‰ribu‹S‘Pos™ive
) {

417 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
®l_©Œibu‹s_veùÜ
;

418 
ASSERT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
,

419 &
®l_©Œibu‹s_veùÜ
));

420 autØ
	gb™1
 : 
®l_©Œibu‹s_veùÜ
) {

421 
SecsA‰ribu‹S‘
 
©Œibu‹s
;

422 
ASYLO_ASSERT_OK_AND_ASSIGN
(
©Œibu‹s
, 
MakeSecsA‰ribu‹S‘
({
b™1
}));

423 autØ
	gb™2
 : 
®l_©Œibu‹s_veùÜ
) {

424 
EXPECT_EQ
(
Te¡A‰ribu‹
(
b™2
, 
©Œibu‹s
), (
b™1
 == bit2));

427 
EXPECT_THAT
(
MakeSecsA‰ribu‹S‘
({
bad_©Œibu‹_
}).
¡©us
(),

428 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

432 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
MakeSecsA‰ribu‹S‘Neg©ive
) {

433 
EXPECT_THAT
(
MakeSecsA‰ribu‹S‘
({
bad_©Œibu‹_
}).
¡©us
(),

434 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

439 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘DeçuÉSecsA‰ribu‹sMask
) {

440 
A‰ribu‹s
 
	g©Œibu‹s_m©ch_mask_veùÜ
;

441 
EXPECT_THAT
(
S‘DeçuÉSecsA‰ribu‹sMask
(&
©Œibu‹s_m©ch_mask_veùÜ
),

442 
IsOk
());

443 
SecsA‰ribu‹S‘
 
	g©Œibu‹s_m©ch_mask
;

444 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹s_m©ch_mask_veùÜ
,

445 &
©Œibu‹s_m©ch_mask
));

447 
SecsA‰ribu‹S‘
 
	gdo_nÙ_ÿ»_©Œibu‹s
;

448 
EXPECT_TRUE
(
G‘DeçuÉDoNÙC¬eSecsA‰ribu‹s
(&
do_nÙ_ÿ»_©Œibu‹s
));

450 
EXPECT_EQ
(~
©Œibu‹s_m©ch_mask
.
æags
, 
do_nÙ_ÿ»_©Œibu‹s
.flags);

451 
EXPECT_EQ
(~
©Œibu‹s_m©ch_mask
.
xäm
, 
do_nÙ_ÿ»_©Œibu‹s
.xfrm);

456 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
S‘SŒiùSecsA‰ribu‹sMask
) {

457 
A‰ribu‹s
 
	g©Œibu‹s_m©ch_mask
;

458 
S‘SŒiùSecsA‰ribu‹sMask
(&
©Œibu‹s_m©ch_mask
);

460 
EXPECT_EQ
(
©Œibu‹s_m©ch_mask
.
æags
(), 
kLÚgLÚgAÎF
);

461 
EXPECT_EQ
(
©Œibu‹s_m©ch_mask
.
xäm
(), 
kLÚgLÚgAÎF
);

465 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
G‘PršbËA‰ribu‹Li¡FromLi¡
) {

466 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_li¡
;

468 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

469 
	g¡d
::
veùÜ
<
SecsA‰ribu‹B™
> 
©Œibu‹_b™_li¡
 = {
©Œibu‹s_
[
i
]};

470 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_b™_li¡
, &
´šbË_li¡
);

471 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 1);

472 
EXPECT_EQ
(
´šbË_li¡
[0], 
©Œibu‹_Çmes_
[
i
]);

475 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s_
, &
´šbË_li¡
);

476 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 
©Œibu‹s_
.size());

477 
	gi
 = 0; i < 
	g´šbË_li¡
.
size
(); i++) {

478 
EXPECT_EQ
(
´šbË_li¡
[
i
], 
©Œibu‹_Çmes_
[i]);

483 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
G‘PršbËA‰ribu‹Li¡FromS‘
) {

484 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_li¡
;

486 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

487 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹_£ts_
[
i
], &
´šbË_li¡
);

488 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 1);

489 
EXPECT_EQ
(
´šbË_li¡
[0], 
©Œibu‹_Çmes_
[
i
]);

492 
G‘PršbËA‰ribu‹Li¡
(
®l_©Œibu‹s_
, &
´šbË_li¡
);

493 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 
©Œibu‹s_
.size());

494 
	gi
 = 0; i < 
	g´šbË_li¡
.
size
(); i++) {

495 
EXPECT_EQ
(
´šbË_li¡
[
i
], 
©Œibu‹_Çmes_
[i]);

500 
TEST_F
(
SecsA‰ribu‹sTe¡
, 
G‘PršbËA‰ribu‹Li¡FromA‰ribu‹s
) {

501 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
´šbË_li¡
;

502 
A‰ribu‹s
 
	g©Œibu‹s
;

504 
	gi
 = 0; i < 
	g©Œibu‹_£ts_
.
size
(); i++) {

505 
EXPECT_TRUE
(

506 
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
©Œibu‹_£ts_
[
i
], &
©Œibu‹s
));

507 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_li¡
);

508 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 1);

509 
EXPECT_EQ
(
´šbË_li¡
[0], 
©Œibu‹_Çmes_
[
i
]);

512 
EXPECT_TRUE
(
CÚv”tSecsA‰ribu‹R•»£Á©iÚ
(
®l_©Œibu‹s_
, &
©Œibu‹s
));

513 
G‘PršbËA‰ribu‹Li¡
(
©Œibu‹s
, &
´šbË_li¡
);

514 
EXPECT_EQ
(
´šbË_li¡
.
size
(), 
©Œibu‹s_
.size());

515 
	gi
 = 0; i < 
	g´šbË_li¡
.
size
(); i++) {

516 
EXPECT_EQ
(
´šbË_li¡
[
i
], 
©Œibu‹_Çmes_
[i]);

	@identity/sgx/secs_miscselect.cc

19 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

21 
	~"asylo/ut/¡©us.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	gsgx
 {

25 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
SecsMisc£ËùB™
 
	gkAÎSecsMisc£ËùB™s
[] = {

29 
SecsMisc£ËùB™
::
EXINFO
};

31 
	g¡d
::
¡ršg
 
G‘Misc£ËùB™Name
(
SecsMisc£ËùB™
 
misc£Ëù_b™
) {

32 
misc£Ëù_b™
) {

33 
SecsMisc£ËùB™
::
EXINFO
:

42 
	gStusOr
<
	gboŞ
> 
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
 
misc£Ëù_b™
,

43 
ušt32_t
 
misc£Ëù
) {

44 
size_t
 
	gb™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
misc£Ëù_b™
);

45 ià(
	gb™_pos™iÚ
 >= 32) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

51  (
	gmisc£Ëù
 & (
UINT32_C
(1è<< 
	gb™_pos™iÚ
)) != 0;

54 
	gStusOr
<
	gboŞ
> 
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
 
misc£Ëù_b™
,

55 cÚ¡ 
Misc£Ëù
 &
misc£Ëù
) {

56  
Te¡Misc£ËùB™
(
misc£Ëù_b™
, 
misc£Ëù
.
v®ue
());

59 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G‘PršbËMisc£ËùLi¡
(
ušt32_t
 
misc£Ëù
) {

60 
¡d
::
veùÜ
<¡d::
¡ršg
> 
´šbË_misc£Ëù_li¡
;

61 
SecsMisc£ËùB™
 
	gmisc£Ëù_b™
 : 
kAÎSecsMisc£ËùB™s
) {

62 
size_t
 
b™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
misc£Ëù_b™
);

63 ià((
	gmisc£Ëù
 & (
UINT32_C
(1è<< 
	gb™_pos™iÚ
)) != 0) {

64 
´šbË_misc£Ëù_li¡
.
em¶aû_back
(

65 
G‘Misc£ËùB™Name
(
misc£Ëù_b™
));

68  
	g´šbË_misc£Ëù_li¡
;

71 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G‘PršbËMisc£ËùLi¡
(

72 cÚ¡ 
Misc£Ëù
 &
misc£Ëù
) {

73  
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
.
v®ue
());

	@identity/sgx/secs_miscselect.cc

19 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

21 
	~"asylo/ut/¡©us.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	gsgx
 {

25 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
SecsMisc£ËùB™
 
	gkAÎSecsMisc£ËùB™s
[] = {

29 
SecsMisc£ËùB™
::
EXINFO
};

31 
	g¡d
::
¡ršg
 
G‘Misc£ËùB™Name
(
SecsMisc£ËùB™
 
misc£Ëù_b™
) {

32 
misc£Ëù_b™
) {

33 
SecsMisc£ËùB™
::
EXINFO
:

42 
	gStusOr
<
	gboŞ
> 
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
 
misc£Ëù_b™
,

43 
ušt32_t
 
misc£Ëù
) {

44 
size_t
 
	gb™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
misc£Ëù_b™
);

45 ià(
	gb™_pos™iÚ
 >= 32) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

51  (
	gmisc£Ëù
 & (
UINT32_C
(1è<< 
	gb™_pos™iÚ
)) != 0;

54 
	gStusOr
<
	gboŞ
> 
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
 
misc£Ëù_b™
,

55 cÚ¡ 
Misc£Ëù
 &
misc£Ëù
) {

56  
Te¡Misc£ËùB™
(
misc£Ëù_b™
, 
misc£Ëù
.
v®ue
());

59 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G‘PršbËMisc£ËùLi¡
(
ušt32_t
 
misc£Ëù
) {

60 
¡d
::
veùÜ
<¡d::
¡ršg
> 
´šbË_misc£Ëù_li¡
;

61 
SecsMisc£ËùB™
 
	gmisc£Ëù_b™
 : 
kAÎSecsMisc£ËùB™s
) {

62 
size_t
 
b™_pos™iÚ
 = 
¡©ic_ÿ¡
<size_t>(
misc£Ëù_b™
);

63 ià((
	gmisc£Ëù
 & (
UINT32_C
(1è<< 
	gb™_pos™iÚ
)) != 0) {

64 
´šbË_misc£Ëù_li¡
.
em¶aû_back
(

65 
G‘Misc£ËùB™Name
(
misc£Ëù_b™
));

68  
	g´šbË_misc£Ëù_li¡
;

71 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G‘PršbËMisc£ËùLi¡
(

72 cÚ¡ 
Misc£Ëù
 &
misc£Ëù
) {

73  
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
.
v®ue
());

	@identity/sgx/secs_miscselect.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SECS_MISCSELECT_H_


20 
	#ASYLO_IDENTITY_SGX_SECS_MISCSELECT_H_


	)

22 
	~<c¡dšt
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~"asylo/id’t™y/sgx/misc£Ëù.pb.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsgx
 {

36 şas 
	cSecsMisc£ËùB™
 {

39 
	gEXINFO
 = 0,

43 
cÚ¡ex´
 
ušt32_t
 
	gkMisc£ËùExšfoMask
 =

44 
¡©ic_ÿ¡
<
ušt32_t
>(1è<< stic_ÿ¡<
size_t
>(
SecsMisc£ËùB™
::
EXINFO
);

47 
cÚ¡ex´
 
ušt32_t
 
	gkMisc£ËùAÎB™s
 = 
kMisc£ËùExšfoMask
;

48 
cÚ¡ex´
 
ušt32_t
 
	gkMisc£ËùRe£rvedB™s
 = ~
kMisc£ËùAÎB™s
;

52 
	gStusOr
<
	gboŞ
> 
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
 
misc£Ëù_b™
,

53 
ušt32_t
 
misc£Ëù
);

57 
	gStusOr
<
	gboŞ
> 
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
 
misc£Ëù_b™
,

58 cÚ¡ 
Misc£Ëù
 &
misc£Ëù
);

62 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G‘PršbËMisc£ËùLi¡
(
ušt32_t
 
misc£Ëù
);

66 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
G‘PršbËMisc£ËùLi¡
(

67 cÚ¡ 
Misc£Ëù
 &
misc£Ëù
);

	@identity/sgx/secs_miscselect_test.cc

19 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

21 
	~<c¡dšt
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
EËm’tsA»
;

32 
	gusšg
 ::
‹¡šg
::
IsEm±y
;

35 
TEST
(
SecsMisc£ËùTe¡
, 
Te¡Misc£ËùB™Inv®id
) {

36 
ušt32_t
 
	gmisc£Ëù
 = 0;

37 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
¡©ic_ÿ¡
<
SecsMisc£ËùB™
>(32), 
misc£Ëù
)

38 .
¡©us
(),

39 
StusIs
(
asylo
::
”rÜ
::
INVALID_ARGUMENT
));

41 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

42 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

43 
EXPECT_THAT
(

44 
Te¡Misc£ËùB™
(
¡©ic_ÿ¡
<
SecsMisc£ËùB™
>(32), 
misc£Ëù_´Ùo
)

45 .
¡©us
(),

46 
StusIs
(
asylo
::
”rÜ
::
INVALID_ARGUMENT
));

49 
TEST
(
SecsMisc£ËùTe¡
, 
Te¡Misc£ËùB™F®£
) {

50 
ušt32_t
 
	gmisc£Ëù
 = 0;

51 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù
),

52 
IsOkAndHŞds
(
çl£
));

54 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

55 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

56 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù_´Ùo
),

57 
IsOkAndHŞds
(
çl£
));

60 
TEST
(
SecsMisc£ËùTe¡
, 
Te¡Misc£ËùB™True
) {

61 
ušt32_t
 
	gmisc£Ëù
 = 
UINT32_C
(1)

62 << 
¡©ic_ÿ¡
<
size_t
>(
SecsMisc£ËùB™
::
EXINFO
);

63 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù
),

64 
IsOkAndHŞds
(
Œue
));

66 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

67 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

68 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù_´Ùo
),

69 
IsOkAndHŞds
(
Œue
));

72 
TEST
(
SecsMisc£ËùTe¡
, 
G‘PršbËMisc£ËùLi¡Em±y
) {

73 
ušt32_t
 
	gmisc£Ëù
 = 0;

74 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
), 
IsEm±y
());

76 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

77 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

78 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù_´Ùo
), 
IsEm±y
());

81 
TEST
(
SecsMisc£ËùTe¡
, 
G‘PršbËMisc£ËùLi¡NÚem±y
) {

82 
ušt32_t
 
	gmisc£Ëù
 = 
UINT32_C
(1)

83 << 
¡©ic_ÿ¡
<
size_t
>(
SecsMisc£ËùB™
::
EXINFO
);

84 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
), 
EËm’tsA»
("EXINFO"));

86 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

87 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

88 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù_´Ùo
),

89 
EËm’tsA»
("EXINFO"));

	@identity/sgx/secs_miscselect_test.cc

19 
	~"asylo/id’t™y/sgx/£cs_misc£Ëù.h
"

21 
	~<c¡dšt
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
EËm’tsA»
;

32 
	gusšg
 ::
‹¡šg
::
IsEm±y
;

35 
TEST
(
SecsMisc£ËùTe¡
, 
Te¡Misc£ËùB™Inv®id
) {

36 
ušt32_t
 
	gmisc£Ëù
 = 0;

37 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
¡©ic_ÿ¡
<
SecsMisc£ËùB™
>(32), 
misc£Ëù
)

38 .
¡©us
(),

39 
StusIs
(
asylo
::
”rÜ
::
INVALID_ARGUMENT
));

41 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

42 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

43 
EXPECT_THAT
(

44 
Te¡Misc£ËùB™
(
¡©ic_ÿ¡
<
SecsMisc£ËùB™
>(32), 
misc£Ëù_´Ùo
)

45 .
¡©us
(),

46 
StusIs
(
asylo
::
”rÜ
::
INVALID_ARGUMENT
));

49 
TEST
(
SecsMisc£ËùTe¡
, 
Te¡Misc£ËùB™F®£
) {

50 
ušt32_t
 
	gmisc£Ëù
 = 0;

51 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù
),

52 
IsOkAndHŞds
(
çl£
));

54 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

55 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

56 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù_´Ùo
),

57 
IsOkAndHŞds
(
çl£
));

60 
TEST
(
SecsMisc£ËùTe¡
, 
Te¡Misc£ËùB™True
) {

61 
ušt32_t
 
	gmisc£Ëù
 = 
UINT32_C
(1)

62 << 
¡©ic_ÿ¡
<
size_t
>(
SecsMisc£ËùB™
::
EXINFO
);

63 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù
),

64 
IsOkAndHŞds
(
Œue
));

66 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

67 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

68 
EXPECT_THAT
(
Te¡Misc£ËùB™
(
SecsMisc£ËùB™
::
EXINFO
, 
misc£Ëù_´Ùo
),

69 
IsOkAndHŞds
(
Œue
));

72 
TEST
(
SecsMisc£ËùTe¡
, 
G‘PršbËMisc£ËùLi¡Em±y
) {

73 
ušt32_t
 
	gmisc£Ëù
 = 0;

74 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
), 
IsEm±y
());

76 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

77 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

78 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù_´Ùo
), 
IsEm±y
());

81 
TEST
(
SecsMisc£ËùTe¡
, 
G‘PršbËMisc£ËùLi¡NÚem±y
) {

82 
ušt32_t
 
	gmisc£Ëù
 = 
UINT32_C
(1)

83 << 
¡©ic_ÿ¡
<
size_t
>(
SecsMisc£ËùB™
::
EXINFO
);

84 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù
), 
EËm’tsA»
("EXINFO"));

86 
Misc£Ëù
 
	gmisc£Ëù_´Ùo
;

87 
	gmisc£Ëù_´Ùo
.
£t_v®ue
(
misc£Ëù
);

88 
EXPECT_THAT
(
G‘PršbËMisc£ËùLi¡
(
misc£Ëù_´Ùo
),

89 
EËm’tsA»
("EXINFO"));

	@identity/sgx/self_identity.cc

19 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

21 
	~"asylo/id’t™y/sgx/£lf_id’t™y_š‹º®.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	gsgx
 {

26 cÚ¡ 
S–fId’t™y
 *
G‘S–fId’t™y
() {

27 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
Ãw
 SelfIdentity();

28  
	g£lf_id’t™y
;

	@identity/sgx/self_identity.cc

19 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

21 
	~"asylo/id’t™y/sgx/£lf_id’t™y_š‹º®.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	gsgx
 {

26 cÚ¡ 
S–fId’t™y
 *
G‘S–fId’t™y
() {

27 
S–fId’t™y
 *
	g£lf_id’t™y
 = 
Ãw
 SelfIdentity();

28  
	g£lf_id’t™y
;

	@identity/sgx/self_identity.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SELF_IDENTITY_H_


20 
	#ASYLO_IDENTITY_SGX_SELF_IDENTITY_H_


	)

22 
	~"asylo/üy±o/ut/by‹s.h
"

23 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

24 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

29 
	sS–fId’t™y
 {

30 
S–fId’t™y
();

31 ~
S–fId’t™y
() = ;

34 
	gUn§ãBy‹s
<
	gkCpusvnSize
> 
	gıusvn
;

35 
ušt32_t
 
	gmisc£Ëù
;

36 
SecsA‰ribu‹S‘
 
	g©Œibu‹s
;

37 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gm»nşave
;

38 
	gUn§ãBy‹s
<
	gSHA256_DIGEST_LENGTH
> 
	gmrsigÃr
;

39 
ušt16_t
 
	gisv´odid
;

40 
ušt16_t
 
	gisvsvn
;

43 
CodeId’t™y
 
	gid’t™y
;

48 cÚ¡ 
S–fId’t™y
 *
G‘S–fId’t™y
();

	@identity/sgx/self_identity_internal.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SELF_IDENTITY_INTERNAL_H_


20 
	#ASYLO_IDENTITY_SGX_SELF_IDENTITY_INTERNAL_H_


	)

25 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

26 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

27 
	~"asylo/ut/loggšg.h
"

28 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

29 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

30 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	gsgx
 {

37 
	gS–fId’t™y
::
S–fId’t™y
() {

38 
AligÃdT¬g‘šfoPŒ
 
tšfo
;

39 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

40 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

42 *
	gtšfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

43 *
	g»pÜtd©a
 = 
TrivŸlZ”oObjeù
<
R•Ütd©a
>();

45 
Stus
 
	g¡©us
 = 
G‘H¬dw¬eR•Üt
(*
tšfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
());

46 ià(!
	g¡©us
.
ok
()) {

47 
LOG
(
FATAL
è<< "G‘H¬dw¬eR•Üt(èçed: " << 
	g¡©us
;

50 
	gıusvn
 = 
»pÜt
->
ıusvn
;

51 
	gmisc£Ëù
 = 
»pÜt
->
misc£Ëù
;

52 
	g©Œibu‹s
 = 
»pÜt
->
©Œibu‹s
;

53 
	gm»nşave
 = 
»pÜt
->
m»nşave
;

54 
	gmrsigÃr
 = 
»pÜt
->
mrsigÃr
;

55 
	gisv´odid
 = 
»pÜt
->
isv´odid
;

56 
	gisvsvn
 = 
»pÜt
->
isvsvn
;

58 
	g¡©us
 = 
P¬£Id’t™yFromH¬dw¬eR•Üt
(*
»pÜt
, &
id’t™y
);

59 ià(!
	g¡©us
.
ok
()) {

60 
LOG
(
FATAL
è<< 
	g¡©us
;

	@identity/sgx/sgx_code_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/sgx/sgx_code_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~"asylo/id’t™y/desütiÚs.h
"

22 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

24 
Çme¥aû
 
	gasylo
 {

26 
	gStusOr
<
	gboŞ
> 
	gSgxCodeId’t™yEx³ù©iÚM©ch”
::
M©ch
(

27 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

28 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) const {

29 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

30 
Stus
 
	g¡©us
 = 
sgx
::
P¬£SgxId’t™y
(
id’t™y
, &
code_id’t™y
);

31 ià(!
	g¡©us
.
ok
()) {

33  
	g¡©us
;

36 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

37 
	g¡©us
 = 
sgx
::
P¬£SgxEx³ù©iÚ
(
ex³ù©iÚ
, &
code_id’t™y_ex³ù©iÚ
);

38 ià(!
	g¡©us
.
ok
()) {

41  
	g¡©us
;

44  
	gsgx
::
M©chId’t™yToEx³ù©iÚ
(
code_id’t™y
,

45 
code_id’t™y_ex³ù©iÚ
);

48 
EnşaveId’t™yDesütiÚ
 
	gSgxCodeId’t™yEx³ù©iÚM©ch”
::
DesütiÚ
()

50 
EnşaveId’t™yDesütiÚ
 
desütiÚ
;

51 
S‘SgxId’t™yDesütiÚ
(&
desütiÚ
);

52  
	gdesütiÚ
;

56 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

57 
SgxCodeId’t™yEx³ù©iÚM©ch”
);

	@identity/sgx/sgx_code_identity_expectation_matcher.cc

19 
	~"asylo/id’t™y/sgx/sgx_code_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~"asylo/id’t™y/desütiÚs.h
"

22 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

24 
Çme¥aû
 
	gasylo
 {

26 
	gStusOr
<
	gboŞ
> 
	gSgxCodeId’t™yEx³ù©iÚM©ch”
::
M©ch
(

27 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

28 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
) const {

29 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

30 
Stus
 
	g¡©us
 = 
sgx
::
P¬£SgxId’t™y
(
id’t™y
, &
code_id’t™y
);

31 ià(!
	g¡©us
.
ok
()) {

33  
	g¡©us
;

36 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

37 
	g¡©us
 = 
sgx
::
P¬£SgxEx³ù©iÚ
(
ex³ù©iÚ
, &
code_id’t™y_ex³ù©iÚ
);

38 ià(!
	g¡©us
.
ok
()) {

41  
	g¡©us
;

44  
	gsgx
::
M©chId’t™yToEx³ù©iÚ
(
code_id’t™y
,

45 
code_id’t™y_ex³ù©iÚ
);

48 
EnşaveId’t™yDesütiÚ
 
	gSgxCodeId’t™yEx³ù©iÚM©ch”
::
DesütiÚ
()

50 
EnşaveId’t™yDesütiÚ
 
desütiÚ
;

51 
S‘SgxId’t™yDesütiÚ
(&
desütiÚ
);

52  
	gdesütiÚ
;

56 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
Id’t™yEx³ù©iÚM©ch”M­
,

57 
SgxCodeId’t™yEx³ù©iÚM©ch”
);

	@identity/sgx/sgx_code_identity_expectation_matcher.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SGX_CODE_IDENTITY_EXPECTATION_MATCHER_H_


20 
	#ASYLO_IDENTITY_SGX_SGX_CODE_IDENTITY_EXPECTATION_MATCHER_H_


	)

22 
	~"asylo/id’t™y/id’t™y.pb.h
"

23 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

25 
Çme¥aû
 
	gasylo
 {

29 şas 
	cSgxCodeId’t™yEx³ù©iÚM©ch”
 
	gfš®


30 : 
public
 
NamedId’t™yEx³ù©iÚM©ch”
 {

31 
public
:

32 
SgxCodeId’t™yEx³ù©iÚM©ch”
() = ;

33 ~
SgxCodeId’t™yEx³ù©iÚM©ch”
(è
	gov”ride
 = ;

36 
	gStusOr
<
	gboŞ
> 
M©ch
(

37 cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

38 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
ècÚ¡ 
	gov”ride
;

41 
EnşaveId’t™yDesütiÚ
 
DesütiÚ
(ècÚ¡ 
	gov”ride
;

	@identity/sgx/sgx_code_identity_expectation_matcher_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_code_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/id’t™y/id’t™y.pb.h
"

24 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

25 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

26 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y_‹¡_ut.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

37 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Exi¡sInSticM­
) {

38 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

39 
	gdesütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

40 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
sgx
::
kSgxAuthÜiz©iÚAuthÜ™y
);

42 autØ
	gm©ch”_™
 = 
Id’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

43 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(
desütiÚ
)

44 .
V®ueOrD›
());

45 
ASSERT_NE
(
m©ch”_™
, 
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
());

49 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”CheckDesütiÚ
) {

50 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

51 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
id’t™y_ty³
(), 
CODE_IDENTITY
);

52 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
authÜ™y_ty³
(),

53 
sgx
::
kSgxAuthÜiz©iÚAuthÜ™y
);

58 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Pos™ive
) {

59 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

60 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

61 
ASSERT_THAT
(
sgx
::
S‘RªdomV®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
,

62 &
code_id’t™y_ex³ù©iÚ
),

63 
IsOk
());

65 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

66 
	gStusOr
<
	gboŞ
> 
	gm©ch”_»suÉ
 =

67 
m©ch”
.
M©ch
(
ex³ù©iÚ
.
»ã»nû_id’t™y
(),ƒxpectation);

68 
ASSERT_THAT
(
m©ch”_»suÉ
, 
IsOk
())

69 << 
	gcode_id’t™y_ex³ù©iÚ
.
ShÜtDebugSŒšg
();

70 
EXPECT_TRUE
(
m©ch”_»suÉ
.
V®ueOrD›
())

71 << 
	gcode_id’t™y_ex³ù©iÚ
.
ShÜtDebugSŒšg
();

76 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Inv®idId’t™y
) {

77 
EnşaveId’t™y
 
	gid’t™y
;

78 
	gsgx
::
S‘RªdomInv®idG’”icId’t™y
(&
id’t™y
);

80 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

81 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

82 
	gsgx
::
S‘RªdomV®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
,

83 &
code_id’t™y_ex³ù©iÚ
);

85 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

86 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
NÙ
(
IsOk
()))

87 << 
	gid’t™y
.
ShÜtDebugSŒšg
()

88 << 
	gcode_id’t™y_ex³ù©iÚ
.
ShÜtDebugSŒšg
();

93 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Inv®idEx³ù©iÚ
) {

94 
EnşaveId’t™y
 
	gid’t™y
;

95 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

96 
	gsgx
::
S‘RªdomV®idG’”icId’t™y
(&
id’t™y
, &
code_id’t™y
);

98 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

99 
ASSERT_THAT
(
sgx
::
S‘RªdomInv®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
), 
IsOk
());

101 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

102 
ASSERT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
NÙ
(
IsOk
()))

103 << 
	gcode_id’t™y
.
ShÜtDebugSŒšg
(è<< 
	gex³ù©iÚ
.ShortDebugString();

108 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Inv®idId’t™yEx³ù©iÚ
) {

109 
EnşaveId’t™y
 
	gid’t™y
;

110 
	gsgx
::
S‘RªdomInv®idG’”icId’t™y
(&
id’t™y
);

112 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

113 
ASSERT_THAT
(
sgx
::
S‘RªdomInv®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
), 
IsOk
());

115 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

116 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
NÙ
(
IsOk
()))

117 << 
	gid’t™y
.
ShÜtDebugSŒšg
(è<< 
	gex³ù©iÚ
.ShortDebugString();

	@identity/sgx/sgx_code_identity_expectation_matcher_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_code_id’t™y_ex³ù©iÚ_m©ch”.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/id’t™y/id’t™y.pb.h
"

24 
	~"asylo/id’t™y/Çmed_id’t™y_ex³ù©iÚ_m©ch”.h
"

25 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

26 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y_‹¡_ut.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

37 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Exi¡sInSticM­
) {

38 
EnşaveId’t™yDesütiÚ
 
	gdesütiÚ
;

39 
	gdesütiÚ
.
£t_id’t™y_ty³
(
CODE_IDENTITY
);

40 
	gdesütiÚ
.
£t_authÜ™y_ty³
(
sgx
::
kSgxAuthÜiz©iÚAuthÜ™y
);

42 autØ
	gm©ch”_™
 = 
Id’t™yEx³ù©iÚM©ch”M­
::
G‘V®ue
(

43 
NamedId’t™yEx³ù©iÚM©ch”
::
G‘M©ch”Name
(
desütiÚ
)

44 .
V®ueOrD›
());

45 
ASSERT_NE
(
m©ch”_™
, 
Id’t™yEx³ù©iÚM©ch”M­
::
v®ue_’d
());

49 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”CheckDesütiÚ
) {

50 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

51 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
id’t™y_ty³
(), 
CODE_IDENTITY
);

52 
EXPECT_EQ
(
m©ch”
.
DesütiÚ
().
authÜ™y_ty³
(),

53 
sgx
::
kSgxAuthÜiz©iÚAuthÜ™y
);

58 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Pos™ive
) {

59 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

60 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

61 
ASSERT_THAT
(
sgx
::
S‘RªdomV®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
,

62 &
code_id’t™y_ex³ù©iÚ
),

63 
IsOk
());

65 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

66 
	gStusOr
<
	gboŞ
> 
	gm©ch”_»suÉ
 =

67 
m©ch”
.
M©ch
(
ex³ù©iÚ
.
»ã»nû_id’t™y
(),ƒxpectation);

68 
ASSERT_THAT
(
m©ch”_»suÉ
, 
IsOk
())

69 << 
	gcode_id’t™y_ex³ù©iÚ
.
ShÜtDebugSŒšg
();

70 
EXPECT_TRUE
(
m©ch”_»suÉ
.
V®ueOrD›
())

71 << 
	gcode_id’t™y_ex³ù©iÚ
.
ShÜtDebugSŒšg
();

76 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Inv®idId’t™y
) {

77 
EnşaveId’t™y
 
	gid’t™y
;

78 
	gsgx
::
S‘RªdomInv®idG’”icId’t™y
(&
id’t™y
);

80 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

81 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

82 
	gsgx
::
S‘RªdomV®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
,

83 &
code_id’t™y_ex³ù©iÚ
);

85 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

86 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
NÙ
(
IsOk
()))

87 << 
	gid’t™y
.
ShÜtDebugSŒšg
()

88 << 
	gcode_id’t™y_ex³ù©iÚ
.
ShÜtDebugSŒšg
();

93 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Inv®idEx³ù©iÚ
) {

94 
EnşaveId’t™y
 
	gid’t™y
;

95 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

96 
	gsgx
::
S‘RªdomV®idG’”icId’t™y
(&
id’t™y
, &
code_id’t™y
);

98 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

99 
ASSERT_THAT
(
sgx
::
S‘RªdomInv®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
), 
IsOk
());

101 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

102 
ASSERT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
NÙ
(
IsOk
()))

103 << 
	gcode_id’t™y
.
ShÜtDebugSŒšg
(è<< 
	gex³ù©iÚ
.ShortDebugString();

108 
TEST
(
SgxCodeId’t™yEx³ù©iÚM©ch”Te¡
, 
M©ch”Inv®idId’t™yEx³ù©iÚ
) {

109 
EnşaveId’t™y
 
	gid’t™y
;

110 
	gsgx
::
S‘RªdomInv®idG’”icId’t™y
(&
id’t™y
);

112 
EnşaveId’t™yEx³ù©iÚ
 
	gex³ù©iÚ
;

113 
ASSERT_THAT
(
sgx
::
S‘RªdomInv®idG’”icEx³ù©iÚ
(&
ex³ù©iÚ
), 
IsOk
());

115 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gm©ch”
;

116 
EXPECT_THAT
(
m©ch”
.
M©ch
(
id’t™y
, 
ex³ù©iÚ
), 
NÙ
(
IsOk
()))

117 << 
	gid’t™y
.
ShÜtDebugSŒšg
(è<< 
	gex³ù©iÚ
.ShortDebugString();

	@identity/sgx/sgx_local_assertion_authority_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/id’t™y/id’t™y.pb.h
"

22 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

23 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

24 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

25 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_g’”©Ü.h
"

26 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_v”if›r.h
"

27 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

28 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkU£rD©a
[] = "User data";

38 
şass
 
	gSgxLoÿlAs£¹iÚAuthÜ™yTe¡


39 : 
public
 ::
‹¡šg
::
Te¡
,

40 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
< 
boŞ
> {

41 
´Ùeùed
:

42 
S‘Up
(è
ov”ride
 {

43 
cÚfig_
 = 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
().
cÚfig
();

46 
	gg’”©Ü_’şave_
.
S‘RªdomId’t™y
();

48 ià(
G‘P¬am
()) {

50 
	gv”if›r_’şave_
 = 
g’”©Ü_’şave_
;

53 
	gv”if›r_’şave_
.
S‘RªdomId’t™y
();

57 
T—rDown
(è
	gov”ride
 {

61 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

64 
	g¡d
::
¡ršg
 
cÚfig_
;

67 
	gsgx
::
FakeEnşave
 
g’”©Ü_’şave_
;

70 
	gsgx
::
FakeEnşave
 
v”if›r_’şave_
;

77 
INSTANTIATE_TEST_SUITE_P
(
RªdomizedEnşaves
, 
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
,

78  ::
‹¡šg
::
BoŞ
());

82 
TEST_P
(
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
, 
CªG’”©e
) {

83 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

85 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

86 
ASSERT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

88 
As£¹iÚReque¡
 
	g»que¡
;

89 
ASSERT_THAT
(
v”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

91 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

92 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

94 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

95 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

96 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
Œue
));

101 
TEST_P
(
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
, 
CªV”ify
) {

102 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

104 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

105 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

107 
As£¹iÚOfãr
 
	gofãr
;

108 
ASSERT_THAT
(
g’”©Ü
.
C»©eAs£¹iÚOfãr
(&
ofãr
), 
IsOk
());

110 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

111 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

113 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

114 
ASSERT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

115 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
Œue
));

120 
TEST_P
(
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
, 
V”ifyAs£¹iÚSameEnşave
) {

121 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

123 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

124 
ASSERT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

126 
As£¹iÚReque¡
 
	g»que¡
;

127 
	gv”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
);

129 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

130 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

132 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

133 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

135 
As£¹iÚ
 
	gas£¹iÚ
;

136 
ASSERT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
»que¡
, &
as£¹iÚ
), 
IsOk
());

138 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

139 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

142 
EnşaveId’t™y
 
	gid’t™y
;

143 
ASSERT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
IsOk
());

145 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

146 
ASSERT_TRUE
(
code_id’t™y
.
P¬£FromSŒšg
(
id’t™y
.identity()));

148 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

149 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

152 
EXPECT_THAT
(
code_id’t™y
, 
Equ®sPrÙo
(
sgx
::
G‘S–fId’t™y
()->
id’t™y
))

154 << 
code_id’t™y
.
DebugSŒšg
() << "\nExpected identity:\n"

155 << 
sgx
::
G‘S–fId’t™y
()->
id’t™y
.
DebugSŒšg
();

	@identity/sgx/sgx_local_assertion_authority_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/id’t™y/id’t™y.pb.h
"

22 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

23 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

24 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

25 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_g’”©Ü.h
"

26 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_v”if›r.h
"

27 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

28 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
cÚ¡ex´
 
	gkU£rD©a
[] = "User data";

38 
şass
 
	gSgxLoÿlAs£¹iÚAuthÜ™yTe¡


39 : 
public
 ::
‹¡šg
::
Te¡
,

40 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
< 
boŞ
> {

41 
´Ùeùed
:

42 
S‘Up
(è
ov”ride
 {

43 
cÚfig_
 = 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
().
cÚfig
();

46 
	gg’”©Ü_’şave_
.
S‘RªdomId’t™y
();

48 ià(
G‘P¬am
()) {

50 
	gv”if›r_’şave_
 = 
g’”©Ü_’şave_
;

53 
	gv”if›r_’şave_
.
S‘RªdomId’t™y
();

57 
T—rDown
(è
	gov”ride
 {

61 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

64 
	g¡d
::
¡ršg
 
cÚfig_
;

67 
	gsgx
::
FakeEnşave
 
g’”©Ü_’şave_
;

70 
	gsgx
::
FakeEnşave
 
v”if›r_’şave_
;

77 
INSTANTIATE_TEST_SUITE_P
(
RªdomizedEnşaves
, 
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
,

78  ::
‹¡šg
::
BoŞ
());

82 
TEST_P
(
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
, 
CªG’”©e
) {

83 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

85 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

86 
ASSERT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

88 
As£¹iÚReque¡
 
	g»que¡
;

89 
ASSERT_THAT
(
v”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
), 
IsOk
());

91 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

92 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

94 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

95 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

96 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
»que¡
), 
IsOkAndHŞds
(
Œue
));

101 
TEST_P
(
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
, 
CªV”ify
) {

102 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

104 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

105 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

107 
As£¹iÚOfãr
 
	gofãr
;

108 
ASSERT_THAT
(
g’”©Ü
.
C»©eAs£¹iÚOfãr
(&
ofãr
), 
IsOk
());

110 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

111 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

113 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

114 
ASSERT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

115 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
Œue
));

120 
TEST_P
(
SgxLoÿlAs£¹iÚAuthÜ™yTe¡
, 
V”ifyAs£¹iÚSameEnşave
) {

121 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

123 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

124 
ASSERT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

126 
As£¹iÚReque¡
 
	g»que¡
;

127 
	gv”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
);

129 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

130 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

132 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

133 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

135 
As£¹iÚ
 
	gas£¹iÚ
;

136 
ASSERT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
»que¡
, &
as£¹iÚ
), 
IsOk
());

138 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

139 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
v”if›r_’şave_
);

142 
EnşaveId’t™y
 
	gid’t™y
;

143 
ASSERT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
IsOk
());

145 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

146 
ASSERT_TRUE
(
code_id’t™y
.
P¬£FromSŒšg
(
id’t™y
.identity()));

148 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

149 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(
g’”©Ü_’şave_
);

152 
EXPECT_THAT
(
code_id’t™y
, 
Equ®sPrÙo
(
sgx
::
G‘S–fId’t™y
()->
id’t™y
))

154 << 
code_id’t™y
.
DebugSŒšg
() << "\nExpected identity:\n"

155 << 
sgx
::
G‘S–fId’t™y
()->
id’t™y
.
DebugSŒšg
();

	@identity/sgx/sgx_local_assertion_generator.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_g’”©Ü.h
"

21 
	~<¡ršg
>

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

24 
	~"asylo/üy±o/sha256_hash.h
"

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

28 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

29 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

30 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

31 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

32 
	~"asylo/ut/¡©us_maüos.h
"

34 
Çme¥aû
 
	gasylo
 {

36 cÚ¡ *cÚ¡ 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
authÜ™y_ty³_
 =

37 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
;

39 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
SgxLoÿlAs£¹iÚG’”©Ü
()

40 : 
š™Ÿlized_
(
çl£
) {}

42 
Stus
 
SgxLoÿlAs£¹iÚG’”©Ü
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

43 ià(
IsIn™Ÿlized
()) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

48 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

49 ià(!
	gauthÜ™y_cÚfig
.
P¬£FromSŒšg
(
cÚfig
)) {

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

54 ià(!
	gauthÜ™y_cÚfig
.
has_©‹¡©iÚ_domaš
()) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

59 
	g©‹¡©iÚ_domaš_
 = 
authÜ™y_cÚfig
.
©‹¡©iÚ_domaš
();

61 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

62 
	gš™Ÿlized_
 = 
Œue
;

64  
	gStus
::
OkStus
();

67 
boŞ
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
IsIn™Ÿlized
() const {

68 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

69  
	gš™Ÿlized_
;

72 
EnşaveId’t™yTy³
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
Id’t™yTy³
() const {

73  
id’t™y_ty³_
;

76 
	g¡d
::
¡ršg
 
SgxLoÿlAs£¹iÚG’”©Ü
::
AuthÜ™yTy³
() const {

77  
authÜ™y_ty³_
;

80 
Stus
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
C»©eAs£¹iÚOfãr
(

81 
As£¹iÚOfãr
 *
ofãr
) const {

82 ià(!
IsIn™Ÿlized
()) {

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

86 
	gofãr
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

87 
	gofãr
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

89 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

90 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(
©‹¡©iÚ_domaš_
);

91 ià(!
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

92 
ofãr
->
mubË_add™iÚ®_šfÜm©iÚ
())) {

93  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

97  
	gStus
::
OkStus
();

100 
	gStusOr
<
	gboŞ
> 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
CªG’”©e
(

101 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

102 ià(!
IsIn™Ÿlized
()) {

103  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

106 
	gStusOr
<
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
> 
add™iÚ®_šfo_»suÉ
 =

107 
P¬£Add™iÚ®Info
(
»que¡
);

109 ià(!
	gadd™iÚ®_šfo_»suÉ
.
ok
()) {

110  
	gadd™iÚ®_šfo_»suÉ
.
¡©us
();

113 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
 =

114 
add™iÚ®_šfo_»suÉ
.
V®ueOrD›
();

116  
	gadd™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(è=ğ
©‹¡©iÚ_domaš_
;

119 
Stus
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
G’”©e
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

120 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
,

121 
As£¹iÚ
 *
as£¹iÚ
) const {

122 ià(!
IsIn™Ÿlized
()) {

123  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

126 
	gStusOr
<
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
> 
add™iÚ®_šfo_»suÉ
 =

127 
P¬£Add™iÚ®Info
(
»que¡
);

128 ià(!
	gadd™iÚ®_šfo_»suÉ
.
ok
()) {

129  
	gadd™iÚ®_šfo_»suÉ
.
¡©us
();

132 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
 =

133 
add™iÚ®_šfo_»suÉ
.
V®ueOrD›
();

135 ià(
	gadd™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(è!ğ
©‹¡©iÚ_domaš_
) {

136  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

148 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
tšfo
;

149 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
sgx
::
T¬g‘šfo
>(

150 
add™iÚ®_šfo
.
rg‘šfo
(), 
tšfo
.
g‘
()));

158 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

159 
Sha256Hash
 
	ghash
;

160 
	ghash
.
Upd©e
(
u£r_d©a
);

161 
	g»pÜtd©a
->
	gd©a
 = 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<
sgx
::
kR•Ütd©aSize
>>();

162 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

163 
ASYLO_RETURN_IF_ERROR
(
hash
.
CumuÏtiveHash
(&
dige¡
));

164 
	g»pÜtd©a
->
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

168 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

169 
ASYLO_RETURN_IF_ERROR
(

170 
sgx
::
G‘H¬dw¬eR•Üt
(*
tšfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

178 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

179 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(*
»pÜt
));

181 ià(!
	gloÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
->
mubË_as£¹iÚ
())) {

182  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

185 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

186 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

188  
	gStus
::
OkStus
();

191 
	gStusOr
<
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
>

192 
SgxLoÿlAs£¹iÚG’”©Ü
::
P¬£Add™iÚ®Info
(

193 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

194 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
»que¡
.
desütiÚ
())) {

195  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

199 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

200 ià(!
	gadd™iÚ®_šfo
.
P¬£FromSŒšg
(
»que¡
.
add™iÚ®_šfÜm©iÚ
())) {

201  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

205  
	gadd™iÚ®_šfo
;

209 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚG’”©ÜM­
,

210 
SgxLoÿlAs£¹iÚG’”©Ü
);

	@identity/sgx/sgx_local_assertion_generator.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_g’”©Ü.h
"

21 
	~<¡ršg
>

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

24 
	~"asylo/üy±o/sha256_hash.h
"

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

27 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

28 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

29 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

30 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

31 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

32 
	~"asylo/ut/¡©us_maüos.h
"

34 
Çme¥aû
 
	gasylo
 {

36 cÚ¡ *cÚ¡ 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
authÜ™y_ty³_
 =

37 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
;

39 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
SgxLoÿlAs£¹iÚG’”©Ü
()

40 : 
š™Ÿlized_
(
çl£
) {}

42 
Stus
 
SgxLoÿlAs£¹iÚG’”©Ü
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

43 ià(
IsIn™Ÿlized
()) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

48 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

49 ià(!
	gauthÜ™y_cÚfig
.
P¬£FromSŒšg
(
cÚfig
)) {

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

54 ià(!
	gauthÜ™y_cÚfig
.
has_©‹¡©iÚ_domaš
()) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

59 
	g©‹¡©iÚ_domaš_
 = 
authÜ™y_cÚfig
.
©‹¡©iÚ_domaš
();

61 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

62 
	gš™Ÿlized_
 = 
Œue
;

64  
	gStus
::
OkStus
();

67 
boŞ
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
IsIn™Ÿlized
() const {

68 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

69  
	gš™Ÿlized_
;

72 
EnşaveId’t™yTy³
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
Id’t™yTy³
() const {

73  
id’t™y_ty³_
;

76 
	g¡d
::
¡ršg
 
SgxLoÿlAs£¹iÚG’”©Ü
::
AuthÜ™yTy³
() const {

77  
authÜ™y_ty³_
;

80 
Stus
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
C»©eAs£¹iÚOfãr
(

81 
As£¹iÚOfãr
 *
ofãr
) const {

82 ià(!
IsIn™Ÿlized
()) {

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

86 
	gofãr
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

87 
	gofãr
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

89 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

90 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(
©‹¡©iÚ_domaš_
);

91 ià(!
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

92 
ofãr
->
mubË_add™iÚ®_šfÜm©iÚ
())) {

93  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

97  
	gStus
::
OkStus
();

100 
	gStusOr
<
	gboŞ
> 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
CªG’”©e
(

101 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

102 ià(!
IsIn™Ÿlized
()) {

103  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

106 
	gStusOr
<
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
> 
add™iÚ®_šfo_»suÉ
 =

107 
P¬£Add™iÚ®Info
(
»que¡
);

109 ià(!
	gadd™iÚ®_šfo_»suÉ
.
ok
()) {

110  
	gadd™iÚ®_šfo_»suÉ
.
¡©us
();

113 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
 =

114 
add™iÚ®_šfo_»suÉ
.
V®ueOrD›
();

116  
	gadd™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(è=ğ
©‹¡©iÚ_domaš_
;

119 
Stus
 
	gSgxLoÿlAs£¹iÚG’”©Ü
::
G’”©e
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

120 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
,

121 
As£¹iÚ
 *
as£¹iÚ
) const {

122 ià(!
IsIn™Ÿlized
()) {

123  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

126 
	gStusOr
<
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
> 
add™iÚ®_šfo_»suÉ
 =

127 
P¬£Add™iÚ®Info
(
»que¡
);

128 ià(!
	gadd™iÚ®_šfo_»suÉ
.
ok
()) {

129  
	gadd™iÚ®_šfo_»suÉ
.
¡©us
();

132 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
 =

133 
add™iÚ®_šfo_»suÉ
.
V®ueOrD›
();

135 ià(
	gadd™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(è!ğ
©‹¡©iÚ_domaš_
) {

136  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

148 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
tšfo
;

149 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
sgx
::
T¬g‘šfo
>(

150 
add™iÚ®_šfo
.
rg‘šfo
(), 
tšfo
.
g‘
()));

158 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

159 
Sha256Hash
 
	ghash
;

160 
	ghash
.
Upd©e
(
u£r_d©a
);

161 
	g»pÜtd©a
->
	gd©a
 = 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<
sgx
::
kR•Ütd©aSize
>>();

162 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

163 
ASYLO_RETURN_IF_ERROR
(
hash
.
CumuÏtiveHash
(&
dige¡
));

164 
	g»pÜtd©a
->
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

168 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

169 
ASYLO_RETURN_IF_ERROR
(

170 
sgx
::
G‘H¬dw¬eR•Üt
(*
tšfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

178 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

179 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(*
»pÜt
));

181 ià(!
	gloÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
->
mubË_as£¹iÚ
())) {

182  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

185 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

186 
	gas£¹iÚ
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

188  
	gStus
::
OkStus
();

191 
	gStusOr
<
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
>

192 
SgxLoÿlAs£¹iÚG’”©Ü
::
P¬£Add™iÚ®Info
(

193 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const {

194 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
»que¡
.
desütiÚ
())) {

195  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

199 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

200 ià(!
	gadd™iÚ®_šfo
.
P¬£FromSŒšg
(
»que¡
.
add™iÚ®_šfÜm©iÚ
())) {

201  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

205  
	gadd™iÚ®_šfo
;

209 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚG’”©ÜM­
,

210 
SgxLoÿlAs£¹iÚG’”©Ü
);

	@identity/sgx/sgx_local_assertion_generator.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SGX_LOCAL_ASSERTION_GENERATOR_H_


20 
	#ASYLO_IDENTITY_SGX_SGX_LOCAL_ASSERTION_GENERATOR_H_


	)

22 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

24 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

25 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

35 şas 
	cSgxLoÿlAs£¹iÚG’”©Ü
 
	gfš®
 : 
public
 
EnşaveAs£¹iÚG’”©Ü
 {

36 
public
:

40 
SgxLoÿlAs£¹iÚG’”©Ü
();

46 
Stus
 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
è
ov”ride
;

48 
boŞ
 
IsIn™Ÿlized
(ècÚ¡ 
	gov”ride
;

50 
EnşaveId’t™yTy³
 
Id’t™yTy³
(ècÚ¡ 
	gov”ride
;

52 
	g¡d
::
¡ršg
 
AuthÜ™yTy³
(ècÚ¡ 
ov”ride
;

58 
Stus
 
C»©eAs£¹iÚOfãr
(
As£¹iÚOfãr
 *
ofãr
ècÚ¡ 
	gov”ride
;

60 
	gStusOr
<
	gboŞ
> 
CªG’”©e
(cÚ¡ 
As£¹iÚReque¡
 &
»que¡
ècÚ¡ 
	gov”ride
;

62 
Stus
 
G’”©e
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
, cÚ¡ 
As£¹iÚReque¡
 &
»que¡
,

63 
As£¹iÚ
 *
as£¹iÚ
ècÚ¡ 
	gov”ride
;

65 
	g´iv©e
:

69 
StusOr
<
sgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
> 
P¬£Add™iÚ®Info
(

70 cÚ¡ 
As£¹iÚReque¡
 &
»que¡
) const;

73 
cÚ¡ex´
 
EnşaveId’t™yTy³
 
	gid’t™y_ty³_
 = 
CODE_IDENTITY
;

76 cÚ¡ *cÚ¡ 
	gauthÜ™y_ty³_
;

79 
	g¡d
::
¡ršg
 
©‹¡©iÚ_domaš_
;

82 
boŞ
 
š™Ÿlized_
 
GUARDED_BY
(
š™Ÿlized_mu_
);

85 
mubË
 
	gab¦
::
Mu‹x
 
š™Ÿlized_mu_
;

	@identity/sgx/sgx_local_assertion_generator_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_g’”©Ü.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"asylo/üy±o/sha256_hash.h
"

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

33 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

34 
	~"asylo/id’t™y/id’t™y.pb.h
"

35 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

36 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

37 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

38 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

39 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

40 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

41 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

42 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

44 
Çme¥aû
 
	gasylo
 {

45 
	gÇme¥aû
 {

47 
	gusšg
 ::
‹¡šg
::
NÙ
;

49 
cÚ¡ex´
 
	gkBadCÚfig
[] = "Not‡„eal config";

51 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš1
[] = "A 16-byte string";

52 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš2
[] = "A superb string!";

54 
cÚ¡ex´
 
	gkBadAuthÜ™y
[] = "Foobar Assertion Authority";

55 
cÚ¡ex´
 
	gkBadAdd™iÚ®Info
[] = "Invalid‡dditional info";

57 cÚ¡ 
	gkU£rD©a
[] = "User data";

61 şas 
	cSgxLoÿlAs£¹iÚG’”©ÜTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

62 
´Ùeùed
:

63 
S‘Up
(è
ov”ride
 {

64 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
authÜ™y_cÚfig
;

65 
	gauthÜ™y_cÚfig
.
£t_©‹¡©iÚ_domaš
(
kLoÿlA‰e¡©iÚDomaš1
);

66 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

71 
S‘As£¹iÚDesütiÚ
(
As£¹iÚDesütiÚ
 *
desütiÚ
) {

72 
	gdesütiÚ
->
£t_id’t™y_ty³
(
CODE_IDENTITY
);

73 
	gdesütiÚ
->
£t_authÜ™y_ty³
(
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

78 
S‘As£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
 
id’t™y_ty³
,

79 
ab¦
::
¡ršg_v›w
 
authÜ™y_ty³
,

80 
As£¹iÚDesütiÚ
 *
desütiÚ
) {

81 
	gdesütiÚ
->
£t_id’t™y_ty³
(
id’t™y_ty³
);

82 
	gdesütiÚ
->
£t_authÜ™y_ty³
(
authÜ™y_ty³
.
d©a
(),

83 
authÜ™y_ty³
.
size
());

89 
boŞ
 
MakeAs£¹iÚReque¡
(
ab¦
::
¡ršg_v›w
 
rg‘šfo
,

90 
ab¦
::
¡ršg_v›w
 
loÿl_©‹¡©iÚ_domaš
,

91 
As£¹iÚReque¡
 *
»que¡
) {

92 
S‘As£¹iÚDesütiÚ
(
»que¡
->
mubË_desütiÚ
());

94 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

95 
	gadd™iÚ®_šfo
.
£t_rg‘šfo
(
rg‘šfo
.
d©a
(),¬g‘šfo.
size
());

96 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(

97 
loÿl_©‹¡©iÚ_domaš
.
d©a
(),†oÿl_©‹¡©iÚ_domaš.
size
());

99  
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

100 
»que¡
->
mubË_add™iÚ®_šfÜm©iÚ
());

106 
boŞ
 
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(

107 
ab¦
::
¡ršg_v›w
 
loÿl_©‹¡©iÚ_domaš
, 
As£¹iÚReque¡
 *
»que¡
) {

108 
	gsgx
::
T¬g‘šfo
 
rg‘šfo
 = 
TrivŸlZ”oObjeù
<
sgx
::Targetinfo>();

112 
	grg‘šfo
.
	gm—su»m’t
 =

113 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

115  
MakeAs£¹iÚReque¡
(

116 
ab¦
::
¡ršg_v›w
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
rg‘šfo
),

117 (
rg‘šfo
)),

118 
loÿl_©‹¡©iÚ_domaš
, 
»que¡
);

122 
	g¡d
::
¡ršg
 
cÚfig_
;

127 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
G’”©ÜFoundInSticM­
) {

128 autØ
	gauthÜ™y_id_»suÉ
 = 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

129 
CODE_IDENTITY
, 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

131 
ASSERT_THAT
(
authÜ™y_id_»suÉ
, 
IsOk
());

132 
ASSERT_NE
(
As£¹iÚG’”©ÜM­
::
G‘V®ue
(
authÜ™y_id_»suÉ
.
V®ueOrD›
()),

133 
As£¹iÚG’”©ÜM­
::
v®ue_’d
());

137 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
In™ŸlizeSucûedsOnû
) {

138 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

139 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

140 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

144 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
In™ŸlizeFasW™hUÅ¬§bËCÚfig
) {

145 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

146 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
kBadCÚfig
), 
NÙ
(
IsOk
()));

151 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

152 
In™ŸlizeFasMissšgA‰e¡©iÚDomaš
) {

153 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

154 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

156 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

157 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

162 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
IsIn™ŸlizedBefÜeAá”In™Ÿliz©iÚ
) {

163 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

164 
EXPECT_FALSE
(
g’”©Ü
.
IsIn™Ÿlized
());

165 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

166 
EXPECT_TRUE
(
g’”©Ü
.
IsIn™Ÿlized
());

169 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
Id’t™yTy³
) {

170 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

171 
EXPECT_EQ
(
g’”©Ü
.
Id’t™yTy³
(), 
CODE_IDENTITY
);

174 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
AuthÜ™yTy³
) {

175 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

176 
EXPECT_EQ
(
g’”©Ü
.
AuthÜ™yTy³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

181 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

182 
C»©eAs£¹iÚOfãrFasIfNÙIn™Ÿlized
) {

183 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

184 
As£¹iÚOfãr
 
	gas£¹iÚ_ofãr
;

185 
EXPECT_THAT
(
g’”©Ü
.
C»©eAs£¹iÚOfãr
(&
as£¹iÚ_ofãr
), 
NÙ
(
IsOk
()));

191 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
C»©eAs£¹iÚOfãrSucûss
) {

192 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

193 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

195 
As£¹iÚOfãr
 
	gas£¹iÚ_ofãr
;

196 
EXPECT_THAT
(
g’”©Ü
.
C»©eAs£¹iÚOfãr
(&
as£¹iÚ_ofãr
), 
IsOk
());

198 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 = 
as£¹iÚ_ofãr
.
desütiÚ
();

199 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

200 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

202 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

203 
ASSERT_TRUE
(
add™iÚ®_šfo
.
P¬£FromSŒšg
(

204 
as£¹iÚ_ofãr
.
add™iÚ®_šfÜm©iÚ
()));

205 
EXPECT_EQ
(
add™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(),

206 
kLoÿlA‰e¡©iÚDomaš1
);

210 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
CªG’”©eFasIfNÙIn™Ÿlized
) {

211 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

212 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

215 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš1
,

216 &
as£¹iÚ_»que¡
));

218 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
NÙ
(
IsOk
()));

223 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

224 
CªG’”©eFasIfNÚM©chšgLoÿlA‰e¡©iÚDomaš
) {

225 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

226 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

228 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

231 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš2
,

232 &
as£¹iÚ_»que¡
));

233 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
IsOkAndHŞds
(
çl£
));

237 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

238 
CªG’”©eFasIfUÅ¬£abËAs£¹iÚReque¡
) {

239 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

240 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

242 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

243 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ_»que¡
.
mubË_desütiÚ
());

244 
	gas£¹iÚ_»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kBadAdd™iÚ®Info
);

246 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
NÙ
(
IsOk
()));

251 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

252 
CªG’”©eFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

253 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

254 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

256 
As£¹iÚReque¡
 
	g»que¡
;

257 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

258 
»que¡
.
mubË_desütiÚ
());

259 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
»que¡
), 
NÙ
(
IsOk
()));

264 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
CªG’”©eSucûss
) {

265 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

266 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

268 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

271 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš1
,

272 &
as£¹iÚ_»que¡
));

273 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
IsOkAndHŞds
(
Œue
));

277 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
G’”©eFasIfNÙIn™Ÿlized
) {

278 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

279 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

282 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš1
,

283 &
as£¹iÚ_»que¡
));

285 
As£¹iÚ
 
	gas£¹iÚ
;

286 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

287 
NÙ
(
IsOk
()));

292 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

293 
G’”©eFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

294 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

295 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

297 
As£¹iÚReque¡
 
	g»que¡
;

298 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

299 
»que¡
.
mubË_desütiÚ
());

301 
As£¹iÚ
 
	gas£¹iÚ
;

302 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
»que¡
, &
as£¹iÚ
), 
NÙ
(
IsOk
()));

307 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

308 
G’”©eFasIfNÚM©chšgLoÿlA‰e¡©iÚDomaš
) {

309 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

310 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

312 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

315 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš2
,

316 &
as£¹iÚ_»que¡
));

318 
As£¹iÚ
 
	gas£¹iÚ
;

319 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

320 
NÙ
(
IsOk
()));

324 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

325 
G’”©eFasIfUÅ¬£abËAs£¹iÚReque¡
) {

326 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

327 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

329 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

330 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ_»que¡
.
mubË_desütiÚ
());

331 
	gas£¹iÚ_»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kBadAdd™iÚ®Info
);

333 
As£¹iÚ
 
	gas£¹iÚ
;

334 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

335 
NÙ
(
IsOk
()));

340 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
G’”©eSucûss
) {

341 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

342 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

344 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

345 
	gsgx
::
T¬g‘šfo
 
rg‘šfo
;

346 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(&
rg‘šfo
);

349 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡
(

350 
ab¦
::
¡ršg_v›w
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
rg‘šfo
),

351 (
rg‘šfo
)),

352 
kLoÿlA‰e¡©iÚDomaš1
, &
as£¹iÚ_»que¡
));

354 
As£¹iÚ
 
	gas£¹iÚ
;

355 
ASSERT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

356 
IsOk
());

358 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 = 
as£¹iÚ
.
desütiÚ
();

359 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

360 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

365 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

366 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

367 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
P¬£FromSŒšg
(
as£¹iÚ
.assertion()));

369 
ASSERT_THAT
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
sgx
::
R•Üt
>(

370 
loÿl_as£¹iÚ
.
»pÜt
(),„•Üt.
g‘
()),

371 
IsOk
());

372 
EXPECT_THAT
(
sgx
::
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
IsOk
())

373 << 
CÚv”tTrivŸlObjeùToHexSŒšg
(*
»pÜt
);

376 
Sha256Hash
 
	ghash
;

377 
	ghash
.
Upd©e
(
kU£rD©a
);

378 autØ
	gex³ùed_»pÜtd©a
 =

379 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<
sgx
::
kR•Ütd©aSize
>>();

380 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

381 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

382 
	gex³ùed_»pÜtd©a
.
»¶aû
Ğ0, 
dige¡
);

383 
EXPECT_EQ
(
»pÜt
->
»pÜtd©a
.
d©a
, 
ex³ùed_»pÜtd©a
);

386 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

387 
ASSERT_THAT
(
sgx
::
P¬£Id’t™yFromH¬dw¬eR•Üt
(*
»pÜt
, &
code_id’t™y
),

388 
IsOk
());

390 
	gsgx
::
CodeId’t™y
 
ex³ùed_id’t™y
 = 
sgx
::
G‘S–fId’t™y
()->
id’t™y
;

391 
EXPECT_THAT
(
code_id’t™y
, 
Equ®sPrÙo
(
ex³ùed_id’t™y
))

393 << 
	gcode_id’t™y
.
DebugSŒšg
() << "\nExpected identity:\n"

394 << 
	gex³ùed_id’t™y
.
DebugSŒšg
();

	@identity/sgx/sgx_local_assertion_generator_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_g’”©Ü.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"asylo/üy±o/sha256_hash.h
"

30 
	~"asylo/üy±o/ut/by‹s.h
"

31 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

32 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

33 
	~"asylo/id’t™y/’şave_as£¹iÚ_g’”©Ü.h
"

34 
	~"asylo/id’t™y/id’t™y.pb.h
"

35 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

36 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

37 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

38 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

39 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

40 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

41 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

42 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

44 
Çme¥aû
 
	gasylo
 {

45 
	gÇme¥aû
 {

47 
	gusšg
 ::
‹¡šg
::
NÙ
;

49 
cÚ¡ex´
 
	gkBadCÚfig
[] = "Not‡„eal config";

51 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš1
[] = "A 16-byte string";

52 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš2
[] = "A superb string!";

54 
cÚ¡ex´
 
	gkBadAuthÜ™y
[] = "Foobar Assertion Authority";

55 
cÚ¡ex´
 
	gkBadAdd™iÚ®Info
[] = "Invalid‡dditional info";

57 cÚ¡ 
	gkU£rD©a
[] = "User data";

61 şas 
	cSgxLoÿlAs£¹iÚG’”©ÜTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

62 
´Ùeùed
:

63 
S‘Up
(è
ov”ride
 {

64 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
authÜ™y_cÚfig
;

65 
	gauthÜ™y_cÚfig
.
£t_©‹¡©iÚ_domaš
(
kLoÿlA‰e¡©iÚDomaš1
);

66 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

71 
S‘As£¹iÚDesütiÚ
(
As£¹iÚDesütiÚ
 *
desütiÚ
) {

72 
	gdesütiÚ
->
£t_id’t™y_ty³
(
CODE_IDENTITY
);

73 
	gdesütiÚ
->
£t_authÜ™y_ty³
(
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

78 
S‘As£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
 
id’t™y_ty³
,

79 
ab¦
::
¡ršg_v›w
 
authÜ™y_ty³
,

80 
As£¹iÚDesütiÚ
 *
desütiÚ
) {

81 
	gdesütiÚ
->
£t_id’t™y_ty³
(
id’t™y_ty³
);

82 
	gdesütiÚ
->
£t_authÜ™y_ty³
(
authÜ™y_ty³
.
d©a
(),

83 
authÜ™y_ty³
.
size
());

89 
boŞ
 
MakeAs£¹iÚReque¡
(
ab¦
::
¡ršg_v›w
 
rg‘šfo
,

90 
ab¦
::
¡ršg_v›w
 
loÿl_©‹¡©iÚ_domaš
,

91 
As£¹iÚReque¡
 *
»que¡
) {

92 
S‘As£¹iÚDesütiÚ
(
»que¡
->
mubË_desütiÚ
());

94 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

95 
	gadd™iÚ®_šfo
.
£t_rg‘šfo
(
rg‘šfo
.
d©a
(),¬g‘šfo.
size
());

96 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(

97 
loÿl_©‹¡©iÚ_domaš
.
d©a
(),†oÿl_©‹¡©iÚ_domaš.
size
());

99  
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

100 
»que¡
->
mubË_add™iÚ®_šfÜm©iÚ
());

106 
boŞ
 
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(

107 
ab¦
::
¡ršg_v›w
 
loÿl_©‹¡©iÚ_domaš
, 
As£¹iÚReque¡
 *
»que¡
) {

108 
	gsgx
::
T¬g‘šfo
 
rg‘šfo
 = 
TrivŸlZ”oObjeù
<
sgx
::Targetinfo>();

112 
	grg‘šfo
.
	gm—su»m’t
 =

113 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>();

115  
MakeAs£¹iÚReque¡
(

116 
ab¦
::
¡ršg_v›w
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
rg‘šfo
),

117 (
rg‘šfo
)),

118 
loÿl_©‹¡©iÚ_domaš
, 
»que¡
);

122 
	g¡d
::
¡ršg
 
cÚfig_
;

127 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
G’”©ÜFoundInSticM­
) {

128 autØ
	gauthÜ™y_id_»suÉ
 = 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

129 
CODE_IDENTITY
, 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

131 
ASSERT_THAT
(
authÜ™y_id_»suÉ
, 
IsOk
());

132 
ASSERT_NE
(
As£¹iÚG’”©ÜM­
::
G‘V®ue
(
authÜ™y_id_»suÉ
.
V®ueOrD›
()),

133 
As£¹iÚG’”©ÜM­
::
v®ue_’d
());

137 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
In™ŸlizeSucûedsOnû
) {

138 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

139 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

140 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

144 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
In™ŸlizeFasW™hUÅ¬§bËCÚfig
) {

145 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

146 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
kBadCÚfig
), 
NÙ
(
IsOk
()));

151 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

152 
In™ŸlizeFasMissšgA‰e¡©iÚDomaš
) {

153 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

154 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

156 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

157 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

162 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
IsIn™ŸlizedBefÜeAá”In™Ÿliz©iÚ
) {

163 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

164 
EXPECT_FALSE
(
g’”©Ü
.
IsIn™Ÿlized
());

165 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

166 
EXPECT_TRUE
(
g’”©Ü
.
IsIn™Ÿlized
());

169 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
Id’t™yTy³
) {

170 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

171 
EXPECT_EQ
(
g’”©Ü
.
Id’t™yTy³
(), 
CODE_IDENTITY
);

174 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
AuthÜ™yTy³
) {

175 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

176 
EXPECT_EQ
(
g’”©Ü
.
AuthÜ™yTy³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

181 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

182 
C»©eAs£¹iÚOfãrFasIfNÙIn™Ÿlized
) {

183 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

184 
As£¹iÚOfãr
 
	gas£¹iÚ_ofãr
;

185 
EXPECT_THAT
(
g’”©Ü
.
C»©eAs£¹iÚOfãr
(&
as£¹iÚ_ofãr
), 
NÙ
(
IsOk
()));

191 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
C»©eAs£¹iÚOfãrSucûss
) {

192 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

193 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

195 
As£¹iÚOfãr
 
	gas£¹iÚ_ofãr
;

196 
EXPECT_THAT
(
g’”©Ü
.
C»©eAs£¹iÚOfãr
(&
as£¹iÚ_ofãr
), 
IsOk
());

198 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 = 
as£¹iÚ_ofãr
.
desütiÚ
();

199 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

200 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

202 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

203 
ASSERT_TRUE
(
add™iÚ®_šfo
.
P¬£FromSŒšg
(

204 
as£¹iÚ_ofãr
.
add™iÚ®_šfÜm©iÚ
()));

205 
EXPECT_EQ
(
add™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(),

206 
kLoÿlA‰e¡©iÚDomaš1
);

210 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
CªG’”©eFasIfNÙIn™Ÿlized
) {

211 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

212 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

215 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš1
,

216 &
as£¹iÚ_»que¡
));

218 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
NÙ
(
IsOk
()));

223 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

224 
CªG’”©eFasIfNÚM©chšgLoÿlA‰e¡©iÚDomaš
) {

225 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

226 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

228 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

231 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš2
,

232 &
as£¹iÚ_»que¡
));

233 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
IsOkAndHŞds
(
çl£
));

237 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

238 
CªG’”©eFasIfUÅ¬£abËAs£¹iÚReque¡
) {

239 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

240 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

242 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

243 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ_»que¡
.
mubË_desütiÚ
());

244 
	gas£¹iÚ_»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kBadAdd™iÚ®Info
);

246 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
NÙ
(
IsOk
()));

251 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

252 
CªG’”©eFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

253 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

254 
ASSERT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

256 
As£¹iÚReque¡
 
	g»que¡
;

257 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

258 
»que¡
.
mubË_desütiÚ
());

259 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
»que¡
), 
NÙ
(
IsOk
()));

264 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
CªG’”©eSucûss
) {

265 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

266 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

268 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

271 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš1
,

272 &
as£¹iÚ_»que¡
));

273 
EXPECT_THAT
(
g’”©Ü
.
CªG’”©e
(
as£¹iÚ_»que¡
), 
IsOkAndHŞds
(
Œue
));

277 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
G’”©eFasIfNÙIn™Ÿlized
) {

278 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

279 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

282 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš1
,

283 &
as£¹iÚ_»que¡
));

285 
As£¹iÚ
 
	gas£¹iÚ
;

286 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

287 
NÙ
(
IsOk
()));

292 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

293 
G’”©eFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

294 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

295 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

297 
As£¹iÚReque¡
 
	g»que¡
;

298 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

299 
»que¡
.
mubË_desütiÚ
());

301 
As£¹iÚ
 
	gas£¹iÚ
;

302 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
»que¡
, &
as£¹iÚ
), 
NÙ
(
IsOk
()));

307 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

308 
G’”©eFasIfNÚM©chšgLoÿlA‰e¡©iÚDomaš
) {

309 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

310 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

312 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

315 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡W™hRªdomT¬g‘
(
kLoÿlA‰e¡©iÚDomaš2
,

316 &
as£¹iÚ_»que¡
));

318 
As£¹iÚ
 
	gas£¹iÚ
;

319 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

320 
NÙ
(
IsOk
()));

324 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
,

325 
G’”©eFasIfUÅ¬£abËAs£¹iÚReque¡
) {

326 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

327 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

329 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

330 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ_»que¡
.
mubË_desütiÚ
());

331 
	gas£¹iÚ_»que¡
.
£t_add™iÚ®_šfÜm©iÚ
(
kBadAdd™iÚ®Info
);

333 
As£¹iÚ
 
	gas£¹iÚ
;

334 
EXPECT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

335 
NÙ
(
IsOk
()));

340 
TEST_F
(
SgxLoÿlAs£¹iÚG’”©ÜTe¡
, 
G’”©eSucûss
) {

341 
SgxLoÿlAs£¹iÚG’”©Ü
 
	gg’”©Ü
;

342 
EXPECT_THAT
(
g’”©Ü
.
In™Ÿlize
(
cÚfig_
), 
IsOk
());

344 
As£¹iÚReque¡
 
	gas£¹iÚ_»que¡
;

345 
	gsgx
::
T¬g‘šfo
 
rg‘šfo
;

346 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(&
rg‘šfo
);

349 
ASSERT_TRUE
(
MakeAs£¹iÚReque¡
(

350 
ab¦
::
¡ršg_v›w
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&
rg‘šfo
),

351 (
rg‘šfo
)),

352 
kLoÿlA‰e¡©iÚDomaš1
, &
as£¹iÚ_»que¡
));

354 
As£¹iÚ
 
	gas£¹iÚ
;

355 
ASSERT_THAT
(
g’”©Ü
.
G’”©e
(
kU£rD©a
, 
as£¹iÚ_»que¡
, &
as£¹iÚ
),

356 
IsOk
());

358 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 = 
as£¹iÚ
.
desütiÚ
();

359 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

360 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

365 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

366 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

367 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
P¬£FromSŒšg
(
as£¹iÚ
.assertion()));

369 
ASSERT_THAT
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
sgx
::
R•Üt
>(

370 
loÿl_as£¹iÚ
.
»pÜt
(),„•Üt.
g‘
()),

371 
IsOk
());

372 
EXPECT_THAT
(
sgx
::
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
IsOk
())

373 << 
CÚv”tTrivŸlObjeùToHexSŒšg
(*
»pÜt
);

376 
Sha256Hash
 
	ghash
;

377 
	ghash
.
Upd©e
(
kU£rD©a
);

378 autØ
	gex³ùed_»pÜtd©a
 =

379 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<
sgx
::
kR•Ütd©aSize
>>();

380 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

381 
ASSERT_THAT
(
hash
.
CumuÏtiveHash
(&
dige¡
), 
IsOk
());

382 
	gex³ùed_»pÜtd©a
.
»¶aû
Ğ0, 
dige¡
);

383 
EXPECT_EQ
(
»pÜt
->
»pÜtd©a
.
d©a
, 
ex³ùed_»pÜtd©a
);

386 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

387 
ASSERT_THAT
(
sgx
::
P¬£Id’t™yFromH¬dw¬eR•Üt
(*
»pÜt
, &
code_id’t™y
),

388 
IsOk
());

390 
	gsgx
::
CodeId’t™y
 
ex³ùed_id’t™y
 = 
sgx
::
G‘S–fId’t™y
()->
id’t™y
;

391 
EXPECT_THAT
(
code_id’t™y
, 
Equ®sPrÙo
(
ex³ùed_id’t™y
))

393 << 
	gcode_id’t™y
.
DebugSŒšg
() << "\nExpected identity:\n"

394 << 
	gex³ùed_id’t™y
.
DebugSŒšg
();

	@identity/sgx/sgx_local_assertion_verifier.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_v”if›r.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

26 
	~"asylo/üy±o/sha256_hash.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

29 
	~"asylo/id’t™y/desütiÚs.h
"

30 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

31 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

32 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

33 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

34 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

37 
Çme¥aû
 
	gasylo
 {

39 cÚ¡ *cÚ¡ 
	gSgxLoÿlAs£¹iÚV”if›r
::
authÜ™y_ty³_
 =

40 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
;

42 
	gSgxLoÿlAs£¹iÚV”if›r
::
SgxLoÿlAs£¹iÚV”if›r
(è: 
š™Ÿlized_
(
çl£
) {}

44 
Stus
 
SgxLoÿlAs£¹iÚV”if›r
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

45 ià(
IsIn™Ÿlized
()) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

50 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

51 ià(!
	gauthÜ™y_cÚfig
.
P¬£FromSŒšg
(
cÚfig
)) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

56 ià(!
	gauthÜ™y_cÚfig
.
has_©‹¡©iÚ_domaš
()) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
	g©‹¡©iÚ_domaš_
 = 
authÜ™y_cÚfig
.
©‹¡©iÚ_domaš
();

63 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

64 
	gš™Ÿlized_
 = 
Œue
;

66  
	gStus
::
OkStus
();

69 
boŞ
 
	gSgxLoÿlAs£¹iÚV”if›r
::
IsIn™Ÿlized
() const {

70 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

71  
	gš™Ÿlized_
;

74 
EnşaveId’t™yTy³
 
	gSgxLoÿlAs£¹iÚV”if›r
::
Id’t™yTy³
() const {

75  
id’t™y_ty³_
;

78 
	g¡d
::
¡ršg
 
SgxLoÿlAs£¹iÚV”if›r
::
AuthÜ™yTy³
() const {

79  
authÜ™y_ty³_
;

82 
Stus
 
	gSgxLoÿlAs£¹iÚV”if›r
::
C»©eAs£¹iÚReque¡
(

83 
As£¹iÚReque¡
 *
»que¡
) const {

84 ià(!
IsIn™Ÿlized
()) {

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

88 
	g»que¡
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

89 
	g»que¡
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

91 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

92 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(
©‹¡©iÚ_domaš_
);

101 
	gsgx
::
T¬g‘šfo
 
rg‘šfo
;

102 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(&
rg‘šfo
);

103 
	gadd™iÚ®_šfo
.
£t_rg‘šfo
(

104 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
rg‘šfo
));

106 ià(!
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

107 
»que¡
->
mubË_add™iÚ®_šfÜm©iÚ
())) {

108  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

112  
	gStus
::
OkStus
();

115 
	gStusOr
<
	gboŞ
> 
	gSgxLoÿlAs£¹iÚV”if›r
::
CªV”ify
(

116 cÚ¡ 
As£¹iÚOfãr
 &
ofãr
) const {

117 ià(!
IsIn™Ÿlized
()) {

118  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

121 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
ofãr
.
desütiÚ
())) {

122  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

126 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

127 ià(!
	gadd™iÚ®_šfo
.
P¬£FromSŒšg
(
ofãr
.
add™iÚ®_šfÜm©iÚ
())) {

128  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

132  
	gadd™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(è=ğ
©‹¡©iÚ_domaš_
;

135 
Stus
 
	gSgxLoÿlAs£¹iÚV”if›r
::
V”ify
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

136 cÚ¡ 
As£¹iÚ
 &
as£¹iÚ
,

137 
EnşaveId’t™y
 *
³”_id’t™y
) const {

138 ià(!
IsIn™Ÿlized
()) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

142 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
as£¹iÚ
.
desütiÚ
())) {

143  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

147 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

148 ià(!
	gloÿl_as£¹iÚ
.
P¬£FromSŒšg
(
as£¹iÚ
.assertion())) {

149  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

161 
	gsgx
::
R•Üt
 
»pÜt
;

162 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
sgx
::
R•Üt
>(

163 
loÿl_as£¹iÚ
.
»pÜt
(), &report));

164 
ASYLO_RETURN_IF_ERROR
(
sgx
::
V”ifyH¬dw¬eR•Üt
(
»pÜt
));

170 
Sha256Hash
 
	ghash
;

171 
	ghash
.
Upd©e
(
u£r_d©a
);

172 
	gsgx
::
R•Ütd©a
 
ex³ùed_»pÜtd©a
;

173 
	gex³ùed_»pÜtd©a
.
	gd©a
 =

174 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<
sgx
::
kR•Ütd©aSize
>>();

175 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

176 
ASYLO_RETURN_IF_ERROR
(
hash
.
CumuÏtiveHash
(&
dige¡
));

177 
	gex³ùed_»pÜtd©a
.
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

179 ià(
	gex³ùed_»pÜtd©a
.
	gd©a
 !ğ
»pÜt
.
»pÜtd©a
.
d©a
) {

180  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

186 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

187 
ASYLO_RETURN_IF_ERROR
(

188 
sgx
::
P¬£Id’t™yFromH¬dw¬eR•Üt
(
»pÜt
, &
code_id’t™y
));

190 ià(!
	gcode_id’t™y
.
S”ŸlizeToSŒšg
(
³”_id’t™y
->
mubË_id’t™y
())) {

191  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

195 
S‘SgxId’t™yDesütiÚ
(
³”_id’t™y
->
mubË_desütiÚ
());

197  
	gStus
::
OkStus
();

201 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚV”if›rM­
,

202 
SgxLoÿlAs£¹iÚV”if›r
);

	@identity/sgx/sgx_local_assertion_verifier.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_v”if›r.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

26 
	~"asylo/üy±o/sha256_hash.h
"

27 
	~"asylo/üy±o/ut/by‹s.h
"

28 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

29 
	~"asylo/id’t™y/desütiÚs.h
"

30 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

31 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

32 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

33 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

34 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

37 
Çme¥aû
 
	gasylo
 {

39 cÚ¡ *cÚ¡ 
	gSgxLoÿlAs£¹iÚV”if›r
::
authÜ™y_ty³_
 =

40 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
;

42 
	gSgxLoÿlAs£¹iÚV”if›r
::
SgxLoÿlAs£¹iÚV”if›r
(è: 
š™Ÿlized_
(
çl£
) {}

44 
Stus
 
SgxLoÿlAs£¹iÚV”if›r
::
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
) {

45 ià(
IsIn™Ÿlized
()) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

50 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

51 ià(!
	gauthÜ™y_cÚfig
.
P¬£FromSŒšg
(
cÚfig
)) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

56 ià(!
	gauthÜ™y_cÚfig
.
has_©‹¡©iÚ_domaš
()) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
	g©‹¡©iÚ_domaš_
 = 
authÜ™y_cÚfig
.
©‹¡©iÚ_domaš
();

63 
	gab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

64 
	gš™Ÿlized_
 = 
Œue
;

66  
	gStus
::
OkStus
();

69 
boŞ
 
	gSgxLoÿlAs£¹iÚV”if›r
::
IsIn™Ÿlized
() const {

70 
ab¦
::
Mu‹xLock
 
lock
(&
š™Ÿlized_mu_
);

71  
	gš™Ÿlized_
;

74 
EnşaveId’t™yTy³
 
	gSgxLoÿlAs£¹iÚV”if›r
::
Id’t™yTy³
() const {

75  
id’t™y_ty³_
;

78 
	g¡d
::
¡ršg
 
SgxLoÿlAs£¹iÚV”if›r
::
AuthÜ™yTy³
() const {

79  
authÜ™y_ty³_
;

82 
Stus
 
	gSgxLoÿlAs£¹iÚV”if›r
::
C»©eAs£¹iÚReque¡
(

83 
As£¹iÚReque¡
 *
»que¡
) const {

84 ià(!
IsIn™Ÿlized
()) {

85  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

88 
	g»que¡
->
mubË_desütiÚ
()->
£t_id’t™y_ty³
(
Id’t™yTy³
());

89 
	g»que¡
->
mubË_desütiÚ
()->
£t_authÜ™y_ty³
(
AuthÜ™yTy³
());

91 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

92 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(
©‹¡©iÚ_domaš_
);

101 
	gsgx
::
T¬g‘šfo
 
rg‘šfo
;

102 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(&
rg‘šfo
);

103 
	gadd™iÚ®_šfo
.
£t_rg‘šfo
(

104 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
rg‘šfo
));

106 ià(!
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

107 
»que¡
->
mubË_add™iÚ®_šfÜm©iÚ
())) {

108  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

112  
	gStus
::
OkStus
();

115 
	gStusOr
<
	gboŞ
> 
	gSgxLoÿlAs£¹iÚV”if›r
::
CªV”ify
(

116 cÚ¡ 
As£¹iÚOfãr
 &
ofãr
) const {

117 ià(!
IsIn™Ÿlized
()) {

118  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

121 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
ofãr
.
desütiÚ
())) {

122  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

126 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

127 ià(!
	gadd™iÚ®_šfo
.
P¬£FromSŒšg
(
ofãr
.
add™iÚ®_šfÜm©iÚ
())) {

128  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

132  
	gadd™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(è=ğ
©‹¡©iÚ_domaš_
;

135 
Stus
 
	gSgxLoÿlAs£¹iÚV”if›r
::
V”ify
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
,

136 cÚ¡ 
As£¹iÚ
 &
as£¹iÚ
,

137 
EnşaveId’t™y
 *
³”_id’t™y
) const {

138 ià(!
IsIn™Ÿlized
()) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
, "Not initialized");

142 ià(!
IsCom·tibËAs£¹iÚDesütiÚ
(
as£¹iÚ
.
desütiÚ
())) {

143  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

147 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

148 ià(!
	gloÿl_as£¹iÚ
.
P¬£FromSŒšg
(
as£¹iÚ
.assertion())) {

149  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

161 
	gsgx
::
R•Üt
 
»pÜt
;

162 
ASYLO_RETURN_IF_ERROR
(
S‘TrivŸlObjeùFromBš¬ySŒšg
<
sgx
::
R•Üt
>(

163 
loÿl_as£¹iÚ
.
»pÜt
(), &report));

164 
ASYLO_RETURN_IF_ERROR
(
sgx
::
V”ifyH¬dw¬eR•Üt
(
»pÜt
));

170 
Sha256Hash
 
	ghash
;

171 
	ghash
.
Upd©e
(
u£r_d©a
);

172 
	gsgx
::
R•Ütd©a
 
ex³ùed_»pÜtd©a
;

173 
	gex³ùed_»pÜtd©a
.
	gd©a
 =

174 
TrivŸlZ”oObjeù
<
Un§ãBy‹s
<
sgx
::
kR•Ütd©aSize
>>();

175 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

176 
ASYLO_RETURN_IF_ERROR
(
hash
.
CumuÏtiveHash
(&
dige¡
));

177 
	gex³ùed_»pÜtd©a
.
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

179 ià(
	gex³ùed_»pÜtd©a
.
	gd©a
 !ğ
»pÜt
.
»pÜtd©a
.
d©a
) {

180  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

186 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

187 
ASYLO_RETURN_IF_ERROR
(

188 
sgx
::
P¬£Id’t™yFromH¬dw¬eR•Üt
(
»pÜt
, &
code_id’t™y
));

190 ià(!
	gcode_id’t™y
.
S”ŸlizeToSŒšg
(
³”_id’t™y
->
mubË_id’t™y
())) {

191  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

195 
S‘SgxId’t™yDesütiÚ
(
³”_id’t™y
->
mubË_desütiÚ
());

197  
	gStus
::
OkStus
();

201 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
As£¹iÚV”if›rM­
,

202 
SgxLoÿlAs£¹iÚV”if›r
);

	@identity/sgx/sgx_local_assertion_verifier.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SGX_LOCAL_ASSERTION_VERIFIER_H_


20 
	#ASYLO_IDENTITY_SGX_SGX_LOCAL_ASSERTION_VERIFIER_H_


	)

22 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

24 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

26 
Çme¥aû
 
	gasylo
 {

34 şas 
	cSgxLoÿlAs£¹iÚV”if›r
 
	gfš®
 : 
public
 
EnşaveAs£¹iÚV”if›r
 {

35 
public
:

39 
SgxLoÿlAs£¹iÚV”if›r
();

45 
Stus
 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
cÚfig
è
ov”ride
;

47 
boŞ
 
IsIn™Ÿlized
(ècÚ¡ 
	gov”ride
;

49 
EnşaveId’t™yTy³
 
Id’t™yTy³
(ècÚ¡ 
	gov”ride
;

51 
	g¡d
::
¡ršg
 
AuthÜ™yTy³
(ècÚ¡ 
ov”ride
;

57 
Stus
 
C»©eAs£¹iÚReque¡
(
As£¹iÚReque¡
 *
»que¡
ècÚ¡ 
	gov”ride
;

59 
	gStusOr
<
	gboŞ
> 
CªV”ify
(cÚ¡ 
As£¹iÚOfãr
 &
ofãr
ècÚ¡ 
	gov”ride
;

61 
Stus
 
V”ify
(cÚ¡ 
¡d
::
¡ršg
 &
u£r_d©a
, cÚ¡ 
As£¹iÚ
 &
as£¹iÚ
,

62 
EnşaveId’t™y
 *
³”_id’t™y
ècÚ¡ 
	gov”ride
;

64 
	g´iv©e
:

66 
cÚ¡ex´
 
EnşaveId’t™yTy³
 
id’t™y_ty³_
 = 
CODE_IDENTITY
;

69 cÚ¡ *cÚ¡ 
	gauthÜ™y_ty³_
;

72 
	g¡d
::
¡ršg
 
©‹¡©iÚ_domaš_
;

75 
boŞ
 
š™Ÿlized_
 
GUARDED_BY
(
š™Ÿlized_mu_
);

78 
mubË
 
	gab¦
::
Mu‹x
 
š™Ÿlized_mu_
;

	@identity/sgx/sgx_local_assertion_verifier_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_v”if›r.h
"

21 
	~<c¡dšt
>

22 
	~<veùÜ
>

24 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

28 
	~"asylo/üy±o/sha256_hash.h
"

29 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

30 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

31 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

32 
	~"asylo/id’t™y/id’t™y.pb.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

34 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

35 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

36 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

37 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

38 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

39 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

40 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

41 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

43 
Çme¥aû
 
	gasylo
 {

44 
	gÇme¥aû
 {

46 
	gusšg
 ::
‹¡šg
::
NÙ
;

48 
cÚ¡ex´
 
	gkBadCÚfig
[] = "Not‡„eal config";

50 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš1
[] = "A 16-byte string";

51 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš2
[] = "A superb string!";

53 
cÚ¡ex´
 
	gkBadAuthÜ™y
[] = "Foobar Assertion Authority";

54 
cÚ¡ex´
 
	gkBadAdd™iÚ®Info
[] = "Invalid‡dditional info";

55 
cÚ¡ex´
 
	gkBadLoÿlAs£¹iÚ
[] = "Invalid†ocal‡ssertion";

56 
cÚ¡ex´
 
	gkBadR•Üt
[] = "Invalid„eport";

58 cÚ¡ 
	gkU£rD©a
[] = "User data";

62 şas 
	cSgxLoÿlAs£¹iÚV”if›rTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

63 
´Ùeùed
:

64 
S‘Up
(è
ov”ride
 {

65 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
authÜ™y_cÚfig
;

66 
	gauthÜ™y_cÚfig
.
£t_©‹¡©iÚ_domaš
(
kLoÿlA‰e¡©iÚDomaš1
);

67 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

72 
S‘As£¹iÚDesütiÚ
(
As£¹iÚDesütiÚ
 *
desütiÚ
) {

73 
S‘As£¹iÚDesütiÚ
(
CODE_IDENTITY
, 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
,

74 
desütiÚ
);

79 
S‘As£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
 
id’t™y_ty³
,

80 
ab¦
::
¡ršg_v›w
 
authÜ™y_ty³
,

81 
As£¹iÚDesütiÚ
 *
desütiÚ
) {

82 
	gdesütiÚ
->
£t_id’t™y_ty³
(
id’t™y_ty³
);

83 
	gdesütiÚ
->
£t_authÜ™y_ty³
(
authÜ™y_ty³
.
d©a
(),

84 
authÜ™y_ty³
.
size
());

89 
boŞ
 
MakeAs£¹iÚOfãr
(
ab¦
::
¡ršg_v›w
 
loÿl_©‹¡©iÚ_domaš
,

90 
As£¹iÚOfãr
 *
ofãr
) {

91 
S‘As£¹iÚDesütiÚ
(
ofãr
->
mubË_desütiÚ
());

93 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

94 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(

95 
loÿl_©‹¡©iÚ_domaš
.
d©a
(),†oÿl_©‹¡©iÚ_domaš.
size
());

97  
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

98 
ofãr
->
mubË_add™iÚ®_šfÜm©iÚ
());

102 
	g¡d
::
¡ršg
 
cÚfig_
;

107 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”if›rFoundInSticM­
) {

108 autØ
	gauthÜ™y_id_»suÉ
 = 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

109 
CODE_IDENTITY
, 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

111 
ASYLO_ASSERT_OK
(
authÜ™y_id_»suÉ
);

112 
ASSERT_NE
(
As£¹iÚV”if›rM­
::
G‘V®ue
(
authÜ™y_id_»suÉ
.
V®ueOrD›
()),

113 
As£¹iÚV”if›rM­
::
v®ue_’d
());

116 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
Id’t™yTy³
) {

117 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

118 
EXPECT_EQ
(
v”if›r
.
Id’t™yTy³
(), 
CODE_IDENTITY
);

121 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
AuthÜ™yTy³
) {

122 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

123 
EXPECT_EQ
(
v”if›r
.
AuthÜ™yTy³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

127 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
In™ŸlizeSucûedsOnû
) {

128 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

129 
ASYLO_EXPECT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

130 
EXPECT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

134 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
In™ŸlizeFasW™hUÅ¬§bËCÚfig
) {

135 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

136 
EXPECT_THAT
(
v”if›r
.
In™Ÿlize
(
kBadCÚfig
), 
NÙ
(
IsOk
()));

141 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
In™ŸlizeFasMissšgA‰e¡©iÚDomaš
) {

142 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

143 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

145 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

146 
EXPECT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

151 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
IsIn™ŸlizedBefÜeAá”In™Ÿliz©iÚ
) {

152 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

153 
EXPECT_FALSE
(
v”if›r
.
IsIn™Ÿlized
());

154 
ASYLO_EXPECT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

155 
EXPECT_TRUE
(
v”if›r
.
IsIn™Ÿlized
());

160 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

161 
C»©eAs£¹iÚReque¡FasIfNÙIn™Ÿlized
) {

162 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

164 
As£¹iÚReque¡
 
	g»que¡
;

165 
EXPECT_THAT
(
v”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
), 
NÙ
(
IsOk
()));

171 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
C»©eAs£¹iÚReque¡Sucûss
) {

172 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

173 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

175 
As£¹iÚReque¡
 
	g»que¡
;

176 
ASYLO_ASSERT_OK
(
v”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
));

178 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 = 
»que¡
.
desütiÚ
();

179 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

180 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

182 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

183 
ASSERT_TRUE
(

184 
add™iÚ®_šfo
.
P¬£FromSŒšg
(
»que¡
.
add™iÚ®_šfÜm©iÚ
()));

185 
EXPECT_EQ
(
add™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(),

186 
kLoÿlA‰e¡©iÚDomaš1
);

190 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
CªV”ifyFasIfNÙIn™Ÿlized
) {

191 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

193 
As£¹iÚOfãr
 
	gofãr
;

194 
MakeAs£¹iÚOfãr
(
kLoÿlA‰e¡©iÚDomaš1
, &
ofãr
);

195 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
NÙ
(
IsOk
()));

199 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

200 
CªV”ifyFasIfUÅ¬£abËAs£¹iÚOfãr
) {

201 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

202 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

204 
As£¹iÚOfãr
 
	gofãr
;

205 
S‘As£¹iÚDesütiÚ
(
ofãr
.
mubË_desütiÚ
());

206 
	gofãr
.
£t_add™iÚ®_šfÜm©iÚ
(
kBadAdd™iÚ®Info
);

207 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
NÙ
(
IsOk
()));

212 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

213 
CªV”ifyFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

214 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

215 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

217 
As£¹iÚOfãr
 
	gofãr
;

218 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

219 
ofãr
.
mubË_desütiÚ
());

220 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
NÙ
(
IsOk
()));

225 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

226 
CªV”ifyFasIfNÚM©chšgLoÿlA‰e¡©iÚDomaš
) {

227 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

228 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

230 
As£¹iÚOfãr
 
	gofãr
;

231 
MakeAs£¹iÚOfãr
(
kLoÿlA‰e¡©iÚDomaš2
, &
ofãr
);

233 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
çl£
));

237 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfNÙIn™Ÿlized
) {

238 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

240 
As£¹iÚ
 
	gas£¹iÚ
;

241 
EnşaveId’t™y
 
	gid’t™y
;

242 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

247 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

248 
V”ifyFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

249 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

250 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

252 
As£¹iÚ
 
	gas£¹iÚ
;

253 
EnşaveId’t™y
 
	gid’t™y
;

254 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

255 
as£¹iÚ
.
mubË_desütiÚ
());

256 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

260 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfUÅ¬£abËAs£¹iÚ
) {

261 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

262 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

264 
As£¹iÚ
 
	gas£¹iÚ
;

265 
EnşaveId’t™y
 
	gid’t™y
;

266 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

267 
	gas£¹iÚ
.
£t_as£¹iÚ
(
kBadLoÿlAs£¹iÚ
);

268 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

272 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfR•ÜtM®fÜmed
) {

273 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

274 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

276 
As£¹iÚ
 
	gas£¹iÚ
;

277 
EnşaveId’t™y
 
	gid’t™y
;

278 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

280 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

281 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
kBadR•Üt
);

282 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

284 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

288 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfR•ÜtIsUnv”ifŸbË
) {

289 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

290 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

292 
As£¹iÚ
 
	gas£¹iÚ
;

293 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

295 
Sha256Hash
 
	ghash
;

296 
	ghash
.
Upd©e
(
kU£rD©a
);

297 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

298 *
	g»pÜtd©a
 = 
TrivŸlZ”oObjeù
<
sgx
::
R•Ütd©a
>();

299 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

300 
ASYLO_ASSERT_OK
(
hash
.
CumuÏtiveHash
(&
dige¡
));

301 
	g»pÜtd©a
->
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

304 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
rg‘šfo
;

305 *
	grg‘šfo
 = 
TrivŸlZ”oObjeù
<
sgx
::
T¬g‘šfo
>();

307 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

308 
ASYLO_ASSERT_OK
(

309 
sgx
::
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

310 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

311 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»pÜt
.
g‘
()),

312 (*
»pÜt
));

313 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

315 
EnşaveId’t™y
 
	gid’t™y
;

316 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

321 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

322 
V”ifyFasIfAs£¹iÚIsNÙBoundToU£rD©a
) {

323 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

324 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

326 
As£¹iÚ
 
	gas£¹iÚ
;

327 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

331 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

332 *
	g»pÜtd©a
 = 
TrivŸlRªdomObjeù
<
sgx
::
R•Ütd©a
>();

334 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
rg‘šfo
;

335 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(
rg‘šfo
.
g‘
());

337 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

338 
ASYLO_ASSERT_OK
(

339 
sgx
::
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

340 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

341 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»pÜt
.
g‘
()),

342 (*
»pÜt
));

343 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

345 
EnşaveId’t™y
 
	gid’t™y
;

346 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

351 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifySucûss
) {

352 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

353 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

355 
As£¹iÚ
 
	gas£¹iÚ
;

356 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

358 
Sha256Hash
 
	ghash
;

359 
	ghash
.
Upd©e
(
kU£rD©a
);

360 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

361 *
	g»pÜtd©a
 = 
TrivŸlZ”oObjeù
<
sgx
::
R•Ütd©a
>();

362 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

363 
ASYLO_ASSERT_OK
(
hash
.
CumuÏtiveHash
(&
dige¡
));

364 
	g»pÜtd©a
->
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

366 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
rg‘šfo
;

367 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(
rg‘šfo
.
g‘
());

369 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

370 
ASYLO_ASSERT_OK
(

371 
sgx
::
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

372 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

373 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»pÜt
.
g‘
()),

374 (*
»pÜt
));

375 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

377 
EnşaveId’t™y
 
	gid’t™y
;

378 
ASYLO_ASSERT_OK
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
));

380 cÚ¡ 
	gEnşaveId’t™yDesütiÚ
 &
	gdesütiÚ
 = 
id’t™y
.
desütiÚ
();

381 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

382 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxAuthÜiz©iÚAuthÜ™y
);

384 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

385 
ASSERT_TRUE
(
code_id’t™y
.
P¬£FromSŒšg
(
id’t™y
.identity()));

387 
	gsgx
::
CodeId’t™y
 
ex³ùed_id’t™y
 = 
sgx
::
G‘S–fId’t™y
()->
id’t™y
;

388 
EXPECT_THAT
(
code_id’t™y
, 
Equ®sPrÙo
(
ex³ùed_id’t™y
))

390 << 
	gcode_id’t™y
.
DebugSŒšg
() << "\nExpected identity:\n"

391 << 
	gex³ùed_id’t™y
.
DebugSŒšg
();

	@identity/sgx/sgx_local_assertion_verifier_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_v”if›r.h
"

21 
	~<c¡dšt
>

22 
	~<veùÜ
>

24 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

28 
	~"asylo/üy±o/sha256_hash.h
"

29 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

30 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y.h
"

31 
	~"asylo/id’t™y/’şave_as£¹iÚ_v”if›r.h
"

32 
	~"asylo/id’t™y/id’t™y.pb.h
"

33 
	~"asylo/id’t™y/sgx/code_id’t™y_cÚ¡ªts.h
"

34 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

35 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

36 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

37 
	~"asylo/id’t™y/sgx/loÿl_as£¹iÚ.pb.h
"

38 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

39 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

40 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

41 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

43 
Çme¥aû
 
	gasylo
 {

44 
	gÇme¥aû
 {

46 
	gusšg
 ::
‹¡šg
::
NÙ
;

48 
cÚ¡ex´
 
	gkBadCÚfig
[] = "Not‡„eal config";

50 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš1
[] = "A 16-byte string";

51 
cÚ¡ex´
 
	gkLoÿlA‰e¡©iÚDomaš2
[] = "A superb string!";

53 
cÚ¡ex´
 
	gkBadAuthÜ™y
[] = "Foobar Assertion Authority";

54 
cÚ¡ex´
 
	gkBadAdd™iÚ®Info
[] = "Invalid‡dditional info";

55 
cÚ¡ex´
 
	gkBadLoÿlAs£¹iÚ
[] = "Invalid†ocal‡ssertion";

56 
cÚ¡ex´
 
	gkBadR•Üt
[] = "Invalid„eport";

58 cÚ¡ 
	gkU£rD©a
[] = "User data";

62 şas 
	cSgxLoÿlAs£¹iÚV”if›rTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

63 
´Ùeùed
:

64 
S‘Up
(è
ov”ride
 {

65 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
authÜ™y_cÚfig
;

66 
	gauthÜ™y_cÚfig
.
£t_©‹¡©iÚ_domaš
(
kLoÿlA‰e¡©iÚDomaš1
);

67 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

72 
S‘As£¹iÚDesütiÚ
(
As£¹iÚDesütiÚ
 *
desütiÚ
) {

73 
S‘As£¹iÚDesütiÚ
(
CODE_IDENTITY
, 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
,

74 
desütiÚ
);

79 
S‘As£¹iÚDesütiÚ
(
EnşaveId’t™yTy³
 
id’t™y_ty³
,

80 
ab¦
::
¡ršg_v›w
 
authÜ™y_ty³
,

81 
As£¹iÚDesütiÚ
 *
desütiÚ
) {

82 
	gdesütiÚ
->
£t_id’t™y_ty³
(
id’t™y_ty³
);

83 
	gdesütiÚ
->
£t_authÜ™y_ty³
(
authÜ™y_ty³
.
d©a
(),

84 
authÜ™y_ty³
.
size
());

89 
boŞ
 
MakeAs£¹iÚOfãr
(
ab¦
::
¡ršg_v›w
 
loÿl_©‹¡©iÚ_domaš
,

90 
As£¹iÚOfãr
 *
ofãr
) {

91 
S‘As£¹iÚDesütiÚ
(
ofãr
->
mubË_desütiÚ
());

93 
	gsgx
::
LoÿlAs£¹iÚOfãrAdd™iÚ®Info
 
add™iÚ®_šfo
;

94 
	gadd™iÚ®_šfo
.
£t_loÿl_©‹¡©iÚ_domaš
(

95 
loÿl_©‹¡©iÚ_domaš
.
d©a
(),†oÿl_©‹¡©iÚ_domaš.
size
());

97  
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(

98 
ofãr
->
mubË_add™iÚ®_šfÜm©iÚ
());

102 
	g¡d
::
¡ršg
 
cÚfig_
;

107 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”if›rFoundInSticM­
) {

108 autØ
	gauthÜ™y_id_»suÉ
 = 
EnşaveAs£¹iÚAuthÜ™y
::
G’”©eAuthÜ™yId
(

109 
CODE_IDENTITY
, 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

111 
ASYLO_ASSERT_OK
(
authÜ™y_id_»suÉ
);

112 
ASSERT_NE
(
As£¹iÚV”if›rM­
::
G‘V®ue
(
authÜ™y_id_»suÉ
.
V®ueOrD›
()),

113 
As£¹iÚV”if›rM­
::
v®ue_’d
());

116 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
Id’t™yTy³
) {

117 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

118 
EXPECT_EQ
(
v”if›r
.
Id’t™yTy³
(), 
CODE_IDENTITY
);

121 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
AuthÜ™yTy³
) {

122 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

123 
EXPECT_EQ
(
v”if›r
.
AuthÜ™yTy³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

127 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
In™ŸlizeSucûedsOnû
) {

128 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

129 
ASYLO_EXPECT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

130 
EXPECT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

134 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
In™ŸlizeFasW™hUÅ¬§bËCÚfig
) {

135 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

136 
EXPECT_THAT
(
v”if›r
.
In™Ÿlize
(
kBadCÚfig
), 
NÙ
(
IsOk
()));

141 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
In™ŸlizeFasMissšgA‰e¡©iÚDomaš
) {

142 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gauthÜ™y_cÚfig
;

143 
ASSERT_TRUE
(
authÜ™y_cÚfig
.
S”ŸlizeToSŒšg
(&
cÚfig_
));

145 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

146 
EXPECT_THAT
(
v”if›r
.
In™Ÿlize
(
cÚfig_
), 
NÙ
(
IsOk
()));

151 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
IsIn™ŸlizedBefÜeAá”In™Ÿliz©iÚ
) {

152 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

153 
EXPECT_FALSE
(
v”if›r
.
IsIn™Ÿlized
());

154 
ASYLO_EXPECT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

155 
EXPECT_TRUE
(
v”if›r
.
IsIn™Ÿlized
());

160 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

161 
C»©eAs£¹iÚReque¡FasIfNÙIn™Ÿlized
) {

162 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

164 
As£¹iÚReque¡
 
	g»que¡
;

165 
EXPECT_THAT
(
v”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
), 
NÙ
(
IsOk
()));

171 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
C»©eAs£¹iÚReque¡Sucûss
) {

172 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

173 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

175 
As£¹iÚReque¡
 
	g»que¡
;

176 
ASYLO_ASSERT_OK
(
v”if›r
.
C»©eAs£¹iÚReque¡
(&
»que¡
));

178 cÚ¡ 
	gAs£¹iÚDesütiÚ
 &
	gdesütiÚ
 = 
»que¡
.
desütiÚ
();

179 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

180 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxLoÿlAs£¹iÚAuthÜ™y
);

182 
	gsgx
::
LoÿlAs£¹iÚReque¡Add™iÚ®Info
 
add™iÚ®_šfo
;

183 
ASSERT_TRUE
(

184 
add™iÚ®_šfo
.
P¬£FromSŒšg
(
»que¡
.
add™iÚ®_šfÜm©iÚ
()));

185 
EXPECT_EQ
(
add™iÚ®_šfo
.
loÿl_©‹¡©iÚ_domaš
(),

186 
kLoÿlA‰e¡©iÚDomaš1
);

190 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
CªV”ifyFasIfNÙIn™Ÿlized
) {

191 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

193 
As£¹iÚOfãr
 
	gofãr
;

194 
MakeAs£¹iÚOfãr
(
kLoÿlA‰e¡©iÚDomaš1
, &
ofãr
);

195 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
NÙ
(
IsOk
()));

199 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

200 
CªV”ifyFasIfUÅ¬£abËAs£¹iÚOfãr
) {

201 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

202 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

204 
As£¹iÚOfãr
 
	gofãr
;

205 
S‘As£¹iÚDesütiÚ
(
ofãr
.
mubË_desütiÚ
());

206 
	gofãr
.
£t_add™iÚ®_šfÜm©iÚ
(
kBadAdd™iÚ®Info
);

207 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
NÙ
(
IsOk
()));

212 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

213 
CªV”ifyFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

214 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

215 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

217 
As£¹iÚOfãr
 
	gofãr
;

218 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

219 
ofãr
.
mubË_desütiÚ
());

220 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
NÙ
(
IsOk
()));

225 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

226 
CªV”ifyFasIfNÚM©chšgLoÿlA‰e¡©iÚDomaš
) {

227 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

228 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

230 
As£¹iÚOfãr
 
	gofãr
;

231 
MakeAs£¹iÚOfãr
(
kLoÿlA‰e¡©iÚDomaš2
, &
ofãr
);

233 
EXPECT_THAT
(
v”if›r
.
CªV”ify
(
ofãr
), 
IsOkAndHŞds
(
çl£
));

237 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfNÙIn™Ÿlized
) {

238 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

240 
As£¹iÚ
 
	gas£¹iÚ
;

241 
EnşaveId’t™y
 
	gid’t™y
;

242 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

247 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

248 
V”ifyFasIfIncom·tibËAs£¹iÚDesütiÚ
) {

249 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

250 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

252 
As£¹iÚ
 
	gas£¹iÚ
;

253 
EnşaveId’t™y
 
	gid’t™y
;

254 
S‘As£¹iÚDesütiÚ
(
UNKNOWN_IDENTITY
, 
kBadAuthÜ™y
,

255 
as£¹iÚ
.
mubË_desütiÚ
());

256 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

260 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfUÅ¬£abËAs£¹iÚ
) {

261 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

262 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

264 
As£¹iÚ
 
	gas£¹iÚ
;

265 
EnşaveId’t™y
 
	gid’t™y
;

266 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

267 
	gas£¹iÚ
.
£t_as£¹iÚ
(
kBadLoÿlAs£¹iÚ
);

268 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

272 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfR•ÜtM®fÜmed
) {

273 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

274 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

276 
As£¹iÚ
 
	gas£¹iÚ
;

277 
EnşaveId’t™y
 
	gid’t™y
;

278 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

280 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

281 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
kBadR•Üt
);

282 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

284 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

288 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifyFasIfR•ÜtIsUnv”ifŸbË
) {

289 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

290 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

292 
As£¹iÚ
 
	gas£¹iÚ
;

293 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

295 
Sha256Hash
 
	ghash
;

296 
	ghash
.
Upd©e
(
kU£rD©a
);

297 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

298 *
	g»pÜtd©a
 = 
TrivŸlZ”oObjeù
<
sgx
::
R•Ütd©a
>();

299 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

300 
ASYLO_ASSERT_OK
(
hash
.
CumuÏtiveHash
(&
dige¡
));

301 
	g»pÜtd©a
->
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

304 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
rg‘šfo
;

305 *
	grg‘šfo
 = 
TrivŸlZ”oObjeù
<
sgx
::
T¬g‘šfo
>();

307 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

308 
ASYLO_ASSERT_OK
(

309 
sgx
::
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

310 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

311 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»pÜt
.
g‘
()),

312 (*
»pÜt
));

313 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

315 
EnşaveId’t™y
 
	gid’t™y
;

316 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

321 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
,

322 
V”ifyFasIfAs£¹iÚIsNÙBoundToU£rD©a
) {

323 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

324 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

326 
As£¹iÚ
 
	gas£¹iÚ
;

327 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

331 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

332 *
	g»pÜtd©a
 = 
TrivŸlRªdomObjeù
<
sgx
::
R•Ütd©a
>();

334 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
rg‘šfo
;

335 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(
rg‘šfo
.
g‘
());

337 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

338 
ASYLO_ASSERT_OK
(

339 
sgx
::
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

340 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

341 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»pÜt
.
g‘
()),

342 (*
»pÜt
));

343 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

345 
EnşaveId’t™y
 
	gid’t™y
;

346 
EXPECT_THAT
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
), 
NÙ
(
IsOk
()));

351 
TEST_F
(
SgxLoÿlAs£¹iÚV”if›rTe¡
, 
V”ifySucûss
) {

352 
SgxLoÿlAs£¹iÚV”if›r
 
	gv”if›r
;

353 
ASYLO_ASSERT_OK
(
v”if›r
.
In™Ÿlize
(
cÚfig_
));

355 
As£¹iÚ
 
	gas£¹iÚ
;

356 
S‘As£¹iÚDesütiÚ
(
as£¹iÚ
.
mubË_desütiÚ
());

358 
Sha256Hash
 
	ghash
;

359 
	ghash
.
Upd©e
(
kU£rD©a
);

360 
	gsgx
::
AligÃdR•Ütd©aPŒ
 
»pÜtd©a
;

361 *
	g»pÜtd©a
 = 
TrivŸlZ”oObjeù
<
sgx
::
R•Ütd©a
>();

362 
	g¡d
::
veùÜ
<
ušt8_t
> 
dige¡
;

363 
ASYLO_ASSERT_OK
(
hash
.
CumuÏtiveHash
(&
dige¡
));

364 
	g»pÜtd©a
->
	gd©a
.
»¶aû
Ğ0, 
dige¡
);

366 
	gsgx
::
AligÃdT¬g‘šfoPŒ
 
rg‘šfo
;

367 
	gsgx
::
S‘T¬g‘šfoFromS–fId’t™y
(
rg‘šfo
.
g‘
());

369 
	gsgx
::
AligÃdR•ÜtPŒ
 
»pÜt
;

370 
ASYLO_ASSERT_OK
(

371 
sgx
::
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

372 
	gsgx
::
LoÿlAs£¹iÚ
 
loÿl_as£¹iÚ
;

373 
	gloÿl_as£¹iÚ
.
£t_»pÜt
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»pÜt
.
g‘
()),

374 (*
»pÜt
));

375 
ASSERT_TRUE
(
loÿl_as£¹iÚ
.
S”ŸlizeToSŒšg
(
as£¹iÚ
.
mubË_as£¹iÚ
()));

377 
EnşaveId’t™y
 
	gid’t™y
;

378 
ASYLO_ASSERT_OK
(
v”if›r
.
V”ify
(
kU£rD©a
, 
as£¹iÚ
, &
id’t™y
));

380 cÚ¡ 
	gEnşaveId’t™yDesütiÚ
 &
	gdesütiÚ
 = 
id’t™y
.
desütiÚ
();

381 
EXPECT_EQ
(
desütiÚ
.
id’t™y_ty³
(), 
CODE_IDENTITY
);

382 
EXPECT_EQ
(
desütiÚ
.
authÜ™y_ty³
(), 
sgx
::
kSgxAuthÜiz©iÚAuthÜ™y
);

384 
	gsgx
::
CodeId’t™y
 
code_id’t™y
;

385 
ASSERT_TRUE
(
code_id’t™y
.
P¬£FromSŒšg
(
id’t™y
.identity()));

387 
	gsgx
::
CodeId’t™y
 
ex³ùed_id’t™y
 = 
sgx
::
G‘S–fId’t™y
()->
id’t™y
;

388 
EXPECT_THAT
(
code_id’t™y
, 
Equ®sPrÙo
(
ex³ùed_id’t™y
))

390 << 
	gcode_id’t™y
.
DebugSŒšg
() << "\nExpected identity:\n"

391 << 
	gex³ùed_id’t™y
.
DebugSŒšg
();

	@identity/sgx/sgx_local_secret_sealer.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_£ü‘_£®”.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"asylo/üy±o/«ad_üy±Ü.h
"

26 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

28 
	~"asylo/üy±o/ut/by‹s.h
"

29 
	~"asylo/id’t™y/id’t™y_aş.pb.h
"

30 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

31 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

32 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

33 
	~"asylo/id’t™y/sgx/loÿl_£ü‘_£®”_h–³rs.h
"

34 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

37 
Çme¥aû
 
	gasylo
 {

39 
usšg
 
	gex³rim’l
::
A—dCry±Ü
;

41 
cÚ¡ex´
 
size_t
 
	gkAes256GcmSivKeySize
 = 32;

43 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
>

44 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
() {

45 
sgx
::
CodeId’t™yM©chS³c
 
¥ec
;

46 
	gsgx
::
S‘DeçuÉM©chS³c
(&
¥ec
);

51 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

52 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

53 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

54 
	gsgx
::
S‘Ex³ù©iÚ
(
¥ec
, 
sgx
::
G‘S–fId’t™y
()->
id’t™y
, &
ex³ù©iÚ
);

55  
	gab¦
::
W¿pUnique
<
SgxLoÿlSeü‘S—Ër
>(

56 
Ãw
 
SgxLoÿlSeü‘S—Ër
(
ex³ù©iÚ
));

59 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
>

60 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
() {

61 
sgx
::
CodeId’t™yM©chS³c
 
¥ec
;

62 
	gsgx
::
S‘DeçuÉM©chS³c
(&
¥ec
);

63 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

64 
	gsgx
::
S‘Ex³ù©iÚ
(
¥ec
, 
sgx
::
G‘S–fId’t™y
()->
id’t™y
, &
ex³ù©iÚ
);

65  
	gab¦
::
W¿pUnique
<
SgxLoÿlSeü‘S—Ër
>(

66 
Ãw
 
SgxLoÿlSeü‘S—Ër
(
ex³ù©iÚ
));

69 
	gSgxLoÿlSeü‘S—Ër
::
SgxLoÿlSeü‘S—Ër
(

70 cÚ¡ 
sgx
::
CodeId’t™yEx³ù©iÚ
 &
deçuÉ_ş›Á_aş
)

71 : 
deçuÉ_ş›Á_aş_
{
deçuÉ_ş›Á_aş
} {}

73 
S—lšgRoÙTy³
 
SgxLoÿlSeü‘S—Ër
::
RoÙTy³
(ècÚ¡ {  
LOCAL
; }

75 
	g¡d
::
¡ršg
 
SgxLoÿlSeü‘S—Ër
::
RoÙName
() const {

76  
sgx
::
š‹º®
::
kSgxLoÿlSeü‘S—ËrRoÙName
;

79 
	g¡d
::
veùÜ
<
EnşaveId’t™yEx³ù©iÚ
> 
SgxLoÿlSeü‘S—Ër
::
RoÙAş
() const {

84 
Stus
 
	gSgxLoÿlSeü‘S—Ër
::
S‘DeçuÉH—d”
(

85 
S—ËdSeü‘H—d”
 *
h—d”
) const {

86 
S—lšgRoÙInfÜm©iÚ
 *
šfo
 = 
h—d”
->
mubË_roÙ_šfo
();

87 
	gšfo
->
£t_£®šg_roÙ_ty³
(
RoÙTy³
());

88 
	gšfo
->
£t_£®šg_roÙ_Çme
(
RoÙName
());

89 
	gsgx
::
S—ËdSeü‘Add™iÚ®Info
 
add™iÚ®_šfo
;

92 
	gadd™iÚ®_šfo
.
£t_ch”_su™e
(
sgx
::
AES256_GCM_SIV
);

93 cÚ¡ 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> &
ıusvn
 = 
sgx
::
G‘S–fId’t™y
()->cpusvn;

94 
	gadd™iÚ®_šfo
.
£t_ıusvn
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
ıusvn
.
d©a
()),

95 
ıusvn
.
size
());

96 ià(!
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(
šfo
->
mubË_add™iÚ®_šfo
())) {

97  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

100 
ASYLO_RETURN_IF_ERROR
(
sgx
::
S”ŸlizeSgxId’t™y
(

101 
sgx
::
G‘S–fId’t™y
()->
id’t™y
, 
h—d”
->
add_authÜ
()));

102  
	gsgx
::
S”ŸlizeSgxEx³ù©iÚ
(

103 
deçuÉ_ş›Á_aş_
, 
h—d”
->
mubË_ş›Á_aş
()->
mubË_ex³ù©iÚ
());

106 
	gStusOr
<
	gsize_t
> 
	gSgxLoÿlSeü‘S—Ër
::
MaxMes§geSize
(

107 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) const {

108 
sgx
::
Ch”Su™e
 
ch”_su™e
;

109 
ASYLO_ASSIGN_OR_RETURN
(

110 
ch”_su™e
,

111 
sgx
::
š‹º®
::
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(
h—d”
));

112  
	gA—dCry±Ü
::
MaxMes§geSize
(

113 
sgx
::
š‹º®
::
Ch”Su™eToA—dScheme
(
ch”_su™e
));

116 
	gStusOr
<
	gušt64_t
> 
	gSgxLoÿlSeü‘S—Ër
::
MaxS—ËdMes§ges
(

117 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) const {

118 
sgx
::
Ch”Su™e
 
ch”_su™e
;

119 
ASYLO_ASSIGN_OR_RETURN
(

120 
ch”_su™e
,

121 
sgx
::
š‹º®
::
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(
h—d”
));

122  
	gA—dCry±Ü
::
MaxS—ËdMes§ges
(

123 
sgx
::
š‹º®
::
Ch”Su™eToA—dScheme
(
ch”_su™e
));

126 
Stus
 
	gSgxLoÿlSeü‘S—Ër
::
S—l
(

127 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
,

128 
By‹CÚš”V›w
 
add™iÚ®_auth’tiÿ‹d_d©a
, By‹CÚš”V›w 
£ü‘
,

129 
S—ËdSeü‘
 *
£®ed_£ü‘
) {

130 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

131 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

132 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

133 
ASYLO_RETURN_IF_ERROR
(

134 
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

135 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
));

137 ià(!
	gh—d”
.
S”ŸlizeToSŒšg
(

138 
£®ed_£ü‘
->
mubË_£®ed_£ü‘_h—d”
())) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

142 
	g£®ed_£ü‘
->
£t_add™iÚ®_auth’tiÿ‹d_d©a
(

143 
»š‹½»t_ÿ¡
<cÚ¡ *>(
add™iÚ®_auth’tiÿ‹d_d©a
.
d©a
()),

144 
add™iÚ®_auth’tiÿ‹d_d©a
.
size
());

146 
	g¡d
::
¡ršg
 
fš®_add™iÚ®_d©a
;

147 
S”ŸlizeBy‹CÚš”s
(&
fš®_add™iÚ®_d©a
,

148 
£®ed_£ü‘
->
£®ed_£ü‘_h—d”
(),

149 
add™iÚ®_auth’tiÿ‹d_d©a
);

151 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

152 
ASYLO_RETURN_IF_ERROR
(
sgx
::
š‹º®
::
G’”©eCry±ÜKey
(

153 
ch”_su™e
, "deçuÉ_key_id", 
ıusvn
, 
sgx_ex³ù©iÚ
,

154 
kAes256GcmSivKeySize
, &
key
));

156 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

157 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

158 
sgx
::
š‹º®
::
MakeCry±Ü
(
ch”_su™e
, 
key
));

159  
	gsgx
::
š‹º®
::
S—l
(
üy±Ü
.
g‘
(), 
£ü‘
, 
fš®_add™iÚ®_d©a
,

160 
£®ed_£ü‘
);

163 
Stus
 
	gSgxLoÿlSeü‘S—Ër
::
Un£®
(cÚ¡ 
S—ËdSeü‘
 &
£®ed_£ü‘
,

164 
CËªsšgVeùÜ
<
ušt8_t
> *
£ü‘
) {

165 
S—ËdSeü‘H—d”
 
	gh—d”
;

166 ià(!
	gh—d”
.
P¬£FromSŒšg
(
£®ed_£ü‘
.
£®ed_£ü‘_h—d”
())) {

167  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

171 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

172 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

173 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

174 
ASYLO_RETURN_IF_ERROR
(

175 
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

176 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
));

178 
	g¡d
::
¡ršg
 
fš®_add™iÚ®_d©a
;

179 
S”ŸlizeBy‹CÚš”s
(&
fš®_add™iÚ®_d©a
,

180 
£®ed_£ü‘
.
£®ed_£ü‘_h—d”
(),

181 
£®ed_£ü‘
.
add™iÚ®_auth’tiÿ‹d_d©a
());

183 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

184 
ASYLO_RETURN_IF_ERROR
(
sgx
::
š‹º®
::
G’”©eCry±ÜKey
(

185 
ch”_su™e
, "deçuÉ_key_id", 
ıusvn
, 
sgx_ex³ù©iÚ
,

186 
kAes256GcmSivKeySize
, &
key
));

188 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

189 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

190 
sgx
::
š‹º®
::
MakeCry±Ü
(
ch”_su™e
, 
key
));

191  
	gsgx
::
š‹º®
::
O³n
(
üy±Ü
.
g‘
(), 
£®ed_£ü‘
,

192 
fš®_add™iÚ®_d©a
, 
£ü‘
);

	@identity/sgx/sgx_local_secret_sealer.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_£ü‘_£®”.h
"

21 
	~<memÜy
>

22 
	~<veùÜ
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"asylo/üy±o/«ad_üy±Ü.h
"

26 
	~"asylo/üy±o/ut/by‹_cÚš”_ut.h
"

27 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

28 
	~"asylo/üy±o/ut/by‹s.h
"

29 
	~"asylo/id’t™y/id’t™y_aş.pb.h
"

30 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

31 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

32 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

33 
	~"asylo/id’t™y/sgx/loÿl_£ü‘_£®”_h–³rs.h
"

34 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

37 
Çme¥aû
 
	gasylo
 {

39 
usšg
 
	gex³rim’l
::
A—dCry±Ü
;

41 
cÚ¡ex´
 
size_t
 
	gkAes256GcmSivKeySize
 = 32;

43 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
>

44 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
() {

45 
sgx
::
CodeId’t™yM©chS³c
 
¥ec
;

46 
	gsgx
::
S‘DeçuÉM©chS³c
(&
¥ec
);

51 
	g¥ec
.
£t_is_m»nşave_m©ch_»quœed
(
Œue
);

52 
	g¥ec
.
£t_is_mrsigÃr_m©ch_»quœed
(
çl£
);

53 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

54 
	gsgx
::
S‘Ex³ù©iÚ
(
¥ec
, 
sgx
::
G‘S–fId’t™y
()->
id’t™y
, &
ex³ù©iÚ
);

55  
	gab¦
::
W¿pUnique
<
SgxLoÿlSeü‘S—Ër
>(

56 
Ãw
 
SgxLoÿlSeü‘S—Ër
(
ex³ù©iÚ
));

59 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
>

60 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
() {

61 
sgx
::
CodeId’t™yM©chS³c
 
¥ec
;

62 
	gsgx
::
S‘DeçuÉM©chS³c
(&
¥ec
);

63 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

64 
	gsgx
::
S‘Ex³ù©iÚ
(
¥ec
, 
sgx
::
G‘S–fId’t™y
()->
id’t™y
, &
ex³ù©iÚ
);

65  
	gab¦
::
W¿pUnique
<
SgxLoÿlSeü‘S—Ër
>(

66 
Ãw
 
SgxLoÿlSeü‘S—Ër
(
ex³ù©iÚ
));

69 
	gSgxLoÿlSeü‘S—Ër
::
SgxLoÿlSeü‘S—Ër
(

70 cÚ¡ 
sgx
::
CodeId’t™yEx³ù©iÚ
 &
deçuÉ_ş›Á_aş
)

71 : 
deçuÉ_ş›Á_aş_
{
deçuÉ_ş›Á_aş
} {}

73 
S—lšgRoÙTy³
 
SgxLoÿlSeü‘S—Ër
::
RoÙTy³
(ècÚ¡ {  
LOCAL
; }

75 
	g¡d
::
¡ršg
 
SgxLoÿlSeü‘S—Ër
::
RoÙName
() const {

76  
sgx
::
š‹º®
::
kSgxLoÿlSeü‘S—ËrRoÙName
;

79 
	g¡d
::
veùÜ
<
EnşaveId’t™yEx³ù©iÚ
> 
SgxLoÿlSeü‘S—Ër
::
RoÙAş
() const {

84 
Stus
 
	gSgxLoÿlSeü‘S—Ër
::
S‘DeçuÉH—d”
(

85 
S—ËdSeü‘H—d”
 *
h—d”
) const {

86 
S—lšgRoÙInfÜm©iÚ
 *
šfo
 = 
h—d”
->
mubË_roÙ_šfo
();

87 
	gšfo
->
£t_£®šg_roÙ_ty³
(
RoÙTy³
());

88 
	gšfo
->
£t_£®šg_roÙ_Çme
(
RoÙName
());

89 
	gsgx
::
S—ËdSeü‘Add™iÚ®Info
 
add™iÚ®_šfo
;

92 
	gadd™iÚ®_šfo
.
£t_ch”_su™e
(
sgx
::
AES256_GCM_SIV
);

93 cÚ¡ 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> &
ıusvn
 = 
sgx
::
G‘S–fId’t™y
()->cpusvn;

94 
	gadd™iÚ®_šfo
.
£t_ıusvn
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
ıusvn
.
d©a
()),

95 
ıusvn
.
size
());

96 ià(!
	gadd™iÚ®_šfo
.
S”ŸlizeToSŒšg
(
šfo
->
mubË_add™iÚ®_šfo
())) {

97  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

100 
ASYLO_RETURN_IF_ERROR
(
sgx
::
S”ŸlizeSgxId’t™y
(

101 
sgx
::
G‘S–fId’t™y
()->
id’t™y
, 
h—d”
->
add_authÜ
()));

102  
	gsgx
::
S”ŸlizeSgxEx³ù©iÚ
(

103 
deçuÉ_ş›Á_aş_
, 
h—d”
->
mubË_ş›Á_aş
()->
mubË_ex³ù©iÚ
());

106 
	gStusOr
<
	gsize_t
> 
	gSgxLoÿlSeü‘S—Ër
::
MaxMes§geSize
(

107 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) const {

108 
sgx
::
Ch”Su™e
 
ch”_su™e
;

109 
ASYLO_ASSIGN_OR_RETURN
(

110 
ch”_su™e
,

111 
sgx
::
š‹º®
::
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(
h—d”
));

112  
	gA—dCry±Ü
::
MaxMes§geSize
(

113 
sgx
::
š‹º®
::
Ch”Su™eToA—dScheme
(
ch”_su™e
));

116 
	gStusOr
<
	gušt64_t
> 
	gSgxLoÿlSeü‘S—Ër
::
MaxS—ËdMes§ges
(

117 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
) const {

118 
sgx
::
Ch”Su™e
 
ch”_su™e
;

119 
ASYLO_ASSIGN_OR_RETURN
(

120 
ch”_su™e
,

121 
sgx
::
š‹º®
::
P¬£Ch”Su™eFromS—ËdSeü‘H—d”
(
h—d”
));

122  
	gA—dCry±Ü
::
MaxS—ËdMes§ges
(

123 
sgx
::
š‹º®
::
Ch”Su™eToA—dScheme
(
ch”_su™e
));

126 
Stus
 
	gSgxLoÿlSeü‘S—Ër
::
S—l
(

127 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
,

128 
By‹CÚš”V›w
 
add™iÚ®_auth’tiÿ‹d_d©a
, By‹CÚš”V›w 
£ü‘
,

129 
S—ËdSeü‘
 *
£®ed_£ü‘
) {

130 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

131 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

132 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

133 
ASYLO_RETURN_IF_ERROR
(

134 
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

135 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
));

137 ià(!
	gh—d”
.
S”ŸlizeToSŒšg
(

138 
£®ed_£ü‘
->
mubË_£®ed_£ü‘_h—d”
())) {

139  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

142 
	g£®ed_£ü‘
->
£t_add™iÚ®_auth’tiÿ‹d_d©a
(

143 
»š‹½»t_ÿ¡
<cÚ¡ *>(
add™iÚ®_auth’tiÿ‹d_d©a
.
d©a
()),

144 
add™iÚ®_auth’tiÿ‹d_d©a
.
size
());

146 
	g¡d
::
¡ršg
 
fš®_add™iÚ®_d©a
;

147 
S”ŸlizeBy‹CÚš”s
(&
fš®_add™iÚ®_d©a
,

148 
£®ed_£ü‘
->
£®ed_£ü‘_h—d”
(),

149 
add™iÚ®_auth’tiÿ‹d_d©a
);

151 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

152 
ASYLO_RETURN_IF_ERROR
(
sgx
::
š‹º®
::
G’”©eCry±ÜKey
(

153 
ch”_su™e
, "deçuÉ_key_id", 
ıusvn
, 
sgx_ex³ù©iÚ
,

154 
kAes256GcmSivKeySize
, &
key
));

156 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

157 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

158 
sgx
::
š‹º®
::
MakeCry±Ü
(
ch”_su™e
, 
key
));

159  
	gsgx
::
š‹º®
::
S—l
(
üy±Ü
.
g‘
(), 
£ü‘
, 
fš®_add™iÚ®_d©a
,

160 
£®ed_£ü‘
);

163 
Stus
 
	gSgxLoÿlSeü‘S—Ër
::
Un£®
(cÚ¡ 
S—ËdSeü‘
 &
£®ed_£ü‘
,

164 
CËªsšgVeùÜ
<
ušt8_t
> *
£ü‘
) {

165 
S—ËdSeü‘H—d”
 
	gh—d”
;

166 ià(!
	gh—d”
.
P¬£FromSŒšg
(
£®ed_£ü‘
.
£®ed_£ü‘_h—d”
())) {

167  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

171 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

172 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

173 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

174 
ASYLO_RETURN_IF_ERROR
(

175 
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

176 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
));

178 
	g¡d
::
¡ršg
 
fš®_add™iÚ®_d©a
;

179 
S”ŸlizeBy‹CÚš”s
(&
fš®_add™iÚ®_d©a
,

180 
£®ed_£ü‘
.
£®ed_£ü‘_h—d”
(),

181 
£®ed_£ü‘
.
add™iÚ®_auth’tiÿ‹d_d©a
());

183 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey
;

184 
ASYLO_RETURN_IF_ERROR
(
sgx
::
š‹º®
::
G’”©eCry±ÜKey
(

185 
ch”_su™e
, "deçuÉ_key_id", 
ıusvn
, 
sgx_ex³ù©iÚ
,

186 
kAes256GcmSivKeySize
, &
key
));

188 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

189 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

190 
sgx
::
š‹º®
::
MakeCry±Ü
(
ch”_su™e
, 
key
));

191  
	gsgx
::
š‹º®
::
O³n
(
üy±Ü
.
g‘
(), 
£®ed_£ü‘
,

192 
fš®_add™iÚ®_d©a
, 
£ü‘
);

	@identity/sgx/sgx_local_secret_sealer.h

19 #iâdeà
ASYLO_IDENTITY_SGX_SGX_LOCAL_SECRET_SEALER_H_


20 
	#ASYLO_IDENTITY_SGX_SGX_LOCAL_SECRET_SEALER_H_


	)

22 
	~<memÜy
>

24 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

25 
	~"asylo/id’t™y/id’t™y.pb.h
"

26 
	~"asylo/id’t™y/£®ed_£ü‘.pb.h
"

27 
	~"asylo/id’t™y/£ü‘_£®”.h
"

28 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

29 
	~"asylo/ut/ş—nsšg_ty³s.h
"

30 
	~"asylo/ut/¡©us.h
"

32 
Çme¥aû
 
	gasylo
 {

107 şas 
	cSgxLoÿlSeü‘S—Ër
 : 
public
 
Seü‘S—Ër
 {

108 
public
:

113 
¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
C»©eM»nşaveSeü‘S—Ër
();

119 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
C»©eMrsigÃrSeü‘S—Ër
();

121 
SgxLoÿlSeü‘S—Ër
(cÚ¡ SgxLoÿlSeü‘S—Ë¸&
Ùh”
èğ
d–‘e
;

122 
	gvœtu®
 ~
SgxLoÿlSeü‘S—Ër
() = ;

124 
	gSgxLoÿlSeü‘S—Ër
 &
	gİ”©Ü
=(cÚ¡ 
SgxLoÿlSeü‘S—Ër
 &
Ùh”
èğ
d–‘e
;

127 
S—lšgRoÙTy³
 
RoÙTy³
(ècÚ¡ 
	gov”ride
;

128 
	g¡d
::
¡ršg
 
RoÙName
(ècÚ¡ 
ov”ride
;

129 
	g¡d
::
veùÜ
<
EnşaveId’t™yEx³ù©iÚ
> 
RoÙAş
(ècÚ¡ 
ov”ride
;

130 
Stus
 
S‘DeçuÉH—d”
(
S—ËdSeü‘H—d”
 *
h—d”
ècÚ¡ 
	gov”ride
;

131 
	gStusOr
<
	gsize_t
> 
MaxMes§geSize
(

132 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
ècÚ¡ 
	gov”ride
;

133 
	gStusOr
<
	gušt64_t
> 
MaxS—ËdMes§ges
(

134 cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
ècÚ¡ 
	gov”ride
;

135 
Stus
 
S—l
(cÚ¡ 
S—ËdSeü‘H—d”
 &
h—d”
,

136 
By‹CÚš”V›w
 
add™iÚ®_auth’tiÿ‹d_d©a
,

137 
By‹CÚš”V›w
 
£ü‘
, 
S—ËdSeü‘
 *
£®ed_£ü‘
è
	gov”ride
;

138 
Stus
 
Un£®
(cÚ¡ 
S—ËdSeü‘
 &
£®ed_£ü‘
,

139 
CËªsšgVeùÜ
<
ušt8_t
> *
£ü‘
è
	gov”ride
;

141 
	g´iv©e
:

144 
SgxLoÿlSeü‘S—Ër
(cÚ¡ 
sgx
::
CodeId’t™yEx³ù©iÚ
 &
deçuÉ_ş›Á_aş
);

147 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
deçuÉ_ş›Á_aş_
;

	@identity/sgx/sgx_local_secret_sealer_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_£ü‘_£®”.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/üy±o/ut/by‹s.h
"

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

28 
	~"asylo/id’t™y/id’t™y.pb.h
"

29 
	~"asylo/id’t™y/id’t™y_aş.pb.h
"

30 
	~"asylo/id’t™y/£®ed_£ü‘.pb.h
"

31 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

32 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

33 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

34 
	~"asylo/id’t™y/sgx/loÿl_£®ed_£ü‘.pb.h
"

35 
	~"asylo/id’t™y/sgx/loÿl_£ü‘_£®”_h–³rs.h
"

36 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

37 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©usÜ.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
	gÇme¥aû
 {

45 
	gusšg
 ::
‹¡šg
::
NÙ
;

47 
cÚ¡ex´
 
	gkBadRoÙName
[] = "BAD";

48 
cÚ¡ex´
 
	gkBadAdd™iÚ®Info
[] = "BAD";

49 
cÚ¡ex´
 
	gkBadCpusvn
[] = "BAD";

50 
cÚ¡ex´
 
	gkTe¡SŒšg
[] = "test";

51 
cÚ¡ex´
 
	gsgx
::
Ch”Su™e
 
kBadCh”Su™e
 = 
sgx
::
UNKNOWN_CIPHER_SUITE
;

52 
cÚ¡ex´
 
	gkTe¡Aad
[] = "Mary had‡†ittle†amb";

53 
cÚ¡ex´
 
	gkTe¡Seü‘
[] = "Its fleece was white‡s snow";

54 
cÚ¡ex´
 
size_t
 
	gkTe¡Seü‘Size
 = (
kTe¡Seü‘
) - 1;

58 şas 
	cSgxLoÿlSeü‘S—ËrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

59 
´Ùeùed
:

60 
SgxLoÿlSeü‘S—ËrTe¡
() {

64 
’şave_
.
»£t
(
sgx
::
RªdomFakeEnşaveFaùÜy
::
CÚ¡ruù
());

65 } 
	g’şave_
->
g‘_isvsvn
() == 0xFFFF);

66 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_
);

71 
	g’şave_cİy_difã»Á_m»nşave_
 =

72 
ab¦
::
make_unique
<
sgx
::
FakeEnşave
>(*
’şave_
);

73 
	g’şave_cİy_difã»Á_m»nşave_
->
£t_m»nşave
(

74 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>());

79 
	g’şave_cİy_difã»Á_mrsigÃr_
 =

80 
ab¦
::
make_unique
<
sgx
::
FakeEnşave
>(*
’şave_
);

81 
	g’şave_cİy_difã»Á_mrsigÃr_
->
£t_mrsigÃr
(

82 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>());

88 
	g’şave_cİy_high”_isvsvn_
 =

89 
ab¦
::
make_unique
<
sgx
::
FakeEnşave
>(*
’şave_
);

90 
	g’şave_cİy_high”_isvsvn_
->
£t_isvsvn
(
’şave_
->
g‘_isvsvn
() + 1);

93 ~
SgxLoÿlSeü‘S—ËrTe¡
(è
	gov”ride
 { 
	gsgx
::
FakeEnşave
::
Ex™Enşave
(); }

95 
P»·»S—ËdSeü‘H—d”
(cÚ¡ 
SgxLoÿlSeü‘S—Ër
 &
£®”
,

96 
S—ËdSeü‘H—d”
 *
h—d”
) {

97 
ASSERT_THAT
(
£®”
.
S‘DeçuÉH—d”
(
h—d”
), 
IsOk
());

98 
	gh—d”
->
£t_£ü‘_Çme
(
kTe¡SŒšg
);

99 
	gh—d”
->
£t_£ü‘_v”siÚ
(
kTe¡SŒšg
);

100 
	gh—d”
->
£t_£ü‘_pu½o£
(
kTe¡SŒšg
);

101 
	gh—d”
->
£t_£ü‘_hªdlšg_pŞicy
(
kTe¡SŒšg
);

104 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_
;

105 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_cİy_difã»Á_m»nşave_
;

106 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_cİy_difã»Á_mrsigÃr_
;

107 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_cİy_high”_isvsvn_
;

110 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
V”ifyRoÙTy³
) {

111 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

112 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

113 
EXPECT_EQ
(
£®”
->
RoÙTy³
(), 
LOCAL
);

115 
	g£®”
 = 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

116 
EXPECT_EQ
(
£®”
->
RoÙTy³
(), 
LOCAL
);

119 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
V”ifyRoÙName
) {

120 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

121 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

122 
EXPECT_EQ
(
£®”
->
RoÙName
(), 
sgx
::
š‹º®
::
kSgxLoÿlSeü‘S—ËrRoÙName
);

124 
	g£®”
 = 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

125 
EXPECT_EQ
(
£®”
->
RoÙName
(), 
sgx
::
š‹º®
::
kSgxLoÿlSeü‘S—ËrRoÙName
);

128 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
V”ifyRoÙAş
) {

129 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

130 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

131 
EXPECT_TRUE
(
£®”
->
RoÙAş
().
em±y
());

133 
	g£®”
 = 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

134 
EXPECT_TRUE
(
£®”
->
RoÙAş
().
em±y
());

139 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadS—lšgRoÙTy³
) {

140 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

141 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

142 
S—ËdSeü‘H—d”
 
	gh—d”
;

143 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

144 
	gh—d”
.
mubË_roÙ_šfo
()->
£t_£®šg_roÙ_ty³
(
REMOTE
);

146 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

147 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

148 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

149 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

150 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

156 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadS—lšgRoÙName
) {

157 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

158 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

159 
S—ËdSeü‘H—d”
 
	gh—d”
;

160 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

161 
	gh—d”
.
mubË_roÙ_šfo
()->
£t_£®šg_roÙ_Çme
(
kBadRoÙName
);

163 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

164 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

165 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

166 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

167 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

168 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

173 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadAdd™iÚ®Info
) {

174 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

175 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

176 
S—ËdSeü‘H—d”
 
	gh—d”
;

177 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

178 
	gh—d”
.
mubË_roÙ_šfo
()->
£t_add™iÚ®_šfo
(
kBadAdd™iÚ®Info
);

180 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

181 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

182 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

183 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

184 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

185 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

190 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadCpusvn
) {

191 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

192 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

193 
S—ËdSeü‘H—d”
 
	gh—d”
;

194 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

195 
	gsgx
::
S—ËdSeü‘Add™iÚ®Info
 
šfo
;

196 
	gšfo
.
£t_ıusvn
(
kBadCpusvn
);

197 
ASSERT_TRUE
(
šfo
.
S”ŸlizeToSŒšg
(

198 
h—d”
.
mubË_roÙ_šfo
()->
mubË_add™iÚ®_šfo
()));

200 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

201 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

202 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

203 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

204 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

205 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

210 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadCh”Su™e
) {

211 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

212 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

213 
S—ËdSeü‘H—d”
 
	gh—d”
;

214 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

215 
	gsgx
::
S—ËdSeü‘Add™iÚ®Info
 
šfo
;

216 
	gšfo
.
£t_ch”_su™e
(
kBadCh”Su™e
);

217 
ASSERT_TRUE
(
šfo
.
S”ŸlizeToSŒšg
(

218 
h—d”
.
mubË_roÙ_šfo
()->
mubË_add™iÚ®_šfo
()));

220 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

221 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

222 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

223 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

224 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

225 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

230 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadCl›ÁAş
) {

231 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

232 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

233 
S—ËdSeü‘H—d”
 
	gh—d”
;

234 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

236 
	gsgx
::
CodeId’t™yM©chS³c
 
¥ec
;

237 
ASSERT_THAT
(
sgx
::
S‘DeçuÉM©chS³c
(&
¥ec
), 
IsOk
());

238 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

239 
ASSERT_TRUE
(

240 
sgx
::
S‘Ex³ù©iÚ
(
¥ec
, sgx::
G‘S–fId’t™y
()->
id’t™y
, &
ex³ù©iÚ
)

241 .
ok
());

242 
ASSERT_TRUE
(

243 
sgx
::
S”ŸlizeSgxEx³ù©iÚ
(
ex³ù©iÚ
, 
h—d”
.
mubË_ş›Á_aş
()

244 ->
mubË_aş_group
()

245 ->
add_´ediÿ‹s
()

246 ->
mubË_ex³ù©iÚ
())

247 .
ok
());

248 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

249 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

250 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

251 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

252 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

253 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

258 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

259 
P¬£KeyG’”©iÚP¬amsM»nşaveSucûssSameEnşave
) {

260 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

261 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

262 
S—ËdSeü‘H—d”
 
	gh—d”
;

263 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

265 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

266 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

267 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

268 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

269 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

270 .
ok
());

271 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

272 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

278 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

279 
P¬£KeyG’”©iÚP¬amsM»nşaveSucûssDifã»ÁMrsigÃr
) {

280 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

281 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

282 
S—ËdSeü‘H—d”
 
	gh—d”
;

283 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

286 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

287 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_mrsigÃr_
);

289 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

290 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

291 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

292 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

293 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

294 .
ok
());

295 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

296 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

301 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsM»nşaveFau»
) {

302 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

303 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

304 
S—ËdSeü‘H—d”
 
	gh—d”
;

305 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

308 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

309 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

311 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

312 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

313 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

314 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

315 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

316 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
));

321 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

322 
P¬£KeyG’”©iÚP¬amsMrsigÃrSucûssSameEnşave
) {

323 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

324 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

325 
S—ËdSeü‘H—d”
 
	gh—d”
;

326 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

328 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

329 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

330 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

331 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

332 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

333 .
ok
());

334 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

335 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

341 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

342 
P¬£KeyG’”©iÚP¬amsMrsigÃrSucûssDifã»ÁM»nşave
) {

343 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

344 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

345 
S—ËdSeü‘H—d”
 
	gh—d”
;

346 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

349 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

350 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

352 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

353 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

354 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

355 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

356 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

357 .
ok
());

358 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

359 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

364 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

365 
P¬£KeyG’”©iÚP¬amsMrsigÃrSucûssHigh”Svn
) {

366 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

367 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

368 
S—ËdSeü‘H—d”
 
	gh—d”
;

369 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

372 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

373 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_high”_isvsvn_
);

375 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

376 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

377 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

378 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

379 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

380 .
ok
());

381 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

382 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

387 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsMrsigÃrFau»
) {

388 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

389 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

390 
S—ËdSeü‘H—d”
 
	gh—d”
;

391 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

394 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

395 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_mrsigÃr_
);

397 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

398 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

399 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

400 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

401 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

402 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
));

407 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®M»nşaveSucûssSameEnşave
) {

408 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

409 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

410 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

412 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

413 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

414 
S—ËdSeü‘H—d”
 
	gh—d”
;

415 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

417 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

418 
ASSERT_TRUE
(

419 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

421 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

422 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

423 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

424 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

426 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

431 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®M»nşaveFau»Difã»ÁM»nşave
) {

432 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

433 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

434 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

436 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

437 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

438 
S—ËdSeü‘H—d”
 
	gh—d”
;

439 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

441 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

442 
ASSERT_TRUE
(

443 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

446 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

447 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

449 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

450 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

451 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

452 
EXPECT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
NÙ
(
IsOk
()));

457 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®MrsigÃrSucûssSameEnşave
) {

458 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

459 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

460 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

462 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

463 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

464 
S—ËdSeü‘H—d”
 
	gh—d”
;

465 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

467 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

468 
ASSERT_TRUE
(

469 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

471 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

472 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

473 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

474 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

476 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

481 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®MrsigÃrSucûssSameMrsigÃr
) {

482 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

483 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

484 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

486 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

487 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

488 
S—ËdSeü‘H—d”
 
	gh—d”
;

489 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

491 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

492 
ASSERT_TRUE
(

493 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

497 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

498 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

500 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

501 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

502 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

503 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

505 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

510 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

511 
S—lUn£®MrsigÃrSucûssSameMrsigÃrHigh”Svn
) {

512 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

513 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

514 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

516 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

517 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

518 
S—ËdSeü‘H—d”
 
	gh—d”
;

519 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

521 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

522 
ASSERT_TRUE
(

523 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

527 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

528 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_high”_isvsvn_
);

530 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

531 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

532 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

533 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

535 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

540 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®MrsigÃrFau»Difã»ÁMrsigÃr
) {

541 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

542 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

543 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

545 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

546 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

547 
S—ËdSeü‘H—d”
 
	gh—d”
;

548 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

550 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

551 
ASSERT_TRUE
(

552 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

555 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

556 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_mrsigÃr_
);

558 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

559 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

560 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

561 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
NÙ
(
IsOk
()));

566 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

567 
S—lUn£®MrsigÃrFau»SameMrsigÃrLow”Svn
) {

568 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

569 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

570 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

572 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

573 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_high”_isvsvn_
);

575 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

576 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

577 
S—ËdSeü‘H—d”
 
	gh—d”
;

578 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

580 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

581 
ASSERT_TRUE
(

582 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

586 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

587 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_
);

589 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

590 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

591 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

592 
EXPECT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
NÙ
(
IsOk
()));

	@identity/sgx/sgx_local_secret_sealer_test.cc

19 
	~"asylo/id’t™y/sgx/sgx_loÿl_£ü‘_£®”.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/üy±o/ut/by‹s.h
"

27 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

28 
	~"asylo/id’t™y/id’t™y.pb.h
"

29 
	~"asylo/id’t™y/id’t™y_aş.pb.h
"

30 
	~"asylo/id’t™y/£®ed_£ü‘.pb.h
"

31 
	~"asylo/id’t™y/sgx/code_id’t™y.pb.h
"

32 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

33 
	~"asylo/id’t™y/sgx/çke_’şave.h
"

34 
	~"asylo/id’t™y/sgx/loÿl_£®ed_£ü‘.pb.h
"

35 
	~"asylo/id’t™y/sgx/loÿl_£ü‘_£®”_h–³rs.h
"

36 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

37 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©usÜ.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
	gÇme¥aû
 {

45 
	gusšg
 ::
‹¡šg
::
NÙ
;

47 
cÚ¡ex´
 
	gkBadRoÙName
[] = "BAD";

48 
cÚ¡ex´
 
	gkBadAdd™iÚ®Info
[] = "BAD";

49 
cÚ¡ex´
 
	gkBadCpusvn
[] = "BAD";

50 
cÚ¡ex´
 
	gkTe¡SŒšg
[] = "test";

51 
cÚ¡ex´
 
	gsgx
::
Ch”Su™e
 
kBadCh”Su™e
 = 
sgx
::
UNKNOWN_CIPHER_SUITE
;

52 
cÚ¡ex´
 
	gkTe¡Aad
[] = "Mary had‡†ittle†amb";

53 
cÚ¡ex´
 
	gkTe¡Seü‘
[] = "Its fleece was white‡s snow";

54 
cÚ¡ex´
 
size_t
 
	gkTe¡Seü‘Size
 = (
kTe¡Seü‘
) - 1;

58 şas 
	cSgxLoÿlSeü‘S—ËrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

59 
´Ùeùed
:

60 
SgxLoÿlSeü‘S—ËrTe¡
() {

64 
’şave_
.
»£t
(
sgx
::
RªdomFakeEnşaveFaùÜy
::
CÚ¡ruù
());

65 } 
	g’şave_
->
g‘_isvsvn
() == 0xFFFF);

66 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_
);

71 
	g’şave_cİy_difã»Á_m»nşave_
 =

72 
ab¦
::
make_unique
<
sgx
::
FakeEnşave
>(*
’şave_
);

73 
	g’şave_cİy_difã»Á_m»nşave_
->
£t_m»nşave
(

74 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>());

79 
	g’şave_cİy_difã»Á_mrsigÃr_
 =

80 
ab¦
::
make_unique
<
sgx
::
FakeEnşave
>(*
’şave_
);

81 
	g’şave_cİy_difã»Á_mrsigÃr_
->
£t_mrsigÃr
(

82 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
SHA256_DIGEST_LENGTH
>>());

88 
	g’şave_cİy_high”_isvsvn_
 =

89 
ab¦
::
make_unique
<
sgx
::
FakeEnşave
>(*
’şave_
);

90 
	g’şave_cİy_high”_isvsvn_
->
£t_isvsvn
(
’şave_
->
g‘_isvsvn
() + 1);

93 ~
SgxLoÿlSeü‘S—ËrTe¡
(è
	gov”ride
 { 
	gsgx
::
FakeEnşave
::
Ex™Enşave
(); }

95 
P»·»S—ËdSeü‘H—d”
(cÚ¡ 
SgxLoÿlSeü‘S—Ër
 &
£®”
,

96 
S—ËdSeü‘H—d”
 *
h—d”
) {

97 
ASSERT_THAT
(
£®”
.
S‘DeçuÉH—d”
(
h—d”
), 
IsOk
());

98 
	gh—d”
->
£t_£ü‘_Çme
(
kTe¡SŒšg
);

99 
	gh—d”
->
£t_£ü‘_v”siÚ
(
kTe¡SŒšg
);

100 
	gh—d”
->
£t_£ü‘_pu½o£
(
kTe¡SŒšg
);

101 
	gh—d”
->
£t_£ü‘_hªdlšg_pŞicy
(
kTe¡SŒšg
);

104 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_
;

105 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_cİy_difã»Á_m»nşave_
;

106 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_cİy_difã»Á_mrsigÃr_
;

107 
	g¡d
::
unique_±r
<
sgx
::
FakeEnşave
> 
’şave_cİy_high”_isvsvn_
;

110 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
V”ifyRoÙTy³
) {

111 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

112 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

113 
EXPECT_EQ
(
£®”
->
RoÙTy³
(), 
LOCAL
);

115 
	g£®”
 = 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

116 
EXPECT_EQ
(
£®”
->
RoÙTy³
(), 
LOCAL
);

119 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
V”ifyRoÙName
) {

120 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

121 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

122 
EXPECT_EQ
(
£®”
->
RoÙName
(), 
sgx
::
š‹º®
::
kSgxLoÿlSeü‘S—ËrRoÙName
);

124 
	g£®”
 = 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

125 
EXPECT_EQ
(
£®”
->
RoÙName
(), 
sgx
::
š‹º®
::
kSgxLoÿlSeü‘S—ËrRoÙName
);

128 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
V”ifyRoÙAş
) {

129 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

130 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

131 
EXPECT_TRUE
(
£®”
->
RoÙAş
().
em±y
());

133 
	g£®”
 = 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

134 
EXPECT_TRUE
(
£®”
->
RoÙAş
().
em±y
());

139 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadS—lšgRoÙTy³
) {

140 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

141 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

142 
S—ËdSeü‘H—d”
 
	gh—d”
;

143 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

144 
	gh—d”
.
mubË_roÙ_šfo
()->
£t_£®šg_roÙ_ty³
(
REMOTE
);

146 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

147 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

148 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

149 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

150 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

156 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadS—lšgRoÙName
) {

157 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

158 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

159 
S—ËdSeü‘H—d”
 
	gh—d”
;

160 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

161 
	gh—d”
.
mubË_roÙ_šfo
()->
£t_£®šg_roÙ_Çme
(
kBadRoÙName
);

163 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

164 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

165 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

166 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

167 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

168 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

173 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadAdd™iÚ®Info
) {

174 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

175 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

176 
S—ËdSeü‘H—d”
 
	gh—d”
;

177 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

178 
	gh—d”
.
mubË_roÙ_šfo
()->
£t_add™iÚ®_šfo
(
kBadAdd™iÚ®Info
);

180 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

181 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

182 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

183 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

184 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

185 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

190 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadCpusvn
) {

191 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

192 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

193 
S—ËdSeü‘H—d”
 
	gh—d”
;

194 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

195 
	gsgx
::
S—ËdSeü‘Add™iÚ®Info
 
šfo
;

196 
	gšfo
.
£t_ıusvn
(
kBadCpusvn
);

197 
ASSERT_TRUE
(
šfo
.
S”ŸlizeToSŒšg
(

198 
h—d”
.
mubË_roÙ_šfo
()->
mubË_add™iÚ®_šfo
()));

200 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

201 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

202 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

203 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

204 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

205 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

210 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadCh”Su™e
) {

211 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

212 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

213 
S—ËdSeü‘H—d”
 
	gh—d”
;

214 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

215 
	gsgx
::
S—ËdSeü‘Add™iÚ®Info
 
šfo
;

216 
	gšfo
.
£t_ch”_su™e
(
kBadCh”Su™e
);

217 
ASSERT_TRUE
(
šfo
.
S”ŸlizeToSŒšg
(

218 
h—d”
.
mubË_roÙ_šfo
()->
mubË_add™iÚ®_šfo
()));

220 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

221 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

222 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

223 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

224 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

225 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

230 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsBadCl›ÁAş
) {

231 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

232 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

233 
S—ËdSeü‘H—d”
 
	gh—d”
;

234 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

236 
	gsgx
::
CodeId’t™yM©chS³c
 
¥ec
;

237 
ASSERT_THAT
(
sgx
::
S‘DeçuÉM©chS³c
(&
¥ec
), 
IsOk
());

238 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
ex³ù©iÚ
;

239 
ASSERT_TRUE
(

240 
sgx
::
S‘Ex³ù©iÚ
(
¥ec
, sgx::
G‘S–fId’t™y
()->
id’t™y
, &
ex³ù©iÚ
)

241 .
ok
());

242 
ASSERT_TRUE
(

243 
sgx
::
S”ŸlizeSgxEx³ù©iÚ
(
ex³ù©iÚ
, 
h—d”
.
mubË_ş›Á_aş
()

244 ->
mubË_aş_group
()

245 ->
add_´ediÿ‹s
()

246 ->
mubË_ex³ù©iÚ
())

247 .
ok
());

248 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

249 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

250 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

251 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

252 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

253 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

258 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

259 
P¬£KeyG’”©iÚP¬amsM»nşaveSucûssSameEnşave
) {

260 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

261 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

262 
S—ËdSeü‘H—d”
 
	gh—d”
;

263 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

265 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

266 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

267 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

268 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

269 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

270 .
ok
());

271 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

272 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

278 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

279 
P¬£KeyG’”©iÚP¬amsM»nşaveSucûssDifã»ÁMrsigÃr
) {

280 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

281 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

282 
S—ËdSeü‘H—d”
 
	gh—d”
;

283 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

286 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

287 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_mrsigÃr_
);

289 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

290 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

291 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

292 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

293 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

294 .
ok
());

295 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

296 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

301 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsM»nşaveFau»
) {

302 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

303 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

304 
S—ËdSeü‘H—d”
 
	gh—d”
;

305 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

308 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

309 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

311 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

312 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

313 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

314 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

315 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

316 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
));

321 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

322 
P¬£KeyG’”©iÚP¬amsMrsigÃrSucûssSameEnşave
) {

323 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

324 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

325 
S—ËdSeü‘H—d”
 
	gh—d”
;

326 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

328 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

329 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

330 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

331 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

332 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

333 .
ok
());

334 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

335 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

341 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

342 
P¬£KeyG’”©iÚP¬amsMrsigÃrSucûssDifã»ÁM»nşave
) {

343 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

344 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

345 
S—ËdSeü‘H—d”
 
	gh—d”
;

346 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

349 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

350 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

352 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

353 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

354 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

355 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

356 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

357 .
ok
());

358 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

359 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

364 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

365 
P¬£KeyG’”©iÚP¬amsMrsigÃrSucûssHigh”Svn
) {

366 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

367 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

368 
S—ËdSeü‘H—d”
 
	gh—d”
;

369 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

372 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

373 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_high”_isvsvn_
);

375 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

376 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

377 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

378 
EXPECT_TRUE
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

379 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
)

380 .
ok
());

381 
EXPECT_EQ
(
ıusvn
, 
sgx
::
FakeEnşave
::
G‘Cu¼’tEnşave
()->
g‘_ıusvn
());

382 
EXPECT_EQ
(
ch”_su™e
, 
sgx
::
AES256_GCM_SIV
);

387 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
P¬£KeyG’”©iÚP¬amsMrsigÃrFau»
) {

388 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

389 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

390 
S—ËdSeü‘H—d”
 
	gh—d”
;

391 
	g£®”
->
S‘DeçuÉH—d”
(&
h—d”
);

394 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

395 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_mrsigÃr_
);

397 
	gUn§ãBy‹s
<
	gsgx
::
kCpusvnSize
> 
ıusvn
;

398 
	gsgx
::
Ch”Su™e
 
ch”_su™e
;

399 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
sgx_ex³ù©iÚ
;

400 
EXPECT_THAT
(
sgx
::
š‹º®
::
P¬£KeyG’”©iÚP¬amsFromS—ËdSeü‘H—d”
(

401 
h—d”
, &
ıusvn
, &
ch”_su™e
, &
sgx_ex³ù©iÚ
),

402 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
));

407 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®M»nşaveSucûssSameEnşave
) {

408 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

409 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

410 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

412 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

413 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

414 
S—ËdSeü‘H—d”
 
	gh—d”
;

415 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

417 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

418 
ASSERT_TRUE
(

419 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

421 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

422 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

423 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

424 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

426 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

431 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®M»nşaveFau»Difã»ÁM»nşave
) {

432 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

433 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

434 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

436 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

437 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

438 
S—ËdSeü‘H—d”
 
	gh—d”
;

439 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

441 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

442 
ASSERT_TRUE
(

443 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

446 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

447 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

449 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

450 
SgxLoÿlSeü‘S—Ër
::
C»©eM»nşaveSeü‘S—Ër
();

451 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

452 
EXPECT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
NÙ
(
IsOk
()));

457 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®MrsigÃrSucûssSameEnşave
) {

458 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

459 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

460 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

462 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

463 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

464 
S—ËdSeü‘H—d”
 
	gh—d”
;

465 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

467 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

468 
ASSERT_TRUE
(

469 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

471 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

472 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

473 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

474 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

476 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

481 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®MrsigÃrSucûssSameMrsigÃr
) {

482 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

483 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

484 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

486 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

487 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

488 
S—ËdSeü‘H—d”
 
	gh—d”
;

489 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

491 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

492 
ASSERT_TRUE
(

493 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

497 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

498 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_m»nşave_
);

500 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

501 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

502 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

503 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

505 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

510 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

511 
S—lUn£®MrsigÃrSucûssSameMrsigÃrHigh”Svn
) {

512 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

513 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

514 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

516 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

517 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

518 
S—ËdSeü‘H—d”
 
	gh—d”
;

519 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

521 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

522 
ASSERT_TRUE
(

523 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

527 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

528 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_high”_isvsvn_
);

530 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

531 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

532 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

533 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
IsOk
());

535 
EXPECT_EQ
(
šput_£ü‘
, 
ouut_£ü‘
);

540 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
, 
S—lUn£®MrsigÃrFau»Difã»ÁMrsigÃr
) {

541 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

542 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

543 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

545 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

546 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

547 
S—ËdSeü‘H—d”
 
	gh—d”
;

548 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

550 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

551 
ASSERT_TRUE
(

552 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

555 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

556 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_difã»Á_mrsigÃr_
);

558 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

559 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

560 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

561 
ASSERT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
NÙ
(
IsOk
()));

566 
TEST_F
(
SgxLoÿlSeü‘S—ËrTe¡
,

567 
S—lUn£®MrsigÃrFau»SameMrsigÃrLow”Svn
) {

568 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
šput_£ü‘
(
kTe¡Seü‘
,

569 
kTe¡Seü‘
 + 
kTe¡Seü‘Size
);

570 
	g¡d
::
¡ršg
 
šput_¯d
(
kTe¡Aad
);

572 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

573 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_cİy_high”_isvsvn_
);

575 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”
 =

576 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

577 
S—ËdSeü‘H—d”
 
	gh—d”
;

578 
P»·»S—ËdSeü‘H—d”
(*
£®”
, &
h—d”
);

580 
S—ËdSeü‘
 
	g£®ed_£ü‘
;

581 
ASSERT_TRUE
(

582 
£®”
->
S—l
(
h—d”
, 
šput_¯d
, 
šput_£ü‘
, &
£®ed_£ü‘
).
ok
());

586 
	gsgx
::
FakeEnşave
::
Ex™Enşave
();

587 
	gsgx
::
FakeEnşave
::
EÁ”Enşave
(*
’şave_
);

589 
	g¡d
::
unique_±r
<
SgxLoÿlSeü‘S—Ër
> 
£®”2
 =

590 
SgxLoÿlSeü‘S—Ër
::
C»©eMrsigÃrSeü‘S—Ër
();

591 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gouut_£ü‘
;

592 
EXPECT_THAT
(
£®”2
->
Un£®
(
£®ed_£ü‘
, &
ouut_£ü‘
), 
NÙ
(
IsOk
()));

	@identity/sgx/tcb.cc

19 
	~"asylo/id’t™y/sgx/tcb.h
"

21 
	~<c¡dšt
>

23 
	~"googË/´Ùobuf/time¡amp.pb.h
"

24 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

25 
	~<googË/´Ùobuf/ut/time_ut.h
>

26 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

29 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

30 
	~"asylo/ut/¡©us_maüos.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	gsgx
 {

34 
	gÇme¥aû
 {

44 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

45 
P¬tŸlOrd”
 
Com·»TÙ®
(cÚ¡ 
T
 &
lhs
, cÚ¡ T &
rhs
) {

46 ià(
	glhs
 < 
	grhs
) {

47  
	gP¬tŸlOrd”
::
kLess
;

48 } ià(
	glhs
 =ğ
rhs
) {

49  
P¬tŸlOrd”
::
kEqu®
;

51  
	gP¬tŸlOrd”
::
kG»©”
;

87 
P¬tŸlOrd”
 
Ord”Combše
(P¬tŸlOrd” 
lhs
, P¬tŸlOrd” 
rhs
) {

88 
	glhs
) {

89 
	gP¬tŸlOrd”
::
kLess
:

90  
rhs
 =ğ
P¬tŸlOrd”
::
kLess
 ||„h =ğP¬tŸlOrd”::
kEqu®


91 ? 
P¬tŸlOrd”
::
kLess


92 : 
P¬tŸlOrd”
::
kIncom·¿bË
;

93 
	gP¬tŸlOrd”
::
kEqu®
:

94  
rhs
;

95 
	gP¬tŸlOrd”
::
kG»©”
:

96  
rhs
 =ğ
P¬tŸlOrd”
::
kEqu®
 ||„h =ğP¬tŸlOrd”::
kG»©”


97 ? 
P¬tŸlOrd”
::
kG»©”


98 : 
P¬tŸlOrd”
::
kIncom·¿bË
;

99 
	gP¬tŸlOrd”
::
kIncom·¿bË
:

100  
P¬tŸlOrd”
::
kIncom·¿bË
;

103  
	gP¬tŸlOrd”
::
kIncom·¿bË
;

111 
Stus
 
V®id©eTime¡amp
(cÚ¡ 
googË
::
´Ùobuf
::
Time¡amp
 &
time¡amp
) {

112 ià(
time¡amp
.
£cÚds
(è< 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMšSecÚds
 ||

113 
time¡amp
.
£cÚds
(è> 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMaxSecÚds
) {

114  
Stus
(

115 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

116 
ab¦
::
SŒC©
("Timestamp's \"seconds\" field must be between ",

117 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMšSecÚds
, "‡nd ",

118 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMaxSecÚds
,

122 ià(
	gtime¡amp
.
Çnos
() < 0 ||imestamp.nanos() > 999999999) {

123  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

128  
	gStus
::
OkStus
();

140 
Stus
 
V®id©eTcbStus
(cÚ¡ 
TcbStus
 &
tcb_¡©us
) {

141 ià(
	gtcb_¡©us
.
v®ue_ÿ£
(è=ğ
TcbStus
::
VALUE_NOT_SET
) {

142  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

146 ià(
	gtcb_¡©us
.
v®ue_ÿ£
(è=ğ
TcbStus
::
kKnownStus
 &&

147 
tcb_¡©us
.
known_¡©us
(è=ğ
TcbStus
::
INVALID
) {

148  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

152  
	gStus
::
OkStus
();

160 
Stus
 
V®id©eTcbLev–
(cÚ¡ 
TcbLev–
 &
tcb_Ëv–
) {

161 ià(!
	gtcb_Ëv–
.
has_tcb
()) {

162  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

166 ià(!
	gtcb_Ëv–
.
has_¡©us
()) {

167  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

171 
ASYLO_RETURN_IF_ERROR
(
V®id©eTcb
(
tcb_Ëv–
.
tcb
()));

172 
ASYLO_RETURN_IF_ERROR
(
V®id©eTcbStus
(
tcb_Ëv–
.
¡©us
()));

174  
	gStus
::
OkStus
();

186 
Stus
 
V®id©eTcbInfoIm¶V1
(cÚ¡ 
TcbInfoIm¶
 &
tcb_šfo_im¶
) {

187 ià(!
	gtcb_šfo_im¶
.
has_issue_d©e
()) {

188  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

192 ià(!
	gtcb_šfo_im¶
.
has_Ãxt_upd©e
()) {

193  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

197 ià(!
	gtcb_šfo_im¶
.
has_fm¥c
()) {

198  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

202 ià(!
	gtcb_šfo_im¶
.
has_pû_id
()) {

203  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

207 
ASYLO_RETURN_IF_ERROR
(
V®id©eTime¡amp
(
tcb_šfo_im¶
.
issue_d©e
()));

208 
ASYLO_RETURN_IF_ERROR
(
V®id©eTime¡amp
(
tcb_šfo_im¶
.
Ãxt_upd©e
()));

210 ià(
	gtcb_šfo_im¶
.
issue_d©e
(è>ğ
tcb_šfo_im¶
.
Ãxt_upd©e
()) {

211  
Stus
(

212 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

216 
ASYLO_RETURN_IF_ERROR
(
V®id©eFm¥c
(
tcb_šfo_im¶
.
fm¥c
()));

217 
ASYLO_RETURN_IF_ERROR
(
V®id©ePûId
(
tcb_šfo_im¶
.
pû_id
()));

219 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
> 
	gtcb_to_¡©us_m­
;

220 cÚ¡ 
	gTcbLev–
 &
	gtcb_Ëv–
 : 
tcb_šfo_im¶
.
tcb_Ëv–s
()) {

221 
ASYLO_RETURN_IF_ERROR
(
V®id©eTcbLev–
(
tcb_Ëv–
));

222 
	g¡d
::
¡ršg
 
m­_key
 = 
ab¦
::
SŒC©
(
tcb_Ëv–
.
tcb
().
compÚ’ts
(),

223 
tcb_Ëv–
.
tcb
().
pû_svn
().
v®ue
());

224 autØ
	gš£¹_·œ
 = 
tcb_to_¡©us_m­
.
š£¹
({
m­_key
, 
tcb_Ëv–
.
¡©us
()});

225 ià(!
	gš£¹_·œ
.
	g£cÚd
 &&

226 !
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equ®s
(
tcb_Ëv–
.
¡©us
(),

227 
š£¹_·œ
.
fœ¡
->
£cÚd
)) {

228  
Stus
(

229 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

235  
	gStus
::
OkStus
();

246 
Stus
 
V®id©eTcbInfoIm¶
(cÚ¡ 
TcbInfoIm¶
 &
tcb_šfo_im¶
) {

247 ià(!
	gtcb_šfo_im¶
.
has_v”siÚ
()) {

248  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

252 
	gtcb_šfo_im¶
.
v”siÚ
()) {

254  
V®id©eTcbInfoIm¶V1
(
tcb_šfo_im¶
);

256  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

257 
ab¦
::
SŒC©
("TcbInfoImpl has‡n unknown (Intel) version: ",

258 
tcb_šfo_im¶
.
v”siÚ
()));

264 cÚ¡ 
	gkTcbCompÚ’tsSize
 = 16;

266 
Stus
 
V®id©eTcb
(cÚ¡ 
Tcb
 &
tcb
) {

267 ià(!
	gtcb
.
has_compÚ’ts
()) {

268  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

272 ià(!
	gtcb
.
has_pû_svn
()) {

273  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

277 ià(
	gtcb
.
compÚ’ts
().
size
(è!ğ
kTcbCompÚ’tsSize
) {

278  
Stus
(

279 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

280 
ab¦
::
SŒC©
(

282 
kTcbCompÚ’tsSize
, " bytes)"));

285  
V®id©ePûSvn
(
tcb
.
pû_svn
());

287  
	gStus
::
OkStus
();

290 
Stus
 
V®id©eRawTcb
(cÚ¡ 
RawTcb
 &
¿w_tcb
) {

291 ià(!
	g¿w_tcb
.
has_ıu_svn
()) {

292  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

296 ià(!
	g¿w_tcb
.
has_pû_svn
()) {

297  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

301 
ASYLO_RETURN_IF_ERROR
(
V®id©eCpuSvn
(
¿w_tcb
.
ıu_svn
()));

302 
ASYLO_RETURN_IF_ERROR
(
V®id©ePûSvn
(
¿w_tcb
.
pû_svn
()));

304  
	gStus
::
OkStus
();

307 
Stus
 
V®id©eTcbInfo
(cÚ¡ 
TcbInfo
 &
tcb_šfo
) {

308 ià(
	gtcb_šfo
.
v®ue_ÿ£
(è!ğ
TcbInfo
::
kIm¶
) {

309  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

313  
V®id©eTcbInfoIm¶
(
tcb_šfo
.
im¶
());

316 
P¬tŸlOrd”
 
Com·»Tcbs
(cÚ¡ 
Tcb
 &
lhs
, cÚ¡ Tcb &
rhs
) {

317 
By‹CÚš”V›w
 
lhs_by‹s
(
lhs
.
compÚ’ts
());

318 
By‹CÚš”V›w
 
rhs_by‹s
(
rhs
.
compÚ’ts
());

319 
P¬tŸlOrd”
 
	gcu¼’t
 = P¬tŸlOrd”::
kEqu®
;

320 
	gi
 = 0; i < 
	gkTcbCompÚ’tsSize
; ++i) {

321 
	gcu¼’t
 = 
Ord”Combše
(
cu¼’t
, 
Com·»TÙ®
(
lhs_by‹s
[
i
], 
rhs_by‹s
[i]));

322 ià(
	gcu¼’t
 =ğ
P¬tŸlOrd”
::
kIncom·¿bË
) {

323  
P¬tŸlOrd”
::
kIncom·¿bË
;

326  
Ord”Combše
(

327 
cu¼’t
, 
Com·»TÙ®
(
lhs
.
pû_svn
().
v®ue
(), 
rhs
.pce_svn().value()));

	@identity/sgx/tcb.cc

19 
	~"asylo/id’t™y/sgx/tcb.h
"

21 
	~<c¡dšt
>

23 
	~"googË/´Ùobuf/time¡amp.pb.h
"

24 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

25 
	~<googË/´Ùobuf/ut/time_ut.h
>

26 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

29 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

30 
	~"asylo/ut/¡©us_maüos.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	gsgx
 {

34 
	gÇme¥aû
 {

44 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

45 
P¬tŸlOrd”
 
Com·»TÙ®
(cÚ¡ 
T
 &
lhs
, cÚ¡ T &
rhs
) {

46 ià(
	glhs
 < 
	grhs
) {

47  
	gP¬tŸlOrd”
::
kLess
;

48 } ià(
	glhs
 =ğ
rhs
) {

49  
P¬tŸlOrd”
::
kEqu®
;

51  
	gP¬tŸlOrd”
::
kG»©”
;

87 
P¬tŸlOrd”
 
Ord”Combše
(P¬tŸlOrd” 
lhs
, P¬tŸlOrd” 
rhs
) {

88 
	glhs
) {

89 
	gP¬tŸlOrd”
::
kLess
:

90  
rhs
 =ğ
P¬tŸlOrd”
::
kLess
 ||„h =ğP¬tŸlOrd”::
kEqu®


91 ? 
P¬tŸlOrd”
::
kLess


92 : 
P¬tŸlOrd”
::
kIncom·¿bË
;

93 
	gP¬tŸlOrd”
::
kEqu®
:

94  
rhs
;

95 
	gP¬tŸlOrd”
::
kG»©”
:

96  
rhs
 =ğ
P¬tŸlOrd”
::
kEqu®
 ||„h =ğP¬tŸlOrd”::
kG»©”


97 ? 
P¬tŸlOrd”
::
kG»©”


98 : 
P¬tŸlOrd”
::
kIncom·¿bË
;

99 
	gP¬tŸlOrd”
::
kIncom·¿bË
:

100  
P¬tŸlOrd”
::
kIncom·¿bË
;

103  
	gP¬tŸlOrd”
::
kIncom·¿bË
;

111 
Stus
 
V®id©eTime¡amp
(cÚ¡ 
googË
::
´Ùobuf
::
Time¡amp
 &
time¡amp
) {

112 ià(
time¡amp
.
£cÚds
(è< 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMšSecÚds
 ||

113 
time¡amp
.
£cÚds
(è> 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMaxSecÚds
) {

114  
Stus
(

115 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

116 
ab¦
::
SŒC©
("Timestamp's \"seconds\" field must be between ",

117 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMšSecÚds
, "‡nd ",

118 
googË
::
´Ùobuf
::
ut
::
TimeUt
::
kTime¡ampMaxSecÚds
,

122 ià(
	gtime¡amp
.
Çnos
() < 0 ||imestamp.nanos() > 999999999) {

123  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

128  
	gStus
::
OkStus
();

140 
Stus
 
V®id©eTcbStus
(cÚ¡ 
TcbStus
 &
tcb_¡©us
) {

141 ià(
	gtcb_¡©us
.
v®ue_ÿ£
(è=ğ
TcbStus
::
VALUE_NOT_SET
) {

142  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

146 ià(
	gtcb_¡©us
.
v®ue_ÿ£
(è=ğ
TcbStus
::
kKnownStus
 &&

147 
tcb_¡©us
.
known_¡©us
(è=ğ
TcbStus
::
INVALID
) {

148  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

152  
	gStus
::
OkStus
();

160 
Stus
 
V®id©eTcbLev–
(cÚ¡ 
TcbLev–
 &
tcb_Ëv–
) {

161 ià(!
	gtcb_Ëv–
.
has_tcb
()) {

162  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

166 ià(!
	gtcb_Ëv–
.
has_¡©us
()) {

167  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

171 
ASYLO_RETURN_IF_ERROR
(
V®id©eTcb
(
tcb_Ëv–
.
tcb
()));

172 
ASYLO_RETURN_IF_ERROR
(
V®id©eTcbStus
(
tcb_Ëv–
.
¡©us
()));

174  
	gStus
::
OkStus
();

186 
Stus
 
V®id©eTcbInfoIm¶V1
(cÚ¡ 
TcbInfoIm¶
 &
tcb_šfo_im¶
) {

187 ià(!
	gtcb_šfo_im¶
.
has_issue_d©e
()) {

188  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

192 ià(!
	gtcb_šfo_im¶
.
has_Ãxt_upd©e
()) {

193  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

197 ià(!
	gtcb_šfo_im¶
.
has_fm¥c
()) {

198  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

202 ià(!
	gtcb_šfo_im¶
.
has_pû_id
()) {

203  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

207 
ASYLO_RETURN_IF_ERROR
(
V®id©eTime¡amp
(
tcb_šfo_im¶
.
issue_d©e
()));

208 
ASYLO_RETURN_IF_ERROR
(
V®id©eTime¡amp
(
tcb_šfo_im¶
.
Ãxt_upd©e
()));

210 ià(
	gtcb_šfo_im¶
.
issue_d©e
(è>ğ
tcb_šfo_im¶
.
Ãxt_upd©e
()) {

211  
Stus
(

212 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

216 
ASYLO_RETURN_IF_ERROR
(
V®id©eFm¥c
(
tcb_šfo_im¶
.
fm¥c
()));

217 
ASYLO_RETURN_IF_ERROR
(
V®id©ePûId
(
tcb_šfo_im¶
.
pû_id
()));

219 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
> 
	gtcb_to_¡©us_m­
;

220 cÚ¡ 
	gTcbLev–
 &
	gtcb_Ëv–
 : 
tcb_šfo_im¶
.
tcb_Ëv–s
()) {

221 
ASYLO_RETURN_IF_ERROR
(
V®id©eTcbLev–
(
tcb_Ëv–
));

222 
	g¡d
::
¡ršg
 
m­_key
 = 
ab¦
::
SŒC©
(
tcb_Ëv–
.
tcb
().
compÚ’ts
(),

223 
tcb_Ëv–
.
tcb
().
pû_svn
().
v®ue
());

224 autØ
	gš£¹_·œ
 = 
tcb_to_¡©us_m­
.
š£¹
({
m­_key
, 
tcb_Ëv–
.
¡©us
()});

225 ià(!
	gš£¹_·œ
.
	g£cÚd
 &&

226 !
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equ®s
(
tcb_Ëv–
.
¡©us
(),

227 
š£¹_·œ
.
fœ¡
->
£cÚd
)) {

228  
Stus
(

229 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

235  
	gStus
::
OkStus
();

246 
Stus
 
V®id©eTcbInfoIm¶
(cÚ¡ 
TcbInfoIm¶
 &
tcb_šfo_im¶
) {

247 ià(!
	gtcb_šfo_im¶
.
has_v”siÚ
()) {

248  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

252 
	gtcb_šfo_im¶
.
v”siÚ
()) {

254  
V®id©eTcbInfoIm¶V1
(
tcb_šfo_im¶
);

256  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

257 
ab¦
::
SŒC©
("TcbInfoImpl has‡n unknown (Intel) version: ",

258 
tcb_šfo_im¶
.
v”siÚ
()));

264 cÚ¡ 
	gkTcbCompÚ’tsSize
 = 16;

266 
Stus
 
V®id©eTcb
(cÚ¡ 
Tcb
 &
tcb
) {

267 ià(!
	gtcb
.
has_compÚ’ts
()) {

268  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

272 ià(!
	gtcb
.
has_pû_svn
()) {

273  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

277 ià(
	gtcb
.
compÚ’ts
().
size
(è!ğ
kTcbCompÚ’tsSize
) {

278  
Stus
(

279 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

280 
ab¦
::
SŒC©
(

282 
kTcbCompÚ’tsSize
, " bytes)"));

285  
V®id©ePûSvn
(
tcb
.
pû_svn
());

287  
	gStus
::
OkStus
();

290 
Stus
 
V®id©eRawTcb
(cÚ¡ 
RawTcb
 &
¿w_tcb
) {

291 ià(!
	g¿w_tcb
.
has_ıu_svn
()) {

292  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

296 ià(!
	g¿w_tcb
.
has_pû_svn
()) {

297  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

301 
ASYLO_RETURN_IF_ERROR
(
V®id©eCpuSvn
(
¿w_tcb
.
ıu_svn
()));

302 
ASYLO_RETURN_IF_ERROR
(
V®id©ePûSvn
(
¿w_tcb
.
pû_svn
()));

304  
	gStus
::
OkStus
();

307 
Stus
 
V®id©eTcbInfo
(cÚ¡ 
TcbInfo
 &
tcb_šfo
) {

308 ià(
	gtcb_šfo
.
v®ue_ÿ£
(è!ğ
TcbInfo
::
kIm¶
) {

309  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

313  
V®id©eTcbInfoIm¶
(
tcb_šfo
.
im¶
());

316 
P¬tŸlOrd”
 
Com·»Tcbs
(cÚ¡ 
Tcb
 &
lhs
, cÚ¡ Tcb &
rhs
) {

317 
By‹CÚš”V›w
 
lhs_by‹s
(
lhs
.
compÚ’ts
());

318 
By‹CÚš”V›w
 
rhs_by‹s
(
rhs
.
compÚ’ts
());

319 
P¬tŸlOrd”
 
	gcu¼’t
 = P¬tŸlOrd”::
kEqu®
;

320 
	gi
 = 0; i < 
	gkTcbCompÚ’tsSize
; ++i) {

321 
	gcu¼’t
 = 
Ord”Combše
(
cu¼’t
, 
Com·»TÙ®
(
lhs_by‹s
[
i
], 
rhs_by‹s
[i]));

322 ià(
	gcu¼’t
 =ğ
P¬tŸlOrd”
::
kIncom·¿bË
) {

323  
P¬tŸlOrd”
::
kIncom·¿bË
;

326  
Ord”Combše
(

327 
cu¼’t
, 
Com·»TÙ®
(
lhs
.
pû_svn
().
v®ue
(), 
rhs
.pce_svn().value()));

	@identity/sgx/tcb.h

19 #iâdeà
ASYLO_IDENTITY_SGX_TCB_H_


20 
	#ASYLO_IDENTITY_SGX_TCB_H_


	)

22 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

23 
	~"asylo/ut/¡©us.h
"

24 
	~"asylo/ut/¡©usÜ.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gsgx
 {

37 şas 
	cP¬tŸlOrd”
 {

38 
	gkLess
,

39 
	gkEqu®
,

40 
	gkG»©”
,

41 
	gkIncom·¿bË
,

45 cÚ¡ 
kTcbCompÚ’tsSize
;

53 
Stus
 
V®id©eTcb
(cÚ¡ 
Tcb
 &
tcb
);

60 
Stus
 
V®id©eRawTcb
(cÚ¡ 
RawTcb
 &
¿w_tcb
);

84 
Stus
 
V®id©eTcbInfo
(cÚ¡ 
TcbInfo
 &
tcb_šfo
);

108 
P¬tŸlOrd”
 
Com·»Tcbs
(cÚ¡ 
Tcb
 &
lhs
, cÚ¡ Tcb &
rhs
);

	@identity/sgx/tcb_info_from_json.cc

19 
	~"asylo/id’t™y/sgx/tcb_šfo_äom_jsÚ.h
"

21 
	~<’dŸn.h
>

23 
	~<c¡dšt
>

24 
	~<lim™s
>

25 
	~<memÜy
>

26 
	~<¡ršg
>

27 
	~<ut™y
>

29 
	~"googË/´Ùobuf/¡ruù.pb.h
"

30 
	~"googË/´Ùobuf/time¡amp.pb.h
"

31 
	~<googË/´Ùobuf/»³©ed_f›ld.h
>

32 
	~<googË/´Ùobuf/ut/jsÚ_ut.h
>

33 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

34 
	~<googË/´Ùobuf/ut/time_ut.h
>

35 
	~"ab¦/ba£/ÿÎ_Úû.h
"

36 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

37 
	~"ab¦/¡ršgs/ascii.h
"

38 
	~"ab¦/¡ršgs/esÿpšg.h
"

39 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

40 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

41 
	~"ab¦/time/civ_time.h
"

42 
	~"ab¦/time/time.h
"

43 
	~"asylo/ut/loggšg.h
"

44 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

45 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

46 
	~"asylo/id’t™y/sgx/tcb.h
"

47 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

48 
	~"asylo/ut/´Ùo_¡ruù_ut.h
"

49 
	~"asylo/ut/¡©us.h
"

50 
	~"asylo/ut/¡©us_maüos.h
"

52 
Çme¥aû
 
	gasylo
 {

53 
Çme¥aû
 
	gsgx
 {

54 
	gÇme¥aû
 {

57 
	gStusOr
<
	gab¦
::
Time
> 
P¬£Iso8601TimeSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
time_¡ršg
) {

58 
ab¦
::
Time
 
time
;

59 
	g¡d
::
¡ršg
 
”rÜ
;

60 ià(!
	gab¦
::
P¬£Time
("%Y-%m-%dT%H:%M:%SZ", 
time_¡ršg
, &
time
, &
”rÜ
)) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("Could‚Ù…¬£im¡ršg: ", 
”rÜ
));

65  
	gtime
;

70 
boŞ
 
CªBeTime¡ampPrÙo
(
ab¦
::
Time
 
time
) {

71 cÚ¡ 
ab¦
::
TimeZÚe
 
utc
 =‡b¦::
UTCTimeZÚe
();

72 cÚ¡ 
	gab¦
::
Time
 
time¡amp_´Ùo_mšimum
 =

73 
ab¦
::
FromCiv
×b¦::
CivSecÚd
(1, 1, 1, 0, 0, 0), 
utc
);

74 cÚ¡ 
	gab¦
::
Time
 
time¡amp_´Ùo_maximum
 =

75 
ab¦
::
FromCiv
×b¦::
CivSecÚd
(9999, 12, 31, 23, 59, 59), 
utc
);

76  
	gtime
 >ğ
time¡amp_´Ùo_mšimum
 && 
time
 <ğ
time¡amp_´Ùo_maximum
;

81 
boŞ
 
IsHexEncoded
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

82 
c
 : 
¡r
) {

83 ià(!
ab¦
::
ascii_isxdig™
(
c
)) {

84  
çl£
;

88  
	g¡r
.
size
() % 2 == 0;

93 cÚ¡ 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
::
StusTy³
>

94 &
KnownStu£sM­
() {

95 
ab¦
::
Úû_æag
 
Úû_š™
;

96 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
::
StusTy³
> *
m­
 = 
nuÎ±r
;

98 
	gab¦
::
ÿÎ_Úû
(
Úû_š™
, [] {

99 
m­
 = 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
TcbStus
::
StusTy³
>({

100 {"UpToD©e", 
TcbStus
::
UP_TO_DATE
},

101 {"OutOfD©e", 
TcbStus
::
OUT_OF_DATE
},

102 {"CÚfigu¿tiÚN“ded", 
TcbStus
::
CONFIGURATION_NEEDED
},

103 {"Revoked", 
TcbStus
::
REVOKED
},

106  *
	gm­
;

110 
	gStusOr
<> 
SgxTcbCompÚ’tSvnFromJsÚ
(

111 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
compÚ’t_jsÚ
) {

112 
compÚ’t
;

113 
ASYLO_ASSIGN_OR_RETURN
(
compÚ’t
, 
JsÚG‘Numb”
(
compÚ’t_jsÚ
));

114 ià(
	gcompÚ’t
 < 0. || component > 255.) {

115  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

118  
	gcompÚ’t
;

122 
	gStusOr
<
	gPûSvn
> 
PûSvnFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
pû_svn_jsÚ
) {

123 
pû_svn_¿w
;

124 
ASYLO_ASSIGN_OR_RETURN
(
pû_svn_¿w
, 
JsÚG‘Numb”
(
pû_svn_jsÚ
));

125 ià(
	gpû_svn_¿w
 < 0. ||…û_svn_¿w > 
	gkPûSvnMaxV®ue
) {

126  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

130 
PûSvn
 
	gpû_svn
;

131 
	gpû_svn
.
£t_v®ue
(
pû_svn_¿w
);

132  
	gpû_svn
;

135 
	gStusOr
<
	gTcb
> 
TcbFromJsÚV®ue
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
jsÚ_v®ue
) {

136 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 *
tcb_objeù
;

137 
ASYLO_ASSIGN_OR_RETURN
(
tcb_objeù
, 
JsÚG‘Objeù
(
jsÚ_v®ue
));

139 
Tcb
 
	gtcb
;

141 
	gtcb
.
£t_compÚ’ts
(
¡d
::
¡ršg
(
kTcbCompÚ’tsSize
, 0));

142 
	gi
 = 0; i < 
	gkTcbCompÚ’tsSize
; ++i) {

143 cÚ¡ 
	g¡d
::
¡ršg
 
f›ld_Çme
 = 
ab¦
::
SŒFÜm©
("sgxtcbcomp%02dsvn", 
i
 + 1);

144 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
compÚ’t_jsÚ
;

145 
ASYLO_ASSIGN_OR_RETURN
(
compÚ’t_jsÚ
,

146 
JsÚObjeùG‘F›ld
(*
tcb_objeù
, 
f›ld_Çme
));

147 
ASYLO_ASSIGN_OR_RETURN
((*
tcb
.
mubË_compÚ’ts
())[
i
],

148 
SgxTcbCompÚ’tSvnFromJsÚ
(*
compÚ’t_jsÚ
));

151 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
pû_svn_jsÚ
;

152 
ASYLO_ASSIGN_OR_RETURN
(
pû_svn_jsÚ
,

153 
JsÚObjeùG‘F›ld
(*
tcb_objeù
, "pcesvn"));

154 
ASYLO_ASSIGN_OR_RETURN
(*
tcb
.
mubË_pû_svn
(), 
PûSvnFromJsÚ
(*
pû_svn_jsÚ
));

159 ià(
	gtcb_objeù
->
f›lds
().
size
(è> 
	gkTcbCompÚ’tsSize
 + 1) {

160 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

161 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
jsÚ_v®ue
, &
jsÚ_¡ršg
).
ok
()) {

162 
	gjsÚ_¡ršg
 = "TCB JSON";

164 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered unrecognized fields in ",

165 
jsÚ_¡ršg
);

168  
	gtcb
;

172 
	gStusOr
<
	gTcbStus
> 
TcbStusFromJsÚ
(

173 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
tcb_¡©us_jsÚ
) {

174 cÚ¡ 
¡d
::
¡ršg
 *
¡©us_¡ršg
;

175 
ASYLO_ASSIGN_OR_RETURN
(
¡©us_¡ršg
, 
JsÚG‘SŒšg
(
tcb_¡©us_jsÚ
));

176 
TcbStus
 
	g¡©us
;

177 ià(
KnownStu£sM­
().
cÚšs
(*
¡©us_¡ršg
)) {

178 
	g¡©us
.
£t_known_¡©us
(
KnownStu£sM­
().
©
(*
¡©us_¡ršg
));

180 
	g¡©us
.
£t_unknown_¡©us
(*
¡©us_¡ršg
);

182  
	g¡©us
;

186 
	gStusOr
<
	gTcbLev–
> 
TcbLev–FromJsÚ
(

187 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
tcb_Ëv–_jsÚ
) {

188 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 *
tcb_Ëv–_objeù
;

189 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–_objeù
, 
JsÚG‘Objeù
(
tcb_Ëv–_jsÚ
));

190 
TcbLev–
 
	gtcb_Ëv–
;

192 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
tcb_jsÚ
;

193 
ASYLO_ASSIGN_OR_RETURN
(
tcb_jsÚ
,

194 
JsÚObjeùG‘F›ld
(*
tcb_Ëv–_objeù
, "tcb"));

195 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_Ëv–
.
mubË_tcb
(), 
TcbFromJsÚV®ue
(*
tcb_jsÚ
));

197 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
¡©us_jsÚ
;

198 
ASYLO_ASSIGN_OR_RETURN
(
¡©us_jsÚ
,

199 
JsÚObjeùG‘F›ld
(*
tcb_Ëv–_objeù
, "status"));

200 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_Ëv–
.
mubË_¡©us
(),

201 
TcbStusFromJsÚ
(*
¡©us_jsÚ
));

204 ià(
	gtcb_Ëv–_jsÚ
.
¡ruù_v®ue
().
f›lds
().
size
() > 2) {

205 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

206 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
tcb_Ëv–_jsÚ
, &
jsÚ_¡ršg
).
ok
()) {

207 
	gjsÚ_¡ršg
 = "TCB†evel JSON";

209 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered unrecognized fields in ",

210 
jsÚ_¡ršg
);

213  
	gtcb_Ëv–
;

217 
	gStusOr
<> 
V”siÚFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v”siÚ_jsÚ
) {

218 
ASYLO_RETURN_IF_ERROR
(
JsÚG‘Numb”
(
v”siÚ_jsÚ
));

220 
	gv”siÚ
 = 
v”siÚ_jsÚ
.
numb”_v®ue
();

221 ià(
	gv”siÚ
 < 
	g¡©ic_ÿ¡
<>(
	g¡d
::
num”ic_lim™s
<
št32_t
>::
mš
()) ||

222 
v”siÚ
 > 
¡©ic_ÿ¡
<>(
¡d
::
num”ic_lim™s
<
št32_t
>::
max
())) {

223  
Stus
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

226  
	gv”siÚ
;

231 
	gStusOr
<
	ggoogË
::
´Ùobuf
::
Time¡amp
> 
Time¡ampFromJsÚ
(

232 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
time¡amp_jsÚ
) {

233 cÚ¡ 
¡d
::
¡ršg
 *
time¡amp_¡ršg
;

234 
ASYLO_ASSIGN_OR_RETURN
(
time¡amp_¡ršg
, 
JsÚG‘SŒšg
(
time¡amp_jsÚ
));

236 
	gab¦
::
Time
 
time
;

237 
ASYLO_ASSIGN_OR_RETURN
(
time
, 
P¬£Iso8601TimeSŒšg
(*
time¡amp_¡ršg
));

238 ià(!
CªBeTime¡ampPrÙo
(
time
)) {

239  
Stus
(

240 
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

244 
	ggoogË
::
´Ùobuf
::
Time¡amp
 
time¡amp
;

245 
	gab¦
::
Du¿tiÚ
 
äom_unix_•och
 = 
time
 - 
ab¦
::
UnixEpoch
();

246 
št64_t
 
	gnum_£cÚds
 = 
äom_unix_•och
 / 
ab¦
::
SecÚds
(1);

247 
št64_t
 
	gnum_Çnos
 =

248 (
äom_unix_•och
 - 
num_£cÚds
 * 
ab¦
::
SecÚds
(1)è/‡b¦::
Nªo£cÚds
(1);

249 
	gtime¡amp
.
£t_£cÚds
(
num_£cÚds
);

250 
	gtime¡amp
.
£t_Çnos
(
num_Çnos
);

251  
	gtime¡amp
;

255 
	gStusOr
<
	gFm¥c
> 
Fm¥cFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
fm¥c_jsÚ
) {

256 cÚ¡ 
¡d
::
¡ršg
 *
fm¥c_hex_¡ršg
;

257 
ASYLO_ASSIGN_OR_RETURN
(
fm¥c_hex_¡ršg
, 
JsÚG‘SŒšg
(
fm¥c_jsÚ
));

258 ià(!
IsHexEncoded
(*
fm¥c_hex_¡ršg
)) {

259  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

263 
	g¡d
::
¡ršg
 
fm¥c_by‹s
 = 
ab¦
::
HexSŒšgToBy‹s
(*
fm¥c_hex_¡ršg
);

264 ià(
	gfm¥c_by‹s
.
size
(è!ğ
kFm¥cSize
) {

265  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

266 
ab¦
::
SŒC©
("FMSPC JSON dÛ nÙ„•»£Á‡ ", 
kFm¥cSize
,

270 
Fm¥c
 
	gfm¥c
;

271 
	gfm¥c
.
£t_v®ue
(
fm¥c_by‹s
);

272  
	gfm¥c
;

276 
	gStusOr
<
	gPûId
> 
PûIdFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
pû_id_jsÚ
) {

277 
cÚ¡ex´
 
kPûIdNumBy‹s
 = 2;

279 cÚ¡ 
	g¡d
::
¡ršg
 *
pû_id_hex_¡ršg
;

280 
ASYLO_ASSIGN_OR_RETURN
(
pû_id_hex_¡ršg
, 
JsÚG‘SŒšg
(
pû_id_jsÚ
));

281 ià(!
IsHexEncoded
(*
pû_id_hex_¡ršg
)) {

282  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

286 
	g¡d
::
¡ršg
 
pû_id_by‹s
 = 
ab¦
::
HexSŒšgToBy‹s
(*
pû_id_hex_¡ršg
);

287 ià(
	gpû_id_by‹s
.
size
(è!ğ
kPûIdNumBy‹s
) {

288  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

289 
ab¦
::
SŒC©
("PCE ID JSON does‚ot„epresent‡ ",

290 
kPûIdNumBy‹s
, "-byte value"));

293 
PûId
 
	gpû_id
;

294 
	gpû_id
.
£t_v®ue
(

295 
Ë16toh
(*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt16_t
 *>(
pû_id_by‹s
.
d©a
())));

296  
	gpû_id
;

300 
	gStusOr
<
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
TcbLev–
>> 
TcbLev–sFromJsÚ
(

301 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
tcb_Ëv–s_jsÚ
) {

302 cÚ¡ 
googË
::
´Ùobuf
::
Li¡V®ue
 *
tcb_Ëv–s_¬¿y
;

303 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–s_¬¿y
, 
JsÚG‘A¼ay
(
tcb_Ëv–s_jsÚ
));

305 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
> 
	gtcb_to_¡©us_m­
;

306 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
TcbLev–
> 
tcb_Ëv–s
;

307 cÚ¡‡utØ&
	gtcb_Ëv–_jsÚ
 : 
tcb_Ëv–s_¬¿y
->
v®ues
()) {

308 
TcbLev–
 
tcb_Ëv–
;

309 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–
, 
TcbLev–FromJsÚ
(
tcb_Ëv–_jsÚ
));

310 
	g¡d
::
¡ršg
 
m­_key
 = 
ab¦
::
SŒC©
(
tcb_Ëv–
.
tcb
().
compÚ’ts
(),

311 
tcb_Ëv–
.
tcb
().
pû_svn
().
v®ue
());

312 autØ
	gš£¹_·œ
 = 
tcb_to_¡©us_m­
.
š£¹
({
m­_key
, 
tcb_Ëv–
.
¡©us
()});

313 ià(!
	gš£¹_·œ
.
	g£cÚd
) {

314 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equ®s
(
š£¹_·œ
.
fœ¡
->
£cÚd
,

315 
tcb_Ëv–
.
¡©us
())) {

316  
Stus
(

317 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

321 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

322 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
tcb_Ëv–s_jsÚ
, &
jsÚ_¡ršg
)

323 .
ok
()) {

324 
	gjsÚ_¡ršg
 = "TCB†evels JSON";

326 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered duplicate TCBƒntries in ",

327 
jsÚ_¡ršg
);

331 *
	gtcb_Ëv–s
.
Add
(èğ
¡d
::
move
(
tcb_Ëv–
);

333  
	gtcb_Ëv–s
;

338 
	gStusOr
<
	gTcbInfo
> 
TcbInfoFromJsÚV1
(

339 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 &
tcb_šfo_objeù
) {

340 
TcbInfo
 
tcb_šfo
;

341 
TcbInfoIm¶
 *
	gtcb_šfo_im¶
 = 
tcb_šfo
.
mubË_im¶
();

343 
	gtcb_šfo_im¶
->
£t_v”siÚ
(1);

345 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
issue_d©e_jsÚ
;

346 
ASYLO_ASSIGN_OR_RETURN
(
issue_d©e_jsÚ
,

347 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "issueDate"));

348 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_issue_d©e
(),

349 
Time¡ampFromJsÚ
(*
issue_d©e_jsÚ
));

351 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
Ãxt_upd©e_jsÚ
;

352 
ASYLO_ASSIGN_OR_RETURN
(
Ãxt_upd©e_jsÚ
,

353 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "nextUpdate"));

354 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_Ãxt_upd©e
(),

355 
Time¡ampFromJsÚ
(*
Ãxt_upd©e_jsÚ
));

357 ià(
	gtcb_šfo_im¶
->
issue_d©e
(è>ğ
tcb_šfo_im¶
->
Ãxt_upd©e
()) {

358  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

362 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
fm¥c_jsÚ
;

363 
ASYLO_ASSIGN_OR_RETURN
(
fm¥c_jsÚ
,

364 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "fmspc"));

365 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_fm¥c
(),

366 
Fm¥cFromJsÚ
(*
fm¥c_jsÚ
));

368 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
pû_id_jsÚ
;

369 
ASYLO_ASSIGN_OR_RETURN
(
pû_id_jsÚ
,

370 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "pceId"));

371 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_pû_id
(),

372 
PûIdFromJsÚ
(*
pû_id_jsÚ
));

374 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
tcb_Ëv–s_jsÚ
;

375 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–s_jsÚ
,

376 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "tcbLevels"));

377 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_tcb_Ëv–s
(),

378 
TcbLev–sFromJsÚ
(*
tcb_Ëv–s_jsÚ
));

382 ià(
	gtcb_šfo_objeù
.
f›lds
().
size
() > 6) {

383 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

384 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
tcb_šfo_objeù
, &
jsÚ_¡ršg
)

385 .
ok
()) {

386 
	gjsÚ_¡ršg
 = "TCB info JSON";

388 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered unrecognized fields in ",

389 
jsÚ_¡ršg
);

392  
	gtcb_šfo
;

397 
	gStusOr
<
	gTcb
> 
TcbFromJsÚ
(cÚ¡ 
¡d
::
¡ršg
 &
jsÚ_¡ršg
) {

398 
googË
::
´Ùobuf
::
V®ue
 
tcb_jsÚ
;

399 
ASYLO_RETURN_IF_ERROR
(

400 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
jsÚ_¡ršg
, &
tcb_jsÚ
)));

401  
TcbFromJsÚV®ue
(
tcb_jsÚ
);

404 
	gStusOr
<
	gTcbInfo
> 
TcbInfoFromJsÚ
(cÚ¡ 
¡d
::
¡ršg
 &
jsÚ_¡ršg
) {

405 
googË
::
´Ùobuf
::
V®ue
 
tcb_šfo_jsÚ
;

406 
ASYLO_RETURN_IF_ERROR
(

407 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
jsÚ_¡ršg
, &
tcb_šfo_jsÚ
)));

409 cÚ¡ 
	ggoogË
::
´Ùobuf
::
SŒuù
 *
tcb_šfo_objeù
;

410 
ASYLO_ASSIGN_OR_RETURN
(
tcb_šfo_objeù
, 
JsÚG‘Objeù
(
tcb_šfo_jsÚ
));

412 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
v”siÚ_jsÚ
;

413 
ASYLO_ASSIGN_OR_RETURN
(
v”siÚ_jsÚ
,

414 
JsÚObjeùG‘F›ld
(*
tcb_šfo_objeù
, "version"));

415 
	gv”siÚ
;

416 
ASYLO_ASSIGN_OR_RETURN
(
v”siÚ
, 
V”siÚFromJsÚ
(*
v”siÚ_jsÚ
));

417 
	gv”siÚ
) {

419  
TcbInfoFromJsÚV1
(*
tcb_šfo_objeù
);

421  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

	@identity/sgx/tcb_info_from_json.cc

19 
	~"asylo/id’t™y/sgx/tcb_šfo_äom_jsÚ.h
"

21 
	~<’dŸn.h
>

23 
	~<c¡dšt
>

24 
	~<lim™s
>

25 
	~<memÜy
>

26 
	~<¡ršg
>

27 
	~<ut™y
>

29 
	~"googË/´Ùobuf/¡ruù.pb.h
"

30 
	~"googË/´Ùobuf/time¡amp.pb.h
"

31 
	~<googË/´Ùobuf/»³©ed_f›ld.h
>

32 
	~<googË/´Ùobuf/ut/jsÚ_ut.h
>

33 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

34 
	~<googË/´Ùobuf/ut/time_ut.h
>

35 
	~"ab¦/ba£/ÿÎ_Úû.h
"

36 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

37 
	~"ab¦/¡ršgs/ascii.h
"

38 
	~"ab¦/¡ršgs/esÿpšg.h
"

39 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

40 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

41 
	~"ab¦/time/civ_time.h
"

42 
	~"ab¦/time/time.h
"

43 
	~"asylo/ut/loggšg.h
"

44 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.h
"

45 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

46 
	~"asylo/id’t™y/sgx/tcb.h
"

47 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

48 
	~"asylo/ut/´Ùo_¡ruù_ut.h
"

49 
	~"asylo/ut/¡©us.h
"

50 
	~"asylo/ut/¡©us_maüos.h
"

52 
Çme¥aû
 
	gasylo
 {

53 
Çme¥aû
 
	gsgx
 {

54 
	gÇme¥aû
 {

57 
	gStusOr
<
	gab¦
::
Time
> 
P¬£Iso8601TimeSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
time_¡ršg
) {

58 
ab¦
::
Time
 
time
;

59 
	g¡d
::
¡ršg
 
”rÜ
;

60 ià(!
	gab¦
::
P¬£Time
("%Y-%m-%dT%H:%M:%SZ", 
time_¡ršg
, &
time
, &
”rÜ
)) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("Could‚Ù…¬£im¡ršg: ", 
”rÜ
));

65  
	gtime
;

70 
boŞ
 
CªBeTime¡ampPrÙo
(
ab¦
::
Time
 
time
) {

71 cÚ¡ 
ab¦
::
TimeZÚe
 
utc
 =‡b¦::
UTCTimeZÚe
();

72 cÚ¡ 
	gab¦
::
Time
 
time¡amp_´Ùo_mšimum
 =

73 
ab¦
::
FromCiv
×b¦::
CivSecÚd
(1, 1, 1, 0, 0, 0), 
utc
);

74 cÚ¡ 
	gab¦
::
Time
 
time¡amp_´Ùo_maximum
 =

75 
ab¦
::
FromCiv
×b¦::
CivSecÚd
(9999, 12, 31, 23, 59, 59), 
utc
);

76  
	gtime
 >ğ
time¡amp_´Ùo_mšimum
 && 
time
 <ğ
time¡amp_´Ùo_maximum
;

81 
boŞ
 
IsHexEncoded
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

82 
c
 : 
¡r
) {

83 ià(!
ab¦
::
ascii_isxdig™
(
c
)) {

84  
çl£
;

88  
	g¡r
.
size
() % 2 == 0;

93 cÚ¡ 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
::
StusTy³
>

94 &
KnownStu£sM­
() {

95 
ab¦
::
Úû_æag
 
Úû_š™
;

96 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
::
StusTy³
> *
m­
 = 
nuÎ±r
;

98 
	gab¦
::
ÿÎ_Úû
(
Úû_š™
, [] {

99 
m­
 = 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
TcbStus
::
StusTy³
>({

100 {"UpToD©e", 
TcbStus
::
UP_TO_DATE
},

101 {"OutOfD©e", 
TcbStus
::
OUT_OF_DATE
},

102 {"CÚfigu¿tiÚN“ded", 
TcbStus
::
CONFIGURATION_NEEDED
},

103 {"Revoked", 
TcbStus
::
REVOKED
},

106  *
	gm­
;

110 
	gStusOr
<> 
SgxTcbCompÚ’tSvnFromJsÚ
(

111 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
compÚ’t_jsÚ
) {

112 
compÚ’t
;

113 
ASYLO_ASSIGN_OR_RETURN
(
compÚ’t
, 
JsÚG‘Numb”
(
compÚ’t_jsÚ
));

114 ià(
	gcompÚ’t
 < 0. || component > 255.) {

115  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

118  
	gcompÚ’t
;

122 
	gStusOr
<
	gPûSvn
> 
PûSvnFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
pû_svn_jsÚ
) {

123 
pû_svn_¿w
;

124 
ASYLO_ASSIGN_OR_RETURN
(
pû_svn_¿w
, 
JsÚG‘Numb”
(
pû_svn_jsÚ
));

125 ià(
	gpû_svn_¿w
 < 0. ||…û_svn_¿w > 
	gkPûSvnMaxV®ue
) {

126  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

130 
PûSvn
 
	gpû_svn
;

131 
	gpû_svn
.
£t_v®ue
(
pû_svn_¿w
);

132  
	gpû_svn
;

135 
	gStusOr
<
	gTcb
> 
TcbFromJsÚV®ue
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
jsÚ_v®ue
) {

136 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 *
tcb_objeù
;

137 
ASYLO_ASSIGN_OR_RETURN
(
tcb_objeù
, 
JsÚG‘Objeù
(
jsÚ_v®ue
));

139 
Tcb
 
	gtcb
;

141 
	gtcb
.
£t_compÚ’ts
(
¡d
::
¡ršg
(
kTcbCompÚ’tsSize
, 0));

142 
	gi
 = 0; i < 
	gkTcbCompÚ’tsSize
; ++i) {

143 cÚ¡ 
	g¡d
::
¡ršg
 
f›ld_Çme
 = 
ab¦
::
SŒFÜm©
("sgxtcbcomp%02dsvn", 
i
 + 1);

144 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
compÚ’t_jsÚ
;

145 
ASYLO_ASSIGN_OR_RETURN
(
compÚ’t_jsÚ
,

146 
JsÚObjeùG‘F›ld
(*
tcb_objeù
, 
f›ld_Çme
));

147 
ASYLO_ASSIGN_OR_RETURN
((*
tcb
.
mubË_compÚ’ts
())[
i
],

148 
SgxTcbCompÚ’tSvnFromJsÚ
(*
compÚ’t_jsÚ
));

151 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
pû_svn_jsÚ
;

152 
ASYLO_ASSIGN_OR_RETURN
(
pû_svn_jsÚ
,

153 
JsÚObjeùG‘F›ld
(*
tcb_objeù
, "pcesvn"));

154 
ASYLO_ASSIGN_OR_RETURN
(*
tcb
.
mubË_pû_svn
(), 
PûSvnFromJsÚ
(*
pû_svn_jsÚ
));

159 ià(
	gtcb_objeù
->
f›lds
().
size
(è> 
	gkTcbCompÚ’tsSize
 + 1) {

160 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

161 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
jsÚ_v®ue
, &
jsÚ_¡ršg
).
ok
()) {

162 
	gjsÚ_¡ršg
 = "TCB JSON";

164 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered unrecognized fields in ",

165 
jsÚ_¡ršg
);

168  
	gtcb
;

172 
	gStusOr
<
	gTcbStus
> 
TcbStusFromJsÚ
(

173 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
tcb_¡©us_jsÚ
) {

174 cÚ¡ 
¡d
::
¡ršg
 *
¡©us_¡ršg
;

175 
ASYLO_ASSIGN_OR_RETURN
(
¡©us_¡ršg
, 
JsÚG‘SŒšg
(
tcb_¡©us_jsÚ
));

176 
TcbStus
 
	g¡©us
;

177 ià(
KnownStu£sM­
().
cÚšs
(*
¡©us_¡ršg
)) {

178 
	g¡©us
.
£t_known_¡©us
(
KnownStu£sM­
().
©
(*
¡©us_¡ršg
));

180 
	g¡©us
.
£t_unknown_¡©us
(*
¡©us_¡ršg
);

182  
	g¡©us
;

186 
	gStusOr
<
	gTcbLev–
> 
TcbLev–FromJsÚ
(

187 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
tcb_Ëv–_jsÚ
) {

188 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 *
tcb_Ëv–_objeù
;

189 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–_objeù
, 
JsÚG‘Objeù
(
tcb_Ëv–_jsÚ
));

190 
TcbLev–
 
	gtcb_Ëv–
;

192 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
tcb_jsÚ
;

193 
ASYLO_ASSIGN_OR_RETURN
(
tcb_jsÚ
,

194 
JsÚObjeùG‘F›ld
(*
tcb_Ëv–_objeù
, "tcb"));

195 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_Ëv–
.
mubË_tcb
(), 
TcbFromJsÚV®ue
(*
tcb_jsÚ
));

197 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
¡©us_jsÚ
;

198 
ASYLO_ASSIGN_OR_RETURN
(
¡©us_jsÚ
,

199 
JsÚObjeùG‘F›ld
(*
tcb_Ëv–_objeù
, "status"));

200 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_Ëv–
.
mubË_¡©us
(),

201 
TcbStusFromJsÚ
(*
¡©us_jsÚ
));

204 ià(
	gtcb_Ëv–_jsÚ
.
¡ruù_v®ue
().
f›lds
().
size
() > 2) {

205 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

206 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
tcb_Ëv–_jsÚ
, &
jsÚ_¡ršg
).
ok
()) {

207 
	gjsÚ_¡ršg
 = "TCB†evel JSON";

209 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered unrecognized fields in ",

210 
jsÚ_¡ršg
);

213  
	gtcb_Ëv–
;

217 
	gStusOr
<> 
V”siÚFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v”siÚ_jsÚ
) {

218 
ASYLO_RETURN_IF_ERROR
(
JsÚG‘Numb”
(
v”siÚ_jsÚ
));

220 
	gv”siÚ
 = 
v”siÚ_jsÚ
.
numb”_v®ue
();

221 ià(
	gv”siÚ
 < 
	g¡©ic_ÿ¡
<>(
	g¡d
::
num”ic_lim™s
<
št32_t
>::
mš
()) ||

222 
v”siÚ
 > 
¡©ic_ÿ¡
<>(
¡d
::
num”ic_lim™s
<
št32_t
>::
max
())) {

223  
Stus
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

226  
	gv”siÚ
;

231 
	gStusOr
<
	ggoogË
::
´Ùobuf
::
Time¡amp
> 
Time¡ampFromJsÚ
(

232 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
time¡amp_jsÚ
) {

233 cÚ¡ 
¡d
::
¡ršg
 *
time¡amp_¡ršg
;

234 
ASYLO_ASSIGN_OR_RETURN
(
time¡amp_¡ršg
, 
JsÚG‘SŒšg
(
time¡amp_jsÚ
));

236 
	gab¦
::
Time
 
time
;

237 
ASYLO_ASSIGN_OR_RETURN
(
time
, 
P¬£Iso8601TimeSŒšg
(*
time¡amp_¡ršg
));

238 ià(!
CªBeTime¡ampPrÙo
(
time
)) {

239  
Stus
(

240 
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

244 
	ggoogË
::
´Ùobuf
::
Time¡amp
 
time¡amp
;

245 
	gab¦
::
Du¿tiÚ
 
äom_unix_•och
 = 
time
 - 
ab¦
::
UnixEpoch
();

246 
št64_t
 
	gnum_£cÚds
 = 
äom_unix_•och
 / 
ab¦
::
SecÚds
(1);

247 
št64_t
 
	gnum_Çnos
 =

248 (
äom_unix_•och
 - 
num_£cÚds
 * 
ab¦
::
SecÚds
(1)è/‡b¦::
Nªo£cÚds
(1);

249 
	gtime¡amp
.
£t_£cÚds
(
num_£cÚds
);

250 
	gtime¡amp
.
£t_Çnos
(
num_Çnos
);

251  
	gtime¡amp
;

255 
	gStusOr
<
	gFm¥c
> 
Fm¥cFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
fm¥c_jsÚ
) {

256 cÚ¡ 
¡d
::
¡ršg
 *
fm¥c_hex_¡ršg
;

257 
ASYLO_ASSIGN_OR_RETURN
(
fm¥c_hex_¡ršg
, 
JsÚG‘SŒšg
(
fm¥c_jsÚ
));

258 ià(!
IsHexEncoded
(*
fm¥c_hex_¡ršg
)) {

259  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

263 
	g¡d
::
¡ršg
 
fm¥c_by‹s
 = 
ab¦
::
HexSŒšgToBy‹s
(*
fm¥c_hex_¡ršg
);

264 ià(
	gfm¥c_by‹s
.
size
(è!ğ
kFm¥cSize
) {

265  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

266 
ab¦
::
SŒC©
("FMSPC JSON dÛ nÙ„•»£Á‡ ", 
kFm¥cSize
,

270 
Fm¥c
 
	gfm¥c
;

271 
	gfm¥c
.
£t_v®ue
(
fm¥c_by‹s
);

272  
	gfm¥c
;

276 
	gStusOr
<
	gPûId
> 
PûIdFromJsÚ
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
pû_id_jsÚ
) {

277 
cÚ¡ex´
 
kPûIdNumBy‹s
 = 2;

279 cÚ¡ 
	g¡d
::
¡ršg
 *
pû_id_hex_¡ršg
;

280 
ASYLO_ASSIGN_OR_RETURN
(
pû_id_hex_¡ršg
, 
JsÚG‘SŒšg
(
pû_id_jsÚ
));

281 ià(!
IsHexEncoded
(*
pû_id_hex_¡ršg
)) {

282  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

286 
	g¡d
::
¡ršg
 
pû_id_by‹s
 = 
ab¦
::
HexSŒšgToBy‹s
(*
pû_id_hex_¡ršg
);

287 ià(
	gpû_id_by‹s
.
size
(è!ğ
kPûIdNumBy‹s
) {

288  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

289 
ab¦
::
SŒC©
("PCE ID JSON does‚ot„epresent‡ ",

290 
kPûIdNumBy‹s
, "-byte value"));

293 
PûId
 
	gpû_id
;

294 
	gpû_id
.
£t_v®ue
(

295 
Ë16toh
(*
»š‹½»t_ÿ¡
<cÚ¡ 
ušt16_t
 *>(
pû_id_by‹s
.
d©a
())));

296  
	gpû_id
;

300 
	gStusOr
<
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
TcbLev–
>> 
TcbLev–sFromJsÚ
(

301 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
tcb_Ëv–s_jsÚ
) {

302 cÚ¡ 
googË
::
´Ùobuf
::
Li¡V®ue
 *
tcb_Ëv–s_¬¿y
;

303 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–s_¬¿y
, 
JsÚG‘A¼ay
(
tcb_Ëv–s_jsÚ
));

305 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTcbStus
> 
	gtcb_to_¡©us_m­
;

306 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
TcbLev–
> 
tcb_Ëv–s
;

307 cÚ¡‡utØ&
	gtcb_Ëv–_jsÚ
 : 
tcb_Ëv–s_¬¿y
->
v®ues
()) {

308 
TcbLev–
 
tcb_Ëv–
;

309 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–
, 
TcbLev–FromJsÚ
(
tcb_Ëv–_jsÚ
));

310 
	g¡d
::
¡ršg
 
m­_key
 = 
ab¦
::
SŒC©
(
tcb_Ëv–
.
tcb
().
compÚ’ts
(),

311 
tcb_Ëv–
.
tcb
().
pû_svn
().
v®ue
());

312 autØ
	gš£¹_·œ
 = 
tcb_to_¡©us_m­
.
š£¹
({
m­_key
, 
tcb_Ëv–
.
¡©us
()});

313 ià(!
	gš£¹_·œ
.
	g£cÚd
) {

314 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equ®s
(
š£¹_·œ
.
fœ¡
->
£cÚd
,

315 
tcb_Ëv–
.
¡©us
())) {

316  
Stus
(

317 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

321 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

322 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
tcb_Ëv–s_jsÚ
, &
jsÚ_¡ršg
)

323 .
ok
()) {

324 
	gjsÚ_¡ršg
 = "TCB†evels JSON";

326 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered duplicate TCBƒntries in ",

327 
jsÚ_¡ršg
);

331 *
	gtcb_Ëv–s
.
Add
(èğ
¡d
::
move
(
tcb_Ëv–
);

333  
	gtcb_Ëv–s
;

338 
	gStusOr
<
	gTcbInfo
> 
TcbInfoFromJsÚV1
(

339 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 &
tcb_šfo_objeù
) {

340 
TcbInfo
 
tcb_šfo
;

341 
TcbInfoIm¶
 *
	gtcb_šfo_im¶
 = 
tcb_šfo
.
mubË_im¶
();

343 
	gtcb_šfo_im¶
->
£t_v”siÚ
(1);

345 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
issue_d©e_jsÚ
;

346 
ASYLO_ASSIGN_OR_RETURN
(
issue_d©e_jsÚ
,

347 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "issueDate"));

348 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_issue_d©e
(),

349 
Time¡ampFromJsÚ
(*
issue_d©e_jsÚ
));

351 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
Ãxt_upd©e_jsÚ
;

352 
ASYLO_ASSIGN_OR_RETURN
(
Ãxt_upd©e_jsÚ
,

353 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "nextUpdate"));

354 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_Ãxt_upd©e
(),

355 
Time¡ampFromJsÚ
(*
Ãxt_upd©e_jsÚ
));

357 ià(
	gtcb_šfo_im¶
->
issue_d©e
(è>ğ
tcb_šfo_im¶
->
Ãxt_upd©e
()) {

358  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

362 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
fm¥c_jsÚ
;

363 
ASYLO_ASSIGN_OR_RETURN
(
fm¥c_jsÚ
,

364 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "fmspc"));

365 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_fm¥c
(),

366 
Fm¥cFromJsÚ
(*
fm¥c_jsÚ
));

368 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
pû_id_jsÚ
;

369 
ASYLO_ASSIGN_OR_RETURN
(
pû_id_jsÚ
,

370 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "pceId"));

371 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_pû_id
(),

372 
PûIdFromJsÚ
(*
pû_id_jsÚ
));

374 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
tcb_Ëv–s_jsÚ
;

375 
ASYLO_ASSIGN_OR_RETURN
(
tcb_Ëv–s_jsÚ
,

376 
JsÚObjeùG‘F›ld
(
tcb_šfo_objeù
, "tcbLevels"));

377 
ASYLO_ASSIGN_OR_RETURN
(*
tcb_šfo_im¶
->
mubË_tcb_Ëv–s
(),

378 
TcbLev–sFromJsÚ
(*
tcb_Ëv–s_jsÚ
));

382 ià(
	gtcb_šfo_objeù
.
f›lds
().
size
() > 6) {

383 
	g¡d
::
¡ršg
 
jsÚ_¡ršg
;

384 ià(!
	ggoogË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
tcb_šfo_objeù
, &
jsÚ_¡ršg
)

385 .
ok
()) {

386 
	gjsÚ_¡ršg
 = "TCB info JSON";

388 
LOG
(
WARNING
è<< 
	gab¦
::
SŒC©
("Encountered unrecognized fields in ",

389 
jsÚ_¡ršg
);

392  
	gtcb_šfo
;

397 
	gStusOr
<
	gTcb
> 
TcbFromJsÚ
(cÚ¡ 
¡d
::
¡ršg
 &
jsÚ_¡ršg
) {

398 
googË
::
´Ùobuf
::
V®ue
 
tcb_jsÚ
;

399 
ASYLO_RETURN_IF_ERROR
(

400 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
jsÚ_¡ršg
, &
tcb_jsÚ
)));

401  
TcbFromJsÚV®ue
(
tcb_jsÚ
);

404 
	gStusOr
<
	gTcbInfo
> 
TcbInfoFromJsÚ
(cÚ¡ 
¡d
::
¡ršg
 &
jsÚ_¡ršg
) {

405 
googË
::
´Ùobuf
::
V®ue
 
tcb_šfo_jsÚ
;

406 
ASYLO_RETURN_IF_ERROR
(

407 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
jsÚ_¡ršg
, &
tcb_šfo_jsÚ
)));

409 cÚ¡ 
	ggoogË
::
´Ùobuf
::
SŒuù
 *
tcb_šfo_objeù
;

410 
ASYLO_ASSIGN_OR_RETURN
(
tcb_šfo_objeù
, 
JsÚG‘Objeù
(
tcb_šfo_jsÚ
));

412 cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *
v”siÚ_jsÚ
;

413 
ASYLO_ASSIGN_OR_RETURN
(
v”siÚ_jsÚ
,

414 
JsÚObjeùG‘F›ld
(*
tcb_šfo_objeù
, "version"));

415 
	gv”siÚ
;

416 
ASYLO_ASSIGN_OR_RETURN
(
v”siÚ
, 
V”siÚFromJsÚ
(*
v”siÚ_jsÚ
));

417 
	gv”siÚ
) {

419  
TcbInfoFromJsÚV1
(*
tcb_šfo_objeù
);

421  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

	@identity/sgx/tcb_info_from_json.h

19 #iâdeà
ASYLO_IDENTITY_SGX_TCB_INFO_FROM_JSON_H_


20 
	#ASYLO_IDENTITY_SGX_TCB_INFO_FROM_JSON_H_


	)

22 
	~<¡ršg
>

24 
	~"googË/´Ùobuf/¡ruù.pb.h
"

25 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gsgx
 {

39 
	gStusOr
<
	gTcb
> 
TcbFromJsÚ
(cÚ¡ 
¡d
::
¡ršg
 &
jsÚ_¡ršg
);

57 
	gStusOr
<
	gTcbInfo
> 
TcbInfoFromJsÚ
(cÚ¡ 
¡d
::
¡ršg
 &
jsÚ_¡ršg
);

	@identity/sgx/tcb_info_from_json_test.cc

19 
	~"asylo/id’t™y/sgx/tcb_šfo_äom_jsÚ.h
"

21 
	~<’dŸn.h
>

23 
	~"googË/´Ùobuf/¡ruù.pb.h
"

24 
	~<googË/´Ùobuf/‹xt_fÜm©.h
>

25 
	~<googË/´Ùobuf/ut/jsÚ_ut.h
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/ba£/maüos.h
"

29 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

30 
	~"ab¦/time/civ_time.h
"

31 
	~"ab¦/time/time.h
"

32 
	~"asylo/ut/loggšg.h
"

33 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

34 
	~"asylo/id’t™y/sgx/tcb.h
"

35 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

36 
	~"asylo/‹¡/ut/ouut_cŞËùÜ.h
"

37 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©us_maüos.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
Çme¥aû
 
	gsgx
 {

44 
	gÇme¥aû
 {

46 
	gusšg
 ::
‹¡šg
::
CÚšsRegex
;

47 
	gusšg
 ::
‹¡šg
::
Eq
;

48 
	gusšg
 ::
‹¡šg
::
SizeIs
;

50 
cÚ¡ex´
 
	gkLogW¬nšgRegex
[] = " WARNING ";

53 
	ggoogË
::
´Ùobuf
::
V®ue
 
C»©eV®idTcbJsÚ
() {

54 
cÚ¡ex´
 
kV®idTcbJsÚ
[] = 
R
"json({

72 })
jsÚ
";

74 
googË
::
´Ùobuf
::
V®ue
 
tcb
;

75 
ASYLO_CHECK_OK
(

76 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
kV®idTcbJsÚ
, &
tcb
)));

77  
	gtcb
;

81 
	ggoogË
::
´Ùobuf
::
V®ue
 
C»©eV®idTcbInfoJsÚ
() {

82 
cÚ¡ex´
 
kV®idTcbInfoJsÚ
[] = 
R
"json({

110 })
jsÚ
";

112 
googË
::
´Ùobuf
::
V®ue
 
tcb_šfo
;

113 
ASYLO_CHECK_OK
(

114 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
kV®idTcbInfoJsÚ
, &
tcb_šfo
)));

115  
	gtcb_šfo
;

119 
	g¡d
::
¡ršg
 
JsÚToSŒšg
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
jsÚ
) {

120 
¡d
::
¡ršg
 
jsÚ_¡ršg
;

121 
ASYLO_CHECK_OK
(
Stus
(
googË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
jsÚ
, &
jsÚ_¡ršg
)));

122  
	gjsÚ_¡ršg
;

125 
TEST
(
TcbFromJsÚV®ueTe¡
, 
Im´İ”JsÚFasToP¬£
) {

126 
EXPECT_THAT
(
TcbFromJsÚ
("} Wa™‡ mšu‹! Thi i¢'ˆ´İ” JSON!").
¡©us
(),

127 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

130 
TEST
(
TcbFromJsÚTe¡
, 
NÚObjeùJsÚV®ueFasToP¬£
) {

131 
EXPECT_THAT
(
TcbFromJsÚ
("[\"AÀ¬¿y,‚Ù‡Àobjeù\"]").
¡©us
(),

132 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

135 
TEST
(
TcbFromJsÚTe¡
, 
MissšgSgxTcbCompÚ’tSvnFasToP¬£
) {

136 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

137 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("sgxtcbcomp09svn");

138 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

139 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

142 
TEST
(
TcbFromJsÚTe¡
, 
NÚIÁeg”SgxTcbCompÚ’tSvnFasToP¬£
) {

143 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

144 
	gjsÚ
.
mubË_¡ruù_v®ue
()

145 ->
mubË_f›lds
()

146 ->
©
("sgxtcbcomp06svn")

147 .
mubË_li¡_v®ue
();

148 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

149 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

152 
TEST
(
TcbFromJsÚTe¡
, 
OutOfBoundsSgxTcbCompÚ’tSvnFasToP¬£
) {

153 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

154 
	gjsÚ
.
mubË_¡ruù_v®ue
()

155 ->
mubË_f›lds
()

156 ->
©
("sgxtcbcomp15svn")

157 .
£t_numb”_v®ue
(-7.);

158 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

159 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

161 
	gjsÚ
.
mubË_¡ruù_v®ue
()

162 ->
mubË_f›lds
()

163 ->
©
("sgxtcbcomp15svn")

164 .
£t_numb”_v®ue
(1000.);

165 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

166 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

169 
TEST
(
TcbFromJsÚTe¡
, 
W™houtPûSvnF›ldFasToP¬£
) {

170 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

171 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("pcesvn");

172 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

173 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

176 
TEST
(
TcbFromJsÚTe¡
, 
NÚIÁeg”PûSvnF›ldFasToP¬£
) {

177 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

178 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûsvn").
£t_¡ršg_v®ue
(

180 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

181 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

184 
TEST
(
TcbFromJsÚTe¡
, 
OutOfBoundsPûSvnF›ldFasToP¬£
) {

185 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

186 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûsvn").
£t_numb”_v®ue
(

188 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

189 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

191 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûsvn").
£t_numb”_v®ue
(

193 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

194 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

197 
TEST
(
TcbFromJsÚTe¡
, 
CÜ»ùTcbJsÚP¬£sSucûssfuÎy
) {

198 
cÚ¡ex´
 
	gkEx³ùedTcbPrÙo
[] = 
R
"proto(

199 
compÚ’ts
: "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f"

200 
pû_svn
 { 
v®ue
: 2 }

201 )
´Ùo
";

203 
Tcb
 
tcb
;

204 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb
,

205 
TcbFromJsÚ
(
JsÚToSŒšg
(
C»©eV®idTcbJsÚ
())));

206 
ASYLO_ASSERT_OK
(
V®id©eTcb
(
tcb
));

208 
Tcb
 
	gex³ùed_tcb
;

209 
ASSERT_TRUE
(

210 
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
(
kEx³ùedTcbPrÙo
, &
ex³ùed_tcb
));

211 
EXPECT_THAT
(
tcb
, 
Equ®sPrÙo
(
ex³ùed_tcb
));

214 
TEST
(
TcbFromJsÚTe¡
, 
ExŒaF›ldsCau£sLogW¬nšg
) {

215 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

216 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

217 
	gv®ue
.
£t_numb”_v®ue
(0.);

218 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
š£¹
({"exŒa", 
v®ue
});

220 
Tcb
 
	gtcb
;

221 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

222 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb
, 
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

223 
ASYLO_ASSERT_OK
(
V®id©eTcb
(
tcb
));

224 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

225 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

228 
TEST
(
TcbInfoFromJsÚTe¡
, 
Im´İ”JsÚFasToP¬£
) {

229 
EXPECT_THAT
(

230 
TcbInfoFromJsÚ
("} Wa™‡ mšu‹! Thi i¢'ˆ´İ” JSON!").
¡©us
(),

231 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

234 
TEST
(
TcbInfoFromJsÚTe¡
, 
NÚObjeùJsÚV®ueFasToP¬£
) {

235 
EXPECT_THAT
(
TcbInfoFromJsÚ
("[\"AÀ¬¿y,‚Ù‡Àobjeù\"]").
¡©us
(),

236 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

239 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtV”siÚF›ldFasToP¬£
) {

240 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

241 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("version");

242 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

243 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

246 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚIÁeg”V”siÚFasToP¬£
) {

247 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

248 
	gjsÚ
.
mubË_¡ruù_v®ue
()

249 ->
mubË_f›lds
()

250 ->
©
("version")

251 .
mubË_li¡_v®ue
();

252 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

253 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

256 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hOutOfRªgeV”siÚFasToP¬£
) {

257 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

258 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("v”siÚ").
£t_numb”_v®ue
(

260 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

261 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

264 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hUnknownV”siÚFasToP¬£
) {

265 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

266 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("v”siÚ").
£t_numb”_v®ue
(

268 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

269 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

272 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtIssueD©eF›ldFasToP¬£
) {

273 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

274 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("issueDate");

275 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

276 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

279 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgIssueD©eFasToP¬£
) {

280 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

281 
	gjsÚ
.
mubË_¡ruù_v®ue
()

282 ->
mubË_f›lds
()

283 ->
©
("issueDate")

284 .
mubË_li¡_v®ue
();

285 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

286 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

289 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hG¬bËdIssueD©eFasToP¬£
) {

290 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

291 
	gjsÚ
.
mubË_¡ruù_v®ue
()

292 ->
mubË_f›lds
()

293 ->
©
("issueDate")

294 .
£t_¡ršg_v®ue
("2000-01-01T00:00:0whatisthemeaningoflifeZ");

295 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

296 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

299 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hOutOfRªgeIssueD©eFasToP¬£
) {

300 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

301 
	gjsÚ
.
mubË_¡ruù_v®ue
()

302 ->
mubË_f›lds
()

303 ->
©
("issueDate")

304 .
£t_¡ršg_v®ue
("10000-01-01T00:00:00Z");

305 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

306 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

309 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtNextUpd©eF›ldFasToP¬£
) {

310 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

311 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("nextUpdate");

312 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

313 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

316 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgNextUpd©eFasToP¬£
) {

317 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

318 
	gjsÚ
.
mubË_¡ruù_v®ue
()

319 ->
mubË_f›lds
()

320 ->
©
("nextUpdate")

321 .
mubË_li¡_v®ue
();

322 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

323 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

326 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hG¬bËdNextUpd©eFasToP¬£
) {

327 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

328 
	gjsÚ
.
mubË_¡ruù_v®ue
()

329 ->
mubË_f›lds
()

330 ->
©
("nextUpdate")

331 .
£t_¡ršg_v®ue
("2000-01-01T00:00:0whatisthemeaningoflifeZ");

332 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

333 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

336 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hOutOfRªgeNextUpd©eFasToP¬£
) {

337 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

338 
	gjsÚ
.
mubË_¡ruù_v®ue
()

339 ->
mubË_f›lds
()

340 ->
©
("nextUpdate")

341 .
£t_¡ršg_v®ue
("10000-01-01T00:00:00Z");

342 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

343 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

346 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hIssueD©eAá”NextUpd©eFasToP¬£
) {

347 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

348 
	gjsÚ
.
mubË_¡ruù_v®ue
()

349 ->
mubË_f›lds
()

350 ->
©
("issueDate")

351 .
£t_¡ršg_v®ue
("3000-01-01T00:00:00Z");

352 
	gjsÚ
.
mubË_¡ruù_v®ue
()

353 ->
mubË_f›lds
()

354 ->
©
("nextUpdate")

355 .
£t_¡ršg_v®ue
("2000-01-01T00:00:00Z");

356 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

357 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

360 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtFm¥cF›ldFasToP¬£
) {

361 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

362 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("fmspc");

363 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

364 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

367 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgFm¥cFasToP¬£
) {

368 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

369 
	gjsÚ
.
mubË_¡ruù_v®ue
()

370 ->
mubË_f›lds
()

371 ->
©
("fmspc")

372 .
mubË_li¡_v®ue
();

373 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

374 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

377 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hBadHexInFm¥cFasToP¬£
) {

378 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

379 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("fm¥c").
£t_¡ršg_v®ue
(

381 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

382 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

385 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hWrÚgSizeOfFm¥cFasToP¬£
) {

386 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

387 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("fm¥c").
£t_¡ršg_v®ue
(

389 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

390 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

393 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtPûIdF›ldFasToP¬£
) {

394 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

395 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("pceId");

396 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

397 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

400 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgPûIdFasToP¬£
) {

401 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

402 
	gjsÚ
.
mubË_¡ruù_v®ue
()

403 ->
mubË_f›lds
()

404 ->
©
("pceId")

405 .
mubË_li¡_v®ue
();

406 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

407 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

410 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hBadHexInPûIdFasToP¬£
) {

411 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

412 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûId").
£t_¡ršg_v®ue
(

414 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

415 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

418 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hWrÚgSizeOfPûIdFasToP¬£
) {

419 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

420 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûId").
£t_¡ršg_v®ue
(

422 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

423 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

426 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtTcbLev–sF›ldFasToP¬£
) {

427 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

428 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("tcbLevels");

429 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

430 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

433 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚA¼ayTcbLev–sFasToP¬£
) {

434 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

435 
	gjsÚ
.
mubË_¡ruù_v®ue
()

436 ->
mubË_f›lds
()

437 ->
©
("tcbLevels")

438 .
mubË_¡ruù_v®ue
();

439 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

440 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

443 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™houtTcbF›ldFasToP¬£
) {

444 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

445 
	gjsÚ
.
mubË_¡ruù_v®ue
()

446 ->
mubË_f›lds
()

447 ->
©
("tcbLevels")

448 .
mubË_li¡_v®ue
()

449 ->
mubË_v®ues
(0)

450 ->
mubË_¡ruù_v®ue
()

451 ->
mubË_f›lds
()

452 ->
”a£
("tcb");

453 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

454 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

457 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™hNÚObjeùTcbFasToP¬£
) {

458 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

459 
	gjsÚ
.
mubË_¡ruù_v®ue
()

460 ->
mubË_f›lds
()

461 ->
©
("tcbLevels")

462 .
mubË_li¡_v®ue
()

463 ->
mubË_v®ues
(0)

464 ->
mubË_¡ruù_v®ue
()

465 ->
mubË_f›lds
()

466 ->
©
("tcb")

467 .
mubË_li¡_v®ue
();

468 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

469 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

472 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hMissšgSgxTcbCompÚ’tSvnFasToP¬£
) {

473 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

474 
	gjsÚ
.
mubË_¡ruù_v®ue
()

475 ->
mubË_f›lds
()

476 ->
©
("tcbLevels")

477 .
mubË_li¡_v®ue
()

478 ->
mubË_v®ues
(0)

479 ->
mubË_¡ruù_v®ue
()

480 ->
mubË_f›lds
()

481 ->
©
("tcb")

482 .
mubË_¡ruù_v®ue
()

483 ->
mubË_f›lds
()

484 ->
”a£
("sgxtcbcomp09svn");

485 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

486 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

489 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hNÚIÁeg”SgxTcbCompÚ’tSvnFasToP¬£
) {

490 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

491 
	gjsÚ
.
mubË_¡ruù_v®ue
()

492 ->
mubË_f›lds
()

493 ->
©
("tcbLevels")

494 .
mubË_li¡_v®ue
()

495 ->
mubË_v®ues
(0)

496 ->
mubË_¡ruù_v®ue
()

497 ->
mubË_f›lds
()

498 ->
©
("tcb")

499 .
mubË_¡ruù_v®ue
()

500 ->
mubË_f›lds
()

501 ->
©
("sgxtcbcomp06svn")

502 .
mubË_li¡_v®ue
();

503 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

504 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

507 
TEST
(
TcbInfoFromJsÚTe¡
,

508 
TcbJsÚW™hOutOfBoundsSgxTcbCompÚ’tSvnFasToP¬£
) {

509 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

510 
	gjsÚ
.
mubË_¡ruù_v®ue
()

511 ->
mubË_f›lds
()

512 ->
©
("tcbLevels")

513 .
mubË_li¡_v®ue
()

514 ->
mubË_v®ues
(0)

515 ->
mubË_¡ruù_v®ue
()

516 ->
mubË_f›lds
()

517 ->
©
("tcb")

518 .
mubË_¡ruù_v®ue
()

519 ->
mubË_f›lds
()

520 ->
©
("sgxtcbcomp15svn")

521 .
£t_numb”_v®ue
(-7.);

522 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

523 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

525 
	gjsÚ
.
mubË_¡ruù_v®ue
()

526 ->
mubË_f›lds
()

527 ->
©
("tcbLevels")

528 .
mubË_li¡_v®ue
()

529 ->
mubË_v®ues
(0)

530 ->
mubË_¡ruù_v®ue
()

531 ->
mubË_f›lds
()

532 ->
©
("tcb")

533 .
mubË_¡ruù_v®ue
()

534 ->
mubË_f›lds
()

535 ->
©
("sgxtcbcomp15svn")

536 .
£t_numb”_v®ue
(1000.);

537 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

538 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

541 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™houtPûSvnF›ldFasToP¬£
) {

542 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

543 
	gjsÚ
.
mubË_¡ruù_v®ue
()

544 ->
mubË_f›lds
()

545 ->
©
("tcbLevels")

546 .
mubË_li¡_v®ue
()

547 ->
mubË_v®ues
(0)

548 ->
mubË_¡ruù_v®ue
()

549 ->
mubË_f›lds
()

550 ->
©
("tcb")

551 .
mubË_¡ruù_v®ue
()

552 ->
mubË_f›lds
()

553 ->
”a£
("pcesvn");

554 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

555 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

558 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hNÚIÁeg”PûSvnF›ldFasToP¬£
) {

559 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

560 
	gjsÚ
.
mubË_¡ruù_v®ue
()

561 ->
mubË_f›lds
()

562 ->
©
("tcbLevels")

563 .
mubË_li¡_v®ue
()

564 ->
mubË_v®ues
(0)

565 ->
mubË_¡ruù_v®ue
()

566 ->
mubË_f›lds
()

567 ->
©
("tcb")

568 .
mubË_¡ruù_v®ue
()

569 ->
mubË_f›lds
()

570 ->
©
("pcesvn")

571 .
£t_¡ršg_v®ue
("");

572 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

573 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

576 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hOutOfBoundsPûSvnF›ldFasToP¬£
) {

577 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

578 
	gjsÚ
.
mubË_¡ruù_v®ue
()

579 ->
mubË_f›lds
()

580 ->
©
("tcbLevels")

581 .
mubË_li¡_v®ue
()

582 ->
mubË_v®ues
(0)

583 ->
mubË_¡ruù_v®ue
()

584 ->
mubË_f›lds
()

585 ->
©
("tcb")

586 .
mubË_¡ruù_v®ue
()

587 ->
mubË_f›lds
()

588 ->
©
("pcesvn")

589 .
£t_numb”_v®ue
(-15);

590 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

591 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

593 
	gjsÚ
.
mubË_¡ruù_v®ue
()

594 ->
mubË_f›lds
()

595 ->
©
("tcbLevels")

596 .
mubË_li¡_v®ue
()

597 ->
mubË_v®ues
(0)

598 ->
mubË_¡ruù_v®ue
()

599 ->
mubË_f›lds
()

600 ->
©
("tcb")

601 .
mubË_¡ruù_v®ue
()

602 ->
mubË_f›lds
()

603 ->
©
("pcesvn")

604 .
£t_numb”_v®ue
(70000);

605 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

606 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

609 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™houtStusF›ldFasToP¬£
) {

610 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

611 
	gjsÚ
.
mubË_¡ruù_v®ue
()

612 ->
mubË_f›lds
()

613 ->
©
("tcbLevels")

614 .
mubË_li¡_v®ue
()

615 ->
mubË_v®ues
(0)

616 ->
mubË_¡ruù_v®ue
()

617 ->
mubË_f›lds
()

618 ->
”a£
("status");

619 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

620 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

623 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™hNÚSŒšgStusFasToP¬£
) {

624 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

625 
	gjsÚ
.
mubË_¡ruù_v®ue
()

626 ->
mubË_f›lds
()

627 ->
©
("tcbLevels")

628 .
mubË_li¡_v®ue
()

629 ->
mubË_v®ues
(0)

630 ->
mubË_¡ruù_v®ue
()

631 ->
mubË_f›lds
()

632 ->
©
("status")

633 .
mubË_li¡_v®ue
();

634 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

635 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

638 
TEST
(
TcbInfoFromJsÚTe¡
,

639 
TcbInfoJsÚW™hDu¶iÿ‹TcbsW™hDifã»ÁStu£sFasToP¬£
) {

640 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

641 
	ggoogË
::
´Ùobuf
::
Li¡V®ue
 *
tcb_Ëv–s
 = 
jsÚ
.
mubË_¡ruù_v®ue
()

642 ->
mubË_f›lds
()

643 ->
©
("tcbLevels")

644 .
mubË_li¡_v®ue
();

645 
	ggoogË
::
´Ùobuf
::
V®ue
 *
Ãw_Ëv–
 = 
tcb_Ëv–s
->
add_v®ues
();

646 *
	gÃw_Ëv–
 = 
tcb_Ëv–s
->
v®ues
(0);

647 
	gÃw_Ëv–
->
mubË_¡ruù_v®ue
()

648 ->
mubË_f›lds
()

649 ->
©
("status")

650 .
£t_¡ršg_v®ue
("OutOfDate");

651 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

652 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

655 
TEST
(
TcbInfoFromJsÚTe¡
, 
CÜ»ùTcbInfoJsÚP¬£sSucûssfuÎy
) {

656 
cÚ¡ex´
 
	gkEx³ùedTcbInfoPrÙo
[] = 
R
"proto(

657 
im¶
 {

658 
v”siÚ
: 1

659 
issue_d©e
 { 
£cÚds
: 1582230020 
Çnos
: 0 }

660 
Ãxt_upd©e
: { 
£cÚds
: 1584735620 
Çnos
: 0 }

661 
fm¥c
 { 
v®ue
: "\x01\x23\x45\x67\x89\xab" }

662 
pû_id
 { 
v®ue
: 0 }

663 
tcb_Ëv–s
 {

664 
tcb
 {

665 
compÚ’ts
: "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f"

666 
pû_svn
 { 
v®ue
: 2 }

668 
¡©us
 { 
known_¡©us
: 
UP_TO_DATE
 }

671 )
´Ùo
";

673 
TcbInfo
 
tcb_šfo
;

674 
ASYLO_ASSERT_OK_AND_ASSIGN
(

675 
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
C»©eV®idTcbInfoJsÚ
())));

676 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

678 
TcbInfo
 
	gex³ùed_tcb_šfo
;

679 
ASSERT_TRUE
(
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
(
kEx³ùedTcbInfoPrÙo
,

680 &
ex³ùed_tcb_šfo
));

681 
EXPECT_THAT
(
tcb_šfo
, 
Equ®sPrÙo
(
ex³ùed_tcb_šfo
));

684 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚZ”oPûIdP¬£sSucûssfuÎy
) {

685 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

686 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûId").
£t_¡ršg_v®ue
(

689 
TcbInfo
 
	gtcb_šfo
;

690 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

691 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

692 
EXPECT_THAT
(
tcb_šfo
.
im¶
().
pû_id
().
v®ue
(), 
Eq
(0x0123));

695 
TEST
(
TcbInfoFromJsÚTe¡
,

696 
TcbLev–JsÚW™hDifã»ÁKnownStusV®uesP¬£SucûssfuÎy
) {

697 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kKnownStusSŒšgs
[] = {

699 
cÚ¡ex´
 
	gTcbStus
::
StusTy³
 
kKnownStusV®ues
[] = {

700 
TcbStus
::
UP_TO_DATE
, TcbStus::
CONFIGURATION_NEEDED
,

701 
TcbStus
::
OUT_OF_DATE
, TcbStus::
REVOKED
};

703 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

704 
TcbInfo
 
	gtcb_šfo
;

706 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kKnownStusV®ues
); ++i) {

707 
	gjsÚ
.
mubË_¡ruù_v®ue
()

708 ->
mubË_f›lds
()

709 ->
©
("tcbLevels")

710 .
mubË_li¡_v®ue
()

711 ->
mubË_v®ues
(0)

712 ->
mubË_¡ruù_v®ue
()

713 ->
mubË_f›lds
()

714 ->
©
("status")

715 .
£t_¡ršg_v®ue
(
kKnownStusSŒšgs
[
i
].
d©a
(),

716 
kKnownStusSŒšgs
[
i
].
size
());

718 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

719 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

720 cÚ¡ 
	gTcbStus
 &
	gtcb_¡©us
 = 
tcb_šfo
.
im¶
().
tcb_Ëv–s
(0).
¡©us
();

721 
ASSERT_THAT
(
tcb_¡©us
.
v®ue_ÿ£
(), 
Eq
(
TcbStus
::
kKnownStus
));

722 
EXPECT_THAT
(
tcb_¡©us
.
known_¡©us
(), 
Eq
(
kKnownStusV®ues
[
i
]));

726 
TEST
(
TcbInfoFromJsÚTe¡
,

727 
TcbLev–JsÚW™hR•—‹dTcbLev–sIsDedu¶iÿ‹dAndCau£sLogW¬nšg
) {

728 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

729 
	ggoogË
::
´Ùobuf
::
Li¡V®ue
 *
tcb_Ëv–s
 = 
jsÚ
.
mubË_¡ruù_v®ue
()

730 ->
mubË_f›lds
()

731 ->
©
("tcbLevels")

732 .
mubË_li¡_v®ue
();

733 *
	gtcb_Ëv–s
->
add_v®ues
(èğ
tcb_Ëv–s
->
v®ues
(0);

735 
TcbInfo
 
	gtcb_šfo
;

736 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

737 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

738 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

739 
EXPECT_THAT
(
tcb_šfo
.
im¶
().
tcb_Ëv–s
(), 
SizeIs
(1));

740 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

741 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

744 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hExŒaF›ldsCau£sLogW¬nšg
) {

745 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

746 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

747 
	gv®ue
.
£t_numb”_v®ue
(0.);

748 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
š£¹
({"v”yExŒa", 
v®ue
});

750 
TcbInfo
 
	gtcb_šfo
;

751 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

752 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

753 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

754 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

755 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

758 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™hExŒaF›ldsCau£sLogW¬nšg
) {

759 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

760 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

761 
	gv®ue
.
£t_numb”_v®ue
(0.);

762 
	gjsÚ
.
mubË_¡ruù_v®ue
()

763 ->
mubË_f›lds
()

764 ->
©
("tcbLevels")

765 .
mubË_li¡_v®ue
()

766 ->
mubË_v®ues
(0)

767 ->
mubË_¡ruù_v®ue
()

768 ->
mubË_f›lds
()

769 ->
š£¹
({"v”yExŒa", 
v®ue
});

771 
TcbInfo
 
	gtcb_šfo
;

772 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

773 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

774 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

775 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

776 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

779 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hExŒaF›ldsCau£sLogW¬nšg
) {

780 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

781 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

782 
	gv®ue
.
£t_numb”_v®ue
(0.);

783 
	gjsÚ
.
mubË_¡ruù_v®ue
()

784 ->
mubË_f›lds
()

785 ->
©
("tcbLevels")

786 .
mubË_li¡_v®ue
()

787 ->
mubË_v®ues
(0)

788 ->
mubË_¡ruù_v®ue
()

789 ->
mubË_f›lds
()

790 ->
©
("tcb")

791 .
mubË_¡ruù_v®ue
()

792 ->
mubË_f›lds
()

793 ->
š£¹
({"v”yExŒa", 
v®ue
});

795 
TcbInfo
 
	gtcb_šfo
;

796 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

797 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

798 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

799 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

800 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

	@identity/sgx/tcb_info_from_json_test.cc

19 
	~"asylo/id’t™y/sgx/tcb_šfo_äom_jsÚ.h
"

21 
	~<’dŸn.h
>

23 
	~"googË/´Ùobuf/¡ruù.pb.h
"

24 
	~<googË/´Ùobuf/‹xt_fÜm©.h
>

25 
	~<googË/´Ùobuf/ut/jsÚ_ut.h
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/ba£/maüos.h
"

29 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

30 
	~"ab¦/time/civ_time.h
"

31 
	~"ab¦/time/time.h
"

32 
	~"asylo/ut/loggšg.h
"

33 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

34 
	~"asylo/id’t™y/sgx/tcb.h
"

35 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

36 
	~"asylo/‹¡/ut/ouut_cŞËùÜ.h
"

37 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©us_maüos.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
Çme¥aû
 
	gsgx
 {

44 
	gÇme¥aû
 {

46 
	gusšg
 ::
‹¡šg
::
CÚšsRegex
;

47 
	gusšg
 ::
‹¡šg
::
Eq
;

48 
	gusšg
 ::
‹¡šg
::
SizeIs
;

50 
cÚ¡ex´
 
	gkLogW¬nšgRegex
[] = " WARNING ";

53 
	ggoogË
::
´Ùobuf
::
V®ue
 
C»©eV®idTcbJsÚ
() {

54 
cÚ¡ex´
 
kV®idTcbJsÚ
[] = 
R
"json({

72 })
jsÚ
";

74 
googË
::
´Ùobuf
::
V®ue
 
tcb
;

75 
ASYLO_CHECK_OK
(

76 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
kV®idTcbJsÚ
, &
tcb
)));

77  
	gtcb
;

81 
	ggoogË
::
´Ùobuf
::
V®ue
 
C»©eV®idTcbInfoJsÚ
() {

82 
cÚ¡ex´
 
kV®idTcbInfoJsÚ
[] = 
R
"json({

110 })
jsÚ
";

112 
googË
::
´Ùobuf
::
V®ue
 
tcb_šfo
;

113 
ASYLO_CHECK_OK
(

114 
Stus
(
googË
::
´Ùobuf
::
ut
::
JsÚSŒšgToMes§ge
(
kV®idTcbInfoJsÚ
, &
tcb_šfo
)));

115  
	gtcb_šfo
;

119 
	g¡d
::
¡ršg
 
JsÚToSŒšg
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
jsÚ
) {

120 
¡d
::
¡ršg
 
jsÚ_¡ršg
;

121 
ASYLO_CHECK_OK
(
Stus
(
googË
::
´Ùobuf
::
ut
::
Mes§geToJsÚSŒšg
(
jsÚ
, &
jsÚ_¡ršg
)));

122  
	gjsÚ_¡ršg
;

125 
TEST
(
TcbFromJsÚV®ueTe¡
, 
Im´İ”JsÚFasToP¬£
) {

126 
EXPECT_THAT
(
TcbFromJsÚ
("} Wa™‡ mšu‹! Thi i¢'ˆ´İ” JSON!").
¡©us
(),

127 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

130 
TEST
(
TcbFromJsÚTe¡
, 
NÚObjeùJsÚV®ueFasToP¬£
) {

131 
EXPECT_THAT
(
TcbFromJsÚ
("[\"AÀ¬¿y,‚Ù‡Àobjeù\"]").
¡©us
(),

132 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

135 
TEST
(
TcbFromJsÚTe¡
, 
MissšgSgxTcbCompÚ’tSvnFasToP¬£
) {

136 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

137 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("sgxtcbcomp09svn");

138 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

139 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

142 
TEST
(
TcbFromJsÚTe¡
, 
NÚIÁeg”SgxTcbCompÚ’tSvnFasToP¬£
) {

143 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

144 
	gjsÚ
.
mubË_¡ruù_v®ue
()

145 ->
mubË_f›lds
()

146 ->
©
("sgxtcbcomp06svn")

147 .
mubË_li¡_v®ue
();

148 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

149 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

152 
TEST
(
TcbFromJsÚTe¡
, 
OutOfBoundsSgxTcbCompÚ’tSvnFasToP¬£
) {

153 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

154 
	gjsÚ
.
mubË_¡ruù_v®ue
()

155 ->
mubË_f›lds
()

156 ->
©
("sgxtcbcomp15svn")

157 .
£t_numb”_v®ue
(-7.);

158 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

159 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

161 
	gjsÚ
.
mubË_¡ruù_v®ue
()

162 ->
mubË_f›lds
()

163 ->
©
("sgxtcbcomp15svn")

164 .
£t_numb”_v®ue
(1000.);

165 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

166 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

169 
TEST
(
TcbFromJsÚTe¡
, 
W™houtPûSvnF›ldFasToP¬£
) {

170 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

171 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("pcesvn");

172 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

173 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

176 
TEST
(
TcbFromJsÚTe¡
, 
NÚIÁeg”PûSvnF›ldFasToP¬£
) {

177 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

178 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûsvn").
£t_¡ršg_v®ue
(

180 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

181 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

184 
TEST
(
TcbFromJsÚTe¡
, 
OutOfBoundsPûSvnF›ldFasToP¬£
) {

185 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

186 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûsvn").
£t_numb”_v®ue
(

188 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

189 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

191 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûsvn").
£t_numb”_v®ue
(

193 
EXPECT_THAT
(
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

194 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

197 
TEST
(
TcbFromJsÚTe¡
, 
CÜ»ùTcbJsÚP¬£sSucûssfuÎy
) {

198 
cÚ¡ex´
 
	gkEx³ùedTcbPrÙo
[] = 
R
"proto(

199 
compÚ’ts
: "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f"

200 
pû_svn
 { 
v®ue
: 2 }

201 )
´Ùo
";

203 
Tcb
 
tcb
;

204 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb
,

205 
TcbFromJsÚ
(
JsÚToSŒšg
(
C»©eV®idTcbJsÚ
())));

206 
ASYLO_ASSERT_OK
(
V®id©eTcb
(
tcb
));

208 
Tcb
 
	gex³ùed_tcb
;

209 
ASSERT_TRUE
(

210 
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
(
kEx³ùedTcbPrÙo
, &
ex³ùed_tcb
));

211 
EXPECT_THAT
(
tcb
, 
Equ®sPrÙo
(
ex³ùed_tcb
));

214 
TEST
(
TcbFromJsÚTe¡
, 
ExŒaF›ldsCau£sLogW¬nšg
) {

215 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbJsÚ
();

216 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

217 
	gv®ue
.
£t_numb”_v®ue
(0.);

218 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
š£¹
({"exŒa", 
v®ue
});

220 
Tcb
 
	gtcb
;

221 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

222 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb
, 
TcbFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

223 
ASYLO_ASSERT_OK
(
V®id©eTcb
(
tcb
));

224 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

225 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

228 
TEST
(
TcbInfoFromJsÚTe¡
, 
Im´İ”JsÚFasToP¬£
) {

229 
EXPECT_THAT
(

230 
TcbInfoFromJsÚ
("} Wa™‡ mšu‹! Thi i¢'ˆ´İ” JSON!").
¡©us
(),

231 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

234 
TEST
(
TcbInfoFromJsÚTe¡
, 
NÚObjeùJsÚV®ueFasToP¬£
) {

235 
EXPECT_THAT
(
TcbInfoFromJsÚ
("[\"AÀ¬¿y,‚Ù‡Àobjeù\"]").
¡©us
(),

236 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

239 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtV”siÚF›ldFasToP¬£
) {

240 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

241 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("version");

242 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

243 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

246 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚIÁeg”V”siÚFasToP¬£
) {

247 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

248 
	gjsÚ
.
mubË_¡ruù_v®ue
()

249 ->
mubË_f›lds
()

250 ->
©
("version")

251 .
mubË_li¡_v®ue
();

252 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

253 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

256 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hOutOfRªgeV”siÚFasToP¬£
) {

257 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

258 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("v”siÚ").
£t_numb”_v®ue
(

260 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

261 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

264 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hUnknownV”siÚFasToP¬£
) {

265 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

266 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("v”siÚ").
£t_numb”_v®ue
(

268 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

269 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

272 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtIssueD©eF›ldFasToP¬£
) {

273 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

274 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("issueDate");

275 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

276 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

279 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgIssueD©eFasToP¬£
) {

280 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

281 
	gjsÚ
.
mubË_¡ruù_v®ue
()

282 ->
mubË_f›lds
()

283 ->
©
("issueDate")

284 .
mubË_li¡_v®ue
();

285 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

286 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

289 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hG¬bËdIssueD©eFasToP¬£
) {

290 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

291 
	gjsÚ
.
mubË_¡ruù_v®ue
()

292 ->
mubË_f›lds
()

293 ->
©
("issueDate")

294 .
£t_¡ršg_v®ue
("2000-01-01T00:00:0whatisthemeaningoflifeZ");

295 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

296 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

299 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hOutOfRªgeIssueD©eFasToP¬£
) {

300 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

301 
	gjsÚ
.
mubË_¡ruù_v®ue
()

302 ->
mubË_f›lds
()

303 ->
©
("issueDate")

304 .
£t_¡ršg_v®ue
("10000-01-01T00:00:00Z");

305 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

306 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

309 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtNextUpd©eF›ldFasToP¬£
) {

310 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

311 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("nextUpdate");

312 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

313 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

316 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgNextUpd©eFasToP¬£
) {

317 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

318 
	gjsÚ
.
mubË_¡ruù_v®ue
()

319 ->
mubË_f›lds
()

320 ->
©
("nextUpdate")

321 .
mubË_li¡_v®ue
();

322 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

323 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

326 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hG¬bËdNextUpd©eFasToP¬£
) {

327 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

328 
	gjsÚ
.
mubË_¡ruù_v®ue
()

329 ->
mubË_f›lds
()

330 ->
©
("nextUpdate")

331 .
£t_¡ršg_v®ue
("2000-01-01T00:00:0whatisthemeaningoflifeZ");

332 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

333 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

336 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hOutOfRªgeNextUpd©eFasToP¬£
) {

337 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

338 
	gjsÚ
.
mubË_¡ruù_v®ue
()

339 ->
mubË_f›lds
()

340 ->
©
("nextUpdate")

341 .
£t_¡ršg_v®ue
("10000-01-01T00:00:00Z");

342 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

343 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

346 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hIssueD©eAá”NextUpd©eFasToP¬£
) {

347 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

348 
	gjsÚ
.
mubË_¡ruù_v®ue
()

349 ->
mubË_f›lds
()

350 ->
©
("issueDate")

351 .
£t_¡ršg_v®ue
("3000-01-01T00:00:00Z");

352 
	gjsÚ
.
mubË_¡ruù_v®ue
()

353 ->
mubË_f›lds
()

354 ->
©
("nextUpdate")

355 .
£t_¡ršg_v®ue
("2000-01-01T00:00:00Z");

356 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

357 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

360 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtFm¥cF›ldFasToP¬£
) {

361 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

362 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("fmspc");

363 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

364 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

367 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgFm¥cFasToP¬£
) {

368 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

369 
	gjsÚ
.
mubË_¡ruù_v®ue
()

370 ->
mubË_f›lds
()

371 ->
©
("fmspc")

372 .
mubË_li¡_v®ue
();

373 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

374 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

377 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hBadHexInFm¥cFasToP¬£
) {

378 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

379 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("fm¥c").
£t_¡ršg_v®ue
(

381 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

382 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

385 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hWrÚgSizeOfFm¥cFasToP¬£
) {

386 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

387 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("fm¥c").
£t_¡ršg_v®ue
(

389 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

390 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

393 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtPûIdF›ldFasToP¬£
) {

394 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

395 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("pceId");

396 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

397 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

400 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚSŒšgPûIdFasToP¬£
) {

401 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

402 
	gjsÚ
.
mubË_¡ruù_v®ue
()

403 ->
mubË_f›lds
()

404 ->
©
("pceId")

405 .
mubË_li¡_v®ue
();

406 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

407 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

410 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hBadHexInPûIdFasToP¬£
) {

411 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

412 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûId").
£t_¡ršg_v®ue
(

414 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

415 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

418 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hWrÚgSizeOfPûIdFasToP¬£
) {

419 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

420 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûId").
£t_¡ršg_v®ue
(

422 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

423 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

426 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™houtTcbLev–sF›ldFasToP¬£
) {

427 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

428 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
”a£
("tcbLevels");

429 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

430 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

433 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚA¼ayTcbLev–sFasToP¬£
) {

434 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

435 
	gjsÚ
.
mubË_¡ruù_v®ue
()

436 ->
mubË_f›lds
()

437 ->
©
("tcbLevels")

438 .
mubË_¡ruù_v®ue
();

439 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

440 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

443 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™houtTcbF›ldFasToP¬£
) {

444 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

445 
	gjsÚ
.
mubË_¡ruù_v®ue
()

446 ->
mubË_f›lds
()

447 ->
©
("tcbLevels")

448 .
mubË_li¡_v®ue
()

449 ->
mubË_v®ues
(0)

450 ->
mubË_¡ruù_v®ue
()

451 ->
mubË_f›lds
()

452 ->
”a£
("tcb");

453 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

454 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

457 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™hNÚObjeùTcbFasToP¬£
) {

458 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

459 
	gjsÚ
.
mubË_¡ruù_v®ue
()

460 ->
mubË_f›lds
()

461 ->
©
("tcbLevels")

462 .
mubË_li¡_v®ue
()

463 ->
mubË_v®ues
(0)

464 ->
mubË_¡ruù_v®ue
()

465 ->
mubË_f›lds
()

466 ->
©
("tcb")

467 .
mubË_li¡_v®ue
();

468 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

469 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

472 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hMissšgSgxTcbCompÚ’tSvnFasToP¬£
) {

473 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

474 
	gjsÚ
.
mubË_¡ruù_v®ue
()

475 ->
mubË_f›lds
()

476 ->
©
("tcbLevels")

477 .
mubË_li¡_v®ue
()

478 ->
mubË_v®ues
(0)

479 ->
mubË_¡ruù_v®ue
()

480 ->
mubË_f›lds
()

481 ->
©
("tcb")

482 .
mubË_¡ruù_v®ue
()

483 ->
mubË_f›lds
()

484 ->
”a£
("sgxtcbcomp09svn");

485 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

486 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

489 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hNÚIÁeg”SgxTcbCompÚ’tSvnFasToP¬£
) {

490 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

491 
	gjsÚ
.
mubË_¡ruù_v®ue
()

492 ->
mubË_f›lds
()

493 ->
©
("tcbLevels")

494 .
mubË_li¡_v®ue
()

495 ->
mubË_v®ues
(0)

496 ->
mubË_¡ruù_v®ue
()

497 ->
mubË_f›lds
()

498 ->
©
("tcb")

499 .
mubË_¡ruù_v®ue
()

500 ->
mubË_f›lds
()

501 ->
©
("sgxtcbcomp06svn")

502 .
mubË_li¡_v®ue
();

503 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

504 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

507 
TEST
(
TcbInfoFromJsÚTe¡
,

508 
TcbJsÚW™hOutOfBoundsSgxTcbCompÚ’tSvnFasToP¬£
) {

509 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

510 
	gjsÚ
.
mubË_¡ruù_v®ue
()

511 ->
mubË_f›lds
()

512 ->
©
("tcbLevels")

513 .
mubË_li¡_v®ue
()

514 ->
mubË_v®ues
(0)

515 ->
mubË_¡ruù_v®ue
()

516 ->
mubË_f›lds
()

517 ->
©
("tcb")

518 .
mubË_¡ruù_v®ue
()

519 ->
mubË_f›lds
()

520 ->
©
("sgxtcbcomp15svn")

521 .
£t_numb”_v®ue
(-7.);

522 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

523 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

525 
	gjsÚ
.
mubË_¡ruù_v®ue
()

526 ->
mubË_f›lds
()

527 ->
©
("tcbLevels")

528 .
mubË_li¡_v®ue
()

529 ->
mubË_v®ues
(0)

530 ->
mubË_¡ruù_v®ue
()

531 ->
mubË_f›lds
()

532 ->
©
("tcb")

533 .
mubË_¡ruù_v®ue
()

534 ->
mubË_f›lds
()

535 ->
©
("sgxtcbcomp15svn")

536 .
£t_numb”_v®ue
(1000.);

537 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

538 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

541 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™houtPûSvnF›ldFasToP¬£
) {

542 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

543 
	gjsÚ
.
mubË_¡ruù_v®ue
()

544 ->
mubË_f›lds
()

545 ->
©
("tcbLevels")

546 .
mubË_li¡_v®ue
()

547 ->
mubË_v®ues
(0)

548 ->
mubË_¡ruù_v®ue
()

549 ->
mubË_f›lds
()

550 ->
©
("tcb")

551 .
mubË_¡ruù_v®ue
()

552 ->
mubË_f›lds
()

553 ->
”a£
("pcesvn");

554 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

555 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

558 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hNÚIÁeg”PûSvnF›ldFasToP¬£
) {

559 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

560 
	gjsÚ
.
mubË_¡ruù_v®ue
()

561 ->
mubË_f›lds
()

562 ->
©
("tcbLevels")

563 .
mubË_li¡_v®ue
()

564 ->
mubË_v®ues
(0)

565 ->
mubË_¡ruù_v®ue
()

566 ->
mubË_f›lds
()

567 ->
©
("tcb")

568 .
mubË_¡ruù_v®ue
()

569 ->
mubË_f›lds
()

570 ->
©
("pcesvn")

571 .
£t_¡ršg_v®ue
("");

572 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

573 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

576 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hOutOfBoundsPûSvnF›ldFasToP¬£
) {

577 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

578 
	gjsÚ
.
mubË_¡ruù_v®ue
()

579 ->
mubË_f›lds
()

580 ->
©
("tcbLevels")

581 .
mubË_li¡_v®ue
()

582 ->
mubË_v®ues
(0)

583 ->
mubË_¡ruù_v®ue
()

584 ->
mubË_f›lds
()

585 ->
©
("tcb")

586 .
mubË_¡ruù_v®ue
()

587 ->
mubË_f›lds
()

588 ->
©
("pcesvn")

589 .
£t_numb”_v®ue
(-15);

590 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

591 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

593 
	gjsÚ
.
mubË_¡ruù_v®ue
()

594 ->
mubË_f›lds
()

595 ->
©
("tcbLevels")

596 .
mubË_li¡_v®ue
()

597 ->
mubË_v®ues
(0)

598 ->
mubË_¡ruù_v®ue
()

599 ->
mubË_f›lds
()

600 ->
©
("tcb")

601 .
mubË_¡ruù_v®ue
()

602 ->
mubË_f›lds
()

603 ->
©
("pcesvn")

604 .
£t_numb”_v®ue
(70000);

605 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

606 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

609 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™houtStusF›ldFasToP¬£
) {

610 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

611 
	gjsÚ
.
mubË_¡ruù_v®ue
()

612 ->
mubË_f›lds
()

613 ->
©
("tcbLevels")

614 .
mubË_li¡_v®ue
()

615 ->
mubË_v®ues
(0)

616 ->
mubË_¡ruù_v®ue
()

617 ->
mubË_f›lds
()

618 ->
”a£
("status");

619 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

620 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

623 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™hNÚSŒšgStusFasToP¬£
) {

624 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

625 
	gjsÚ
.
mubË_¡ruù_v®ue
()

626 ->
mubË_f›lds
()

627 ->
©
("tcbLevels")

628 .
mubË_li¡_v®ue
()

629 ->
mubË_v®ues
(0)

630 ->
mubË_¡ruù_v®ue
()

631 ->
mubË_f›lds
()

632 ->
©
("status")

633 .
mubË_li¡_v®ue
();

634 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

635 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

638 
TEST
(
TcbInfoFromJsÚTe¡
,

639 
TcbInfoJsÚW™hDu¶iÿ‹TcbsW™hDifã»ÁStu£sFasToP¬£
) {

640 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

641 
	ggoogË
::
´Ùobuf
::
Li¡V®ue
 *
tcb_Ëv–s
 = 
jsÚ
.
mubË_¡ruù_v®ue
()

642 ->
mubË_f›lds
()

643 ->
©
("tcbLevels")

644 .
mubË_li¡_v®ue
();

645 
	ggoogË
::
´Ùobuf
::
V®ue
 *
Ãw_Ëv–
 = 
tcb_Ëv–s
->
add_v®ues
();

646 *
	gÃw_Ëv–
 = 
tcb_Ëv–s
->
v®ues
(0);

647 
	gÃw_Ëv–
->
mubË_¡ruù_v®ue
()

648 ->
mubË_f›lds
()

649 ->
©
("status")

650 .
£t_¡ršg_v®ue
("OutOfDate");

651 
EXPECT_THAT
(
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)).
¡©us
(),

652 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

655 
TEST
(
TcbInfoFromJsÚTe¡
, 
CÜ»ùTcbInfoJsÚP¬£sSucûssfuÎy
) {

656 
cÚ¡ex´
 
	gkEx³ùedTcbInfoPrÙo
[] = 
R
"proto(

657 
im¶
 {

658 
v”siÚ
: 1

659 
issue_d©e
 { 
£cÚds
: 1582230020 
Çnos
: 0 }

660 
Ãxt_upd©e
: { 
£cÚds
: 1584735620 
Çnos
: 0 }

661 
fm¥c
 { 
v®ue
: "\x01\x23\x45\x67\x89\xab" }

662 
pû_id
 { 
v®ue
: 0 }

663 
tcb_Ëv–s
 {

664 
tcb
 {

665 
compÚ’ts
: "\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f"

666 
pû_svn
 { 
v®ue
: 2 }

668 
¡©us
 { 
known_¡©us
: 
UP_TO_DATE
 }

671 )
´Ùo
";

673 
TcbInfo
 
tcb_šfo
;

674 
ASYLO_ASSERT_OK_AND_ASSIGN
(

675 
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
C»©eV®idTcbInfoJsÚ
())));

676 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

678 
TcbInfo
 
	gex³ùed_tcb_šfo
;

679 
ASSERT_TRUE
(
googË
::
´Ùobuf
::
TextFÜm©
::
P¬£FromSŒšg
(
kEx³ùedTcbInfoPrÙo
,

680 &
ex³ùed_tcb_šfo
));

681 
EXPECT_THAT
(
tcb_šfo
, 
Equ®sPrÙo
(
ex³ùed_tcb_šfo
));

684 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hNÚZ”oPûIdP¬£sSucûssfuÎy
) {

685 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

686 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
©
("pûId").
£t_¡ršg_v®ue
(

689 
TcbInfo
 
	gtcb_šfo
;

690 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

691 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

692 
EXPECT_THAT
(
tcb_šfo
.
im¶
().
pû_id
().
v®ue
(), 
Eq
(0x0123));

695 
TEST
(
TcbInfoFromJsÚTe¡
,

696 
TcbLev–JsÚW™hDifã»ÁKnownStusV®uesP¬£SucûssfuÎy
) {

697 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kKnownStusSŒšgs
[] = {

699 
cÚ¡ex´
 
	gTcbStus
::
StusTy³
 
kKnownStusV®ues
[] = {

700 
TcbStus
::
UP_TO_DATE
, TcbStus::
CONFIGURATION_NEEDED
,

701 
TcbStus
::
OUT_OF_DATE
, TcbStus::
REVOKED
};

703 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

704 
TcbInfo
 
	gtcb_šfo
;

706 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
kKnownStusV®ues
); ++i) {

707 
	gjsÚ
.
mubË_¡ruù_v®ue
()

708 ->
mubË_f›lds
()

709 ->
©
("tcbLevels")

710 .
mubË_li¡_v®ue
()

711 ->
mubË_v®ues
(0)

712 ->
mubË_¡ruù_v®ue
()

713 ->
mubË_f›lds
()

714 ->
©
("status")

715 .
£t_¡ršg_v®ue
(
kKnownStusSŒšgs
[
i
].
d©a
(),

716 
kKnownStusSŒšgs
[
i
].
size
());

718 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

719 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

720 cÚ¡ 
	gTcbStus
 &
	gtcb_¡©us
 = 
tcb_šfo
.
im¶
().
tcb_Ëv–s
(0).
¡©us
();

721 
ASSERT_THAT
(
tcb_¡©us
.
v®ue_ÿ£
(), 
Eq
(
TcbStus
::
kKnownStus
));

722 
EXPECT_THAT
(
tcb_¡©us
.
known_¡©us
(), 
Eq
(
kKnownStusV®ues
[
i
]));

726 
TEST
(
TcbInfoFromJsÚTe¡
,

727 
TcbLev–JsÚW™hR•—‹dTcbLev–sIsDedu¶iÿ‹dAndCau£sLogW¬nšg
) {

728 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

729 
	ggoogË
::
´Ùobuf
::
Li¡V®ue
 *
tcb_Ëv–s
 = 
jsÚ
.
mubË_¡ruù_v®ue
()

730 ->
mubË_f›lds
()

731 ->
©
("tcbLevels")

732 .
mubË_li¡_v®ue
();

733 *
	gtcb_Ëv–s
->
add_v®ues
(èğ
tcb_Ëv–s
->
v®ues
(0);

735 
TcbInfo
 
	gtcb_šfo
;

736 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

737 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

738 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

739 
EXPECT_THAT
(
tcb_šfo
.
im¶
().
tcb_Ëv–s
(), 
SizeIs
(1));

740 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

741 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

744 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbInfoJsÚW™hExŒaF›ldsCau£sLogW¬nšg
) {

745 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

746 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

747 
	gv®ue
.
£t_numb”_v®ue
(0.);

748 
	gjsÚ
.
mubË_¡ruù_v®ue
()->
mubË_f›lds
()->
š£¹
({"v”yExŒa", 
v®ue
});

750 
TcbInfo
 
	gtcb_šfo
;

751 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

752 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

753 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

754 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

755 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

758 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbLev–JsÚW™hExŒaF›ldsCau£sLogW¬nšg
) {

759 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

760 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

761 
	gv®ue
.
£t_numb”_v®ue
(0.);

762 
	gjsÚ
.
mubË_¡ruù_v®ue
()

763 ->
mubË_f›lds
()

764 ->
©
("tcbLevels")

765 .
mubË_li¡_v®ue
()

766 ->
mubË_v®ues
(0)

767 ->
mubË_¡ruù_v®ue
()

768 ->
mubË_f›lds
()

769 ->
š£¹
({"v”yExŒa", 
v®ue
});

771 
TcbInfo
 
	gtcb_šfo
;

772 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

773 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

774 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

775 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

776 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

779 
TEST
(
TcbInfoFromJsÚTe¡
, 
TcbJsÚW™hExŒaF›ldsCau£sLogW¬nšg
) {

780 
	ggoogË
::
´Ùobuf
::
V®ue
 
jsÚ
 = 
C»©eV®idTcbInfoJsÚ
();

781 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

782 
	gv®ue
.
£t_numb”_v®ue
(0.);

783 
	gjsÚ
.
mubË_¡ruù_v®ue
()

784 ->
mubË_f›lds
()

785 ->
©
("tcbLevels")

786 .
mubË_li¡_v®ue
()

787 ->
mubË_v®ues
(0)

788 ->
mubË_¡ruù_v®ue
()

789 ->
mubË_f›lds
()

790 ->
©
("tcb")

791 .
mubË_¡ruù_v®ue
()

792 ->
mubË_f›lds
()

793 ->
š£¹
({"v”yExŒa", 
v®ue
});

795 
TcbInfo
 
	gtcb_šfo
;

796 
OuutCŞËùÜ
 
w¬nšg_cŞËùÜ
(
kCŞËùStdout
);

797 
ASYLO_ASSERT_OK_AND_ASSIGN
(
tcb_šfo
, 
TcbInfoFromJsÚ
(
JsÚToSŒšg
(
jsÚ
)));

798 
ASYLO_ASSERT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

799 
EXPECT_THAT
(
w¬nšg_cŞËùÜ
.
CŞËùOuutSoF¬
(),

800 
IsOkAndHŞds
(
CÚšsRegex
(
kLogW¬nšgRegex
)));

	@identity/sgx/tcb_test.cc

19 
	~"asylo/id’t™y/sgx/tcb.h
"

21 
	~<tu¶e
>

23 
	~"googË/´Ùobuf/time¡amp.pb.h
"

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/ba£/maüos.h
"

26 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
	~"ab¦/time/şock.h
"

28 
	~"ab¦/time/time.h
"

29 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

30 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/¡©us.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gsgx
 {

36 
	gÇme¥aû
 {

38 
	gusšg
 ::
‹¡šg
::
Eq
;

41 
Tcb
 
C»©eV®idTcb
() {

42 
Tcb
 
	gtcb
;

43 
	gtcb
.
£t_compÚ’ts
("0123456789abcdef");

44 
	gtcb
.
mubË_pû_svn
()->
£t_v®ue
(7);

45  
	gtcb
;

49 
RawTcb
 
C»©eV®idRawTcb
() {

50 
RawTcb
 
	g¿w_tcb
;

51 
	g¿w_tcb
.
mubË_ıu_svn
()->
£t_v®ue
("0123456789abcdef");

52 
	g¿w_tcb
.
mubË_pû_svn
()->
£t_v®ue
(7);

53  
	g¿w_tcb
;

57 
TcbInfo
 
C»©eV®idTcbInfo
() {

58 
	gab¦
::
Time
 
now
 = 
ab¦
::
Now
();

59 
	gab¦
::
Time
 
Ï‹r
 = 
now
 + 
ab¦
::
Hours
(24 * 30);

61 
TcbInfo
 
	gtcb_šfo
;

62 
TcbInfoIm¶
 *
	gim¶
 = 
tcb_šfo
.
mubË_im¶
();

63 
	gim¶
->
£t_v”siÚ
(1);

65 
	ggoogË
::
´Ùobuf
::
Time¡amp
 *
issue_d©e
 = 
im¶
->
mubË_issue_d©e
();

66 
	gissue_d©e
->
£t_£cÚds
((
now
 - 
ab¦
::
UnixEpoch
()è/‡b¦::
SecÚds
(1));

67 
	gissue_d©e
->
£t_Çnos
(0);

69 
	ggoogË
::
´Ùobuf
::
Time¡amp
 *
Ãxt_upd©e
 = 
im¶
->
mubË_Ãxt_upd©e
();

70 
	gÃxt_upd©e
->
£t_£cÚds
((
Ï‹r
 - 
ab¦
::
UnixEpoch
()è/‡b¦::
SecÚds
(1));

71 
	gÃxt_upd©e
->
£t_Çnos
(0);

73 
	gim¶
->
mubË_fm¥c
()->
£t_v®ue
("abcdef");

74 
	gim¶
->
mubË_pû_id
()->
£t_v®ue
(0);

76 
TcbLev–
 *
	gtcb_Ëv–
 = 
im¶
->
add_tcb_Ëv–s
();

77 *
	gtcb_Ëv–
->
mubË_tcb
(èğ
C»©eV®idTcb
();

78 
	gtcb_Ëv–
->
mubË_¡©us
()->
£t_known_¡©us
(
TcbStus
::
UP_TO_DATE
);

80  
	gtcb_šfo
;

83 
TEST
(
TcbTe¡
, 
TcbW™houtCompÚ’tsF›ldIsInv®id
) {

84 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

85 
	gtcb
.
ş—r_compÚ’ts
();

86 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

89 
TEST
(
TcbTe¡
, 
TcbW™houtPûSvnF›ldIsInv®id
) {

90 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

91 
	gtcb
.
ş—r_pû_svn
();

92 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

95 
TEST
(
TcbTe¡
, 
TcbW™hCompÚ’tsF›ldOfBadL’gthIsInv®id
) {

96 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

97 
	gtcb
.
£t_compÚ’ts
("short");

98 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

100 
	gtcb
.
£t_compÚ’ts
("waaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaytoolong");

101 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

104 
TEST
(
TcbTe¡
, 
TcbW™hInv®idPûSvnF›ldIsInv®id
) {

105 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

106 
	gtcb
.
mubË_pû_svn
()->
ş—r_v®ue
();

107 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

110 
TEST
(
TcbTe¡
, 
V®idTcbIsV®id
) {

111 
ASYLO_EXPECT_OK
(
V®id©eTcb
(
C»©eV®idTcb
()));

114 
TEST
(
TcbTe¡
, 
RawTcbW™houtCpuSvnF›ldIsInv®id
) {

115 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

116 
	g¿w_tcb
.
ş—r_ıu_svn
();

117 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

118 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

121 
TEST
(
TcbTe¡
, 
RawTcbW™houtPûSvnF›ldIsInv®id
) {

122 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

123 
	g¿w_tcb
.
ş—r_pû_svn
();

124 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

125 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

128 
TEST
(
TcbTe¡
, 
RawTcbW™hInv®idCpuSvnF›ldIsInv®id
) {

129 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

130 
	g¿w_tcb
.
mubË_ıu_svn
()->
ş—r_v®ue
();

131 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

132 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

135 
TEST
(
TcbTe¡
, 
RawTcbW™hInv®idPûSvnF›ldIsInv®id
) {

136 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

137 
	g¿w_tcb
.
mubË_pû_svn
()->
ş—r_v®ue
();

138 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

139 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

142 
TEST
(
TcbTe¡
, 
V®idRawTcbIsV®id
) {

143 
ASYLO_EXPECT_OK
(
V®id©eRawTcb
(
C»©eV®idRawTcb
()));

146 
TEST
(
TcbTe¡
, 
TcbInfoW™houtV®ueV¬ŸÁIsInv®id
) {

147 
EXPECT_THAT
(
V®id©eTcbInfo
(
TcbInfo
()),

148 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

151 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtV”siÚF›ldIsInv®id
) {

152 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

153 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_v”siÚ
();

154 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

155 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

158 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtIssueD©eF›ldIsInv®id
) {

159 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

160 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_issue_d©e
();

161 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

162 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

165 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtNextUpd©eF›ldIsInv®id
) {

166 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

167 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_Ãxt_upd©e
();

168 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

169 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

172 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtFm¥cF›ldIsInv®id
) {

173 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

174 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_fm¥c
();

175 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

176 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

179 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtPûIdF›ldIsInv®id
) {

180 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

181 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_pû_id
();

182 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

183 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

186 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hUnknownV”siÚIsInv®id
) {

187 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

188 
	gtcb_šfo
.
mubË_im¶
()->
£t_v”siÚ
(12);

189 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

190 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

193 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idIssueD©eIsInv®id
) {

194 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

195 
	gtcb_šfo
.
mubË_im¶
()->
mubË_issue_d©e
()->
£t_£cÚds
(-100000000000);

196 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

197 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

200 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idNextUpd©eIsInv®id
) {

201 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

202 
	gtcb_šfo
.
mubË_im¶
()->
mubË_Ãxt_upd©e
()->
£t_£cÚds
(-100000000000);

203 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

204 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

207 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idFm¥cIsInv®id
) {

208 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

209 
	gtcb_šfo
.
mubË_im¶
()->
mubË_fm¥c
()->
ş—r_v®ue
();

210 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

211 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

214 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idPûIdIsInv®id
) {

215 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

216 
	gtcb_šfo
.
mubË_im¶
()->
mubË_pû_id
()->
ş—r_v®ue
();

217 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

218 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

221 
TEST
(
TcbTe¡
, 
TcbLev–W™houtTcbF›ldIsInv®id
) {

222 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

223 
	gtcb_šfo
.
mubË_im¶
()->
mubË_tcb_Ëv–s
(0)->
ş—r_tcb
();

224 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

225 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

228 
TEST
(
TcbTe¡
, 
TcbLev–W™houtStusF›ldIsInv®id
) {

229 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

230 
	gtcb_šfo
.
mubË_im¶
()->
mubË_tcb_Ëv–s
(0)->
ş—r_¡©us
();

231 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

232 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

235 
TEST
(
TcbTe¡
, 
TcbLev–W™hInv®idTcbIsInv®id
) {

236 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

237 
	gtcb_šfo
.
mubË_im¶
()

238 ->
mubË_tcb_Ëv–s
(0)

239 ->
mubË_tcb
()

240 ->
ş—r_pû_svn
();

241 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

242 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

245 
TEST
(
TcbTe¡
, 
TcbStusW™houtV®ueV¬ŸÁIsInv®id
) {

246 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

247 
	gtcb_šfo
.
mubË_im¶
()

248 ->
mubË_tcb_Ëv–s
(0)

249 ->
mubË_¡©us
()

250 ->
ş—r_v®ue
();

251 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

252 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

255 
TEST
(
TcbTe¡
, 
TcbStusW™hUnknownKnownStusV¬ŸÁIsInv®id
) {

256 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

257 
	gtcb_šfo
.
mubË_im¶
()

258 ->
mubË_tcb_Ëv–s
(0)

259 ->
mubË_¡©us
()

260 ->
£t_known_¡©us
(
TcbStus
::
INVALID
);

261 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

262 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

265 
TEST
(
TcbTe¡
,

266 
TcbInfoIm¶W™hMuÉËTcbLev–sW™hSameTcbButDifã»ÁStu£sIsInv®id
) {

267 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

268 *
	gtcb_šfo
.
mubË_im¶
()->
add_tcb_Ëv–s
(èğ
tcb_šfo
.
im¶
().
tcb_Ëv–s
(0);

269 
	gtcb_šfo
.
mubË_im¶
()

270 ->
mubË_tcb_Ëv–s
(1)

271 ->
mubË_¡©us
()

272 ->
£t_known_¡©us
(
TcbStus
::
OUT_OF_DATE
);

273 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

274 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

277 
TEST
(
TcbTe¡
, 
V®idTcbInfoIsV®id
) {

278 
ASYLO_EXPECT_OK
(
V®id©eTcbInfo
(
C»©eV®idTcbInfo
()));

281 
TEST
(
TcbTe¡
,

282 
TcbInfoIm¶W™hMuÉËTcbLev–sW™hSameTcbAnsSameStu£sIsV®id
) {

283 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

284 *
	gtcb_šfo
.
mubË_im¶
()->
add_tcb_Ëv–s
(èğ
tcb_šfo
.
im¶
().
tcb_Ëv–s
(0);

285 
ASYLO_EXPECT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

288 
TEST
(
TcbTe¡
, 
Com·»TcbsCom·»sArgum’tsCÜ»ùly
) {

289 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kBa£CompÚ’ts
 = "0123456789abcdef";

290 
cÚ¡ex´
 
	gkBa£PûSvn
 = 5;

292 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kLessCompÚ’ts
 = "0011223344556677";

293 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kEqu®CompÚ’ts
 = 
kBa£CompÚ’ts
;

294 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kG»©”CompÚ’ts
 = "8899aabbccddeeff";

295 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kIncom·¿bËCompÚ’ts
 = "fedcba9876543210";

297 
cÚ¡ex´
 
	gkLessPûSvn
 = 2;

298 
cÚ¡ex´
 
	gkEqu®PûSvn
 = 
kBa£PûSvn
;

299 
cÚ¡ex´
 
	gkG»©”PûSvn
 = 8;

301 cÚ¡ 
	g¡d
::
tu¶e
<
ab¦
::
¡ršg_v›w
, , 
	gP¬tŸlOrd”
> 
	g‹¡_ÿ£s
[12] = {

302 
¡d
::
make_tu¶e
(
kLessCompÚ’ts
, 
kLessPûSvn
, 
P¬tŸlOrd”
::
kLess
),

303 
¡d
::
make_tu¶e
(
kLessCompÚ’ts
, 
kEqu®PûSvn
, 
P¬tŸlOrd”
::
kLess
),

304 
¡d
::
make_tu¶e
(
kLessCompÚ’ts
, 
kG»©”PûSvn
,

305 
P¬tŸlOrd”
::
kIncom·¿bË
),

306 
¡d
::
make_tu¶e
(
kEqu®CompÚ’ts
, 
kLessPûSvn
, 
P¬tŸlOrd”
::
kLess
),

307 
¡d
::
make_tu¶e
(
kEqu®CompÚ’ts
, 
kEqu®PûSvn
, 
P¬tŸlOrd”
::
kEqu®
),

308 
¡d
::
make_tu¶e
(
kEqu®CompÚ’ts
, 
kG»©”PûSvn
, 
P¬tŸlOrd”
::
kG»©”
),

309 
¡d
::
make_tu¶e
(
kG»©”CompÚ’ts
, 
kLessPûSvn
,

310 
P¬tŸlOrd”
::
kIncom·¿bË
),

311 
¡d
::
make_tu¶e
(
kG»©”CompÚ’ts
, 
kEqu®PûSvn
, 
P¬tŸlOrd”
::
kG»©”
),

312 
¡d
::
make_tu¶e
(
kG»©”CompÚ’ts
, 
kG»©”PûSvn
,

313 
P¬tŸlOrd”
::
kG»©”
),

314 
¡d
::
make_tu¶e
(
kIncom·¿bËCompÚ’ts
, 
kLessPûSvn
,

315 
P¬tŸlOrd”
::
kIncom·¿bË
),

316 
¡d
::
make_tu¶e
(
kIncom·¿bËCompÚ’ts
, 
kEqu®PûSvn
,

317 
P¬tŸlOrd”
::
kIncom·¿bË
),

318 
¡d
::
make_tu¶e
(
kIncom·¿bËCompÚ’ts
, 
kG»©”PûSvn
,

319 
P¬tŸlOrd”
::
kIncom·¿bË
)};

321 
Tcb
 
	grhs
;

322 
	grhs
.
£t_compÚ’ts
(
kBa£CompÚ’ts
.
d©a
(), kBa£CompÚ’ts.
size
());

323 
	grhs
.
mubË_pû_svn
()->
£t_v®ue
(
kBa£PûSvn
);

324 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
‹¡_ÿ£s
); ++i) {

325 
Tcb
 
	glhs
;

326 
	gab¦
::
¡ršg_v›w
 
compÚ’ts
 = 
¡d
::
g‘
<0>(
‹¡_ÿ£s
[
i
]);

327 
	glhs
.
£t_compÚ’ts
(
compÚ’ts
.
d©a
(), compÚ’ts.
size
());

328 
	glhs
.
mubË_pû_svn
()->
£t_v®ue
(
¡d
::
g‘
<1>(
‹¡_ÿ£s
[
i
]));

329 
EXPECT_THAT
(
Com·»Tcbs
(
lhs
, 
rhs
), 
Eq
(
¡d
::
g‘
<2>(
‹¡_ÿ£s
[
i
])));

	@identity/sgx/tcb_test.cc

19 
	~"asylo/id’t™y/sgx/tcb.h
"

21 
	~<tu¶e
>

23 
	~"googË/´Ùobuf/time¡amp.pb.h
"

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/ba£/maüos.h
"

26 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
	~"ab¦/time/şock.h
"

28 
	~"ab¦/time/time.h
"

29 
	~"asylo/id’t™y/sgx/¶©fÜm_´ovisiÚšg.pb.h
"

30 
	~"asylo/id’t™y/sgx/tcb.pb.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/¡©us.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gsgx
 {

36 
	gÇme¥aû
 {

38 
	gusšg
 ::
‹¡šg
::
Eq
;

41 
Tcb
 
C»©eV®idTcb
() {

42 
Tcb
 
	gtcb
;

43 
	gtcb
.
£t_compÚ’ts
("0123456789abcdef");

44 
	gtcb
.
mubË_pû_svn
()->
£t_v®ue
(7);

45  
	gtcb
;

49 
RawTcb
 
C»©eV®idRawTcb
() {

50 
RawTcb
 
	g¿w_tcb
;

51 
	g¿w_tcb
.
mubË_ıu_svn
()->
£t_v®ue
("0123456789abcdef");

52 
	g¿w_tcb
.
mubË_pû_svn
()->
£t_v®ue
(7);

53  
	g¿w_tcb
;

57 
TcbInfo
 
C»©eV®idTcbInfo
() {

58 
	gab¦
::
Time
 
now
 = 
ab¦
::
Now
();

59 
	gab¦
::
Time
 
Ï‹r
 = 
now
 + 
ab¦
::
Hours
(24 * 30);

61 
TcbInfo
 
	gtcb_šfo
;

62 
TcbInfoIm¶
 *
	gim¶
 = 
tcb_šfo
.
mubË_im¶
();

63 
	gim¶
->
£t_v”siÚ
(1);

65 
	ggoogË
::
´Ùobuf
::
Time¡amp
 *
issue_d©e
 = 
im¶
->
mubË_issue_d©e
();

66 
	gissue_d©e
->
£t_£cÚds
((
now
 - 
ab¦
::
UnixEpoch
()è/‡b¦::
SecÚds
(1));

67 
	gissue_d©e
->
£t_Çnos
(0);

69 
	ggoogË
::
´Ùobuf
::
Time¡amp
 *
Ãxt_upd©e
 = 
im¶
->
mubË_Ãxt_upd©e
();

70 
	gÃxt_upd©e
->
£t_£cÚds
((
Ï‹r
 - 
ab¦
::
UnixEpoch
()è/‡b¦::
SecÚds
(1));

71 
	gÃxt_upd©e
->
£t_Çnos
(0);

73 
	gim¶
->
mubË_fm¥c
()->
£t_v®ue
("abcdef");

74 
	gim¶
->
mubË_pû_id
()->
£t_v®ue
(0);

76 
TcbLev–
 *
	gtcb_Ëv–
 = 
im¶
->
add_tcb_Ëv–s
();

77 *
	gtcb_Ëv–
->
mubË_tcb
(èğ
C»©eV®idTcb
();

78 
	gtcb_Ëv–
->
mubË_¡©us
()->
£t_known_¡©us
(
TcbStus
::
UP_TO_DATE
);

80  
	gtcb_šfo
;

83 
TEST
(
TcbTe¡
, 
TcbW™houtCompÚ’tsF›ldIsInv®id
) {

84 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

85 
	gtcb
.
ş—r_compÚ’ts
();

86 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

89 
TEST
(
TcbTe¡
, 
TcbW™houtPûSvnF›ldIsInv®id
) {

90 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

91 
	gtcb
.
ş—r_pû_svn
();

92 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

95 
TEST
(
TcbTe¡
, 
TcbW™hCompÚ’tsF›ldOfBadL’gthIsInv®id
) {

96 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

97 
	gtcb
.
£t_compÚ’ts
("short");

98 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

100 
	gtcb
.
£t_compÚ’ts
("waaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaytoolong");

101 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

104 
TEST
(
TcbTe¡
, 
TcbW™hInv®idPûSvnF›ldIsInv®id
) {

105 
Tcb
 
	gtcb
 = 
C»©eV®idTcb
();

106 
	gtcb
.
mubË_pû_svn
()->
ş—r_v®ue
();

107 
EXPECT_THAT
(
V®id©eTcb
(
tcb
), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

110 
TEST
(
TcbTe¡
, 
V®idTcbIsV®id
) {

111 
ASYLO_EXPECT_OK
(
V®id©eTcb
(
C»©eV®idTcb
()));

114 
TEST
(
TcbTe¡
, 
RawTcbW™houtCpuSvnF›ldIsInv®id
) {

115 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

116 
	g¿w_tcb
.
ş—r_ıu_svn
();

117 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

118 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

121 
TEST
(
TcbTe¡
, 
RawTcbW™houtPûSvnF›ldIsInv®id
) {

122 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

123 
	g¿w_tcb
.
ş—r_pû_svn
();

124 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

125 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

128 
TEST
(
TcbTe¡
, 
RawTcbW™hInv®idCpuSvnF›ldIsInv®id
) {

129 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

130 
	g¿w_tcb
.
mubË_ıu_svn
()->
ş—r_v®ue
();

131 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

132 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

135 
TEST
(
TcbTe¡
, 
RawTcbW™hInv®idPûSvnF›ldIsInv®id
) {

136 
RawTcb
 
	g¿w_tcb
 = 
C»©eV®idRawTcb
();

137 
	g¿w_tcb
.
mubË_pû_svn
()->
ş—r_v®ue
();

138 
EXPECT_THAT
(
V®id©eRawTcb
(
¿w_tcb
),

139 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

142 
TEST
(
TcbTe¡
, 
V®idRawTcbIsV®id
) {

143 
ASYLO_EXPECT_OK
(
V®id©eRawTcb
(
C»©eV®idRawTcb
()));

146 
TEST
(
TcbTe¡
, 
TcbInfoW™houtV®ueV¬ŸÁIsInv®id
) {

147 
EXPECT_THAT
(
V®id©eTcbInfo
(
TcbInfo
()),

148 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

151 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtV”siÚF›ldIsInv®id
) {

152 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

153 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_v”siÚ
();

154 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

155 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

158 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtIssueD©eF›ldIsInv®id
) {

159 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

160 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_issue_d©e
();

161 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

162 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

165 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtNextUpd©eF›ldIsInv®id
) {

166 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

167 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_Ãxt_upd©e
();

168 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

169 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

172 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtFm¥cF›ldIsInv®id
) {

173 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

174 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_fm¥c
();

175 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

176 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

179 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™houtPûIdF›ldIsInv®id
) {

180 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

181 
	gtcb_šfo
.
mubË_im¶
()->
ş—r_pû_id
();

182 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

183 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

186 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hUnknownV”siÚIsInv®id
) {

187 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

188 
	gtcb_šfo
.
mubË_im¶
()->
£t_v”siÚ
(12);

189 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

190 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

193 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idIssueD©eIsInv®id
) {

194 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

195 
	gtcb_šfo
.
mubË_im¶
()->
mubË_issue_d©e
()->
£t_£cÚds
(-100000000000);

196 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

197 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

200 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idNextUpd©eIsInv®id
) {

201 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

202 
	gtcb_šfo
.
mubË_im¶
()->
mubË_Ãxt_upd©e
()->
£t_£cÚds
(-100000000000);

203 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

204 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

207 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idFm¥cIsInv®id
) {

208 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

209 
	gtcb_šfo
.
mubË_im¶
()->
mubË_fm¥c
()->
ş—r_v®ue
();

210 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

211 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

214 
TEST
(
TcbTe¡
, 
TcbInfoIm¶W™hInv®idPûIdIsInv®id
) {

215 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

216 
	gtcb_šfo
.
mubË_im¶
()->
mubË_pû_id
()->
ş—r_v®ue
();

217 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

218 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

221 
TEST
(
TcbTe¡
, 
TcbLev–W™houtTcbF›ldIsInv®id
) {

222 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

223 
	gtcb_šfo
.
mubË_im¶
()->
mubË_tcb_Ëv–s
(0)->
ş—r_tcb
();

224 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

225 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

228 
TEST
(
TcbTe¡
, 
TcbLev–W™houtStusF›ldIsInv®id
) {

229 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

230 
	gtcb_šfo
.
mubË_im¶
()->
mubË_tcb_Ëv–s
(0)->
ş—r_¡©us
();

231 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

232 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

235 
TEST
(
TcbTe¡
, 
TcbLev–W™hInv®idTcbIsInv®id
) {

236 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

237 
	gtcb_šfo
.
mubË_im¶
()

238 ->
mubË_tcb_Ëv–s
(0)

239 ->
mubË_tcb
()

240 ->
ş—r_pû_svn
();

241 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

242 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

245 
TEST
(
TcbTe¡
, 
TcbStusW™houtV®ueV¬ŸÁIsInv®id
) {

246 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

247 
	gtcb_šfo
.
mubË_im¶
()

248 ->
mubË_tcb_Ëv–s
(0)

249 ->
mubË_¡©us
()

250 ->
ş—r_v®ue
();

251 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

252 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

255 
TEST
(
TcbTe¡
, 
TcbStusW™hUnknownKnownStusV¬ŸÁIsInv®id
) {

256 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

257 
	gtcb_šfo
.
mubË_im¶
()

258 ->
mubË_tcb_Ëv–s
(0)

259 ->
mubË_¡©us
()

260 ->
£t_known_¡©us
(
TcbStus
::
INVALID
);

261 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

262 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

265 
TEST
(
TcbTe¡
,

266 
TcbInfoIm¶W™hMuÉËTcbLev–sW™hSameTcbButDifã»ÁStu£sIsInv®id
) {

267 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

268 *
	gtcb_šfo
.
mubË_im¶
()->
add_tcb_Ëv–s
(èğ
tcb_šfo
.
im¶
().
tcb_Ëv–s
(0);

269 
	gtcb_šfo
.
mubË_im¶
()

270 ->
mubË_tcb_Ëv–s
(1)

271 ->
mubË_¡©us
()

272 ->
£t_known_¡©us
(
TcbStus
::
OUT_OF_DATE
);

273 
EXPECT_THAT
(
V®id©eTcbInfo
(
tcb_šfo
),

274 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

277 
TEST
(
TcbTe¡
, 
V®idTcbInfoIsV®id
) {

278 
ASYLO_EXPECT_OK
(
V®id©eTcbInfo
(
C»©eV®idTcbInfo
()));

281 
TEST
(
TcbTe¡
,

282 
TcbInfoIm¶W™hMuÉËTcbLev–sW™hSameTcbAnsSameStu£sIsV®id
) {

283 
TcbInfo
 
	gtcb_šfo
 = 
C»©eV®idTcbInfo
();

284 *
	gtcb_šfo
.
mubË_im¶
()->
add_tcb_Ëv–s
(èğ
tcb_šfo
.
im¶
().
tcb_Ëv–s
(0);

285 
ASYLO_EXPECT_OK
(
V®id©eTcbInfo
(
tcb_šfo
));

288 
TEST
(
TcbTe¡
, 
Com·»TcbsCom·»sArgum’tsCÜ»ùly
) {

289 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kBa£CompÚ’ts
 = "0123456789abcdef";

290 
cÚ¡ex´
 
	gkBa£PûSvn
 = 5;

292 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kLessCompÚ’ts
 = "0011223344556677";

293 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kEqu®CompÚ’ts
 = 
kBa£CompÚ’ts
;

294 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kG»©”CompÚ’ts
 = "8899aabbccddeeff";

295 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kIncom·¿bËCompÚ’ts
 = "fedcba9876543210";

297 
cÚ¡ex´
 
	gkLessPûSvn
 = 2;

298 
cÚ¡ex´
 
	gkEqu®PûSvn
 = 
kBa£PûSvn
;

299 
cÚ¡ex´
 
	gkG»©”PûSvn
 = 8;

301 cÚ¡ 
	g¡d
::
tu¶e
<
ab¦
::
¡ršg_v›w
, , 
	gP¬tŸlOrd”
> 
	g‹¡_ÿ£s
[12] = {

302 
¡d
::
make_tu¶e
(
kLessCompÚ’ts
, 
kLessPûSvn
, 
P¬tŸlOrd”
::
kLess
),

303 
¡d
::
make_tu¶e
(
kLessCompÚ’ts
, 
kEqu®PûSvn
, 
P¬tŸlOrd”
::
kLess
),

304 
¡d
::
make_tu¶e
(
kLessCompÚ’ts
, 
kG»©”PûSvn
,

305 
P¬tŸlOrd”
::
kIncom·¿bË
),

306 
¡d
::
make_tu¶e
(
kEqu®CompÚ’ts
, 
kLessPûSvn
, 
P¬tŸlOrd”
::
kLess
),

307 
¡d
::
make_tu¶e
(
kEqu®CompÚ’ts
, 
kEqu®PûSvn
, 
P¬tŸlOrd”
::
kEqu®
),

308 
¡d
::
make_tu¶e
(
kEqu®CompÚ’ts
, 
kG»©”PûSvn
, 
P¬tŸlOrd”
::
kG»©”
),

309 
¡d
::
make_tu¶e
(
kG»©”CompÚ’ts
, 
kLessPûSvn
,

310 
P¬tŸlOrd”
::
kIncom·¿bË
),

311 
¡d
::
make_tu¶e
(
kG»©”CompÚ’ts
, 
kEqu®PûSvn
, 
P¬tŸlOrd”
::
kG»©”
),

312 
¡d
::
make_tu¶e
(
kG»©”CompÚ’ts
, 
kG»©”PûSvn
,

313 
P¬tŸlOrd”
::
kG»©”
),

314 
¡d
::
make_tu¶e
(
kIncom·¿bËCompÚ’ts
, 
kLessPûSvn
,

315 
P¬tŸlOrd”
::
kIncom·¿bË
),

316 
¡d
::
make_tu¶e
(
kIncom·¿bËCompÚ’ts
, 
kEqu®PûSvn
,

317 
P¬tŸlOrd”
::
kIncom·¿bË
),

318 
¡d
::
make_tu¶e
(
kIncom·¿bËCompÚ’ts
, 
kG»©”PûSvn
,

319 
P¬tŸlOrd”
::
kIncom·¿bË
)};

321 
Tcb
 
	grhs
;

322 
	grhs
.
£t_compÚ’ts
(
kBa£CompÚ’ts
.
d©a
(), kBa£CompÚ’ts.
size
());

323 
	grhs
.
mubË_pû_svn
()->
£t_v®ue
(
kBa£PûSvn
);

324 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
‹¡_ÿ£s
); ++i) {

325 
Tcb
 
	glhs
;

326 
	gab¦
::
¡ršg_v›w
 
compÚ’ts
 = 
¡d
::
g‘
<0>(
‹¡_ÿ£s
[
i
]);

327 
	glhs
.
£t_compÚ’ts
(
compÚ’ts
.
d©a
(), compÚ’ts.
size
());

328 
	glhs
.
mubË_pû_svn
()->
£t_v®ue
(
¡d
::
g‘
<1>(
‹¡_ÿ£s
[
i
]));

329 
EXPECT_THAT
(
Com·»Tcbs
(
lhs
, 
rhs
), 
Eq
(
¡d
::
g‘
<2>(
‹¡_ÿ£s
[
i
])));

	@identity/sgx/verify_hardware_report_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

22 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

23 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

24 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

35 
TEST
(
V”ifyH¬dw¬eR•ÜtTe¡
, 
V”ifyH¬dw¬eR•ÜtSucûedsWh’T¬g‘IsS–f
) {

36 
AligÃdT¬g‘šfoPŒ
 
	grg‘šfo
;

37 
S‘T¬g‘šfoFromS–fId’t™y
(
rg‘šfo
.
g‘
());

39 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

40 
	g»pÜtd©a
->
	gd©a
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kR•Ütd©aSize
>>();

42 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

43 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

44 
ASYLO_ASSERT_OK
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
));

49 
TEST
(
V”ifyH¬dw¬eR•ÜtTe¡
, 
V”ifyH¬dw¬eR•ÜtFasWh’T¬g‘IsNÙS–f
) {

50 
AligÃdT¬g‘šfoPŒ
 
	grg‘šfo
;

51 *
	grg‘šfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

53 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

54 
	g»pÜtd©a
->
	gd©a
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kR•Ütd©aSize
>>();

56 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

57 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

58 
ASSERT_THAT
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
NÙ
(
IsOk
()));

	@identity/sgx/verify_hardware_report_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

22 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

23 
	~"asylo/id’t™y/sgx/h¬dw¬e_š‹rçû.h
"

24 
	~"asylo/id’t™y/sgx/id’t™y_key_mªagem’t_¡ruùs.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsgx
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

35 
TEST
(
V”ifyH¬dw¬eR•ÜtTe¡
, 
V”ifyH¬dw¬eR•ÜtSucûedsWh’T¬g‘IsS–f
) {

36 
AligÃdT¬g‘šfoPŒ
 
	grg‘šfo
;

37 
S‘T¬g‘šfoFromS–fId’t™y
(
rg‘šfo
.
g‘
());

39 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

40 
	g»pÜtd©a
->
	gd©a
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kR•Ütd©aSize
>>();

42 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

43 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

44 
ASYLO_ASSERT_OK
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
));

49 
TEST
(
V”ifyH¬dw¬eR•ÜtTe¡
, 
V”ifyH¬dw¬eR•ÜtFasWh’T¬g‘IsNÙS–f
) {

50 
AligÃdT¬g‘šfoPŒ
 
	grg‘šfo
;

51 *
	grg‘šfo
 = 
TrivŸlZ”oObjeù
<
T¬g‘šfo
>();

53 
AligÃdR•Ütd©aPŒ
 
	g»pÜtd©a
;

54 
	g»pÜtd©a
->
	gd©a
 = 
TrivŸlRªdomObjeù
<
Un§ãBy‹s
<
kR•Ütd©aSize
>>();

56 
AligÃdR•ÜtPŒ
 
	g»pÜt
;

57 
ASYLO_ASSERT_OK
(
G‘H¬dw¬eR•Üt
(*
rg‘šfo
, *
»pÜtd©a
, 
»pÜt
.
g‘
()));

58 
ASSERT_THAT
(
V”ifyH¬dw¬eR•Üt
(*
»pÜt
), 
NÙ
(
IsOk
()));

	@identity/test/mock_identity_expectation_matcher.h

19 #iâdeà
ASYLO_IDENTITY_TEST_MOCK_IDENTITY_EXPECTATION_MATCHER_H_


20 
	#ASYLO_IDENTITY_TEST_MOCK_IDENTITY_EXPECTATION_MATCHER_H_


	)

22 
	~<gmock/gmock.h
>

23 
	~"asylo/id’t™y/id’t™y.pb.h
"

24 
	~"asylo/id’t™y/id’t™y_ex³ù©iÚ_m©ch”.h
"

25 
	~"asylo/ut/¡©usÜ.h
"

27 
Çme¥aû
 
	gasylo
 {

29 şas 
	cMockId’t™yEx³ù©iÚM©ch”
 : 
public
 
Id’t™yEx³ù©iÚM©ch”
 {

30 
public
:

31 
MOCK_CONST_METHOD2
(

32 
M©ch
, 
StusOr
<
boŞ
>(cÚ¡ 
EnşaveId’t™y
 &
id’t™y
,

33 cÚ¡ 
EnşaveId’t™yEx³ù©iÚ
 &
ex³ù©iÚ
));

	@identity/util/aligned_object_ptr.h

19 #iâdeà
ASYLO_IDENTITY_UTIL_ALIGNED_OBJECT_PTR_H_


20 
	#ASYLO_IDENTITY_UTIL_ALIGNED_OBJECT_PTR_H_


	)

22 
	~<c¡dšt
>

23 
	~<c¡dlib
>

24 
	~<memÜy
>

25 
	~<ty³_Œa™s
>

26 
	~<veùÜ
>

28 
Çme¥aû
 
	gasylo
 {

36 
	g‹m¶©e
 <
şass
 
	gT
, 
size_t
 
	gAlign
>

37 şas 
	cAligÃdObjeùPŒ
 {

38 
	gpublic
:

39 
‹m¶©e
 <
ty³Çme
... 
Args
>

40 
ex¶ic™
 
AligÃdObjeùPŒ
(
Args
 &&... 
¬gs
)

41 : 
obj_±r_
{
nuÎ±r
}, 
	gbufãr_
{
	gnuÎ±r
} {

42 
¡©ic_as£¹
((
T
) < (1ULL << 62),

44 
¡©ic_as£¹
(
Align
 != 0, "Template…arameter Align must‚ot be zero.");

45 
¡©ic_as£¹
(!
¡d
::
is_¬¿y
<
T
>::
v®ue
,

47 
size_t
 
	g®loc_size
 = (
T
è+ 
Align
 - 1;

50 
	gbufãr_
.
»£t
(
Ãw
 
ušt8_t
[
®loc_size
]);

51 
ušt8_t
 *
	g®igÃd_addr
 = 
®ign
(
Align
, 
bufãr_
.
g‘
());

52 
	gobj_±r_
 = 
Ãw
 (
®igÃd_addr
è
T
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

55 
AligÃdObjeùPŒ
(AligÃdObjeùPŒ &&
rhs
)

56 : 
obj_±r_
{
rhs
.obj_±r_}, 
	gbufãr_
{
	g¡d
::
move
Ôhs.
bufãr_
)} {

57 
rhs
.
obj_±r_
 = 
nuÎ±r
;

60 ~
AligÃdObjeùPŒ
() {

61 ià(
	gobj_±r_
 !ğ
nuÎ±r
) {

62 
obj_±r_
->~
T
();

66 
	gAligÃdObjeùPŒ
 &
	gİ”©Ü
=(
AligÃdObjeùPŒ
 &&
rhs
) {

67 ià(
this
 =ğ&
rhs
) {

68  *
this
;

70 ià(
	gobj_±r_
 !ğ
nuÎ±r
) {

71 
obj_±r_
->~
T
();

73 
	gobj_±r_
 = 
rhs
.
obj_±r_
;

74 
	grhs
.
	gobj_±r_
 = 
nuÎ±r
;

75 
	gbufãr_
 = 
¡d
::
move
(
rhs
.
bufãr_
);

76  *
	gthis
;

81 
T
 *
g‘
(è{  
	gobj_±r_
; }

82 cÚ¡ 
T
 *
g‘
(ècÚ¡ {  
	gobj_±r_
; }

84 
T
 *
	gİ”©Ü
->(è{  
g‘
(); }

85 cÚ¡ 
T
 *
	gİ”©Ü
->(ècÚ¡ {  
g‘
(); }

86 
	gT
 &
	gİ”©Ü
*(è{  *
g‘
(); }

87 cÚ¡ 
	gT
 &
	gİ”©Ü
*(ècÚ¡ {  *
g‘
(); }

90 
ex¶ic™
 
İ”©Ü
 
boŞ
(ècÚ¡ {  
	gobj_±r_
 !ğ
nuÎ±r
; }

93 
boŞ
 
IsAligÃd
(cÚ¡ *
addr
) {

94  
	g»š‹½»t_ÿ¡
<
	gušŒ_t
>(
	gaddr
è% 
	gAlign
 == 0;

97 
	g´iv©e
:

99 
ušt8_t
 *
®ign
(
size_t
 
®ignm’t
, ušt8_ˆ*
addr
) {

100 
ušŒ_t
 
	gnum”ic_addr
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
addr
);

101 
ušt64_t
 
	goff£t
 = (
®ignm’t
 - (
num”ic_addr
 %‡lignment)) %‡lignment;

102  
	g»š‹½»t_ÿ¡
<
	gušt8_t
 *>(
	gnum”ic_addr
 + 
	goff£t
);

107 
T
 *
	gobj_±r_
;

110 
	g¡d
::
unique_±r
<
ušt8_t
[]> 
bufãr_
;

	@identity/util/aligned_object_ptr_test.cc

19 
	~"asylo/id’t™y/ut/®igÃd_objeù_±r.h
"

21 
	~<¡ršg
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/ba£/©Œibu‹s.h
"

25 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
	sTe¡SŒuù
 {

31 
ušt64_t
 
	ga
;

32 
ušt32_t
 
	gb
;

33 } 
	gABSL_ATTRIBUTE_PACKED
;

37 şas 
	cTe¡CÏss
 {

38 
	gpublic
:

39 
Te¡CÏss
(
ušt64_t
 
a
, 
ušt32_t
 
b
è: 
a_
{a}, 
	gb_
{
	gb
} {}

40 
Te¡CÏss
(è: 
a_
{0}, 
	gb_
{0} {}

42 
ušt64_t
 
g‘_a
(è{  
	ga_
; }

43 
ušt32_t
 
g‘_b
(è{  
	gb_
; }

45 
	g´iv©e
:

46 
ušt64_t
 
a_
;

47 
ušt32_t
 
	gb_
;

50 
cÚ¡ex´
 
ušt64_t
 
	gkAlignSizes
[] = {

56 şas 
	cAligÃdObjeùPŒTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

58 
	g‹m¶©e
 <
şass
 
	gT
, 
size_t
 
	gAlign
>

59 
CheckAlign
(cÚ¡ 
AligÃdObjeùPŒ
<
T
, 
Align
> &
t
) {

60 
ušŒ_t
 
	gaddr
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
t
.
g‘
());

61 
EXPECT_EQ
(
addr
 % 
Align
, 0);

62 
usšg
 
	gTmpTy³
 = 
AligÃdObjeùPŒ
<
T
, 
	gAlign
>;

63 
EXPECT_TRUE
(
TmpTy³
::
IsAligÃd
(
t
.
g‘
()));

67 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
Ušt64_tAlign
) {

68 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[0]> 
	gnum0
;

69 
EXPECT_TRUE
(
num0
);

70 
CheckAlign
(
num0
);

72 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[1]> 
	gnum1
;

73 
EXPECT_TRUE
(
num1
);

74 
CheckAlign
(
num1
);

76 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[2]> 
	gnum2
;

77 
EXPECT_TRUE
(
num2
);

78 
CheckAlign
(
num2
);

80 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[3]> 
	gnum3
;

81 
EXPECT_TRUE
(
num3
);

82 
CheckAlign
(
num3
);

84 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[4]> 
	gnum4
;

85 
EXPECT_TRUE
(
num4
);

86 
CheckAlign
(
num4
);

88 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[5]> 
	gnum5
;

89 
EXPECT_TRUE
(
num5
);

90 
CheckAlign
(
num5
);

92 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[6]> 
	gnum6
;

93 
EXPECT_TRUE
(
num6
);

94 
CheckAlign
(
num6
);

96 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[7]> 
	gnum7
;

97 
EXPECT_TRUE
(
num7
);

98 
CheckAlign
(
num7
);

103 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
SŒuùAlign
) {

104 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[0]> 
	gts0
;

105 
EXPECT_TRUE
(
ts0
);

106 
CheckAlign
(
ts0
);

108 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[1]> 
	gts1
;

109 
EXPECT_TRUE
(
ts1
);

110 
CheckAlign
(
ts1
);

112 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[2]> 
	gts2
;

113 
EXPECT_TRUE
(
ts2
);

114 
CheckAlign
(
ts2
);

116 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[3]> 
	gts3
;

117 
EXPECT_TRUE
(
ts3
);

118 
CheckAlign
(
ts3
);

120 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[4]> 
	gts4
;

121 
EXPECT_TRUE
(
ts4
);

122 
CheckAlign
(
ts4
);

124 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[5]> 
	gts5
;

125 
EXPECT_TRUE
(
ts5
);

126 
CheckAlign
(
ts5
);

128 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[6]> 
	gts6
;

129 
EXPECT_TRUE
(
ts6
);

130 
CheckAlign
(
ts6
);

132 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[7]> 
	gts7
;

133 
EXPECT_TRUE
(
ts7
);

134 
CheckAlign
(
ts7
);

142 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
CÏssAlign
) {

143 
Te¡SŒuù
 
	gs1
{1, 1}, 
	gs2
{2, 2}, 
	gs3
{3, 3};

145 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[0]>

146 
	gm­0
;

147 
EXPECT_TRUE
(
m­0
);

148 
EXPECT_TRUE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

149 
EXPECT_TRUE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

150 
EXPECT_TRUE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

151 
EXPECT_FALSE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

152 
CheckAlign
(
m­0
);

154 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[1]>

155 
	gm­1
;

156 
EXPECT_TRUE
(
m­1
);

157 
EXPECT_TRUE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

158 
EXPECT_TRUE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

159 
EXPECT_TRUE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

160 
EXPECT_FALSE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

161 
CheckAlign
(
m­1
);

163 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[2]>

164 
	gm­2
;

165 
EXPECT_TRUE
(
m­2
);

166 
EXPECT_TRUE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

167 
EXPECT_TRUE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

168 
EXPECT_TRUE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

169 
EXPECT_FALSE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

170 
CheckAlign
(
m­2
);

172 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[3]>

173 
	gm­3
;

174 
EXPECT_TRUE
(
m­3
);

175 
EXPECT_TRUE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

176 
EXPECT_TRUE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

177 
EXPECT_TRUE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

178 
EXPECT_FALSE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

179 
CheckAlign
(
m­3
);

181 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[4]>

182 
	gm­4
;

183 
EXPECT_TRUE
(
m­4
);

184 
EXPECT_TRUE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

185 
EXPECT_TRUE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

186 
EXPECT_TRUE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

187 
EXPECT_FALSE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

188 
CheckAlign
(
m­4
);

190 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[5]>

191 
	gm­5
;

192 
EXPECT_TRUE
(
m­5
);

193 
EXPECT_TRUE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

194 
EXPECT_TRUE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

195 
EXPECT_TRUE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

196 
EXPECT_FALSE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

197 
CheckAlign
(
m­5
);

199 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[6]>

200 
	gm­6
;

201 
EXPECT_TRUE
(
m­6
);

202 
EXPECT_TRUE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

203 
EXPECT_TRUE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

204 
EXPECT_TRUE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

205 
EXPECT_FALSE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

206 
CheckAlign
(
m­6
);

208 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[7]>

209 
	gm­7
;

210 
EXPECT_TRUE
(
m­7
);

211 
EXPECT_TRUE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

212 
EXPECT_TRUE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

213 
EXPECT_TRUE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

214 
EXPECT_FALSE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

215 
CheckAlign
(
m­7
);

219 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
CÚ¡ruùÜFÜw¬d
) {

220 
	gAligÃdObjeùPŒ
<
	gTe¡CÏss
, 
	gkAlignSizes
[5]> 
	gtc0
;

221 
EXPECT_TRUE
(
tc0
);

222 
EXPECT_EQ
(
tc0
->
g‘_a
(), 0);

223 
EXPECT_EQ
(
tc0
->
g‘_b
(), 0);

225 
	gAligÃdObjeùPŒ
<
	gTe¡CÏss
, 
	gkAlignSizes
[5]> 
tc1
(0xACEDFACEULL, 0xDEADBEEF);

226 
EXPECT_TRUE
(
tc1
);

227 
EXPECT_EQ
(
tc1
->
g‘_a
(), 0xACEDFACEULL);

228 
EXPECT_EQ
(
tc1
->
g‘_b
(), 0xDEADBEEF);

231 
	g‹m¶©e
 <
şass
 
	gT
, 
size_t
 
	gALIGN
>

232 
Te¡MoveAssign
(
AligÃdObjeùPŒ
<
T
, 
ALIGN
> *
t
) {

233 
	gAligÃdObjeùPŒ
<
	gT
, 
	gALIGN
> 
	g‰
;

234 
boŞ
 
	gtb
 = 
¡©ic_ÿ¡
<boŞ>(*
t
);

235 
	g‰
 = 
¡d
::
move
(*
t
);

236 
EXPECT_EQ
(
¡©ic_ÿ¡
<
boŞ
>(
‰
), 
tb
);

240 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
MoveAndAssign
) {

241 
Te¡SŒuù
 
	gs1
{1, 1}, 
	gs2
{2, 2}, 
	gs3
{3, 3};

242 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[5]>

243 
	gm­
;

244 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

245 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

246 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

247 
EXPECT_FALSE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

248 
Te¡MoveAssign
(&
m­
);

249 
EXPECT_FALSE
(
m­
);

253 
	g‹m¶©e
 <
şass
 
	gT
, 
size_t
 
	gAlign
>

254 
	gAligÃdObjeùPŒ
<
	gT
, 
	gAlign
> &&
MoveObjeù
(
AligÃdObjeùPŒ
<
T
, 
Align
> *
t
) {

255  
	g¡d
::
move
(*
t
);

259 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
S–fMoveAssign
) {

260 
Te¡SŒuù
 
	gs1
{1, 1}, 
	gs2
{2, 2}, 
	gs3
{3, 3};

261 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[5]>

262 
	gm­
;

263 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

264 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

265 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

266 
EXPECT_FALSE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

267 
	gm­
 = 
MoveObjeù
(&
m­
);

268 
EXPECT_TRUE
(
m­
);

269 
EXPECT_NE
(
m­
->
fšd
(
¡d
::
¡ršg
("s1")), m­->
’d
());

270 
EXPECT_NE
(
m­
->
fšd
(
¡d
::
¡ršg
("s2")), m­->
’d
());

271 
EXPECT_NE
(
m­
->
fšd
(
¡d
::
¡ršg
("s3")), m­->
’d
());

	@identity/util/aligned_object_ptr_test.cc

19 
	~"asylo/id’t™y/ut/®igÃd_objeù_±r.h
"

21 
	~<¡ršg
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/ba£/©Œibu‹s.h
"

25 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
	sTe¡SŒuù
 {

31 
ušt64_t
 
	ga
;

32 
ušt32_t
 
	gb
;

33 } 
	gABSL_ATTRIBUTE_PACKED
;

37 şas 
	cTe¡CÏss
 {

38 
	gpublic
:

39 
Te¡CÏss
(
ušt64_t
 
a
, 
ušt32_t
 
b
è: 
a_
{a}, 
	gb_
{
	gb
} {}

40 
Te¡CÏss
(è: 
a_
{0}, 
	gb_
{0} {}

42 
ušt64_t
 
g‘_a
(è{  
	ga_
; }

43 
ušt32_t
 
g‘_b
(è{  
	gb_
; }

45 
	g´iv©e
:

46 
ušt64_t
 
a_
;

47 
ušt32_t
 
	gb_
;

50 
cÚ¡ex´
 
ušt64_t
 
	gkAlignSizes
[] = {

56 şas 
	cAligÃdObjeùPŒTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

58 
	g‹m¶©e
 <
şass
 
	gT
, 
size_t
 
	gAlign
>

59 
CheckAlign
(cÚ¡ 
AligÃdObjeùPŒ
<
T
, 
Align
> &
t
) {

60 
ušŒ_t
 
	gaddr
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
t
.
g‘
());

61 
EXPECT_EQ
(
addr
 % 
Align
, 0);

62 
usšg
 
	gTmpTy³
 = 
AligÃdObjeùPŒ
<
T
, 
	gAlign
>;

63 
EXPECT_TRUE
(
TmpTy³
::
IsAligÃd
(
t
.
g‘
()));

67 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
Ušt64_tAlign
) {

68 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[0]> 
	gnum0
;

69 
EXPECT_TRUE
(
num0
);

70 
CheckAlign
(
num0
);

72 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[1]> 
	gnum1
;

73 
EXPECT_TRUE
(
num1
);

74 
CheckAlign
(
num1
);

76 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[2]> 
	gnum2
;

77 
EXPECT_TRUE
(
num2
);

78 
CheckAlign
(
num2
);

80 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[3]> 
	gnum3
;

81 
EXPECT_TRUE
(
num3
);

82 
CheckAlign
(
num3
);

84 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[4]> 
	gnum4
;

85 
EXPECT_TRUE
(
num4
);

86 
CheckAlign
(
num4
);

88 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[5]> 
	gnum5
;

89 
EXPECT_TRUE
(
num5
);

90 
CheckAlign
(
num5
);

92 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[6]> 
	gnum6
;

93 
EXPECT_TRUE
(
num6
);

94 
CheckAlign
(
num6
);

96 
	gAligÃdObjeùPŒ
<
	gušt64_t
, 
	gkAlignSizes
[7]> 
	gnum7
;

97 
EXPECT_TRUE
(
num7
);

98 
CheckAlign
(
num7
);

103 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
SŒuùAlign
) {

104 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[0]> 
	gts0
;

105 
EXPECT_TRUE
(
ts0
);

106 
CheckAlign
(
ts0
);

108 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[1]> 
	gts1
;

109 
EXPECT_TRUE
(
ts1
);

110 
CheckAlign
(
ts1
);

112 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[2]> 
	gts2
;

113 
EXPECT_TRUE
(
ts2
);

114 
CheckAlign
(
ts2
);

116 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[3]> 
	gts3
;

117 
EXPECT_TRUE
(
ts3
);

118 
CheckAlign
(
ts3
);

120 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[4]> 
	gts4
;

121 
EXPECT_TRUE
(
ts4
);

122 
CheckAlign
(
ts4
);

124 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[5]> 
	gts5
;

125 
EXPECT_TRUE
(
ts5
);

126 
CheckAlign
(
ts5
);

128 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[6]> 
	gts6
;

129 
EXPECT_TRUE
(
ts6
);

130 
CheckAlign
(
ts6
);

132 
	gAligÃdObjeùPŒ
<
	gTe¡SŒuù
, 
	gkAlignSizes
[7]> 
	gts7
;

133 
EXPECT_TRUE
(
ts7
);

134 
CheckAlign
(
ts7
);

142 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
CÏssAlign
) {

143 
Te¡SŒuù
 
	gs1
{1, 1}, 
	gs2
{2, 2}, 
	gs3
{3, 3};

145 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[0]>

146 
	gm­0
;

147 
EXPECT_TRUE
(
m­0
);

148 
EXPECT_TRUE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

149 
EXPECT_TRUE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

150 
EXPECT_TRUE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

151 
EXPECT_FALSE
(
m­0
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

152 
CheckAlign
(
m­0
);

154 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[1]>

155 
	gm­1
;

156 
EXPECT_TRUE
(
m­1
);

157 
EXPECT_TRUE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

158 
EXPECT_TRUE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

159 
EXPECT_TRUE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

160 
EXPECT_FALSE
(
m­1
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

161 
CheckAlign
(
m­1
);

163 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[2]>

164 
	gm­2
;

165 
EXPECT_TRUE
(
m­2
);

166 
EXPECT_TRUE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

167 
EXPECT_TRUE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

168 
EXPECT_TRUE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

169 
EXPECT_FALSE
(
m­2
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

170 
CheckAlign
(
m­2
);

172 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[3]>

173 
	gm­3
;

174 
EXPECT_TRUE
(
m­3
);

175 
EXPECT_TRUE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

176 
EXPECT_TRUE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

177 
EXPECT_TRUE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

178 
EXPECT_FALSE
(
m­3
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

179 
CheckAlign
(
m­3
);

181 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[4]>

182 
	gm­4
;

183 
EXPECT_TRUE
(
m­4
);

184 
EXPECT_TRUE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

185 
EXPECT_TRUE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

186 
EXPECT_TRUE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

187 
EXPECT_FALSE
(
m­4
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

188 
CheckAlign
(
m­4
);

190 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[5]>

191 
	gm­5
;

192 
EXPECT_TRUE
(
m­5
);

193 
EXPECT_TRUE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

194 
EXPECT_TRUE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

195 
EXPECT_TRUE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

196 
EXPECT_FALSE
(
m­5
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

197 
CheckAlign
(
m­5
);

199 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[6]>

200 
	gm­6
;

201 
EXPECT_TRUE
(
m­6
);

202 
EXPECT_TRUE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

203 
EXPECT_TRUE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

204 
EXPECT_TRUE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

205 
EXPECT_FALSE
(
m­6
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

206 
CheckAlign
(
m­6
);

208 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[7]>

209 
	gm­7
;

210 
EXPECT_TRUE
(
m­7
);

211 
EXPECT_TRUE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

212 
EXPECT_TRUE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

213 
EXPECT_TRUE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

214 
EXPECT_FALSE
(
m­7
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

215 
CheckAlign
(
m­7
);

219 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
CÚ¡ruùÜFÜw¬d
) {

220 
	gAligÃdObjeùPŒ
<
	gTe¡CÏss
, 
	gkAlignSizes
[5]> 
	gtc0
;

221 
EXPECT_TRUE
(
tc0
);

222 
EXPECT_EQ
(
tc0
->
g‘_a
(), 0);

223 
EXPECT_EQ
(
tc0
->
g‘_b
(), 0);

225 
	gAligÃdObjeùPŒ
<
	gTe¡CÏss
, 
	gkAlignSizes
[5]> 
tc1
(0xACEDFACEULL, 0xDEADBEEF);

226 
EXPECT_TRUE
(
tc1
);

227 
EXPECT_EQ
(
tc1
->
g‘_a
(), 0xACEDFACEULL);

228 
EXPECT_EQ
(
tc1
->
g‘_b
(), 0xDEADBEEF);

231 
	g‹m¶©e
 <
şass
 
	gT
, 
size_t
 
	gALIGN
>

232 
Te¡MoveAssign
(
AligÃdObjeùPŒ
<
T
, 
ALIGN
> *
t
) {

233 
	gAligÃdObjeùPŒ
<
	gT
, 
	gALIGN
> 
	g‰
;

234 
boŞ
 
	gtb
 = 
¡©ic_ÿ¡
<boŞ>(*
t
);

235 
	g‰
 = 
¡d
::
move
(*
t
);

236 
EXPECT_EQ
(
¡©ic_ÿ¡
<
boŞ
>(
‰
), 
tb
);

240 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
MoveAndAssign
) {

241 
Te¡SŒuù
 
	gs1
{1, 1}, 
	gs2
{2, 2}, 
	gs3
{3, 3};

242 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[5]>

243 
	gm­
;

244 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

245 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

246 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

247 
EXPECT_FALSE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

248 
Te¡MoveAssign
(&
m­
);

249 
EXPECT_FALSE
(
m­
);

253 
	g‹m¶©e
 <
şass
 
	gT
, 
size_t
 
	gAlign
>

254 
	gAligÃdObjeùPŒ
<
	gT
, 
	gAlign
> &&
MoveObjeù
(
AligÃdObjeùPŒ
<
T
, 
Align
> *
t
) {

255  
	g¡d
::
move
(*
t
);

259 
TEST_F
(
AligÃdObjeùPŒTe¡
, 
S–fMoveAssign
) {

260 
Te¡SŒuù
 
	gs1
{1, 1}, 
	gs2
{2, 2}, 
	gs3
{3, 3};

261 
	gAligÃdObjeùPŒ
<
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gTe¡SŒuù
>, 
	gkAlignSizes
[5]>

262 
	gm­
;

263 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s1"), 
s1
).
£cÚd
);

264 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s2"), 
s2
).
£cÚd
);

265 
EXPECT_TRUE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

266 
EXPECT_FALSE
(
m­
->
em¶aû
(
¡d
::
¡ršg
("s3"), 
s3
).
£cÚd
);

267 
	gm­
 = 
MoveObjeù
(&
m­
);

268 
EXPECT_TRUE
(
m­
);

269 
EXPECT_NE
(
m­
->
fšd
(
¡d
::
¡ršg
("s1")), m­->
’d
());

270 
EXPECT_NE
(
m­
->
fšd
(
¡d
::
¡ršg
("s2")), m­->
’d
());

271 
EXPECT_NE
(
m­
->
fšd
(
¡d
::
¡ršg
("s3")), m­->
’d
());

	@identity/util/sha256_hash_util.cc

19 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

21 
	~<¡ršg
>

23 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

24 
	~"ab¦/¡ršgs/esÿpšg.h
"

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

27 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
boŞ
 
Sha256HashFromHexSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
hex
, 
Sha256HashPrÙo
 *
h
) {

32 
	gUn§ãBy‹s
<
	gkSha256Size
> 
	gby‹s
;

34 ià(!
S‘TrivŸlObjeùFromHexSŒšg
(
hex
, &
by‹s
).
ok
()) {

35  
	gçl£
;

38 
	gh
->
£t_hash
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
by‹s
.
d©a
()), by‹s.
size
());

39  
	gŒue
;

42 
Sha256HashToHexSŒšg
(cÚ¡ 
Sha256HashPrÙo
 &
h
, 
¡d
::
¡ršg
 *
¡r
) {

43 *
¡r
 = 
ab¦
::
By‹sToHexSŒšg
(
h
.
hash
());

46 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Sha256HashPrÙo
 &
lhs
, cÚ¡ 
	gSha256HashPrÙo
 &
	grhs
) {

47  ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
lhs
, 
rhs
);

50 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Sha256HashPrÙo
 &
lhs
, cÚ¡ 
	gSha256HashPrÙo
 &
	grhs
) {

51  !(
	glhs
 =ğ
rhs
);

	@identity/util/sha256_hash_util.cc

19 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

21 
	~<¡ršg
>

23 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

24 
	~"ab¦/¡ršgs/esÿpšg.h
"

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

27 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
boŞ
 
Sha256HashFromHexSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
hex
, 
Sha256HashPrÙo
 *
h
) {

32 
	gUn§ãBy‹s
<
	gkSha256Size
> 
	gby‹s
;

34 ià(!
S‘TrivŸlObjeùFromHexSŒšg
(
hex
, &
by‹s
).
ok
()) {

35  
	gçl£
;

38 
	gh
->
£t_hash
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
by‹s
.
d©a
()), by‹s.
size
());

39  
	gŒue
;

42 
Sha256HashToHexSŒšg
(cÚ¡ 
Sha256HashPrÙo
 &
h
, 
¡d
::
¡ršg
 *
¡r
) {

43 *
¡r
 = 
ab¦
::
By‹sToHexSŒšg
(
h
.
hash
());

46 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Sha256HashPrÙo
 &
lhs
, cÚ¡ 
	gSha256HashPrÙo
 &
	grhs
) {

47  ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
(
lhs
, 
rhs
);

50 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Sha256HashPrÙo
 &
lhs
, cÚ¡ 
	gSha256HashPrÙo
 &
	grhs
) {

51  !(
	glhs
 =ğ
rhs
);

	@identity/util/sha256_hash_util.h

19 #iâdeà
ASYLO_IDENTITY_UTIL_SHA256_HASH_UTIL_H_


20 
	#ASYLO_IDENTITY_UTIL_SHA256_HASH_UTIL_H_


	)

22 
	~<c¡dšt
>

23 
	~<¡ršg
>

25 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
cÚ¡ex´
 
ušt32_t
 
	gkSha256Size
 = 32;

32 
boŞ
 
Sha256HashFromHexSŒšg
(cÚ¡ 
¡d
::
¡ršg
 &
hex
, 
Sha256HashPrÙo
 *
h
);

35 
Sha256HashToHexSŒšg
(cÚ¡ 
Sha256HashPrÙo
 &
h
, 
¡d
::
¡ršg
 *
¡r
);

38 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Sha256HashPrÙo
 &
lhs
, cÚ¡ 
	gSha256HashPrÙo
 &
	grhs
);

41 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Sha256HashPrÙo
 &
lhs
, cÚ¡ 
	gSha256HashPrÙo
 &
	grhs
);

	@identity/util/sha256_hash_util_test.cc

19 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
cÚ¡ex´
 
	gkHashBš1
[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,

34 
cÚ¡ex´
 
	gkHashBš2
[] = {0x0a, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,

38 
cÚ¡ex´
 
	gkHashHex1
[] =

40 
cÚ¡ex´
 
	gkHashHexShÜt
[] =

45 şas 
	cSha256HashUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

46 
´Ùeùed
:

47 
Sha256HashUtTe¡
() {}

50 
TEST_F
(
Sha256HashUtTe¡
, 
SucûssfulCÚv”siÚFromHexSŒšg
) {

51 
Sha256HashPrÙo
 
	gh
;

53 
EXPECT_TRUE
(
Sha256HashFromHexSŒšg
(
kHashHex1
, &
h
));

54 
EXPECT_EQ
(
h
.
hash
(), 
¡d
::
¡ršg
(
kHashBš1
, (kHashBin1)));

57 
TEST_F
(
Sha256HashUtTe¡
, 
UnsucûssfulCÚv”siÚFromHexSŒšg
) {

58 
Sha256HashPrÙo
 
	gh
;

60 
EXPECT_FALSE
(
Sha256HashFromHexSŒšg
(
kHashHexShÜt
, &
h
));

63 
TEST_F
(
Sha256HashUtTe¡
, 
CÚv”siÚToHexSŒšg
) {

64 
Sha256HashPrÙo
 
	gh
;

65 
	gh
.
£t_hash
(
kHashBš1
, (kHashBin1));

66 
	g¡d
::
¡ršg
 
¡r
;

68 
Sha256HashToHexSŒšg
(
h
, &
¡r
);

69 
EXPECT_EQ
(
¡r
, 
¡d
::
¡ršg
(
kHashHex1
));

72 
TEST_F
(
Sha256HashUtTe¡
, 
Equ®™yO³¿tÜPos™ive
) {

73 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

74 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

75 
	gh2
.
£t_hash
(
kHashBš1
, (kHashBin1));

77 
EXPECT_TRUE
(
h1
 =ğ
h2
);

80 
TEST_F
(
Sha256HashUtTe¡
, 
Equ®™yO³¿tÜNeg©ive
) {

81 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

82 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

83 
	gh2
.
£t_hash
(
kHashBš2
, (kHashBin2));

85 
EXPECT_FALSE
(
h1
 =ğ
h2
);

88 
TEST_F
(
Sha256HashUtTe¡
, 
IÃqu®™yO³¿tÜNeg©ive
) {

89 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

90 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

91 
	gh2
.
£t_hash
(
kHashBš1
, (kHashBin1));

93 
EXPECT_FALSE
(
h1
 !ğ
h2
);

96 
TEST_F
(
Sha256HashUtTe¡
, 
IÃqu®™yO³¿tÜPos™ive
) {

97 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

98 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

99 
	gh2
.
£t_hash
(
kHashBš2
, (kHashBin2));

101 
EXPECT_TRUE
(
h1
 !ğ
h2
);

	@identity/util/sha256_hash_util_test.cc

19 
	~"asylo/id’t™y/ut/sha256_hash_ut.h
"

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/id’t™y/ut/sha256_hash.pb.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
cÚ¡ex´
 
	gkHashBš1
[] = {0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,

34 
cÚ¡ex´
 
	gkHashBš2
[] = {0x0a, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,

38 
cÚ¡ex´
 
	gkHashHex1
[] =

40 
cÚ¡ex´
 
	gkHashHexShÜt
[] =

45 şas 
	cSha256HashUtTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

46 
´Ùeùed
:

47 
Sha256HashUtTe¡
() {}

50 
TEST_F
(
Sha256HashUtTe¡
, 
SucûssfulCÚv”siÚFromHexSŒšg
) {

51 
Sha256HashPrÙo
 
	gh
;

53 
EXPECT_TRUE
(
Sha256HashFromHexSŒšg
(
kHashHex1
, &
h
));

54 
EXPECT_EQ
(
h
.
hash
(), 
¡d
::
¡ršg
(
kHashBš1
, (kHashBin1)));

57 
TEST_F
(
Sha256HashUtTe¡
, 
UnsucûssfulCÚv”siÚFromHexSŒšg
) {

58 
Sha256HashPrÙo
 
	gh
;

60 
EXPECT_FALSE
(
Sha256HashFromHexSŒšg
(
kHashHexShÜt
, &
h
));

63 
TEST_F
(
Sha256HashUtTe¡
, 
CÚv”siÚToHexSŒšg
) {

64 
Sha256HashPrÙo
 
	gh
;

65 
	gh
.
£t_hash
(
kHashBš1
, (kHashBin1));

66 
	g¡d
::
¡ršg
 
¡r
;

68 
Sha256HashToHexSŒšg
(
h
, &
¡r
);

69 
EXPECT_EQ
(
¡r
, 
¡d
::
¡ršg
(
kHashHex1
));

72 
TEST_F
(
Sha256HashUtTe¡
, 
Equ®™yO³¿tÜPos™ive
) {

73 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

74 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

75 
	gh2
.
£t_hash
(
kHashBš1
, (kHashBin1));

77 
EXPECT_TRUE
(
h1
 =ğ
h2
);

80 
TEST_F
(
Sha256HashUtTe¡
, 
Equ®™yO³¿tÜNeg©ive
) {

81 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

82 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

83 
	gh2
.
£t_hash
(
kHashBš2
, (kHashBin2));

85 
EXPECT_FALSE
(
h1
 =ğ
h2
);

88 
TEST_F
(
Sha256HashUtTe¡
, 
IÃqu®™yO³¿tÜNeg©ive
) {

89 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

90 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

91 
	gh2
.
£t_hash
(
kHashBš1
, (kHashBin1));

93 
EXPECT_FALSE
(
h1
 !ğ
h2
);

96 
TEST_F
(
Sha256HashUtTe¡
, 
IÃqu®™yO³¿tÜPos™ive
) {

97 
Sha256HashPrÙo
 
	gh1
, 
	gh2
;

98 
	gh1
.
£t_hash
(
kHashBš1
, (kHashBin1));

99 
	gh2
.
£t_hash
(
kHashBš2
, (kHashBin2));

101 
EXPECT_TRUE
(
h1
 !ğ
h2
);

	@platform/arch/common/trusted/fork.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

21 
	~<¡dlib.h
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
pid_t
 
’c_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

29  
’c_uÁru¡ed_fÜk
(
’şave_Çme
, 
nuÎ±r
, 0,

30  
çl£
);

33 
boŞ
 
IsSecu»FÜkSuµÜ‹d
(è{  
	gçl£
; }

35 
Stus
 
TakeSÇpshÙFÜFÜk
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
) {

37 
abÜt
();

40 
Stus
 
Re¡ÜeFÜFÜk
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
) {

42 
abÜt
();

45 
Stus
 
T¿nsãrSecu»SÇpshÙKey
(

46 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
) {

48 
abÜt
();

51 
SaveTh»adLayoutFÜSÇpshÙ
() {

53 
abÜt
();

56 
S‘FÜkReque¡ed
() {

58 
abÜt
();

	@platform/arch/common/trusted/fork.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

21 
	~<¡dlib.h
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
pid_t
 
’c_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

29  
’c_uÁru¡ed_fÜk
(
’şave_Çme
, 
nuÎ±r
, 0,

30  
çl£
);

33 
boŞ
 
IsSecu»FÜkSuµÜ‹d
(è{  
	gçl£
; }

35 
Stus
 
TakeSÇpshÙFÜFÜk
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
) {

37 
abÜt
();

40 
Stus
 
Re¡ÜeFÜFÜk
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
) {

42 
abÜt
();

45 
Stus
 
T¿nsãrSecu»SÇpshÙKey
(

46 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
) {

48 
abÜt
();

51 
SaveTh»adLayoutFÜSÇpshÙ
() {

53 
abÜt
();

56 
S‘FÜkReque¡ed
() {

58 
abÜt
();

	@platform/arch/include/trusted/fork.h

19 #iâdeà
ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_FORK_H_


20 
	#ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_FORK_H_


	)

22 
	~<sys/ty³s.h
>

24 
	~"asylo/’şave.pb.h
"

25 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

30 
pid_t
 
’c_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ 
EnşaveCÚfig
 &
cÚfig
);

33 
boŞ
 
IsSecu»FÜkSuµÜ‹d
();

37 
Stus
 
TakeSÇpshÙFÜFÜk
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
);

44 
Stus
 
Re¡ÜeFÜFÜk
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
);

48 
Stus
 
T¿nsãrSecu»SÇpshÙKey
(

49 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
);

54 
SaveTh»adLayoutFÜSÇpshÙ
();

57 
S‘FÜkReque¡ed
();

	@platform/arch/include/trusted/hardware_random.h

19 #iâdeà
ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_HARDWARE_RANDOM_H_


20 
	#ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_HARDWARE_RANDOM_H_


	)

22 
	~<¡dšt.h
>

23 
	~<sys/ty³s.h
>

25 #ifdeà
__ılu¥lus


29 
ssize_t
 
’c_h¬dw¬e_¿ndom
(
ušt8_t
 *
buf
, 
size_t
 
couÁ
);

31 #ifdeà
__ılu¥lus


	@platform/arch/include/trusted/host_calls.h

19 #iâdeà
ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_HOST_CALLS_H_


20 
	#ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_HOST_CALLS_H_


	)

26 
	~<¬·/š‘.h
>

27 
	~<içddrs.h
>

28 
	~<pŞl.h
>

29 
	~<pwd.h
>

30 
	~<sched.h
>

31 
	~<¡ddef.h
>

32 
	~<¡dšt.h
>

33 
	~<sys/sock‘.h
>

34 
	~<sys/ty³s.h
>

35 
	~<sys/ut¢ame.h
>

36 
	~<time.h
>

37 
	~<uni¡d.h
>

39 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme_kšd.h
"

41 #ifdeà
__ılu¥lus


56 *
’c_uÁru¡ed_m®loc
(
size_t
 
size
);

59 *
’c_uÁru¡ed_»®loc
(*
±r
, 
size_t
 
size
);

62 
’c_uÁru¡ed_ä“
(*
±r
);

66 **
’c_uÁru¡ed_®loÿ‹_bufãrs
(

67 
size_t
 
couÁ
, size_ˆ
size
);

71 
’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(**
ä“_li¡
, 
size_t
 
couÁ
);

78 
’c_uÁru¡ed_g‘_”ºo
();

84 
’c_uÁru¡ed_İ’
(cÚ¡ *
·th_Çme
, 
æags
, ...);

85 
’c_uÁru¡ed_şo£
(
fd
);

86 
ssize_t
 
’c_uÁru¡ed_»ad
(
fd
, *
buf
, 
size_t
 
Ën
);

87 
ssize_t
 
’c_uÁru¡ed_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
);

88 
’c_uÁru¡ed_puts
(cÚ¡ *
¡r
);

89 
off_t
 
’c_uÁru¡ed_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
);

90 
’c_uÁru¡ed_uÆšk
(cÚ¡ *
·th_Çme
);

91 
’c_uÁru¡ed_fú
(
fd
, 
cmd
, ...);

92 
’c_uÁru¡ed_fsync
(
fd
);

93 
’c_uÁru¡ed_acûss
(cÚ¡ *
·th_Çme
, 
mode
);

94 
’c_uÁru¡ed_chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
);

95 
’c_uÁru¡ed_lšk
(cÚ¡ *
äom
, cÚ¡ *
to
);

96 
’c_uÁru¡ed_»Çme
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
);

97 
ssize_t
 
’c_uÁru¡ed_»adlšk
(cÚ¡ *
·th
, *
buf
, 
size_t
 
bufsize
);

98 
’c_uÁru¡ed_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
);

99 
’c_uÁru¡ed_l¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
);

100 
’c_uÁru¡ed_symlšk
(cÚ¡ *
äom
, cÚ¡ *
to
);

101 
’c_uÁru¡ed_f¡©
(
fd
, 
¡©
 *
¡©_bufãr
);

102 
’c_uÁru¡ed_i§‰y
(
fe
);

103 
ssize_t
 
’c_uÁru¡ed_wr™ev
(
fd
, *
buf
, 
size
);

104 
ssize_t
 
’c_uÁru¡ed_»adv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
,

105 *
buf
, 
size
);

111 
’c_uÁru¡ed_acû±
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

112 
’c_uÁru¡ed_bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

113 
sockËn_t
 
add¾’
);

114 
’c_uÁru¡ed_cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

115 
sockËn_t
 
add¾’
);

116 
’c_uÁru¡ed_li¡’
(
sockfd
, 
backlog
);

117 
’c_uÁru¡ed_£tsockİt
(
sock‘
, 
Ëv–
, 
İtiÚ_Çme
,

118 cÚ¡ *
İtiÚ_v®ue
, 
sockËn_t
 
İtiÚ_Ën
);

119 
’c_uÁru¡ed_shutdown
(
sockfd
, 
how
);

120 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

121 cÚ¡ *
’c_uÁru¡ed_š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
,

122 
sockËn_t
 
size
);

123 
’c_uÁru¡ed_š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

124 
ssize_t
 
’c_uÁru¡ed_£nd
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
);

125 
ssize_t
 
’c_uÁru¡ed_£ndmsg
(

126 
sockfd
, cÚ¡ 
bridge_msghdr
 *
bridge_msg
, 
æags
);

127 
ssize_t
 
’c_uÁru¡ed_»cvmsg
(
sockfd
, 
msghdr
 *
msg
,

128 
bridge_msghdr
 *
bridge_msg
, 
æags
);

129 
’c_uÁru¡ed_g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

130 cÚ¡ 
addršfo
 *
hšts
,

131 
addršfo
 **
»s
);

132 
’c_uÁru¡ed_ä“addršfo
(
addršfo
 *
»s
);

133 
’c_uÁru¡ed_g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

134 
sockËn_t
 *
İ’
);

135 
’c_uÁru¡ed_g‘sockÇme
(
sockfd
, 
sockaddr
 *
addr
,

136 
sockËn_t
 *
add¾’
);

137 
’c_uÁru¡ed_g‘³”Çme
(
sockfd
, 
sockaddr
 *
addr
,

138 
sockËn_t
 *
add¾’
);

139 
ssize_t
 
’c_uÁru¡ed_»cväom
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
,

140 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
);

148 
’c_uÁru¡ed_ü—‹_th»ad
(cÚ¡ *
Çme
);

153 
’c_uÁru¡ed_sys_fu‹x_wa™
(
št32_t
 *
fu‹x
, iÁ32_ˆ
ex³ùed
);

156 
’c_uÁru¡ed_sys_fu‹x_wake
(
št32_t
 *
fu‹x
);

162 
’c_uÁru¡ed_pŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
);

168 
’c_uÁru¡ed_•Şl_ü—‹
(
size
);

169 
’c_uÁru¡ed_•Şl_ùl
(
•fd
, 
İ
, 
fd
,

170 
•Şl_ev’t
 *
ev’t
);

171 
’c_uÁru¡ed_•Şl_wa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
,

172 
maxev’ts
, 
timeout
);

178 
’c_uÁru¡ed_šÙify_š™1
(
nÚ_block
);

179 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
,

180 
ušt32_t
 
mask
);

181 
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
);

182 
’c_uÁru¡ed_šÙify_»ad
(
fd
, 
size_t
 
couÁ
, **
£rŸlized_ev’ts
,

183 
size_t
 *
£rŸlized_ev’ts_Ën
);

189 
’c_uÁru¡ed_g‘içddrs
(
içddrs
 **
içp
);

190 
’c_uÁru¡ed_ä“içddrs
(
içddrs
 *
iç
);

196 
·sswd
 *
’c_uÁru¡ed_g‘pwuid
(
uid_t
 
uid
);

204 
’c_uÁru¡ed_sched_g‘affš™y
(
pid_t
 
pid
, 
size_t
 
ıu£tsize
,

205 
ıu_£t_t
 *
mask
);

206 
’c_uÁru¡ed_sched_y›ld
();

212 
’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

213 
signum
,

214 (*
bridge_sigaùiÚ
)(, 
bridge_sigšfo_t
 *, *),

215 cÚ¡ 
sig£t_t
 
mask
, 
æags
, cÚ¡ *
’şave_Çme
);

217 
’c_uÁru¡ed_sig´ocmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
);

219 
’c_uÁru¡ed_¿i£
(
sig
);

225 
’c_uÁru¡ed_g‘ru§ge
(
who
, 
ru§ge
 *
u§ge
);

231 
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
);

237 
’c_uÁru¡ed_£Ëù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
,

238 
fd_£t
 *
exû±fds
, 
timev®
 *
timeout
);

244 
’c_uÁru¡ed_mkdœ
(cÚ¡ *
·th
, 
mode
);

245 
mode_t
 
’c_uÁru¡ed_umask
(mode_ˆ
mask
);

246 
’c_uÁru¡ed_chmod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
);

247 
’c_uÁru¡ed_fchmod
(
fd
, 
mode_t
 
mode
);

253 
’c_uÁru¡ed_İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
);

254 
’c_uÁru¡ed_sy¦og
(
´iÜ™y
, cÚ¡ *
mes§ge
);

260 
’c_uÁru¡ed_uÇme
(
ut¢ame
 *
ut¢ame_buf
);

266 
’c_uÁru¡ed_Çno¦“p
(cÚ¡ 
time¥ec
 *
»q
, time¥eø*
»m
);

267 
’c_uÁru¡ed_g‘timeofday
(
timev®
 *
tv
, *
tz
);

268 
’c_uÁru¡ed_times
(
tms
 *
buf
);

269 
’c_uÁru¡ed_şock_g‘time
(
şockid_t
 
şk_id
, 
time¥ec
 *

);

270 
’c_uÁru¡ed_g‘™im”
(
which
, 
™im”v®
 *
cu¼_v®ue
);

271 
’c_uÁru¡ed_£t™im”
(
which
, cÚ¡ 
™im”v®
 *
Ãw_v®ue
,

272 
™im”v®
 *
Şd_v®ue
);

278 
’c_uÁru¡ed_fchown
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
);

279 
’c_uÁru¡ed_pe2
(
pefd
[2], 
æags
);

280 
št64_t
 
’c_uÁru¡ed_syscÚf
(
Çme
);

281 
ušt32_t
 
’c_uÁru¡ed_¦“p
(ušt32_ˆ
£cÚds
);

282 
’c_uÁru¡ed_u¦“p
(
u£cÚds_t
 
u£c
);

283 
uid_t
 
’c_uÁru¡ed_g‘uid
();

284 
uid_t
 
’c_uÁru¡ed_g‘euid
();

285 
gid_t
 
’c_uÁru¡ed_g‘gid
();

286 
gid_t
 
’c_uÁru¡ed_g‘egid
();

287 
pid_t
 
’c_uÁru¡ed_g‘pid
();

288 
pid_t
 
’c_uÁru¡ed_g‘µid
();

289 
pid_t
 
’c_uÁru¡ed_£tsid
();

290 
’c_uÁru¡ed_rmdœ
(cÚ¡ *
·thÇme
);

291 
’c_uÁru¡ed_Œunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
);

292 
’c_uÁru¡ed_árunÿ‹
(
fd
, 
off_t
 
Ëngth
);

293 
’c_uÁru¡ed__ex™
(
rc
);

294 
pid_t
 
’c_uÁru¡ed_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ *
cÚfig
,

295 
size_t
 
cÚfig_Ën
, 
boŞ
 
»¡Üe_¢­shÙ
);

301 
’c_uÁru¡ed_utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
);

302 
’c_uÁru¡ed_utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]);

308 
’c_uÁru¡ed_wa™
(*
w¡©us
);

309 
pid_t
 
’c_uÁru¡ed_wa™3
(*
w¡©us
, 
İtiÚs
, 
ru§ge
 *
u§ge
);

310 
pid_t
 
’c_uÁru¡ed_wa™pid
Õid_ˆ
pid
, *
w¡©us
, 
İtiÚs
);

320 *
’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

321 cÚ¡ *
Çme
);

326 
’c_uÁru¡ed_»Ëa£_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

327 cÚ¡ *
Çme
);

334 
’c_uÁru¡ed_hex_dump
(cÚ¡ *
buf
, 
nby‹s
);

336 #ifdeà
__ılu¥lus


	@platform/arch/include/trusted/register_signal.h

19 #iâdeà
ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_REGISTER_SIGNAL_H_


20 
	#ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_REGISTER_SIGNAL_H_


	)

22 
	~<sigÇl.h
>

23 
	~<¡ddef.h
>

25 #ifdeà
__ılu¥lus


31 
’c_»gi¡”_sigÇl
(
signum
, cÚ¡ 
sig£t_t
 
mask
, 
æags
,

32 cÚ¡ *
’şave_Çme
);

34 #ifdeà
__ılu¥lus


	@platform/arch/include/trusted/time.h

19 #iâdeà
ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_TIME_H_


20 
	#ASYLO_PLATFORM_ARCH_INCLUDE_TRUSTED_TIME_H_


	)

22 #ifdeà
__ılu¥lus


29 
g‘_time_v›w
();

33 
g‘_mÚÙime_v›w
();

35 #ifdeà
__ılu¥lus


	@platform/arch/sgx/trusted/ecalls.cc

22 
	~<û¼no
>

23 
	~<c¡ršg
>

24 
	~<¡ršg
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/’şave.pb.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

30 
	~"asylo/¶©fÜm/¬ch/sgx/Œu¡ed/g’”©ed_bridge_t.h
"

31 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

32 
	~"asylo/¶©fÜm/cÜe/’Œy_pošts.h
"

33 
	~"asylo/¶©fÜm/´im™ives/sgx/Œu¡ed_sgx.h
"

34 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

35 
	~"asylo/ut/¡©us.h
"

36 
	~"šşude/sgx_Œts.h
"

45 
	$eÿÎ_hªdË_sigÇl
(cÚ¡ *
šput
, 
bridge_size_t
 
šput_Ën
) {

46 
»suÉ
 = 0;

47 
Œy
 {

48 
»suÉ
 =

49 
asylo
::
	`__asylo_hªdË_sigÇl
(
šput
, 
¡©ic_ÿ¡
<
size_t
>(
šput_Ën
));

50 } 
	`ÿtch
 (...) {

54 
	`abÜt
();

56  
»suÉ
;

57 
	}
}

61 
	$eÿÎ_ke_¢­shÙ
(**
ouut
, 
bridge_size_t
 *
ouut_Ën
) {

62 
»suÉ
 = 0;

63 
size_t
 
tmp_ouut_Ën
 = 0;

64 
Œy
 {

65 
»suÉ
 =

66 
asylo
::
	`__asylo_ke_¢­shÙ
(
ouut
, &
tmp_ouut_Ën
);

67 } 
	`ÿtch
 (...) {

68 
	`LOG
(
FATAL
) << "Uncaughtƒxception inƒnclave";

71 ià(
ouut_Ën
) {

72 *
ouut_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
tmp_ouut_Ën
);

74  
»suÉ
;

75 
	}
}

79 
	$eÿÎ_»¡Üe
(cÚ¡ *
šput
, 
bridge_size_t
 
šput_Ën
, **
ouut
,

80 
bridge_size_t
 *
ouut_Ën
) {

81 
»suÉ
 = 0;

82 
size_t
 
tmp_ouut_Ën
 = 0;

83 
Œy
 {

84 
»suÉ
 = 
asylo
::
	`__asylo_»¡Üe
(
šput
, 
¡©ic_ÿ¡
<
size_t
>(
šput_Ën
),

85 
ouut
, &
tmp_ouut_Ën
);

86 } 
	`ÿtch
 (...) {

87 
	`LOG
(
FATAL
) << "Uncaughtƒxception inƒnclave";

90 ià(
ouut_Ën
) {

91 *
ouut_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
tmp_ouut_Ën
);

93  
»suÉ
;

94 
	}
}

98 
	$eÿÎ_Œªsãr_£cu»_¢­shÙ_key
(cÚ¡ *
šput
,

99 
bridge_size_t
 
šput_Ën
, **
ouut
,

100 
bridge_size_t
 *
ouut_Ën
) {

101 
»suÉ
 = 0;

102 
bridge_size_t
 
bridge_ouut_Ën
;

103 
Œy
 {

104 
»suÉ
 = 
asylo
::
	`__asylo_Œªsãr_£cu»_¢­shÙ_key
(

105 
šput
, 
¡©ic_ÿ¡
<
size_t
>(
šput_Ën
), 
ouut
, &
bridge_ouut_Ën
);

106 } 
	`ÿtch
 (...) {

107 
	`LOG
(
FATAL
) << "Uncaughtƒxception inƒnclave";

109 ià(
ouut_Ën
) {

110 *
ouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

112  
»suÉ
;

113 
	}
}

117 
	$eÿÎ_di¥©ch_Œu¡ed_ÿÎ
(
ušt64_t
 
£ËùÜ
, *
bufãr
) {

118  
asylo
::
´im™ives
::
	`asylo_’şave_ÿÎ
(
£ËùÜ
, 
bufãr
);

119 
	}
}

	@platform/arch/sgx/trusted/ecalls.cc

22 
	~<û¼no
>

23 
	~<c¡ršg
>

24 
	~<¡ršg
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/’şave.pb.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

30 
	~"asylo/¶©fÜm/¬ch/sgx/Œu¡ed/g’”©ed_bridge_t.h
"

31 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

32 
	~"asylo/¶©fÜm/cÜe/’Œy_pošts.h
"

33 
	~"asylo/¶©fÜm/´im™ives/sgx/Œu¡ed_sgx.h
"

34 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

35 
	~"asylo/ut/¡©us.h
"

36 
	~"šşude/sgx_Œts.h
"

45 
	$eÿÎ_hªdË_sigÇl
(cÚ¡ *
šput
, 
bridge_size_t
 
šput_Ën
) {

46 
»suÉ
 = 0;

47 
Œy
 {

48 
»suÉ
 =

49 
asylo
::
	`__asylo_hªdË_sigÇl
(
šput
, 
¡©ic_ÿ¡
<
size_t
>(
šput_Ën
));

50 } 
	`ÿtch
 (...) {

54 
	`abÜt
();

56  
»suÉ
;

57 
	}
}

61 
	$eÿÎ_ke_¢­shÙ
(**
ouut
, 
bridge_size_t
 *
ouut_Ën
) {

62 
»suÉ
 = 0;

63 
size_t
 
tmp_ouut_Ën
 = 0;

64 
Œy
 {

65 
»suÉ
 =

66 
asylo
::
	`__asylo_ke_¢­shÙ
(
ouut
, &
tmp_ouut_Ën
);

67 } 
	`ÿtch
 (...) {

68 
	`LOG
(
FATAL
) << "Uncaughtƒxception inƒnclave";

71 ià(
ouut_Ën
) {

72 *
ouut_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
tmp_ouut_Ën
);

74  
»suÉ
;

75 
	}
}

79 
	$eÿÎ_»¡Üe
(cÚ¡ *
šput
, 
bridge_size_t
 
šput_Ën
, **
ouut
,

80 
bridge_size_t
 *
ouut_Ën
) {

81 
»suÉ
 = 0;

82 
size_t
 
tmp_ouut_Ën
 = 0;

83 
Œy
 {

84 
»suÉ
 = 
asylo
::
	`__asylo_»¡Üe
(
šput
, 
¡©ic_ÿ¡
<
size_t
>(
šput_Ën
),

85 
ouut
, &
tmp_ouut_Ën
);

86 } 
	`ÿtch
 (...) {

87 
	`LOG
(
FATAL
) << "Uncaughtƒxception inƒnclave";

90 ià(
ouut_Ën
) {

91 *
ouut_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
tmp_ouut_Ën
);

93  
»suÉ
;

94 
	}
}

98 
	$eÿÎ_Œªsãr_£cu»_¢­shÙ_key
(cÚ¡ *
šput
,

99 
bridge_size_t
 
šput_Ën
, **
ouut
,

100 
bridge_size_t
 *
ouut_Ën
) {

101 
»suÉ
 = 0;

102 
bridge_size_t
 
bridge_ouut_Ën
;

103 
Œy
 {

104 
»suÉ
 = 
asylo
::
	`__asylo_Œªsãr_£cu»_¢­shÙ_key
(

105 
šput
, 
¡©ic_ÿ¡
<
size_t
>(
šput_Ën
), 
ouut
, &
bridge_ouut_Ën
);

106 } 
	`ÿtch
 (...) {

107 
	`LOG
(
FATAL
) << "Uncaughtƒxception inƒnclave";

109 ià(
ouut_Ën
) {

110 *
ouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

112  
»suÉ
;

113 
	}
}

117 
	$eÿÎ_di¥©ch_Œu¡ed_ÿÎ
(
ušt64_t
 
£ËùÜ
, *
bufãr
) {

118  
asylo
::
´im™ives
::
	`asylo_’şave_ÿÎ
(
£ËùÜ
, 
bufãr
);

119 
	}
}

	@platform/arch/sgx/trusted/enclave_syscalls.cc

19 
	~<’şave/’şave_sysÿÎs.h
>

21 
	~<¡dlib.h
>

22 
	~<sys/¡©.h
>

23 
	~<sys/time.h
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

41 
’şave_execve
(*
Çme
, **
¬gv
, **
’v
è{ 
abÜt
(); }

43 
’şave_kl
(
pid
, 
sig
è{ 
abÜt
(); }

	@platform/arch/sgx/trusted/enclave_syscalls.cc

19 
	~<’şave/’şave_sysÿÎs.h
>

21 
	~<¡dlib.h
>

22 
	~<sys/¡©.h
>

23 
	~<sys/time.h
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

41 
’şave_execve
(*
Çme
, **
¬gv
, **
’v
è{ 
abÜt
(); }

43 
’şave_kl
(
pid
, 
sig
è{ 
abÜt
(); }

	@platform/arch/sgx/trusted/exceptions.cc

19 
	~<¡dlib.h
>

21 
	~"šşude/sgx_ıuid.h
"

22 
	~"šşude/sgx_Œts_exû±iÚ.h
"

24 
	gÇme¥aû
 {

27 
cÚ¡ex´
 
ušt16_t
 
	gkCpuidOpcode
 = 0xA20F;

28 
cÚ¡ex´
 
ušt16_t
 
	gkRdtscOpcode
 = 0x310F;

36 
cÚ¡ex´
 
	gkMaxSuµÜ‹dCpuidL—f
 = 7;

37 
cÚ¡ex´
 
	gkSuµÜ‹dCpuidL—ves
[] = {0, 1, 4, 7};

40 
	sCpuidResuÉ
 {

42 
	eCpuidRegi¡”s
 { 
	gEAX
 = 0, 
	gEBX
 = 1, 
	gECX
 = 2, 
	gEDX
 = 3 };

45 
	g»g
[4];

46 
boŞ
 
	gÿched
;

48 
CpuidResuÉ
 
	gıuid_»suÉs
[
kMaxSuµÜ‹dCpuidL—f
 + 1];

52 
š™Ÿlize_ıuid_»suÉs
() {

54 
	gi
 = 0; i < 
	gkMaxSuµÜ‹dCpuidL—f
; ++i) {

55 
	gıuid_»suÉs
[
i
].
	gÿched
 = 
çl£
;

59 
	gi
 : 
kSuµÜ‹dCpuidL—ves
) {

61 ià(
sgx_ıuid
(
ıuid_»suÉs
[
i
].
»g
, iè!ğ
SGX_SUCCESS
è
abÜt
();

62 
	gıuid_»suÉs
[
i
].
	gÿched
 = 
Œue
;

69 
hªdË_ıuid_exû±iÚ
(
sgx_exû±iÚ_šfo_t
 *
šfo
) {

71 
ušt16_t
 
	gİcode
 = *
»š‹½»t_ÿ¡
<ušt16_ˆ*>(
šfo
->
ıu_cÚ‹xt
.
r
);

76 ià(
	gšfo
->
	gexû±iÚ_veùÜ
 !ğ
SGX_EXCEPTION_VECTOR_UD
 ||

77 
šfo
->
exû±iÚ_ty³
 !ğ
SGX_EXCEPTION_HARDWARE
 ||

78 
İcode
 !ğ
kCpuidOpcode
) {

79  
EXCEPTION_CONTINUE_SEARCH
;

83 
ušt64_t
 
	gËaf
 = 
šfo
->
ıu_cÚ‹xt
.
¿x
;

84 ià(
	gËaf
 > 
	gkMaxSuµÜ‹dCpuidL—f
 || !
	gıuid_»suÉs
[
Ëaf
].
	gÿched
) {

85  
	gEXCEPTION_CONTINUE_SEARCH
;

91 
ušt64_t
 
	gsubËaf
 = 
šfo
->
ıu_cÚ‹xt
.
rcx
;

92 ià(
	gËaf
 !ğ0 && 
Ëaf
 !ğ1 && 
subËaf
 !ğ0è 
EXCEPTION_CONTINUE_SEARCH
;

95 
	gšfo
->
	gıu_cÚ‹xt
.
	g¿x
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
EAX
];

96 
	gšfo
->
	gıu_cÚ‹xt
.
	grbx
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
EBX
];

97 
	gšfo
->
	gıu_cÚ‹xt
.
	grcx
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
ECX
];

98 
	gšfo
->
	gıu_cÚ‹xt
.
	grdx
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
EDX
];

103 
	gšfo
->
	gıu_cÚ‹xt
.
	gr
 += 2;

105  
	gEXCEPTION_CONTINUE_EXECUTION
;

110 
hªdË_rdtsc_exû±iÚ
(
sgx_exû±iÚ_šfo_t
 *
šfo
) {

112 
ušt16_t
 
	gİcode
 = *
»š‹½»t_ÿ¡
<ušt16_ˆ*>(
šfo
->
ıu_cÚ‹xt
.
r
);

117 ià(
	gšfo
->
	gexû±iÚ_veùÜ
 !ğ
SGX_EXCEPTION_VECTOR_UD
 ||

118 
šfo
->
exû±iÚ_ty³
 !ğ
SGX_EXCEPTION_HARDWARE
 ||

119 
İcode
 !ğ
kRdtscOpcode
) {

120  
EXCEPTION_CONTINUE_SEARCH
;

124 
ušt64_t
 
	gÏ¡_rdtsc
 = 0;

125 
	gÏ¡_rdtsc
++;

128 
	gšfo
->
	gıu_cÚ‹xt
.
	g¿x
 = 
Ï¡_rdtsc
 & 0xFFFFFFFF;

129 
	gšfo
->
	gıu_cÚ‹xt
.
	grdx
 = 
Ï¡_rdtsc
 >> 32;

134 
	gšfo
->
	gıu_cÚ‹xt
.
	gr
 += 2;

136  
	gEXCEPTION_CONTINUE_EXECUTION
;

142 
»gi¡”_exû±iÚ_hªdËrs
(è
__©Œibu‹__
((
cÚ¡ruùÜ
(101)));

143 
»gi¡”_exû±iÚ_hªdËrs
() {

144 
š™Ÿlize_ıuid_»suÉs
();

145 
sgx_»gi¡”_exû±iÚ_hªdËr
(
Œue
, 
hªdË_ıuid_exû±iÚ
);

146 
sgx_»gi¡”_exû±iÚ_hªdËr
(
Œue
, 
hªdË_rdtsc_exû±iÚ
);

	@platform/arch/sgx/trusted/exceptions.cc

19 
	~<¡dlib.h
>

21 
	~"šşude/sgx_ıuid.h
"

22 
	~"šşude/sgx_Œts_exû±iÚ.h
"

24 
	gÇme¥aû
 {

27 
cÚ¡ex´
 
ušt16_t
 
	gkCpuidOpcode
 = 0xA20F;

28 
cÚ¡ex´
 
ušt16_t
 
	gkRdtscOpcode
 = 0x310F;

36 
cÚ¡ex´
 
	gkMaxSuµÜ‹dCpuidL—f
 = 7;

37 
cÚ¡ex´
 
	gkSuµÜ‹dCpuidL—ves
[] = {0, 1, 4, 7};

40 
	sCpuidResuÉ
 {

42 
	eCpuidRegi¡”s
 { 
	gEAX
 = 0, 
	gEBX
 = 1, 
	gECX
 = 2, 
	gEDX
 = 3 };

45 
	g»g
[4];

46 
boŞ
 
	gÿched
;

48 
CpuidResuÉ
 
	gıuid_»suÉs
[
kMaxSuµÜ‹dCpuidL—f
 + 1];

52 
š™Ÿlize_ıuid_»suÉs
() {

54 
	gi
 = 0; i < 
	gkMaxSuµÜ‹dCpuidL—f
; ++i) {

55 
	gıuid_»suÉs
[
i
].
	gÿched
 = 
çl£
;

59 
	gi
 : 
kSuµÜ‹dCpuidL—ves
) {

61 ià(
sgx_ıuid
(
ıuid_»suÉs
[
i
].
»g
, iè!ğ
SGX_SUCCESS
è
abÜt
();

62 
	gıuid_»suÉs
[
i
].
	gÿched
 = 
Œue
;

69 
hªdË_ıuid_exû±iÚ
(
sgx_exû±iÚ_šfo_t
 *
šfo
) {

71 
ušt16_t
 
	gİcode
 = *
»š‹½»t_ÿ¡
<ušt16_ˆ*>(
šfo
->
ıu_cÚ‹xt
.
r
);

76 ià(
	gšfo
->
	gexû±iÚ_veùÜ
 !ğ
SGX_EXCEPTION_VECTOR_UD
 ||

77 
šfo
->
exû±iÚ_ty³
 !ğ
SGX_EXCEPTION_HARDWARE
 ||

78 
İcode
 !ğ
kCpuidOpcode
) {

79  
EXCEPTION_CONTINUE_SEARCH
;

83 
ušt64_t
 
	gËaf
 = 
šfo
->
ıu_cÚ‹xt
.
¿x
;

84 ià(
	gËaf
 > 
	gkMaxSuµÜ‹dCpuidL—f
 || !
	gıuid_»suÉs
[
Ëaf
].
	gÿched
) {

85  
	gEXCEPTION_CONTINUE_SEARCH
;

91 
ušt64_t
 
	gsubËaf
 = 
šfo
->
ıu_cÚ‹xt
.
rcx
;

92 ià(
	gËaf
 !ğ0 && 
Ëaf
 !ğ1 && 
subËaf
 !ğ0è 
EXCEPTION_CONTINUE_SEARCH
;

95 
	gšfo
->
	gıu_cÚ‹xt
.
	g¿x
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
EAX
];

96 
	gšfo
->
	gıu_cÚ‹xt
.
	grbx
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
EBX
];

97 
	gšfo
->
	gıu_cÚ‹xt
.
	grcx
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
ECX
];

98 
	gšfo
->
	gıu_cÚ‹xt
.
	grdx
 = 
ıuid_»suÉs
[
Ëaf
].
»g
[
CpuidResuÉ
::
EDX
];

103 
	gšfo
->
	gıu_cÚ‹xt
.
	gr
 += 2;

105  
	gEXCEPTION_CONTINUE_EXECUTION
;

110 
hªdË_rdtsc_exû±iÚ
(
sgx_exû±iÚ_šfo_t
 *
šfo
) {

112 
ušt16_t
 
	gİcode
 = *
»š‹½»t_ÿ¡
<ušt16_ˆ*>(
šfo
->
ıu_cÚ‹xt
.
r
);

117 ià(
	gšfo
->
	gexû±iÚ_veùÜ
 !ğ
SGX_EXCEPTION_VECTOR_UD
 ||

118 
šfo
->
exû±iÚ_ty³
 !ğ
SGX_EXCEPTION_HARDWARE
 ||

119 
İcode
 !ğ
kRdtscOpcode
) {

120  
EXCEPTION_CONTINUE_SEARCH
;

124 
ušt64_t
 
	gÏ¡_rdtsc
 = 0;

125 
	gÏ¡_rdtsc
++;

128 
	gšfo
->
	gıu_cÚ‹xt
.
	g¿x
 = 
Ï¡_rdtsc
 & 0xFFFFFFFF;

129 
	gšfo
->
	gıu_cÚ‹xt
.
	grdx
 = 
Ï¡_rdtsc
 >> 32;

134 
	gšfo
->
	gıu_cÚ‹xt
.
	gr
 += 2;

136  
	gEXCEPTION_CONTINUE_EXECUTION
;

142 
»gi¡”_exû±iÚ_hªdËrs
(è
__©Œibu‹__
((
cÚ¡ruùÜ
(101)));

143 
»gi¡”_exû±iÚ_hªdËrs
() {

144 
š™Ÿlize_ıuid_»suÉs
();

145 
sgx_»gi¡”_exû±iÚ_hªdËr
(
Œue
, 
hªdË_ıuid_exû±iÚ
);

146 
sgx_»gi¡”_exû±iÚ_hªdËr
(
Œue
, 
hªdË_rdtsc_exû±iÚ
);

	@platform/arch/sgx/trusted/fork.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

21 
	~<İ’s¦/¿nd.h
>

22 
	~<sys/sock‘.h
>

23 
	~<fú.h
>

25 
	~<©omic
>

26 
	~<c¡ddef
>

27 
	~<veùÜ
>

29 
	~"ab¦/ba£/maüos.h
"

30 
	~"asylo/üy±o/«ad_üy±Ü.h
"

31 
	~"asylo/üy±o/ut/bs¦_ut.h
"

32 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

33 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

34 
	~"asylo/ut/loggšg.h
"

35 
	~"asylo/g½c/auth/cÜe/ş›Á_ek•_hªdshak”.h
"

36 
	~"asylo/g½c/auth/cÜe/£rv”_ek•_hªdshak”.h
"

37 
	~"asylo/id’t™y/desütiÚs.h
"

38 
	~"asylo/id’t™y/id’t™y_aş_ev®u©Ü.h
"

39 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

40 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

41 
	~"asylo/id’t™y/sgx/sgx_code_id’t™y_ex³ù©iÚ_m©ch”.h
"

42 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

43 
	~"asylo/¶©fÜm/posix/memÜy/memÜy.h
"

44 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

45 
	~"asylo/ut/ş—nsšg_ty³s.h
"

46 
	~"asylo/ut/ş—nup.h
"

47 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

48 
	~"asylo/ut/¡©us.h
"

50 
usšg
 
	gA—dCry±Ü
 = 
asylo
::
ex³rim’l
::
A—dCry±Ü
;

52 
Çme¥aû
 
	gasylo
 {

53 
	gÇme¥aû
 {

57 
cÚ¡ex´
 
size_t
 
	gkSÇpshÙKeySize
 = 32;

61 
	g¡d
::
©omic
<
boŞ
> 
fÜk_»que¡ed
(
çl£
);

66 
	g¡d
::
©omic
<
boŞ
> 
¢­shÙ_key_Œªsãr_»que¡ed
(
çl£
);

68 cÚ¡ 
	gkSÇpshÙKeyAssocŸ‹dD©aBuf
[] = "AES256-GCM-SIV snapshot key";

71 
	gCËªsšgVeùÜ
<
	gušt8_t
> *
glob®_¢­shÙ_key
(
nuÎ±r
);

74 
	sTh»adMemÜyLayout
 {

77 *
	gth»ad_ba£
;

79 
size_t
 
	gth»ad_size
;

82 *
	g¡ack_ba£
;

85 *
	g¡ack_lim™
;

91 
Th»adMemÜyLayout
 
	gfÜked_th»ad_memÜy_Ïyout
 = {

92 
nuÎ±r
, 0,‚ullptr,‚ullptr};

95 
boŞ
 
CË¬FÜkReque¡ed
(è{  
	gfÜk_»que¡ed
.
exchªge
(
çl£
); }

99 
boŞ
 
CË¬SÇpshÙKeyT¿nsãrReque¡ed
() {

100  
	g¢­shÙ_key_Œªsãr_»que¡ed
.
exchªge
(
çl£
);

105 
S‘SÇpshÙKeyT¿nsãrReque¡ed
() {

106 
	g¢­shÙ_key_Œªsãr_»que¡ed
 = 
Œue
;

111 cÚ¡ 
Th»adMemÜyLayout
 
G‘Th»adLayoutFÜSÇpshÙ
() {

112  
	gfÜked_th»ad_memÜy_Ïyout
;

115 
D–‘eSÇpshÙKey
() {

116 ià(
	gglob®_¢­shÙ_key
) {

117 
d–‘e
 
	gglob®_¢­shÙ_key
;

119 
	gglob®_¢­shÙ_key
 = 
nuÎ±r
;

122 
boŞ
 
S‘SÇpshÙKey
(cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
key
) {

123 ià(
	gkey
.
size
(è!ğ
kSÇpshÙKeySize
) {

124  
çl£
;

126 
D–‘eSÇpshÙKey
();

127 
	gglob®_¢­shÙ_key
 = 
Ãw
 
CËªsšgVeùÜ
<
ušt8_t
>(
key
);

128  
	gŒue
;

131 
boŞ
 
G‘SÇpshÙKey
(
CËªsšgVeùÜ
<
ušt8_t
> *
key
) {

132 ià(!
	gglob®_¢­shÙ_key
) {

133  
	gçl£
;

135 *
	gkey
 = *
glob®_¢­shÙ_key
;

136  
	gŒue
;

145 
Stus
 
Enüy±ToUÁru¡edMemÜy
(
A—dCry±Ü
 *
üy±Ü
, cÚ¡ *
sourû_ba£
,

146 cÚ¡ 
size_t
 
sourû_size
,

147 
SÇpshÙLayoutEÁry
 *
¢­shÙ_’Œy
) {

148 
By‹CÚš”V›w
 
¶aš‹xt
(
sourû_ba£
, 
sourû_size
);

149 
	gmaximum_ch”‹xt_size
 = 
sourû_size
 + 
üy±Ü
->
MaxS—lOv”h—d
();

150 *
	gde¡š©iÚ_ba£
 = 
’c_uÁru¡ed_m®loc
(
maximum_ch”‹xt_size
);

151 
size_t
 
	gde¡š©iÚ_size
;

152 ià(!
	gde¡š©iÚ_ba£
) {

153  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

156 
size_t
 
	gnÚû_size
 = 
üy±Ü
->
NÚûSize
();

157 *
	gnÚû_ba£
 = 
’c_uÁru¡ed_m®loc
(
nÚû_size
);

158 ià(!
	gnÚû_ba£
) {

159  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

165 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
S—l
(

166 
¶aš‹xt
, 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
sourû_ba£
),

167 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
nÚû_ba£
), 
nÚû_size
),

168 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
de¡š©iÚ_ba£
),

169 
maximum_ch”‹xt_size
),

170 &
de¡š©iÚ_size
));

172 
	g¢­shÙ_’Œy
->
£t_ch”‹xt_ba£
(

173 
»š‹½»t_ÿ¡
<
ušt64_t
>(
de¡š©iÚ_ba£
));

174 
	g¢­shÙ_’Œy
->
£t_ch”‹xt_size
(
¡©ic_ÿ¡
<
ušt64_t
>(
de¡š©iÚ_size
));

175 
	g¢­shÙ_’Œy
->
£t_nÚû_ba£
(
»š‹½»t_ÿ¡
<
ušt64_t
>(
nÚû_ba£
));

176 
	g¢­shÙ_’Œy
->
£t_nÚû_size
(
¡©ic_ÿ¡
<
ušt64_t
>(
nÚû_size
));

177  
	gStus
::
OkStus
();

186 
Stus
 
Deüy±FromUÁru¡edMemÜy
(
A—dCry±Ü
 *
üy±Ü
,

187 
SÇpshÙLayoutEÁry
 
¢­shÙ_’Œy
,

188 *
de¡š©iÚ_ba£
,

189 
size_t
 
de¡š©iÚ_size
,

190 
size_t
 *
aùu®_¶aš‹xt_size
) {

193 *
	gsourû_ba£
 =

194 
»š‹½»t_ÿ¡
<*>(
¢­shÙ_’Œy
.
ch”‹xt_ba£
());

195 
size_t
 
	gsourû_size
 = 
¡©ic_ÿ¡
<size_t>(
¢­shÙ_’Œy
.
ch”‹xt_size
());

196 ià(!
’c_is_outside_’şave
(
sourû_ba£
, 
sourû_size
)) {

197  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

200 *
	gnÚû_ba£
 = 
»š‹½»t_ÿ¡
<*>(
¢­shÙ_’Œy
.
nÚû_ba£
());

201 
size_t
 
	gnÚû_size
 = 
¡©ic_ÿ¡
<size_t>(
¢­shÙ_’Œy
.
nÚû_size
());

202 ià(!
’c_is_outside_’şave
(
nÚû_ba£
, 
nÚû_size
)) {

203  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

206 
By‹CÚš”V›w
 
ch”‹xt
(
sourû_ba£
, 
sourû_size
);

207 
	g¡d
::
veùÜ
<
ušt8_t
> 
nÚû
(

208 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
nÚû_ba£
),

209 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
nÚû_ba£
è+ 
nÚû_size
);

213  
	güy±Ü
->
O³n
(

214 
ch”‹xt
, 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
de¡š©iÚ_ba£
), 
nÚû
,

215 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
de¡š©iÚ_ba£
),

216 
de¡š©iÚ_size
),

217 
aùu®_¶aš‹xt_size
);

220 
CİyNÚOkStus
(cÚ¡ 
Stus
 &
nÚ_ok_¡©us
,

221 
”rÜ
::
GoogËE¼Ü
 *
”rÜ_code
, *
”rÜ_mes§ge
,

222 
size_t
 
mes§ge_bufãr_size
) {

223 *
	g”rÜ_code
 = 
nÚ_ok_¡©us
.
CªÚiÿlCode
();

224 
¡ºıy
(
”rÜ_mes§ge
, 
nÚ_ok_¡©us
.”rÜ_mes§ge().
d©a
(),

225 
¡d
::
mš
(
mes§ge_bufãr_size
, 
nÚ_ok_¡©us
.
”rÜ_mes§ge
().
size
()));

233 
Stus
 
Enüy±ToSÇpshÙ
(
A—dCry±Ü
 *
üy±Ü
, *
sourû_ba£
,

234 
size_t
 
sourû_size
,

235 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
SÇpshÙLayoutEÁry
> *
’Œy
) {

236 
size_t
 
by‹s_Ëá
 = 
sourû_size
;

237 
ušt8_t
 *
	gcu¼’t_pos™iÚ
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
sourû_ba£
);

239 
	gby‹s_Ëá
 > 0) {

240 
size_t
 
	g¶aš‹xt_size
 = 
¡d
::
mš
(
üy±Ü
->
MaxMes§geSize
(), 
by‹s_Ëá
);

241 
ASYLO_RETURN_IF_ERROR
(
Enüy±ToUÁru¡edMemÜy
(

242 
üy±Ü
, 
cu¼’t_pos™iÚ
, 
¶aš‹xt_size
, 
’Œy
->
Add
()));

244 
	gby‹s_Ëá
 -ğ
¶aš‹xt_size
;

245 
	gcu¼’t_pos™iÚ
 +ğ
¶aš‹xt_size
;

247  
	gStus
::
OkStus
();

254 
Stus
 
Deüy±FromSÇpshÙ
(

255 
A—dCry±Ü
 *
üy±Ü
, *
de¡š©iÚ_ba£
, 
size_t
 
de¡š©iÚ_size
,

256 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
SÇpshÙLayoutEÁry
> &
’Œy
) {

257 
ušt8_t
 *
cu¼’t_pos™iÚ
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
de¡š©iÚ_ba£
);

258 
size_t
 
	gby‹s_Ëá
 = 
de¡š©iÚ_size
;

260 
	gi
 = 0; i < 
	g’Œy
.
size
(è&& 
	gby‹s_Ëá
 > 0; ++i) {

264 
size_t
 
	gex³ùed_¶aš‹xt_size
 =

265 
¡d
::
mš
(
üy±Ü
->
MaxMes§geSize
(), 
by‹s_Ëá
);

267 ià(!
	gcu¼’t_pos™iÚ
 ||

268 !
’c_is_w™hš_’şave
(
cu¼’t_pos™iÚ
, 
ex³ùed_¶aš‹xt_size
)) {

269  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

273 
size_t
 
	gaùu®_¶aš‹xt_size
;

274 
ASYLO_RETURN_IF_ERROR
(
Deüy±FromUÁru¡edMemÜy
(

275 
üy±Ü
, 
’Œy
[
i
], 
cu¼’t_pos™iÚ
, 
ex³ùed_¶aš‹xt_size
,

276 &
aùu®_¶aš‹xt_size
));

277 ià(
	gaùu®_¶aš‹xt_size
 !ğ
ex³ùed_¶aš‹xt_size
) {

278  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

281 
	gby‹s_Ëá
 -ğ
aùu®_¶aš‹xt_size
;

282 
	gcu¼’t_pos™iÚ
 +ğ
aùu®_¶aš‹xt_size
;

284  
	gStus
::
OkStus
();

289 
boŞ
 
IsSecu»FÜkSuµÜ‹d
(è{  
	gŒue
; }

293 
SaveTh»adLayoutFÜSÇpshÙ
() {

294 
EnşaveMemÜyLayout
 
	g’şave_memÜy_Ïyout
;

295 
’c_g‘_memÜy_Ïyout
(&
’şave_memÜy_Ïyout
);

296 
Th»adMemÜyLayout
 
	gth»ad_memÜy_Ïyout
;

297 
	gth»ad_memÜy_Ïyout
.
	gth»ad_ba£
 = 
’şave_memÜy_Ïyout
.
th»ad_ba£
;

298 
	gth»ad_memÜy_Ïyout
.
	gth»ad_size
 = 
’şave_memÜy_Ïyout
.
th»ad_size
;

299 
	gth»ad_memÜy_Ïyout
.
	g¡ack_ba£
 = 
’şave_memÜy_Ïyout
.
¡ack_ba£
;

300 
	gth»ad_memÜy_Ïyout
.
	g¡ack_lim™
 = 
’şave_memÜy_Ïyout
.
¡ack_lim™
;

301 
	gfÜked_th»ad_memÜy_Ïyout
 = 
th»ad_memÜy_Ïyout
;

304 
S‘FÜkReque¡ed
(è{ 
	gfÜk_»que¡ed
 = 
Œue
; }

308 
Stus
 
TakeSÇpshÙFÜFÜk
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
) {

311 ià(!
CË¬FÜkReque¡ed
()) {

312  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

317 
CËªup
 
unblock_eÿÎs
(
’c_unblock_eÿÎs
);

320 
’c_block_eÿÎs
();

326 ià(
g‘_aùive_’şave_’Œ›s
() > 2) {

327 
LOG
(
WARNING
è<< "Th”¬" << 
g‘_aùive_’şave_’Œ›s
()

334 ià(!
	g¢­shÙ_Ïyout
) {

335  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

340 
EnşaveMemÜyLayout
 
	g’şave_Ïyout
;

341 
’c_g‘_memÜy_Ïyout
(&
’şave_Ïyout
);

342 ià(!
	g’şave_Ïyout
.
	gd©a_ba£
 ||ƒnşave_Ïyout.
	gd©a_size
 <= 0) {

343  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

346 ià(!
	g’şave_Ïyout
.
	gbss_ba£
 ||ƒnşave_Ïyout.
	gbss_size
 <= 0) {

347  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

350 ià(!
	g’şave_Ïyout
.
	gh—p_ba£
 ||ƒnşave_Ïyout.
	gh—p_size
 <= 0) {

351  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Can't findƒnclave heap");

354 
Th»adMemÜyLayout
 
	gth»ad_Ïyout
 = 
G‘Th»adLayoutFÜSÇpshÙ
();

356 ià(!
	gth»ad_Ïyout
.
	gth»ad_ba£
 ||h»ad_Ïyout.
	gth»ad_size
 <= 0) {

357  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

361 ià(!
	gth»ad_Ïyout
.
	g¡ack_ba£
 || !th»ad_Ïyout.
	g¡ack_lim™
) {

362  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

366 ià(
	g’şave_Ïyout
.
	g»£rved_d©a_size
 <ƒnşave_Ïyout.
	gd©a_size
) {

367  
Stus
(

368 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

372 ià(
	g’şave_Ïyout
.
	g»£rved_bss_size
 <ƒnşave_Ïyout.
	gbss_size
) {

373  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

378 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
¢­shÙ_key
(
kSÇpshÙKeySize
);

379 ià(!
RAND_by‹s
(
¢­shÙ_key
.
d©a
(), 
kSÇpshÙKeySize
)) {

380  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

381 
ab¦
::
SŒC©
("Can‚ot generatehe snapshot key: ",

382 
Bs¦La¡E¼ÜSŒšg
()));

384 ià(!
S‘SÇpshÙKey
(
¢­shÙ_key
)) {

385  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

392 
memıy
(
’şave_Ïyout
.
»£rved_d©a_ba£
,ƒnşave_Ïyout.
d©a_ba£
,

393 
’şave_Ïyout
.
d©a_size
);

395 
memıy
(
’şave_Ïyout
.
»£rved_bss_ba£
,ƒnşave_Ïyout.
bss_ba£
,

396 
’şave_Ïyout
.
bss_size
);

400 
	g”rÜ
::
GoogËE¼Ü
 
”rÜ_code
 = 
”rÜ
::GoogËE¼Ü::
OK
;

401 
	g”rÜ_mes§ge
[1024];

406 
h—p_sw™ch
(
’şave_Ïyout
.
»£rved_h—p_ba£
,

407 
’şave_Ïyout
.
»£rved_h—p_size
);

417 
SÇpshÙLayout
 
	gtmp_¢­shÙ_Ïyout
;

421 autØ
	güy±Ü_»suÉ
 = 
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
¢­shÙ_key
);

422 ià(!
	güy±Ü_»suÉ
.
ok
()) {

423 
CİyNÚOkStus
(
üy±Ü_»suÉ
.
¡©us
(), &
”rÜ_code
, 
”rÜ_mes§ge
,

424 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

427 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
 =

428 
¡d
::
move
(
üy±Ü_»suÉ
.
V®ueOrD›
());

431 
Stus
 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(

432 
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_d©a_ba£
,

433 
’şave_Ïyout
.
d©a_size
, 
tmp_¢­shÙ_Ïyout
.
mubË_d©a
());

435 ià(!
	g¡©us
.
ok
()) {

436 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

437 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

442 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_bss_ba£
,

443 
’şave_Ïyout
.
bss_size
,

444 
tmp_¢­shÙ_Ïyout
.
mubË_bss
());

446 ià(!
	g¡©us
.
ok
()) {

447 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

448 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

453 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
th»ad_ba£
,

454 
th»ad_Ïyout
.
th»ad_size
,

455 
tmp_¢­shÙ_Ïyout
.
mubË_th»ad
());

457 ià(!
	g¡©us
.
ok
()) {

458 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

459 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

464 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
h—p_ba£
,

465 
’şave_Ïyout
.
h—p_size
,

466 
tmp_¢­shÙ_Ïyout
.
mubË_h—p
());

468 ià(!
	g¡©us
.
ok
()) {

469 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

470 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

475 
size_t
 
	g¡ack_size
 = 
»š‹½»t_ÿ¡
<size_t>(
th»ad_Ïyout
.
¡ack_ba£
) -

476 
»š‹½»t_ÿ¡
<
size_t
>(
th»ad_Ïyout
.
¡ack_lim™
);

478 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
¡ack_lim™
,

479 
¡ack_size
, 
tmp_¢­shÙ_Ïyout
.
mubË_¡ack
());

481 ià(!
	g¡©us
.
ok
()) {

482 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

483 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

489 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

490 *
	g¢­shÙ_Ïyout
 = 
tmp_¢­shÙ_Ïyout
;

494 
h—p_sw™ch
(
’şave_Ïyout
.
»£rved_h—p_ba£
,

495 
’şave_Ïyout
.
»£rved_h—p_size
);

499 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

500 ià(
	g”rÜ_code
 !ğ
”rÜ
::
GoogËE¼Ü
::
OK
) {

501  
Stus
(
”rÜ_code
, 
”rÜ_mes§ge
);

506 
S‘SÇpshÙKeyT¿nsãrReque¡ed
();

507  
	gStus
::
OkStus
();

513 
Stus
 
Deüy±AndRe¡ÜeEnşaveD©aBssH—p
(

514 cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
,

515 cÚ¡ 
EnşaveMemÜyLayout
 &
’şave_Ïyout
,

516 cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
¢­shÙ_key
) {

519 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

520 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

521 
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
¢­shÙ_key
));

525 
ASYLO_RETURN_IF_ERROR
(

526 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_d©a_ba£
,

527 
’şave_Ïyout
.
d©a_size
, 
¢­shÙ_Ïyout
.
d©a
()));

531 
ASYLO_RETURN_IF_ERROR
(

532 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_bss_ba£
,

533 
’şave_Ïyout
.
bss_size
, 
¢­shÙ_Ïyout
.
bss
()));

537 
ASYLO_RETURN_IF_ERROR
(

538 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
h—p_ba£
,

539 
’şave_Ïyout
.
h—p_size
, 
¢­shÙ_Ïyout
.
h—p
()));

541 *
	gsw™ched_h—p_Ãxt
 = 
G‘Sw™chedH—pNext
();

542 
size_t
 
	gsw™ched_h—p_»maššg
 = 
G‘Sw™chedH—pRemaššg
();

545 
memıy
(
’şave_Ïyout
.
d©a_ba£
,ƒnşave_Ïyout.
»£rved_d©a_ba£
,

546 
’şave_Ïyout
.
d©a_size
);

547 
memıy
(
’şave_Ïyout
.
bss_ba£
,ƒnşave_Ïyout.
»£rved_bss_ba£
,

548 
’şave_Ïyout
.
bss_size
);

553 
h—p_sw™ch
(
sw™ched_h—p_Ãxt
, 
sw™ched_h—p_»maššg
);

554  
	gStus
::
OkStus
();

560 
Stus
 
Deüy±AndRe¡ÜeTh»adSck
(

561 cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
,

562 cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
¢­shÙ_key
) {

563 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

564 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

565 
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
¢­shÙ_key
));

569 
Th»adMemÜyLayout
 
	gth»ad_Ïyout
 = 
G‘Th»adLayoutFÜSÇpshÙ
();

574 
ASYLO_RETURN_IF_ERROR
(

575 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
th»ad_ba£
,

576 
th»ad_Ïyout
.
th»ad_size
, 
¢­shÙ_Ïyout
.
th»ad
()));

579 
size_t
 
	g¡ack_size
 = 
»š‹½»t_ÿ¡
<size_t>(
th»ad_Ïyout
.
¡ack_ba£
) -

580 
»š‹½»t_ÿ¡
<
size_t
>(
th»ad_Ïyout
.
¡ack_lim™
);

581 
ASYLO_RETURN_IF_ERROR
(

582 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
¡ack_lim™
, 
¡ack_size
,

583 
¢­shÙ_Ïyout
.
¡ack
()));

585  
	gStus
::
OkStus
();

589 
Stus
 
Re¡ÜeFÜFÜk
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
) {

593 
’c_block_eÿÎs
();

597 ià(
g‘_aùive_’şave_’Œ›s
() != 1) {

598 
LOG
(
INFO
è<< "’Œ˜num : " << 
g‘_aùive_’şave_’Œ›s
() ;

607 
EnşaveMemÜyLayout
 
	g’şave_Ïyout
;

608 
’c_g‘_memÜy_Ïyout
(&
’şave_Ïyout
);

610 
	g”rÜ
::
GoogËE¼Ü
 
”rÜ_code
 = 
”rÜ
::GoogËE¼Ü::
OK
;

611 
	g”rÜ_mes§ge
[1024];

615 
h—p_sw™ch
(
’şave_Ïyout
.
»£rved_h—p_ba£
,

616 
’şave_Ïyout
.
»£rved_h—p_size
);

625 
	gasylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout
;

626 ià(!
	g¢­shÙ_Ïyout
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

627 
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

629 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

630 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

635 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g¢­shÙ_key
;

637 ià(!
G‘SÇpshÙKey
(&
¢­shÙ_key
)) {

638 
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

640 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

641 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

647 
Stus
 
	g¡©us
 = 
Deüy±AndRe¡ÜeEnşaveD©aBssH—p
(

648 
¢­shÙ_Ïyout
, 
’şave_Ïyout
, 
¢­shÙ_key
);

649 ià(!
	g¡©us
.
ok
()) {

650 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

651 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

658 
	g¡©us
 = 
Deüy±AndRe¡ÜeTh»adSck
(
¢­shÙ_Ïyout
, 
¢­shÙ_key
);

659 ià(!
	g¡©us
.
ok
()) {

660 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

661 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

667 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

668 ià(
	g”rÜ_code
 !ğ
”rÜ
::
GoogËE¼Ü
::
OK
) {

669  
Stus
(
”rÜ_code
, 
”rÜ_mes§ge
);

676 
’c_unblock_eÿÎs
();

678  
	gStus
::
OkStus
();

682 
Stus
 
RunEk•Hªdshake
(
Ek•Hªdshak”
 *
hªdshak”
, 
boŞ
 
is_·»Á
,

683 
sock‘
) {

684 
	g¡d
::
¡ršg
 
outgošg_by‹s
;

687 
	gEk•Hªdshak”
::
ResuÉ
 
»suÉ
 = 
Ek•Hªdshak”
::ResuÉ::
IN_PROGRESS
;

689 ià(
	gis_·»Á
) {

690 
	g»suÉ
 = 
hªdshak”
->
NextHªdshakeS‹p
(
nuÎ±r
, 0, &
outgošg_by‹s
);

691 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
ABORTED
) {

692  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "EKEP handshake has‡borted");

697 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
outgošg_by‹s
.
c_¡r
(),

698 
outgošg_by‹s
.
size
()) <= 0) {

699  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Write failed");

704 
	gbuf
[1024];

705 
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
IN_PROGRESS
) {

707 
outgošg_by‹s
.
ş—r
();

710 
ssize_t
 
	gby‹s_»ûived
 =

711 
’c_uÁru¡ed_»cväom
(
sock‘
, 
buf
, (buf), 
MSG_PEEK
,

712  
nuÎ±r
,‚ullptr);

713 ià(
	gby‹s_»ûived
 <= 0) {

714  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Read failed");

716 
	g»suÉ
 =

717 
hªdshak”
->
NextHªdshakeS‹p
(
buf
, 
by‹s_»ûived
, &
outgošg_by‹s
);

719 
	gby‹s_u£d
 = 
by‹s_»ûived
;

720 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
COMPLETED
) {

724 autØ
unu£d_by‹s_»suÉ
 = 
hªdshak”
->
G‘Unu£dBy‹s
();

725 ià(!
	gunu£d_by‹s_»suÉ
.
ok
()) {

726  
	gunu£d_by‹s_»suÉ
.
¡©us
();

728 
size_t
 
	gunu£d_by‹s_size
 = 
unu£d_by‹s_»suÉ
.
V®ueOrD›
().
size
();

729 
	gby‹s_u£d
 -ğ
unu£d_by‹s_size
;

732 
’c_uÁru¡ed_»cväom
(
sock‘
, 
buf
, 
by‹s_u£d
, 0,

733  
nuÎ±r
,‚ullptr);

734 } 
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
NOT_ENOUGH_DATA
);

736 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
ABORTED
) {

737  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "EKEP handshake has‡borted");

740 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
COMPLETED
 && !
is_·»Á
) {

746 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
outgošg_by‹s
.
c_¡r
(),

747 
outgošg_by‹s
.
size
()) <= 0) {

748  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Write failed");

751  
	gStus
::
OkStus
();

758 
Stus
 
Com·»P“rAndS–fId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
³”_id’t™y
) {

759 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

760 
	gsgx
::
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
(&
code_id’t™y_ex³ù©iÚ
);

761 
EnşaveId’t™yEx³ù©iÚ
 
	g’şave_id’t™y_ex³ù©iÚ
;

762 
ASYLO_RETURN_IF_ERROR
(
sgx
::
S”ŸlizeSgxEx³ù©iÚ
(

763 
code_id’t™y_ex³ù©iÚ
, &
’şave_id’t™y_ex³ù©iÚ
));

764 
Id’t™yAşP»diÿ‹
 
	g´ediÿ‹
;

765 *
	g´ediÿ‹
.
mubË_ex³ù©iÚ
(èğ
’şave_id’t™y_ex³ù©iÚ
;

766 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gsgx_m©ch”
;

768 autØ
	gaş_»suÉ
 =

769 
Ev®u©eId’t™yAş
({
³”_id’t™y
}, 
´ediÿ‹
, 
sgx_m©ch”
);

770 ià(!
	gaş_»suÉ
.
ok
()) {

771  
	gaş_»suÉ
.
¡©us
();

773 ià(!
	gaş_»suÉ
.
V®ueOrD›
()) {

774  
Stus
(

775 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

778  
	gStus
::
OkStus
();

782 
Stus
 
Enüy±AndS’dSÇpshÙKey
(
¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
,

783 
sock‘
) {

784 *
	g±r
;

785 
CËªup
 
d–‘e_¢­shÙ_key
(
D–‘eSÇpshÙKey
);

786 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
¢­shÙ_key
(
kSÇpshÙKeySize
);

787 ià(!
G‘SÇpshÙKey
(&
¢­shÙ_key
)) {

788  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo get snapshot key");

792 
By‹CÚš”V›w
 
assocŸ‹d_d©a
(
kSÇpshÙKeyAssocŸ‹dD©aBuf
,

793 (
kSÇpshÙKeyAssocŸ‹dD©aBuf
));

795 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_ch”‹xt
(
kSÇpshÙKeySize
 +

796 
üy±Ü
->
MaxS—lOv”h—d
());

797 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_nÚû
(
üy±Ü
->
NÚûSize
());

798 
size_t
 
	g’üy±ed_¢­shÙ_key_size
;

800 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
S—l
(

801 
¢­shÙ_key
, 
assocŸ‹d_d©a
, 
ab¦
::
MakeS·n
(
¢­shÙ_key_nÚû
),

802 
ab¦
::
MakeS·n
(
¢­shÙ_key_ch”‹xt
), &
’üy±ed_¢­shÙ_key_size
));

803 
	g¢­shÙ_key_ch”‹xt
.
»size
(
’üy±ed_¢­shÙ_key_size
);

806 
Enüy±edSÇpshÙKey
 
	g’üy±ed_¢­shÙ_key
;

807 
	g’üy±ed_¢­shÙ_key
.
£t_ch”‹xt
(
¢­shÙ_key_ch”‹xt
.
d©a
(),

808 
’üy±ed_¢­shÙ_key_size
);

809 
	g’üy±ed_¢­shÙ_key
.
£t_nÚû
(
¢­shÙ_key_nÚû
.
d©a
(),

810 
¢­shÙ_key_nÚû
.
size
());

812 
	g¡d
::
¡ršg
 
’üy±ed_¢­shÙ_key_¡ršg
;

813 ià(!
	g’üy±ed_¢­shÙ_key
.
S”ŸlizeToSŒšg
(

814 &
’üy±ed_¢­shÙ_key_¡ršg
)) {

815  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

819 
	gfd
 = 
’c_uÁru¡ed_İ’
("/tmp/¢­_key", 
O_WRONLY
);

820 
’c_uÁru¡ed_wr™e
(
fd
,

821 
’üy±ed_¢­shÙ_key_¡ršg
.
d©a
(),

822 
’üy±ed_¢­shÙ_key_¡ršg
.
size
());

823 
şo£
(
fd
);

826 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
’üy±ed_¢­shÙ_key_¡ršg
.
d©a
(),

827 
’üy±ed_¢­shÙ_key_¡ršg
.
size
()) <= 0) {

828  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Write failed");

831  
	gStus
::
OkStus
();

835 
Stus
 
ReûiveSÇpshÙKey
(
¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
, 
sock‘
) {

837 
	gbuf
[1024];

838 *
	g±r
;

839 
	grc
 = 
’c_uÁru¡ed_»ad
(
sock‘
, 
buf
, (buf));

840 ià(
	grc
 <= 0) {

841  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Read failed");

845 
	gfd
;

846 
	gfd
 = 
’c_uÁru¡ed_İ’
("/tmp/¢­_key", 
O_RDONLY
);

847 
	grc
 = 
’c_uÁru¡ed_»ad
(
fd
, 
buf
, (buf));

848 
	g±r
 = (*)
buf
;

849 
şo£
(
fd
);

851 
Enüy±edSÇpshÙKey
 
	g’üy±ed_¢­shÙ_key
;

852 ià(!
	g’üy±ed_¢­shÙ_key
.
P¬£FromA¼ay
(
buf
, 
rc
)) {

853  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

858 
	g¡d
::
¡ršg
 
’üy±ed_¢­shÙ_key_¡ršg
;

859 ià(!
	g’üy±ed_¢­shÙ_key
.
S”ŸlizeToSŒšg
(

860 &
’üy±ed_¢­shÙ_key_¡ršg
)) {

861  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

866 
By‹CÚš”V›w
 
assocŸ‹d_d©a
(
kSÇpshÙKeyAssocŸ‹dD©aBuf
,

867 (
kSÇpshÙKeyAssocŸ‹dD©aBuf
));

869 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_ch”‹xt
(

870 
’üy±ed_¢­shÙ_key
.
ch”‹xt
().
cbegš
(),

871 
’üy±ed_¢­shÙ_key
.
ch”‹xt
().
ûnd
());

872 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_nÚû
(

873 
’üy±ed_¢­shÙ_key
.
nÚû
().
cbegš
(),

874 
’üy±ed_¢­shÙ_key
.
nÚû
().
ûnd
());

875 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
¢­shÙ_key
(
¢­shÙ_key_ch”‹xt
.
size
());

876 
size_t
 
	g¢­shÙ_key_size
;

877 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
O³n
(

878 
¢­shÙ_key_ch”‹xt
, 
assocŸ‹d_d©a
, 
¢­shÙ_key_nÚû
,

879 
ab¦
::
MakeS·n
(
¢­shÙ_key
), &
¢­shÙ_key_size
));

880 
	g¢­shÙ_key
.
»size
(
¢­shÙ_key_size
);

884 ià(!
S‘SÇpshÙKey
(
¢­shÙ_key
)) {

885  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

888  
	gStus
::
OkStus
();

895 
Stus
 
T¿nsãrSecu»SÇpshÙKey
(

896 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
) {

897 ià(!
	gfÜk_hªdshake_cÚfig
.
has_is_·»Á
() ||

898 !
	gfÜk_hªdshake_cÚfig
.
has_sock‘
()) {

899  
Stus
(

900 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

904 ià(
	gfÜk_hªdshake_cÚfig
.
sock‘
() < 0) {

905  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

909 
boŞ
 
	gis_·»Á
 = 
fÜk_hªdshake_cÚfig
.
is_·»Á
();

913 ià(
	gis_·»Á
 && !
CË¬SÇpshÙKeyT¿nsãrReque¡ed
()) {

914  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

919 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

920 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
desütiÚ
);

922 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
;

923 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
push_back
(
desütiÚ
);

924 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
push_back
(
desütiÚ
);

929 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
hªdshak”
;

930 ià(
	gis_·»Á
) {

931 
	ghªdshak”
 = 
Cl›ÁEk•Hªdshak”
::
C»©e
(
İtiÚs
);

933 
	ghªdshak”
 = 
S”v”Ek•Hªdshak”
::
C»©e
(
İtiÚs
);

936 
ASYLO_RETURN_IF_ERROR
(
RunEk•Hªdshake
(
hªdshak”
.
g‘
(), 
is_·»Á
,

937 
fÜk_hªdshake_cÚfig
.
sock‘
()));

941 
EnşaveId’t™y
 
	g³”_id’t™y
 =

942 
hªdshak”
->
G‘P“rId’t™›s
().
V®ueOrD›
()->
id’t™›s
(0);

944 
ASYLO_RETURN_IF_ERROR
(
Com·»P“rAndS–fId’t™y
(
³”_id’t™y
));

948 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g»cÜd_´ÙocŞ_key
;

949 
ASYLO_ASSIGN_OR_RETURN
(
»cÜd_´ÙocŞ_key
,

950 
hªdshak”
->
G‘RecÜdPrÙocŞKey
());

951 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

952 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

953 
A—dCry±Ü
::
C»©eAesGcmCry±Ü
(
»cÜd_´ÙocŞ_key
));

955 ià(
	gis_·»Á
) {

956  
Enüy±AndS’dSÇpshÙKey
(
¡d
::
move
(
üy±Ü
),

957 
fÜk_hªdshake_cÚfig
.
sock‘
());

959  
ReûiveSÇpshÙKey
(
¡d
::
move
(
üy±Ü
),

960 
fÜk_hªdshake_cÚfig
.
sock‘
());

964 
pid_t
 
’c_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

966 
	gasylo
::
SaveTh»adLayoutFÜSÇpshÙ
();

969 
S‘FÜkReque¡ed
();

970 
	g¡d
::
¡ršg
 
buf
;

971 ià(!
	gcÚfig
.
S”ŸlizeToSŒšg
(&
buf
)) {

972 
	g”ºo
 = 
EFAULT
;

976  
’c_uÁru¡ed_fÜk
(
’şave_Çme
, 
buf
.
d©a
(), buf.
size
(),

977  
Œue
);

	@platform/arch/sgx/trusted/fork.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

21 
	~<İ’s¦/¿nd.h
>

22 
	~<sys/sock‘.h
>

23 
	~<fú.h
>

25 
	~<©omic
>

26 
	~<c¡ddef
>

27 
	~<veùÜ
>

29 
	~"ab¦/ba£/maüos.h
"

30 
	~"asylo/üy±o/«ad_üy±Ü.h
"

31 
	~"asylo/üy±o/ut/bs¦_ut.h
"

32 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

33 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

34 
	~"asylo/ut/loggšg.h
"

35 
	~"asylo/g½c/auth/cÜe/ş›Á_ek•_hªdshak”.h
"

36 
	~"asylo/g½c/auth/cÜe/£rv”_ek•_hªdshak”.h
"

37 
	~"asylo/id’t™y/desütiÚs.h
"

38 
	~"asylo/id’t™y/id’t™y_aş_ev®u©Ü.h
"

39 
	~"asylo/id’t™y/sgx/code_id’t™y_ut.h
"

40 
	~"asylo/id’t™y/sgx/£lf_id’t™y.h
"

41 
	~"asylo/id’t™y/sgx/sgx_code_id’t™y_ex³ù©iÚ_m©ch”.h
"

42 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

43 
	~"asylo/¶©fÜm/posix/memÜy/memÜy.h
"

44 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

45 
	~"asylo/ut/ş—nsšg_ty³s.h
"

46 
	~"asylo/ut/ş—nup.h
"

47 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

48 
	~"asylo/ut/¡©us.h
"

50 
usšg
 
	gA—dCry±Ü
 = 
asylo
::
ex³rim’l
::
A—dCry±Ü
;

52 
Çme¥aû
 
	gasylo
 {

53 
	gÇme¥aû
 {

57 
cÚ¡ex´
 
size_t
 
	gkSÇpshÙKeySize
 = 32;

61 
	g¡d
::
©omic
<
boŞ
> 
fÜk_»que¡ed
(
çl£
);

66 
	g¡d
::
©omic
<
boŞ
> 
¢­shÙ_key_Œªsãr_»que¡ed
(
çl£
);

68 cÚ¡ 
	gkSÇpshÙKeyAssocŸ‹dD©aBuf
[] = "AES256-GCM-SIV snapshot key";

71 
	gCËªsšgVeùÜ
<
	gušt8_t
> *
glob®_¢­shÙ_key
(
nuÎ±r
);

74 
	sTh»adMemÜyLayout
 {

77 *
	gth»ad_ba£
;

79 
size_t
 
	gth»ad_size
;

82 *
	g¡ack_ba£
;

85 *
	g¡ack_lim™
;

91 
Th»adMemÜyLayout
 
	gfÜked_th»ad_memÜy_Ïyout
 = {

92 
nuÎ±r
, 0,‚ullptr,‚ullptr};

95 
boŞ
 
CË¬FÜkReque¡ed
(è{  
	gfÜk_»que¡ed
.
exchªge
(
çl£
); }

99 
boŞ
 
CË¬SÇpshÙKeyT¿nsãrReque¡ed
() {

100  
	g¢­shÙ_key_Œªsãr_»que¡ed
.
exchªge
(
çl£
);

105 
S‘SÇpshÙKeyT¿nsãrReque¡ed
() {

106 
	g¢­shÙ_key_Œªsãr_»que¡ed
 = 
Œue
;

111 cÚ¡ 
Th»adMemÜyLayout
 
G‘Th»adLayoutFÜSÇpshÙ
() {

112  
	gfÜked_th»ad_memÜy_Ïyout
;

115 
D–‘eSÇpshÙKey
() {

116 ià(
	gglob®_¢­shÙ_key
) {

117 
d–‘e
 
	gglob®_¢­shÙ_key
;

119 
	gglob®_¢­shÙ_key
 = 
nuÎ±r
;

122 
boŞ
 
S‘SÇpshÙKey
(cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
key
) {

123 ià(
	gkey
.
size
(è!ğ
kSÇpshÙKeySize
) {

124  
çl£
;

126 
D–‘eSÇpshÙKey
();

127 
	gglob®_¢­shÙ_key
 = 
Ãw
 
CËªsšgVeùÜ
<
ušt8_t
>(
key
);

128  
	gŒue
;

131 
boŞ
 
G‘SÇpshÙKey
(
CËªsšgVeùÜ
<
ušt8_t
> *
key
) {

132 ià(!
	gglob®_¢­shÙ_key
) {

133  
	gçl£
;

135 *
	gkey
 = *
glob®_¢­shÙ_key
;

136  
	gŒue
;

145 
Stus
 
Enüy±ToUÁru¡edMemÜy
(
A—dCry±Ü
 *
üy±Ü
, cÚ¡ *
sourû_ba£
,

146 cÚ¡ 
size_t
 
sourû_size
,

147 
SÇpshÙLayoutEÁry
 *
¢­shÙ_’Œy
) {

148 
By‹CÚš”V›w
 
¶aš‹xt
(
sourû_ba£
, 
sourû_size
);

149 
	gmaximum_ch”‹xt_size
 = 
sourû_size
 + 
üy±Ü
->
MaxS—lOv”h—d
();

150 *
	gde¡š©iÚ_ba£
 = 
’c_uÁru¡ed_m®loc
(
maximum_ch”‹xt_size
);

151 
size_t
 
	gde¡š©iÚ_size
;

152 ià(!
	gde¡š©iÚ_ba£
) {

153  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

156 
size_t
 
	gnÚû_size
 = 
üy±Ü
->
NÚûSize
();

157 *
	gnÚû_ba£
 = 
’c_uÁru¡ed_m®loc
(
nÚû_size
);

158 ià(!
	gnÚû_ba£
) {

159  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

165 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
S—l
(

166 
¶aš‹xt
, 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
sourû_ba£
),

167 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
nÚû_ba£
), 
nÚû_size
),

168 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
de¡š©iÚ_ba£
),

169 
maximum_ch”‹xt_size
),

170 &
de¡š©iÚ_size
));

172 
	g¢­shÙ_’Œy
->
£t_ch”‹xt_ba£
(

173 
»š‹½»t_ÿ¡
<
ušt64_t
>(
de¡š©iÚ_ba£
));

174 
	g¢­shÙ_’Œy
->
£t_ch”‹xt_size
(
¡©ic_ÿ¡
<
ušt64_t
>(
de¡š©iÚ_size
));

175 
	g¢­shÙ_’Œy
->
£t_nÚû_ba£
(
»š‹½»t_ÿ¡
<
ušt64_t
>(
nÚû_ba£
));

176 
	g¢­shÙ_’Œy
->
£t_nÚû_size
(
¡©ic_ÿ¡
<
ušt64_t
>(
nÚû_size
));

177  
	gStus
::
OkStus
();

186 
Stus
 
Deüy±FromUÁru¡edMemÜy
(
A—dCry±Ü
 *
üy±Ü
,

187 
SÇpshÙLayoutEÁry
 
¢­shÙ_’Œy
,

188 *
de¡š©iÚ_ba£
,

189 
size_t
 
de¡š©iÚ_size
,

190 
size_t
 *
aùu®_¶aš‹xt_size
) {

193 *
	gsourû_ba£
 =

194 
»š‹½»t_ÿ¡
<*>(
¢­shÙ_’Œy
.
ch”‹xt_ba£
());

195 
size_t
 
	gsourû_size
 = 
¡©ic_ÿ¡
<size_t>(
¢­shÙ_’Œy
.
ch”‹xt_size
());

196 ià(!
’c_is_outside_’şave
(
sourû_ba£
, 
sourû_size
)) {

197  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

200 *
	gnÚû_ba£
 = 
»š‹½»t_ÿ¡
<*>(
¢­shÙ_’Œy
.
nÚû_ba£
());

201 
size_t
 
	gnÚû_size
 = 
¡©ic_ÿ¡
<size_t>(
¢­shÙ_’Œy
.
nÚû_size
());

202 ià(!
’c_is_outside_’şave
(
nÚû_ba£
, 
nÚû_size
)) {

203  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

206 
By‹CÚš”V›w
 
ch”‹xt
(
sourû_ba£
, 
sourû_size
);

207 
	g¡d
::
veùÜ
<
ušt8_t
> 
nÚû
(

208 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
nÚû_ba£
),

209 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
nÚû_ba£
è+ 
nÚû_size
);

213  
	güy±Ü
->
O³n
(

214 
ch”‹xt
, 
CÚv”tTrivŸlObjeùToBš¬ySŒšg
(
de¡š©iÚ_ba£
), 
nÚû
,

215 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
de¡š©iÚ_ba£
),

216 
de¡š©iÚ_size
),

217 
aùu®_¶aš‹xt_size
);

220 
CİyNÚOkStus
(cÚ¡ 
Stus
 &
nÚ_ok_¡©us
,

221 
”rÜ
::
GoogËE¼Ü
 *
”rÜ_code
, *
”rÜ_mes§ge
,

222 
size_t
 
mes§ge_bufãr_size
) {

223 *
	g”rÜ_code
 = 
nÚ_ok_¡©us
.
CªÚiÿlCode
();

224 
¡ºıy
(
”rÜ_mes§ge
, 
nÚ_ok_¡©us
.”rÜ_mes§ge().
d©a
(),

225 
¡d
::
mš
(
mes§ge_bufãr_size
, 
nÚ_ok_¡©us
.
”rÜ_mes§ge
().
size
()));

233 
Stus
 
Enüy±ToSÇpshÙ
(
A—dCry±Ü
 *
üy±Ü
, *
sourû_ba£
,

234 
size_t
 
sourû_size
,

235 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
SÇpshÙLayoutEÁry
> *
’Œy
) {

236 
size_t
 
by‹s_Ëá
 = 
sourû_size
;

237 
ušt8_t
 *
	gcu¼’t_pos™iÚ
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
sourû_ba£
);

239 
	gby‹s_Ëá
 > 0) {

240 
size_t
 
	g¶aš‹xt_size
 = 
¡d
::
mš
(
üy±Ü
->
MaxMes§geSize
(), 
by‹s_Ëá
);

241 
ASYLO_RETURN_IF_ERROR
(
Enüy±ToUÁru¡edMemÜy
(

242 
üy±Ü
, 
cu¼’t_pos™iÚ
, 
¶aš‹xt_size
, 
’Œy
->
Add
()));

244 
	gby‹s_Ëá
 -ğ
¶aš‹xt_size
;

245 
	gcu¼’t_pos™iÚ
 +ğ
¶aš‹xt_size
;

247  
	gStus
::
OkStus
();

254 
Stus
 
Deüy±FromSÇpshÙ
(

255 
A—dCry±Ü
 *
üy±Ü
, *
de¡š©iÚ_ba£
, 
size_t
 
de¡š©iÚ_size
,

256 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
SÇpshÙLayoutEÁry
> &
’Œy
) {

257 
ušt8_t
 *
cu¼’t_pos™iÚ
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
de¡š©iÚ_ba£
);

258 
size_t
 
	gby‹s_Ëá
 = 
de¡š©iÚ_size
;

260 
	gi
 = 0; i < 
	g’Œy
.
size
(è&& 
	gby‹s_Ëá
 > 0; ++i) {

264 
size_t
 
	gex³ùed_¶aš‹xt_size
 =

265 
¡d
::
mš
(
üy±Ü
->
MaxMes§geSize
(), 
by‹s_Ëá
);

267 ià(!
	gcu¼’t_pos™iÚ
 ||

268 !
’c_is_w™hš_’şave
(
cu¼’t_pos™iÚ
, 
ex³ùed_¶aš‹xt_size
)) {

269  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

273 
size_t
 
	gaùu®_¶aš‹xt_size
;

274 
ASYLO_RETURN_IF_ERROR
(
Deüy±FromUÁru¡edMemÜy
(

275 
üy±Ü
, 
’Œy
[
i
], 
cu¼’t_pos™iÚ
, 
ex³ùed_¶aš‹xt_size
,

276 &
aùu®_¶aš‹xt_size
));

277 ià(
	gaùu®_¶aš‹xt_size
 !ğ
ex³ùed_¶aš‹xt_size
) {

278  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

281 
	gby‹s_Ëá
 -ğ
aùu®_¶aš‹xt_size
;

282 
	gcu¼’t_pos™iÚ
 +ğ
aùu®_¶aš‹xt_size
;

284  
	gStus
::
OkStus
();

289 
boŞ
 
IsSecu»FÜkSuµÜ‹d
(è{  
	gŒue
; }

293 
SaveTh»adLayoutFÜSÇpshÙ
() {

294 
EnşaveMemÜyLayout
 
	g’şave_memÜy_Ïyout
;

295 
’c_g‘_memÜy_Ïyout
(&
’şave_memÜy_Ïyout
);

296 
Th»adMemÜyLayout
 
	gth»ad_memÜy_Ïyout
;

297 
	gth»ad_memÜy_Ïyout
.
	gth»ad_ba£
 = 
’şave_memÜy_Ïyout
.
th»ad_ba£
;

298 
	gth»ad_memÜy_Ïyout
.
	gth»ad_size
 = 
’şave_memÜy_Ïyout
.
th»ad_size
;

299 
	gth»ad_memÜy_Ïyout
.
	g¡ack_ba£
 = 
’şave_memÜy_Ïyout
.
¡ack_ba£
;

300 
	gth»ad_memÜy_Ïyout
.
	g¡ack_lim™
 = 
’şave_memÜy_Ïyout
.
¡ack_lim™
;

301 
	gfÜked_th»ad_memÜy_Ïyout
 = 
th»ad_memÜy_Ïyout
;

304 
S‘FÜkReque¡ed
(è{ 
	gfÜk_»que¡ed
 = 
Œue
; }

308 
Stus
 
TakeSÇpshÙFÜFÜk
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
) {

311 ià(!
CË¬FÜkReque¡ed
()) {

312  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

317 
CËªup
 
unblock_eÿÎs
(
’c_unblock_eÿÎs
);

320 
’c_block_eÿÎs
();

326 ià(
g‘_aùive_’şave_’Œ›s
() > 2) {

327 
LOG
(
WARNING
è<< "Th”¬" << 
g‘_aùive_’şave_’Œ›s
()

334 ià(!
	g¢­shÙ_Ïyout
) {

335  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

340 
EnşaveMemÜyLayout
 
	g’şave_Ïyout
;

341 
’c_g‘_memÜy_Ïyout
(&
’şave_Ïyout
);

342 ià(!
	g’şave_Ïyout
.
	gd©a_ba£
 ||ƒnşave_Ïyout.
	gd©a_size
 <= 0) {

343  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

346 ià(!
	g’şave_Ïyout
.
	gbss_ba£
 ||ƒnşave_Ïyout.
	gbss_size
 <= 0) {

347  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

350 ià(!
	g’şave_Ïyout
.
	gh—p_ba£
 ||ƒnşave_Ïyout.
	gh—p_size
 <= 0) {

351  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Can't findƒnclave heap");

354 
Th»adMemÜyLayout
 
	gth»ad_Ïyout
 = 
G‘Th»adLayoutFÜSÇpshÙ
();

356 ià(!
	gth»ad_Ïyout
.
	gth»ad_ba£
 ||h»ad_Ïyout.
	gth»ad_size
 <= 0) {

357  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

361 ià(!
	gth»ad_Ïyout
.
	g¡ack_ba£
 || !th»ad_Ïyout.
	g¡ack_lim™
) {

362  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

366 ià(
	g’şave_Ïyout
.
	g»£rved_d©a_size
 <ƒnşave_Ïyout.
	gd©a_size
) {

367  
Stus
(

368 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

372 ià(
	g’şave_Ïyout
.
	g»£rved_bss_size
 <ƒnşave_Ïyout.
	gbss_size
) {

373  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

378 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
¢­shÙ_key
(
kSÇpshÙKeySize
);

379 ià(!
RAND_by‹s
(
¢­shÙ_key
.
d©a
(), 
kSÇpshÙKeySize
)) {

380  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

381 
ab¦
::
SŒC©
("Can‚ot generatehe snapshot key: ",

382 
Bs¦La¡E¼ÜSŒšg
()));

384 ià(!
S‘SÇpshÙKey
(
¢­shÙ_key
)) {

385  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

392 
memıy
(
’şave_Ïyout
.
»£rved_d©a_ba£
,ƒnşave_Ïyout.
d©a_ba£
,

393 
’şave_Ïyout
.
d©a_size
);

395 
memıy
(
’şave_Ïyout
.
»£rved_bss_ba£
,ƒnşave_Ïyout.
bss_ba£
,

396 
’şave_Ïyout
.
bss_size
);

400 
	g”rÜ
::
GoogËE¼Ü
 
”rÜ_code
 = 
”rÜ
::GoogËE¼Ü::
OK
;

401 
	g”rÜ_mes§ge
[1024];

406 
h—p_sw™ch
(
’şave_Ïyout
.
»£rved_h—p_ba£
,

407 
’şave_Ïyout
.
»£rved_h—p_size
);

417 
SÇpshÙLayout
 
	gtmp_¢­shÙ_Ïyout
;

421 autØ
	güy±Ü_»suÉ
 = 
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
¢­shÙ_key
);

422 ià(!
	güy±Ü_»suÉ
.
ok
()) {

423 
CİyNÚOkStus
(
üy±Ü_»suÉ
.
¡©us
(), &
”rÜ_code
, 
”rÜ_mes§ge
,

424 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

427 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
 =

428 
¡d
::
move
(
üy±Ü_»suÉ
.
V®ueOrD›
());

431 
Stus
 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(

432 
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_d©a_ba£
,

433 
’şave_Ïyout
.
d©a_size
, 
tmp_¢­shÙ_Ïyout
.
mubË_d©a
());

435 ià(!
	g¡©us
.
ok
()) {

436 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

437 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

442 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_bss_ba£
,

443 
’şave_Ïyout
.
bss_size
,

444 
tmp_¢­shÙ_Ïyout
.
mubË_bss
());

446 ià(!
	g¡©us
.
ok
()) {

447 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

448 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

453 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
th»ad_ba£
,

454 
th»ad_Ïyout
.
th»ad_size
,

455 
tmp_¢­shÙ_Ïyout
.
mubË_th»ad
());

457 ià(!
	g¡©us
.
ok
()) {

458 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

459 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

464 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
h—p_ba£
,

465 
’şave_Ïyout
.
h—p_size
,

466 
tmp_¢­shÙ_Ïyout
.
mubË_h—p
());

468 ià(!
	g¡©us
.
ok
()) {

469 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

470 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

475 
size_t
 
	g¡ack_size
 = 
»š‹½»t_ÿ¡
<size_t>(
th»ad_Ïyout
.
¡ack_ba£
) -

476 
»š‹½»t_ÿ¡
<
size_t
>(
th»ad_Ïyout
.
¡ack_lim™
);

478 
	g¡©us
 = 
Enüy±ToSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
¡ack_lim™
,

479 
¡ack_size
, 
tmp_¢­shÙ_Ïyout
.
mubË_¡ack
());

481 ià(!
	g¡©us
.
ok
()) {

482 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

483 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

489 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

490 *
	g¢­shÙ_Ïyout
 = 
tmp_¢­shÙ_Ïyout
;

494 
h—p_sw™ch
(
’şave_Ïyout
.
»£rved_h—p_ba£
,

495 
’şave_Ïyout
.
»£rved_h—p_size
);

499 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

500 ià(
	g”rÜ_code
 !ğ
”rÜ
::
GoogËE¼Ü
::
OK
) {

501  
Stus
(
”rÜ_code
, 
”rÜ_mes§ge
);

506 
S‘SÇpshÙKeyT¿nsãrReque¡ed
();

507  
	gStus
::
OkStus
();

513 
Stus
 
Deüy±AndRe¡ÜeEnşaveD©aBssH—p
(

514 cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
,

515 cÚ¡ 
EnşaveMemÜyLayout
 &
’şave_Ïyout
,

516 cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
¢­shÙ_key
) {

519 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

520 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

521 
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
¢­shÙ_key
));

525 
ASYLO_RETURN_IF_ERROR
(

526 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_d©a_ba£
,

527 
’şave_Ïyout
.
d©a_size
, 
¢­shÙ_Ïyout
.
d©a
()));

531 
ASYLO_RETURN_IF_ERROR
(

532 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
»£rved_bss_ba£
,

533 
’şave_Ïyout
.
bss_size
, 
¢­shÙ_Ïyout
.
bss
()));

537 
ASYLO_RETURN_IF_ERROR
(

538 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
’şave_Ïyout
.
h—p_ba£
,

539 
’şave_Ïyout
.
h—p_size
, 
¢­shÙ_Ïyout
.
h—p
()));

541 *
	gsw™ched_h—p_Ãxt
 = 
G‘Sw™chedH—pNext
();

542 
size_t
 
	gsw™ched_h—p_»maššg
 = 
G‘Sw™chedH—pRemaššg
();

545 
memıy
(
’şave_Ïyout
.
d©a_ba£
,ƒnşave_Ïyout.
»£rved_d©a_ba£
,

546 
’şave_Ïyout
.
d©a_size
);

547 
memıy
(
’şave_Ïyout
.
bss_ba£
,ƒnşave_Ïyout.
»£rved_bss_ba£
,

548 
’şave_Ïyout
.
bss_size
);

553 
h—p_sw™ch
(
sw™ched_h—p_Ãxt
, 
sw™ched_h—p_»maššg
);

554  
	gStus
::
OkStus
();

560 
Stus
 
Deüy±AndRe¡ÜeTh»adSck
(

561 cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
,

562 cÚ¡ 
CËªsšgVeùÜ
<
ušt8_t
> &
¢­shÙ_key
) {

563 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

564 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

565 
A—dCry±Ü
::
C»©eAesGcmSivCry±Ü
(
¢­shÙ_key
));

569 
Th»adMemÜyLayout
 
	gth»ad_Ïyout
 = 
G‘Th»adLayoutFÜSÇpshÙ
();

574 
ASYLO_RETURN_IF_ERROR
(

575 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
th»ad_ba£
,

576 
th»ad_Ïyout
.
th»ad_size
, 
¢­shÙ_Ïyout
.
th»ad
()));

579 
size_t
 
	g¡ack_size
 = 
»š‹½»t_ÿ¡
<size_t>(
th»ad_Ïyout
.
¡ack_ba£
) -

580 
»š‹½»t_ÿ¡
<
size_t
>(
th»ad_Ïyout
.
¡ack_lim™
);

581 
ASYLO_RETURN_IF_ERROR
(

582 
Deüy±FromSÇpshÙ
(
üy±Ü
.
g‘
(), 
th»ad_Ïyout
.
¡ack_lim™
, 
¡ack_size
,

583 
¢­shÙ_Ïyout
.
¡ack
()));

585  
	gStus
::
OkStus
();

589 
Stus
 
Re¡ÜeFÜFÜk
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
) {

593 
’c_block_eÿÎs
();

597 ià(
g‘_aùive_’şave_’Œ›s
() != 1) {

598 
LOG
(
INFO
è<< "’Œ˜num : " << 
g‘_aùive_’şave_’Œ›s
() ;

607 
EnşaveMemÜyLayout
 
	g’şave_Ïyout
;

608 
’c_g‘_memÜy_Ïyout
(&
’şave_Ïyout
);

610 
	g”rÜ
::
GoogËE¼Ü
 
”rÜ_code
 = 
”rÜ
::GoogËE¼Ü::
OK
;

611 
	g”rÜ_mes§ge
[1024];

615 
h—p_sw™ch
(
’şave_Ïyout
.
»£rved_h—p_ba£
,

616 
’şave_Ïyout
.
»£rved_h—p_size
);

625 
	gasylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout
;

626 ià(!
	g¢­shÙ_Ïyout
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

627 
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

629 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

630 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

635 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g¢­shÙ_key
;

637 ià(!
G‘SÇpshÙKey
(&
¢­shÙ_key
)) {

638 
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

640 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

641 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

647 
Stus
 
	g¡©us
 = 
Deüy±AndRe¡ÜeEnşaveD©aBssH—p
(

648 
¢­shÙ_Ïyout
, 
’şave_Ïyout
, 
¢­shÙ_key
);

649 ià(!
	g¡©us
.
ok
()) {

650 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

651 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

658 
	g¡©us
 = 
Deüy±AndRe¡ÜeTh»adSck
(
¢­shÙ_Ïyout
, 
¢­shÙ_key
);

659 ià(!
	g¡©us
.
ok
()) {

660 
CİyNÚOkStus
(
¡©us
, &
”rÜ_code
, 
”rÜ_mes§ge
,

661 
ABSL_ARRAYSIZE
(
”rÜ_mes§ge
));

667 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

668 ià(
	g”rÜ_code
 !ğ
”rÜ
::
GoogËE¼Ü
::
OK
) {

669  
Stus
(
”rÜ_code
, 
”rÜ_mes§ge
);

676 
’c_unblock_eÿÎs
();

678  
	gStus
::
OkStus
();

682 
Stus
 
RunEk•Hªdshake
(
Ek•Hªdshak”
 *
hªdshak”
, 
boŞ
 
is_·»Á
,

683 
sock‘
) {

684 
	g¡d
::
¡ršg
 
outgošg_by‹s
;

687 
	gEk•Hªdshak”
::
ResuÉ
 
»suÉ
 = 
Ek•Hªdshak”
::ResuÉ::
IN_PROGRESS
;

689 ià(
	gis_·»Á
) {

690 
	g»suÉ
 = 
hªdshak”
->
NextHªdshakeS‹p
(
nuÎ±r
, 0, &
outgošg_by‹s
);

691 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
ABORTED
) {

692  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "EKEP handshake has‡borted");

697 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
outgošg_by‹s
.
c_¡r
(),

698 
outgošg_by‹s
.
size
()) <= 0) {

699  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Write failed");

704 
	gbuf
[1024];

705 
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
IN_PROGRESS
) {

707 
outgošg_by‹s
.
ş—r
();

710 
ssize_t
 
	gby‹s_»ûived
 =

711 
’c_uÁru¡ed_»cväom
(
sock‘
, 
buf
, (buf), 
MSG_PEEK
,

712  
nuÎ±r
,‚ullptr);

713 ià(
	gby‹s_»ûived
 <= 0) {

714  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Read failed");

716 
	g»suÉ
 =

717 
hªdshak”
->
NextHªdshakeS‹p
(
buf
, 
by‹s_»ûived
, &
outgošg_by‹s
);

719 
	gby‹s_u£d
 = 
by‹s_»ûived
;

720 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
COMPLETED
) {

724 autØ
unu£d_by‹s_»suÉ
 = 
hªdshak”
->
G‘Unu£dBy‹s
();

725 ià(!
	gunu£d_by‹s_»suÉ
.
ok
()) {

726  
	gunu£d_by‹s_»suÉ
.
¡©us
();

728 
size_t
 
	gunu£d_by‹s_size
 = 
unu£d_by‹s_»suÉ
.
V®ueOrD›
().
size
();

729 
	gby‹s_u£d
 -ğ
unu£d_by‹s_size
;

732 
’c_uÁru¡ed_»cväom
(
sock‘
, 
buf
, 
by‹s_u£d
, 0,

733  
nuÎ±r
,‚ullptr);

734 } 
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
NOT_ENOUGH_DATA
);

736 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
ABORTED
) {

737  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "EKEP handshake has‡borted");

740 ià(
	g»suÉ
 =ğ
Ek•Hªdshak”
::
ResuÉ
::
COMPLETED
 && !
is_·»Á
) {

746 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
outgošg_by‹s
.
c_¡r
(),

747 
outgošg_by‹s
.
size
()) <= 0) {

748  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Write failed");

751  
	gStus
::
OkStus
();

758 
Stus
 
Com·»P“rAndS–fId’t™y
(cÚ¡ 
EnşaveId’t™y
 &
³”_id’t™y
) {

759 
	gsgx
::
CodeId’t™yEx³ù©iÚ
 
code_id’t™y_ex³ù©iÚ
;

760 
	gsgx
::
S‘SŒiùS–fCodeId’t™yEx³ù©iÚ
(&
code_id’t™y_ex³ù©iÚ
);

761 
EnşaveId’t™yEx³ù©iÚ
 
	g’şave_id’t™y_ex³ù©iÚ
;

762 
ASYLO_RETURN_IF_ERROR
(
sgx
::
S”ŸlizeSgxEx³ù©iÚ
(

763 
code_id’t™y_ex³ù©iÚ
, &
’şave_id’t™y_ex³ù©iÚ
));

764 
Id’t™yAşP»diÿ‹
 
	g´ediÿ‹
;

765 *
	g´ediÿ‹
.
mubË_ex³ù©iÚ
(èğ
’şave_id’t™y_ex³ù©iÚ
;

766 
SgxCodeId’t™yEx³ù©iÚM©ch”
 
	gsgx_m©ch”
;

768 autØ
	gaş_»suÉ
 =

769 
Ev®u©eId’t™yAş
({
³”_id’t™y
}, 
´ediÿ‹
, 
sgx_m©ch”
);

770 ià(!
	gaş_»suÉ
.
ok
()) {

771  
	gaş_»suÉ
.
¡©us
();

773 ià(!
	gaş_»suÉ
.
V®ueOrD›
()) {

774  
Stus
(

775 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

778  
	gStus
::
OkStus
();

782 
Stus
 
Enüy±AndS’dSÇpshÙKey
(
¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
,

783 
sock‘
) {

784 *
	g±r
;

785 
CËªup
 
d–‘e_¢­shÙ_key
(
D–‘eSÇpshÙKey
);

786 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
¢­shÙ_key
(
kSÇpshÙKeySize
);

787 ià(!
G‘SÇpshÙKey
(&
¢­shÙ_key
)) {

788  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo get snapshot key");

792 
By‹CÚš”V›w
 
assocŸ‹d_d©a
(
kSÇpshÙKeyAssocŸ‹dD©aBuf
,

793 (
kSÇpshÙKeyAssocŸ‹dD©aBuf
));

795 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_ch”‹xt
(
kSÇpshÙKeySize
 +

796 
üy±Ü
->
MaxS—lOv”h—d
());

797 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_nÚû
(
üy±Ü
->
NÚûSize
());

798 
size_t
 
	g’üy±ed_¢­shÙ_key_size
;

800 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
S—l
(

801 
¢­shÙ_key
, 
assocŸ‹d_d©a
, 
ab¦
::
MakeS·n
(
¢­shÙ_key_nÚû
),

802 
ab¦
::
MakeS·n
(
¢­shÙ_key_ch”‹xt
), &
’üy±ed_¢­shÙ_key_size
));

803 
	g¢­shÙ_key_ch”‹xt
.
»size
(
’üy±ed_¢­shÙ_key_size
);

806 
Enüy±edSÇpshÙKey
 
	g’üy±ed_¢­shÙ_key
;

807 
	g’üy±ed_¢­shÙ_key
.
£t_ch”‹xt
(
¢­shÙ_key_ch”‹xt
.
d©a
(),

808 
’üy±ed_¢­shÙ_key_size
);

809 
	g’üy±ed_¢­shÙ_key
.
£t_nÚû
(
¢­shÙ_key_nÚû
.
d©a
(),

810 
¢­shÙ_key_nÚû
.
size
());

812 
	g¡d
::
¡ršg
 
’üy±ed_¢­shÙ_key_¡ršg
;

813 ià(!
	g’üy±ed_¢­shÙ_key
.
S”ŸlizeToSŒšg
(

814 &
’üy±ed_¢­shÙ_key_¡ršg
)) {

815  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

819 
	gfd
 = 
’c_uÁru¡ed_İ’
("/tmp/¢­_key", 
O_WRONLY
);

820 
’c_uÁru¡ed_wr™e
(
fd
,

821 
’üy±ed_¢­shÙ_key_¡ršg
.
d©a
(),

822 
’üy±ed_¢­shÙ_key_¡ršg
.
size
());

823 
şo£
(
fd
);

826 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
’üy±ed_¢­shÙ_key_¡ršg
.
d©a
(),

827 
’üy±ed_¢­shÙ_key_¡ršg
.
size
()) <= 0) {

828  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Write failed");

831  
	gStus
::
OkStus
();

835 
Stus
 
ReûiveSÇpshÙKey
(
¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
, 
sock‘
) {

837 
	gbuf
[1024];

838 *
	g±r
;

839 
	grc
 = 
’c_uÁru¡ed_»ad
(
sock‘
, 
buf
, (buf));

840 ià(
	grc
 <= 0) {

841  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "Read failed");

845 
	gfd
;

846 
	gfd
 = 
’c_uÁru¡ed_İ’
("/tmp/¢­_key", 
O_RDONLY
);

847 
	grc
 = 
’c_uÁru¡ed_»ad
(
fd
, 
buf
, (buf));

848 
	g±r
 = (*)
buf
;

849 
şo£
(
fd
);

851 
Enüy±edSÇpshÙKey
 
	g’üy±ed_¢­shÙ_key
;

852 ià(!
	g’üy±ed_¢­shÙ_key
.
P¬£FromA¼ay
(
buf
, 
rc
)) {

853  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

858 
	g¡d
::
¡ršg
 
’üy±ed_¢­shÙ_key_¡ršg
;

859 ià(!
	g’üy±ed_¢­shÙ_key
.
S”ŸlizeToSŒšg
(

860 &
’üy±ed_¢­shÙ_key_¡ršg
)) {

861  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

866 
By‹CÚš”V›w
 
assocŸ‹d_d©a
(
kSÇpshÙKeyAssocŸ‹dD©aBuf
,

867 (
kSÇpshÙKeyAssocŸ‹dD©aBuf
));

869 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_ch”‹xt
(

870 
’üy±ed_¢­shÙ_key
.
ch”‹xt
().
cbegš
(),

871 
’üy±ed_¢­shÙ_key
.
ch”‹xt
().
ûnd
());

872 
	g¡d
::
veùÜ
<
ušt8_t
> 
¢­shÙ_key_nÚû
(

873 
’üy±ed_¢­shÙ_key
.
nÚû
().
cbegš
(),

874 
’üy±ed_¢­shÙ_key
.
nÚû
().
ûnd
());

875 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
¢­shÙ_key
(
¢­shÙ_key_ch”‹xt
.
size
());

876 
size_t
 
	g¢­shÙ_key_size
;

877 
ASYLO_RETURN_IF_ERROR
(
üy±Ü
->
O³n
(

878 
¢­shÙ_key_ch”‹xt
, 
assocŸ‹d_d©a
, 
¢­shÙ_key_nÚû
,

879 
ab¦
::
MakeS·n
(
¢­shÙ_key
), &
¢­shÙ_key_size
));

880 
	g¢­shÙ_key
.
»size
(
¢­shÙ_key_size
);

884 ià(!
S‘SÇpshÙKey
(
¢­shÙ_key
)) {

885  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

888  
	gStus
::
OkStus
();

895 
Stus
 
T¿nsãrSecu»SÇpshÙKey
(

896 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
) {

897 ià(!
	gfÜk_hªdshake_cÚfig
.
has_is_·»Á
() ||

898 !
	gfÜk_hªdshake_cÚfig
.
has_sock‘
()) {

899  
Stus
(

900 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

904 ià(
	gfÜk_hªdshake_cÚfig
.
sock‘
() < 0) {

905  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

909 
boŞ
 
	gis_·»Á
 = 
fÜk_hªdshake_cÚfig
.
is_·»Á
();

913 ià(
	gis_·»Á
 && !
CË¬SÇpshÙKeyT¿nsãrReque¡ed
()) {

914  
Stus
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

919 
As£¹iÚDesütiÚ
 
	gdesütiÚ
;

920 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(&
desütiÚ
);

922 
Ek•Hªdshak”O±iÚs
 
	gİtiÚs
;

923 
	gİtiÚs
.
	g£lf_as£¹iÚs
.
push_back
(
desütiÚ
);

924 
	gİtiÚs
.
	gacû±ed_³”_as£¹iÚs
.
push_back
(
desütiÚ
);

929 
	g¡d
::
unique_±r
<
Ek•Hªdshak”
> 
hªdshak”
;

930 ià(
	gis_·»Á
) {

931 
	ghªdshak”
 = 
Cl›ÁEk•Hªdshak”
::
C»©e
(
İtiÚs
);

933 
	ghªdshak”
 = 
S”v”Ek•Hªdshak”
::
C»©e
(
İtiÚs
);

936 
ASYLO_RETURN_IF_ERROR
(
RunEk•Hªdshake
(
hªdshak”
.
g‘
(), 
is_·»Á
,

937 
fÜk_hªdshake_cÚfig
.
sock‘
()));

941 
EnşaveId’t™y
 
	g³”_id’t™y
 =

942 
hªdshak”
->
G‘P“rId’t™›s
().
V®ueOrD›
()->
id’t™›s
(0);

944 
ASYLO_RETURN_IF_ERROR
(
Com·»P“rAndS–fId’t™y
(
³”_id’t™y
));

948 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g»cÜd_´ÙocŞ_key
;

949 
ASYLO_ASSIGN_OR_RETURN
(
»cÜd_´ÙocŞ_key
,

950 
hªdshak”
->
G‘RecÜdPrÙocŞKey
());

951 
	g¡d
::
unique_±r
<
A—dCry±Ü
> 
üy±Ü
;

952 
ASYLO_ASSIGN_OR_RETURN
(
üy±Ü
,

953 
A—dCry±Ü
::
C»©eAesGcmCry±Ü
(
»cÜd_´ÙocŞ_key
));

955 ià(
	gis_·»Á
) {

956  
Enüy±AndS’dSÇpshÙKey
(
¡d
::
move
(
üy±Ü
),

957 
fÜk_hªdshake_cÚfig
.
sock‘
());

959  
ReûiveSÇpshÙKey
(
¡d
::
move
(
üy±Ü
),

960 
fÜk_hªdshake_cÚfig
.
sock‘
());

964 
pid_t
 
’c_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

966 
	gasylo
::
SaveTh»adLayoutFÜSÇpshÙ
();

969 
S‘FÜkReque¡ed
();

970 
	g¡d
::
¡ršg
 
buf
;

971 ià(!
	gcÚfig
.
S”ŸlizeToSŒšg
(&
buf
)) {

972 
	g”ºo
 = 
EFAULT
;

976  
’c_uÁru¡ed_fÜk
(
’şave_Çme
, 
buf
.
d©a
(), buf.
size
(),

977  
Œue
);

	@platform/arch/sgx/trusted/hardware_random.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/h¬dw¬e_¿ndom.h
"

21 
	~<immšŒš.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<®gÜ™hm
>

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
rd¿nd64
(*
out
) {

31 
cÚ¡ex´
 
	gkRªdR‘r›s
 = 10;

32 
	gi
 = 0; i < 
	gkRªdR‘r›s
; ++i) {

33 ià(
_rd¿nd64_¡•
(
¡©ic_ÿ¡
<*>(
out
))) {

38 
abÜt
();

41 
ušt64_t
 
rd¿nd64
() {

42 
ušt64_t
 
	g‹mp
;

43 
rd¿nd64
(&
‹mp
);

45  
	g‹mp
;

49 
C®cuÏ‹Alignm’t
(cÚ¡ *
buf
, 
size_t
 
size
, size_ˆ
®ign_size
,

50 
size_t
 *
uÇligÃd_by‹s
, size_ˆ*
®igÃd_couÁ
,

51 
size_t
 *
·¹Ÿl_by‹s
) {

53 *
	guÇligÃd_by‹s
 = (~
»š‹½»t_ÿ¡
<
ušŒ_t
>(
buf
è+ 1è% 
®ign_size
;

54 *
	guÇligÃd_by‹s
 = 
¡d
::
mš
(*
uÇligÃd_by‹s
, 
size
);

55 *
	g®igÃd_couÁ
 = (
size
 - *
uÇligÃd_by‹s
è/ 
®ign_size
;

56 *
	g·¹Ÿl_by‹s
 = 
size
 - *
uÇligÃd_by‹s
 - (*
®igÃd_couÁ
 * 
®ign_size
);

62 "C" 
ssize_t
 
’c_h¬dw¬e_¿ndom
(
ušt8_t
 *
buf
, 
size_t
 
couÁ
) {

63 
size_t
 
uÇligÃd_by‹s
;

64 
size_t
 
®igÃd_couÁ
;

65 
size_t
 
·¹Ÿl_by‹s
;

66 
C®cuÏ‹Alignm’t
(
buf
, 
couÁ
, (
ušt64_t
), &
uÇligÃd_by‹s
,

67 &
®igÃd_couÁ
, &
·¹Ÿl_by‹s
);

70 
ušt8_t
 *
by‹_buf
 = 
¡©ic_ÿ¡
<ušt8_ˆ*>(
buf
);

73 ià(
uÇligÃd_by‹s
) {

74 
ušt64_t
 
‹mp
 = 
rd¿nd64
();

75 
memıy
(&
by‹_buf
[0], &
‹mp
, 
uÇligÃd_by‹s
);

79 
ušt8_t
 *
®igÃd_’d
 = &
by‹_buf
[
couÁ
 - 
·¹Ÿl_by‹s
];

80 
ušt8_t
 *
®igÃd_buf
 = &
by‹_buf
[
uÇligÃd_by‹s
];

81 
®igÃd_buf
 < 
®igÃd_’d
;‡ligÃd_buà+ğ(
ušt64_t
)) {

82 
rd¿nd64
(
®igÃd_buf
);

86 ià(
·¹Ÿl_by‹s
) {

87 
ušt64_t
 
‹mp
 = 
rd¿nd64
();

88 
memıy
(
®igÃd_’d
, &
‹mp
, 
·¹Ÿl_by‹s
);

91  
couÁ
;

	@platform/arch/sgx/trusted/hardware_random.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/h¬dw¬e_¿ndom.h
"

21 
	~<immšŒš.h
>

22 
	~<¡dlib.h
>

23 
	~<¡ršg.h
>

24 
	~<®gÜ™hm
>

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
rd¿nd64
(*
out
) {

31 
cÚ¡ex´
 
	gkRªdR‘r›s
 = 10;

32 
	gi
 = 0; i < 
	gkRªdR‘r›s
; ++i) {

33 ià(
_rd¿nd64_¡•
(
¡©ic_ÿ¡
<*>(
out
))) {

38 
abÜt
();

41 
ušt64_t
 
rd¿nd64
() {

42 
ušt64_t
 
	g‹mp
;

43 
rd¿nd64
(&
‹mp
);

45  
	g‹mp
;

49 
C®cuÏ‹Alignm’t
(cÚ¡ *
buf
, 
size_t
 
size
, size_ˆ
®ign_size
,

50 
size_t
 *
uÇligÃd_by‹s
, size_ˆ*
®igÃd_couÁ
,

51 
size_t
 *
·¹Ÿl_by‹s
) {

53 *
	guÇligÃd_by‹s
 = (~
»š‹½»t_ÿ¡
<
ušŒ_t
>(
buf
è+ 1è% 
®ign_size
;

54 *
	guÇligÃd_by‹s
 = 
¡d
::
mš
(*
uÇligÃd_by‹s
, 
size
);

55 *
	g®igÃd_couÁ
 = (
size
 - *
uÇligÃd_by‹s
è/ 
®ign_size
;

56 *
	g·¹Ÿl_by‹s
 = 
size
 - *
uÇligÃd_by‹s
 - (*
®igÃd_couÁ
 * 
®ign_size
);

62 "C" 
ssize_t
 
’c_h¬dw¬e_¿ndom
(
ušt8_t
 *
buf
, 
size_t
 
couÁ
) {

63 
size_t
 
uÇligÃd_by‹s
;

64 
size_t
 
®igÃd_couÁ
;

65 
size_t
 
·¹Ÿl_by‹s
;

66 
C®cuÏ‹Alignm’t
(
buf
, 
couÁ
, (
ušt64_t
), &
uÇligÃd_by‹s
,

67 &
®igÃd_couÁ
, &
·¹Ÿl_by‹s
);

70 
ušt8_t
 *
by‹_buf
 = 
¡©ic_ÿ¡
<ušt8_ˆ*>(
buf
);

73 ià(
uÇligÃd_by‹s
) {

74 
ušt64_t
 
‹mp
 = 
rd¿nd64
();

75 
memıy
(&
by‹_buf
[0], &
‹mp
, 
uÇligÃd_by‹s
);

79 
ušt8_t
 *
®igÃd_’d
 = &
by‹_buf
[
couÁ
 - 
·¹Ÿl_by‹s
];

80 
ušt8_t
 *
®igÃd_buf
 = &
by‹_buf
[
uÇligÃd_by‹s
];

81 
®igÃd_buf
 < 
®igÃd_’d
;‡ligÃd_buà+ğ(
ušt64_t
)) {

82 
rd¿nd64
(
®igÃd_buf
);

86 ià(
·¹Ÿl_by‹s
) {

87 
ušt64_t
 
‹mp
 = 
rd¿nd64
();

88 
memıy
(
®igÃd_’d
, &
‹mp
, 
·¹Ÿl_by‹s
);

91  
couÁ
;

	@platform/arch/sgx/trusted/host_calls.cc

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~<”ºo.h
>

27 
	~<fú.h
>

28 
	~<pŞl.h
>

29 
	~<pwd.h
>

30 
	~<¡d¬g.h
>

31 
	~<¡dšt.h
>

32 
	~<¡dio.h
>

33 
	~<¡dlib.h
>

34 
	~<sys/sock‘.h
>

35 
	~<sys/¡©.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/ut¢ame.h
>

38 
	~<uni¡d.h
>

39 
	~<utime.h
>

41 
	~<c¡ršg
>

42 
	~<¡ršg
>

43 
	~<veùÜ
>

45 
	~"ab¦/memÜy/memÜy.h
"

46 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

47 
	~"asylo/ut/loggšg.h
"

48 
	~"asylo/¶©fÜm/¬ch/sgx/Œu¡ed/g’”©ed_bridge_t.h
"

49 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

50 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

51 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

52 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

53 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

54 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

55 
	~"asylo/ut/¡©us.h
"

56 
	~"šşude/sgx_Œts.h
"

58 
Çme¥aû
 
	gasylo
 {

59 
	gÇme¥aû
 {

61 
	#CHECK_OCALL
(
¡©us_
) \

63 
sgx_¡©us_t
 
¡©us
##
__COUNTER__
 = 
¡©us_
; \

64 ià(
¡©us
##
__COUNTER__
 !ğ
SGX_SUCCESS
) { \

65 
	`’c_uÁru¡ed_puts
( \

66 
ab¦
::
	`SŒC©
( \

67 
__FILE__
, ":", 
__LINE__
, ": ", \

68 
asylo
::
	`Stus
(
¡©us
##
__COUNTER__
, "oÿÎ faed").
	`ToSŒšg
()) \

69 .
	`c_¡r
()); \

70 
	`abÜt
(); \

72 } 0)

	)

76 
·sswd
 
	gglob®_·sswÜd
;

87 *
’c_uÁru¡ed_m®loc
(
size_t
 
size
) {

88 *
»suÉ
;

89 
CHECK_OCALL
(

90 
oÿÎ_’c_uÁru¡ed_m®loc
(&
»suÉ
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
)));

91 ià(
»suÉ
 &&

92 !
sgx_is_outside_’şave
(
»suÉ
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
))) {

93 
abÜt
();

95 ià(!
»suÉ
) {

96 
abÜt
();

98  
»suÉ
;

101 **
’c_uÁru¡ed_®loÿ‹_bufãrs
(
size_t
 
couÁ
, size_ˆ
size
) {

102 **
bufãrs
;

103 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_®loÿ‹_bufãrs
(

104 &
bufãrs
,

105 
¡©ic_ÿ¡
<
bridge_size_t
>(
couÁ
),

106 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
)));

107 ià(!
bufãrs
 || !
sgx_is_outside_’şave
(bufãrs, 
size
)) {

108 
abÜt
();

110  
bufãrs
;

113 
’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(**
ä“_li¡
, 
size_t
 
couÁ
) {

114 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(

115 
ä“_li¡
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
couÁ
)));

118 
’c_uÁru¡ed_İ’
(cÚ¡ *
·th_Çme
, 
æags
, ...) {

119 
ušt32_t
 
mode
 = 0;

120 ià(
æags
 & 
O_CREAT
) {

121 
va_li¡
 
­
;

122 
va_¡¬t
(
­
, 
æags
);

123 
mode
 = 
va_¬g
(
­
, 
mode_t
);

124 
va_’d
(
­
);

127 
bridge_æags
 = 
asylo
::
ToBridgeFeFÏgs
(
æags
);

128 
»suÉ
;

129 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_İ’
(&
»suÉ
, 
·th_Çme
, 
bridge_æags
, 
mode
));

130  
»suÉ
;

133 
’c_uÁru¡ed_puts
(cÚ¡ *
¡r
) {

134 
»suÉ
;

135 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_puts
(&
»suÉ
, 
¡r
));

136  
»suÉ
;

139 
FúH–³r
(
fd
, 
cmd
, 
št64_t
 
¬g
) {

140 
»suÉ
;

141 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_fú
(&
»suÉ
, 
fd
, 
cmd
, 
¬g
));

142  
»suÉ
;

145 
’c_uÁru¡ed_fú
(
fd
, 
cmd
, ...) {

146 
št64_t
 
¬g
 = 0;

147 
va_li¡
 
­
;

148 
va_¡¬t
(
­
, 
cmd
);

149 
¬g
 = 
va_¬g
(
­
, 
št64_t
);

150 
va_’d
(
­
);

152 
bridge_cmd
 = 
asylo
::
ToBridgeFúCmd
(
cmd
);

153 ià(
bridge_cmd
 == -1) {

154 
”ºo
 = 
EINVAL
;

158 
cmd
) {

159 
F_SETFL
: {

160 
¬g
 = 
asylo
::
ToBridgeFeFÏgs
(arg);

161  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

163 
F_SETFD
: {

164 
¬g
 = 
asylo
::
ToBridgeFDFÏgs
(arg);

165  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

167 
F_GETFL
: {

168 
»suÉ
 = 
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

169 ià(
»suÉ
 != -1) {

170 
»suÉ
 = 
asylo
::
FromBridgeFeFÏgs
(result);

172  
»suÉ
;

174 
F_GETFD
: {

175 
»suÉ
 = 
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

176 ià(
»suÉ
 != -1) {

177 
»suÉ
 = 
asylo
::
FromBridgeFDFÏgs
(result);

179  
»suÉ
;

181 
F_GETPIPE_SZ
: {

182  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

184 
F_SETPIPE_SZ
: {

185  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

188 
”ºo
 = 
EINVAL
;

194 
’c_uÁru¡ed_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

195 
»suÉ
;

196 
bridge_¡©
 
bridge_¡©_bufãr
;

197 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_¡©
(&
»suÉ
, 
·thÇme
, &
bridge_¡©_bufãr
));

198 
asylo
::
FromBridgeSt
(&
bridge_¡©_bufãr
, 
¡©_bufãr
);

199  
»suÉ
;

202 
’c_uÁru¡ed_f¡©
(
fd
, 
¡©
 *
¡©_bufãr
) {

203 
»suÉ
;

204 
bridge_¡©
 
bridge_¡©_bufãr
;

205 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_f¡©
(&
»suÉ
, 
fd
, &
bridge_¡©_bufãr
));

206 
asylo
::
FromBridgeSt
(&
bridge_¡©_bufãr
, 
¡©_bufãr
);

207  
»suÉ
;

210 
’c_uÁru¡ed_l¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

211 
»suÉ
;

212 
bridge_¡©
 
bridge_¡©_bufãr
;

213 
CHECK_OCALL
(

214 
oÿÎ_’c_uÁru¡ed_l¡©
(&
»suÉ
, 
·thÇme
, &
bridge_¡©_bufãr
));

215 
asylo
::
FromBridgeSt
(&
bridge_¡©_bufãr
, 
¡©_bufãr
);

216  
»suÉ
;

219 
fl_iov
(cÚ¡ *
buf
, 
size
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

220 
size_t
 
by‹s_Ëá
 = 
size
;

221 
i
 = 0; i < 
iovút
; ++i) {

222 ià(
by‹s_Ëá
 == 0) {

225 
by‹s_to_cİy
 = 
¡d
::
mš
(
by‹s_Ëá
, 
iov
[
i
].
iov_Ën
);

226 
memıy
(
iov
[
i
].
iov_ba£
, 
buf
, 
by‹s_to_cİy
);

227 
buf
 +ğ
by‹s_to_cİy
;

228 
by‹s_Ëá
 -ğ
by‹s_to_cİy
;

232 
ssize_t
 
’c_uÁru¡ed_wr™ev
(
fd
, *
buf
, 
size
) {

233 
asylo
::
UÁru¡edUniquePŒ
<> 
tmp
(
buf
);

234 
bridge_ssize_t
 
»t
;

236 
CHECK_OCALL
(

237 
oÿÎ_’c_uÁru¡ed_wr™e_w™h_uÁru¡ed_±r
(&
»t
, 
fd
, 
buf
, 
size
));

238  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

241 
ssize_t
 
’c_uÁru¡ed_»adv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
,

242 *
buf
, 
size
) {

243 
asylo
::
UÁru¡edUniquePŒ
<> 
tmp
(
buf
);

244 
bridge_ssize_t
 
»t
;

245 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»ad_w™h_uÁru¡ed_±r
(&
»t
, 
fd
, 
buf
, 
size
));

246 
fl_iov
(
buf
, 
»t
, 
iov
, 
iovút
);

247  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

254 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

255 
»t
;

260 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sock‘
(&
»t
, 
asylo
::
ToBridgeAfFamy
(
domaš
),

261 
asylo
::
ToBridgeSock‘Ty³
(
ty³
),

262 
´ÙocŞ
));

263  
»t
;

266 
’c_uÁru¡ed_acû±
(
sockfd
, 
sockaddr
 *
addr
,

267 
sockËn_t
 *
add¾’
) {

268 
»t
;

269 
bridge_sockaddr
 
tmp
;

270 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_acû±
(&
»t
, 
sockfd
, &
tmp
));

271 ià(
»t
 == -1) {

272  
»t
;

274 ià(
addr
 !ğ
nuÎ±r
 && 
add¾’
 !=‚ullptr) {

275 
asylo
::
FromBridgeSockaddr
(&
tmp
, 
addr
, 
add¾’
);

277  
»t
;

280 
’c_uÁru¡ed_bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

281 
sockËn_t
 
add¾’
) {

282 
»t
;

283 
bridge_sockaddr
 
tmp
;

284 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_bšd
(

285 &
»t
, 
sockfd
, 
asylo
::
ToBridgeSockaddr
(
addr
, 
add¾’
, &
tmp
)));

286  
»t
;

289 
’c_uÁru¡ed_cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

290 
sockËn_t
 
add¾’
) {

291 
»t
;

292 
bridge_sockaddr
 
tmp
;

293 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_cÚÃù
(

294 &
»t
, 
sockfd
, 
asylo
::
ToBridgeSockaddr
(
addr
, 
add¾’
, &
tmp
)));

295  
»t
;

298 
ssize_t
 
’c_uÁru¡ed_£ndmsg
(
sockfd
,

299 cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

300 
æags
) {

301 
bridge_ssize_t
 
»t
;

302 
CHECK_OCALL
(

303 
oÿÎ_’c_uÁru¡ed_£ndmsg
(&
»t
, 
sockfd
, 
bridge_msg
, 
æags
));

304  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

307 
ssize_t
 
’c_uÁru¡ed_»cvmsg
(
sockfd
,

308 
msghdr
 *
msg
,

309 
bridge_msghdr
 *
bridge_msg
,

310 
æags
) {

311 
bridge_ssize_t
 
»t
;

312 
CHECK_OCALL
(

313 
oÿÎ_’c_uÁru¡ed_»cvmsg
(&
»t
, 
sockfd
, 
bridge_msg
, 
æags
));

315 
asylo
::
FromBridgeIovecA¼ay
(
bridge_msg
, 
msg
);

316  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

319 cÚ¡ *
’c_uÁru¡ed_š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
,

320 
sockËn_t
 
size
) {

321 *
»t
;

322 
bridge_size_t
 
¤c_size
;

323 ià(
af
 =ğ
AF_INET
) {

324 
¤c_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š_addr
));

325 } ià(
af
 =ğ
AF_INET6
) {

326 
¤c_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š6_addr
));

328 
”ºo
 = 
EAFNOSUPPORT
;

329  
nuÎ±r
;

331 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_š‘_Áİ
(&
»t
, 
af
, 
¤c
, 
¤c_size
, 
d¡
,

332 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
)));

335 ià(!
»t
) {

336  
nuÎ±r
;

338  
d¡
;

341 
’c_uÁru¡ed_š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
) {

342 
»t
 = 0;

343 
bridge_size_t
 
d¡_size
 = 0;

344 ià(
af
 =ğ
AF_INET
) {

345 
d¡_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š_addr
));

346 } ià(
af
 =ğ
AF_INET6
) {

347 
d¡_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š6_addr
));

349 
”ºo
 = 
EINVAL
;

352 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_š‘_±Ú
(&
»t
, 
asylo
::
ToBridgeAfFamy
(
af
),

353 
¤c
, 
d¡
, 
d¡_size
));

354  
»t
;

357 
’c_uÁru¡ed_g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

358 cÚ¡ 
addršfo
 *
hšts
,

359 
addršfo
 **
»s
) {

360 
¡d
::
¡ršg
 
£rŸlized_hšts
;

361 
addršfo
 
bridge_hšts
;

362 ià(
hšts
) {

363 
bridge_hšts
 = *
hšts
;

364 
bridge_hšts
.
ai_æags
 =

365 
asylo
::
ToBridgeAdd»ssInfoFÏgs
(
bridge_hšts
.
ai_æags
);

369 
bridge_”rÜ_code
 = 
BRIDGE_EAI_UNKNOWN
;

371 ià(!
asylo
::
S”ŸlizeAddršfo
(
hšts
 ? &
bridge_hšts
 : 
nuÎ±r
,

372 &
£rŸlized_hšts
, &
bridge_”rÜ_code
)) {

373 ià(
bridge_”rÜ_code
 =ğ
BRIDGE_EAI_UNKNOWN
) {

374 
LOG
(
ERROR
) << "Bad‡ddrinfo";

376  
asylo
::
FromBridgeAdd»ssInfoE¼Üs
(
bridge_”rÜ_code
);

379 
»t
;

380 *
tmp_£rŸlized_»s_¡¬t
;

381 
bridge_size_t
 
tmp_£rŸlized_»s_Ën
;

382 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘addršfo
(

383 &
»t
, 
node
, 
£rviû
, 
£rŸlized_hšts
.
c_¡r
(),

384 
¡©ic_ÿ¡
<
bridge_size_t
>(
£rŸlized_hšts
.
Ëngth
()),

385 &
tmp_£rŸlized_»s_¡¬t
, &
tmp_£rŸlized_»s_Ën
));

386 
»t
 = 
asylo
::
FromBridgeAdd»ssInfoE¼Üs
(ret);

387 ià(
»t
 != 0) {

388  
»t
;

390 ià(!
sgx_is_outside_’şave
(
tmp_£rŸlized_»s_¡¬t
,

391 
¡©ic_ÿ¡
<
size_t
>(
tmp_£rŸlized_»s_Ën
))) {

392 
LOG
(
ERROR
) << "getaddrinfo„esponse…ointer‚ot from host‡ddress space";

397 
tmp_£rŸlized_»s
[
tmp_£rŸlized_»s_Ën
];

398 
memıy
(
tmp_£rŸlized_»s
, 
tmp_£rŸlized_»s_¡¬t
,

399 
¡©ic_ÿ¡
<
size_t
>(
tmp_£rŸlized_»s_Ën
));

400 
’c_uÁru¡ed_ä“
(
tmp_£rŸlized_»s_¡¬t
);

402 
¡d
::
¡ršg
 
£rŸlized_»s
(
tmp_£rŸlized_»s
,

403 
¡©ic_ÿ¡
<
size_t
>(
tmp_£rŸlized_»s_Ën
));

404 ià(!
asylo
::
De£rŸlizeAddršfo
(&
£rŸlized_»s
, 
»s
)) {

405 
LOG
(
ERROR
) << "Invalid‡ddrinfo in getaddrinfo„esponse";

408  
»t
;

411 
’c_uÁru¡ed_ä“addršfo
(
addršfo
 *
»s
) {

412 
asylo
::
F»eDe£rŸlizedAddršfo
(
»s
);

415 
’c_uÁru¡ed_g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

416 
sockËn_t
 *
İ’
) {

417 
»t
;

418 
ho¡_İ’
 = *
İ’
;

419 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘sockİt
(

420 &
»t
, 
sockfd
, 
Ëv–
, 
asylo
::
ToBridgeO±iÚName
Öev–, 
İŠame
), 
İtv®
,

421 
ho¡_İ’
, &host_optlen));

422 *
İ’
 = 
ho¡_İ’
;

423  
»t
;

426 
’c_uÁru¡ed_£tsockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

427 cÚ¡ *
İtv®
, 
sockËn_t
 
İ’
) {

428 
»t
;

429 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_£tsockİt
(

430 &
»t
, 
sockfd
, 
Ëv–
, 
asylo
::
ToBridgeO±iÚName
Öev–, 
İŠame
), 
İtv®
,

431 
¡©ic_ÿ¡
<
bridge_size_t
>(
İ’
)));

432  
»t
;

435 
’c_uÁru¡ed_g‘sockÇme
(
sockfd
, 
sockaddr
 *
addr
,

436 
sockËn_t
 *
add¾’
) {

437 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
sockaddr
>(
addr
) ||

438 !
asylo
::
IsV®idEnşaveAdd»ss
<
sockËn_t
>(
add¾’
)) {

439 
”ºo
 = 
EFAULT
;

444 ià(*
add¾’
 =ğ0 || *add¾’ > 
INT32_MAX
) {

445 
”ºo
 = 
EINVAL
;

448 
»t
;

449 
bridge_sockaddr
 
tmp
;

450 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘sockÇme
(&
»t
, 
sockfd
, &
tmp
));

451 ià(
»t
 == 0) {

452 
asylo
::
FromBridgeSockaddr
(&
tmp
, 
addr
, 
add¾’
);

454  
»t
;

457 
’c_uÁru¡ed_g‘³”Çme
(
sockfd
, 
sockaddr
 *
addr
,

458 
sockËn_t
 *
add¾’
) {

459 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
sockaddr
>(
addr
) ||

460 !
asylo
::
IsV®idEnşaveAdd»ss
<
sockËn_t
>(
add¾’
)) {

461 
”ºo
 = 
EFAULT
;

466 ià(*
add¾’
 =ğ0 || *add¾’ > 
INT32_MAX
) {

467 
”ºo
 = 
EINVAL
;

470 
»t
;

471 
bridge_sockaddr
 
tmp
;

472 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘³”Çme
(&
»t
, 
sockfd
, &
tmp
));

473 ià(
»t
 == 0) {

474 
asylo
::
FromBridgeSockaddr
(&
tmp
, 
addr
, 
add¾’
);

476  
»t
;

479 
ssize_t
 
’c_uÁru¡ed_»cväom
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
,

480 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
) {

481 
ssize_t
 
»t
 = 0;

482 *
£rŸlized_¬gs
 = 
nuÎ±r
;

483 
size_t
 
£rŸlized_Ën
 = 0;

484 ià(!
asylo
::
S”ŸlizeRecvFromArgs
(
sockfd
, 
Ën
, 
æags
, &
£rŸlized_¬gs
,

485 &
£rŸlized_Ën
)) {

486 
”ºo
 = 
EINVAL
;

489 
asylo
::
M®locUniquePŒ
<[]> 
¬gs_±r
(
£rŸlized_¬gs
);

490 *
£rŸlized_ouut
 = 
nuÎ±r
;

491 **
£rŸlized_ouut_±r
 = 
¤c_addr
 ? &
£rŸlized_ouut
 : 
nuÎ±r
;

492 *
ouut_buf
 = 
nuÎ±r
;

493 
bridge_ssize_t
 
ouut_Ën
 = 0;

494 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»cväom
(&
»t
, 
£rŸlized_¬gs
,

495 
£rŸlized_Ën
, &
ouut_buf
,

496 
£rŸlized_ouut_±r
, &
ouut_Ën
));

497 
asylo
::
UÁru¡edUniquePŒ
<[]> 
ouut_buf_±r
(
ouut_buf
);

498 ià(
»t
 < 0) {

502 ià(!
sgx_is_outside_’şave
(
ouut_buf
, 
»t
)) {

503 
abÜt
();

505 
memıy
(
buf
, 
ouut_buf
, 
»t
);

506 ià(
¤c_addr
) {

507 
sockaddr
 *
¤c_addr_cİy
 = 
nuÎ±r
;

508 
asylo
::
UÁru¡edUniquePŒ
<[]> 
ouut_unique_±r
(
£rŸlized_ouut
);

509 ià(!
sgx_is_outside_’şave
(
£rŸlized_ouut
, 
ouut_Ën
)) {

510 
abÜt
();

512 
¡d
::
¡ršg
 
£rŸlized_ouut_¡r
(
£rŸlized_ouut
, 
ouut_Ën
);

513 ià(!
add¾’
 || !
asylo
::
De£rŸlizeRecvFromSrcAddr
(
£rŸlized_ouut_¡r
,

514 &
¤c_addr_cİy
)) {

515 
”ºo
 = 
EINVAL
;

518 
asylo
::
M®locUniquePŒ
<
sockaddr
> 
¤c_addr_±r
(
¤c_addr_cİy
);

519 ià(
¤c_addr_cİy
->
§_çmy
 =ğ
AF_INET
) {

520 
memıy
(

521 
¤c_addr
, 
¤c_addr_cİy
,

522 
¡d
::
mš
(
¡©ic_ÿ¡
<
size_t
>(*
add¾’
), (
sockaddr_š
)));

523 *
add¾’
 = (
sockaddr_š
);

524 } ià(
¤c_addr_cİy
->
§_çmy
 =ğ
AF_INET6
) {

525 
memıy
(

526 
¤c_addr
, 
¤c_addr_cİy
,

527 
¡d
::
mš
(
¡©ic_ÿ¡
<
size_t
>(*
add¾’
), (
sockaddr_š6
)));

528 *
add¾’
 = (
sockaddr_š6
);

530 
”ºo
 = 
EINVAL
;

534  
»t
;

541 
’c_uÁru¡ed_ü—‹_th»ad
(cÚ¡ *
Çme
) {

542 
»t
;

543 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_th»ad_ü—‹
(&
»t
, 
Çme
));

552 
’c_uÁru¡ed_pŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
) {

553 
»t
;

554 autØ
tmp
 = 
ab¦
::
make_unique
<
bridge_pŞlfd
[]>(
nfds
);

555 
i
 = 0; i < 
nfds
; ++i) {

556 ià(!
asylo
::
ToBridgePŞlfd
(&
fds
[
i
], &
tmp
[i])) {

557 
”ºo
 = 
EFAULT
;

561 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_pŞl
(&
»t
, 
tmp
.
g‘
(), 
nfds
, 
timeout
));

562 
i
 = 0; i < 
nfds
; ++i) {

563 ià(!
asylo
::
FromBridgePŞlfd
(&
tmp
[
i
], &
fds
[i])) {

564 
LOG
(
ERROR
) << "Invalid bridge…oll fd in…oll„esponse";

565 
”ºo
 = 
EFAULT
;

569  
»t
;

576 
’c_uÁru¡ed_•Şl_ü—‹
(
size
) {

577 
»t
 = 0;

578 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_•Şl_ü—‹
(&
»t
, 
size
));

579  
»t
;

582 
’c_uÁru¡ed_•Şl_ùl
(
•fd
, 
İ
, 
fd
,

583 
•Şl_ev’t
 *
ev’t
) {

584 *
£rŸlized_¬gs
 = 
nuÎ±r
;

585 
asylo
::
M®locUniquePŒ
<[]> 
¬gs_±r
(
£rŸlized_¬gs
);

586 
size_t
 
Ën
 = 0;

587 ià(!
asylo
::
S”ŸlizeEpŞlCArgs
(
•fd
, 
İ
, 
fd
, 
ev’t
, &
£rŸlized_¬gs
,

588 &
Ën
)) {

589 
”ºo
 = 
EINVAL
;

592 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

593 
»t
 = 0;

594 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_•Şl_ùl
(&
»t
, 
£rŸlized_¬gs
,

595 
£rŸlized_¬gs_Ën
));

596  
»t
;

599 
’c_uÁru¡ed_•Şl_wa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
,

600 
maxev’ts
, 
timeout
) {

601 *
£rŸlized_¬gs
 = 
nuÎ±r
;

602 
asylo
::
M®locUniquePŒ
<[]> 
¬gs_±r
(
£rŸlized_¬gs
);

603 
size_t
 
Ën
 = 0;

604 ià(!
asylo
::
S”ŸlizeEpŞlWa™Args
(
•fd
, 
maxev’ts
, 
timeout
, &
£rŸlized_¬gs
,

605 &
Ën
)) {

606 
”ºo
 = 
EINVAL
;

610 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

611 
»t
 = 0;

612 *
£rŸlized_ev’t_li¡
 = 
nuÎ±r
;

613 
bridge_size_t
 
£rŸlized_ev’t_li¡_Ën
 = 0;

614 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_•Şl_wa™
(

615 &
»t
, 
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
, &
£rŸlized_ev’t_li¡
,

616 &
£rŸlized_ev’t_li¡_Ën
));

617 ià(!
sgx_is_outside_’şave
(
£rŸlized_ev’t_li¡
,

618 
£rŸlized_ev’t_li¡_Ën
)) {

619 
abÜt
();

621 
asylo
::
UÁru¡edUniquePŒ
<[]>

622 
£rŸlized_ev’ts_±r
(
£rŸlized_ev’t_li¡
);

625 
¡d
::
¡ršg
 
ev’t_li¡_¡r
(
£rŸlized_ev’t_li¡
, 
£rŸlized_ev’t_li¡_Ën
);

626 
numev’ts
 = 0;

627 ià(!
asylo
::
De£rŸlizeEv’ts
(
ev’t_li¡_¡r
, 
ev’ts
, &
numev’ts
)) {

628 
”ºo
 = 
EBADE
;

634 ià(
numev’ts
 !ğ
»t
) {

635 
abÜt
();

637  
»t
;

644 
’c_uÁru¡ed_šÙify_š™1
(
nÚ_block
) {

645 
»t
 = 0;

646 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_š™1
(&
»t
, 
nÚ_block
));

647  
»t
;

650 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
,

651 
ušt32_t
 
mask
) {

652 *
£rŸlized_¬gs
 = 
nuÎ±r
;

653 
asylo
::
M®locUniquePŒ
<> 
¬gs_±r
(
£rŸlized_¬gs
);

654 
size_t
 
Ën
 = 0;

655 ià(!
asylo
::
S”ŸlizeInÙifyAddW©chArgs
(
fd
, 
·thÇme
, 
mask
, &
£rŸlized_¬gs
,

656 &
Ën
)) {

659 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

660 
»t
 = 0;

661 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_add_w©ch
(&
»t
, 
£rŸlized_¬gs
,

662 
£rŸlized_¬gs_Ën
));

663  
»t
;

666 
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
) {

667 *
£rŸlized_¬gs
 = 
nuÎ±r
;

668 
asylo
::
M®locUniquePŒ
<> 
¬gs_±r
(
£rŸlized_¬gs
);

669 
size_t
 
Ën
 = 0;

670 ià(!
asylo
::
S”ŸlizeInÙifyRmW©chArgs
(
fd
, 
wd
, &
£rŸlized_¬gs
, &
Ën
)) {

671 
”ºo
 = 
EINVAL
;

674 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

675 
»t
 = 0;

676 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_rm_w©ch
(&
»t
, 
£rŸlized_¬gs
,

677 
£rŸlized_¬gs_Ën
));

678  
»t
;

681 
’c_uÁru¡ed_šÙify_»ad
(
fd
, 
size_t
 
couÁ
, **
£rŸlized_ev’ts
,

682 
size_t
 *
£rŸlized_ev’ts_Ën
) {

683 
»t
 = 0;

684 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_»ad
(

685 &
»t
, 
fd
, 
couÁ
, 
£rŸlized_ev’ts
, 
£rŸlized_ev’ts_Ën
));

686  
»t
;

693 
’c_uÁru¡ed_g‘içddrs
(
içddrs
 **
içp
) {

694 *
£rŸlized_içddrs
 = 
nuÎ±r
;

695 
bridge_ssize_t
 
£rŸlized_içddrs_Ën
 = 0;

696 
»t
 = 0;

697 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘içddrs
(&
»t
, &
£rŸlized_içddrs
,

698 &
£rŸlized_içddrs_Ën
));

699 ià(
»t
 != 0) {

700  
»t
;

702 ià(!
sgx_is_outside_’şave
(
£rŸlized_içddrs
,

703 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_içddrs_Ën
))) {

704 
LOG
(
ERROR
) << "serialized_ifaddrs‚ot from host‡ddress space";

707 
asylo
::
UÁru¡edUniquePŒ
<> 
içddrs_¡r_±r
(
£rŸlized_içddrs
);

708 
¡d
::
¡ršg
 
içddrs_¡r
(
£rŸlized_içddrs
, 
£rŸlized_içddrs_Ën
);

709 ià(!
asylo
::
De£rŸlizeIfAddrs
(
içddrs_¡r
, 
içp
))  -1;

710  
»t
;

713 
’c_uÁru¡ed_ä“içddrs
(
içddrs
 *
iç
) {

714 
asylo
::
F»eDe£rŸlizedIfAddrs
(
iç
);

721 
·sswd
 *
’c_uÁru¡ed_g‘pwuid
(
uid_t
 
uid
) {

722 
BridgePassWd
 
bridge_·sswÜd
;

723 
»t
 = 0;

724 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘pwuid
(&
»t
, 
uid
, &
bridge_·sswÜd
));

725 ià(
»t
 != 0) {

726  
nuÎ±r
;

731 
BridgePassWd
 
·sswÜd_bufãrs
;

733 ià(!
asylo
::
CİyBridgePassWd
(&
bridge_·sswÜd
, &
·sswÜd_bufãrs
) ||

734 !
asylo
::
FromBridgePassWd
(&
·sswÜd_bufãrs
, &asylo::
glob®_·sswÜd
)) {

735 
”ºo
 = 
EFAULT
;

736  
nuÎ±r
;

739  &
asylo
::
glob®_·sswÜd
;

746 
’c_uÁru¡ed_sched_g‘affš™y
(
pid_t
 
pid
, 
size_t
 
ıu£tsize
,

747 
ıu_£t_t
 *
mask
) {

748 ià(
ıu£tsize
 < (
ıu_£t_t
)) {

749 
”ºo
 = 
EINVAL
;

753 
»t
;

754 
BridgeCpuS‘
 
bridge_mask
;

755 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sched_g‘affš™y
(

756 &
»t
, 
¡©ic_ÿ¡
<
št64_t
>(
pid
), &
bridge_mask
));

759 
CPU_ZERO
(
mask
);

760 
ıu
 = 0; cpu < 
CPU_SETSIZE
; ++cpu) {

761 ià(
asylo
::
BridgeCpuS‘CheckB™
(
ıu
, &
bridge_mask
)) {

762 
CPU_SET
(
ıu
, 
mask
);

766  
»t
;

773 
’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

774 
signum
, (*
bridge_sigaùiÚ
)(, 
bridge_sigšfo_t
 *, *),

775 cÚ¡ 
sig£t_t
 
mask
, 
æags
, cÚ¡ *
’şave_Çme
) {

776 
bridge_signum
 = 
asylo
::
ToBridgeSigÇl
(
signum
);

777 ià(
bridge_signum
 < 0) {

778 
”ºo
 = 
EINVAL
;

781 
BridgeSigÇlHªdËr
 
hªdËr
;

782 
hªdËr
.
sigaùiÚ
 = 
bridge_sigaùiÚ
;

783 
asylo
::
ToBridgeSigS‘
(&
mask
, &
hªdËr
.mask);

784 
hªdËr
.
æags
 = 
asylo
::
ToBridgeSigÇlFÏgs
(flags);

785 
»t
;

786 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

787 &
»t
, 
bridge_signum
, &
hªdËr
, 
’şave_Çme
));

788  
»t
;

791 
’c_uÁru¡ed_sig´ocmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
) {

792 
bridge_sig£t_t
 
bridge_£t
;

793 
asylo
::
ToBridgeSigS‘
(
£t
, &
bridge_£t
);

794 
bridge_sig£t_t
 
bridge_Şd_£t
;

795 
»t
;

796 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sig´ocmask
(

797 &
»t
, 
asylo
::
ToBridgeSigMaskAùiÚ
(
how
), &
bridge_£t
, &
bridge_Şd_£t
));

798 
asylo
::
FromBridgeSigS‘
(&
bridge_Şd_£t
, 
Şd£t
);

799  
»t
;

802 
’c_uÁru¡ed_¿i£
(
sig
) {

803 
bridge_sig
 = 
asylo
::
ToBridgeSigÇl
(
sig
);

804 ià(
bridge_sig
 < 0) {

805 
”ºo
 = 
EINVAL
;

808 
»t
;

809 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_¿i£
(&
»t
, 
bridge_sig
));

810  
»t
;

817 
’c_uÁru¡ed_g‘ru§ge
(
who
, 
ru§ge
 *
u§ge
) {

818 
»t
;

819 
BridgeRU§ge
 
bridge_u§ge
;

820 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘ru§ge
(

821 &
»t
, 
asylo
::
ToBridgeRU§geT¬g‘
(
who
), &
bridge_u§ge
));

822 
asylo
::
FromBridgeRU§ge
(&
bridge_u§ge
, 
u§ge
);

823  
»t
;

830 
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
) {

831 
»t
;

832 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_æock
(

833 &
»t
, 
fd
, 
asylo
::
ToBridgeFLockO³¿tiÚ
(
İ”©iÚ
)));

834  
»t
;

841 
’c_uÁru¡ed_£Ëù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
,

842 
fd_£t
 *
exû±fds
, 
timev®
 *
timeout
) {

843 
BridgeFDS‘
 
bridge_»adfds
, 
bridge_wr™efds
, 
bridge_exû±fds
;

844 ià(
»adfds
 && !
asylo
::
ToBridgeFDS‘
Ô—dfds, &
bridge_»adfds
)) {

845 
”ºo
 = 
EBADE
;

848 ià(
wr™efds
 && !
asylo
::
ToBridgeFDS‘
(wr™efds, &
bridge_wr™efds
)) {

849 
”ºo
 = 
EBADE
;

852 ià(
exû±fds
 && !
asylo
::
ToBridgeFDS‘
Óxû±fds, &
bridge_exû±fds
)) {

853 
”ºo
 = 
EBADE
;

856 
bridge_timev®
 
bridge_timeout
;

857 ià(!
asylo
::
ToBridgeTimeV®
(
timeout
, &
bridge_timeout
)) {

858 
”ºo
 = 
EBADE
;

861 
»t
;

862 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_£Ëù
(&
»t
, 
nfds
, &
bridge_»adfds
,

863 &
bridge_wr™efds
, &
bridge_exû±fds
,

864 &
bridge_timeout
));

866 ià(
»adfds
 && !
asylo
::
FromBridgeFDS‘
(&
bridge_»adfds
,„eadfds)) {

867 
”ºo
 = 
EBADE
;

870 ià(
wr™efds
 && !
asylo
::
FromBridgeFDS‘
(&
bridge_wr™efds
, writefds)) {

871 
”ºo
 = 
EBADE
;

874 ià(
exû±fds
 && !
asylo
::
FromBridgeFDS‘
(&
bridge_exû±fds
,ƒxceptfds)) {

875 
”ºo
 = 
EBADE
;

878  
»t
;

885 
’c_uÁru¡ed_İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
) {

886 
CHECK_OCALL
(

887 
oÿÎ_’c_uÁru¡ed_İ’log
(
id’t
, 
asylo
::
ToBridgeSysLogO±iÚ
(
İtiÚ
),

888 
asylo
::
ToBridgeSysLogFac™y
(
çc™y
)));

891 
’c_uÁru¡ed_sy¦og
(
´iÜ™y
, cÚ¡ *
mes§ge
) {

892 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sy¦og
(

893 
asylo
::
ToBridgeSysLogPriÜ™y
(
´iÜ™y
), 
mes§ge
));

900 
’c_uÁru¡ed_Çno¦“p
(cÚ¡ 
time¥ec
 *
»q
, time¥eø*
»m
) {

901 
»t
;

902 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_Çno¦“p
(

903 &
»t
, 
»š‹½»t_ÿ¡
<cÚ¡ 
bridge_time¥ec
 *>(
»q
),

904 
»š‹½»t_ÿ¡
<
bridge_time¥ec
 *>(
»m
)));

905  
»t
;

908 
’c_uÁru¡ed_times
(
tms
 *
buf
) {

909 
»t
;

910 
BridgeTms
 
bridge_buf
;

911 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_times
(&
»t
, &
bridge_buf
));

912 ià(!
asylo
::
FromBridgeTms
(&
bridge_buf
, 
buf
)) {

913 
”ºo
 = 
EFAULT
;

916  
»t
;

919 
’c_uÁru¡ed_şock_g‘time
(
şockid_t
 
şk_id
, 
time¥ec
 *

) {

920 
»t
;

921 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_şock_g‘time
(

922 &
»t
, 
¡©ic_ÿ¡
<
bridge_şockid_t
>(
şk_id
),

923 
»š‹½»t_ÿ¡
<
bridge_time¥ec
 *>(

)));

924  
»t
;

927 
’c_uÁru¡ed_g‘™im”
(
which
, 
™im”v®
 *
cu¼_v®ue
) {

928 
»t
;

929 
BridgeITim”V®
 
bridge_cu¼_v®ue
;

930 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘™im”
(

931 &
»t
, 
asylo
::
ToBridgeTim”Ty³
(
which
), &
bridge_cu¼_v®ue
));

932 ià(
cu¼_v®ue
 =ğ
nuÎ±r
 ||

933 !
asylo
::
FromBridgeITim”V®
(&
bridge_cu¼_v®ue
, 
cu¼_v®ue
)) {

934 
”ºo
 = 
EFAULT
;

937  
»t
;

940 
’c_uÁru¡ed_£t™im”
(
which
, cÚ¡ 
™im”v®
 *
Ãw_v®ue
,

941 
™im”v®
 *
Şd_v®ue
) {

942 
»t
;

943 
BridgeITim”V®
 
bridge_Ãw_v®ue
, 
bridge_Şd_v®ue
;

944 ià(!
asylo
::
ToBridgeITim”V®
(
Ãw_v®ue
, &
bridge_Ãw_v®ue
)) {

945 
”ºo
 = 
EFAULT
;

948 
CHECK_OCALL
(

949 
oÿÎ_’c_uÁru¡ed_£t™im”
(&
»t
, 
asylo
::
ToBridgeTim”Ty³
(
which
),

950 &
bridge_Ãw_v®ue
, &
bridge_Şd_v®ue
));

952 ià(
Şd_v®ue
 !ğ
nuÎ±r
 &&

953 !
asylo
::
FromBridgeITim”V®
(&
bridge_Şd_v®ue
, 
Şd_v®ue
)) {

954 
”ºo
 = 
EFAULT
;

957  
»t
;

964 
’c_uÁru¡ed_g‘timeofday
(
timev®
 *
tv
, *
tz
) {

965 
»t
;

966 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘timeofday
(

967 &
»t
, 
»š‹½»t_ÿ¡
<
bridge_timev®
 *>(
tv
), 
nuÎ±r
));

968  
»t
;

975 
’c_uÁru¡ed_uÇme
(
ut¢ame
 *
ut¢ame_v®
) {

976 ià(!
ut¢ame_v®
) {

977 
”ºo
 = 
EFAULT
;

981 
BridgeUtsName
 
bridge_ut¢ame_v®
;

982 
»t
;

983 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_uÇme
(&
»t
, &
bridge_ut¢ame_v®
));

984 ià(
»t
 != 0) {

985  
»t
;

988 ià(!
asylo
::
CÚv”tUtsName
(
bridge_ut¢ame_v®
, 
ut¢ame_v®
)) {

989 
LOG
(
FATAL
) << "uname„eturned‡n ill-formed utsname";

992  
»t
;

999 
’c_uÁru¡ed_pe2
(
pefd
[2], 
æags
) {

1000 ià(
æags
 & ~(
O_CLOEXEC
 | 
O_DIRECT
 | 
O_NONBLOCK
)) {

1001 
”ºo
 = 
EINVAL
;

1005 
»t
;

1006 
CHECK_OCALL
(

1007 
oÿÎ_’c_uÁru¡ed_pe2
(&
»t
, 
pefd
, 
asylo
::
ToBridgeFeFÏgs
(
æags
)));

1008  
»t
;

1011 
št64_t
 
’c_uÁru¡ed_syscÚf
(
Çme
) {

1012 
št64_t
 
»t
;

1013 
SyscÚfCÚ¡ªts
 
bridge_Çme
 = 
asylo
::
ToBridgeSyscÚfCÚ¡ªts
(
Çme
);

1014 ià(
bridge_Çme
 =ğ
BRIDGE_SC_UNKNOWN
) {

1015 
”ºo
 = 
EINVAL
;

1018 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_syscÚf
(&
»t
, 
bridge_Çme
));

1019  
»t
;

1022 
ušt32_t
 
’c_uÁru¡ed_¦“p
(ušt32_ˆ
£cÚds
) {

1023 
ušt32_t
 
»t
;

1024 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_¦“p
(&
»t
, 
£cÚds
));

1025  
»t
;

1028 
’c_uÁru¡ed__ex™
(
rc
è{ 
oÿÎ_’c_uÁru¡ed__ex™
(rc); }

1030 
pid_t
 
’c_uÁru¡ed_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ *
cÚfig
,

1031 
size_t
 
cÚfig_Ën
, 
boŞ
 
»¡Üe_¢­shÙ
) {

1032 
pid_t
 
»t
;

1033 
sgx_¡©us_t
 
¡©us
 = 
oÿÎ_’c_uÁru¡ed_fÜk
(

1034 &
»t
, 
’şave_Çme
, 
cÚfig
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
cÚfig_Ën
),

1035 
»¡Üe_¢­shÙ
);

1036 ià(
¡©us
 !ğ
SGX_SUCCESS
) {

1037 
”ºo
 = 
EINTR
;

1040  
»t
;

1047 
pid_t
 
’c_uÁru¡ed_wa™3
(*
w¡©us
, 
İtiÚs
, 
ru§ge
 *
u§ge
) {

1048 
pid_t
 
»t
;

1049 
BridgeWStus
 
bridge_w¡©us
;

1050 
BridgeRU§ge
 
bridge_u§ge
;

1051 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_wa™3
(&
»t
, &
bridge_w¡©us
,

1052 
asylo
::
ToBridgeWa™O±iÚs
(
İtiÚs
),

1053 &
bridge_u§ge
));

1054 ià(
w¡©us
) {

1055 *
w¡©us
 = 
asylo
::
FromBridgeWStus
(
bridge_w¡©us
);

1057 
asylo
::
FromBridgeRU§ge
(&
bridge_u§ge
, 
u§ge
);

1058  
»t
;

1061 
pid_t
 
’c_uÁru¡ed_wa™pid
Õid_ˆ
pid
, *
w¡©us
, 
İtiÚs
) {

1062 
pid_t
 
»t
;

1063 
BridgeWStus
 
bridge_w¡©us
;

1064 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_wa™pid
(&
»t
, 
pid
, &
bridge_w¡©us
,

1065 
asylo
::
ToBridgeWa™O±iÚs
(
İtiÚs
)));

1066 ià(
w¡©us
) {

1067 *
w¡©us
 = 
asylo
::
FromBridgeWStus
(
bridge_w¡©us
);

1069  
»t
;

1076 
’c_uÁru¡ed_utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
) {

1077 
»t
;

1078 
bridge_utimbuf
 
tmp_bridge_utimbuf
;

1079 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_utime
(

1080 &
»t
, 
f’ame
, 
asylo
::
ToBridgeUtimbuf
(
times
, &
tmp_bridge_utimbuf
)));

1081  
»t
;

1084 
’c_uÁru¡ed_utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]) {

1085 
»t
;

1086 
bridge_timev®
 
bridge_acûss_time
;

1087 
bridge_timev®
 
bridge_modifiÿtiÚ_time
;

1088 ià(!
asylo
::
ToBridgeTimeV®
(&
times
[0], &
bridge_acûss_time
) ||

1089 !
asylo
::
ToBridgeTimeV®
(&
times
[1], &
bridge_modifiÿtiÚ_time
)) {

1090 
”ºo
 = 
EBADE
;

1093 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_utimes
(&
»t
, 
f’ame
, &
bridge_acûss_time
,

1094 &
bridge_modifiÿtiÚ_time
));

1095  
»t
;

1102 *
’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1103 cÚ¡ *
Çme
) {

1104 *
»t
;

1105 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(&
»t
, 
kšd
, 
Çme
));

1106  
»t
;

1109 
’c_uÁru¡ed_»Ëa£_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1110 cÚ¡ *
Çme
) {

1111 
»t
;

1112 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»Ëa£_sh¬ed_»sourû
(&
»t
, 
kšd
, 
Çme
));

1113  
»t
 ? 0 : -1;

1120 
’c_uÁru¡ed_hex_dump
(cÚ¡ *
buf
, 
nby‹s
) {

1121 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_hex_dump
(
buf
, 
nby‹s
));

	@platform/arch/sgx/trusted/host_calls.cc

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~<”ºo.h
>

27 
	~<fú.h
>

28 
	~<pŞl.h
>

29 
	~<pwd.h
>

30 
	~<¡d¬g.h
>

31 
	~<¡dšt.h
>

32 
	~<¡dio.h
>

33 
	~<¡dlib.h
>

34 
	~<sys/sock‘.h
>

35 
	~<sys/¡©.h
>

36 
	~<sys/ty³s.h
>

37 
	~<sys/ut¢ame.h
>

38 
	~<uni¡d.h
>

39 
	~<utime.h
>

41 
	~<c¡ršg
>

42 
	~<¡ršg
>

43 
	~<veùÜ
>

45 
	~"ab¦/memÜy/memÜy.h
"

46 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

47 
	~"asylo/ut/loggšg.h
"

48 
	~"asylo/¶©fÜm/¬ch/sgx/Œu¡ed/g’”©ed_bridge_t.h
"

49 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

50 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

51 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

52 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

53 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

54 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

55 
	~"asylo/ut/¡©us.h
"

56 
	~"šşude/sgx_Œts.h
"

58 
Çme¥aû
 
	gasylo
 {

59 
	gÇme¥aû
 {

61 
	#CHECK_OCALL
(
¡©us_
) \

63 
sgx_¡©us_t
 
¡©us
##
__COUNTER__
 = 
¡©us_
; \

64 ià(
¡©us
##
__COUNTER__
 !ğ
SGX_SUCCESS
) { \

65 
	`’c_uÁru¡ed_puts
( \

66 
ab¦
::
	`SŒC©
( \

67 
__FILE__
, ":", 
__LINE__
, ": ", \

68 
asylo
::
	`Stus
(
¡©us
##
__COUNTER__
, "oÿÎ faed").
	`ToSŒšg
()) \

69 .
	`c_¡r
()); \

70 
	`abÜt
(); \

72 } 0)

	)

76 
·sswd
 
	gglob®_·sswÜd
;

87 *
’c_uÁru¡ed_m®loc
(
size_t
 
size
) {

88 *
»suÉ
;

89 
CHECK_OCALL
(

90 
oÿÎ_’c_uÁru¡ed_m®loc
(&
»suÉ
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
)));

91 ià(
»suÉ
 &&

92 !
sgx_is_outside_’şave
(
»suÉ
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
))) {

93 
abÜt
();

95 ià(!
»suÉ
) {

96 
abÜt
();

98  
»suÉ
;

101 **
’c_uÁru¡ed_®loÿ‹_bufãrs
(
size_t
 
couÁ
, size_ˆ
size
) {

102 **
bufãrs
;

103 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_®loÿ‹_bufãrs
(

104 &
bufãrs
,

105 
¡©ic_ÿ¡
<
bridge_size_t
>(
couÁ
),

106 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
)));

107 ià(!
bufãrs
 || !
sgx_is_outside_’şave
(bufãrs, 
size
)) {

108 
abÜt
();

110  
bufãrs
;

113 
’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(**
ä“_li¡
, 
size_t
 
couÁ
) {

114 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(

115 
ä“_li¡
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
couÁ
)));

118 
’c_uÁru¡ed_İ’
(cÚ¡ *
·th_Çme
, 
æags
, ...) {

119 
ušt32_t
 
mode
 = 0;

120 ià(
æags
 & 
O_CREAT
) {

121 
va_li¡
 
­
;

122 
va_¡¬t
(
­
, 
æags
);

123 
mode
 = 
va_¬g
(
­
, 
mode_t
);

124 
va_’d
(
­
);

127 
bridge_æags
 = 
asylo
::
ToBridgeFeFÏgs
(
æags
);

128 
»suÉ
;

129 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_İ’
(&
»suÉ
, 
·th_Çme
, 
bridge_æags
, 
mode
));

130  
»suÉ
;

133 
’c_uÁru¡ed_puts
(cÚ¡ *
¡r
) {

134 
»suÉ
;

135 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_puts
(&
»suÉ
, 
¡r
));

136  
»suÉ
;

139 
FúH–³r
(
fd
, 
cmd
, 
št64_t
 
¬g
) {

140 
»suÉ
;

141 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_fú
(&
»suÉ
, 
fd
, 
cmd
, 
¬g
));

142  
»suÉ
;

145 
’c_uÁru¡ed_fú
(
fd
, 
cmd
, ...) {

146 
št64_t
 
¬g
 = 0;

147 
va_li¡
 
­
;

148 
va_¡¬t
(
­
, 
cmd
);

149 
¬g
 = 
va_¬g
(
­
, 
št64_t
);

150 
va_’d
(
­
);

152 
bridge_cmd
 = 
asylo
::
ToBridgeFúCmd
(
cmd
);

153 ià(
bridge_cmd
 == -1) {

154 
”ºo
 = 
EINVAL
;

158 
cmd
) {

159 
F_SETFL
: {

160 
¬g
 = 
asylo
::
ToBridgeFeFÏgs
(arg);

161  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

163 
F_SETFD
: {

164 
¬g
 = 
asylo
::
ToBridgeFDFÏgs
(arg);

165  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

167 
F_GETFL
: {

168 
»suÉ
 = 
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

169 ià(
»suÉ
 != -1) {

170 
»suÉ
 = 
asylo
::
FromBridgeFeFÏgs
(result);

172  
»suÉ
;

174 
F_GETFD
: {

175 
»suÉ
 = 
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

176 ià(
»suÉ
 != -1) {

177 
»suÉ
 = 
asylo
::
FromBridgeFDFÏgs
(result);

179  
»suÉ
;

181 
F_GETPIPE_SZ
: {

182  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

184 
F_SETPIPE_SZ
: {

185  
FúH–³r
(
fd
, 
bridge_cmd
, 
¬g
);

188 
”ºo
 = 
EINVAL
;

194 
’c_uÁru¡ed_¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

195 
»suÉ
;

196 
bridge_¡©
 
bridge_¡©_bufãr
;

197 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_¡©
(&
»suÉ
, 
·thÇme
, &
bridge_¡©_bufãr
));

198 
asylo
::
FromBridgeSt
(&
bridge_¡©_bufãr
, 
¡©_bufãr
);

199  
»suÉ
;

202 
’c_uÁru¡ed_f¡©
(
fd
, 
¡©
 *
¡©_bufãr
) {

203 
»suÉ
;

204 
bridge_¡©
 
bridge_¡©_bufãr
;

205 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_f¡©
(&
»suÉ
, 
fd
, &
bridge_¡©_bufãr
));

206 
asylo
::
FromBridgeSt
(&
bridge_¡©_bufãr
, 
¡©_bufãr
);

207  
»suÉ
;

210 
’c_uÁru¡ed_l¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

211 
»suÉ
;

212 
bridge_¡©
 
bridge_¡©_bufãr
;

213 
CHECK_OCALL
(

214 
oÿÎ_’c_uÁru¡ed_l¡©
(&
»suÉ
, 
·thÇme
, &
bridge_¡©_bufãr
));

215 
asylo
::
FromBridgeSt
(&
bridge_¡©_bufãr
, 
¡©_bufãr
);

216  
»suÉ
;

219 
fl_iov
(cÚ¡ *
buf
, 
size
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

220 
size_t
 
by‹s_Ëá
 = 
size
;

221 
i
 = 0; i < 
iovút
; ++i) {

222 ià(
by‹s_Ëá
 == 0) {

225 
by‹s_to_cİy
 = 
¡d
::
mš
(
by‹s_Ëá
, 
iov
[
i
].
iov_Ën
);

226 
memıy
(
iov
[
i
].
iov_ba£
, 
buf
, 
by‹s_to_cİy
);

227 
buf
 +ğ
by‹s_to_cİy
;

228 
by‹s_Ëá
 -ğ
by‹s_to_cİy
;

232 
ssize_t
 
’c_uÁru¡ed_wr™ev
(
fd
, *
buf
, 
size
) {

233 
asylo
::
UÁru¡edUniquePŒ
<> 
tmp
(
buf
);

234 
bridge_ssize_t
 
»t
;

236 
CHECK_OCALL
(

237 
oÿÎ_’c_uÁru¡ed_wr™e_w™h_uÁru¡ed_±r
(&
»t
, 
fd
, 
buf
, 
size
));

238  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

241 
ssize_t
 
’c_uÁru¡ed_»adv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
,

242 *
buf
, 
size
) {

243 
asylo
::
UÁru¡edUniquePŒ
<> 
tmp
(
buf
);

244 
bridge_ssize_t
 
»t
;

245 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»ad_w™h_uÁru¡ed_±r
(&
»t
, 
fd
, 
buf
, 
size
));

246 
fl_iov
(
buf
, 
»t
, 
iov
, 
iovút
);

247  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

254 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

255 
»t
;

260 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sock‘
(&
»t
, 
asylo
::
ToBridgeAfFamy
(
domaš
),

261 
asylo
::
ToBridgeSock‘Ty³
(
ty³
),

262 
´ÙocŞ
));

263  
»t
;

266 
’c_uÁru¡ed_acû±
(
sockfd
, 
sockaddr
 *
addr
,

267 
sockËn_t
 *
add¾’
) {

268 
»t
;

269 
bridge_sockaddr
 
tmp
;

270 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_acû±
(&
»t
, 
sockfd
, &
tmp
));

271 ià(
»t
 == -1) {

272  
»t
;

274 ià(
addr
 !ğ
nuÎ±r
 && 
add¾’
 !=‚ullptr) {

275 
asylo
::
FromBridgeSockaddr
(&
tmp
, 
addr
, 
add¾’
);

277  
»t
;

280 
’c_uÁru¡ed_bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

281 
sockËn_t
 
add¾’
) {

282 
»t
;

283 
bridge_sockaddr
 
tmp
;

284 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_bšd
(

285 &
»t
, 
sockfd
, 
asylo
::
ToBridgeSockaddr
(
addr
, 
add¾’
, &
tmp
)));

286  
»t
;

289 
’c_uÁru¡ed_cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

290 
sockËn_t
 
add¾’
) {

291 
»t
;

292 
bridge_sockaddr
 
tmp
;

293 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_cÚÃù
(

294 &
»t
, 
sockfd
, 
asylo
::
ToBridgeSockaddr
(
addr
, 
add¾’
, &
tmp
)));

295  
»t
;

298 
ssize_t
 
’c_uÁru¡ed_£ndmsg
(
sockfd
,

299 cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

300 
æags
) {

301 
bridge_ssize_t
 
»t
;

302 
CHECK_OCALL
(

303 
oÿÎ_’c_uÁru¡ed_£ndmsg
(&
»t
, 
sockfd
, 
bridge_msg
, 
æags
));

304  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

307 
ssize_t
 
’c_uÁru¡ed_»cvmsg
(
sockfd
,

308 
msghdr
 *
msg
,

309 
bridge_msghdr
 *
bridge_msg
,

310 
æags
) {

311 
bridge_ssize_t
 
»t
;

312 
CHECK_OCALL
(

313 
oÿÎ_’c_uÁru¡ed_»cvmsg
(&
»t
, 
sockfd
, 
bridge_msg
, 
æags
));

315 
asylo
::
FromBridgeIovecA¼ay
(
bridge_msg
, 
msg
);

316  
¡©ic_ÿ¡
<
ssize_t
>(
»t
);

319 cÚ¡ *
’c_uÁru¡ed_š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
,

320 
sockËn_t
 
size
) {

321 *
»t
;

322 
bridge_size_t
 
¤c_size
;

323 ià(
af
 =ğ
AF_INET
) {

324 
¤c_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š_addr
));

325 } ià(
af
 =ğ
AF_INET6
) {

326 
¤c_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š6_addr
));

328 
”ºo
 = 
EAFNOSUPPORT
;

329  
nuÎ±r
;

331 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_š‘_Áİ
(&
»t
, 
af
, 
¤c
, 
¤c_size
, 
d¡
,

332 
¡©ic_ÿ¡
<
bridge_size_t
>(
size
)));

335 ià(!
»t
) {

336  
nuÎ±r
;

338  
d¡
;

341 
’c_uÁru¡ed_š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
) {

342 
»t
 = 0;

343 
bridge_size_t
 
d¡_size
 = 0;

344 ià(
af
 =ğ
AF_INET
) {

345 
d¡_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š_addr
));

346 } ià(
af
 =ğ
AF_INET6
) {

347 
d¡_size
 = 
¡©ic_ÿ¡
<
bridge_size_t
>((
š6_addr
));

349 
”ºo
 = 
EINVAL
;

352 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_š‘_±Ú
(&
»t
, 
asylo
::
ToBridgeAfFamy
(
af
),

353 
¤c
, 
d¡
, 
d¡_size
));

354  
»t
;

357 
’c_uÁru¡ed_g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

358 cÚ¡ 
addršfo
 *
hšts
,

359 
addršfo
 **
»s
) {

360 
¡d
::
¡ršg
 
£rŸlized_hšts
;

361 
addršfo
 
bridge_hšts
;

362 ià(
hšts
) {

363 
bridge_hšts
 = *
hšts
;

364 
bridge_hšts
.
ai_æags
 =

365 
asylo
::
ToBridgeAdd»ssInfoFÏgs
(
bridge_hšts
.
ai_æags
);

369 
bridge_”rÜ_code
 = 
BRIDGE_EAI_UNKNOWN
;

371 ià(!
asylo
::
S”ŸlizeAddršfo
(
hšts
 ? &
bridge_hšts
 : 
nuÎ±r
,

372 &
£rŸlized_hšts
, &
bridge_”rÜ_code
)) {

373 ià(
bridge_”rÜ_code
 =ğ
BRIDGE_EAI_UNKNOWN
) {

374 
LOG
(
ERROR
) << "Bad‡ddrinfo";

376  
asylo
::
FromBridgeAdd»ssInfoE¼Üs
(
bridge_”rÜ_code
);

379 
»t
;

380 *
tmp_£rŸlized_»s_¡¬t
;

381 
bridge_size_t
 
tmp_£rŸlized_»s_Ën
;

382 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘addršfo
(

383 &
»t
, 
node
, 
£rviû
, 
£rŸlized_hšts
.
c_¡r
(),

384 
¡©ic_ÿ¡
<
bridge_size_t
>(
£rŸlized_hšts
.
Ëngth
()),

385 &
tmp_£rŸlized_»s_¡¬t
, &
tmp_£rŸlized_»s_Ën
));

386 
»t
 = 
asylo
::
FromBridgeAdd»ssInfoE¼Üs
(ret);

387 ià(
»t
 != 0) {

388  
»t
;

390 ià(!
sgx_is_outside_’şave
(
tmp_£rŸlized_»s_¡¬t
,

391 
¡©ic_ÿ¡
<
size_t
>(
tmp_£rŸlized_»s_Ën
))) {

392 
LOG
(
ERROR
) << "getaddrinfo„esponse…ointer‚ot from host‡ddress space";

397 
tmp_£rŸlized_»s
[
tmp_£rŸlized_»s_Ën
];

398 
memıy
(
tmp_£rŸlized_»s
, 
tmp_£rŸlized_»s_¡¬t
,

399 
¡©ic_ÿ¡
<
size_t
>(
tmp_£rŸlized_»s_Ën
));

400 
’c_uÁru¡ed_ä“
(
tmp_£rŸlized_»s_¡¬t
);

402 
¡d
::
¡ršg
 
£rŸlized_»s
(
tmp_£rŸlized_»s
,

403 
¡©ic_ÿ¡
<
size_t
>(
tmp_£rŸlized_»s_Ën
));

404 ià(!
asylo
::
De£rŸlizeAddršfo
(&
£rŸlized_»s
, 
»s
)) {

405 
LOG
(
ERROR
) << "Invalid‡ddrinfo in getaddrinfo„esponse";

408  
»t
;

411 
’c_uÁru¡ed_ä“addršfo
(
addršfo
 *
»s
) {

412 
asylo
::
F»eDe£rŸlizedAddršfo
(
»s
);

415 
’c_uÁru¡ed_g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

416 
sockËn_t
 *
İ’
) {

417 
»t
;

418 
ho¡_İ’
 = *
İ’
;

419 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘sockİt
(

420 &
»t
, 
sockfd
, 
Ëv–
, 
asylo
::
ToBridgeO±iÚName
Öev–, 
İŠame
), 
İtv®
,

421 
ho¡_İ’
, &host_optlen));

422 *
İ’
 = 
ho¡_İ’
;

423  
»t
;

426 
’c_uÁru¡ed_£tsockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

427 cÚ¡ *
İtv®
, 
sockËn_t
 
İ’
) {

428 
»t
;

429 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_£tsockİt
(

430 &
»t
, 
sockfd
, 
Ëv–
, 
asylo
::
ToBridgeO±iÚName
Öev–, 
İŠame
), 
İtv®
,

431 
¡©ic_ÿ¡
<
bridge_size_t
>(
İ’
)));

432  
»t
;

435 
’c_uÁru¡ed_g‘sockÇme
(
sockfd
, 
sockaddr
 *
addr
,

436 
sockËn_t
 *
add¾’
) {

437 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
sockaddr
>(
addr
) ||

438 !
asylo
::
IsV®idEnşaveAdd»ss
<
sockËn_t
>(
add¾’
)) {

439 
”ºo
 = 
EFAULT
;

444 ià(*
add¾’
 =ğ0 || *add¾’ > 
INT32_MAX
) {

445 
”ºo
 = 
EINVAL
;

448 
»t
;

449 
bridge_sockaddr
 
tmp
;

450 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘sockÇme
(&
»t
, 
sockfd
, &
tmp
));

451 ià(
»t
 == 0) {

452 
asylo
::
FromBridgeSockaddr
(&
tmp
, 
addr
, 
add¾’
);

454  
»t
;

457 
’c_uÁru¡ed_g‘³”Çme
(
sockfd
, 
sockaddr
 *
addr
,

458 
sockËn_t
 *
add¾’
) {

459 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
sockaddr
>(
addr
) ||

460 !
asylo
::
IsV®idEnşaveAdd»ss
<
sockËn_t
>(
add¾’
)) {

461 
”ºo
 = 
EFAULT
;

466 ià(*
add¾’
 =ğ0 || *add¾’ > 
INT32_MAX
) {

467 
”ºo
 = 
EINVAL
;

470 
»t
;

471 
bridge_sockaddr
 
tmp
;

472 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘³”Çme
(&
»t
, 
sockfd
, &
tmp
));

473 ià(
»t
 == 0) {

474 
asylo
::
FromBridgeSockaddr
(&
tmp
, 
addr
, 
add¾’
);

476  
»t
;

479 
ssize_t
 
’c_uÁru¡ed_»cväom
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
,

480 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
) {

481 
ssize_t
 
»t
 = 0;

482 *
£rŸlized_¬gs
 = 
nuÎ±r
;

483 
size_t
 
£rŸlized_Ën
 = 0;

484 ià(!
asylo
::
S”ŸlizeRecvFromArgs
(
sockfd
, 
Ën
, 
æags
, &
£rŸlized_¬gs
,

485 &
£rŸlized_Ën
)) {

486 
”ºo
 = 
EINVAL
;

489 
asylo
::
M®locUniquePŒ
<[]> 
¬gs_±r
(
£rŸlized_¬gs
);

490 *
£rŸlized_ouut
 = 
nuÎ±r
;

491 **
£rŸlized_ouut_±r
 = 
¤c_addr
 ? &
£rŸlized_ouut
 : 
nuÎ±r
;

492 *
ouut_buf
 = 
nuÎ±r
;

493 
bridge_ssize_t
 
ouut_Ën
 = 0;

494 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»cväom
(&
»t
, 
£rŸlized_¬gs
,

495 
£rŸlized_Ën
, &
ouut_buf
,

496 
£rŸlized_ouut_±r
, &
ouut_Ën
));

497 
asylo
::
UÁru¡edUniquePŒ
<[]> 
ouut_buf_±r
(
ouut_buf
);

498 ià(
»t
 < 0) {

502 ià(!
sgx_is_outside_’şave
(
ouut_buf
, 
»t
)) {

503 
abÜt
();

505 
memıy
(
buf
, 
ouut_buf
, 
»t
);

506 ià(
¤c_addr
) {

507 
sockaddr
 *
¤c_addr_cİy
 = 
nuÎ±r
;

508 
asylo
::
UÁru¡edUniquePŒ
<[]> 
ouut_unique_±r
(
£rŸlized_ouut
);

509 ià(!
sgx_is_outside_’şave
(
£rŸlized_ouut
, 
ouut_Ën
)) {

510 
abÜt
();

512 
¡d
::
¡ršg
 
£rŸlized_ouut_¡r
(
£rŸlized_ouut
, 
ouut_Ën
);

513 ià(!
add¾’
 || !
asylo
::
De£rŸlizeRecvFromSrcAddr
(
£rŸlized_ouut_¡r
,

514 &
¤c_addr_cİy
)) {

515 
”ºo
 = 
EINVAL
;

518 
asylo
::
M®locUniquePŒ
<
sockaddr
> 
¤c_addr_±r
(
¤c_addr_cİy
);

519 ià(
¤c_addr_cİy
->
§_çmy
 =ğ
AF_INET
) {

520 
memıy
(

521 
¤c_addr
, 
¤c_addr_cİy
,

522 
¡d
::
mš
(
¡©ic_ÿ¡
<
size_t
>(*
add¾’
), (
sockaddr_š
)));

523 *
add¾’
 = (
sockaddr_š
);

524 } ià(
¤c_addr_cİy
->
§_çmy
 =ğ
AF_INET6
) {

525 
memıy
(

526 
¤c_addr
, 
¤c_addr_cİy
,

527 
¡d
::
mš
(
¡©ic_ÿ¡
<
size_t
>(*
add¾’
), (
sockaddr_š6
)));

528 *
add¾’
 = (
sockaddr_š6
);

530 
”ºo
 = 
EINVAL
;

534  
»t
;

541 
’c_uÁru¡ed_ü—‹_th»ad
(cÚ¡ *
Çme
) {

542 
»t
;

543 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_th»ad_ü—‹
(&
»t
, 
Çme
));

552 
’c_uÁru¡ed_pŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
) {

553 
»t
;

554 autØ
tmp
 = 
ab¦
::
make_unique
<
bridge_pŞlfd
[]>(
nfds
);

555 
i
 = 0; i < 
nfds
; ++i) {

556 ià(!
asylo
::
ToBridgePŞlfd
(&
fds
[
i
], &
tmp
[i])) {

557 
”ºo
 = 
EFAULT
;

561 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_pŞl
(&
»t
, 
tmp
.
g‘
(), 
nfds
, 
timeout
));

562 
i
 = 0; i < 
nfds
; ++i) {

563 ià(!
asylo
::
FromBridgePŞlfd
(&
tmp
[
i
], &
fds
[i])) {

564 
LOG
(
ERROR
) << "Invalid bridge…oll fd in…oll„esponse";

565 
”ºo
 = 
EFAULT
;

569  
»t
;

576 
’c_uÁru¡ed_•Şl_ü—‹
(
size
) {

577 
»t
 = 0;

578 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_•Şl_ü—‹
(&
»t
, 
size
));

579  
»t
;

582 
’c_uÁru¡ed_•Şl_ùl
(
•fd
, 
İ
, 
fd
,

583 
•Şl_ev’t
 *
ev’t
) {

584 *
£rŸlized_¬gs
 = 
nuÎ±r
;

585 
asylo
::
M®locUniquePŒ
<[]> 
¬gs_±r
(
£rŸlized_¬gs
);

586 
size_t
 
Ën
 = 0;

587 ià(!
asylo
::
S”ŸlizeEpŞlCArgs
(
•fd
, 
İ
, 
fd
, 
ev’t
, &
£rŸlized_¬gs
,

588 &
Ën
)) {

589 
”ºo
 = 
EINVAL
;

592 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

593 
»t
 = 0;

594 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_•Şl_ùl
(&
»t
, 
£rŸlized_¬gs
,

595 
£rŸlized_¬gs_Ën
));

596  
»t
;

599 
’c_uÁru¡ed_•Şl_wa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
,

600 
maxev’ts
, 
timeout
) {

601 *
£rŸlized_¬gs
 = 
nuÎ±r
;

602 
asylo
::
M®locUniquePŒ
<[]> 
¬gs_±r
(
£rŸlized_¬gs
);

603 
size_t
 
Ën
 = 0;

604 ià(!
asylo
::
S”ŸlizeEpŞlWa™Args
(
•fd
, 
maxev’ts
, 
timeout
, &
£rŸlized_¬gs
,

605 &
Ën
)) {

606 
”ºo
 = 
EINVAL
;

610 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

611 
»t
 = 0;

612 *
£rŸlized_ev’t_li¡
 = 
nuÎ±r
;

613 
bridge_size_t
 
£rŸlized_ev’t_li¡_Ën
 = 0;

614 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_•Şl_wa™
(

615 &
»t
, 
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
, &
£rŸlized_ev’t_li¡
,

616 &
£rŸlized_ev’t_li¡_Ën
));

617 ià(!
sgx_is_outside_’şave
(
£rŸlized_ev’t_li¡
,

618 
£rŸlized_ev’t_li¡_Ën
)) {

619 
abÜt
();

621 
asylo
::
UÁru¡edUniquePŒ
<[]>

622 
£rŸlized_ev’ts_±r
(
£rŸlized_ev’t_li¡
);

625 
¡d
::
¡ršg
 
ev’t_li¡_¡r
(
£rŸlized_ev’t_li¡
, 
£rŸlized_ev’t_li¡_Ën
);

626 
numev’ts
 = 0;

627 ià(!
asylo
::
De£rŸlizeEv’ts
(
ev’t_li¡_¡r
, 
ev’ts
, &
numev’ts
)) {

628 
”ºo
 = 
EBADE
;

634 ià(
numev’ts
 !ğ
»t
) {

635 
abÜt
();

637  
»t
;

644 
’c_uÁru¡ed_šÙify_š™1
(
nÚ_block
) {

645 
»t
 = 0;

646 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_š™1
(&
»t
, 
nÚ_block
));

647  
»t
;

650 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
,

651 
ušt32_t
 
mask
) {

652 *
£rŸlized_¬gs
 = 
nuÎ±r
;

653 
asylo
::
M®locUniquePŒ
<> 
¬gs_±r
(
£rŸlized_¬gs
);

654 
size_t
 
Ën
 = 0;

655 ià(!
asylo
::
S”ŸlizeInÙifyAddW©chArgs
(
fd
, 
·thÇme
, 
mask
, &
£rŸlized_¬gs
,

656 &
Ën
)) {

659 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

660 
»t
 = 0;

661 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_add_w©ch
(&
»t
, 
£rŸlized_¬gs
,

662 
£rŸlized_¬gs_Ën
));

663  
»t
;

666 
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
) {

667 *
£rŸlized_¬gs
 = 
nuÎ±r
;

668 
asylo
::
M®locUniquePŒ
<> 
¬gs_±r
(
£rŸlized_¬gs
);

669 
size_t
 
Ën
 = 0;

670 ià(!
asylo
::
S”ŸlizeInÙifyRmW©chArgs
(
fd
, 
wd
, &
£rŸlized_¬gs
, &
Ën
)) {

671 
”ºo
 = 
EINVAL
;

674 
bridge_size_t
 
£rŸlized_¬gs_Ën
 = 
¡©ic_ÿ¡
<bridge_size_t>(
Ën
);

675 
»t
 = 0;

676 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_rm_w©ch
(&
»t
, 
£rŸlized_¬gs
,

677 
£rŸlized_¬gs_Ën
));

678  
»t
;

681 
’c_uÁru¡ed_šÙify_»ad
(
fd
, 
size_t
 
couÁ
, **
£rŸlized_ev’ts
,

682 
size_t
 *
£rŸlized_ev’ts_Ën
) {

683 
»t
 = 0;

684 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_šÙify_»ad
(

685 &
»t
, 
fd
, 
couÁ
, 
£rŸlized_ev’ts
, 
£rŸlized_ev’ts_Ën
));

686  
»t
;

693 
’c_uÁru¡ed_g‘içddrs
(
içddrs
 **
içp
) {

694 *
£rŸlized_içddrs
 = 
nuÎ±r
;

695 
bridge_ssize_t
 
£rŸlized_içddrs_Ën
 = 0;

696 
»t
 = 0;

697 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘içddrs
(&
»t
, &
£rŸlized_içddrs
,

698 &
£rŸlized_içddrs_Ën
));

699 ià(
»t
 != 0) {

700  
»t
;

702 ià(!
sgx_is_outside_’şave
(
£rŸlized_içddrs
,

703 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_içddrs_Ën
))) {

704 
LOG
(
ERROR
) << "serialized_ifaddrs‚ot from host‡ddress space";

707 
asylo
::
UÁru¡edUniquePŒ
<> 
içddrs_¡r_±r
(
£rŸlized_içddrs
);

708 
¡d
::
¡ršg
 
içddrs_¡r
(
£rŸlized_içddrs
, 
£rŸlized_içddrs_Ën
);

709 ià(!
asylo
::
De£rŸlizeIfAddrs
(
içddrs_¡r
, 
içp
))  -1;

710  
»t
;

713 
’c_uÁru¡ed_ä“içddrs
(
içddrs
 *
iç
) {

714 
asylo
::
F»eDe£rŸlizedIfAddrs
(
iç
);

721 
·sswd
 *
’c_uÁru¡ed_g‘pwuid
(
uid_t
 
uid
) {

722 
BridgePassWd
 
bridge_·sswÜd
;

723 
»t
 = 0;

724 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘pwuid
(&
»t
, 
uid
, &
bridge_·sswÜd
));

725 ià(
»t
 != 0) {

726  
nuÎ±r
;

731 
BridgePassWd
 
·sswÜd_bufãrs
;

733 ià(!
asylo
::
CİyBridgePassWd
(&
bridge_·sswÜd
, &
·sswÜd_bufãrs
) ||

734 !
asylo
::
FromBridgePassWd
(&
·sswÜd_bufãrs
, &asylo::
glob®_·sswÜd
)) {

735 
”ºo
 = 
EFAULT
;

736  
nuÎ±r
;

739  &
asylo
::
glob®_·sswÜd
;

746 
’c_uÁru¡ed_sched_g‘affš™y
(
pid_t
 
pid
, 
size_t
 
ıu£tsize
,

747 
ıu_£t_t
 *
mask
) {

748 ià(
ıu£tsize
 < (
ıu_£t_t
)) {

749 
”ºo
 = 
EINVAL
;

753 
»t
;

754 
BridgeCpuS‘
 
bridge_mask
;

755 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sched_g‘affš™y
(

756 &
»t
, 
¡©ic_ÿ¡
<
št64_t
>(
pid
), &
bridge_mask
));

759 
CPU_ZERO
(
mask
);

760 
ıu
 = 0; cpu < 
CPU_SETSIZE
; ++cpu) {

761 ià(
asylo
::
BridgeCpuS‘CheckB™
(
ıu
, &
bridge_mask
)) {

762 
CPU_SET
(
ıu
, 
mask
);

766  
»t
;

773 
’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

774 
signum
, (*
bridge_sigaùiÚ
)(, 
bridge_sigšfo_t
 *, *),

775 cÚ¡ 
sig£t_t
 
mask
, 
æags
, cÚ¡ *
’şave_Çme
) {

776 
bridge_signum
 = 
asylo
::
ToBridgeSigÇl
(
signum
);

777 ià(
bridge_signum
 < 0) {

778 
”ºo
 = 
EINVAL
;

781 
BridgeSigÇlHªdËr
 
hªdËr
;

782 
hªdËr
.
sigaùiÚ
 = 
bridge_sigaùiÚ
;

783 
asylo
::
ToBridgeSigS‘
(&
mask
, &
hªdËr
.mask);

784 
hªdËr
.
æags
 = 
asylo
::
ToBridgeSigÇlFÏgs
(flags);

785 
»t
;

786 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

787 &
»t
, 
bridge_signum
, &
hªdËr
, 
’şave_Çme
));

788  
»t
;

791 
’c_uÁru¡ed_sig´ocmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
) {

792 
bridge_sig£t_t
 
bridge_£t
;

793 
asylo
::
ToBridgeSigS‘
(
£t
, &
bridge_£t
);

794 
bridge_sig£t_t
 
bridge_Şd_£t
;

795 
»t
;

796 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sig´ocmask
(

797 &
»t
, 
asylo
::
ToBridgeSigMaskAùiÚ
(
how
), &
bridge_£t
, &
bridge_Şd_£t
));

798 
asylo
::
FromBridgeSigS‘
(&
bridge_Şd_£t
, 
Şd£t
);

799  
»t
;

802 
’c_uÁru¡ed_¿i£
(
sig
) {

803 
bridge_sig
 = 
asylo
::
ToBridgeSigÇl
(
sig
);

804 ià(
bridge_sig
 < 0) {

805 
”ºo
 = 
EINVAL
;

808 
»t
;

809 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_¿i£
(&
»t
, 
bridge_sig
));

810  
»t
;

817 
’c_uÁru¡ed_g‘ru§ge
(
who
, 
ru§ge
 *
u§ge
) {

818 
»t
;

819 
BridgeRU§ge
 
bridge_u§ge
;

820 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘ru§ge
(

821 &
»t
, 
asylo
::
ToBridgeRU§geT¬g‘
(
who
), &
bridge_u§ge
));

822 
asylo
::
FromBridgeRU§ge
(&
bridge_u§ge
, 
u§ge
);

823  
»t
;

830 
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
) {

831 
»t
;

832 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_æock
(

833 &
»t
, 
fd
, 
asylo
::
ToBridgeFLockO³¿tiÚ
(
İ”©iÚ
)));

834  
»t
;

841 
’c_uÁru¡ed_£Ëù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
,

842 
fd_£t
 *
exû±fds
, 
timev®
 *
timeout
) {

843 
BridgeFDS‘
 
bridge_»adfds
, 
bridge_wr™efds
, 
bridge_exû±fds
;

844 ià(
»adfds
 && !
asylo
::
ToBridgeFDS‘
Ô—dfds, &
bridge_»adfds
)) {

845 
”ºo
 = 
EBADE
;

848 ià(
wr™efds
 && !
asylo
::
ToBridgeFDS‘
(wr™efds, &
bridge_wr™efds
)) {

849 
”ºo
 = 
EBADE
;

852 ià(
exû±fds
 && !
asylo
::
ToBridgeFDS‘
Óxû±fds, &
bridge_exû±fds
)) {

853 
”ºo
 = 
EBADE
;

856 
bridge_timev®
 
bridge_timeout
;

857 ià(!
asylo
::
ToBridgeTimeV®
(
timeout
, &
bridge_timeout
)) {

858 
”ºo
 = 
EBADE
;

861 
»t
;

862 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_£Ëù
(&
»t
, 
nfds
, &
bridge_»adfds
,

863 &
bridge_wr™efds
, &
bridge_exû±fds
,

864 &
bridge_timeout
));

866 ià(
»adfds
 && !
asylo
::
FromBridgeFDS‘
(&
bridge_»adfds
,„eadfds)) {

867 
”ºo
 = 
EBADE
;

870 ià(
wr™efds
 && !
asylo
::
FromBridgeFDS‘
(&
bridge_wr™efds
, writefds)) {

871 
”ºo
 = 
EBADE
;

874 ià(
exû±fds
 && !
asylo
::
FromBridgeFDS‘
(&
bridge_exû±fds
,ƒxceptfds)) {

875 
”ºo
 = 
EBADE
;

878  
»t
;

885 
’c_uÁru¡ed_İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
) {

886 
CHECK_OCALL
(

887 
oÿÎ_’c_uÁru¡ed_İ’log
(
id’t
, 
asylo
::
ToBridgeSysLogO±iÚ
(
İtiÚ
),

888 
asylo
::
ToBridgeSysLogFac™y
(
çc™y
)));

891 
’c_uÁru¡ed_sy¦og
(
´iÜ™y
, cÚ¡ *
mes§ge
) {

892 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_sy¦og
(

893 
asylo
::
ToBridgeSysLogPriÜ™y
(
´iÜ™y
), 
mes§ge
));

900 
’c_uÁru¡ed_Çno¦“p
(cÚ¡ 
time¥ec
 *
»q
, time¥eø*
»m
) {

901 
»t
;

902 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_Çno¦“p
(

903 &
»t
, 
»š‹½»t_ÿ¡
<cÚ¡ 
bridge_time¥ec
 *>(
»q
),

904 
»š‹½»t_ÿ¡
<
bridge_time¥ec
 *>(
»m
)));

905  
»t
;

908 
’c_uÁru¡ed_times
(
tms
 *
buf
) {

909 
»t
;

910 
BridgeTms
 
bridge_buf
;

911 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_times
(&
»t
, &
bridge_buf
));

912 ià(!
asylo
::
FromBridgeTms
(&
bridge_buf
, 
buf
)) {

913 
”ºo
 = 
EFAULT
;

916  
»t
;

919 
’c_uÁru¡ed_şock_g‘time
(
şockid_t
 
şk_id
, 
time¥ec
 *

) {

920 
»t
;

921 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_şock_g‘time
(

922 &
»t
, 
¡©ic_ÿ¡
<
bridge_şockid_t
>(
şk_id
),

923 
»š‹½»t_ÿ¡
<
bridge_time¥ec
 *>(

)));

924  
»t
;

927 
’c_uÁru¡ed_g‘™im”
(
which
, 
™im”v®
 *
cu¼_v®ue
) {

928 
»t
;

929 
BridgeITim”V®
 
bridge_cu¼_v®ue
;

930 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘™im”
(

931 &
»t
, 
asylo
::
ToBridgeTim”Ty³
(
which
), &
bridge_cu¼_v®ue
));

932 ià(
cu¼_v®ue
 =ğ
nuÎ±r
 ||

933 !
asylo
::
FromBridgeITim”V®
(&
bridge_cu¼_v®ue
, 
cu¼_v®ue
)) {

934 
”ºo
 = 
EFAULT
;

937  
»t
;

940 
’c_uÁru¡ed_£t™im”
(
which
, cÚ¡ 
™im”v®
 *
Ãw_v®ue
,

941 
™im”v®
 *
Şd_v®ue
) {

942 
»t
;

943 
BridgeITim”V®
 
bridge_Ãw_v®ue
, 
bridge_Şd_v®ue
;

944 ià(!
asylo
::
ToBridgeITim”V®
(
Ãw_v®ue
, &
bridge_Ãw_v®ue
)) {

945 
”ºo
 = 
EFAULT
;

948 
CHECK_OCALL
(

949 
oÿÎ_’c_uÁru¡ed_£t™im”
(&
»t
, 
asylo
::
ToBridgeTim”Ty³
(
which
),

950 &
bridge_Ãw_v®ue
, &
bridge_Şd_v®ue
));

952 ià(
Şd_v®ue
 !ğ
nuÎ±r
 &&

953 !
asylo
::
FromBridgeITim”V®
(&
bridge_Şd_v®ue
, 
Şd_v®ue
)) {

954 
”ºo
 = 
EFAULT
;

957  
»t
;

964 
’c_uÁru¡ed_g‘timeofday
(
timev®
 *
tv
, *
tz
) {

965 
»t
;

966 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_g‘timeofday
(

967 &
»t
, 
»š‹½»t_ÿ¡
<
bridge_timev®
 *>(
tv
), 
nuÎ±r
));

968  
»t
;

975 
’c_uÁru¡ed_uÇme
(
ut¢ame
 *
ut¢ame_v®
) {

976 ià(!
ut¢ame_v®
) {

977 
”ºo
 = 
EFAULT
;

981 
BridgeUtsName
 
bridge_ut¢ame_v®
;

982 
»t
;

983 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_uÇme
(&
»t
, &
bridge_ut¢ame_v®
));

984 ià(
»t
 != 0) {

985  
»t
;

988 ià(!
asylo
::
CÚv”tUtsName
(
bridge_ut¢ame_v®
, 
ut¢ame_v®
)) {

989 
LOG
(
FATAL
) << "uname„eturned‡n ill-formed utsname";

992  
»t
;

999 
’c_uÁru¡ed_pe2
(
pefd
[2], 
æags
) {

1000 ià(
æags
 & ~(
O_CLOEXEC
 | 
O_DIRECT
 | 
O_NONBLOCK
)) {

1001 
”ºo
 = 
EINVAL
;

1005 
»t
;

1006 
CHECK_OCALL
(

1007 
oÿÎ_’c_uÁru¡ed_pe2
(&
»t
, 
pefd
, 
asylo
::
ToBridgeFeFÏgs
(
æags
)));

1008  
»t
;

1011 
št64_t
 
’c_uÁru¡ed_syscÚf
(
Çme
) {

1012 
št64_t
 
»t
;

1013 
SyscÚfCÚ¡ªts
 
bridge_Çme
 = 
asylo
::
ToBridgeSyscÚfCÚ¡ªts
(
Çme
);

1014 ià(
bridge_Çme
 =ğ
BRIDGE_SC_UNKNOWN
) {

1015 
”ºo
 = 
EINVAL
;

1018 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_syscÚf
(&
»t
, 
bridge_Çme
));

1019  
»t
;

1022 
ušt32_t
 
’c_uÁru¡ed_¦“p
(ušt32_ˆ
£cÚds
) {

1023 
ušt32_t
 
»t
;

1024 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_¦“p
(&
»t
, 
£cÚds
));

1025  
»t
;

1028 
’c_uÁru¡ed__ex™
(
rc
è{ 
oÿÎ_’c_uÁru¡ed__ex™
(rc); }

1030 
pid_t
 
’c_uÁru¡ed_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ *
cÚfig
,

1031 
size_t
 
cÚfig_Ën
, 
boŞ
 
»¡Üe_¢­shÙ
) {

1032 
pid_t
 
»t
;

1033 
sgx_¡©us_t
 
¡©us
 = 
oÿÎ_’c_uÁru¡ed_fÜk
(

1034 &
»t
, 
’şave_Çme
, 
cÚfig
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
cÚfig_Ën
),

1035 
»¡Üe_¢­shÙ
);

1036 ià(
¡©us
 !ğ
SGX_SUCCESS
) {

1037 
”ºo
 = 
EINTR
;

1040  
»t
;

1047 
pid_t
 
’c_uÁru¡ed_wa™3
(*
w¡©us
, 
İtiÚs
, 
ru§ge
 *
u§ge
) {

1048 
pid_t
 
»t
;

1049 
BridgeWStus
 
bridge_w¡©us
;

1050 
BridgeRU§ge
 
bridge_u§ge
;

1051 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_wa™3
(&
»t
, &
bridge_w¡©us
,

1052 
asylo
::
ToBridgeWa™O±iÚs
(
İtiÚs
),

1053 &
bridge_u§ge
));

1054 ià(
w¡©us
) {

1055 *
w¡©us
 = 
asylo
::
FromBridgeWStus
(
bridge_w¡©us
);

1057 
asylo
::
FromBridgeRU§ge
(&
bridge_u§ge
, 
u§ge
);

1058  
»t
;

1061 
pid_t
 
’c_uÁru¡ed_wa™pid
Õid_ˆ
pid
, *
w¡©us
, 
İtiÚs
) {

1062 
pid_t
 
»t
;

1063 
BridgeWStus
 
bridge_w¡©us
;

1064 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_wa™pid
(&
»t
, 
pid
, &
bridge_w¡©us
,

1065 
asylo
::
ToBridgeWa™O±iÚs
(
İtiÚs
)));

1066 ià(
w¡©us
) {

1067 *
w¡©us
 = 
asylo
::
FromBridgeWStus
(
bridge_w¡©us
);

1069  
»t
;

1076 
’c_uÁru¡ed_utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
) {

1077 
»t
;

1078 
bridge_utimbuf
 
tmp_bridge_utimbuf
;

1079 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_utime
(

1080 &
»t
, 
f’ame
, 
asylo
::
ToBridgeUtimbuf
(
times
, &
tmp_bridge_utimbuf
)));

1081  
»t
;

1084 
’c_uÁru¡ed_utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]) {

1085 
»t
;

1086 
bridge_timev®
 
bridge_acûss_time
;

1087 
bridge_timev®
 
bridge_modifiÿtiÚ_time
;

1088 ià(!
asylo
::
ToBridgeTimeV®
(&
times
[0], &
bridge_acûss_time
) ||

1089 !
asylo
::
ToBridgeTimeV®
(&
times
[1], &
bridge_modifiÿtiÚ_time
)) {

1090 
”ºo
 = 
EBADE
;

1093 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_utimes
(&
»t
, 
f’ame
, &
bridge_acûss_time
,

1094 &
bridge_modifiÿtiÚ_time
));

1095  
»t
;

1102 *
’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1103 cÚ¡ *
Çme
) {

1104 *
»t
;

1105 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(&
»t
, 
kšd
, 
Çme
));

1106  
»t
;

1109 
’c_uÁru¡ed_»Ëa£_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1110 cÚ¡ *
Çme
) {

1111 
»t
;

1112 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_»Ëa£_sh¬ed_»sourû
(&
»t
, 
kšd
, 
Çme
));

1113  
»t
 ? 0 : -1;

1120 
’c_uÁru¡ed_hex_dump
(cÚ¡ *
buf
, 
nby‹s
) {

1121 
CHECK_OCALL
(
oÿÎ_’c_uÁru¡ed_hex_dump
(
buf
, 
nby‹s
));

	@platform/arch/sgx/trusted/register_signal.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/»gi¡”_sigÇl.h
"

21 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

23 "C" 
	$’c_»gi¡”_sigÇl
(
signum
, cÚ¡ 
sig£t_t
 
mask
, 
æags
,

24 cÚ¡ *
’şave_Çme
) {

25  
	`’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

26 
signum
, 
nuÎ±r
, 
mask
, 
æags
, 
’şave_Çme
);

27 
	}
}

	@platform/arch/sgx/trusted/register_signal.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/»gi¡”_sigÇl.h
"

21 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

23 "C" 
	$’c_»gi¡”_sigÇl
(
signum
, cÚ¡ 
sig£t_t
 
mask
, 
æags
,

24 cÚ¡ *
’şave_Çme
) {

25  
	`’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

26 
signum
, 
nuÎ±r
, 
mask
, 
æags
, 
’şave_Çme
);

27 
	}
}

	@platform/arch/sgx/untrusted/ocalls.cc

22 #iâdeà
_GNU_SOURCE


23 
	#_GNU_SOURCE


	)

26 
	~<¬·/š‘.h
>

27 
	~<fú.h
>

28 
	~<içddrs.h
>

29 
	~<Ãtdb.h
>

30 
	~<pŞl.h
>

31 
	~<pwd.h
>

32 
	~<sched.h
>

33 
	~<sys/•Şl.h
>

34 
	~<sys/fe.h
>

35 
	~<sys/šÙify.h
>

36 
	~<sys/£Ëù.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/¡©.h
>

39 
	~<sys/time.h
>

40 
	~<sys/ut¢ame.h
>

41 
	~<sys/wa™.h
>

42 
	~<sy¦og.h
>

43 
	~<uni¡d.h
>

44 
	~<utime.h
>

46 
	~<®gÜ™hm
>

47 
	~<û¼no
>

48 
	~<csigÇl
>

49 
	~<c¡dšt
>

50 
	~<c¡dio
>

51 
	~<c¡dlib
>

52 
	~<ùime
>

53 
	~<™”©Ü
>

54 
	~<veùÜ
>

56 
	~"ab¦/memÜy/memÜy.h
"

57 
	~"asylo/’şave.pb.h
"

58 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/g’”©ed_bridge_u.h
"

59 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/sgx_ş›Á.h
"

60 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

61 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

62 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

63 
	~"asylo/¶©fÜm/commÚ/debug_¡ršgs.h
"

64 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

65 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

66 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme.h
"

67 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

68 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

69 
	~"asylo/ut/¡©us.h
"

70 
	~"asylo/ut/¡©us_maüos.h
"

72 
	~"asylo/ut/loggšg.h
"

74 
	gÇme¥aû
 {

79 (*
	ghªdË_sigÇl_šside_’şave
)(, 
	gbridge_sigšfo_t
 *,

80 *èğ
nuÎ±r
;

84 
T¿n¦©eToBridgeAndHªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
,

85 *
ucÚ‹xt
) {

86 
	gbridge_signum
 = 
asylo
::
ToBridgeSigÇl
(
signum
);

87 ià(
	gbridge_signum
 < 0) {

91 
bridge_sigšfo_t
 
	gbridge_sigšfo
;

92 
	gasylo
::
ToBridgeSigInfo
(
šfo
, &
bridge_sigšfo
);

93 ià(
	ghªdË_sigÇl_šside_’şave
) {

94 
hªdË_sigÇl_šside_’şave
(
bridge_signum
, &
bridge_sigšfo
, 
ucÚ‹xt
);

103 
EÁ”EnşaveAndHªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

104 
	gasylo
::
EnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
()->
EÁ”EnşaveAndHªdËSigÇl
(

105 
signum
, 
šfo
, 
ucÚ‹xt
);

114 
HªdËSigÇlInSim
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

115 autØ
	gş›Á_»suÉ
 =

116 
asylo
::
EnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
()->
G‘Cl›ÁFÜSigÇl
(
signum
);

117 ià(!
	gş›Á_»suÉ
.
ok
()) {

120 
	gasylo
::
SgxCl›Á
 *
ş›Á
 =

121 
dyÇmic_ÿ¡
<
asylo
::
SgxCl›Á
 *>(
ş›Á_»suÉ
.
V®ueOrD›
());

122 ià(
	gş›Á
->
IsTcsAùive
()) {

123 
T¿n¦©eToBridgeAndHªdËSigÇl
(
signum
, 
šfo
, 
ucÚ‹xt
);

125 
EÁ”EnşaveAndHªdËSigÇl
(
signum
, 
šfo
, 
ucÚ‹xt
);

130 
	gasylo
::
Stus
 
DoSÇpshÙKeyT¿nsãr
(
asylo
::
EnşaveMªag”
 *
mªag”
,

131 
asylo
::
EnşaveCl›Á
 *
ş›Á
,

132 
£lf_sock‘
, 
³”_sock‘
,

133 
boŞ
 
is_·»Á
) {

134 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
£lf_sock‘_şo£r
(
£lf_sock‘
);

137 ià(
şo£
(
³”_sock‘
) < 0) {

138  
	gasylo
::
Stus
(
¡©ic_ÿ¡
<
asylo
::
”rÜ
::
PosixE¼Ü
>(
”ºo
),

139 
ab¦
::
SŒC©
("şo£ faed: ", 
¡»¼Ü
(
”ºo
)));

142 
	gasylo
::
FÜkHªdshakeCÚfig
 
fÜk_hªdshake_cÚfig
;

143 
	gfÜk_hªdshake_cÚfig
.
£t_is_·»Á
(
is_·»Á
);

144 
	gfÜk_hªdshake_cÚfig
.
£t_sock‘
(
£lf_sock‘
);

145 
	gasylo
::
SgxCl›Á
 *
sgx_ş›Á
 = 
dyÇmic_ÿ¡
<
asylo
::SgxCl›Á *>(
ş›Á
);

146 
ASYLO_RETURN_IF_ERROR
(
sgx_ş›Á
->
EÁ”AndT¿nsãrSecu»SÇpshÙKey
(

147 
fÜk_hªdshake_cÚfig
));

149  
	gasylo
::
Stus
::
OkStus
();

153 şas 
	cSÇpshÙD©aD–‘”
 {

154 
	gpublic
:

155 
ex¶ic™
 
SÇpshÙD©aD–‘”
(cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
)

156 : 
ch”‹xt_d–‘”_
(
»š‹½»t_ÿ¡
<*>(
’Œy
.
ch”‹xt_ba£
())),

157 
nÚû_d–‘”_
(
»š‹½»t_ÿ¡
<*>(
’Œy
.
nÚû_ba£
())) {}

159 
	g´iv©e
:

160 
asylo
::
M®locUniquePŒ
<> 
ch”‹xt_d–‘”_
;

161 
	gasylo
::
M®locUniquePŒ
<> 
nÚû_d–‘”_
;

167 "C" 
__asylo_dÚ©e_th»ad
(cÚ¡ *
Çme
);

173 
	$oÿÎ_’c_uÁru¡ed_puts
(cÚ¡ *
¡r
) {

174 
rc
 = 
	`puts
(
¡r
);

177 
	`fæush
(
¡dout
);

178  
rc
;

179 
	}
}

181 *
	$oÿÎ_’c_uÁru¡ed_m®loc
(
bridge_size_t
 
size
) {

182 *
»t
 = 
	`m®loc
(
¡©ic_ÿ¡
<
size_t
>(
size
));

183  
»t
;

184 
	}
}

186 **
	$oÿÎ_’c_uÁru¡ed_®loÿ‹_bufãrs
(
bridge_size_t
 
couÁ
,

187 
bridge_size_t
 
size
) {

188 **
bufãrs
 = 
»š‹½»t_ÿ¡
<**>(

189 
	`m®loc
(
¡©ic_ÿ¡
<
size_t
>(
couÁ
) * (*)));

190 
i
 = 0; i < 
couÁ
; i++) {

191 
bufãrs
[
i
] = 
	`m®loc
(
size
);

193  
bufãrs
;

194 
	}
}

196 
	$oÿÎ_’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(**
ä“_li¡
,

197 
bridge_size_t
 
couÁ
) {

202 
i
 = 0; i < 
couÁ
; i++) {

203 
	`ä“
(
ä“_li¡
[
i
]);

205 
	}
}

207 
	$oÿÎ_’c_uÁru¡ed_İ’
(cÚ¡ *
·th_Çme
, 
æags
, 
ušt32_t
 
mode
) {

208 
ho¡_æags
 = 
asylo
::
	`FromBridgeFeFÏgs
(
æags
);

209 
»t
 = 
	`İ’
(
·th_Çme
, 
ho¡_æags
, 
mode
);

210  
»t
;

211 
	}
}

213 
	$oÿÎ_’c_uÁru¡ed_fú
(
fd
, 
bridge_cmd
, 
št64_t
 
¬g
) {

214 
cmd
 = 
asylo
::
	`FromBridgeFúCmd
(
bridge_cmd
);

215 ià(
cmd
 == -1) {

216 
”ºo
 = 
EINVAL
;

220 
»t
;

221 
cmd
) {

222 
F_SETFL
:

223 
»t
 = 
	`fú
(
fd
, 
cmd
, 
asylo
::
	`FromBridgeFeFÏgs
(
¬g
));

225 
F_SETFD
:

226 
»t
 = 
	`fú
(
fd
, 
cmd
, 
asylo
::
	`FromBridgeFDFÏgs
(
¬g
));

228 
F_GETFL
:

229 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

230 ià(
»t
 != -1) {

231 
»t
 = 
asylo
::
	`ToBridgeFeFÏgs
(ret);

234 
F_GETFD
:

235 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

236 ià(
»t
 != -1) {

237 
»t
 = 
asylo
::
	`ToBridgeFDFÏgs
(ret);

240 
F_GETPIPE_SZ
:

241 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

243 
F_SETPIPE_SZ
:

244 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

247 
”ºo
 = 
EINVAL
;

250  
»t
;

251 
	}
}

253 
	$oÿÎ_’c_uÁru¡ed_¡©
(cÚ¡ *
·thÇme
,

254 
bridge_¡©
 *
¡©_bufãr
) {

255 
¡©
 
ho¡_¡©_bufãr
;

256 
»t
 = 
	`¡©
(
·thÇme
, &
ho¡_¡©_bufãr
);

257 
asylo
::
	`ToBridgeSt
(&
ho¡_¡©_bufãr
, 
¡©_bufãr
);

258  
»t
;

259 
	}
}

261 
	$oÿÎ_’c_uÁru¡ed_f¡©
(
fd
, 
bridge_¡©
 *
¡©_bufãr
) {

262 
¡©
 
ho¡_¡©_bufãr
;

263 
»t
 = 
	`f¡©
(
fd
, &
ho¡_¡©_bufãr
);

264 
asylo
::
	`ToBridgeSt
(&
ho¡_¡©_bufãr
, 
¡©_bufãr
);

265  
»t
;

266 
	}
}

268 
	$oÿÎ_’c_uÁru¡ed_l¡©
(cÚ¡ *
·thÇme
,

269 
bridge_¡©
 *
¡©_bufãr
) {

270 
¡©
 
ho¡_¡©_bufãr
;

271 
»t
 = 
	`l¡©
(
·thÇme
, &
ho¡_¡©_bufãr
);

272 
asylo
::
	`ToBridgeSt
(&
ho¡_¡©_bufãr
, 
¡©_bufãr
);

273  
»t
;

274 
	}
}

276 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_wr™e_w™h_uÁru¡ed_±r
(
fd
,

277 cÚ¡ *
buf
,

278 
size
) {

279  
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`wr™e
(
fd
, 
buf
, 
size
));

280 
	}
}

282 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_»ad_w™h_uÁru¡ed_±r
(
fd
, *
buf
,

283 
size
) {

284  
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`»ad
(
fd
, 
buf
, 
size
));

285 
	}
}

291 
	$oÿÎ_’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

292  
	`sock‘
(
asylo
::
	`FromBridgeAfFamy
(
domaš
),

293 
asylo
::
	`FromBridgeSock‘Ty³
(
ty³
), 
´ÙocŞ
);

294 
	}
}

296 
	$oÿÎ_’c_uÁru¡ed_cÚÃù
(
sockfd
,

297 cÚ¡ 
bridge_sockaddr
 *
bridge_addr
) {

298 
sockaddr_¡Üage
 
tmp
;

299 
sockËn_t
 
Ën
 = (
tmp
);

300 
sockaddr
 *
addr
 = 
asylo
::
	`FromBridgeSockaddr
(

301 
bridge_addr
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
Ën
);

303 
	`LOG_IF
(
FATAL
, 
addr
 =ğ
nuÎ±r
) << "Unexpected bridge failure";

304 
	`LOG_IF
(
FATAL
, 
Ën
 > (
tmp
)) << "Insufficient sockaddr buf space";

306 
»t
 = 
	`cÚÃù
(
sockfd
, 
addr
, 
Ën
);

307  
»t
;

308 
	}
}

310 
	$oÿÎ_’c_uÁru¡ed_bšd
(
sockfd
,

311 cÚ¡ 
bridge_sockaddr
 *
bridge_addr
) {

312 
sockaddr_¡Üage
 
tmp
;

313 
sockËn_t
 
Ën
 = (
tmp
);

314 
sockaddr
 *
addr
 = 
asylo
::
	`FromBridgeSockaddr
(

315 
bridge_addr
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
Ën
);

317 
	`LOG_IF
(
FATAL
, 
addr
 =ğ
nuÎ±r
) << "Unexpected bridge failure";

318 
	`LOG_IF
(
FATAL
, 
Ën
 > (
tmp
)) << "Insufficient sockaddr buf space";

320 
»t
 = 
	`bšd
(
sockfd
, 
addr
, 
Ën
);

321  
»t
;

322 
	}
}

324 
	$oÿÎ_’c_uÁru¡ed_acû±
(
sockfd
, 
bridge_sockaddr
 *
addr
) {

325 
sockaddr_¡Üage
 
tmp
;

326 
sockËn_t
 
tmp_Ën
 = (
tmp
);

327 
»t
 = 
	`acû±
(
sockfd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
tmp_Ën
);

328 ià(
»t
 == -1) {

329  
»t
;

331 ià(!
asylo
::
	`ToBridgeSockaddr
(
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
),

332 (
tmp
), 
addr
)) {

333 
”ºo
 = 
EFAULT
;

336  
»t
;

337 
	}
}

339 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_£ndmsg
(
sockfd
,

340 cÚ¡ 
bridge_msghdr
 *
msg
,

341 
æags
) {

342 
msghdr
 
tmp
;

343 ià(!
asylo
::
	`FromBridgeMsgHdr
(
msg
, &
tmp
)) {

344 
”ºo
 = 
EFAULT
;

347 autØ
buf
 = 
ab¦
::
make_unique
<
iovec
[]>(
msg
->
msg_iovËn
);

348 
i
 = 0; i < 
msg
->
msg_iovËn
; ++i) {

349 ià(!
asylo
::
	`FromBridgeIovec
(&
msg
->
msg_iov
[
i
], &
buf
[i])) {

350 
”ºo
 = 
EFAULT
;

354 
tmp
.
msg_iov
 = 
buf
.
	`g‘
();

355 
bridge_ssize_t
 
»t
 =

356 
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`£ndmsg
(
sockfd
, &
tmp
, 
æags
));

357  
»t
;

358 
	}
}

360 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_»cvmsg
(
sockfd
,

361 
bridge_msghdr
 *
msg
,

362 
æags
) {

363 
msghdr
 
tmp
;

364 ià(!
asylo
::
	`FromBridgeMsgHdr
(
msg
, &
tmp
)) {

365 
”ºo
 = 
EFAULT
;

368 autØ
buf
 = 
ab¦
::
make_unique
<
iovec
[]>(
msg
->
msg_iovËn
);

369 
i
 = 0; i < 
msg
->
msg_iovËn
; ++i) {

370 ià(!
asylo
::
	`FromBridgeIovec
(&
msg
->
msg_iov
[
i
], &
buf
[i])) {

371 
”ºo
 = 
EFAULT
;

375 
tmp
.
msg_iov
 = 
buf
.
	`g‘
();

376 
bridge_ssize_t
 
»t
 =

377 
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`»cvmsg
(
sockfd
, &
tmp
, 
æags
));

378 ià(!
asylo
::
	`ToBridgeIovecA¼ay
(&
tmp
, 
msg
)) {

379 
”ºo
 = 
EFAULT
;

382  
»t
;

383 
	}
}

385 *
	$oÿÎ_’c_uÁru¡ed_š‘_Áİ
(
af
, cÚ¡ *
¤c
,

386 
bridge_size_t
 
¤c_size
, *
d¡
,

387 
bridge_size_t
 
buf_size
) {

390 ()
¤c_size
;

391 cÚ¡ *
»t
 = 
	`š‘_Áİ
(
af
, 
¤c
, 
d¡
, 
¡©ic_ÿ¡
<
size_t
>(
buf_size
));

393  
cÚ¡_ÿ¡
<*>(
»t
);

394 
	}
}

396 
	$oÿÎ_’c_uÁru¡ed_š‘_±Ú
(
AfFamy
 
af
, cÚ¡ *
¤c
, *
d¡
,

397 
bridge_size_t
 
d¡_size
) {

400 (è
d¡_size
;

401  
	`š‘_±Ú
(
asylo
::
	`FromBridgeAfFamy
(
af
), 
¤c
, 
d¡
);

402 
	}
}

404 
	$oÿÎ_’c_uÁru¡ed_g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

405 cÚ¡ *
£rŸlized_hšts
,

406 
bridge_size_t
 
£rŸlized_hšts_Ën
,

407 **
£rŸlized_»s_¡¬t
,

408 
bridge_size_t
 *
£rŸlized_»s_Ën
) {

409 
addršfo
 *
hšts
;

410 
¡d
::
¡ršg
 
	`tmp_£rŸlized_hšts
(
£rŸlized_hšts
,

411 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_hšts_Ën
));

412 ià(!
asylo
::
	`De£rŸlizeAddršfo
(&
tmp_£rŸlized_hšts
, &
hšts
)) {

416 
addršfo
 *
»s
;

417 
»t
 = 
	`g‘addršfo
(
node
, 
£rviû
, 
hšts
, &
»s
);

418 ià(
»t
 != 0) {

419  
asylo
::
	`ToBridgeAdd»ssInfoE¼Üs
(
»t
);

421 
asylo
::
	`F»eDe£rŸlizedAddršfo
(
hšts
);

423 
¡d
::
¡ršg
 
tmp_£rŸlized_»s
;

424 
bridge_”rÜ_code
 = -1;

425 ià(!
asylo
::
	`S”ŸlizeAddršfo
(
»s
, &
tmp_£rŸlized_»s
, &
bridge_”rÜ_code
)) {

426  
bridge_”rÜ_code
;

428 
	`ä“addršfo
(
»s
);

431 
size_t
 
tmp_£rŸlized_»s_Ën
 = 
tmp_£rŸlized_»s
.
	`Ëngth
();

432 *
£rŸlized_»s
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
tmp_£rŸlized_»s_Ën
));

433 
	`memıy
(
£rŸlized_»s
, 
tmp_£rŸlized_»s
.
	`c_¡r
(), 
tmp_£rŸlized_»s_Ën
);

434 *
£rŸlized_»s_¡¬t
 = 
£rŸlized_»s
;

435 *
£rŸlized_»s_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
tmp_£rŸlized_»s_Ën
);

437 
	}
}

439 
	$oÿÎ_’c_uÁru¡ed_g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

440 *
İtv®
, 
İ’_š
,

441 *
İ’_out
) {

442 
»t
 =

443 
	`g‘sockİt
(
sockfd
, 
Ëv–
, 
asylo
::
	`FromBridgeO±iÚName
Öev–, 
İŠame
),

444 
İtv®
, 
»š‹½»t_ÿ¡
<
sockËn_t
 *>(&
İ’_š
));

445 *
İ’_out
 = 
İ’_š
;

446  
»t
;

447 
	}
}

449 
	$oÿÎ_’c_uÁru¡ed_£tsockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

450 cÚ¡ *
İtv®
, 
bridge_size_t
 
İ’
) {

451  
	`£tsockİt
(
sockfd
, 
Ëv–
, 
asylo
::
	`FromBridgeO±iÚName
Öev–, 
İŠame
),

452 
İtv®
, 
¡©ic_ÿ¡
<
sockËn_t
>(
İ’
));

453 
	}
}

455 
	$oÿÎ_’c_uÁru¡ed_g‘sockÇme
(
sockfd
, 
bridge_sockaddr
 *
addr
) {

456 
sockaddr_¡Üage
 
tmp
;

457 
sockËn_t
 
tmp_Ën
 = (
tmp
);

458 
»t
 =

459 
	`g‘sockÇme
(
sockfd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
tmp_Ën
);

461 
	`LOG_IF
(
FATAL
, 
tmp_Ën
 > (
tmp
)) << "Insufficient sockaddr buf space";

464 ià(
»t
 == 0) {

465 ià(!
asylo
::
	`ToBridgeSockaddr
(
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
),

466 (
tmp
), 
addr
)) {

467 
”ºo
 = 
EFAULT
;

471  
»t
;

472 
	}
}

474 
	$oÿÎ_’c_uÁru¡ed_g‘³”Çme
(
sockfd
, 
bridge_sockaddr
 *
addr
) {

475 
sockaddr_¡Üage
 
tmp
;

476 
sockËn_t
 
tmp_Ën
 = (
tmp
);

477 
»t
 =

478 
	`g‘³”Çme
(
sockfd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
tmp_Ën
);

479 ià(
»t
 == 0) {

480 ià(!
asylo
::
	`ToBridgeSockaddr
(
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
),

481 
tmp_Ën
, 
addr
)) {

482 
”ºo
 = 
EFAULT
;

486  
»t
;

487 
	}
}

489 
ssize_t
 
	$oÿÎ_’c_uÁru¡ed_»cväom
(cÚ¡ *
£rŸlized_¬gs
,

490 
bridge_ssize_t
 
£rŸlized_¬gs_Ën
,

491 **
buf_±r
, **
£rŸlized_ouut
,

492 
bridge_ssize_t
 *
£rŸlized_ouut_Ën
) {

493 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
);

494 
sockfd
 = 0;

495 
size_t
 
Ën
 = 0;

496 
æags
 = 0;

497 ià(!
asylo
::
	`De£rŸlizeRecvFromArgs
(
£rŸlized_¬gs
, &
sockfd
, &
Ën
, &
æags
) ||

498 !
buf_±r
) {

499 
”ºo
 = 
EINVAL
;

502 *
buf_±r
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
Ën
));

503 ià(
£rŸlized_ouut
) {

504 
sockaddr_¡Üage
 
¤c_addr
;

505 
sockaddr
 *
¤c_addr_±r
 =

506 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
¤c_addr
);

507 
sockËn_t
 
add¾’
;

508 
»t
 = 
	`»cväom
(
sockfd
, *
buf_±r
, 
Ën
, 
æags
, 
¤c_addr_±r
, &
add¾’
);

509 
size_t
 
¤c_addr_Ën
 = 0;

513 
”rÜ_code
;

516 ià(!
asylo
::
	`S”ŸlizeRecvFromSrcAddr
(
¤c_addr_±r
, 
£rŸlized_ouut
,

517 &
¤c_addr_Ën
, &
”rÜ_code
)) {

518 
”ºo
 = 
EINVAL
;

521 *
£rŸlized_ouut_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
¤c_addr_Ën
);

522  
»t
;

524  
	`»cväom
(
sockfd
, *
buf_±r
, 
Ën
, 
æags
, 
nuÎ±r
,‚ullptr);

526 
	}
}

532 
	$oÿÎ_’c_uÁru¡ed_pŞl
(
bridge_pŞlfd
 *
fds
, 
nfds
,

533 
timeout
) {

534 autØ
tmp
 = 
ab¦
::
make_unique
<
pŞlfd
[]>(
nfds
);

535 
i
 = 0; i < 
nfds
; ++i) {

536 ià(!
asylo
::
	`FromBridgePŞlfd
(&
fds
[
i
], &
tmp
[i])) {

537 
”ºo
 = 
EFAULT
;

541 
»t
 = 
	`pŞl
(
tmp
.
	`g‘
(), 
nfds
, 
timeout
);

542 
i
 = 0; i < 
nfds
; ++i) {

543 ià(!
asylo
::
	`ToBridgePŞlfd
(&
tmp
[
i
], &
fds
[i])) {

544 
”ºo
 = 
EFAULT
;

548  
»t
;

549 
	}
}

555 
	$oÿÎ_’c_uÁru¡ed_•Şl_ü—‹
(
size
è{  
	`•Şl_ü—‹
(size); 
	}
}

557 
	$oÿÎ_’c_uÁru¡ed_•Şl_ùl
(cÚ¡ *
£rŸlized_¬gs
,

558 
bridge_size_t
 
£rŸlized_¬gs_Ën
) {

559 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
,

560 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_¬gs_Ën
));

561 
•fd
 = 0;

562 
İ
 = 0;

563 
ho¡fd
 = 0;

564 
•Şl_ev’t
 
ev’t
;

565 ià(!
asylo
::
	`De£rŸlizeEpŞlCArgs
(
£rŸlized_¬gs_¡r
, &
•fd
, &
İ
, &
ho¡fd
,

566 &
ev’t
)) {

567 
”ºo
 = 
EINVAL
;

570  
	`•Şl_ùl
(
•fd
, 
İ
, 
ho¡fd
, &
ev’t
);

571 
	}
}

573 
	$oÿÎ_’c_uÁru¡ed_•Şl_wa™
(cÚ¡ *
£rŸlized_¬gs
,

574 
bridge_size_t
 
£rŸlized_¬gs_Ën
,

575 **
£rŸlized_ev’ts
,

576 
bridge_size_t
 *
£rŸlized_ev’ts_Ën
) {

577 
•fd
 = 0;

578 
maxev’ts
 = 0;

579 
timeout
 = 0;

580 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
,

581 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_¬gs_Ën
));

582 ià(!
asylo
::
	`De£rŸlizeEpŞlWa™Args
(
£rŸlized_¬gs_¡r
, &
•fd
, &
maxev’ts
,

583 &
timeout
)) {

584 
”ºo
 = 
EINVAL
;

587 
•Şl_ev’t
 *
ev’t_¬¿y
 = 
¡©ic_ÿ¡
<epoll_event *>(

588 
	`m®loc
((
•Şl_ev’t
è* 
maxev’ts
));

589 
asylo
::
M®locUniquePŒ
<
•Şl_ev’t
> 
	`ev’t_¬¿y_±r
(
ev’t_¬¿y
);

590 
»t
 = 
	`•Şl_wa™
(
•fd
, 
ev’t_¬¿y
, 
maxev’ts
, 
timeout
);

591 
size_t
 
Ën
 = 0;

592 ià(!
asylo
::
	`S”ŸlizeEv’ts
(
ev’t_¬¿y
, 
»t
, 
£rŸlized_ev’ts
, &
Ën
)) {

593 
”ºo
 = 
EINVAL
;

596 *
£rŸlized_ev’ts_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
Ën
);

597  
»t
;

598 
	}
}

604 
	$oÿÎ_’c_uÁru¡ed_šÙify_š™1
(
nÚ_block
) {

605 
æags
 = 
nÚ_block
 ? 
IN_NONBLOCK
 : 0;

606  
	`šÙify_š™1
(
æags
);

607 
	}
}

609 
	$oÿÎ_’c_uÁru¡ed_šÙify_add_w©ch
(cÚ¡ *
£rŸlized_¬gs
,

610 
bridge_size_t
 
£rŸlized_¬gs_Ën
) {

611 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
);

612 
fd
 = 0;

613 *
·thÇme
 = 
nuÎ±r
;

614 
asylo
::
M®locUniquePŒ
<> 
	`·thÇme_±r
(
·thÇme
);

615 
ušt32_t
 
mask
 = 0;

616 ià(!
asylo
::
	`De£rŸlizeInÙifyAddW©chArgs
(
£rŸlized_¬gs_¡r
, &
fd
,

617 &
·thÇme
, &
mask
)) {

618 
”ºo
 = 
EINVAL
;

621  
	`šÙify_add_w©ch
(
fd
, 
·thÇme
, 
mask
);

622 
	}
}

624 
	$oÿÎ_’c_uÁru¡ed_šÙify_rm_w©ch
(cÚ¡ *
£rŸlized_¬gs
,

625 
bridge_size_t
 
£rŸlized_¬gs_Ën
) {

626 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
);

627 
fd
 = 0;

628 
wd
 = 0;

629 ià(!
asylo
::
	`De£rŸlizeInÙifyRmW©chArgs
(
£rŸlized_¬gs_¡r
, &
fd
, &
wd
)) {

630 
”ºo
 = 
EINVAL
;

633  
	`šÙify_rm_w©ch
(
fd
, 
wd
);

634 
	}
}

636 
	$oÿÎ_’c_uÁru¡ed_šÙify_»ad
(
fd
, 
bridge_size_t
 
couÁ
,

637 **
£rŸlized_ev’ts
,

638 
bridge_size_t
 *
£rŸlized_ev’ts_Ën
) {

639 
size_t
 
buf_size
 =

640 
¡d
::
	`max
((
šÙify_ev’t
è+ 
NAME_MAX
 + 1, 
couÁ
);

641 *
buf
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
buf_size
));

642 
asylo
::
M®locUniquePŒ
<> 
	`buf_±r
(
buf
);

643 
by‹s_»ad
 = 
	`»ad
(
fd
, 
buf
, 
buf_size
);

644 ià(
by‹s_»ad
 < 0) {

648 
size_t
 
Ën
 = 0;

649 ià(!
asylo
::
	`S”ŸlizeInÙifyEv’ts
(
buf
, 
by‹s_»ad
, 
£rŸlized_ev’ts
,

650 &
Ën
)) {

653 *
£rŸlized_ev’ts_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
Ën
);

655 
	}
}

661 
	$oÿÎ_’c_uÁru¡ed_g‘içddrs
(**
£rŸlized_içddrs
,

662 
bridge_ssize_t
 *
£rŸlized_içddrs_Ën
) {

663 
içddrs
 *
içddr_li¡
 = 
nuÎ±r
;

664 
»t
 = 
	`g‘içddrs
(&
içddr_li¡
);

665 ià(
»t
 != 0) {

668 
size_t
 
Ën
 = 0;

669 ià(!
asylo
::
	`S”ŸlizeIfAddrs
(
içddr_li¡
, 
£rŸlized_içddrs
, &
Ën
)) {

670 
	`ä“içddrs
(
içddr_li¡
);

673 *
£rŸlized_içddrs_Ën
 = 
¡©ic_ÿ¡
<
bridge_ssize_t
>(
Ën
);

674 
	`ä“içddrs
(
içddr_li¡
);

675  
»t
;

676 
	}
}

682 
	$oÿÎ_’c_uÁru¡ed_g‘pwuid
(
uid_t
 
uid
,

683 
BridgePassWd
 *
bridge_·sswÜd
) {

684 
·sswd
 *
·sswÜd
 = 
	`g‘pwuid
(
uid
);

685 ià(!
·sswÜd
) {

688 ià(!
asylo
::
	`ToBridgePassWd
(
·sswÜd
, 
bridge_·sswÜd
)) {

689 
”ºo
 = 
EFAULT
;

693 
	}
}

699 
	$oÿÎ_’c_uÁru¡ed_sched_g‘affš™y
(
št64_t
 
pid
, 
BridgeCpuS‘
 *
mask
) {

700 
ıu_£t_t
 
ho¡_mask
;

701 ià(
BRIDGE_CPU_SET_MAX_CPUS
 !ğ
CPU_SETSIZE
) {

702 
	`LOG
(
ERROR
è<< "sched_g‘affš™y: CPU_SETSIZE (" << 
CPU_SETSIZE


703 << "èi nÙƒqu®Ø" << 
BRIDGE_CPU_SET_MAX_CPUS
;

704 
”ºo
 = 
ENOSYS
;

708 
»t
 =

709 
	`sched_g‘affš™y
(
¡©ic_ÿ¡
<
pid_t
>(
pid
), (
ıu_£t_t
), &
ho¡_mask
);

712 
tÙ®_ıus
 = 
	`CPU_COUNT
(&
ho¡_mask
);

713 
asylo
::
	`BridgeCpuS‘Z”o
(
mask
);

714 
ıu
 = 0, 
ıus_so_çr
 = 0; cpus_so_ç¸< 
tÙ®_ıus
; ++cpu) {

715 ià(
	`CPU_ISSET
(
ıu
, &
ho¡_mask
)) {

716 
asylo
::
	`BridgeCpuS‘AddB™
(
ıu
, 
mask
);

717 ++
ıus_so_çr
;

721  
»t
;

722 
	}
}

728 
	$oÿÎ_’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

729 
bridge_signum
, cÚ¡ 
BridgeSigÇlHªdËr
 *
hªdËr
,

730 cÚ¡ *
Çme
) {

731 
¡d
::
¡ršg
 
	`’şave_Çme
(
Çme
);

732 
signum
 = 
asylo
::
	`FromBridgeSigÇl
(
bridge_signum
);

733 ià(
signum
 < 0) {

734 
”ºo
 = 
EINVAL
;

737 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

738 ià(!
mªag”_»suÉ
.
	`ok
()) {

743 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

744 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
(
’şave_Çme
);

745 cÚ¡ 
asylo
::
EnşaveCl›Á
 *
Şd_ş›Á
 =

746 
asylo
::
EnşaveSigÇlDi¥©ch”
::
	`G‘In¡ªû
()->
	`Regi¡”SigÇl
(
signum
,

747 
ş›Á
);

748 ià(
Şd_ş›Á
) {

749 
	`LOG
(
WARNING
è<< "Ov”wr™šghsigÇÈhªdË¸fÜ sigÇl: " << 
signum


750 << "„egi¡”ed byƒnşave: " << 
mªag”
->
	`G‘Name
(
Şd_ş›Á
);

752 
sigaùiÚ
 
Ãwaù
;

753 ià(!
hªdËr
 || !hªdËr->
sigaùiÚ
) {

756 
Ãwaù
.
§_sigaùiÚ
 = &
EÁ”EnşaveAndHªdËSigÇl
;

761 
hªdË_sigÇl_šside_’şave
 = 
hªdËr
->
sigaùiÚ
;

762 
Ãwaù
.
§_sigaùiÚ
 = &
HªdËSigÇlInSim
;

764 ià(
hªdËr
) {

765 
asylo
::
	`FromBridgeSigS‘
(&
hªdËr
->
mask
, &
Ãwaù
.
§_mask
);

769 
Ãwaù
.
§_æags
 = 
asylo
::
	`FromBridgeSigÇlFÏgs
(
hªdËr
->
æags
);

770 
Ãwaù
.
§_æags
 |ğ
SA_SIGINFO
;

771 
sigaùiÚ
 
Şdaù
;

772  
	`sigaùiÚ
(
signum
, &
Ãwaù
, &
Şdaù
);

773 
	}
}

775 
	$oÿÎ_’c_uÁru¡ed_sig´ocmask
(
how
, cÚ¡ 
bridge_sig£t_t
 *
£t
,

776 
bridge_sig£t_t
 *
Şd£t
) {

777 
sig£t_t
 
tmp_£t
;

778 
asylo
::
	`FromBridgeSigS‘
(
£t
, &
tmp_£t
);

779 
sig£t_t
 
tmp_Şd£t
;

780 
»t
 =

781 
	`sig´ocmask
(
asylo
::
	`FromBridgeSigMaskAùiÚ
(
how
), &
tmp_£t
, &
tmp_Şd£t
);

782 
asylo
::
	`ToBridgeSigS‘
(&
tmp_Şd£t
, 
Şd£t
);

783  
»t
;

784 
	}
}

786 
	$oÿÎ_’c_uÁru¡ed_¿i£
(
bridge_sig
) {

787 
sig
 = 
asylo
::
	`FromBridgeSigÇl
(
bridge_sig
);

788 ià(
sig
 < 0) {

789 
”ºo
 = 
EINVAL
;

792  
	`¿i£
(
sig
);

793 
	}
}

799 
	$oÿÎ_’c_uÁru¡ed_g‘ru§ge
(
RU§geT¬g‘
 
who
,

800 
BridgeRU§ge
 *
bridge_u§ge
) {

801 
ru§ge
 
u§ge
;

802 
»t
 = 
	`g‘ru§ge
(
asylo
::
	`FromBridgeRU§geT¬g‘
(
who
), &
u§ge
);

803 
asylo
::
	`ToBridgeRU§ge
(&
u§ge
, 
bridge_u§ge
);

804  
»t
;

805 
	}
}

811 
	$oÿÎ_’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
) {

812  
	`æock
(
fd
, 
asylo
::
	`FromBridgeFLockO³¿tiÚ
(
İ”©iÚ
));

813 
	}
}

819 
	$oÿÎ_’c_uÁru¡ed_£Ëù
(
nfds
, 
BridgeFDS‘
 *
bridge_»adfds
,

820 
BridgeFDS‘
 *
bridge_wr™efds
,

821 
BridgeFDS‘
 *
bridge_exû±fds
,

822 
bridge_timev®
 *
bridge_timeout
) {

823 
fd_£t
 
»adfds
, 
wr™efds
, 
exû±fds
;

824 ià(
bridge_»adfds
 && !
asylo
::
	`FromBridgeFDS‘
(bridge_»adfds, &
»adfds
)) {

825 
”ºo
 = 
EBADE
;

828 ià(
bridge_wr™efds
 && !
asylo
::
	`FromBridgeFDS‘
(bridge_wr™efds, &
wr™efds
)) {

829 
”ºo
 = 
EBADE
;

832 ià(
bridge_exû±fds
 &&

833 !
asylo
::
	`FromBridgeFDS‘
(
bridge_exû±fds
, &
exû±fds
)) {

834 
”ºo
 = 
EBADE
;

838 
timev®
 
timeout
;

839 ià(!
asylo
::
	`FromBridgeTimeV®
(
bridge_timeout
, &
timeout
)) {

840 
”ºo
 = 
EBADE
;

843 
»t
 = 
	`£Ëù
(
nfds
, &
»adfds
, &
wr™efds
, &
exû±fds
, &
timeout
);

845 ià(
bridge_»adfds
 && !
asylo
::
	`ToBridgeFDS‘
(&
»adfds
, bridge_readfds)) {

846 
”ºo
 = 
EBADE
;

849 ià(
bridge_wr™efds
 && !
asylo
::
	`ToBridgeFDS‘
(&
wr™efds
, bridge_writefds)) {

850 
”ºo
 = 
EBADE
;

853 ià(
bridge_exû±fds
 && !
asylo
::
	`ToBridgeFDS‘
(&
exû±fds
, bridge_exceptfds)) {

854 
”ºo
 = 
EBADE
;

858  
»t
;

859 
	}
}

865 
	$oÿÎ_’c_uÁru¡ed_İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
) {

866 
	`İ’log
(
id’t
, 
asylo
::
	`FromBridgeSysLogO±iÚ
(
İtiÚ
),

867 
asylo
::
	`FromBridgeSysLogFac™y
(
çc™y
));

868 
	}
}

870 
	$oÿÎ_’c_uÁru¡ed_sy¦og
(
´iÜ™y
, cÚ¡ *
mes§ge
) {

871 
	`sy¦og
(
asylo
::
	`FromBridgeSysLogPriÜ™y
(
´iÜ™y
), "%s", 
mes§ge
);

872 
	}
}

878 
	$oÿÎ_’c_uÁru¡ed_Çno¦“p
(cÚ¡ 
bridge_time¥ec
 *
»q
,

879 
bridge_time¥ec
 *
»m
) {

880 
»t
 = 
	`Çno¦“p
(
»š‹½»t_ÿ¡
<cÚ¡ 
time¥ec
 *>(
»q
),

881 
»š‹½»t_ÿ¡
<
time¥ec
 *>(
»m
));

882  
»t
;

883 
	}
}

885 
	$oÿÎ_’c_uÁru¡ed_times
(
BridgeTms
 *
bridge_buf
) {

886 
tms
 
buf
;

887 
»t
 = 
	`times
(&
buf
);

888 ià(!
asylo
::
	`ToBridgeTms
(&
buf
, 
bridge_buf
)) {

889 
”ºo
 = 
EFAULT
;

892  
»t
;

893 
	}
}

895 
	$oÿÎ_’c_uÁru¡ed_şock_g‘time
(
bridge_şockid_t
 
şk_id
,

896 
bridge_time¥ec
 *

) {

897 
»t
 = 
	`şock_g‘time
(
¡©ic_ÿ¡
<
şockid_t
>(
şk_id
),

898 
»š‹½»t_ÿ¡
<
time¥ec
 *>(

));

899  
»t
;

900 
	}
}

902 
	$oÿÎ_’c_uÁru¡ed_g‘™im”
(
Tim”Ty³
 
which
,

903 
BridgeITim”V®
 *
bridge_cu¼_v®ue
) {

904 
™im”v®
 
cu¼_v®ue
;

905 
»t
 = 
	`g‘™im”
(
asylo
::
	`FromBridgeTim”Ty³
(
which
), &
cu¼_v®ue
);

906 ià(
bridge_cu¼_v®ue
 =ğ
nuÎ±r
 ||

907 !
asylo
::
	`ToBridgeITim”V®
(&
cu¼_v®ue
, 
bridge_cu¼_v®ue
)) {

908 
”ºo
 = 
EFAULT
;

911  
»t
;

912 
	}
}

914 
	$oÿÎ_’c_uÁru¡ed_£t™im”
(
Tim”Ty³
 
which
,

915 
BridgeITim”V®
 *
bridge_Ãw_v®ue
,

916 
BridgeITim”V®
 *
bridge_Şd_v®ue
) {

917 
™im”v®
 
Ãw_v®ue
, 
Şd_v®ue
;

918 ià(!
asylo
::
	`FromBridgeITim”V®
(
bridge_Ãw_v®ue
, &
Ãw_v®ue
)) {

919 
”ºo
 = 
EFAULT
;

922 
»t
 =

923 
	`£t™im”
(
asylo
::
	`FromBridgeTim”Ty³
(
which
), &
Ãw_v®ue
, &
Şd_v®ue
);

924 ià(
bridge_Şd_v®ue
 !ğ
nuÎ±r
 &&

925 !
asylo
::
	`ToBridgeITim”V®
(&
Şd_v®ue
, 
bridge_Şd_v®ue
)) {

926 
”ºo
 = 
EFAULT
;

929  
»t
;

930 
	}
}

936 
	$oÿÎ_’c_uÁru¡ed_g‘timeofday
(
bridge_timev®
 *
tv
, *
tz
) {

937  
	`g‘timeofday
(
»š‹½»t_ÿ¡
<
timev®
 *>(
tv
), 
nuÎ±r
);

938 
	}
}

944 
	$oÿÎ_’c_uÁru¡ed_uÇme
(
BridgeUtsName
 *
bridge_ut¢ame_v®
) {

945 ià(!
bridge_ut¢ame_v®
) {

946 
”ºo
 = 
EFAULT
;

950 
ut¢ame
 
ut¢ame_v®
;

951 
»t
 = 
	`uÇme
(&
ut¢ame_v®
);

952 ià(
»t
 != 0) {

953  
»t
;

956 ià(!
asylo
::
	`CÚv”tUtsName
(
ut¢ame_v®
, 
bridge_ut¢ame_v®
)) {

957 
”ºo
 = 
EINTR
;

961  
»t
;

962 
	}
}

968 
	$oÿÎ_’c_uÁru¡ed_pe2
(
pefd
[2], 
æags
) {

969 
»t
 = 
	`pe2
(
pefd
, 
asylo
::
	`FromBridgeFeFÏgs
(
æags
));

970  
»t
;

971 
	}
}

973 
št64_t
 
	$oÿÎ_’c_uÁru¡ed_syscÚf
(
SyscÚfCÚ¡ªts
 
bridge_Çme
) {

974 
Çme
 = 
asylo
::
	`FromBridgeSyscÚfCÚ¡ªts
(
bridge_Çme
);

975 
št64_t
 
»t
 = -1;

976 ià(
Çme
 != -1) {

977 
»t
 = 
	`syscÚf
(
Çme
);

979  
»t
;

980 
	}
}

982 
ušt32_t
 
	$oÿÎ_’c_uÁru¡ed_¦“p
(
ušt32_t
 
£cÚds
è{  
	`¦“p
(£cÚds); 
	}
}

984 
	$oÿÎ_’c_uÁru¡ed__ex™
(
rc
è{ 
	`_ex™
Ôc); 
	}
}

986 
pid_t
 
	$oÿÎ_’c_uÁru¡ed_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ *
cÚfig
,

987 
bridge_size_t
 
cÚfig_Ën
,

988 
boŞ
 
»¡Üe_¢­shÙ
) {

989 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

990 ià(!
mªag”_»suÉ
.
	`ok
()) {

993 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

994 
asylo
::
SgxCl›Á
 *
ş›Á
 = 
dyÇmic_ÿ¡
<asylo::SgxClient *>(

995 
mªag”
->
	`G‘Cl›Á
(
’şave_Çme
));

997 ià(!
»¡Üe_¢­shÙ
) {

1000 
pid_t
 
pid
 = 
	`fÜk
();

1001 ià(
pid
 == 0) {

1004 
ş›Á
->
	`S‘ProûssId
();

1006  
pid
;

1012 *
’şave_ba£_add»ss
 = 
ş›Á
->
	`ba£_add»ss
();

1013 
asylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout
;

1014 
asylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout2
;

1015 
asylo
::
Stus
 
¡©us
 = 
ş›Á
->
	`EÁ”AndTakeSÇpshÙ
(&
¢­shÙ_Ïyout
);

1016 ià(!
¡©us
.
	`ok
()) {

1017 
	`LOG
(
ERROR
è<< "EÁ”AndTakeSÇpshÙ faed: " << 
¡©us
;

1018 
”ºo
 = 
ENOMEM
;

1022 
	`LOG
(
INFO
è<< "Thi i ¢­shÙ1 : " << &
¢­shÙ_Ïyout
;

1023 
FILE
 * 
å
 = 
	`fİ’
("/tmp/snapshot_layout2", "wb");

1024 
	`fwr™e
(&
¢­shÙ_Ïyout
, (
asylo
::
SÇpshÙLayout
), 1, 
å
);

1025 
	`fşo£
(
å
);

1028 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
d©a_d–‘”_
;

1029 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
bss_d–‘”_
;

1030 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
h—p_d–‘”_
;

1031 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
th»ad_d–‘”_
;

1032 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
¡ack_d–‘”_
;

1034 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`d©a
().
	`cbegš
(), sÇpshÙ_Ïyout.d©a().
	`ûnd
(),

1035 
¡d
::
	`back_š£¹”
(
d©a_d–‘”_
),

1036 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1037  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1040 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`bss
().
	`cbegš
(), sÇpshÙ_Ïyout.bss().
	`ûnd
(),

1041 
¡d
::
	`back_š£¹”
(
bss_d–‘”_
),

1042 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1043  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1046 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`h—p
().
	`cbegš
(), sÇpshÙ_Ïyout.h—p().
	`ûnd
(),

1047 
¡d
::
	`back_š£¹”
(
h—p_d–‘”_
),

1048 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1049  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1052 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`th»ad
().
	`cbegš
(),

1053 
¢­shÙ_Ïyout
.
	`th»ad
().
	`ûnd
(),

1054 
¡d
::
	`back_š£¹”
(
th»ad_d–‘”_
),

1055 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1056  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1059 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`¡ack
().
	`cbegš
(),

1060 
¢­shÙ_Ïyout
.
	`¡ack
().
	`ûnd
(),

1061 
¡d
::
	`back_š£¹”
(
¡ack_d–‘”_
),

1062 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1063  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1066 
asylo
::
EnşaveLßd”
 *
lßd”
 = 
mªag”
->
	`G‘Lßd”FromCl›Á
(
ş›Á
);

1070 ià(!
dyÇmic_ÿ¡
<
asylo
::
SgxLßd”
 *>(
lßd”
) &&

1071 !
dyÇmic_ÿ¡
<
asylo
::
SgxEmbeddedLßd”
 *>(
lßd”
)) {

1072 
	`LOG
(
ERROR
) << "Failedo gethe†oader forheƒnclaveo fork";

1073 
”ºo
 = 
EFAULT
;

1080 
sock‘_·œ
[2];

1081 ià(
	`sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
sock‘_·œ
) < 0) {

1082 
	`LOG
(
ERROR
) << "Failedo create socket…air";

1083 
”ºo
 = 
EFAULT
;

1090 
pefd
[2];

1091 ià(
	`pe
(
pefd
) < 0) {

1092 
	`LOG
(
ERROR
) << "Failedo create…ipe";

1093 
”ºo
 = 
EFAULT
;

1097 
pid_t
 
pid
 = 
	`fÜk
();

1098 ià(
pid
 == -1) {

1099  
pid
;

1103 
size_t
 
’şave_size
 = 
ş›Á
->
	`size
();

1107 
asylo
::
EnşaveCÚfig
 
’şave_cÚfig
;

1108 ià(!
’şave_cÚfig
.
	`P¬£FromA¼ay
(
cÚfig
, 
¡©ic_ÿ¡
<
size_t
>(
cÚfig_Ën
))) {

1109 
	`LOG
(
ERROR
) << "Failedo…arse EnclaveConfig";

1110 
”ºo
 = 
EFAULT
;

1114 ià(
pid
 == 0) {

1115 ià(
	`şo£
(
pefd
[0]) < 0) {

1116 
	`LOG
(
ERROR
è<< "çedØşo£…efd: " << 
	`¡»¼Ü
(
”ºo
);

1117 
”ºo
 = 
EFAULT
;

1121 
	`LOG
(
INFO
è<< "ba£: " << 
’şave_ba£_add»ss
 << " sz: " << 
’şave_size
;

1122 
¡©us
 = 
mªag”
->
	`LßdEnşave
(
’şave_Çme
, *
lßd”
, 
’şave_cÚfig
,

1123 
’şave_ba£_add»ss
, 
’şave_size
);

1124 ià(!
¡©us
.
	`ok
()) {

1125 
	`LOG
(
ERROR
è<< "Lßd‚ewƒnşavçed:" << 
¡©us
;

1126 
”ºo
 = 
ENOMEM
;

1132 
ş›Á
 = 
dyÇmic_ÿ¡
<
asylo
::
SgxCl›Á
 *>(
mªag”
->
	`G‘Cl›Á
(
’şave_Çme
));

1133 *
chd_’şave_ba£_add»ss
 = 
ş›Á
->
	`ba£_add»ss
();

1134 ià(
chd_’şave_ba£_add»ss
 !ğ
’şave_ba£_add»ss
) {

1135 
	`LOG
(
ERROR
è<< "Newƒnşavadd»ss: " << 
chd_’şave_ba£_add»ss


1137 << 
’şave_ba£_add»ss
;

1138 
”ºo
 = 
EAGAIN
;

1142 
¡d
::
¡ršg
 
chd_»suÉ
 = "Child fork succeeded";

1143 
	`LOG
(
INFO
è<< "chd„esuÉ : " << 
chd_»suÉ
;

1144 
asylo
::
Stus
 
¡©us
 = 
	`DoSÇpshÙKeyT¿nsãr
(

1145 
mªag”
, 
ş›Á
, 
sock‘_·œ
[0], sock‘_·œ[1], 
çl£
);

1146 ià(!
¡©us
.
	`ok
()) {

1148 
chd_»suÉ
 = "Child DoSnapshotKeyTransfer failed";

1149 ià(
	`wr™e
(
pefd
[1], 
chd_»suÉ
.
	`d©a
(), chd_»suÉ.
	`size
()) < 0) {

1150 
	`LOG
(
ERROR
è<< "FaedØwr™chd fÜk„esuÉo: " << 
pefd
[1]

1151 << ",ƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

1154 
	`LOG
(
ERROR
è<< "DoSÇpshÙKeyT¿nsã¸çed: " << 
¡©us
;

1155 
”ºo
 = 
EFAULT
;

1160 
FILE
 * 
å
 = 
	`fİ’
("/tmp/snapshot_layout2", "rb");

1161 
	`ä—d
(&
¢­shÙ_Ïyout2
, (
asylo
::
SÇpshÙLayout
), 1, 
å
);

1162 
	`fşo£
(
å
);

1163 
	`LOG
(
INFO
è<< "Thi i ¢­shÙ2 : " << &
¢­shÙ_Ïyout2
;

1170 
¡©us
 = 
ş›Á
->
	`EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout2
);

1171 ià(!
¡©us
.
	`ok
()) {

1173 
chd_»suÉ
 = "Child EnterAndRestore failed";

1174 ià(
	`wr™e
(
pefd
[1], 
chd_»suÉ
.
	`d©a
(), chd_»suÉ.
	`size
()) < 0) {

1175 
	`LOG
(
ERROR
è<< "FaedØwr™chd fÜk„esuÉo: " << 
pefd
[1]

1176 << ",ƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

1179 
	`LOG
(
ERROR
è<< "EÁ”AndRe¡Üçed: " << 
¡©us
;

1180 
”ºo
 = 
EAGAIN
;

1184 ià(
	`wr™e
(
pefd
[1], 
chd_»suÉ
.
	`d©a
(), chd_»suÉ.
	`size
()) < 0) {

1185 
	`LOG
(
ERROR
è<< "FaedØwr™chd fÜk„esuÉo: " << 
pefd
[1]

1186 << ",ƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

1190 ià(
	`şo£
(
pefd
[1]) < 0) {

1191 
	`LOG
(
ERROR
è<< "FaedØşo£…efd: " << 
	`¡»¼Ü
(
”ºo
);

1192 
”ºo
 = 
EFAULT
;

1195 
asylo
::
Stus
 
¡©us
 = 
	`DoSÇpshÙKeyT¿nsãr
(

1196 
mªag”
, 
ş›Á
, 
sock‘_·œ
[1],

1197  
sock‘_·œ
[0], 
Œue
);

1198 ià(!
¡©us
.
	`ok
()) {

1199 
	`LOG
(
ERROR
è<< "DoSÇpshÙKeyT¿nsã¸çed: " << 
¡©us
;

1200 
”ºo
 = 
EFAULT
;

1205 cÚ¡ 
timeout_£cÚds
 = 5;

1206 
fd_£t
 
»ad_fds
;

1207 
	`FD_ZERO
(&
»ad_fds
);

1208 
	`FD_SET
(
pefd
[0], &
»ad_fds
);

1209 
timev®
 
timeout
;

1210 
timeout
.
tv_£c
 = 
timeout_£cÚds
;

1211 
timeout
.
tv_u£c
 = 0;

1212 
wa™_»suÉ
 =

1213 
	`£Ëù
Ğ
pefd
[0] + 1, &
»ad_fds
, 
nuÎ±r
,

1214  
nuÎ±r
, &
timeout
);

1215 ià(
wa™_»suÉ
 < 0) {

1216 
	`LOG
(
ERROR
) << "Error while waiting for child fork„esult: "

1217 << 
	`¡»¼Ü
(
”ºo
);

1219 } ià(
wa™_»suÉ
 == 0) {

1220 
	`LOG
(
ERROR
) << "Timeout waiting for fork„esult fromhe child";

1221 
”ºo
 = 
EFAULT
;

1225 
buf
[64];

1226 
rc
 = 
	`»ad
(
pefd
[0], 
buf
, (buf));

1227 ià(
rc
 <= 0) {

1228 
	`LOG
(
ERROR
) << "Failedo„ead child fork„esult";

1231 
buf
[
rc
] = '\0';

1232 ià(
	`¡ºcmp
(
buf
, "Child fork succeeded", (buf)) != 0) {

1233 
	`LOG
(
ERROR
è<< 
buf
;

1237  
pid
;

1238 
	}
}

1244 
pid_t
 
	$oÿÎ_’c_uÁru¡ed_wa™3
(
BridgeWStus
 *
bridge_w¡©us
,

1245 
İtiÚs
,

1246 
BridgeRU§ge
 *
bridge_u§ge
) {

1247 
ru§ge
 
u§ge
;

1248 
w¡©us
;

1249 
pid_t
 
»t
 = 
	`wa™3
(&
w¡©us
, 
asylo
::
	`FromBridgeWa™O±iÚs
(
İtiÚs
), &
u§ge
);

1250 
asylo
::
	`ToBridgeRU§ge
(&
u§ge
, 
bridge_u§ge
);

1251 ià(
bridge_w¡©us
) {

1252 *
bridge_w¡©us
 = 
asylo
::
	`ToBridgeWStus
(
w¡©us
);

1254  
»t
;

1255 
	}
}

1257 
pid_t
 
	$oÿÎ_’c_uÁru¡ed_wa™pid
(
pid_t
 
pid
,

1258 
BridgeWStus
 *
bridge_w¡©us
,

1259 
İtiÚs
) {

1260 
w¡©us
;

1261 
pid_t
 
»t
 = 
	`wa™pid
(
pid
, &
w¡©us
, 
asylo
::
	`FromBridgeWa™O±iÚs
(
İtiÚs
));

1262 ià(
bridge_w¡©us
) {

1263 *
bridge_w¡©us
 = 
asylo
::
	`ToBridgeWStus
(
w¡©us
);

1265  
»t
;

1266 
	}
}

1272 
	$oÿÎ_’c_uÁru¡ed_utime
(cÚ¡ *
f’ame
,

1273 cÚ¡ 
bridge_utimbuf
 *
times
) {

1274 
utimbuf
 
tmp
;

1275  
	`utime
(
f’ame
, 
asylo
::
	`FromBridgeUtimbuf
(
times
, &
tmp
));

1276 
	}
}

1278 
	$oÿÎ_’c_uÁru¡ed_utimes
(

1279 cÚ¡ *
f’ame
, cÚ¡ 
bridge_timev®
 *
bridge_acûss_time
,

1280 cÚ¡ 
bridge_timev®
 *
bridge_modifiÿtiÚ_time
) {

1281 
timev®
 
times
[2];

1282 ià(!
asylo
::
	`FromBridgeTimeV®
(
bridge_acûss_time
, &
times
[0]) ||

1283 !
asylo
::
	`FromBridgeTimeV®
(
bridge_modifiÿtiÚ_time
, &
times
[1])) {

1284 
”ºo
 = 
EBADE
;

1287  
	`utimes
(
f’ame
, 
times
);

1288 
	}
}

1294 *
	$oÿÎ_’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1295 cÚ¡ *
Çme
) {

1296 
asylo
::
Sh¬edName
 
	`sh¬ed_Çme
(
kšd
, 
¡d
::
	`¡ršg
(
Çme
));

1297 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

1298 ià(
mªag”_»suÉ
.
	`ok
()) {

1299  
mªag”_»suÉ
.
	`V®ueOrD›
()

1300 ->
	`sh¬ed_»sourûs
()

1301 ->
AcquœeResourû
<>(
sh¬ed_Çme
);

1303  
nuÎ±r
;

1305 
	}
}

1307 
	$oÿÎ_’c_uÁru¡ed_»Ëa£_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1308 cÚ¡ *
Çme
) {

1309 
asylo
::
Sh¬edName
 
	`sh¬ed_Çme
(
kšd
, 
¡d
::
	`¡ršg
(
Çme
));

1310 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

1311 ià(
mªag”_»suÉ
.
	`ok
()) {

1312  
mªag”_»suÉ
.
	`V®ueOrD›
()->
	`sh¬ed_»sourûs
()->
	`R–—£Resourû
(

1313 
sh¬ed_Çme
);

1315  
çl£
;

1316 
	}
}

1322 
	$oÿÎ_’c_uÁru¡ed_hex_dump
(cÚ¡ *
buf
, 
nby‹s
) {

1323 
	`årštf
(
¡d”r
, "%s\n", 
asylo
::
	`bufãr_to_hex_¡ršg
(
buf
, 
nby‹s
).
	`c_¡r
());

1324 
	}
}

1330 
	$oÿÎ_’c_uÁru¡ed_th»ad_ü—‹
(cÚ¡ *
Çme
) {

1331 
	`__asylo_dÚ©e_th»ad
(
Çme
);

1333 
	}
}

1335 
	$oÿÎ_di¥©ch_uÁru¡ed_ÿÎ
(
ušt64_t
 
£ËùÜ
, *
bufãr
) {

1336 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
 =

1337 
asylo
::
´im™ives
::
Cl›Á
::
	`Ex™C®lback
(

1338 
£ËùÜ
,

1339 
»š‹½»t_ÿ¡
<
asylo
::
´im™ives
::
N©iveP¬am‘”Sck
 *>(
bufãr
));

1341  
¡©us
.
	`”rÜ_code
();

1342 
	}
}

	@platform/arch/sgx/untrusted/ocalls.cc

22 #iâdeà
_GNU_SOURCE


23 
	#_GNU_SOURCE


	)

26 
	~<¬·/š‘.h
>

27 
	~<fú.h
>

28 
	~<içddrs.h
>

29 
	~<Ãtdb.h
>

30 
	~<pŞl.h
>

31 
	~<pwd.h
>

32 
	~<sched.h
>

33 
	~<sys/•Şl.h
>

34 
	~<sys/fe.h
>

35 
	~<sys/šÙify.h
>

36 
	~<sys/£Ëù.h
>

37 
	~<sys/sock‘.h
>

38 
	~<sys/¡©.h
>

39 
	~<sys/time.h
>

40 
	~<sys/ut¢ame.h
>

41 
	~<sys/wa™.h
>

42 
	~<sy¦og.h
>

43 
	~<uni¡d.h
>

44 
	~<utime.h
>

46 
	~<®gÜ™hm
>

47 
	~<û¼no
>

48 
	~<csigÇl
>

49 
	~<c¡dšt
>

50 
	~<c¡dio
>

51 
	~<c¡dlib
>

52 
	~<ùime
>

53 
	~<™”©Ü
>

54 
	~<veùÜ
>

56 
	~"ab¦/memÜy/memÜy.h
"

57 
	~"asylo/’şave.pb.h
"

58 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/g’”©ed_bridge_u.h
"

59 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/sgx_ş›Á.h
"

60 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

61 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

62 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

63 
	~"asylo/¶©fÜm/commÚ/debug_¡ršgs.h
"

64 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

65 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

66 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme.h
"

67 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

68 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

69 
	~"asylo/ut/¡©us.h
"

70 
	~"asylo/ut/¡©us_maüos.h
"

72 
	~"asylo/ut/loggšg.h
"

74 
	gÇme¥aû
 {

79 (*
	ghªdË_sigÇl_šside_’şave
)(, 
	gbridge_sigšfo_t
 *,

80 *èğ
nuÎ±r
;

84 
T¿n¦©eToBridgeAndHªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
,

85 *
ucÚ‹xt
) {

86 
	gbridge_signum
 = 
asylo
::
ToBridgeSigÇl
(
signum
);

87 ià(
	gbridge_signum
 < 0) {

91 
bridge_sigšfo_t
 
	gbridge_sigšfo
;

92 
	gasylo
::
ToBridgeSigInfo
(
šfo
, &
bridge_sigšfo
);

93 ià(
	ghªdË_sigÇl_šside_’şave
) {

94 
hªdË_sigÇl_šside_’şave
(
bridge_signum
, &
bridge_sigšfo
, 
ucÚ‹xt
);

103 
EÁ”EnşaveAndHªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

104 
	gasylo
::
EnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
()->
EÁ”EnşaveAndHªdËSigÇl
(

105 
signum
, 
šfo
, 
ucÚ‹xt
);

114 
HªdËSigÇlInSim
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

115 autØ
	gş›Á_»suÉ
 =

116 
asylo
::
EnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
()->
G‘Cl›ÁFÜSigÇl
(
signum
);

117 ià(!
	gş›Á_»suÉ
.
ok
()) {

120 
	gasylo
::
SgxCl›Á
 *
ş›Á
 =

121 
dyÇmic_ÿ¡
<
asylo
::
SgxCl›Á
 *>(
ş›Á_»suÉ
.
V®ueOrD›
());

122 ià(
	gş›Á
->
IsTcsAùive
()) {

123 
T¿n¦©eToBridgeAndHªdËSigÇl
(
signum
, 
šfo
, 
ucÚ‹xt
);

125 
EÁ”EnşaveAndHªdËSigÇl
(
signum
, 
šfo
, 
ucÚ‹xt
);

130 
	gasylo
::
Stus
 
DoSÇpshÙKeyT¿nsãr
(
asylo
::
EnşaveMªag”
 *
mªag”
,

131 
asylo
::
EnşaveCl›Á
 *
ş›Á
,

132 
£lf_sock‘
, 
³”_sock‘
,

133 
boŞ
 
is_·»Á
) {

134 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
£lf_sock‘_şo£r
(
£lf_sock‘
);

137 ià(
şo£
(
³”_sock‘
) < 0) {

138  
	gasylo
::
Stus
(
¡©ic_ÿ¡
<
asylo
::
”rÜ
::
PosixE¼Ü
>(
”ºo
),

139 
ab¦
::
SŒC©
("şo£ faed: ", 
¡»¼Ü
(
”ºo
)));

142 
	gasylo
::
FÜkHªdshakeCÚfig
 
fÜk_hªdshake_cÚfig
;

143 
	gfÜk_hªdshake_cÚfig
.
£t_is_·»Á
(
is_·»Á
);

144 
	gfÜk_hªdshake_cÚfig
.
£t_sock‘
(
£lf_sock‘
);

145 
	gasylo
::
SgxCl›Á
 *
sgx_ş›Á
 = 
dyÇmic_ÿ¡
<
asylo
::SgxCl›Á *>(
ş›Á
);

146 
ASYLO_RETURN_IF_ERROR
(
sgx_ş›Á
->
EÁ”AndT¿nsãrSecu»SÇpshÙKey
(

147 
fÜk_hªdshake_cÚfig
));

149  
	gasylo
::
Stus
::
OkStus
();

153 şas 
	cSÇpshÙD©aD–‘”
 {

154 
	gpublic
:

155 
ex¶ic™
 
SÇpshÙD©aD–‘”
(cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
)

156 : 
ch”‹xt_d–‘”_
(
»š‹½»t_ÿ¡
<*>(
’Œy
.
ch”‹xt_ba£
())),

157 
nÚû_d–‘”_
(
»š‹½»t_ÿ¡
<*>(
’Œy
.
nÚû_ba£
())) {}

159 
	g´iv©e
:

160 
asylo
::
M®locUniquePŒ
<> 
ch”‹xt_d–‘”_
;

161 
	gasylo
::
M®locUniquePŒ
<> 
nÚû_d–‘”_
;

167 "C" 
__asylo_dÚ©e_th»ad
(cÚ¡ *
Çme
);

173 
	$oÿÎ_’c_uÁru¡ed_puts
(cÚ¡ *
¡r
) {

174 
rc
 = 
	`puts
(
¡r
);

177 
	`fæush
(
¡dout
);

178  
rc
;

179 
	}
}

181 *
	$oÿÎ_’c_uÁru¡ed_m®loc
(
bridge_size_t
 
size
) {

182 *
»t
 = 
	`m®loc
(
¡©ic_ÿ¡
<
size_t
>(
size
));

183  
»t
;

184 
	}
}

186 **
	$oÿÎ_’c_uÁru¡ed_®loÿ‹_bufãrs
(
bridge_size_t
 
couÁ
,

187 
bridge_size_t
 
size
) {

188 **
bufãrs
 = 
»š‹½»t_ÿ¡
<**>(

189 
	`m®loc
(
¡©ic_ÿ¡
<
size_t
>(
couÁ
) * (*)));

190 
i
 = 0; i < 
couÁ
; i++) {

191 
bufãrs
[
i
] = 
	`m®loc
(
size
);

193  
bufãrs
;

194 
	}
}

196 
	$oÿÎ_’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(**
ä“_li¡
,

197 
bridge_size_t
 
couÁ
) {

202 
i
 = 0; i < 
couÁ
; i++) {

203 
	`ä“
(
ä“_li¡
[
i
]);

205 
	}
}

207 
	$oÿÎ_’c_uÁru¡ed_İ’
(cÚ¡ *
·th_Çme
, 
æags
, 
ušt32_t
 
mode
) {

208 
ho¡_æags
 = 
asylo
::
	`FromBridgeFeFÏgs
(
æags
);

209 
»t
 = 
	`İ’
(
·th_Çme
, 
ho¡_æags
, 
mode
);

210  
»t
;

211 
	}
}

213 
	$oÿÎ_’c_uÁru¡ed_fú
(
fd
, 
bridge_cmd
, 
št64_t
 
¬g
) {

214 
cmd
 = 
asylo
::
	`FromBridgeFúCmd
(
bridge_cmd
);

215 ià(
cmd
 == -1) {

216 
”ºo
 = 
EINVAL
;

220 
»t
;

221 
cmd
) {

222 
F_SETFL
:

223 
»t
 = 
	`fú
(
fd
, 
cmd
, 
asylo
::
	`FromBridgeFeFÏgs
(
¬g
));

225 
F_SETFD
:

226 
»t
 = 
	`fú
(
fd
, 
cmd
, 
asylo
::
	`FromBridgeFDFÏgs
(
¬g
));

228 
F_GETFL
:

229 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

230 ià(
»t
 != -1) {

231 
»t
 = 
asylo
::
	`ToBridgeFeFÏgs
(ret);

234 
F_GETFD
:

235 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

236 ià(
»t
 != -1) {

237 
»t
 = 
asylo
::
	`ToBridgeFDFÏgs
(ret);

240 
F_GETPIPE_SZ
:

241 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

243 
F_SETPIPE_SZ
:

244 
»t
 = 
	`fú
(
fd
, 
cmd
, 
¬g
);

247 
”ºo
 = 
EINVAL
;

250  
»t
;

251 
	}
}

253 
	$oÿÎ_’c_uÁru¡ed_¡©
(cÚ¡ *
·thÇme
,

254 
bridge_¡©
 *
¡©_bufãr
) {

255 
¡©
 
ho¡_¡©_bufãr
;

256 
»t
 = 
	`¡©
(
·thÇme
, &
ho¡_¡©_bufãr
);

257 
asylo
::
	`ToBridgeSt
(&
ho¡_¡©_bufãr
, 
¡©_bufãr
);

258  
»t
;

259 
	}
}

261 
	$oÿÎ_’c_uÁru¡ed_f¡©
(
fd
, 
bridge_¡©
 *
¡©_bufãr
) {

262 
¡©
 
ho¡_¡©_bufãr
;

263 
»t
 = 
	`f¡©
(
fd
, &
ho¡_¡©_bufãr
);

264 
asylo
::
	`ToBridgeSt
(&
ho¡_¡©_bufãr
, 
¡©_bufãr
);

265  
»t
;

266 
	}
}

268 
	$oÿÎ_’c_uÁru¡ed_l¡©
(cÚ¡ *
·thÇme
,

269 
bridge_¡©
 *
¡©_bufãr
) {

270 
¡©
 
ho¡_¡©_bufãr
;

271 
»t
 = 
	`l¡©
(
·thÇme
, &
ho¡_¡©_bufãr
);

272 
asylo
::
	`ToBridgeSt
(&
ho¡_¡©_bufãr
, 
¡©_bufãr
);

273  
»t
;

274 
	}
}

276 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_wr™e_w™h_uÁru¡ed_±r
(
fd
,

277 cÚ¡ *
buf
,

278 
size
) {

279  
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`wr™e
(
fd
, 
buf
, 
size
));

280 
	}
}

282 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_»ad_w™h_uÁru¡ed_±r
(
fd
, *
buf
,

283 
size
) {

284  
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`»ad
(
fd
, 
buf
, 
size
));

285 
	}
}

291 
	$oÿÎ_’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

292  
	`sock‘
(
asylo
::
	`FromBridgeAfFamy
(
domaš
),

293 
asylo
::
	`FromBridgeSock‘Ty³
(
ty³
), 
´ÙocŞ
);

294 
	}
}

296 
	$oÿÎ_’c_uÁru¡ed_cÚÃù
(
sockfd
,

297 cÚ¡ 
bridge_sockaddr
 *
bridge_addr
) {

298 
sockaddr_¡Üage
 
tmp
;

299 
sockËn_t
 
Ën
 = (
tmp
);

300 
sockaddr
 *
addr
 = 
asylo
::
	`FromBridgeSockaddr
(

301 
bridge_addr
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
Ën
);

303 
	`LOG_IF
(
FATAL
, 
addr
 =ğ
nuÎ±r
) << "Unexpected bridge failure";

304 
	`LOG_IF
(
FATAL
, 
Ën
 > (
tmp
)) << "Insufficient sockaddr buf space";

306 
»t
 = 
	`cÚÃù
(
sockfd
, 
addr
, 
Ën
);

307  
»t
;

308 
	}
}

310 
	$oÿÎ_’c_uÁru¡ed_bšd
(
sockfd
,

311 cÚ¡ 
bridge_sockaddr
 *
bridge_addr
) {

312 
sockaddr_¡Üage
 
tmp
;

313 
sockËn_t
 
Ën
 = (
tmp
);

314 
sockaddr
 *
addr
 = 
asylo
::
	`FromBridgeSockaddr
(

315 
bridge_addr
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
Ën
);

317 
	`LOG_IF
(
FATAL
, 
addr
 =ğ
nuÎ±r
) << "Unexpected bridge failure";

318 
	`LOG_IF
(
FATAL
, 
Ën
 > (
tmp
)) << "Insufficient sockaddr buf space";

320 
»t
 = 
	`bšd
(
sockfd
, 
addr
, 
Ën
);

321  
»t
;

322 
	}
}

324 
	$oÿÎ_’c_uÁru¡ed_acû±
(
sockfd
, 
bridge_sockaddr
 *
addr
) {

325 
sockaddr_¡Üage
 
tmp
;

326 
sockËn_t
 
tmp_Ën
 = (
tmp
);

327 
»t
 = 
	`acû±
(
sockfd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
tmp_Ën
);

328 ià(
»t
 == -1) {

329  
»t
;

331 ià(!
asylo
::
	`ToBridgeSockaddr
(
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
),

332 (
tmp
), 
addr
)) {

333 
”ºo
 = 
EFAULT
;

336  
»t
;

337 
	}
}

339 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_£ndmsg
(
sockfd
,

340 cÚ¡ 
bridge_msghdr
 *
msg
,

341 
æags
) {

342 
msghdr
 
tmp
;

343 ià(!
asylo
::
	`FromBridgeMsgHdr
(
msg
, &
tmp
)) {

344 
”ºo
 = 
EFAULT
;

347 autØ
buf
 = 
ab¦
::
make_unique
<
iovec
[]>(
msg
->
msg_iovËn
);

348 
i
 = 0; i < 
msg
->
msg_iovËn
; ++i) {

349 ià(!
asylo
::
	`FromBridgeIovec
(&
msg
->
msg_iov
[
i
], &
buf
[i])) {

350 
”ºo
 = 
EFAULT
;

354 
tmp
.
msg_iov
 = 
buf
.
	`g‘
();

355 
bridge_ssize_t
 
»t
 =

356 
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`£ndmsg
(
sockfd
, &
tmp
, 
æags
));

357  
»t
;

358 
	}
}

360 
bridge_ssize_t
 
	$oÿÎ_’c_uÁru¡ed_»cvmsg
(
sockfd
,

361 
bridge_msghdr
 *
msg
,

362 
æags
) {

363 
msghdr
 
tmp
;

364 ià(!
asylo
::
	`FromBridgeMsgHdr
(
msg
, &
tmp
)) {

365 
”ºo
 = 
EFAULT
;

368 autØ
buf
 = 
ab¦
::
make_unique
<
iovec
[]>(
msg
->
msg_iovËn
);

369 
i
 = 0; i < 
msg
->
msg_iovËn
; ++i) {

370 ià(!
asylo
::
	`FromBridgeIovec
(&
msg
->
msg_iov
[
i
], &
buf
[i])) {

371 
”ºo
 = 
EFAULT
;

375 
tmp
.
msg_iov
 = 
buf
.
	`g‘
();

376 
bridge_ssize_t
 
»t
 =

377 
¡©ic_ÿ¡
<
bridge_ssize_t
>(
	`»cvmsg
(
sockfd
, &
tmp
, 
æags
));

378 ià(!
asylo
::
	`ToBridgeIovecA¼ay
(&
tmp
, 
msg
)) {

379 
”ºo
 = 
EFAULT
;

382  
»t
;

383 
	}
}

385 *
	$oÿÎ_’c_uÁru¡ed_š‘_Áİ
(
af
, cÚ¡ *
¤c
,

386 
bridge_size_t
 
¤c_size
, *
d¡
,

387 
bridge_size_t
 
buf_size
) {

390 ()
¤c_size
;

391 cÚ¡ *
»t
 = 
	`š‘_Áİ
(
af
, 
¤c
, 
d¡
, 
¡©ic_ÿ¡
<
size_t
>(
buf_size
));

393  
cÚ¡_ÿ¡
<*>(
»t
);

394 
	}
}

396 
	$oÿÎ_’c_uÁru¡ed_š‘_±Ú
(
AfFamy
 
af
, cÚ¡ *
¤c
, *
d¡
,

397 
bridge_size_t
 
d¡_size
) {

400 (è
d¡_size
;

401  
	`š‘_±Ú
(
asylo
::
	`FromBridgeAfFamy
(
af
), 
¤c
, 
d¡
);

402 
	}
}

404 
	$oÿÎ_’c_uÁru¡ed_g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

405 cÚ¡ *
£rŸlized_hšts
,

406 
bridge_size_t
 
£rŸlized_hšts_Ën
,

407 **
£rŸlized_»s_¡¬t
,

408 
bridge_size_t
 *
£rŸlized_»s_Ën
) {

409 
addršfo
 *
hšts
;

410 
¡d
::
¡ršg
 
	`tmp_£rŸlized_hšts
(
£rŸlized_hšts
,

411 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_hšts_Ën
));

412 ià(!
asylo
::
	`De£rŸlizeAddršfo
(&
tmp_£rŸlized_hšts
, &
hšts
)) {

416 
addršfo
 *
»s
;

417 
»t
 = 
	`g‘addršfo
(
node
, 
£rviû
, 
hšts
, &
»s
);

418 ià(
»t
 != 0) {

419  
asylo
::
	`ToBridgeAdd»ssInfoE¼Üs
(
»t
);

421 
asylo
::
	`F»eDe£rŸlizedAddršfo
(
hšts
);

423 
¡d
::
¡ršg
 
tmp_£rŸlized_»s
;

424 
bridge_”rÜ_code
 = -1;

425 ià(!
asylo
::
	`S”ŸlizeAddršfo
(
»s
, &
tmp_£rŸlized_»s
, &
bridge_”rÜ_code
)) {

426  
bridge_”rÜ_code
;

428 
	`ä“addršfo
(
»s
);

431 
size_t
 
tmp_£rŸlized_»s_Ën
 = 
tmp_£rŸlized_»s
.
	`Ëngth
();

432 *
£rŸlized_»s
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
tmp_£rŸlized_»s_Ën
));

433 
	`memıy
(
£rŸlized_»s
, 
tmp_£rŸlized_»s
.
	`c_¡r
(), 
tmp_£rŸlized_»s_Ën
);

434 *
£rŸlized_»s_¡¬t
 = 
£rŸlized_»s
;

435 *
£rŸlized_»s_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
tmp_£rŸlized_»s_Ën
);

437 
	}
}

439 
	$oÿÎ_’c_uÁru¡ed_g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

440 *
İtv®
, 
İ’_š
,

441 *
İ’_out
) {

442 
»t
 =

443 
	`g‘sockİt
(
sockfd
, 
Ëv–
, 
asylo
::
	`FromBridgeO±iÚName
Öev–, 
İŠame
),

444 
İtv®
, 
»š‹½»t_ÿ¡
<
sockËn_t
 *>(&
İ’_š
));

445 *
İ’_out
 = 
İ’_š
;

446  
»t
;

447 
	}
}

449 
	$oÿÎ_’c_uÁru¡ed_£tsockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

450 cÚ¡ *
İtv®
, 
bridge_size_t
 
İ’
) {

451  
	`£tsockİt
(
sockfd
, 
Ëv–
, 
asylo
::
	`FromBridgeO±iÚName
Öev–, 
İŠame
),

452 
İtv®
, 
¡©ic_ÿ¡
<
sockËn_t
>(
İ’
));

453 
	}
}

455 
	$oÿÎ_’c_uÁru¡ed_g‘sockÇme
(
sockfd
, 
bridge_sockaddr
 *
addr
) {

456 
sockaddr_¡Üage
 
tmp
;

457 
sockËn_t
 
tmp_Ën
 = (
tmp
);

458 
»t
 =

459 
	`g‘sockÇme
(
sockfd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
tmp_Ën
);

461 
	`LOG_IF
(
FATAL
, 
tmp_Ën
 > (
tmp
)) << "Insufficient sockaddr buf space";

464 ià(
»t
 == 0) {

465 ià(!
asylo
::
	`ToBridgeSockaddr
(
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
),

466 (
tmp
), 
addr
)) {

467 
”ºo
 = 
EFAULT
;

471  
»t
;

472 
	}
}

474 
	$oÿÎ_’c_uÁru¡ed_g‘³”Çme
(
sockfd
, 
bridge_sockaddr
 *
addr
) {

475 
sockaddr_¡Üage
 
tmp
;

476 
sockËn_t
 
tmp_Ën
 = (
tmp
);

477 
»t
 =

478 
	`g‘³”Çme
(
sockfd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
), &
tmp_Ën
);

479 ià(
»t
 == 0) {

480 ià(!
asylo
::
	`ToBridgeSockaddr
(
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
tmp
),

481 
tmp_Ën
, 
addr
)) {

482 
”ºo
 = 
EFAULT
;

486  
»t
;

487 
	}
}

489 
ssize_t
 
	$oÿÎ_’c_uÁru¡ed_»cväom
(cÚ¡ *
£rŸlized_¬gs
,

490 
bridge_ssize_t
 
£rŸlized_¬gs_Ën
,

491 **
buf_±r
, **
£rŸlized_ouut
,

492 
bridge_ssize_t
 *
£rŸlized_ouut_Ën
) {

493 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
);

494 
sockfd
 = 0;

495 
size_t
 
Ën
 = 0;

496 
æags
 = 0;

497 ià(!
asylo
::
	`De£rŸlizeRecvFromArgs
(
£rŸlized_¬gs
, &
sockfd
, &
Ën
, &
æags
) ||

498 !
buf_±r
) {

499 
”ºo
 = 
EINVAL
;

502 *
buf_±r
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
Ën
));

503 ià(
£rŸlized_ouut
) {

504 
sockaddr_¡Üage
 
¤c_addr
;

505 
sockaddr
 *
¤c_addr_±r
 =

506 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
¤c_addr
);

507 
sockËn_t
 
add¾’
;

508 
»t
 = 
	`»cväom
(
sockfd
, *
buf_±r
, 
Ën
, 
æags
, 
¤c_addr_±r
, &
add¾’
);

509 
size_t
 
¤c_addr_Ën
 = 0;

513 
”rÜ_code
;

516 ià(!
asylo
::
	`S”ŸlizeRecvFromSrcAddr
(
¤c_addr_±r
, 
£rŸlized_ouut
,

517 &
¤c_addr_Ën
, &
”rÜ_code
)) {

518 
”ºo
 = 
EINVAL
;

521 *
£rŸlized_ouut_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
¤c_addr_Ën
);

522  
»t
;

524  
	`»cväom
(
sockfd
, *
buf_±r
, 
Ën
, 
æags
, 
nuÎ±r
,‚ullptr);

526 
	}
}

532 
	$oÿÎ_’c_uÁru¡ed_pŞl
(
bridge_pŞlfd
 *
fds
, 
nfds
,

533 
timeout
) {

534 autØ
tmp
 = 
ab¦
::
make_unique
<
pŞlfd
[]>(
nfds
);

535 
i
 = 0; i < 
nfds
; ++i) {

536 ià(!
asylo
::
	`FromBridgePŞlfd
(&
fds
[
i
], &
tmp
[i])) {

537 
”ºo
 = 
EFAULT
;

541 
»t
 = 
	`pŞl
(
tmp
.
	`g‘
(), 
nfds
, 
timeout
);

542 
i
 = 0; i < 
nfds
; ++i) {

543 ià(!
asylo
::
	`ToBridgePŞlfd
(&
tmp
[
i
], &
fds
[i])) {

544 
”ºo
 = 
EFAULT
;

548  
»t
;

549 
	}
}

555 
	$oÿÎ_’c_uÁru¡ed_•Şl_ü—‹
(
size
è{  
	`•Şl_ü—‹
(size); 
	}
}

557 
	$oÿÎ_’c_uÁru¡ed_•Şl_ùl
(cÚ¡ *
£rŸlized_¬gs
,

558 
bridge_size_t
 
£rŸlized_¬gs_Ën
) {

559 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
,

560 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_¬gs_Ën
));

561 
•fd
 = 0;

562 
İ
 = 0;

563 
ho¡fd
 = 0;

564 
•Şl_ev’t
 
ev’t
;

565 ià(!
asylo
::
	`De£rŸlizeEpŞlCArgs
(
£rŸlized_¬gs_¡r
, &
•fd
, &
İ
, &
ho¡fd
,

566 &
ev’t
)) {

567 
”ºo
 = 
EINVAL
;

570  
	`•Şl_ùl
(
•fd
, 
İ
, 
ho¡fd
, &
ev’t
);

571 
	}
}

573 
	$oÿÎ_’c_uÁru¡ed_•Şl_wa™
(cÚ¡ *
£rŸlized_¬gs
,

574 
bridge_size_t
 
£rŸlized_¬gs_Ën
,

575 **
£rŸlized_ev’ts
,

576 
bridge_size_t
 *
£rŸlized_ev’ts_Ën
) {

577 
•fd
 = 0;

578 
maxev’ts
 = 0;

579 
timeout
 = 0;

580 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
,

581 
¡©ic_ÿ¡
<
size_t
>(
£rŸlized_¬gs_Ën
));

582 ià(!
asylo
::
	`De£rŸlizeEpŞlWa™Args
(
£rŸlized_¬gs_¡r
, &
•fd
, &
maxev’ts
,

583 &
timeout
)) {

584 
”ºo
 = 
EINVAL
;

587 
•Şl_ev’t
 *
ev’t_¬¿y
 = 
¡©ic_ÿ¡
<epoll_event *>(

588 
	`m®loc
((
•Şl_ev’t
è* 
maxev’ts
));

589 
asylo
::
M®locUniquePŒ
<
•Şl_ev’t
> 
	`ev’t_¬¿y_±r
(
ev’t_¬¿y
);

590 
»t
 = 
	`•Şl_wa™
(
•fd
, 
ev’t_¬¿y
, 
maxev’ts
, 
timeout
);

591 
size_t
 
Ën
 = 0;

592 ià(!
asylo
::
	`S”ŸlizeEv’ts
(
ev’t_¬¿y
, 
»t
, 
£rŸlized_ev’ts
, &
Ën
)) {

593 
”ºo
 = 
EINVAL
;

596 *
£rŸlized_ev’ts_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
Ën
);

597  
»t
;

598 
	}
}

604 
	$oÿÎ_’c_uÁru¡ed_šÙify_š™1
(
nÚ_block
) {

605 
æags
 = 
nÚ_block
 ? 
IN_NONBLOCK
 : 0;

606  
	`šÙify_š™1
(
æags
);

607 
	}
}

609 
	$oÿÎ_’c_uÁru¡ed_šÙify_add_w©ch
(cÚ¡ *
£rŸlized_¬gs
,

610 
bridge_size_t
 
£rŸlized_¬gs_Ën
) {

611 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
);

612 
fd
 = 0;

613 *
·thÇme
 = 
nuÎ±r
;

614 
asylo
::
M®locUniquePŒ
<> 
	`·thÇme_±r
(
·thÇme
);

615 
ušt32_t
 
mask
 = 0;

616 ià(!
asylo
::
	`De£rŸlizeInÙifyAddW©chArgs
(
£rŸlized_¬gs_¡r
, &
fd
,

617 &
·thÇme
, &
mask
)) {

618 
”ºo
 = 
EINVAL
;

621  
	`šÙify_add_w©ch
(
fd
, 
·thÇme
, 
mask
);

622 
	}
}

624 
	$oÿÎ_’c_uÁru¡ed_šÙify_rm_w©ch
(cÚ¡ *
£rŸlized_¬gs
,

625 
bridge_size_t
 
£rŸlized_¬gs_Ën
) {

626 
¡d
::
¡ršg
 
	`£rŸlized_¬gs_¡r
(
£rŸlized_¬gs
, 
£rŸlized_¬gs_Ën
);

627 
fd
 = 0;

628 
wd
 = 0;

629 ià(!
asylo
::
	`De£rŸlizeInÙifyRmW©chArgs
(
£rŸlized_¬gs_¡r
, &
fd
, &
wd
)) {

630 
”ºo
 = 
EINVAL
;

633  
	`šÙify_rm_w©ch
(
fd
, 
wd
);

634 
	}
}

636 
	$oÿÎ_’c_uÁru¡ed_šÙify_»ad
(
fd
, 
bridge_size_t
 
couÁ
,

637 **
£rŸlized_ev’ts
,

638 
bridge_size_t
 *
£rŸlized_ev’ts_Ën
) {

639 
size_t
 
buf_size
 =

640 
¡d
::
	`max
((
šÙify_ev’t
è+ 
NAME_MAX
 + 1, 
couÁ
);

641 *
buf
 = 
¡©ic_ÿ¡
<*>(
	`m®loc
(
buf_size
));

642 
asylo
::
M®locUniquePŒ
<> 
	`buf_±r
(
buf
);

643 
by‹s_»ad
 = 
	`»ad
(
fd
, 
buf
, 
buf_size
);

644 ià(
by‹s_»ad
 < 0) {

648 
size_t
 
Ën
 = 0;

649 ià(!
asylo
::
	`S”ŸlizeInÙifyEv’ts
(
buf
, 
by‹s_»ad
, 
£rŸlized_ev’ts
,

650 &
Ën
)) {

653 *
£rŸlized_ev’ts_Ën
 = 
¡©ic_ÿ¡
<
bridge_size_t
>(
Ën
);

655 
	}
}

661 
	$oÿÎ_’c_uÁru¡ed_g‘içddrs
(**
£rŸlized_içddrs
,

662 
bridge_ssize_t
 *
£rŸlized_içddrs_Ën
) {

663 
içddrs
 *
içddr_li¡
 = 
nuÎ±r
;

664 
»t
 = 
	`g‘içddrs
(&
içddr_li¡
);

665 ià(
»t
 != 0) {

668 
size_t
 
Ën
 = 0;

669 ià(!
asylo
::
	`S”ŸlizeIfAddrs
(
içddr_li¡
, 
£rŸlized_içddrs
, &
Ën
)) {

670 
	`ä“içddrs
(
içddr_li¡
);

673 *
£rŸlized_içddrs_Ën
 = 
¡©ic_ÿ¡
<
bridge_ssize_t
>(
Ën
);

674 
	`ä“içddrs
(
içddr_li¡
);

675  
»t
;

676 
	}
}

682 
	$oÿÎ_’c_uÁru¡ed_g‘pwuid
(
uid_t
 
uid
,

683 
BridgePassWd
 *
bridge_·sswÜd
) {

684 
·sswd
 *
·sswÜd
 = 
	`g‘pwuid
(
uid
);

685 ià(!
·sswÜd
) {

688 ià(!
asylo
::
	`ToBridgePassWd
(
·sswÜd
, 
bridge_·sswÜd
)) {

689 
”ºo
 = 
EFAULT
;

693 
	}
}

699 
	$oÿÎ_’c_uÁru¡ed_sched_g‘affš™y
(
št64_t
 
pid
, 
BridgeCpuS‘
 *
mask
) {

700 
ıu_£t_t
 
ho¡_mask
;

701 ià(
BRIDGE_CPU_SET_MAX_CPUS
 !ğ
CPU_SETSIZE
) {

702 
	`LOG
(
ERROR
è<< "sched_g‘affš™y: CPU_SETSIZE (" << 
CPU_SETSIZE


703 << "èi nÙƒqu®Ø" << 
BRIDGE_CPU_SET_MAX_CPUS
;

704 
”ºo
 = 
ENOSYS
;

708 
»t
 =

709 
	`sched_g‘affš™y
(
¡©ic_ÿ¡
<
pid_t
>(
pid
), (
ıu_£t_t
), &
ho¡_mask
);

712 
tÙ®_ıus
 = 
	`CPU_COUNT
(&
ho¡_mask
);

713 
asylo
::
	`BridgeCpuS‘Z”o
(
mask
);

714 
ıu
 = 0, 
ıus_so_çr
 = 0; cpus_so_ç¸< 
tÙ®_ıus
; ++cpu) {

715 ià(
	`CPU_ISSET
(
ıu
, &
ho¡_mask
)) {

716 
asylo
::
	`BridgeCpuS‘AddB™
(
ıu
, 
mask
);

717 ++
ıus_so_çr
;

721  
»t
;

722 
	}
}

728 
	$oÿÎ_’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

729 
bridge_signum
, cÚ¡ 
BridgeSigÇlHªdËr
 *
hªdËr
,

730 cÚ¡ *
Çme
) {

731 
¡d
::
¡ršg
 
	`’şave_Çme
(
Çme
);

732 
signum
 = 
asylo
::
	`FromBridgeSigÇl
(
bridge_signum
);

733 ià(
signum
 < 0) {

734 
”ºo
 = 
EINVAL
;

737 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

738 ià(!
mªag”_»suÉ
.
	`ok
()) {

743 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

744 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”
->
	`G‘Cl›Á
(
’şave_Çme
);

745 cÚ¡ 
asylo
::
EnşaveCl›Á
 *
Şd_ş›Á
 =

746 
asylo
::
EnşaveSigÇlDi¥©ch”
::
	`G‘In¡ªû
()->
	`Regi¡”SigÇl
(
signum
,

747 
ş›Á
);

748 ià(
Şd_ş›Á
) {

749 
	`LOG
(
WARNING
è<< "Ov”wr™šghsigÇÈhªdË¸fÜ sigÇl: " << 
signum


750 << "„egi¡”ed byƒnşave: " << 
mªag”
->
	`G‘Name
(
Şd_ş›Á
);

752 
sigaùiÚ
 
Ãwaù
;

753 ià(!
hªdËr
 || !hªdËr->
sigaùiÚ
) {

756 
Ãwaù
.
§_sigaùiÚ
 = &
EÁ”EnşaveAndHªdËSigÇl
;

761 
hªdË_sigÇl_šside_’şave
 = 
hªdËr
->
sigaùiÚ
;

762 
Ãwaù
.
§_sigaùiÚ
 = &
HªdËSigÇlInSim
;

764 ià(
hªdËr
) {

765 
asylo
::
	`FromBridgeSigS‘
(&
hªdËr
->
mask
, &
Ãwaù
.
§_mask
);

769 
Ãwaù
.
§_æags
 = 
asylo
::
	`FromBridgeSigÇlFÏgs
(
hªdËr
->
æags
);

770 
Ãwaù
.
§_æags
 |ğ
SA_SIGINFO
;

771 
sigaùiÚ
 
Şdaù
;

772  
	`sigaùiÚ
(
signum
, &
Ãwaù
, &
Şdaù
);

773 
	}
}

775 
	$oÿÎ_’c_uÁru¡ed_sig´ocmask
(
how
, cÚ¡ 
bridge_sig£t_t
 *
£t
,

776 
bridge_sig£t_t
 *
Şd£t
) {

777 
sig£t_t
 
tmp_£t
;

778 
asylo
::
	`FromBridgeSigS‘
(
£t
, &
tmp_£t
);

779 
sig£t_t
 
tmp_Şd£t
;

780 
»t
 =

781 
	`sig´ocmask
(
asylo
::
	`FromBridgeSigMaskAùiÚ
(
how
), &
tmp_£t
, &
tmp_Şd£t
);

782 
asylo
::
	`ToBridgeSigS‘
(&
tmp_Şd£t
, 
Şd£t
);

783  
»t
;

784 
	}
}

786 
	$oÿÎ_’c_uÁru¡ed_¿i£
(
bridge_sig
) {

787 
sig
 = 
asylo
::
	`FromBridgeSigÇl
(
bridge_sig
);

788 ià(
sig
 < 0) {

789 
”ºo
 = 
EINVAL
;

792  
	`¿i£
(
sig
);

793 
	}
}

799 
	$oÿÎ_’c_uÁru¡ed_g‘ru§ge
(
RU§geT¬g‘
 
who
,

800 
BridgeRU§ge
 *
bridge_u§ge
) {

801 
ru§ge
 
u§ge
;

802 
»t
 = 
	`g‘ru§ge
(
asylo
::
	`FromBridgeRU§geT¬g‘
(
who
), &
u§ge
);

803 
asylo
::
	`ToBridgeRU§ge
(&
u§ge
, 
bridge_u§ge
);

804  
»t
;

805 
	}
}

811 
	$oÿÎ_’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
) {

812  
	`æock
(
fd
, 
asylo
::
	`FromBridgeFLockO³¿tiÚ
(
İ”©iÚ
));

813 
	}
}

819 
	$oÿÎ_’c_uÁru¡ed_£Ëù
(
nfds
, 
BridgeFDS‘
 *
bridge_»adfds
,

820 
BridgeFDS‘
 *
bridge_wr™efds
,

821 
BridgeFDS‘
 *
bridge_exû±fds
,

822 
bridge_timev®
 *
bridge_timeout
) {

823 
fd_£t
 
»adfds
, 
wr™efds
, 
exû±fds
;

824 ià(
bridge_»adfds
 && !
asylo
::
	`FromBridgeFDS‘
(bridge_»adfds, &
»adfds
)) {

825 
”ºo
 = 
EBADE
;

828 ià(
bridge_wr™efds
 && !
asylo
::
	`FromBridgeFDS‘
(bridge_wr™efds, &
wr™efds
)) {

829 
”ºo
 = 
EBADE
;

832 ià(
bridge_exû±fds
 &&

833 !
asylo
::
	`FromBridgeFDS‘
(
bridge_exû±fds
, &
exû±fds
)) {

834 
”ºo
 = 
EBADE
;

838 
timev®
 
timeout
;

839 ià(!
asylo
::
	`FromBridgeTimeV®
(
bridge_timeout
, &
timeout
)) {

840 
”ºo
 = 
EBADE
;

843 
»t
 = 
	`£Ëù
(
nfds
, &
»adfds
, &
wr™efds
, &
exû±fds
, &
timeout
);

845 ià(
bridge_»adfds
 && !
asylo
::
	`ToBridgeFDS‘
(&
»adfds
, bridge_readfds)) {

846 
”ºo
 = 
EBADE
;

849 ià(
bridge_wr™efds
 && !
asylo
::
	`ToBridgeFDS‘
(&
wr™efds
, bridge_writefds)) {

850 
”ºo
 = 
EBADE
;

853 ià(
bridge_exû±fds
 && !
asylo
::
	`ToBridgeFDS‘
(&
exû±fds
, bridge_exceptfds)) {

854 
”ºo
 = 
EBADE
;

858  
»t
;

859 
	}
}

865 
	$oÿÎ_’c_uÁru¡ed_İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
) {

866 
	`İ’log
(
id’t
, 
asylo
::
	`FromBridgeSysLogO±iÚ
(
İtiÚ
),

867 
asylo
::
	`FromBridgeSysLogFac™y
(
çc™y
));

868 
	}
}

870 
	$oÿÎ_’c_uÁru¡ed_sy¦og
(
´iÜ™y
, cÚ¡ *
mes§ge
) {

871 
	`sy¦og
(
asylo
::
	`FromBridgeSysLogPriÜ™y
(
´iÜ™y
), "%s", 
mes§ge
);

872 
	}
}

878 
	$oÿÎ_’c_uÁru¡ed_Çno¦“p
(cÚ¡ 
bridge_time¥ec
 *
»q
,

879 
bridge_time¥ec
 *
»m
) {

880 
»t
 = 
	`Çno¦“p
(
»š‹½»t_ÿ¡
<cÚ¡ 
time¥ec
 *>(
»q
),

881 
»š‹½»t_ÿ¡
<
time¥ec
 *>(
»m
));

882  
»t
;

883 
	}
}

885 
	$oÿÎ_’c_uÁru¡ed_times
(
BridgeTms
 *
bridge_buf
) {

886 
tms
 
buf
;

887 
»t
 = 
	`times
(&
buf
);

888 ià(!
asylo
::
	`ToBridgeTms
(&
buf
, 
bridge_buf
)) {

889 
”ºo
 = 
EFAULT
;

892  
»t
;

893 
	}
}

895 
	$oÿÎ_’c_uÁru¡ed_şock_g‘time
(
bridge_şockid_t
 
şk_id
,

896 
bridge_time¥ec
 *

) {

897 
»t
 = 
	`şock_g‘time
(
¡©ic_ÿ¡
<
şockid_t
>(
şk_id
),

898 
»š‹½»t_ÿ¡
<
time¥ec
 *>(

));

899  
»t
;

900 
	}
}

902 
	$oÿÎ_’c_uÁru¡ed_g‘™im”
(
Tim”Ty³
 
which
,

903 
BridgeITim”V®
 *
bridge_cu¼_v®ue
) {

904 
™im”v®
 
cu¼_v®ue
;

905 
»t
 = 
	`g‘™im”
(
asylo
::
	`FromBridgeTim”Ty³
(
which
), &
cu¼_v®ue
);

906 ià(
bridge_cu¼_v®ue
 =ğ
nuÎ±r
 ||

907 !
asylo
::
	`ToBridgeITim”V®
(&
cu¼_v®ue
, 
bridge_cu¼_v®ue
)) {

908 
”ºo
 = 
EFAULT
;

911  
»t
;

912 
	}
}

914 
	$oÿÎ_’c_uÁru¡ed_£t™im”
(
Tim”Ty³
 
which
,

915 
BridgeITim”V®
 *
bridge_Ãw_v®ue
,

916 
BridgeITim”V®
 *
bridge_Şd_v®ue
) {

917 
™im”v®
 
Ãw_v®ue
, 
Şd_v®ue
;

918 ià(!
asylo
::
	`FromBridgeITim”V®
(
bridge_Ãw_v®ue
, &
Ãw_v®ue
)) {

919 
”ºo
 = 
EFAULT
;

922 
»t
 =

923 
	`£t™im”
(
asylo
::
	`FromBridgeTim”Ty³
(
which
), &
Ãw_v®ue
, &
Şd_v®ue
);

924 ià(
bridge_Şd_v®ue
 !ğ
nuÎ±r
 &&

925 !
asylo
::
	`ToBridgeITim”V®
(&
Şd_v®ue
, 
bridge_Şd_v®ue
)) {

926 
”ºo
 = 
EFAULT
;

929  
»t
;

930 
	}
}

936 
	$oÿÎ_’c_uÁru¡ed_g‘timeofday
(
bridge_timev®
 *
tv
, *
tz
) {

937  
	`g‘timeofday
(
»š‹½»t_ÿ¡
<
timev®
 *>(
tv
), 
nuÎ±r
);

938 
	}
}

944 
	$oÿÎ_’c_uÁru¡ed_uÇme
(
BridgeUtsName
 *
bridge_ut¢ame_v®
) {

945 ià(!
bridge_ut¢ame_v®
) {

946 
”ºo
 = 
EFAULT
;

950 
ut¢ame
 
ut¢ame_v®
;

951 
»t
 = 
	`uÇme
(&
ut¢ame_v®
);

952 ià(
»t
 != 0) {

953  
»t
;

956 ià(!
asylo
::
	`CÚv”tUtsName
(
ut¢ame_v®
, 
bridge_ut¢ame_v®
)) {

957 
”ºo
 = 
EINTR
;

961  
»t
;

962 
	}
}

968 
	$oÿÎ_’c_uÁru¡ed_pe2
(
pefd
[2], 
æags
) {

969 
»t
 = 
	`pe2
(
pefd
, 
asylo
::
	`FromBridgeFeFÏgs
(
æags
));

970  
»t
;

971 
	}
}

973 
št64_t
 
	$oÿÎ_’c_uÁru¡ed_syscÚf
(
SyscÚfCÚ¡ªts
 
bridge_Çme
) {

974 
Çme
 = 
asylo
::
	`FromBridgeSyscÚfCÚ¡ªts
(
bridge_Çme
);

975 
št64_t
 
»t
 = -1;

976 ià(
Çme
 != -1) {

977 
»t
 = 
	`syscÚf
(
Çme
);

979  
»t
;

980 
	}
}

982 
ušt32_t
 
	$oÿÎ_’c_uÁru¡ed_¦“p
(
ušt32_t
 
£cÚds
è{  
	`¦“p
(£cÚds); 
	}
}

984 
	$oÿÎ_’c_uÁru¡ed__ex™
(
rc
è{ 
	`_ex™
Ôc); 
	}
}

986 
pid_t
 
	$oÿÎ_’c_uÁru¡ed_fÜk
(cÚ¡ *
’şave_Çme
, cÚ¡ *
cÚfig
,

987 
bridge_size_t
 
cÚfig_Ën
,

988 
boŞ
 
»¡Üe_¢­shÙ
) {

989 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

990 ià(!
mªag”_»suÉ
.
	`ok
()) {

993 
asylo
::
EnşaveMªag”
 *
mªag”
 = 
mªag”_»suÉ
.
	`V®ueOrD›
();

994 
asylo
::
SgxCl›Á
 *
ş›Á
 = 
dyÇmic_ÿ¡
<asylo::SgxClient *>(

995 
mªag”
->
	`G‘Cl›Á
(
’şave_Çme
));

997 ià(!
»¡Üe_¢­shÙ
) {

1000 
pid_t
 
pid
 = 
	`fÜk
();

1001 ià(
pid
 == 0) {

1004 
ş›Á
->
	`S‘ProûssId
();

1006  
pid
;

1012 *
’şave_ba£_add»ss
 = 
ş›Á
->
	`ba£_add»ss
();

1013 
asylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout
;

1014 
asylo
::
SÇpshÙLayout
 
¢­shÙ_Ïyout2
;

1015 
asylo
::
Stus
 
¡©us
 = 
ş›Á
->
	`EÁ”AndTakeSÇpshÙ
(&
¢­shÙ_Ïyout
);

1016 ià(!
¡©us
.
	`ok
()) {

1017 
	`LOG
(
ERROR
è<< "EÁ”AndTakeSÇpshÙ faed: " << 
¡©us
;

1018 
”ºo
 = 
ENOMEM
;

1022 
	`LOG
(
INFO
è<< "Thi i ¢­shÙ1 : " << &
¢­shÙ_Ïyout
;

1023 
FILE
 * 
å
 = 
	`fİ’
("/tmp/snapshot_layout2", "wb");

1024 
	`fwr™e
(&
¢­shÙ_Ïyout
, (
asylo
::
SÇpshÙLayout
), 1, 
å
);

1025 
	`fşo£
(
å
);

1028 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
d©a_d–‘”_
;

1029 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
bss_d–‘”_
;

1030 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
h—p_d–‘”_
;

1031 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
th»ad_d–‘”_
;

1032 
¡d
::
veùÜ
<
SÇpshÙD©aD–‘”
> 
¡ack_d–‘”_
;

1034 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`d©a
().
	`cbegš
(), sÇpshÙ_Ïyout.d©a().
	`ûnd
(),

1035 
¡d
::
	`back_š£¹”
(
d©a_d–‘”_
),

1036 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1037  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1040 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`bss
().
	`cbegš
(), sÇpshÙ_Ïyout.bss().
	`ûnd
(),

1041 
¡d
::
	`back_š£¹”
(
bss_d–‘”_
),

1042 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1043  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1046 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`h—p
().
	`cbegš
(), sÇpshÙ_Ïyout.h—p().
	`ûnd
(),

1047 
¡d
::
	`back_š£¹”
(
h—p_d–‘”_
),

1048 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1049  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1052 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`th»ad
().
	`cbegš
(),

1053 
¢­shÙ_Ïyout
.
	`th»ad
().
	`ûnd
(),

1054 
¡d
::
	`back_š£¹”
(
th»ad_d–‘”_
),

1055 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1056  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1059 
¡d
::
	`ŒªsfÜm
(
¢­shÙ_Ïyout
.
	`¡ack
().
	`cbegš
(),

1060 
¢­shÙ_Ïyout
.
	`¡ack
().
	`ûnd
(),

1061 
¡d
::
	`back_š£¹”
(
¡ack_d–‘”_
),

1062 [](cÚ¡ 
asylo
::
SÇpshÙLayoutEÁry
 &
’Œy
) {

1063  
	`SÇpshÙD©aD–‘”
(
’Œy
);

1066 
asylo
::
EnşaveLßd”
 *
lßd”
 = 
mªag”
->
	`G‘Lßd”FromCl›Á
(
ş›Á
);

1070 ià(!
dyÇmic_ÿ¡
<
asylo
::
SgxLßd”
 *>(
lßd”
) &&

1071 !
dyÇmic_ÿ¡
<
asylo
::
SgxEmbeddedLßd”
 *>(
lßd”
)) {

1072 
	`LOG
(
ERROR
) << "Failedo gethe†oader forheƒnclaveo fork";

1073 
”ºo
 = 
EFAULT
;

1080 
sock‘_·œ
[2];

1081 ià(
	`sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
sock‘_·œ
) < 0) {

1082 
	`LOG
(
ERROR
) << "Failedo create socket…air";

1083 
”ºo
 = 
EFAULT
;

1090 
pefd
[2];

1091 ià(
	`pe
(
pefd
) < 0) {

1092 
	`LOG
(
ERROR
) << "Failedo create…ipe";

1093 
”ºo
 = 
EFAULT
;

1097 
pid_t
 
pid
 = 
	`fÜk
();

1098 ià(
pid
 == -1) {

1099  
pid
;

1103 
size_t
 
’şave_size
 = 
ş›Á
->
	`size
();

1107 
asylo
::
EnşaveCÚfig
 
’şave_cÚfig
;

1108 ià(!
’şave_cÚfig
.
	`P¬£FromA¼ay
(
cÚfig
, 
¡©ic_ÿ¡
<
size_t
>(
cÚfig_Ën
))) {

1109 
	`LOG
(
ERROR
) << "Failedo…arse EnclaveConfig";

1110 
”ºo
 = 
EFAULT
;

1114 ià(
pid
 == 0) {

1115 ià(
	`şo£
(
pefd
[0]) < 0) {

1116 
	`LOG
(
ERROR
è<< "çedØşo£…efd: " << 
	`¡»¼Ü
(
”ºo
);

1117 
”ºo
 = 
EFAULT
;

1121 
	`LOG
(
INFO
è<< "ba£: " << 
’şave_ba£_add»ss
 << " sz: " << 
’şave_size
;

1122 
¡©us
 = 
mªag”
->
	`LßdEnşave
(
’şave_Çme
, *
lßd”
, 
’şave_cÚfig
,

1123 
’şave_ba£_add»ss
, 
’şave_size
);

1124 ià(!
¡©us
.
	`ok
()) {

1125 
	`LOG
(
ERROR
è<< "Lßd‚ewƒnşavçed:" << 
¡©us
;

1126 
”ºo
 = 
ENOMEM
;

1132 
ş›Á
 = 
dyÇmic_ÿ¡
<
asylo
::
SgxCl›Á
 *>(
mªag”
->
	`G‘Cl›Á
(
’şave_Çme
));

1133 *
chd_’şave_ba£_add»ss
 = 
ş›Á
->
	`ba£_add»ss
();

1134 ià(
chd_’şave_ba£_add»ss
 !ğ
’şave_ba£_add»ss
) {

1135 
	`LOG
(
ERROR
è<< "Newƒnşavadd»ss: " << 
chd_’şave_ba£_add»ss


1137 << 
’şave_ba£_add»ss
;

1138 
”ºo
 = 
EAGAIN
;

1142 
¡d
::
¡ršg
 
chd_»suÉ
 = "Child fork succeeded";

1143 
	`LOG
(
INFO
è<< "chd„esuÉ : " << 
chd_»suÉ
;

1144 
asylo
::
Stus
 
¡©us
 = 
	`DoSÇpshÙKeyT¿nsãr
(

1145 
mªag”
, 
ş›Á
, 
sock‘_·œ
[0], sock‘_·œ[1], 
çl£
);

1146 ià(!
¡©us
.
	`ok
()) {

1148 
chd_»suÉ
 = "Child DoSnapshotKeyTransfer failed";

1149 ià(
	`wr™e
(
pefd
[1], 
chd_»suÉ
.
	`d©a
(), chd_»suÉ.
	`size
()) < 0) {

1150 
	`LOG
(
ERROR
è<< "FaedØwr™chd fÜk„esuÉo: " << 
pefd
[1]

1151 << ",ƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

1154 
	`LOG
(
ERROR
è<< "DoSÇpshÙKeyT¿nsã¸çed: " << 
¡©us
;

1155 
”ºo
 = 
EFAULT
;

1160 
FILE
 * 
å
 = 
	`fİ’
("/tmp/snapshot_layout2", "rb");

1161 
	`ä—d
(&
¢­shÙ_Ïyout2
, (
asylo
::
SÇpshÙLayout
), 1, 
å
);

1162 
	`fşo£
(
å
);

1163 
	`LOG
(
INFO
è<< "Thi i ¢­shÙ2 : " << &
¢­shÙ_Ïyout2
;

1170 
¡©us
 = 
ş›Á
->
	`EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout2
);

1171 ià(!
¡©us
.
	`ok
()) {

1173 
chd_»suÉ
 = "Child EnterAndRestore failed";

1174 ià(
	`wr™e
(
pefd
[1], 
chd_»suÉ
.
	`d©a
(), chd_»suÉ.
	`size
()) < 0) {

1175 
	`LOG
(
ERROR
è<< "FaedØwr™chd fÜk„esuÉo: " << 
pefd
[1]

1176 << ",ƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

1179 
	`LOG
(
ERROR
è<< "EÁ”AndRe¡Üçed: " << 
¡©us
;

1180 
”ºo
 = 
EAGAIN
;

1184 ià(
	`wr™e
(
pefd
[1], 
chd_»suÉ
.
	`d©a
(), chd_»suÉ.
	`size
()) < 0) {

1185 
	`LOG
(
ERROR
è<< "FaedØwr™chd fÜk„esuÉo: " << 
pefd
[1]

1186 << ",ƒ¼Ü: " << 
	`¡»¼Ü
(
”ºo
);

1190 ià(
	`şo£
(
pefd
[1]) < 0) {

1191 
	`LOG
(
ERROR
è<< "FaedØşo£…efd: " << 
	`¡»¼Ü
(
”ºo
);

1192 
”ºo
 = 
EFAULT
;

1195 
asylo
::
Stus
 
¡©us
 = 
	`DoSÇpshÙKeyT¿nsãr
(

1196 
mªag”
, 
ş›Á
, 
sock‘_·œ
[1],

1197  
sock‘_·œ
[0], 
Œue
);

1198 ià(!
¡©us
.
	`ok
()) {

1199 
	`LOG
(
ERROR
è<< "DoSÇpshÙKeyT¿nsã¸çed: " << 
¡©us
;

1200 
”ºo
 = 
EFAULT
;

1205 cÚ¡ 
timeout_£cÚds
 = 5;

1206 
fd_£t
 
»ad_fds
;

1207 
	`FD_ZERO
(&
»ad_fds
);

1208 
	`FD_SET
(
pefd
[0], &
»ad_fds
);

1209 
timev®
 
timeout
;

1210 
timeout
.
tv_£c
 = 
timeout_£cÚds
;

1211 
timeout
.
tv_u£c
 = 0;

1212 
wa™_»suÉ
 =

1213 
	`£Ëù
Ğ
pefd
[0] + 1, &
»ad_fds
, 
nuÎ±r
,

1214  
nuÎ±r
, &
timeout
);

1215 ià(
wa™_»suÉ
 < 0) {

1216 
	`LOG
(
ERROR
) << "Error while waiting for child fork„esult: "

1217 << 
	`¡»¼Ü
(
”ºo
);

1219 } ià(
wa™_»suÉ
 == 0) {

1220 
	`LOG
(
ERROR
) << "Timeout waiting for fork„esult fromhe child";

1221 
”ºo
 = 
EFAULT
;

1225 
buf
[64];

1226 
rc
 = 
	`»ad
(
pefd
[0], 
buf
, (buf));

1227 ià(
rc
 <= 0) {

1228 
	`LOG
(
ERROR
) << "Failedo„ead child fork„esult";

1231 
buf
[
rc
] = '\0';

1232 ià(
	`¡ºcmp
(
buf
, "Child fork succeeded", (buf)) != 0) {

1233 
	`LOG
(
ERROR
è<< 
buf
;

1237  
pid
;

1238 
	}
}

1244 
pid_t
 
	$oÿÎ_’c_uÁru¡ed_wa™3
(
BridgeWStus
 *
bridge_w¡©us
,

1245 
İtiÚs
,

1246 
BridgeRU§ge
 *
bridge_u§ge
) {

1247 
ru§ge
 
u§ge
;

1248 
w¡©us
;

1249 
pid_t
 
»t
 = 
	`wa™3
(&
w¡©us
, 
asylo
::
	`FromBridgeWa™O±iÚs
(
İtiÚs
), &
u§ge
);

1250 
asylo
::
	`ToBridgeRU§ge
(&
u§ge
, 
bridge_u§ge
);

1251 ià(
bridge_w¡©us
) {

1252 *
bridge_w¡©us
 = 
asylo
::
	`ToBridgeWStus
(
w¡©us
);

1254  
»t
;

1255 
	}
}

1257 
pid_t
 
	$oÿÎ_’c_uÁru¡ed_wa™pid
(
pid_t
 
pid
,

1258 
BridgeWStus
 *
bridge_w¡©us
,

1259 
İtiÚs
) {

1260 
w¡©us
;

1261 
pid_t
 
»t
 = 
	`wa™pid
(
pid
, &
w¡©us
, 
asylo
::
	`FromBridgeWa™O±iÚs
(
İtiÚs
));

1262 ià(
bridge_w¡©us
) {

1263 *
bridge_w¡©us
 = 
asylo
::
	`ToBridgeWStus
(
w¡©us
);

1265  
»t
;

1266 
	}
}

1272 
	$oÿÎ_’c_uÁru¡ed_utime
(cÚ¡ *
f’ame
,

1273 cÚ¡ 
bridge_utimbuf
 *
times
) {

1274 
utimbuf
 
tmp
;

1275  
	`utime
(
f’ame
, 
asylo
::
	`FromBridgeUtimbuf
(
times
, &
tmp
));

1276 
	}
}

1278 
	$oÿÎ_’c_uÁru¡ed_utimes
(

1279 cÚ¡ *
f’ame
, cÚ¡ 
bridge_timev®
 *
bridge_acûss_time
,

1280 cÚ¡ 
bridge_timev®
 *
bridge_modifiÿtiÚ_time
) {

1281 
timev®
 
times
[2];

1282 ià(!
asylo
::
	`FromBridgeTimeV®
(
bridge_acûss_time
, &
times
[0]) ||

1283 !
asylo
::
	`FromBridgeTimeV®
(
bridge_modifiÿtiÚ_time
, &
times
[1])) {

1284 
”ºo
 = 
EBADE
;

1287  
	`utimes
(
f’ame
, 
times
);

1288 
	}
}

1294 *
	$oÿÎ_’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1295 cÚ¡ *
Çme
) {

1296 
asylo
::
Sh¬edName
 
	`sh¬ed_Çme
(
kšd
, 
¡d
::
	`¡ršg
(
Çme
));

1297 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

1298 ià(
mªag”_»suÉ
.
	`ok
()) {

1299  
mªag”_»suÉ
.
	`V®ueOrD›
()

1300 ->
	`sh¬ed_»sourûs
()

1301 ->
AcquœeResourû
<>(
sh¬ed_Çme
);

1303  
nuÎ±r
;

1305 
	}
}

1307 
	$oÿÎ_’c_uÁru¡ed_»Ëa£_sh¬ed_»sourû
(
Sh¬edNameKšd
 
kšd
,

1308 cÚ¡ *
Çme
) {

1309 
asylo
::
Sh¬edName
 
	`sh¬ed_Çme
(
kšd
, 
¡d
::
	`¡ršg
(
Çme
));

1310 autØ
mªag”_»suÉ
 = 
asylo
::
EnşaveMªag”
::
	`In¡ªû
();

1311 ià(
mªag”_»suÉ
.
	`ok
()) {

1312  
mªag”_»suÉ
.
	`V®ueOrD›
()->
	`sh¬ed_»sourûs
()->
	`R–—£Resourû
(

1313 
sh¬ed_Çme
);

1315  
çl£
;

1316 
	}
}

1322 
	$oÿÎ_’c_uÁru¡ed_hex_dump
(cÚ¡ *
buf
, 
nby‹s
) {

1323 
	`årštf
(
¡d”r
, "%s\n", 
asylo
::
	`bufãr_to_hex_¡ršg
(
buf
, 
nby‹s
).
	`c_¡r
());

1324 
	}
}

1330 
	$oÿÎ_’c_uÁru¡ed_th»ad_ü—‹
(cÚ¡ *
Çme
) {

1331 
	`__asylo_dÚ©e_th»ad
(
Çme
);

1333 
	}
}

1335 
	$oÿÎ_di¥©ch_uÁru¡ed_ÿÎ
(
ušt64_t
 
£ËùÜ
, *
bufãr
) {

1336 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
 =

1337 
asylo
::
´im™ives
::
Cl›Á
::
	`Ex™C®lback
(

1338 
£ËùÜ
,

1339 
»š‹½»t_ÿ¡
<
asylo
::
´im™ives
::
N©iveP¬am‘”Sck
 *>(
bufãr
));

1341  
¡©us
.
	`”rÜ_code
();

1342 
	}
}

	@platform/arch/sgx/untrusted/sgx_client.cc

19 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/sgx_ş›Á.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
	~"ab¦/ty³s/¥ª.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/g’”©ed_bridge_u.h
"

30 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

31 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

32 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

33 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

34 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

35 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

36 
	~"asylo/ut/–f_»ad”.h
"

37 
	~"asylo/ut/fe_m­pšg.h
"

38 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

39 
	~"asylo/ut/¡©us_maüos.h
"

41 
Çme¥aû
 
	gasylo
 {

50 
Stus
 
	gSgxCl›Á
::
In™Ÿlize
(

51 cÚ¡ *
Çme
, 
size_t
 
Çme_Ën
, cÚ¡ *
šput
, size_ˆ
šput_Ën
,

52 **
ouut
, 
size_t
 *
ouut_Ën
) {

53 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

54 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
Çme
, 
Çme_Ën
});

55 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
šput
, 
šput_Ën
});

56 
ASYLO_RETURN_IF_ERROR
(
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

57 
´im™ives
::
kS–eùÜAsyloIn™
, &
·¿ms
));

59 ià(
	g·¿ms
.
em±y
()) {

60  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

63 
	g´im™ives
::
N©iveP¬am‘”Sck
::
Ex‹ÁPŒ
 
ouut_ex‹Á
 = 
·¿ms
.
Pİ
();

64 *
	gouut_Ën
 = 
ouut_ex‹Á
->
size
();

65 *
	gouut
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(*
ouut_Ën
));

66 
memıy
(*
ouut
, 
ouut_ex‹Á
->
As
<>(), *
ouut_Ën
);

67  
	gStus
::
OkStus
();

76 
Stus
 
	gSgxCl›Á
::
Run
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

77 **
ouut
, 
size_t
 *
ouut_Ën
) {

78 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

79 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
šput
, 
šput_Ën
});

80 
ASYLO_RETURN_IF_ERROR
(
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

81 
´im™ives
::
kS–eùÜAsyloRun
, &
·¿ms
));

83 ià(
	g·¿ms
.
em±y
()) {

84  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

87 
	g´im™ives
::
N©iveP¬am‘”Sck
::
Ex‹ÁPŒ
 
ouut_ex‹Á
 = 
·¿ms
.
Pİ
();

88 *
	gouut_Ën
 = 
ouut_ex‹Á
->
size
();

89 *
	gouut
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(*
ouut_Ën
));

90 
memıy
(*
ouut
, 
ouut_ex‹Á
->
As
<>(), *
ouut_Ën
);

91  
	gStus
::
OkStus
();

100 
Stus
 
	gSgxCl›Á
::
Fš®ize
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

101 **
ouut
, 
size_t
 *
ouut_Ën
) {

102 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

103 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
šput
, 
šput_Ën
});

104 
ASYLO_RETURN_IF_ERROR
(
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

105 
´im™ives
::
kS–eùÜAsyloFši
, &
·¿ms
));

106 
LOG
(
INFO
è<< "Fš®izouut_ËÀ" << *
	gouut_Ën
;

108 ià(
	g·¿ms
.
em±y
()) {

109  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

112 
	g´im™ives
::
N©iveP¬am‘”Sck
::
Ex‹ÁPŒ
 
ouut_ex‹Á
 = 
·¿ms
.
Pİ
();

113 *
	gouut_Ën
 = 
ouut_ex‹Á
->
size
();

114 *
	gouut
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(*
ouut_Ën
));

115 
memıy
(*
ouut
, 
ouut_ex‹Á
->
As
<>(), *
ouut_Ën
);

116  
	gStus
::
OkStus
();

121 
Stus
 
hªdË_sigÇl
(
sgx_’şave_id_t
 
eid
, cÚ¡ *
šput
,

122 
size_t
 
šput_Ën
) {

123 
	g»suÉ
;

124 
sgx_¡©us_t
 
	gsgx_¡©us
 = 
eÿÎ_hªdË_sigÇl
(

125 
eid
, &
»suÉ
, 
šput
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
šput_Ën
));

126 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

128  
Stus
(
sgx_¡©us
, "Calloƒcall_handle_signal failed");

129 } ià(
	g»suÉ
) {

130 
	g¡d
::
¡ršg
 
mes§ge
;

131 
	g»suÉ
) {

133 
mes§ge
 = "Invalid or unregistered incoming signal";

136 
mes§ge
 = "Enclave unableo handle signal in current state";

139 
mes§ge
 = "Incoming signal is blocked insideheƒnclave";

142 
mes§ge
 = "Unexpectedƒrror while handling signal";

144  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
mes§ge
);

146  
	gStus
::
OkStus
();

151 
Stus
 
ke_¢­shÙ
(
sgx_’şave_id_t
 
eid
, **
ouut
,

152 
size_t
 *
ouut_Ën
) {

153 
	g»suÉ
;

154 
bridge_size_t
 
	gbridge_ouut_Ën
 = 0;

155 
sgx_¡©us_t
 
	gsgx_¡©us
 =

156 
eÿÎ_ke_¢­shÙ
(
eid
, &
»suÉ
, 
ouut
, &
bridge_ouut_Ën
);

157 ià(
	gouut_Ën
) {

158 *
	gouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

160 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

162  
Stus
(
sgx_¡©us
, "Calloƒcall_take_snapshot failed");

163 } ià(
	g»suÉ
 || *
	gouut_Ën
 == 0) {

167  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

171  
	gStus
::
OkStus
();

176 
Stus
 
»¡Üe
(
sgx_’şave_id_t
 
eid
, cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

177 **
ouut
, 
size_t
 *
ouut_Ën
) {

178 
	g»suÉ
;

179 
bridge_size_t
 
	gbridge_ouut_Ën
 = 0;

180 
sgx_¡©us_t
 
	gsgx_¡©us
 =

181 
eÿÎ_»¡Üe
(
eid
, &
»suÉ
, 
šput
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
šput_Ën
),

182 
ouut
, &
bridge_ouut_Ën
);

183 ià(
	gouut_Ën
) {

184 *
	gouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

186 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

188  
Stus
(
sgx_¡©us
, "Calloƒcall_restore failed");

189 } ià(
	g»suÉ
 || *
	gouut_Ën
 == 0) {

193  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

197  
	gStus
::
OkStus
();

202 
Stus
 
Œªsãr_£cu»_¢­shÙ_key
(
sgx_’şave_id_t
 
eid
,

203 cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

204 **
ouut
, 
size_t
 *
ouut_Ën
) {

205 
	g»suÉ
;

206 
bridge_size_t
 
	gbridge_ouut_Ën
;

207 
sgx_¡©us_t
 
	gsgx_¡©us
 = 
eÿÎ_Œªsãr_£cu»_¢­shÙ_key
(

208 
eid
, &
»suÉ
, 
šput
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
šput_Ën
), 
ouut
,

209 &
bridge_ouut_Ën
);

210 ià(
	gouut_Ën
) {

211 *
	gouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

213 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

215  
Stus
(
sgx_¡©us
, "Calloƒcall_do_handshake failed");

216 } ià(
	g»suÉ
 || *
	gouut_Ën
 == 0) {

220  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "No output fromƒnclave");

222  
	gStus
::
OkStus
();

225 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
SgxLßd”
::
LßdEnşave
(

226 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

227 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) const {

228 
	g¡d
::
unique_±r
<
SgxCl›Á
> 
ş›Á
 = 
ab¦
::
make_unique
<SgxCl›Á>(
Çme
);

230 
ASYLO_ASSIGN_OR_RETURN
(

231 
ş›Á
->
´im™ive_ş›Á_
,

232 
´im™ives
::
LßdEnşave
<´im™ives::
SgxBack’d
>(

233 
Çme
, 
ba£_add»ss
, 
’şave_·th_
, 
’şave_size
, 
cÚfig
, 
debug_
,

234 
ab¦
::
make_unique
<
´im™ives
::
Di¥©chTabË
>()));

236 
	gş›Á
->
	g´im™ive_sgx_ş›Á_
 =

237 
¡d
::
¡©ic_poš‹r_ÿ¡
<
´im™ives
::
SgxEnşaveCl›Á
>(

238 
ş›Á
->
´im™ive_ş›Á_
);

240  
	g¡d
::
unique_±r
<
EnşaveCl›Á
>(
¡d
::
move
(
ş›Á
));

243 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
SgxLßd”
::
Cİy
() const {

244 
¡d
::
unique_±r
<
SgxLßd”
> 
lßd”
(
Ãw
 SgxLßd”(*
this
));

245 ià(!
	glßd”
) {

246  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo create self†oader");

248  
	g¡d
::
unique_±r
<
EnşaveLßd”
>(
lßd”
.
»Ëa£
());

251 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
SgxEmbeddedLßd”
::
LßdEnşave
(

252 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

253 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) const {

254 
	g¡d
::
unique_±r
<
SgxCl›Á
> 
ş›Á
 = 
ab¦
::
make_unique
<SgxCl›Á>(
Çme
);

256 
ASYLO_ASSIGN_OR_RETURN
(

257 
ş›Á
->
´im™ive_ş›Á_
,

258 
´im™ives
::
LßdEnşave
<´im™ives::
SgxEmbeddedBack’d
>(

259 
Çme
, 
ba£_add»ss
, 
£ùiÚ_Çme_
, 
’şave_size
, 
cÚfig
, 
debug_
,

260 
ab¦
::
make_unique
<
´im™ives
::
Di¥©chTabË
>()));

262 
	gş›Á
->
	g´im™ive_sgx_ş›Á_
 =

263 
¡d
::
¡©ic_poš‹r_ÿ¡
<
´im™ives
::
SgxEnşaveCl›Á
>(

264 
ş›Á
->
´im™ive_ş›Á_
);

266  
	g¡d
::
unique_±r
<
EnşaveCl›Á
>(
¡d
::
move
(
ş›Á
));

269 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
SgxEmbeddedLßd”
::
Cİy
() const {

270 
¡d
::
unique_±r
<
SgxEmbeddedLßd”
> 
lßd”
(
Ãw
 SgxEmbeddedLßd”(*
this
));

271 ià(!
	glßd”
) {

272  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo create self†oader");

274  
	g¡d
::
unique_±r
<
EnşaveLßd”
>(
lßd”
.
»Ëa£
());

277 
Stus
 
	gSgxCl›Á
::
EÁ”AndIn™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

278 
¡d
::
¡ršg
 
buf
;

279 ià(!
	gcÚfig
.
S”ŸlizeToSŒšg
(&
buf
)) {

280  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

284 *
	gouut
 = 
nuÎ±r
;

285 
size_t
 
	gouut_Ën
 = 0;

286 
	g¡d
::
¡ršg
 
’şave_Çme
 = 
g‘_Çme
();

287 
ASYLO_RETURN_IF_ERROR
(

288 
In™Ÿlize
(
’şave_Çme
.
c_¡r
(),ƒnşave_Çme.
size
(è+ 1, 
buf
.
d©a
(),

289 
buf
.
size
(), &
ouut
, &
ouut_Ën
));

293 
StusPrÙo
 
	g¡©us_´Ùo
;

294 ià(!
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
)) {

295  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

298 
Stus
 
	g¡©us
;

299 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

303 
ä“
(
ouut
);

305  
	g¡©us
;

308 
Stus
 
	gSgxCl›Á
::
EÁ”AndRun
(cÚ¡ 
EnşaveIÅut
 &
šput
,

309 
EnşaveOuut
 *
ouut
) {

310 
	g¡d
::
¡ršg
 
buf
;

311 ià(!
	gšput
.
S”ŸlizeToSŒšg
(&
buf
)) {

312  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

316 *
	gouut_buf
 = 
nuÎ±r
;

317 
size_t
 
	gouut_Ën
 = 0;

318 
ASYLO_RETURN_IF_ERROR
(
Run
(
buf
.
d©a
(), buf.
size
(), &
ouut_buf
, &
ouut_Ën
));

322 
EnşaveOuut
 
	gloÿl_ouut
;

323 
	gloÿl_ouut
.
P¬£FromA¼ay
(
ouut_buf
, 
ouut_Ën
);

324 
Stus
 
	g¡©us
;

325 
	g¡©us
.
Re¡ÜeFrom
(
loÿl_ouut
.
¡©us
());

330 
ä“
(
ouut_buf
);

334 ià(
	gouut
) {

335 *
	gouut
 = 
loÿl_ouut
;

338  
	g¡©us
;

341 
Stus
 
	gSgxCl›Á
::
EÁ”AndFš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

342 
¡d
::
¡ršg
 
buf
;

343 ià(!
	gfš®_šput
.
S”ŸlizeToSŒšg
(&
buf
)) {

344  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

348 *
	gouut
 = 
nuÎ±r
;

349 
size_t
 
	gouut_Ën
 = 0;

351 
ASYLO_RETURN_IF_ERROR
(
Fš®ize
(
buf
.
d©a
(), buf.
size
(), &
ouut
, &
ouut_Ën
));

355 
StusPrÙo
 
	g¡©us_´Ùo
;

356 
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
);

357 
Stus
 
	g¡©us
;

358 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

362 
ä“
(
ouut
);

364  
	g¡©us
;

367 
Stus
 
	gSgxCl›Á
::
EÁ”AndDÚ©eTh»ad
() {

368 
´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

369 
Stus
 
	g¡©us
 = 
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

370 
´im™ives
::
kS–eùÜAsyloDÚ©eTh»ad
, &
·¿ms
);

371 ià(!
	g¡©us
.
ok
()) {

372 
LOG
(
ERROR
è<< "EÁ”AndDÚ©eTh»ad faed " << 
	g¡©us
;

374  
	g¡©us
;

377 
Stus
 
	gSgxCl›Á
::
EÁ”AndHªdËSigÇl
(cÚ¡ 
EnşaveSigÇl
 &
sigÇl
) {

378 
EnşaveSigÇl
 
’şave_sigÇl
;

379 
	gbridge_signum
 = 
ToBridgeSigÇl
(
sigÇl
.
signum
());

380 ià(
	gbridge_signum
 < 0) {

381  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

382 
ab¦
::
SŒC©
("FaedØcÚv”ˆsignum (", 
sigÇl
.
signum
(),

385 
	g’şave_sigÇl
.
£t_signum
(
bridge_signum
);

386 
	g¡d
::
¡ršg
 
£rŸlized_’şave_sigÇl
;

387 ià(!
	g’şave_sigÇl
.
S”ŸlizeToSŒšg
(&
£rŸlized_’şave_sigÇl
)) {

388  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

391  
hªdË_sigÇl
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(),

392 
£rŸlized_’şave_sigÇl
.
d©a
(),

393 
£rŸlized_’şave_sigÇl
.
size
());

396 
Stus
 
	gSgxCl›Á
::
EÁ”AndTakeSÇpshÙ
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
) {

397 *
ouut_buf
 = 
nuÎ±r
;

398 
size_t
 
	gouut_Ën
 = 0;

399 
LOG
(
INFO
) << "EnterAndTakeSnapshot!!!!!!!!!!!!!";

400 
ASYLO_RETURN_IF_ERROR
(
ke_¢­shÙ
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(),

401 &
ouut_buf
, &
ouut_Ën
));

405 
EnşaveOuut
 
	gloÿl_ouut
;

406 
	gloÿl_ouut
.
P¬£FromA¼ay
(
ouut_buf
, 
ouut_Ën
);

407 
Stus
 
	g¡©us
;

408 
	g¡©us
.
Re¡ÜeFrom
(
loÿl_ouut
.
¡©us
());

413 
ä“
(
ouut_buf
);

416 ià(
	g¢­shÙ_Ïyout
) {

417 *
	g¢­shÙ_Ïyout
 = 
loÿl_ouut
.
G‘Ex‹nsiÚ
(
¢­shÙ
);

420  
	g¡©us
;

423 
Stus
 
	gSgxCl›Á
::
EÁ”AndRe¡Üe
(cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
) {

424 
¡d
::
¡ršg
 
buf
;

425 ià(!
	g¢­shÙ_Ïyout
.
S”ŸlizeToSŒšg
(&
buf
)) {

426  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

430 *
	gouut
 = 
nuÎ±r
;

431 
size_t
 
	gouut_Ën
 = 0;

433 
ASYLO_RETURN_IF_ERROR
(
»¡Üe
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(),

434 
buf
.
d©a
(), buf.
size
(), &
ouut
, &
ouut_Ën
));

438 
StusPrÙo
 
	g¡©us_´Ùo
;

439 
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
);

440 
Stus
 
	g¡©us
;

441 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

445 
ä“
(
ouut
);

447  
	g¡©us
;

450 
Stus
 
	gSgxCl›Á
::
EÁ”AndT¿nsãrSecu»SÇpshÙKey
(

451 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
) {

452 
¡d
::
¡ršg
 
buf
;

453 ià(!
	gfÜk_hªdshake_cÚfig
.
S”ŸlizeToSŒšg
(&
buf
)) {

454  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

458 *
	gouut
 = 
nuÎ±r
;

459 
size_t
 
	gouut_Ën
 = 0;

461 
ASYLO_RETURN_IF_ERROR
(
Œªsãr_£cu»_¢­shÙ_key
(

462 
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(), 
buf
.
d©a
(), buf.
size
(),

463 &
ouut
, &
ouut_Ën
));

467 
StusPrÙo
 
	g¡©us_´Ùo
;

468 
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
);

469 
Stus
 
	g¡©us
;

470 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

474 
ä“
(
ouut
);

476  
	g¡©us
;

479 
Stus
 
	gSgxCl›Á
::
De¡royEnşave
(è{  
´im™ive_sgx_ş›Á_
->
De¡roy
(); }

481 
boŞ
 
	gSgxCl›Á
::
IsTcsAùive
() {

482  (
sgx_is_tcs_aùive
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
()) != 0);

485 
	gSgxCl›Á
::
S‘ProûssId
() {

486 
sgx_£t_´oûss_id
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
());

	@platform/arch/sgx/untrusted/sgx_client.cc

19 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/sgx_ş›Á.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
	~"ab¦/ty³s/¥ª.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/¬ch/sgx/uÁru¡ed/g’”©ed_bridge_u.h
"

30 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

31 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

32 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

33 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

34 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

35 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

36 
	~"asylo/ut/–f_»ad”.h
"

37 
	~"asylo/ut/fe_m­pšg.h
"

38 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

39 
	~"asylo/ut/¡©us_maüos.h
"

41 
Çme¥aû
 
	gasylo
 {

50 
Stus
 
	gSgxCl›Á
::
In™Ÿlize
(

51 cÚ¡ *
Çme
, 
size_t
 
Çme_Ën
, cÚ¡ *
šput
, size_ˆ
šput_Ën
,

52 **
ouut
, 
size_t
 *
ouut_Ën
) {

53 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

54 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
Çme
, 
Çme_Ën
});

55 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
šput
, 
šput_Ën
});

56 
ASYLO_RETURN_IF_ERROR
(
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

57 
´im™ives
::
kS–eùÜAsyloIn™
, &
·¿ms
));

59 ià(
	g·¿ms
.
em±y
()) {

60  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

63 
	g´im™ives
::
N©iveP¬am‘”Sck
::
Ex‹ÁPŒ
 
ouut_ex‹Á
 = 
·¿ms
.
Pİ
();

64 *
	gouut_Ën
 = 
ouut_ex‹Á
->
size
();

65 *
	gouut
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(*
ouut_Ën
));

66 
memıy
(*
ouut
, 
ouut_ex‹Á
->
As
<>(), *
ouut_Ën
);

67  
	gStus
::
OkStus
();

76 
Stus
 
	gSgxCl›Á
::
Run
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

77 **
ouut
, 
size_t
 *
ouut_Ën
) {

78 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

79 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
šput
, 
šput_Ën
});

80 
ASYLO_RETURN_IF_ERROR
(
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

81 
´im™ives
::
kS–eùÜAsyloRun
, &
·¿ms
));

83 ià(
	g·¿ms
.
em±y
()) {

84  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

87 
	g´im™ives
::
N©iveP¬am‘”Sck
::
Ex‹ÁPŒ
 
ouut_ex‹Á
 = 
·¿ms
.
Pİ
();

88 *
	gouut_Ën
 = 
ouut_ex‹Á
->
size
();

89 *
	gouut
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(*
ouut_Ën
));

90 
memıy
(*
ouut
, 
ouut_ex‹Á
->
As
<>(), *
ouut_Ën
);

91  
	gStus
::
OkStus
();

100 
Stus
 
	gSgxCl›Á
::
Fš®ize
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

101 **
ouut
, 
size_t
 *
ouut_Ën
) {

102 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

103 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
šput
, 
šput_Ën
});

104 
ASYLO_RETURN_IF_ERROR
(
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

105 
´im™ives
::
kS–eùÜAsyloFši
, &
·¿ms
));

106 
LOG
(
INFO
è<< "Fš®izouut_ËÀ" << *
	gouut_Ën
;

108 ià(
	g·¿ms
.
em±y
()) {

109  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

112 
	g´im™ives
::
N©iveP¬am‘”Sck
::
Ex‹ÁPŒ
 
ouut_ex‹Á
 = 
·¿ms
.
Pİ
();

113 *
	gouut_Ën
 = 
ouut_ex‹Á
->
size
();

114 *
	gouut
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(*
ouut_Ën
));

115 
memıy
(*
ouut
, 
ouut_ex‹Á
->
As
<>(), *
ouut_Ën
);

116  
	gStus
::
OkStus
();

121 
Stus
 
hªdË_sigÇl
(
sgx_’şave_id_t
 
eid
, cÚ¡ *
šput
,

122 
size_t
 
šput_Ën
) {

123 
	g»suÉ
;

124 
sgx_¡©us_t
 
	gsgx_¡©us
 = 
eÿÎ_hªdË_sigÇl
(

125 
eid
, &
»suÉ
, 
šput
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
šput_Ën
));

126 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

128  
Stus
(
sgx_¡©us
, "Calloƒcall_handle_signal failed");

129 } ià(
	g»suÉ
) {

130 
	g¡d
::
¡ršg
 
mes§ge
;

131 
	g»suÉ
) {

133 
mes§ge
 = "Invalid or unregistered incoming signal";

136 
mes§ge
 = "Enclave unableo handle signal in current state";

139 
mes§ge
 = "Incoming signal is blocked insideheƒnclave";

142 
mes§ge
 = "Unexpectedƒrror while handling signal";

144  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
mes§ge
);

146  
	gStus
::
OkStus
();

151 
Stus
 
ke_¢­shÙ
(
sgx_’şave_id_t
 
eid
, **
ouut
,

152 
size_t
 *
ouut_Ën
) {

153 
	g»suÉ
;

154 
bridge_size_t
 
	gbridge_ouut_Ën
 = 0;

155 
sgx_¡©us_t
 
	gsgx_¡©us
 =

156 
eÿÎ_ke_¢­shÙ
(
eid
, &
»suÉ
, 
ouut
, &
bridge_ouut_Ën
);

157 ià(
	gouut_Ën
) {

158 *
	gouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

160 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

162  
Stus
(
sgx_¡©us
, "Calloƒcall_take_snapshot failed");

163 } ià(
	g»suÉ
 || *
	gouut_Ën
 == 0) {

167  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

171  
	gStus
::
OkStus
();

176 
Stus
 
»¡Üe
(
sgx_’şave_id_t
 
eid
, cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

177 **
ouut
, 
size_t
 *
ouut_Ën
) {

178 
	g»suÉ
;

179 
bridge_size_t
 
	gbridge_ouut_Ën
 = 0;

180 
sgx_¡©us_t
 
	gsgx_¡©us
 =

181 
eÿÎ_»¡Üe
(
eid
, &
»suÉ
, 
šput
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
šput_Ën
),

182 
ouut
, &
bridge_ouut_Ën
);

183 ià(
	gouut_Ën
) {

184 *
	gouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

186 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

188  
Stus
(
sgx_¡©us
, "Calloƒcall_restore failed");

189 } ià(
	g»suÉ
 || *
	gouut_Ën
 == 0) {

193  
Stus
(
asylo
::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

197  
	gStus
::
OkStus
();

202 
Stus
 
Œªsãr_£cu»_¢­shÙ_key
(
sgx_’şave_id_t
 
eid
,

203 cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

204 **
ouut
, 
size_t
 *
ouut_Ën
) {

205 
	g»suÉ
;

206 
bridge_size_t
 
	gbridge_ouut_Ën
;

207 
sgx_¡©us_t
 
	gsgx_¡©us
 = 
eÿÎ_Œªsãr_£cu»_¢­shÙ_key
(

208 
eid
, &
»suÉ
, 
šput
, 
¡©ic_ÿ¡
<
bridge_size_t
>(
šput_Ën
), 
ouut
,

209 &
bridge_ouut_Ën
);

210 ià(
	gouut_Ën
) {

211 *
	gouut_Ën
 = 
¡©ic_ÿ¡
<
size_t
>(
bridge_ouut_Ën
);

213 ià(
	gsgx_¡©us
 !ğ
SGX_SUCCESS
) {

215  
Stus
(
sgx_¡©us
, "Calloƒcall_do_handshake failed");

216 } ià(
	g»suÉ
 || *
	gouut_Ën
 == 0) {

220  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "No output fromƒnclave");

222  
	gStus
::
OkStus
();

225 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
SgxLßd”
::
LßdEnşave
(

226 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

227 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) const {

228 
	g¡d
::
unique_±r
<
SgxCl›Á
> 
ş›Á
 = 
ab¦
::
make_unique
<SgxCl›Á>(
Çme
);

230 
ASYLO_ASSIGN_OR_RETURN
(

231 
ş›Á
->
´im™ive_ş›Á_
,

232 
´im™ives
::
LßdEnşave
<´im™ives::
SgxBack’d
>(

233 
Çme
, 
ba£_add»ss
, 
’şave_·th_
, 
’şave_size
, 
cÚfig
, 
debug_
,

234 
ab¦
::
make_unique
<
´im™ives
::
Di¥©chTabË
>()));

236 
	gş›Á
->
	g´im™ive_sgx_ş›Á_
 =

237 
¡d
::
¡©ic_poš‹r_ÿ¡
<
´im™ives
::
SgxEnşaveCl›Á
>(

238 
ş›Á
->
´im™ive_ş›Á_
);

240  
	g¡d
::
unique_±r
<
EnşaveCl›Á
>(
¡d
::
move
(
ş›Á
));

243 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
SgxLßd”
::
Cİy
() const {

244 
¡d
::
unique_±r
<
SgxLßd”
> 
lßd”
(
Ãw
 SgxLßd”(*
this
));

245 ià(!
	glßd”
) {

246  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo create self†oader");

248  
	g¡d
::
unique_±r
<
EnşaveLßd”
>(
lßd”
.
»Ëa£
());

251 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
SgxEmbeddedLßd”
::
LßdEnşave
(

252 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

253 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) const {

254 
	g¡d
::
unique_±r
<
SgxCl›Á
> 
ş›Á
 = 
ab¦
::
make_unique
<SgxCl›Á>(
Çme
);

256 
ASYLO_ASSIGN_OR_RETURN
(

257 
ş›Á
->
´im™ive_ş›Á_
,

258 
´im™ives
::
LßdEnşave
<´im™ives::
SgxEmbeddedBack’d
>(

259 
Çme
, 
ba£_add»ss
, 
£ùiÚ_Çme_
, 
’şave_size
, 
cÚfig
, 
debug_
,

260 
ab¦
::
make_unique
<
´im™ives
::
Di¥©chTabË
>()));

262 
	gş›Á
->
	g´im™ive_sgx_ş›Á_
 =

263 
¡d
::
¡©ic_poš‹r_ÿ¡
<
´im™ives
::
SgxEnşaveCl›Á
>(

264 
ş›Á
->
´im™ive_ş›Á_
);

266  
	g¡d
::
unique_±r
<
EnşaveCl›Á
>(
¡d
::
move
(
ş›Á
));

269 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
SgxEmbeddedLßd”
::
Cİy
() const {

270 
¡d
::
unique_±r
<
SgxEmbeddedLßd”
> 
lßd”
(
Ãw
 SgxEmbeddedLßd”(*
this
));

271 ià(!
	glßd”
) {

272  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo create self†oader");

274  
	g¡d
::
unique_±r
<
EnşaveLßd”
>(
lßd”
.
»Ëa£
());

277 
Stus
 
	gSgxCl›Á
::
EÁ”AndIn™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

278 
¡d
::
¡ršg
 
buf
;

279 ià(!
	gcÚfig
.
S”ŸlizeToSŒšg
(&
buf
)) {

280  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

284 *
	gouut
 = 
nuÎ±r
;

285 
size_t
 
	gouut_Ën
 = 0;

286 
	g¡d
::
¡ršg
 
’şave_Çme
 = 
g‘_Çme
();

287 
ASYLO_RETURN_IF_ERROR
(

288 
In™Ÿlize
(
’şave_Çme
.
c_¡r
(),ƒnşave_Çme.
size
(è+ 1, 
buf
.
d©a
(),

289 
buf
.
size
(), &
ouut
, &
ouut_Ën
));

293 
StusPrÙo
 
	g¡©us_´Ùo
;

294 ià(!
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
)) {

295  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

298 
Stus
 
	g¡©us
;

299 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

303 
ä“
(
ouut
);

305  
	g¡©us
;

308 
Stus
 
	gSgxCl›Á
::
EÁ”AndRun
(cÚ¡ 
EnşaveIÅut
 &
šput
,

309 
EnşaveOuut
 *
ouut
) {

310 
	g¡d
::
¡ršg
 
buf
;

311 ià(!
	gšput
.
S”ŸlizeToSŒšg
(&
buf
)) {

312  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

316 *
	gouut_buf
 = 
nuÎ±r
;

317 
size_t
 
	gouut_Ën
 = 0;

318 
ASYLO_RETURN_IF_ERROR
(
Run
(
buf
.
d©a
(), buf.
size
(), &
ouut_buf
, &
ouut_Ën
));

322 
EnşaveOuut
 
	gloÿl_ouut
;

323 
	gloÿl_ouut
.
P¬£FromA¼ay
(
ouut_buf
, 
ouut_Ën
);

324 
Stus
 
	g¡©us
;

325 
	g¡©us
.
Re¡ÜeFrom
(
loÿl_ouut
.
¡©us
());

330 
ä“
(
ouut_buf
);

334 ià(
	gouut
) {

335 *
	gouut
 = 
loÿl_ouut
;

338  
	g¡©us
;

341 
Stus
 
	gSgxCl›Á
::
EÁ”AndFš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

342 
¡d
::
¡ršg
 
buf
;

343 ià(!
	gfš®_šput
.
S”ŸlizeToSŒšg
(&
buf
)) {

344  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

348 *
	gouut
 = 
nuÎ±r
;

349 
size_t
 
	gouut_Ën
 = 0;

351 
ASYLO_RETURN_IF_ERROR
(
Fš®ize
(
buf
.
d©a
(), buf.
size
(), &
ouut
, &
ouut_Ën
));

355 
StusPrÙo
 
	g¡©us_´Ùo
;

356 
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
);

357 
Stus
 
	g¡©us
;

358 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

362 
ä“
(
ouut
);

364  
	g¡©us
;

367 
Stus
 
	gSgxCl›Á
::
EÁ”AndDÚ©eTh»ad
() {

368 
´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

369 
Stus
 
	g¡©us
 = 
´im™ive_sgx_ş›Á_
->
EnşaveC®l
(

370 
´im™ives
::
kS–eùÜAsyloDÚ©eTh»ad
, &
·¿ms
);

371 ià(!
	g¡©us
.
ok
()) {

372 
LOG
(
ERROR
è<< "EÁ”AndDÚ©eTh»ad faed " << 
	g¡©us
;

374  
	g¡©us
;

377 
Stus
 
	gSgxCl›Á
::
EÁ”AndHªdËSigÇl
(cÚ¡ 
EnşaveSigÇl
 &
sigÇl
) {

378 
EnşaveSigÇl
 
’şave_sigÇl
;

379 
	gbridge_signum
 = 
ToBridgeSigÇl
(
sigÇl
.
signum
());

380 ià(
	gbridge_signum
 < 0) {

381  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

382 
ab¦
::
SŒC©
("FaedØcÚv”ˆsignum (", 
sigÇl
.
signum
(),

385 
	g’şave_sigÇl
.
£t_signum
(
bridge_signum
);

386 
	g¡d
::
¡ršg
 
£rŸlized_’şave_sigÇl
;

387 ià(!
	g’şave_sigÇl
.
S”ŸlizeToSŒšg
(&
£rŸlized_’şave_sigÇl
)) {

388  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

391  
hªdË_sigÇl
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(),

392 
£rŸlized_’şave_sigÇl
.
d©a
(),

393 
£rŸlized_’şave_sigÇl
.
size
());

396 
Stus
 
	gSgxCl›Á
::
EÁ”AndTakeSÇpshÙ
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
) {

397 *
ouut_buf
 = 
nuÎ±r
;

398 
size_t
 
	gouut_Ën
 = 0;

399 
LOG
(
INFO
) << "EnterAndTakeSnapshot!!!!!!!!!!!!!";

400 
ASYLO_RETURN_IF_ERROR
(
ke_¢­shÙ
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(),

401 &
ouut_buf
, &
ouut_Ën
));

405 
EnşaveOuut
 
	gloÿl_ouut
;

406 
	gloÿl_ouut
.
P¬£FromA¼ay
(
ouut_buf
, 
ouut_Ën
);

407 
Stus
 
	g¡©us
;

408 
	g¡©us
.
Re¡ÜeFrom
(
loÿl_ouut
.
¡©us
());

413 
ä“
(
ouut_buf
);

416 ià(
	g¢­shÙ_Ïyout
) {

417 *
	g¢­shÙ_Ïyout
 = 
loÿl_ouut
.
G‘Ex‹nsiÚ
(
¢­shÙ
);

420  
	g¡©us
;

423 
Stus
 
	gSgxCl›Á
::
EÁ”AndRe¡Üe
(cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
) {

424 
¡d
::
¡ršg
 
buf
;

425 ià(!
	g¢­shÙ_Ïyout
.
S”ŸlizeToSŒšg
(&
buf
)) {

426  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

430 *
	gouut
 = 
nuÎ±r
;

431 
size_t
 
	gouut_Ën
 = 0;

433 
ASYLO_RETURN_IF_ERROR
(
»¡Üe
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(),

434 
buf
.
d©a
(), buf.
size
(), &
ouut
, &
ouut_Ën
));

438 
StusPrÙo
 
	g¡©us_´Ùo
;

439 
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
);

440 
Stus
 
	g¡©us
;

441 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

445 
ä“
(
ouut
);

447  
	g¡©us
;

450 
Stus
 
	gSgxCl›Á
::
EÁ”AndT¿nsãrSecu»SÇpshÙKey
(

451 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
) {

452 
¡d
::
¡ršg
 
buf
;

453 ià(!
	gfÜk_hªdshake_cÚfig
.
S”ŸlizeToSŒšg
(&
buf
)) {

454  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

458 *
	gouut
 = 
nuÎ±r
;

459 
size_t
 
	gouut_Ën
 = 0;

461 
ASYLO_RETURN_IF_ERROR
(
Œªsãr_£cu»_¢­shÙ_key
(

462 
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
(), 
buf
.
d©a
(), buf.
size
(),

463 &
ouut
, &
ouut_Ën
));

467 
StusPrÙo
 
	g¡©us_´Ùo
;

468 
	g¡©us_´Ùo
.
P¬£FromA¼ay
(
ouut
, 
ouut_Ën
);

469 
Stus
 
	g¡©us
;

470 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

474 
ä“
(
ouut
);

476  
	g¡©us
;

479 
Stus
 
	gSgxCl›Á
::
De¡royEnşave
(è{  
´im™ive_sgx_ş›Á_
->
De¡roy
(); }

481 
boŞ
 
	gSgxCl›Á
::
IsTcsAùive
() {

482  (
sgx_is_tcs_aùive
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
()) != 0);

485 
	gSgxCl›Á
::
S‘ProûssId
() {

486 
sgx_£t_´oûss_id
(
´im™ive_sgx_ş›Á_
->
G‘EnşaveId
());

	@platform/arch/sgx/untrusted/sgx_client.h

19 #iâdeà
ASYLO_PLATFORM_ARCH_SGX_UNTRUSTED_SGX_CLIENT_H_


20 
	#ASYLO_PLATFORM_ARCH_SGX_UNTRUSTED_SGX_CLIENT_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/ba£/maüos.h
"

25 
	~"asylo/’şave.pb.h
"

26 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

27 
	~"asylo/¶©fÜm/cÜe/’şave_ş›Á.h
"

28 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

29 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

32 
	~"šşude/sgx_u¹s.h
"

34 
Çme¥aû
 
	gasylo
 {

37 şas 
	cSgxCl›Á
 : 
public
 
EnşaveCl›Á
 {

38 
public
:

39 
SgxCl›Á
(èğ
d–‘e
;

41 
ex¶ic™
 
SgxCl›Á
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
è: 
EnşaveCl›Á
(name) {}

42 
Stus
 
EÁ”AndRun
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
;

47 
boŞ
 
IsTcsAùive
();

49 *
ba£_add»ss
(è{  
	g´im™ive_sgx_ş›Á_
->
G‘Ba£Add»ss
(); }

51 cÚ¡ *
ba£_add»ss
() const {

52  
	g´im™ive_sgx_ş›Á_
->
G‘Ba£Add»ss
();

55 
size_t
 
size
(è{  
	g´im™ive_sgx_ş›Á_
->
G‘EnşaveSize
(); }

58 
S‘ProûssId
();

61 
	g¡d
::
sh¬ed_±r
<
´im™ives
::
SgxEnşaveCl›Á
> 
G‘Prim™ivesCl›Á
() {

62  
´im™ive_sgx_ş›Á_
;

64 
Stus
 
EÁ”AndTakeSÇpshÙ
(
SÇpshÙLayout
 *
¢­shÙ_Ïyout
);

65 
Stus
 
EÁ”AndRe¡Üe
(cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
);

66 
Stus
 
EÁ”AndT¿nsãrSecu»SÇpshÙKey
(

67 cÚ¡ 
FÜkHªdshakeCÚfig
 &
fÜk_hªdshake_cÚfig
);

69 
	g´iv©e
:

70 
ä›nd
 
şass
 
SgxLßd”
;

71 
ä›nd
 
şass
 
	gSgxEmbeddedLßd”
;

73 
Stus
 
EÁ”AndIn™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
	gov”ride
;

74 
Stus
 
EÁ”AndFš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
è
	gov”ride
;

75 
Stus
 
EÁ”AndDÚ©eTh»ad
(è
	gov”ride
;

76 
Stus
 
EÁ”AndHªdËSigÇl
(cÚ¡ 
EnşaveSigÇl
 &
sigÇl
è
	gov”ride
;

77 
Stus
 
De¡royEnşave
(è
	gov”ride
;

80 
Stus
 
In™Ÿlize
(cÚ¡ *
Çme
, 
size_t
 
Çme_Ën
, cÚ¡ *
šput
,

81 
size_t
 
šput_Ën
, **
ouut
, size_ˆ*
ouut_Ën
);

82 
Stus
 
Run
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

83 
size_t
 *
ouut_Ën
);

84 
Stus
 
Fš®ize
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

85 
size_t
 *
ouut_Ën
);

87 
	g¡d
::
sh¬ed_±r
<
´im™ives
::
SgxEnşaveCl›Á
> 
´im™ive_sgx_ş›Á_
;

92 şas 
	cSgxLßd”
 : 
public
 
EnşaveLßd”
 {

93 
public
:

99 
SgxLßd”
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
boŞ
 
debug
)

100 : 
’şave_·th_
(
·th
), 
debug_
(
debug
) {}

102 
	g´iv©e
:

103 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

104 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

105 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
ècÚ¡ 
	gov”ride
;

107 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
(ècÚ¡ 
ov”ride
;

109 cÚ¡ 
	g¡d
::
¡ršg
 
’şave_·th_
;

110 cÚ¡ 
boŞ
 
	gdebug_
;

115 şas 
	cSgxEmbeddedLßd”
 : 
public
 
EnşaveLßd”
 {

116 
public
:

123 
SgxEmbeddedLßd”
(cÚ¡ 
¡d
::
¡ršg
 &
–f_£ùiÚ_Çme
, 
boŞ
 
debug
)

124 : 
£ùiÚ_Çme_
(
–f_£ùiÚ_Çme
), 
debug_
(
debug
) {}

126 
	g´iv©e
:

127 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

128 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

129 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
ècÚ¡ 
	gov”ride
;

131 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
(ècÚ¡ 
ov”ride
;

133 cÚ¡ 
	g¡d
::
¡ršg
 
£ùiÚ_Çme_
;

134 cÚ¡ 
boŞ
 
	gdebug_
;

138 
usšg
 
SGXCl›Á
 
ABSL_DEPRECATED
("U£ SgxCl›Á in¡—d"èğ
SgxCl›Á
;

141 
usšg
 
SGXLßd”
 
ABSL_DEPRECATED
("U£ SgxLßd” in¡—d"èğ
SgxLßd”
;

148 
usšg
 
	gSimLßd”
 = 
SgxLßd”
;

155 
usšg
 
	gSimEmbeddedLßd”
 = 
SgxEmbeddedLßd”
;

	@platform/arch/sgx_sim/trusted/hardware_random.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/h¬dw¬e_¿ndom.h
"

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<time.h
>

24 
	~<®gÜ™hm
>

30 "C" 
ssize_t
 
	$’c_h¬dw¬e_¿ndom
(
ušt8_t
 *
buf
, 
size_t
 
couÁ
) {

31 
boŞ
 
Úly_Úû
 = 
Œue
;

32 ià(
Úly_Úû
) {

33 
Úly_Úû
 = 
çl£
;

36 
	`¤ªd
(
	`time
(
nuÎ±r
));

39 
¡d
::
	`g’”©e
(&
buf
[0], &buf[
couÁ
], ::
¿nd
);

40  
couÁ
;

41 
	}
}

	@platform/arch/sgx_sim/trusted/hardware_random.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/h¬dw¬e_¿ndom.h
"

21 
	~<¡dio.h
>

22 
	~<¡dlib.h
>

23 
	~<time.h
>

24 
	~<®gÜ™hm
>

30 "C" 
ssize_t
 
	$’c_h¬dw¬e_¿ndom
(
ušt8_t
 *
buf
, 
size_t
 
couÁ
) {

31 
boŞ
 
Úly_Úû
 = 
Œue
;

32 ià(
Úly_Úû
) {

33 
Úly_Úû
 = 
çl£
;

36 
	`¤ªd
(
	`time
(
nuÎ±r
));

39 
¡d
::
	`g’”©e
(&
buf
[0], &buf[
couÁ
], ::
¿nd
);

40  
couÁ
;

41 
	}
}

	@platform/arch/sgx_sim/trusted/register_signal.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/»gi¡”_sigÇl.h
"

21 
	~<sigÇl.h
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

25 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

26 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

28 
Çme¥aû
 
	gasylo
 {

32 
T¿n¦©eAndHªdËSigÇl
(
bridge_signum
,

33 
bridge_sigšfo_t
 *
bridge_sigšfo
,

34 *
ucÚ‹xt
) {

35 
	gsignum
 = 
FromBridgeSigÇl
(
bridge_signum
);

36 ià(
	gsignum
 < 0) {

39 
sigšfo_t
 
	gšfo
;

40 ià(!
FromBridgeSigInfo
(
bridge_sigšfo
, &
šfo
)) {

44 
SigÇlMªag”
 *
	gsigÇl_mªag”
 = SigÇlMªag”::
G‘In¡ªû
();

45 
sig£t_t
 
	gmask
 = 
sigÇl_mªag”
->
G‘SigÇlMask
();

48 ià(
sigismemb”
(&
mask
, 
signum
)) {

51 
Stus
 
	g¡©us
 = 
sigÇl_mªag”
->
HªdËSigÇl
(
signum
, &
šfo
, 
ucÚ‹xt
);

52 ià(!
	g¡©us
.
ok
()) {

53 
LOG
(
ERROR
è<< 
	g¡©us
;

59 "C" 
	$’c_»gi¡”_sigÇl
(
signum
, cÚ¡ 
sig£t_t
 
mask
, 
æags
,

60 cÚ¡ *
’şave_Çme
) {

61  
	`’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

62 
signum
, &
asylo
::
T¿n¦©eAndHªdËSigÇl
, 
mask
, 
æags
, 
’şave_Çme
);

63 
	}
}

	@platform/arch/sgx_sim/trusted/register_signal.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/»gi¡”_sigÇl.h
"

21 
	~<sigÇl.h
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

25 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

26 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

28 
Çme¥aû
 
	gasylo
 {

32 
T¿n¦©eAndHªdËSigÇl
(
bridge_signum
,

33 
bridge_sigšfo_t
 *
bridge_sigšfo
,

34 *
ucÚ‹xt
) {

35 
	gsignum
 = 
FromBridgeSigÇl
(
bridge_signum
);

36 ià(
	gsignum
 < 0) {

39 
sigšfo_t
 
	gšfo
;

40 ià(!
FromBridgeSigInfo
(
bridge_sigšfo
, &
šfo
)) {

44 
SigÇlMªag”
 *
	gsigÇl_mªag”
 = SigÇlMªag”::
G‘In¡ªû
();

45 
sig£t_t
 
	gmask
 = 
sigÇl_mªag”
->
G‘SigÇlMask
();

48 ià(
sigismemb”
(&
mask
, 
signum
)) {

51 
Stus
 
	g¡©us
 = 
sigÇl_mªag”
->
HªdËSigÇl
(
signum
, &
šfo
, 
ucÚ‹xt
);

52 ià(!
	g¡©us
.
ok
()) {

53 
LOG
(
ERROR
è<< 
	g¡©us
;

59 "C" 
	$’c_»gi¡”_sigÇl
(
signum
, cÚ¡ 
sig£t_t
 
mask
, 
æags
,

60 cÚ¡ *
’şave_Çme
) {

61  
	`’c_uÁru¡ed_»gi¡”_sigÇl_hªdËr
(

62 
signum
, &
asylo
::
T¿n¦©eAndHªdËSigÇl
, 
mask
, 
æags
, 
’şave_Çme
);

63 
	}
}

	@platform/common/bridge_functions.cc

19 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

22 #iâdeà
_GNU_SOURCE


23 
	#_GNU_SOURCE


	)

27 #iâdeà
_XOPEN_SOURCE


28 
	#_XOPEN_SOURCE


	)

31 
	~<fú.h
>

32 
	~<Ãtdb.h
>

33 
	~<Ãtš‘/š.h
>

34 
	~<pŞl.h
>

35 
	~<sys/sock‘.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/un.h
>

39 
	~<uni¡d.h
>

40 
	~<utime.h
>

41 
	~<®gÜ™hm
>

42 
	~<csigÇl
>

43 
	~<c¡dšt
>

44 
	~<c¡ršg
>

45 
	~<unÜd”ed_m­
>

47 
	~"asylo/ut/loggšg.h
"

48 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

50 
Çme¥aû
 
	gasylo
 {

51 
	gÇme¥aû
 {

53 
boŞ
 
BridgeWIfEx™ed
(
BridgeWStus
 
bridge_w¡©us
) {

54  
	gbridge_w¡©us
.
	gcode
 == 0;

57 
boŞ
 
BridgeWIfStİ³d
(
BridgeWStus
 
bridge_w¡©us
) {

58  
	gbridge_w¡©us
.
	gcode
 =ğ
BRIDGE_WSTOPPED
;

61 
FromBridgeSysLogLev–
(
bridge_sy¦og_Ëv–
) {

62 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_EMERG
è 
LOG_EMERG
;

63 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_ALERT
è 
LOG_ALERT
;

64 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_CRIT
è 
LOG_CRIT
;

65 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_ERR
è 
LOG_ERR
;

66 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_WARNING
è 
LOG_WARNING
;

67 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_NOTICE
è 
LOG_NOTICE
;

68 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_INFO
è 
LOG_INFO
;

69 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_DEBUG
è 
LOG_DEBUG
;

73 
ToBridgeSysLogLev–
(
sy¦og_Ëv–
) {

74 ià(
	gsy¦og_Ëv–
 =ğ
LOG_EMERG
è 
BRIDGE_LOG_EMERG
;

75 ià(
	gsy¦og_Ëv–
 =ğ
LOG_ALERT
è 
BRIDGE_LOG_ALERT
;

76 ià(
	gsy¦og_Ëv–
 =ğ
LOG_CRIT
è 
BRIDGE_LOG_CRIT
;

77 ià(
	gsy¦og_Ëv–
 =ğ
LOG_ERR
è 
BRIDGE_LOG_ERR
;

78 ià(
	gsy¦og_Ëv–
 =ğ
LOG_WARNING
è 
BRIDGE_LOG_WARNING
;

79 ià(
	gsy¦og_Ëv–
 =ğ
LOG_NOTICE
è 
BRIDGE_LOG_NOTICE
;

80 ià(
	gsy¦og_Ëv–
 =ğ
LOG_INFO
è 
BRIDGE_LOG_INFO
;

81 ià(
	gsy¦og_Ëv–
 =ğ
LOG_DEBUG
è 
BRIDGE_LOG_DEBUG
;

85 
BridgeSigAddS‘
(
bridge_sig£t_t
 *
bridge_£t
, cÚ¡ 
sig
) {

86 *
	gbridge_£t
 |ğ(
UINT64_C
(1è<< 
sig
);

89 
boŞ
 
BridgeSigIsMemb”
(cÚ¡ 
bridge_sig£t_t
 *
bridge_£t
, cÚ¡ 
sig
) {

90  (*
	gbridge_£t
 & (
UINT64_C
(1è<< 
	gsig
)) != 0;

93 
BridgeSigEm±yS‘
(
bridge_sig£t_t
 *
bridge_£t
è{ *
	gbridge_£t
 = 0; }

95 cÚ¡ 
	g¡d
::
unÜd”ed_m­
<, > *
C»©eBridgeSigÇlM­
() {

96 autØ
	gsigÇl_m­
 = 
Ãw
 
¡d
::
unÜd”ed_m­
<, >;

97 
	gsigÇl_m­
->
š£¹
({
SIGHUP
, 
BRIDGE_SIGHUP
});

98 
	gsigÇl_m­
->
š£¹
({
SIGINT
, 
BRIDGE_SIGINT
});

99 
	gsigÇl_m­
->
š£¹
({
SIGQUIT
, 
BRIDGE_SIGQUIT
});

100 
	gsigÇl_m­
->
š£¹
({
SIGILL
, 
BRIDGE_SIGILL
});

101 
	gsigÇl_m­
->
š£¹
({
SIGTRAP
, 
BRIDGE_SIGTRAP
});

102 
	gsigÇl_m­
->
š£¹
({
SIGABRT
, 
BRIDGE_SIGABRT
});

103 
	gsigÇl_m­
->
š£¹
({
SIGBUS
, 
BRIDGE_SIGBUS
});

104 
	gsigÇl_m­
->
š£¹
({
SIGFPE
, 
BRIDGE_SIGFPE
});

105 
	gsigÇl_m­
->
š£¹
({
SIGKILL
, 
BRIDGE_SIGKILL
});

106 
	gsigÇl_m­
->
š£¹
({
SIGUSR1
, 
BRIDGE_SIGUSR1
});

107 
	gsigÇl_m­
->
š£¹
({
SIGSEGV
, 
BRIDGE_SIGSEGV
});

108 
	gsigÇl_m­
->
š£¹
({
SIGUSR2
, 
BRIDGE_SIGUSR2
});

109 
	gsigÇl_m­
->
š£¹
({
SIGPIPE
, 
BRIDGE_SIGPIPE
});

110 
	gsigÇl_m­
->
š£¹
({
SIGALRM
, 
BRIDGE_SIGALRM
});

111 
	gsigÇl_m­
->
š£¹
({
SIGCHLD
, 
BRIDGE_SIGCHLD
});

112 
	gsigÇl_m­
->
š£¹
({
SIGCONT
, 
BRIDGE_SIGCONT
});

113 
	gsigÇl_m­
->
š£¹
({
SIGSTOP
, 
BRIDGE_SIGSTOP
});

114 
	gsigÇl_m­
->
š£¹
({
SIGTSTP
, 
BRIDGE_SIGTSTP
});

115 
	gsigÇl_m­
->
š£¹
({
SIGTTIN
, 
BRIDGE_SIGTTIN
});

116 
	gsigÇl_m­
->
š£¹
({
SIGTTOU
, 
BRIDGE_SIGTTOU
});

117 
	gsigÇl_m­
->
š£¹
({
SIGURG
, 
BRIDGE_SIGURG
});

118 
	gsigÇl_m­
->
š£¹
({
SIGXCPU
, 
BRIDGE_SIGXCPU
});

119 
	gsigÇl_m­
->
š£¹
({
SIGXFSZ
, 
BRIDGE_SIGXFSZ
});

120 
	gsigÇl_m­
->
š£¹
({
SIGVTALRM
, 
BRIDGE_SIGVTALRM
});

121 
	gsigÇl_m­
->
š£¹
({
SIGPROF
, 
BRIDGE_SIGPROF
});

122 
	gsigÇl_m­
->
š£¹
({
SIGWINCH
, 
BRIDGE_SIGWINCH
});

123 
	gsigÇl_m­
->
š£¹
({
SIGSYS
, 
BRIDGE_SIGSYS
});

124 
	gsigÇl_m­
->
š£¹
({
SIGTERM
, 
BRIDGE_SIGTERM
});

125 #ià
defšed
(
SIGRTMIN
è&& defšed(
SIGRTMAX
)

126 
	gsigÇl
 = 
SIGRTMIN
; sigÇÈ<ğ
SIGRTMAX
; ++signal) {

127 
	gsigÇl_m­
->
š£¹
({
sigÇl
, sigÇÈ- 
SIGRTMIN
 + 
BRIDGE_SIGRTMIN
});

130  
	gsigÇl_m­
;

133 cÚ¡ 
	g¡d
::
unÜd”ed_m­
<, > *
G‘SigÇlToBridgeSigÇlM­
() {

134 cÚ¡ 
	g¡d
::
unÜd”ed_m­
<, > *
	gsigÇl_to_bridge_sigÇl_m­
 =

135 
C»©eBridgeSigÇlM­
();

136  
	gsigÇl_to_bridge_sigÇl_m­
;

139 
FromBridgeTıO±iÚName
(
bridge_tı_İtiÚ_Çme
) {

140 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_NODELAY
è 
TCP_NODELAY
;

141 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_KEEPIDLE
è 
TCP_KEEPIDLE
;

142 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_KEEPINTVL
è 
TCP_KEEPINTVL
;

143 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_KEEPCNT
è 
TCP_KEEPCNT
;

147 
FromBridgeIpV6O±iÚName
(
bridge_v6_İtiÚ_Çme
) {

148 ià(
	gbridge_v6_İtiÚ_Çme
 =ğ
BRIDGE_IPV6_V6ONLY
è 
IPV6_V6ONLY
;

152 
ToBridgeIpV6O±iÚName
(
v6_İtiÚ_Çme
) {

153 ià(
	gv6_İtiÚ_Çme
 =ğ
IPV6_V6ONLY
è 
BRIDGE_IPV6_V6ONLY
;

157 
ToBridgeTıO±iÚName
(
tı_İtiÚ_Çme
) {

158 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_NODELAY
è 
BRIDGE_TCP_NODELAY
;

159 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_KEEPIDLE
è 
BRIDGE_TCP_KEEPIDLE
;

160 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_KEEPINTVL
è 
BRIDGE_TCP_KEEPINTVL
;

161 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_KEEPCNT
è 
BRIDGE_TCP_KEEPCNT
;

165 
FromBridgeSock‘O±iÚName
(
bridge_sock‘_İtiÚ_Çme
) {

166 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_DEBUG
è 
SO_DEBUG
;

167 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_REUSEADDR
è 
SO_REUSEADDR
;

168 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_TYPE
è 
SO_TYPE
;

169 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_ERROR
è 
SO_ERROR
;

170 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_DONTROUTE
è 
SO_DONTROUTE
;

171 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_BROADCAST
è 
SO_BROADCAST
;

172 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_SNDBUF
è 
SO_SNDBUF
;

173 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_RCVBUF
è 
SO_RCVBUF
;

174 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_SNDTIMEO
è 
SO_SNDTIMEO
;

175 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_RCVTIMEO
è 
SO_RCVTIMEO
;

176 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_SNDBUFFORCE
è 
SO_SNDBUFFORCE
;

177 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_RCVBUFFORCE
è 
SO_RCVBUFFORCE
;

178 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_KEEPALIVE
è 
SO_KEEPALIVE
;

179 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_OOBINLINE
è 
SO_OOBINLINE
;

180 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_NO_CHECK
è 
SO_NO_CHECK
;

181 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_PRIORITY
è 
SO_PRIORITY
;

182 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_LINGER
è 
SO_LINGER
;

183 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_BSDCOMPAT
è 
SO_BSDCOMPAT
;

184 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_REUSEPORT
è 
SO_REUSEPORT
;

188 
ToBridgeSock‘O±iÚName
(
sock‘_İtiÚ_Çme
) {

189 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_DEBUG
è 
BRIDGE_SO_DEBUG
;

190 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_REUSEADDR
è 
BRIDGE_SO_REUSEADDR
;

191 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_TYPE
è 
BRIDGE_SO_TYPE
;

192 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_ERROR
è 
BRIDGE_SO_ERROR
;

193 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_DONTROUTE
è 
BRIDGE_SO_DONTROUTE
;

194 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_BROADCAST
è 
BRIDGE_SO_BROADCAST
;

195 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_SNDBUF
è 
BRIDGE_SO_SNDBUF
;

196 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_RCVBUF
è 
BRIDGE_SO_RCVBUF
;

197 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_SNDTIMEO
è 
BRIDGE_SO_SNDTIMEO
;

198 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_RCVTIMEO
è 
BRIDGE_SO_RCVTIMEO
;

199 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_SNDBUFFORCE
è 
BRIDGE_SO_SNDBUFFORCE
;

200 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_RCVBUFFORCE
è 
BRIDGE_SO_RCVBUFFORCE
;

201 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_KEEPALIVE
è 
BRIDGE_SO_KEEPALIVE
;

202 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_OOBINLINE
è 
BRIDGE_SO_OOBINLINE
;

203 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_NO_CHECK
è 
BRIDGE_SO_NO_CHECK
;

204 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_PRIORITY
è 
BRIDGE_SO_PRIORITY
;

205 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_LINGER
è 
BRIDGE_SO_LINGER
;

206 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_BSDCOMPAT
è 
BRIDGE_SO_BSDCOMPAT
;

207 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_REUSEPORT
è 
BRIDGE_SO_REUSEPORT
;

211 
ušt8_t
 
BridgeFDIsS‘
(
fd
, cÚ¡ 
BridgeFDS‘
 *
bridge_fds
) {

212 ià(
	gbridge_fds
 && 
	gfd
 < 
	gBRIDGE_FD_SETSIZE
) {

213  
	gbridge_fds
->
	gfe_desütÜ_£t
[
fd
];

218 
BridgeFDS‘
(
fd
, BridgeFDS‘ *
bridge_fds
) {

219 ià(
	gbridge_fds
 && 
	gfd
 < 
	gBRIDGE_FD_SETSIZE
) {

220 
	gbridge_fds
->
	gfe_desütÜ_£t
[
fd
] = 1;

224 
BridgeFDZ”o
(
BridgeFDS‘
 *
bridge_fds
) {

225 ià(
	gbridge_fds
) {

226 
	gfd
 = 0; fd < 
	gBRIDGE_FD_SETSIZE
; ++fd) {

227 
	gbridge_fds
->
	gfe_desütÜ_£t
[
fd
] = 0;

232 
FromBridgePŞlEv’ts
(
ev’ts
) {

233 
	g»suÉ
 = 0;

234 ià(
	gev’ts
 & 
	gPOLLIN
è
	g»suÉ
 |ğ
BRIDGE_POLLIN
;

235 ià(
	gev’ts
 & 
	gPOLLPRI
è
	g»suÉ
 |ğ
BRIDGE_POLLPRI
;

236 ià(
	gev’ts
 & 
	gPOLLOUT
è
	g»suÉ
 |ğ
BRIDGE_POLLOUT
;

237 ià(
	gev’ts
 & 
	gPOLLRDHUP
è
	g»suÉ
 |ğ
BRIDGE_POLLRDHUP
;

238 ià(
	gev’ts
 & 
	gPOLLERR
è
	g»suÉ
 |ğ
BRIDGE_POLLERR
;

239 ià(
	gev’ts
 & 
	gPOLLHUP
è
	g»suÉ
 |ğ
BRIDGE_POLLHUP
;

240 ià(
	gev’ts
 & 
	gPOLLNVAL
è
	g»suÉ
 |ğ
BRIDGE_POLLNVAL
;

241 ià(
	gev’ts
 & 
	gPOLLRDNORM
è
	g»suÉ
 |ğ
BRIDGE_POLLRDNORM
;

242 ià(
	gev’ts
 & 
	gPOLLRDBAND
è
	g»suÉ
 |ğ
BRIDGE_POLLRDBAND
;

243 ià(
	gev’ts
 & 
	gPOLLWRNORM
è
	g»suÉ
 |ğ
BRIDGE_POLLWRNORM
;

244 ià(
	gev’ts
 & 
	gPOLLWRBAND
è
	g»suÉ
 |ğ
BRIDGE_POLLWRBAND
;

245  
	g»suÉ
;

248 
ToBridgePŞlEv’ts
(
bridge_ev’ts
) {

249 
	g»suÉ
 = 0;

250 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLIN
è
	g»suÉ
 |ğ
POLLIN
;

251 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLPRI
è
	g»suÉ
 |ğ
POLLPRI
;

252 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLOUT
è
	g»suÉ
 |ğ
POLLOUT
;

253 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLRDHUP
è
	g»suÉ
 |ğ
POLLRDHUP
;

254 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLERR
è
	g»suÉ
 |ğ
POLLERR
;

255 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLHUP
è
	g»suÉ
 |ğ
POLLHUP
;

256 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLNVAL
è
	g»suÉ
 |ğ
POLLNVAL
;

257 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLRDNORM
è
	g»suÉ
 |ğ
POLLRDNORM
;

258 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLRDBAND
è
	g»suÉ
 |ğ
POLLRDBAND
;

259 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLWRNORM
è
	g»suÉ
 |ğ
POLLWRNORM
;

260 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLWRBAND
è
	g»suÉ
 |ğ
POLLWRBAND
;

261  
	g»suÉ
;

266 
FromBridgeFLockO³¿tiÚ
(
bridge_æock_İ”©iÚ
) {

267 
	gæock_İ”©iÚ
 = 0;

268 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_SH
è
	gæock_İ”©iÚ
 |ğ
LOCK_SH
;

269 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_EX
è
	gæock_İ”©iÚ
 |ğ
LOCK_EX
;

270 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_NB
è
	gæock_İ”©iÚ
 |ğ
LOCK_NB
;

271 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_UN
è
	gæock_İ”©iÚ
 |ğ
LOCK_UN
;

272  
	gæock_İ”©iÚ
;

275 
ToBridgeFLockO³¿tiÚ
(
æock_İ”©iÚ
) {

276 
	gbridge_æock_İ”©iÚ
 = 0;

277 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_SH
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_SH
;

278 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_EX
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_EX
;

279 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_NB
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_NB
;

280 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_UN
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_UN
;

281  
	gbridge_æock_İ”©iÚ
;

284 
FromBridgeSyscÚfCÚ¡ªts
(
SyscÚfCÚ¡ªts
 
bridge_syscÚf_cÚ¡ªt
) {

285 
	gbridge_syscÚf_cÚ¡ªt
) {

286 
	gBRIDGE_SC_NPROCESSORS_CONF
:

287  
_SC_NPROCESSORS_CONF
;

288 
	gBRIDGE_SC_NPROCESSORS_ONLN
:

289  
_SC_NPROCESSORS_ONLN
;

295 
SyscÚfCÚ¡ªts
 
ToBridgeSyscÚfCÚ¡ªts
(
syscÚf_cÚ¡ªt
) {

296 
	gsyscÚf_cÚ¡ªt
) {

297 
	g_SC_NPROCESSORS_CONF
:

298  
BRIDGE_SC_NPROCESSORS_CONF
;

299 
	g_SC_NPROCESSORS_ONLN
:

300  
BRIDGE_SC_NPROCESSORS_ONLN
;

302  
BRIDGE_SC_UNKNOWN
;

306 
FromBridgeTim”Ty³
(
Tim”Ty³
 
bridge_tim”_ty³
) {

307 ià(
	gbridge_tim”_ty³
 =ğ
BRIDGE_ITIMER_REAL
è 
ITIMER_REAL
;

308 ià(
	gbridge_tim”_ty³
 =ğ
BRIDGE_ITIMER_VIRTUAL
è 
ITIMER_VIRTUAL
;

309 ià(
	gbridge_tim”_ty³
 =ğ
BRIDGE_ITIMER_PROF
è 
ITIMER_PROF
;

313 
Tim”Ty³
 
ToBridgeTim”Ty³
(
tim”_ty³
) {

314 ià(
	gtim”_ty³
 =ğ
ITIMER_REAL
è 
BRIDGE_ITIMER_REAL
;

315 ià(
	gtim”_ty³
 =ğ
ITIMER_VIRTUAL
è 
BRIDGE_ITIMER_VIRTUAL
;

316 ià(
	gtim”_ty³
 =ğ
ITIMER_PROF
è 
BRIDGE_ITIMER_PROF
;

317  
	gBRIDGE_ITIMER_UNKNOWN
;

320 
FromBridgeWa™O±iÚs
(
bridge_wa™_İtiÚs
) {

321 
	gwa™_İtiÚs
 = 0;

322 ià(
	gbridge_wa™_İtiÚs
 & 
	gBRIDGE_WNOHANG
è
	gwa™_İtiÚs
 |ğ
WNOHANG
;

323  
	gwa™_İtiÚs
;

326 
ToBridgeWa™O±iÚs
(
wa™_İtiÚs
) {

327 
	gbridge_wa™_İtiÚs
 = 0;

328 ià(
	gwa™_İtiÚs
 & 
	gWNOHANG
è
	gbridge_wa™_İtiÚs
 |ğ
BRIDGE_WNOHANG
;

329  
	gbridge_wa™_İtiÚs
;

332 
FromBridgeRU§geT¬g‘
(
RU§geT¬g‘
 
bridge_ru§ge_rg‘
) {

333 ià(
	gbridge_ru§ge_rg‘
 =ğ
BRIDGE_RUSAGE_SELF
è 
RUSAGE_SELF
;

334 ià(
	gbridge_ru§ge_rg‘
 =ğ
BRIDGE_RUSAGE_CHILDREN
è 
RUSAGE_CHILDREN
;

338 
RU§geT¬g‘
 
ToBridgeRU§geT¬g‘
(
ru§ge_rg‘
) {

339 ià(
	gru§ge_rg‘
 =ğ
RUSAGE_SELF
è 
BRIDGE_RUSAGE_SELF
;

340 ià(
	gru§ge_rg‘
 =ğ
RUSAGE_CHILDREN
è 
BRIDGE_RUSAGE_CHILDREN
;

341  
	gBRIDGE_RUSAGE_UNKNOWN
;

344 
FromBridgeSigÇl
(
bridge_signum
) {

345 autØ
	gsigÇl
 : *
G‘SigÇlToBridgeSigÇlM­
()) {

346 ià(
bridge_signum
 =ğ
sigÇl
.
£cÚd
) {

347  
sigÇl
.
fœ¡
;

353 
ToBridgeSigÇl
(
signum
) {

354 autØ
	g™”©Ü
 = 
G‘SigÇlToBridgeSigÇlM­
()->
fšd
(
signum
);

355 ià(
	g™”©Ü
 =ğ
G‘SigÇlToBridgeSigÇlM­
()->
’d
()) {

358  
	g™”©Ü
->
	g£cÚd
;

361 
FromBridgeSigMaskAùiÚ
(
bridge_how
) {

362 ià(
	gbridge_how
 =ğ
BRIDGE_SIG_BLOCK
è 
SIG_BLOCK
;

363 ià(
	gbridge_how
 =ğ
BRIDGE_SIG_UNBLOCK
è 
SIG_UNBLOCK
;

364 ià(
	gbridge_how
 =ğ
BRIDGE_SIG_SETMASK
è 
SIG_SETMASK
;

368 
ToBridgeSigMaskAùiÚ
(
how
) {

369 ià(
	ghow
 =ğ
SIG_BLOCK
è 
BRIDGE_SIG_BLOCK
;

370 ià(
	ghow
 =ğ
SIG_UNBLOCK
è 
BRIDGE_SIG_UNBLOCK
;

371 ià(
	ghow
 =ğ
SIG_SETMASK
è 
BRIDGE_SIG_SETMASK
;

375 
sig£t_t
 *
FromBridgeSigS‘
(cÚ¡ 
bridge_sig£t_t
 *
bridge_£t
, sig£t_ˆ*
£t
) {

376 ià(!
	gbridge_£t
 || !
	g£t
è 
	gnuÎ±r
;

377 
sigem±y£t
(
£t
);

378 autØ
	gsigÇl
 : *
G‘SigÇlToBridgeSigÇlM­
()) {

379 ià(
BridgeSigIsMemb”
(
bridge_£t
, 
sigÇl
.
£cÚd
)) {

380 
sigadd£t
(
£t
, 
sigÇl
.
fœ¡
);

383  
	g£t
;

386 
bridge_sig£t_t
 *
ToBridgeSigS‘
(cÚ¡ 
sig£t_t
 *
£t
,

387 
bridge_sig£t_t
 *
bridge_£t
) {

388 ià(!
	g£t
 || !
	gbridge_£t
è 
	gnuÎ±r
;

389 
BridgeSigEm±yS‘
(
bridge_£t
);

390 autØ
	gsigÇl
 : *
G‘SigÇlToBridgeSigÇlM­
()) {

391 ià(
sigismemb”
(
£t
, 
sigÇl
.
fœ¡
)) {

392 
BridgeSigAddS‘
(
bridge_£t
, 
sigÇl
.
£cÚd
);

395  
	gbridge_£t
;

398 
FromBridgeSigÇlCode
(
bridge_si_code
) {

399 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_USER
è 
SI_USER
;

400 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_QUEUE
è 
SI_QUEUE
;

401 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_TIMER
è 
SI_TIMER
;

402 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_ASYNCIO
è 
SI_ASYNCIO
;

403 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_MESGQ
è 
SI_MESGQ
;

407 
ToBridgeSigÇlCode
(
si_code
) {

408 ià(
	gsi_code
 =ğ
SI_USER
è 
BRIDGE_SI_USER
;

409 ià(
	gsi_code
 =ğ
SI_QUEUE
è 
BRIDGE_SI_QUEUE
;

410 ià(
	gsi_code
 =ğ
SI_TIMER
è 
BRIDGE_SI_TIMER
;

411 ià(
	gsi_code
 =ğ
SI_ASYNCIO
è 
BRIDGE_SI_ASYNCIO
;

412 ià(
	gsi_code
 =ğ
SI_MESGQ
è 
BRIDGE_SI_MESGQ
;

416 
sigšfo_t
 *
FromBridgeSigInfo
(cÚ¡ 
bridge_sigšfo_t
 *
bridge_sigšfo
,

417 
sigšfo_t
 *
sigšfo
) {

418 ià(!
	gbridge_sigšfo
 || !
	gsigšfo
è 
	gnuÎ±r
;

419 
	gsigšfo
->
	gsi_signo
 = 
FromBridgeSigÇl
(
bridge_sigšfo
->
si_signo
);

420 
	gsigšfo
->
	gsi_code
 = 
FromBridgeSigÇlCode
(
bridge_sigšfo
->
si_code
);

421  
	gsigšfo
;

424 
bridge_sigšfo_t
 *
ToBridgeSigInfo
(

425 cÚ¡ 
sigšfo_t
 *
sigšfo
, 
bridge_sigšfo_t
 *
bridge_sigšfo
) {

426 ià(!
	gsigšfo
 || !
	gbridge_sigšfo
è 
	gnuÎ±r
;

427 
	gbridge_sigšfo
->
	gsi_signo
 = 
ToBridgeSigÇl
(
sigšfo
->
si_signo
);

428 
	gbridge_sigšfo
->
	gsi_code
 = 
ToBridgeSigÇlCode
(
sigšfo
->
si_code
);

429  
	gbridge_sigšfo
;

432 
FromBridgeSigÇlFÏgs
(
bridge_§_æags
) {

433 
	g§_æags
 = 0;

434 ià(
	gbridge_§_æags
 & 
	gBRIDGE_SA_NODEFER
è
	g§_æags
 |ğ
SA_NODEFER
;

435 ià(
	gbridge_§_æags
 & 
	gBRIDGE_SA_RESETHAND
è
	g§_æags
 |ğ
SA_RESETHAND
;

436  
	g§_æags
;

439 
ToBridgeSigÇlFÏgs
(
§_æags
) {

440 
	gbridge_§_æags
 = 0;

441 ià(
	g§_æags
 & 
	gSA_NODEFER
è
	gbridge_§_æags
 |ğ
BRIDGE_SA_NODEFER
;

442 ià(
	g§_æags
 & 
	gSA_RESETHAND
è
	gbridge_§_æags
 |ğ
BRIDGE_SA_RESETHAND
;

443  
	gbridge_§_æags
;

446 
FromBridgeAdd»ssInfoFÏgs
(
bridge_ai_æag
) {

447 
	gai_æag
 = 0;

448 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_CANONNAME
è
	gai_æag
 |ğ
AI_CANONNAME
;

449 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_NUMERICHOST
è
	gai_æag
 |ğ
AI_NUMERICHOST
;

450 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_V4MAPPED
è
	gai_æag
 |ğ
AI_V4MAPPED
;

451 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_ADDRCONFIG
è
	gai_æag
 |ğ
AI_ADDRCONFIG
;

452 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_ALL
è
	gai_æag
 |ğ
AI_ALL
;

453 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_PASSIVE
è
	gai_æag
 |ğ
AI_PASSIVE
;

454 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_NUMERICSERV
è
	gai_æag
 |ğ
AI_NUMERICSERV
;

455 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_IDN
è
	gai_æag
 |ğ
AI_IDN
;

456 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_CANONIDN
è
	gai_æag
 |ğ
AI_CANONIDN
;

457  
	gai_æag
;

460 
ToBridgeAdd»ssInfoFÏgs
(
ai_æag
) {

461 
	gbridge_ai_æag
 = 0;

462 ià(
	gai_æag
 & 
	gAI_CANONNAME
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_CANONNAME
;

463 ià(
	gai_æag
 & 
	gAI_NUMERICHOST
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_NUMERICHOST
;

464 ià(
	gai_æag
 & 
	gAI_V4MAPPED
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_V4MAPPED
;

465 ià(
	gai_æag
 & 
	gAI_ADDRCONFIG
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_ADDRCONFIG
;

466 ià(
	gai_æag
 & 
	gAI_ALL
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_ALL
;

467 ià(
	gai_æag
 & 
	gAI_PASSIVE
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_PASSIVE
;

468 ià(
	gai_æag
 & 
	gAI_NUMERICSERV
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_NUMERICSERV
;

469 ià(
	gai_æag
 & 
	gAI_IDN
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_IDN
;

470 ià(
	gai_æag
 & 
	gAI_CANONIDN
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_CANONIDN
;

471  
	gbridge_ai_æag
;

474 
FromBridgeSysLogO±iÚ
(
bridge_sy¦og_İtiÚ
) {

475 
	gsy¦og_İtiÚ
 = 0;

476 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_PID
è
	gsy¦og_İtiÚ
 |ğ
LOG_PID
;

477 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_CONS
è
	gsy¦og_İtiÚ
 |ğ
LOG_CONS
;

478 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_ODELAY
è
	gsy¦og_İtiÚ
 |ğ
LOG_ODELAY
;

479 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_NDELAY
è
	gsy¦og_İtiÚ
 |ğ
LOG_NDELAY
;

480 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_NOWAIT
è
	gsy¦og_İtiÚ
 |ğ
LOG_NOWAIT
;

481 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_PERROR
è
	gsy¦og_İtiÚ
 |ğ
LOG_PERROR
;

482  
	gsy¦og_İtiÚ
;

485 
ToBridgeSysLogO±iÚ
(
sy¦og_İtiÚ
) {

486 
	gbridge_sy¦og_İtiÚ
 = 0;

487 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_PID
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_PID
;

488 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_CONS
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_CONS
;

489 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_ODELAY
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_ODELAY
;

490 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_NDELAY
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_NDELAY
;

491 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_NOWAIT
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_NOWAIT
;

492 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_PERROR
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_PERROR
;

493  
	gbridge_sy¦og_İtiÚ
;

496 
FromBridgeSysLogFac™y
(
bridge_sy¦og_çc™y
) {

497 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_USER
è 
LOG_USER
;

498 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL0
è 
LOG_LOCAL0
;

499 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL1
è 
LOG_LOCAL1
;

500 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL2
è 
LOG_LOCAL2
;

501 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL3
è 
LOG_LOCAL3
;

502 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL4
è 
LOG_LOCAL4
;

503 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL5
è 
LOG_LOCAL5
;

504 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL6
è 
LOG_LOCAL6
;

505 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL7
è 
LOG_LOCAL7
;

509 
ToBridgeSysLogFac™y
(
sy¦og_çc™y
) {

510 ià(
	gsy¦og_çc™y
 =ğ
LOG_USER
è 
BRIDGE_LOG_USER
;

511 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL0
è 
BRIDGE_LOG_LOCAL0
;

512 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL1
è 
BRIDGE_LOG_LOCAL1
;

513 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL2
è 
BRIDGE_LOG_LOCAL2
;

514 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL3
è 
BRIDGE_LOG_LOCAL3
;

515 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL4
è 
BRIDGE_LOG_LOCAL4
;

516 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL5
è 
BRIDGE_LOG_LOCAL5
;

517 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL6
è 
BRIDGE_LOG_LOCAL6
;

518 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL7
è 
BRIDGE_LOG_LOCAL7
;

524 
FromBridgeSysLogPriÜ™y
(
bridge_sy¦og_´iÜ™y
) {

525 
	gbridge_sy¦og_Ëv–
 = 
bridge_sy¦og_´iÜ™y
 & 0x07;

526 
	gbridge_sy¦og_çc™y
 = 
bridge_sy¦og_´iÜ™y
 & ~0x07;

527  
FromBridgeSysLogLev–
(
bridge_sy¦og_Ëv–
) |

528 
FromBridgeSysLogFac™y
(
bridge_sy¦og_çc™y
);

531 
ToBridgeSysLogPriÜ™y
(
sy¦og_´iÜ™y
) {

532 
	gsy¦og_Ëv–
 = 
sy¦og_´iÜ™y
 & 0x07;

533 
	gsy¦og_çc™y
 = 
sy¦og_´iÜ™y
 & ~0x07;

534  
ToBridgeSysLogLev–
(
sy¦og_Ëv–
) |

535 
ToBridgeSysLogFac™y
(
sy¦og_çc™y
);

538 
FromBridgeFúCmd
(
bridge_fú_cmd
) {

539 
	gbridge_fú_cmd
) {

540 
	gBRIDGE_F_GETFD
:

541  
F_GETFD
;

542 
	gBRIDGE_F_SETFD
:

543  
F_SETFD
;

544 
	gBRIDGE_F_GETFL
:

545  
F_GETFL
;

546 
	gBRIDGE_F_SETFL
:

547  
F_SETFL
;

548 
	gBRIDGE_F_GETPIPE_SZ
:

549  
F_GETPIPE_SZ
;

550 
	gBRIDGE_F_SETPIPE_SZ
:

551  
F_SETPIPE_SZ
;

557 
ToBridgeFúCmd
(
fú_cmd
) {

558 
	gfú_cmd
) {

559 
	gF_GETFD
:

560  
BRIDGE_F_GETFD
;

561 
	gF_SETFD
:

562  
BRIDGE_F_SETFD
;

563 
	gF_GETFL
:

564  
BRIDGE_F_GETFL
;

565 
	gF_SETFL
:

566  
BRIDGE_F_SETFL
;

567 
	gF_GETPIPE_SZ
:

568  
BRIDGE_F_GETPIPE_SZ
;

569 
	gF_SETPIPE_SZ
:

570  
BRIDGE_F_SETPIPE_SZ
;

576 
FromBridgeFeFÏgs
(
bridge_fe_æag
) {

577 
	gfe_æag
 = 0;

578 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_RDONLY
è
	gfe_æag
 |ğ
O_RDONLY
;

579 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_WRONLY
è
	gfe_æag
 |ğ
O_WRONLY
;

580 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_RDWR
è
	gfe_æag
 |ğ
O_RDWR
;

581 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_CREAT
è
	gfe_æag
 |ğ
O_CREAT
;

582 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_APPEND
è
	gfe_æag
 |ğ
O_APPEND
;

583 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_EXCL
è
	gfe_æag
 |ğ
O_EXCL
;

584 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_TRUNC
è
	gfe_æag
 |ğ
O_TRUNC
;

585 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_NONBLOCK
è
	gfe_æag
 |ğ
O_NONBLOCK
;

586 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_DIRECT
è
	gfe_æag
 |ğ
O_DIRECT
;

587 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_O_CLOEXEC
è
	gfe_æag
 |ğ
O_CLOEXEC
;

588  
	gfe_æag
;

591 
ToBridgeFeFÏgs
(
fe_æag
) {

592 
	gbridge_fe_æag
 = 0;

593 ià(
	gfe_æag
 & 
	gO_RDONLY
è
	gbridge_fe_æag
 |ğ
BRIDGE_RDONLY
;

594 ià(
	gfe_æag
 & 
	gO_WRONLY
è
	gbridge_fe_æag
 |ğ
BRIDGE_WRONLY
;

595 ià(
	gfe_æag
 & 
	gO_RDWR
è
	gbridge_fe_æag
 |ğ
BRIDGE_RDWR
;

596 ià(
	gfe_æag
 & 
	gO_CREAT
è
	gbridge_fe_æag
 |ğ
BRIDGE_CREAT
;

597 ià(
	gfe_æag
 & 
	gO_APPEND
è
	gbridge_fe_æag
 |ğ
BRIDGE_APPEND
;

598 ià(
	gfe_æag
 & 
	gO_EXCL
è
	gbridge_fe_æag
 |ğ
BRIDGE_EXCL
;

599 ià(
	gfe_æag
 & 
	gO_TRUNC
è
	gbridge_fe_æag
 |ğ
BRIDGE_TRUNC
;

600 ià(
	gfe_æag
 & 
	gO_NONBLOCK
è
	gbridge_fe_æag
 |ğ
BRIDGE_NONBLOCK
;

601 ià(
	gfe_æag
 & 
	gO_DIRECT
è
	gbridge_fe_æag
 |ğ
BRIDGE_DIRECT
;

602 ià(
	gfe_æag
 & 
	gO_CLOEXEC
è
	gbridge_fe_æag
 |ğ
BRIDGE_O_CLOEXEC
;

603  
	gbridge_fe_æag
;

606 
FromBridgeFDFÏgs
(
bridge_fd_æag
) {

607 
	gfd_æag
 = 0;

608 ià(
	gbridge_fd_æag
 & 
	gBRIDGE_CLOEXEC
è
	gfd_æag
 |ğ
FD_CLOEXEC
;

609  
	gfd_æag
;

612 
ToBridgeFDFÏgs
(
fd_æag
) {

613 
	gbridge_fd_æag
 = 0;

614 ià(
	gfd_æag
 & 
	gFD_CLOEXEC
è
	gbridge_fd_æag
 |ğ
BRIDGE_CLOEXEC
;

615  
	gbridge_fd_æag
;

618 
FromBridgeO±iÚName
(
Ëv–
, 
bridge_İtiÚ_Çme
) {

619 ià(
	gËv–
 =ğ
IPPROTO_TCP
) {

620  
FromBridgeTıO±iÚName
(
bridge_İtiÚ_Çme
);

622 ià(
	gËv–
 =ğ
IPPROTO_IPV6
) {

623  
FromBridgeIpV6O±iÚName
(
bridge_İtiÚ_Çme
);

625 ià(
	gËv–
 =ğ
SOL_SOCKET
) {

626  
FromBridgeSock‘O±iÚName
(
bridge_İtiÚ_Çme
);

631 
ToBridgeO±iÚName
(
Ëv–
, 
İtiÚ_Çme
) {

632 ià(
	gËv–
 =ğ
IPPROTO_TCP
) {

633  
ToBridgeTıO±iÚName
(
İtiÚ_Çme
);

635 ià(
	gËv–
 =ğ
IPPROTO_IPV6
) {

636  
ToBridgeIpV6O±iÚName
(
İtiÚ_Çme
);

638 ià(
	gËv–
 =ğ
SOL_SOCKET
) {

639  
ToBridgeSock‘O±iÚName
(
İtiÚ_Çme
);

644 
¡©
 *
FromBridgeSt
(cÚ¡ 
bridge_¡©
 *
bridge_¡©buf
,

645 
¡©
 *
¡©buf
) {

646 ià(!
	gbridge_¡©buf
 || !
	g¡©buf
è 
	gnuÎ±r
;

647 
	g¡©buf
->
	g¡_dev
 = 
bridge_¡©buf
->
¡_dev
;

648 
	g¡©buf
->
	g¡_šo
 = 
bridge_¡©buf
->
¡_šo
;

649 
	g¡©buf
->
	g¡_mode
 = 
bridge_¡©buf
->
¡_mode
;

650 
	g¡©buf
->
	g¡_Æšk
 = 
bridge_¡©buf
->
¡_Æšk
;

651 
	g¡©buf
->
	g¡_uid
 = 
bridge_¡©buf
->
¡_uid
;

652 
	g¡©buf
->
	g¡_gid
 = 
bridge_¡©buf
->
¡_gid
;

653 
	g¡©buf
->
	g¡_rdev
 = 
bridge_¡©buf
->
¡_rdev
;

654 
	g¡©buf
->
	g¡_size
 = 
bridge_¡©buf
->
¡_size
;

655 
	g¡©buf
->
	g¡_©ime
 = 
bridge_¡©buf
->
¡_©ime_’c
;

656 
	g¡©buf
->
	g¡_mtime
 = 
bridge_¡©buf
->
¡_mtime_’c
;

657 
	g¡©buf
->
	g¡_ùime
 = 
bridge_¡©buf
->
¡_ùime_’c
;

658 
	g¡©buf
->
	g¡_blksize
 = 
bridge_¡©buf
->
¡_blksize
;

659 
	g¡©buf
->
	g¡_blocks
 = 
bridge_¡©buf
->
¡_blocks
;

660  
	g¡©buf
;

663 
bridge_¡©
 *
ToBridgeSt
(cÚ¡ 
¡©
 *
¡©buf
,

664 
bridge_¡©
 *
bridge_¡©buf
) {

665 ià(!
	g¡©buf
 || !
	gbridge_¡©buf
è 
	gnuÎ±r
;

666 
	gbridge_¡©buf
->
	g¡_dev
 = 
¡©buf
->
¡_dev
;

667 
	gbridge_¡©buf
->
	g¡_šo
 = 
¡©buf
->
¡_šo
;

668 
	gbridge_¡©buf
->
	g¡_mode
 = 
¡©buf
->
¡_mode
;

669 
	gbridge_¡©buf
->
	g¡_Æšk
 = 
¡©buf
->
¡_Æšk
;

670 
	gbridge_¡©buf
->
	g¡_uid
 = 
¡©buf
->
¡_uid
;

671 
	gbridge_¡©buf
->
	g¡_gid
 = 
¡©buf
->
¡_gid
;

672 
	gbridge_¡©buf
->
	g¡_rdev
 = 
¡©buf
->
¡_rdev
;

673 
	gbridge_¡©buf
->
	g¡_size
 = 
¡©buf
->
¡_size
;

674 
	gbridge_¡©buf
->
	g¡_©ime_’c
 = 
¡©buf
->
¡_©ime
;

675 
	gbridge_¡©buf
->
	g¡_mtime_’c
 = 
¡©buf
->
¡_mtime
;

676 
	gbridge_¡©buf
->
	g¡_ùime_’c
 = 
¡©buf
->
¡_ùime
;

677 
	gbridge_¡©buf
->
	g¡_blksize
 = 
¡©buf
->
¡_blksize
;

678 
	gbridge_¡©buf
->
	g¡_blocks
 = 
¡©buf
->
¡_blocks
;

679  
	gbridge_¡©buf
;

682 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

683 
Reš‹½»tCİySšgË
(
T
 *
d¡
, cÚ¡ 
U
 *
¤c
) {

684 
memıy
(
d¡
, 
¤c
, 
¡d
::
mš
((
T
), (
U
)));

687 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gM
,y³Çm
	gU
, size_ˆ
	gN
>

688 
Reš‹½»tCİyA¼ay
(
T
 (&
d¡
)[
M
], cÚ¡ 
U
 (&
¤c
)[
N
],

689 
size_t
 
max_Ën
 = 
SIZE_MAX
) {

690 
memıy
(
d¡
, 
¤c
, 
¡d
::
mš
(
max_Ën
, std::mš((
T
è* 
M
, (
U
è* 
N
)));

693 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

694 
In™ŸlizeToZ”oSšgË
(
T
 *
±r
) {

695 
mem£t
(
±r
, 0, (
T
));

698 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gM
>

699 
In™ŸlizeToZ”oA¼ay
(
T
 (&
±r
)[
M
]) {

700 
mem£t
(
±r
, 0, (
T
è* 
M
);

711 
sockaddr
 *
CİySockaddr
(*
sourû
, 
sockËn_t
 
sourû_Ën
,

712 
sockaddr
 *
addr_de¡
,

713 
sockËn_t
 *
add¾’_de¡
) {

714 
memıy
(
addr_de¡
, 
sourû
, 
¡d
::
mš
(*
add¾’_de¡
, 
sourû_Ën
));

715 *
	gadd¾’_de¡
 = 
sourû_Ën
;

716  
	gaddr_de¡
;

719 
sockaddr
 *
FromBridgeSockaddr
(cÚ¡ 
bridge_sockaddr
 *
bridge_addr
,

720 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

721 ià(
	gbridge_addr
 =ğ
nuÎ±r
 || 
addr
 =ğnuÎ±¸|| 
add¾’
 ==‚ullptr) {

722  
nuÎ±r
;

724 
§_çmy_t
 
	gçmy
 = 
FromBridgeAfFamy
(
bridge_addr
->
§_çmy
);

725 ià(
	gçmy
 =ğ
AF_UNIX
 || 
çmy
 =ğ
AF_LOCAL
) {

726 
sockaddr_un
 
sockaddr_un_out
;

727 
	gsockaddr_un_out
.
	gsun_çmy
 = 
çmy
;

728 
In™ŸlizeToZ”oA¼ay
(
sockaddr_un_out
.
sun_·th
);

729 
Reš‹½»tCİyA¼ay
(
sockaddr_un_out
.
sun_·th
,

730 
bridge_addr
->
addr_un
.
sun_·th
,

731 
bridge_addr
->
addr_un
.
Ën
 - (
çmy
));

732  
CİySockaddr
(&
sockaddr_un_out
, 
bridge_addr
->
addr_un
.
Ën
, 
addr
,

733 
add¾’
);

734 } ià(
	gçmy
 =ğ
AF_INET6
) {

735 
sockaddr_š6
 
sockaddr_š6_out
;

736 
	gsockaddr_š6_out
.
	gsš6_çmy
 = 
çmy
;

737 
	gsockaddr_š6_out
.
	gsš6_pÜt
 = 
bridge_addr
->
addr_š6
.
sš6_pÜt
;

738 
	gsockaddr_š6_out
.
	gsš6_æowšfo
 = 
bridge_addr
->
addr_š6
.
sš6_æowšfo
;

739 
In™ŸlizeToZ”oSšgË
(&
sockaddr_š6_out
.
sš6_addr
);

740 
Reš‹½»tCİySšgË
(&
sockaddr_š6_out
.
sš6_addr
,

741 &
bridge_addr
->
addr_š6
.
sš6_addr
);

742 
	gsockaddr_š6_out
.
	gsš6_scİe_id
 = 
bridge_addr
->
addr_š6
.
sš6_scİe_id
;

743  
CİySockaddr
(&
sockaddr_š6_out
, (sockaddr_š6_out), 
addr
,

744 
add¾’
);

745 } ià(
	gçmy
 =ğ
AF_INET
) {

746 
sockaddr_š
 
sockaddr_š_out
;

747 
	gsockaddr_š_out
.
	gsš_çmy
 = 
çmy
;

748 
	gsockaddr_š_out
.
	gsš_pÜt
 = 
bridge_addr
->
addr_š
.
sš_pÜt
;

749 
In™ŸlizeToZ”oSšgË
(&
sockaddr_š_out
.
sš_addr
);

750 
Reš‹½»tCİySšgË
(&
sockaddr_š_out
.
sš_addr
,

751 &
bridge_addr
->
addr_š
.
sš_addr
);

752 
In™ŸlizeToZ”oA¼ay
(
sockaddr_š_out
.
sš_z”o
);

753 
Reš‹½»tCİyA¼ay
(
sockaddr_š_out
.
sš_z”o
,

754 
bridge_addr
->
addr_š
.
sš_z”o
);

755  
CİySockaddr
(&
sockaddr_š_out
, (sockaddr_š_out), 
addr
,

756 
add¾’
);

757 } ià(
	gçmy
 =ğ
AF_UNSPEC
) {

758 
sockaddr
 
sockaddr_out
;

759 
	gsockaddr_out
.
	g§_çmy
 = 
çmy
;

760  
CİySockaddr
(&
sockaddr_out
, (sockaddr_out), 
addr
, 
add¾’
);

762 
LOG
(
ERROR
è<< "sockadd¸çmy i nÙ suµÜ‹d: " << 
	gçmy
;

763 
abÜt
();

767 
bridge_sockaddr
 *
ToBridgeSockaddr
(cÚ¡ 
sockaddr
 *
addr
,

768 
sockËn_t
 
add¾’
,

769 
bridge_sockaddr
 *
bridge_addr
) {

770 ià(!
	gaddr
 || !
	gbridge_addr
è 
	gnuÎ±r
;

771 
	gbridge_addr
->
	g§_çmy
 = 
ToBridgeAfFamy
(
addr
->
§_çmy
);

772 ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_UNSUPPORTED
) {

773  
nuÎ±r
;

775 ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_UNIX
 ||

776 
bridge_addr
->
§_çmy
 =ğ
BRIDGE_AF_LOCAL
) {

777 
sockaddr_un
 *
sockaddr_un_š
 = 
cÚ¡_ÿ¡
<sockaddr_un *>(

778 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_un
 *>(
addr
));

779 
In™ŸlizeToZ”oA¼ay
(
bridge_addr
->
addr_un
.
sun_·th
);

780 ià(
	gadd¾’
 <ğ(
bridge_addr
->
§_çmy
)) {

781  
nuÎ±r
;

783 
Reš‹½»tCİyA¼ay
(
bridge_addr
->
addr_un
.
sun_·th
,

784 
sockaddr_un_š
->
sun_·th
,

785 
add¾’
 - (
bridge_addr
->
§_çmy
));

786 
	gbridge_addr
->
	gaddr_un
.
	gËn
 = 
add¾’
;

787 } ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_INET6
) {

788 ià(
add¾’
 < (
sockaddr_š6
)) {

789  
nuÎ±r
;

791 
sockaddr_š6
 *
	gsockaddr_š6_š
 = 
cÚ¡_ÿ¡
<sockaddr_in6 *>(

792 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
addr
));

793 
	gbridge_addr
->
	gaddr_š6
.
	gsš6_pÜt
 = 
sockaddr_š6_š
->
sš6_pÜt
;

794 
	gbridge_addr
->
	gaddr_š6
.
	gsš6_æowšfo
 = 
sockaddr_š6_š
->
sš6_æowšfo
;

795 
In™ŸlizeToZ”oSšgË
(&
bridge_addr
->
addr_š6
.
sš6_addr
);

796 
Reš‹½»tCİySšgË
(&
bridge_addr
->
addr_š6
.
sš6_addr
,

797 &
sockaddr_š6_š
->
sš6_addr
);

798 
	gbridge_addr
->
	gaddr_š6
.
	gsš6_scİe_id
 = 
sockaddr_š6_š
->
sš6_scİe_id
;

799 } ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_INET
) {

800 ià(
add¾’
 < (
sockaddr_š
)) {

801  
nuÎ±r
;

803 
sockaddr_š
 *
	gsockaddr_š_š
 = 
cÚ¡_ÿ¡
<sockaddr_in *>(

804 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
addr
));

805 
	gbridge_addr
->
	gaddr_š
.
	gsš_pÜt
 = 
sockaddr_š_š
->
sš_pÜt
;

806 
In™ŸlizeToZ”oSšgË
(&
bridge_addr
->
addr_š
.
sš_addr
);

807 
Reš‹½»tCİySšgË
(&
bridge_addr
->
addr_š
.
sš_addr
,

808 &
sockaddr_š_š
->
sš_addr
);

809 
In™ŸlizeToZ”oA¼ay
(
bridge_addr
->
addr_š
.
sš_z”o
);

810 
Reš‹½»tCİyA¼ay
(
bridge_addr
->
addr_š
.
sš_z”o
,

811 
sockaddr_š_š
->
sš_z”o
);

812 } ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_UNSPEC
) {

815 
LOG
(
ERROR
) << "sockaddr family is‚ot supported: "

816 << 
bridge_addr
->
§_çmy
;

817 
abÜt
();

819  
	gbridge_addr
;

822 
FromBridgeAdd»ssInfoE¼Üs
(
bridge_—i_code
) {

823 
	gbridge_—i_code
) {

824 
	gBRIDGE_EAI_SUCCESS
:

826 
	gBRIDGE_EAI_ADDRFAMILY
:

827  
EAI_ADDRFAMILY
;

828 
	gBRIDGE_EAI_BADFLAGS
:

829  
EAI_BADFLAGS
;

830 
	gBRIDGE_EAI_NONAME
:

831  
EAI_NONAME
;

832 
	gBRIDGE_EAI_AGAIN
:

833  
EAI_AGAIN
;

834 
	gBRIDGE_EAI_FAIL
:

835  
EAI_FAIL
;

836 
	gBRIDGE_EAI_FAMILY
:

837  
EAI_FAMILY
;

838 
	gBRIDGE_EAI_MEMORY
:

839  
EAI_MEMORY
;

840 
	gBRIDGE_EAI_NODATA
:

841  
EAI_NODATA
;

842 
	gBRIDGE_EAI_SERVICE
:

843  
EAI_SERVICE
;

844 
	gBRIDGE_EAI_SOCKTYPE
:

845  
EAI_SOCKTYPE
;

846 
	gBRIDGE_EAI_OVERFLOW
:

847  
EAI_OVERFLOW
;

848 
	gBRIDGE_EAI_INPROGRESS
:

849  
EAI_INPROGRESS
;

850 
	gBRIDGE_EAI_CANCELED
:

851  
EAI_CANCELED
;

852 
	gBRIDGE_EAI_ALLDONE
:

853  
EAI_ALLDONE
;

854 
	gBRIDGE_EAI_SYSTEM
:

855  
EAI_SYSTEM
;

861 
ToBridgeAdd»ssInfoE¼Üs
(
—i_code
) {

862 
	g—i_code
) {

864  
BRIDGE_EAI_SUCCESS
;

865 
	gEAI_BADFLAGS
:

866  
BRIDGE_EAI_BADFLAGS
;

867 
	gEAI_NONAME
:

868  
BRIDGE_EAI_NONAME
;

869 
	gEAI_AGAIN
:

870  
BRIDGE_EAI_AGAIN
;

871 
	gEAI_FAIL
:

872  
BRIDGE_EAI_FAIL
;

873 
	gEAI_FAMILY
:

874  
BRIDGE_EAI_FAMILY
;

875 
	gEAI_SOCKTYPE
:

876  
BRIDGE_EAI_SOCKTYPE
;

877 
	gEAI_SERVICE
:

878  
BRIDGE_EAI_SERVICE
;

879 
	gEAI_MEMORY
:

880  
BRIDGE_EAI_MEMORY
;

881 
	gEAI_SYSTEM
:

882  
BRIDGE_EAI_SYSTEM
;

883 
	gEAI_OVERFLOW
:

884  
BRIDGE_EAI_OVERFLOW
;

885 
	gEAI_NODATA
:

886  
BRIDGE_EAI_NODATA
;

887 
	gEAI_ADDRFAMILY
:

888  
BRIDGE_EAI_ADDRFAMILY
;

889 
	gEAI_INPROGRESS
:

890  
BRIDGE_EAI_INPROGRESS
;

891 
	gEAI_CANCELED
:

892  
BRIDGE_EAI_CANCELED
;

893 
	gEAI_ALLDONE
:

894  
BRIDGE_EAI_ALLDONE
;

895 
	gEAI_INTR
:

896  
BRIDGE_EAI_IDN_ENCODE
;

898  
BRIDGE_EAI_UNKNOWN
;

902 
AfFamy
 
ToBridgeAfFamy
(
af_çmy
) {

905 ià(
	gaf_çmy
 =ğ
AF_UNIX
è 
BRIDGE_AF_UNIX
;

906 ià(
	gaf_çmy
 =ğ
AF_LOCAL
è 
BRIDGE_AF_LOCAL
;

907 
	gaf_çmy
) {

908 
	gAF_INET
:

909  
BRIDGE_AF_INET
;

910 
	gAF_INET6
:

911  
BRIDGE_AF_INET6
;

912 
	gAF_UNSPEC
:

913  
BRIDGE_AF_UNSPEC
;

914 
	gAF_IPX
:

915  
BRIDGE_AF_IPX
;

916 
	gAF_NETLINK
:

917  
BRIDGE_AF_NETLINK
;

918 
	gAF_X25
:

919  
BRIDGE_AF_X25
;

920 
	gAF_AX25
:

921  
BRIDGE_AF_AX25
;

922 
	gAF_ATMPVC
:

923  
BRIDGE_AF_ATMPVC
;

924 
	gAF_APPLETALK
:

925  
BRIDGE_AF_APPLETALK
;

926 
	gAF_PACKET
:

927  
BRIDGE_AF_PACKET
;

928 
	gAF_ALG
:

929  
BRIDGE_AF_ALG
;

931 
LOG
(
ERROR
è<< "UnsuµÜ‹d‡dd»s çmy: " << 
af_çmy
;

932  
	gBRIDGE_AF_UNSUPPORTED
;

936 
FromBridgeAfFamy
(
bridge_af_çmy
) {

937 
	gbridge_af_çmy
) {

938 
	gBRIDGE_AF_INET
:

939  
AF_INET
;

940 
	gBRIDGE_AF_INET6
:

941  
AF_INET6
;

942 
	gBRIDGE_AF_UNSPEC
:

943  
AF_UNSPEC
;

944 
	gBRIDGE_AF_UNIX
:

945  
AF_UNIX
;

946 
	gBRIDGE_AF_LOCAL
:

947  
AF_LOCAL
;

948 
	gBRIDGE_AF_IPX
:

949  
AF_IPX
;

950 
	gBRIDGE_AF_NETLINK
:

951  
AF_NETLINK
;

952 
	gBRIDGE_AF_X25
:

953  
AF_X25
;

954 
	gBRIDGE_AF_AX25
:

955  
AF_AX25
;

956 
	gBRIDGE_AF_ATMPVC
:

957  
AF_ATMPVC
;

958 
	gBRIDGE_AF_APPLETALK
:

959  
AF_APPLETALK
;

960 
	gBRIDGE_AF_PACKET
:

961  
AF_PACKET
;

962 
	gBRIDGE_AF_ALG
:

963  
AF_ALG
;

965  
AF_UNSPEC
;

969 
FromBridgeSock‘Ty³
(
bridge_sock_ty³
) {

970 
	gsock_ty³
 = 0;

971 
	g’um_b™s
 = 
bridge_sock_ty³
 & (~
BRIDGE_SOCK_TYPE_FLAGS
);

972 
	g’um_b™s
) {

973 
	gBRIDGE_SOCK_STREAM
:

974 
sock_ty³
 = 
SOCK_STREAM
;

976 
	gBRIDGE_SOCK_DGRAM
:

977 
sock_ty³
 = 
SOCK_DGRAM
;

979 
	gBRIDGE_SOCK_SEQPACKET
:

980 
sock_ty³
 = 
SOCK_SEQPACKET
;

982 
	gBRIDGE_SOCK_RAW
:

983 
sock_ty³
 = 
SOCK_RAW
;

985 
	gBRIDGE_SOCK_RDM
:

986 
sock_ty³
 = 
SOCK_RDM
;

988 
	gBRIDGE_SOCK_PACKET
:

989 
sock_ty³
 = 
SOCK_PACKET
;

994 ià(
	gbridge_sock_ty³
 & 
	gBRIDGE_SOCK_O_NONBLOCK
è
	gsock_ty³
 |ğ
SOCK_NONBLOCK
;

995 ià(
	gbridge_sock_ty³
 & 
	gBRIDGE_SOCK_O_CLOEXEC
è
	gsock_ty³
 |ğ
SOCK_CLOEXEC
;

996  
	gsock_ty³
;

999 
ToBridgeSock‘Ty³
(
sock_ty³
) {

1000 
cÚ¡ex´
 
	gkSockTy³FÏgMask
 = ~(
SOCK_CLOEXEC
 | 
SOCK_NONBLOCK
);

1001 
	gbridge_sock_ty³
 = 0;

1002 
	g’um_b™s
 = 
sock_ty³
 & 
kSockTy³FÏgMask
;

1003 
	g’um_b™s
) {

1004 
	gSOCK_STREAM
:

1005 
bridge_sock_ty³
 = 
BRIDGE_SOCK_STREAM
;

1007 
	gSOCK_DGRAM
:

1008 
bridge_sock_ty³
 = 
BRIDGE_SOCK_DGRAM
;

1010 
	gSOCK_SEQPACKET
:

1011 
bridge_sock_ty³
 = 
BRIDGE_SOCK_SEQPACKET
;

1013 
	gSOCK_RAW
:

1014 
bridge_sock_ty³
 = 
BRIDGE_SOCK_RAW
;

1016 
	gSOCK_RDM
:

1017 
bridge_sock_ty³
 = 
BRIDGE_SOCK_RDM
;

1019 
	gSOCK_PACKET
:

1020 
bridge_sock_ty³
 = 
BRIDGE_SOCK_PACKET
;

1023  
BRIDGE_SOCK_UNSUPPORTED
;

1025 ià(
	gsock_ty³
 & 
	gSOCK_NONBLOCK
è
	gbridge_sock_ty³
 |ğ
BRIDGE_SOCK_O_NONBLOCK
;

1026 ià(
	gsock_ty³
 & 
	gSOCK_CLOEXEC
è
	gbridge_sock_ty³
 |ğ
BRIDGE_SOCK_O_CLOEXEC
;

1027  
	gbridge_sock_ty³
;

1030 
pŞlfd
 *
FromBridgePŞlfd
(cÚ¡ 
bridge_pŞlfd
 *
bridge_fd
,

1031 
pŞlfd
 *
fd
) {

1032 ià(!
	gbridge_fd
 || !
	gfd
è 
	gnuÎ±r
;

1033 
	gfd
->fd = 
bridge_fd
->
fd
;

1034 
	gfd
->
	gev’ts
 = 
FromBridgePŞlEv’ts
(
bridge_fd
->
ev’ts
);

1035 
	gfd
->
	g»v’ts
 = 
FromBridgePŞlEv’ts
(
bridge_fd
->
»v’ts
);

1036  
	gfd
;

1039 
bridge_pŞlfd
 *
ToBridgePŞlfd
(cÚ¡ 
pŞlfd
 *
fd
,

1040 
bridge_pŞlfd
 *
bridge_fd
) {

1041 ià(!
	gfd
 || !
	gbridge_fd
è 
	gnuÎ±r
;

1042 
	gbridge_fd
->
	gfd
 = 
fd
->fd;

1043 
	gbridge_fd
->
	gev’ts
 = 
ToBridgePŞlEv’ts
(
fd
->
ev’ts
);

1044 
	gbridge_fd
->
	g»v’ts
 = 
ToBridgePŞlEv’ts
(
fd
->
»v’ts
);

1045  
	gbridge_fd
;

1048 
msghdr
 *
FromBridgeMsgHdr
(cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

1049 
msghdr
 *
msg
) {

1050 ià(!
	gbridge_msg
 || !
	gmsg
è 
	gnuÎ±r
;

1051 
	gmsg
->
	gmsg_Çme
 = 
bridge_msg
->
msg_Çme
;

1052 
	gmsg
->
	gmsg_Çm–’
 = 
bridge_msg
->
msg_Çm–’
;

1053 
	gmsg
->
	gmsg_iov
 = 
»š‹½»t_ÿ¡
<
iovec
 *>(
bridge_msg
->
msg_iov
);

1054 
	gmsg
->
	gmsg_iovËn
 = 
bridge_msg
->
msg_iovËn
;

1055 
	gmsg
->
	gmsg_cÚŒŞ
 = 
bridge_msg
->
msg_cÚŒŞ
;

1056 
	gmsg
->
	gmsg_cÚŒŞËn
 = 
bridge_msg
->
msg_cÚŒŞËn
;

1057 
	gmsg
->
	gmsg_æags
 = 
bridge_msg
->
msg_æags
;

1058  
	gmsg
;

1061 
bridge_msghdr
 *
ToBridgeMsgHdr
(cÚ¡ 
msghdr
 *
msg
,

1062 
bridge_msghdr
 *
bridge_msg
) {

1063 ià(!
	gmsg
 || !
	gbridge_msg
è 
	gnuÎ±r
;

1064 
	gbridge_msg
->
	gmsg_Çme
 = 
msg
->
msg_Çme
;

1065 
	gbridge_msg
->
	gmsg_Çm–’
 = 
msg
->
msg_Çm–’
;

1066 
	gbridge_msg
->
	gmsg_iov
 = 
»š‹½»t_ÿ¡
<
bridge_iovec
 *>(
msg
->
msg_iov
);

1067 
	gbridge_msg
->
	gmsg_iovËn
 = 
msg
->
msg_iovËn
;

1068 
	gbridge_msg
->
	gmsg_cÚŒŞ
 = 
msg
->
msg_cÚŒŞ
;

1069 
	gbridge_msg
->
	gmsg_cÚŒŞËn
 = 
msg
->
msg_cÚŒŞËn
;

1070 
	gbridge_msg
->
	gmsg_æags
 = 
msg
->
msg_æags
;

1071  
	gbridge_msg
;

1074 
msghdr
 *
FromBridgeIovecA¼ay
(cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

1075 
msghdr
 *
msg
) {

1076 ià(!
	gbridge_msg
 || !
	gmsg
è 
	gnuÎ±r
;

1077 
ušt64_t
 
	gi
 = 0; i < 
	gbridge_msg
->
	gmsg_iovËn
; ++i) {

1078 
memıy
(
msg
->
msg_iov
[
i
].
iov_ba£
, 
bridge_msg
->msg_iov[i].iov_base,

1079 
bridge_msg
->
msg_iov
[
i
].
iov_Ën
);

1081  
	gmsg
;

1084 
bridge_msghdr
 *
ToBridgeIovecA¼ay
(cÚ¡ 
msghdr
 *
msg
,

1085 
bridge_msghdr
 *
bridge_msg
) {

1086 ià(!
	gmsg
 || !
	gbridge_msg
è 
	gnuÎ±r
;

1087 
ušt64_t
 
	gi
 = 0; i < 
	gmsg
->
	gmsg_iovËn
; ++i) {

1088 
memıy
(
bridge_msg
->
msg_iov
[
i
].
iov_ba£
, 
msg
->msg_iov[i].iov_base,

1089 
msg
->
msg_iov
[
i
].
iov_Ën
);

1091  
	gbridge_msg
;

1094 
iovec
 *
FromBridgeIovec
(cÚ¡ 
bridge_iovec
 *
bridge_iov
,

1095 
iovec
 *
iov
) {

1096 ià(!
	gbridge_iov
 || !
	giov
è 
	gnuÎ±r
;

1097 
	giov
->
	giov_ba£
 = 
bridge_iov
->
iov_ba£
;

1098 
	giov
->
	giov_Ën
 = 
bridge_iov
->
iov_Ën
;

1099  
	giov
;

1102 
bridge_iovec
 *
ToBridgeIovec
(cÚ¡ 
iovec
 *
iov
,

1103 
bridge_iovec
 *
bridge_iov
) {

1104 ià(!
	giov
 || !
	gbridge_iov
è 
	gnuÎ±r
;

1105 
	gbridge_iov
->
	giov_ba£
 = 
iov
->
iov_ba£
;

1106 
	gbridge_iov
->
	giov_Ën
 = 
iov
->
iov_Ën
;

1107  
	gbridge_iov
;

1110 
tms
 *
FromBridgeTms
(cÚ¡ 
BridgeTms
 *
bridge_times
,

1111 
tms
 *
times
) {

1112 ià(!
	gbridge_times
 || !
	gtimes
è 
	gnuÎ±r
;

1113 
	gtimes
->
	gtms_utime
 = 
bridge_times
->
tms_utime
;

1114 
	gtimes
->
	gtms_¡ime
 = 
bridge_times
->
tms_¡ime
;

1115 
	gtimes
->
	gtms_cutime
 = 
bridge_times
->
tms_cutime
;

1116 
	gtimes
->
	gtms_c¡ime
 = 
bridge_times
->
tms_c¡ime
;

1117  
	gtimes
;

1120 
BridgeTms
 *
ToBridgeTms
(cÚ¡ 
tms
 *
times
,

1121 
BridgeTms
 *
bridge_times
) {

1122 ià(!
	gtimes
 || !
	gbridge_times
è 
	gnuÎ±r
;

1123 
	gbridge_times
->
	gtms_utime
 = 
times
->
tms_utime
;

1124 
	gbridge_times
->
	gtms_¡ime
 = 
times
->
tms_¡ime
;

1125 
	gbridge_times
->
	gtms_cutime
 = 
times
->
tms_cutime
;

1126 
	gbridge_times
->
	gtms_c¡ime
 = 
times
->
tms_c¡ime
;

1127  
	gbridge_times
;

1130 
time¥ec
 *
FromBridgeTime¥ec
(cÚ¡ 
bridge_time¥ec
 *
bridge_
,

1131 
time¥ec
 *

) {

1132 
	g
->
	gtv_£c
 = 
bridge_
->
tv_£c
;

1133 
	g
->
	gtv_n£c
 = 
bridge_
->
tv_n£c
;

1134  
	g
;

1137 
bridge_time¥ec
 *
ToBridgeTime¥ec
(cÚ¡ 
time¥ec
 *

,

1138 
bridge_time¥ec
 *
bridge_
) {

1139 
	gbridge_
->
	gtv_£c
 = 

->
tv_£c
;

1140 
	gbridge_
->
	gtv_n£c
 = 

->
tv_n£c
;

1141  
	gbridge_
;

1144 
utimbuf
 *
FromBridgeUtimbuf
(cÚ¡ 
bridge_utimbuf
 *
bridge_ut
,

1145 
utimbuf
 *
ut
) {

1146 ià(!
	gut
 || !
	gbridge_ut
è 
	gnuÎ±r
;

1147 
	gut
->
	gaùime
 = 
bridge_ut
->
aùime
;

1148 
	gut
->
	gmodtime
 = 
bridge_ut
->
modtime
;

1149  
	gut
;

1152 
bridge_utimbuf
 *
ToBridgeUtimbuf
(cÚ¡ 
utimbuf
 *
ut
,

1153 
bridge_utimbuf
 *
bridge_ut
) {

1154 ià(!
	gut
 || !
	gbridge_ut
è 
	gnuÎ±r
;

1155 
	gbridge_ut
->
	gaùime
 = 
ut
->
aùime
;

1156 
	gbridge_ut
->
	gmodtime
 = 
ut
->
modtime
;

1157  
	gbridge_ut
;

1160 
timev®
 *
FromBridgeTimeV®
(cÚ¡ 
bridge_timev®
 *
bridge_tv
,

1161 
timev®
 *
tv
) {

1162 ià(!
	gbridge_tv
 || !
	gtv
è 
	gnuÎ±r
;

1163 
	gtv
->
	gtv_£c
 = 
bridge_tv
->
tv_£c
;

1164 
	gtv
->
	gtv_u£c
 = 
bridge_tv
->
tv_u£c
;

1165  
	gtv
;

1168 
bridge_timev®
 *
ToBridgeTimeV®
(cÚ¡ 
timev®
 *
tv
,

1169 
bridge_timev®
 *
bridge_tv
) {

1170 ià(!
	gtv
 || !
	gbridge_tv
è 
	gnuÎ±r
;

1171 
	gbridge_tv
->
	gtv_£c
 = 
tv
->
tv_£c
;

1172 
	gbridge_tv
->
	gtv_u£c
 = 
tv
->
tv_u£c
;

1173  
	gbridge_tv
;

1176 
™im”v®
 *
FromBridgeITim”V®
(

1177 cÚ¡ 
BridgeITim”V®
 *
bridge_tim”v®
, 
™im”v®
 *
tim”v®
) {

1178 ià(!
	gbridge_tim”v®
 || !
	gtim”v®
è 
	gnuÎ±r
;

1179 
FromBridgeTimeV®
(&
bridge_tim”v®
->
™_š‹rv®
, &
tim”v®
->it_interval);

1180 
FromBridgeTimeV®
(&
bridge_tim”v®
->
™_v®ue
, &
tim”v®
->it_value);

1181  
	gtim”v®
;

1184 
BridgeITim”V®
 *
ToBridgeITim”V®
(

1185 cÚ¡ 
™im”v®
 *
tim”v®
, 
BridgeITim”V®
 *
bridge_tim”v®
) {

1186 ià(!
	gtim”v®
 || !
	gbridge_tim”v®
è 
	gnuÎ±r
;

1187 
ToBridgeTimeV®
(&
tim”v®
->
™_š‹rv®
, &
bridge_tim”v®
->it_interval);

1188 
ToBridgeTimeV®
(&
tim”v®
->
™_v®ue
, &
bridge_tim”v®
->it_value);

1189  
	gbridge_tim”v®
;

1192 
FromBridgeWStus
(
BridgeWStus
 
bridge_w¡©us
) {

1193 
	gw¡©us
 = 
¡©ic_ÿ¡
<>(
bridge_w¡©us
.
šfo
) << 8;

1194 ià(
BridgeWIfEx™ed
(
bridge_w¡©us
)) {

1195  
	gw¡©us
;

1197 ià(
BridgeWIfStİ³d
(
bridge_w¡©us
)) {

1198  
	gw¡©us
 + 
	gBRIDGE_WSTOPPED
;

1200  
	gw¡©us
 + 
	gbridge_w¡©us
.
	gcode
;

1203 
BridgeWStus
 
ToBridgeWStus
(
w¡©us
) {

1204 
BridgeWStus
 
	gbridge_w¡©us
;

1207 
	gbridge_w¡©us
.
	gšfo
 = 
w¡©us
 >> 8 & 0xff;

1208 ià(
WIFEXITED
(
w¡©us
)) {

1209 
	gbridge_w¡©us
.
	gcode
 = 0;

1210 } ià(
WIFSTOPPED
(
w¡©us
)) {

1211 
	gbridge_w¡©us
.
	gcode
 = 
BRIDGE_WSTOPPED
;

1213 
	gbridge_w¡©us
.
	gcode
 = 
w¡©us
 & 
BRIDGE_WSTOPPED
;

1215  
	gbridge_w¡©us
;

1218 
ru§ge
 *
FromBridgeRU§ge
(cÚ¡ 
BridgeRU§ge
 *
bridge_ru§ge
,

1219 
ru§ge
 *rusage) {

1220 ià(!
	gbridge_ru§ge
 || !
	gru§ge
è 
	gnuÎ±r
;

1221 
FromBridgeTimeV®
(&
bridge_ru§ge
->
ru_utime
, &
ru§ge
->ru_utime);

1222 
FromBridgeTimeV®
(&
bridge_ru§ge
->
ru_¡ime
, &
ru§ge
->ru_stime);

1223  
	gru§ge
;

1226 
BridgeRU§ge
 *
ToBridgeRU§ge
(cÚ¡ 
ru§ge
 *rusage,

1227 
BridgeRU§ge
 *
bridge_ru§ge
) {

1228 ià(!
	gru§ge
 || !
	gbridge_ru§ge
è 
	gnuÎ±r
;

1229 
ToBridgeTimeV®
(&
ru§ge
->
ru_utime
, &
bridge_ru§ge
->ru_utime);

1230 
ToBridgeTimeV®
(&
ru§ge
->
ru_¡ime
, &
bridge_ru§ge
->ru_stime);

1231  
	gbridge_ru§ge
;

1234 
fd_£t
 *
FromBridgeFDS‘
(cÚ¡ 
BridgeFDS‘
 *
bridge_fds
, fd_£ˆ*
fds
) {

1235 ià(!
	gbridge_fds
 || !
	gfds
è 
	gnuÎ±r
;

1236 
FD_ZERO
(
fds
);

1237 
	gfd
 = 0; fd < 
	g¡d
::
mš
(
FD_SETSIZE
, 
BRIDGE_FD_SETSIZE
); ++fd) {

1238 ià(
BridgeFDIsS‘
(
fd
, 
bridge_fds
)) {

1239 
FD_SET
(
fd
, 
fds
);

1242  
	gfds
;

1245 
BridgeFDS‘
 *
ToBridgeFDS‘
(cÚ¡ 
fd_£t
 *
fds
,

1246 
BridgeFDS‘
 *
bridge_fds
) {

1247 ià(!
	gfds
 || !
	gbridge_fds
è 
	gnuÎ±r
;

1248 
BridgeFDZ”o
(
bridge_fds
);

1249 
	gfd
 = 0; fd < 
	g¡d
::
mš
(
FD_SETSIZE
, 
BRIDGE_FD_SETSIZE
); ++fd) {

1250 ià(
FD_ISSET
(
fd
, 
fds
)) {

1251 
BridgeFDS‘
(
fd
, 
bridge_fds
);

1254  
	gbridge_fds
;

1257 
šlše
 
ušt64_t
 
BridgeWÜdNum
(
ıu
) {

1258  
	gıu
 / (8 * (
	gBridgeCpuS‘WÜd
));

1261 
šlše
 
BridgeCpuS‘WÜd
 
BridgeB™Num
(
ıu
) {

1262  
	gıu
 % (8 * (
	gBridgeCpuS‘WÜd
));

1268 
BridgeCpuS‘Z”o
(
BridgeCpuS‘
 *
£t
) {

1269 
mem£t
(
£t
->
wÜds
, 0, 
BRIDGE_CPU_SET_NUM_WORDS
 * (
BridgeCpuS‘WÜd
));

1272 
BridgeCpuS‘AddB™
(
ıu
, 
BridgeCpuS‘
 *
£t
) {

1273 
	g£t
->
	gwÜds
[
BridgeWÜdNum
(
ıu
)] |ğ
¡©ic_ÿ¡
<
BridgeCpuS‘WÜd
>(1)

1274 << 
BridgeB™Num
(
ıu
);

1277 
BridgeCpuS‘CheckB™
(
ıu
, 
BridgeCpuS‘
 *
£t
) {

1278  (
	g£t
->
	gwÜds
[
BridgeWÜdNum
(
ıu
)] &

1279 (
	g¡©ic_ÿ¡
<
	gBridgeCpuS‘WÜd
>(1è<< 
BridgeB™Num
(
ıu
)))

1284 
boŞ
 
CSŒšgCİy
(cÚ¡ *
sourû_buf
, *
de¡_buf
, 
size_t
 
size
) {

1285 
	g»t
 = 
¢´štf
(
de¡_buf
, 
size
, "%s", 
sourû_buf
);

1286  
	g»t
 >ğ0 && 
¡©ic_ÿ¡
<
size_t
>(
»t
è< 
size
;

1289 
·sswd
 *
FromBridgePassWd
(
BridgePassWd
 *
bridge_·sswÜd
,

1290 
·sswd
 *
·sswÜd
) {

1291 ià(!
	gbridge_·sswÜd
 || !
	g·sswÜd
) {

1292  
	gnuÎ±r
;

1295 
	g·sswÜd
->
	gpw_Çme
 = 
bridge_·sswÜd
->
pw_Çme
;

1296 
	g·sswÜd
->
	gpw_·sswd
 = 
bridge_·sswÜd
->
pw_·sswd
;

1297 
	g·sswÜd
->
	gpw_uid
 = 
bridge_·sswÜd
->
pw_uid
;

1298 
	g·sswÜd
->
	gpw_gid
 = 
bridge_·sswÜd
->
pw_gid
;

1299 
	g·sswÜd
->
	gpw_gecos
 = 
bridge_·sswÜd
->
pw_gecos
;

1300 
	g·sswÜd
->
	gpw_dœ
 = 
bridge_·sswÜd
->
pw_dœ
;

1301 
	g·sswÜd
->
	gpw_sh–l
 = 
bridge_·sswÜd
->
pw_sh–l
;

1303  
	g·sswÜd
;

1306 
BridgePassWd
 *
ToBridgePassWd
(cÚ¡ 
·sswd
 *
·sswÜd
,

1307 
BridgePassWd
 *
bridge_·sswÜd
) {

1308 ià(!
	g·sswÜd
 || !
	gbridge_·sswÜd
) {

1309  
	gnuÎ±r
;

1312 
	gbridge_·sswÜd
->
	gpw_uid
 = 
·sswÜd
->
pw_uid
;

1313 
	gbridge_·sswÜd
->
	gpw_gid
 = 
·sswÜd
->
pw_gid
;

1315 ià(!
CSŒšgCİy
(
·sswÜd
->
pw_Çme
, 
bridge_·sswÜd
->pw_name,

1316 (
bridge_·sswÜd
->
pw_Çme
)) ||

1317 !
CSŒšgCİy
(
·sswÜd
->
pw_·sswd
, 
bridge_·sswÜd
->pw_passwd,

1318 (
bridge_·sswÜd
->
pw_·sswd
)) ||

1319 !
CSŒšgCİy
(
·sswÜd
->
pw_gecos
, 
bridge_·sswÜd
->pw_gecos,

1320 (
bridge_·sswÜd
->
pw_gecos
)) ||

1321 !
CSŒšgCİy
(
·sswÜd
->
pw_dœ
, 
bridge_·sswÜd
->pw_dir,

1322 (
bridge_·sswÜd
->
pw_dœ
)) ||

1323 !
CSŒšgCİy
(
·sswÜd
->
pw_sh–l
, 
bridge_·sswÜd
->pw_shell,

1324 (
bridge_·sswÜd
->
pw_sh–l
))) {

1325  
	gnuÎ±r
;

1328  
	gbridge_·sswÜd
;

1331 
BridgePassWd
 *
CİyBridgePassWd
(

1332 cÚ¡ 
BridgePassWd
 *
sourû_bridge_·sswÜd
,

1333 
BridgePassWd
 *
de¡š©iÚ_bridge_·sswÜd
) {

1334 ià(!
	gsourû_bridge_·sswÜd
 || !
	gde¡š©iÚ_bridge_·sswÜd
) {

1335  
	gnuÎ±r
;

1338 
	gde¡š©iÚ_bridge_·sswÜd
->
	gpw_uid
 = 
sourû_bridge_·sswÜd
->
pw_uid
;

1339 
	gde¡š©iÚ_bridge_·sswÜd
->
	gpw_gid
 = 
sourû_bridge_·sswÜd
->
pw_gid
;

1341 ià(!
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_Çme
,

1342 
de¡š©iÚ_bridge_·sswÜd
->
pw_Çme
,

1343 (
de¡š©iÚ_bridge_·sswÜd
->
pw_Çme
)) ||

1344 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_·sswd
,

1345 
de¡š©iÚ_bridge_·sswÜd
->
pw_·sswd
,

1346 (
de¡š©iÚ_bridge_·sswÜd
->
pw_·sswd
)) ||

1347 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_gecos
,

1348 
de¡š©iÚ_bridge_·sswÜd
->
pw_gecos
,

1349 (
de¡š©iÚ_bridge_·sswÜd
->
pw_gecos
)) ||

1350 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_dœ
,

1351 
de¡š©iÚ_bridge_·sswÜd
->
pw_dœ
,

1352 (
de¡š©iÚ_bridge_·sswÜd
->
pw_dœ
)) ||

1353 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_sh–l
,

1354 
de¡š©iÚ_bridge_·sswÜd
->
pw_sh–l
,

1355 (
de¡š©iÚ_bridge_·sswÜd
->
pw_sh–l
))) {

1356  
	gnuÎ±r
;

1359  
	gde¡š©iÚ_bridge_·sswÜd
;

	@platform/common/bridge_functions.cc

19 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

22 #iâdeà
_GNU_SOURCE


23 
	#_GNU_SOURCE


	)

27 #iâdeà
_XOPEN_SOURCE


28 
	#_XOPEN_SOURCE


	)

31 
	~<fú.h
>

32 
	~<Ãtdb.h
>

33 
	~<Ãtš‘/š.h
>

34 
	~<pŞl.h
>

35 
	~<sys/sock‘.h
>

36 
	~<sys/¡©.h
>

37 
	~<sys/ty³s.h
>

38 
	~<sys/un.h
>

39 
	~<uni¡d.h
>

40 
	~<utime.h
>

41 
	~<®gÜ™hm
>

42 
	~<csigÇl
>

43 
	~<c¡dšt
>

44 
	~<c¡ršg
>

45 
	~<unÜd”ed_m­
>

47 
	~"asylo/ut/loggšg.h
"

48 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

50 
Çme¥aû
 
	gasylo
 {

51 
	gÇme¥aû
 {

53 
boŞ
 
BridgeWIfEx™ed
(
BridgeWStus
 
bridge_w¡©us
) {

54  
	gbridge_w¡©us
.
	gcode
 == 0;

57 
boŞ
 
BridgeWIfStİ³d
(
BridgeWStus
 
bridge_w¡©us
) {

58  
	gbridge_w¡©us
.
	gcode
 =ğ
BRIDGE_WSTOPPED
;

61 
FromBridgeSysLogLev–
(
bridge_sy¦og_Ëv–
) {

62 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_EMERG
è 
LOG_EMERG
;

63 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_ALERT
è 
LOG_ALERT
;

64 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_CRIT
è 
LOG_CRIT
;

65 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_ERR
è 
LOG_ERR
;

66 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_WARNING
è 
LOG_WARNING
;

67 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_NOTICE
è 
LOG_NOTICE
;

68 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_INFO
è 
LOG_INFO
;

69 ià(
	gbridge_sy¦og_Ëv–
 =ğ
BRIDGE_LOG_DEBUG
è 
LOG_DEBUG
;

73 
ToBridgeSysLogLev–
(
sy¦og_Ëv–
) {

74 ià(
	gsy¦og_Ëv–
 =ğ
LOG_EMERG
è 
BRIDGE_LOG_EMERG
;

75 ià(
	gsy¦og_Ëv–
 =ğ
LOG_ALERT
è 
BRIDGE_LOG_ALERT
;

76 ià(
	gsy¦og_Ëv–
 =ğ
LOG_CRIT
è 
BRIDGE_LOG_CRIT
;

77 ià(
	gsy¦og_Ëv–
 =ğ
LOG_ERR
è 
BRIDGE_LOG_ERR
;

78 ià(
	gsy¦og_Ëv–
 =ğ
LOG_WARNING
è 
BRIDGE_LOG_WARNING
;

79 ià(
	gsy¦og_Ëv–
 =ğ
LOG_NOTICE
è 
BRIDGE_LOG_NOTICE
;

80 ià(
	gsy¦og_Ëv–
 =ğ
LOG_INFO
è 
BRIDGE_LOG_INFO
;

81 ià(
	gsy¦og_Ëv–
 =ğ
LOG_DEBUG
è 
BRIDGE_LOG_DEBUG
;

85 
BridgeSigAddS‘
(
bridge_sig£t_t
 *
bridge_£t
, cÚ¡ 
sig
) {

86 *
	gbridge_£t
 |ğ(
UINT64_C
(1è<< 
sig
);

89 
boŞ
 
BridgeSigIsMemb”
(cÚ¡ 
bridge_sig£t_t
 *
bridge_£t
, cÚ¡ 
sig
) {

90  (*
	gbridge_£t
 & (
UINT64_C
(1è<< 
	gsig
)) != 0;

93 
BridgeSigEm±yS‘
(
bridge_sig£t_t
 *
bridge_£t
è{ *
	gbridge_£t
 = 0; }

95 cÚ¡ 
	g¡d
::
unÜd”ed_m­
<, > *
C»©eBridgeSigÇlM­
() {

96 autØ
	gsigÇl_m­
 = 
Ãw
 
¡d
::
unÜd”ed_m­
<, >;

97 
	gsigÇl_m­
->
š£¹
({
SIGHUP
, 
BRIDGE_SIGHUP
});

98 
	gsigÇl_m­
->
š£¹
({
SIGINT
, 
BRIDGE_SIGINT
});

99 
	gsigÇl_m­
->
š£¹
({
SIGQUIT
, 
BRIDGE_SIGQUIT
});

100 
	gsigÇl_m­
->
š£¹
({
SIGILL
, 
BRIDGE_SIGILL
});

101 
	gsigÇl_m­
->
š£¹
({
SIGTRAP
, 
BRIDGE_SIGTRAP
});

102 
	gsigÇl_m­
->
š£¹
({
SIGABRT
, 
BRIDGE_SIGABRT
});

103 
	gsigÇl_m­
->
š£¹
({
SIGBUS
, 
BRIDGE_SIGBUS
});

104 
	gsigÇl_m­
->
š£¹
({
SIGFPE
, 
BRIDGE_SIGFPE
});

105 
	gsigÇl_m­
->
š£¹
({
SIGKILL
, 
BRIDGE_SIGKILL
});

106 
	gsigÇl_m­
->
š£¹
({
SIGUSR1
, 
BRIDGE_SIGUSR1
});

107 
	gsigÇl_m­
->
š£¹
({
SIGSEGV
, 
BRIDGE_SIGSEGV
});

108 
	gsigÇl_m­
->
š£¹
({
SIGUSR2
, 
BRIDGE_SIGUSR2
});

109 
	gsigÇl_m­
->
š£¹
({
SIGPIPE
, 
BRIDGE_SIGPIPE
});

110 
	gsigÇl_m­
->
š£¹
({
SIGALRM
, 
BRIDGE_SIGALRM
});

111 
	gsigÇl_m­
->
š£¹
({
SIGCHLD
, 
BRIDGE_SIGCHLD
});

112 
	gsigÇl_m­
->
š£¹
({
SIGCONT
, 
BRIDGE_SIGCONT
});

113 
	gsigÇl_m­
->
š£¹
({
SIGSTOP
, 
BRIDGE_SIGSTOP
});

114 
	gsigÇl_m­
->
š£¹
({
SIGTSTP
, 
BRIDGE_SIGTSTP
});

115 
	gsigÇl_m­
->
š£¹
({
SIGTTIN
, 
BRIDGE_SIGTTIN
});

116 
	gsigÇl_m­
->
š£¹
({
SIGTTOU
, 
BRIDGE_SIGTTOU
});

117 
	gsigÇl_m­
->
š£¹
({
SIGURG
, 
BRIDGE_SIGURG
});

118 
	gsigÇl_m­
->
š£¹
({
SIGXCPU
, 
BRIDGE_SIGXCPU
});

119 
	gsigÇl_m­
->
š£¹
({
SIGXFSZ
, 
BRIDGE_SIGXFSZ
});

120 
	gsigÇl_m­
->
š£¹
({
SIGVTALRM
, 
BRIDGE_SIGVTALRM
});

121 
	gsigÇl_m­
->
š£¹
({
SIGPROF
, 
BRIDGE_SIGPROF
});

122 
	gsigÇl_m­
->
š£¹
({
SIGWINCH
, 
BRIDGE_SIGWINCH
});

123 
	gsigÇl_m­
->
š£¹
({
SIGSYS
, 
BRIDGE_SIGSYS
});

124 
	gsigÇl_m­
->
š£¹
({
SIGTERM
, 
BRIDGE_SIGTERM
});

125 #ià
defšed
(
SIGRTMIN
è&& defšed(
SIGRTMAX
)

126 
	gsigÇl
 = 
SIGRTMIN
; sigÇÈ<ğ
SIGRTMAX
; ++signal) {

127 
	gsigÇl_m­
->
š£¹
({
sigÇl
, sigÇÈ- 
SIGRTMIN
 + 
BRIDGE_SIGRTMIN
});

130  
	gsigÇl_m­
;

133 cÚ¡ 
	g¡d
::
unÜd”ed_m­
<, > *
G‘SigÇlToBridgeSigÇlM­
() {

134 cÚ¡ 
	g¡d
::
unÜd”ed_m­
<, > *
	gsigÇl_to_bridge_sigÇl_m­
 =

135 
C»©eBridgeSigÇlM­
();

136  
	gsigÇl_to_bridge_sigÇl_m­
;

139 
FromBridgeTıO±iÚName
(
bridge_tı_İtiÚ_Çme
) {

140 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_NODELAY
è 
TCP_NODELAY
;

141 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_KEEPIDLE
è 
TCP_KEEPIDLE
;

142 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_KEEPINTVL
è 
TCP_KEEPINTVL
;

143 ià(
	gbridge_tı_İtiÚ_Çme
 =ğ
BRIDGE_TCP_KEEPCNT
è 
TCP_KEEPCNT
;

147 
FromBridgeIpV6O±iÚName
(
bridge_v6_İtiÚ_Çme
) {

148 ià(
	gbridge_v6_İtiÚ_Çme
 =ğ
BRIDGE_IPV6_V6ONLY
è 
IPV6_V6ONLY
;

152 
ToBridgeIpV6O±iÚName
(
v6_İtiÚ_Çme
) {

153 ià(
	gv6_İtiÚ_Çme
 =ğ
IPV6_V6ONLY
è 
BRIDGE_IPV6_V6ONLY
;

157 
ToBridgeTıO±iÚName
(
tı_İtiÚ_Çme
) {

158 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_NODELAY
è 
BRIDGE_TCP_NODELAY
;

159 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_KEEPIDLE
è 
BRIDGE_TCP_KEEPIDLE
;

160 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_KEEPINTVL
è 
BRIDGE_TCP_KEEPINTVL
;

161 ià(
	gtı_İtiÚ_Çme
 =ğ
TCP_KEEPCNT
è 
BRIDGE_TCP_KEEPCNT
;

165 
FromBridgeSock‘O±iÚName
(
bridge_sock‘_İtiÚ_Çme
) {

166 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_DEBUG
è 
SO_DEBUG
;

167 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_REUSEADDR
è 
SO_REUSEADDR
;

168 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_TYPE
è 
SO_TYPE
;

169 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_ERROR
è 
SO_ERROR
;

170 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_DONTROUTE
è 
SO_DONTROUTE
;

171 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_BROADCAST
è 
SO_BROADCAST
;

172 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_SNDBUF
è 
SO_SNDBUF
;

173 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_RCVBUF
è 
SO_RCVBUF
;

174 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_SNDTIMEO
è 
SO_SNDTIMEO
;

175 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_RCVTIMEO
è 
SO_RCVTIMEO
;

176 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_SNDBUFFORCE
è 
SO_SNDBUFFORCE
;

177 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_RCVBUFFORCE
è 
SO_RCVBUFFORCE
;

178 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_KEEPALIVE
è 
SO_KEEPALIVE
;

179 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_OOBINLINE
è 
SO_OOBINLINE
;

180 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_NO_CHECK
è 
SO_NO_CHECK
;

181 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_PRIORITY
è 
SO_PRIORITY
;

182 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_LINGER
è 
SO_LINGER
;

183 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_BSDCOMPAT
è 
SO_BSDCOMPAT
;

184 ià(
	gbridge_sock‘_İtiÚ_Çme
 =ğ
BRIDGE_SO_REUSEPORT
è 
SO_REUSEPORT
;

188 
ToBridgeSock‘O±iÚName
(
sock‘_İtiÚ_Çme
) {

189 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_DEBUG
è 
BRIDGE_SO_DEBUG
;

190 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_REUSEADDR
è 
BRIDGE_SO_REUSEADDR
;

191 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_TYPE
è 
BRIDGE_SO_TYPE
;

192 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_ERROR
è 
BRIDGE_SO_ERROR
;

193 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_DONTROUTE
è 
BRIDGE_SO_DONTROUTE
;

194 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_BROADCAST
è 
BRIDGE_SO_BROADCAST
;

195 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_SNDBUF
è 
BRIDGE_SO_SNDBUF
;

196 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_RCVBUF
è 
BRIDGE_SO_RCVBUF
;

197 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_SNDTIMEO
è 
BRIDGE_SO_SNDTIMEO
;

198 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_RCVTIMEO
è 
BRIDGE_SO_RCVTIMEO
;

199 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_SNDBUFFORCE
è 
BRIDGE_SO_SNDBUFFORCE
;

200 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_RCVBUFFORCE
è 
BRIDGE_SO_RCVBUFFORCE
;

201 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_KEEPALIVE
è 
BRIDGE_SO_KEEPALIVE
;

202 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_OOBINLINE
è 
BRIDGE_SO_OOBINLINE
;

203 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_NO_CHECK
è 
BRIDGE_SO_NO_CHECK
;

204 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_PRIORITY
è 
BRIDGE_SO_PRIORITY
;

205 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_LINGER
è 
BRIDGE_SO_LINGER
;

206 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_BSDCOMPAT
è 
BRIDGE_SO_BSDCOMPAT
;

207 ià(
	gsock‘_İtiÚ_Çme
 =ğ
SO_REUSEPORT
è 
BRIDGE_SO_REUSEPORT
;

211 
ušt8_t
 
BridgeFDIsS‘
(
fd
, cÚ¡ 
BridgeFDS‘
 *
bridge_fds
) {

212 ià(
	gbridge_fds
 && 
	gfd
 < 
	gBRIDGE_FD_SETSIZE
) {

213  
	gbridge_fds
->
	gfe_desütÜ_£t
[
fd
];

218 
BridgeFDS‘
(
fd
, BridgeFDS‘ *
bridge_fds
) {

219 ià(
	gbridge_fds
 && 
	gfd
 < 
	gBRIDGE_FD_SETSIZE
) {

220 
	gbridge_fds
->
	gfe_desütÜ_£t
[
fd
] = 1;

224 
BridgeFDZ”o
(
BridgeFDS‘
 *
bridge_fds
) {

225 ià(
	gbridge_fds
) {

226 
	gfd
 = 0; fd < 
	gBRIDGE_FD_SETSIZE
; ++fd) {

227 
	gbridge_fds
->
	gfe_desütÜ_£t
[
fd
] = 0;

232 
FromBridgePŞlEv’ts
(
ev’ts
) {

233 
	g»suÉ
 = 0;

234 ià(
	gev’ts
 & 
	gPOLLIN
è
	g»suÉ
 |ğ
BRIDGE_POLLIN
;

235 ià(
	gev’ts
 & 
	gPOLLPRI
è
	g»suÉ
 |ğ
BRIDGE_POLLPRI
;

236 ià(
	gev’ts
 & 
	gPOLLOUT
è
	g»suÉ
 |ğ
BRIDGE_POLLOUT
;

237 ià(
	gev’ts
 & 
	gPOLLRDHUP
è
	g»suÉ
 |ğ
BRIDGE_POLLRDHUP
;

238 ià(
	gev’ts
 & 
	gPOLLERR
è
	g»suÉ
 |ğ
BRIDGE_POLLERR
;

239 ià(
	gev’ts
 & 
	gPOLLHUP
è
	g»suÉ
 |ğ
BRIDGE_POLLHUP
;

240 ià(
	gev’ts
 & 
	gPOLLNVAL
è
	g»suÉ
 |ğ
BRIDGE_POLLNVAL
;

241 ià(
	gev’ts
 & 
	gPOLLRDNORM
è
	g»suÉ
 |ğ
BRIDGE_POLLRDNORM
;

242 ià(
	gev’ts
 & 
	gPOLLRDBAND
è
	g»suÉ
 |ğ
BRIDGE_POLLRDBAND
;

243 ià(
	gev’ts
 & 
	gPOLLWRNORM
è
	g»suÉ
 |ğ
BRIDGE_POLLWRNORM
;

244 ià(
	gev’ts
 & 
	gPOLLWRBAND
è
	g»suÉ
 |ğ
BRIDGE_POLLWRBAND
;

245  
	g»suÉ
;

248 
ToBridgePŞlEv’ts
(
bridge_ev’ts
) {

249 
	g»suÉ
 = 0;

250 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLIN
è
	g»suÉ
 |ğ
POLLIN
;

251 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLPRI
è
	g»suÉ
 |ğ
POLLPRI
;

252 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLOUT
è
	g»suÉ
 |ğ
POLLOUT
;

253 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLRDHUP
è
	g»suÉ
 |ğ
POLLRDHUP
;

254 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLERR
è
	g»suÉ
 |ğ
POLLERR
;

255 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLHUP
è
	g»suÉ
 |ğ
POLLHUP
;

256 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLNVAL
è
	g»suÉ
 |ğ
POLLNVAL
;

257 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLRDNORM
è
	g»suÉ
 |ğ
POLLRDNORM
;

258 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLRDBAND
è
	g»suÉ
 |ğ
POLLRDBAND
;

259 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLWRNORM
è
	g»suÉ
 |ğ
POLLWRNORM
;

260 ià(
	gbridge_ev’ts
 & 
	gBRIDGE_POLLWRBAND
è
	g»suÉ
 |ğ
POLLWRBAND
;

261  
	g»suÉ
;

266 
FromBridgeFLockO³¿tiÚ
(
bridge_æock_İ”©iÚ
) {

267 
	gæock_İ”©iÚ
 = 0;

268 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_SH
è
	gæock_İ”©iÚ
 |ğ
LOCK_SH
;

269 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_EX
è
	gæock_İ”©iÚ
 |ğ
LOCK_EX
;

270 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_NB
è
	gæock_İ”©iÚ
 |ğ
LOCK_NB
;

271 ià(
	gbridge_æock_İ”©iÚ
 & 
	gBRIDGE_LOCK_UN
è
	gæock_İ”©iÚ
 |ğ
LOCK_UN
;

272  
	gæock_İ”©iÚ
;

275 
ToBridgeFLockO³¿tiÚ
(
æock_İ”©iÚ
) {

276 
	gbridge_æock_İ”©iÚ
 = 0;

277 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_SH
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_SH
;

278 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_EX
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_EX
;

279 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_NB
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_NB
;

280 ià(
	gæock_İ”©iÚ
 & 
	gLOCK_UN
è
	gbridge_æock_İ”©iÚ
 |ğ
BRIDGE_LOCK_UN
;

281  
	gbridge_æock_İ”©iÚ
;

284 
FromBridgeSyscÚfCÚ¡ªts
(
SyscÚfCÚ¡ªts
 
bridge_syscÚf_cÚ¡ªt
) {

285 
	gbridge_syscÚf_cÚ¡ªt
) {

286 
	gBRIDGE_SC_NPROCESSORS_CONF
:

287  
_SC_NPROCESSORS_CONF
;

288 
	gBRIDGE_SC_NPROCESSORS_ONLN
:

289  
_SC_NPROCESSORS_ONLN
;

295 
SyscÚfCÚ¡ªts
 
ToBridgeSyscÚfCÚ¡ªts
(
syscÚf_cÚ¡ªt
) {

296 
	gsyscÚf_cÚ¡ªt
) {

297 
	g_SC_NPROCESSORS_CONF
:

298  
BRIDGE_SC_NPROCESSORS_CONF
;

299 
	g_SC_NPROCESSORS_ONLN
:

300  
BRIDGE_SC_NPROCESSORS_ONLN
;

302  
BRIDGE_SC_UNKNOWN
;

306 
FromBridgeTim”Ty³
(
Tim”Ty³
 
bridge_tim”_ty³
) {

307 ià(
	gbridge_tim”_ty³
 =ğ
BRIDGE_ITIMER_REAL
è 
ITIMER_REAL
;

308 ià(
	gbridge_tim”_ty³
 =ğ
BRIDGE_ITIMER_VIRTUAL
è 
ITIMER_VIRTUAL
;

309 ià(
	gbridge_tim”_ty³
 =ğ
BRIDGE_ITIMER_PROF
è 
ITIMER_PROF
;

313 
Tim”Ty³
 
ToBridgeTim”Ty³
(
tim”_ty³
) {

314 ià(
	gtim”_ty³
 =ğ
ITIMER_REAL
è 
BRIDGE_ITIMER_REAL
;

315 ià(
	gtim”_ty³
 =ğ
ITIMER_VIRTUAL
è 
BRIDGE_ITIMER_VIRTUAL
;

316 ià(
	gtim”_ty³
 =ğ
ITIMER_PROF
è 
BRIDGE_ITIMER_PROF
;

317  
	gBRIDGE_ITIMER_UNKNOWN
;

320 
FromBridgeWa™O±iÚs
(
bridge_wa™_İtiÚs
) {

321 
	gwa™_İtiÚs
 = 0;

322 ià(
	gbridge_wa™_İtiÚs
 & 
	gBRIDGE_WNOHANG
è
	gwa™_İtiÚs
 |ğ
WNOHANG
;

323  
	gwa™_İtiÚs
;

326 
ToBridgeWa™O±iÚs
(
wa™_İtiÚs
) {

327 
	gbridge_wa™_İtiÚs
 = 0;

328 ià(
	gwa™_İtiÚs
 & 
	gWNOHANG
è
	gbridge_wa™_İtiÚs
 |ğ
BRIDGE_WNOHANG
;

329  
	gbridge_wa™_İtiÚs
;

332 
FromBridgeRU§geT¬g‘
(
RU§geT¬g‘
 
bridge_ru§ge_rg‘
) {

333 ià(
	gbridge_ru§ge_rg‘
 =ğ
BRIDGE_RUSAGE_SELF
è 
RUSAGE_SELF
;

334 ià(
	gbridge_ru§ge_rg‘
 =ğ
BRIDGE_RUSAGE_CHILDREN
è 
RUSAGE_CHILDREN
;

338 
RU§geT¬g‘
 
ToBridgeRU§geT¬g‘
(
ru§ge_rg‘
) {

339 ià(
	gru§ge_rg‘
 =ğ
RUSAGE_SELF
è 
BRIDGE_RUSAGE_SELF
;

340 ià(
	gru§ge_rg‘
 =ğ
RUSAGE_CHILDREN
è 
BRIDGE_RUSAGE_CHILDREN
;

341  
	gBRIDGE_RUSAGE_UNKNOWN
;

344 
FromBridgeSigÇl
(
bridge_signum
) {

345 autØ
	gsigÇl
 : *
G‘SigÇlToBridgeSigÇlM­
()) {

346 ià(
bridge_signum
 =ğ
sigÇl
.
£cÚd
) {

347  
sigÇl
.
fœ¡
;

353 
ToBridgeSigÇl
(
signum
) {

354 autØ
	g™”©Ü
 = 
G‘SigÇlToBridgeSigÇlM­
()->
fšd
(
signum
);

355 ià(
	g™”©Ü
 =ğ
G‘SigÇlToBridgeSigÇlM­
()->
’d
()) {

358  
	g™”©Ü
->
	g£cÚd
;

361 
FromBridgeSigMaskAùiÚ
(
bridge_how
) {

362 ià(
	gbridge_how
 =ğ
BRIDGE_SIG_BLOCK
è 
SIG_BLOCK
;

363 ià(
	gbridge_how
 =ğ
BRIDGE_SIG_UNBLOCK
è 
SIG_UNBLOCK
;

364 ià(
	gbridge_how
 =ğ
BRIDGE_SIG_SETMASK
è 
SIG_SETMASK
;

368 
ToBridgeSigMaskAùiÚ
(
how
) {

369 ià(
	ghow
 =ğ
SIG_BLOCK
è 
BRIDGE_SIG_BLOCK
;

370 ià(
	ghow
 =ğ
SIG_UNBLOCK
è 
BRIDGE_SIG_UNBLOCK
;

371 ià(
	ghow
 =ğ
SIG_SETMASK
è 
BRIDGE_SIG_SETMASK
;

375 
sig£t_t
 *
FromBridgeSigS‘
(cÚ¡ 
bridge_sig£t_t
 *
bridge_£t
, sig£t_ˆ*
£t
) {

376 ià(!
	gbridge_£t
 || !
	g£t
è 
	gnuÎ±r
;

377 
sigem±y£t
(
£t
);

378 autØ
	gsigÇl
 : *
G‘SigÇlToBridgeSigÇlM­
()) {

379 ià(
BridgeSigIsMemb”
(
bridge_£t
, 
sigÇl
.
£cÚd
)) {

380 
sigadd£t
(
£t
, 
sigÇl
.
fœ¡
);

383  
	g£t
;

386 
bridge_sig£t_t
 *
ToBridgeSigS‘
(cÚ¡ 
sig£t_t
 *
£t
,

387 
bridge_sig£t_t
 *
bridge_£t
) {

388 ià(!
	g£t
 || !
	gbridge_£t
è 
	gnuÎ±r
;

389 
BridgeSigEm±yS‘
(
bridge_£t
);

390 autØ
	gsigÇl
 : *
G‘SigÇlToBridgeSigÇlM­
()) {

391 ià(
sigismemb”
(
£t
, 
sigÇl
.
fœ¡
)) {

392 
BridgeSigAddS‘
(
bridge_£t
, 
sigÇl
.
£cÚd
);

395  
	gbridge_£t
;

398 
FromBridgeSigÇlCode
(
bridge_si_code
) {

399 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_USER
è 
SI_USER
;

400 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_QUEUE
è 
SI_QUEUE
;

401 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_TIMER
è 
SI_TIMER
;

402 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_ASYNCIO
è 
SI_ASYNCIO
;

403 ià(
	gbridge_si_code
 =ğ
BRIDGE_SI_MESGQ
è 
SI_MESGQ
;

407 
ToBridgeSigÇlCode
(
si_code
) {

408 ià(
	gsi_code
 =ğ
SI_USER
è 
BRIDGE_SI_USER
;

409 ià(
	gsi_code
 =ğ
SI_QUEUE
è 
BRIDGE_SI_QUEUE
;

410 ià(
	gsi_code
 =ğ
SI_TIMER
è 
BRIDGE_SI_TIMER
;

411 ià(
	gsi_code
 =ğ
SI_ASYNCIO
è 
BRIDGE_SI_ASYNCIO
;

412 ià(
	gsi_code
 =ğ
SI_MESGQ
è 
BRIDGE_SI_MESGQ
;

416 
sigšfo_t
 *
FromBridgeSigInfo
(cÚ¡ 
bridge_sigšfo_t
 *
bridge_sigšfo
,

417 
sigšfo_t
 *
sigšfo
) {

418 ià(!
	gbridge_sigšfo
 || !
	gsigšfo
è 
	gnuÎ±r
;

419 
	gsigšfo
->
	gsi_signo
 = 
FromBridgeSigÇl
(
bridge_sigšfo
->
si_signo
);

420 
	gsigšfo
->
	gsi_code
 = 
FromBridgeSigÇlCode
(
bridge_sigšfo
->
si_code
);

421  
	gsigšfo
;

424 
bridge_sigšfo_t
 *
ToBridgeSigInfo
(

425 cÚ¡ 
sigšfo_t
 *
sigšfo
, 
bridge_sigšfo_t
 *
bridge_sigšfo
) {

426 ià(!
	gsigšfo
 || !
	gbridge_sigšfo
è 
	gnuÎ±r
;

427 
	gbridge_sigšfo
->
	gsi_signo
 = 
ToBridgeSigÇl
(
sigšfo
->
si_signo
);

428 
	gbridge_sigšfo
->
	gsi_code
 = 
ToBridgeSigÇlCode
(
sigšfo
->
si_code
);

429  
	gbridge_sigšfo
;

432 
FromBridgeSigÇlFÏgs
(
bridge_§_æags
) {

433 
	g§_æags
 = 0;

434 ià(
	gbridge_§_æags
 & 
	gBRIDGE_SA_NODEFER
è
	g§_æags
 |ğ
SA_NODEFER
;

435 ià(
	gbridge_§_æags
 & 
	gBRIDGE_SA_RESETHAND
è
	g§_æags
 |ğ
SA_RESETHAND
;

436  
	g§_æags
;

439 
ToBridgeSigÇlFÏgs
(
§_æags
) {

440 
	gbridge_§_æags
 = 0;

441 ià(
	g§_æags
 & 
	gSA_NODEFER
è
	gbridge_§_æags
 |ğ
BRIDGE_SA_NODEFER
;

442 ià(
	g§_æags
 & 
	gSA_RESETHAND
è
	gbridge_§_æags
 |ğ
BRIDGE_SA_RESETHAND
;

443  
	gbridge_§_æags
;

446 
FromBridgeAdd»ssInfoFÏgs
(
bridge_ai_æag
) {

447 
	gai_æag
 = 0;

448 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_CANONNAME
è
	gai_æag
 |ğ
AI_CANONNAME
;

449 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_NUMERICHOST
è
	gai_æag
 |ğ
AI_NUMERICHOST
;

450 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_V4MAPPED
è
	gai_æag
 |ğ
AI_V4MAPPED
;

451 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_ADDRCONFIG
è
	gai_æag
 |ğ
AI_ADDRCONFIG
;

452 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_ALL
è
	gai_æag
 |ğ
AI_ALL
;

453 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_PASSIVE
è
	gai_æag
 |ğ
AI_PASSIVE
;

454 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_NUMERICSERV
è
	gai_æag
 |ğ
AI_NUMERICSERV
;

455 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_IDN
è
	gai_æag
 |ğ
AI_IDN
;

456 ià(
	gbridge_ai_æag
 & 
	gBRIDGE_AI_CANONIDN
è
	gai_æag
 |ğ
AI_CANONIDN
;

457  
	gai_æag
;

460 
ToBridgeAdd»ssInfoFÏgs
(
ai_æag
) {

461 
	gbridge_ai_æag
 = 0;

462 ià(
	gai_æag
 & 
	gAI_CANONNAME
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_CANONNAME
;

463 ià(
	gai_æag
 & 
	gAI_NUMERICHOST
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_NUMERICHOST
;

464 ià(
	gai_æag
 & 
	gAI_V4MAPPED
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_V4MAPPED
;

465 ià(
	gai_æag
 & 
	gAI_ADDRCONFIG
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_ADDRCONFIG
;

466 ià(
	gai_æag
 & 
	gAI_ALL
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_ALL
;

467 ià(
	gai_æag
 & 
	gAI_PASSIVE
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_PASSIVE
;

468 ià(
	gai_æag
 & 
	gAI_NUMERICSERV
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_NUMERICSERV
;

469 ià(
	gai_æag
 & 
	gAI_IDN
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_IDN
;

470 ià(
	gai_æag
 & 
	gAI_CANONIDN
è
	gbridge_ai_æag
 |ğ
BRIDGE_AI_CANONIDN
;

471  
	gbridge_ai_æag
;

474 
FromBridgeSysLogO±iÚ
(
bridge_sy¦og_İtiÚ
) {

475 
	gsy¦og_İtiÚ
 = 0;

476 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_PID
è
	gsy¦og_İtiÚ
 |ğ
LOG_PID
;

477 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_CONS
è
	gsy¦og_İtiÚ
 |ğ
LOG_CONS
;

478 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_ODELAY
è
	gsy¦og_İtiÚ
 |ğ
LOG_ODELAY
;

479 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_NDELAY
è
	gsy¦og_İtiÚ
 |ğ
LOG_NDELAY
;

480 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_NOWAIT
è
	gsy¦og_İtiÚ
 |ğ
LOG_NOWAIT
;

481 ià(
	gbridge_sy¦og_İtiÚ
 & 
	gBRIDGE_LOG_PERROR
è
	gsy¦og_İtiÚ
 |ğ
LOG_PERROR
;

482  
	gsy¦og_İtiÚ
;

485 
ToBridgeSysLogO±iÚ
(
sy¦og_İtiÚ
) {

486 
	gbridge_sy¦og_İtiÚ
 = 0;

487 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_PID
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_PID
;

488 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_CONS
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_CONS
;

489 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_ODELAY
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_ODELAY
;

490 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_NDELAY
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_NDELAY
;

491 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_NOWAIT
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_NOWAIT
;

492 ià(
	gsy¦og_İtiÚ
 & 
	gLOG_PERROR
è
	gbridge_sy¦og_İtiÚ
 |ğ
BRIDGE_LOG_PERROR
;

493  
	gbridge_sy¦og_İtiÚ
;

496 
FromBridgeSysLogFac™y
(
bridge_sy¦og_çc™y
) {

497 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_USER
è 
LOG_USER
;

498 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL0
è 
LOG_LOCAL0
;

499 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL1
è 
LOG_LOCAL1
;

500 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL2
è 
LOG_LOCAL2
;

501 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL3
è 
LOG_LOCAL3
;

502 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL4
è 
LOG_LOCAL4
;

503 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL5
è 
LOG_LOCAL5
;

504 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL6
è 
LOG_LOCAL6
;

505 ià(
	gbridge_sy¦og_çc™y
 =ğ
BRIDGE_LOG_LOCAL7
è 
LOG_LOCAL7
;

509 
ToBridgeSysLogFac™y
(
sy¦og_çc™y
) {

510 ià(
	gsy¦og_çc™y
 =ğ
LOG_USER
è 
BRIDGE_LOG_USER
;

511 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL0
è 
BRIDGE_LOG_LOCAL0
;

512 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL1
è 
BRIDGE_LOG_LOCAL1
;

513 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL2
è 
BRIDGE_LOG_LOCAL2
;

514 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL3
è 
BRIDGE_LOG_LOCAL3
;

515 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL4
è 
BRIDGE_LOG_LOCAL4
;

516 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL5
è 
BRIDGE_LOG_LOCAL5
;

517 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL6
è 
BRIDGE_LOG_LOCAL6
;

518 ià(
	gsy¦og_çc™y
 =ğ
LOG_LOCAL7
è 
BRIDGE_LOG_LOCAL7
;

524 
FromBridgeSysLogPriÜ™y
(
bridge_sy¦og_´iÜ™y
) {

525 
	gbridge_sy¦og_Ëv–
 = 
bridge_sy¦og_´iÜ™y
 & 0x07;

526 
	gbridge_sy¦og_çc™y
 = 
bridge_sy¦og_´iÜ™y
 & ~0x07;

527  
FromBridgeSysLogLev–
(
bridge_sy¦og_Ëv–
) |

528 
FromBridgeSysLogFac™y
(
bridge_sy¦og_çc™y
);

531 
ToBridgeSysLogPriÜ™y
(
sy¦og_´iÜ™y
) {

532 
	gsy¦og_Ëv–
 = 
sy¦og_´iÜ™y
 & 0x07;

533 
	gsy¦og_çc™y
 = 
sy¦og_´iÜ™y
 & ~0x07;

534  
ToBridgeSysLogLev–
(
sy¦og_Ëv–
) |

535 
ToBridgeSysLogFac™y
(
sy¦og_çc™y
);

538 
FromBridgeFúCmd
(
bridge_fú_cmd
) {

539 
	gbridge_fú_cmd
) {

540 
	gBRIDGE_F_GETFD
:

541  
F_GETFD
;

542 
	gBRIDGE_F_SETFD
:

543  
F_SETFD
;

544 
	gBRIDGE_F_GETFL
:

545  
F_GETFL
;

546 
	gBRIDGE_F_SETFL
:

547  
F_SETFL
;

548 
	gBRIDGE_F_GETPIPE_SZ
:

549  
F_GETPIPE_SZ
;

550 
	gBRIDGE_F_SETPIPE_SZ
:

551  
F_SETPIPE_SZ
;

557 
ToBridgeFúCmd
(
fú_cmd
) {

558 
	gfú_cmd
) {

559 
	gF_GETFD
:

560  
BRIDGE_F_GETFD
;

561 
	gF_SETFD
:

562  
BRIDGE_F_SETFD
;

563 
	gF_GETFL
:

564  
BRIDGE_F_GETFL
;

565 
	gF_SETFL
:

566  
BRIDGE_F_SETFL
;

567 
	gF_GETPIPE_SZ
:

568  
BRIDGE_F_GETPIPE_SZ
;

569 
	gF_SETPIPE_SZ
:

570  
BRIDGE_F_SETPIPE_SZ
;

576 
FromBridgeFeFÏgs
(
bridge_fe_æag
) {

577 
	gfe_æag
 = 0;

578 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_RDONLY
è
	gfe_æag
 |ğ
O_RDONLY
;

579 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_WRONLY
è
	gfe_æag
 |ğ
O_WRONLY
;

580 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_RDWR
è
	gfe_æag
 |ğ
O_RDWR
;

581 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_CREAT
è
	gfe_æag
 |ğ
O_CREAT
;

582 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_APPEND
è
	gfe_æag
 |ğ
O_APPEND
;

583 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_EXCL
è
	gfe_æag
 |ğ
O_EXCL
;

584 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_TRUNC
è
	gfe_æag
 |ğ
O_TRUNC
;

585 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_NONBLOCK
è
	gfe_æag
 |ğ
O_NONBLOCK
;

586 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_DIRECT
è
	gfe_æag
 |ğ
O_DIRECT
;

587 ià(
	gbridge_fe_æag
 & 
	gBRIDGE_O_CLOEXEC
è
	gfe_æag
 |ğ
O_CLOEXEC
;

588  
	gfe_æag
;

591 
ToBridgeFeFÏgs
(
fe_æag
) {

592 
	gbridge_fe_æag
 = 0;

593 ià(
	gfe_æag
 & 
	gO_RDONLY
è
	gbridge_fe_æag
 |ğ
BRIDGE_RDONLY
;

594 ià(
	gfe_æag
 & 
	gO_WRONLY
è
	gbridge_fe_æag
 |ğ
BRIDGE_WRONLY
;

595 ià(
	gfe_æag
 & 
	gO_RDWR
è
	gbridge_fe_æag
 |ğ
BRIDGE_RDWR
;

596 ià(
	gfe_æag
 & 
	gO_CREAT
è
	gbridge_fe_æag
 |ğ
BRIDGE_CREAT
;

597 ià(
	gfe_æag
 & 
	gO_APPEND
è
	gbridge_fe_æag
 |ğ
BRIDGE_APPEND
;

598 ià(
	gfe_æag
 & 
	gO_EXCL
è
	gbridge_fe_æag
 |ğ
BRIDGE_EXCL
;

599 ià(
	gfe_æag
 & 
	gO_TRUNC
è
	gbridge_fe_æag
 |ğ
BRIDGE_TRUNC
;

600 ià(
	gfe_æag
 & 
	gO_NONBLOCK
è
	gbridge_fe_æag
 |ğ
BRIDGE_NONBLOCK
;

601 ià(
	gfe_æag
 & 
	gO_DIRECT
è
	gbridge_fe_æag
 |ğ
BRIDGE_DIRECT
;

602 ià(
	gfe_æag
 & 
	gO_CLOEXEC
è
	gbridge_fe_æag
 |ğ
BRIDGE_O_CLOEXEC
;

603  
	gbridge_fe_æag
;

606 
FromBridgeFDFÏgs
(
bridge_fd_æag
) {

607 
	gfd_æag
 = 0;

608 ià(
	gbridge_fd_æag
 & 
	gBRIDGE_CLOEXEC
è
	gfd_æag
 |ğ
FD_CLOEXEC
;

609  
	gfd_æag
;

612 
ToBridgeFDFÏgs
(
fd_æag
) {

613 
	gbridge_fd_æag
 = 0;

614 ià(
	gfd_æag
 & 
	gFD_CLOEXEC
è
	gbridge_fd_æag
 |ğ
BRIDGE_CLOEXEC
;

615  
	gbridge_fd_æag
;

618 
FromBridgeO±iÚName
(
Ëv–
, 
bridge_İtiÚ_Çme
) {

619 ià(
	gËv–
 =ğ
IPPROTO_TCP
) {

620  
FromBridgeTıO±iÚName
(
bridge_İtiÚ_Çme
);

622 ià(
	gËv–
 =ğ
IPPROTO_IPV6
) {

623  
FromBridgeIpV6O±iÚName
(
bridge_İtiÚ_Çme
);

625 ià(
	gËv–
 =ğ
SOL_SOCKET
) {

626  
FromBridgeSock‘O±iÚName
(
bridge_İtiÚ_Çme
);

631 
ToBridgeO±iÚName
(
Ëv–
, 
İtiÚ_Çme
) {

632 ià(
	gËv–
 =ğ
IPPROTO_TCP
) {

633  
ToBridgeTıO±iÚName
(
İtiÚ_Çme
);

635 ià(
	gËv–
 =ğ
IPPROTO_IPV6
) {

636  
ToBridgeIpV6O±iÚName
(
İtiÚ_Çme
);

638 ià(
	gËv–
 =ğ
SOL_SOCKET
) {

639  
ToBridgeSock‘O±iÚName
(
İtiÚ_Çme
);

644 
¡©
 *
FromBridgeSt
(cÚ¡ 
bridge_¡©
 *
bridge_¡©buf
,

645 
¡©
 *
¡©buf
) {

646 ià(!
	gbridge_¡©buf
 || !
	g¡©buf
è 
	gnuÎ±r
;

647 
	g¡©buf
->
	g¡_dev
 = 
bridge_¡©buf
->
¡_dev
;

648 
	g¡©buf
->
	g¡_šo
 = 
bridge_¡©buf
->
¡_šo
;

649 
	g¡©buf
->
	g¡_mode
 = 
bridge_¡©buf
->
¡_mode
;

650 
	g¡©buf
->
	g¡_Æšk
 = 
bridge_¡©buf
->
¡_Æšk
;

651 
	g¡©buf
->
	g¡_uid
 = 
bridge_¡©buf
->
¡_uid
;

652 
	g¡©buf
->
	g¡_gid
 = 
bridge_¡©buf
->
¡_gid
;

653 
	g¡©buf
->
	g¡_rdev
 = 
bridge_¡©buf
->
¡_rdev
;

654 
	g¡©buf
->
	g¡_size
 = 
bridge_¡©buf
->
¡_size
;

655 
	g¡©buf
->
	g¡_©ime
 = 
bridge_¡©buf
->
¡_©ime_’c
;

656 
	g¡©buf
->
	g¡_mtime
 = 
bridge_¡©buf
->
¡_mtime_’c
;

657 
	g¡©buf
->
	g¡_ùime
 = 
bridge_¡©buf
->
¡_ùime_’c
;

658 
	g¡©buf
->
	g¡_blksize
 = 
bridge_¡©buf
->
¡_blksize
;

659 
	g¡©buf
->
	g¡_blocks
 = 
bridge_¡©buf
->
¡_blocks
;

660  
	g¡©buf
;

663 
bridge_¡©
 *
ToBridgeSt
(cÚ¡ 
¡©
 *
¡©buf
,

664 
bridge_¡©
 *
bridge_¡©buf
) {

665 ià(!
	g¡©buf
 || !
	gbridge_¡©buf
è 
	gnuÎ±r
;

666 
	gbridge_¡©buf
->
	g¡_dev
 = 
¡©buf
->
¡_dev
;

667 
	gbridge_¡©buf
->
	g¡_šo
 = 
¡©buf
->
¡_šo
;

668 
	gbridge_¡©buf
->
	g¡_mode
 = 
¡©buf
->
¡_mode
;

669 
	gbridge_¡©buf
->
	g¡_Æšk
 = 
¡©buf
->
¡_Æšk
;

670 
	gbridge_¡©buf
->
	g¡_uid
 = 
¡©buf
->
¡_uid
;

671 
	gbridge_¡©buf
->
	g¡_gid
 = 
¡©buf
->
¡_gid
;

672 
	gbridge_¡©buf
->
	g¡_rdev
 = 
¡©buf
->
¡_rdev
;

673 
	gbridge_¡©buf
->
	g¡_size
 = 
¡©buf
->
¡_size
;

674 
	gbridge_¡©buf
->
	g¡_©ime_’c
 = 
¡©buf
->
¡_©ime
;

675 
	gbridge_¡©buf
->
	g¡_mtime_’c
 = 
¡©buf
->
¡_mtime
;

676 
	gbridge_¡©buf
->
	g¡_ùime_’c
 = 
¡©buf
->
¡_ùime
;

677 
	gbridge_¡©buf
->
	g¡_blksize
 = 
¡©buf
->
¡_blksize
;

678 
	gbridge_¡©buf
->
	g¡_blocks
 = 
¡©buf
->
¡_blocks
;

679  
	gbridge_¡©buf
;

682 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

683 
Reš‹½»tCİySšgË
(
T
 *
d¡
, cÚ¡ 
U
 *
¤c
) {

684 
memıy
(
d¡
, 
¤c
, 
¡d
::
mš
((
T
), (
U
)));

687 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gM
,y³Çm
	gU
, size_ˆ
	gN
>

688 
Reš‹½»tCİyA¼ay
(
T
 (&
d¡
)[
M
], cÚ¡ 
U
 (&
¤c
)[
N
],

689 
size_t
 
max_Ën
 = 
SIZE_MAX
) {

690 
memıy
(
d¡
, 
¤c
, 
¡d
::
mš
(
max_Ën
, std::mš((
T
è* 
M
, (
U
è* 
N
)));

693 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

694 
In™ŸlizeToZ”oSšgË
(
T
 *
±r
) {

695 
mem£t
(
±r
, 0, (
T
));

698 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
size_t
 
	gM
>

699 
In™ŸlizeToZ”oA¼ay
(
T
 (&
±r
)[
M
]) {

700 
mem£t
(
±r
, 0, (
T
è* 
M
);

711 
sockaddr
 *
CİySockaddr
(*
sourû
, 
sockËn_t
 
sourû_Ën
,

712 
sockaddr
 *
addr_de¡
,

713 
sockËn_t
 *
add¾’_de¡
) {

714 
memıy
(
addr_de¡
, 
sourû
, 
¡d
::
mš
(*
add¾’_de¡
, 
sourû_Ën
));

715 *
	gadd¾’_de¡
 = 
sourû_Ën
;

716  
	gaddr_de¡
;

719 
sockaddr
 *
FromBridgeSockaddr
(cÚ¡ 
bridge_sockaddr
 *
bridge_addr
,

720 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

721 ià(
	gbridge_addr
 =ğ
nuÎ±r
 || 
addr
 =ğnuÎ±¸|| 
add¾’
 ==‚ullptr) {

722  
nuÎ±r
;

724 
§_çmy_t
 
	gçmy
 = 
FromBridgeAfFamy
(
bridge_addr
->
§_çmy
);

725 ià(
	gçmy
 =ğ
AF_UNIX
 || 
çmy
 =ğ
AF_LOCAL
) {

726 
sockaddr_un
 
sockaddr_un_out
;

727 
	gsockaddr_un_out
.
	gsun_çmy
 = 
çmy
;

728 
In™ŸlizeToZ”oA¼ay
(
sockaddr_un_out
.
sun_·th
);

729 
Reš‹½»tCİyA¼ay
(
sockaddr_un_out
.
sun_·th
,

730 
bridge_addr
->
addr_un
.
sun_·th
,

731 
bridge_addr
->
addr_un
.
Ën
 - (
çmy
));

732  
CİySockaddr
(&
sockaddr_un_out
, 
bridge_addr
->
addr_un
.
Ën
, 
addr
,

733 
add¾’
);

734 } ià(
	gçmy
 =ğ
AF_INET6
) {

735 
sockaddr_š6
 
sockaddr_š6_out
;

736 
	gsockaddr_š6_out
.
	gsš6_çmy
 = 
çmy
;

737 
	gsockaddr_š6_out
.
	gsš6_pÜt
 = 
bridge_addr
->
addr_š6
.
sš6_pÜt
;

738 
	gsockaddr_š6_out
.
	gsš6_æowšfo
 = 
bridge_addr
->
addr_š6
.
sš6_æowšfo
;

739 
In™ŸlizeToZ”oSšgË
(&
sockaddr_š6_out
.
sš6_addr
);

740 
Reš‹½»tCİySšgË
(&
sockaddr_š6_out
.
sš6_addr
,

741 &
bridge_addr
->
addr_š6
.
sš6_addr
);

742 
	gsockaddr_š6_out
.
	gsš6_scİe_id
 = 
bridge_addr
->
addr_š6
.
sš6_scİe_id
;

743  
CİySockaddr
(&
sockaddr_š6_out
, (sockaddr_š6_out), 
addr
,

744 
add¾’
);

745 } ià(
	gçmy
 =ğ
AF_INET
) {

746 
sockaddr_š
 
sockaddr_š_out
;

747 
	gsockaddr_š_out
.
	gsš_çmy
 = 
çmy
;

748 
	gsockaddr_š_out
.
	gsš_pÜt
 = 
bridge_addr
->
addr_š
.
sš_pÜt
;

749 
In™ŸlizeToZ”oSšgË
(&
sockaddr_š_out
.
sš_addr
);

750 
Reš‹½»tCİySšgË
(&
sockaddr_š_out
.
sš_addr
,

751 &
bridge_addr
->
addr_š
.
sš_addr
);

752 
In™ŸlizeToZ”oA¼ay
(
sockaddr_š_out
.
sš_z”o
);

753 
Reš‹½»tCİyA¼ay
(
sockaddr_š_out
.
sš_z”o
,

754 
bridge_addr
->
addr_š
.
sš_z”o
);

755  
CİySockaddr
(&
sockaddr_š_out
, (sockaddr_š_out), 
addr
,

756 
add¾’
);

757 } ià(
	gçmy
 =ğ
AF_UNSPEC
) {

758 
sockaddr
 
sockaddr_out
;

759 
	gsockaddr_out
.
	g§_çmy
 = 
çmy
;

760  
CİySockaddr
(&
sockaddr_out
, (sockaddr_out), 
addr
, 
add¾’
);

762 
LOG
(
ERROR
è<< "sockadd¸çmy i nÙ suµÜ‹d: " << 
	gçmy
;

763 
abÜt
();

767 
bridge_sockaddr
 *
ToBridgeSockaddr
(cÚ¡ 
sockaddr
 *
addr
,

768 
sockËn_t
 
add¾’
,

769 
bridge_sockaddr
 *
bridge_addr
) {

770 ià(!
	gaddr
 || !
	gbridge_addr
è 
	gnuÎ±r
;

771 
	gbridge_addr
->
	g§_çmy
 = 
ToBridgeAfFamy
(
addr
->
§_çmy
);

772 ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_UNSUPPORTED
) {

773  
nuÎ±r
;

775 ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_UNIX
 ||

776 
bridge_addr
->
§_çmy
 =ğ
BRIDGE_AF_LOCAL
) {

777 
sockaddr_un
 *
sockaddr_un_š
 = 
cÚ¡_ÿ¡
<sockaddr_un *>(

778 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_un
 *>(
addr
));

779 
In™ŸlizeToZ”oA¼ay
(
bridge_addr
->
addr_un
.
sun_·th
);

780 ià(
	gadd¾’
 <ğ(
bridge_addr
->
§_çmy
)) {

781  
nuÎ±r
;

783 
Reš‹½»tCİyA¼ay
(
bridge_addr
->
addr_un
.
sun_·th
,

784 
sockaddr_un_š
->
sun_·th
,

785 
add¾’
 - (
bridge_addr
->
§_çmy
));

786 
	gbridge_addr
->
	gaddr_un
.
	gËn
 = 
add¾’
;

787 } ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_INET6
) {

788 ià(
add¾’
 < (
sockaddr_š6
)) {

789  
nuÎ±r
;

791 
sockaddr_š6
 *
	gsockaddr_š6_š
 = 
cÚ¡_ÿ¡
<sockaddr_in6 *>(

792 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
addr
));

793 
	gbridge_addr
->
	gaddr_š6
.
	gsš6_pÜt
 = 
sockaddr_š6_š
->
sš6_pÜt
;

794 
	gbridge_addr
->
	gaddr_š6
.
	gsš6_æowšfo
 = 
sockaddr_š6_š
->
sš6_æowšfo
;

795 
In™ŸlizeToZ”oSšgË
(&
bridge_addr
->
addr_š6
.
sš6_addr
);

796 
Reš‹½»tCİySšgË
(&
bridge_addr
->
addr_š6
.
sš6_addr
,

797 &
sockaddr_š6_š
->
sš6_addr
);

798 
	gbridge_addr
->
	gaddr_š6
.
	gsš6_scİe_id
 = 
sockaddr_š6_š
->
sš6_scİe_id
;

799 } ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_INET
) {

800 ià(
add¾’
 < (
sockaddr_š
)) {

801  
nuÎ±r
;

803 
sockaddr_š
 *
	gsockaddr_š_š
 = 
cÚ¡_ÿ¡
<sockaddr_in *>(

804 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
addr
));

805 
	gbridge_addr
->
	gaddr_š
.
	gsš_pÜt
 = 
sockaddr_š_š
->
sš_pÜt
;

806 
In™ŸlizeToZ”oSšgË
(&
bridge_addr
->
addr_š
.
sš_addr
);

807 
Reš‹½»tCİySšgË
(&
bridge_addr
->
addr_š
.
sš_addr
,

808 &
sockaddr_š_š
->
sš_addr
);

809 
In™ŸlizeToZ”oA¼ay
(
bridge_addr
->
addr_š
.
sš_z”o
);

810 
Reš‹½»tCİyA¼ay
(
bridge_addr
->
addr_š
.
sš_z”o
,

811 
sockaddr_š_š
->
sš_z”o
);

812 } ià(
	gbridge_addr
->
	g§_çmy
 =ğ
BRIDGE_AF_UNSPEC
) {

815 
LOG
(
ERROR
) << "sockaddr family is‚ot supported: "

816 << 
bridge_addr
->
§_çmy
;

817 
abÜt
();

819  
	gbridge_addr
;

822 
FromBridgeAdd»ssInfoE¼Üs
(
bridge_—i_code
) {

823 
	gbridge_—i_code
) {

824 
	gBRIDGE_EAI_SUCCESS
:

826 
	gBRIDGE_EAI_ADDRFAMILY
:

827  
EAI_ADDRFAMILY
;

828 
	gBRIDGE_EAI_BADFLAGS
:

829  
EAI_BADFLAGS
;

830 
	gBRIDGE_EAI_NONAME
:

831  
EAI_NONAME
;

832 
	gBRIDGE_EAI_AGAIN
:

833  
EAI_AGAIN
;

834 
	gBRIDGE_EAI_FAIL
:

835  
EAI_FAIL
;

836 
	gBRIDGE_EAI_FAMILY
:

837  
EAI_FAMILY
;

838 
	gBRIDGE_EAI_MEMORY
:

839  
EAI_MEMORY
;

840 
	gBRIDGE_EAI_NODATA
:

841  
EAI_NODATA
;

842 
	gBRIDGE_EAI_SERVICE
:

843  
EAI_SERVICE
;

844 
	gBRIDGE_EAI_SOCKTYPE
:

845  
EAI_SOCKTYPE
;

846 
	gBRIDGE_EAI_OVERFLOW
:

847  
EAI_OVERFLOW
;

848 
	gBRIDGE_EAI_INPROGRESS
:

849  
EAI_INPROGRESS
;

850 
	gBRIDGE_EAI_CANCELED
:

851  
EAI_CANCELED
;

852 
	gBRIDGE_EAI_ALLDONE
:

853  
EAI_ALLDONE
;

854 
	gBRIDGE_EAI_SYSTEM
:

855  
EAI_SYSTEM
;

861 
ToBridgeAdd»ssInfoE¼Üs
(
—i_code
) {

862 
	g—i_code
) {

864  
BRIDGE_EAI_SUCCESS
;

865 
	gEAI_BADFLAGS
:

866  
BRIDGE_EAI_BADFLAGS
;

867 
	gEAI_NONAME
:

868  
BRIDGE_EAI_NONAME
;

869 
	gEAI_AGAIN
:

870  
BRIDGE_EAI_AGAIN
;

871 
	gEAI_FAIL
:

872  
BRIDGE_EAI_FAIL
;

873 
	gEAI_FAMILY
:

874  
BRIDGE_EAI_FAMILY
;

875 
	gEAI_SOCKTYPE
:

876  
BRIDGE_EAI_SOCKTYPE
;

877 
	gEAI_SERVICE
:

878  
BRIDGE_EAI_SERVICE
;

879 
	gEAI_MEMORY
:

880  
BRIDGE_EAI_MEMORY
;

881 
	gEAI_SYSTEM
:

882  
BRIDGE_EAI_SYSTEM
;

883 
	gEAI_OVERFLOW
:

884  
BRIDGE_EAI_OVERFLOW
;

885 
	gEAI_NODATA
:

886  
BRIDGE_EAI_NODATA
;

887 
	gEAI_ADDRFAMILY
:

888  
BRIDGE_EAI_ADDRFAMILY
;

889 
	gEAI_INPROGRESS
:

890  
BRIDGE_EAI_INPROGRESS
;

891 
	gEAI_CANCELED
:

892  
BRIDGE_EAI_CANCELED
;

893 
	gEAI_ALLDONE
:

894  
BRIDGE_EAI_ALLDONE
;

895 
	gEAI_INTR
:

896  
BRIDGE_EAI_IDN_ENCODE
;

898  
BRIDGE_EAI_UNKNOWN
;

902 
AfFamy
 
ToBridgeAfFamy
(
af_çmy
) {

905 ià(
	gaf_çmy
 =ğ
AF_UNIX
è 
BRIDGE_AF_UNIX
;

906 ià(
	gaf_çmy
 =ğ
AF_LOCAL
è 
BRIDGE_AF_LOCAL
;

907 
	gaf_çmy
) {

908 
	gAF_INET
:

909  
BRIDGE_AF_INET
;

910 
	gAF_INET6
:

911  
BRIDGE_AF_INET6
;

912 
	gAF_UNSPEC
:

913  
BRIDGE_AF_UNSPEC
;

914 
	gAF_IPX
:

915  
BRIDGE_AF_IPX
;

916 
	gAF_NETLINK
:

917  
BRIDGE_AF_NETLINK
;

918 
	gAF_X25
:

919  
BRIDGE_AF_X25
;

920 
	gAF_AX25
:

921  
BRIDGE_AF_AX25
;

922 
	gAF_ATMPVC
:

923  
BRIDGE_AF_ATMPVC
;

924 
	gAF_APPLETALK
:

925  
BRIDGE_AF_APPLETALK
;

926 
	gAF_PACKET
:

927  
BRIDGE_AF_PACKET
;

928 
	gAF_ALG
:

929  
BRIDGE_AF_ALG
;

931 
LOG
(
ERROR
è<< "UnsuµÜ‹d‡dd»s çmy: " << 
af_çmy
;

932  
	gBRIDGE_AF_UNSUPPORTED
;

936 
FromBridgeAfFamy
(
bridge_af_çmy
) {

937 
	gbridge_af_çmy
) {

938 
	gBRIDGE_AF_INET
:

939  
AF_INET
;

940 
	gBRIDGE_AF_INET6
:

941  
AF_INET6
;

942 
	gBRIDGE_AF_UNSPEC
:

943  
AF_UNSPEC
;

944 
	gBRIDGE_AF_UNIX
:

945  
AF_UNIX
;

946 
	gBRIDGE_AF_LOCAL
:

947  
AF_LOCAL
;

948 
	gBRIDGE_AF_IPX
:

949  
AF_IPX
;

950 
	gBRIDGE_AF_NETLINK
:

951  
AF_NETLINK
;

952 
	gBRIDGE_AF_X25
:

953  
AF_X25
;

954 
	gBRIDGE_AF_AX25
:

955  
AF_AX25
;

956 
	gBRIDGE_AF_ATMPVC
:

957  
AF_ATMPVC
;

958 
	gBRIDGE_AF_APPLETALK
:

959  
AF_APPLETALK
;

960 
	gBRIDGE_AF_PACKET
:

961  
AF_PACKET
;

962 
	gBRIDGE_AF_ALG
:

963  
AF_ALG
;

965  
AF_UNSPEC
;

969 
FromBridgeSock‘Ty³
(
bridge_sock_ty³
) {

970 
	gsock_ty³
 = 0;

971 
	g’um_b™s
 = 
bridge_sock_ty³
 & (~
BRIDGE_SOCK_TYPE_FLAGS
);

972 
	g’um_b™s
) {

973 
	gBRIDGE_SOCK_STREAM
:

974 
sock_ty³
 = 
SOCK_STREAM
;

976 
	gBRIDGE_SOCK_DGRAM
:

977 
sock_ty³
 = 
SOCK_DGRAM
;

979 
	gBRIDGE_SOCK_SEQPACKET
:

980 
sock_ty³
 = 
SOCK_SEQPACKET
;

982 
	gBRIDGE_SOCK_RAW
:

983 
sock_ty³
 = 
SOCK_RAW
;

985 
	gBRIDGE_SOCK_RDM
:

986 
sock_ty³
 = 
SOCK_RDM
;

988 
	gBRIDGE_SOCK_PACKET
:

989 
sock_ty³
 = 
SOCK_PACKET
;

994 ià(
	gbridge_sock_ty³
 & 
	gBRIDGE_SOCK_O_NONBLOCK
è
	gsock_ty³
 |ğ
SOCK_NONBLOCK
;

995 ià(
	gbridge_sock_ty³
 & 
	gBRIDGE_SOCK_O_CLOEXEC
è
	gsock_ty³
 |ğ
SOCK_CLOEXEC
;

996  
	gsock_ty³
;

999 
ToBridgeSock‘Ty³
(
sock_ty³
) {

1000 
cÚ¡ex´
 
	gkSockTy³FÏgMask
 = ~(
SOCK_CLOEXEC
 | 
SOCK_NONBLOCK
);

1001 
	gbridge_sock_ty³
 = 0;

1002 
	g’um_b™s
 = 
sock_ty³
 & 
kSockTy³FÏgMask
;

1003 
	g’um_b™s
) {

1004 
	gSOCK_STREAM
:

1005 
bridge_sock_ty³
 = 
BRIDGE_SOCK_STREAM
;

1007 
	gSOCK_DGRAM
:

1008 
bridge_sock_ty³
 = 
BRIDGE_SOCK_DGRAM
;

1010 
	gSOCK_SEQPACKET
:

1011 
bridge_sock_ty³
 = 
BRIDGE_SOCK_SEQPACKET
;

1013 
	gSOCK_RAW
:

1014 
bridge_sock_ty³
 = 
BRIDGE_SOCK_RAW
;

1016 
	gSOCK_RDM
:

1017 
bridge_sock_ty³
 = 
BRIDGE_SOCK_RDM
;

1019 
	gSOCK_PACKET
:

1020 
bridge_sock_ty³
 = 
BRIDGE_SOCK_PACKET
;

1023  
BRIDGE_SOCK_UNSUPPORTED
;

1025 ià(
	gsock_ty³
 & 
	gSOCK_NONBLOCK
è
	gbridge_sock_ty³
 |ğ
BRIDGE_SOCK_O_NONBLOCK
;

1026 ià(
	gsock_ty³
 & 
	gSOCK_CLOEXEC
è
	gbridge_sock_ty³
 |ğ
BRIDGE_SOCK_O_CLOEXEC
;

1027  
	gbridge_sock_ty³
;

1030 
pŞlfd
 *
FromBridgePŞlfd
(cÚ¡ 
bridge_pŞlfd
 *
bridge_fd
,

1031 
pŞlfd
 *
fd
) {

1032 ià(!
	gbridge_fd
 || !
	gfd
è 
	gnuÎ±r
;

1033 
	gfd
->fd = 
bridge_fd
->
fd
;

1034 
	gfd
->
	gev’ts
 = 
FromBridgePŞlEv’ts
(
bridge_fd
->
ev’ts
);

1035 
	gfd
->
	g»v’ts
 = 
FromBridgePŞlEv’ts
(
bridge_fd
->
»v’ts
);

1036  
	gfd
;

1039 
bridge_pŞlfd
 *
ToBridgePŞlfd
(cÚ¡ 
pŞlfd
 *
fd
,

1040 
bridge_pŞlfd
 *
bridge_fd
) {

1041 ià(!
	gfd
 || !
	gbridge_fd
è 
	gnuÎ±r
;

1042 
	gbridge_fd
->
	gfd
 = 
fd
->fd;

1043 
	gbridge_fd
->
	gev’ts
 = 
ToBridgePŞlEv’ts
(
fd
->
ev’ts
);

1044 
	gbridge_fd
->
	g»v’ts
 = 
ToBridgePŞlEv’ts
(
fd
->
»v’ts
);

1045  
	gbridge_fd
;

1048 
msghdr
 *
FromBridgeMsgHdr
(cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

1049 
msghdr
 *
msg
) {

1050 ià(!
	gbridge_msg
 || !
	gmsg
è 
	gnuÎ±r
;

1051 
	gmsg
->
	gmsg_Çme
 = 
bridge_msg
->
msg_Çme
;

1052 
	gmsg
->
	gmsg_Çm–’
 = 
bridge_msg
->
msg_Çm–’
;

1053 
	gmsg
->
	gmsg_iov
 = 
»š‹½»t_ÿ¡
<
iovec
 *>(
bridge_msg
->
msg_iov
);

1054 
	gmsg
->
	gmsg_iovËn
 = 
bridge_msg
->
msg_iovËn
;

1055 
	gmsg
->
	gmsg_cÚŒŞ
 = 
bridge_msg
->
msg_cÚŒŞ
;

1056 
	gmsg
->
	gmsg_cÚŒŞËn
 = 
bridge_msg
->
msg_cÚŒŞËn
;

1057 
	gmsg
->
	gmsg_æags
 = 
bridge_msg
->
msg_æags
;

1058  
	gmsg
;

1061 
bridge_msghdr
 *
ToBridgeMsgHdr
(cÚ¡ 
msghdr
 *
msg
,

1062 
bridge_msghdr
 *
bridge_msg
) {

1063 ià(!
	gmsg
 || !
	gbridge_msg
è 
	gnuÎ±r
;

1064 
	gbridge_msg
->
	gmsg_Çme
 = 
msg
->
msg_Çme
;

1065 
	gbridge_msg
->
	gmsg_Çm–’
 = 
msg
->
msg_Çm–’
;

1066 
	gbridge_msg
->
	gmsg_iov
 = 
»š‹½»t_ÿ¡
<
bridge_iovec
 *>(
msg
->
msg_iov
);

1067 
	gbridge_msg
->
	gmsg_iovËn
 = 
msg
->
msg_iovËn
;

1068 
	gbridge_msg
->
	gmsg_cÚŒŞ
 = 
msg
->
msg_cÚŒŞ
;

1069 
	gbridge_msg
->
	gmsg_cÚŒŞËn
 = 
msg
->
msg_cÚŒŞËn
;

1070 
	gbridge_msg
->
	gmsg_æags
 = 
msg
->
msg_æags
;

1071  
	gbridge_msg
;

1074 
msghdr
 *
FromBridgeIovecA¼ay
(cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

1075 
msghdr
 *
msg
) {

1076 ià(!
	gbridge_msg
 || !
	gmsg
è 
	gnuÎ±r
;

1077 
ušt64_t
 
	gi
 = 0; i < 
	gbridge_msg
->
	gmsg_iovËn
; ++i) {

1078 
memıy
(
msg
->
msg_iov
[
i
].
iov_ba£
, 
bridge_msg
->msg_iov[i].iov_base,

1079 
bridge_msg
->
msg_iov
[
i
].
iov_Ën
);

1081  
	gmsg
;

1084 
bridge_msghdr
 *
ToBridgeIovecA¼ay
(cÚ¡ 
msghdr
 *
msg
,

1085 
bridge_msghdr
 *
bridge_msg
) {

1086 ià(!
	gmsg
 || !
	gbridge_msg
è 
	gnuÎ±r
;

1087 
ušt64_t
 
	gi
 = 0; i < 
	gmsg
->
	gmsg_iovËn
; ++i) {

1088 
memıy
(
bridge_msg
->
msg_iov
[
i
].
iov_ba£
, 
msg
->msg_iov[i].iov_base,

1089 
msg
->
msg_iov
[
i
].
iov_Ën
);

1091  
	gbridge_msg
;

1094 
iovec
 *
FromBridgeIovec
(cÚ¡ 
bridge_iovec
 *
bridge_iov
,

1095 
iovec
 *
iov
) {

1096 ià(!
	gbridge_iov
 || !
	giov
è 
	gnuÎ±r
;

1097 
	giov
->
	giov_ba£
 = 
bridge_iov
->
iov_ba£
;

1098 
	giov
->
	giov_Ën
 = 
bridge_iov
->
iov_Ën
;

1099  
	giov
;

1102 
bridge_iovec
 *
ToBridgeIovec
(cÚ¡ 
iovec
 *
iov
,

1103 
bridge_iovec
 *
bridge_iov
) {

1104 ià(!
	giov
 || !
	gbridge_iov
è 
	gnuÎ±r
;

1105 
	gbridge_iov
->
	giov_ba£
 = 
iov
->
iov_ba£
;

1106 
	gbridge_iov
->
	giov_Ën
 = 
iov
->
iov_Ën
;

1107  
	gbridge_iov
;

1110 
tms
 *
FromBridgeTms
(cÚ¡ 
BridgeTms
 *
bridge_times
,

1111 
tms
 *
times
) {

1112 ià(!
	gbridge_times
 || !
	gtimes
è 
	gnuÎ±r
;

1113 
	gtimes
->
	gtms_utime
 = 
bridge_times
->
tms_utime
;

1114 
	gtimes
->
	gtms_¡ime
 = 
bridge_times
->
tms_¡ime
;

1115 
	gtimes
->
	gtms_cutime
 = 
bridge_times
->
tms_cutime
;

1116 
	gtimes
->
	gtms_c¡ime
 = 
bridge_times
->
tms_c¡ime
;

1117  
	gtimes
;

1120 
BridgeTms
 *
ToBridgeTms
(cÚ¡ 
tms
 *
times
,

1121 
BridgeTms
 *
bridge_times
) {

1122 ià(!
	gtimes
 || !
	gbridge_times
è 
	gnuÎ±r
;

1123 
	gbridge_times
->
	gtms_utime
 = 
times
->
tms_utime
;

1124 
	gbridge_times
->
	gtms_¡ime
 = 
times
->
tms_¡ime
;

1125 
	gbridge_times
->
	gtms_cutime
 = 
times
->
tms_cutime
;

1126 
	gbridge_times
->
	gtms_c¡ime
 = 
times
->
tms_c¡ime
;

1127  
	gbridge_times
;

1130 
time¥ec
 *
FromBridgeTime¥ec
(cÚ¡ 
bridge_time¥ec
 *
bridge_
,

1131 
time¥ec
 *

) {

1132 
	g
->
	gtv_£c
 = 
bridge_
->
tv_£c
;

1133 
	g
->
	gtv_n£c
 = 
bridge_
->
tv_n£c
;

1134  
	g
;

1137 
bridge_time¥ec
 *
ToBridgeTime¥ec
(cÚ¡ 
time¥ec
 *

,

1138 
bridge_time¥ec
 *
bridge_
) {

1139 
	gbridge_
->
	gtv_£c
 = 

->
tv_£c
;

1140 
	gbridge_
->
	gtv_n£c
 = 

->
tv_n£c
;

1141  
	gbridge_
;

1144 
utimbuf
 *
FromBridgeUtimbuf
(cÚ¡ 
bridge_utimbuf
 *
bridge_ut
,

1145 
utimbuf
 *
ut
) {

1146 ià(!
	gut
 || !
	gbridge_ut
è 
	gnuÎ±r
;

1147 
	gut
->
	gaùime
 = 
bridge_ut
->
aùime
;

1148 
	gut
->
	gmodtime
 = 
bridge_ut
->
modtime
;

1149  
	gut
;

1152 
bridge_utimbuf
 *
ToBridgeUtimbuf
(cÚ¡ 
utimbuf
 *
ut
,

1153 
bridge_utimbuf
 *
bridge_ut
) {

1154 ià(!
	gut
 || !
	gbridge_ut
è 
	gnuÎ±r
;

1155 
	gbridge_ut
->
	gaùime
 = 
ut
->
aùime
;

1156 
	gbridge_ut
->
	gmodtime
 = 
ut
->
modtime
;

1157  
	gbridge_ut
;

1160 
timev®
 *
FromBridgeTimeV®
(cÚ¡ 
bridge_timev®
 *
bridge_tv
,

1161 
timev®
 *
tv
) {

1162 ià(!
	gbridge_tv
 || !
	gtv
è 
	gnuÎ±r
;

1163 
	gtv
->
	gtv_£c
 = 
bridge_tv
->
tv_£c
;

1164 
	gtv
->
	gtv_u£c
 = 
bridge_tv
->
tv_u£c
;

1165  
	gtv
;

1168 
bridge_timev®
 *
ToBridgeTimeV®
(cÚ¡ 
timev®
 *
tv
,

1169 
bridge_timev®
 *
bridge_tv
) {

1170 ià(!
	gtv
 || !
	gbridge_tv
è 
	gnuÎ±r
;

1171 
	gbridge_tv
->
	gtv_£c
 = 
tv
->
tv_£c
;

1172 
	gbridge_tv
->
	gtv_u£c
 = 
tv
->
tv_u£c
;

1173  
	gbridge_tv
;

1176 
™im”v®
 *
FromBridgeITim”V®
(

1177 cÚ¡ 
BridgeITim”V®
 *
bridge_tim”v®
, 
™im”v®
 *
tim”v®
) {

1178 ià(!
	gbridge_tim”v®
 || !
	gtim”v®
è 
	gnuÎ±r
;

1179 
FromBridgeTimeV®
(&
bridge_tim”v®
->
™_š‹rv®
, &
tim”v®
->it_interval);

1180 
FromBridgeTimeV®
(&
bridge_tim”v®
->
™_v®ue
, &
tim”v®
->it_value);

1181  
	gtim”v®
;

1184 
BridgeITim”V®
 *
ToBridgeITim”V®
(

1185 cÚ¡ 
™im”v®
 *
tim”v®
, 
BridgeITim”V®
 *
bridge_tim”v®
) {

1186 ià(!
	gtim”v®
 || !
	gbridge_tim”v®
è 
	gnuÎ±r
;

1187 
ToBridgeTimeV®
(&
tim”v®
->
™_š‹rv®
, &
bridge_tim”v®
->it_interval);

1188 
ToBridgeTimeV®
(&
tim”v®
->
™_v®ue
, &
bridge_tim”v®
->it_value);

1189  
	gbridge_tim”v®
;

1192 
FromBridgeWStus
(
BridgeWStus
 
bridge_w¡©us
) {

1193 
	gw¡©us
 = 
¡©ic_ÿ¡
<>(
bridge_w¡©us
.
šfo
) << 8;

1194 ià(
BridgeWIfEx™ed
(
bridge_w¡©us
)) {

1195  
	gw¡©us
;

1197 ià(
BridgeWIfStİ³d
(
bridge_w¡©us
)) {

1198  
	gw¡©us
 + 
	gBRIDGE_WSTOPPED
;

1200  
	gw¡©us
 + 
	gbridge_w¡©us
.
	gcode
;

1203 
BridgeWStus
 
ToBridgeWStus
(
w¡©us
) {

1204 
BridgeWStus
 
	gbridge_w¡©us
;

1207 
	gbridge_w¡©us
.
	gšfo
 = 
w¡©us
 >> 8 & 0xff;

1208 ià(
WIFEXITED
(
w¡©us
)) {

1209 
	gbridge_w¡©us
.
	gcode
 = 0;

1210 } ià(
WIFSTOPPED
(
w¡©us
)) {

1211 
	gbridge_w¡©us
.
	gcode
 = 
BRIDGE_WSTOPPED
;

1213 
	gbridge_w¡©us
.
	gcode
 = 
w¡©us
 & 
BRIDGE_WSTOPPED
;

1215  
	gbridge_w¡©us
;

1218 
ru§ge
 *
FromBridgeRU§ge
(cÚ¡ 
BridgeRU§ge
 *
bridge_ru§ge
,

1219 
ru§ge
 *rusage) {

1220 ià(!
	gbridge_ru§ge
 || !
	gru§ge
è 
	gnuÎ±r
;

1221 
FromBridgeTimeV®
(&
bridge_ru§ge
->
ru_utime
, &
ru§ge
->ru_utime);

1222 
FromBridgeTimeV®
(&
bridge_ru§ge
->
ru_¡ime
, &
ru§ge
->ru_stime);

1223  
	gru§ge
;

1226 
BridgeRU§ge
 *
ToBridgeRU§ge
(cÚ¡ 
ru§ge
 *rusage,

1227 
BridgeRU§ge
 *
bridge_ru§ge
) {

1228 ià(!
	gru§ge
 || !
	gbridge_ru§ge
è 
	gnuÎ±r
;

1229 
ToBridgeTimeV®
(&
ru§ge
->
ru_utime
, &
bridge_ru§ge
->ru_utime);

1230 
ToBridgeTimeV®
(&
ru§ge
->
ru_¡ime
, &
bridge_ru§ge
->ru_stime);

1231  
	gbridge_ru§ge
;

1234 
fd_£t
 *
FromBridgeFDS‘
(cÚ¡ 
BridgeFDS‘
 *
bridge_fds
, fd_£ˆ*
fds
) {

1235 ià(!
	gbridge_fds
 || !
	gfds
è 
	gnuÎ±r
;

1236 
FD_ZERO
(
fds
);

1237 
	gfd
 = 0; fd < 
	g¡d
::
mš
(
FD_SETSIZE
, 
BRIDGE_FD_SETSIZE
); ++fd) {

1238 ià(
BridgeFDIsS‘
(
fd
, 
bridge_fds
)) {

1239 
FD_SET
(
fd
, 
fds
);

1242  
	gfds
;

1245 
BridgeFDS‘
 *
ToBridgeFDS‘
(cÚ¡ 
fd_£t
 *
fds
,

1246 
BridgeFDS‘
 *
bridge_fds
) {

1247 ià(!
	gfds
 || !
	gbridge_fds
è 
	gnuÎ±r
;

1248 
BridgeFDZ”o
(
bridge_fds
);

1249 
	gfd
 = 0; fd < 
	g¡d
::
mš
(
FD_SETSIZE
, 
BRIDGE_FD_SETSIZE
); ++fd) {

1250 ià(
FD_ISSET
(
fd
, 
fds
)) {

1251 
BridgeFDS‘
(
fd
, 
bridge_fds
);

1254  
	gbridge_fds
;

1257 
šlše
 
ušt64_t
 
BridgeWÜdNum
(
ıu
) {

1258  
	gıu
 / (8 * (
	gBridgeCpuS‘WÜd
));

1261 
šlše
 
BridgeCpuS‘WÜd
 
BridgeB™Num
(
ıu
) {

1262  
	gıu
 % (8 * (
	gBridgeCpuS‘WÜd
));

1268 
BridgeCpuS‘Z”o
(
BridgeCpuS‘
 *
£t
) {

1269 
mem£t
(
£t
->
wÜds
, 0, 
BRIDGE_CPU_SET_NUM_WORDS
 * (
BridgeCpuS‘WÜd
));

1272 
BridgeCpuS‘AddB™
(
ıu
, 
BridgeCpuS‘
 *
£t
) {

1273 
	g£t
->
	gwÜds
[
BridgeWÜdNum
(
ıu
)] |ğ
¡©ic_ÿ¡
<
BridgeCpuS‘WÜd
>(1)

1274 << 
BridgeB™Num
(
ıu
);

1277 
BridgeCpuS‘CheckB™
(
ıu
, 
BridgeCpuS‘
 *
£t
) {

1278  (
	g£t
->
	gwÜds
[
BridgeWÜdNum
(
ıu
)] &

1279 (
	g¡©ic_ÿ¡
<
	gBridgeCpuS‘WÜd
>(1è<< 
BridgeB™Num
(
ıu
)))

1284 
boŞ
 
CSŒšgCİy
(cÚ¡ *
sourû_buf
, *
de¡_buf
, 
size_t
 
size
) {

1285 
	g»t
 = 
¢´štf
(
de¡_buf
, 
size
, "%s", 
sourû_buf
);

1286  
	g»t
 >ğ0 && 
¡©ic_ÿ¡
<
size_t
>(
»t
è< 
size
;

1289 
·sswd
 *
FromBridgePassWd
(
BridgePassWd
 *
bridge_·sswÜd
,

1290 
·sswd
 *
·sswÜd
) {

1291 ià(!
	gbridge_·sswÜd
 || !
	g·sswÜd
) {

1292  
	gnuÎ±r
;

1295 
	g·sswÜd
->
	gpw_Çme
 = 
bridge_·sswÜd
->
pw_Çme
;

1296 
	g·sswÜd
->
	gpw_·sswd
 = 
bridge_·sswÜd
->
pw_·sswd
;

1297 
	g·sswÜd
->
	gpw_uid
 = 
bridge_·sswÜd
->
pw_uid
;

1298 
	g·sswÜd
->
	gpw_gid
 = 
bridge_·sswÜd
->
pw_gid
;

1299 
	g·sswÜd
->
	gpw_gecos
 = 
bridge_·sswÜd
->
pw_gecos
;

1300 
	g·sswÜd
->
	gpw_dœ
 = 
bridge_·sswÜd
->
pw_dœ
;

1301 
	g·sswÜd
->
	gpw_sh–l
 = 
bridge_·sswÜd
->
pw_sh–l
;

1303  
	g·sswÜd
;

1306 
BridgePassWd
 *
ToBridgePassWd
(cÚ¡ 
·sswd
 *
·sswÜd
,

1307 
BridgePassWd
 *
bridge_·sswÜd
) {

1308 ià(!
	g·sswÜd
 || !
	gbridge_·sswÜd
) {

1309  
	gnuÎ±r
;

1312 
	gbridge_·sswÜd
->
	gpw_uid
 = 
·sswÜd
->
pw_uid
;

1313 
	gbridge_·sswÜd
->
	gpw_gid
 = 
·sswÜd
->
pw_gid
;

1315 ià(!
CSŒšgCİy
(
·sswÜd
->
pw_Çme
, 
bridge_·sswÜd
->pw_name,

1316 (
bridge_·sswÜd
->
pw_Çme
)) ||

1317 !
CSŒšgCİy
(
·sswÜd
->
pw_·sswd
, 
bridge_·sswÜd
->pw_passwd,

1318 (
bridge_·sswÜd
->
pw_·sswd
)) ||

1319 !
CSŒšgCİy
(
·sswÜd
->
pw_gecos
, 
bridge_·sswÜd
->pw_gecos,

1320 (
bridge_·sswÜd
->
pw_gecos
)) ||

1321 !
CSŒšgCİy
(
·sswÜd
->
pw_dœ
, 
bridge_·sswÜd
->pw_dir,

1322 (
bridge_·sswÜd
->
pw_dœ
)) ||

1323 !
CSŒšgCİy
(
·sswÜd
->
pw_sh–l
, 
bridge_·sswÜd
->pw_shell,

1324 (
bridge_·sswÜd
->
pw_sh–l
))) {

1325  
	gnuÎ±r
;

1328  
	gbridge_·sswÜd
;

1331 
BridgePassWd
 *
CİyBridgePassWd
(

1332 cÚ¡ 
BridgePassWd
 *
sourû_bridge_·sswÜd
,

1333 
BridgePassWd
 *
de¡š©iÚ_bridge_·sswÜd
) {

1334 ià(!
	gsourû_bridge_·sswÜd
 || !
	gde¡š©iÚ_bridge_·sswÜd
) {

1335  
	gnuÎ±r
;

1338 
	gde¡š©iÚ_bridge_·sswÜd
->
	gpw_uid
 = 
sourû_bridge_·sswÜd
->
pw_uid
;

1339 
	gde¡š©iÚ_bridge_·sswÜd
->
	gpw_gid
 = 
sourû_bridge_·sswÜd
->
pw_gid
;

1341 ià(!
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_Çme
,

1342 
de¡š©iÚ_bridge_·sswÜd
->
pw_Çme
,

1343 (
de¡š©iÚ_bridge_·sswÜd
->
pw_Çme
)) ||

1344 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_·sswd
,

1345 
de¡š©iÚ_bridge_·sswÜd
->
pw_·sswd
,

1346 (
de¡š©iÚ_bridge_·sswÜd
->
pw_·sswd
)) ||

1347 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_gecos
,

1348 
de¡š©iÚ_bridge_·sswÜd
->
pw_gecos
,

1349 (
de¡š©iÚ_bridge_·sswÜd
->
pw_gecos
)) ||

1350 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_dœ
,

1351 
de¡š©iÚ_bridge_·sswÜd
->
pw_dœ
,

1352 (
de¡š©iÚ_bridge_·sswÜd
->
pw_dœ
)) ||

1353 !
CSŒšgCİy
(
sourû_bridge_·sswÜd
->
pw_sh–l
,

1354 
de¡š©iÚ_bridge_·sswÜd
->
pw_sh–l
,

1355 (
de¡š©iÚ_bridge_·sswÜd
->
pw_sh–l
))) {

1356  
	gnuÎ±r
;

1359  
	gde¡š©iÚ_bridge_·sswÜd
;

	@platform/common/bridge_functions.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_BRIDGE_FUNCTIONS_H_


20 
	#ASYLO_PLATFORM_COMMON_BRIDGE_FUNCTIONS_H_


	)

22 
	~<Ãtdb.h
>

23 
	~<Ãtš‘/tı.h
>

24 
	~<pŞl.h
>

25 
	~<pwd.h
>

26 
	~<sys/»sourû.h
>

27 
	~<sys/sock‘.h
>

28 
	~<sys/¡©.h
>

29 
	~<sys/time.h
>

30 
	~<sys/times.h
>

31 
	~<sys/ty³s.h
>

32 
	~<sys/wa™.h
>

33 
	~<sy¦og.h
>

34 
	~<utime.h
>

36 
	~<csigÇl
>

37 
	~<c¡dšt
>

39 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

41 
Çme¥aû
 
	gasylo
 {

45 
FromBridgeFLockO³¿tiÚ
(
bridge_æock_İ”©iÚ
);

49 
ToBridgeFLockO³¿tiÚ
(
æock_İ”©iÚ
);

53 
FromBridgeSyscÚfCÚ¡ªts
(
SyscÚfCÚ¡ªts
 
bridge_syscÚf_cÚ¡ªt
);

57 
SyscÚfCÚ¡ªts
 
ToBridgeSyscÚfCÚ¡ªts
(
syscÚf_cÚ¡ªt
);

61 
FromBridgeTim”Ty³
(
Tim”Ty³
 
bridge_tim”_ty³
);

65 
Tim”Ty³
 
ToBridgeTim”Ty³
(
tim”_ty³
);

69 
FromBridgeWa™O±iÚs
(
bridge_wa™_İtiÚs
);

73 
ToBridgeWa™O±iÚs
(
wa™_İtiÚs
);

77 
FromBridgeRU§geT¬g‘
(
RU§geT¬g‘
 
bridge_ru§ge_rg‘
);

81 
RU§geT¬g‘
 
ToBridgeRU§geT¬g‘
(
ru§ge_rg‘
);

85 
FromBridgeSigMaskAùiÚ
(
bridge_how
);

89 
ToBridgeSigMaskAùiÚ
(
how
);

93 
sig£t_t
 *
FromBridgeSigS‘
(cÚ¡ 
bridge_sig£t_t
 *
bridge_£t
, sig£t_ˆ*
£t
);

96 
bridge_sig£t_t
 *
ToBridgeSigS‘
(cÚ¡ 
sig£t_t
 *
£t
,

97 
bridge_sig£t_t
 *
bridge_£t
);

101 
FromBridgeSigÇl
(
bridge_signum
);

104 
ToBridgeSigÇl
(
signum
);

108 
FromBridgeSigÇlCode
(
bridge_si_code
);

111 
ToBridgeSigÇlCode
(
si_code
);

115 
sigšfo_t
 *
FromBridgeSigInfo
(cÚ¡ 
bridge_sigšfo_t
 *
bridge_sigšfo
,

116 
sigšfo_t
 *
sigšfo
);

119 
bridge_sigšfo_t
 *
ToBridgeSigInfo
(

120 cÚ¡ 
sigšfo_t
 *
sigšfo
, 
bridge_sigšfo_t
 *
bridge_sigšfo
);

124 
FromBridgeSigÇlFÏgs
(
bridge_§_æags
);

128 
ToBridgeSigÇlFÏgs
(
§_æags
);

132 
FromBridgeAdd»ssInfoFÏgs
(
bridge_ai_æag
);

136 
ToBridgeAdd»ssInfoFÏgs
(
ai_æag
);

140 
ToBridgeAdd»ssInfoE¼Üs
(
—i_code
);

144 
FromBridgeAdd»ssInfoE¼Üs
(
bridge_—i_code
);

148 
FromBridgeSock‘Ty³
(
bridge_sock_ty³
);

152 
ToBridgeSock‘Ty³
(
sock_ty³
);

156 
FromBridgeSysLogO±iÚ
(
bridge_sy¦og_İtiÚ
);

160 
ToBridgeSysLogO±iÚ
(
sy¦og_İtiÚ
);

164 
FromBridgeSysLogFac™y
(
bridge_sy¦og_çc™y
);

168 
ToBridgeSysLogFac™y
(
sy¦og_çc™y
);

172 
FromBridgeSysLogPriÜ™y
(
bridge_sy¦og_´iÜ™y
);

176 
ToBridgeSysLogPriÜ™y
(
sy¦og_´iÜ™y
);

179 
FromBridgeFúCmd
(
bridge_fú_cmd
);

182 
ToBridgeFúCmd
(
fú_cmd
);

185 
FromBridgeFeFÏgs
(
bridge_fe_æag
);

188 
ToBridgeFeFÏgs
(
fe_æag
);

191 
FromBridgeFDFÏgs
(
bridge_fd_æag
);

194 
ToBridgeFDFÏgs
(
fd_æag
);

197 
FromBridgeO±iÚName
(
Ëv–
, 
bridge_İtiÚ_Çme
);

200 
ToBridgeO±iÚName
(
Ëv–
, 
İtiÚ_Çme
);

203 
¡©
 *
FromBridgeSt
(cÚ¡ 
bridge_¡©
 *
bridge_¡©buf
,

204 
¡©
 *
¡©buf
);

207 
bridge_¡©
 *
ToBridgeSt
(cÚ¡ 
¡©
 *
¡©buf
,

208 
bridge_¡©
 *
bridge_¡©buf
);

212 
AfFamy
 
ToBridgeAfFamy
(
af_çmy
);

216 
FromBridgeAfFamy
(
bridge_af_çmy
);

220 
ToBridgeSock‘Ty³
(
sock_ty³
);

224 
FromBridgeSock‘Ty³
(
bridge_sock_ty³
);

234 
sockaddr
 *
FromBridgeSockaddr
(cÚ¡ 
bridge_sockaddr
 *
bridge_addr
,

235 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

239 
bridge_sockaddr
 *
ToBridgeSockaddr
(cÚ¡ 
sockaddr
 *
addr
,

240 
sockËn_t
 
add¾’
,

241 
bridge_sockaddr
 *
bridge_addr
);

244 
tms
 *
FromBridgeTms
(cÚ¡ 
BridgeTms
 *
bridge_times
,

245 
tms
 *
times
);

248 
BridgeTms
 *
ToBridgeTms
(cÚ¡ 
tms
 *
times
,

249 
BridgeTms
 *
bridge_times
);

252 
time¥ec
 *
FromBridgeTime¥ec
(cÚ¡ 
bridge_time¥ec
 *
bridge_
,

253 
time¥ec
 *

);

256 
bridge_time¥ec
 *
ToBridgeTime¥ec
(cÚ¡ 
time¥ec
 *

,

257 
bridge_time¥ec
 *
bridge_
);

260 
utimbuf
 *
FromBridgeUtimbuf
(cÚ¡ 
bridge_utimbuf
 *
bridge_ut
,

261 
utimbuf
 *
ut
);

264 
bridge_utimbuf
 *
ToBridgeUtimbuf
(cÚ¡ 
utimbuf
 *
ut
,

265 
bridge_utimbuf
 *
bridge_ut
);

268 
timev®
 *
FromBridgeTimeV®
(cÚ¡ 
bridge_timev®
 *
bridge_tv
,

269 
timev®
 *
tv
);

272 
bridge_timev®
 *
ToBridgeTimeV®
(cÚ¡ 
timev®
 *
tv
,

273 
bridge_timev®
 *
bridge_tv
);

276 
™im”v®
 *
FromBridgeITim”V®
(

277 cÚ¡ 
BridgeITim”V®
 *
bridge_tim”v®
, 
™im”v®
 *
tim”v®
);

280 
BridgeITim”V®
 *
ToBridgeITim”V®
(

281 cÚ¡ 
™im”v®
 *
tim”v®
, 
BridgeITim”V®
 *
bridge_tim”v®
);

284 
pŞlfd
 *
FromBridgePŞlfd
(cÚ¡ 
bridge_pŞlfd
 *
bridge_fd
,

285 
pŞlfd
 *
fd
);

288 
bridge_pŞlfd
 *
ToBridgePŞlfd
(cÚ¡ 
pŞlfd
 *
fd
,

289 
bridge_pŞlfd
 *
bridge_fd
);

294 
msghdr
 *
FromBridgeMsgHdr
(cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

295 
msghdr
 *
msg
);

300 
bridge_msghdr
 *
ToBridgeMsgHdr
(cÚ¡ 
msghdr
 *
msg
,

301 
bridge_msghdr
 *
bridge_msg
);

306 
msghdr
 *
FromBridgeIovecA¼ay
(cÚ¡ 
bridge_msghdr
 *
bridge_msg
,

307 
msghdr
 *
msg
);

312 
bridge_msghdr
 *
ToBridgeIovecA¼ay
(cÚ¡ 
msghdr
 *
msg
,

313 
bridge_msghdr
 *
bridge_msg
);

316 
iovec
 *
FromBridgeIovec
(cÚ¡ 
bridge_iovec
 *
bridge_iov
,

317 
iovec
 *
iov
);

320 
bridge_iovec
 *
ToBridgeIovec
(cÚ¡ 
iovec
 *
iov
,

321 
bridge_iovec
 *
bridge_iov
);

325 
FromBridgeWStus
(
BridgeWStus
 
bridge_w¡©us
);

328 
BridgeWStus
 
ToBridgeWStus
(
w¡©us
);

332 
ru§ge
 *
FromBridgeRU§ge
(cÚ¡ 
BridgeRU§ge
 *
bridge_ru§ge
,

333 
ru§ge
 *rusage);

336 
BridgeRU§ge
 *
ToBridgeRU§ge
(cÚ¡ 
ru§ge
 *rusage,

337 
BridgeRU§ge
 *
bridge_ru§ge
);

340 
fd_£t
 *
FromBridgeFDS‘
(cÚ¡ 
BridgeFDS‘
 *
bridge_fds
, fd_£ˆ*
fds
);

343 
BridgeFDS‘
 *
ToBridgeFDS‘
(cÚ¡ 
fd_£t
 *
fds
,

344 
BridgeFDS‘
 *
bridge_fds
);

349 
·sswd
 *
FromBridgePassWd
(
BridgePassWd
 *
bridge_·sswÜd
,

350 
·sswd
 *
·sswÜd
);

354 
BridgePassWd
 *
ToBridgePassWd
(cÚ¡ 
·sswd
 *
·sswÜd
,

355 
BridgePassWd
 *
bridge_·sswÜd
);

360 
BridgePassWd
 *
CİyBridgePassWd
(

361 cÚ¡ 
BridgePassWd
 *
sourû_bridge_·sswÜd
,

362 
BridgePassWd
 *
de¡š©iÚ_bridge_·sswÜd
);

367 
BridgeCpuS‘Z”o
(
BridgeCpuS‘
 *
£t
);

369 
BridgeCpuS‘AddB™
(
ıu
, 
BridgeCpuS‘
 *
£t
);

371 
BridgeCpuS‘CheckB™
(
ıu
, 
BridgeCpuS‘
 *
£t
);

379 
boŞ
 
CSŒšgCİy
(cÚ¡ *
sourû_buf
, *
de¡_buf
, 
size_t
 
size
);

392 
	g‹m¶©e
 <
ty³Çme
 
	gSrcUtsNameTy³
,y³Çm
	gD¡UtsNameTy³
>

393 
boŞ
 
CÚv”tUtsName
(cÚ¡ 
SrcUtsNameTy³
 &
sourû_ut¢ame
,

394 
D¡UtsNameTy³
 *
de¡_ut¢ame
) {

395 ià(!
	gde¡_ut¢ame
) {

396  
	gçl£
;

399  
CSŒšgCİy
(
sourû_ut¢ame
.
sy¢ame
, 
de¡_ut¢ame
->sysname,

400 (
de¡_ut¢ame
->
sy¢ame
)) &&

401 
CSŒšgCİy
(
sourû_ut¢ame
.
nod’ame
, 
de¡_ut¢ame
->nodename,

402 (
de¡_ut¢ame
->
nod’ame
)) &&

403 
CSŒšgCİy
(
sourû_ut¢ame
.
»Ëa£
, 
de¡_ut¢ame
->release,

404 (
de¡_ut¢ame
->
»Ëa£
)) &&

405 
CSŒšgCİy
(
sourû_ut¢ame
.
v”siÚ
, 
de¡_ut¢ame
->version,

406 (
de¡_ut¢ame
->
v”siÚ
)) &&

407 
CSŒšgCİy
(
sourû_ut¢ame
.
machše
, 
de¡_ut¢ame
->machine,

408 (
de¡_ut¢ame
->
machše
)) &&

409 
CSŒšgCİy
(
sourû_ut¢ame
.
domašÇme
, 
de¡_ut¢ame
->domainname,

410 (
de¡_ut¢ame
->
domašÇme
));

	@platform/common/bridge_functions_test.cc

19 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

21 
	~<fú.h
>

22 
	~<Ãtdb.h
>

23 
	~<sys/sock‘.h
>

24 
	~<sys/un.h
>

25 
	~<sy¦og.h
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

30 
	~"asylo/‹¡/ut/fš™e_domaš_fuzz.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

36 cÚ¡ 
	gITER_BOUND
 = 6000;

38 şas 
	cBridgeTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

39 
public
:

42 
usšg
 
	gštvec
 = 
¡d
::
veùÜ
<>;

44 
TEST_F
(
BridgeTe¡
, 
BridgeFLockO³¿tiÚTe¡
) {

45 
štvec
 
	gäom_b™s
 = {
BRIDGE_LOCK_SH
, 
BRIDGE_LOCK_EX
, 
BRIDGE_LOCK_NB
,

46 
BRIDGE_LOCK_UN
};

47 
štvec
 
	gto_b™s
 = {
LOCK_SH
, 
LOCK_EX
, 
LOCK_NB
, 
LOCK_UN
};

48 
EXPECT_EQ
(
äom_b™s
.
size
(), 
to_b™s
.size());

49 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFLockO³¿tiÚ
);

50 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

51 
äom_m©ch”
);

52 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFLockO³¿tiÚ
);

53 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

54 
to_m©ch”
);

57 
TEST_F
(
BridgeTe¡
, 
BridgeSyscÚfCÚ¡ªtsTe¡
) {

58 
	g¡d
::
veùÜ
<
SyscÚfCÚ¡ªts
> 
äom_cÚ¡s
 = {
BRIDGE_SC_NPROCESSORS_CONF
,

59 
BRIDGE_SC_NPROCESSORS_ONLN
,

60 
BRIDGE_SC_UNKNOWN
};

61 
štvec
 
	gto_cÚ¡s
 = {
_SC_NPROCESSORS_CONF
, 
_SC_NPROCESSORS_ONLN
, -1};

62 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, 
	gSyscÚfCÚ¡ªts
>(

63 
	gToBridgeSyscÚfCÚ¡ªts
);

64 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

65 
BRIDGE_SC_UNKNOWN
, 
ITER_BOUND
),

66 
to_m©ch”
);

67 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<
SyscÚfCÚ¡ªts
, >(

68 
	gFromBridgeSyscÚfCÚ¡ªts
);

69 
EXPECT_THAT
(
z
(
äom_cÚ¡s
, 
to_cÚ¡s
), 
äom_m©ch”
);

72 
TEST_F
(
BridgeTe¡
, 
BridgeTim”Ty³Te¡
) {

73 
	g¡d
::
veùÜ
<
Tim”Ty³
> 
äom_cÚ¡s
 = {

74 
BRIDGE_ITIMER_REAL
,

75 
BRIDGE_ITIMER_VIRTUAL
,

76 
BRIDGE_ITIMER_PROF
,

77 
BRIDGE_ITIMER_UNKNOWN
,

79 
štvec
 
	gto_cÚ¡s
 = {
ITIMER_REAL
, 
ITIMER_VIRTUAL
, 
ITIMER_PROF
, -1};

80 autØ
	gäom_m©ch”
 =

81 
IsFš™eRe¡riùiÚOf
<
Tim”Ty³
, >(
	gFromBridgeTim”Ty³
);

82 
EXPECT_THAT
(
z
(
äom_cÚ¡s
, 
to_cÚ¡s
), 
äom_m©ch”
);

83 autØ
	gto_m©ch”
 =

84 
IsFš™eRe¡riùiÚOf
<, 
	gTim”Ty³
>(
	gToBridgeTim”Ty³
);

85 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

86 
BRIDGE_ITIMER_UNKNOWN
, 
ITER_BOUND
),

87 
to_m©ch”
);

90 
TEST_F
(
BridgeTe¡
, 
BridgeWa™O±iÚsTe¡
) {

91 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_WNOHANG
};

92 
štvec
 
	gto_cÚ¡s
 = {
WNOHANG
};

93 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeWa™O±iÚs
);

94 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_cÚ¡s
, 
to_cÚ¡s
, 
ITER_BOUND
),

95 
äom_m©ch”
);

96 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeWa™O±iÚs
);

97 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_cÚ¡s
, 
äom_cÚ¡s
, 
ITER_BOUND
),

98 
to_m©ch”
);

101 
TEST_F
(
BridgeTe¡
, 
BridgeRU§geT¬g‘Te¡
) {

102 
	g¡d
::
veùÜ
<
RU§geT¬g‘
> 
äom_cÚ¡s
 = {

103 
BRIDGE_RUSAGE_SELF
,

104 
BRIDGE_RUSAGE_CHILDREN
,

106 
štvec
 
	gto_cÚ¡s
 = {
RUSAGE_SELF
, 
RUSAGE_CHILDREN
};

107 autØ
	gäom_m©ch”
 =

108 
IsFš™eRe¡riùiÚOf
<
RU§geT¬g‘
, >(
	gFromBridgeRU§geT¬g‘
);

109 
EXPECT_THAT
(
z
(
äom_cÚ¡s
, 
to_cÚ¡s
), 
äom_m©ch”
);

110 autØ
	gto_m©ch”
 =

111 
IsFš™eRe¡riùiÚOf
<, 
	gRU§geT¬g‘
>(
	gToBridgeRU§geT¬g‘
);

112 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

113 
BRIDGE_RUSAGE_UNKNOWN
, 
ITER_BOUND
),

114 
to_m©ch”
);

117 
TEST_F
(
BridgeTe¡
, 
BridgeSigMaskAùiÚTe¡
) {

118 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_SIG_BLOCK
, 
BRIDGE_SIG_UNBLOCK
,

119 
BRIDGE_SIG_SETMASK
};

120 
štvec
 
	gto_cÚ¡s
 = {
SIG_BLOCK
, 
SIG_UNBLOCK
, 
SIG_SETMASK
};

121 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSigMaskAùiÚ
);

122 
EXPECT_THAT
(

123 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1, 
ITER_BOUND
),

124 
äom_m©ch”
);

125 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSigMaskAùiÚ
);

126 
EXPECT_THAT
(

127 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1, 
ITER_BOUND
),

128 
to_m©ch”
);

131 
TEST_F
(
BridgeTe¡
, 
BridgeSigÇlCodeTe¡
) {

132 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_SI_USER
, 
BRIDGE_SI_QUEUE
, 
BRIDGE_SI_TIMER
,

133 
BRIDGE_SI_ASYNCIO
, 
BRIDGE_SI_MESGQ
};

134 
štvec
 
	gto_cÚ¡s
 = {
SI_USER
, 
SI_QUEUE
, 
SI_TIMER
, 
SI_ASYNCIO
, 
SI_MESGQ
};

135 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSigÇlCode
);

136 
EXPECT_THAT
(

137 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1, 
ITER_BOUND
),

138 
äom_m©ch”
);

139 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSigÇlCode
);

140 
EXPECT_THAT
(

141 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1, 
ITER_BOUND
),

142 
to_m©ch”
);

145 
TEST_F
(
BridgeTe¡
, 
BridgeSigInfoTe¡
) {

148 
TEST_F
(
BridgeTe¡
, 
BridgeAdd»ssInfoFÏgsTe¡
) {

149 
štvec
 
	gäom_b™s
 = {
BRIDGE_AI_CANONNAME
,

150 
BRIDGE_AI_NUMERICHOST
,

151 
BRIDGE_AI_V4MAPPED
,

152 
BRIDGE_AI_ADDRCONFIG
,

153 
BRIDGE_AI_ALL
,

154 
BRIDGE_AI_PASSIVE
,

155 
BRIDGE_AI_NUMERICSERV
,

156 
BRIDGE_AI_IDN
,

157 
BRIDGE_AI_CANONIDN
};

158 
štvec
 
	gto_b™s
 = {
AI_CANONNAME
,

159 
AI_NUMERICHOST
,

160 
AI_V4MAPPED
,

161 
AI_ADDRCONFIG
,

162 
AI_ALL
,

163 
AI_PASSIVE
,

164 
AI_NUMERICSERV
,

165 
AI_IDN
,

166 
AI_CANONIDN
};

167 autØ
	gäom_m©ch”
 =

168 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeAdd»ssInfoFÏgs
);

169 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

170 
äom_m©ch”
);

171 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeAdd»ssInfoFÏgs
);

172 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

173 
to_m©ch”
);

176 
TEST_F
(
BridgeTe¡
, 
BridgeSysLogO±iÚTe¡
) {

177 
štvec
 
	gäom_b™s
 = {
BRIDGE_LOG_PID
, 
BRIDGE_LOG_CONS
, 
BRIDGE_LOG_ODELAY
,

178 
BRIDGE_LOG_NDELAY
, 
BRIDGE_LOG_NOWAIT
, 
BRIDGE_LOG_PERROR
};

179 
štvec
 
	gto_b™s
 = {
LOG_PID
, 
LOG_CONS
, 
LOG_ODELAY
,

180 
LOG_NDELAY
, 
LOG_NOWAIT
, 
LOG_PERROR
};

181 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSysLogO±iÚ
);

182 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

183 
äom_m©ch”
);

184 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSysLogO±iÚ
);

185 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

186 
to_m©ch”
);

189 
TEST_F
(
BridgeTe¡
, 
BridgeSysLogFac™yTe¡
) {

190 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_LOG_USER
, 
BRIDGE_LOG_LOCAL0
,

191 
BRIDGE_LOG_LOCAL1
, 
BRIDGE_LOG_LOCAL2
,

192 
BRIDGE_LOG_LOCAL3
, 
BRIDGE_LOG_LOCAL4
,

193 
BRIDGE_LOG_LOCAL5
, 
BRIDGE_LOG_LOCAL6
,

194 
BRIDGE_LOG_LOCAL7
, 0};

195 
štvec
 
	gto_cÚ¡s
 = {
LOG_USER
, 
LOG_LOCAL0
, 
LOG_LOCAL1
, 
LOG_LOCAL2
,

196 
LOG_LOCAL3
, 
LOG_LOCAL4
, 
LOG_LOCAL5
, 
LOG_LOCAL6
,

197 
LOG_LOCAL7
, 0};

198 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSysLogFac™y
);

199 
EXPECT_THAT
(

200 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, 0, 
ITER_BOUND
),

201 
äom_m©ch”
);

202 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSysLogFac™y
);

203 
EXPECT_THAT
(

204 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, 0, 
ITER_BOUND
),

205 
to_m©ch”
);

208 
TEST_F
(
BridgeTe¡
, 
BridgeSysLogPriÜ™yTe¡
) {

209 
štvec
 
	ghigh_äom_cÚ¡s
 = {
BRIDGE_LOG_USER
, 
BRIDGE_LOG_LOCAL0
,

210 
BRIDGE_LOG_LOCAL1
, 
BRIDGE_LOG_LOCAL2
,

211 
BRIDGE_LOG_LOCAL3
, 
BRIDGE_LOG_LOCAL4
,

212 
BRIDGE_LOG_LOCAL5
, 
BRIDGE_LOG_LOCAL6
,

213 
BRIDGE_LOG_LOCAL7
, 0};

214 
štvec
 
	glow_äom_cÚ¡s
 = {

215 
BRIDGE_LOG_EMERG
, 
BRIDGE_LOG_ALERT
, 
BRIDGE_LOG_CRIT
, 
BRIDGE_LOG_ERR
,

216 
BRIDGE_LOG_WARNING
, 
BRIDGE_LOG_NOTICE
, 
BRIDGE_LOG_INFO
, 
BRIDGE_LOG_DEBUG
};

217 
štvec
 
	ghigh_to_cÚ¡s
 = {
LOG_USER
, 
LOG_LOCAL0
, 
LOG_LOCAL1
, 
LOG_LOCAL2
,

218 
LOG_LOCAL3
, 
LOG_LOCAL4
, 
LOG_LOCAL5
, 
LOG_LOCAL6
,

219 
LOG_LOCAL7
, 0};

220 
štvec
 
	glow_to_cÚ¡s
 = {
LOG_EMERG
, 
LOG_ALERT
, 
LOG_CRIT
, 
LOG_ERR
,

221 
LOG_WARNING
, 
LOG_NOTICE
, 
LOG_INFO
, 
LOG_DEBUG
};

223 
	gi
 = 0; i < 
	ghigh_äom_cÚ¡s
.
size
(); i++) {

224 
	gj
 = 0; j < 
	glow_äom_cÚ¡s
.
size
(); j++) {

225 
	gäom
 = 
high_äom_cÚ¡s
[
i
] | 
low_äom_cÚ¡s
[
j
];

226 
	gto
 = 
high_to_cÚ¡s
[
i
] | 
low_to_cÚ¡s
[
j
];

227 
EXPECT_EQ
(
FromBridgeSysLogPriÜ™y
(
äom
), 
to
);

228 
EXPECT_EQ
(
ToBridgeSysLogPriÜ™y
(
to
), 
äom
);

233 
TEST_F
(
BridgeTe¡
, 
BridgeFúCommªdsTe¡
) {

234 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_F_GETFD
, 
BRIDGE_F_SETFD
,

235 
BRIDGE_F_GETFL
, 
BRIDGE_F_SETFL
,

236 
BRIDGE_F_GETPIPE_SZ
, 
BRIDGE_F_SETPIPE_SZ
};

237 
štvec
 
	gto_cÚ¡s
 = {
F_GETFD
, 
F_SETFD
, 
F_GETFL
,

238 
F_SETFL
, 
F_GETPIPE_SZ
, 
F_SETPIPE_SZ
};

239 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFúCmd
);

240 
EXPECT_THAT
(

241 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1, 
ITER_BOUND
),

242 
äom_m©ch”
);

243 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFúCmd
);

244 
EXPECT_THAT
(

245 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1, 
ITER_BOUND
),

246 
to_m©ch”
);

249 
TEST_F
(
BridgeTe¡
, 
BridgeFeFÏgsTe¡
) {

250 
štvec
 
	gäom_b™s
 = {
BRIDGE_RDONLY
, 
BRIDGE_WRONLY
, 
BRIDGE_RDWR
,

251 
BRIDGE_CREAT
, 
BRIDGE_APPEND
, 
BRIDGE_EXCL
,

252 
BRIDGE_TRUNC
, 
BRIDGE_NONBLOCK
, 
BRIDGE_DIRECT
,

253 
BRIDGE_O_CLOEXEC
};

254 
štvec
 
	gto_b™s
 = {
O_RDONLY
, 
O_WRONLY
, 
O_RDWR
, 
O_CREAT
, 
O_APPEND
,

255 
O_EXCL
, 
O_TRUNC
, 
O_NONBLOCK
, 
O_DIRECT
, 
O_CLOEXEC
};

256 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFeFÏgs
);

257 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

258 
äom_m©ch”
);

259 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFeFÏgs
);

260 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

261 
to_m©ch”
);

264 
TEST_F
(
BridgeTe¡
, 
BridgeFDFÏgsTe¡
) {

265 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_CLOEXEC
};

266 
štvec
 
	gto_cÚ¡s
 = {
FD_CLOEXEC
};

267 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFDFÏgs
);

268 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_cÚ¡s
, 
to_cÚ¡s
, 
ITER_BOUND
),

269 
äom_m©ch”
);

270 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFDFÏgs
);

271 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_cÚ¡s
, 
äom_cÚ¡s
, 
ITER_BOUND
),

272 
to_m©ch”
);

275 
TEST_F
(
BridgeTe¡
, 
BridgeO±iÚNameTe¡
) {

276 
štvec
 
	gËv–s
 = {
IPPROTO_TCP
, 
IPPROTO_IPV6
, 
SOL_SOCKET
, -1};

277 
	g¡d
::
veùÜ
<
štvec
> 
äom_cÚ¡s
 = {

278 {
BRIDGE_TCP_NODELAY
, 
BRIDGE_TCP_KEEPIDLE
, 
BRIDGE_TCP_KEEPINTVL
,

279 
BRIDGE_TCP_KEEPCNT
},

280 {
BRIDGE_IPV6_V6ONLY
},

281 {
BRIDGE_SO_DEBUG
, 
BRIDGE_SO_REUSEADDR
, 
BRIDGE_SO_TYPE
, 
BRIDGE_SO_ERROR
,

282 
BRIDGE_SO_DONTROUTE
, 
BRIDGE_SO_BROADCAST
, 
BRIDGE_SO_SNDBUF
,

283 
BRIDGE_SO_RCVBUF
, 
BRIDGE_SO_SNDTIMEO
, 
BRIDGE_SO_RCVTIMEO
,

284 
BRIDGE_SO_SNDBUFFORCE
, 
BRIDGE_SO_RCVBUFFORCE
, 
BRIDGE_SO_KEEPALIVE
,

285 
BRIDGE_SO_OOBINLINE
, 
BRIDGE_SO_NO_CHECK
, 
BRIDGE_SO_PRIORITY
,

286 
BRIDGE_SO_LINGER
, 
BRIDGE_SO_BSDCOMPAT
, 
BRIDGE_SO_REUSEPORT
},

288 
	g¡d
::
veùÜ
<
štvec
> 
to_cÚ¡s
 = {

289 {
TCP_NODELAY
, 
TCP_KEEPIDLE
, 
TCP_KEEPINTVL
, 
TCP_KEEPCNT
},

290 {
IPV6_V6ONLY
},

291 {
SO_DEBUG
, 
SO_REUSEADDR
, 
SO_TYPE
, 
SO_ERROR
, 
SO_DONTROUTE
, 
SO_BROADCAST
,

292 
SO_SNDBUF
, 
SO_RCVBUF
, 
SO_SNDTIMEO
, 
SO_RCVTIMEO
, 
SO_SNDBUFFORCE
,

293 
SO_RCVBUFFORCE
, 
SO_KEEPALIVE
, 
SO_OOBINLINE
, 
SO_NO_CHECK
, 
SO_PRIORITY
,

294 
SO_LINGER
, 
SO_BSDCOMPAT
, 
SO_REUSEPORT
},

296 
	gi
 = 0; i < 
	gËv–s
.
size
(); i++) {

297 
	g¡d
::
funùiÚ
<()> 
äom_şo£
 = [
Ëv–s
, 
i
](
	gİtiÚ
) {

298  
FromBridgeO±iÚName
(
Ëv–s
[
i
], 
İtiÚ
);

300 
	g¡d
::
funùiÚ
<()> 
to_şo£
 = [
Ëv–s
, 
i
](
	gİtiÚ
) {

301  
ToBridgeO±iÚName
(
Ëv–s
[
i
], 
İtiÚ
);

303 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gäom_şo£
);

304 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
[
i
], 
to_cÚ¡s
[i], -1,

305 
ITER_BOUND
),

306 
äom_m©ch”
);

307 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gto_şo£
);

308 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
[
i
], 
äom_cÚ¡s
[i], -1,

309 
ITER_BOUND
),

310 
to_m©ch”
);

314 
TEST_F
(
BridgeTe¡
, 
BridgeAfFamyTe¡
) {

315 
	g¡d
::
veùÜ
<
AfFamy
> 
äom_cÚ¡s
 = {

316 
BRIDGE_AF_UNIX
, 
BRIDGE_AF_INET
, 
BRIDGE_AF_INET6
, 
BRIDGE_AF_UNSPEC
,

317 
BRIDGE_AF_IPX
, 
BRIDGE_AF_NETLINK
, 
BRIDGE_AF_X25
, 
BRIDGE_AF_AX25
,

318 
BRIDGE_AF_ATMPVC
, 
BRIDGE_AF_APPLETALK
, 
BRIDGE_AF_PACKET
, 
BRIDGE_AF_ALG
};

319 
štvec
 
	gto_cÚ¡s
 = {
AF_UNIX
, 
AF_INET
, 
AF_INET6
, 
AF_UNSPEC
,

320 
AF_IPX
, 
AF_NETLINK
, 
AF_X25
, 
AF_AX25
,

321 
AF_ATMPVC
, 
AF_APPLETALK
, 
AF_PACKET
, 
AF_ALG
};

322 
štvec
 
	gäom_šts
 = {
BRIDGE_AF_UNIX
, 
BRIDGE_AF_INET
, 
BRIDGE_AF_INET6
,

323 
BRIDGE_AF_UNSPEC
, 
BRIDGE_AF_IPX
, 
BRIDGE_AF_NETLINK
,

324 
BRIDGE_AF_X25
, 
BRIDGE_AF_AX25
, 
BRIDGE_AF_ATMPVC
,

325 
BRIDGE_AF_APPLETALK
, 
BRIDGE_AF_PACKET
, 
BRIDGE_AF_ALG
};

327 ià(
	gBRIDGE_AF_UNIX
 !ğ
BRIDGE_AF_LOCAL
 && 
AF_UNIX
 !ğ
AF_LOCAL
) {

328 
äom_cÚ¡s
.
push_back
(
BRIDGE_AF_LOCAL
);

329 
	gto_cÚ¡s
.
push_back
(
AF_LOCAL
);

330 
	gäom_šts
.
push_back
(
BRIDGE_AF_LOCAL
);

333 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeAfFamy
);

334 
EXPECT_THAT
(
z
(
äom_šts
, 
to_cÚ¡s
), 
äom_m©ch”
);

335 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, 
	gAfFamy
>(
	gToBridgeAfFamy
);

336 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

337 
BRIDGE_AF_UNSUPPORTED
, 
ITER_BOUND
),

338 
to_m©ch”
);

	@platform/common/bridge_functions_test.cc

19 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

21 
	~<fú.h
>

22 
	~<Ãtdb.h
>

23 
	~<sys/sock‘.h
>

24 
	~<sys/un.h
>

25 
	~<sy¦og.h
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

30 
	~"asylo/‹¡/ut/fš™e_domaš_fuzz.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

36 cÚ¡ 
	gITER_BOUND
 = 6000;

38 şas 
	cBridgeTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

39 
public
:

42 
usšg
 
	gštvec
 = 
¡d
::
veùÜ
<>;

44 
TEST_F
(
BridgeTe¡
, 
BridgeFLockO³¿tiÚTe¡
) {

45 
štvec
 
	gäom_b™s
 = {
BRIDGE_LOCK_SH
, 
BRIDGE_LOCK_EX
, 
BRIDGE_LOCK_NB
,

46 
BRIDGE_LOCK_UN
};

47 
štvec
 
	gto_b™s
 = {
LOCK_SH
, 
LOCK_EX
, 
LOCK_NB
, 
LOCK_UN
};

48 
EXPECT_EQ
(
äom_b™s
.
size
(), 
to_b™s
.size());

49 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFLockO³¿tiÚ
);

50 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

51 
äom_m©ch”
);

52 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFLockO³¿tiÚ
);

53 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

54 
to_m©ch”
);

57 
TEST_F
(
BridgeTe¡
, 
BridgeSyscÚfCÚ¡ªtsTe¡
) {

58 
	g¡d
::
veùÜ
<
SyscÚfCÚ¡ªts
> 
äom_cÚ¡s
 = {
BRIDGE_SC_NPROCESSORS_CONF
,

59 
BRIDGE_SC_NPROCESSORS_ONLN
,

60 
BRIDGE_SC_UNKNOWN
};

61 
štvec
 
	gto_cÚ¡s
 = {
_SC_NPROCESSORS_CONF
, 
_SC_NPROCESSORS_ONLN
, -1};

62 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, 
	gSyscÚfCÚ¡ªts
>(

63 
	gToBridgeSyscÚfCÚ¡ªts
);

64 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

65 
BRIDGE_SC_UNKNOWN
, 
ITER_BOUND
),

66 
to_m©ch”
);

67 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<
SyscÚfCÚ¡ªts
, >(

68 
	gFromBridgeSyscÚfCÚ¡ªts
);

69 
EXPECT_THAT
(
z
(
äom_cÚ¡s
, 
to_cÚ¡s
), 
äom_m©ch”
);

72 
TEST_F
(
BridgeTe¡
, 
BridgeTim”Ty³Te¡
) {

73 
	g¡d
::
veùÜ
<
Tim”Ty³
> 
äom_cÚ¡s
 = {

74 
BRIDGE_ITIMER_REAL
,

75 
BRIDGE_ITIMER_VIRTUAL
,

76 
BRIDGE_ITIMER_PROF
,

77 
BRIDGE_ITIMER_UNKNOWN
,

79 
štvec
 
	gto_cÚ¡s
 = {
ITIMER_REAL
, 
ITIMER_VIRTUAL
, 
ITIMER_PROF
, -1};

80 autØ
	gäom_m©ch”
 =

81 
IsFš™eRe¡riùiÚOf
<
Tim”Ty³
, >(
	gFromBridgeTim”Ty³
);

82 
EXPECT_THAT
(
z
(
äom_cÚ¡s
, 
to_cÚ¡s
), 
äom_m©ch”
);

83 autØ
	gto_m©ch”
 =

84 
IsFš™eRe¡riùiÚOf
<, 
	gTim”Ty³
>(
	gToBridgeTim”Ty³
);

85 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

86 
BRIDGE_ITIMER_UNKNOWN
, 
ITER_BOUND
),

87 
to_m©ch”
);

90 
TEST_F
(
BridgeTe¡
, 
BridgeWa™O±iÚsTe¡
) {

91 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_WNOHANG
};

92 
štvec
 
	gto_cÚ¡s
 = {
WNOHANG
};

93 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeWa™O±iÚs
);

94 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_cÚ¡s
, 
to_cÚ¡s
, 
ITER_BOUND
),

95 
äom_m©ch”
);

96 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeWa™O±iÚs
);

97 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_cÚ¡s
, 
äom_cÚ¡s
, 
ITER_BOUND
),

98 
to_m©ch”
);

101 
TEST_F
(
BridgeTe¡
, 
BridgeRU§geT¬g‘Te¡
) {

102 
	g¡d
::
veùÜ
<
RU§geT¬g‘
> 
äom_cÚ¡s
 = {

103 
BRIDGE_RUSAGE_SELF
,

104 
BRIDGE_RUSAGE_CHILDREN
,

106 
štvec
 
	gto_cÚ¡s
 = {
RUSAGE_SELF
, 
RUSAGE_CHILDREN
};

107 autØ
	gäom_m©ch”
 =

108 
IsFš™eRe¡riùiÚOf
<
RU§geT¬g‘
, >(
	gFromBridgeRU§geT¬g‘
);

109 
EXPECT_THAT
(
z
(
äom_cÚ¡s
, 
to_cÚ¡s
), 
äom_m©ch”
);

110 autØ
	gto_m©ch”
 =

111 
IsFš™eRe¡riùiÚOf
<, 
	gRU§geT¬g‘
>(
	gToBridgeRU§geT¬g‘
);

112 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

113 
BRIDGE_RUSAGE_UNKNOWN
, 
ITER_BOUND
),

114 
to_m©ch”
);

117 
TEST_F
(
BridgeTe¡
, 
BridgeSigMaskAùiÚTe¡
) {

118 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_SIG_BLOCK
, 
BRIDGE_SIG_UNBLOCK
,

119 
BRIDGE_SIG_SETMASK
};

120 
štvec
 
	gto_cÚ¡s
 = {
SIG_BLOCK
, 
SIG_UNBLOCK
, 
SIG_SETMASK
};

121 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSigMaskAùiÚ
);

122 
EXPECT_THAT
(

123 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1, 
ITER_BOUND
),

124 
äom_m©ch”
);

125 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSigMaskAùiÚ
);

126 
EXPECT_THAT
(

127 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1, 
ITER_BOUND
),

128 
to_m©ch”
);

131 
TEST_F
(
BridgeTe¡
, 
BridgeSigÇlCodeTe¡
) {

132 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_SI_USER
, 
BRIDGE_SI_QUEUE
, 
BRIDGE_SI_TIMER
,

133 
BRIDGE_SI_ASYNCIO
, 
BRIDGE_SI_MESGQ
};

134 
štvec
 
	gto_cÚ¡s
 = {
SI_USER
, 
SI_QUEUE
, 
SI_TIMER
, 
SI_ASYNCIO
, 
SI_MESGQ
};

135 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSigÇlCode
);

136 
EXPECT_THAT
(

137 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1, 
ITER_BOUND
),

138 
äom_m©ch”
);

139 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSigÇlCode
);

140 
EXPECT_THAT
(

141 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1, 
ITER_BOUND
),

142 
to_m©ch”
);

145 
TEST_F
(
BridgeTe¡
, 
BridgeSigInfoTe¡
) {

148 
TEST_F
(
BridgeTe¡
, 
BridgeAdd»ssInfoFÏgsTe¡
) {

149 
štvec
 
	gäom_b™s
 = {
BRIDGE_AI_CANONNAME
,

150 
BRIDGE_AI_NUMERICHOST
,

151 
BRIDGE_AI_V4MAPPED
,

152 
BRIDGE_AI_ADDRCONFIG
,

153 
BRIDGE_AI_ALL
,

154 
BRIDGE_AI_PASSIVE
,

155 
BRIDGE_AI_NUMERICSERV
,

156 
BRIDGE_AI_IDN
,

157 
BRIDGE_AI_CANONIDN
};

158 
štvec
 
	gto_b™s
 = {
AI_CANONNAME
,

159 
AI_NUMERICHOST
,

160 
AI_V4MAPPED
,

161 
AI_ADDRCONFIG
,

162 
AI_ALL
,

163 
AI_PASSIVE
,

164 
AI_NUMERICSERV
,

165 
AI_IDN
,

166 
AI_CANONIDN
};

167 autØ
	gäom_m©ch”
 =

168 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeAdd»ssInfoFÏgs
);

169 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

170 
äom_m©ch”
);

171 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeAdd»ssInfoFÏgs
);

172 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

173 
to_m©ch”
);

176 
TEST_F
(
BridgeTe¡
, 
BridgeSysLogO±iÚTe¡
) {

177 
štvec
 
	gäom_b™s
 = {
BRIDGE_LOG_PID
, 
BRIDGE_LOG_CONS
, 
BRIDGE_LOG_ODELAY
,

178 
BRIDGE_LOG_NDELAY
, 
BRIDGE_LOG_NOWAIT
, 
BRIDGE_LOG_PERROR
};

179 
štvec
 
	gto_b™s
 = {
LOG_PID
, 
LOG_CONS
, 
LOG_ODELAY
,

180 
LOG_NDELAY
, 
LOG_NOWAIT
, 
LOG_PERROR
};

181 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSysLogO±iÚ
);

182 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

183 
äom_m©ch”
);

184 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSysLogO±iÚ
);

185 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

186 
to_m©ch”
);

189 
TEST_F
(
BridgeTe¡
, 
BridgeSysLogFac™yTe¡
) {

190 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_LOG_USER
, 
BRIDGE_LOG_LOCAL0
,

191 
BRIDGE_LOG_LOCAL1
, 
BRIDGE_LOG_LOCAL2
,

192 
BRIDGE_LOG_LOCAL3
, 
BRIDGE_LOG_LOCAL4
,

193 
BRIDGE_LOG_LOCAL5
, 
BRIDGE_LOG_LOCAL6
,

194 
BRIDGE_LOG_LOCAL7
, 0};

195 
štvec
 
	gto_cÚ¡s
 = {
LOG_USER
, 
LOG_LOCAL0
, 
LOG_LOCAL1
, 
LOG_LOCAL2
,

196 
LOG_LOCAL3
, 
LOG_LOCAL4
, 
LOG_LOCAL5
, 
LOG_LOCAL6
,

197 
LOG_LOCAL7
, 0};

198 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeSysLogFac™y
);

199 
EXPECT_THAT
(

200 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, 0, 
ITER_BOUND
),

201 
äom_m©ch”
);

202 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeSysLogFac™y
);

203 
EXPECT_THAT
(

204 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, 0, 
ITER_BOUND
),

205 
to_m©ch”
);

208 
TEST_F
(
BridgeTe¡
, 
BridgeSysLogPriÜ™yTe¡
) {

209 
štvec
 
	ghigh_äom_cÚ¡s
 = {
BRIDGE_LOG_USER
, 
BRIDGE_LOG_LOCAL0
,

210 
BRIDGE_LOG_LOCAL1
, 
BRIDGE_LOG_LOCAL2
,

211 
BRIDGE_LOG_LOCAL3
, 
BRIDGE_LOG_LOCAL4
,

212 
BRIDGE_LOG_LOCAL5
, 
BRIDGE_LOG_LOCAL6
,

213 
BRIDGE_LOG_LOCAL7
, 0};

214 
štvec
 
	glow_äom_cÚ¡s
 = {

215 
BRIDGE_LOG_EMERG
, 
BRIDGE_LOG_ALERT
, 
BRIDGE_LOG_CRIT
, 
BRIDGE_LOG_ERR
,

216 
BRIDGE_LOG_WARNING
, 
BRIDGE_LOG_NOTICE
, 
BRIDGE_LOG_INFO
, 
BRIDGE_LOG_DEBUG
};

217 
štvec
 
	ghigh_to_cÚ¡s
 = {
LOG_USER
, 
LOG_LOCAL0
, 
LOG_LOCAL1
, 
LOG_LOCAL2
,

218 
LOG_LOCAL3
, 
LOG_LOCAL4
, 
LOG_LOCAL5
, 
LOG_LOCAL6
,

219 
LOG_LOCAL7
, 0};

220 
štvec
 
	glow_to_cÚ¡s
 = {
LOG_EMERG
, 
LOG_ALERT
, 
LOG_CRIT
, 
LOG_ERR
,

221 
LOG_WARNING
, 
LOG_NOTICE
, 
LOG_INFO
, 
LOG_DEBUG
};

223 
	gi
 = 0; i < 
	ghigh_äom_cÚ¡s
.
size
(); i++) {

224 
	gj
 = 0; j < 
	glow_äom_cÚ¡s
.
size
(); j++) {

225 
	gäom
 = 
high_äom_cÚ¡s
[
i
] | 
low_äom_cÚ¡s
[
j
];

226 
	gto
 = 
high_to_cÚ¡s
[
i
] | 
low_to_cÚ¡s
[
j
];

227 
EXPECT_EQ
(
FromBridgeSysLogPriÜ™y
(
äom
), 
to
);

228 
EXPECT_EQ
(
ToBridgeSysLogPriÜ™y
(
to
), 
äom
);

233 
TEST_F
(
BridgeTe¡
, 
BridgeFúCommªdsTe¡
) {

234 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_F_GETFD
, 
BRIDGE_F_SETFD
,

235 
BRIDGE_F_GETFL
, 
BRIDGE_F_SETFL
,

236 
BRIDGE_F_GETPIPE_SZ
, 
BRIDGE_F_SETPIPE_SZ
};

237 
štvec
 
	gto_cÚ¡s
 = {
F_GETFD
, 
F_SETFD
, 
F_GETFL
,

238 
F_SETFL
, 
F_GETPIPE_SZ
, 
F_SETPIPE_SZ
};

239 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFúCmd
);

240 
EXPECT_THAT
(

241 
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1, 
ITER_BOUND
),

242 
äom_m©ch”
);

243 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFúCmd
);

244 
EXPECT_THAT
(

245 
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1, 
ITER_BOUND
),

246 
to_m©ch”
);

249 
TEST_F
(
BridgeTe¡
, 
BridgeFeFÏgsTe¡
) {

250 
štvec
 
	gäom_b™s
 = {
BRIDGE_RDONLY
, 
BRIDGE_WRONLY
, 
BRIDGE_RDWR
,

251 
BRIDGE_CREAT
, 
BRIDGE_APPEND
, 
BRIDGE_EXCL
,

252 
BRIDGE_TRUNC
, 
BRIDGE_NONBLOCK
, 
BRIDGE_DIRECT
,

253 
BRIDGE_O_CLOEXEC
};

254 
štvec
 
	gto_b™s
 = {
O_RDONLY
, 
O_WRONLY
, 
O_RDWR
, 
O_CREAT
, 
O_APPEND
,

255 
O_EXCL
, 
O_TRUNC
, 
O_NONBLOCK
, 
O_DIRECT
, 
O_CLOEXEC
};

256 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFeFÏgs
);

257 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
ITER_BOUND
),

258 
äom_m©ch”
);

259 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFeFÏgs
);

260 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
ITER_BOUND
),

261 
to_m©ch”
);

264 
TEST_F
(
BridgeTe¡
, 
BridgeFDFÏgsTe¡
) {

265 
štvec
 
	gäom_cÚ¡s
 = {
BRIDGE_CLOEXEC
};

266 
štvec
 
	gto_cÚ¡s
 = {
FD_CLOEXEC
};

267 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeFDFÏgs
);

268 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_cÚ¡s
, 
to_cÚ¡s
, 
ITER_BOUND
),

269 
äom_m©ch”
);

270 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gToBridgeFDFÏgs
);

271 
EXPECT_THAT
(
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_cÚ¡s
, 
äom_cÚ¡s
, 
ITER_BOUND
),

272 
to_m©ch”
);

275 
TEST_F
(
BridgeTe¡
, 
BridgeO±iÚNameTe¡
) {

276 
štvec
 
	gËv–s
 = {
IPPROTO_TCP
, 
IPPROTO_IPV6
, 
SOL_SOCKET
, -1};

277 
	g¡d
::
veùÜ
<
štvec
> 
äom_cÚ¡s
 = {

278 {
BRIDGE_TCP_NODELAY
, 
BRIDGE_TCP_KEEPIDLE
, 
BRIDGE_TCP_KEEPINTVL
,

279 
BRIDGE_TCP_KEEPCNT
},

280 {
BRIDGE_IPV6_V6ONLY
},

281 {
BRIDGE_SO_DEBUG
, 
BRIDGE_SO_REUSEADDR
, 
BRIDGE_SO_TYPE
, 
BRIDGE_SO_ERROR
,

282 
BRIDGE_SO_DONTROUTE
, 
BRIDGE_SO_BROADCAST
, 
BRIDGE_SO_SNDBUF
,

283 
BRIDGE_SO_RCVBUF
, 
BRIDGE_SO_SNDTIMEO
, 
BRIDGE_SO_RCVTIMEO
,

284 
BRIDGE_SO_SNDBUFFORCE
, 
BRIDGE_SO_RCVBUFFORCE
, 
BRIDGE_SO_KEEPALIVE
,

285 
BRIDGE_SO_OOBINLINE
, 
BRIDGE_SO_NO_CHECK
, 
BRIDGE_SO_PRIORITY
,

286 
BRIDGE_SO_LINGER
, 
BRIDGE_SO_BSDCOMPAT
, 
BRIDGE_SO_REUSEPORT
},

288 
	g¡d
::
veùÜ
<
štvec
> 
to_cÚ¡s
 = {

289 {
TCP_NODELAY
, 
TCP_KEEPIDLE
, 
TCP_KEEPINTVL
, 
TCP_KEEPCNT
},

290 {
IPV6_V6ONLY
},

291 {
SO_DEBUG
, 
SO_REUSEADDR
, 
SO_TYPE
, 
SO_ERROR
, 
SO_DONTROUTE
, 
SO_BROADCAST
,

292 
SO_SNDBUF
, 
SO_RCVBUF
, 
SO_SNDTIMEO
, 
SO_RCVTIMEO
, 
SO_SNDBUFFORCE
,

293 
SO_RCVBUFFORCE
, 
SO_KEEPALIVE
, 
SO_OOBINLINE
, 
SO_NO_CHECK
, 
SO_PRIORITY
,

294 
SO_LINGER
, 
SO_BSDCOMPAT
, 
SO_REUSEPORT
},

296 
	gi
 = 0; i < 
	gËv–s
.
size
(); i++) {

297 
	g¡d
::
funùiÚ
<()> 
äom_şo£
 = [
Ëv–s
, 
i
](
	gİtiÚ
) {

298  
FromBridgeO±iÚName
(
Ëv–s
[
i
], 
İtiÚ
);

300 
	g¡d
::
funùiÚ
<()> 
to_şo£
 = [
Ëv–s
, 
i
](
	gİtiÚ
) {

301  
ToBridgeO±iÚName
(
Ëv–s
[
i
], 
İtiÚ
);

303 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gäom_şo£
);

304 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
[
i
], 
to_cÚ¡s
[i], -1,

305 
ITER_BOUND
),

306 
äom_m©ch”
);

307 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gto_şo£
);

308 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
[
i
], 
äom_cÚ¡s
[i], -1,

309 
ITER_BOUND
),

310 
to_m©ch”
);

314 
TEST_F
(
BridgeTe¡
, 
BridgeAfFamyTe¡
) {

315 
	g¡d
::
veùÜ
<
AfFamy
> 
äom_cÚ¡s
 = {

316 
BRIDGE_AF_UNIX
, 
BRIDGE_AF_INET
, 
BRIDGE_AF_INET6
, 
BRIDGE_AF_UNSPEC
,

317 
BRIDGE_AF_IPX
, 
BRIDGE_AF_NETLINK
, 
BRIDGE_AF_X25
, 
BRIDGE_AF_AX25
,

318 
BRIDGE_AF_ATMPVC
, 
BRIDGE_AF_APPLETALK
, 
BRIDGE_AF_PACKET
, 
BRIDGE_AF_ALG
};

319 
štvec
 
	gto_cÚ¡s
 = {
AF_UNIX
, 
AF_INET
, 
AF_INET6
, 
AF_UNSPEC
,

320 
AF_IPX
, 
AF_NETLINK
, 
AF_X25
, 
AF_AX25
,

321 
AF_ATMPVC
, 
AF_APPLETALK
, 
AF_PACKET
, 
AF_ALG
};

322 
štvec
 
	gäom_šts
 = {
BRIDGE_AF_UNIX
, 
BRIDGE_AF_INET
, 
BRIDGE_AF_INET6
,

323 
BRIDGE_AF_UNSPEC
, 
BRIDGE_AF_IPX
, 
BRIDGE_AF_NETLINK
,

324 
BRIDGE_AF_X25
, 
BRIDGE_AF_AX25
, 
BRIDGE_AF_ATMPVC
,

325 
BRIDGE_AF_APPLETALK
, 
BRIDGE_AF_PACKET
, 
BRIDGE_AF_ALG
};

327 ià(
	gBRIDGE_AF_UNIX
 !ğ
BRIDGE_AF_LOCAL
 && 
AF_UNIX
 !ğ
AF_LOCAL
) {

328 
äom_cÚ¡s
.
push_back
(
BRIDGE_AF_LOCAL
);

329 
	gto_cÚ¡s
.
push_back
(
AF_LOCAL
);

330 
	gäom_šts
.
push_back
(
BRIDGE_AF_LOCAL
);

333 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gFromBridgeAfFamy
);

334 
EXPECT_THAT
(
z
(
äom_šts
, 
to_cÚ¡s
), 
äom_m©ch”
);

335 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, 
	gAfFamy
>(
	gToBridgeAfFamy
);

336 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
,

337 
BRIDGE_AF_UNSUPPORTED
, 
ITER_BOUND
),

338 
to_m©ch”
);

	@platform/common/bridge_proto_serializer.cc

19 
	~<içddrs.h
>

20 
	~<Ãt/if.h
>

21 
	~<Ãtdb.h
>

22 
	~<sys/•Şl.h
>

23 
	~<sys/šÙify.h
>

24 
	~<sys/ioùl.h
>

25 
	~<sys/sock‘.h
>

26 
	~<sys/ty³s.h
>

27 
	~<¡ršg
>

29 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

30 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

31 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

37 
boŞ
 
CÚv”tToSockaddr
(cÚ¡ 
SockaddrPrÙo
 &
š
, 
sockaddr
 **
out
,

38 
sockËn_t
 *
add¾’
) {

39 ià(!
	gout
è 
	gçl£
;

41 ià(
	gš
.
çmy_ÿ£
(è=ğ
SockaddrPrÙo
::
kSockaddrIn6
) {

42 
sockaddr_š6
 *
sock
 = 
¡©ic_ÿ¡
<sockaddr_in6 *>(

43 
ÿÎoc
(1, (
sockaddr_š6
)));

44 
	gsock
->
	gsš6_çmy
 = 
AF_INET6
;

45 
	gsock
->
	gsš6_pÜt
 = 
š
.
sockaddr_š6
().
sš6_pÜt
();

46 
	gsock
->
	gsš6_æowšfo
 = 
š
.
sockaddr_š6
().
sš6_æowšfo
();

47 
memıy
(&(
sock
->
sš6_addr
.
s6_addr
), 
š
.
sockaddr_š6
().sš6_addr().
c_¡r
(),

48 
kIn6AddrNumBy‹s
);

49 
	gsock
->
	gsš6_scİe_id
 = 
š
.
sockaddr_š6
().
sš6_scİe_id
();

50 *
	gout
 = 
»š‹½»t_ÿ¡
<
sockaddr
 *>(
sock
);

51 ià(
	gadd¾’
) {

52 *
	gadd¾’
 = (*
sock
);

54 } ià(
	gš
.
çmy_ÿ£
(è=ğ
SockaddrPrÙo
::
kSockaddrIn
) {

55 
sockaddr_š
 *
sock
 = 
¡©ic_ÿ¡
<sockaddr_in *>(

56 
ÿÎoc
(1, (
sockaddr_š
)));

57 
	gsock
->
	gsš_çmy
 = 
AF_INET
;

58 
	gsock
->
	gsš_pÜt
 = 
š
.
sockaddr_š
().
sš_pÜt
();

59 
	gsock
->
	gsš_addr
.
	gs_addr
 = 
š
.
sockaddr_š
().
sš_addr
();

60 *
	gout
 = 
»š‹½»t_ÿ¡
<
sockaddr
 *>(
sock
);

61 ià(
	gadd¾’
) {

62 *
	gadd¾’
 = (*
sock
);

65  
	gçl£
;

67  
	gŒue
;

70 
boŞ
 
CÚv”tToSockaddrPrÙobuf
(cÚ¡ 
sockaddr
 *
š
, 
SockaddrPrÙo
 *
out
,

71 *
”rÜ_code
) {

72 ià(!
	gš
 || !
	gout
è 
	gçl£
;

74 ià(
	gš
->
	g§_çmy
 =ğ
AF_INET6
) {

75 
SockaddrPrÙo
::
SockaddrIn6
 *
sock_š6_´Ùo
 = 
out
->
mubË_sockaddr_š6
();

76 cÚ¡ 
sockaddr_š6
 *
	gsock
 =

77 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
š
);

78 
	gsock_š6_´Ùo
->
£t_sš6_pÜt
(
sock
->
sš6_pÜt
);

79 
	gsock_š6_´Ùo
->
£t_sš6_æowšfo
(
sock
->
sš6_æowšfo
);

80 
	gsock_š6_´Ùo
->
£t_sš6_addr
(

81 
¡d
::
¡ršg
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&(
sock
->
sš6_addr
.
s6_addr
)),

82 
kIn6AddrNumBy‹s
));

83 
	gsock_š6_´Ùo
->
£t_sš6_scİe_id
(
sock
->
sš6_scİe_id
);

84 } ià(
	gš
->
	g§_çmy
 =ğ
AF_INET
) {

85 
SockaddrPrÙo
::
SockaddrIn
 *
sock_š_´Ùo
 = 
out
->
mubË_sockaddr_š
();

86 cÚ¡ 
sockaddr_š
 *
	gsock
 =

87 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
š
);

88 
	gsock_š_´Ùo
->
£t_sš_pÜt
(
sock
->
sš_pÜt
);

89 
	gsock_š_´Ùo
->
£t_sš_addr
(
sock
->
sš_addr
.
s_addr
);

91 *
	g”rÜ_code
 = 
BRIDGE_EAI_ADDRFAMILY
;

92  
	gçl£
;

94  
	gŒue
;

98 
boŞ
 
S‘AddršfoCªÚÇme
(cÚ¡ 
¡d
::
¡ršg
 *
ÿnÚÇme
, 
addršfo
 *
šfo
) {

99 
	gšfo
->
	gai_ÿnÚÇme
 = 
¡rdup
(
ÿnÚÇme
->
c_¡r
());

100 ià(
	gšfo
->
	gai_ÿnÚÇme
 =ğ
nuÎ±r
) {

101  
çl£
;

103  
	gŒue
;

106 
boŞ
 
CÚv”tToAddršfo
(cÚ¡ 
AddršfosPrÙo
 *
š
, 
addršfo
 **
out
) {

107 ià(!
	gš
 || !
	gout
è 
	gçl£
;

109 
addršfo
 *
	g´ev_šfo
 = 
nuÎ±r
;

110 
	gi
 = 0; i < 
	gš
->
addršfos
().
size
(); i++) {

111 cÚ¡ 
AddršfoPrÙo
 
	gšfo_´Ùo
 = 
š
->
addršfos
(
i
);

112 
addršfo
 *
	gšfo
 =

113 
¡©ic_ÿ¡
<
addršfo
 *>(
m®loc
((addrinfo)));

114 ià(
	gšfo
 =ğ
nuÎ±r
è 
çl£
;

116 
mem£t
(
šfo
, 0, (
addršfo
));

117 
	gšfo
->
	gai_æags
 = 
FromBridgeAdd»ssInfoFÏgs
(
šfo_´Ùo
.
ai_æags
());

118 
	gšfo
->
	gai_çmy
 = 
FromBridgeAfFamy
(
šfo_´Ùo
.
ai_çmy
());

119 ià(
	gšfo
->
	gai_çmy
 == -1) {

120  
çl£
;

122 
	gšfo
->
	gai_sockty³
 = 
FromBridgeSock‘Ty³
(
šfo_´Ùo
.
ai_sockty³
());

123 ià(
	gšfo
->
	gai_sockty³
 == -1) {

124  
çl£
;

126 
	gšfo
->
	gai_´ÙocŞ
 = 
šfo_´Ùo
.
ai_´ÙocŞ
();

127 ià(
	gšfo_´Ùo
.
has_ai_addr
() &&

128 !
CÚv”tToSockaddr
(
šfo_´Ùo
.
ai_addr
(), &
šfo
->ai_addr,

129 &
šfo
->
ai_add¾’
)) {

130  
	gçl£
;

132 ià(
	gšfo_´Ùo
.
has_ai_ÿnÚÇme
() &&

133 !
S‘AddršfoCªÚÇme
(&
šfo_´Ùo
.
ai_ÿnÚÇme
(), 
šfo
)) {

134  
	gçl£
;

138 ià(!
	g´ev_šfo
) {

139 *
	gout
 = 
šfo
;

141 
	g´ev_šfo
->
	gai_Ãxt
 = 
šfo
;

143 
	g´ev_šfo
 = 
šfo
;

146  
	gŒue
;

151 
cÚ¡ex´
 
	gkMaxCªnÚÇmeL’
 = 4096;

152 
boŞ
 
CÚv”tToAddršfoPrÙobuf
(cÚ¡ 
addršfo
 *
š
, 
AddršfosPrÙo
 *
out
,

153 *
bridge_”rÜ_code
) {

154 ià(!
	gš
 || !
	gout
è 
	gçl£
;

156 cÚ¡ 
addršfo
 *
	gšfo
 = 
š
; infØ!ğ
nuÎ±r
;

157 
	gšfo
 = 
šfo
->
ai_Ãxt
) {

158 
AddršfoPrÙo
 *
šfo_´Ùo
 = 
out
->
add_addršfos
();

159 
	gšfo_´Ùo
->
£t_ai_æags
(
ToBridgeAdd»ssInfoFÏgs
(
šfo
->
ai_æags
));

160 
	gaf_çmy
 = 
ToBridgeAfFamy
(
šfo
->
ai_çmy
);

161 ià(
	gaf_çmy
 =ğ
BRIDGE_AF_UNSUPPORTED
) {

162 *
bridge_”rÜ_code
 = 
BRIDGE_EAI_ADDRFAMILY
;

163  
	gçl£
;

165 
	gšfo_´Ùo
->
£t_ai_çmy
(
af_çmy
);

166 
	gai_sockty³
 = 
ToBridgeSock‘Ty³
(
šfo
->
ai_sockty³
);

167 ià(
	gai_sockty³
 =ğ
BRIDGE_SOCK_UNSUPPORTED
) {

168 *
bridge_”rÜ_code
 = 
BRIDGE_EAI_SOCKTYPE
;

169  
	gçl£
;

171 
	gšfo_´Ùo
->
£t_ai_sockty³
(
ai_sockty³
);

174 
	gšfo_´Ùo
->
£t_ai_´ÙocŞ
(
šfo
->
ai_´ÙocŞ
);

175 ià(
	gšfo
->
	gai_addr
) {

176 
SockaddrPrÙo
 *
	gsock_´Ùo
 = 
šfo_´Ùo
->
mubË_ai_addr
();

177 ià(!
CÚv”tToSockaddrPrÙobuf
(
šfo
->
ai_addr
, 
sock_´Ùo
,

178 
bridge_”rÜ_code
)) {

179  
	gçl£
;

182 ià(
	gšfo
->
	gai_ÿnÚÇme
) {

183 
	gÿnÚÇme_Ën
 = 
¡ºËn
(
šfo
->
ai_ÿnÚÇme
, 
kMaxCªnÚÇmeL’
);

184 
	gšfo_´Ùo
->
£t_ai_ÿnÚÇme
(
šfo
->
ai_ÿnÚÇme
, 
ÿnÚÇme_Ën
);

188  
	gŒue
;

192 
CÚv”tToEpŞlEv’tPrÙobuf
(cÚ¡ 
•Şl_ev’t
 *
ev’t
,

193 
EpŞlEv’t
 *
ev’t_´Ùo
) {

194 
	gæags
 = 
ev’t
->
ev’ts
;

195 ià(
	gæags
 & 
	gEPOLLIN
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_IN
);

196 ià(
	gæags
 & 
	gEPOLLPRI
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_PRI
);

197 ià(
	gæags
 & 
	gEPOLLOUT
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_OUT
);

198 ià(
	gæags
 & 
	gEPOLLMSG
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_MSG
);

199 ià(
	gæags
 & 
	gEPOLLERR
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_ERR
);

200 ià(
	gæags
 & 
	gEPOLLHUP
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_HUP
);

201 ià(
	gæags
 & 
	gEPOLLRDHUP
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_RDHUP
);

202 ià(
	gæags
 & 
	gEPOLLWAKEUP
)

203 
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_WAKEUP
);

204 ià(
	gæags
 & 
	gEPOLLONESHOT
)

205 
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_ONESHOT
);

206 ià(
	gæags
 & 
	gEPOLLET
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_ET
);

207 
	gev’t_´Ùo
->
£t_d©a
(
ev’t
->
d©a
.
u64
);

210 
CÚv”tToEpŞlEv’t
(cÚ¡ 
EpŞlEv’t
 &
ev’t_´Ùo
,

211 
•Şl_ev’t
 *
ev’t
) {

212 
	gæags
 = 0;

213 
	gi
 = 0; i < 
	gev’t_´Ùo
.
ev’t_æags_size
(); ++i) {

214 
	gEpŞlEv’t
::
EpŞlEv’tFÏg
 
cu¼_æag
 = 
ev’t_´Ùo
.
ev’t_æags
(
i
);

215 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_IN
)

216 
æags
 |ğ
EPOLLIN
;

217 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_PRI
)

218 
æags
 |ğ
EPOLLPRI
;

219 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_OUT
)

220 
æags
 |ğ
EPOLLOUT
;

221 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_MSG
)

222 
æags
 |ğ
EPOLLMSG
;

223 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_ERR
)

224 
æags
 |ğ
EPOLLERR
;

225 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_HUP
)

226 
æags
 |ğ
EPOLLHUP
;

227 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_RDHUP
)

228 
æags
 |ğ
EPOLLRDHUP
;

229 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_WAKEUP
)

230 
æags
 |ğ
EPOLLWAKEUP
;

231 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_ONESHOT
)

232 
æags
 |ğ
EPOLLONESHOT
;

233 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_ET
)

234 
æags
 |ğ
EPOLLET
;

236 
	gev’t
->
	gev’ts
 = 
æags
;

237 
	gev’t
->
	gd©a
.
	gu64
 = 
ev’t_´Ùo
.
d©a
();

240 
boŞ
 
CÚv”tToEpŞlEv’tLi¡
(cÚ¡ 
•Şl_ev’t
 *
ev’ts
, 
numev’ts
,

241 
EpŞlEv’tLi¡
 *
ev’t_li¡
) {

242 ià(!
	gev’ts
 || !
	gev’t_li¡
è 
	gçl£
;

243 
	gi
 = 0; i < 
	gnumev’ts
; i++) {

244 
EpŞlEv’t
 *
	gev’t
 = 
ev’t_li¡
->
add_ev’ts
();

245 
CÚv”tToEpŞlEv’tPrÙobuf
(&
ev’ts
[
i
], 
ev’t
);

247  
	gŒue
;

250 
boŞ
 
CÚv”tToEpŞlEv’tSŒuùs
(cÚ¡ 
EpŞlEv’tLi¡
 &
ev’t_li¡
,

251 
•Şl_ev’t
 *
ev’ts
, *
numev’ts
) {

252 ià(!
	gev’ts
) {

253  
	gçl£
;

255 *
	gnumev’ts
 = 
ev’t_li¡
.
ev’ts
().
size
();

256 
	gi
 = 0; i < *
	gnumev’ts
; ++i) {

257 
CÚv”tToEpŞlEv’t
(
ev’t_li¡
.
ev’ts
(
i
), &events[i]);

259  
	gŒue
;

262 
	gEpŞlCArgs
::
EpŞlCOp
 
CÚv”tToPrÙoOp
(
ho¡_İ
) {

263 ià(
ho¡_İ
 =ğ
EPOLL_CTL_ADD
)

264  
EpŞlCArgs
::
PROTO_CTL_ADD
;

265 ià(
	gho¡_İ
 =ğ
EPOLL_CTL_DEL
)

266  
EpŞlCArgs
::
PROTO_CTL_DEL
;

267 ià(
	gho¡_İ
 =ğ
EPOLL_CTL_MOD
)

268  
EpŞlCArgs
::
PROTO_CTL_MOD
;

269  
	gEpŞlCArgs
::
UNSUPPORTED
;

272 
CÚv”tToHo¡Op
(
EpŞlCArgs
::
EpŞlCOp
 
´Ùo_İ
) {

273 ià(
´Ùo_İ
 =ğ
EpŞlCArgs
::
PROTO_CTL_ADD
)

274  
EPOLL_CTL_ADD
;

275 ià(
	g´Ùo_İ
 =ğ
EpŞlCArgs
::
PROTO_CTL_DEL
)

276  
EPOLL_CTL_DEL
;

277 ià(
	g´Ùo_İ
 =ğ
EpŞlCArgs
::
PROTO_CTL_MOD
)

278  
EPOLL_CTL_MOD
;

282 
boŞ
 
CÚv”tToEpŞlCArgsPrÙobuf
(
•fd
, 
İ
, 
fd
,

283 
•Şl_ev’t
 *
ev’t
,

284 
EpŞlCArgs
 *
¬gs
) {

285 ià((!
	gev’t
 && 
	gİ
 !ğ
EPOLL_CTL_DEL
è|| !
¬gs
è 
çl£
;

286 
	g¬gs
->
£t_•fd
(
•fd
);

287 
	g¬gs
->
£t_İ
(
CÚv”tToPrÙoOp
(
İ
));

288 
	g¬gs
->
£t_ho¡fd
(
fd
);

289 
EpŞlEv’t
 *
	gev’t_´Ùo
 = 
¬gs
->
mubË_ev’t
();

290 ià(
	gev’t
è
CÚv”tToEpŞlEv’tPrÙobuf
(
ev’t
, 
ev’t_´Ùo
);

291  
	gŒue
;

294 
boŞ
 
CÚv”tToEpŞlWa™ArgsPrÙobuf
(
•fd
, 
maxev’ts
, 
timeout
,

295 
EpŞlWa™Args
 *
¬gs
) {

296 ià(!
	g¬gs
è 
	gçl£
;

297 
	g¬gs
->
£t_•fd
(
•fd
);

298 
	g¬gs
->
£t_maxev’ts
(
maxev’ts
);

299 
	g¬gs
->
£t_timeout
(
timeout
);

300  
	gŒue
;

304 
FromPrÙoIffFÏgs
(cÚ¡ 
IfAddrPrÙo
 &
š
) {

305 
	gæags
 = 0;

306 
	gi
 = 0; i < 
	gš
.
iç_æags
().
size
(); ++i) {

307 
	gIfAddrPrÙo
::
IfAddrFÏg
 
cu¼_æag
 = 
š
.
iç_æags
(
i
);

308 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_UP
è
æags
 |ğ
IFF_UP
;

309 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_BROADCAST
è
æags
 |ğ
IFF_BROADCAST
;

310 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_DEBUG
è
æags
 |ğ
IFF_DEBUG
;

311 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_LOOPBACK
è
æags
 |ğ
IFF_LOOPBACK
;

312 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_POINTOPOINT
è
æags
 |ğ
IFF_POINTOPOINT
;

313 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_NOTRAILERS
è
æags
 |ğ
IFF_NOTRAILERS
;

314 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_RUNNING
è
æags
 |ğ
IFF_RUNNING
;

315 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_NOARP
è
æags
 |ğ
IFF_NOARP
;

316 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_PROMISC
è
æags
 |ğ
IFF_PROMISC
;

317 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_ALLMULTI
è
æags
 |ğ
IFF_ALLMULTI
;

318 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_MULTICAST
è
æags
 |ğ
IFF_MULTICAST
;

320  
	gæags
;

323 
ToPrÙoIffFÏgs
(
æags
, 
IfAddrPrÙo
 *
out
) {

324 ià(
	gæags
 & 
	gIFF_UP
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_UP
);

325 ià(
	gæags
 & 
	gIFF_BROADCAST
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_BROADCAST
);

326 ià(
	gæags
 & 
	gIFF_DEBUG
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_DEBUG
);

327 ià(
	gæags
 & 
	gIFF_LOOPBACK
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_LOOPBACK
);

328 ià(
	gæags
 & 
	gIFF_POINTOPOINT
)

329 
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_POINTOPOINT
);

330 ià(
	gæags
 & 
	gIFF_NOTRAILERS
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_NOTRAILERS
);

331 ià(
	gæags
 & 
	gIFF_RUNNING
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_RUNNING
);

332 ià(
	gæags
 & 
	gIFF_NOARP
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_NOARP
);

333 ià(
	gæags
 & 
	gIFF_PROMISC
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_PROMISC
);

334 ià(
	gæags
 & 
	gIFF_ALLMULTI
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_ALLMULTI
);

335 ià(
	gæags
 & 
	gIFF_MULTICAST
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_MULTICAST
);

338 
boŞ
 
CÚv”tToIfAddrs
(cÚ¡ 
IfAddrsPrÙo
 &
š
, 
içddrs
 **
out
) {

339 ià(!
	gout
è 
	gçl£
;

341 
içddrs
 *
	g´ev_içddr
 = 
nuÎ±r
;

342 
	gi
 = 0; i < 
	gš
.
içddrs
().
size
(); ++i) {

343 cÚ¡ 
	gIfAddrPrÙo
 &
	giçddr_´Ùo
 = 
š
.
içddrs
(
i
);

344 
içddrs
 *
	giçddr_node
 =

345 
¡©ic_ÿ¡
<
içddrs
 *>(
ÿÎoc
(1, (ifaddrs)));

346 ià(
	giçddr_node
 =ğ
nuÎ±r
) {

347 
F»eDe£rŸlizedIfAddrs
(*
out
);

348 *
	gout
 = 
nuÎ±r
;

349  
	gçl£
;

352 
	giçddr_node
->
	giç_Çme
 = 
¡rdup
(
içddr_´Ùo
.
iç_Çme
().
c_¡r
());

353 
	giçddr_node
->
	giç_æags
 = 
FromPrÙoIffFÏgs
(
içddr_´Ùo
);

354 ià((
	giçddr_´Ùo
.
has_iç_addr
() &&

355 !
CÚv”tToSockaddr
(
içddr_´Ùo
.
iç_addr
(), &
içddr_node
->ifa_addr,

356  
nuÎ±r
)) ||

357 (
	giçddr_´Ùo
.
has_iç_Ãtmask
() &&

358 !
CÚv”tToSockaddr
(
içddr_´Ùo
.
iç_Ãtmask
(),

359 &
içddr_node
->
iç_Ãtmask
, 
nuÎ±r
)) ||

360 (
	giçddr_´Ùo
.
has_iç_ifu
() &&

361 !
CÚv”tToSockaddr
(
içddr_´Ùo
.
iç_ifu
(),

362 &((
içddr_node
->
iç_ifu
).
ifu_d¡addr
),

363  
nuÎ±r
))) {

364 
F»eDe£rŸlizedIfAddrs
(*
out
);

365 *
	gout
 = 
nuÎ±r
;

366  
	gçl£
;

368 ià(!
	g´ev_içddr
) {

369 *
	gout
 = 
içddr_node
;

371 
	g´ev_içddr
->
	giç_Ãxt
 = 
içddr_node
;

373 
	g´ev_içddr
 = 
içddr_node
;

375  
	gŒue
;

379 
boŞ
 
IpCom¶ŸÁ
(cÚ¡ 
sockaddr
 *
addr
) {

380  (
	gaddr
->
	g§_çmy
 =ğ
AF_INET
è|| (
addr
->
§_çmy
 =ğ
AF_INET6
);

383 
boŞ
 
CÚv”tToIfAddrsPrÙobuf
(cÚ¡ 
içddrs
 *
š
, 
IfAddrsPrÙo
 *
out
) {

384 ià(!
	gš
 || !
	gout
è 
	gçl£
;

386 cÚ¡ 
içddrs
 *
	gcu¼
 = 
š
; cu¼ !ğ
nuÎ±r
;

387 
	gcu¼
 = 
cu¼
->
iç_Ãxt
) {

389 ià(!
IfAddrSuµÜ‹d
(
cu¼
)) ;

390 
IfAddrPrÙo
 *
	giçddr_´Ùo
 = 
out
->
add_içddrs
();

391 
	giçddr_´Ùo
->
£t_iç_Çme
(
cu¼
->
iç_Çme
);

392 
ToPrÙoIffFÏgs
(
cu¼
->
iç_æags
, 
içddr_´Ùo
);

395 
	g”rÜ_code
;

398 ià((
	gcu¼
->
	giç_addr
 &&

399 !
CÚv”tToSockaddrPrÙobuf
(

400 
cu¼
->
iç_addr
, 
içddr_´Ùo
->
mubË_iç_addr
(), &
”rÜ_code
)) ||

401 (
	gcu¼
->
	giç_Ãtmask
 &&

402 !
CÚv”tToSockaddrPrÙobuf
(
cu¼
->
iç_Ãtmask
,

403 
içddr_´Ùo
->
mubË_iç_Ãtmask
(),

404 &
”rÜ_code
)) ||

405 (
	gcu¼
->
	giç_ifu
.
	gifu_d¡addr
 &&

406 !
CÚv”tToSockaddrPrÙobuf
(
cu¼
->
iç_ifu
.
ifu_d¡addr
,

407 
içddr_´Ùo
->
mubË_iç_ifu
(),

408 &
”rÜ_code
))) {

412  
	gçl£
;

415  
	gŒue
;

418 
CÚv”tToInÙifyMaskPrÙo
(
ušt32_t
 
mask
,

419 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> *
mask_´Ùo
) {

420 ià(
mask
 & 
IN_ACCESS
è
mask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ACCESS
);

421 ià(
	gmask
 & 
	gIN_ATTRIB
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ATTRIB
);

422 ià(
	gmask
 & 
	gIN_CLOSE_WRITE
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_CLOSE_WRITE
);

423 ià(
	gmask
 & 
	gIN_CLOSE_NOWRITE
)

424 
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_CLOSE_NOWRITE
);

425 ià(
	gmask
 & 
	gIN_CREATE
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_CREATE
);

426 ià(
	gmask
 & 
	gIN_DELETE
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_DELETE
);

427 ià(
	gmask
 & 
	gIN_DELETE_SELF
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_DELETE_SELF
);

428 ià(
	gmask
 & 
	gIN_MODIFY
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MODIFY
);

429 ià(
	gmask
 & 
	gIN_MOVE_SELF
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MOVE_SELF
);

430 ià(
	gmask
 & 
	gIN_MOVED_FROM
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MOVED_FROM
);

431 ià(
	gmask
 & 
	gIN_MOVED_TO
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MOVED_TO
);

432 ià(
	gmask
 & 
	gIN_OPEN
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_OPEN
);

433 ià(
	gmask
 & 
	gIN_DONT_FOLLOW
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_DONT_FOLLOW
);

434 ià(
	gmask
 & 
	gIN_EXCL_UNLINK
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_EXCL_UNLINK
);

435 ià(
	gmask
 & 
	gIN_MASK_ADD
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MASK_ADD
);

436 ià(
	gmask
 & 
	gIN_ONESHOT
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ONESHOT
);

437 ià(
	gmask
 & 
	gIN_ONLYDIR
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ONLYDIR
);

438 ià(
	gmask
 & 
	gIN_IGNORED
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_IGNORED
);

439 ià(
	gmask
 & 
	gIN_ISDIR
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ISDIR
);

440 ià(
	gmask
 & 
	gIN_Q_OVERFLOW
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_Q_OVERFLOW
);

441 ià(
	gmask
 & 
	gIN_UNMOUNT
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_UNMOUNT
);

444 
ušt32_t
 
CÚv”tFromInÙifyMaskPrÙo
(

445 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
mask_´Ùo
) {

446 
ušt32_t
 
æags
 = 0;

447 
	gi
 = 0; i < 
	gmask_´Ùo
.
size
(); ++i) {

448 
	gcu¼_æag
 = 
mask_´Ùo
.
G‘
(
i
);

449 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ACCESS
)

450 
æags
 |ğ
IN_ACCESS
;

451 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ATTRIB
)

452 
æags
 |ğ
IN_ATTRIB
;

453 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_CLOSE_WRITE
)

454 
æags
 |ğ
IN_CLOSE_WRITE
;

455 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_CLOSE_NOWRITE
)

456 
æags
 |ğ
IN_CLOSE_NOWRITE
;

457 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_CREATE
)

458 
æags
 |ğ
IN_CREATE
;

459 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_DELETE
)

460 
æags
 |ğ
IN_DELETE
;

461 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_DELETE_SELF
)

462 
æags
 |ğ
IN_DELETE_SELF
;

463 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MODIFY
)

464 
æags
 |ğ
IN_MODIFY
;

465 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MOVE_SELF
)

466 
æags
 |ğ
IN_MOVE_SELF
;

467 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MOVED_FROM
)

468 
æags
 |ğ
IN_MOVED_FROM
;

469 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MOVED_TO
)

470 
æags
 |ğ
IN_MOVED_TO
;

471 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_OPEN
)

472 
æags
 |ğ
IN_OPEN
;

473 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_DONT_FOLLOW
)

474 
æags
 |ğ
IN_DONT_FOLLOW
;

475 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_EXCL_UNLINK
)

476 
æags
 |ğ
IN_EXCL_UNLINK
;

477 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MASK_ADD
)

478 
æags
 |ğ
IN_MASK_ADD
;

479 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ONESHOT
)

480 
æags
 |ğ
IN_ONESHOT
;

481 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ONLYDIR
)

482 
æags
 |ğ
IN_ONLYDIR
;

483 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_IGNORED
)

484 
æags
 |ğ
IN_IGNORED
;

485 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ISDIR
)

486 
æags
 |ğ
IN_ISDIR
;

487 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_Q_OVERFLOW
)

488 
æags
 |ğ
IN_Q_OVERFLOW
;

489 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_UNMOUNT
)

490 
æags
 |ğ
IN_UNMOUNT
;

492  
	gæags
;

495 
boŞ
 
CÚv”tToInÙifyAddW©chArgsPrÙobuf
(
fd
, 
ab¦
::
¡ršg_v›w
 
·thÇme
,

496 
ušt32_t
 
mask
,

497 
InÙifyAddW©chArgs
 *
¬gs
) {

498 ià(!
	g¬gs
è 
	gçl£
;

499 
	g¬gs
->
£t_fd
(
fd
);

500 
	g¬gs
->
£t_·thÇme
(
·thÇme
.
d©a
(),…©hÇme.
size
());

501 
CÚv”tToInÙifyMaskPrÙo
(
mask
, 
¬gs
->
mubË_mask
());

502  
	gŒue
;

505 
boŞ
 
CÚv”tToInÙifyRmW©chArgsPrÙobuf
(
fd
, 
wd
,

506 
InÙifyRmW©chArgs
 *
¬gs
) {

507 ià(!
	g¬gs
è 
	gçl£
;

508 
	g¬gs
->
£t_fd
(
fd
);

509 
	g¬gs
->
£t_wd
(
wd
);

510  
	gŒue
;

513 
boŞ
 
CÚv”tToInÙifyEv’tPrÙobuf
(cÚ¡ 
šÙify_ev’t
 *
ev’t
,

514 
InÙifyEv’t
 *
ev’t_´Ùo
) {

515 ià(!
	gev’t
 || !
	gev’t_´Ùo
è 
	gçl£
;

516 
	gev’t_´Ùo
->
£t_wd
(
ev’t
->
wd
);

517 
CÚv”tToInÙifyMaskPrÙo
(
ev’t
->
mask
, 
ev’t_´Ùo
->
mubË_mask
());

518 
	gev’t_´Ùo
->
£t_cook›
(
ev’t
->
cook›
);

519 ià(
	gev’t
->
	gËn
) {

520 
	gev’t_´Ùo
->
£t_Çme
(
ev’t
->
Çme
);

522  
	gŒue
;

525 
boŞ
 
CÚv”tToInÙifyEv’tLi¡
(*
buf
, 
size_t
 
buf_Ën
,

526 
InÙifyEv’tLi¡
 *
ev’t_li¡
) {

527 *
	gcu¼_ev’t_±r
 = 
buf
;

528 
	gcu¼_ev’t_±r
 < 
	gbuf
 + 
	gbuf_Ën
) {

529 
šÙify_ev’t
 *
	gcu¼_ev’t
 =

530 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
cu¼_ev’t_±r
);

531 ià(!
CÚv”tToInÙifyEv’tPrÙobuf
(
cu¼_ev’t
, 
ev’t_li¡
->
add_ev’ts
()))

532  
	gçl£
;

533 
	gcu¼_ev’t_±r
 +ğ(
šÙify_ev’t
è+ 
cu¼_ev’t
->
Ën
;

535  
	gŒue
;

538 
AddToInÙifyEv’tQueue
(cÚ¡ 
InÙifyEv’tLi¡
 &
ev’t_li¡
,

539 
¡d
::
queue
<
šÙify_ev’t
 *> *
ev’t_¡ruùs
) {

540 
i
 = 0; 
	gi
 < 
	gev’t_li¡
.
ev’ts
().
size
(); ++i) {

541 cÚ¡ 
	gInÙifyEv’t
 &
	gcu¼_ev’t
 = 
ev’t_li¡
.
ev’ts
(
i
);

543 
ušt32_t
 
	gËn
 = 0;

544 ià(
	gcu¼_ev’t
.
has_Çme
()) {

545 
	gËn
 = 
cu¼_ev’t
.
Çme
().
Ëngth
() + 1;

548 
šÙify_ev’t
 *
	gÃw_ev’t_¡ruù
 =

549 
¡©ic_ÿ¡
<
šÙify_ev’t
 *>(

550 
m®loc
((
šÙify_ev’t
è+ 
Ën
));

551 
	gÃw_ev’t_¡ruù
->
	gwd
 = 
cu¼_ev’t
.
wd
();

552 
	gÃw_ev’t_¡ruù
->
	gmask
 = 
CÚv”tFromInÙifyMaskPrÙo
(
cu¼_ev’t
.
mask
());

553 
	gÃw_ev’t_¡ruù
->
	gcook›
 = 
cu¼_ev’t
.
cook›
();

554 
	gÃw_ev’t_¡ruù
->
	gËn
 = 
Ën
;

555 ià(
	gËn
) {

556 
memıy
(
Ãw_ev’t_¡ruù
->
Çme
, 
cu¼_ev’t
.Çme().
c_¡r
(), 
Ën
);

558 
	gev’t_¡ruùs
->
push
(
Ãw_ev’t_¡ruù
);

563 
boŞ
 
CÚv”tToRecvFromArgs
(
sockfd
, 
size_t
 
Ën
, 
æags
,

564 
RecvFromArgs
 *
¬gs
) {

565 ià(!
	g¬gs
) {

566  
	gçl£
;

568 
	g¬gs
->
£t_sockfd
(
sockfd
);

569 
	g¬gs
->
£t_Ën
(
Ën
);

570 ià(
	gæags
 & 
	gMSG_OOB
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_OOB
);

571 ià(
	gæags
 & 
	gMSG_PEEK
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_PEEK
);

572 ià(
	gæags
 & 
	gMSG_DONTROUTE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_DONTROUTE
);

573 ià(
	gæags
 & 
	gMSG_CTRUNC
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_CTRUNC
);

574 ià(
	gæags
 & 
	gMSG_PROXY
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_PROXY
);

575 ià(
	gæags
 & 
	gMSG_TRUNC
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_TRUNC
);

576 ià(
	gæags
 & 
	gMSG_DONTWAIT
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_DONTWAIT
);

577 ià(
	gæags
 & 
	gMSG_EOR
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_EOR
);

578 ià(
	gæags
 & 
	gMSG_WAITALL
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_WAITALL
);

579 ià(
	gæags
 & 
	gMSG_FIN
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_FIN
);

580 ià(
	gæags
 & 
	gMSG_SYN
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_SYN
);

581 ià(
	gæags
 & 
	gMSG_CONFIRM
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_CONFIRM
);

582 ià(
	gæags
 & 
	gMSG_RST
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_RST
);

583 ià(
	gæags
 & 
	gMSG_ERRQUEUE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_ERRQUEUE
);

584 ià(
	gæags
 & 
	gMSG_NOSIGNAL
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_NOSIGNAL
);

585 ià(
	gæags
 & 
	gMSG_MORE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_MORE
);

586 ià(
	gæags
 & 
	gMSG_WAITFORONE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_WAITFORONE
);

587 ià(
	gæags
 & 
	gMSG_FASTOPEN
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_FASTOPEN
);

588 ià(
	gæags
 & 
	gMSG_CMSG_CLOEXEC
) {

589 
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_CMSG_CLOEXEC
);

591  
	gŒue
;

594 
boŞ
 
CÚv”tFromRecvFromArgsPrÙo
(cÚ¡ 
RecvFromArgs
 &
¬gs
, *
sockfd
,

595 
size_t
 *
Ën
, *
æags
) {

596 ià(!
	gsockfd
 || !
	gËn
 || !
	gæags
) {

597  
	gçl£
;

599 *
	gæags
 = 0;

600 *
	gsockfd
 = 
¬gs
.
sockfd
();

601 *
	gËn
 = 
¬gs
.
Ën
();

602 
	gi
 = 0; i < 
	g¬gs
.
æags
().
size
(); ++i) {

603 
	gcu¼_æag
 = 
¬gs
.
æags
(
i
);

604 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_OOB
è*
æags
 |ğ
MSG_OOB
;

605 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_PEEK
è*
æags
 |ğ
MSG_PEEK
;

606 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_DONTROUTE
è*
æags
 |ğ
MSG_DONTROUTE
;

607 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_CTRUNC
è*
æags
 |ğ
MSG_CTRUNC
;

608 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_PROXY
è*
æags
 |ğ
MSG_PROXY
;

609 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_TRUNC
è*
æags
 |ğ
MSG_TRUNC
;

610 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_DONTWAIT
è*
æags
 |ğ
MSG_DONTWAIT
;

611 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_EOR
è*
æags
 |ğ
MSG_EOR
;

612 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_WAITALL
è*
æags
 |ğ
MSG_WAITALL
;

613 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_FIN
è*
æags
 |ğ
MSG_FIN
;

614 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_SYN
è*
æags
 |ğ
MSG_SYN
;

615 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_CONFIRM
è*
æags
 |ğ
MSG_CONFIRM
;

616 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_RST
è*
æags
 |ğ
MSG_RST
;

617 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_ERRQUEUE
è*
æags
 |ğ
MSG_ERRQUEUE
;

618 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_NOSIGNAL
è*
æags
 |ğ
MSG_NOSIGNAL
;

619 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_MORE
è*
æags
 |ğ
MSG_MORE
;

620 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_WAITFORONE
è*
æags
 |ğ
MSG_WAITFORONE
;

621 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_FASTOPEN
è*
æags
 |ğ
MSG_FASTOPEN
;

622 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_CMSG_CLOEXEC
) {

623 *
æags
 |ğ
MSG_CMSG_CLOEXEC
;

626  
	gŒue
;

631 
boŞ
 
S”ŸlizeAddršfo
(cÚ¡ 
addršfo
 *
š
, 
¡d
::
¡ršg
 *
out
,

632 *
bridge_”rÜ_code
) {

633 
AddršfosPrÙo
 
	gaddršfo_´Ùobuf
;

634 ià(!
	gš
è 
	gaddršfo_´Ùobuf
.
S”ŸlizeToSŒšg
(
out
);

635  
CÚv”tToAddršfoPrÙobuf
(
š
, &
addršfo_´Ùobuf
, 
bridge_”rÜ_code
) &&

636 
	gaddršfo_´Ùobuf
.
S”ŸlizeToSŒšg
(
out
);

639 
boŞ
 
De£rŸlizeAddršfo
(cÚ¡ 
¡d
::
¡ršg
 *
š
, 
addršfo
 **
out
) {

640 
AddršfosPrÙo
 
	gaddršfo_´Ùobuf
;

641 ià(!
	gaddršfo_´Ùobuf
.
P¬£FromSŒšg
(*
š
)è 
	gçl£
;

642 ià(
	gaddršfo_´Ùobuf
.
addršfos_size
() == 0) {

643 *
out
 = 
nuÎ±r
;

644  
	gŒue
;

646  
CÚv”tToAddršfo
(&
addršfo_´Ùobuf
, 
out
);

649 
F»eDe£rŸlizedAddršfo
(
addršfo
 *
š
) {

650 
addršfo
 *
	g´ev_šfo
 = 
nuÎ±r
;

651 
addršfo
 *
	gšfo
 = 
š
; infØ!ğ
nuÎ±r
; infØğ
šfo
->
ai_Ãxt
) {

652 ià(
´ev_šfo
è
ä“
(prev_info);

653 ià(
	gšfo
->
	gai_addr
è
ä“
(
šfo
->
ai_addr
);

654 ià(
	gšfo
->
	gai_ÿnÚÇme
è
ä“
(
šfo
->
ai_ÿnÚÇme
);

655 
	g´ev_šfo
 = 
šfo
;

657 ià(
	g´ev_šfo
è
ä“
(
´ev_šfo
);

660 
boŞ
 
S”ŸlizeEpŞlCArgs
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
,

661 **
out
, 
size_t
 *
Ën
) {

662 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

663 
EpŞlCArgs
 
	g¬gs_´Ùo
;

664 ià(
CÚv”tToEpŞlCArgsPrÙobuf
(
•fd
, 
İ
, 
fd
, 
ev’t
, &
¬gs_´Ùo
)) {

665 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

667 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

668  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

670  
	gçl£
;

673 
boŞ
 
De£rŸlizeEpŞlCArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
•fd
, *
İ
, *
fd
,

674 
•Şl_ev’t
 *
ev’t
) {

675 ià(!
	g•fd
 || !
	gİ
 || !
	gfd
 || (!
	gev’t
 && *İ =ğ
EPOLL_CTL_DEL
)è 
çl£
;

676 
EpŞlCArgs
 
	g¬gs_´Ùo
;

677 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

678 *
	g•fd
 = 
¬gs_´Ùo
.
•fd
();

679 *
	gİ
 = 
CÚv”tToHo¡Op
(
¬gs_´Ùo
.
İ
());

680 *
	gfd
 = 
¬gs_´Ùo
.
ho¡fd
();

681 ià(
	g¬gs_´Ùo
.
has_ev’t
()è
CÚv”tToEpŞlEv’t
(
¬gs_´Ùo
.
ev’t
(),ƒvent);

682  
	gŒue
;

685 
boŞ
 
S”ŸlizeEpŞlWa™Args
(
•fd
, 
maxev’ts
, 
timeout
, **
out
,

686 
size_t
 *
Ën
) {

687 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

688 
EpŞlWa™Args
 
	g¬gs_´Ùo
;

689 ià(
CÚv”tToEpŞlWa™ArgsPrÙobuf
(
•fd
, 
maxev’ts
, 
timeout
, &
¬gs_´Ùo
)) {

690 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

692 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

693  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

695  
	gçl£
;

698 
boŞ
 
De£rŸlizeEpŞlWa™Args
(
ab¦
::
¡ršg_v›w
 
š
, *
•fd
, *
maxev’ts
,

699 *
timeout
) {

700 ià(!
	g•fd
 || !
	gmaxev’ts
è 
	gçl£
;

701 
EpŞlWa™Args
 
	g¬gs_´Ùo
;

702 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

703 *
	g•fd
 = 
¬gs_´Ùo
.
•fd
();

704 *
	gmaxev’ts
 = 
¬gs_´Ùo
.
maxev’ts
();

705 *
	gtimeout
 = 
¬gs_´Ùo
.
timeout
();

706  
	gŒue
;

709 
boŞ
 
S”ŸlizeEv’ts
(cÚ¡ 
•Şl_ev’t
 *
ev’ts
, 
numev’ts
,

710 **
out
, 
size_t
 *
Ën
) {

711 ià(!
	gev’ts
 || !
	gout
è 
	gçl£
;

712 
EpŞlEv’tLi¡
 
	gev’t_li¡_´Ùo
;

713 ià(
CÚv”tToEpŞlEv’tLi¡
(
ev’ts
, 
numev’ts
, &
ev’t_li¡_´Ùo
)) {

714 *
	gËn
 = 
ev’t_li¡_´Ùo
.
By‹SizeLÚg
();

716 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

717  
	gev’t_li¡_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

719  
	gçl£
;

722 
boŞ
 
De£rŸlizeEv’ts
(
ab¦
::
¡ršg_v›w
 
š
, 
•Şl_ev’t
 *
ev’ts
,

723 *
numev’ts
) {

724 ià(!
	gev’ts
 || !
	gnumev’ts
è 
	gçl£
;

725 
EpŞlEv’tLi¡
 
	gev’t_li¡_´Ùo
;

726 ià(!
	gev’t_li¡_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

727  
CÚv”tToEpŞlEv’tSŒuùs
(
ev’t_li¡_´Ùo
, 
ev’ts
, 
numev’ts
);

730 
boŞ
 
S”ŸlizeIfAddrs
(cÚ¡ 
içddrs
 *
š
, **
out
, 
size_t
 *
Ën
) {

731 
IfAddrsPrÙo
 
	giçddrs_´Ùo
;

732 ià(!
	gout
è 
	gçl£
;

734 ià(!
	gš
 || 
CÚv”tToIfAddrsPrÙobuf
(
š
, &
içddrs_´Ùo
)) {

735 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(
içddrs_´Ùo
.
By‹SizeLÚg
()));

736 *
	gËn
 = 
içddrs_´Ùo
.
By‹SizeLÚg
();

737  
	giçddrs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, 
içddrs_´Ùo
.
By‹SizeLÚg
());

739  
	gçl£
;

742 
boŞ
 
De£rŸlizeIfAddrs
(
ab¦
::
¡ršg_v›w
 
š
, 
içddrs
 **
out
) {

743 
IfAddrsPrÙo
 
	giçddrs_´Ùo
;

744 ià(!
	giçddrs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

745 ià(
	giçddrs_´Ùo
.
içddrs_size
() == 0) {

746 *
out
 = 
nuÎ±r
;

747  
	gŒue
;

749  
CÚv”tToIfAddrs
(
içddrs_´Ùo
, 
out
);

752 
F»eDe£rŸlizedIfAddrs
(
içddrs
 *
iç
) {

753 
içddrs
 *
	gcu¼
 = 
iç
;

754 
	gcu¼
 !ğ
nuÎ±r
) {

755 
içddrs
 *
Ãxt
 = 
cu¼
->
iç_Ãxt
;

756 
ä“
(
cu¼
->
iç_Çme
);

757 
ä“
(
cu¼
->
iç_addr
);

758 
ä“
(
cu¼
->
iç_Ãtmask
);

759 
ä“
(
cu¼
->
iç_ifu
.
ifu_d¡addr
);

760 
ä“
(
cu¼
);

761 
	gcu¼
 = 
Ãxt
;

765 
boŞ
 
IfAddrSuµÜ‹d
(cÚ¡ 
içddrs
 *
’Œy
) {

766 ià(
	g’Œy
->
	giç_addr
 && !
IpCom¶ŸÁ
(
’Œy
->
iç_addr
)è 
	gçl£
;

767 ià(
	g’Œy
->
	giç_Ãtmask
 && !
IpCom¶ŸÁ
(
’Œy
->
iç_Ãtmask
)è 
	gçl£
;

768 ià(
	g’Œy
->
	giç_ifu
.
	gifu_d¡addr
 && !
IpCom¶ŸÁ
(
’Œy
->
iç_ifu
.
ifu_d¡addr
)) {

769  
	gçl£
;

771  
	gŒue
;

774 
boŞ
 
S”ŸlizeInÙifyAddW©chArgs
(
fd
, 
ab¦
::
¡ršg_v›w
 
·thÇme
,

775 
ušt32_t
 
mask
, **
out
, 
size_t
 *
Ën
) {

776 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

777 
InÙifyAddW©chArgs
 
	g¬gs_´Ùo
;

778 ià(
CÚv”tToInÙifyAddW©chArgsPrÙobuf
(
fd
, 
·thÇme
, 
mask
, &
¬gs_´Ùo
)) {

779 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

781 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

782  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

784  
	gçl£
;

787 
boŞ
 
S”ŸlizeInÙifyRmW©chArgs
(
fd
, 
wd
, **
out
, 
size_t
 *
Ën
) {

788 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

789 
InÙifyRmW©chArgs
 
	g¬gs_´Ùo
;

790 ià(
CÚv”tToInÙifyRmW©chArgsPrÙobuf
(
fd
, 
wd
, &
¬gs_´Ùo
)) {

791 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

792 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

793  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

795  
	gçl£
;

798 
boŞ
 
De£rŸlizeInÙifyAddW©chArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
fd
,

799 **
·thÇme
, 
ušt32_t
 *
mask
) {

800 ià(!
	gfd
 || !
	g·thÇme
 || !
	gmask
è 
	gçl£
;

801 
InÙifyAddW©chArgs
 
	g¬gs_´Ùo
;

802 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

803 *
	gfd
 = 
¬gs_´Ùo
.
fd
();

805 *
	g·thÇme
 = 
¡rdup
(
¬gs_´Ùo
.
·thÇme
().
c_¡r
());

806 *
	gmask
 = 
CÚv”tFromInÙifyMaskPrÙo
(
¬gs_´Ùo
.
mask
());

807  
	gŒue
;

810 
boŞ
 
De£rŸlizeInÙifyRmW©chArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
fd
, *
wd
) {

811 ià(!
	gfd
 || !
	gwd
è 
	gçl£
;

812 
InÙifyRmW©chArgs
 
	g¬gs_´Ùo
;

813 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

814 *
	gfd
 = 
¬gs_´Ùo
.
fd
();

815 *
	gwd
 = 
¬gs_´Ùo
.
wd
();

816  
	gŒue
;

819 
boŞ
 
S”ŸlizeInÙifyEv’ts
(*
buf
, 
size_t
 
buf_Ën
, **
out
,

820 
size_t
 *
Ën
) {

821 
InÙifyEv’tLi¡
 
	gev’t_li¡_´Ùo
;

822 ià(
CÚv”tToInÙifyEv’tLi¡
(
buf
, 
buf_Ën
, &
ev’t_li¡_´Ùo
)) {

823 *
	gËn
 = 
ev’t_li¡_´Ùo
.
By‹SizeLÚg
();

825 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

826  
	gev’t_li¡_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

828  
	gçl£
;

831 
boŞ
 
De£rŸlizeInÙifyEv’ts
(
ab¦
::
¡ršg_v›w
 
š
,

832 
¡d
::
queue
<
šÙify_ev’t
 *> *
ev’ts
) {

833 ià(!
ev’ts
è 
çl£
;

834 
InÙifyEv’tLi¡
 
	gev’t_li¡_´Ùo
;

835 ià(!
	gev’t_li¡_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

836 
AddToInÙifyEv’tQueue
(
ev’t_li¡_´Ùo
, 
ev’ts
);

837  
	gŒue
;

840 
boŞ
 
S”ŸlizeRecvFromArgs
(
sockfd
, 
size_t
 
Ën
, 
æags
, **
out
,

841 
size_t
 *
out_Ën
) {

842 ià(!
	gout
 || !
	gout_Ën
) {

843  
	gçl£
;

845 
RecvFromArgs
 
	g¬gs_´Ùo
;

846 ià(
CÚv”tToRecvFromArgs
(
sockfd
, 
Ën
, 
æags
, &
¬gs_´Ùo
)) {

847 *
	gout_Ën
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

849 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
out_Ën
));

850  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
out_Ën
);

852  
	gçl£
;

855 
boŞ
 
De£rŸlizeRecvFromArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
sockfd
, 
size_t
 *
Ën
,

856 *
æags
) {

857 
RecvFromArgs
 
	g¬gs
;

858 ià(!
	g¬gs
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())) {

859  
	gçl£
;

861  
CÚv”tFromRecvFromArgsPrÙo
(
¬gs
, 
sockfd
, 
Ën
, 
æags
);

864 
boŞ
 
S”ŸlizeRecvFromSrcAddr
(
sockaddr
 *
¤c_addr
, **
out
,

865 
size_t
 *
out_Ën
, *
bridge_”rÜ_code
) {

866 
RecvFromSrcAddr
 
	gaddr_´Ùo
;

867 ià(!
	g¤c_addr
 || !
	gout
 || !
	gout_Ën
 ||

868 !
CÚv”tToSockaddrPrÙobuf
(
¤c_addr
, 
addr_´Ùo
.
mubË_¤c_addr
(),

869 
bridge_”rÜ_code
)) {

870  
	gçl£
;

872 *
	gout_Ën
 = 
addr_´Ùo
.
By‹SizeLÚg
();

874 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
out_Ën
));

875  
	gaddr_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
out_Ën
);

878 
boŞ
 
De£rŸlizeRecvFromSrcAddr
(
ab¦
::
¡ršg_v›w
 
š
,

879 
sockaddr
 **
¤c_addr
) {

880 
RecvFromSrcAddr
 
	gaddr_´Ùo
;

881 ià(!
	g¤c_addr
 || !
	gaddr_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())) {

882  
	gçl£
;

886  
CÚv”tToSockaddr
(
addr_´Ùo
.
¤c_addr
(), src_addr,

887  
nuÎ±r
);

	@platform/common/bridge_proto_serializer.cc

19 
	~<içddrs.h
>

20 
	~<Ãt/if.h
>

21 
	~<Ãtdb.h
>

22 
	~<sys/•Şl.h
>

23 
	~<sys/šÙify.h
>

24 
	~<sys/ioùl.h
>

25 
	~<sys/sock‘.h
>

26 
	~<sys/ty³s.h
>

27 
	~<¡ršg
>

29 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

30 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

31 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

37 
boŞ
 
CÚv”tToSockaddr
(cÚ¡ 
SockaddrPrÙo
 &
š
, 
sockaddr
 **
out
,

38 
sockËn_t
 *
add¾’
) {

39 ià(!
	gout
è 
	gçl£
;

41 ià(
	gš
.
çmy_ÿ£
(è=ğ
SockaddrPrÙo
::
kSockaddrIn6
) {

42 
sockaddr_š6
 *
sock
 = 
¡©ic_ÿ¡
<sockaddr_in6 *>(

43 
ÿÎoc
(1, (
sockaddr_š6
)));

44 
	gsock
->
	gsš6_çmy
 = 
AF_INET6
;

45 
	gsock
->
	gsš6_pÜt
 = 
š
.
sockaddr_š6
().
sš6_pÜt
();

46 
	gsock
->
	gsš6_æowšfo
 = 
š
.
sockaddr_š6
().
sš6_æowšfo
();

47 
memıy
(&(
sock
->
sš6_addr
.
s6_addr
), 
š
.
sockaddr_š6
().sš6_addr().
c_¡r
(),

48 
kIn6AddrNumBy‹s
);

49 
	gsock
->
	gsš6_scİe_id
 = 
š
.
sockaddr_š6
().
sš6_scİe_id
();

50 *
	gout
 = 
»š‹½»t_ÿ¡
<
sockaddr
 *>(
sock
);

51 ià(
	gadd¾’
) {

52 *
	gadd¾’
 = (*
sock
);

54 } ià(
	gš
.
çmy_ÿ£
(è=ğ
SockaddrPrÙo
::
kSockaddrIn
) {

55 
sockaddr_š
 *
sock
 = 
¡©ic_ÿ¡
<sockaddr_in *>(

56 
ÿÎoc
(1, (
sockaddr_š
)));

57 
	gsock
->
	gsš_çmy
 = 
AF_INET
;

58 
	gsock
->
	gsš_pÜt
 = 
š
.
sockaddr_š
().
sš_pÜt
();

59 
	gsock
->
	gsš_addr
.
	gs_addr
 = 
š
.
sockaddr_š
().
sš_addr
();

60 *
	gout
 = 
»š‹½»t_ÿ¡
<
sockaddr
 *>(
sock
);

61 ià(
	gadd¾’
) {

62 *
	gadd¾’
 = (*
sock
);

65  
	gçl£
;

67  
	gŒue
;

70 
boŞ
 
CÚv”tToSockaddrPrÙobuf
(cÚ¡ 
sockaddr
 *
š
, 
SockaddrPrÙo
 *
out
,

71 *
”rÜ_code
) {

72 ià(!
	gš
 || !
	gout
è 
	gçl£
;

74 ià(
	gš
->
	g§_çmy
 =ğ
AF_INET6
) {

75 
SockaddrPrÙo
::
SockaddrIn6
 *
sock_š6_´Ùo
 = 
out
->
mubË_sockaddr_š6
();

76 cÚ¡ 
sockaddr_š6
 *
	gsock
 =

77 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
š
);

78 
	gsock_š6_´Ùo
->
£t_sš6_pÜt
(
sock
->
sš6_pÜt
);

79 
	gsock_š6_´Ùo
->
£t_sš6_æowšfo
(
sock
->
sš6_æowšfo
);

80 
	gsock_š6_´Ùo
->
£t_sš6_addr
(

81 
¡d
::
¡ršg
(
»š‹½»t_ÿ¡
<cÚ¡ *>(&(
sock
->
sš6_addr
.
s6_addr
)),

82 
kIn6AddrNumBy‹s
));

83 
	gsock_š6_´Ùo
->
£t_sš6_scİe_id
(
sock
->
sš6_scİe_id
);

84 } ià(
	gš
->
	g§_çmy
 =ğ
AF_INET
) {

85 
SockaddrPrÙo
::
SockaddrIn
 *
sock_š_´Ùo
 = 
out
->
mubË_sockaddr_š
();

86 cÚ¡ 
sockaddr_š
 *
	gsock
 =

87 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
š
);

88 
	gsock_š_´Ùo
->
£t_sš_pÜt
(
sock
->
sš_pÜt
);

89 
	gsock_š_´Ùo
->
£t_sš_addr
(
sock
->
sš_addr
.
s_addr
);

91 *
	g”rÜ_code
 = 
BRIDGE_EAI_ADDRFAMILY
;

92  
	gçl£
;

94  
	gŒue
;

98 
boŞ
 
S‘AddršfoCªÚÇme
(cÚ¡ 
¡d
::
¡ršg
 *
ÿnÚÇme
, 
addršfo
 *
šfo
) {

99 
	gšfo
->
	gai_ÿnÚÇme
 = 
¡rdup
(
ÿnÚÇme
->
c_¡r
());

100 ià(
	gšfo
->
	gai_ÿnÚÇme
 =ğ
nuÎ±r
) {

101  
çl£
;

103  
	gŒue
;

106 
boŞ
 
CÚv”tToAddršfo
(cÚ¡ 
AddršfosPrÙo
 *
š
, 
addršfo
 **
out
) {

107 ià(!
	gš
 || !
	gout
è 
	gçl£
;

109 
addršfo
 *
	g´ev_šfo
 = 
nuÎ±r
;

110 
	gi
 = 0; i < 
	gš
->
addršfos
().
size
(); i++) {

111 cÚ¡ 
AddršfoPrÙo
 
	gšfo_´Ùo
 = 
š
->
addršfos
(
i
);

112 
addršfo
 *
	gšfo
 =

113 
¡©ic_ÿ¡
<
addršfo
 *>(
m®loc
((addrinfo)));

114 ià(
	gšfo
 =ğ
nuÎ±r
è 
çl£
;

116 
mem£t
(
šfo
, 0, (
addršfo
));

117 
	gšfo
->
	gai_æags
 = 
FromBridgeAdd»ssInfoFÏgs
(
šfo_´Ùo
.
ai_æags
());

118 
	gšfo
->
	gai_çmy
 = 
FromBridgeAfFamy
(
šfo_´Ùo
.
ai_çmy
());

119 ià(
	gšfo
->
	gai_çmy
 == -1) {

120  
çl£
;

122 
	gšfo
->
	gai_sockty³
 = 
FromBridgeSock‘Ty³
(
šfo_´Ùo
.
ai_sockty³
());

123 ià(
	gšfo
->
	gai_sockty³
 == -1) {

124  
çl£
;

126 
	gšfo
->
	gai_´ÙocŞ
 = 
šfo_´Ùo
.
ai_´ÙocŞ
();

127 ià(
	gšfo_´Ùo
.
has_ai_addr
() &&

128 !
CÚv”tToSockaddr
(
šfo_´Ùo
.
ai_addr
(), &
šfo
->ai_addr,

129 &
šfo
->
ai_add¾’
)) {

130  
	gçl£
;

132 ià(
	gšfo_´Ùo
.
has_ai_ÿnÚÇme
() &&

133 !
S‘AddršfoCªÚÇme
(&
šfo_´Ùo
.
ai_ÿnÚÇme
(), 
šfo
)) {

134  
	gçl£
;

138 ià(!
	g´ev_šfo
) {

139 *
	gout
 = 
šfo
;

141 
	g´ev_šfo
->
	gai_Ãxt
 = 
šfo
;

143 
	g´ev_šfo
 = 
šfo
;

146  
	gŒue
;

151 
cÚ¡ex´
 
	gkMaxCªnÚÇmeL’
 = 4096;

152 
boŞ
 
CÚv”tToAddršfoPrÙobuf
(cÚ¡ 
addršfo
 *
š
, 
AddršfosPrÙo
 *
out
,

153 *
bridge_”rÜ_code
) {

154 ià(!
	gš
 || !
	gout
è 
	gçl£
;

156 cÚ¡ 
addršfo
 *
	gšfo
 = 
š
; infØ!ğ
nuÎ±r
;

157 
	gšfo
 = 
šfo
->
ai_Ãxt
) {

158 
AddršfoPrÙo
 *
šfo_´Ùo
 = 
out
->
add_addršfos
();

159 
	gšfo_´Ùo
->
£t_ai_æags
(
ToBridgeAdd»ssInfoFÏgs
(
šfo
->
ai_æags
));

160 
	gaf_çmy
 = 
ToBridgeAfFamy
(
šfo
->
ai_çmy
);

161 ià(
	gaf_çmy
 =ğ
BRIDGE_AF_UNSUPPORTED
) {

162 *
bridge_”rÜ_code
 = 
BRIDGE_EAI_ADDRFAMILY
;

163  
	gçl£
;

165 
	gšfo_´Ùo
->
£t_ai_çmy
(
af_çmy
);

166 
	gai_sockty³
 = 
ToBridgeSock‘Ty³
(
šfo
->
ai_sockty³
);

167 ià(
	gai_sockty³
 =ğ
BRIDGE_SOCK_UNSUPPORTED
) {

168 *
bridge_”rÜ_code
 = 
BRIDGE_EAI_SOCKTYPE
;

169  
	gçl£
;

171 
	gšfo_´Ùo
->
£t_ai_sockty³
(
ai_sockty³
);

174 
	gšfo_´Ùo
->
£t_ai_´ÙocŞ
(
šfo
->
ai_´ÙocŞ
);

175 ià(
	gšfo
->
	gai_addr
) {

176 
SockaddrPrÙo
 *
	gsock_´Ùo
 = 
šfo_´Ùo
->
mubË_ai_addr
();

177 ià(!
CÚv”tToSockaddrPrÙobuf
(
šfo
->
ai_addr
, 
sock_´Ùo
,

178 
bridge_”rÜ_code
)) {

179  
	gçl£
;

182 ià(
	gšfo
->
	gai_ÿnÚÇme
) {

183 
	gÿnÚÇme_Ën
 = 
¡ºËn
(
šfo
->
ai_ÿnÚÇme
, 
kMaxCªnÚÇmeL’
);

184 
	gšfo_´Ùo
->
£t_ai_ÿnÚÇme
(
šfo
->
ai_ÿnÚÇme
, 
ÿnÚÇme_Ën
);

188  
	gŒue
;

192 
CÚv”tToEpŞlEv’tPrÙobuf
(cÚ¡ 
•Şl_ev’t
 *
ev’t
,

193 
EpŞlEv’t
 *
ev’t_´Ùo
) {

194 
	gæags
 = 
ev’t
->
ev’ts
;

195 ià(
	gæags
 & 
	gEPOLLIN
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_IN
);

196 ià(
	gæags
 & 
	gEPOLLPRI
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_PRI
);

197 ià(
	gæags
 & 
	gEPOLLOUT
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_OUT
);

198 ià(
	gæags
 & 
	gEPOLLMSG
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_MSG
);

199 ià(
	gæags
 & 
	gEPOLLERR
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_ERR
);

200 ià(
	gæags
 & 
	gEPOLLHUP
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_HUP
);

201 ià(
	gæags
 & 
	gEPOLLRDHUP
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_RDHUP
);

202 ià(
	gæags
 & 
	gEPOLLWAKEUP
)

203 
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_WAKEUP
);

204 ià(
	gæags
 & 
	gEPOLLONESHOT
)

205 
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_ONESHOT
);

206 ià(
	gæags
 & 
	gEPOLLET
è
	gev’t_´Ùo
->
add_ev’t_æags
(
EpŞlEv’t
::
PROTO_ET
);

207 
	gev’t_´Ùo
->
£t_d©a
(
ev’t
->
d©a
.
u64
);

210 
CÚv”tToEpŞlEv’t
(cÚ¡ 
EpŞlEv’t
 &
ev’t_´Ùo
,

211 
•Şl_ev’t
 *
ev’t
) {

212 
	gæags
 = 0;

213 
	gi
 = 0; i < 
	gev’t_´Ùo
.
ev’t_æags_size
(); ++i) {

214 
	gEpŞlEv’t
::
EpŞlEv’tFÏg
 
cu¼_æag
 = 
ev’t_´Ùo
.
ev’t_æags
(
i
);

215 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_IN
)

216 
æags
 |ğ
EPOLLIN
;

217 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_PRI
)

218 
æags
 |ğ
EPOLLPRI
;

219 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_OUT
)

220 
æags
 |ğ
EPOLLOUT
;

221 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_MSG
)

222 
æags
 |ğ
EPOLLMSG
;

223 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_ERR
)

224 
æags
 |ğ
EPOLLERR
;

225 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_HUP
)

226 
æags
 |ğ
EPOLLHUP
;

227 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_RDHUP
)

228 
æags
 |ğ
EPOLLRDHUP
;

229 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_WAKEUP
)

230 
æags
 |ğ
EPOLLWAKEUP
;

231 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_ONESHOT
)

232 
æags
 |ğ
EPOLLONESHOT
;

233 ià(
	gcu¼_æag
 =ğ
EpŞlEv’t
::
PROTO_ET
)

234 
æags
 |ğ
EPOLLET
;

236 
	gev’t
->
	gev’ts
 = 
æags
;

237 
	gev’t
->
	gd©a
.
	gu64
 = 
ev’t_´Ùo
.
d©a
();

240 
boŞ
 
CÚv”tToEpŞlEv’tLi¡
(cÚ¡ 
•Şl_ev’t
 *
ev’ts
, 
numev’ts
,

241 
EpŞlEv’tLi¡
 *
ev’t_li¡
) {

242 ià(!
	gev’ts
 || !
	gev’t_li¡
è 
	gçl£
;

243 
	gi
 = 0; i < 
	gnumev’ts
; i++) {

244 
EpŞlEv’t
 *
	gev’t
 = 
ev’t_li¡
->
add_ev’ts
();

245 
CÚv”tToEpŞlEv’tPrÙobuf
(&
ev’ts
[
i
], 
ev’t
);

247  
	gŒue
;

250 
boŞ
 
CÚv”tToEpŞlEv’tSŒuùs
(cÚ¡ 
EpŞlEv’tLi¡
 &
ev’t_li¡
,

251 
•Şl_ev’t
 *
ev’ts
, *
numev’ts
) {

252 ià(!
	gev’ts
) {

253  
	gçl£
;

255 *
	gnumev’ts
 = 
ev’t_li¡
.
ev’ts
().
size
();

256 
	gi
 = 0; i < *
	gnumev’ts
; ++i) {

257 
CÚv”tToEpŞlEv’t
(
ev’t_li¡
.
ev’ts
(
i
), &events[i]);

259  
	gŒue
;

262 
	gEpŞlCArgs
::
EpŞlCOp
 
CÚv”tToPrÙoOp
(
ho¡_İ
) {

263 ià(
ho¡_İ
 =ğ
EPOLL_CTL_ADD
)

264  
EpŞlCArgs
::
PROTO_CTL_ADD
;

265 ià(
	gho¡_İ
 =ğ
EPOLL_CTL_DEL
)

266  
EpŞlCArgs
::
PROTO_CTL_DEL
;

267 ià(
	gho¡_İ
 =ğ
EPOLL_CTL_MOD
)

268  
EpŞlCArgs
::
PROTO_CTL_MOD
;

269  
	gEpŞlCArgs
::
UNSUPPORTED
;

272 
CÚv”tToHo¡Op
(
EpŞlCArgs
::
EpŞlCOp
 
´Ùo_İ
) {

273 ià(
´Ùo_İ
 =ğ
EpŞlCArgs
::
PROTO_CTL_ADD
)

274  
EPOLL_CTL_ADD
;

275 ià(
	g´Ùo_İ
 =ğ
EpŞlCArgs
::
PROTO_CTL_DEL
)

276  
EPOLL_CTL_DEL
;

277 ià(
	g´Ùo_İ
 =ğ
EpŞlCArgs
::
PROTO_CTL_MOD
)

278  
EPOLL_CTL_MOD
;

282 
boŞ
 
CÚv”tToEpŞlCArgsPrÙobuf
(
•fd
, 
İ
, 
fd
,

283 
•Şl_ev’t
 *
ev’t
,

284 
EpŞlCArgs
 *
¬gs
) {

285 ià((!
	gev’t
 && 
	gİ
 !ğ
EPOLL_CTL_DEL
è|| !
¬gs
è 
çl£
;

286 
	g¬gs
->
£t_•fd
(
•fd
);

287 
	g¬gs
->
£t_İ
(
CÚv”tToPrÙoOp
(
İ
));

288 
	g¬gs
->
£t_ho¡fd
(
fd
);

289 
EpŞlEv’t
 *
	gev’t_´Ùo
 = 
¬gs
->
mubË_ev’t
();

290 ià(
	gev’t
è
CÚv”tToEpŞlEv’tPrÙobuf
(
ev’t
, 
ev’t_´Ùo
);

291  
	gŒue
;

294 
boŞ
 
CÚv”tToEpŞlWa™ArgsPrÙobuf
(
•fd
, 
maxev’ts
, 
timeout
,

295 
EpŞlWa™Args
 *
¬gs
) {

296 ià(!
	g¬gs
è 
	gçl£
;

297 
	g¬gs
->
£t_•fd
(
•fd
);

298 
	g¬gs
->
£t_maxev’ts
(
maxev’ts
);

299 
	g¬gs
->
£t_timeout
(
timeout
);

300  
	gŒue
;

304 
FromPrÙoIffFÏgs
(cÚ¡ 
IfAddrPrÙo
 &
š
) {

305 
	gæags
 = 0;

306 
	gi
 = 0; i < 
	gš
.
iç_æags
().
size
(); ++i) {

307 
	gIfAddrPrÙo
::
IfAddrFÏg
 
cu¼_æag
 = 
š
.
iç_æags
(
i
);

308 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_UP
è
æags
 |ğ
IFF_UP
;

309 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_BROADCAST
è
æags
 |ğ
IFF_BROADCAST
;

310 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_DEBUG
è
æags
 |ğ
IFF_DEBUG
;

311 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_LOOPBACK
è
æags
 |ğ
IFF_LOOPBACK
;

312 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_POINTOPOINT
è
æags
 |ğ
IFF_POINTOPOINT
;

313 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_NOTRAILERS
è
æags
 |ğ
IFF_NOTRAILERS
;

314 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_RUNNING
è
æags
 |ğ
IFF_RUNNING
;

315 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_NOARP
è
æags
 |ğ
IFF_NOARP
;

316 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_PROMISC
è
æags
 |ğ
IFF_PROMISC
;

317 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_ALLMULTI
è
æags
 |ğ
IFF_ALLMULTI
;

318 ià(
	gcu¼_æag
 =ğ
IfAddrPrÙo
::
PROTO_MULTICAST
è
æags
 |ğ
IFF_MULTICAST
;

320  
	gæags
;

323 
ToPrÙoIffFÏgs
(
æags
, 
IfAddrPrÙo
 *
out
) {

324 ià(
	gæags
 & 
	gIFF_UP
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_UP
);

325 ià(
	gæags
 & 
	gIFF_BROADCAST
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_BROADCAST
);

326 ià(
	gæags
 & 
	gIFF_DEBUG
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_DEBUG
);

327 ià(
	gæags
 & 
	gIFF_LOOPBACK
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_LOOPBACK
);

328 ià(
	gæags
 & 
	gIFF_POINTOPOINT
)

329 
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_POINTOPOINT
);

330 ià(
	gæags
 & 
	gIFF_NOTRAILERS
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_NOTRAILERS
);

331 ià(
	gæags
 & 
	gIFF_RUNNING
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_RUNNING
);

332 ià(
	gæags
 & 
	gIFF_NOARP
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_NOARP
);

333 ià(
	gæags
 & 
	gIFF_PROMISC
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_PROMISC
);

334 ià(
	gæags
 & 
	gIFF_ALLMULTI
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_ALLMULTI
);

335 ià(
	gæags
 & 
	gIFF_MULTICAST
è
	gout
->
add_iç_æags
(
IfAddrPrÙo
::
PROTO_MULTICAST
);

338 
boŞ
 
CÚv”tToIfAddrs
(cÚ¡ 
IfAddrsPrÙo
 &
š
, 
içddrs
 **
out
) {

339 ià(!
	gout
è 
	gçl£
;

341 
içddrs
 *
	g´ev_içddr
 = 
nuÎ±r
;

342 
	gi
 = 0; i < 
	gš
.
içddrs
().
size
(); ++i) {

343 cÚ¡ 
	gIfAddrPrÙo
 &
	giçddr_´Ùo
 = 
š
.
içddrs
(
i
);

344 
içddrs
 *
	giçddr_node
 =

345 
¡©ic_ÿ¡
<
içddrs
 *>(
ÿÎoc
(1, (ifaddrs)));

346 ià(
	giçddr_node
 =ğ
nuÎ±r
) {

347 
F»eDe£rŸlizedIfAddrs
(*
out
);

348 *
	gout
 = 
nuÎ±r
;

349  
	gçl£
;

352 
	giçddr_node
->
	giç_Çme
 = 
¡rdup
(
içddr_´Ùo
.
iç_Çme
().
c_¡r
());

353 
	giçddr_node
->
	giç_æags
 = 
FromPrÙoIffFÏgs
(
içddr_´Ùo
);

354 ià((
	giçddr_´Ùo
.
has_iç_addr
() &&

355 !
CÚv”tToSockaddr
(
içddr_´Ùo
.
iç_addr
(), &
içddr_node
->ifa_addr,

356  
nuÎ±r
)) ||

357 (
	giçddr_´Ùo
.
has_iç_Ãtmask
() &&

358 !
CÚv”tToSockaddr
(
içddr_´Ùo
.
iç_Ãtmask
(),

359 &
içddr_node
->
iç_Ãtmask
, 
nuÎ±r
)) ||

360 (
	giçddr_´Ùo
.
has_iç_ifu
() &&

361 !
CÚv”tToSockaddr
(
içddr_´Ùo
.
iç_ifu
(),

362 &((
içddr_node
->
iç_ifu
).
ifu_d¡addr
),

363  
nuÎ±r
))) {

364 
F»eDe£rŸlizedIfAddrs
(*
out
);

365 *
	gout
 = 
nuÎ±r
;

366  
	gçl£
;

368 ià(!
	g´ev_içddr
) {

369 *
	gout
 = 
içddr_node
;

371 
	g´ev_içddr
->
	giç_Ãxt
 = 
içddr_node
;

373 
	g´ev_içddr
 = 
içddr_node
;

375  
	gŒue
;

379 
boŞ
 
IpCom¶ŸÁ
(cÚ¡ 
sockaddr
 *
addr
) {

380  (
	gaddr
->
	g§_çmy
 =ğ
AF_INET
è|| (
addr
->
§_çmy
 =ğ
AF_INET6
);

383 
boŞ
 
CÚv”tToIfAddrsPrÙobuf
(cÚ¡ 
içddrs
 *
š
, 
IfAddrsPrÙo
 *
out
) {

384 ià(!
	gš
 || !
	gout
è 
	gçl£
;

386 cÚ¡ 
içddrs
 *
	gcu¼
 = 
š
; cu¼ !ğ
nuÎ±r
;

387 
	gcu¼
 = 
cu¼
->
iç_Ãxt
) {

389 ià(!
IfAddrSuµÜ‹d
(
cu¼
)) ;

390 
IfAddrPrÙo
 *
	giçddr_´Ùo
 = 
out
->
add_içddrs
();

391 
	giçddr_´Ùo
->
£t_iç_Çme
(
cu¼
->
iç_Çme
);

392 
ToPrÙoIffFÏgs
(
cu¼
->
iç_æags
, 
içddr_´Ùo
);

395 
	g”rÜ_code
;

398 ià((
	gcu¼
->
	giç_addr
 &&

399 !
CÚv”tToSockaddrPrÙobuf
(

400 
cu¼
->
iç_addr
, 
içddr_´Ùo
->
mubË_iç_addr
(), &
”rÜ_code
)) ||

401 (
	gcu¼
->
	giç_Ãtmask
 &&

402 !
CÚv”tToSockaddrPrÙobuf
(
cu¼
->
iç_Ãtmask
,

403 
içddr_´Ùo
->
mubË_iç_Ãtmask
(),

404 &
”rÜ_code
)) ||

405 (
	gcu¼
->
	giç_ifu
.
	gifu_d¡addr
 &&

406 !
CÚv”tToSockaddrPrÙobuf
(
cu¼
->
iç_ifu
.
ifu_d¡addr
,

407 
içddr_´Ùo
->
mubË_iç_ifu
(),

408 &
”rÜ_code
))) {

412  
	gçl£
;

415  
	gŒue
;

418 
CÚv”tToInÙifyMaskPrÙo
(
ušt32_t
 
mask
,

419 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> *
mask_´Ùo
) {

420 ià(
mask
 & 
IN_ACCESS
è
mask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ACCESS
);

421 ià(
	gmask
 & 
	gIN_ATTRIB
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ATTRIB
);

422 ià(
	gmask
 & 
	gIN_CLOSE_WRITE
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_CLOSE_WRITE
);

423 ià(
	gmask
 & 
	gIN_CLOSE_NOWRITE
)

424 
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_CLOSE_NOWRITE
);

425 ià(
	gmask
 & 
	gIN_CREATE
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_CREATE
);

426 ià(
	gmask
 & 
	gIN_DELETE
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_DELETE
);

427 ià(
	gmask
 & 
	gIN_DELETE_SELF
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_DELETE_SELF
);

428 ià(
	gmask
 & 
	gIN_MODIFY
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MODIFY
);

429 ià(
	gmask
 & 
	gIN_MOVE_SELF
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MOVE_SELF
);

430 ià(
	gmask
 & 
	gIN_MOVED_FROM
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MOVED_FROM
);

431 ià(
	gmask
 & 
	gIN_MOVED_TO
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MOVED_TO
);

432 ià(
	gmask
 & 
	gIN_OPEN
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_OPEN
);

433 ià(
	gmask
 & 
	gIN_DONT_FOLLOW
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_DONT_FOLLOW
);

434 ià(
	gmask
 & 
	gIN_EXCL_UNLINK
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_EXCL_UNLINK
);

435 ià(
	gmask
 & 
	gIN_MASK_ADD
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_MASK_ADD
);

436 ià(
	gmask
 & 
	gIN_ONESHOT
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ONESHOT
);

437 ià(
	gmask
 & 
	gIN_ONLYDIR
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ONLYDIR
);

438 ià(
	gmask
 & 
	gIN_IGNORED
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_IGNORED
);

439 ià(
	gmask
 & 
	gIN_ISDIR
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_ISDIR
);

440 ià(
	gmask
 & 
	gIN_Q_OVERFLOW
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_Q_OVERFLOW
);

441 ià(
	gmask
 & 
	gIN_UNMOUNT
è
	gmask_´Ùo
->
Add
(
InÙifyFÏg
::
PROTO_UNMOUNT
);

444 
ušt32_t
 
CÚv”tFromInÙifyMaskPrÙo
(

445 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> &
mask_´Ùo
) {

446 
ušt32_t
 
æags
 = 0;

447 
	gi
 = 0; i < 
	gmask_´Ùo
.
size
(); ++i) {

448 
	gcu¼_æag
 = 
mask_´Ùo
.
G‘
(
i
);

449 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ACCESS
)

450 
æags
 |ğ
IN_ACCESS
;

451 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ATTRIB
)

452 
æags
 |ğ
IN_ATTRIB
;

453 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_CLOSE_WRITE
)

454 
æags
 |ğ
IN_CLOSE_WRITE
;

455 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_CLOSE_NOWRITE
)

456 
æags
 |ğ
IN_CLOSE_NOWRITE
;

457 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_CREATE
)

458 
æags
 |ğ
IN_CREATE
;

459 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_DELETE
)

460 
æags
 |ğ
IN_DELETE
;

461 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_DELETE_SELF
)

462 
æags
 |ğ
IN_DELETE_SELF
;

463 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MODIFY
)

464 
æags
 |ğ
IN_MODIFY
;

465 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MOVE_SELF
)

466 
æags
 |ğ
IN_MOVE_SELF
;

467 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MOVED_FROM
)

468 
æags
 |ğ
IN_MOVED_FROM
;

469 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MOVED_TO
)

470 
æags
 |ğ
IN_MOVED_TO
;

471 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_OPEN
)

472 
æags
 |ğ
IN_OPEN
;

473 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_DONT_FOLLOW
)

474 
æags
 |ğ
IN_DONT_FOLLOW
;

475 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_EXCL_UNLINK
)

476 
æags
 |ğ
IN_EXCL_UNLINK
;

477 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_MASK_ADD
)

478 
æags
 |ğ
IN_MASK_ADD
;

479 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ONESHOT
)

480 
æags
 |ğ
IN_ONESHOT
;

481 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ONLYDIR
)

482 
æags
 |ğ
IN_ONLYDIR
;

483 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_IGNORED
)

484 
æags
 |ğ
IN_IGNORED
;

485 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_ISDIR
)

486 
æags
 |ğ
IN_ISDIR
;

487 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_Q_OVERFLOW
)

488 
æags
 |ğ
IN_Q_OVERFLOW
;

489 ià(
	gcu¼_æag
 =ğ
InÙifyFÏg
::
PROTO_UNMOUNT
)

490 
æags
 |ğ
IN_UNMOUNT
;

492  
	gæags
;

495 
boŞ
 
CÚv”tToInÙifyAddW©chArgsPrÙobuf
(
fd
, 
ab¦
::
¡ršg_v›w
 
·thÇme
,

496 
ušt32_t
 
mask
,

497 
InÙifyAddW©chArgs
 *
¬gs
) {

498 ià(!
	g¬gs
è 
	gçl£
;

499 
	g¬gs
->
£t_fd
(
fd
);

500 
	g¬gs
->
£t_·thÇme
(
·thÇme
.
d©a
(),…©hÇme.
size
());

501 
CÚv”tToInÙifyMaskPrÙo
(
mask
, 
¬gs
->
mubË_mask
());

502  
	gŒue
;

505 
boŞ
 
CÚv”tToInÙifyRmW©chArgsPrÙobuf
(
fd
, 
wd
,

506 
InÙifyRmW©chArgs
 *
¬gs
) {

507 ià(!
	g¬gs
è 
	gçl£
;

508 
	g¬gs
->
£t_fd
(
fd
);

509 
	g¬gs
->
£t_wd
(
wd
);

510  
	gŒue
;

513 
boŞ
 
CÚv”tToInÙifyEv’tPrÙobuf
(cÚ¡ 
šÙify_ev’t
 *
ev’t
,

514 
InÙifyEv’t
 *
ev’t_´Ùo
) {

515 ià(!
	gev’t
 || !
	gev’t_´Ùo
è 
	gçl£
;

516 
	gev’t_´Ùo
->
£t_wd
(
ev’t
->
wd
);

517 
CÚv”tToInÙifyMaskPrÙo
(
ev’t
->
mask
, 
ev’t_´Ùo
->
mubË_mask
());

518 
	gev’t_´Ùo
->
£t_cook›
(
ev’t
->
cook›
);

519 ià(
	gev’t
->
	gËn
) {

520 
	gev’t_´Ùo
->
£t_Çme
(
ev’t
->
Çme
);

522  
	gŒue
;

525 
boŞ
 
CÚv”tToInÙifyEv’tLi¡
(*
buf
, 
size_t
 
buf_Ën
,

526 
InÙifyEv’tLi¡
 *
ev’t_li¡
) {

527 *
	gcu¼_ev’t_±r
 = 
buf
;

528 
	gcu¼_ev’t_±r
 < 
	gbuf
 + 
	gbuf_Ën
) {

529 
šÙify_ev’t
 *
	gcu¼_ev’t
 =

530 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
cu¼_ev’t_±r
);

531 ià(!
CÚv”tToInÙifyEv’tPrÙobuf
(
cu¼_ev’t
, 
ev’t_li¡
->
add_ev’ts
()))

532  
	gçl£
;

533 
	gcu¼_ev’t_±r
 +ğ(
šÙify_ev’t
è+ 
cu¼_ev’t
->
Ën
;

535  
	gŒue
;

538 
AddToInÙifyEv’tQueue
(cÚ¡ 
InÙifyEv’tLi¡
 &
ev’t_li¡
,

539 
¡d
::
queue
<
šÙify_ev’t
 *> *
ev’t_¡ruùs
) {

540 
i
 = 0; 
	gi
 < 
	gev’t_li¡
.
ev’ts
().
size
(); ++i) {

541 cÚ¡ 
	gInÙifyEv’t
 &
	gcu¼_ev’t
 = 
ev’t_li¡
.
ev’ts
(
i
);

543 
ušt32_t
 
	gËn
 = 0;

544 ià(
	gcu¼_ev’t
.
has_Çme
()) {

545 
	gËn
 = 
cu¼_ev’t
.
Çme
().
Ëngth
() + 1;

548 
šÙify_ev’t
 *
	gÃw_ev’t_¡ruù
 =

549 
¡©ic_ÿ¡
<
šÙify_ev’t
 *>(

550 
m®loc
((
šÙify_ev’t
è+ 
Ën
));

551 
	gÃw_ev’t_¡ruù
->
	gwd
 = 
cu¼_ev’t
.
wd
();

552 
	gÃw_ev’t_¡ruù
->
	gmask
 = 
CÚv”tFromInÙifyMaskPrÙo
(
cu¼_ev’t
.
mask
());

553 
	gÃw_ev’t_¡ruù
->
	gcook›
 = 
cu¼_ev’t
.
cook›
();

554 
	gÃw_ev’t_¡ruù
->
	gËn
 = 
Ën
;

555 ià(
	gËn
) {

556 
memıy
(
Ãw_ev’t_¡ruù
->
Çme
, 
cu¼_ev’t
.Çme().
c_¡r
(), 
Ën
);

558 
	gev’t_¡ruùs
->
push
(
Ãw_ev’t_¡ruù
);

563 
boŞ
 
CÚv”tToRecvFromArgs
(
sockfd
, 
size_t
 
Ën
, 
æags
,

564 
RecvFromArgs
 *
¬gs
) {

565 ià(!
	g¬gs
) {

566  
	gçl£
;

568 
	g¬gs
->
£t_sockfd
(
sockfd
);

569 
	g¬gs
->
£t_Ën
(
Ën
);

570 ià(
	gæags
 & 
	gMSG_OOB
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_OOB
);

571 ià(
	gæags
 & 
	gMSG_PEEK
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_PEEK
);

572 ià(
	gæags
 & 
	gMSG_DONTROUTE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_DONTROUTE
);

573 ià(
	gæags
 & 
	gMSG_CTRUNC
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_CTRUNC
);

574 ià(
	gæags
 & 
	gMSG_PROXY
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_PROXY
);

575 ià(
	gæags
 & 
	gMSG_TRUNC
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_TRUNC
);

576 ià(
	gæags
 & 
	gMSG_DONTWAIT
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_DONTWAIT
);

577 ià(
	gæags
 & 
	gMSG_EOR
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_EOR
);

578 ià(
	gæags
 & 
	gMSG_WAITALL
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_WAITALL
);

579 ià(
	gæags
 & 
	gMSG_FIN
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_FIN
);

580 ià(
	gæags
 & 
	gMSG_SYN
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_SYN
);

581 ià(
	gæags
 & 
	gMSG_CONFIRM
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_CONFIRM
);

582 ià(
	gæags
 & 
	gMSG_RST
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_RST
);

583 ià(
	gæags
 & 
	gMSG_ERRQUEUE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_ERRQUEUE
);

584 ià(
	gæags
 & 
	gMSG_NOSIGNAL
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_NOSIGNAL
);

585 ià(
	gæags
 & 
	gMSG_MORE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_MORE
);

586 ià(
	gæags
 & 
	gMSG_WAITFORONE
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_WAITFORONE
);

587 ià(
	gæags
 & 
	gMSG_FASTOPEN
è
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_FASTOPEN
);

588 ià(
	gæags
 & 
	gMSG_CMSG_CLOEXEC
) {

589 
	g¬gs
->
add_æags
(
RecvS’dFÏgs
::
PROTO_CMSG_CLOEXEC
);

591  
	gŒue
;

594 
boŞ
 
CÚv”tFromRecvFromArgsPrÙo
(cÚ¡ 
RecvFromArgs
 &
¬gs
, *
sockfd
,

595 
size_t
 *
Ën
, *
æags
) {

596 ià(!
	gsockfd
 || !
	gËn
 || !
	gæags
) {

597  
	gçl£
;

599 *
	gæags
 = 0;

600 *
	gsockfd
 = 
¬gs
.
sockfd
();

601 *
	gËn
 = 
¬gs
.
Ën
();

602 
	gi
 = 0; i < 
	g¬gs
.
æags
().
size
(); ++i) {

603 
	gcu¼_æag
 = 
¬gs
.
æags
(
i
);

604 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_OOB
è*
æags
 |ğ
MSG_OOB
;

605 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_PEEK
è*
æags
 |ğ
MSG_PEEK
;

606 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_DONTROUTE
è*
æags
 |ğ
MSG_DONTROUTE
;

607 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_CTRUNC
è*
æags
 |ğ
MSG_CTRUNC
;

608 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_PROXY
è*
æags
 |ğ
MSG_PROXY
;

609 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_TRUNC
è*
æags
 |ğ
MSG_TRUNC
;

610 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_DONTWAIT
è*
æags
 |ğ
MSG_DONTWAIT
;

611 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_EOR
è*
æags
 |ğ
MSG_EOR
;

612 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_WAITALL
è*
æags
 |ğ
MSG_WAITALL
;

613 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_FIN
è*
æags
 |ğ
MSG_FIN
;

614 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_SYN
è*
æags
 |ğ
MSG_SYN
;

615 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_CONFIRM
è*
æags
 |ğ
MSG_CONFIRM
;

616 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_RST
è*
æags
 |ğ
MSG_RST
;

617 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_ERRQUEUE
è*
æags
 |ğ
MSG_ERRQUEUE
;

618 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_NOSIGNAL
è*
æags
 |ğ
MSG_NOSIGNAL
;

619 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_MORE
è*
æags
 |ğ
MSG_MORE
;

620 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_WAITFORONE
è*
æags
 |ğ
MSG_WAITFORONE
;

621 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_FASTOPEN
è*
æags
 |ğ
MSG_FASTOPEN
;

622 ià(
	gcu¼_æag
 =ğ
RecvS’dFÏgs
::
PROTO_CMSG_CLOEXEC
) {

623 *
æags
 |ğ
MSG_CMSG_CLOEXEC
;

626  
	gŒue
;

631 
boŞ
 
S”ŸlizeAddršfo
(cÚ¡ 
addršfo
 *
š
, 
¡d
::
¡ršg
 *
out
,

632 *
bridge_”rÜ_code
) {

633 
AddršfosPrÙo
 
	gaddršfo_´Ùobuf
;

634 ià(!
	gš
è 
	gaddršfo_´Ùobuf
.
S”ŸlizeToSŒšg
(
out
);

635  
CÚv”tToAddršfoPrÙobuf
(
š
, &
addršfo_´Ùobuf
, 
bridge_”rÜ_code
) &&

636 
	gaddršfo_´Ùobuf
.
S”ŸlizeToSŒšg
(
out
);

639 
boŞ
 
De£rŸlizeAddršfo
(cÚ¡ 
¡d
::
¡ršg
 *
š
, 
addršfo
 **
out
) {

640 
AddršfosPrÙo
 
	gaddršfo_´Ùobuf
;

641 ià(!
	gaddršfo_´Ùobuf
.
P¬£FromSŒšg
(*
š
)è 
	gçl£
;

642 ià(
	gaddršfo_´Ùobuf
.
addršfos_size
() == 0) {

643 *
out
 = 
nuÎ±r
;

644  
	gŒue
;

646  
CÚv”tToAddršfo
(&
addršfo_´Ùobuf
, 
out
);

649 
F»eDe£rŸlizedAddršfo
(
addršfo
 *
š
) {

650 
addršfo
 *
	g´ev_šfo
 = 
nuÎ±r
;

651 
addršfo
 *
	gšfo
 = 
š
; infØ!ğ
nuÎ±r
; infØğ
šfo
->
ai_Ãxt
) {

652 ià(
´ev_šfo
è
ä“
(prev_info);

653 ià(
	gšfo
->
	gai_addr
è
ä“
(
šfo
->
ai_addr
);

654 ià(
	gšfo
->
	gai_ÿnÚÇme
è
ä“
(
šfo
->
ai_ÿnÚÇme
);

655 
	g´ev_šfo
 = 
šfo
;

657 ià(
	g´ev_šfo
è
ä“
(
´ev_šfo
);

660 
boŞ
 
S”ŸlizeEpŞlCArgs
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
,

661 **
out
, 
size_t
 *
Ën
) {

662 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

663 
EpŞlCArgs
 
	g¬gs_´Ùo
;

664 ià(
CÚv”tToEpŞlCArgsPrÙobuf
(
•fd
, 
İ
, 
fd
, 
ev’t
, &
¬gs_´Ùo
)) {

665 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

667 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

668  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

670  
	gçl£
;

673 
boŞ
 
De£rŸlizeEpŞlCArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
•fd
, *
İ
, *
fd
,

674 
•Şl_ev’t
 *
ev’t
) {

675 ià(!
	g•fd
 || !
	gİ
 || !
	gfd
 || (!
	gev’t
 && *İ =ğ
EPOLL_CTL_DEL
)è 
çl£
;

676 
EpŞlCArgs
 
	g¬gs_´Ùo
;

677 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

678 *
	g•fd
 = 
¬gs_´Ùo
.
•fd
();

679 *
	gİ
 = 
CÚv”tToHo¡Op
(
¬gs_´Ùo
.
İ
());

680 *
	gfd
 = 
¬gs_´Ùo
.
ho¡fd
();

681 ià(
	g¬gs_´Ùo
.
has_ev’t
()è
CÚv”tToEpŞlEv’t
(
¬gs_´Ùo
.
ev’t
(),ƒvent);

682  
	gŒue
;

685 
boŞ
 
S”ŸlizeEpŞlWa™Args
(
•fd
, 
maxev’ts
, 
timeout
, **
out
,

686 
size_t
 *
Ën
) {

687 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

688 
EpŞlWa™Args
 
	g¬gs_´Ùo
;

689 ià(
CÚv”tToEpŞlWa™ArgsPrÙobuf
(
•fd
, 
maxev’ts
, 
timeout
, &
¬gs_´Ùo
)) {

690 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

692 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

693  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

695  
	gçl£
;

698 
boŞ
 
De£rŸlizeEpŞlWa™Args
(
ab¦
::
¡ršg_v›w
 
š
, *
•fd
, *
maxev’ts
,

699 *
timeout
) {

700 ià(!
	g•fd
 || !
	gmaxev’ts
è 
	gçl£
;

701 
EpŞlWa™Args
 
	g¬gs_´Ùo
;

702 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

703 *
	g•fd
 = 
¬gs_´Ùo
.
•fd
();

704 *
	gmaxev’ts
 = 
¬gs_´Ùo
.
maxev’ts
();

705 *
	gtimeout
 = 
¬gs_´Ùo
.
timeout
();

706  
	gŒue
;

709 
boŞ
 
S”ŸlizeEv’ts
(cÚ¡ 
•Şl_ev’t
 *
ev’ts
, 
numev’ts
,

710 **
out
, 
size_t
 *
Ën
) {

711 ià(!
	gev’ts
 || !
	gout
è 
	gçl£
;

712 
EpŞlEv’tLi¡
 
	gev’t_li¡_´Ùo
;

713 ià(
CÚv”tToEpŞlEv’tLi¡
(
ev’ts
, 
numev’ts
, &
ev’t_li¡_´Ùo
)) {

714 *
	gËn
 = 
ev’t_li¡_´Ùo
.
By‹SizeLÚg
();

716 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

717  
	gev’t_li¡_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

719  
	gçl£
;

722 
boŞ
 
De£rŸlizeEv’ts
(
ab¦
::
¡ršg_v›w
 
š
, 
•Şl_ev’t
 *
ev’ts
,

723 *
numev’ts
) {

724 ià(!
	gev’ts
 || !
	gnumev’ts
è 
	gçl£
;

725 
EpŞlEv’tLi¡
 
	gev’t_li¡_´Ùo
;

726 ià(!
	gev’t_li¡_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

727  
CÚv”tToEpŞlEv’tSŒuùs
(
ev’t_li¡_´Ùo
, 
ev’ts
, 
numev’ts
);

730 
boŞ
 
S”ŸlizeIfAddrs
(cÚ¡ 
içddrs
 *
š
, **
out
, 
size_t
 *
Ën
) {

731 
IfAddrsPrÙo
 
	giçddrs_´Ùo
;

732 ià(!
	gout
è 
	gçl£
;

734 ià(!
	gš
 || 
CÚv”tToIfAddrsPrÙobuf
(
š
, &
içddrs_´Ùo
)) {

735 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(
içddrs_´Ùo
.
By‹SizeLÚg
()));

736 *
	gËn
 = 
içddrs_´Ùo
.
By‹SizeLÚg
();

737  
	giçddrs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, 
içddrs_´Ùo
.
By‹SizeLÚg
());

739  
	gçl£
;

742 
boŞ
 
De£rŸlizeIfAddrs
(
ab¦
::
¡ršg_v›w
 
š
, 
içddrs
 **
out
) {

743 
IfAddrsPrÙo
 
	giçddrs_´Ùo
;

744 ià(!
	giçddrs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

745 ià(
	giçddrs_´Ùo
.
içddrs_size
() == 0) {

746 *
out
 = 
nuÎ±r
;

747  
	gŒue
;

749  
CÚv”tToIfAddrs
(
içddrs_´Ùo
, 
out
);

752 
F»eDe£rŸlizedIfAddrs
(
içddrs
 *
iç
) {

753 
içddrs
 *
	gcu¼
 = 
iç
;

754 
	gcu¼
 !ğ
nuÎ±r
) {

755 
içddrs
 *
Ãxt
 = 
cu¼
->
iç_Ãxt
;

756 
ä“
(
cu¼
->
iç_Çme
);

757 
ä“
(
cu¼
->
iç_addr
);

758 
ä“
(
cu¼
->
iç_Ãtmask
);

759 
ä“
(
cu¼
->
iç_ifu
.
ifu_d¡addr
);

760 
ä“
(
cu¼
);

761 
	gcu¼
 = 
Ãxt
;

765 
boŞ
 
IfAddrSuµÜ‹d
(cÚ¡ 
içddrs
 *
’Œy
) {

766 ià(
	g’Œy
->
	giç_addr
 && !
IpCom¶ŸÁ
(
’Œy
->
iç_addr
)è 
	gçl£
;

767 ià(
	g’Œy
->
	giç_Ãtmask
 && !
IpCom¶ŸÁ
(
’Œy
->
iç_Ãtmask
)è 
	gçl£
;

768 ià(
	g’Œy
->
	giç_ifu
.
	gifu_d¡addr
 && !
IpCom¶ŸÁ
(
’Œy
->
iç_ifu
.
ifu_d¡addr
)) {

769  
	gçl£
;

771  
	gŒue
;

774 
boŞ
 
S”ŸlizeInÙifyAddW©chArgs
(
fd
, 
ab¦
::
¡ršg_v›w
 
·thÇme
,

775 
ušt32_t
 
mask
, **
out
, 
size_t
 *
Ën
) {

776 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

777 
InÙifyAddW©chArgs
 
	g¬gs_´Ùo
;

778 ià(
CÚv”tToInÙifyAddW©chArgsPrÙobuf
(
fd
, 
·thÇme
, 
mask
, &
¬gs_´Ùo
)) {

779 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

781 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

782  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

784  
	gçl£
;

787 
boŞ
 
S”ŸlizeInÙifyRmW©chArgs
(
fd
, 
wd
, **
out
, 
size_t
 *
Ën
) {

788 ià(!
	gout
 || !
	gËn
è 
	gçl£
;

789 
InÙifyRmW©chArgs
 
	g¬gs_´Ùo
;

790 ià(
CÚv”tToInÙifyRmW©chArgsPrÙobuf
(
fd
, 
wd
, &
¬gs_´Ùo
)) {

791 *
	gËn
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

792 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

793  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

795  
	gçl£
;

798 
boŞ
 
De£rŸlizeInÙifyAddW©chArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
fd
,

799 **
·thÇme
, 
ušt32_t
 *
mask
) {

800 ià(!
	gfd
 || !
	g·thÇme
 || !
	gmask
è 
	gçl£
;

801 
InÙifyAddW©chArgs
 
	g¬gs_´Ùo
;

802 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

803 *
	gfd
 = 
¬gs_´Ùo
.
fd
();

805 *
	g·thÇme
 = 
¡rdup
(
¬gs_´Ùo
.
·thÇme
().
c_¡r
());

806 *
	gmask
 = 
CÚv”tFromInÙifyMaskPrÙo
(
¬gs_´Ùo
.
mask
());

807  
	gŒue
;

810 
boŞ
 
De£rŸlizeInÙifyRmW©chArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
fd
, *
wd
) {

811 ià(!
	gfd
 || !
	gwd
è 
	gçl£
;

812 
InÙifyRmW©chArgs
 
	g¬gs_´Ùo
;

813 ià(!
	g¬gs_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

814 *
	gfd
 = 
¬gs_´Ùo
.
fd
();

815 *
	gwd
 = 
¬gs_´Ùo
.
wd
();

816  
	gŒue
;

819 
boŞ
 
S”ŸlizeInÙifyEv’ts
(*
buf
, 
size_t
 
buf_Ën
, **
out
,

820 
size_t
 *
Ën
) {

821 
InÙifyEv’tLi¡
 
	gev’t_li¡_´Ùo
;

822 ià(
CÚv”tToInÙifyEv’tLi¡
(
buf
, 
buf_Ën
, &
ev’t_li¡_´Ùo
)) {

823 *
	gËn
 = 
ev’t_li¡_´Ùo
.
By‹SizeLÚg
();

825 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
Ën
));

826  
	gev’t_li¡_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
Ën
);

828  
	gçl£
;

831 
boŞ
 
De£rŸlizeInÙifyEv’ts
(
ab¦
::
¡ršg_v›w
 
š
,

832 
¡d
::
queue
<
šÙify_ev’t
 *> *
ev’ts
) {

833 ià(!
ev’ts
è 
çl£
;

834 
InÙifyEv’tLi¡
 
	gev’t_li¡_´Ùo
;

835 ià(!
	gev’t_li¡_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())è 
	gçl£
;

836 
AddToInÙifyEv’tQueue
(
ev’t_li¡_´Ùo
, 
ev’ts
);

837  
	gŒue
;

840 
boŞ
 
S”ŸlizeRecvFromArgs
(
sockfd
, 
size_t
 
Ën
, 
æags
, **
out
,

841 
size_t
 *
out_Ën
) {

842 ià(!
	gout
 || !
	gout_Ën
) {

843  
	gçl£
;

845 
RecvFromArgs
 
	g¬gs_´Ùo
;

846 ià(
CÚv”tToRecvFromArgs
(
sockfd
, 
Ën
, 
æags
, &
¬gs_´Ùo
)) {

847 *
	gout_Ën
 = 
¬gs_´Ùo
.
By‹SizeLÚg
();

849 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
out_Ën
));

850  
	g¬gs_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
out_Ën
);

852  
	gçl£
;

855 
boŞ
 
De£rŸlizeRecvFromArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
sockfd
, 
size_t
 *
Ën
,

856 *
æags
) {

857 
RecvFromArgs
 
	g¬gs
;

858 ià(!
	g¬gs
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())) {

859  
	gçl£
;

861  
CÚv”tFromRecvFromArgsPrÙo
(
¬gs
, 
sockfd
, 
Ën
, 
æags
);

864 
boŞ
 
S”ŸlizeRecvFromSrcAddr
(
sockaddr
 *
¤c_addr
, **
out
,

865 
size_t
 *
out_Ën
, *
bridge_”rÜ_code
) {

866 
RecvFromSrcAddr
 
	gaddr_´Ùo
;

867 ià(!
	g¤c_addr
 || !
	gout
 || !
	gout_Ën
 ||

868 !
CÚv”tToSockaddrPrÙobuf
(
¤c_addr
, 
addr_´Ùo
.
mubË_¤c_addr
(),

869 
bridge_”rÜ_code
)) {

870  
	gçl£
;

872 *
	gout_Ën
 = 
addr_´Ùo
.
By‹SizeLÚg
();

874 *
	gout
 = 
¡©ic_ÿ¡
<*>(
m®loc
(*
out_Ën
));

875  
	gaddr_´Ùo
.
S”ŸlizeToA¼ay
(*
out
, *
out_Ën
);

878 
boŞ
 
De£rŸlizeRecvFromSrcAddr
(
ab¦
::
¡ršg_v›w
 
š
,

879 
sockaddr
 **
¤c_addr
) {

880 
RecvFromSrcAddr
 
	gaddr_´Ùo
;

881 ià(!
	g¤c_addr
 || !
	gaddr_´Ùo
.
P¬£FromA¼ay
(
š
.
d©a
(), in.
Ëngth
())) {

882  
	gçl£
;

886  
CÚv”tToSockaddr
(
addr_´Ùo
.
¤c_addr
(), src_addr,

887  
nuÎ±r
);

	@platform/common/bridge_proto_serializer.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_BRIDGE_PROTO_SERIALIZER_H_


20 
	#ASYLO_PLATFORM_COMMON_BRIDGE_PROTO_SERIALIZER_H_


	)

22 
	~<queue
>

24 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

25 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_ty³s.pb.h
"

30 
Çme¥aû
 
	gasylo
 {

32 
cÚ¡ex´
 
	gkIn6AddrNumBy‹s
 = 16;

34 
boŞ
 
S”ŸlizeAddršfo
(cÚ¡ 
addršfo
 *
š
, 
¡d
::
¡ršg
 *
out
,

35 *
bridge_”rÜ_code
);

37 
boŞ
 
De£rŸlizeAddršfo
(cÚ¡ 
¡d
::
¡ršg
 *
š
, 
addršfo
 **
out
);

39 
F»eDe£rŸlizedAddršfo
(
addršfo
 *
š
);

41 
boŞ
 
S”ŸlizeIfAddrs
(cÚ¡ 
içddrs
 *
š
, **
out
, 
size_t
 *
Ën
);

43 
boŞ
 
De£rŸlizeIfAddrs
(
ab¦
::
¡ršg_v›w
 
š
, 
içddrs
 **
out
);

45 
F»eDe£rŸlizedIfAddrs
(
içddrs
 *
iç
);

47 
boŞ
 
S”ŸlizeRecvFromArgs
(
sockfd
, 
size_t
 
Ën
, 
æags
, **
out
,

48 
size_t
 *
out_Ën
);

50 
boŞ
 
De£rŸlizeRecvFromArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
sockfd
, 
size_t
 *
Ën
,

51 *
æags
);

53 
boŞ
 
S”ŸlizeRecvFromSrcAddr
(
sockaddr
 *
¤c_addr
, **
out
,

54 
size_t
 *
out_Ën
, *
bridge_”rÜ_code
);

56 
boŞ
 
De£rŸlizeRecvFromSrcAddr
(
ab¦
::
¡ršg_v›w
 
š
,

57 
sockaddr
 **
¤c_addr
);

62 
boŞ
 
IfAddrSuµÜ‹d
(cÚ¡ 
içddrs
 *
’Œy
);

64 
boŞ
 
S”ŸlizeEpŞlCArgs
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
,

65 **
out
, 
size_t
 *
Ën
);

67 
boŞ
 
S”ŸlizeEpŞlWa™Args
(
•fd
, 
maxev’ts
, 
timeout
, **
out
,

68 
size_t
 *
Ën
);

70 
boŞ
 
De£rŸlizeEpŞlCArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
•fd
, *
İ
, *
fd
,

71 
•Şl_ev’t
 *
ev’t
);

73 
boŞ
 
De£rŸlizeEpŞlWa™Args
(
ab¦
::
¡ršg_v›w
 
š
, *
•fd
, *
maxev’ts
,

74 *
timeout
);

76 
boŞ
 
S”ŸlizeEv’ts
(cÚ¡ 
•Şl_ev’t
 *
ev’ts
, 
numev’ts
,

77 **
out
, 
size_t
 *
Ën
);

79 
boŞ
 
De£rŸlizeEv’ts
(
ab¦
::
¡ršg_v›w
 
š
, 
•Şl_ev’t
 *
ev’ts
,

80 *
numev’ts
);

82 
boŞ
 
S”ŸlizeInÙifyAddW©chArgs
(
fd
, 
ab¦
::
¡ršg_v›w
 
·thÇme
,

83 
ušt32_t
 
mask
, **
out
, 
size_t
 *
Ën
);

85 
boŞ
 
S”ŸlizeInÙifyRmW©chArgs
(
fd
, 
wd
, **
out
, 
size_t
 *
Ën
);

87 
boŞ
 
De£rŸlizeInÙifyAddW©chArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
fd
,

88 **
·thÇme
, 
ušt32_t
 *
mask
);

90 
boŞ
 
De£rŸlizeInÙifyRmW©chArgs
(
ab¦
::
¡ršg_v›w
 
š
, *
fd
, *
wd
);

92 
boŞ
 
S”ŸlizeInÙifyEv’ts
(*
buf
, 
size_t
 
buf_Ën
, **
out
, size_ˆ*
Ën
);

94 
boŞ
 
De£rŸlizeInÙifyEv’ts
(
ab¦
::
¡ršg_v›w
 
š
,

95 
¡d
::
queue
<
šÙify_ev’t
 *> *
ev’ts
);

	@platform/common/bridge_types.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_BRIDGE_TYPES_H_


20 
	#ASYLO_PLATFORM_COMMON_BRIDGE_TYPES_H_


	)

22 
	~<Ãtdb.h
>

23 
	~<Ãtš‘/tı.h
>

24 
	~<sigÇl.h
>

25 
	~<¡dšt.h
>

26 
	~<sys/»sourû.h
>

27 
	~<sys/sock‘.h
>

28 
	~<sys/¡©.h
>

29 
	~<sys/wa™.h
>

30 
	~<sy¦og.h
>

32 
	~"ab¦/ba£/©Œibu‹s.h
"

37 #ifdeà
__ılu¥lus


43 
ušt64_t
 
	tbridge_size_t
;

44 
št64_t
 
	tbridge_ssize_t
;

45 
št64_t
 
	tbridge_sig£t_t
;

48 
	eFLockO³¿tiÚs
 {

49 
BRIDGE_LOCK_SH
 = 0x01,

50 
BRIDGE_LOCK_EX
 = 0x02,

51 
BRIDGE_LOCK_NB
 = 0x04,

52 
BRIDGE_LOCK_UN
 = 0x08,

57 
	eSyscÚfCÚ¡ªts
 {

58 
BRIDGE_SC_UNKNOWN
 = 0,

59 
BRIDGE_SC_NPROCESSORS_ONLN
 = 1,

60 
BRIDGE_SC_NPROCESSORS_CONF
 = 2,

64 
	eTim”Ty³
 {

65 
BRIDGE_ITIMER_UNKNOWN
 = 0,

66 
BRIDGE_ITIMER_REAL
 = 1,

67 
BRIDGE_ITIMER_VIRTUAL
 = 2,

68 
BRIDGE_ITIMER_PROF
 = 3,

72 
	eRU§geT¬g‘
 {

73 
BRIDGE_RUSAGE_UNKNOWN
 = 0,

74 
BRIDGE_RUSAGE_SELF
 = 1,

75 
BRIDGE_RUSAGE_CHILDREN
 = 2,

79 
	eWa™O±iÚs
 {

80 
BRIDGE_WNOHANG
 = 1,

87 
	eWStusCode
 {

88 
BRIDGE_WCODEBYTE
 = 0xff,

89 
BRIDGE_WSTOPPED
 = 0x7f,

92 
	sBridgeWStus
 {

93 
ušt8_t
 
code
;

94 
ušt8_t
 
šfo
;

98 
	eSigMaskAùiÚ
 {

99 
BRIDGE_SIG_SETMASK
 = 0,

100 
BRIDGE_SIG_BLOCK
 = 1,

101 
BRIDGE_SIG_UNBLOCK
 = 2,

106 
	eSigÇlNumb”
 {

107 
BRIDGE_SIGHUP
 = 1,

108 
BRIDGE_SIGINT
 = 2,

109 
BRIDGE_SIGQUIT
 = 3,

110 
BRIDGE_SIGILL
 = 4,

111 
BRIDGE_SIGTRAP
 = 5,

112 
BRIDGE_SIGABRT
 = 6,

113 
BRIDGE_SIGBUS
 = 7,

114 
BRIDGE_SIGFPE
 = 8,

115 
BRIDGE_SIGKILL
 = 9,

116 
BRIDGE_SIGUSR1
 = 10,

117 
BRIDGE_SIGSEGV
 = 11,

118 
BRIDGE_SIGUSR2
 = 12,

119 
BRIDGE_SIGPIPE
 = 13,

120 
BRIDGE_SIGALRM
 = 14,

121 
BRIDGE_SIGTERM
 = 15,

122 
BRIDGE_SIGCHLD
 = 16,

123 
BRIDGE_SIGCONT
 = 17,

124 
BRIDGE_SIGSTOP
 = 18,

125 
BRIDGE_SIGTSTP
 = 19,

126 
BRIDGE_SIGTTIN
 = 20,

127 
BRIDGE_SIGTTOU
 = 21,

128 
BRIDGE_SIGURG
 = 22,

129 
BRIDGE_SIGXCPU
 = 23,

130 
BRIDGE_SIGXFSZ
 = 24,

131 
BRIDGE_SIGVTALRM
 = 25,

132 
BRIDGE_SIGPROF
 = 26,

133 
BRIDGE_SIGWINCH
 = 27,

134 
BRIDGE_SIGSYS
 = 28,

135 
BRIDGE_SIGRTMIN
 = 32,

136 
BRIDGE_SIGRTMAX
 = 64,

140 
	eSigÇlCode
 {

141 
BRIDGE_SI_USER
 = 1,

142 
BRIDGE_SI_QUEUE
 = 2,

143 
BRIDGE_SI_TIMER
 = 3,

144 
BRIDGE_SI_ASYNCIO
 = 4,

145 
BRIDGE_SI_MESGQ
 = 5,

149 
	eSigÇlFÏgs
 {

150 
BRIDGE_SA_NODEFER
 = 0x01,

151 
BRIDGE_SA_RESETHAND
 = 0x02,

156 
	eAddrInfoFÏgs
 {

157 
BRIDGE_AI_CANONNAME
 = 0x0002,

158 
BRIDGE_AI_NUMERICHOST
 = 0x0004,

159 
BRIDGE_AI_V4MAPPED
 = 0x0008,

160 
BRIDGE_AI_ADDRCONFIG
 = 0x0010,

161 
BRIDGE_AI_ALL
 = 0x0020,

162 
BRIDGE_AI_PASSIVE
 = 0x0040,

163 
BRIDGE_AI_NUMERICSERV
 = 0x0080,

164 
BRIDGE_AI_IDN
 = 0x0100,

165 
BRIDGE_AI_CANONIDN
 = 0x0200,

169 
	eAddrInfoE¼ÜCode
 {

170 
BRIDGE_EAI_SUCCESS
 = 0,

171 
BRIDGE_EAI_ADDRFAMILY
 = 1,

172 
BRIDGE_EAI_AGAIN
 = 2,

173 
BRIDGE_EAI_BADFLAGS
 = 3,

174 
BRIDGE_EAI_FAIL
 = 4,

175 
BRIDGE_EAI_FAMILY
 = 5,

176 
BRIDGE_EAI_MEMORY
 = 6,

177 
BRIDGE_EAI_NODATA
 = 7,

178 
BRIDGE_EAI_NONAME
 = 8,

179 
BRIDGE_EAI_SERVICE
 = 9,

180 
BRIDGE_EAI_SOCKTYPE
 = 10,

181 
BRIDGE_EAI_SYSTEM
 = 11,

182 
BRIDGE_EAI_OVERFLOW
 = 12,

183 
BRIDGE_EAI_INPROGRESS
 = 13,

184 
BRIDGE_EAI_CANCELED
 = 14,

185 
BRIDGE_EAI_ALLDONE
 = 15,

186 
BRIDGE_EAI_INTR
 = 16,

187 
BRIDGE_EAI_IDN_ENCODE
 = 17,

188 
BRIDGE_EAI_UNKNOWN
 = 20,

193 
	eBridgeSock‘Ty³
 {

194 
BRIDGE_SOCK_UNSUPPORTED
 = 0,

195 
BRIDGE_SOCK_STREAM
 = 1,

196 
BRIDGE_SOCK_DGRAM
 = 2,

197 
BRIDGE_SOCK_SEQPACKET
 = 3,

198 
BRIDGE_SOCK_RAW
 = 4,

199 
BRIDGE_SOCK_RDM
 = 5,

200 
BRIDGE_SOCK_PACKET
 = 6,

202 
BRIDGE_SOCK_O_NONBLOCK
 = 0x0100,

203 
BRIDGE_SOCK_O_CLOEXEC
 = 0x0200,

204 
BRIDGE_SOCK_TYPE_FLAGS
 = 
BRIDGE_SOCK_O_NONBLOCK
 | 
BRIDGE_SOCK_O_CLOEXEC
,

208 
	eFeStusFÏgs
 {

209 
BRIDGE_RDONLY
 = 0x00,

210 
BRIDGE_WRONLY
 = 0x01,

211 
BRIDGE_RDWR
 = 0x02,

212 
BRIDGE_CREAT
 = 0x40,

213 
BRIDGE_EXCL
 = 0x80,

214 
BRIDGE_TRUNC
 = 0x200,

215 
BRIDGE_APPEND
 = 0x400,

216 
BRIDGE_NONBLOCK
 = 0x800,

217 
BRIDGE_DIRECT
 = 0x1000,

218 
BRIDGE_O_CLOEXEC
 = 0x2000,

221 
	eFeDesütÜFÏgs
 {

222 
BRIDGE_CLOEXEC
 = 0x01,

226 
	eSysLogO±iÚs
 {

227 
BRIDGE_LOG_PID
 = 0x01,

228 
BRIDGE_LOG_CONS
 = 0x02,

229 
BRIDGE_LOG_ODELAY
 = 0x04,

230 
BRIDGE_LOG_NDELAY
 = 0x08,

231 
BRIDGE_LOG_NOWAIT
 = 0x10,

232 
BRIDGE_LOG_PERROR
 = 0x20,

236 
	eSysLogFac™›s
 {

237 
BRIDGE_LOG_USER
 = 1 << 3,

238 
BRIDGE_LOG_LOCAL0
 = 16 << 3,

239 
BRIDGE_LOG_LOCAL1
 = 17 << 3,

240 
BRIDGE_LOG_LOCAL2
 = 18 << 3,

241 
BRIDGE_LOG_LOCAL3
 = 19 << 3,

242 
BRIDGE_LOG_LOCAL4
 = 20 << 3,

243 
BRIDGE_LOG_LOCAL5
 = 21 << 3,

244 
BRIDGE_LOG_LOCAL6
 = 22 << 3,

245 
BRIDGE_LOG_LOCAL7
 = 23 << 3,

250 
	eSysLogLev–
 {

251 
BRIDGE_LOG_EMERG
 = 0,

252 
BRIDGE_LOG_ALERT
 = 1,

253 
BRIDGE_LOG_CRIT
 = 2,

254 
BRIDGE_LOG_ERR
 = 3,

255 
BRIDGE_LOG_WARNING
 = 4,

256 
BRIDGE_LOG_NOTICE
 = 5,

257 
BRIDGE_LOG_INFO
 = 6,

258 
BRIDGE_LOG_DEBUG
 = 7,

262 
	eFúCommªds
 {

263 
BRIDGE_F_GETFD
 = 1,

264 
BRIDGE_F_SETFD
 = 2,

265 
BRIDGE_F_GETFL
 = 3,

266 
BRIDGE_F_SETFL
 = 4,

267 
BRIDGE_F_GETPIPE_SZ
 = 5,

268 
BRIDGE_F_SETPIPE_SZ
 = 6,

272 
	eTıO±iÚNames
 {

273 
BRIDGE_TCP_NODELAY
 = 1,

274 
BRIDGE_TCP_KEEPIDLE
 = 4,

275 
BRIDGE_TCP_KEEPINTVL
 = 5,

276 
BRIDGE_TCP_KEEPCNT
 = 6,

280 
	eIpV6O±iÚNames
 {

281 
BRIDGE_IPV6_V6ONLY
 = 1,

285 
	eSock‘O±iÚNames
 {

286 
BRIDGE_SO_DEBUG
 = 1,

287 
BRIDGE_SO_REUSEADDR
 = 2,

288 
BRIDGE_SO_TYPE
 = 3,

289 
BRIDGE_SO_ERROR
 = 4,

290 
BRIDGE_SO_DONTROUTE
 = 5,

291 
BRIDGE_SO_BROADCAST
 = 6,

292 
BRIDGE_SO_SNDBUF
 = 7,

293 
BRIDGE_SO_RCVBUF
 = 8,

294 
BRIDGE_SO_KEEPALIVE
 = 9,

295 
BRIDGE_SO_OOBINLINE
 = 10,

296 
BRIDGE_SO_NO_CHECK
 = 11,

297 
BRIDGE_SO_PRIORITY
 = 12,

298 
BRIDGE_SO_LINGER
 = 13,

299 
BRIDGE_SO_BSDCOMPAT
 = 14,

300 
BRIDGE_SO_REUSEPORT
 = 15,

301 
BRIDGE_SO_RCVTIMEO
 = 20,

302 
BRIDGE_SO_SNDTIMEO
 = 21,

303 
BRIDGE_SO_SNDBUFFORCE
 = 32,

304 
BRIDGE_SO_RCVBUFFORCE
 = 33,

307 
	eAfFamy
 {

308 
BRIDGE_AF_UNSUPPORTED
 = 0,

309 
BRIDGE_AF_INET
 = 1,

310 
BRIDGE_AF_INET6
 = 2,

311 
BRIDGE_AF_UNSPEC
 = 3,

312 
BRIDGE_AF_UNIX
 = 4,

313 
BRIDGE_AF_LOCAL
 = 5,

314 
BRIDGE_AF_IPX
 = 6,

315 
BRIDGE_AF_NETLINK
 = 7,

316 
BRIDGE_AF_X25
 = 8,

317 
BRIDGE_AF_AX25
 = 9,

318 
BRIDGE_AF_ATMPVC
 = 10,

319 
BRIDGE_AF_APPLETALK
 = 11,

320 
BRIDGE_AF_PACKET
 = 12,

321 
BRIDGE_AF_ALG
 = 13,

324 
	eBridgePŞlEv’ts
 {

325 
BRIDGE_POLLIN
 = 0x001,

326 
BRIDGE_POLLPRI
 = 0x002,

327 
BRIDGE_POLLOUT
 = 0x004,

328 
BRIDGE_POLLRDHUP
 = 0x008,

329 
BRIDGE_POLLERR
 = 0x010,

330 
BRIDGE_POLLHUP
 = 0x020,

331 
BRIDGE_POLLNVAL
 = 0x040,

332 
BRIDGE_POLLRDNORM
 = 0x080,

333 
BRIDGE_POLLRDBAND
 = 0x100,

334 
BRIDGE_POLLWRNORM
 = 0x200,

335 
BRIDGE_POLLWRBAND
 = 0x400,

338 
	sbridge_š_addr
 {

339 
ušt32_t
 
š‘_addr
;

340 } 
ABSL_ATTRIBUTE_PACKED
;

342 
	sbridge_š6_addr
 {

343 
ušt8_t
 
š‘6_addr
[16];

344 } 
ABSL_ATTRIBUTE_PACKED
;

346 
	sbridge_sockaddr_š6
 {

347 
ušt16_t
 
sš6_pÜt
;

348 
ušt32_t
 
sš6_æowšfo
;

349 
bridge_š6_addr
 
sš6_addr
;

350 
ušt32_t
 
sš6_scİe_id
;

351 } 
ABSL_ATTRIBUTE_PACKED
;

353 
	sbridge_sockaddr_š
 {

354 
ušt16_t
 
sš_pÜt
;

355 
bridge_š_addr
 
sš_addr
;

356 
sš_z”o
[8];

357 } 
ABSL_ATTRIBUTE_PACKED
;

359 
	sbridge_sockaddr_un
 {

360 
ušt32_t
 
Ën
;

361 
sun_·th
[108];

362 } 
ABSL_ATTRIBUTE_PACKED
;

369 
	sbridge_sockaddr
 {

370 
ušt16_t
 
§_çmy
;

372 
bridge_sockaddr_š
 
addr_š
;

373 
bridge_sockaddr_š6
 
addr_š6
;

374 
bridge_sockaddr_un
 
addr_un
;

375 } 
ABSL_ATTRIBUTE_PACKED
;

376 } 
ABSL_ATTRIBUTE_PACKED
;

378 
št64_t
 
	tbridge_şockid_t
;

380 
	sBridgeTms
 {

381 
şock_t
 
tms_utime
;

382 
şock_t
 
tms_¡ime
;

383 
şock_t
 
tms_cutime
;

384 
şock_t
 
tms_c¡ime
;

385 } 
ABSL_ATTRIBUTE_PACKED
;

387 
	sbridge_timev®
 {

388 
št64_t
 
tv_£c
;

389 
št64_t
 
tv_u£c
;

390 } 
ABSL_ATTRIBUTE_PACKED
;

392 
	sBridgeITim”V®
 {

393 
bridge_timev®
 
™_š‹rv®
;

394 
bridge_timev®
 
™_v®ue
;

395 } 
ABSL_ATTRIBUTE_PACKED
;

397 
	sbridge_time¥ec
 {

398 
št64_t
 
tv_£c
;

399 
št64_t
 
tv_n£c
;

400 } 
ABSL_ATTRIBUTE_PACKED
;

402 
	sbridge_utimbuf
 {

403 
št64_t
 
aùime
;

404 
št64_t
 
modtime
;

405 } 
ABSL_ATTRIBUTE_PACKED
;

407 
	sbridge_¡©
 {

408 
št64_t
 
¡_dev
;

409 
št64_t
 
¡_šo
;

410 
št64_t
 
¡_mode
;

411 
št64_t
 
¡_Æšk
;

412 
št64_t
 
¡_uid
;

413 
št64_t
 
¡_gid
;

414 
št64_t
 
¡_rdev
;

415 
št64_t
 
¡_size
;

416 
št64_t
 
¡_©ime_’c
;

417 
št64_t
 
¡_mtime_’c
;

418 
št64_t
 
¡_ùime_’c
;

419 
št64_t
 
¡_blksize
;

420 
št64_t
 
¡_blocks
;

421 } 
ABSL_ATTRIBUTE_PACKED
;

423 
	sbridge_pŞlfd
 {

424 
št32_t
 
fd
;

425 
št16_t
 
ev’ts
;

426 
št16_t
 
»v’ts
;

429 
	sbridge_msghdr
 {

430 *
msg_Çme
;

431 
ušt64_t
 
msg_Çm–’
;

432 
bridge_iovec
 *
msg_iov
;

433 
ušt64_t
 
msg_iovËn
;

434 *
msg_cÚŒŞ
;

435 
ušt64_t
 
msg_cÚŒŞËn
;

436 
št32_t
 
msg_æags
;

439 
	sbridge_iovec
 {

440 *
iov_ba£
;

441 
ušt64_t
 
iov_Ën
;

444 
	sbridge_sigšfo_t
 {

445 
št32_t
 
si_signo
;

446 
št32_t
 
si_code
;

449 
	sBridgeSigÇlHªdËr
 {

450 (*
sigaùiÚ
)(, 
bridge_sigšfo_t
 *, *);

451 
bridge_sig£t_t
 
mask
;

452 
æags
;

455 
	sBridgeRU§ge
 {

456 
bridge_timev®
 
ru_utime
;

457 
bridge_timev®
 
ru_¡ime
;

462 
	#BRIDGE_CPU_SET_MAX_CPUS
 1024

	)

464 
ušt64_t
 
	tBridgeCpuS‘WÜd
;

466 
	#BRIDGE_CPU_SET_NUM_WORDS
 \

467 ((
BRIDGE_CPU_SET_MAX_CPUS
 / 8 + (
BridgeCpuS‘WÜd
) - 1) / \

468 (
BridgeCpuS‘WÜd
))

	)

472 
	sBridgeCpuS‘
 {

473 
BridgeCpuS‘WÜd
 
wÜds
[
BRIDGE_CPU_SET_NUM_WORDS
];

474 } 
ABSL_ATTRIBUTE_PACKED
;

480 
	#BRIDGE_UTSNAME_FIELD_LENGTH
 256

	)

482 
	sBridgeUtsName
 {

483 
sy¢ame
[
BRIDGE_UTSNAME_FIELD_LENGTH
];

484 
nod’ame
[
BRIDGE_UTSNAME_FIELD_LENGTH
];

485 
»Ëa£
[
BRIDGE_UTSNAME_FIELD_LENGTH
];

486 
v”siÚ
[
BRIDGE_UTSNAME_FIELD_LENGTH
];

487 
machše
[
BRIDGE_UTSNAME_FIELD_LENGTH
];

491 
domašÇme
[
BRIDGE_UTSNAME_FIELD_LENGTH
];

494 #iâdeà
BRIDGE_FD_SETSIZE


495 
	#BRIDGE_FD_SETSIZE
 1024

	)

498 
	sBridgeFDS‘
 {

499 
ušt8_t
 
fe_desütÜ_£t
[
BRIDGE_FD_SETSIZE
];

504 
	#BRIDGE_PASSWD_FIELD_LENGTH
 1024

	)

506 
	sBridgePassWd
 {

507 
pw_Çme
[
BRIDGE_PASSWD_FIELD_LENGTH
];

508 
pw_·sswd
[
BRIDGE_PASSWD_FIELD_LENGTH
];

509 
uid_t
 
pw_uid
;

510 
gid_t
 
pw_gid
;

511 
pw_gecos
[
BRIDGE_PASSWD_FIELD_LENGTH
];

512 
pw_dœ
[
BRIDGE_PASSWD_FIELD_LENGTH
];

513 
pw_sh–l
[
BRIDGE_PASSWD_FIELD_LENGTH
];

516 #ifdeà
__ılu¥lus


	@platform/common/debug_strings.cc

19 
	~"asylo/¶©fÜm/commÚ/debug_¡ršgs.h
"

21 
	~<veùÜ
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"ab¦/ty³s/¥ª.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
	g¡d
::
¡ršg
 
ToHex
(
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
) {

32 
¡d
::
veùÜ
<> 
¡ršg_d©a
(1 + 
bufãr
.
size
() * 2, '\0');

33 
size_t
 
	gšdex
 = 0;

34 autØ
	gby‹
 : 
bufãr
) {

35 
¢´štf
(&
¡ršg_d©a
[
šdex
], sŒšg_d©a.
size
(è- index, "%02X", 
by‹
);

36 
	gšdex
 += 2;

38  
	g¡d
::
¡ršg
(
¡ršg_d©a
.
d©a
());

43 
	g¡d
::
¡ršg
 
bufãr_to_hex_¡ršg
(cÚ¡ *
buf
, 
nby‹s
) {

44 ià(!
	gbuf
) {

47 ià(
	gnby‹s
 < 0) {

48  
	gab¦
::
SŒC©
("[ERROR:‚eg©ivËngth ", 
nby‹s
, "]");

50 ià(
	gnby‹s
 == 0) {

53  
	gab¦
::
SŒC©
(

55 
ToHex
(
ab¦
::
MakeCÚ¡S·n
(
¡©ic_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
), 
nby‹s
)),

	@platform/common/debug_strings.cc

19 
	~"asylo/¶©fÜm/commÚ/debug_¡ršgs.h
"

21 
	~<veùÜ
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"ab¦/ty³s/¥ª.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
	g¡d
::
¡ršg
 
ToHex
(
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
) {

32 
¡d
::
veùÜ
<> 
¡ršg_d©a
(1 + 
bufãr
.
size
() * 2, '\0');

33 
size_t
 
	gšdex
 = 0;

34 autØ
	gby‹
 : 
bufãr
) {

35 
¢´štf
(&
¡ršg_d©a
[
šdex
], sŒšg_d©a.
size
(è- index, "%02X", 
by‹
);

36 
	gšdex
 += 2;

38  
	g¡d
::
¡ršg
(
¡ršg_d©a
.
d©a
());

43 
	g¡d
::
¡ršg
 
bufãr_to_hex_¡ršg
(cÚ¡ *
buf
, 
nby‹s
) {

44 ià(!
	gbuf
) {

47 ià(
	gnby‹s
 < 0) {

48  
	gab¦
::
SŒC©
("[ERROR:‚eg©ivËngth ", 
nby‹s
, "]");

50 ià(
	gnby‹s
 == 0) {

53  
	gab¦
::
SŒC©
(

55 
ToHex
(
ab¦
::
MakeCÚ¡S·n
(
¡©ic_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
), 
nby‹s
)),

	@platform/common/debug_strings.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_DEBUG_STRINGS_H_


20 
	#ASYLO_PLATFORM_COMMON_DEBUG_STRINGS_H_


	)

22 
	~<¡ršg
>

24 
Çme¥aû
 
	gasylo
 {

31 
	g¡d
::
¡ršg
 
bufãr_to_hex_¡ršg
(cÚ¡ *
buf
, 
nby‹s
);

	@platform/common/debug_strings_test.cc

19 
	~"asylo/¶©fÜm/commÚ/debug_¡ršgs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

26 
	gusšg
 ::
‹¡šg
::
Eq
;

27 
	gusšg
 ::
‹¡šg
::
SŒEq
;

29 
TEST
(
DebugSŒšgsTe¡
, 
NuÎ
) {

30 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
nuÎ±r
, 0), 
SŒEq
("null"));

33 
TEST
(
DebugSŒšgsTe¡
, 
Z”oL’gth
) {

34 
	gbufãr
[] = "abc";

35 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 0),

36 
SŒEq
("[]"));

39 
TEST
(
DebugSŒšgsTe¡
, 
Neg©iveL’gth
) {

40 
	gbufãr
[] = "abc";

41 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), -4),

42 
SŒEq
("[ERROR:‚egative†ength -4]"));

45 
TEST
(
DebugSŒšgsTe¡
, 
SšgËtÚNuÎBufãr
) {

46 
ušt8_t
 
	gbufãr
[] = {0};

47 
ASSERT_THAT
((
bufãr
), 
Eq
(1));

48 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 1),

49 
SŒEq
("[0x00]"));

52 
TEST
(
DebugSŒšgsTe¡
, 
NÚem±yBufãrDecim®Dig™s
) {

53 
	gbufãr
[] = "ABC";

54 
ASSERT_THAT
((
bufãr
), 
Eq
(4));

55 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 4),

56 
SŒEq
("[0x41424300]"));

59 
TEST
(
DebugSŒšgsTe¡
, 
NÚem±yBufãrHighDig™s
) {

60 
	gbufãr
[] = "[-]";

61 
ASSERT_THAT
((
bufãr
), 
Eq
(4));

62 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 4),

63 
SŒEq
("[0x5B2D5D00]"));

66 
TEST
(
DebugSŒšgsTe¡
, 
NÚem±yNuÎBufãr
) {

67 
ušt8_t
 
	gbufãr
[] = {0, 0, 0, 0};

68 
ASSERT_THAT
((
bufãr
), 
Eq
(4));

69 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 4),

70 
SŒEq
("[0x00000000]"));

	@platform/common/debug_strings_test.cc

19 
	~"asylo/¶©fÜm/commÚ/debug_¡ršgs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

26 
	gusšg
 ::
‹¡šg
::
Eq
;

27 
	gusšg
 ::
‹¡šg
::
SŒEq
;

29 
TEST
(
DebugSŒšgsTe¡
, 
NuÎ
) {

30 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
nuÎ±r
, 0), 
SŒEq
("null"));

33 
TEST
(
DebugSŒšgsTe¡
, 
Z”oL’gth
) {

34 
	gbufãr
[] = "abc";

35 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 0),

36 
SŒEq
("[]"));

39 
TEST
(
DebugSŒšgsTe¡
, 
Neg©iveL’gth
) {

40 
	gbufãr
[] = "abc";

41 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), -4),

42 
SŒEq
("[ERROR:‚egative†ength -4]"));

45 
TEST
(
DebugSŒšgsTe¡
, 
SšgËtÚNuÎBufãr
) {

46 
ušt8_t
 
	gbufãr
[] = {0};

47 
ASSERT_THAT
((
bufãr
), 
Eq
(1));

48 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 1),

49 
SŒEq
("[0x00]"));

52 
TEST
(
DebugSŒšgsTe¡
, 
NÚem±yBufãrDecim®Dig™s
) {

53 
	gbufãr
[] = "ABC";

54 
ASSERT_THAT
((
bufãr
), 
Eq
(4));

55 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 4),

56 
SŒEq
("[0x41424300]"));

59 
TEST
(
DebugSŒšgsTe¡
, 
NÚem±yBufãrHighDig™s
) {

60 
	gbufãr
[] = "[-]";

61 
ASSERT_THAT
((
bufãr
), 
Eq
(4));

62 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 4),

63 
SŒEq
("[0x5B2D5D00]"));

66 
TEST
(
DebugSŒšgsTe¡
, 
NÚem±yNuÎBufãr
) {

67 
ušt8_t
 
	gbufãr
[] = {0, 0, 0, 0};

68 
ASSERT_THAT
((
bufãr
), 
Eq
(4));

69 
EXPECT_THAT
(
bufãr_to_hex_¡ršg
(
¡©ic_ÿ¡
<cÚ¡ *>(
bufãr
), 4),

70 
SŒEq
("[0x00000000]"));

	@platform/common/futex.cc

19 
	~"asylo/¶©fÜm/commÚ/fu‹x.h
"

21 
	~<lšux/fu‹x.h
>

22 
	~<sys/sysÿÎ.h
>

23 
	~<sys/time.h
>

24 
	~<uni¡d.h
>

26 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

32 
sys_fu‹x
(
št32_t
 *
uaddr
, iÁ32_ˆ
fu‹x_İ
, iÁ32_ˆ
v®
,

33 cÚ¡ 
time¥ec
 *
timeout
, 
št32_t
 *
uaddr2
, iÁ32_ˆ
v®3
) {

34  
sysÿÎ
(
SYS_fu‹x
, 
uaddr
, 
fu‹x_İ
, 
v®
, 
timeout
, 
uaddr2
, 
v®3
);

41 
sys_fu‹x_wa™
(
št32_t
 *
fu‹x
, iÁ32_ˆ
ex³ùed
) {

42 
sys_fu‹x
(
fu‹x
, 
FUTEX_WAIT
, 
ex³ùed
, 
nuÎ±r
,‚ullptr, 0);

45 
sys_fu‹x_wake
(
št32_t
 *
fu‹x
) {

46 
sys_fu‹x
(
fu‹x
, 
FUTEX_WAKE
, 0, 
nuÎ±r
,‚ullptr, 0);

	@platform/common/futex.cc

19 
	~"asylo/¶©fÜm/commÚ/fu‹x.h
"

21 
	~<lšux/fu‹x.h
>

22 
	~<sys/sysÿÎ.h
>

23 
	~<sys/time.h
>

24 
	~<uni¡d.h
>

26 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

32 
sys_fu‹x
(
št32_t
 *
uaddr
, iÁ32_ˆ
fu‹x_İ
, iÁ32_ˆ
v®
,

33 cÚ¡ 
time¥ec
 *
timeout
, 
št32_t
 *
uaddr2
, iÁ32_ˆ
v®3
) {

34  
sysÿÎ
(
SYS_fu‹x
, 
uaddr
, 
fu‹x_İ
, 
v®
, 
timeout
, 
uaddr2
, 
v®3
);

41 
sys_fu‹x_wa™
(
št32_t
 *
fu‹x
, iÁ32_ˆ
ex³ùed
) {

42 
sys_fu‹x
(
fu‹x
, 
FUTEX_WAIT
, 
ex³ùed
, 
nuÎ±r
,‚ullptr, 0);

45 
sys_fu‹x_wake
(
št32_t
 *
fu‹x
) {

46 
sys_fu‹x
(
fu‹x
, 
FUTEX_WAKE
, 0, 
nuÎ±r
,‚ullptr, 0);

	@platform/common/futex.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_FUTEX_H_


20 
	#ASYLO_PLATFORM_COMMON_FUTEX_H_


	)

22 
	~<c¡dšt
>

29 
sys_fu‹x_wa™
(
št32_t
 *
fu‹x
, iÁ32_ˆ
ex³ùed
);

32 
sys_fu‹x_wake
(
št32_t
 *
fu‹x
);

	@platform/common/hash_combine.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_HASH_COMBINE_H_


20 
	#ASYLO_PLATFORM_COMMON_HASH_COMBINE_H_


	)

22 
	~<funùiÚ®
>

24 
Çme¥aû
 
	gasylo
 {

27 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

28 
size_t
 
HashCombše
(size_ˆ
£ed
, cÚ¡ 
T
 &
v®ue
) {

29 
size_t
 
	ghash
 = 
¡d
::
hash
<
T
>()(
v®ue
);

33  
	g£ed
 ^ (
	ghash
 + 0x9e3779b97f4a7c16 + (seed << 12) + (seed >> 4));

	@platform/common/memory.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_MEMORY_H_


20 
	#ASYLO_PLATFORM_COMMON_MEMORY_H_


	)

22 
	~<memÜy
>

24 
Çme¥aû
 
	gasylo
 {

28 
	sM®locD–‘”
 {

29 
šlše
 
İ”©Ü
()(*
	g±r
ècÚ¡ { 
ä“
(
±r
); }

32 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

33 
usšg
 
	gM®locUniquePŒ
 = 
¡d
::
unique_±r
<
T
, 
	gM®locD–‘”
>;

	@platform/common/ring_buffer.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_RING_BUFFER_H_


20 
	#ASYLO_PLATFORM_COMMON_RING_BUFFER_H_


	)

22 
	~<¬¿y
>

23 
	~<©omic
>

24 
	~<c¡ddef
>

25 
	~<c¡dšt
>

26 
	~<c¡dlib
>

27 
	~<c¡ršg
>

28 
	~<th»ad
>

30 
Çme¥aû
 
	gasylo
 {

61 
	g‹m¶©e
 <
size_t
 
	gkC­ac™y
>

62 
şass
 
	gRšgBufãrFÜTe¡
;

64 
	g‹m¶©e
 <
size_t
 
	gkC­ac™y
>

65 şas 
	cRšgBufãr
 {

66 
	gpublic
:

67 
¡©ic_as£¹
(
kC­ac™y
 > 1, "Minimum supported size iswoƒlements.");

73 
¡©ic_as£¹
((
¡d
::
©omic
<
size_t
>) == (size_t),

76 
RšgBufãr
()

77 : 
š¡ªû_v”siÚ_
(
RšgBufãr
<
kC­ac™y
>::
Ty³V”siÚ
()),

78 
şo£d_fÜ_»ad_
(0),

79 
şo£d_fÜ_wr™e_
(0),

80 
couÁ_
(0),

81 
»ad_pos_
(0),

82 
wr™e_pos_
(0) {}

84 
RšgBufãr
(cÚ¡ RšgBufãr<
kC­ac™y
> &èğ
d–‘e
;

86 
RšgBufãr
(RšgBufãr<
kC­ac™y
> &&èğ
d–‘e
;

88 
	gRšgBufãr
<
	gkC­ac™y
> &
	gİ”©Ü
=(cÚ¡ 
RšgBufãr
 &èğ
d–‘e
;

90 
	gRšgBufãr
<
	gkC­ac™y
> &
	gİ”©Ü
=(
RšgBufãr
 &&èğ
d–‘e
;

93 
size_t
 
R—d
(
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

94 ià(
	gşo£d_fÜ_»ad_
) {

98 
size_t
 
	g®»ady_»ad
 = 0;

99 
	gnby‹
 - 
	g®»ady_»ad
 > 0) {

100 
em±y
()) {

101 ià(
	gşo£d_fÜ_wr™e_
è 
	g®»ady_»ad
;

102 
	g¡d
::
this_th»ad
::
y›ld
();

104 
	g®»ady_»ad
 +ğ
NÚBlockšgR—d
(
buf
 + 
®»ady_»ad
, 
nby‹
 -‡lready_read);

106  
	g®»ady_»ad
;

110 
size_t
 
Wr™e
(cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

111 ià(
	gşo£d_fÜ_wr™e_
) {

115 
size_t
 
	g®»ady_wr™‹n
 = 0;

116 
	gnby‹
 - 
	g®»ady_wr™‹n
 > 0) {

117 
fuÎ
()) {

118 ià(
	gşo£d_fÜ_»ad_
è 
	g®»ady_wr™‹n
;

119 
	g¡d
::
this_th»ad
::
y›ld
();

121 
	g®»ady_wr™‹n
 +=

122 
NÚBlockšgWr™e
(
buf
 + 
®»ady_wr™‹n
, 
nby‹
 -‡lready_written);

124  
	g®»ady_wr™‹n
;

129 
şo£_fÜ_wr™e
(è{ 
	gşo£d_fÜ_wr™e_
 = 1; }

133 
şo£_fÜ_»ad
(è{ 
	gşo£d_fÜ_»ad_
 = 1; }

136 
boŞ
 
is_şo£d_fÜ_wr™e
(ècÚ¡ {  
	gşo£d_fÜ_wr™e_
 != 0; }

139 
boŞ
 
is_şo£d_fÜ_»ad
(ècÚ¡ {  
	gşo£d_fÜ_»ad_
 != 0; }

142 
cÚ¡ex´
 
size_t
 
ÿ·c™y
(ècÚ¡ {  
	gkC­ac™y
; }

147 
UnsynchrÚizedCË¬
() {

148 
	gşo£d_fÜ_»ad_
 = 0;

149 
	gşo£d_fÜ_wr™e_
 = 0;

150 
	gcouÁ_
 = 0;

151 
	g»ad_pos_
 = 0;

152 
	gwr™e_pos_
 = 0;

156 
size_t
 
avaabË
(ècÚ¡ {  
	gkC­ac™y
 - 
	gcouÁ_
; }

159 
size_t
 
size
(ècÚ¡ {  
	gcouÁ_
; }

162 
boŞ
 
em±y
(ècÚ¡ {  
	gcouÁ_
 == 0; }

165 
boŞ
 
fuÎ
(ècÚ¡ {  
	gcouÁ_
 =ğ
kC­ac™y
; }

168 
ušt64_t
 
In¡ªûV”siÚ
(ècÚ¡ {  
	gš¡ªû_v”siÚ_
; }

171 
cÚ¡ex´
 
ušt64_t
 
Ty³V”siÚ
() {

172  
off£tof
(
RšgBufãr
, 
couÁ_
) << 0 |

173 
off£tof
(
RšgBufãr
, 
şo£d_fÜ_»ad_
) << 8 |

174 
off£tof
(
RšgBufãr
, 
şo£d_fÜ_wr™e_
) << 16 |

175 
off£tof
(
RšgBufãr
, 
»ad_pos_
) << 24 |

176 
off£tof
(
RšgBufãr
, 
wr™e_pos_
) << 32 |

177 
off£tof
(
RšgBufãr
, 
bufãr_
è<< 40 | (
	gRšgBufãr
) << 48;

180 
	g´iv©e
:

181 
ä›nd
 
şass
 
RšgBufãrFÜTe¡
<
kC­ac™y
>;

185 
size_t
 
NÚBlockšgR—d
(
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

188 
size_t
 
	gsize
 = 
¡d
::
mš
(
nby‹
, 
couÁ_
.
lßd
());

189 ià(
	gsize
 == 0) {

202 
size_t
 
	gright_šdex
 = 
»ad_pos_
 % 
kC­ac™y
;

203 
size_t
 
	gright_couÁ
 = 
¡d
::
mš
(
size
, 
kC­ac™y
 - 
right_šdex
);

204 
memıy
(
buf
, 
bufãr_
.
d©a
(è+ 
right_šdex
, 
right_couÁ
);

205 ià(
	gsize
 - 
	gright_couÁ
 > 0) {

207 
memıy
(
buf
 + 
right_couÁ
, 
bufãr_
.
d©a
(), 
size
 -„ight_count);

212 
	gcouÁ_
.
ãtch_add
(-
size
);

213 
	g»ad_pos_
 = (
»ad_pos_
 + 
size
è% 
kC­ac™y
;

215  
	gsize
;

220 
size_t
 
NÚBlockšgWr™e
(cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

223 
size_t
 
	gsize
 = 
¡d
::
mš
(
nby‹
, 
kC­ac™y
 - 
couÁ_
);

224 ià(
	gsize
 == 0) {

235 
size_t
 
	gright_šdex
 = 
wr™e_pos_
 % 
kC­ac™y
;

236 
size_t
 
	gright_couÁ
 = 
¡d
::
mš
(
size
, 
kC­ac™y
 - 
right_šdex
);

237 
memıy
(
bufãr_
.
d©a
(è+ 
right_šdex
, 
buf
, 
right_couÁ
);

238 ià(
	gsize
 - 
	gright_couÁ
 > 0) {

240 
memıy
(
bufãr_
.
d©a
(), 
buf
 + 
right_couÁ
, 
size
 -„ight_count);

245 
	gcouÁ_
.
ãtch_add
(
size
);

246 
	gwr™e_pos_
 = (
wr™e_pos_
 + 
size
è% 
kC­ac™y
;

248  
	gsize
;

251 cÚ¡ 
ušt64_t
 
	gš¡ªû_v”siÚ_
;

252 
	g¡d
::
©omic
<
ušt32_t
> 
şo£d_fÜ_»ad_
;

253 
	g¡d
::
©omic
<
ušt32_t
> 
şo£d_fÜ_wr™e_
;

254 
	g¡d
::
©omic
<
size_t
> 
couÁ_
;

255 vŞ©
size_t
 
	g»ad_pos_
;

256 vŞ©
size_t
 
	gwr™e_pos_
;

257 
	g¡d
::
¬¿y
<
ušt8_t
, 
	gkC­ac™y
> 
	gbufãr_
;

258 } 
__©Œibu‹__
((
®igÃd
(8)));

	@platform/common/ring_buffer_test.cc

19 
	~"asylo/¶©fÜm/commÚ/ršg_bufãr.h
"

21 
	~<c¡dšt
>

22 
	~<c¡dlib
>

23 
	~<th»ad
>

24 
	~<veùÜ
>

26 
	~<g‹¡/g‹¡.h
>

28 
Çme¥aû
 
	gasylo
 {

30 
cÚ¡ex´
 cÚ¡ 
size_t
 
	gkD©aSize
 = 4 * 1024 * 1024;

33 
	g‹m¶©e
 <
size_t
 
	gC­ac™y
>

34 
şass
 
	gRšgBufãrFÜTe¡
 : 
public
 
RšgBufãr
<
C­ac™y
> {

35 
public
:

36 
size_t
 
NÚBlockšgWr™e
(cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

37  
	gRšgBufãr
<
	gC­ac™y
>::
NÚBlockšgWr™e
(
buf
, 
nby‹
);

40 
size_t
 
NÚBlockšgR—d
(
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

41  
	gRšgBufãr
<
	gC­ac™y
>::
NÚBlockšgR—d
(
buf
, 
nby‹
);

46 
	g¡d
::
veùÜ
<
ušt8_t
> 
MakeTe¡D©a
(
size_t
 
size
) {

47 
ušt8_t
 
f1
 = 0;

48 
ušt8_t
 
	gf2
 = 1;

49 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a
(
size
);

50 
	gi
 = 0; i < 
	gsize
; i++) {

51 
ušt8_t
 
	gÃxt
 = 
f1
 + 
f2
;

52 
	gd©a
[
i
] = 
Ãxt
;

53 
	gf1
 = 
f2
;

54 
	gf2
 = 
Ãxt
;

56  
	gd©a
;

59 şas 
	cRšgBufãrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

60 
´Ùeùed
:

61 
S‘Up
(è
fš®
 {

62 
¤ªdom
(::
‹¡šg
::
Un™Te¡
::
G‘In¡ªû
()->
¿ndom_£ed
());

63 
	gsü©ch_
 = 
¡d
::
veùÜ
<
ušt8_t
>(
kD©aSize
, 0);

64 
	gd©a_
 = 
MakeTe¡D©a
(
kD©aSize
);

67 
R—dTe¡D©a
(
¡d
::
veùÜ
<
ušt8_t
> *
out
) {

68 
size_t
 
»ad_couÁ
 = 0;

69 
cÚ¡ex´
 
size_t
 
	gkR—dSize
 = 4096;

70 !(
	gbuf_
.
em±y
(è&& buf_.
is_şo£d_fÜ_wr™e
())) {

71 
ušt8_t
 
	g»ad_bufãr
[
kR—dSize
];

72 
size_t
 
	gsz
 = 
buf_
.
R—d
(
»ad_bufãr
, 
kR—dSize
);

73 
	gout
->
»size
(
»ad_couÁ
 + 
sz
);

74 
memıy
(
out
->
d©a
(è+ 
»ad_couÁ
, 
»ad_bufãr
, 
sz
);

75 
	g»ad_couÁ
 +ğ
sz
;

77 
	gbuf_
.
şo£_fÜ_»ad
();

80 
Wr™eTe¡D©a
() {

81 
	gbuf_
.
Wr™e
(
d©a_
.
d©a
(), 
kD©aSize
);

82 
	gbuf_
.
şo£_fÜ_wr™e
();

85 
	gRšgBufãrFÜTe¡
<
	gkD©aSize
> 
	gbuf_
;

86 
	g¡d
::
veùÜ
<
ušt8_t
> 
sü©ch_
;

87 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a_
;

90 
	$TEST_F
(
RšgBufãrTe¡
, 
BasicPrİ”t›s
) {

91 
	`ASSERT_EQ
(
buf_
.
	`ÿ·c™y
(), 
kD©aSize
);

92 
	`EXPECT_EQ
(
buf_
.
	`size
(), 0);

93 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

94 
size_t
 
rc
 = 
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
());

95 
	`EXPECT_EQ
(
rc
, 
buf_
.
	`ÿ·c™y
());

96 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

97 
size_t
 
size
 = 
buf_
.
	`size
();

98 
	`EXPECT_EQ
(
buf_
.
	`size
(), 
kD©aSize
);

99 
rc
 = 
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), 
size
);

100 
	`EXPECT_EQ
(
rc
, 
buf_
.
	`ÿ·c™y
());

101 
	`EXPECT_EQ
(
	`memcmp
(
d©a_
.
	`d©a
(), 
sü©ch_
.d©a(), 
size
), 0);

102 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

103 
	}
}

105 
	$TEST_F
(
RšgBufãrTe¡
, 
V”siÚM©chšg
) {

106 
usšg
 
Tšy
 = 
RšgBufãr
<2>;

107 
usšg
 
Medium
 = 
RšgBufãr
<32>;

108 
usšg
 
Big
 = 
RšgBufãr
<64>;

110 
Tšy
 
tšy
;

111 
Medium
 
medium
;

112 
Big
 
big
;

114 
	`EXPECT_EQ
(
tšy
.
	`In¡ªûV”siÚ
(), 
Tšy
::
	`Ty³V”siÚ
());

115 
	`EXPECT_EQ
(
medium
.
	`In¡ªûV”siÚ
(), 
Medium
::
	`Ty³V”siÚ
());

116 
	`EXPECT_EQ
(
big
.
	`In¡ªûV”siÚ
(), 
Big
::
	`Ty³V”siÚ
());

117 
	`EXPECT_NE
(
tšy
.
	`In¡ªûV”siÚ
(), 
Medium
::
	`Ty³V”siÚ
());

118 
	`EXPECT_NE
(
medium
.
	`In¡ªûV”siÚ
(), 
Big
::
	`Ty³V”siÚ
());

119 
	`EXPECT_NE
(
big
.
	`In¡ªûV”siÚ
(), 
Tšy
::
	`Ty³V”siÚ
());

120 
	}
}

124 
	$TEST_F
(
RšgBufãrTe¡
, 
SšgËTh»adedSŒessTe¡
) {

125 
¡d
::
veùÜ
<
ušt8_t
> 
	`cİ›d_d©a
(
kD©aSize
);

126 cÚ¡ 
size_t
 
kBigge¡Chunk
 = 1024;

127 
RšgBufãrFÜTe¡
<255> 
sm®l_buf
;

130 
d©a_šdex
 = 0;

132 
cİy_šdex
 = 0;

133 
cİy_šdex
 < 
kD©aSize
) {

134 
size_t
 
Ãxt_chunk_size
 = 
	`¿ndom
(è% 
kBigge¡Chunk
;

135 
	`¿ndom
() % 2) {

139 
Ãxt_chunk_size
 = 
¡d
::
	`mš
Òext_chunk_size, 
d©a_
.
	`size
(è- 
d©a_šdex
);

140 
size_t
 
couÁ
 = 
¡d
::
	`mš
(
Ãxt_chunk_size
, 
sm®l_buf
.
	`avaabË
());

141 
d©a_šdex
 +=

142 
sm®l_buf
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(è+ 
d©a_šdex
, 
couÁ
);

147 
Ãxt_chunk_size
 =

148 
¡d
::
	`mš
(
Ãxt_chunk_size
, 
cİ›d_d©a
.
	`size
(è- 
cİy_šdex
);

149 
size_t
 
couÁ
 = 
¡d
::
	`mš
(
Ãxt_chunk_size
, 
sm®l_buf
.
	`size
());

150 
cİy_šdex
 +=

151 
sm®l_buf
.
	`NÚBlockšgR—d
(
cİ›d_d©a
.
	`d©a
(è+ 
cİy_šdex
, 
couÁ
);

155 
	`EXPECT_EQ
(
	`memcmp
(
d©a_
.
	`d©a
(), 
cİ›d_d©a
.d©a(), 
kD©aSize
), 0);

156 
	}
}

158 
	$TEST_F
(
RšgBufãrTe¡
, 
Wr™eFuÎBufãr
) {

159 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()),

160 
buf_
.
	`ÿ·c™y
());

161 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

162 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), 1), 0);

163 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

164 
	}
}

166 
	$TEST_F
(
RšgBufãrTe¡
, 
R—dEm±yBufãr
) {

167 
buf_
.
	`UnsynchrÚizedCË¬
();

168 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

169 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), 1), 0);

170 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

171 
	}
}

173 
	$TEST_F
(
RšgBufãrTe¡
, 
Wr™eL¬g”ThªBufãr
) {

174 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), 2 * buf_.
	`ÿ·c™y
()),

175 
buf_
.
	`ÿ·c™y
());

176 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

177 
	}
}

179 
	$TEST_F
(
RšgBufãrTe¡
, 
R—dL¬g”ThªBufãr
) {

180 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()),

181 
buf_
.
	`ÿ·c™y
());

182 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), buf_.
	`ÿ·c™y
() + 1),

183 
buf_
.
	`ÿ·c™y
());

184 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

185 
	}
}

189 
	$TEST_F
(
RšgBufãrTe¡
, 
Wr™eN—¾yFuÎ
) {

190 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
() - 1),

191 
buf_
.
	`ÿ·c™y
() - 1);

192 
	`EXPECT_EQ
(
buf_
.
	`size
(), buf_.
	`ÿ·c™y
() - 1);

193 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()), 1);

194 
	`EXPECT_EQ
(
buf_
.
	`size
(), buf_.
	`ÿ·c™y
());

195 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

196 
	}
}

200 
	$TEST_F
(
RšgBufãrTe¡
, 
R—dN—¾yEm±y
) {

201 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()),

202 
buf_
.
	`ÿ·c™y
());

203 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

204 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), buf_.
	`ÿ·c™y
() - 1),

205 
buf_
.
	`ÿ·c™y
() - 1);

206 
	`EXPECT_EQ
(
buf_
.
	`size
(), 1);

207 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), buf_.
	`ÿ·c™y
()), 1);

208 
	`EXPECT_EQ
(
buf_
.
	`size
(), 0);

209 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

210 
	}
}

212 
	$TEST_F
(
RšgBufãrTe¡
, 
BlockšgR—dWr™eTe¡
) {

213 
¡d
::
veùÜ
<
ušt8_t
> 
out
;

214 
¡d
::
th»ad
 
wr™”
 = std::
	`th»ad
([&](è{ 
	`Wr™eTe¡D©a
(); });

215 
¡d
::
th»ad
 
»ad”
 = std::
	`th»ad
([&](è{ 
	`R—dTe¡D©a
(&
out
); });

216 
wr™”
.
	`još
();

217 
»ad”
.
	`još
();

218 
	`EXPECT_EQ
(
	`memcmp
(
d©a_
.
	`d©a
(), 
out
.d©a(), 
kD©aSize
), 0);

219 
	}
}

222 
	$TEST_F
(
RšgBufãrTe¡
, 
Clo£dFÏgs
) {

223 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

224 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

227 
buf_
.
	`şo£_fÜ_»ad
();

228 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

229 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

231 
buf_
.
	`şo£_fÜ_wr™e
();

232 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

233 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

236 
buf_
.
	`şo£_fÜ_»ad
();

237 
buf_
.
	`şo£_fÜ_wr™e
();

238 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

239 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

242 
buf_
.
	`UnsynchrÚizedCË¬
();

243 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

244 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

245 
	}
}

	@platform/common/ring_buffer_test.cc

19 
	~"asylo/¶©fÜm/commÚ/ršg_bufãr.h
"

21 
	~<c¡dšt
>

22 
	~<c¡dlib
>

23 
	~<th»ad
>

24 
	~<veùÜ
>

26 
	~<g‹¡/g‹¡.h
>

28 
Çme¥aû
 
	gasylo
 {

30 
cÚ¡ex´
 cÚ¡ 
size_t
 
	gkD©aSize
 = 4 * 1024 * 1024;

33 
	g‹m¶©e
 <
size_t
 
	gC­ac™y
>

34 
şass
 
	gRšgBufãrFÜTe¡
 : 
public
 
RšgBufãr
<
C­ac™y
> {

35 
public
:

36 
size_t
 
NÚBlockšgWr™e
(cÚ¡ 
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

37  
	gRšgBufãr
<
	gC­ac™y
>::
NÚBlockšgWr™e
(
buf
, 
nby‹
);

40 
size_t
 
NÚBlockšgR—d
(
ušt8_t
 *
buf
, size_ˆ
nby‹
) {

41  
	gRšgBufãr
<
	gC­ac™y
>::
NÚBlockšgR—d
(
buf
, 
nby‹
);

46 
	g¡d
::
veùÜ
<
ušt8_t
> 
MakeTe¡D©a
(
size_t
 
size
) {

47 
ušt8_t
 
f1
 = 0;

48 
ušt8_t
 
	gf2
 = 1;

49 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a
(
size
);

50 
	gi
 = 0; i < 
	gsize
; i++) {

51 
ušt8_t
 
	gÃxt
 = 
f1
 + 
f2
;

52 
	gd©a
[
i
] = 
Ãxt
;

53 
	gf1
 = 
f2
;

54 
	gf2
 = 
Ãxt
;

56  
	gd©a
;

59 şas 
	cRšgBufãrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

60 
´Ùeùed
:

61 
S‘Up
(è
fš®
 {

62 
¤ªdom
(::
‹¡šg
::
Un™Te¡
::
G‘In¡ªû
()->
¿ndom_£ed
());

63 
	gsü©ch_
 = 
¡d
::
veùÜ
<
ušt8_t
>(
kD©aSize
, 0);

64 
	gd©a_
 = 
MakeTe¡D©a
(
kD©aSize
);

67 
R—dTe¡D©a
(
¡d
::
veùÜ
<
ušt8_t
> *
out
) {

68 
size_t
 
»ad_couÁ
 = 0;

69 
cÚ¡ex´
 
size_t
 
	gkR—dSize
 = 4096;

70 !(
	gbuf_
.
em±y
(è&& buf_.
is_şo£d_fÜ_wr™e
())) {

71 
ušt8_t
 
	g»ad_bufãr
[
kR—dSize
];

72 
size_t
 
	gsz
 = 
buf_
.
R—d
(
»ad_bufãr
, 
kR—dSize
);

73 
	gout
->
»size
(
»ad_couÁ
 + 
sz
);

74 
memıy
(
out
->
d©a
(è+ 
»ad_couÁ
, 
»ad_bufãr
, 
sz
);

75 
	g»ad_couÁ
 +ğ
sz
;

77 
	gbuf_
.
şo£_fÜ_»ad
();

80 
Wr™eTe¡D©a
() {

81 
	gbuf_
.
Wr™e
(
d©a_
.
d©a
(), 
kD©aSize
);

82 
	gbuf_
.
şo£_fÜ_wr™e
();

85 
	gRšgBufãrFÜTe¡
<
	gkD©aSize
> 
	gbuf_
;

86 
	g¡d
::
veùÜ
<
ušt8_t
> 
sü©ch_
;

87 
	g¡d
::
veùÜ
<
ušt8_t
> 
d©a_
;

90 
	$TEST_F
(
RšgBufãrTe¡
, 
BasicPrİ”t›s
) {

91 
	`ASSERT_EQ
(
buf_
.
	`ÿ·c™y
(), 
kD©aSize
);

92 
	`EXPECT_EQ
(
buf_
.
	`size
(), 0);

93 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

94 
size_t
 
rc
 = 
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
());

95 
	`EXPECT_EQ
(
rc
, 
buf_
.
	`ÿ·c™y
());

96 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

97 
size_t
 
size
 = 
buf_
.
	`size
();

98 
	`EXPECT_EQ
(
buf_
.
	`size
(), 
kD©aSize
);

99 
rc
 = 
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), 
size
);

100 
	`EXPECT_EQ
(
rc
, 
buf_
.
	`ÿ·c™y
());

101 
	`EXPECT_EQ
(
	`memcmp
(
d©a_
.
	`d©a
(), 
sü©ch_
.d©a(), 
size
), 0);

102 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

103 
	}
}

105 
	$TEST_F
(
RšgBufãrTe¡
, 
V”siÚM©chšg
) {

106 
usšg
 
Tšy
 = 
RšgBufãr
<2>;

107 
usšg
 
Medium
 = 
RšgBufãr
<32>;

108 
usšg
 
Big
 = 
RšgBufãr
<64>;

110 
Tšy
 
tšy
;

111 
Medium
 
medium
;

112 
Big
 
big
;

114 
	`EXPECT_EQ
(
tšy
.
	`In¡ªûV”siÚ
(), 
Tšy
::
	`Ty³V”siÚ
());

115 
	`EXPECT_EQ
(
medium
.
	`In¡ªûV”siÚ
(), 
Medium
::
	`Ty³V”siÚ
());

116 
	`EXPECT_EQ
(
big
.
	`In¡ªûV”siÚ
(), 
Big
::
	`Ty³V”siÚ
());

117 
	`EXPECT_NE
(
tšy
.
	`In¡ªûV”siÚ
(), 
Medium
::
	`Ty³V”siÚ
());

118 
	`EXPECT_NE
(
medium
.
	`In¡ªûV”siÚ
(), 
Big
::
	`Ty³V”siÚ
());

119 
	`EXPECT_NE
(
big
.
	`In¡ªûV”siÚ
(), 
Tšy
::
	`Ty³V”siÚ
());

120 
	}
}

124 
	$TEST_F
(
RšgBufãrTe¡
, 
SšgËTh»adedSŒessTe¡
) {

125 
¡d
::
veùÜ
<
ušt8_t
> 
	`cİ›d_d©a
(
kD©aSize
);

126 cÚ¡ 
size_t
 
kBigge¡Chunk
 = 1024;

127 
RšgBufãrFÜTe¡
<255> 
sm®l_buf
;

130 
d©a_šdex
 = 0;

132 
cİy_šdex
 = 0;

133 
cİy_šdex
 < 
kD©aSize
) {

134 
size_t
 
Ãxt_chunk_size
 = 
	`¿ndom
(è% 
kBigge¡Chunk
;

135 
	`¿ndom
() % 2) {

139 
Ãxt_chunk_size
 = 
¡d
::
	`mš
Òext_chunk_size, 
d©a_
.
	`size
(è- 
d©a_šdex
);

140 
size_t
 
couÁ
 = 
¡d
::
	`mš
(
Ãxt_chunk_size
, 
sm®l_buf
.
	`avaabË
());

141 
d©a_šdex
 +=

142 
sm®l_buf
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(è+ 
d©a_šdex
, 
couÁ
);

147 
Ãxt_chunk_size
 =

148 
¡d
::
	`mš
(
Ãxt_chunk_size
, 
cİ›d_d©a
.
	`size
(è- 
cİy_šdex
);

149 
size_t
 
couÁ
 = 
¡d
::
	`mš
(
Ãxt_chunk_size
, 
sm®l_buf
.
	`size
());

150 
cİy_šdex
 +=

151 
sm®l_buf
.
	`NÚBlockšgR—d
(
cİ›d_d©a
.
	`d©a
(è+ 
cİy_šdex
, 
couÁ
);

155 
	`EXPECT_EQ
(
	`memcmp
(
d©a_
.
	`d©a
(), 
cİ›d_d©a
.d©a(), 
kD©aSize
), 0);

156 
	}
}

158 
	$TEST_F
(
RšgBufãrTe¡
, 
Wr™eFuÎBufãr
) {

159 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()),

160 
buf_
.
	`ÿ·c™y
());

161 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

162 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), 1), 0);

163 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

164 
	}
}

166 
	$TEST_F
(
RšgBufãrTe¡
, 
R—dEm±yBufãr
) {

167 
buf_
.
	`UnsynchrÚizedCË¬
();

168 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

169 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), 1), 0);

170 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

171 
	}
}

173 
	$TEST_F
(
RšgBufãrTe¡
, 
Wr™eL¬g”ThªBufãr
) {

174 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), 2 * buf_.
	`ÿ·c™y
()),

175 
buf_
.
	`ÿ·c™y
());

176 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

177 
	}
}

179 
	$TEST_F
(
RšgBufãrTe¡
, 
R—dL¬g”ThªBufãr
) {

180 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()),

181 
buf_
.
	`ÿ·c™y
());

182 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), buf_.
	`ÿ·c™y
() + 1),

183 
buf_
.
	`ÿ·c™y
());

184 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

185 
	}
}

189 
	$TEST_F
(
RšgBufãrTe¡
, 
Wr™eN—¾yFuÎ
) {

190 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
() - 1),

191 
buf_
.
	`ÿ·c™y
() - 1);

192 
	`EXPECT_EQ
(
buf_
.
	`size
(), buf_.
	`ÿ·c™y
() - 1);

193 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()), 1);

194 
	`EXPECT_EQ
(
buf_
.
	`size
(), buf_.
	`ÿ·c™y
());

195 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

196 
	}
}

200 
	$TEST_F
(
RšgBufãrTe¡
, 
R—dN—¾yEm±y
) {

201 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgWr™e
(
d©a_
.
	`d©a
(), buf_.
	`ÿ·c™y
()),

202 
buf_
.
	`ÿ·c™y
());

203 
	`EXPECT_TRUE
(
buf_
.
	`fuÎ
());

204 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), buf_.
	`ÿ·c™y
() - 1),

205 
buf_
.
	`ÿ·c™y
() - 1);

206 
	`EXPECT_EQ
(
buf_
.
	`size
(), 1);

207 
	`EXPECT_EQ
(
buf_
.
	`NÚBlockšgR—d
(
sü©ch_
.
	`d©a
(), buf_.
	`ÿ·c™y
()), 1);

208 
	`EXPECT_EQ
(
buf_
.
	`size
(), 0);

209 
	`EXPECT_TRUE
(
buf_
.
	`em±y
());

210 
	}
}

212 
	$TEST_F
(
RšgBufãrTe¡
, 
BlockšgR—dWr™eTe¡
) {

213 
¡d
::
veùÜ
<
ušt8_t
> 
out
;

214 
¡d
::
th»ad
 
wr™”
 = std::
	`th»ad
([&](è{ 
	`Wr™eTe¡D©a
(); });

215 
¡d
::
th»ad
 
»ad”
 = std::
	`th»ad
([&](è{ 
	`R—dTe¡D©a
(&
out
); });

216 
wr™”
.
	`još
();

217 
»ad”
.
	`još
();

218 
	`EXPECT_EQ
(
	`memcmp
(
d©a_
.
	`d©a
(), 
out
.d©a(), 
kD©aSize
), 0);

219 
	}
}

222 
	$TEST_F
(
RšgBufãrTe¡
, 
Clo£dFÏgs
) {

223 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

224 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

227 
buf_
.
	`şo£_fÜ_»ad
();

228 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

229 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

231 
buf_
.
	`şo£_fÜ_wr™e
();

232 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

233 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

236 
buf_
.
	`şo£_fÜ_»ad
();

237 
buf_
.
	`şo£_fÜ_wr™e
();

238 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

239 
	`EXPECT_TRUE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

242 
buf_
.
	`UnsynchrÚizedCË¬
();

243 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_»ad
());

244 
	`EXPECT_FALSE
(
buf_
.
	`is_şo£d_fÜ_wr™e
());

245 
	}
}

	@platform/common/singleton.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_SINGLETON_H_


20 
	#ASYLO_PLATFORM_COMMON_SINGLETON_H_


	)

22 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

24 
Çme¥aû
 
	gasylo
 {

27 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

28 
	sDeçuÉFaùÜy
 {

29 
usšg
 
	gv®ue_ty³
 = 
T
;

30 
T
 *
CÚ¡ruù
(è{  
Ãw
 T(); }

31 
De¡ruù
(
T
 *
t
è{ 
d–‘e
 
	gt
; }

41 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
 = 
DeçuÉFaùÜy
<
T
>>

42 şas 
	cSšgËtÚ
 {

43 
public
:

46 
T
 *
g‘
(è
LOCKS_EXCLUDED
(
mu_
) {

47 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

48 ià(
	gš¡ªû_
) {

49  
	gš¡ªû_
;

52 ià(
	gde¡royed_
) {

53  
	gnuÎ±r
;

55 ià(
	gš¡ªû_
) {

56  
	gš¡ªû_
;

58 
	gš¡ªû_
 = 
F
::
CÚ¡ruù
();

59  
	gš¡ªû_
;

67 
De¡ruù
(è
LOCKS_EXCLUDED
(
mu_
) {

68 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

69 
T
 *
	gtmp_±r
 = 
š¡ªû_
;

70 
	gš¡ªû_
 = 
nuÎ±r
;

71 
	gF
::
De¡ruù
(
tmp_±r
);

72 
	gde¡royed_
 = 
Œue
;

75 
	g´iv©e
:

76 
T
 *
š¡ªû_
 
GUARDED_BY
(
mu_
);

77 
boŞ
 
de¡royed_
 
GUARDED_BY
(
mu_
);

78 
	gab¦
::
Mu‹x
 
mu_
;

81 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
>

82 
T
 *
	gSšgËtÚ
<
	gT
, 
	gF
>::
š¡ªû_
 = 
nuÎ±r
;

84 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
>

85 
boŞ
 
	gSšgËtÚ
<
	gT
, 
	gF
>::
de¡royed_
 = 
çl£
;

87 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gF
>

88 
	gab¦
::
Mu‹x
 
SšgËtÚ
<
T
, 
	gF
>::
mu_
;

	@platform/common/singleton_test.cc

19 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

21 
	~<İ’s¦/mem.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

25 
	~<th»ad
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

31 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
cÚ¡ex´
 
size_t
 
	gkBufSize
 = 1024;

37 
cÚ¡ex´
 
size_t
 
	gkLoİCouÁ
 = 1024 * 128;

38 
cÚ¡ex´
 
size_t
 
	gkNumTh»ads
 = 8;

42 
	g‹m¶©e
 <
	gN
>

43 
	sNum”icCÚ¡ªt
 {

44 
Num”icCÚ¡ªt
(è: 
v®ue
{
N
} {

45 
¡d
::
th»ad
::
id
 
th»ad_id
 = std::
this_th»ad
::
g‘_id
();

46 
	g¡d
::
hash
<
¡d
::
th»ad
::
id
> 
hash”
;

47 
	gtid_hash
 = 
hash”
(
th»ad_id
);

49 cÚ¡ 
	gv®ue
;

50 
size_t
 
	gtid_hash
;

55 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

56 
	sL‘h¬gicFaùÜy
 {

57 
usšg
 
	gv®ue_ty³
 = 
T
;

58 
T
 *
CÚ¡ruù
() {

59 
ušt8_t
 
	gbufãr
[
kBufSize
];

60 
	gi
 = 0; i < 
	gkLoİCouÁ
; i++) {

61 
RAND_by‹s
(
bufãr
, 
kBufSize
);

62 
OPENSSL_ş—n£
(
bufãr
, 
kBufSize
);

64  
Ãw
 
T
();

74 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

75 
Te¡SšgËtÚ
(
T
 **
±r
, 
ab¦
::
Mu‹x
 *
mu
) {

76 
T
 *
tmp_±r
 = 
SšgËtÚ
<T, 
	gL‘h¬gicFaùÜy
<
	gT
>>::
g‘
();

78 
	gab¦
::
Mu‹xLock
 
lock
(
mu
);

79 ià(*
	g±r
 =ğ
nuÎ±r
) {

80 *
±r
 = 
tmp_±r
;

84 
ASSERT_EQ
(*
±r
, 
tmp_±r
);

88 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

89 şas 
	cTy³dSšgËtÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

91 ::
‹¡šg
::
	tTy³s
<
	tNum”icCÚ¡ªt
<0>,

92 
	tab¦
::
	tæ©_hash_m­
<
	t¡d
::
	t¡ršg
, std::string>,

93 
	t¡d
::
	t¡ršg
, std::
	tveùÜ
<
	tušt8_t
>>

94 
	tMyTy³s
;

96 
TYPED_TEST_SUITE
(
Ty³dSšgËtÚTe¡
, 
MyTy³s
);

101 
TYPED_TEST
(
Ty³dSšgËtÚTe¡
, 
SšgËtÚCÜ»ùÃss
) {

102 
Ty³P¬am
 *
	g±r
 = 
nuÎ±r
;

103 
	gab¦
::
Mu‹x
 
mu
;

104 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

106 
	gi
 = 0; i < 
	gkNumTh»ads
; i++) {

107 
	gth»ads
.
em¶aû_back
(
Te¡SšgËtÚ
<
Ty³P¬am
>, &
±r
, &
mu
);

110 autØ&
	gth»ad
 : 
th»ads
) {

111 
th»ad
.
još
();

114 
EXPECT_NE
(
±r
, 
nuÎ±r
);

116 
	gSšgËtÚ
<
	gTy³P¬am
>::
De¡ruù
();

117 
EXPECT_EQ
(
SšgËtÚ
<
Ty³P¬am
>::
g‘
(), 
nuÎ±r
);

	@platform/common/singleton_test.cc

19 
	~"asylo/¶©fÜm/commÚ/sšgËtÚ.h
"

21 
	~<İ’s¦/mem.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

25 
	~<th»ad
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

31 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
cÚ¡ex´
 
size_t
 
	gkBufSize
 = 1024;

37 
cÚ¡ex´
 
size_t
 
	gkLoİCouÁ
 = 1024 * 128;

38 
cÚ¡ex´
 
size_t
 
	gkNumTh»ads
 = 8;

42 
	g‹m¶©e
 <
	gN
>

43 
	sNum”icCÚ¡ªt
 {

44 
Num”icCÚ¡ªt
(è: 
v®ue
{
N
} {

45 
¡d
::
th»ad
::
id
 
th»ad_id
 = std::
this_th»ad
::
g‘_id
();

46 
	g¡d
::
hash
<
¡d
::
th»ad
::
id
> 
hash”
;

47 
	gtid_hash
 = 
hash”
(
th»ad_id
);

49 cÚ¡ 
	gv®ue
;

50 
size_t
 
	gtid_hash
;

55 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

56 
	sL‘h¬gicFaùÜy
 {

57 
usšg
 
	gv®ue_ty³
 = 
T
;

58 
T
 *
CÚ¡ruù
() {

59 
ušt8_t
 
	gbufãr
[
kBufSize
];

60 
	gi
 = 0; i < 
	gkLoİCouÁ
; i++) {

61 
RAND_by‹s
(
bufãr
, 
kBufSize
);

62 
OPENSSL_ş—n£
(
bufãr
, 
kBufSize
);

64  
Ãw
 
T
();

74 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

75 
Te¡SšgËtÚ
(
T
 **
±r
, 
ab¦
::
Mu‹x
 *
mu
) {

76 
T
 *
tmp_±r
 = 
SšgËtÚ
<T, 
	gL‘h¬gicFaùÜy
<
	gT
>>::
g‘
();

78 
	gab¦
::
Mu‹xLock
 
lock
(
mu
);

79 ià(*
	g±r
 =ğ
nuÎ±r
) {

80 *
±r
 = 
tmp_±r
;

84 
ASSERT_EQ
(*
±r
, 
tmp_±r
);

88 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

89 şas 
	cTy³dSšgËtÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

91 ::
‹¡šg
::
	tTy³s
<
	tNum”icCÚ¡ªt
<0>,

92 
	tab¦
::
	tæ©_hash_m­
<
	t¡d
::
	t¡ršg
, std::string>,

93 
	t¡d
::
	t¡ršg
, std::
	tveùÜ
<
	tušt8_t
>>

94 
	tMyTy³s
;

96 
TYPED_TEST_SUITE
(
Ty³dSšgËtÚTe¡
, 
MyTy³s
);

101 
TYPED_TEST
(
Ty³dSšgËtÚTe¡
, 
SšgËtÚCÜ»ùÃss
) {

102 
Ty³P¬am
 *
	g±r
 = 
nuÎ±r
;

103 
	gab¦
::
Mu‹x
 
mu
;

104 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

106 
	gi
 = 0; i < 
	gkNumTh»ads
; i++) {

107 
	gth»ads
.
em¶aû_back
(
Te¡SšgËtÚ
<
Ty³P¬am
>, &
±r
, &
mu
);

110 autØ&
	gth»ad
 : 
th»ads
) {

111 
th»ad
.
još
();

114 
EXPECT_NE
(
±r
, 
nuÎ±r
);

116 
	gSšgËtÚ
<
	gTy³P¬am
>::
De¡ruù
();

117 
EXPECT_EQ
(
SšgËtÚ
<
Ty³P¬am
>::
g‘
(), 
nuÎ±r
);

	@platform/common/spin_lock.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_SPIN_LOCK_H_


20 
	#ASYLO_PLATFORM_COMMON_SPIN_LOCK_H_


	)

22 
	~<xmmšŒš.h
>

23 
	~<©omic
>

24 
	~<c¡ddef
>

29 şas 
	cSpšLock
 {

30 
	mpublic
:

32 
	$SpšLock
(è: 
	$lock_wÜd_
(
kUÆockedV®ue
) {}

35 
	$Acquœe
() {

36 !
	`TryLock
()) {

37 
	`_mm_·u£
();

39 
	}
}

43 
boŞ
 
	$TryLock
() {

44 
ušt64_t
 
ex³ùed_v®ue
 = 
kUÆockedV®ue
;

45  
lock_wÜd_
.
	`com·»_exchªge_¡rÚg
(
ex³ùed_v®ue
, 
kLockedV®ue
,

46 
¡d
::
memÜy_Üd”_acq_»l
);

47 
	}
}

50 
	$R–—£
() {

51 
lock_wÜd_
.
	`¡Üe
(
kUÆockedV®ue
, 
¡d
::
memÜy_Üd”_»Ëa£
);

52 
	}
}

54 
	g´iv©e
:

56 
cÚ¡ex´
 
ušt64_t
 
kUÆockedV®ue
 = 0x0;

58 
cÚ¡ex´
 
ušt64_t
 
	gkLockedV®ue
 = 0x1;

60 
	g¡d
::
©omic
<
ušt64_t
> 
lock_wÜd_
;

64 şas 
	cScİedSpšLock
 {

65 
	mpublic
:

66 
	$ScİedSpšLock
(
SpšLock
 *
lock
è: 
	$lock_
(
lock
) {

67 
lock_
->
	`Acquœe
();

70 ~
	$ScİedSpšLock
(è{ 
lock_
->
	`R–—£
(); 
	}
}

72 
	g´iv©e
:

73 
SpšLock
 *
lock_
;

	@platform/common/spin_lock_test.cc

19 
	~<th»ad
>

20 
	~<veùÜ
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/commÚ/¥š_lock.h
"

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
	gkMªyTh»ads
 = 128;

31 
TEST
(
SpšLockTe¡
, 
MªyTh»adsTe¡
) {

32 
	gsh¬ed_couÁ”
 = 0;

33 
SpšLock
 
	glock
;

34 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

35 
	gth»ads
.
»£rve
(
kMªyTh»ads
);

36 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

37 
	gth»ads
.
em¶aû_back
([&]() {

38 
i
 = 0; i < 256; i++) {

39 
lock
.
Acquœe
();

40 
sh¬ed_couÁ”
++;

41 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

42 
sh¬ed_couÁ”
--;

43 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

44 
lock
.
R–—£
();

49 autØ&
	gth»ad
 : 
th»ads
) {

50 
th»ad
.
još
();

53 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

57 
TEST
(
ScİedSpšLockTe¡
, 
MªyTh»adsTe¡
) {

58 
	gsh¬ed_couÁ”
 = 0;

59 
SpšLock
 
	glock
;

60 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

61 
	gth»ads
.
»£rve
(
kMªyTh»ads
);

62 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

63 
	gth»ads
.
em¶aû_back
([&]() {

64 
i
 = 0; i < 256; i++) {

65 
ScİedSpšLock
 
¥š_lock
(&
lock
);

66 
sh¬ed_couÁ”
++;

67 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

68 
sh¬ed_couÁ”
--;

69 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

74 autØ&
	gth»ad
 : 
th»ads
) {

75 
th»ad
.
još
();

78 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

	@platform/common/spin_lock_test.cc

19 
	~<th»ad
>

20 
	~<veùÜ
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/commÚ/¥š_lock.h
"

26 
	gÇme¥aû
 {

28 
cÚ¡ex´
 
	gkMªyTh»ads
 = 128;

31 
TEST
(
SpšLockTe¡
, 
MªyTh»adsTe¡
) {

32 
	gsh¬ed_couÁ”
 = 0;

33 
SpšLock
 
	glock
;

34 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

35 
	gth»ads
.
»£rve
(
kMªyTh»ads
);

36 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

37 
	gth»ads
.
em¶aû_back
([&]() {

38 
i
 = 0; i < 256; i++) {

39 
lock
.
Acquœe
();

40 
sh¬ed_couÁ”
++;

41 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

42 
sh¬ed_couÁ”
--;

43 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

44 
lock
.
R–—£
();

49 autØ&
	gth»ad
 : 
th»ads
) {

50 
th»ad
.
još
();

53 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

57 
TEST
(
ScİedSpšLockTe¡
, 
MªyTh»adsTe¡
) {

58 
	gsh¬ed_couÁ”
 = 0;

59 
SpšLock
 
	glock
;

60 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

61 
	gth»ads
.
»£rve
(
kMªyTh»ads
);

62 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

63 
	gth»ads
.
em¶aû_back
([&]() {

64 
i
 = 0; i < 256; i++) {

65 
ScİedSpšLock
 
¥š_lock
(&
lock
);

66 
sh¬ed_couÁ”
++;

67 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

68 
sh¬ed_couÁ”
--;

69 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

74 autØ&
	gth»ad
 : 
th»ads
) {

75 
th»ad
.
još
();

78 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

	@platform/common/static_map.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_STATIC_MAP_H_


20 
	#ASYLO_PLATFORM_COMMON_STATIC_MAP_H_


	)

112 
	~<¡ršg
>

113 
	~<ty³_Œa™s
>

115 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

116 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

117 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

118 
	~"asylo/ut/loggšg.h
"

119 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­_š‹º®.h
"

121 
Çme¥aû
 
	gasylo
 {

133 
	#DEFINE_STATIC_MAP_OF_BASE_TYPE
(
M­Name
, 
V®ueTy³
, ...) \

134 
şass
 
M­Name
 \

135 : 
public
 ::
asylo
::
SticM­
<
M­Name
, 
V®ueTy³
, ##
__VA_ARGS__
> {};

	)

139 
	#SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
M­Name
, 
SubşassTy³
) \

140 
Çme¥aû
 { \

141 
M­Name
::
V®ueIn£¹”
 M­Name##
	`SubşassTy³
(
Ãw
 SubclassType()); \

142 }

	)

146 
	g‹m¶©e
 <
şass
 
	gT
>

147 
	gNam”
;

155 
	g‹m¶©e
 <
şass
 
	gM­Name
, cÏs 
	gT
, cÏs 
	gN
 = 
Nam”
<
T
>>

156 şas 
	cSticM­
 {

157 
public
:

158 
usšg
 
v®ue_™”©Ü
 = 
š‹º®
::
V®ueI‹¿tÜ
<

159 
T
, 
ty³Çme
 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gT
 *>::
™”©Ü
>;

160 
usšg
 
	gcÚ¡_v®ue_™”©Ü
 = 
š‹º®
::
V®ueI‹¿tÜ
<

161 cÚ¡ 
T
, 
ty³Çme
 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gT
 *>::
cÚ¡_™”©Ü
>;

165 şas 
	cV®ueIn£¹”
 {

166 
	gpublic
:

167 
ex¶ic™
 
V®ueIn£¹”
(
T
 *
v®ue
è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

168 #iâdeà
__ASYLO__


169 
¡©ic_as£¹
(

170 
¡d
::
is_ŒivŸÎy_deçuÉ_cÚ¡ruùibË
<
N
>::
v®ue
,

175 
	gab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

178 
	gSticM­
::
In™Ÿlize
();

182 
	g¡d
::
¡ršg
 
key
 = 
SticM­
::
Çm”_
(*
v®ue
);

183 ià(!
	gSticM­
::
m­_
->
em¶aû
(
key
, 
v®ue
).
	g£cÚd
) {

184 
LOG
(
FATAL
è<< "Addšg du¶iÿ‹ key " << 
	gkey
 << "o static map";

192 şas 
	cV®ueCŞËùiÚ
 {

193 
	gpublic
:

194 
usšg
 
™”©Ü
 = 
SticM­
::
v®ue_™”©Ü
;

195 
usšg
 
	gcÚ¡_™”©Ü
 = 
SticM­
::
cÚ¡_v®ue_™”©Ü
;

197 
V®ueCŞËùiÚ
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

198 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

201 
	gSticM­
::
In™Ÿlize
();

204 
™”©Ü
 
begš
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

205 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

206  
™”©Ü
(
SticM­
::
m­_
->
begš
());

208 
cÚ¡_™”©Ü
 
begš
(ècÚ¡ 
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

209 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

210  
cÚ¡_™”©Ü
(
SticM­
::
m­_
->
cbegš
());

212 
cÚ¡_™”©Ü
 
cbegš
(ècÚ¡ 
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

213 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

214  
cÚ¡_™”©Ü
(
SticM­
::
m­_
->
cbegš
());

216 
™”©Ü
 
’d
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

217 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

218  
™”©Ü
(
SticM­
::
m­_
->
’d
());

220 
cÚ¡_™”©Ü
 
’d
(ècÚ¡ 
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

221 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

222  
cÚ¡_™”©Ü
(
SticM­
::
m­_
->
ûnd
());

224 
cÚ¡_™”©Ü
 
ûnd
(ècÚ¡ 
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

225 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

226  
cÚ¡_™”©Ü
(
SticM­
::
m­_
->
ûnd
());

232 
V®ueCŞËùiÚ
 
V®ues
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

233  
V®ueCŞËùiÚ
();

236 
v®ue_™”©Ü
 
v®ue_begš
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

237  
V®ues
().
begš
();

239 
v®ue_™”©Ü
 
v®ue_’d
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

240  
V®ues
().
’d
();

242 
cÚ¡_v®ue_™”©Ü
 
v®ue_cbegš
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

243  
V®ues
().
cbegš
();

245 
cÚ¡_v®ue_™”©Ü
 
v®ue_ûnd
(è
LOCKS_EXCLUDED
(
SticM­
::
mu_
) {

246  
V®ues
().
ûnd
();

251 
v®ue_™”©Ü
 
G‘V®ue
(cÚ¡ 
¡d
::
¡ršg
 &
key
) {

252 
ab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

255 
In™Ÿlize
();

257  
v®ue_™”©Ü
(
SticM­
::
m­_
->
fšd
(
key
));

260 
size_t
 
Size
() {

261 
	gab¦
::
Mu‹xLock
 
lock
(&
SticM­
::
mu_
);

264 
In™Ÿlize
();

266  
	gSticM­
::
m­_
->
size
();

269 
	g´iv©e
:

270 
In™Ÿlize
(è
EXCLUSIVE_LOCKS_REQUIRED
(
mu_
) {

271 ià(
m­_
 =ğ
nuÎ±r
) {

272 
m­_
 = 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gT
 *>();

275 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gT
 *> *
m­_
 
GUARDED_BY
(
mu_
)

276 
PT_GUARDED_BY
(
mu_
);

277 
	gab¦
::
Mu‹x
 
mu_
;

278 
N
 
	gÇm”_
;

281 
	g‹m¶©e
 <
şass
 
	gM­Name
, cÏs 
	gT
, cÏs 
	gN
>

282 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gT
 *> *
	gSticM­
<
	gM­Name
, T, 
	gN
>::
m­_
 = 
nuÎ±r
;

284 
	g‹m¶©e
 <
şass
 
	gM­Name
, cÏs 
	gT
, cÏs 
	gN
>

285 
	gab¦
::
Mu‹x
 
SticM­
<
M­Name
, 
	gT
, 
	gN
>::
mu_
;

287 
	g‹m¶©e
 <
şass
 
	gM­Name
, cÏs 
	gT
, cÏs 
	gN
>

288 
N
 
	gSticM­
<
	gM­Name
, 
	gT
, 
	gN
>::
Çm”_
;

	@platform/common/static_map_internal.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_STATIC_MAP_INTERNAL_H_


20 
	#ASYLO_PLATFORM_COMMON_STATIC_MAP_INTERNAL_H_


	)

22 
	~<ty³_Œa™s
>

23 
	~<ut™y
>

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gš‹º®
 {

30 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gM­I‹¿tÜT
>

31 şas 
	cV®ueI‹¿tÜ
 : 
public
 
M­I‹¿tÜT
 {

32 
public
:

33 
usšg
 
difã»nû_ty³
 = 
ty³Çme
 
M­I‹¿tÜT
::difference_type;

34 
usšg
 
	gv®ue_ty³
 = 
T
;

35 
usšg
 
	gpoš‹r
 = 
T
 *;

36 
usšg
 
	g»ã»nû
 = 
T
 &;

37 
usšg
 
	g™”©Ü_ÿ‹gÜy
 = 
ty³Çme
 
M­I‹¿tÜT
::
™”©Ü_ÿ‹gÜy
;

39 
V®ueI‹¿tÜ
() = ;

43 
ex¶ic™
 
V®ueI‹¿tÜ
(
M­I‹¿tÜT
 &&
™”
è: M­I‹¿tÜT(
¡d
::
move
(iter)) {}

48 
‹m¶©e
 <
ty³Çme
 
M­I‹¿tÜU
>

49 
V®ueI‹¿tÜ
(

50 
V®ueI‹¿tÜ
<
ty³Çme
 
¡d
::
»move_cÚ¡
<
T
>::
ty³
, 
M­I‹¿tÜU
> 
Ùh”
)

51 : 
M­I‹¿tÜT
(
¡©ic_ÿ¡
<
M­I‹¿tÜU
>(
Ùh”
)) {}

55 
T
 &
İ”©Ü
*(è{  *
M­I‹¿tÜT
::İ”©Ü*().
£cÚd
; }

59 
T
 *
	gİ”©Ü
->(è{  
	gM­I‹¿tÜT
::
İ”©Ü
->()->
£cÚd
; }

	@platform/common/static_map_test.cc

19 
	~<®gÜ™hm
>

20 
	~<¡ršg
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cFoo
 {

32 
	gpublic
:

33 
vœtu®
 ~
Foo
() {}

35 
vœtu®
 
¡d
::
¡ršg
 
Name
() const {  "Foo"; }

38 şas 
	cB¬
 : 
public
 
Foo
 {

39 
public
:

40 
¡d
::
¡ršg
 
Name
(ècÚ¡ 
ov”ride
 {  "Bar"; }

43 şas 
	cBaz
 : 
public
 
B¬
 {

44 
public
:

45 
¡d
::
¡ršg
 
Name
(ècÚ¡ 
ov”ride
 {  "Baz"; }

48 
	sB¬Nam”
 {

49 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
B¬
 &
b¬
) {

50  
ab¦
::
SŒC©
(
b¬
.
Name
(), bar.Name());

55 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
FooM­
, 
Foo
);

56 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
FooM­
, 
B¬
);

57 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
FooM­
, 
Baz
);

60 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
B¬M­
, 
B¬
, 
B¬Nam”
);

61 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
B¬M­
, 
Baz
);

64 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
BazM­
, 
Baz
);

67 
TEST
(
SticM­Te¡
, 
Te¡SticM­Basic
) {

68 
EXPECT_EQ
(
FooM­
::
Size
(), 2);

70 autØ
	gb¬
 = 
FooM­
::
G‘V®ue
("Bar");

71 
EXPECT_NE
(
b¬
, 
FooM­
::
v®ue_’d
());

72 
EXPECT_EQ
(
b¬
->
Name
(), "Bar");

74 autØ
	gbaz
 = 
FooM­
::
G‘V®ue
("Baz");

75 
EXPECT_NE
(
baz
, 
FooM­
::
v®ue_’d
());

76 
EXPECT_EQ
(
baz
->
Name
(), "Baz");

80 
TEST
(
SticM­Te¡
, 
Te¡SticM­Cu¡omNam”
) {

81 
EXPECT_EQ
(
B¬M­
::
Size
(), 1);

83 autØ
	gbaz
 = 
B¬M­
::
G‘V®ue
("BazBaz");

84 
EXPECT_NE
(
baz
, 
B¬M­
::
v®ue_’d
());

85 
EXPECT_EQ
(
baz
->
Name
(), "Baz");

90 
TEST
(
SticM­Te¡
, 
Te¡G‘NÚExi¡’tM­EËm’t
) {

91 autØ
	gbad_foo
 = 
FooM­
::
G‘V®ue
("BadFoo");

92 
EXPECT_EQ
(
bad_foo
, 
FooM­
::
v®ue_’d
());

96 
TEST
(
SticM­Te¡
, 
Te¡AcûssEm±ySticM­
) {

97 
EXPECT_EQ
(
BazM­
::
Size
(), 0);

99 autØ
	gbaz
 = 
BazM­
::
G‘V®ue
("Baz");

100 
EXPECT_EQ
(
baz
, 
BazM­
::
v®ue_’d
());

104 
TEST
(
SticM­Te¡
, 
Te¡I‹¿tÜ
) {

105 
	gcouÁ
 = 0;

106 
boŞ
 
	gfound_b¬
 = 
çl£
;

107 
boŞ
 
	gfound_baz
 = 
çl£
;

109 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

110 autØ
	g™”
 = 
v®ues
.
begš
(); i‹¸!ğv®ues.
’d
(); ++iter) {

111 ++
	gcouÁ
;

112 ià(
	g™”
->
Name
() == "Bar") {

113 
found_b¬
 = 
Œue
;

114 } ià(
	g™”
->
Name
() == "Baz") {

115 
found_baz
 = 
Œue
;

118 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

119 
EXPECT_TRUE
(
found_b¬
);

120 
EXPECT_TRUE
(
found_baz
);

125 
TEST
(
SticM­Te¡
, 
Te¡CÚ¡I‹¿tÜ
) {

126 
	gcouÁ
 = 0;

127 
boŞ
 
	gfound_b¬
 = 
çl£
;

128 
boŞ
 
	gfound_baz
 = 
çl£
;

130 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

131 autØ
	g™”
 = 
v®ues
.
cbegš
(); i‹¸!ğv®ues.
ûnd
(); ++iter) {

132 ++
	gcouÁ
;

133 ià(
	g™”
->
Name
() == "Bar") {

134 
found_b¬
 = 
Œue
;

135 } ià(
	g™”
->
Name
() == "Baz") {

136 
found_baz
 = 
Œue
;

139 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

140 
EXPECT_TRUE
(
found_b¬
);

141 
EXPECT_TRUE
(
found_baz
);

145 
TEST
(
SticM­Te¡
, 
Te¡I‹¿tÜCÚv”siÚ
) {

146 
	gcouÁ
 = 0;

147 
boŞ
 
	gfound_b¬
 = 
çl£
;

148 
boŞ
 
	gfound_baz
 = 
çl£
;

150 
	gFooM­
::
cÚ¡_v®ue_™”©Ü
 
™”
 = 
FooM­
::
v®ue_begš
();

151 
	g™”
 !ğ
FooM­
::
v®ue_’d
(); ++iter) {

152 ++
	gcouÁ
;

153 ià(
	g™”
->
Name
() == "Bar") {

154 
found_b¬
 = 
Œue
;

155 } ià(
	g™”
->
Name
() == "Baz") {

156 
found_baz
 = 
Œue
;

159 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

160 
EXPECT_TRUE
(
found_b¬
);

161 
EXPECT_TRUE
(
found_baz
);

166 
TEST
(
SticM­Te¡
, 
Te¡RªgeBa£dFÜ
) {

167 
	gcouÁ
 = 0;

168 
boŞ
 
	gfound_b¬
 = 
çl£
;

169 
boŞ
 
	gfound_baz
 = 
çl£
;

176 cÚ¡‡utØ&
	g™em
 : 
FooM­
::
V®ues
()) {

177 ++
couÁ
;

178 ià(
	g™em
.
Name
() == "Bar") {

179 
found_b¬
 = 
Œue
;

181 ià(
	g™em
.
Name
() == "Baz") {

182 
found_baz
 = 
Œue
;

185 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

186 
EXPECT_TRUE
(
found_b¬
);

187 
EXPECT_TRUE
(
found_baz
);

192 
TEST
(
SticM­Te¡
, 
Te¡AlgÜ™hmI‹¿tÜ
) {

193 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

194 autØ
	gb¬_™
 = 
¡d
::
fšd_if
(
v®ues
.
begš
(), v®ues.
’d
(), [](cÚ¡ 
Foo
 &
foo
) {

195  
foo
.
Name
() == "Bar";

197 
EXPECT_NE
(
b¬_™
, 
v®ues
.
’d
());

198 
EXPECT_EQ
(
b¬_™
->
Name
(), "Bar");

200 autØ
	gyam_™
 = 
¡d
::
fšd_if
(
v®ues
.
begš
(), v®ues.
’d
(), [](cÚ¡ 
Foo
 &
foo
) {

201  
foo
.
Name
() == "Yam";

203 
EXPECT_EQ
(
yam_™
, 
v®ues
.
’d
());

208 
TEST
(
SticM­Te¡
, 
Te¡AlgÜ™hmCÚ¡I‹¿tÜ
) {

209 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

210 autØ
	gb¬_™
 =

211 
¡d
::
fšd_if
(
v®ues
.
cbegš
(), v®ues.
ûnd
(),

212 [](cÚ¡ 
Foo
 &
foo
è{  foo.
Name
() == "Bar"; });

213 
EXPECT_NE
(
b¬_™
, 
v®ues
.
ûnd
());

214 
EXPECT_EQ
(
b¬_™
->
Name
(), "Bar");

216 autØ
	gyam_™
 =

217 
¡d
::
fšd_if
(
v®ues
.
cbegš
(), v®ues.
ûnd
(),

218 [](cÚ¡ 
Foo
 &
foo
è{  foo.
Name
() == "Yam"; });

219 
EXPECT_EQ
(
yam_™
, 
v®ues
.
ûnd
());

227 
	g‹m¶©e
 <>

228 
	gNam”
<
	gFoo
> {

229 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
Foo
 &
foo
è{  foo.
Name
(); }

	@platform/common/static_map_test.cc

19 
	~<®gÜ™hm
>

20 
	~<¡ršg
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cFoo
 {

32 
	gpublic
:

33 
vœtu®
 ~
Foo
() {}

35 
vœtu®
 
¡d
::
¡ršg
 
Name
() const {  "Foo"; }

38 şas 
	cB¬
 : 
public
 
Foo
 {

39 
public
:

40 
¡d
::
¡ršg
 
Name
(ècÚ¡ 
ov”ride
 {  "Bar"; }

43 şas 
	cBaz
 : 
public
 
B¬
 {

44 
public
:

45 
¡d
::
¡ršg
 
Name
(ècÚ¡ 
ov”ride
 {  "Baz"; }

48 
	sB¬Nam”
 {

49 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
B¬
 &
b¬
) {

50  
ab¦
::
SŒC©
(
b¬
.
Name
(), bar.Name());

55 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
FooM­
, 
Foo
);

56 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
FooM­
, 
B¬
);

57 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
FooM­
, 
Baz
);

60 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
B¬M­
, 
B¬
, 
B¬Nam”
);

61 
SET_STATIC_MAP_VALUE_OF_DERIVED_TYPE
(
B¬M­
, 
Baz
);

64 
DEFINE_STATIC_MAP_OF_BASE_TYPE
(
BazM­
, 
Baz
);

67 
TEST
(
SticM­Te¡
, 
Te¡SticM­Basic
) {

68 
EXPECT_EQ
(
FooM­
::
Size
(), 2);

70 autØ
	gb¬
 = 
FooM­
::
G‘V®ue
("Bar");

71 
EXPECT_NE
(
b¬
, 
FooM­
::
v®ue_’d
());

72 
EXPECT_EQ
(
b¬
->
Name
(), "Bar");

74 autØ
	gbaz
 = 
FooM­
::
G‘V®ue
("Baz");

75 
EXPECT_NE
(
baz
, 
FooM­
::
v®ue_’d
());

76 
EXPECT_EQ
(
baz
->
Name
(), "Baz");

80 
TEST
(
SticM­Te¡
, 
Te¡SticM­Cu¡omNam”
) {

81 
EXPECT_EQ
(
B¬M­
::
Size
(), 1);

83 autØ
	gbaz
 = 
B¬M­
::
G‘V®ue
("BazBaz");

84 
EXPECT_NE
(
baz
, 
B¬M­
::
v®ue_’d
());

85 
EXPECT_EQ
(
baz
->
Name
(), "Baz");

90 
TEST
(
SticM­Te¡
, 
Te¡G‘NÚExi¡’tM­EËm’t
) {

91 autØ
	gbad_foo
 = 
FooM­
::
G‘V®ue
("BadFoo");

92 
EXPECT_EQ
(
bad_foo
, 
FooM­
::
v®ue_’d
());

96 
TEST
(
SticM­Te¡
, 
Te¡AcûssEm±ySticM­
) {

97 
EXPECT_EQ
(
BazM­
::
Size
(), 0);

99 autØ
	gbaz
 = 
BazM­
::
G‘V®ue
("Baz");

100 
EXPECT_EQ
(
baz
, 
BazM­
::
v®ue_’d
());

104 
TEST
(
SticM­Te¡
, 
Te¡I‹¿tÜ
) {

105 
	gcouÁ
 = 0;

106 
boŞ
 
	gfound_b¬
 = 
çl£
;

107 
boŞ
 
	gfound_baz
 = 
çl£
;

109 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

110 autØ
	g™”
 = 
v®ues
.
begš
(); i‹¸!ğv®ues.
’d
(); ++iter) {

111 ++
	gcouÁ
;

112 ià(
	g™”
->
Name
() == "Bar") {

113 
found_b¬
 = 
Œue
;

114 } ià(
	g™”
->
Name
() == "Baz") {

115 
found_baz
 = 
Œue
;

118 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

119 
EXPECT_TRUE
(
found_b¬
);

120 
EXPECT_TRUE
(
found_baz
);

125 
TEST
(
SticM­Te¡
, 
Te¡CÚ¡I‹¿tÜ
) {

126 
	gcouÁ
 = 0;

127 
boŞ
 
	gfound_b¬
 = 
çl£
;

128 
boŞ
 
	gfound_baz
 = 
çl£
;

130 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

131 autØ
	g™”
 = 
v®ues
.
cbegš
(); i‹¸!ğv®ues.
ûnd
(); ++iter) {

132 ++
	gcouÁ
;

133 ià(
	g™”
->
Name
() == "Bar") {

134 
found_b¬
 = 
Œue
;

135 } ià(
	g™”
->
Name
() == "Baz") {

136 
found_baz
 = 
Œue
;

139 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

140 
EXPECT_TRUE
(
found_b¬
);

141 
EXPECT_TRUE
(
found_baz
);

145 
TEST
(
SticM­Te¡
, 
Te¡I‹¿tÜCÚv”siÚ
) {

146 
	gcouÁ
 = 0;

147 
boŞ
 
	gfound_b¬
 = 
çl£
;

148 
boŞ
 
	gfound_baz
 = 
çl£
;

150 
	gFooM­
::
cÚ¡_v®ue_™”©Ü
 
™”
 = 
FooM­
::
v®ue_begš
();

151 
	g™”
 !ğ
FooM­
::
v®ue_’d
(); ++iter) {

152 ++
	gcouÁ
;

153 ià(
	g™”
->
Name
() == "Bar") {

154 
found_b¬
 = 
Œue
;

155 } ià(
	g™”
->
Name
() == "Baz") {

156 
found_baz
 = 
Œue
;

159 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

160 
EXPECT_TRUE
(
found_b¬
);

161 
EXPECT_TRUE
(
found_baz
);

166 
TEST
(
SticM­Te¡
, 
Te¡RªgeBa£dFÜ
) {

167 
	gcouÁ
 = 0;

168 
boŞ
 
	gfound_b¬
 = 
çl£
;

169 
boŞ
 
	gfound_baz
 = 
çl£
;

176 cÚ¡‡utØ&
	g™em
 : 
FooM­
::
V®ues
()) {

177 ++
couÁ
;

178 ià(
	g™em
.
Name
() == "Bar") {

179 
found_b¬
 = 
Œue
;

181 ià(
	g™em
.
Name
() == "Baz") {

182 
found_baz
 = 
Œue
;

185 
EXPECT_EQ
(
couÁ
, 
FooM­
::
Size
());

186 
EXPECT_TRUE
(
found_b¬
);

187 
EXPECT_TRUE
(
found_baz
);

192 
TEST
(
SticM­Te¡
, 
Te¡AlgÜ™hmI‹¿tÜ
) {

193 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

194 autØ
	gb¬_™
 = 
¡d
::
fšd_if
(
v®ues
.
begš
(), v®ues.
’d
(), [](cÚ¡ 
Foo
 &
foo
) {

195  
foo
.
Name
() == "Bar";

197 
EXPECT_NE
(
b¬_™
, 
v®ues
.
’d
());

198 
EXPECT_EQ
(
b¬_™
->
Name
(), "Bar");

200 autØ
	gyam_™
 = 
¡d
::
fšd_if
(
v®ues
.
begš
(), v®ues.
’d
(), [](cÚ¡ 
Foo
 &
foo
) {

201  
foo
.
Name
() == "Yam";

203 
EXPECT_EQ
(
yam_™
, 
v®ues
.
’d
());

208 
TEST
(
SticM­Te¡
, 
Te¡AlgÜ™hmCÚ¡I‹¿tÜ
) {

209 autØ
	gv®ues
 = 
FooM­
::
V®ues
();

210 autØ
	gb¬_™
 =

211 
¡d
::
fšd_if
(
v®ues
.
cbegš
(), v®ues.
ûnd
(),

212 [](cÚ¡ 
Foo
 &
foo
è{  foo.
Name
() == "Bar"; });

213 
EXPECT_NE
(
b¬_™
, 
v®ues
.
ûnd
());

214 
EXPECT_EQ
(
b¬_™
->
Name
(), "Bar");

216 autØ
	gyam_™
 =

217 
¡d
::
fšd_if
(
v®ues
.
cbegš
(), v®ues.
ûnd
(),

218 [](cÚ¡ 
Foo
 &
foo
è{  foo.
Name
() == "Yam"; });

219 
EXPECT_EQ
(
yam_™
, 
v®ues
.
ûnd
());

227 
	g‹m¶©e
 <>

228 
	gNam”
<
	gFoo
> {

229 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
Foo
 &
foo
è{  foo.
Name
(); }

	@platform/common/test/bridge_types_test_data.cc

19 
	~"asylo/¶©fÜm/commÚ/‹¡/bridge_ty³s_‹¡_d©a.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

24 
Çme¥aû
 
	gasylo
 {

27 
size_t
 
bridge_ty³_size
(cÚ¡ 
¡d
::
¡ršg
 &
ty³_Çme
) {

28 ià(
ty³_Çme
 == "bridge_in_addr") {

30 } ià(
	gty³_Çme
 == "bridge_in6_addr") {

32 } ià(
	gty³_Çme
 == "bridge_sockaddr_in6") {

34 } ià(
	gty³_Çme
 == "bridge_sockaddr_in") {

36 } ià(
	gty³_Çme
 == "bridge_sockaddr_un") {

38 } ià(
	gty³_Çme
 == "bridge_sockaddr") {

40 } ià(
	gty³_Çme
 == "bridge_timeval") {

42 } ià(
	gty³_Çme
 == "bridge_timespec") {

44 } ià(
	gty³_Çme
 == "bridge_stat") {

46 } ià(
	gty³_Çme
 == "bridge_pollfd") {

	@platform/common/test/bridge_types_test_data.cc

19 
	~"asylo/¶©fÜm/commÚ/‹¡/bridge_ty³s_‹¡_d©a.h
"

21 
	~<c¡dšt
>

22 
	~<¡ršg
>

24 
Çme¥aû
 
	gasylo
 {

27 
size_t
 
bridge_ty³_size
(cÚ¡ 
¡d
::
¡ršg
 &
ty³_Çme
) {

28 ià(
ty³_Çme
 == "bridge_in_addr") {

30 } ià(
	gty³_Çme
 == "bridge_in6_addr") {

32 } ià(
	gty³_Çme
 == "bridge_sockaddr_in6") {

34 } ià(
	gty³_Çme
 == "bridge_sockaddr_in") {

36 } ià(
	gty³_Çme
 == "bridge_sockaddr_un") {

38 } ià(
	gty³_Çme
 == "bridge_sockaddr") {

40 } ià(
	gty³_Çme
 == "bridge_timeval") {

42 } ià(
	gty³_Çme
 == "bridge_timespec") {

44 } ià(
	gty³_Çme
 == "bridge_stat") {

46 } ià(
	gty³_Çme
 == "bridge_pollfd") {

	@platform/common/test/bridge_types_test_data.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_TEST_BRIDGE_TYPES_TEST_DATA_H_


20 
	#ASYLO_PLATFORM_COMMON_TEST_BRIDGE_TYPES_TEST_DATA_H_


	)

22 
	~<c¡dšt
>

23 
	~<¡ršg
>

25 
Çme¥aû
 
	gasylo
 {

29 
size_t
 
bridge_ty³_size
(cÚ¡ 
¡d
::
¡ršg
 &
ty³_Çme
);

	@platform/common/test/bridge_types_test_driver.cc

19 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/commÚ/‹¡/bridge_ty³s_‹¡_d©a.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cBridgeTy³sTe¡
 : 
public
 
EnşaveTe¡
 {

32 
´Ùeùed
:

33 
‹m¶©e
 <
ty³Çme
 
T
>

34 
RunTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
šput
) {

36 
EnşaveIÅut
 
’şave_šput
;

37 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
šput
);

38 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

39 
EXPECT_EQ
(
bridge_ty³_size
(
šput
), (
T
));

42 
	g´iv©e
:

43 
¡d
::
m­
<¡d::
¡ršg
, 
	gsize_t
> 
	gd©a_
;

46 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_š_addr
) {

47 
	gRunTe¡
<
	gbridge_š_addr
>("bridge_in_addr");

50 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_š6_addr
) {

51 
	gRunTe¡
<
	gbridge_š6_addr
>("bridge_in6_addr");

54 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr_š6
) {

55 
	gRunTe¡
<
	gbridge_sockaddr_š6
>("bridge_sockaddr_in6");

58 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr_š
) {

59 
	gRunTe¡
<
	gbridge_sockaddr_š
>("bridge_sockaddr_in");

62 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr_un
) {

63 
	gRunTe¡
<
	gbridge_sockaddr_un
>("bridge_sockaddr_un");

66 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr
) {

67 
	gRunTe¡
<
	gbridge_sockaddr
>("bridge_sockaddr");

70 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_timev®
) {

71 
	gRunTe¡
<
	gbridge_timev®
>("bridge_timeval");

74 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_time¥ec
) {

75 
	gRunTe¡
<
	gbridge_time¥ec
>("bridge_timespec");

78 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_¡©
) {

79 
	gRunTe¡
<
	gbridge_¡©
>("bridge_stat");

82 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_pŞlfd
) {

83 
	gRunTe¡
<
	gbridge_pŞlfd
>("bridge_pollfd");

	@platform/common/test/bridge_types_test_driver.cc

19 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/commÚ/‹¡/bridge_ty³s_‹¡_d©a.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cBridgeTy³sTe¡
 : 
public
 
EnşaveTe¡
 {

32 
´Ùeùed
:

33 
‹m¶©e
 <
ty³Çme
 
T
>

34 
RunTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
šput
) {

36 
EnşaveIÅut
 
’şave_šput
;

37 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
šput
);

38 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

39 
EXPECT_EQ
(
bridge_ty³_size
(
šput
), (
T
));

42 
	g´iv©e
:

43 
¡d
::
m­
<¡d::
¡ršg
, 
	gsize_t
> 
	gd©a_
;

46 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_š_addr
) {

47 
	gRunTe¡
<
	gbridge_š_addr
>("bridge_in_addr");

50 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_š6_addr
) {

51 
	gRunTe¡
<
	gbridge_š6_addr
>("bridge_in6_addr");

54 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr_š6
) {

55 
	gRunTe¡
<
	gbridge_sockaddr_š6
>("bridge_sockaddr_in6");

58 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr_š
) {

59 
	gRunTe¡
<
	gbridge_sockaddr_š
>("bridge_sockaddr_in");

62 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr_un
) {

63 
	gRunTe¡
<
	gbridge_sockaddr_un
>("bridge_sockaddr_un");

66 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_sockaddr
) {

67 
	gRunTe¡
<
	gbridge_sockaddr
>("bridge_sockaddr");

70 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_timev®
) {

71 
	gRunTe¡
<
	gbridge_timev®
>("bridge_timeval");

74 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_time¥ec
) {

75 
	gRunTe¡
<
	gbridge_time¥ec
>("bridge_timespec");

78 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_¡©
) {

79 
	gRunTe¡
<
	gbridge_¡©
>("bridge_stat");

82 
TEST_F
(
BridgeTy³sTe¡
, 
Te¡PackedSize_bridge_pŞlfd
) {

83 
	gRunTe¡
<
	gbridge_pŞlfd
>("bridge_pollfd");

	@platform/common/test/bridge_types_test_enclave.cc

19 
	~<c¡dšt
>

20 
	~<m­
>

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

27 
	~"asylo/¶©fÜm/commÚ/‹¡/bridge_ty³s_‹¡_d©a.h
"

28 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

30 
Çme¥aû
 
	gasylo
 {

32 şas 
	cEnşaveBridgeTy³s
 : 
public
 
EnşaveTe¡Ca£
 {

33 
public
:

34 
EnşaveBridgeTy³s
() = ;

36 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
	gov”ride
 {

37 
	g¡d
::
veùÜ
<
¡d
::
·œ
<¡d::
¡ršg
, 
	gsize_t
>> 
	gsizes_li¡
 = {

38 {"bridge_š_addr", (
bridge_š_addr
)},

39 {"bridge_š6_addr", (
bridge_š6_addr
)},

40 {"bridge_sockaddr_š6", (
bridge_sockaddr_š6
)},

41 {"bridge_sockaddr_š", (
bridge_sockaddr_š
)},

42 {"bridge_sockaddr_un", (
bridge_sockaddr_un
)},

43 {"bridge_sockaddr", (
bridge_sockaddr
)},

44 {"bridge_timev®", (
bridge_timev®
)},

45 {"bridge_time¥ec", (
bridge_time¥ec
)},

46 {"bridge_¡©", (
bridge_¡©
)},

47 {"bridge_pŞlfd", (
bridge_pŞlfd
)},

49 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gsize_t
> 
sizes
(
sizes_li¡
.
begš
(),

50 
sizes_li¡
.
’d
());

51 
	gty³_sizes_
 = 
¡d
::
move
(
sizes
);

52  
	gStus
::
OkStus
();

55 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

56 
	g¡d
::
¡ršg
 
‹¡_ty³
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

57 
size_t
 
	gsize
 = 
bridge_ty³_size
(
‹¡_ty³
);

59 ià(
	gty³_sizes_
.
fšd
(
‹¡_ty³
è=ğ
ty³_sizes_
.
’d
()) {

60  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Unknownestype");

62 ià(
	gty³_sizes_
[
‹¡_ty³
] !ğ
size
) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

64 
ab¦
::
SŒC©
(
‹¡_ty³
, " failed"));

66  
	gStus
::
OkStus
();

69 
	g´iv©e
:

70 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gsize_t
> 
	gty³_sizes_
;

73 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveBridgeTy³s
; 
	}
}

	@platform/common/test/bridge_types_test_enclave.cc

19 
	~<c¡dšt
>

20 
	~<m­
>

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

27 
	~"asylo/¶©fÜm/commÚ/‹¡/bridge_ty³s_‹¡_d©a.h
"

28 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

30 
Çme¥aû
 
	gasylo
 {

32 şas 
	cEnşaveBridgeTy³s
 : 
public
 
EnşaveTe¡Ca£
 {

33 
public
:

34 
EnşaveBridgeTy³s
() = ;

36 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
	gov”ride
 {

37 
	g¡d
::
veùÜ
<
¡d
::
·œ
<¡d::
¡ršg
, 
	gsize_t
>> 
	gsizes_li¡
 = {

38 {"bridge_š_addr", (
bridge_š_addr
)},

39 {"bridge_š6_addr", (
bridge_š6_addr
)},

40 {"bridge_sockaddr_š6", (
bridge_sockaddr_š6
)},

41 {"bridge_sockaddr_š", (
bridge_sockaddr_š
)},

42 {"bridge_sockaddr_un", (
bridge_sockaddr_un
)},

43 {"bridge_sockaddr", (
bridge_sockaddr
)},

44 {"bridge_timev®", (
bridge_timev®
)},

45 {"bridge_time¥ec", (
bridge_time¥ec
)},

46 {"bridge_¡©", (
bridge_¡©
)},

47 {"bridge_pŞlfd", (
bridge_pŞlfd
)},

49 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gsize_t
> 
sizes
(
sizes_li¡
.
begš
(),

50 
sizes_li¡
.
’d
());

51 
	gty³_sizes_
 = 
¡d
::
move
(
sizes
);

52  
	gStus
::
OkStus
();

55 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

56 
	g¡d
::
¡ršg
 
‹¡_ty³
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

57 
size_t
 
	gsize
 = 
bridge_ty³_size
(
‹¡_ty³
);

59 ià(
	gty³_sizes_
.
fšd
(
‹¡_ty³
è=ğ
ty³_sizes_
.
’d
()) {

60  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "Unknownestype");

62 ià(
	gty³_sizes_
[
‹¡_ty³
] !ğ
size
) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

64 
ab¦
::
SŒC©
(
‹¡_ty³
, " failed"));

66  
	gStus
::
OkStus
();

69 
	g´iv©e
:

70 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gsize_t
> 
	gty³_sizes_
;

73 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveBridgeTy³s
; 
	}
}

	@platform/common/time_util.cc

19 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gÇme¥aû
 {

25 
cÚ¡ex´
 
št64_t
 
	gkMiüo£cÚdsP”SecÚd
 = 
INT64_C
(1000000);

26 
cÚ¡ex´
 
št64_t
 
	gkNªo£cÚdsP”Miüo£cÚd
 = 
INT64_C
(1000);

27 
cÚ¡ex´
 
št64_t
 
	gkNªo£cÚdsP”SecÚd
 = 
INT64_C
(1000000000);

28 
cÚ¡ex´
 
št64_t
 
	gkFœ¡R•»£ÁabËSecÚd
 = 
INT64_MIN
 / 
kNªo£cÚdsP”SecÚd
;

29 
cÚ¡ex´
 
št64_t
 
	gkLa¡R•»£ÁabËSecÚd
 = 
INT64_MAX
 / 
kNªo£cÚdsP”SecÚd
;

33 
boŞ
 
IsR•»£ÁabËAsNªo£cÚds
(cÚ¡ 
time¥ec
 *
ts
) {

34  
	gts
->
	gtv_£c
 > 
	gkFœ¡R•»£ÁabËSecÚd
 &&

35 
	gts
->
	gtv_£c
 < 
	gkLa¡R•»£ÁabËSecÚd
;

38 
boŞ
 
IsR•»£ÁabËAsNªo£cÚds
(cÚ¡ 
timev®
 *
tv
) {

39  
	gtv
->
	gtv_£c
 > 
	gkFœ¡R•»£ÁabËSecÚd
 &&

40 
	gtv
->
	gtv_£c
 < 
	gkLa¡R•»£ÁabËSecÚd
;

43 
boŞ
 
TimeS³cSubŒaù
(cÚ¡ 
time¥ec
 &
lhs
, cÚ¡ time¥eø&
rhs
,

44 
time¥ec
 *
»suÉ
) {

46 
št64_t
 
	gr£c
 = 
rhs
.
tv_£c
, 
	gº£c
 =„hs.
tv_n£c
;

47 ià(
	glhs
.
	gtv_n£c
 < 
	gº£c
) {

48 
	g£c
 = (
º£c
 - 
lhs
.
tv_n£c
è/ 
kNªo£cÚdsP”SecÚd
 + 1;

49 
	gº£c
 -ğ
kNªo£cÚdsP”SecÚd
 * 
£c
;

50 
	gr£c
 +ğ
£c
;

53 
št64_t
 
	gd–_n£c
 = 
lhs
.
tv_n£c
 - 
º£c
;

54 ià(
	gd–_n£c
 > 
	gkNªo£cÚdsP”SecÚd
) {

55 
št64_t
 
	g£c
 = 
d–_n£c
 / 
kNªo£cÚdsP”SecÚd
;

56 
	gº£c
 +ğ
kNªo£cÚdsP”SecÚd
 * 
£c
;

57 
	gr£c
 -ğ
£c
;

61 
	g»suÉ
->
	gtv_£c
 = 
lhs
.
tv_£c
 - 
r£c
;

62 
	g»suÉ
->
	gtv_n£c
 = 
lhs
.
tv_n£c
 - 
º£c
;

63  
	glhs
.
	gtv_£c
 < 
	gr£c
;

66 
št64_t
 
TimeS³cToNªo£cÚds
(cÚ¡ 
time¥ec
 *
ts
) {

67  
	gts
->
tv_£c
 * 
	gkNªo£cÚdsP”SecÚd
 +s->
	gtv_n£c
;

70 
št64_t
 
TimeV®ToNªo£cÚds
(cÚ¡ 
timev®
 *
tv
) {

71  
	gtv
->
tv_£c
 * 
	gkNªo£cÚdsP”SecÚd
 +

72 
	gtv
->
tv_u£c
 * 
	gkNªo£cÚdsP”Miüo£cÚd
;

75 
time¥ec
 *
Nªo£cÚdsToTimeS³c
Ñime¥eø*
ts
, 
št64_t
 
Çno£cs
) {

76 
	gts
->
	gtv_£c
 = 
Çno£cs
 / 
kNªo£cÚdsP”SecÚd
;

77 
	gts
->
	gtv_n£c
 = 
Çno£cs
 % 
kNªo£cÚdsP”SecÚd
;

78  
	gts
;

81 
timev®
 *
Nªo£cÚdsToTimeV®
Ñimev® *
tv
, 
št64_t
 
Çno£cs
) {

82 
	gtv
->
	gtv_£c
 = 
Çno£cs
 / 
kNªo£cÚdsP”SecÚd
;

83 
	gtv
->
	gtv_u£c
 = 
Çno£cs
 / 
kNªo£cÚdsP”Miüo£cÚd
 % 
kMiüo£cÚdsP”SecÚd
;

84  
	gtv
;

	@platform/common/time_util.cc

19 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gÇme¥aû
 {

25 
cÚ¡ex´
 
št64_t
 
	gkMiüo£cÚdsP”SecÚd
 = 
INT64_C
(1000000);

26 
cÚ¡ex´
 
št64_t
 
	gkNªo£cÚdsP”Miüo£cÚd
 = 
INT64_C
(1000);

27 
cÚ¡ex´
 
št64_t
 
	gkNªo£cÚdsP”SecÚd
 = 
INT64_C
(1000000000);

28 
cÚ¡ex´
 
št64_t
 
	gkFœ¡R•»£ÁabËSecÚd
 = 
INT64_MIN
 / 
kNªo£cÚdsP”SecÚd
;

29 
cÚ¡ex´
 
št64_t
 
	gkLa¡R•»£ÁabËSecÚd
 = 
INT64_MAX
 / 
kNªo£cÚdsP”SecÚd
;

33 
boŞ
 
IsR•»£ÁabËAsNªo£cÚds
(cÚ¡ 
time¥ec
 *
ts
) {

34  
	gts
->
	gtv_£c
 > 
	gkFœ¡R•»£ÁabËSecÚd
 &&

35 
	gts
->
	gtv_£c
 < 
	gkLa¡R•»£ÁabËSecÚd
;

38 
boŞ
 
IsR•»£ÁabËAsNªo£cÚds
(cÚ¡ 
timev®
 *
tv
) {

39  
	gtv
->
	gtv_£c
 > 
	gkFœ¡R•»£ÁabËSecÚd
 &&

40 
	gtv
->
	gtv_£c
 < 
	gkLa¡R•»£ÁabËSecÚd
;

43 
boŞ
 
TimeS³cSubŒaù
(cÚ¡ 
time¥ec
 &
lhs
, cÚ¡ time¥eø&
rhs
,

44 
time¥ec
 *
»suÉ
) {

46 
št64_t
 
	gr£c
 = 
rhs
.
tv_£c
, 
	gº£c
 =„hs.
tv_n£c
;

47 ià(
	glhs
.
	gtv_n£c
 < 
	gº£c
) {

48 
	g£c
 = (
º£c
 - 
lhs
.
tv_n£c
è/ 
kNªo£cÚdsP”SecÚd
 + 1;

49 
	gº£c
 -ğ
kNªo£cÚdsP”SecÚd
 * 
£c
;

50 
	gr£c
 +ğ
£c
;

53 
št64_t
 
	gd–_n£c
 = 
lhs
.
tv_n£c
 - 
º£c
;

54 ià(
	gd–_n£c
 > 
	gkNªo£cÚdsP”SecÚd
) {

55 
št64_t
 
	g£c
 = 
d–_n£c
 / 
kNªo£cÚdsP”SecÚd
;

56 
	gº£c
 +ğ
kNªo£cÚdsP”SecÚd
 * 
£c
;

57 
	gr£c
 -ğ
£c
;

61 
	g»suÉ
->
	gtv_£c
 = 
lhs
.
tv_£c
 - 
r£c
;

62 
	g»suÉ
->
	gtv_n£c
 = 
lhs
.
tv_n£c
 - 
º£c
;

63  
	glhs
.
	gtv_£c
 < 
	gr£c
;

66 
št64_t
 
TimeS³cToNªo£cÚds
(cÚ¡ 
time¥ec
 *
ts
) {

67  
	gts
->
tv_£c
 * 
	gkNªo£cÚdsP”SecÚd
 +s->
	gtv_n£c
;

70 
št64_t
 
TimeV®ToNªo£cÚds
(cÚ¡ 
timev®
 *
tv
) {

71  
	gtv
->
tv_£c
 * 
	gkNªo£cÚdsP”SecÚd
 +

72 
	gtv
->
tv_u£c
 * 
	gkNªo£cÚdsP”Miüo£cÚd
;

75 
time¥ec
 *
Nªo£cÚdsToTimeS³c
Ñime¥eø*
ts
, 
št64_t
 
Çno£cs
) {

76 
	gts
->
	gtv_£c
 = 
Çno£cs
 / 
kNªo£cÚdsP”SecÚd
;

77 
	gts
->
	gtv_n£c
 = 
Çno£cs
 % 
kNªo£cÚdsP”SecÚd
;

78  
	gts
;

81 
timev®
 *
Nªo£cÚdsToTimeV®
Ñimev® *
tv
, 
št64_t
 
Çno£cs
) {

82 
	gtv
->
	gtv_£c
 = 
Çno£cs
 / 
kNªo£cÚdsP”SecÚd
;

83 
	gtv
->
	gtv_u£c
 = 
Çno£cs
 / 
kNªo£cÚdsP”Miüo£cÚd
 % 
kMiüo£cÚdsP”SecÚd
;

84  
	gtv
;

	@platform/common/time_util.h

19 #iâdeà
ASYLO_PLATFORM_COMMON_TIME_UTIL_H_


20 
	#ASYLO_PLATFORM_COMMON_TIME_UTIL_H_


	)

22 
	~<c¡dšt
>

23 
	~<ùime
>

25 
Çme¥aû
 
	gasylo
 {

29 
boŞ
 
IsR•»£ÁabËAsNªo£cÚds
(cÚ¡ 
time¥ec
 *
ts
);

33 
boŞ
 
IsR•»£ÁabËAsNªo£cÚds
(cÚ¡ 
timev®
 *
tv
);

37 
boŞ
 
TimeS³cSubŒaù
(cÚ¡ 
time¥ec
 &
lhs
, cÚ¡ time¥eø&
rhs
,

38 
time¥ec
 *
»suÉ
);

41 
št64_t
 
TimeS³cToNªo£cÚds
(cÚ¡ 
time¥ec
 *
ts
);

44 
št64_t
 
TimeV®ToNªo£cÚds
(cÚ¡ 
timev®
 *
tv
);

47 
time¥ec
 *
Nªo£cÚdsToTimeS³c
(time¥eø*
ts
, 
št64_t
 
Çno£cs
);

50 
timev®
 *
Nªo£cÚdsToTimeV®
(timev® *
tv
, 
št64_t
 
Çno£cs
);

	@platform/common/time_util_test.cc

19 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 cÚ¡ 
št64_t
 
	gkNªo£cÚdsP”Miüo£cÚd
 = 1000;

31 
TEST
(
TimeTe¡s
, 
CÚv”siÚs
) {

32 
	g¡d
::
veùÜ
<
št64_t
> 
v®ues
 = {

35 2324227069, -1827186485, 
INT64_MAX
, 
INT64_MIN
,

39 
št64_t
 
	gv®ue
 : 
v®ues
) {

40 
time¥ec
 
ts
;

41 
Nªo£cÚdsToTimeS³c
(&
ts
, 
v®ue
);

42 
EXPECT_EQ
(
TimeS³cToNªo£cÚds
(&
ts
), 
v®ue
);

46 
št64_t
 
	gv®ue
 : 
v®ues
) {

47 
timev®
 
tv
;

48 
Nªo£cÚdsToTimeV®
(&
tv
, 
v®ue
);

51 
št64_t
 
	gex³ù©iÚ
 = 
v®ue
 - v®u% 
kNªo£cÚdsP”Miüo£cÚd
;

52 
EXPECT_EQ
(
TimeV®ToNªo£cÚds
(&
tv
), 
ex³ù©iÚ
);

57 
TEST
(
TimeTe¡s
, 
Rªge
) {

59 
	gi
 = 0; i < 63; i++) {

60 
time¥ec
 
	gts
;

61 
	gts
.
	gtv_£c
 = 
INT64_C
(1è<< 
i
;

62 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
ts
), 
i
 < 34);

63 
	gts
.
	gtv_£c
 *= -1;

64 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
ts
), 
i
 < 34);

67 
	gi
 = 0; i < 63; i++) {

68 
timev®
 
	gtv
;

69 
	gtv
.
	gtv_£c
 = 
INT64_C
(1è<< 
i
;

70 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
tv
), 
i
 < 34);

71 
	gtv
.
	gtv_£c
 *= -1;

72 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
tv
), 
i
 < 34);

76 
TEST
(
TimeTe¡s
, 
TimeS³cSubŒaù
) {

77 
time¥ec
 
	ga
, 
	gb
, 
	g»suÉ
;

79 
	ga
.
	gtv_£c
 = 5;

80 
	ga
.
	gtv_n£c
 = 700;

81 
	gb
.
	gtv_£c
 = 5;

82 
	gb
.
	gtv_n£c
 = 1200;

83 
ASSERT_TRUE
(
TimeS³cSubŒaù
(
a
, 
b
, &
»suÉ
));

84 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), -500);

85 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
b
, 
a
, &
»suÉ
));

86 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 500);

88 
	ga
.
	gtv_£c
 = 10;

89 
	ga
.
	gtv_n£c
 = 999999500;

90 
	gb
.
	gtv_£c
 = 11;

91 
	gb
.
	gtv_n£c
 = 800;

92 
ASSERT_TRUE
(
TimeS³cSubŒaù
(
a
, 
b
, &
»suÉ
));

93 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), -1300);

94 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
b
, 
a
, &
»suÉ
));

95 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 1300);

97 
	ga
 = 
b
;

98 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
a
, 
b
, &
»suÉ
));

99 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 0);

100 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
b
, 
a
, &
»suÉ
));

101 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 0);

	@platform/common/time_util_test.cc

19 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 cÚ¡ 
št64_t
 
	gkNªo£cÚdsP”Miüo£cÚd
 = 1000;

31 
TEST
(
TimeTe¡s
, 
CÚv”siÚs
) {

32 
	g¡d
::
veùÜ
<
št64_t
> 
v®ues
 = {

35 2324227069, -1827186485, 
INT64_MAX
, 
INT64_MIN
,

39 
št64_t
 
	gv®ue
 : 
v®ues
) {

40 
time¥ec
 
ts
;

41 
Nªo£cÚdsToTimeS³c
(&
ts
, 
v®ue
);

42 
EXPECT_EQ
(
TimeS³cToNªo£cÚds
(&
ts
), 
v®ue
);

46 
št64_t
 
	gv®ue
 : 
v®ues
) {

47 
timev®
 
tv
;

48 
Nªo£cÚdsToTimeV®
(&
tv
, 
v®ue
);

51 
št64_t
 
	gex³ù©iÚ
 = 
v®ue
 - v®u% 
kNªo£cÚdsP”Miüo£cÚd
;

52 
EXPECT_EQ
(
TimeV®ToNªo£cÚds
(&
tv
), 
ex³ù©iÚ
);

57 
TEST
(
TimeTe¡s
, 
Rªge
) {

59 
	gi
 = 0; i < 63; i++) {

60 
time¥ec
 
	gts
;

61 
	gts
.
	gtv_£c
 = 
INT64_C
(1è<< 
i
;

62 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
ts
), 
i
 < 34);

63 
	gts
.
	gtv_£c
 *= -1;

64 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
ts
), 
i
 < 34);

67 
	gi
 = 0; i < 63; i++) {

68 
timev®
 
	gtv
;

69 
	gtv
.
	gtv_£c
 = 
INT64_C
(1è<< 
i
;

70 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
tv
), 
i
 < 34);

71 
	gtv
.
	gtv_£c
 *= -1;

72 
EXPECT_EQ
(
IsR•»£ÁabËAsNªo£cÚds
(&
tv
), 
i
 < 34);

76 
TEST
(
TimeTe¡s
, 
TimeS³cSubŒaù
) {

77 
time¥ec
 
	ga
, 
	gb
, 
	g»suÉ
;

79 
	ga
.
	gtv_£c
 = 5;

80 
	ga
.
	gtv_n£c
 = 700;

81 
	gb
.
	gtv_£c
 = 5;

82 
	gb
.
	gtv_n£c
 = 1200;

83 
ASSERT_TRUE
(
TimeS³cSubŒaù
(
a
, 
b
, &
»suÉ
));

84 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), -500);

85 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
b
, 
a
, &
»suÉ
));

86 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 500);

88 
	ga
.
	gtv_£c
 = 10;

89 
	ga
.
	gtv_n£c
 = 999999500;

90 
	gb
.
	gtv_£c
 = 11;

91 
	gb
.
	gtv_n£c
 = 800;

92 
ASSERT_TRUE
(
TimeS³cSubŒaù
(
a
, 
b
, &
»suÉ
));

93 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), -1300);

94 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
b
, 
a
, &
»suÉ
));

95 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 1300);

97 
	ga
 = 
b
;

98 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
a
, 
b
, &
»suÉ
));

99 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 0);

100 
ASSERT_FALSE
(
TimeS³cSubŒaù
(
b
, 
a
, &
»suÉ
));

101 
ASSERT_EQ
(
TimeS³cToNªo£cÚds
(&
»suÉ
), 0);

	@platform/core/atomic.h

19 #iâdeà
ASYLO_PLATFORM_CORE_ATOMIC_H_


20 
	#ASYLO_PLATFORM_CORE_ATOMIC_H_


	)

22 
	~<c¡dlib
>

24 
Çme¥aû
 
	gasylo
 {

29 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

30 
šlše
 
T
 
Com·»AndSw­
(vŞ©T *
loÿtiÚ
, T 
ex³ùed
, T 
desœed
) {

31 
T
 
	g´evious
 = 
ex³ùed
;

32 
__©omic_com·»_exchªge_n
(
loÿtiÚ
,

33  &
´evious
,

34  
desœed
,

35  
çl£
,

36  
__ATOMIC_SEQ_CST
,

37  
__ATOMIC_SEQ_CST
);

38  
	g´evious
;

43 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

44 
šlše
 
T
 
AtomicDeüem’t
(vŞ©T *
loÿtiÚ
) {

45  
__©omic_ãtch_sub
(
loÿtiÚ
, 1, 
__ATOMIC_SEQ_CST
);

49 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

50 
šlše
 
AtomicR–—£
(vŞ©
T
 *
loÿtiÚ
) {

51 
__©omic_ş—r
(
loÿtiÚ
, 
__ATOMIC_RELEASE
);

56 
cÚ¡ex´
 
size_t
 
	gkCacheLšeSize
 = 64;

	@platform/core/bridge_msghdr_wrapper.cc

18 
	~<”ºo.h
>

20 
	~"asylo/ut/loggšg.h
"

21 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

22 
	~"asylo/¶©fÜm/cÜe/bridge_msghdr_w¿µ”.h
"

23 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

32 
boŞ
 
CİyToUÁru¡edMemÜy
(**
addr
, *
d©a
, 
size_t
 
size
) {

33 ià(
	gd©a
 && !
	gaddr
) {

34  
	gçl£
;

37 ià(!
	gd©a
) {

38 ià(
	gaddr
) {

39 *
	gaddr
 = 
nuÎ±r
;

41  
	gŒue
;

45 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

46 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

47 *
	goutside_’şave
 = 
uÁru¡ed_ÿche_m®loc
->
M®loc
(
size
);

49 
LOG_IF
(
FATAL
, !
outside_’şave
) << "Untrusted memory‡llocation failed";

51 
memıy
(
outside_’şave
, 
d©a
, 
size
);

52 *
	gaddr
 = 
outside_’şave
;

53  
	gŒue
;

59 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$BridgeMsghdrW¿µ”
(cÚ¡ 
msghdr
 *
š
) {

60 
bridge_msghdr
 
Œu¡ed_bridge_msghdr
;

61 
	`ToBridgeMsgHdr
(
š
, &
Œu¡ed_bridge_msghdr
);

62 
bridge_msghdr
 *
uÁru¡ed_bridge_msghdr
 = 
nuÎ±r
;

63 cÚ¡ 
boŞ
 
»t
 = 
	`CİyToUÁru¡edMemÜy
(

64 
»š‹½»t_ÿ¡
<**>(&
uÁru¡ed_bridge_msghdr
),

65 &
Œu¡ed_bridge_msghdr
, (
bridge_msghdr
));

66 ià(
»t
 && 
uÁru¡ed_bridge_msghdr
) {

67 
msg_out_
.
	`»£t
(
uÁru¡ed_bridge_msghdr
);

69 
msg_š_
 = 
š
;

70 
	}
}

72 
bridge_msghdr
 *
	gasylo
::
BridgeMsghdrW¿µ”
::
	$g‘_msg
()

73 cÚ¡ {  
msg_out_
.
	`g‘
(); 
	}
}

75 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgName
() {

76 *
tmp_Çme_±r
 = 
nuÎ±r
;

77 ià(!
	`CİyToUÁru¡edMemÜy
(&
tmp_Çme_±r
, 
msg_š_
->
msg_Çme
,

78 
msg_š_
->
msg_Çm–’
)) {

79  
çl£
;

81 ià(
tmp_Çme_±r
) {

82 
msg_Çme_±r_
.
	`»£t
(
tmp_Çme_±r
);

83 
msg_out_
->
msg_Çme
 = 
tmp_Çme_±r
;

85  
Œue
;

86 
	}
}

89 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgIov
() {

91 
asylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

92 
asylo
::
UÁru¡edCacheM®loc
::
	`In¡ªû
();

93 autØ
tmp_iov_±r
 =

94 
»š‹½»t_ÿ¡
<
bridge_iovec
 *>(
uÁru¡ed_ÿche_m®loc
->
	`M®loc
(

95 
msg_š_
->
msg_iovËn
 * (
bridge_iovec
)));

96 
	`LOG_IF
(
FATAL
, !
tmp_iov_±r
) << "Untrusted memory‡llocation failed";

97 ià(
tmp_iov_±r
) {

98 
msg_iov_±r_
.
	`»£t
(
tmp_iov_±r
);

99 
msg_out_
->
msg_iov
 = 
tmp_iov_±r
;

101 
i
 = 0; i < 
msg_š_
->
msg_iovËn
; ++i) {

102 ià(!
	`ToBridgeIovec
(&
msg_š_
->
msg_iov
[
i
], &
msg_out_
->msg_iov[i])) {

103 
	`LOG
(
FATAL
) << "Iovec‡llocation failed";

106  
Œue
;

107 
	}
}

109 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgIovBa£
() {

110 
i
 = 0; i < 
msg_š_
->
msg_iovËn
; ++i) {

111 
msg_iov_ba£_±rs_
.
	`push_back
(
nuÎ±r
);

112 *
tmp_iov_ba£_±r
 = 
nuÎ±r
;

113 ià(!
	`CİyToUÁru¡edMemÜy
(&
tmp_iov_ba£_±r
, 
msg_š_
->
msg_iov
[
i
].
iov_ba£
,

114 
msg_š_
->
msg_iov
[
i
].
iov_Ën
)) {

115  
çl£
;

117 ià(
tmp_iov_ba£_±r
) {

118 
msg_iov_ba£_±rs_
[
i
].
	`»£t
(
tmp_iov_ba£_±r
);

119 
msg_out_
->
msg_iov
[
i
].
iov_ba£
 = 
tmp_iov_ba£_±r
;

122  
Œue
;

123 
	}
}

125 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgCÚŒŞ
() {

126 *
tmp_cÚŒŞ_±r
 = 
nuÎ±r
;

127 ià(!
	`CİyToUÁru¡edMemÜy
(&
tmp_cÚŒŞ_±r
, 
msg_š_
->
msg_cÚŒŞ
,

128 
msg_š_
->
msg_cÚŒŞËn
)) {

129  
çl£
;

131 ià(
tmp_cÚŒŞ_±r
) {

132 
msg_cÚŒŞ_±r_
.
	`»£t
(
tmp_cÚŒŞ_±r
);

133 
msg_out_
->
msg_cÚŒŞ
 = 
tmp_cÚŒŞ_±r
;

135  
Œue
;

136 
	}
}

138 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyAÎBufãrs
() {

139 ià(!
	`CİyMsgName
(è|| !
	`CİyMsgIov
(è|| !
	`CİyMsgIovBa£
() ||

140 !
	`CİyMsgCÚŒŞ
()) {

141  
çl£
;

143  
Œue
;

144 
	}
}

	@platform/core/bridge_msghdr_wrapper.cc

18 
	~<”ºo.h
>

20 
	~"asylo/ut/loggšg.h
"

21 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

22 
	~"asylo/¶©fÜm/cÜe/bridge_msghdr_w¿µ”.h
"

23 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

32 
boŞ
 
CİyToUÁru¡edMemÜy
(**
addr
, *
d©a
, 
size_t
 
size
) {

33 ià(
	gd©a
 && !
	gaddr
) {

34  
	gçl£
;

37 ià(!
	gd©a
) {

38 ià(
	gaddr
) {

39 *
	gaddr
 = 
nuÎ±r
;

41  
	gŒue
;

45 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

46 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

47 *
	goutside_’şave
 = 
uÁru¡ed_ÿche_m®loc
->
M®loc
(
size
);

49 
LOG_IF
(
FATAL
, !
outside_’şave
) << "Untrusted memory‡llocation failed";

51 
memıy
(
outside_’şave
, 
d©a
, 
size
);

52 *
	gaddr
 = 
outside_’şave
;

53  
	gŒue
;

59 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$BridgeMsghdrW¿µ”
(cÚ¡ 
msghdr
 *
š
) {

60 
bridge_msghdr
 
Œu¡ed_bridge_msghdr
;

61 
	`ToBridgeMsgHdr
(
š
, &
Œu¡ed_bridge_msghdr
);

62 
bridge_msghdr
 *
uÁru¡ed_bridge_msghdr
 = 
nuÎ±r
;

63 cÚ¡ 
boŞ
 
»t
 = 
	`CİyToUÁru¡edMemÜy
(

64 
»š‹½»t_ÿ¡
<**>(&
uÁru¡ed_bridge_msghdr
),

65 &
Œu¡ed_bridge_msghdr
, (
bridge_msghdr
));

66 ià(
»t
 && 
uÁru¡ed_bridge_msghdr
) {

67 
msg_out_
.
	`»£t
(
uÁru¡ed_bridge_msghdr
);

69 
msg_š_
 = 
š
;

70 
	}
}

72 
bridge_msghdr
 *
	gasylo
::
BridgeMsghdrW¿µ”
::
	$g‘_msg
()

73 cÚ¡ {  
msg_out_
.
	`g‘
(); 
	}
}

75 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgName
() {

76 *
tmp_Çme_±r
 = 
nuÎ±r
;

77 ià(!
	`CİyToUÁru¡edMemÜy
(&
tmp_Çme_±r
, 
msg_š_
->
msg_Çme
,

78 
msg_š_
->
msg_Çm–’
)) {

79  
çl£
;

81 ià(
tmp_Çme_±r
) {

82 
msg_Çme_±r_
.
	`»£t
(
tmp_Çme_±r
);

83 
msg_out_
->
msg_Çme
 = 
tmp_Çme_±r
;

85  
Œue
;

86 
	}
}

89 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgIov
() {

91 
asylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

92 
asylo
::
UÁru¡edCacheM®loc
::
	`In¡ªû
();

93 autØ
tmp_iov_±r
 =

94 
»š‹½»t_ÿ¡
<
bridge_iovec
 *>(
uÁru¡ed_ÿche_m®loc
->
	`M®loc
(

95 
msg_š_
->
msg_iovËn
 * (
bridge_iovec
)));

96 
	`LOG_IF
(
FATAL
, !
tmp_iov_±r
) << "Untrusted memory‡llocation failed";

97 ià(
tmp_iov_±r
) {

98 
msg_iov_±r_
.
	`»£t
(
tmp_iov_±r
);

99 
msg_out_
->
msg_iov
 = 
tmp_iov_±r
;

101 
i
 = 0; i < 
msg_š_
->
msg_iovËn
; ++i) {

102 ià(!
	`ToBridgeIovec
(&
msg_š_
->
msg_iov
[
i
], &
msg_out_
->msg_iov[i])) {

103 
	`LOG
(
FATAL
) << "Iovec‡llocation failed";

106  
Œue
;

107 
	}
}

109 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgIovBa£
() {

110 
i
 = 0; i < 
msg_š_
->
msg_iovËn
; ++i) {

111 
msg_iov_ba£_±rs_
.
	`push_back
(
nuÎ±r
);

112 *
tmp_iov_ba£_±r
 = 
nuÎ±r
;

113 ià(!
	`CİyToUÁru¡edMemÜy
(&
tmp_iov_ba£_±r
, 
msg_š_
->
msg_iov
[
i
].
iov_ba£
,

114 
msg_š_
->
msg_iov
[
i
].
iov_Ën
)) {

115  
çl£
;

117 ià(
tmp_iov_ba£_±r
) {

118 
msg_iov_ba£_±rs_
[
i
].
	`»£t
(
tmp_iov_ba£_±r
);

119 
msg_out_
->
msg_iov
[
i
].
iov_ba£
 = 
tmp_iov_ba£_±r
;

122  
Œue
;

123 
	}
}

125 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyMsgCÚŒŞ
() {

126 *
tmp_cÚŒŞ_±r
 = 
nuÎ±r
;

127 ià(!
	`CİyToUÁru¡edMemÜy
(&
tmp_cÚŒŞ_±r
, 
msg_š_
->
msg_cÚŒŞ
,

128 
msg_š_
->
msg_cÚŒŞËn
)) {

129  
çl£
;

131 ià(
tmp_cÚŒŞ_±r
) {

132 
msg_cÚŒŞ_±r_
.
	`»£t
(
tmp_cÚŒŞ_±r
);

133 
msg_out_
->
msg_cÚŒŞ
 = 
tmp_cÚŒŞ_±r
;

135  
Œue
;

136 
	}
}

138 
boŞ
 
	gasylo
::
BridgeMsghdrW¿µ”
::
	$CİyAÎBufãrs
() {

139 ià(!
	`CİyMsgName
(è|| !
	`CİyMsgIov
(è|| !
	`CİyMsgIovBa£
() ||

140 !
	`CİyMsgCÚŒŞ
()) {

141  
çl£
;

143  
Œue
;

144 
	}
}

	@platform/core/bridge_msghdr_wrapper.h

19 #iâdeà
ASYLO_PLATFORM_CORE_BRIDGE_MSGHDR_WRAPPER_H_


20 
	#ASYLO_PLATFORM_CORE_BRIDGE_MSGHDR_WRAPPER_H_


	)

22 
	~<sys/sock‘.h
>

23 
	~<veùÜ
>

25 
	~"asylo/¶©fÜm/commÚ/bridge_ty³s.h
"

26 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

28 
Çme¥aû
 
	gasylo
 {

32 şas 
	cBridgeMsghdrW¿µ”
 {

33 
	gpublic
:

34 
ex¶ic™
 
BridgeMsghdrW¿µ”
(cÚ¡ 
msghdr
 *
š
);

35 
BridgeMsghdrW¿µ”
(cÚ¡ BridgeMsghdrW¿µ” &
Ùh”
èğ
d–‘e
;

36 
	gBridgeMsghdrW¿µ”
 &
	gİ”©Ü
=(cÚ¡ 
BridgeMsghdrW¿µ”
 &
Ùh”
èğ
d–‘e
;

37 
bridge_msghdr
 *
g‘_msg
() const;

38 
boŞ
 
CİyAÎBufãrs
();

40 
	g´iv©e
:

41 
boŞ
 
CİyMsgName
();

42 
boŞ
 
CİyMsgIov
();

43 
boŞ
 
CİyMsgIovBa£
();

44 
boŞ
 
CİyMsgCÚŒŞ
();

46 cÚ¡ 
msghdr
 *
	gmsg_š_
;

47 
	gUÁru¡edUniquePŒ
<
	gbridge_msghdr
> 
	gmsg_out_
;

48 
	gUÁru¡edUniquePŒ
<> 
	gmsg_Çme_±r_
;

49 
	gUÁru¡edUniquePŒ
<> 
	gmsg_iov_±r_
;

50 
	gUÁru¡edUniquePŒ
<> 
	gmsg_cÚŒŞ_±r_
;

51 
	g¡d
::
veùÜ
<
UÁru¡edUniquePŒ
<>> 
msg_iov_ba£_±rs_
;

	@platform/core/enclave_client.h

19 #iâdeà
ASYLO_PLATFORM_CORE_ENCLAVE_CLIENT_H_


20 
	#ASYLO_PLATFORM_CORE_ENCLAVE_CLIENT_H_


	)

22 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/’şave.pb.h
"

25 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

26 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme.h
"

27 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

36 şas 
	cEnşaveCl›Á
 {

37 
	gpublic
:

38 
EnşaveCl›Á
(cÚ¡ EnşaveCl›Á &èğ
d–‘e
;

40 
	gEnşaveCl›Á
 &
	gİ”©Ü
=(cÚ¡ 
EnşaveCl›Á
 &èğ
d–‘e
;

42 
	gvœtu®
 ~
EnşaveCl›Á
() = ;

51 
vœtu®
 
Stus
 
EÁ”AndRun
(cÚ¡ 
EnşaveIÅut
 &
šput
,

52 
EnşaveOuut
 *
ouut
) = 0;

57 
vœtu®
 cÚ¡ 
	g¡d
::
¡ršg
 &
g‘_Çme
(ècÚ¡ {  
Çme_
; }

59 
	g´Ùeùed
:

63 
ex¶ic™
 
EnşaveCl›Á
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
è: 
Çme_
(name) {}

66 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> 
´im™ive_ş›Á_
;

68 
	g´iv©e
:

69 
ä›nd
 
şass
 
EnşaveMªag”
;

70 
ä›nd
 
şass
 
	gEnşaveSigÇlDi¥©ch”
;

71 
ä›nd
 
dÚ©e
(
EnşaveCl›Á
 *
ş›Á
);

74 
vœtu®
 
Stus
 
EÁ”AndIn™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) = 0;

77 
vœtu®
 
Stus
 
EÁ”AndFš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) = 0;

80 
vœtu®
 
Stus
 
EÁ”AndDÚ©eTh»ad
() = 0;

83 
vœtu®
 
Stus
 
EÁ”AndHªdËSigÇl
(cÚ¡ 
EnşaveSigÇl
 &
sigÇl
) = 0;

88 
vœtu®
 
Stus
 
De¡royEnşave
() = 0;

90 
	g¡d
::
¡ršg
 
Çme_
;

	@platform/core/enclave_clock_test.cc

19 
	~<time.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/time/time.h
"

24 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

25 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

26 
	~"asylo/¶©fÜm/cÜe/sh¬ed_»sourû_mªag”.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
št64_t
 
MÚÙÚicClock
() {

32 
time¥ec
 
	gts
;

33 
şock_g‘time
(
CLOCK_MONOTONIC
, &
ts
);

34  
TimeS³cToNªo£cÚds
(&
ts
);

39 
TEST
(
EnşaveClockTe¡
, 
E¼ÜBounds
) {

40 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

41 autØ
	g’şave_mªag”
 = 
EnşaveMªag”
::
In¡ªû
();

42 autØ*
	g»sourûs
 = 
’şave_mªag”
.
V®ueOrD›
()->
sh¬ed_»sourûs
();

43 autØ*
	gşock
 = 
»sourûs
->
AcquœeResourû
<
¡d
::
©omic
<
št64_t
>>(

44 
Sh¬edName
(
kAdd»ssName
, "clock_monotonic"));

45 
ASSERT_NE
(
şock
, 
nuÎ±r
);

46 
	gi
 = 0; i < 1000; i++) {

47 
št64_t
 
	g”rÜ
 = 
¡d
::
abs
(*
şock
 - 
MÚÙÚicClock
());

48 
EXPECT_LT
(
”rÜ
, 
ab¦
::
ToIÁ64Nªo£cÚds
×b¦::
Mli£cÚds
(100)));

49 
	gab¦
::
SË•FÜ
(
ab¦
::
Mli£cÚds
(1));

	@platform/core/enclave_clock_test.cc

19 
	~<time.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/time/time.h
"

24 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

25 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

26 
	~"asylo/¶©fÜm/cÜe/sh¬ed_»sourû_mªag”.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
št64_t
 
MÚÙÚicClock
() {

32 
time¥ec
 
	gts
;

33 
şock_g‘time
(
CLOCK_MONOTONIC
, &
ts
);

34  
TimeS³cToNªo£cÚds
(&
ts
);

39 
TEST
(
EnşaveClockTe¡
, 
E¼ÜBounds
) {

40 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

41 autØ
	g’şave_mªag”
 = 
EnşaveMªag”
::
In¡ªû
();

42 autØ*
	g»sourûs
 = 
’şave_mªag”
.
V®ueOrD›
()->
sh¬ed_»sourûs
();

43 autØ*
	gşock
 = 
»sourûs
->
AcquœeResourû
<
¡d
::
©omic
<
št64_t
>>(

44 
Sh¬edName
(
kAdd»ssName
, "clock_monotonic"));

45 
ASSERT_NE
(
şock
, 
nuÎ±r
);

46 
	gi
 = 0; i < 1000; i++) {

47 
št64_t
 
	g”rÜ
 = 
¡d
::
abs
(*
şock
 - 
MÚÙÚicClock
());

48 
EXPECT_LT
(
”rÜ
, 
ab¦
::
ToIÁ64Nªo£cÚds
×b¦::
Mli£cÚds
(100)));

49 
	gab¦
::
SË•FÜ
(
ab¦
::
Mli£cÚds
(1));

	@platform/core/enclave_config_util.cc

19 
	~"asylo/¶©fÜm/cÜe/’şave_cÚfig_ut.h
"

21 
	~<”ºo.h
>

22 
	~<uni¡d.h
>

24 
	~"asylo/ut/loggšg.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

31 
S‘DeçuÉHo¡Name
(
EnşaveCÚfig
 *
cÚfig
) {

33 ià(
	gcÚfig
->
has_ho¡_Çme
()) ;

36 
	gbuf
[1024];

37 ià(
g‘ho¡Çme
(
buf
, (buf)) != 0) {

38 
LOG
(
ERROR
è<< "g‘ho¡ÇmÚ ho¡ faed:" << 
¡»¼Ü
(
”ºo
);

41 
	gbuf
[(
buf
) - 1] = '\0';

42 
	gcÚfig
->
£t_ho¡_Çme
(
buf
);

47 
S‘DeçuÉCu¼’tWÜkšgDœeùÜy
(
EnşaveCÚfig
 *
cÚfig
) {

49 ià(
	gcÚfig
->
has_cu¼’t_wÜkšg_dœeùÜy
()) ;

52 
	gbuf
[
PATH_MAX
];

53 ià(!
g‘cwd
(
buf
, (buf))) {

54 
LOG
(
ERROR
è<< "g‘cwd oÀho¡ faed:" << 
¡»¼Ü
(
”ºo
);

57 
	gbuf
[(
buf
) - 1] = '\0';

58 
	gcÚfig
->
£t_cu¼’t_wÜkšg_dœeùÜy
(
buf
);

63 
S‘Ho¡CÚfig
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
, 
EnşaveCÚfig
 *
cÚfig
) {

64 
Ho¡CÚfig
 *
	gmubË_ho¡_cÚfig
 = 
cÚfig
->
mubË_ho¡_cÚfig
();

65 ià(!
	gmubË_ho¡_cÚfig
->
has_loÿl_©‹¡©iÚ_domaš
() &&

66 
	gho¡_cÚfig
.
has_loÿl_©‹¡©iÚ_domaš
()) {

67 
	gmubË_ho¡_cÚfig
->
£t_loÿl_©‹¡©iÚ_domaš
(

68 
ho¡_cÚfig
.
loÿl_©‹¡©iÚ_domaš
());

74 
S‘EnşaveCÚfigDeçuÉs
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
,

75 
EnşaveCÚfig
 *
cÚfig
) {

76 
S‘DeçuÉHo¡Name
(
cÚfig
);

77 
S‘DeçuÉCu¼’tWÜkšgDœeùÜy
(
cÚfig
);

78 
S‘Ho¡CÚfig
(
ho¡_cÚfig
, 
cÚfig
);

81 
EnşaveCÚfig
 
C»©eDeçuÉEnşaveCÚfig
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
) {

82 
EnşaveCÚfig
 
	gcÚfig
;

83 
S‘EnşaveCÚfigDeçuÉs
(
ho¡_cÚfig
, &
cÚfig
);

84  
	gcÚfig
;

	@platform/core/enclave_config_util.cc

19 
	~"asylo/¶©fÜm/cÜe/’şave_cÚfig_ut.h
"

21 
	~<”ºo.h
>

22 
	~<uni¡d.h
>

24 
	~"asylo/ut/loggšg.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

31 
S‘DeçuÉHo¡Name
(
EnşaveCÚfig
 *
cÚfig
) {

33 ià(
	gcÚfig
->
has_ho¡_Çme
()) ;

36 
	gbuf
[1024];

37 ià(
g‘ho¡Çme
(
buf
, (buf)) != 0) {

38 
LOG
(
ERROR
è<< "g‘ho¡ÇmÚ ho¡ faed:" << 
¡»¼Ü
(
”ºo
);

41 
	gbuf
[(
buf
) - 1] = '\0';

42 
	gcÚfig
->
£t_ho¡_Çme
(
buf
);

47 
S‘DeçuÉCu¼’tWÜkšgDœeùÜy
(
EnşaveCÚfig
 *
cÚfig
) {

49 ià(
	gcÚfig
->
has_cu¼’t_wÜkšg_dœeùÜy
()) ;

52 
	gbuf
[
PATH_MAX
];

53 ià(!
g‘cwd
(
buf
, (buf))) {

54 
LOG
(
ERROR
è<< "g‘cwd oÀho¡ faed:" << 
¡»¼Ü
(
”ºo
);

57 
	gbuf
[(
buf
) - 1] = '\0';

58 
	gcÚfig
->
£t_cu¼’t_wÜkšg_dœeùÜy
(
buf
);

63 
S‘Ho¡CÚfig
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
, 
EnşaveCÚfig
 *
cÚfig
) {

64 
Ho¡CÚfig
 *
	gmubË_ho¡_cÚfig
 = 
cÚfig
->
mubË_ho¡_cÚfig
();

65 ià(!
	gmubË_ho¡_cÚfig
->
has_loÿl_©‹¡©iÚ_domaš
() &&

66 
	gho¡_cÚfig
.
has_loÿl_©‹¡©iÚ_domaš
()) {

67 
	gmubË_ho¡_cÚfig
->
£t_loÿl_©‹¡©iÚ_domaš
(

68 
ho¡_cÚfig
.
loÿl_©‹¡©iÚ_domaš
());

74 
S‘EnşaveCÚfigDeçuÉs
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
,

75 
EnşaveCÚfig
 *
cÚfig
) {

76 
S‘DeçuÉHo¡Name
(
cÚfig
);

77 
S‘DeçuÉCu¼’tWÜkšgDœeùÜy
(
cÚfig
);

78 
S‘Ho¡CÚfig
(
ho¡_cÚfig
, 
cÚfig
);

81 
EnşaveCÚfig
 
C»©eDeçuÉEnşaveCÚfig
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
) {

82 
EnşaveCÚfig
 
	gcÚfig
;

83 
S‘EnşaveCÚfigDeçuÉs
(
ho¡_cÚfig
, &
cÚfig
);

84  
	gcÚfig
;

	@platform/core/enclave_config_util.h

19 #iâdeà
ASYLO_PLATFORM_CORE_ENCLAVE_CONFIG_UTIL_H_


20 
	#ASYLO_PLATFORM_CORE_ENCLAVE_CONFIG_UTIL_H_


	)

22 
	~"asylo/’şave.pb.h
"

24 
Çme¥aû
 
	gasylo
 {

30 
S‘EnşaveCÚfigDeçuÉs
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
,

31 
EnşaveCÚfig
 *
cÚfig
);

40 
EnşaveCÚfig
 
C»©eDeçuÉEnşaveCÚfig
(cÚ¡ 
Ho¡CÚfig
 &
ho¡_cÚfig
);

	@platform/core/enclave_manager.cc

19 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

21 
	~<sigÇl.h
>

22 
	~<¡dšt.h
>

23 
	~<sys/ucÚ‹xt.h
>

24 
	~<time.h
>

25 
	~<th»ad
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

37 
št64_t
 
MÚÙÚicClock
() {

38 
time¥ec
 
	gts
;

39 
CHECK
(
şock_g‘time
(
CLOCK_MONOTONIC
, &
ts
) == 0)

41  
TimeS³cToNªo£cÚds
(&
ts
);

45 
št64_t
 
R—lTimeClock
() {

46 
time¥ec
 
	gts
;

47 
CHECK
(
şock_g‘time
(
CLOCK_REALTIME
, &
ts
) == 0)

49  
TimeS³cToNªo£cÚds
(&
ts
);

53 
SË•
(
št64_t
 
Çno£cÚds
) {

54 
time¥ec
 
	g»q
;

55 
Çno¦“p
(
Nªo£cÚdsToTimeS³c
(&
»q
, 
Çno£cÚds
), 
nuÎ±r
);

59 
Wa™UÁ
(
št64_t
 
d—dlše
) {

60 
št64_t
 
	gd–
;

61 (
	gd–
 = 
d—dlše
 - 
MÚÙÚicClock
()) > 0) {

62 
SË•
(
d–
);

68 
	gab¦
::
Mu‹x
 
EnşaveMªag”
::
mu_
;

69 
boŞ
 
	gEnşaveMªag”
::
cÚfigu»d_
 = 
çl£
;

70 
EnşaveMªag”O±iÚs
 *
	gEnşaveMªag”
::
İtiÚs_
 = 
nuÎ±r
;

71 
EnşaveMªag”
 *
	gEnşaveMªag”
::
š¡ªû_
 = 
nuÎ±r
;

73 
dÚ©e
(
asylo
::
EnşaveCl›Á
 *
ş›Á
) {

74 
Stus
 
¡©us
 = 
ş›Á
->
EÁ”AndDÚ©eTh»ad
();

75 ià(!
	g¡©us
.
ok
()) {

76 
LOG
(
ERROR
è<< "EÁ”AndDÚ©eTh»ad(èçed: " << 
	g¡©us
;

81 
	gEnşaveMªag”O±iÚs
::
EnşaveMªag”O±iÚs
()

82 : 
ho¡_cÚfig_šfo_
(
ab¦
::
š_¶aû_ty³_t
<
Ho¡CÚfig
>()) {}

84 
EnşaveMªag”O±iÚs
 &

85 
EnşaveMªag”O±iÚs
::
£t_cÚfig_£rv”_cÚÃùiÚ_©Œibu‹s
(

86 
¡d
::
¡ršg
 
add»ss
, 
ab¦
::
Du¿tiÚ
 
timeout
) {

87 
ho¡_cÚfig_šfo_
.
em¶aû
<
CÚfigS”v”CÚÃùiÚA‰ribu‹s
>(

88 
¡d
::
move
(
add»ss
), 
	gtimeout
);

89  *
	gthis
;

92 
	gEnşaveMªag”O±iÚs
 &EnşaveMªag”O±iÚs::
£t_ho¡_cÚfig
(

93 
Ho¡CÚfig
 
cÚfig
) {

94 
ho¡_cÚfig_šfo_
.
em¶aû
<
Ho¡CÚfig
>(
¡d
::
move
(
cÚfig
));

95  *
	gthis
;

98 
	gStusOr
<
	g¡d
::
¡ršg
> 
EnşaveMªag”O±iÚs
::
g‘_cÚfig_£rv”_add»ss
() const {

99 cÚ¡ 
CÚfigS”v”CÚÃùiÚA‰ribu‹s
 *
©Œibu‹s
 =

100 
ab¦
::
g‘_if
<
CÚfigS”v”CÚÃùiÚA‰ribu‹s
>(&
ho¡_cÚfig_šfo_
);

101 ià(!
	g©Œibu‹s
) {

102  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

105  
	g©Œibu‹s
->
	g£rv”_add»ss
;

108 
	gStusOr
<
	gab¦
::
Du¿tiÚ
>

109 
EnşaveMªag”O±iÚs
::
g‘_cÚfig_£rv”_cÚÃùiÚ_timeout
() const {

110 cÚ¡ 
CÚfigS”v”CÚÃùiÚA‰ribu‹s
 *
©Œibu‹s
 =

111 
ab¦
::
g‘_if
<
CÚfigS”v”CÚÃùiÚA‰ribu‹s
>(&
ho¡_cÚfig_šfo_
);

112 ià(!
	g©Œibu‹s
) {

113  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

116  
	g©Œibu‹s
->
	gcÚÃùiÚ_timeout
;

119 
	gStusOr
<
	gHo¡CÚfig
> 
	gEnşaveMªag”O±iÚs
::
g‘_ho¡_cÚfig
() const {

120 cÚ¡ 
Ho¡CÚfig
 *
cÚfig
 = 
ab¦
::
g‘_if
<Ho¡CÚfig>(&
ho¡_cÚfig_šfo_
);

121 ià(!
	gcÚfig
) {

122  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

125  *
	gcÚfig
;

128 
boŞ
 
	gEnşaveMªag”O±iÚs
::
hŞds_ho¡_cÚfig
() const {

129  
ab¦
::
hŞds_®‹º©ive
<
Ho¡CÚfig
>(
ho¡_cÚfig_šfo_
);

132 
Ho¡CÚfig
 
	gEnşaveMªag”
::
G‘Ho¡CÚfig
() {

133 ià(
İtiÚs_
->
hŞds_ho¡_cÚfig
()) {

134 
StusOr
<
Ho¡CÚfig
> 
cÚfig_»suÉ
 = 
İtiÚs_
->
g‘_ho¡_cÚfig
();

135 ià(!
	gcÚfig_»suÉ
.
ok
()) {

136 
LOG
(
ERROR
è<< 
	gcÚfig_»suÉ
.
¡©us
();

137  
Ho¡CÚfig
();

139  
	gcÚfig_»suÉ
.
V®ueOrD›
();

142 
Ho¡CÚfig
 
	gcÚfig
;

143 
LOG
(
ERROR
) << "Not implemented";

144  
	gcÚfig
;

147 
	gEnşaveMªag”
::
EnşaveMªag”
(è: 
ho¡_cÚfig_
(
G‘Ho¡CÚfig
()) {

148 
Stus
 
rc
 = 
sh¬ed_»sourû_mªag”_
.
Regi¡”UnmªagedResourû
(

149 
Sh¬edName
::
Add»ss
("şock_mÚÙÚic"), &
şock_mÚÙÚic_
);

150 ià(!
	grc
.
ok
()) {

151 
LOG
(
FATAL
) << "Could‚ot„egister monotonic clock„esource.";

154 
	grc
 = 
sh¬ed_»sourû_mªag”_
.
Regi¡”UnmªagedResourû
(

155 
Sh¬edName
::
Add»ss
("şock_»®time"), &
şock_»®time_
);

156 ià(!
	grc
.
ok
()) {

157 
LOG
(
FATAL
) << "Could‚ot„egister„ealtime clock„esource.";

160 
S·wnWÜk”Th»ad
();

163 
Stus
 
	gEnşaveMªag”
::
De¡royEnşave
(
EnşaveCl›Á
 *
ş›Á
,

164 cÚ¡ 
EnşaveFš®
 &
fš®_šput
,

165 
boŞ
 
sk_fš®ize
) {

166 ià(!
	gş›Á
) {

167  
	gStus
::
OkStus
();

170 
Stus
 
	gfš®ize_¡©us
;

171 ià(!
	gsk_fš®ize
) {

172 
	gfš®ize_¡©us
 = 
ş›Á
->
EÁ”AndFš®ize
(
fš®_šput
);

174 
LOG_IF
(
ERROR
, !
fš®ize_¡©us
.
ok
()è<< "Cl›Á' EÁ”AndFš®izçed: " << 
	gfš®ize_¡©us
;

176 
Stus
 
	g¡©us
 = 
ş›Á
->
De¡royEnşave
();

177 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< "Cl›Á' De¡royEnşavçed: " << 
	g¡©us
;

179 
	g¡©us
 =

180 
EnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
()->
D”egi¡”AÎSigÇlsFÜCl›Á
(

181 
ş›Á
);

182 
LOG_IF
(
ERROR
, !
¡©us
.
ok
())

183 << "D”egi¡”AÎSigÇlsFÜCl›Á faed: " << 
	g¡©us
;

185 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

186 cÚ¡‡utØ&
	gÇme
 = 
Çme_by_ş›Á_
[
ş›Á
];

187 
	gş›Á_by_Çme_
.
”a£
(
Çme
);

188 
	gÇme_by_ş›Á_
.
”a£
(
ş›Á
);

189 
	glßd”_by_ş›Á_
.
”a£
(
ş›Á
);

191  
	gfš®ize_¡©us
;

194 
EnşaveCl›Á
 *
	gEnşaveMªag”
::
G‘Cl›Á
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) const {

195 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

196 autØ
	g™
 = 
ş›Á_by_Çme_
.
fšd
(
Çme
);

197 ià(
	g™
 =ğ
ş›Á_by_Çme_
.
’d
()) {

198  
nuÎ±r
;

200  
	g™
->
	g£cÚd
.
g‘
();

204 cÚ¡ 
	g¡d
::
¡ršg
 
EnşaveMªag”
::
G‘Name
(cÚ¡ 
EnşaveCl›Á
 *
ş›Á
) const {

205 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

206 autØ
	g™
 = 
Çme_by_ş›Á_
.
fšd
(
ş›Á
);

207 ià(
	g™
 =ğ
Çme_by_ş›Á_
.
’d
()) {

210  
	g™
->
	g£cÚd
;

214 
EnşaveLßd”
 *
	gEnşaveMªag”
::
G‘Lßd”FromCl›Á
(
EnşaveCl›Á
 *
ş›Á
) {

215 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

216 ià(!
	gş›Á
 || 
	glßd”_by_ş›Á_
.
fšd
(
ş›Á
è=ğ
lßd”_by_ş›Á_
.
’d
()) {

217  
nuÎ±r
;

219  
	glßd”_by_ş›Á_
[
ş›Á
].
g‘
();

222 
Stus
 
	gEnşaveMªag”
::
CÚfigu»
(cÚ¡ 
EnşaveMªag”O±iÚs
 &
İtiÚs
) {

223 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

225 ià(
	gš¡ªû_
) {

226  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

231 
d–‘e
 
	gİtiÚs_
;

232 
	gİtiÚs_
 = 
Ãw
 
EnşaveMªag”O±iÚs
(
İtiÚs
);

233 
	gcÚfigu»d_
 = 
Œue
;

234  
	gStus
::
OkStus
();

237 
	gStusOr
<
	gEnşaveMªag”
 *> EnşaveMªag”::
In¡ªû
() {

238 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

240 ià(
	gš¡ªû_
) {

241  
	gš¡ªû_
;

244 ià(!
	gcÚfigu»d_
) {

245  
Stus
(

246 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

250 
	gš¡ªû_
 = 
Ãw
 
EnşaveMªag”
();

251 ià(!
	gš¡ªû_
) {

252  
Stus
(
”rÜ
::
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
,

256  
	gš¡ªû_
;

259 
Stus
 
	gEnşaveMªag”
::
LßdEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
,

260 cÚ¡ 
EnşaveLßd”
 &
lßd”
,

261 *
ba£_add»ss
,

262 cÚ¡ 
size_t
 
’şave_size
) {

263  
LßdEnşaveIÁ”Çl
(

264 
Çme
, 
lßd”
, 
C»©eDeçuÉEnşaveCÚfig
(
ho¡_cÚfig_
), 
ba£_add»ss
,

265 
’şave_size
);

268 
Stus
 
	gEnşaveMªag”
::
LßdEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
,

269 cÚ¡ 
EnşaveLßd”
 &
lßd”
,

270 
EnşaveCÚfig
 
cÚfig
, *
ba£_add»ss
,

271 cÚ¡ 
size_t
 
’şave_size
) {

272 
EnşaveCÚfig
 
	g§n™ized_cÚfig
 = 
¡d
::
move
(
cÚfig
);

273 
S‘EnşaveCÚfigDeçuÉs
(
ho¡_cÚfig_
, &
§n™ized_cÚfig
);

274  
LßdEnşaveIÁ”Çl
(
Çme
, 
lßd”
, 
§n™ized_cÚfig
, 
ba£_add»ss
,

275 
’şave_size
);

278 
Stus
 
	gEnşaveMªag”
::
LßdEnşaveIÁ”Çl
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
,

279 cÚ¡ 
EnşaveLßd”
 &
lßd”
,

280 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
,

281 *
ba£_add»ss
,

282 cÚ¡ 
size_t
 
’şave_size
) {

283 ià(
	gcÚfig
.
’abË_fÜk
(è&& 
	gba£_add»ss
) {

287 
RemoveEnşaveReã»nû
(
Çme
);

291 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

292 ià(
	gş›Á_by_Çme_
.
fšd
(
Çme
è!ğ
ş›Á_by_Çme_
.
’d
()) {

297 
ş›Á_by_Çme_
.
”a£
(
Çme
);

302 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
»suÉ
 =

303 
lßd”
.
LßdEnşave
(
Çme
, 
ba£_add»ss
, 
’şave_size
, 
cÚfig
);

304 ià(!
	g»suÉ
.
ok
()) {

305 
LOG
(
ERROR
è<< "LßdEnşavçed: " << 
	g»suÉ
.
¡©us
();

306  
	g»suÉ
.
¡©us
();

310 
EnşaveCl›Á
 *
	gş›Á
 = 
»suÉ
.
V®ueOrD›
().
g‘
();

312 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

313 
	gş›Á_by_Çme_
.
em¶aû
(
Çme
, 
¡d
::
move
(
»suÉ
).
V®ueOrD›
());

314 
	gÇme_by_ş›Á_
.
em¶aû
(
ş›Á
, 
Çme
);

316 ià(
	gcÚfig
.
’abË_fÜk
()) {

317 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
lßd”_»suÉ
 = 
lßd”
.
Cİy
();

318 ià(!
	glßd”_»suÉ
.
ok
()) {

319  
	glßd”_»suÉ
.
¡©us
();

321 
	glßd”_by_ş›Á_
.
em¶aû
(
ş›Á
, 
¡d
::
move
(
lßd”_»suÉ
.
V®ueOrD›
()));

325 
Stus
 
	g¡©us
 = 
ş›Á
->
EÁ”AndIn™Ÿlize
(
cÚfig
);

328 ià(!
	g¡©us
.
ok
()) {

329 
Stus
 
	gde¡roy_¡©us
 = 
ş›Á
->
De¡royEnşave
();

330 ià(!
	gde¡roy_¡©us
.
ok
()) {

331 
LOG
(
ERROR
) << "DestroyEnclave failed‡fter EnterAndInitialize failure: "

332 << 
	gde¡roy_¡©us
;

335 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

336 
	gş›Á_by_Çme_
.
”a£
(
Çme
);

337 
	gÇme_by_ş›Á_
.
”a£
(
ş›Á
);

338 
	glßd”_by_ş›Á_
.
”a£
(
ş›Á
);

341  
	g¡©us
;

344 
	gEnşaveMªag”
::
RemoveEnşaveReã»nû
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

345 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

346 
EnşaveCl›Á
 *
	gş›Á
 = 
ş›Á_by_Çme_
[
Çme
].
g‘
();

347 
	gş›Á_by_Çme_
.
”a£
(
Çme
);

348 
	gÇme_by_ş›Á_
.
”a£
(
ş›Á
);

351 
	gEnşaveMªag”
::
S·wnWÜk”Th»ad
() {

354 
Tick
();

355 
	g¡d
::
th»ad
 
wÜk”
([
this
] { 
WÜk”Loİ
(); });

356 
	gwÜk”
.
d‘ach
();

359 
	gEnşaveMªag”
::
Tick
() {

360 
şock_mÚÙÚic_
 = 
MÚÙÚicClock
();

361 
	gşock_»®time_
 = 
R—lTimeClock
();

364 
	gEnşaveMªag”
::
WÜk”Loİ
() {

366 
cÚ¡ex´
 
št64_t
 
kClockP”iod
 = 
INT64_C
(70000);

367 
št64_t
 
	gÃxt_tick
 = 
MÚÙÚicClock
();

368 
	gŒue
) {

369 
Wa™UÁ
(
Ãxt_tick
);

370 
Tick
();

371 
	gÃxt_tick
 +ğ
kClockP”iod
;

375 
EnşaveSigÇlDi¥©ch”
 *
	gEnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
() {

376 
EnşaveSigÇlDi¥©ch”
 *
š¡ªû
 = 
Ãw
 EnclaveSignalDispatcher();

377  
	gš¡ªû
;

380 
	gStusOr
<
	gEnşaveCl›Á
 *> 
	gEnşaveSigÇlDi¥©ch”
::
G‘Cl›ÁFÜSigÇl
(

381 
signum
) const {

382 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_’şave_m­_lock_
);

383 autØ
	g™
 = 
sigÇl_to_ş›Á_m­_
.
fšd
(
signum
);

384 ià(
	g™
 =ğ
sigÇl_to_ş›Á_m­_
.
’d
()) {

385  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

386 
ab¦
::
SŒC©
("NØ’şavha »gi¡”ed sigÇl: ", 
signum
));

388  
	g™
->
	g£cÚd
;

391 cÚ¡ 
EnşaveCl›Á
 *
	gEnşaveSigÇlDi¥©ch”
::
Regi¡”SigÇl
(

392 
signum
, 
EnşaveCl›Á
 *
ş›Á
) {

394 
sig£t_t
 
	gmask
, 
	gŞdmask
;

395 
sigfl£t
(&
mask
);

396 
sig´ocmask
(
SIG_SETMASK
, &
mask
, &
Şdmask
);

397 
EnşaveCl›Á
 *
	gŞd_ş›Á
 = 
nuÎ±r
;

399 
	gab¦
::
Mu‹xLock
 
lock
(&
sigÇl_’şave_m­_lock_
);

401 autØ
	gş›Á_™”©Ü
 = 
sigÇl_to_ş›Á_m­_
.
fšd
(
signum
);

402 ià(
	gş›Á_™”©Ü
 !ğ
sigÇl_to_ş›Á_m­_
.
’d
()) {

403 
Şd_ş›Á
 = 
ş›Á_™”©Ü
->
£cÚd
;

405 
	gsigÇl_to_ş›Á_m­_
[
signum
] = 
ş›Á
;

408 
sig´ocmask
(
SIG_SETMASK
, &
Şdmask
, 
nuÎ±r
);

409  
	gŞd_ş›Á
;

412 
Stus
 
	gEnşaveSigÇlDi¥©ch”
::
D”egi¡”AÎSigÇlsFÜCl›Á
(

413 
EnşaveCl›Á
 *
ş›Á
) {

414 
sig£t_t
 
mask
, 
	gŞdmask
;

415 
sigfl£t
(&
mask
);

416 
sig´ocmask
(
SIG_SETMASK
, &
mask
, &
Şdmask
);

417 
Stus
 
	g¡©us
 = Stus::
OkStus
();

419 
	gab¦
::
Mu‹xLock
 
lock
(&
sigÇl_’şave_m­_lock_
);

422 autØ
	g™”©Ü
 = 
sigÇl_to_ş›Á_m­_
.
begš
();

423 
	g™”©Ü
 !ğ
sigÇl_to_ş›Á_m­_
.
’d
();) {

424 ià(
	g™”©Ü
->
	g£cÚd
 =ğ
ş›Á
) {

425 ià(
sigÇl
(
™”©Ü
->
fœ¡
, 
SIG_DFL
è=ğ
SIG_ERR
) {

426 
¡©us
 = 
Stus
(

427 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

428 
ab¦
::
SŒC©
(

430 
™”©Ü
->
fœ¡
));

432 autØ
	g§ved_™”©Ü
 = 
™”©Ü
;

433 ++
	g™”©Ü
;

434 
	gsigÇl_to_ş›Á_m­_
.
”a£
(
§ved_™”©Ü
);

436 ++
	g™”©Ü
;

440 
sig´ocmask
(
SIG_SETMASK
, &
Şdmask
, 
nuÎ±r
);

441  
	g¡©us
;

444 
Stus
 
	gEnşaveSigÇlDi¥©ch”
::
EÁ”EnşaveAndHªdËSigÇl
(
signum
,

445 
sigšfo_t
 *
šfo
,

446 *
ucÚ‹xt
) {

447 
EnşaveCl›Á
 *
	gş›Á
;

448 
ASYLO_ASSIGN_OR_RETURN
(
ş›Á
, 
G‘Cl›ÁFÜSigÇl
(
signum
));

449 
EnşaveSigÇl
 
	g’şave_sigÇl
;

450 
	g’şave_sigÇl
.
£t_signum
(
signum
);

451 
	g’şave_sigÇl
.
£t_code
(
šfo
->
si_code
);

452 
	g’şave_sigÇl
.
ş—r_g»gs
();

453 
ucÚ‹xt_t
 *
	guc
 = 
»š‹½»t_ÿ¡
<ucÚ‹xt_ˆ*>(
ucÚ‹xt
);

454 
	gg»g_šdex
 = 0; g»g_šdex < 
	gNGREG
; ++greg_index) {

455 
	g’şave_sigÇl
.
add_g»gs
(

456 
¡©ic_ÿ¡
<
ušt64_t
>(
uc
->
uc_mcÚ‹xt
.
g»gs
[
g»g_šdex
]));

458  
	gş›Á
->
EÁ”AndHªdËSigÇl
(
’şave_sigÇl
);

465 
__asylo_dÚ©e_th»ad
(cÚ¡ *
Çme
) {

466 autØ
mªag”_»suÉ
 = ::
asylo
::
EnşaveMªag”
::
In¡ªû
();

467 ià(!
mªag”_»suÉ
.
ok
()) {

468 
LOG
(
ERROR
è<< 
mªag”_»suÉ
.
¡©us
();

471 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”_»suÉ
.
V®ueOrD›
()->
G‘Cl›Á
(
Çme
);

472 ià(!
ş›Á
) {

476 
¡d
::
th»ad
h»ad(
asylo
::
dÚ©e
, 
ş›Á
);

477 
th»ad
.
d‘ach
();

	@platform/core/enclave_manager.cc

19 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

21 
	~<sigÇl.h
>

22 
	~<¡dšt.h
>

23 
	~<sys/ucÚ‹xt.h
>

24 
	~<time.h
>

25 
	~<th»ad
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

37 
št64_t
 
MÚÙÚicClock
() {

38 
time¥ec
 
	gts
;

39 
CHECK
(
şock_g‘time
(
CLOCK_MONOTONIC
, &
ts
) == 0)

41  
TimeS³cToNªo£cÚds
(&
ts
);

45 
št64_t
 
R—lTimeClock
() {

46 
time¥ec
 
	gts
;

47 
CHECK
(
şock_g‘time
(
CLOCK_REALTIME
, &
ts
) == 0)

49  
TimeS³cToNªo£cÚds
(&
ts
);

53 
SË•
(
št64_t
 
Çno£cÚds
) {

54 
time¥ec
 
	g»q
;

55 
Çno¦“p
(
Nªo£cÚdsToTimeS³c
(&
»q
, 
Çno£cÚds
), 
nuÎ±r
);

59 
Wa™UÁ
(
št64_t
 
d—dlše
) {

60 
št64_t
 
	gd–
;

61 (
	gd–
 = 
d—dlše
 - 
MÚÙÚicClock
()) > 0) {

62 
SË•
(
d–
);

68 
	gab¦
::
Mu‹x
 
EnşaveMªag”
::
mu_
;

69 
boŞ
 
	gEnşaveMªag”
::
cÚfigu»d_
 = 
çl£
;

70 
EnşaveMªag”O±iÚs
 *
	gEnşaveMªag”
::
İtiÚs_
 = 
nuÎ±r
;

71 
EnşaveMªag”
 *
	gEnşaveMªag”
::
š¡ªû_
 = 
nuÎ±r
;

73 
dÚ©e
(
asylo
::
EnşaveCl›Á
 *
ş›Á
) {

74 
Stus
 
¡©us
 = 
ş›Á
->
EÁ”AndDÚ©eTh»ad
();

75 ià(!
	g¡©us
.
ok
()) {

76 
LOG
(
ERROR
è<< "EÁ”AndDÚ©eTh»ad(èçed: " << 
	g¡©us
;

81 
	gEnşaveMªag”O±iÚs
::
EnşaveMªag”O±iÚs
()

82 : 
ho¡_cÚfig_šfo_
(
ab¦
::
š_¶aû_ty³_t
<
Ho¡CÚfig
>()) {}

84 
EnşaveMªag”O±iÚs
 &

85 
EnşaveMªag”O±iÚs
::
£t_cÚfig_£rv”_cÚÃùiÚ_©Œibu‹s
(

86 
¡d
::
¡ršg
 
add»ss
, 
ab¦
::
Du¿tiÚ
 
timeout
) {

87 
ho¡_cÚfig_šfo_
.
em¶aû
<
CÚfigS”v”CÚÃùiÚA‰ribu‹s
>(

88 
¡d
::
move
(
add»ss
), 
	gtimeout
);

89  *
	gthis
;

92 
	gEnşaveMªag”O±iÚs
 &EnşaveMªag”O±iÚs::
£t_ho¡_cÚfig
(

93 
Ho¡CÚfig
 
cÚfig
) {

94 
ho¡_cÚfig_šfo_
.
em¶aû
<
Ho¡CÚfig
>(
¡d
::
move
(
cÚfig
));

95  *
	gthis
;

98 
	gStusOr
<
	g¡d
::
¡ršg
> 
EnşaveMªag”O±iÚs
::
g‘_cÚfig_£rv”_add»ss
() const {

99 cÚ¡ 
CÚfigS”v”CÚÃùiÚA‰ribu‹s
 *
©Œibu‹s
 =

100 
ab¦
::
g‘_if
<
CÚfigS”v”CÚÃùiÚA‰ribu‹s
>(&
ho¡_cÚfig_šfo_
);

101 ià(!
	g©Œibu‹s
) {

102  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

105  
	g©Œibu‹s
->
	g£rv”_add»ss
;

108 
	gStusOr
<
	gab¦
::
Du¿tiÚ
>

109 
EnşaveMªag”O±iÚs
::
g‘_cÚfig_£rv”_cÚÃùiÚ_timeout
() const {

110 cÚ¡ 
CÚfigS”v”CÚÃùiÚA‰ribu‹s
 *
©Œibu‹s
 =

111 
ab¦
::
g‘_if
<
CÚfigS”v”CÚÃùiÚA‰ribu‹s
>(&
ho¡_cÚfig_šfo_
);

112 ià(!
	g©Œibu‹s
) {

113  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

116  
	g©Œibu‹s
->
	gcÚÃùiÚ_timeout
;

119 
	gStusOr
<
	gHo¡CÚfig
> 
	gEnşaveMªag”O±iÚs
::
g‘_ho¡_cÚfig
() const {

120 cÚ¡ 
Ho¡CÚfig
 *
cÚfig
 = 
ab¦
::
g‘_if
<Ho¡CÚfig>(&
ho¡_cÚfig_šfo_
);

121 ià(!
	gcÚfig
) {

122  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

125  *
	gcÚfig
;

128 
boŞ
 
	gEnşaveMªag”O±iÚs
::
hŞds_ho¡_cÚfig
() const {

129  
ab¦
::
hŞds_®‹º©ive
<
Ho¡CÚfig
>(
ho¡_cÚfig_šfo_
);

132 
Ho¡CÚfig
 
	gEnşaveMªag”
::
G‘Ho¡CÚfig
() {

133 ià(
İtiÚs_
->
hŞds_ho¡_cÚfig
()) {

134 
StusOr
<
Ho¡CÚfig
> 
cÚfig_»suÉ
 = 
İtiÚs_
->
g‘_ho¡_cÚfig
();

135 ià(!
	gcÚfig_»suÉ
.
ok
()) {

136 
LOG
(
ERROR
è<< 
	gcÚfig_»suÉ
.
¡©us
();

137  
Ho¡CÚfig
();

139  
	gcÚfig_»suÉ
.
V®ueOrD›
();

142 
Ho¡CÚfig
 
	gcÚfig
;

143 
LOG
(
ERROR
) << "Not implemented";

144  
	gcÚfig
;

147 
	gEnşaveMªag”
::
EnşaveMªag”
(è: 
ho¡_cÚfig_
(
G‘Ho¡CÚfig
()) {

148 
Stus
 
rc
 = 
sh¬ed_»sourû_mªag”_
.
Regi¡”UnmªagedResourû
(

149 
Sh¬edName
::
Add»ss
("şock_mÚÙÚic"), &
şock_mÚÙÚic_
);

150 ià(!
	grc
.
ok
()) {

151 
LOG
(
FATAL
) << "Could‚ot„egister monotonic clock„esource.";

154 
	grc
 = 
sh¬ed_»sourû_mªag”_
.
Regi¡”UnmªagedResourû
(

155 
Sh¬edName
::
Add»ss
("şock_»®time"), &
şock_»®time_
);

156 ià(!
	grc
.
ok
()) {

157 
LOG
(
FATAL
) << "Could‚ot„egister„ealtime clock„esource.";

160 
S·wnWÜk”Th»ad
();

163 
Stus
 
	gEnşaveMªag”
::
De¡royEnşave
(
EnşaveCl›Á
 *
ş›Á
,

164 cÚ¡ 
EnşaveFš®
 &
fš®_šput
,

165 
boŞ
 
sk_fš®ize
) {

166 ià(!
	gş›Á
) {

167  
	gStus
::
OkStus
();

170 
Stus
 
	gfš®ize_¡©us
;

171 ià(!
	gsk_fš®ize
) {

172 
	gfš®ize_¡©us
 = 
ş›Á
->
EÁ”AndFš®ize
(
fš®_šput
);

174 
LOG_IF
(
ERROR
, !
fš®ize_¡©us
.
ok
()è<< "Cl›Á' EÁ”AndFš®izçed: " << 
	gfš®ize_¡©us
;

176 
Stus
 
	g¡©us
 = 
ş›Á
->
De¡royEnşave
();

177 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< "Cl›Á' De¡royEnşavçed: " << 
	g¡©us
;

179 
	g¡©us
 =

180 
EnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
()->
D”egi¡”AÎSigÇlsFÜCl›Á
(

181 
ş›Á
);

182 
LOG_IF
(
ERROR
, !
¡©us
.
ok
())

183 << "D”egi¡”AÎSigÇlsFÜCl›Á faed: " << 
	g¡©us
;

185 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

186 cÚ¡‡utØ&
	gÇme
 = 
Çme_by_ş›Á_
[
ş›Á
];

187 
	gş›Á_by_Çme_
.
”a£
(
Çme
);

188 
	gÇme_by_ş›Á_
.
”a£
(
ş›Á
);

189 
	glßd”_by_ş›Á_
.
”a£
(
ş›Á
);

191  
	gfš®ize_¡©us
;

194 
EnşaveCl›Á
 *
	gEnşaveMªag”
::
G‘Cl›Á
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) const {

195 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

196 autØ
	g™
 = 
ş›Á_by_Çme_
.
fšd
(
Çme
);

197 ià(
	g™
 =ğ
ş›Á_by_Çme_
.
’d
()) {

198  
nuÎ±r
;

200  
	g™
->
	g£cÚd
.
g‘
();

204 cÚ¡ 
	g¡d
::
¡ršg
 
EnşaveMªag”
::
G‘Name
(cÚ¡ 
EnşaveCl›Á
 *
ş›Á
) const {

205 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

206 autØ
	g™
 = 
Çme_by_ş›Á_
.
fšd
(
ş›Á
);

207 ià(
	g™
 =ğ
Çme_by_ş›Á_
.
’d
()) {

210  
	g™
->
	g£cÚd
;

214 
EnşaveLßd”
 *
	gEnşaveMªag”
::
G‘Lßd”FromCl›Á
(
EnşaveCl›Á
 *
ş›Á
) {

215 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

216 ià(!
	gş›Á
 || 
	glßd”_by_ş›Á_
.
fšd
(
ş›Á
è=ğ
lßd”_by_ş›Á_
.
’d
()) {

217  
nuÎ±r
;

219  
	glßd”_by_ş›Á_
[
ş›Á
].
g‘
();

222 
Stus
 
	gEnşaveMªag”
::
CÚfigu»
(cÚ¡ 
EnşaveMªag”O±iÚs
 &
İtiÚs
) {

223 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

225 ià(
	gš¡ªû_
) {

226  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

231 
d–‘e
 
	gİtiÚs_
;

232 
	gİtiÚs_
 = 
Ãw
 
EnşaveMªag”O±iÚs
(
İtiÚs
);

233 
	gcÚfigu»d_
 = 
Œue
;

234  
	gStus
::
OkStus
();

237 
	gStusOr
<
	gEnşaveMªag”
 *> EnşaveMªag”::
In¡ªû
() {

238 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

240 ià(
	gš¡ªû_
) {

241  
	gš¡ªû_
;

244 ià(!
	gcÚfigu»d_
) {

245  
Stus
(

246 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

250 
	gš¡ªû_
 = 
Ãw
 
EnşaveMªag”
();

251 ià(!
	gš¡ªû_
) {

252  
Stus
(
”rÜ
::
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
,

256  
	gš¡ªû_
;

259 
Stus
 
	gEnşaveMªag”
::
LßdEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
,

260 cÚ¡ 
EnşaveLßd”
 &
lßd”
,

261 *
ba£_add»ss
,

262 cÚ¡ 
size_t
 
’şave_size
) {

263  
LßdEnşaveIÁ”Çl
(

264 
Çme
, 
lßd”
, 
C»©eDeçuÉEnşaveCÚfig
(
ho¡_cÚfig_
), 
ba£_add»ss
,

265 
’şave_size
);

268 
Stus
 
	gEnşaveMªag”
::
LßdEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
,

269 cÚ¡ 
EnşaveLßd”
 &
lßd”
,

270 
EnşaveCÚfig
 
cÚfig
, *
ba£_add»ss
,

271 cÚ¡ 
size_t
 
’şave_size
) {

272 
EnşaveCÚfig
 
	g§n™ized_cÚfig
 = 
¡d
::
move
(
cÚfig
);

273 
S‘EnşaveCÚfigDeçuÉs
(
ho¡_cÚfig_
, &
§n™ized_cÚfig
);

274  
LßdEnşaveIÁ”Çl
(
Çme
, 
lßd”
, 
§n™ized_cÚfig
, 
ba£_add»ss
,

275 
’şave_size
);

278 
Stus
 
	gEnşaveMªag”
::
LßdEnşaveIÁ”Çl
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
,

279 cÚ¡ 
EnşaveLßd”
 &
lßd”
,

280 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
,

281 *
ba£_add»ss
,

282 cÚ¡ 
size_t
 
’şave_size
) {

283 ià(
	gcÚfig
.
’abË_fÜk
(è&& 
	gba£_add»ss
) {

287 
RemoveEnşaveReã»nû
(
Çme
);

291 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

292 ià(
	gş›Á_by_Çme_
.
fšd
(
Çme
è!ğ
ş›Á_by_Çme_
.
’d
()) {

297 
ş›Á_by_Çme_
.
”a£
(
Çme
);

302 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
»suÉ
 =

303 
lßd”
.
LßdEnşave
(
Çme
, 
ba£_add»ss
, 
’şave_size
, 
cÚfig
);

304 ià(!
	g»suÉ
.
ok
()) {

305 
LOG
(
ERROR
è<< "LßdEnşavçed: " << 
	g»suÉ
.
¡©us
();

306  
	g»suÉ
.
¡©us
();

310 
EnşaveCl›Á
 *
	gş›Á
 = 
»suÉ
.
V®ueOrD›
().
g‘
();

312 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

313 
	gş›Á_by_Çme_
.
em¶aû
(
Çme
, 
¡d
::
move
(
»suÉ
).
V®ueOrD›
());

314 
	gÇme_by_ş›Á_
.
em¶aû
(
ş›Á
, 
Çme
);

316 ià(
	gcÚfig
.
’abË_fÜk
()) {

317 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
lßd”_»suÉ
 = 
lßd”
.
Cİy
();

318 ià(!
	glßd”_»suÉ
.
ok
()) {

319  
	glßd”_»suÉ
.
¡©us
();

321 
	glßd”_by_ş›Á_
.
em¶aû
(
ş›Á
, 
¡d
::
move
(
lßd”_»suÉ
.
V®ueOrD›
()));

325 
Stus
 
	g¡©us
 = 
ş›Á
->
EÁ”AndIn™Ÿlize
(
cÚfig
);

328 ià(!
	g¡©us
.
ok
()) {

329 
Stus
 
	gde¡roy_¡©us
 = 
ş›Á
->
De¡royEnşave
();

330 ià(!
	gde¡roy_¡©us
.
ok
()) {

331 
LOG
(
ERROR
) << "DestroyEnclave failed‡fter EnterAndInitialize failure: "

332 << 
	gde¡roy_¡©us
;

335 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

336 
	gş›Á_by_Çme_
.
”a£
(
Çme
);

337 
	gÇme_by_ş›Á_
.
”a£
(
ş›Á
);

338 
	glßd”_by_ş›Á_
.
”a£
(
ş›Á
);

341  
	g¡©us
;

344 
	gEnşaveMªag”
::
RemoveEnşaveReã»nû
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

345 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
ş›Á_bË_lock_
);

346 
EnşaveCl›Á
 *
	gş›Á
 = 
ş›Á_by_Çme_
[
Çme
].
g‘
();

347 
	gş›Á_by_Çme_
.
”a£
(
Çme
);

348 
	gÇme_by_ş›Á_
.
”a£
(
ş›Á
);

351 
	gEnşaveMªag”
::
S·wnWÜk”Th»ad
() {

354 
Tick
();

355 
	g¡d
::
th»ad
 
wÜk”
([
this
] { 
WÜk”Loİ
(); });

356 
	gwÜk”
.
d‘ach
();

359 
	gEnşaveMªag”
::
Tick
() {

360 
şock_mÚÙÚic_
 = 
MÚÙÚicClock
();

361 
	gşock_»®time_
 = 
R—lTimeClock
();

364 
	gEnşaveMªag”
::
WÜk”Loİ
() {

366 
cÚ¡ex´
 
št64_t
 
kClockP”iod
 = 
INT64_C
(70000);

367 
št64_t
 
	gÃxt_tick
 = 
MÚÙÚicClock
();

368 
	gŒue
) {

369 
Wa™UÁ
(
Ãxt_tick
);

370 
Tick
();

371 
	gÃxt_tick
 +ğ
kClockP”iod
;

375 
EnşaveSigÇlDi¥©ch”
 *
	gEnşaveSigÇlDi¥©ch”
::
G‘In¡ªû
() {

376 
EnşaveSigÇlDi¥©ch”
 *
š¡ªû
 = 
Ãw
 EnclaveSignalDispatcher();

377  
	gš¡ªû
;

380 
	gStusOr
<
	gEnşaveCl›Á
 *> 
	gEnşaveSigÇlDi¥©ch”
::
G‘Cl›ÁFÜSigÇl
(

381 
signum
) const {

382 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_’şave_m­_lock_
);

383 autØ
	g™
 = 
sigÇl_to_ş›Á_m­_
.
fšd
(
signum
);

384 ià(
	g™
 =ğ
sigÇl_to_ş›Á_m­_
.
’d
()) {

385  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

386 
ab¦
::
SŒC©
("NØ’şavha »gi¡”ed sigÇl: ", 
signum
));

388  
	g™
->
	g£cÚd
;

391 cÚ¡ 
EnşaveCl›Á
 *
	gEnşaveSigÇlDi¥©ch”
::
Regi¡”SigÇl
(

392 
signum
, 
EnşaveCl›Á
 *
ş›Á
) {

394 
sig£t_t
 
	gmask
, 
	gŞdmask
;

395 
sigfl£t
(&
mask
);

396 
sig´ocmask
(
SIG_SETMASK
, &
mask
, &
Şdmask
);

397 
EnşaveCl›Á
 *
	gŞd_ş›Á
 = 
nuÎ±r
;

399 
	gab¦
::
Mu‹xLock
 
lock
(&
sigÇl_’şave_m­_lock_
);

401 autØ
	gş›Á_™”©Ü
 = 
sigÇl_to_ş›Á_m­_
.
fšd
(
signum
);

402 ià(
	gş›Á_™”©Ü
 !ğ
sigÇl_to_ş›Á_m­_
.
’d
()) {

403 
Şd_ş›Á
 = 
ş›Á_™”©Ü
->
£cÚd
;

405 
	gsigÇl_to_ş›Á_m­_
[
signum
] = 
ş›Á
;

408 
sig´ocmask
(
SIG_SETMASK
, &
Şdmask
, 
nuÎ±r
);

409  
	gŞd_ş›Á
;

412 
Stus
 
	gEnşaveSigÇlDi¥©ch”
::
D”egi¡”AÎSigÇlsFÜCl›Á
(

413 
EnşaveCl›Á
 *
ş›Á
) {

414 
sig£t_t
 
mask
, 
	gŞdmask
;

415 
sigfl£t
(&
mask
);

416 
sig´ocmask
(
SIG_SETMASK
, &
mask
, &
Şdmask
);

417 
Stus
 
	g¡©us
 = Stus::
OkStus
();

419 
	gab¦
::
Mu‹xLock
 
lock
(&
sigÇl_’şave_m­_lock_
);

422 autØ
	g™”©Ü
 = 
sigÇl_to_ş›Á_m­_
.
begš
();

423 
	g™”©Ü
 !ğ
sigÇl_to_ş›Á_m­_
.
’d
();) {

424 ià(
	g™”©Ü
->
	g£cÚd
 =ğ
ş›Á
) {

425 ià(
sigÇl
(
™”©Ü
->
fœ¡
, 
SIG_DFL
è=ğ
SIG_ERR
) {

426 
¡©us
 = 
Stus
(

427 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

428 
ab¦
::
SŒC©
(

430 
™”©Ü
->
fœ¡
));

432 autØ
	g§ved_™”©Ü
 = 
™”©Ü
;

433 ++
	g™”©Ü
;

434 
	gsigÇl_to_ş›Á_m­_
.
”a£
(
§ved_™”©Ü
);

436 ++
	g™”©Ü
;

440 
sig´ocmask
(
SIG_SETMASK
, &
Şdmask
, 
nuÎ±r
);

441  
	g¡©us
;

444 
Stus
 
	gEnşaveSigÇlDi¥©ch”
::
EÁ”EnşaveAndHªdËSigÇl
(
signum
,

445 
sigšfo_t
 *
šfo
,

446 *
ucÚ‹xt
) {

447 
EnşaveCl›Á
 *
	gş›Á
;

448 
ASYLO_ASSIGN_OR_RETURN
(
ş›Á
, 
G‘Cl›ÁFÜSigÇl
(
signum
));

449 
EnşaveSigÇl
 
	g’şave_sigÇl
;

450 
	g’şave_sigÇl
.
£t_signum
(
signum
);

451 
	g’şave_sigÇl
.
£t_code
(
šfo
->
si_code
);

452 
	g’şave_sigÇl
.
ş—r_g»gs
();

453 
ucÚ‹xt_t
 *
	guc
 = 
»š‹½»t_ÿ¡
<ucÚ‹xt_ˆ*>(
ucÚ‹xt
);

454 
	gg»g_šdex
 = 0; g»g_šdex < 
	gNGREG
; ++greg_index) {

455 
	g’şave_sigÇl
.
add_g»gs
(

456 
¡©ic_ÿ¡
<
ušt64_t
>(
uc
->
uc_mcÚ‹xt
.
g»gs
[
g»g_šdex
]));

458  
	gş›Á
->
EÁ”AndHªdËSigÇl
(
’şave_sigÇl
);

465 
__asylo_dÚ©e_th»ad
(cÚ¡ *
Çme
) {

466 autØ
mªag”_»suÉ
 = ::
asylo
::
EnşaveMªag”
::
In¡ªû
();

467 ià(!
mªag”_»suÉ
.
ok
()) {

468 
LOG
(
ERROR
è<< 
mªag”_»suÉ
.
¡©us
();

471 
asylo
::
EnşaveCl›Á
 *
ş›Á
 = 
mªag”_»suÉ
.
V®ueOrD›
()->
G‘Cl›Á
(
Çme
);

472 ià(!
ş›Á
) {

476 
¡d
::
th»ad
h»ad(
asylo
::
dÚ©e
, 
ş›Á
);

477 
th»ad
.
d‘ach
();

	@platform/core/enclave_manager.h

19 #iâdeà
ASYLO_PLATFORM_CORE_ENCLAVE_MANAGER_H_


20 
	#ASYLO_PLATFORM_CORE_ENCLAVE_MANAGER_H_


	)

25 
	~<¡ršg
>

26 
	~<ut™y
>

28 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

29 
	~"ab¦/memÜy/memÜy.h
"

30 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

31 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

32 
	~"ab¦/time/time.h
"

33 
	~"ab¦/ty³s/v¬ŸÁ.h
"

34 
	~"asylo/’şave.pb.h
"

35 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

36 
	~"asylo/¶©fÜm/cÜe/’şave_ş›Á.h
"

37 
	~"asylo/¶©fÜm/cÜe/’şave_cÚfig_ut.h
"

38 
	~"asylo/¶©fÜm/cÜe/sh¬ed_»sourû_mªag”.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©usÜ.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
şass
 
	gEnşaveLßd”
;

46 şas 
	cEnşaveMªag”O±iÚs
 {

47 
	gpublic
:

64 
	sCÚfigS”v”CÚÃùiÚA‰ribu‹s
 {

65 
CÚfigS”v”CÚÃùiÚA‰ribu‹s
(
¡d
::
¡ršg
 
add»ss
,

66 
ab¦
::
Du¿tiÚ
 
timeout
)

67 : 
£rv”_add»ss
(
¡d
::
move
(
add»ss
)),

68 
cÚÃùiÚ_timeout
(
¡d
::
move
(
timeout
)) {}

70 
¡d
::
¡ršg
 
£rv”_add»ss
;

71 
	gab¦
::
Du¿tiÚ
 
cÚÃùiÚ_timeout
;

75 
EnşaveMªag”O±iÚs
();

83 
	gEnşaveMªag”O±iÚs
 &
£t_cÚfig_£rv”_cÚÃùiÚ_©Œibu‹s
(

84 
¡d
::
¡ršg
 
add»ss
, 
ab¦
::
Du¿tiÚ
 
timeout
);

89 
	gEnşaveMªag”O±iÚs
 &
£t_ho¡_cÚfig
(
Ho¡CÚfig
 
cÚfig
);

96 
	gStusOr
<
	g¡d
::
¡ršg
> 
g‘_cÚfig_£rv”_add»ss
() const;

103 
	gStusOr
<
	gab¦
::
Du¿tiÚ
> 
g‘_cÚfig_£rv”_cÚÃùiÚ_timeout
() const;

109 
	gStusOr
<
	gHo¡CÚfig
> 
g‘_ho¡_cÚfig
() const;

112 
boŞ
 
hŞds_ho¡_cÚfig
() const;

114 
	g´iv©e
:

117 
ab¦
::
v¬ŸÁ
<
CÚfigS”v”CÚÃùiÚA‰ribu‹s
, 
	gHo¡CÚfig
> 
	gho¡_cÚfig_šfo_
;

154 şas 
	cEnşaveMªag”
 {

155 
	gpublic
:

160 
StusOr
<
EnşaveMªag”
 *> 
In¡ªû
();

166 
Stus
 
CÚfigu»
(cÚ¡ 
EnşaveMªag”O±iÚs
 &
İtiÚs
);

186 
Stus
 
LßdEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ 
EnşaveLßd”
 &
lßd”
,

187 *
ba£_add»ss
 = 
nuÎ±r
,

188 cÚ¡ 
size_t
 
’şave_size
 = 0);

212 
Stus
 
LßdEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
, cÚ¡ 
EnşaveLßd”
 &
lßd”
,

213 
EnşaveCÚfig
 
cÚfig
, *
ba£_add»ss
 = 
nuÎ±r
,

214 cÚ¡ 
size_t
 
’şave_size
 = 0);

222 
EnşaveCl›Á
 *
G‘Cl›Á
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) const

223 
LOCKS_EXCLUDED
(
ş›Á_bË_lock_
);

231 cÚ¡ 
	g¡d
::
¡ršg
 
G‘Name
(cÚ¡ 
EnşaveCl›Á
 *
ş›Á
) const

232 
LOCKS_EXCLUDED
(
ş›Á_bË_lock_
);

250 
Stus
 
De¡royEnşave
(
EnşaveCl›Á
 *
ş›Á
, cÚ¡ 
EnşaveFš®
 &
fš®_šput
,

251 
boŞ
 
sk_fš®ize
 = 
çl£
)

252 
LOCKS_EXCLUDED
(
ş›Á_bË_lock_
);

257 
Sh¬edResourûMªag”
 *
sh¬ed_»sourûs
() {

258  &
	gsh¬ed_»sourû_mªag”_
;

264 cÚ¡ 
Sh¬edResourûMªag”
 *
sh¬ed_»sourûs
() const {

265  &
	gsh¬ed_»sourû_mªag”_
;

270 
EnşaveLßd”
 *
G‘Lßd”FromCl›Á
(
EnşaveCl›Á
 *
ş›Á
)

271 
LOCKS_EXCLUDED
(
ş›Á_bË_lock_
);

273 
	g´iv©e
:

274 
EnşaveMªag”
(è
EXCLUSIVE_LOCKS_REQUIRED
(
mu_
);

275 
EnşaveMªag”
(EnşaveMªag” cÚ¡ &èğ
d–‘e
;

276 
	gEnşaveMªag”
 &
	gİ”©Ü
=(
EnşaveMªag”
 cÚ¡ &èğ
d–‘e
;

281 
Ho¡CÚfig
 
G‘Ho¡CÚfig
(è
EXCLUSIVE_LOCKS_REQUIRED
(
mu_
);

286 
Stus
 
LßdEnşaveIÁ”Çl
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
,

287 cÚ¡ 
EnşaveLßd”
 &
lßd”
,

288 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
,

289 *
ba£_add»ss
 = 
nuÎ±r
,

290 cÚ¡ 
size_t
 
’şave_size
 = 0)

291 
LOCKS_EXCLUDED
(
ş›Á_bË_lock_
);

295 
RemoveEnşaveReã»nû
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
)

296 
LOCKS_EXCLUDED
(
ş›Á_bË_lock_
);

299 
S·wnWÜk”Th»ad
();

302 
WÜk”Loİ
();

305 
Tick
();

308 
Sh¬edResourûMªag”
 
	gsh¬ed_»sourû_mªag”_
;

311 
	g¡d
::
©omic
<
št64_t
> 
şock_mÚÙÚic_
;

314 
	g¡d
::
©omic
<
št64_t
> 
şock_»®time_
;

318 
mubË
 
	gab¦
::
Mu‹x
 
ş›Á_bË_lock_
;

320 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	g¡d
::
unique_±r
<
EnşaveCl›Á
>>

321 
ş›Á_by_Çme_
 
GUARDED_BY
(
ş›Á_bË_lock_
);

322 
	gab¦
::
æ©_hash_m­
<cÚ¡ 
EnşaveCl›Á
 *, 
	g¡d
::
¡ršg
> 
Çme_by_ş›Á_


323 
GUARDED_BY
(
ş›Á_bË_lock_
);

325 
	gab¦
::
æ©_hash_m­
<cÚ¡ 
EnşaveCl›Á
 *, 
	g¡d
::
unique_±r
<
EnşaveLßd”
>>

326 
lßd”_by_ş›Á_
 
GUARDED_BY
(
ş›Á_bË_lock_
);

330 
Ho¡CÚfig
 
	gho¡_cÚfig_
;

333 
	gab¦
::
Mu‹x
 
mu_
;

337 
boŞ
 
cÚfigu»d_
 
GUARDED_BY
(
mu_
);

340 
EnşaveMªag”O±iÚs
 *
İtiÚs_
 
GUARDED_BY
(
mu_
);

343 
EnşaveMªag”
 *
š¡ªû_
 
GUARDED_BY
(
mu_
);

350 şas 
	cEnşaveLßd”
 {

351 
	gpublic
:

352 
vœtu®
 ~
EnşaveLßd”
() = ;

354 
	g´Ùeùed
:

356 
ä›nd
 
şass
 
EnşaveMªag”
;

360 
vœtu®
 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

361 cÚ¡ 
¡d
::
¡ršg
 &
Çme
) const {

362 
EnşaveCÚfig
 
cÚfig
;

363  
LßdEnşave
(
Çme
, 
nuÎ±r
, 0,

364 
cÚfig
);

369 
vœtu®
 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

370 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

371 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) const = 0;

375 
vœtu®
 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
() const = 0;

380 şas 
	cEnşaveSigÇlDi¥©ch”
 {

381 
	gpublic
:

382 
EnşaveSigÇlDi¥©ch”
 *
G‘In¡ªû
();

390 cÚ¡ 
EnşaveCl›Á
 *
Regi¡”SigÇl
(
signum
, EnşaveCl›Á *
ş›Á
)

391 
LOCKS_EXCLUDED
(
sigÇl_’şave_m­_lock_
);

394 
	gStusOr
<
	gEnşaveCl›Á
 *> 
G‘Cl›ÁFÜSigÇl
(
signum
) const

395 
LOCKS_EXCLUDED
(
sigÇl_’şave_m­_lock_
);

398 
Stus
 
D”egi¡”AÎSigÇlsFÜCl›Á
(
EnşaveCl›Á
 *
ş›Á
)

399 
LOCKS_EXCLUDED
(
sigÇl_’şave_m­_lock_
);

404 
Stus
 
EÁ”EnşaveAndHªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
,

405 *
ucÚ‹xt
);

407 
	g´iv©e
:

408 
EnşaveSigÇlDi¥©ch”
() = ;

409 
EnşaveSigÇlDi¥©ch”
(EnşaveSigÇlDi¥©ch” cÚ¡ &èğ
d–‘e
;

410 
	gİ”©Ü
=(
EnşaveSigÇlDi¥©ch”
 cÚ¡ &èğ
d–‘e
;

413 
	gab¦
::
æ©_hash_m­
<, 
	gEnşaveCl›Á
 *> 
sigÇl_to_ş›Á_m­_


414 
GUARDED_BY
(
sigÇl_’şave_m­_lock_
);

417 
mubË
 
	gab¦
::
Mu‹x
 
sigÇl_’şave_m­_lock_
;

	@platform/core/entry_points.h

19 #iâdeà
ASYLO_PLATFORM_CORE_ENTRY_POINTS_H_


20 
	#ASYLO_PLATFORM_CORE_ENTRY_POINTS_H_


	)

22 
	~<uni¡d.h
>

24 
Çme¥aû
 
	gasylo
 {

26 #ifdeà
__ılu¥lus


48 
__asylo_u£r_š™
(cÚ¡ *
Çme
, cÚ¡ *
cÚfig
, 
size_t
 
cÚfig_Ën
,

49 **
ouut
, 
size_t
 *
ouut_Ën
);

55 
__asylo_u£r_run
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

56 
size_t
 *
ouut_Ën
);

62 
__asylo_u£r_fši
(cÚ¡ *
fš®_šput
, 
size_t
 
Ën
, **
ouut
,

63 
size_t
 *
ouut_Ën
);

66 
__asylo_th»adšg_dÚ©e
();

71 
__asylo_hªdË_sigÇl
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
);

76 
__asylo_ke_¢­shÙ
(**
ouut
, 
size_t
 *
ouut_Ën
);

82 
__asylo_»¡Üe
(cÚ¡ *
¢­shÙ_Ïyout
, 
size_t
 
¢­shÙ_Ïyout_Ën
,

83 **
ouut
, 
size_t
 *
ouut_Ën
);

89 
__asylo_Œªsãr_£cu»_¢­shÙ_key
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

90 **
ouut
, 
size_t
 *
ouut_Ën
);

92 #ifdeà
__ılu¥lus


	@platform/core/fake_trusted_global_state.cc

19 
	~"ab¦/ba£/©Œibu‹s.h
"

20 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

22 #ifdeà
__ASYLO__


26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

35 
ABSL_CONST_INIT
 
th»ad_loÿl
 
	g¡d
::
¡ršg
 *
’şave_Çme
 = 
nuÎ±r
;

39 
ABSL_CONST_INIT
 
th»ad_loÿl
 
	gasylo
::
EnşaveCÚfig
 *
’şave_cÚfig
 = 
nuÎ±r
;

43 
S‘EnşaveName
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

44 
d–‘e
 
’şave_Çme
;

45 
	g’şave_Çme
 = 
Ãw
 
¡d
::
¡ršg
(
Çme
);

48 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveName
(è{  *
’şave_Çme
; }

50 
Stus
 
S‘EnşaveCÚfig
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

55 
d–‘e
 
	g’şave_cÚfig
;

56 
	g’şave_cÚfig
 = 
Ãw
 
EnşaveCÚfig
(
cÚfig
);

57  
	gStus
::
OkStus
();

60 
	gStusOr
<cÚ¡ 
	gEnşaveCÚfig
 *> 
G‘EnşaveCÚfig
() {

61 ià(!
	g’şave_cÚfig
) {

62  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

66  
	g’şave_cÚfig
;

	@platform/core/fake_trusted_global_state.cc

19 
	~"ab¦/ba£/©Œibu‹s.h
"

20 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

22 #ifdeà
__ASYLO__


26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

35 
ABSL_CONST_INIT
 
th»ad_loÿl
 
	g¡d
::
¡ršg
 *
’şave_Çme
 = 
nuÎ±r
;

39 
ABSL_CONST_INIT
 
th»ad_loÿl
 
	gasylo
::
EnşaveCÚfig
 *
’şave_cÚfig
 = 
nuÎ±r
;

43 
S‘EnşaveName
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

44 
d–‘e
 
’şave_Çme
;

45 
	g’şave_Çme
 = 
Ãw
 
¡d
::
¡ršg
(
Çme
);

48 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveName
(è{  *
’şave_Çme
; }

50 
Stus
 
S‘EnşaveCÚfig
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

55 
d–‘e
 
	g’şave_cÚfig
;

56 
	g’şave_cÚfig
 = 
Ãw
 
EnşaveCÚfig
(
cÚfig
);

57  
	gStus
::
OkStus
();

60 
	gStusOr
<cÚ¡ 
	gEnşaveCÚfig
 *> 
G‘EnşaveCÚfig
() {

61 ià(!
	g’şave_cÚfig
) {

62  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

66  
	g’şave_cÚfig
;

	@platform/core/shared_name.h

19 #iâdeà
ASYLO_PLATFORM_CORE_SHARED_NAME_H_


20 
	#ASYLO_PLATFORM_CORE_SHARED_NAME_H_


	)

22 
	~<c¡dlib
>

23 
	~<funùiÚ®
>

24 
	~<io¡»am
>

25 
	~<¡ršg
>

27 
	~"asylo/¶©fÜm/commÚ/hash_combše.h
"

28 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme_kšd.h
"

30 
Çme¥aû
 
	gasylo
 {

36 şas 
	cSh¬edName
 {

37 
	gpublic
:

39 
Sh¬edName
() = ;

45 
Sh¬edName
(
Sh¬edNameKšd
 
kšd
, cÚ¡ 
¡d
::
¡ršg
 &
Çme
)

46 : 
kšd_
(
kšd
), 
Çme_
(
Çme
) {}

51 
Sh¬edNameKšd
 
kšd
(ècÚ¡ {  
	gkšd_
; }

56 cÚ¡ 
	g¡d
::
¡ršg
 &
Çme
(ècÚ¡ {  
Çme_
; }

59 
Sh¬edName
 
Add»ss
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

60  
Sh¬edName
(
kAdd»ssName
, 
Çme
);

64 
Sh¬edName
 
MemBlock
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

65  
Sh¬edName
(
kMemBlockName
, 
Çme
);

69 
Sh¬edName
 
Sock‘
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

70  
Sh¬edName
(
kSock‘Name
, 
Çme
);

74 
Sh¬edName
 
Tim”
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

75  
Sh¬edName
(
kTim”Name
, 
Çme
);

78 
	gHash
 : 
¡d
::
uÇry_funùiÚ
<
Sh¬edName
, 
	gsize_t
> {

79 
size_t
 
İ”©Ü
()(cÚ¡ 
	gSh¬edName
 &
	gÇme
) const {

80  
	gHashCombše
<
	g¡d
::
¡ršg
>(
¡d
::
hash
<>()(
Çme
.
kšd_
), 
	gÇme
.
	gÇme_
);

84 
	gEq
 : 
¡d
::
bš¬y_funùiÚ
<
Sh¬edName
, 
	gSh¬edName
, 
	gboŞ
> {

85 
boŞ
 
İ”©Ü
()(cÚ¡ 
	gSh¬edName
 &
	glhs
, cÚ¡ Sh¬edNam&
	grhs
) const {

86  (
	glhs
.
	gkšd_
 =ğ
rhs
.
kšd_
è&& (
lhs
.
Çme_
 ==„hs.name_);

90 
	g´iv©e
:

91 
Sh¬edNameKšd
 
kšd_
;

92 
	g¡d
::
¡ršg
 
Çme_
;

95 
šlše
 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
os
, cÚ¡ 
	gSh¬edName
 &
	gÇme
) {

96 
	gÇme
.
kšd
()) {

97 
	gkUn¥ecif›dName
:

98 
os
 << "kUnspecifiedName";

100 
	gkAdd»ssName
:

101 
os
 << "kAddressName";

103 
	gkSock‘Name
:

104 
os
 << "kSocketName";

106 
	gkTim”Name
:

107 
os
 << "kTimerName";

109 
	gkMemBlockName
:

110 
os
 << "kMemBlockName";

113 
abÜt
();

115  
	gos
 << "::" << 
	gÇme
.
Çme
();

	@platform/core/shared_name_kind.h

19 #iâdeà
ASYLO_PLATFORM_CORE_SHARED_NAME_KIND_H_


20 
	#ASYLO_PLATFORM_CORE_SHARED_NAME_KIND_H_


	)

22 #ifdeà
__ılu¥lus


27 
	eSh¬edNameKšd
 {

30 
kUn¥ecif›dName
 = 0,

33 
kAdd»ssName
,

36 
kSock‘Name
,

39 
kTim”Name
,

42 
kMemBlockName
,

45 #ifdeà
__ılu¥lus


	@platform/core/shared_resource_manager.cc

19 
	~"asylo/¶©fÜm/cÜe/sh¬ed_»sourû_mªag”.h
"

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
Stus
 
	gSh¬edResourûMªag”
::
In¡®lResourû
(
ResourûHªdË
 *
hªdË
) {

28 
mu_
.
As£¹H–d
();

29 autØ
	g™
 = 
sh¬ed_»sourûs_
.
fšd
(
hªdË
->
»sourû_Çme
);

30 ià(
	g™
 !ğ
sh¬ed_»sourûs_
.
’d
()) {

33 
¡d
::
¡ršg
 
Çme
 = 
hªdË
->
»sourû_Çme
.name();

34 
	ghªdË
->
»Ëa£
();

35 
d–‘e
 
	ghªdË
;

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
,

37 
ab¦
::
SŒC©
("CªnÙ in¡®È»sourû \"", 
Çme
,

40 
	gsh¬ed_»sourûs_
[
hªdË
->
»sourû_Çme
] = 
ab¦
::
W¿pUnique
(handle);

41  
	gStus
::
OkStus
();

44 
boŞ
 
	gSh¬edResourûMªag”
::
R–—£Resourû
(cÚ¡ 
Sh¬edName
 &
Çme
) {

45 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

46 autØ
	g™
 = 
sh¬ed_»sourûs_
.
fšd
(
Çme
);

47 ià(
	g™
 =ğ
sh¬ed_»sourûs_
.
’d
()) {

48  
çl£
;

50 
	g™
->
	g£cÚd
->
	g»ã»nû_couÁ
--;

51 ià(
	g™
->
	g£cÚd
->
	g»ã»nû_couÁ
 == 0) {

52 
sh¬ed_»sourûs_
.
”a£
(
™
);

54  
	gŒue
;

	@platform/core/shared_resource_manager.cc

19 
	~"asylo/¶©fÜm/cÜe/sh¬ed_»sourû_mªag”.h
"

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
Stus
 
	gSh¬edResourûMªag”
::
In¡®lResourû
(
ResourûHªdË
 *
hªdË
) {

28 
mu_
.
As£¹H–d
();

29 autØ
	g™
 = 
sh¬ed_»sourûs_
.
fšd
(
hªdË
->
»sourû_Çme
);

30 ià(
	g™
 !ğ
sh¬ed_»sourûs_
.
’d
()) {

33 
¡d
::
¡ršg
 
Çme
 = 
hªdË
->
»sourû_Çme
.name();

34 
	ghªdË
->
»Ëa£
();

35 
d–‘e
 
	ghªdË
;

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
,

37 
ab¦
::
SŒC©
("CªnÙ in¡®È»sourû \"", 
Çme
,

40 
	gsh¬ed_»sourûs_
[
hªdË
->
»sourû_Çme
] = 
ab¦
::
W¿pUnique
(handle);

41  
	gStus
::
OkStus
();

44 
boŞ
 
	gSh¬edResourûMªag”
::
R–—£Resourû
(cÚ¡ 
Sh¬edName
 &
Çme
) {

45 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

46 autØ
	g™
 = 
sh¬ed_»sourûs_
.
fšd
(
Çme
);

47 ià(
	g™
 =ğ
sh¬ed_»sourûs_
.
’d
()) {

48  
çl£
;

50 
	g™
->
	g£cÚd
->
	g»ã»nû_couÁ
--;

51 ià(
	g™
->
	g£cÚd
->
	g»ã»nû_couÁ
 == 0) {

52 
sh¬ed_»sourûs_
.
”a£
(
™
);

54  
	gŒue
;

	@platform/core/shared_resource_manager.h

19 #iâdeà
ASYLO_PLATFORM_CORE_SHARED_RESOURCE_MANAGER_H_


20 
	#ASYLO_PLATFORM_CORE_SHARED_RESOURCE_MANAGER_H_


	)

22 
	~<memÜy
>

24 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

25 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

26 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

35 şas 
	cSh¬edResourûMªag”
 {

36 
	gpublic
:

54 
‹m¶©e
 <
ty³Çme
 
T
,y³Çm
	gD–‘”
 = 
¡d
::
deçuÉ_d–‘e
<T>>

55 
Stus
 
Regi¡”MªagedResourû
(cÚ¡ 
Sh¬edName
 &
Çme
, 
T
 *
poš‹r
) {

56 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

57 autØ*
	g»sourû
 = 
Ãw
 
MªagedResourû
<
T
, 
	gD–‘”
>(
	gÇme
, 
	gpoš‹r
);

58  
In¡®lResourû
(
»sourû
);

70 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

71 
Stus
 
Regi¡”UnmªagedResourû
(cÚ¡ 
Sh¬edName
 &
Çme
, 
T
 *
poš‹r
) {

72 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

73 autØ*
	g»sourû
 = 
Ãw
 
UnmªagedResourû
<
T
>(
Çme
, 
	gpoš‹r
);

74  
In¡®lResourû
(
»sourû
);

82 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

83 
T
 *
AcquœeResourû
(cÚ¡ 
Sh¬edName
 &
Çme
) {

84 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

85 autØ
	g™
 = 
sh¬ed_»sourûs_
.
fšd
(
Çme
);

86 ià(
	g™
 =ğ
sh¬ed_»sourûs_
.
’d
()) {

87  
nuÎ±r
;

89 
	g™
->
	g£cÚd
->
	g»ã»nû_couÁ
++;

90  
	g¡©ic_ÿ¡
<
	gT
 *>(
	g™
->
	g£cÚd
->
g‘
());

99 
boŞ
 
R–—£Resourû
(cÚ¡ 
Sh¬edName
 &
Çme
);

101 
	g´iv©e
:

105 
	sResourûHªdË
 {

106 
ResourûHªdË
(cÚ¡ 
Sh¬edName
 &
Çme
)

107 : 
»sourû_Çme
(
Çme
), 
»ã»nû_couÁ
(1) {}

108 
	gvœtu®
 ~
ResourûHªdË
() = ;

111 
vœtu®
 *
g‘
() = 0;

115 
vœtu®
 
»Ëa£
() = 0;

117 
Sh¬edName
 
	g»sourû_Çme
;

118 
	g»ã»nû_couÁ
;

122 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gD–‘”
>

123 
	gMªagedResourû
 : 
public
 
ResourûHªdË
 {

124 
MªagedResourû
(cÚ¡ 
Sh¬edName
 &
Çme
, 
T
 *
poš‹r
)

125 : 
ResourûHªdË
(
Çme
), 
»sourû
(
poš‹r
) {}

126 *
g‘
(è
	gov”ride
 {  
	g¡©ic_ÿ¡
<*>(
	g»sourû
.get()); }

127 
»Ëa£
(è
	gov”ride
 { 
	g»sourû
.release(); }

128 
	g¡d
::
unique_±r
<
T
, 
	gD–‘”
> 
	g»sourû
;

132 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

133 
	gUnmªagedResourû
 : 
public
 
ResourûHªdË
 {

134 
UnmªagedResourû
(cÚ¡ 
Sh¬edName
 &
Çme
, 
T
 *
poš‹r
)

135 : 
ResourûHªdË
(
Çme
), 
»sourû
(
poš‹r
) {}

136 *
g‘
(è
	gov”ride
 {  
	g¡©ic_ÿ¡
<*>(
	g»sourû
); }

137 
»Ëa£
(è
	gov”ride
 {}

138 
T
 *
	g»sourû
;

143 
Stus
 
In¡®lResourû
(
ResourûHªdË
 *
hªdË
è
EXCLUSIVE_LOCKS_REQUIRED
(
mu_
);

145 
	gab¦
::
Mu‹x
 
mu_
;

146 
	gab¦
::
æ©_hash_m­
<
Sh¬edName
, 
	g¡d
::
unique_±r
<
ResourûHªdË
>,

147 
	gSh¬edName
::
Hash
, Sh¬edName::
Eq
>

148 
sh¬ed_»sourûs_
;

	@platform/core/test/enclave_api_test_driver.cc

19 
	~<¡ršg
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

35 şas 
	cCl›ÁApiTe¡
 : 
public
 
EnşaveTe¡
 {};

37 
TEST_F
(
Cl›ÁApiTe¡
, 
IÅutOuutTe¡
) {

38 
EnşaveIÅut
 
	g’şave_šput
;

39 
EnşaveApiTe¡
 *
	gšput_‹¡
 =

40 
’şave_šput
.
MubËEx‹nsiÚ
(
’şave_­i_‹¡_šput
);

41 
	gšput_‹¡
->
£t_‹¡_¡ršg
("test string");

42 
	gšput_‹¡
->
£t_‹¡_št
(1);

43 
	gšput_‹¡
->
add_‹¡_»³©ed
("test„epeated 1");

44 
	gšput_‹¡
->
add_‹¡_»³©ed
("test„epeated 2");

45 
EnşaveOuut
 
	g’şave_ouut
;

46 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
);

47 
EXPECT_THAT
(
¡©us
, 
IsOk
());

49 
ASSERT_TRUE
(
’şave_ouut
.
HasEx‹nsiÚ
(
’şave_­i_‹¡_ouut
));

50 
EnşaveApiTe¡
 
	gouut_‹¡
 =

51 
’şave_ouut
.
G‘Ex‹nsiÚ
(
’şave_­i_‹¡_ouut
);

52 
ASSERT_TRUE
(
ouut_‹¡
.
has_‹¡_¡ršg
());

53 
ASSERT_TRUE
(
ouut_‹¡
.
has_‹¡_št
());

54 
ASSERT_EQ
(
ouut_‹¡
.
‹¡_»³©ed_size
(), 2);

55 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_¡ršg
(), "output string");

56 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_št
(), 1);

57 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_»³©ed
(0), "output„epeated 1");

58 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_»³©ed
(1), "output„epeated 2");

	@platform/core/test/enclave_api_test_driver.cc

19 
	~<¡ršg
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

35 şas 
	cCl›ÁApiTe¡
 : 
public
 
EnşaveTe¡
 {};

37 
TEST_F
(
Cl›ÁApiTe¡
, 
IÅutOuutTe¡
) {

38 
EnşaveIÅut
 
	g’şave_šput
;

39 
EnşaveApiTe¡
 *
	gšput_‹¡
 =

40 
’şave_šput
.
MubËEx‹nsiÚ
(
’şave_­i_‹¡_šput
);

41 
	gšput_‹¡
->
£t_‹¡_¡ršg
("test string");

42 
	gšput_‹¡
->
£t_‹¡_št
(1);

43 
	gšput_‹¡
->
add_‹¡_»³©ed
("test„epeated 1");

44 
	gšput_‹¡
->
add_‹¡_»³©ed
("test„epeated 2");

45 
EnşaveOuut
 
	g’şave_ouut
;

46 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
);

47 
EXPECT_THAT
(
¡©us
, 
IsOk
());

49 
ASSERT_TRUE
(
’şave_ouut
.
HasEx‹nsiÚ
(
’şave_­i_‹¡_ouut
));

50 
EnşaveApiTe¡
 
	gouut_‹¡
 =

51 
’şave_ouut
.
G‘Ex‹nsiÚ
(
’şave_­i_‹¡_ouut
);

52 
ASSERT_TRUE
(
ouut_‹¡
.
has_‹¡_¡ršg
());

53 
ASSERT_TRUE
(
ouut_‹¡
.
has_‹¡_št
());

54 
ASSERT_EQ
(
ouut_‹¡
.
‹¡_»³©ed_size
(), 2);

55 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_¡ršg
(), "output string");

56 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_št
(), 1);

57 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_»³©ed
(0), "output„epeated 1");

58 
EXPECT_EQ
(
ouut_‹¡
.
‹¡_»³©ed
(1), "output„epeated 2");

	@platform/core/test/enclave_api_test_enclave.cc

19 
	~<¡ršg
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
Çme¥aû
 
	gasylo
 {

27 şas 
	cEnşaveApi
 : 
public
 
EnşaveTe¡Ca£
 {

28 
public
:

29 
EnşaveApi
() = ;

31 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

32 ià(!
	gšput
.
HasEx‹nsiÚ
(
’şave_­i_‹¡_šput
)) {

33  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

36 
EnşaveApiTe¡
 
	gšput_‹¡
 = 
šput
.
G‘Ex‹nsiÚ
(
’şave_­i_‹¡_šput
);

37 ià(!
	gšput_‹¡
.
has_‹¡_¡ršg
(è|| !šput_‹¡.
has_‹¡_št
() ||

38 
	gšput_‹¡
.
‹¡_»³©ed_size
() == 0) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 ià(
	gšput_‹¡
.
‹¡_¡ršg
() != "test string" ||

43 
šput_‹¡
.
‹¡_št
(è!ğ1 || iÅut_‹¡.
‹¡_»³©ed_size
() != 2 ||

44 
šput_‹¡
.
‹¡_»³©ed
(0) != "test„epeated 1" ||

45 
šput_‹¡
.
‹¡_»³©ed
(1) != "test„epeated 2") {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

49 
EnşaveApiTe¡
 
	gouut_‹¡
;

50 
	gouut_‹¡
.
£t_‹¡_¡ršg
("output string");

51 
	gouut_‹¡
.
£t_‹¡_št
(1);

52 
	gouut_‹¡
.
add_‹¡_»³©ed
("output„epeated 1");

53 
	gouut_‹¡
.
add_‹¡_»³©ed
("output„epeated 2");

54 
	gouut
->
MubËEx‹nsiÚ
(
’şave_­i_‹¡_ouut
)->
CİyFrom
(
ouut_‹¡
);

56  
	gStus
::
OkStus
();

60 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveApi
; 
	}
}

	@platform/core/test/enclave_api_test_enclave.cc

19 
	~<¡ršg
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
Çme¥aû
 
	gasylo
 {

27 şas 
	cEnşaveApi
 : 
public
 
EnşaveTe¡Ca£
 {

28 
public
:

29 
EnşaveApi
() = ;

31 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

32 ià(!
	gšput
.
HasEx‹nsiÚ
(
’şave_­i_‹¡_šput
)) {

33  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

36 
EnşaveApiTe¡
 
	gšput_‹¡
 = 
šput
.
G‘Ex‹nsiÚ
(
’şave_­i_‹¡_šput
);

37 ià(!
	gšput_‹¡
.
has_‹¡_¡ršg
(è|| !šput_‹¡.
has_‹¡_št
() ||

38 
	gšput_‹¡
.
‹¡_»³©ed_size
() == 0) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 ià(
	gšput_‹¡
.
‹¡_¡ršg
() != "test string" ||

43 
šput_‹¡
.
‹¡_št
(è!ğ1 || iÅut_‹¡.
‹¡_»³©ed_size
() != 2 ||

44 
šput_‹¡
.
‹¡_»³©ed
(0) != "test„epeated 1" ||

45 
šput_‹¡
.
‹¡_»³©ed
(1) != "test„epeated 2") {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

49 
EnşaveApiTe¡
 
	gouut_‹¡
;

50 
	gouut_‹¡
.
£t_‹¡_¡ršg
("output string");

51 
	gouut_‹¡
.
£t_‹¡_št
(1);

52 
	gouut_‹¡
.
add_‹¡_»³©ed
("output„epeated 1");

53 
	gouut_‹¡
.
add_‹¡_»³©ed
("output„epeated 2");

54 
	gouut
->
MubËEx‹nsiÚ
(
’şave_­i_‹¡_ouut
)->
CİyFrom
(
ouut_‹¡
);

56  
	gStus
::
OkStus
();

60 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveApi
; 
	}
}

	@platform/core/test/getenv_test_driver.cc

19 
	~<¡ršg
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/’şave.pb.h
"

24 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cEnşaveG‘’vTe¡
 : 
public
 
EnşaveTe¡
 {

32 
public
:

33 
S‘Up
(è
ov”ride
 {

34 
EnvœÚm’tV¬ŸbË
 *
v¬ŸbË
 = 
cÚfig_
.
add_’vœÚm’t_v¬ŸbËs
();

35 
	gv¬ŸbË
->
£t_Çme
("GETENV_TEST");

36 
	gv¬ŸbË
->
£t_v®ue
("expected_value");

37 
S‘UpBa£
();

41 
TEST_F
(
EnşaveG‘’vTe¡
, 
G‘’vTe¡
) {

42 
EnşaveIÅut
 
	g’şave_šput
;

43 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

44 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("GETENV_TEST=expected_value");

45 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("PATH~");

46 
	g¡d
::
¡ršg
 
buf
 = 
’şave_šput_‹¡
.
S”ŸlizeAsSŒšg
();

47 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
buf
);

48 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

49 
EXPECT_THAT
(
¡©us
, 
IsOk
());

	@platform/core/test/getenv_test_driver.cc

19 
	~<¡ršg
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/’şave.pb.h
"

24 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cEnşaveG‘’vTe¡
 : 
public
 
EnşaveTe¡
 {

32 
public
:

33 
S‘Up
(è
ov”ride
 {

34 
EnvœÚm’tV¬ŸbË
 *
v¬ŸbË
 = 
cÚfig_
.
add_’vœÚm’t_v¬ŸbËs
();

35 
	gv¬ŸbË
->
£t_Çme
("GETENV_TEST");

36 
	gv¬ŸbË
->
£t_v®ue
("expected_value");

37 
S‘UpBa£
();

41 
TEST_F
(
EnşaveG‘’vTe¡
, 
G‘’vTe¡
) {

42 
EnşaveIÅut
 
	g’şave_šput
;

43 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

44 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("GETENV_TEST=expected_value");

45 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("PATH~");

46 
	g¡d
::
¡ršg
 
buf
 = 
’şave_šput_‹¡
.
S”ŸlizeAsSŒšg
();

47 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
buf
);

48 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

49 
EXPECT_THAT
(
¡©us
, 
IsOk
());

	@platform/core/test/getenv_test_enclave.cc

19 
	~<¡dlib.h
>

20 
	~<¡ršg
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

29 şas 
	cEnşaveG‘’vTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

30 
public
:

31 
EnşaveG‘’vTe¡
() = ;

33 
Stus
 
RunTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡_¡ršg
) {

34 cÚ¡ *
pos™ive
 = 
¡rchr
(
‹¡_¡ršg
.
c_¡r
(), '=');

35 ià(
	gpos™ive
) {

36 
	g¡d
::
¡ršg
 
Çme
(
‹¡_¡ršg
.
c_¡r
(), 
pos™ive
 -est_string.c_str());

37 
	g¡d
::
¡ršg
 
v®ue
(
pos™ive
 + 1, 
‹¡_¡ršg
.
size
(è- 
Çme
.size() - 1);

38 cÚ¡ *
	g‹¡_v®ue
 = 
g‘’v
(
Çme
.
c_¡r
());

39 ià(!
	g‹¡_v®ue
) {

40  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

41 
ab¦
::
SŒC©
("g‘’v„‘uºed‚uÎ fÜ‚am", 
Çme
));

42 } ià(
	gv®ue
 !ğ
‹¡_v®ue
) {

43  
Stus
(

44 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

45 
ab¦
::
SŒC©
("g‘’v„‘uºed‡ÀuÃx³ùed v®ufÜ‚am", 
Çme
,

46 ": ", 
‹¡_v®ue
, ",ƒx³ùed ", 
v®ue
));

49 cÚ¡ *
	gÃg©ive
 = 
¡rchr
(
‹¡_¡ršg
.
c_¡r
(), '~');

50 ià(!
	gÃg©ive
) {

51  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

52 
ab¦
::
SŒC©
("Bade¡ sŒšg: ", 
‹¡_¡ršg
));

54 
	g¡d
::
¡ršg
 
Çme
(
‹¡_¡ršg
.
c_¡r
(), 
Ãg©ive
 -est_string.c_str());

55 cÚ¡ *
	gÃg©ive_v®ue
 = 
g‘’v
(
Çme
.
c_¡r
());

56 ià(
	gÃg©ive_v®ue
) {

57  
Stus
(

58 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

59 
ab¦
::
SŒC©
("Test for unset getenv„eturned‡ value for‚ame ",

60 
Çme
, ": ", 
Ãg©ive_v®ue
));

63  
	gStus
::
OkStus
();

66 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *) {

67 
	g¡d
::
¡ršg
 
buf
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

68 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

69 ià(!
	g’şave_šput_‹¡
.
P¬£FromA¼ay
(
buf
.
d©a
(), buf.
size
())) {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 ià(
	g’şave_šput_‹¡
.
‹¡_»³©ed_size
() != 2) {

74  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

78 cÚ¡‡utØ&
	g‹¡
 : 
’şave_šput_‹¡
.
‹¡_»³©ed
()) {

79 
ASYLO_RETURN_IF_ERROR
(
RunTe¡
(
‹¡
));

81  
	gStus
::
OkStus
();

85 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveG‘’vTe¡
; 
	}
}

	@platform/core/test/getenv_test_enclave.cc

19 
	~<¡dlib.h
>

20 
	~<¡ršg
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

29 şas 
	cEnşaveG‘’vTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

30 
public
:

31 
EnşaveG‘’vTe¡
() = ;

33 
Stus
 
RunTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡_¡ršg
) {

34 cÚ¡ *
pos™ive
 = 
¡rchr
(
‹¡_¡ršg
.
c_¡r
(), '=');

35 ià(
	gpos™ive
) {

36 
	g¡d
::
¡ršg
 
Çme
(
‹¡_¡ršg
.
c_¡r
(), 
pos™ive
 -est_string.c_str());

37 
	g¡d
::
¡ršg
 
v®ue
(
pos™ive
 + 1, 
‹¡_¡ršg
.
size
(è- 
Çme
.size() - 1);

38 cÚ¡ *
	g‹¡_v®ue
 = 
g‘’v
(
Çme
.
c_¡r
());

39 ià(!
	g‹¡_v®ue
) {

40  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

41 
ab¦
::
SŒC©
("g‘’v„‘uºed‚uÎ fÜ‚am", 
Çme
));

42 } ià(
	gv®ue
 !ğ
‹¡_v®ue
) {

43  
Stus
(

44 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

45 
ab¦
::
SŒC©
("g‘’v„‘uºed‡ÀuÃx³ùed v®ufÜ‚am", 
Çme
,

46 ": ", 
‹¡_v®ue
, ",ƒx³ùed ", 
v®ue
));

49 cÚ¡ *
	gÃg©ive
 = 
¡rchr
(
‹¡_¡ršg
.
c_¡r
(), '~');

50 ià(!
	gÃg©ive
) {

51  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

52 
ab¦
::
SŒC©
("Bade¡ sŒšg: ", 
‹¡_¡ršg
));

54 
	g¡d
::
¡ršg
 
Çme
(
‹¡_¡ršg
.
c_¡r
(), 
Ãg©ive
 -est_string.c_str());

55 cÚ¡ *
	gÃg©ive_v®ue
 = 
g‘’v
(
Çme
.
c_¡r
());

56 ià(
	gÃg©ive_v®ue
) {

57  
Stus
(

58 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

59 
ab¦
::
SŒC©
("Test for unset getenv„eturned‡ value for‚ame ",

60 
Çme
, ": ", 
Ãg©ive_v®ue
));

63  
	gStus
::
OkStus
();

66 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *) {

67 
	g¡d
::
¡ršg
 
buf
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

68 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

69 ià(!
	g’şave_šput_‹¡
.
P¬£FromA¼ay
(
buf
.
d©a
(), buf.
size
())) {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 ià(
	g’şave_šput_‹¡
.
‹¡_»³©ed_size
() != 2) {

74  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

78 cÚ¡‡utØ&
	g‹¡
 : 
’şave_šput_‹¡
.
‹¡_»³©ed
()) {

79 
ASYLO_RETURN_IF_ERROR
(
RunTe¡
(
‹¡
));

81  
	gStus
::
OkStus
();

85 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşaveG‘’vTe¡
; 
	}
}

	@platform/core/test/lock_test.cc

19 
	~<th»ad
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_mu‹x.h
"

24 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_¥š_lock.h
"

25 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_mu‹x.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
cÚ¡ex´
 
	gkMªyTh»ads
 = 12;

32 
	g‹m¶©e
 <
ty³Çme
 
	gLockTy³
>

33 şas 
	cLockTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

34 
´Ùeùed
:

35 
LockTe¡
(è: 
lock_
(
Œue
), 
nÚ_»cursive_
(
çl£
) {}

36 
LockTy³
 
	glock_
;

37 
LockTy³
 
	gnÚ_»cursive_
;

40 ::
‹¡šg
::
	tTy³s
<
	tUÁru¡edMu‹x
, 
	tTru¡edSpšLock
, 
	tTru¡edMu‹x
>

41 
	tIm¶em’tiÚs
;

43 
TYPED_TEST_SUITE
(
LockTe¡
, 
Im¶em’tiÚs
);

45 
TYPED_TEST
(
LockTe¡
, 
RecursiveTe¡
) {

46 
EXPECT_FALSE
(
this
->
lock_
.
OwÃd
());

47 
	gthis
->
	glock_
.
Lock
();

48 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

49 
	gthis
->
	glock_
.
Lock
();

50 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

51 
	gthis
->
	glock_
.
Lock
();

52 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

53 
	gthis
->
	glock_
.
UÆock
();

54 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

55 
	gthis
->
	glock_
.
UÆock
();

56 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

57 
	gthis
->
	glock_
.
UÆock
();

58 
EXPECT_FALSE
(
this
->
lock_
.
OwÃd
());

59 
ASSERT_TRUE
(
this
->
lock_
.
TryLock
());

62 
TYPED_TEST
(
LockTe¡
, 
RecursiveMªyTh»adsTe¡
) {

63 
	gsh¬ed_couÁ”
 = 0;

64 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

65 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

66 
	gth»ads
.
em¶aû_back
([&]() {

67 
i
 = 0; i < 128 * 1024; i++) {

68 
this
->
lock_
.
Lock
();

69 
this
->
lock_
.
Lock
();

70 
EXPECT_TRUE
(
this
->
lock_
.
TryLock
());

71 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

72 
sh¬ed_couÁ”
++;

73 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

74 
sh¬ed_couÁ”
--;

75 
this
->
lock_
.
UÆock
();

76 
this
->
lock_
.
UÆock
();

77 
this
->
lock_
.
UÆock
();

82 autØ&
	gth»ad
 : 
th»ads
) {

83 
th»ad
.
još
();

86 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

89 
TYPED_TEST
(
LockTe¡
, 
NÚRecursiveMªyTh»adsTe¡
) {

90 
	gsh¬ed_couÁ”
 = 0;

91 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

92 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

93 
	gth»ads
.
em¶aû_back
([&]() {

94 
i
 = 0; i < 128 * 1024; i++) {

95 
this
->
nÚ_»cursive_
.
Lock
();

96 
EXPECT_FALSE
(
this
->
nÚ_»cursive_
.
TryLock
());

97 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

98 
sh¬ed_couÁ”
++;

99 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

100 
sh¬ed_couÁ”
--;

101 
this
->
nÚ_»cursive_
.
UÆock
();

106 autØ&
	gth»ad
 : 
th»ads
) {

107 
th»ad
.
još
();

110 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

	@platform/core/test/lock_test.cc

19 
	~<th»ad
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_mu‹x.h
"

24 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_¥š_lock.h
"

25 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_mu‹x.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
cÚ¡ex´
 
	gkMªyTh»ads
 = 12;

32 
	g‹m¶©e
 <
ty³Çme
 
	gLockTy³
>

33 şas 
	cLockTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

34 
´Ùeùed
:

35 
LockTe¡
(è: 
lock_
(
Œue
), 
nÚ_»cursive_
(
çl£
) {}

36 
LockTy³
 
	glock_
;

37 
LockTy³
 
	gnÚ_»cursive_
;

40 ::
‹¡šg
::
	tTy³s
<
	tUÁru¡edMu‹x
, 
	tTru¡edSpšLock
, 
	tTru¡edMu‹x
>

41 
	tIm¶em’tiÚs
;

43 
TYPED_TEST_SUITE
(
LockTe¡
, 
Im¶em’tiÚs
);

45 
TYPED_TEST
(
LockTe¡
, 
RecursiveTe¡
) {

46 
EXPECT_FALSE
(
this
->
lock_
.
OwÃd
());

47 
	gthis
->
	glock_
.
Lock
();

48 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

49 
	gthis
->
	glock_
.
Lock
();

50 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

51 
	gthis
->
	glock_
.
Lock
();

52 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

53 
	gthis
->
	glock_
.
UÆock
();

54 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

55 
	gthis
->
	glock_
.
UÆock
();

56 
EXPECT_TRUE
(
this
->
lock_
.
OwÃd
());

57 
	gthis
->
	glock_
.
UÆock
();

58 
EXPECT_FALSE
(
this
->
lock_
.
OwÃd
());

59 
ASSERT_TRUE
(
this
->
lock_
.
TryLock
());

62 
TYPED_TEST
(
LockTe¡
, 
RecursiveMªyTh»adsTe¡
) {

63 
	gsh¬ed_couÁ”
 = 0;

64 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

65 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

66 
	gth»ads
.
em¶aû_back
([&]() {

67 
i
 = 0; i < 128 * 1024; i++) {

68 
this
->
lock_
.
Lock
();

69 
this
->
lock_
.
Lock
();

70 
EXPECT_TRUE
(
this
->
lock_
.
TryLock
());

71 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

72 
sh¬ed_couÁ”
++;

73 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

74 
sh¬ed_couÁ”
--;

75 
this
->
lock_
.
UÆock
();

76 
this
->
lock_
.
UÆock
();

77 
this
->
lock_
.
UÆock
();

82 autØ&
	gth»ad
 : 
th»ads
) {

83 
th»ad
.
još
();

86 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

89 
TYPED_TEST
(
LockTe¡
, 
NÚRecursiveMªyTh»adsTe¡
) {

90 
	gsh¬ed_couÁ”
 = 0;

91 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

92 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

93 
	gth»ads
.
em¶aû_back
([&]() {

94 
i
 = 0; i < 128 * 1024; i++) {

95 
this
->
nÚ_»cursive_
.
Lock
();

96 
EXPECT_FALSE
(
this
->
nÚ_»cursive_
.
TryLock
());

97 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

98 
sh¬ed_couÁ”
++;

99 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

100 
sh¬ed_couÁ”
--;

101 
this
->
nÚ_»cursive_
.
UÆock
();

106 autØ&
	gth»ad
 : 
th»ads
) {

107 
th»ad
.
još
();

110 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

	@platform/core/test/proto_test_driver.cc

19 
	~<¡ršg
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 şas 
	cEnşavePrÙoTe¡
 : 
public
 
EnşaveTe¡
 {};

32 
TEST_F
(
EnşavePrÙoTe¡
, 
R—dWr™eTe¡
) {

33 
EnşaveIÅut
 
	g’şave_šput
;

34 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

35 
	g’şave_šput_‹¡
.
£t_‹¡_¡ršg
("test string");

36 
	g’şave_šput_‹¡
.
£t_‹¡_št
(1);

37 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("test„epeated 1");

38 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("test„epeated 2");

39 
	g¡d
::
¡ršg
 
buf
 = 
’şave_šput_‹¡
.
S”ŸlizeAsSŒšg
();

40 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
buf
);

41 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

42 
EXPECT_THAT
(
¡©us
, 
IsOk
());

	@platform/core/test/proto_test_driver.cc

19 
	~<¡ršg
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 şas 
	cEnşavePrÙoTe¡
 : 
public
 
EnşaveTe¡
 {};

32 
TEST_F
(
EnşavePrÙoTe¡
, 
R—dWr™eTe¡
) {

33 
EnşaveIÅut
 
	g’şave_šput
;

34 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

35 
	g’şave_šput_‹¡
.
£t_‹¡_¡ršg
("test string");

36 
	g’şave_šput_‹¡
.
£t_‹¡_št
(1);

37 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("test„epeated 1");

38 
	g’şave_šput_‹¡
.
add_‹¡_»³©ed
("test„epeated 2");

39 
	g¡d
::
¡ršg
 
buf
 = 
’şave_šput_‹¡
.
S”ŸlizeAsSŒšg
();

40 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
buf
);

41 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

42 
EXPECT_THAT
(
¡©us
, 
IsOk
());

	@platform/core/test/proto_test_enclave.cc

19 
	~<¡ršg
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
Çme¥aû
 
	gasylo
 {

27 şas 
	cEnşavePrÙoTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

28 
public
:

29 
EnşavePrÙoTe¡
() = ;

31 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

32 
	g¡d
::
¡ršg
 
buf
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

33 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

34 ià(!
	g’şave_šput_‹¡
.
P¬£FromA¼ay
(
buf
.
d©a
(), buf.
size
())) {

35  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

38 ià(!
	g’şave_šput_‹¡
.
has_‹¡_¡ršg
() ||

39 !
	g’şave_šput_‹¡
.
has_‹¡_št
() ||

40 
	g’şave_šput_‹¡
.
‹¡_»³©ed_size
() == 0) {

41  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

44 ià(
	g’şave_šput_‹¡
.
‹¡_¡ršg
() != "test string" ||

45 
’şave_šput_‹¡
.
‹¡_št
() != 1 ||

46 
’şave_šput_‹¡
.
‹¡_»³©ed_size
() != 2 ||

47 
’şave_šput_‹¡
.
‹¡_»³©ed
(0) != "test„epeated 1" ||

48 
’şave_šput_‹¡
.
‹¡_»³©ed
(1) != "test„epeated 2") {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

53  
	gStus
::
OkStus
();

57 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşavePrÙoTe¡
; 
	}
}

	@platform/core/test/proto_test_enclave.cc

19 
	~<¡ršg
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/cÜe/‹¡/´Ùo_‹¡.pb.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
Çme¥aû
 
	gasylo
 {

27 şas 
	cEnşavePrÙoTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

28 
public
:

29 
EnşavePrÙoTe¡
() = ;

31 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

32 
	g¡d
::
¡ršg
 
buf
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

33 
EnşaveApiTe¡
 
	g’şave_šput_‹¡
;

34 ià(!
	g’şave_šput_‹¡
.
P¬£FromA¼ay
(
buf
.
d©a
(), buf.
size
())) {

35  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

38 ià(!
	g’şave_šput_‹¡
.
has_‹¡_¡ršg
() ||

39 !
	g’şave_šput_‹¡
.
has_‹¡_št
() ||

40 
	g’şave_šput_‹¡
.
‹¡_»³©ed_size
() == 0) {

41  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

44 ià(
	g’şave_šput_‹¡
.
‹¡_¡ršg
() != "test string" ||

45 
’şave_šput_‹¡
.
‹¡_št
() != 1 ||

46 
’şave_šput_‹¡
.
‹¡_»³©ed_size
() != 2 ||

47 
’şave_šput_‹¡
.
‹¡_»³©ed
(0) != "test„epeated 1" ||

48 
’şave_šput_‹¡
.
‹¡_»³©ed
(1) != "test„epeated 2") {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

53  
	gStus
::
OkStus
();

57 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
EnşavePrÙoTe¡
; 
	}
}

	@platform/core/test/random_test.cc

19 
	~<fú.h
>

20 
	~<İ’s¦/¿nd.h
>

21 
	~<uni¡d.h
>

22 
	~<®gÜ™hm
>

23 
	~<¡ršg
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dRªdomBy‹s
(cÚ¡ *
·th
, 
size_t
 
»ad_by‹s
,

37 
size_t
 
®ign_by‹s
) {

38 
	gfd
 = 
İ’
(
·th
, 
O_RDONLY
, 0);

39 ià(
	gfd
 < 0) {

40  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

41 
ab¦
::
SŒC©
("FaedØİ’…©h ", 
·th
));

43 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

44 
ušt8_t
 
	gbuf
[128] = {};

45 ià(
	g»ad_by‹s
 > (
	gbuf
) - 16) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

47 
ab¦
::
SŒC©
("Inv®id†’gth„eque¡ed: ", 
»ad_by‹s
));

49 ià(
	g®ign_by‹s
 > 16) {

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

51 
ab¦
::
SŒC©
("Inv®id‡lignm’ˆ»que¡ed: ", 
®ign_by‹s
));

53 
size_t
 
	gcouÁ
 = 
»ad
(
fd
, &
buf
[
®ign_by‹s
], 
»ad_by‹s
);

54 ià(
	gcouÁ
 !ğ
»ad_by‹s
) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

56 
ab¦
::
SŒC©
("CªnÙ„—d ", 
·th
));

61 
size_t
 
	g»tuº_by‹s
 = (
®ign_by‹s
 + 
»ad_by‹s
 + (
ušt64_t
) - 1) /

62 (
ušt64_t
) * (uint64_t);

64  
	g¡d
::
¡ršg
(&
buf
[0], &buf[
»tuº_by‹s
]);

67 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dRªdomBy‹sFromBÜšgSSL
(
size_t
 
»ad_by‹s
) {

68 
ušt8_t
 
buf
[128] = {};

69 ià(
	g»ad_by‹s
 > (
	gbuf
)) {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Invalid‚umber of bytes„ead");

72 ià(!
RAND_by‹s
(
buf
, 
»ad_by‹s
)) {

73  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Cannot„ead„andom bytes");

75  
	g¡d
::
¡ršg
(&
buf
[0], &buf[
»ad_by‹s
]);

78 
TEST
(
DeviûsTe¡
, 
RªdomHªdËrTe¡
) {

79 cÚ¡ *
	g·th
 : {"/dev/random", "/dev/urandom"}) {

80 
size_t
 
	g»ad_by‹s
 = 1;„ead_bytes <= 32; ++read_bytes) {

81 
size_t
 
	g®ign_by‹s
 = 0;‡lign_by‹ < (
	gušt64_t
);

82 ++
	g®ign_by‹s
) {

84 autØ
	g»suÉ1_Ü_”rÜ
 = 
R—dRªdomBy‹s
(
·th
, 
»ad_by‹s
, 
®ign_by‹s
);

85 
ASSERT_TRUE
(
»suÉ1_Ü_”rÜ
.
ok
());

86 
	g¡d
::
¡ršg
 
»suÉ1
 = 
»suÉ1_Ü_”rÜ
.
V®ueOrD›
();

88 autØ
	g»suÉ2_Ü_”rÜ
 = 
R—dRªdomBy‹s
(
·th
, 
»ad_by‹s
, 
®ign_by‹s
);

89 
ASSERT_TRUE
(
»suÉ2_Ü_”rÜ
.
ok
());

90 
	g¡d
::
¡ršg
 
»suÉ2
 = 
»suÉ2_Ü_”rÜ
.
V®ueOrD›
();

94 ià(
	g»ad_by‹s
 >= 6) {

95 
EXPECT_NE
(
»suÉ1
, 
»suÉ2
);

99 
size_t
 
	gtÙ®
 = (
»ad_by‹s
 + 
®ign_by‹s
 + (
ušt64_t
) - 1) /

100 (
ušt64_t
) * (uint64_t);

101 
EXPECT_EQ
(
»suÉ1
.
Ëngth
(), 
tÙ®
);

102 
EXPECT_EQ
(
»suÉ2
.
Ëngth
(), 
tÙ®
);

106 ià(
	g®ign_by‹s
) {

107 
EXPECT_EQ
(
»suÉ1
.
sub¡r
(0, 
®ign_by‹s
),

108 
¡d
::
¡ršg
(
®ign_by‹s
, 0));

109 
EXPECT_EQ
(
»suÉ2
.
sub¡r
(0, 
®ign_by‹s
),

110 
¡d
::
¡ršg
(
®ign_by‹s
, 0));

112 
size_t
 
	gexŒa
 = 
tÙ®
 - 
®ign_by‹s
 - 
»ad_by‹s
;

113 ià(
	gexŒa
) {

114 
EXPECT_EQ
(
»suÉ1
.
sub¡r
ÔesuÉ1.
size
(è- 
exŒa
),

115 
¡d
::
¡ršg
(
exŒa
, 0));

116 
EXPECT_EQ
(
»suÉ2
.
sub¡r
ÔesuÉ2.
size
(è- 
exŒa
),

117 
¡d
::
¡ršg
(
exŒa
, 0));

124 
TEST
(
BÜšgSSLTe¡
, 
RªdomHªdËrTe¡
) {

125 
	g»ad_by‹s
 = 16;

127 autØ
	g»suÉ1_Ü_”rÜ
 = 
R—dRªdomBy‹sFromBÜšgSSL
(
»ad_by‹s
);

128 
ASSERT_TRUE
(
»suÉ1_Ü_”rÜ
.
ok
());

129 
	g¡d
::
¡ršg
 
»suÉ1
 = 
»suÉ1_Ü_”rÜ
.
V®ueOrD›
();

132 autØ
	g»suÉ2_Ü_”rÜ
 = 
R—dRªdomBy‹sFromBÜšgSSL
(
»ad_by‹s
);

133 
ASSERT_TRUE
(
»suÉ2_Ü_”rÜ
.
ok
());

134 
	g¡d
::
¡ršg
 
»suÉ2
 = 
»suÉ2_Ü_”rÜ
.
V®ueOrD›
();

137 
EXPECT_NE
(
»suÉ1
, 
»suÉ2
);

140 
EXPECT_EQ
(
»suÉ1
.
Ëngth
(), 
»ad_by‹s
);

141 
EXPECT_EQ
(
»suÉ2
.
Ëngth
(), 
»ad_by‹s
);

	@platform/core/test/random_test.cc

19 
	~<fú.h
>

20 
	~<İ’s¦/¿nd.h
>

21 
	~<uni¡d.h
>

22 
	~<®gÜ™hm
>

23 
	~<¡ršg
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dRªdomBy‹s
(cÚ¡ *
·th
, 
size_t
 
»ad_by‹s
,

37 
size_t
 
®ign_by‹s
) {

38 
	gfd
 = 
İ’
(
·th
, 
O_RDONLY
, 0);

39 ià(
	gfd
 < 0) {

40  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

41 
ab¦
::
SŒC©
("FaedØİ’…©h ", 
·th
));

43 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

44 
ušt8_t
 
	gbuf
[128] = {};

45 ià(
	g»ad_by‹s
 > (
	gbuf
) - 16) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

47 
ab¦
::
SŒC©
("Inv®id†’gth„eque¡ed: ", 
»ad_by‹s
));

49 ià(
	g®ign_by‹s
 > 16) {

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

51 
ab¦
::
SŒC©
("Inv®id‡lignm’ˆ»que¡ed: ", 
®ign_by‹s
));

53 
size_t
 
	gcouÁ
 = 
»ad
(
fd
, &
buf
[
®ign_by‹s
], 
»ad_by‹s
);

54 ià(
	gcouÁ
 !ğ
»ad_by‹s
) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

56 
ab¦
::
SŒC©
("CªnÙ„—d ", 
·th
));

61 
size_t
 
	g»tuº_by‹s
 = (
®ign_by‹s
 + 
»ad_by‹s
 + (
ušt64_t
) - 1) /

62 (
ušt64_t
) * (uint64_t);

64  
	g¡d
::
¡ršg
(&
buf
[0], &buf[
»tuº_by‹s
]);

67 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dRªdomBy‹sFromBÜšgSSL
(
size_t
 
»ad_by‹s
) {

68 
ušt8_t
 
buf
[128] = {};

69 ià(
	g»ad_by‹s
 > (
	gbuf
)) {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Invalid‚umber of bytes„ead");

72 ià(!
RAND_by‹s
(
buf
, 
»ad_by‹s
)) {

73  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Cannot„ead„andom bytes");

75  
	g¡d
::
¡ršg
(&
buf
[0], &buf[
»ad_by‹s
]);

78 
TEST
(
DeviûsTe¡
, 
RªdomHªdËrTe¡
) {

79 cÚ¡ *
	g·th
 : {"/dev/random", "/dev/urandom"}) {

80 
size_t
 
	g»ad_by‹s
 = 1;„ead_bytes <= 32; ++read_bytes) {

81 
size_t
 
	g®ign_by‹s
 = 0;‡lign_by‹ < (
	gušt64_t
);

82 ++
	g®ign_by‹s
) {

84 autØ
	g»suÉ1_Ü_”rÜ
 = 
R—dRªdomBy‹s
(
·th
, 
»ad_by‹s
, 
®ign_by‹s
);

85 
ASSERT_TRUE
(
»suÉ1_Ü_”rÜ
.
ok
());

86 
	g¡d
::
¡ršg
 
»suÉ1
 = 
»suÉ1_Ü_”rÜ
.
V®ueOrD›
();

88 autØ
	g»suÉ2_Ü_”rÜ
 = 
R—dRªdomBy‹s
(
·th
, 
»ad_by‹s
, 
®ign_by‹s
);

89 
ASSERT_TRUE
(
»suÉ2_Ü_”rÜ
.
ok
());

90 
	g¡d
::
¡ršg
 
»suÉ2
 = 
»suÉ2_Ü_”rÜ
.
V®ueOrD›
();

94 ià(
	g»ad_by‹s
 >= 6) {

95 
EXPECT_NE
(
»suÉ1
, 
»suÉ2
);

99 
size_t
 
	gtÙ®
 = (
»ad_by‹s
 + 
®ign_by‹s
 + (
ušt64_t
) - 1) /

100 (
ušt64_t
) * (uint64_t);

101 
EXPECT_EQ
(
»suÉ1
.
Ëngth
(), 
tÙ®
);

102 
EXPECT_EQ
(
»suÉ2
.
Ëngth
(), 
tÙ®
);

106 ià(
	g®ign_by‹s
) {

107 
EXPECT_EQ
(
»suÉ1
.
sub¡r
(0, 
®ign_by‹s
),

108 
¡d
::
¡ršg
(
®ign_by‹s
, 0));

109 
EXPECT_EQ
(
»suÉ2
.
sub¡r
(0, 
®ign_by‹s
),

110 
¡d
::
¡ršg
(
®ign_by‹s
, 0));

112 
size_t
 
	gexŒa
 = 
tÙ®
 - 
®ign_by‹s
 - 
»ad_by‹s
;

113 ià(
	gexŒa
) {

114 
EXPECT_EQ
(
»suÉ1
.
sub¡r
ÔesuÉ1.
size
(è- 
exŒa
),

115 
¡d
::
¡ršg
(
exŒa
, 0));

116 
EXPECT_EQ
(
»suÉ2
.
sub¡r
ÔesuÉ2.
size
(è- 
exŒa
),

117 
¡d
::
¡ršg
(
exŒa
, 0));

124 
TEST
(
BÜšgSSLTe¡
, 
RªdomHªdËrTe¡
) {

125 
	g»ad_by‹s
 = 16;

127 autØ
	g»suÉ1_Ü_”rÜ
 = 
R—dRªdomBy‹sFromBÜšgSSL
(
»ad_by‹s
);

128 
ASSERT_TRUE
(
»suÉ1_Ü_”rÜ
.
ok
());

129 
	g¡d
::
¡ršg
 
»suÉ1
 = 
»suÉ1_Ü_”rÜ
.
V®ueOrD›
();

132 autØ
	g»suÉ2_Ü_”rÜ
 = 
R—dRªdomBy‹sFromBÜšgSSL
(
»ad_by‹s
);

133 
ASSERT_TRUE
(
»suÉ2_Ü_”rÜ
.
ok
());

134 
	g¡d
::
¡ršg
 
»suÉ2
 = 
»suÉ2_Ü_”rÜ
.
V®ueOrD›
();

137 
EXPECT_NE
(
»suÉ1
, 
»suÉ2
);

140 
EXPECT_EQ
(
»suÉ1
.
Ëngth
(), 
»ad_by‹s
);

141 
EXPECT_EQ
(
»suÉ2
.
Ëngth
(), 
»ad_by‹s
);

	@platform/core/test/shared_resource_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

27 
	sTe¡Resourû
 {

30 
ex¶ic™
 
Te¡Resourû
(
boŞ
 *
®ive
è:‡live×liveè{ *®ivğ
Œue
; }

31 ~
Te¡Resourû
(è{ *
	g®ive
 = 
çl£
; }

32 
	g¡d
::
¡ršg
 
v®ue
;

33 
boŞ
 *
	g®ive
;

36 
TEST
(
EnşaveResourûsTe¡
, 
ResourûLiãCyşe
) {

37 cÚ¡ 
Sh¬edName
 
mªaged_Çme
(
kUn¥ecif›dName
, "managed„esource");

38 cÚ¡ 
Sh¬edName
 
unmªaged_Çme
(
kUn¥ecif›dName
, "unmanaged„esource");

40 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

41 
Sh¬edResourûMªag”
 *
	g»sourûs
 =

42 
EnşaveMªag”
::
In¡ªû
().
V®ueOrD›
()->
sh¬ed_»sourûs
();

45 
boŞ
 
	gis_mªaged_»sourû_®ive
;

46 
boŞ
 
	gis_unmªaged_»sourû_®ive
;

47 
Te¡Resourû
 
unmªaged_»sourû
(&
is_unmªaged_»sourû_®ive
);

48 autØ*
	gmªaged_»sourû
 = 
Ãw
 
Te¡Resourû
(&
is_mªaged_»sourû_®ive
);

49 
	gmªaged_»sourû
->
	gv®ue
 = "managed„esource";

50 
	gunmªaged_»sourû
.
	gv®ue
 = "unmanaged„esource";

53 
	g»sourûs
->
Regi¡”MªagedResourû
(
mªaged_Çme
, 
mªaged_»sourû
);

54 
	g»sourûs
->
Regi¡”UnmªagedResourû
(
unmªaged_Çme
, &
unmªaged_»sourû
);

57 
EXPECT_TRUE
(
is_mªaged_»sourû_®ive
);

58 
EXPECT_TRUE
(
is_unmªaged_»sourû_®ive
);

61 
EXPECT_FALSE
(

62 
»sourûs
->
Regi¡”MªagedResourû
(
unmªaged_Çme
, &
unmªaged_»sourû
)

63 .
ok
());

66 
	gi
 = 0; i < 100; i++) {

67 
Te¡Resourû
 *
	g»sourû
 =

68 
»sourûs
->
AcquœeResourû
<
Te¡Resourû
>(
unmªaged_Çme
);

69 
EXPECT_EQ
(
»sourû
->
v®ue
, "unmanaged„esource");

70 
	g»sourû
 = 
»sourûs
->
AcquœeResourû
<
Te¡Resourû
>(
mªaged_Çme
);

71 
EXPECT_EQ
(
»sourû
->
v®ue
, "managed„esource");

75 
	gi
 = 0; i < 100; i++) {

76 
EXPECT_TRUE
(
»sourûs
->
R–—£Resourû
(
mªaged_Çme
));

77 
EXPECT_TRUE
(
is_mªaged_»sourû_®ive
);

78 
EXPECT_TRUE
(
»sourûs
->
R–—£Resourû
(
unmªaged_Çme
));

79 
EXPECT_TRUE
(
is_unmªaged_»sourû_®ive
);

84 
	g»sourûs
->
R–—£Resourû
(
mªaged_Çme
);

85 
EXPECT_FALSE
(
is_mªaged_»sourû_®ive
);

89 
	g»sourûs
->
R–—£Resourû
(
unmªaged_Çme
);

90 
EXPECT_TRUE
(
is_unmªaged_»sourû_®ive
);

93 
EXPECT_FALSE
(
»sourûs
->
R–—£Resourû
(
mªaged_Çme
));

94 
EXPECT_FALSE
(
»sourûs
->
R–—£Resourû
(
unmªaged_Çme
));

97 
EXPECT_TRUE
(

98 
»sourûs
->
Regi¡”MªagedResourû
(
unmªaged_Çme
, &
unmªaged_»sourû
)

99 .
ok
());

102 
TEST
(
EnşaveResourûsTe¡
, 
Cu¡omD–‘”
) {

103 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

104 
Sh¬edResourûMªag”
 *
	g»sourûs
 =

105 
EnşaveMªag”
::
In¡ªû
().
V®ueOrD›
()->
sh¬ed_»sourûs
();

108 
	sCu¡omCËªupSŒ©egy
 {

109 
İ”©Ü
()(
	g¡d
::
¡ršg
 *
»sourû
) {

110 *
»sourû
 = "custom cleanup strategy was invoked";

114 cÚ¡ 
Sh¬edName
 
Çme
(
kUn¥ecif›dName
, "resource‚ame");

115 
	g¡d
::
¡ršg
 
a_¡ršg_»sourû
 = "I'm‚ot dead!";

116 
	g»sourûs
->
	gRegi¡”MªagedResourû
<
	g¡d
::
¡ršg
, 
	gCu¡omCËªupSŒ©egy
>(

117 
	gÇme
, &
	ga_¡ršg_»sourû
);

118 
	g»sourûs
->
R–—£Resourû
(
Çme
);

119 
EXPECT_EQ
(
a_¡ršg_»sourû
, "custom cleanup strategy was invoked");

	@platform/core/test/shared_resource_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

27 
	sTe¡Resourû
 {

30 
ex¶ic™
 
Te¡Resourû
(
boŞ
 *
®ive
è:‡live×liveè{ *®ivğ
Œue
; }

31 ~
Te¡Resourû
(è{ *
	g®ive
 = 
çl£
; }

32 
	g¡d
::
¡ršg
 
v®ue
;

33 
boŞ
 *
	g®ive
;

36 
TEST
(
EnşaveResourûsTe¡
, 
ResourûLiãCyşe
) {

37 cÚ¡ 
Sh¬edName
 
mªaged_Çme
(
kUn¥ecif›dName
, "managed„esource");

38 cÚ¡ 
Sh¬edName
 
unmªaged_Çme
(
kUn¥ecif›dName
, "unmanaged„esource");

40 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

41 
Sh¬edResourûMªag”
 *
	g»sourûs
 =

42 
EnşaveMªag”
::
In¡ªû
().
V®ueOrD›
()->
sh¬ed_»sourûs
();

45 
boŞ
 
	gis_mªaged_»sourû_®ive
;

46 
boŞ
 
	gis_unmªaged_»sourû_®ive
;

47 
Te¡Resourû
 
unmªaged_»sourû
(&
is_unmªaged_»sourû_®ive
);

48 autØ*
	gmªaged_»sourû
 = 
Ãw
 
Te¡Resourû
(&
is_mªaged_»sourû_®ive
);

49 
	gmªaged_»sourû
->
	gv®ue
 = "managed„esource";

50 
	gunmªaged_»sourû
.
	gv®ue
 = "unmanaged„esource";

53 
	g»sourûs
->
Regi¡”MªagedResourû
(
mªaged_Çme
, 
mªaged_»sourû
);

54 
	g»sourûs
->
Regi¡”UnmªagedResourû
(
unmªaged_Çme
, &
unmªaged_»sourû
);

57 
EXPECT_TRUE
(
is_mªaged_»sourû_®ive
);

58 
EXPECT_TRUE
(
is_unmªaged_»sourû_®ive
);

61 
EXPECT_FALSE
(

62 
»sourûs
->
Regi¡”MªagedResourû
(
unmªaged_Çme
, &
unmªaged_»sourû
)

63 .
ok
());

66 
	gi
 = 0; i < 100; i++) {

67 
Te¡Resourû
 *
	g»sourû
 =

68 
»sourûs
->
AcquœeResourû
<
Te¡Resourû
>(
unmªaged_Çme
);

69 
EXPECT_EQ
(
»sourû
->
v®ue
, "unmanaged„esource");

70 
	g»sourû
 = 
»sourûs
->
AcquœeResourû
<
Te¡Resourû
>(
mªaged_Çme
);

71 
EXPECT_EQ
(
»sourû
->
v®ue
, "managed„esource");

75 
	gi
 = 0; i < 100; i++) {

76 
EXPECT_TRUE
(
»sourûs
->
R–—£Resourû
(
mªaged_Çme
));

77 
EXPECT_TRUE
(
is_mªaged_»sourû_®ive
);

78 
EXPECT_TRUE
(
»sourûs
->
R–—£Resourû
(
unmªaged_Çme
));

79 
EXPECT_TRUE
(
is_unmªaged_»sourû_®ive
);

84 
	g»sourûs
->
R–—£Resourû
(
mªaged_Çme
);

85 
EXPECT_FALSE
(
is_mªaged_»sourû_®ive
);

89 
	g»sourûs
->
R–—£Resourû
(
unmªaged_Çme
);

90 
EXPECT_TRUE
(
is_unmªaged_»sourû_®ive
);

93 
EXPECT_FALSE
(
»sourûs
->
R–—£Resourû
(
mªaged_Çme
));

94 
EXPECT_FALSE
(
»sourûs
->
R–—£Resourû
(
unmªaged_Çme
));

97 
EXPECT_TRUE
(

98 
»sourûs
->
Regi¡”MªagedResourû
(
unmªaged_Çme
, &
unmªaged_»sourû
)

99 .
ok
());

102 
TEST
(
EnşaveResourûsTe¡
, 
Cu¡omD–‘”
) {

103 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

104 
Sh¬edResourûMªag”
 *
	g»sourûs
 =

105 
EnşaveMªag”
::
In¡ªû
().
V®ueOrD›
()->
sh¬ed_»sourûs
();

108 
	sCu¡omCËªupSŒ©egy
 {

109 
İ”©Ü
()(
	g¡d
::
¡ršg
 *
»sourû
) {

110 *
»sourû
 = "custom cleanup strategy was invoked";

114 cÚ¡ 
Sh¬edName
 
Çme
(
kUn¥ecif›dName
, "resource‚ame");

115 
	g¡d
::
¡ršg
 
a_¡ršg_»sourû
 = "I'm‚ot dead!";

116 
	g»sourûs
->
	gRegi¡”MªagedResourû
<
	g¡d
::
¡ršg
, 
	gCu¡omCËªupSŒ©egy
>(

117 
	gÇme
, &
	ga_¡ršg_»sourû
);

118 
	g»sourûs
->
R–—£Resourû
(
Çme
);

119 
EXPECT_EQ
(
a_¡ršg_»sourû
, "custom cleanup strategy was invoked");

	@platform/core/trusted_application.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_­¶iÿtiÚ.h
"

21 
	~<sys/ucÚ‹xt.h
>

22 
	~<uni¡d.h
>

24 
	~<û¼no
>

25 
	~<c¡dio
>

26 
	~<c¡dlib
>

27 
	~<funùiÚ®
>

28 
	~<¡ršg
>

30 
	~"ab¦/memÜy/memÜy.h
"

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
	~"asylo/ut/loggšg.h
"

34 
	~"asylo/id’t™y/š™.h
"

35 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

36 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

37 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/time.h
"

38 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

39 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme_kšd.h
"

40 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

41 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

42 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

43 
	~"asylo/¶©fÜm/posix/io/Çtive_·ths.h
"

44 
	~"asylo/¶©fÜm/posix/io/¿ndom_deviûs.h
"

45 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

46 
	~"asylo/¶©fÜm/posix/th»adšg/th»ad_mªag”.h
"

47 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

48 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

49 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

50 
	~"asylo/ut/¡©us.h
"

51 
	~"asylo/ut/¡©us_maüos.h
"

53 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

54 
usšg
 
	gEnşaveS‹
 = ::
asylo
::
Tru¡edAµliÿtiÚ
::
S‹
;

55 
usšg
 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
;

57 
Çme¥aû
 
	gasylo
 {

58 
	gÇme¥aû
 {

60 
LogE¼Ü
(cÚ¡ 
Stus
 &
¡©us
) {

61 
EnşaveS‹
 
	g¡©e
 = 
G‘AµliÿtiÚIn¡ªû
()->
G‘S‹
();

62 ià(
	g¡©e
 < 
	gEnşaveS‹
::
kU£rIn™Ÿlizšg
) {

65 
’c_uÁru¡ed_puts
(
¡©us
.
ToSŒšg
().
c_¡r
());

67 
LOG
(
ERROR
è<< 
	g¡©us
;

75 
	g‹m¶©e
 <
şass
 
	gOuutPrÙo
>

76 şas 
	cStusS”Ÿliz”
 {

77 
	gpublic
:

82 
StusS”Ÿliz”
(cÚ¡ 
OuutPrÙo
 *
ouut_´Ùo
, 
StusPrÙo
 *
¡©us_´Ùo
,

83 **
ouut
, 
size_t
 *
ouut_Ën
)

84 : 
ouut_´Ùo_
{
ouut_´Ùo
},

85 
	g¡©us_´Ùo_
{
	g¡©us_´Ùo
},

86 
	gouut_
{
	gouut
},

87 
	gouut_Ën_
{
	gouut_Ën
},

88 
	gcu¡om_®loÿtÜ_
{
	gnuÎ±r
} {}

93 
StusS”Ÿliz”
(**
ouut
, 
size_t
 *
ouut_Ën
)

94 : 
ouut_´Ùo_
{&
´Ùo
},

95 
	g¡©us_´Ùo_
{&
	g´Ùo
},

96 
	gouut_
{
	gouut
},

97 
	gouut_Ën_
{
	gouut_Ën
},

98 
	gcu¡om_®loÿtÜ_
{
	gnuÎ±r
} {}

104 
StusS”Ÿliz”
(cÚ¡ 
OuutPrÙo
 *
ouut_´Ùo
, 
StusPrÙo
 *
¡©us_´Ùo
,

105 **
ouut
, 
size_t
 *
ouut_Ën
,

106 
¡d
::
funùiÚ
<*(
size_t
)> 
®loÿtÜ
)

107 : 
ouut_´Ùo_
{
ouut_´Ùo
},

108 
	g¡©us_´Ùo_
{
	g¡©us_´Ùo
},

109 
	gouut_
{
	gouut
},

110 
	gouut_Ën_
{
	gouut_Ën
},

111 
	gcu¡om_®loÿtÜ_
{
	g®loÿtÜ
} {}

116 
S”Ÿlize
(cÚ¡ 
Stus
 &
¡©us
) {

117 
	g¡©us
.
SaveTo
(
¡©us_´Ùo_
);

121 *
	gouut_Ën_
 = 
ouut_´Ùo_
->
By‹SizeLÚg
();

122 
	g¡d
::
unique_±r
<[]> 
Œu¡ed_ouut
(
Ãw
 [*
ouut_Ën_
]);

123 ià(!
	gouut_´Ùo_
->
S”ŸlizeToA¼ay
(
Œu¡ed_ouut
.
g‘
(), *
ouut_Ën_
)) {

124 *
	gouut_
 = 
nuÎ±r
;

125 *
	gouut_Ën_
 = 0;

126 
LogE¼Ü
(
¡©us
);

131 ià(
	gcu¡om_®loÿtÜ_
) {

132 *
	gouut_
 = 
»š‹½»t_ÿ¡
<*>(
cu¡om_®loÿtÜ_
(*
ouut_Ën_
));

135 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

136 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

137 *
	gouut_
 = 
»š‹½»t_ÿ¡
<*>(

138 
uÁru¡ed_ÿche_m®loc
->
M®loc
(*
ouut_Ën_
));

140 
memıy
(*
ouut_
, 
Œu¡ed_ouut
.
g‘
(), *
ouut_Ën_
);

144 
	g´iv©e
:

145 
OuutPrÙo
 
´Ùo
;

146 cÚ¡ 
OuutPrÙo
 *
	gouut_´Ùo_
;

147 
StusPrÙo
 *
	g¡©us_´Ùo_
;

148 **
	gouut_
;

149 
size_t
 *
	gouut_Ën_
;

150 
	g¡d
::
funùiÚ
<*(
size_t
)> 
cu¡om_®loÿtÜ_
;

155 
Stus
 
	gTru¡edAµliÿtiÚ
::
	$V”ifyAndS‘S‹
(cÚ¡ 
EnşaveS‹
 &
ex³ùed_¡©e
,

156 cÚ¡ 
EnşaveS‹
 &
Ãw_¡©e
) {

157 
ab¦
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

158 ià(
’şave_¡©e_
 !ğ
ex³ùed_¡©e
) {

159  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

160 ::
ab¦
::
	`SŒC©
("Enşavi š s‹: ", 
’şave_¡©e_
,

161 "ƒx³ùed s‹: ", 
ex³ùed_¡©e
));

163 
’şave_¡©e_
 = 
Ãw_¡©e
;

164  
Stus
::
	`OkStus
();

165 
	}
}

167 
EnşaveS‹
 
	gTru¡edAµliÿtiÚ
::
	$G‘S‹
() {

168 
ab¦
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

169  
’şave_¡©e_
;

170 
	}
}

172 
	gTru¡edAµliÿtiÚ
::
	$S‘S‹
(cÚ¡ 
EnşaveS‹
 &
¡©e
) {

173 
ab¦
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

174 
’şave_¡©e_
 = 
¡©e
;

175 
	}
}

177 
Stus
 
	$V”ifyOuutArgum’ts
(**
ouut
, 
size_t
 *
ouut_Ën
) {

178 ià(!
ouut
 || !
ouut_Ën
) {

179 
Stus
 
¡©us
 =

180 
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

182 
	`LogE¼Ü
(
¡©us
);

183  
¡©us
;

185  
Stus
::
	`OkStus
();

186 
	}
}

189 
Tru¡edAµliÿtiÚ
 *
	gglob®_Œu¡ed_­¶iÿtiÚ
 = 
nuÎ±r
;

192 
	gab¦
::
Mu‹x
 
g‘_­¶iÿtiÚ_lock
;

195 
In™ŸlizeIO
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
);

197 
Tru¡edAµliÿtiÚ
 *
	$G‘AµliÿtiÚIn¡ªû
() {

198 
ab¦
::
Mu‹xLock
 
	`lock
(&
g‘_­¶iÿtiÚ_lock
);

199 ià(!
glob®_Œu¡ed_­¶iÿtiÚ
) {

200 
glob®_Œu¡ed_­¶iÿtiÚ
 = 
	`BudTru¡edAµliÿtiÚ
();

202  
glob®_Œu¡ed_­¶iÿtiÚ
;

203 
	}
}

205 
Stus
 
In™ŸlizeEnvœÚm’tV¬ŸbËs
(

206 cÚ¡ 
R•—‹dPŒF›ld
<
EnvœÚm’tV¬ŸbË
> &
v¬ŸbËs
) {

207 cÚ¡‡utØ&
	gv¬ŸbË
 : 
v¬ŸbËs
) {

208 ià(!
v¬ŸbË
.
has_Çme
(è|| !v¬ŸbË.
has_v®ue
()) {

209  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

213 
£‹nv
(
v¬ŸbË
.
Çme
().
c_¡r
(), v¬ŸbË.
v®ue
().c_str(), 0);

215  
	gStus
::
OkStus
();

218 
Stus
 
	gTru¡edAµliÿtiÚ
::
	$In™ŸlizeIÁ”Çl
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

219 
	`In™ŸlizeIO
(
cÚfig
);

220 
Stus
 
¡©us
 =

221 
	`In™ŸlizeEnvœÚm’tV¬ŸbËs
(
cÚfig
.
	`’vœÚm’t_v¬ŸbËs
());

222 cÚ¡ *
log_dœeùÜy
 = 
cÚfig
.
	`loggšg_cÚfig
().
	`log_dœeùÜy
().
	`c_¡r
();

223 
vlog_Ëv–
 = 
cÚfig
.
	`loggšg_cÚfig
().
	`vlog_Ëv–
();

224 if(!
	`In™Loggšg
(
log_dœeùÜy
, 
	`G‘EnşaveName
().
	`c_¡r
(), 
vlog_Ëv–
)) {

225 
	`årštf
(
¡d”r
, "Initialization ofƒnclave†ogging failed\n");

227 ià(!
¡©us
.
	`ok
()) {

228 
	`LOG
(
WARNING
) << "Initialization ofƒnclaveƒnvironment variables failed: "

229 << 
¡©us
;

231 
	`S‘EnşaveCÚfig
(
cÚfig
);

233 
¡©us
 = 
	`In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

234 
cÚfig
.
	`’şave_as£¹iÚ_authÜ™y_cÚfigs
().
	`begš
(),

235 
cÚfig
.
	`’şave_as£¹iÚ_authÜ™y_cÚfigs
().
	`’d
());

236 ià(!
¡©us
.
	`ok
()) {

237 
	`LOG
(
WARNING
) << "Initialization ofƒnclave‡ssertion‡uthorities failed: "

238 << 
¡©us
;

241 
	`ASYLO_RETURN_IF_ERROR
(
	`V”ifyAndS‘S‹
(
EnşaveS‹
::
kIÁ”ÇlIn™Ÿlizšg
,

242 
EnşaveS‹
::
kU£rIn™Ÿlizšg
));

243  
	`In™Ÿlize
(
cÚfig
);

244 
	}
}

246 
	$In™ŸlizeIO
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

247 autØ&
io_mªag”
 = 
io
::
IOMªag”
::
	`G‘In¡ªû
();

252 ià(
cÚfig
.
	`¡dš_fd
() >= 0) {

253 
io_mªag”
.
	`Regi¡”Ho¡FeDesütÜ
(
cÚfig
.
	`¡dš_fd
());

255 ià(
cÚfig
.
	`¡dout_fd
() >= 0) {

256 
io_mªag”
.
	`Regi¡”Ho¡FeDesütÜ
(
cÚfig
.
	`¡dout_fd
());

258 ià(
cÚfig
.
	`¡d”r_fd
() >= 0) {

259 
io_mªag”
.
	`Regi¡”Ho¡FeDesütÜ
(
cÚfig
.
	`¡d”r_fd
());

265 
io_mªag”
.
	`Regi¡”Vœtu®P©hHªdËr
(

266 "", ::
ab¦
::
make_unique
<
io
::
N©iveP©hHªdËr
>());

270 
io_mªag”
.
	`Regi¡”Vœtu®P©hHªdËr
(

271 
RªdomP©hHªdËr
::
kRªdomP©h
, ::
ab¦
::
make_unique
<RandomPathHandler>());

272 
io_mªag”
.
	`Regi¡”Vœtu®P©hHªdËr
(

273 
RªdomP©hHªdËr
::
kURªdomP©h
,

274 ::
ab¦
::
make_unique
<
RªdomP©hHªdËr
>());

277 
io_mªag”
.
	`S‘Cu¼’tWÜkšgDœeùÜy
(
cÚfig
.
	`cu¼’t_wÜkšg_dœeùÜy
());

278 
	}
}

286 
__asylo_u£r_š™
(cÚ¡ *
Çme
, cÚ¡ *
cÚfig
, 
size_t
 
cÚfig_Ën
,

287 **
ouut
, 
size_t
 *
ouut_Ën
) {

290 
	sIn™CËª”
 {

291 
boŞ
 
’şave_was_š™Ÿlized
 = 
çl£
;

293 ~
In™CËª”
() {

294 ià(!
’şave_was_š™Ÿlized
) {

297 
d–‘e
 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

300 } 
š™_ş—Ãr
;

302 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

303 ià(!
¡©us
.
ok
()) {

307 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

309 
EnşaveCÚfig
 
’şave_cÚfig
;

310 ià(!
’şave_cÚfig
.
P¬£FromA¼ay
(
cÚfig
, 
cÚfig_Ën
)) {

311 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

313  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

316 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

317 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
V”ifyAndS‘S‹
(

318 
EnşaveS‹
::
kUnš™Ÿlized
, EnşaveS‹::
kIÁ”ÇlIn™Ÿlizšg
);

319 ià(!
¡©us
.
ok
()) {

320  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

323 
S‘EnşaveName
(
Çme
);

325 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
In™ŸlizeIÁ”Çl
(
’şave_cÚfig
);

326 ià(!
¡©us
.
ok
()) {

327 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kUnš™Ÿlized
);

328  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

331 
š™_ş—Ãr
.
’şave_was_š™Ÿlized
 = 
Œue
;

332 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kRuÂšg
);

333  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

336 
__asylo_u£r_run
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

337 
size_t
 *
ouut_Ën
) {

338 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

339 ià(!
¡©us
.
ok
()) {

343 
EnşaveOuut
 
’şave_ouut
;

344 
StusS”Ÿliz”
<
EnşaveOuut
> 
¡©us_£rŸliz”
(

345 &
’şave_ouut
,ƒnşave_ouut.
mubË_¡©us
(), 
ouut
, 
ouut_Ën
);

347 
EnşaveIÅut
 
’şave_šput
;

348 ià(!
’şave_šput
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

349 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

351  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

354 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

355 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

356 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

358  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

362 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
Run
(
’şave_šput
, &
’şave_ouut
);

363  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

366 
__asylo_u£r_fši
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

367 
size_t
 *
ouut_Ën
) {

368 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

369 ià(!
¡©us
.
ok
()) {

373 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

375 
asylo
::
EnşaveFš®
 
’şave_fš®
;

376 ià(!
’şave_fš®
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

377 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

379  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

382 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

383 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
V”ifyAndS‘S‹
(
EnşaveS‹
::
kRuÂšg
,

384 
EnşaveS‹
::
kFš®izšg
);

385 ià(!
¡©us
.
ok
()) {

386  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

390 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
Fš®ize
(
’şave_fš®
);

392 
Th»adMªag”
 *
th»ad_mªag”
 = Th»adMªag”::
G‘In¡ªû
();

393 
th»ad_mªag”
->
Fš®ize
();

397 
d–‘e
 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

399 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kFš®ized
);

400  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

403 
__asylo_th»adšg_dÚ©e
() {

404 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

405 
EnşaveS‹
 
cu¼’t_¡©e
 = 
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
();

406 ià(
cu¼’t_¡©e
 < 
EnşaveS‹
::
kU£rIn™Ÿlizšg
 ||

407 
cu¼’t_¡©e
 > 
EnşaveS‹
::
kFš®izšg
) {

408 
Stus
 
¡©us
 = Stus(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

410 
LOG
(
ERROR
è<< 
¡©us
;

411  
EPERM
;

414 
Th»adMªag”
 *
th»ad_mªag”
 = Th»adMªag”::
G‘In¡ªû
();

415  
th»ad_mªag”
->
S¹Th»ad
();

418 
__asylo_hªdË_sigÇl
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
) {

419 
asylo
::
EnşaveSigÇl
 
sigÇl
;

420 ià(!
sigÇl
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

423 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

424 
EnşaveS‹
 
cu¼’t_¡©e
 = 
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
();

425 ià(
cu¼’t_¡©e
 < 
EnşaveS‹
::
kRuÂšg
 ||

426 
cu¼’t_¡©e
 > 
EnşaveS‹
::
kFš®izšg
) {

429 
signum
 = 
FromBridgeSigÇl
(
sigÇl
.signum());

430 ià(
signum
 < 0) {

433 
sigšfo_t
 
šfo
;

434 
šfo
.
si_signo
 = 
signum
;

435 
šfo
.
si_code
 = 
sigÇl
.
code
();

436 
ucÚ‹xt_t
 
ucÚ‹xt
;

437 
g»g_šdex
 = 0;

438 
g»g_šdex
 < 
NGREG
 && g»g_šdex < 
sigÇl
.
g»gs_size
(); ++greg_index) {

439 
ucÚ‹xt
.
uc_mcÚ‹xt
.
g»gs
[
g»g_šdex
] =

440 
¡©ic_ÿ¡
<
g»g_t
>(
sigÇl
.
g»gs
(
g»g_šdex
));

442 
SigÇlMªag”
 *
sigÇl_mªag”
 = SigÇlMªag”::
G‘In¡ªû
();

443 cÚ¡ 
sig£t_t
 
mask
 = 
sigÇl_mªag”
->
G‘SigÇlMask
();

447 ià(
sigismemb”
(&
mask
, 
signum
)) {

450 ià(!
sigÇl_mªag”
->
HªdËSigÇl
(
signum
, &
šfo
, &
ucÚ‹xt
).
ok
()) {

456 
__asylo_ke_¢­shÙ
(**
ouut
, 
size_t
 *
ouut_Ën
) {

457 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

458 ià(!
¡©us
.
ok
()) {

461 
EnşaveOuut
 
’şave_ouut
;

465 
StusS”Ÿliz”
<
EnşaveOuut
> 
¡©us_£rŸliz”
(

466 &
’şave_ouut
,ƒnşave_ouut.
mubË_¡©us
(), 
ouut
, 
ouut_Ën
,

467 &
’c_uÁru¡ed_m®loc
);

469 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

470 
asylo
::
G‘EnşaveCÚfig
();

472 ià(!
cÚfig_»suÉ
.
ok
()) {

473  
¡©us_£rŸliz”
.
S”Ÿlize
(
cÚfig_»suÉ
.
¡©us
());

476 cÚ¡ 
asylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

477 ià(!
cÚfig
->
has_’abË_fÜk
(è|| !cÚfig->
’abË_fÜk
()) {

478 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

480  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

483 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

484 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

485 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

487  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

489 ià(
g‘_aùive_’şave_’Œ›s
() > 2) {

490 
LOG
(
WARNING
è<< "Th”¬" << 
g‘_aùive_’şave_’Œ›s
()

495 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

497  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

500 
SÇpshÙLayout
 
¢­shÙ_Ïyout
;

501 
¡©us
 = 
TakeSÇpshÙFÜFÜk
(&
¢­shÙ_Ïyout
);

502 *
’şave_ouut
.
MubËEx‹nsiÚ
(
¢­shÙ
èğ
¢­shÙ_Ïyout
;

503  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

506 
__asylo_»¡Üe
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

507 
size_t
 *
ouut_Ën
) {

508 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

509 ià(!
¡©us
.
ok
()) {

513 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

515 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

516 
asylo
::
G‘EnşaveCÚfig
();

518 ià(!
cÚfig_»suÉ
.
ok
()) {

519  
¡©us_£rŸliz”
.
S”Ÿlize
(
cÚfig_»suÉ
.
¡©us
());

522 cÚ¡ 
asylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

523 ià(!
cÚfig
->
has_’abË_fÜk
(è|| !cÚfig->
’abË_fÜk
()) {

524 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

526  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

529 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

530 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

531 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

533  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

542 
¡©us
 = 
Re¡ÜeFÜFÜk
(
šput
, 
šput_Ën
);

544 ià(!
¡©us
.
ok
()) {

546 
Th»adMªag”
 *
th»ad_mªag”
 = Th»adMªag”::
G‘In¡ªû
();

547 
th»ad_mªag”
->
Fš®ize
();

551 
d–‘e
 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

552 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kFš®ized
);

555  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

558 
__asylo_Œªsãr_£cu»_¢­shÙ_key
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

559 **
ouut
, 
size_t
 *
ouut_Ën
) {

560 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

561 ià(!
¡©us
.
ok
()) {

565 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

567 
asylo
::
FÜkHªdshakeCÚfig
 
fÜk_hªdshake_cÚfig
;

568 ià(!
fÜk_hªdshake_cÚfig
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

569 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

571  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

574 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

575 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

576 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

578  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

581 
¡©us
 = 
T¿nsãrSecu»SÇpshÙKey
(
fÜk_hªdshake_cÚfig
);

582  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

589 "C" 
Prim™iveStus
 
	$’c_š™
(è{  
Prim™iveStus
::
	`OkStus
(); 
	}
}

	@platform/core/trusted_application.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_­¶iÿtiÚ.h
"

21 
	~<sys/ucÚ‹xt.h
>

22 
	~<uni¡d.h
>

24 
	~<û¼no
>

25 
	~<c¡dio
>

26 
	~<c¡dlib
>

27 
	~<funùiÚ®
>

28 
	~<¡ršg
>

30 
	~"ab¦/memÜy/memÜy.h
"

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
	~"asylo/ut/loggšg.h
"

34 
	~"asylo/id’t™y/š™.h
"

35 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

36 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

37 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/time.h
"

38 
	~"asylo/¶©fÜm/commÚ/bridge_funùiÚs.h
"

39 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme_kšd.h
"

40 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

41 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

42 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

43 
	~"asylo/¶©fÜm/posix/io/Çtive_·ths.h
"

44 
	~"asylo/¶©fÜm/posix/io/¿ndom_deviûs.h
"

45 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

46 
	~"asylo/¶©fÜm/posix/th»adšg/th»ad_mªag”.h
"

47 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

48 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

49 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

50 
	~"asylo/ut/¡©us.h
"

51 
	~"asylo/ut/¡©us_maüos.h
"

53 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

54 
usšg
 
	gEnşaveS‹
 = ::
asylo
::
Tru¡edAµliÿtiÚ
::
S‹
;

55 
usšg
 
	ggoogË
::
´Ùobuf
::
R•—‹dPŒF›ld
;

57 
Çme¥aû
 
	gasylo
 {

58 
	gÇme¥aû
 {

60 
LogE¼Ü
(cÚ¡ 
Stus
 &
¡©us
) {

61 
EnşaveS‹
 
	g¡©e
 = 
G‘AµliÿtiÚIn¡ªû
()->
G‘S‹
();

62 ià(
	g¡©e
 < 
	gEnşaveS‹
::
kU£rIn™Ÿlizšg
) {

65 
’c_uÁru¡ed_puts
(
¡©us
.
ToSŒšg
().
c_¡r
());

67 
LOG
(
ERROR
è<< 
	g¡©us
;

75 
	g‹m¶©e
 <
şass
 
	gOuutPrÙo
>

76 şas 
	cStusS”Ÿliz”
 {

77 
	gpublic
:

82 
StusS”Ÿliz”
(cÚ¡ 
OuutPrÙo
 *
ouut_´Ùo
, 
StusPrÙo
 *
¡©us_´Ùo
,

83 **
ouut
, 
size_t
 *
ouut_Ën
)

84 : 
ouut_´Ùo_
{
ouut_´Ùo
},

85 
	g¡©us_´Ùo_
{
	g¡©us_´Ùo
},

86 
	gouut_
{
	gouut
},

87 
	gouut_Ën_
{
	gouut_Ën
},

88 
	gcu¡om_®loÿtÜ_
{
	gnuÎ±r
} {}

93 
StusS”Ÿliz”
(**
ouut
, 
size_t
 *
ouut_Ën
)

94 : 
ouut_´Ùo_
{&
´Ùo
},

95 
	g¡©us_´Ùo_
{&
	g´Ùo
},

96 
	gouut_
{
	gouut
},

97 
	gouut_Ën_
{
	gouut_Ën
},

98 
	gcu¡om_®loÿtÜ_
{
	gnuÎ±r
} {}

104 
StusS”Ÿliz”
(cÚ¡ 
OuutPrÙo
 *
ouut_´Ùo
, 
StusPrÙo
 *
¡©us_´Ùo
,

105 **
ouut
, 
size_t
 *
ouut_Ën
,

106 
¡d
::
funùiÚ
<*(
size_t
)> 
®loÿtÜ
)

107 : 
ouut_´Ùo_
{
ouut_´Ùo
},

108 
	g¡©us_´Ùo_
{
	g¡©us_´Ùo
},

109 
	gouut_
{
	gouut
},

110 
	gouut_Ën_
{
	gouut_Ën
},

111 
	gcu¡om_®loÿtÜ_
{
	g®loÿtÜ
} {}

116 
S”Ÿlize
(cÚ¡ 
Stus
 &
¡©us
) {

117 
	g¡©us
.
SaveTo
(
¡©us_´Ùo_
);

121 *
	gouut_Ën_
 = 
ouut_´Ùo_
->
By‹SizeLÚg
();

122 
	g¡d
::
unique_±r
<[]> 
Œu¡ed_ouut
(
Ãw
 [*
ouut_Ën_
]);

123 ià(!
	gouut_´Ùo_
->
S”ŸlizeToA¼ay
(
Œu¡ed_ouut
.
g‘
(), *
ouut_Ën_
)) {

124 *
	gouut_
 = 
nuÎ±r
;

125 *
	gouut_Ën_
 = 0;

126 
LogE¼Ü
(
¡©us
);

131 ià(
	gcu¡om_®loÿtÜ_
) {

132 *
	gouut_
 = 
»š‹½»t_ÿ¡
<*>(
cu¡om_®loÿtÜ_
(*
ouut_Ën_
));

135 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

136 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

137 *
	gouut_
 = 
»š‹½»t_ÿ¡
<*>(

138 
uÁru¡ed_ÿche_m®loc
->
M®loc
(*
ouut_Ën_
));

140 
memıy
(*
ouut_
, 
Œu¡ed_ouut
.
g‘
(), *
ouut_Ën_
);

144 
	g´iv©e
:

145 
OuutPrÙo
 
´Ùo
;

146 cÚ¡ 
OuutPrÙo
 *
	gouut_´Ùo_
;

147 
StusPrÙo
 *
	g¡©us_´Ùo_
;

148 **
	gouut_
;

149 
size_t
 *
	gouut_Ën_
;

150 
	g¡d
::
funùiÚ
<*(
size_t
)> 
cu¡om_®loÿtÜ_
;

155 
Stus
 
	gTru¡edAµliÿtiÚ
::
	$V”ifyAndS‘S‹
(cÚ¡ 
EnşaveS‹
 &
ex³ùed_¡©e
,

156 cÚ¡ 
EnşaveS‹
 &
Ãw_¡©e
) {

157 
ab¦
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

158 ià(
’şave_¡©e_
 !ğ
ex³ùed_¡©e
) {

159  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

160 ::
ab¦
::
	`SŒC©
("Enşavi š s‹: ", 
’şave_¡©e_
,

161 "ƒx³ùed s‹: ", 
ex³ùed_¡©e
));

163 
’şave_¡©e_
 = 
Ãw_¡©e
;

164  
Stus
::
	`OkStus
();

165 
	}
}

167 
EnşaveS‹
 
	gTru¡edAµliÿtiÚ
::
	$G‘S‹
() {

168 
ab¦
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

169  
’şave_¡©e_
;

170 
	}
}

172 
	gTru¡edAµliÿtiÚ
::
	$S‘S‹
(cÚ¡ 
EnşaveS‹
 &
¡©e
) {

173 
ab¦
::
Mu‹xLock
 
	`lock
(&
mu‹x_
);

174 
’şave_¡©e_
 = 
¡©e
;

175 
	}
}

177 
Stus
 
	$V”ifyOuutArgum’ts
(**
ouut
, 
size_t
 *
ouut_Ën
) {

178 ià(!
ouut
 || !
ouut_Ën
) {

179 
Stus
 
¡©us
 =

180 
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

182 
	`LogE¼Ü
(
¡©us
);

183  
¡©us
;

185  
Stus
::
	`OkStus
();

186 
	}
}

189 
Tru¡edAµliÿtiÚ
 *
	gglob®_Œu¡ed_­¶iÿtiÚ
 = 
nuÎ±r
;

192 
	gab¦
::
Mu‹x
 
g‘_­¶iÿtiÚ_lock
;

195 
In™ŸlizeIO
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
);

197 
Tru¡edAµliÿtiÚ
 *
	$G‘AµliÿtiÚIn¡ªû
() {

198 
ab¦
::
Mu‹xLock
 
	`lock
(&
g‘_­¶iÿtiÚ_lock
);

199 ià(!
glob®_Œu¡ed_­¶iÿtiÚ
) {

200 
glob®_Œu¡ed_­¶iÿtiÚ
 = 
	`BudTru¡edAµliÿtiÚ
();

202  
glob®_Œu¡ed_­¶iÿtiÚ
;

203 
	}
}

205 
Stus
 
In™ŸlizeEnvœÚm’tV¬ŸbËs
(

206 cÚ¡ 
R•—‹dPŒF›ld
<
EnvœÚm’tV¬ŸbË
> &
v¬ŸbËs
) {

207 cÚ¡‡utØ&
	gv¬ŸbË
 : 
v¬ŸbËs
) {

208 ià(!
v¬ŸbË
.
has_Çme
(è|| !v¬ŸbË.
has_v®ue
()) {

209  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

213 
£‹nv
(
v¬ŸbË
.
Çme
().
c_¡r
(), v¬ŸbË.
v®ue
().c_str(), 0);

215  
	gStus
::
OkStus
();

218 
Stus
 
	gTru¡edAµliÿtiÚ
::
	$In™ŸlizeIÁ”Çl
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

219 
	`In™ŸlizeIO
(
cÚfig
);

220 
Stus
 
¡©us
 =

221 
	`In™ŸlizeEnvœÚm’tV¬ŸbËs
(
cÚfig
.
	`’vœÚm’t_v¬ŸbËs
());

222 cÚ¡ *
log_dœeùÜy
 = 
cÚfig
.
	`loggšg_cÚfig
().
	`log_dœeùÜy
().
	`c_¡r
();

223 
vlog_Ëv–
 = 
cÚfig
.
	`loggšg_cÚfig
().
	`vlog_Ëv–
();

224 if(!
	`In™Loggšg
(
log_dœeùÜy
, 
	`G‘EnşaveName
().
	`c_¡r
(), 
vlog_Ëv–
)) {

225 
	`årštf
(
¡d”r
, "Initialization ofƒnclave†ogging failed\n");

227 ià(!
¡©us
.
	`ok
()) {

228 
	`LOG
(
WARNING
) << "Initialization ofƒnclaveƒnvironment variables failed: "

229 << 
¡©us
;

231 
	`S‘EnşaveCÚfig
(
cÚfig
);

233 
¡©us
 = 
	`In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

234 
cÚfig
.
	`’şave_as£¹iÚ_authÜ™y_cÚfigs
().
	`begš
(),

235 
cÚfig
.
	`’şave_as£¹iÚ_authÜ™y_cÚfigs
().
	`’d
());

236 ià(!
¡©us
.
	`ok
()) {

237 
	`LOG
(
WARNING
) << "Initialization ofƒnclave‡ssertion‡uthorities failed: "

238 << 
¡©us
;

241 
	`ASYLO_RETURN_IF_ERROR
(
	`V”ifyAndS‘S‹
(
EnşaveS‹
::
kIÁ”ÇlIn™Ÿlizšg
,

242 
EnşaveS‹
::
kU£rIn™Ÿlizšg
));

243  
	`In™Ÿlize
(
cÚfig
);

244 
	}
}

246 
	$In™ŸlizeIO
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

247 autØ&
io_mªag”
 = 
io
::
IOMªag”
::
	`G‘In¡ªû
();

252 ià(
cÚfig
.
	`¡dš_fd
() >= 0) {

253 
io_mªag”
.
	`Regi¡”Ho¡FeDesütÜ
(
cÚfig
.
	`¡dš_fd
());

255 ià(
cÚfig
.
	`¡dout_fd
() >= 0) {

256 
io_mªag”
.
	`Regi¡”Ho¡FeDesütÜ
(
cÚfig
.
	`¡dout_fd
());

258 ià(
cÚfig
.
	`¡d”r_fd
() >= 0) {

259 
io_mªag”
.
	`Regi¡”Ho¡FeDesütÜ
(
cÚfig
.
	`¡d”r_fd
());

265 
io_mªag”
.
	`Regi¡”Vœtu®P©hHªdËr
(

266 "", ::
ab¦
::
make_unique
<
io
::
N©iveP©hHªdËr
>());

270 
io_mªag”
.
	`Regi¡”Vœtu®P©hHªdËr
(

271 
RªdomP©hHªdËr
::
kRªdomP©h
, ::
ab¦
::
make_unique
<RandomPathHandler>());

272 
io_mªag”
.
	`Regi¡”Vœtu®P©hHªdËr
(

273 
RªdomP©hHªdËr
::
kURªdomP©h
,

274 ::
ab¦
::
make_unique
<
RªdomP©hHªdËr
>());

277 
io_mªag”
.
	`S‘Cu¼’tWÜkšgDœeùÜy
(
cÚfig
.
	`cu¼’t_wÜkšg_dœeùÜy
());

278 
	}
}

286 
__asylo_u£r_š™
(cÚ¡ *
Çme
, cÚ¡ *
cÚfig
, 
size_t
 
cÚfig_Ën
,

287 **
ouut
, 
size_t
 *
ouut_Ën
) {

290 
	sIn™CËª”
 {

291 
boŞ
 
’şave_was_š™Ÿlized
 = 
çl£
;

293 ~
In™CËª”
() {

294 ià(!
’şave_was_š™Ÿlized
) {

297 
d–‘e
 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

300 } 
š™_ş—Ãr
;

302 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

303 ià(!
¡©us
.
ok
()) {

307 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

309 
EnşaveCÚfig
 
’şave_cÚfig
;

310 ià(!
’şave_cÚfig
.
P¬£FromA¼ay
(
cÚfig
, 
cÚfig_Ën
)) {

311 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

313  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

316 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

317 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
V”ifyAndS‘S‹
(

318 
EnşaveS‹
::
kUnš™Ÿlized
, EnşaveS‹::
kIÁ”ÇlIn™Ÿlizšg
);

319 ià(!
¡©us
.
ok
()) {

320  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

323 
S‘EnşaveName
(
Çme
);

325 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
In™ŸlizeIÁ”Çl
(
’şave_cÚfig
);

326 ià(!
¡©us
.
ok
()) {

327 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kUnš™Ÿlized
);

328  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

331 
š™_ş—Ãr
.
’şave_was_š™Ÿlized
 = 
Œue
;

332 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kRuÂšg
);

333  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

336 
__asylo_u£r_run
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

337 
size_t
 *
ouut_Ën
) {

338 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

339 ià(!
¡©us
.
ok
()) {

343 
EnşaveOuut
 
’şave_ouut
;

344 
StusS”Ÿliz”
<
EnşaveOuut
> 
¡©us_£rŸliz”
(

345 &
’şave_ouut
,ƒnşave_ouut.
mubË_¡©us
(), 
ouut
, 
ouut_Ën
);

347 
EnşaveIÅut
 
’şave_šput
;

348 ià(!
’şave_šput
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

349 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

351  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

354 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

355 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

356 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

358  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

362 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
Run
(
’şave_šput
, &
’şave_ouut
);

363  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

366 
__asylo_u£r_fši
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

367 
size_t
 *
ouut_Ën
) {

368 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

369 ià(!
¡©us
.
ok
()) {

373 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

375 
asylo
::
EnşaveFš®
 
’şave_fš®
;

376 ià(!
’şave_fš®
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

377 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

379  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

382 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

383 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
V”ifyAndS‘S‹
(
EnşaveS‹
::
kRuÂšg
,

384 
EnşaveS‹
::
kFš®izšg
);

385 ià(!
¡©us
.
ok
()) {

386  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

390 
¡©us
 = 
Œu¡ed_­¶iÿtiÚ
->
Fš®ize
(
’şave_fš®
);

392 
Th»adMªag”
 *
th»ad_mªag”
 = Th»adMªag”::
G‘In¡ªû
();

393 
th»ad_mªag”
->
Fš®ize
();

397 
d–‘e
 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

399 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kFš®ized
);

400  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

403 
__asylo_th»adšg_dÚ©e
() {

404 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

405 
EnşaveS‹
 
cu¼’t_¡©e
 = 
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
();

406 ià(
cu¼’t_¡©e
 < 
EnşaveS‹
::
kU£rIn™Ÿlizšg
 ||

407 
cu¼’t_¡©e
 > 
EnşaveS‹
::
kFš®izšg
) {

408 
Stus
 
¡©us
 = Stus(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

410 
LOG
(
ERROR
è<< 
¡©us
;

411  
EPERM
;

414 
Th»adMªag”
 *
th»ad_mªag”
 = Th»adMªag”::
G‘In¡ªû
();

415  
th»ad_mªag”
->
S¹Th»ad
();

418 
__asylo_hªdË_sigÇl
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
) {

419 
asylo
::
EnşaveSigÇl
 
sigÇl
;

420 ià(!
sigÇl
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

423 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

424 
EnşaveS‹
 
cu¼’t_¡©e
 = 
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
();

425 ià(
cu¼’t_¡©e
 < 
EnşaveS‹
::
kRuÂšg
 ||

426 
cu¼’t_¡©e
 > 
EnşaveS‹
::
kFš®izšg
) {

429 
signum
 = 
FromBridgeSigÇl
(
sigÇl
.signum());

430 ià(
signum
 < 0) {

433 
sigšfo_t
 
šfo
;

434 
šfo
.
si_signo
 = 
signum
;

435 
šfo
.
si_code
 = 
sigÇl
.
code
();

436 
ucÚ‹xt_t
 
ucÚ‹xt
;

437 
g»g_šdex
 = 0;

438 
g»g_šdex
 < 
NGREG
 && g»g_šdex < 
sigÇl
.
g»gs_size
(); ++greg_index) {

439 
ucÚ‹xt
.
uc_mcÚ‹xt
.
g»gs
[
g»g_šdex
] =

440 
¡©ic_ÿ¡
<
g»g_t
>(
sigÇl
.
g»gs
(
g»g_šdex
));

442 
SigÇlMªag”
 *
sigÇl_mªag”
 = SigÇlMªag”::
G‘In¡ªû
();

443 cÚ¡ 
sig£t_t
 
mask
 = 
sigÇl_mªag”
->
G‘SigÇlMask
();

447 ià(
sigismemb”
(&
mask
, 
signum
)) {

450 ià(!
sigÇl_mªag”
->
HªdËSigÇl
(
signum
, &
šfo
, &
ucÚ‹xt
).
ok
()) {

456 
__asylo_ke_¢­shÙ
(**
ouut
, 
size_t
 *
ouut_Ën
) {

457 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

458 ià(!
¡©us
.
ok
()) {

461 
EnşaveOuut
 
’şave_ouut
;

465 
StusS”Ÿliz”
<
EnşaveOuut
> 
¡©us_£rŸliz”
(

466 &
’şave_ouut
,ƒnşave_ouut.
mubË_¡©us
(), 
ouut
, 
ouut_Ën
,

467 &
’c_uÁru¡ed_m®loc
);

469 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

470 
asylo
::
G‘EnşaveCÚfig
();

472 ià(!
cÚfig_»suÉ
.
ok
()) {

473  
¡©us_£rŸliz”
.
S”Ÿlize
(
cÚfig_»suÉ
.
¡©us
());

476 cÚ¡ 
asylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

477 ià(!
cÚfig
->
has_’abË_fÜk
(è|| !cÚfig->
’abË_fÜk
()) {

478 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

480  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

483 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

484 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

485 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

487  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

489 ià(
g‘_aùive_’şave_’Œ›s
() > 2) {

490 
LOG
(
WARNING
è<< "Th”¬" << 
g‘_aùive_’şave_’Œ›s
()

495 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

497  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

500 
SÇpshÙLayout
 
¢­shÙ_Ïyout
;

501 
¡©us
 = 
TakeSÇpshÙFÜFÜk
(&
¢­shÙ_Ïyout
);

502 *
’şave_ouut
.
MubËEx‹nsiÚ
(
¢­shÙ
èğ
¢­shÙ_Ïyout
;

503  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

506 
__asylo_»¡Üe
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

507 
size_t
 *
ouut_Ën
) {

508 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

509 ià(!
¡©us
.
ok
()) {

513 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

515 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

516 
asylo
::
G‘EnşaveCÚfig
();

518 ià(!
cÚfig_»suÉ
.
ok
()) {

519  
¡©us_£rŸliz”
.
S”Ÿlize
(
cÚfig_»suÉ
.
¡©us
());

522 cÚ¡ 
asylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

523 ià(!
cÚfig
->
has_’abË_fÜk
(è|| !cÚfig->
’abË_fÜk
()) {

524 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

526  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

529 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

530 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

531 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

533  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

542 
¡©us
 = 
Re¡ÜeFÜFÜk
(
šput
, 
šput_Ën
);

544 ià(!
¡©us
.
ok
()) {

546 
Th»adMªag”
 *
th»ad_mªag”
 = Th»adMªag”::
G‘In¡ªû
();

547 
th»ad_mªag”
->
Fš®ize
();

551 
d–‘e
 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

552 
Œu¡ed_­¶iÿtiÚ
->
S‘S‹
(
EnşaveS‹
::
kFš®ized
);

555  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

558 
__asylo_Œªsãr_£cu»_¢­shÙ_key
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

559 **
ouut
, 
size_t
 *
ouut_Ën
) {

560 
Stus
 
¡©us
 = 
V”ifyOuutArgum’ts
(
ouut
, 
ouut_Ën
);

561 ià(!
¡©us
.
ok
()) {

565 
StusS”Ÿliz”
<
StusPrÙo
> 
¡©us_£rŸliz”
(
ouut
, 
ouut_Ën
);

567 
asylo
::
FÜkHªdshakeCÚfig
 
fÜk_hªdshake_cÚfig
;

568 ià(!
fÜk_hªdshake_cÚfig
.
P¬£FromA¼ay
(
šput
, 
šput_Ën
)) {

569 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

571  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

574 
Tru¡edAµliÿtiÚ
 *
Œu¡ed_­¶iÿtiÚ
 = 
G‘AµliÿtiÚIn¡ªû
();

575 ià(
Œu¡ed_­¶iÿtiÚ
->
G‘S‹
(è!ğ
EnşaveS‹
::
kRuÂšg
) {

576 
¡©us
 = 
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

578  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

581 
¡©us
 = 
T¿nsãrSecu»SÇpshÙKey
(
fÜk_hªdshake_cÚfig
);

582  
¡©us_£rŸliz”
.
S”Ÿlize
(
¡©us
);

589 "C" 
Prim™iveStus
 
	$’c_š™
(è{  
Prim™iveStus
::
	`OkStus
(); 
	}
}

	@platform/core/trusted_application.h

19 #iâdeà
ASYLO_PLATFORM_CORE_TRUSTED_APPLICATION_H_


20 
	#ASYLO_PLATFORM_CORE_TRUSTED_APPLICATION_H_


	)

24 
	~<¡ršg
>

26 
	~"asylo/’şave.pb.h
"

27 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

28 
	~"asylo/¶©fÜm/cÜe/’Œy_pošts.h
"

29 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

30 
	~"asylo/ut/¡©us.h
"

32 
Çme¥aû
 
	gasylo
 {

72 şas 
	cTru¡edAµliÿtiÚ
 {

73 
	gpublic
:

75 şas 
	cS‹
 {

77 
kUnš™Ÿlized
,

79 
	gkIÁ”ÇlIn™Ÿlizšg
,

82 
	gkU£rIn™Ÿlizšg
,

84 
	gkRuÂšg
,

86 
	gkFš®izšg
,

88 
	gkFš®ized
,

92 
Stus
 
In™ŸlizeIÁ”Çl
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
);

99 
vœtu®
 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

100  
	gStus
::
OkStus
();

109 
vœtu®
 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

110  
	gStus
::
OkStus
();

118 
vœtu®
 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

119  
	gStus
::
OkStus
();

127 
	gvœtu®
 ~
Tru¡edAµliÿtiÚ
() = ;

130 
S‹
 
G‘S‹
(è
LOCKS_EXCLUDED
(
mu‹x_
);

132 
	g´iv©e
:

134 
S‹
 
’şave_¡©e_
 
GUARDED_BY
(
mu‹x_
èğS‹::
kUnš™Ÿlized
;

135 
	gab¦
::
Mu‹x
 
mu‹x_
;

139 
	gasylo
::
Stus
 
V”ifyAndS‘S‹
(cÚ¡ 
S‹
 &
ex³ùed_¡©e
,

140 cÚ¡ 
S‹
 &
Ãw_¡©e
)

141 
LOCKS_EXCLUDED
(
mu‹x_
);

144 
S‘S‹
(cÚ¡ 
S‹
 &
¡©e
è
LOCKS_EXCLUDED
(
mu‹x_
);

146 
ä›nd
 
__asylo_u£r_š™
(cÚ¡ *
Çme
, cÚ¡ *
cÚfig
,

147 
size_t
 
cÚfig_Ën
, **
ouut
,

148 
size_t
 *
ouut_Ën
);

149 
ä›nd
 
__asylo_u£r_run
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

150 **
ouut
, 
size_t
 *
ouut_Ën
);

151 
ä›nd
 
__asylo_u£r_fši
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
,

152 **
ouut
, 
size_t
 *
ouut_Ën
);

153 
ä›nd
 
__asylo_th»adšg_dÚ©e
();

154 
ä›nd
 
__asylo_hªdË_sigÇl
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
);

155 
ä›nd
 
__asylo_ke_¢­shÙ
(**
ouut
, 
size_t
 *
ouut_Ën
);

156 
ä›nd
 
__asylo_»¡Üe
(cÚ¡ *
šput
, 
size_t
 
šput_Ën
, **
ouut
,

157 
size_t
 *
ouut_Ën
);

158 
ä›nd
 
__asylo_Œªsãr_£cu»_¢­shÙ_key
(cÚ¡ *
šput
,

159 
size_t
 
šput_Ën
,

160 **
ouut
,

161 
size_t
 *
ouut_Ën
);

168 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
();

174 
Tru¡edAµliÿtiÚ
 *
G‘AµliÿtiÚIn¡ªû
();

	@platform/core/trusted_global_state.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

21 
Çme¥aû
 
	gasylo
 {

24 
	g¡d
::
¡ršg
 *
glob®_’şave_Çme
 = 
nuÎ±r
;

27 
	gasylo
::
EnşaveCÚfig
 *
glob®_’şave_cÚfig
 = 
nuÎ±r
;

29 
S‘EnşaveName
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

30 
d–‘e
 
glob®_’şave_Çme
;

31 
	gglob®_’şave_Çme
 = 
Ãw
 
¡d
::
¡ršg
(
Çme
);

34 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveName
(è{  *
glob®_’şave_Çme
; }

36 
Stus
 
S‘EnşaveCÚfig
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

39 ià(
	gglob®_’şave_cÚfig
) {

40  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

43 
	gglob®_’şave_cÚfig
 = 
Ãw
 
EnşaveCÚfig
(
cÚfig
);

44  
	gStus
::
OkStus
();

47 
	gStusOr
<cÚ¡ 
	gEnşaveCÚfig
 *> 
G‘EnşaveCÚfig
() {

48 ià(!
	gglob®_’şave_cÚfig
) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

53  
	gglob®_’şave_cÚfig
;

	@platform/core/trusted_global_state.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

21 
Çme¥aû
 
	gasylo
 {

24 
	g¡d
::
¡ršg
 *
glob®_’şave_Çme
 = 
nuÎ±r
;

27 
	gasylo
::
EnşaveCÚfig
 *
glob®_’şave_cÚfig
 = 
nuÎ±r
;

29 
S‘EnşaveName
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

30 
d–‘e
 
glob®_’şave_Çme
;

31 
	gglob®_’şave_Çme
 = 
Ãw
 
¡d
::
¡ršg
(
Çme
);

34 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveName
(è{  *
glob®_’şave_Çme
; }

36 
Stus
 
S‘EnşaveCÚfig
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

39 ià(
	gglob®_’şave_cÚfig
) {

40  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

43 
	gglob®_’şave_cÚfig
 = 
Ãw
 
EnşaveCÚfig
(
cÚfig
);

44  
	gStus
::
OkStus
();

47 
	gStusOr
<cÚ¡ 
	gEnşaveCÚfig
 *> 
G‘EnşaveCÚfig
() {

48 ià(!
	gglob®_’şave_cÚfig
) {

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

53  
	gglob®_’şave_cÚfig
;

	@platform/core/trusted_global_state.h

19 #iâdeà
ASYLO_PLATFORM_CORE_TRUSTED_GLOBAL_STATE_H_


20 
	#ASYLO_PLATFORM_CORE_TRUSTED_GLOBAL_STATE_H_


	)

24 
	~<¡ršg
>

26 
	~"asylo/’şave.pb.h
"

27 
	~"asylo/ut/¡©us.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

34 
S‘EnşaveName
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
);

38 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveName
();

42 
Stus
 
S‘EnşaveCÚfig
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
);

47 
	gStusOr
<cÚ¡ 
	gEnşaveCÚfig
 *> 
G‘EnşaveCÚfig
();

	@platform/core/trusted_mutex.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_mu‹x.h
"

21 
	~<c¡dio
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

27 
Çme¥aû
 
	gasylo
 {

29 
	gTru¡edMu‹x
::
Tru¡edMu‹x
(
boŞ
 
is_»cursive
)

30 : 
uÁru¡ed_mu‹x_
(
is_»cursive
), 
Œu¡ed_¥š_lock_
(is_recursive) {}

32 
	gTru¡edMu‹x
::
Lock
() {

33 
uÁru¡ed_mu‹x_
.
Lock
();

34 ià(!
	gŒu¡ed_¥š_lock_
.
TryLock
()) {

35 
abÜt
();

39 
boŞ
 
	gTru¡edMu‹x
::
OwÃd
(ècÚ¡ {  
Œu¡ed_¥š_lock_
.Owned(); }

41 
boŞ
 
	gTru¡edMu‹x
::
TryLock
() {

42 ià(!
uÁru¡ed_mu‹x_
.
TryLock
()) {

43  
çl£
;

46 ià(!
	gŒu¡ed_¥š_lock_
.
TryLock
()) {

47 
’c_uÁru¡ed_puts
(

50 
abÜt
();

52  
	gŒue
;

55 
	gTru¡edMu‹x
::
UÆock
() {

56 
Œu¡ed_¥š_lock_
.
UÆock
();

57 
	guÁru¡ed_mu‹x_
.
UÆock
();

	@platform/core/trusted_mutex.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_mu‹x.h
"

21 
	~<c¡dio
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

27 
Çme¥aû
 
	gasylo
 {

29 
	gTru¡edMu‹x
::
Tru¡edMu‹x
(
boŞ
 
is_»cursive
)

30 : 
uÁru¡ed_mu‹x_
(
is_»cursive
), 
Œu¡ed_¥š_lock_
(is_recursive) {}

32 
	gTru¡edMu‹x
::
Lock
() {

33 
uÁru¡ed_mu‹x_
.
Lock
();

34 ià(!
	gŒu¡ed_¥š_lock_
.
TryLock
()) {

35 
abÜt
();

39 
boŞ
 
	gTru¡edMu‹x
::
OwÃd
(ècÚ¡ {  
Œu¡ed_¥š_lock_
.Owned(); }

41 
boŞ
 
	gTru¡edMu‹x
::
TryLock
() {

42 ià(!
uÁru¡ed_mu‹x_
.
TryLock
()) {

43  
çl£
;

46 ià(!
	gŒu¡ed_¥š_lock_
.
TryLock
()) {

47 
’c_uÁru¡ed_puts
(

50 
abÜt
();

52  
	gŒue
;

55 
	gTru¡edMu‹x
::
UÆock
() {

56 
Œu¡ed_¥š_lock_
.
UÆock
();

57 
	guÁru¡ed_mu‹x_
.
UÆock
();

	@platform/core/trusted_mutex.h

19 #iâdeà
ASYLO_PLATFORM_CORE_TRUSTED_MUTEX_H_


20 
	#ASYLO_PLATFORM_CORE_TRUSTED_MUTEX_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_¥š_lock.h
"

25 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_mu‹x.h
"

27 
Çme¥aû
 
	gasylo
 {

35 şas 
	cTru¡edMu‹x
 {

36 
	gpublic
:

42 
ex¶ic™
 
Tru¡edMu‹x
(
boŞ
 
is_»cursive
);

44 ~
Tru¡edMu‹x
() = ;

50 
Lock
();

53 
boŞ
 
OwÃd
() const;

57 
boŞ
 
TryLock
();

62 
UÆock
();

64 
	g´iv©e
:

65 
UÁru¡edMu‹x
 
uÁru¡ed_mu‹x_
;

66 
Tru¡edSpšLock
 
	gŒu¡ed_¥š_lock_
;

	@platform/core/trusted_spin_lock.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_¥š_lock.h
"

21 
	~<c¡dio
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

30 
V®id©eSpšLock
(
ušt32_t
 
¥š_lock
) {

31 ià(
	g¥š_lock
 > 
	gTru¡edSpšLock
::
kLocked
) {

32 
buf
[1024];

33 
¢´štf
(
buf
, (buf),

35 
¥š_lock
);

36 
’c_uÁru¡ed_puts
(
buf
);

37 
abÜt
();

43 
	gTru¡edSpšLock
::
Lock
() {

44 !
TryLock
()) {

45 
’c_·u£
();

49 
boŞ
 
	gTru¡edSpšLock
::
OwÃd
(ècÚ¡ {  
owÃr_
 =ğ
’c_th»ad_£lf
(); }

51 
boŞ
 
	gTru¡edSpšLock
::
TryLock
() {

52 
V®id©eSpšLock
(
¥š_lock_
);

54 ià(
	gis_»cursive_
 && 
	gowÃr_
 =ğ
’c_th»ad_£lf
()) {

55 
»cursive_lock_couÁ_
++;

56  
	gŒue
;

59 ià(
	g¥š_lock_
 !ğ
kUÆocked
) {

60  
çl£
;

63 ià(
Com·»AndSw­
(&
¥š_lock_
, 
kUÆocked
, 
kLocked
) == kUnlocked) {

64 
owÃr_
 = 
’c_th»ad_£lf
();

65 ià(
	gis_»cursive_
) {

66 
	g»cursive_lock_couÁ_
 = 1;

69  
	gŒue
;

71  
	gçl£
;

74 
	gTru¡edSpšLock
::
UÆock
() {

75 
V®id©eSpšLock
(
¥š_lock_
);

79 ià(
	gowÃr_
 !ğ
’c_th»ad_£lf
()) {

80 
’c_uÁru¡ed_puts
(

85 ià(
	gis_»cursive_
) {

86 
	g»cursive_lock_couÁ_
--;

89 ià(!
	gis_»cursive_
 || 
	g»cursive_lock_couÁ_
 == 0) {

90 
owÃr_
 = 
kInv®idTh»ad
;

91 
AtomicR–—£
(&
¥š_lock_
);

	@platform/core/trusted_spin_lock.cc

19 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_¥š_lock.h
"

21 
	~<c¡dio
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

30 
V®id©eSpšLock
(
ušt32_t
 
¥š_lock
) {

31 ià(
	g¥š_lock
 > 
	gTru¡edSpšLock
::
kLocked
) {

32 
buf
[1024];

33 
¢´štf
(
buf
, (buf),

35 
¥š_lock
);

36 
’c_uÁru¡ed_puts
(
buf
);

37 
abÜt
();

43 
	gTru¡edSpšLock
::
Lock
() {

44 !
TryLock
()) {

45 
’c_·u£
();

49 
boŞ
 
	gTru¡edSpšLock
::
OwÃd
(ècÚ¡ {  
owÃr_
 =ğ
’c_th»ad_£lf
(); }

51 
boŞ
 
	gTru¡edSpšLock
::
TryLock
() {

52 
V®id©eSpšLock
(
¥š_lock_
);

54 ià(
	gis_»cursive_
 && 
	gowÃr_
 =ğ
’c_th»ad_£lf
()) {

55 
»cursive_lock_couÁ_
++;

56  
	gŒue
;

59 ià(
	g¥š_lock_
 !ğ
kUÆocked
) {

60  
çl£
;

63 ià(
Com·»AndSw­
(&
¥š_lock_
, 
kUÆocked
, 
kLocked
) == kUnlocked) {

64 
owÃr_
 = 
’c_th»ad_£lf
();

65 ià(
	gis_»cursive_
) {

66 
	g»cursive_lock_couÁ_
 = 1;

69  
	gŒue
;

71  
	gçl£
;

74 
	gTru¡edSpšLock
::
UÆock
() {

75 
V®id©eSpšLock
(
¥š_lock_
);

79 ià(
	gowÃr_
 !ğ
’c_th»ad_£lf
()) {

80 
’c_uÁru¡ed_puts
(

85 ià(
	gis_»cursive_
) {

86 
	g»cursive_lock_couÁ_
--;

89 ià(!
	gis_»cursive_
 || 
	g»cursive_lock_couÁ_
 == 0) {

90 
owÃr_
 = 
kInv®idTh»ad
;

91 
AtomicR–—£
(&
¥š_lock_
);

	@platform/core/trusted_spin_lock.h

19 #iâdeà
ASYLO_PLATFORM_CORE_TRUSTED_SPIN_LOCK_H_


20 
	#ASYLO_PLATFORM_CORE_TRUSTED_SPIN_LOCK_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/¶©fÜm/cÜe/©omic.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

27 
Çme¥aû
 
	gasylo
 {

36 şas 
	c®igÇs
(
kCacheLšeSize
è
Tru¡edSpšLock
 {

37 
public
:

42 
cÚ¡ex´
 
ušt32_t
 
kUÆocked
 = 0;

45 
cÚ¡ex´
 
ušt32_t
 
kLocked
 = 1;

52 
cÚ¡ex´
 
ex¶ic™
 
	`Tru¡edSpšLock
(
boŞ
 
is_»cursive
)

53 : 
	`¥š_lock_
(
kUÆocked
),

54 
	`owÃr_
(
kInv®idTh»ad
),

55 
	`is_»cursive_
(
is_»cursive
),

56 
	`»cursive_lock_couÁ_
(0) {}

58 ~
	`Tru¡edSpšLock
() = ;

64 
	`Lock
();

67 
boŞ
 
	`OwÃd
() const;

71 
boŞ
 
	`TryLock
();

76 
	`UÆock
();

78 
´iv©e
:

80 vŞ©
ušt32_t
 
¥š_lock_
;

84 vŞ©
ušt64_t
 
owÃr_
;

87 
boŞ
 
is_»cursive_
;

90 
ušt64_t
 
»cursive_lock_couÁ_
;

91 
	}
};

93 
¡©ic_as£¹
((
Tru¡edSpšLock
è=ğ
kCacheLšeSize
,

	@platform/core/untrusted_cache_malloc.cc

18 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

20 
	~<c¡dlib
>

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

30 *
uÁru¡ed_ÿche_m®loc
(
size_t
 
size
) {

31 
asylo
::
UÁru¡edCacheM®loc
 *
š¡ªû
 =

32 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

33  
š¡ªû
->
M®loc
(
size
);

36 
uÁru¡ed_ÿche_ä“
(*
bufãr
) {

37 
asylo
::
UÁru¡edCacheM®loc
 *
š¡ªû
 =

38 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

39 
š¡ªû
->
F»e
(
bufãr
);

44 
Çme¥aû
 
asylo
 {

46 
boŞ
 
UÁru¡edCacheM®loc
::
is_de¡royed
 = 
çl£
;

48 
UÁru¡edCacheM®loc
 *UÁru¡edCacheM®loc::
In¡ªû
() {

49 
UÁru¡edCacheM®loc
 *
š¡ªû
 = 
Ãw
 UntrustedCacheMalloc();

50  
š¡ªû
;

53 
UÁru¡edCacheM®loc
::UntrustedCacheMalloc() {

54 ià(
is_de¡royed
) {

59 
ä“_li¡_
 = 
ab¦
::
make_unique
<
F»eLi¡
>();

60 
ä“_li¡_
->
bufãrs
.
»£t
(
»š‹½»t_ÿ¡
<**>(
’c_uÁru¡ed_m®loc
(

61 (*è* 
kF»eLi¡C­ac™y
)));

62 
ä“_li¡_
->
couÁ
 = 0;

65 
UÁru¡edCacheM®loc
::~UntrustedCacheMalloc() {

66 !
bufãr_poŞ_
.
em±y
()) {

67 
PushToF»eLi¡
(
bufãr_poŞ_
.
tİ
());

68 
bufãr_poŞ_
.
pİ
();

74 ià(
ä“_li¡_
->
couÁ
 > 0) {

75 
’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(
ä“_li¡_
->
bufãrs
.
g‘
(),

76 
ä“_li¡_
->
couÁ
);

78 
is_de¡royed
 = 
Œue
;

81 *
UÁru¡edCacheM®loc
::
G‘Bufãr
() {

82 **
bufãrs
 = 
nuÎ±r
;

83 *
bufãr
;

84 
boŞ
 
is_poŞ_em±y
;

87 
ScİedSpšLock
 
¥š_lock
(&
lock_
);

88 
is_poŞ_em±y
 = 
bufãr_poŞ_
.
em±y
();

89 ià(
is_poŞ_em±y
) {

90 
bufãrs
 = 
’c_uÁru¡ed_®loÿ‹_bufãrs
(
kPoŞInüem’t
, 
kPoŞEÁrySize
);

91 
i
 = 0; i < 
kPoŞInüem’t
; i++) {

92 ià(!
bufãrs
[
i
]

93 || !
’c_is_outside_’şave
(
bufãrs
[
i
], 
kPoŞEÁrySize
)) {

94 
abÜt
();

96 
bufãr_poŞ_
.
push
(
bufãrs
[
i
]);

99 
bufãr
 = 
bufãr_poŞ_
.
tİ
();

100 
bufãr_poŞ_
.
pİ
();

101 
busy_bufãrs_
.
š£¹
(
bufãr
);

104 ià(
is_poŞ_em±y
) {

107 
F»e
(
bufãrs
);

109  
bufãr
;

112 *
UÁru¡edCacheM®loc
::
M®loc
(
size_t
 
size
) {

113 ià(
is_de¡royed
 || (
size
 > 
kPoŞEÁrySize
)) {

114  
’c_uÁru¡ed_m®loc
(
size
);

116  
G‘Bufãr
();

119 
UÁru¡edCacheM®loc
::
PushToF»eLi¡
(*
bufãr
) {

120 
ä“_li¡_
->
bufãrs
.
g‘
()[ä“_li¡_->
couÁ
] = 
bufãr
;

121 
ä“_li¡_
->
couÁ
++;

123 ià(
ä“_li¡_
->
couÁ
 =ğ
kF»eLi¡C­ac™y
) {

124 
’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(
ä“_li¡_
->
bufãrs
.
g‘
(),

125 
kF»eLi¡C­ac™y
);

126 
ä“_li¡_
->
couÁ
 = 0;

130 
UÁru¡edCacheM®loc
::
F»e
(*
bufãr
) {

131 ià(
is_de¡royed
) {

132 
’c_uÁru¡ed_ä“
(
bufãr
);

135 
ScİedSpšLock
 
¥š_lock
(&
lock_
);

140 ià(
busy_bufãrs_
.
fšd
(
bufãr
è=ğbusy_bufãrs_.
’d
()) {

141 
PushToF»eLi¡
(
bufãr
);

144 
busy_bufãrs_
.
”a£
(
bufãr
);

145 
bufãr_poŞ_
.
push
(
bufãr
);

	@platform/core/untrusted_cache_malloc.cc

18 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

20 
	~<c¡dlib
>

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

30 *
uÁru¡ed_ÿche_m®loc
(
size_t
 
size
) {

31 
asylo
::
UÁru¡edCacheM®loc
 *
š¡ªû
 =

32 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

33  
š¡ªû
->
M®loc
(
size
);

36 
uÁru¡ed_ÿche_ä“
(*
bufãr
) {

37 
asylo
::
UÁru¡edCacheM®loc
 *
š¡ªû
 =

38 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

39 
š¡ªû
->
F»e
(
bufãr
);

44 
Çme¥aû
 
asylo
 {

46 
boŞ
 
UÁru¡edCacheM®loc
::
is_de¡royed
 = 
çl£
;

48 
UÁru¡edCacheM®loc
 *UÁru¡edCacheM®loc::
In¡ªû
() {

49 
UÁru¡edCacheM®loc
 *
š¡ªû
 = 
Ãw
 UntrustedCacheMalloc();

50  
š¡ªû
;

53 
UÁru¡edCacheM®loc
::UntrustedCacheMalloc() {

54 ià(
is_de¡royed
) {

59 
ä“_li¡_
 = 
ab¦
::
make_unique
<
F»eLi¡
>();

60 
ä“_li¡_
->
bufãrs
.
»£t
(
»š‹½»t_ÿ¡
<**>(
’c_uÁru¡ed_m®loc
(

61 (*è* 
kF»eLi¡C­ac™y
)));

62 
ä“_li¡_
->
couÁ
 = 0;

65 
UÁru¡edCacheM®loc
::~UntrustedCacheMalloc() {

66 !
bufãr_poŞ_
.
em±y
()) {

67 
PushToF»eLi¡
(
bufãr_poŞ_
.
tİ
());

68 
bufãr_poŞ_
.
pİ
();

74 ià(
ä“_li¡_
->
couÁ
 > 0) {

75 
’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(
ä“_li¡_
->
bufãrs
.
g‘
(),

76 
ä“_li¡_
->
couÁ
);

78 
is_de¡royed
 = 
Œue
;

81 *
UÁru¡edCacheM®loc
::
G‘Bufãr
() {

82 **
bufãrs
 = 
nuÎ±r
;

83 *
bufãr
;

84 
boŞ
 
is_poŞ_em±y
;

87 
ScİedSpšLock
 
¥š_lock
(&
lock_
);

88 
is_poŞ_em±y
 = 
bufãr_poŞ_
.
em±y
();

89 ià(
is_poŞ_em±y
) {

90 
bufãrs
 = 
’c_uÁru¡ed_®loÿ‹_bufãrs
(
kPoŞInüem’t
, 
kPoŞEÁrySize
);

91 
i
 = 0; i < 
kPoŞInüem’t
; i++) {

92 ià(!
bufãrs
[
i
]

93 || !
’c_is_outside_’şave
(
bufãrs
[
i
], 
kPoŞEÁrySize
)) {

94 
abÜt
();

96 
bufãr_poŞ_
.
push
(
bufãrs
[
i
]);

99 
bufãr
 = 
bufãr_poŞ_
.
tİ
();

100 
bufãr_poŞ_
.
pİ
();

101 
busy_bufãrs_
.
š£¹
(
bufãr
);

104 ià(
is_poŞ_em±y
) {

107 
F»e
(
bufãrs
);

109  
bufãr
;

112 *
UÁru¡edCacheM®loc
::
M®loc
(
size_t
 
size
) {

113 ià(
is_de¡royed
 || (
size
 > 
kPoŞEÁrySize
)) {

114  
’c_uÁru¡ed_m®loc
(
size
);

116  
G‘Bufãr
();

119 
UÁru¡edCacheM®loc
::
PushToF»eLi¡
(*
bufãr
) {

120 
ä“_li¡_
->
bufãrs
.
g‘
()[ä“_li¡_->
couÁ
] = 
bufãr
;

121 
ä“_li¡_
->
couÁ
++;

123 ià(
ä“_li¡_
->
couÁ
 =ğ
kF»eLi¡C­ac™y
) {

124 
’c_uÁru¡ed_d—Îoÿ‹_ä“_li¡
(
ä“_li¡_
->
bufãrs
.
g‘
(),

125 
kF»eLi¡C­ac™y
);

126 
ä“_li¡_
->
couÁ
 = 0;

130 
UÁru¡edCacheM®loc
::
F»e
(*
bufãr
) {

131 ià(
is_de¡royed
) {

132 
’c_uÁru¡ed_ä“
(
bufãr
);

135 
ScİedSpšLock
 
¥š_lock
(&
lock_
);

140 ià(
busy_bufãrs_
.
fšd
(
bufãr
è=ğbusy_bufãrs_.
’d
()) {

141 
PushToF»eLi¡
(
bufãr
);

144 
busy_bufãrs_
.
”a£
(
bufãr
);

145 
bufãr_poŞ_
.
push
(
bufãr
);

	@platform/core/untrusted_cache_malloc.h

19 #iâdeà
ASYLO_PLATFORM_CORE_UNTRUSTED_CACHE_MALLOC_H_


20 
	#ASYLO_PLATFORM_CORE_UNTRUSTED_CACHE_MALLOC_H_


	)

22 
	~<c¡ddef
>

23 
	~<¡ack
>

25 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

26 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
	~"asylo/¶©fÜm/commÚ/¥š_lock.h
"

28 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

30 
Çme¥aû
 
	gasylo
 {

44 şas 
	cUÁru¡edCacheM®loc
 {

45 
	gpublic
:

46 
UÁru¡edCacheM®loc
(UÁru¡edCacheM®loøcÚ¡ &èğ
d–‘e
;

47 
	gUÁru¡edCacheM®loc
 &
	gİ”©Ü
=(
UÁru¡edCacheM®loc
 cÚ¡ &èğ
d–‘e
;

50 ~
UÁru¡edCacheM®loc
();

53 
UÁru¡edCacheM®loc
 *
In¡ªû
();

60 *
M®loc
(
size_t
 
size
);

63 
F»e
(*
bufãr
);

65 
	g´iv©e
:

66 
	sF»eLi¡
 {

67 
UÁru¡edUniquePŒ
<*> 
bufãrs
;

68 
	gcouÁ
;

71 
SpšLock
 
	glock_
;

74 
cÚ¡ex´
 
size_t
 
	gkPoŞInüem’t
 = 1024;

77 
cÚ¡ex´
 
size_t
 
	gkPoŞEÁrySize
 = 4096;

81 
cÚ¡ex´
 
size_t
 
	gkF»eLi¡C­ac™y
 = 1024;

86 
boŞ
 
	gis_de¡royed
;

88 
UÁru¡edCacheM®loc
();

93 *
G‘Bufãr
();

99 
PushToF»eLi¡
(*
bufãr
);

102 
	g¡d
::
unique_±r
<
F»eLi¡
> 
ä“_li¡_
;

108 
	g¡d
::
¡ack
<*> 
bufãr_poŞ_
;

111 
	gab¦
::
æ©_hash_£t
<*> 
busy_bufãrs_
;

	@platform/core/untrusted_cache_malloc_test.cc

19 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

21 
	~<c¡ddef
>

22 
	~<c¡dlib
>

23 
	~<¿ndom
>

24 
	~<th»ad
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 şas 
	cUÁru¡edCacheM®locTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

34 
´Ùeùed
:

35 
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc_
 =

36 
UÁru¡edCacheM®loc
::
In¡ªû
();

39 
TEST_F
(
UÁru¡edCacheM®locTe¡
, 
SŒessTe¡
) {

40 
cÚ¡ex´
 
	gkNumTh»ads
 = 1;

41 
cÚ¡ex´
 
	gkAÎoÿtiÚs
 = 2;

42 
cÚ¡ex´
 
size_t
 
	gkMaxPoŞEÁrySize
 = 8192;

45 autØ
	gŒy_m®loc_ä“
 = [](
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
) {

46 *
mem
[
kAÎoÿtiÚs
];

47 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; i++) {

50 
	g¡d
::
mt19937
 
¿nd_’gše
;

51 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
ušt64_t
> 
¿nd_g’
(1, 
kMaxPoŞEÁrySize
);

52 
size_t
 
	gsize
 = 
¿nd_g’
(
¿nd_’gše
);

53 
	gmem
[
i
] = 
uÁru¡ed_ÿche_m®loc
->
M®loc
(
size
);

56 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; i++) {

57 
	guÁru¡ed_ÿche_m®loc
->
F»e
(
mem
[
i
]);

61 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

62 
	gi
 = 0; i < 
	gkNumTh»ads
; i++) {

63 
	gth»ads
.
em¶aû_back
(
Œy_m®loc_ä“
, 
uÁru¡ed_ÿche_m®loc_
);

65 autØ&
	gth»ad
 : 
th»ads
) {

66 
th»ad
.
još
();

	@platform/core/untrusted_cache_malloc_test.cc

19 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

21 
	~<c¡ddef
>

22 
	~<c¡dlib
>

23 
	~<¿ndom
>

24 
	~<th»ad
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 şas 
	cUÁru¡edCacheM®locTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

34 
´Ùeùed
:

35 
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc_
 =

36 
UÁru¡edCacheM®loc
::
In¡ªû
();

39 
TEST_F
(
UÁru¡edCacheM®locTe¡
, 
SŒessTe¡
) {

40 
cÚ¡ex´
 
	gkNumTh»ads
 = 1;

41 
cÚ¡ex´
 
	gkAÎoÿtiÚs
 = 2;

42 
cÚ¡ex´
 
size_t
 
	gkMaxPoŞEÁrySize
 = 8192;

45 autØ
	gŒy_m®loc_ä“
 = [](
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
) {

46 *
mem
[
kAÎoÿtiÚs
];

47 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; i++) {

50 
	g¡d
::
mt19937
 
¿nd_’gše
;

51 
	g¡d
::
unifÜm_št_di¡ributiÚ
<
ušt64_t
> 
¿nd_g’
(1, 
kMaxPoŞEÁrySize
);

52 
size_t
 
	gsize
 = 
¿nd_g’
(
¿nd_’gše
);

53 
	gmem
[
i
] = 
uÁru¡ed_ÿche_m®loc
->
M®loc
(
size
);

56 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; i++) {

57 
	guÁru¡ed_ÿche_m®loc
->
F»e
(
mem
[
i
]);

61 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

62 
	gi
 = 0; i < 
	gkNumTh»ads
; i++) {

63 
	gth»ads
.
em¶aû_back
(
Œy_m®loc_ä“
, 
uÁru¡ed_ÿche_m®loc_
);

65 autØ&
	gth»ad
 : 
th»ads
) {

66 
th»ad
.
još
();

	@platform/core/untrusted_mutex.cc

19 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_mu‹x.h
"

21 
	~<c¡dio
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/cÜe/©omic.h
"

26 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

27 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

29 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

43 
cÚ¡ex´
 
št32_t
 
	gkUÆocked
 = 0;

45 
cÚ¡ex´
 
št32_t
 
	gkH–d
 = 1;

48 
cÚ¡ex´
 
št32_t
 
	gkQueued
 = 2;

53 
	gUÁru¡edMu‹x
::
UÁru¡edMu‹x
(
boŞ
 
is_»cursive
)

54 : 
is_»cursive_
(
is_»cursive
),

55 
owÃr_
(
kInv®idTh»ad
),

56 
»cursive_lock_couÁ_
(0) {

59 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

60 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

66 
	guÁru¡ed_fu‹x_
 =

67 
¡©ic_ÿ¡
<
št32_t
 *>(
uÁru¡ed_ÿche_m®loc
->
M®loc
(
kCacheLšeSize
));

70 *
	guÁru¡ed_fu‹x_
 = 
kUÆocked
;

73 
	gUÁru¡edMu‹x
::~
UÁru¡edMu‹x
() {

75 
asylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

76 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

77 
	guÁru¡ed_ÿche_m®loc
->
F»e
(
uÁru¡ed_fu‹x_
);

80 
	gUÁru¡edMu‹x
::
Lock
() {

82 ià(*
uÁru¡ed_fu‹x_
 < 
kUÆocked
 || *uÁru¡ed_fu‹x_ > 
kQueued
) {

83 
’c_uÁru¡ed_puts
("Invalid futex value in UntrustedMutex::Lock.");

84 
abÜt
();

87 ià(
	gis_»cursive_
 && 
	gowÃr_
 =ğ
’c_th»ad_£lf
()) {

88 
»cursive_lock_couÁ_
++;

95 
št32_t
 
	gfu‹x_v®ue
 = 
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kUÆocked
, 
kH–d
);

100 ià(
	gfu‹x_v®ue
 !ğ
kUÆocked
) {

105 ià(
fu‹x_v®ue
 !ğ
kQueued
) {

106 
fu‹x_v®ue
 = 
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kH–d
, 
kQueued
);

111 
’c_uÁru¡ed_sys_fu‹x_wa™
(
uÁru¡ed_fu‹x_
, 
kQueued
);

117 
	gfu‹x_v®ue
 = 
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kUÆocked
, 
kQueued
);

118 } 
	gfu‹x_v®ue
 !ğ
kUÆocked
);

121 
	gowÃr_
 = 
’c_th»ad_£lf
();

123 ià(
	gis_»cursive_
) {

124 
	g»cursive_lock_couÁ_
++;

128 
boŞ
 
	gUÁru¡edMu‹x
::
OwÃd
(ècÚ¡ {  
owÃr_
 =ğ
’c_th»ad_£lf
(); }

130 
boŞ
 
	gUÁru¡edMu‹x
::
TryLock
() {

131 ià(
is_»cursive_
 && 
owÃr_
 =ğ
’c_th»ad_£lf
()) {

132 
»cursive_lock_couÁ_
++;

133  
	gŒue
;

135 ià(
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kUÆocked
, 
kH–d
) == kUnlocked) {

136 
owÃr_
 = 
’c_th»ad_£lf
();

137 ià(
	gis_»cursive_
) {

138 
	g»cursive_lock_couÁ_
 = 1;

140  
	gŒue
;

142  
	gçl£
;

145 
	gUÁru¡edMu‹x
::
UÆock
() {

147 ià(*
uÁru¡ed_fu‹x_
 < 
kUÆocked
 || *uÁru¡ed_fu‹x_ > 
kQueued
) {

148 
buf
[1024];

149 
¢´štf
(
buf
, (buf),

151 *
uÁru¡ed_fu‹x_
);

152 
’c_uÁru¡ed_puts
(
buf
);

158 ià(
	gowÃr_
 !ğ
’c_th»ad_£lf
()) {

159 
’c_uÁru¡ed_puts
(

161 
abÜt
();

164 ià(
	gis_»cursive_
) {

165 
	g»cursive_lock_couÁ_
--;

168 ià(!
	gis_»cursive_
 || 
	g»cursive_lock_couÁ_
 == 0) {

169 
owÃr_
 = 
kInv®idTh»ad
;

177 
št32_t
 
	gfu‹x_v®ue
 = 
AtomicDeüem’t
(
uÁru¡ed_fu‹x_
);

184 ià(
	gfu‹x_v®ue
 !ğ
kH–d
) {

185 
AtomicR–—£
(
uÁru¡ed_fu‹x_
);

186 
’c_uÁru¡ed_sys_fu‹x_wake
(
uÁru¡ed_fu‹x_
);

	@platform/core/untrusted_mutex.cc

19 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_mu‹x.h
"

21 
	~<c¡dio
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/cÜe/©omic.h
"

26 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

27 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

29 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

43 
cÚ¡ex´
 
št32_t
 
	gkUÆocked
 = 0;

45 
cÚ¡ex´
 
št32_t
 
	gkH–d
 = 1;

48 
cÚ¡ex´
 
št32_t
 
	gkQueued
 = 2;

53 
	gUÁru¡edMu‹x
::
UÁru¡edMu‹x
(
boŞ
 
is_»cursive
)

54 : 
is_»cursive_
(
is_»cursive
),

55 
owÃr_
(
kInv®idTh»ad
),

56 
»cursive_lock_couÁ_
(0) {

59 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

60 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

66 
	guÁru¡ed_fu‹x_
 =

67 
¡©ic_ÿ¡
<
št32_t
 *>(
uÁru¡ed_ÿche_m®loc
->
M®loc
(
kCacheLšeSize
));

70 *
	guÁru¡ed_fu‹x_
 = 
kUÆocked
;

73 
	gUÁru¡edMu‹x
::~
UÁru¡edMu‹x
() {

75 
asylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

76 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

77 
	guÁru¡ed_ÿche_m®loc
->
F»e
(
uÁru¡ed_fu‹x_
);

80 
	gUÁru¡edMu‹x
::
Lock
() {

82 ià(*
uÁru¡ed_fu‹x_
 < 
kUÆocked
 || *uÁru¡ed_fu‹x_ > 
kQueued
) {

83 
’c_uÁru¡ed_puts
("Invalid futex value in UntrustedMutex::Lock.");

84 
abÜt
();

87 ià(
	gis_»cursive_
 && 
	gowÃr_
 =ğ
’c_th»ad_£lf
()) {

88 
»cursive_lock_couÁ_
++;

95 
št32_t
 
	gfu‹x_v®ue
 = 
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kUÆocked
, 
kH–d
);

100 ià(
	gfu‹x_v®ue
 !ğ
kUÆocked
) {

105 ià(
fu‹x_v®ue
 !ğ
kQueued
) {

106 
fu‹x_v®ue
 = 
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kH–d
, 
kQueued
);

111 
’c_uÁru¡ed_sys_fu‹x_wa™
(
uÁru¡ed_fu‹x_
, 
kQueued
);

117 
	gfu‹x_v®ue
 = 
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kUÆocked
, 
kQueued
);

118 } 
	gfu‹x_v®ue
 !ğ
kUÆocked
);

121 
	gowÃr_
 = 
’c_th»ad_£lf
();

123 ià(
	gis_»cursive_
) {

124 
	g»cursive_lock_couÁ_
++;

128 
boŞ
 
	gUÁru¡edMu‹x
::
OwÃd
(ècÚ¡ {  
owÃr_
 =ğ
’c_th»ad_£lf
(); }

130 
boŞ
 
	gUÁru¡edMu‹x
::
TryLock
() {

131 ià(
is_»cursive_
 && 
owÃr_
 =ğ
’c_th»ad_£lf
()) {

132 
»cursive_lock_couÁ_
++;

133  
	gŒue
;

135 ià(
Com·»AndSw­
(
uÁru¡ed_fu‹x_
, 
kUÆocked
, 
kH–d
) == kUnlocked) {

136 
owÃr_
 = 
’c_th»ad_£lf
();

137 ià(
	gis_»cursive_
) {

138 
	g»cursive_lock_couÁ_
 = 1;

140  
	gŒue
;

142  
	gçl£
;

145 
	gUÁru¡edMu‹x
::
UÆock
() {

147 ià(*
uÁru¡ed_fu‹x_
 < 
kUÆocked
 || *uÁru¡ed_fu‹x_ > 
kQueued
) {

148 
buf
[1024];

149 
¢´štf
(
buf
, (buf),

151 *
uÁru¡ed_fu‹x_
);

152 
’c_uÁru¡ed_puts
(
buf
);

158 ià(
	gowÃr_
 !ğ
’c_th»ad_£lf
()) {

159 
’c_uÁru¡ed_puts
(

161 
abÜt
();

164 ià(
	gis_»cursive_
) {

165 
	g»cursive_lock_couÁ_
--;

168 ià(!
	gis_»cursive_
 || 
	g»cursive_lock_couÁ_
 == 0) {

169 
owÃr_
 = 
kInv®idTh»ad
;

177 
št32_t
 
	gfu‹x_v®ue
 = 
AtomicDeüem’t
(
uÁru¡ed_fu‹x_
);

184 ià(
	gfu‹x_v®ue
 !ğ
kH–d
) {

185 
AtomicR–—£
(
uÁru¡ed_fu‹x_
);

186 
’c_uÁru¡ed_sys_fu‹x_wake
(
uÁru¡ed_fu‹x_
);

	@platform/core/untrusted_mutex.h

19 #iâdeà
ASYLO_PLATFORM_CORE_UNTRUSTED_MUTEX_H_


20 
	#ASYLO_PLATFORM_CORE_UNTRUSTED_MUTEX_H_


	)

22 
	~<c¡dšt
>

24 
Çme¥aû
 
	gasylo
 {

36 şas 
	cUÁru¡edMu‹x
 {

37 
	gpublic
:

43 
ex¶ic™
 
UÁru¡edMu‹x
(
boŞ
 
is_»cursive
);

45 ~
UÁru¡edMu‹x
();

51 
Lock
();

54 
boŞ
 
OwÃd
() const;

58 
boŞ
 
TryLock
();

63 
UÆock
();

65 
	g´iv©e
:

67 
št32_t
 *
uÁru¡ed_fu‹x_
;

70 
boŞ
 
	gis_»cursive_
;

74 
ušt64_t
 
	gowÃr_
;

77 
ušt64_t
 
	g»cursive_lock_couÁ_
;

	@platform/crypto/gcmlib/gcm_cryptor.cc

19 
	~"asylo/¶©fÜm/üy±o/gcmlib/gcm_üy±Ü.h
"

21 
	~<İ’s¦/«s.h
>

22 
	~<İ’s¦/cmac.h
>

23 
	~<İ’s¦/”r.h
>

24 
	~<İ’s¦/evp.h
>

25 
	~<İ’s¦/mem.h
>

26 
	~<İ’s¦/¿nd.h
>

27 
	~<c¡dlib
>

28 
	~<c¡ršg
>

29 
	~<ùime
>

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
	~"asylo/üy±o/ut/bs¦_ut.h
"

34 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

35 
	~"asylo/üy±o/ut/by‹s.h
"

36 
	~"asylo/ut/loggšg.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	g¶©fÜm
 {

40 
Çme¥aû
 
	güy±o
 {

41 
Çme¥aû
 
	ggcmlib
 {

43 
	gÇme¥aû
 {

48 
cÚ¡ex´
 
ušt8_t
 
	gkGcmD”iv©iÚCÚ¡ªt
[
kKeyIdL’gth
] = {

52 
cÚ¡ex´
 
ušt8_t
 
	gkCmacD”iv©iÚCÚ¡ªt
[
kKeyIdL’gth
] = {

57 
boŞ
 
G’”©eD”ivedKey
(cÚ¡ 
GcmCry±ÜKey
 &
w¿µšg_key
,

58 cÚ¡ 
ušt8_t
 *
key_id
, 
GcmCry±ÜKey
 *
dk
) {

59 
¡©ic_as£¹
(
kKeyL’gth
 =ğ2 * 
AES_BLOCK_SIZE
, "kKeyLength is invalid");

60 
By‹CÚš”V›w
 
key_id_v›w
(
key_id
, 
kKeyIdL’gth
);

61 
	gUn§ãBy‹s
<
	gkKeyIdL’gth
> 
key_id_şÚe
(
key_id_v›w
);

62 
	gSaãBy‹s
<
	gkKeyIdL’gth
> 
	gd”ived_key
;

66 *
	gkey_id_şÚe
.
d©a
() |= 1 << 7;

67 ià(1 !ğ
AES_CMAC
(
d”ived_key
.
d©a
(),

68 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
w¿µšg_key
.
d©a
()),

69 
kKeyL’gth
, 
key_id_şÚe
.
d©a
(), 
kKeyIdL’gth
)) {

70 
LOG
(
ERROR
è<< "AES_CMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

71  
	gçl£
;

76 *
	gkey_id_şÚe
.
d©a
() &= ~(1 << 7);

77 ià(1 !ğ
AES_CMAC
(
d”ived_key
.
d©a
(è+ 
AES_BLOCK_SIZE
,

78 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
w¿µšg_key
.
d©a
()),

79 
kKeyL’gth
, 
key_id_şÚe
.
d©a
(), 
kKeyIdL’gth
)) {

80 
LOG
(
ERROR
è<< "AES_CMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

81  
	gçl£
;

84 *
	gdk
 = 
GcmCry±ÜKey
(
d”ived_key
.
d©a
(), 
kKeyL’gth
);

85  
	gŒue
;

90 
	gGcmCry±Ü
::
GcmCry±Ü
(
size_t
 
block_Ëngth
, cÚ¡ 
GcmCry±ÜKey
 &
gcm_key
,

91 cÚ¡ 
GcmCry±ÜKey
 &
cmac_key
)

92 : 
kBlockL’gth
(
block_Ëngth
),

93 
kGcmKey
(
gcm_key
),

94 
kCmacKey
(
cmac_key
),

95 
key_id_couÁ”_
(0) {}

97 
	g¡d
::
unique_±r
<
GcmCry±Ü
> GcmCry±Ü::
C»©e
(

98 
size_t
 
block_Ëngth
, cÚ¡ 
GcmCry±ÜKey
 &
ma¡”_key
) {

99 ià(
	gblock_Ëngth
 == 0) {

100  
nuÎ±r
;

103 
¡©ic_as£¹
(
kTok’L’gth
 =ğ
kNÚûL’gth
 + 
kKeyIdL’gth
,

107 
¡©ic_as£¹
(
kTok’L’gth
 =ğ(
Tok’
),

110 ià(
EVP_AEAD_nÚû_Ëngth
(
EVP_«ad_«s_256_gcm
()è!ğ
kNÚûL’gth
) {

111 
LOG
(
ERROR
)

113 << 
EVP_AEAD_nÚû_Ëngth
(
EVP_«ad_«s_256_gcm
());

114  
	gnuÎ±r
;

117 ià(
EVP_AEAD_max_ov”h—d
(
EVP_«ad_«s_256_gcm
()è!ğ
kTagL’gth
) {

118 
LOG
(
ERROR
)

120 << 
EVP_AEAD_max_ov”h—d
(
EVP_«ad_«s_256_gcm
());

121  
	gnuÎ±r
;

124 ià(
	gma¡”_key
.
size
(è!ğ
kKeyL’gth
) {

125 
LOG
(
ERROR
) << "The GCM cryptor supports 256-bit keys only.";

126  
	gnuÎ±r
;

129 
GcmCry±ÜKey
 
	ggcm_key
;

130 ià(!
G’”©eD”ivedKey
(
ma¡”_key
, 
kGcmD”iv©iÚCÚ¡ªt
, &
gcm_key
)) {

131 
LOG
(
ERROR
è<< "FaedØd”ivkey fÜ GCM: " << 
Bs¦La¡E¼ÜSŒšg
();

132  
	gnuÎ±r
;

135 
GcmCry±ÜKey
 
	gcmac_key
;

136 ià(!
G’”©eD”ivedKey
(
ma¡”_key
, 
kCmacD”iv©iÚCÚ¡ªt
, &
cmac_key
)) {

137 
LOG
(
ERROR
è<< "FaedØd”ivkey fÜ CMAC: " << 
Bs¦La¡E¼ÜSŒšg
();

138  
	gnuÎ±r
;

141 
GcmCry±Ü
 *
	ggcm_üy±Ü
 = 
Ãw
 GcmCry±Ü(
block_Ëngth
, 
gcm_key
, 
cmac_key
);

142  
	gab¦
::
W¿pUnique
(
gcm_üy±Ü
);

145 
boŞ
 
	gGcmCry±Ü
::
Enüy±Block
(cÚ¡ 
ušt8_t
 *
¶aš‹xt_d©a
, ušt8_ˆ*
tok’
,

146 
ušt8_t
 *
ch”‹xt_d©a
) {

147 ià(
	g¶aš‹xt_d©a
 =ğ
nuÎ±r
 || 
tok’
 ==‚ullptr ||

148 
ch”‹xt_d©a
 =ğ
nuÎ±r
) {

149 
LOG
(
ERROR
) << "Invalid inputo GcmCryptor::EncryptBlock.";

150  
	gçl£
;

153 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

155 ià(1 !ğ
RAND_by‹s
(
Ãxt_tok’_
.
nÚû
, 
kNÚûL’gth
)) {

156 
LOG
(
ERROR
)

158 << 
Bs¦La¡E¼ÜSŒšg
();

159  
	gçl£
;

162 ià(
	gkey_id_couÁ”_
 % 
	gkKeyIdCyşe
 == 0) {

163 
key_id_couÁ”_
 = 0;

165 ià(1 !ğ
RAND_by‹s
(
Ãxt_tok’_
.
key_id
, 
kKeyIdL’gth
)) {

166 
LOG
(
ERROR
)

168 << 
Bs¦La¡E¼ÜSŒšg
();

169  
	gçl£
;

172 ià(!
G’”©eD”ivedGcmKey
(
Ãxt_tok’_
.
key_id
, &
Ãxt_d”ived_key_
)) {

173 
LOG
(
ERROR
) << "Failedo derive key for GcmCryptor::EncryptBlock: "

174 << 
Bs¦La¡E¼ÜSŒšg
();

175  
	gçl£
;

180 
	gkey_id_couÁ”_
++;

182 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

183 ià(!
EVP_AEAD_CTX_š™
(

184 &
cÚ‹xt
, 
EVP_«ad_«s_256_gcm
(),

185 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
Ãxt_d”ived_key_
.
d©a
()),

186 
kKeyL’gth
, 
kTagL’gth
, 
nuÎ±r
)) {

187 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_š™ faed: " << 
Bs¦La¡E¼ÜSŒšg
();

188 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

189  
	gçl£
;

192 
size_t
 
	gch”‹xt_Ëngth
;

193 
size_t
 
	gmax_ch”‹xt_Ëngth
 = 
kBlockL’gth
 + 
kTagL’gth
;

194 ià(!
EVP_AEAD_CTX_£®
(&
cÚ‹xt
, 
ch”‹xt_d©a
, &
ch”‹xt_Ëngth
,

195 
max_ch”‹xt_Ëngth
, 
Ãxt_tok’_
.
nÚû
, 
kNÚûL’gth
,

196 
¶aš‹xt_d©a
, 
kBlockL’gth
, 
nuÎ±r
, 0)) {

197 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_£® faed: " << 
Bs¦La¡E¼ÜSŒšg
();

198 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

199  
	gçl£
;

202 ià(
	gch”‹xt_Ëngth
 !ğ
max_ch”‹xt_Ëngth
) {

203 
LOG
(
ERROR
) << "EVP_AEAD_CTX_seal failedoƒncrypt complete…laintext, "

204 << "ex³ùed ch”‹xt_Ëngth = " << 
max_ch”‹xt_Ëngth


205 << ",ƒncouÁ”ed ch”‹xt_Ëngth = " << 
ch”‹xt_Ëngth
;

206 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

207  
	gçl£
;

210 
memıy
(
tok’
, 
Ãxt_tok’_
.
d©a
(), 
kTok’L’gth
);

212 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

213  
	gŒue
;

216 
boŞ
 
	gGcmCry±Ü
::
Deüy±Block
(cÚ¡ 
ušt8_t
 *
ch”‹xt_d©a
,

217 cÚ¡ 
ušt8_t
 *
tok’
, ušt8_ˆ*
¶aš‹xt_d©a
) {

218 ià(
	gch”‹xt_d©a
 =ğ
nuÎ±r
 || 
tok’
 ==‚ullptr ||

219 
¶aš‹xt_d©a
 =ğ
nuÎ±r
) {

220 
LOG
(
ERROR
) << "Invalid inputo GcmCryptor::DecryptBlock.";

221  
	gçl£
;

224 cÚ¡ 
Tok’
 *
	gtok
 = 
»š‹½»t_ÿ¡
<cÚ¡ Tok’ *>(
tok’
);

226 
GcmCry±ÜKey
 
	gd”ived_key
;

227 ià(!
G’”©eD”ivedGcmKey
(
tok
->
key_id
, &
d”ived_key
)) {

228 
LOG
(
ERROR
) << "Failedo derive key for GcmCryptor::DecryptBlock: "

229 << 
Bs¦La¡E¼ÜSŒšg
();

230  
	gçl£
;

233 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

234 ià(!
EVP_AEAD_CTX_š™
(&
cÚ‹xt
, 
EVP_«ad_«s_256_gcm
(),

235 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
d”ived_key
.
d©a
()),

236 
kKeyL’gth
, 
kTagL’gth
, 
nuÎ±r
)) {

237 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_š™ faed: " << 
Bs¦La¡E¼ÜSŒšg
();

238 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

239  
	gçl£
;

242 
size_t
 
	g¶aš‹xt_Ëngth
;

243 ià(!
EVP_AEAD_CTX_İ’
(&
cÚ‹xt
, 
¶aš‹xt_d©a
, &
¶aš‹xt_Ëngth
,

244 
kBlockL’gth
, 
tok
->
nÚû
, 
kNÚûL’gth
,

245 
ch”‹xt_d©a
, 
kBlockL’gth
 + 
kTagL’gth
, 
nuÎ±r
,

247 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_İ’ faed: " << 
Bs¦La¡E¼ÜSŒšg
();

248 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

249  
	gçl£
;

252 ià(
	g¶aš‹xt_Ëngth
 !ğ
kBlockL’gth
) {

253 
LOG
(
ERROR
) << "EVP_AEAD_CTX_open failedo decrypt complete ciphertext, "

254 << "ex³ùed…Ïš‹xt_Ëngth = " << 
kBlockL’gth


255 << ",ƒncouÁ”ed…Ïš‹xt_Ëngth = " << 
¶aš‹xt_Ëngth
;

256 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

257  
	gçl£
;

260 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

261  
	gŒue
;

264 
boŞ
 
	gGcmCry±Ü
::
G’”©eD”ivedGcmKey
(cÚ¡ 
ušt8_t
 *
key_id
,

265 
GcmCry±ÜKey
 *
dk
) {

266  
G’”©eD”ivedKey
(
kGcmKey
, 
key_id
, 
dk
);

269 
boŞ
 
	gGcmCry±Ü
::
G‘AuthTag
(
ušt8_t
 
out
[16], cÚ¡ ušt8_ˆ*
š
,

270 
size_t
 
š_Ën
) const {

271 ià(1 !ğ
AES_CMAC
(
out
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
kCmacKey
.
d©a
()),

272 
kKeyL’gth
, 
š
, 
š_Ën
)) {

273 
LOG
(
ERROR
è<< "AES_CMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

274  
	gçl£
;

277  
	gŒue
;

286 
GcmCry±Ü
 *
	gGcmCry±ÜRegi¡ry
::
G‘GcmCry±Ü
(
size_t
 
block_Ëngth
,

287 cÚ¡ 
GcmCry±ÜKey
 &
key
) {

288 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

290 autØ
	g™
 = 
üy±Ü_»gi¡ry_
.
fšd
(
key
);

291 ià(
	g™
 !ğ
üy±Ü_»gi¡ry_
.
’d
()) {

292  
™
->
£cÚd
.
g‘
();

295 autØ
	g»suÉ
 =

296 
üy±Ü_»gi¡ry_
.
em¶aû
(
key
, 
GcmCry±Ü
::
C»©e
(
block_Ëngth
, key));

297  
	g»suÉ
.
	gfœ¡
->
	g£cÚd
.
g‘
();

	@platform/crypto/gcmlib/gcm_cryptor.cc

19 
	~"asylo/¶©fÜm/üy±o/gcmlib/gcm_üy±Ü.h
"

21 
	~<İ’s¦/«s.h
>

22 
	~<İ’s¦/cmac.h
>

23 
	~<İ’s¦/”r.h
>

24 
	~<İ’s¦/evp.h
>

25 
	~<İ’s¦/mem.h
>

26 
	~<İ’s¦/¿nd.h
>

27 
	~<c¡dlib
>

28 
	~<c¡ršg
>

29 
	~<ùime
>

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
	~"asylo/üy±o/ut/bs¦_ut.h
"

34 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

35 
	~"asylo/üy±o/ut/by‹s.h
"

36 
	~"asylo/ut/loggšg.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	g¶©fÜm
 {

40 
Çme¥aû
 
	güy±o
 {

41 
Çme¥aû
 
	ggcmlib
 {

43 
	gÇme¥aû
 {

48 
cÚ¡ex´
 
ušt8_t
 
	gkGcmD”iv©iÚCÚ¡ªt
[
kKeyIdL’gth
] = {

52 
cÚ¡ex´
 
ušt8_t
 
	gkCmacD”iv©iÚCÚ¡ªt
[
kKeyIdL’gth
] = {

57 
boŞ
 
G’”©eD”ivedKey
(cÚ¡ 
GcmCry±ÜKey
 &
w¿µšg_key
,

58 cÚ¡ 
ušt8_t
 *
key_id
, 
GcmCry±ÜKey
 *
dk
) {

59 
¡©ic_as£¹
(
kKeyL’gth
 =ğ2 * 
AES_BLOCK_SIZE
, "kKeyLength is invalid");

60 
By‹CÚš”V›w
 
key_id_v›w
(
key_id
, 
kKeyIdL’gth
);

61 
	gUn§ãBy‹s
<
	gkKeyIdL’gth
> 
key_id_şÚe
(
key_id_v›w
);

62 
	gSaãBy‹s
<
	gkKeyIdL’gth
> 
	gd”ived_key
;

66 *
	gkey_id_şÚe
.
d©a
() |= 1 << 7;

67 ià(1 !ğ
AES_CMAC
(
d”ived_key
.
d©a
(),

68 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
w¿µšg_key
.
d©a
()),

69 
kKeyL’gth
, 
key_id_şÚe
.
d©a
(), 
kKeyIdL’gth
)) {

70 
LOG
(
ERROR
è<< "AES_CMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

71  
	gçl£
;

76 *
	gkey_id_şÚe
.
d©a
() &= ~(1 << 7);

77 ià(1 !ğ
AES_CMAC
(
d”ived_key
.
d©a
(è+ 
AES_BLOCK_SIZE
,

78 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
w¿µšg_key
.
d©a
()),

79 
kKeyL’gth
, 
key_id_şÚe
.
d©a
(), 
kKeyIdL’gth
)) {

80 
LOG
(
ERROR
è<< "AES_CMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

81  
	gçl£
;

84 *
	gdk
 = 
GcmCry±ÜKey
(
d”ived_key
.
d©a
(), 
kKeyL’gth
);

85  
	gŒue
;

90 
	gGcmCry±Ü
::
GcmCry±Ü
(
size_t
 
block_Ëngth
, cÚ¡ 
GcmCry±ÜKey
 &
gcm_key
,

91 cÚ¡ 
GcmCry±ÜKey
 &
cmac_key
)

92 : 
kBlockL’gth
(
block_Ëngth
),

93 
kGcmKey
(
gcm_key
),

94 
kCmacKey
(
cmac_key
),

95 
key_id_couÁ”_
(0) {}

97 
	g¡d
::
unique_±r
<
GcmCry±Ü
> GcmCry±Ü::
C»©e
(

98 
size_t
 
block_Ëngth
, cÚ¡ 
GcmCry±ÜKey
 &
ma¡”_key
) {

99 ià(
	gblock_Ëngth
 == 0) {

100  
nuÎ±r
;

103 
¡©ic_as£¹
(
kTok’L’gth
 =ğ
kNÚûL’gth
 + 
kKeyIdL’gth
,

107 
¡©ic_as£¹
(
kTok’L’gth
 =ğ(
Tok’
),

110 ià(
EVP_AEAD_nÚû_Ëngth
(
EVP_«ad_«s_256_gcm
()è!ğ
kNÚûL’gth
) {

111 
LOG
(
ERROR
)

113 << 
EVP_AEAD_nÚû_Ëngth
(
EVP_«ad_«s_256_gcm
());

114  
	gnuÎ±r
;

117 ià(
EVP_AEAD_max_ov”h—d
(
EVP_«ad_«s_256_gcm
()è!ğ
kTagL’gth
) {

118 
LOG
(
ERROR
)

120 << 
EVP_AEAD_max_ov”h—d
(
EVP_«ad_«s_256_gcm
());

121  
	gnuÎ±r
;

124 ià(
	gma¡”_key
.
size
(è!ğ
kKeyL’gth
) {

125 
LOG
(
ERROR
) << "The GCM cryptor supports 256-bit keys only.";

126  
	gnuÎ±r
;

129 
GcmCry±ÜKey
 
	ggcm_key
;

130 ià(!
G’”©eD”ivedKey
(
ma¡”_key
, 
kGcmD”iv©iÚCÚ¡ªt
, &
gcm_key
)) {

131 
LOG
(
ERROR
è<< "FaedØd”ivkey fÜ GCM: " << 
Bs¦La¡E¼ÜSŒšg
();

132  
	gnuÎ±r
;

135 
GcmCry±ÜKey
 
	gcmac_key
;

136 ià(!
G’”©eD”ivedKey
(
ma¡”_key
, 
kCmacD”iv©iÚCÚ¡ªt
, &
cmac_key
)) {

137 
LOG
(
ERROR
è<< "FaedØd”ivkey fÜ CMAC: " << 
Bs¦La¡E¼ÜSŒšg
();

138  
	gnuÎ±r
;

141 
GcmCry±Ü
 *
	ggcm_üy±Ü
 = 
Ãw
 GcmCry±Ü(
block_Ëngth
, 
gcm_key
, 
cmac_key
);

142  
	gab¦
::
W¿pUnique
(
gcm_üy±Ü
);

145 
boŞ
 
	gGcmCry±Ü
::
Enüy±Block
(cÚ¡ 
ušt8_t
 *
¶aš‹xt_d©a
, ušt8_ˆ*
tok’
,

146 
ušt8_t
 *
ch”‹xt_d©a
) {

147 ià(
	g¶aš‹xt_d©a
 =ğ
nuÎ±r
 || 
tok’
 ==‚ullptr ||

148 
ch”‹xt_d©a
 =ğ
nuÎ±r
) {

149 
LOG
(
ERROR
) << "Invalid inputo GcmCryptor::EncryptBlock.";

150  
	gçl£
;

153 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

155 ià(1 !ğ
RAND_by‹s
(
Ãxt_tok’_
.
nÚû
, 
kNÚûL’gth
)) {

156 
LOG
(
ERROR
)

158 << 
Bs¦La¡E¼ÜSŒšg
();

159  
	gçl£
;

162 ià(
	gkey_id_couÁ”_
 % 
	gkKeyIdCyşe
 == 0) {

163 
key_id_couÁ”_
 = 0;

165 ià(1 !ğ
RAND_by‹s
(
Ãxt_tok’_
.
key_id
, 
kKeyIdL’gth
)) {

166 
LOG
(
ERROR
)

168 << 
Bs¦La¡E¼ÜSŒšg
();

169  
	gçl£
;

172 ià(!
G’”©eD”ivedGcmKey
(
Ãxt_tok’_
.
key_id
, &
Ãxt_d”ived_key_
)) {

173 
LOG
(
ERROR
) << "Failedo derive key for GcmCryptor::EncryptBlock: "

174 << 
Bs¦La¡E¼ÜSŒšg
();

175  
	gçl£
;

180 
	gkey_id_couÁ”_
++;

182 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

183 ià(!
EVP_AEAD_CTX_š™
(

184 &
cÚ‹xt
, 
EVP_«ad_«s_256_gcm
(),

185 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
Ãxt_d”ived_key_
.
d©a
()),

186 
kKeyL’gth
, 
kTagL’gth
, 
nuÎ±r
)) {

187 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_š™ faed: " << 
Bs¦La¡E¼ÜSŒšg
();

188 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

189  
	gçl£
;

192 
size_t
 
	gch”‹xt_Ëngth
;

193 
size_t
 
	gmax_ch”‹xt_Ëngth
 = 
kBlockL’gth
 + 
kTagL’gth
;

194 ià(!
EVP_AEAD_CTX_£®
(&
cÚ‹xt
, 
ch”‹xt_d©a
, &
ch”‹xt_Ëngth
,

195 
max_ch”‹xt_Ëngth
, 
Ãxt_tok’_
.
nÚû
, 
kNÚûL’gth
,

196 
¶aš‹xt_d©a
, 
kBlockL’gth
, 
nuÎ±r
, 0)) {

197 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_£® faed: " << 
Bs¦La¡E¼ÜSŒšg
();

198 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

199  
	gçl£
;

202 ià(
	gch”‹xt_Ëngth
 !ğ
max_ch”‹xt_Ëngth
) {

203 
LOG
(
ERROR
) << "EVP_AEAD_CTX_seal failedoƒncrypt complete…laintext, "

204 << "ex³ùed ch”‹xt_Ëngth = " << 
max_ch”‹xt_Ëngth


205 << ",ƒncouÁ”ed ch”‹xt_Ëngth = " << 
ch”‹xt_Ëngth
;

206 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

207  
	gçl£
;

210 
memıy
(
tok’
, 
Ãxt_tok’_
.
d©a
(), 
kTok’L’gth
);

212 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

213  
	gŒue
;

216 
boŞ
 
	gGcmCry±Ü
::
Deüy±Block
(cÚ¡ 
ušt8_t
 *
ch”‹xt_d©a
,

217 cÚ¡ 
ušt8_t
 *
tok’
, ušt8_ˆ*
¶aš‹xt_d©a
) {

218 ià(
	gch”‹xt_d©a
 =ğ
nuÎ±r
 || 
tok’
 ==‚ullptr ||

219 
¶aš‹xt_d©a
 =ğ
nuÎ±r
) {

220 
LOG
(
ERROR
) << "Invalid inputo GcmCryptor::DecryptBlock.";

221  
	gçl£
;

224 cÚ¡ 
Tok’
 *
	gtok
 = 
»š‹½»t_ÿ¡
<cÚ¡ Tok’ *>(
tok’
);

226 
GcmCry±ÜKey
 
	gd”ived_key
;

227 ià(!
G’”©eD”ivedGcmKey
(
tok
->
key_id
, &
d”ived_key
)) {

228 
LOG
(
ERROR
) << "Failedo derive key for GcmCryptor::DecryptBlock: "

229 << 
Bs¦La¡E¼ÜSŒšg
();

230  
	gçl£
;

233 
EVP_AEAD_CTX
 
	gcÚ‹xt
;

234 ià(!
EVP_AEAD_CTX_š™
(&
cÚ‹xt
, 
EVP_«ad_«s_256_gcm
(),

235 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
d”ived_key
.
d©a
()),

236 
kKeyL’gth
, 
kTagL’gth
, 
nuÎ±r
)) {

237 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_š™ faed: " << 
Bs¦La¡E¼ÜSŒšg
();

238 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

239  
	gçl£
;

242 
size_t
 
	g¶aš‹xt_Ëngth
;

243 ià(!
EVP_AEAD_CTX_İ’
(&
cÚ‹xt
, 
¶aš‹xt_d©a
, &
¶aš‹xt_Ëngth
,

244 
kBlockL’gth
, 
tok
->
nÚû
, 
kNÚûL’gth
,

245 
ch”‹xt_d©a
, 
kBlockL’gth
 + 
kTagL’gth
, 
nuÎ±r
,

247 
LOG
(
ERROR
è<< "EVP_AEAD_CTX_İ’ faed: " << 
Bs¦La¡E¼ÜSŒšg
();

248 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

249  
	gçl£
;

252 ià(
	g¶aš‹xt_Ëngth
 !ğ
kBlockL’gth
) {

253 
LOG
(
ERROR
) << "EVP_AEAD_CTX_open failedo decrypt complete ciphertext, "

254 << "ex³ùed…Ïš‹xt_Ëngth = " << 
kBlockL’gth


255 << ",ƒncouÁ”ed…Ïš‹xt_Ëngth = " << 
¶aš‹xt_Ëngth
;

256 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

257  
	gçl£
;

260 
EVP_AEAD_CTX_ş—nup
(&
cÚ‹xt
);

261  
	gŒue
;

264 
boŞ
 
	gGcmCry±Ü
::
G’”©eD”ivedGcmKey
(cÚ¡ 
ušt8_t
 *
key_id
,

265 
GcmCry±ÜKey
 *
dk
) {

266  
G’”©eD”ivedKey
(
kGcmKey
, 
key_id
, 
dk
);

269 
boŞ
 
	gGcmCry±Ü
::
G‘AuthTag
(
ušt8_t
 
out
[16], cÚ¡ ušt8_ˆ*
š
,

270 
size_t
 
š_Ën
) const {

271 ià(1 !ğ
AES_CMAC
(
out
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
kCmacKey
.
d©a
()),

272 
kKeyL’gth
, 
š
, 
š_Ën
)) {

273 
LOG
(
ERROR
è<< "AES_CMAC faed: " << 
Bs¦La¡E¼ÜSŒšg
();

274  
	gçl£
;

277  
	gŒue
;

286 
GcmCry±Ü
 *
	gGcmCry±ÜRegi¡ry
::
G‘GcmCry±Ü
(
size_t
 
block_Ëngth
,

287 cÚ¡ 
GcmCry±ÜKey
 &
key
) {

288 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

290 autØ
	g™
 = 
üy±Ü_»gi¡ry_
.
fšd
(
key
);

291 ià(
	g™
 !ğ
üy±Ü_»gi¡ry_
.
’d
()) {

292  
™
->
£cÚd
.
g‘
();

295 autØ
	g»suÉ
 =

296 
üy±Ü_»gi¡ry_
.
em¶aû
(
key
, 
GcmCry±Ü
::
C»©e
(
block_Ëngth
, key));

297  
	g»suÉ
.
	gfœ¡
->
	g£cÚd
.
g‘
();

	@platform/crypto/gcmlib/gcm_cryptor.h

19 #iâdeà
ASYLO_PLATFORM_CRYPTO_GCMLIB_GCM_CRYPTOR_H_


20 
	#ASYLO_PLATFORM_CRYPTO_GCMLIB_GCM_CRYPTOR_H_


	)

22 
	~<İ’s¦/evp.h
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

28 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g¶©fÜm
 {

33 
Çme¥aû
 
	güy±o
 {

34 
Çme¥aû
 
	ggcmlib
 {

37 
cÚ¡ex´
 
size_t
 
	gkKeyL’gth
 = 32;

40 
cÚ¡ex´
 
size_t
 
	gkTagL’gth
 = 16;

43 
cÚ¡ex´
 
size_t
 
	gkTok’L’gth
 = 44;

46 
cÚ¡ex´
 
size_t
 
	gkKeyIdL’gth
 = 32;

48 
usšg
 
	gGcmCry±ÜKey
 = 
SaãBy‹s
<
kKeyL’gth
>;

51 şas 
	cGcmCry±Ü
 {

52 
	gpublic
:

54 
¡d
::
unique_±r
<
GcmCry±Ü
> 
C»©e
(
size_t
 
block_Ëngth
,

55 cÚ¡ 
GcmCry±ÜKey
 &
ma¡”_key
);

56 
	gvœtu®
 ~
GcmCry±Ü
() = ;

61 
boŞ
 
Enüy±Block
(cÚ¡ 
ušt8_t
 *
¶aš‹xt_d©a
, ušt8_ˆ*
tok’
,

62 
ušt8_t
 *
ch”‹xt_d©a
);

67 
boŞ
 
Deüy±Block
(cÚ¡ 
ušt8_t
 *
ch”‹xt_d©a
, cÚ¡ ušt8_ˆ*
tok’
,

68 
ušt8_t
 *
¶aš‹xt_d©a
);

72 
boŞ
 
G‘AuthTag
(
ušt8_t
 
out
[16], cÚ¡ ušt8_ˆ*
š
, 
size_t
 
š_Ën
) const;

74 
	g´iv©e
:

75 
cÚ¡ex´
 
size_t
 
kNÚûL’gth
 = 12;

76 
cÚ¡ex´
 
size_t
 
	gkKeyIdCyşe
 = 256;

78 
	sTok’
 {

79 
ušt8_t
 
	gnÚû
[
kNÚûL’gth
];

80 
ušt8_t
 
	gkey_id
[
kKeyIdL’gth
];

83 
ušt8_t
 *
d©a
(è{  
	gnÚû
; }

86 
GcmCry±Ü
(
size_t
 
block_Ëngth
, cÚ¡ 
GcmCry±ÜKey
 &
gcm_key
,

87 cÚ¡ 
GcmCry±ÜKey
 &
cmac_key
);

88 
boŞ
 
G’”©eD”ivedGcmKey
(cÚ¡ 
ušt8_t
 *
key_id
, 
GcmCry±ÜKey
 *
dk
);

90 cÚ¡ 
size_t
 
	gkBlockL’gth
;

91 cÚ¡ 
GcmCry±ÜKey
 
	gkGcmKey
;

92 cÚ¡ 
GcmCry±ÜKey
 
	gkCmacKey
;

93 
Tok’
 
Ãxt_tok’_
 
GUARDED_BY
(
mu_
);

94 
ušt64_t
 
	gkey_id_couÁ”_
;

95 
GcmCry±ÜKey
 
Ãxt_d”ived_key_
 
GUARDED_BY
(
mu_
);

96 
	gab¦
::
Mu‹x
 
mu_
;

98 
GcmCry±Ü
(cÚ¡ GcmCry±Ü &èğ
d–‘e
;

99 
	gGcmCry±Ü
 &
	gİ”©Ü
=(cÚ¡ 
GcmCry±Ü
 &èğ
d–‘e
;

104 şas 
	cGcmCry±ÜRegi¡ry
 {

105 
	gpublic
:

106 
GcmCry±ÜRegi¡ry
 &
G‘In¡ªû
() {

107 
GcmCry±ÜRegi¡ry
 *
š¡ªû
 = 
Ãw
 GcmCryptorRegistry;

108  *
	gš¡ªû
;

112 
GcmCry±Ü
 *
G‘GcmCry±Ü
(
size_t
 
block_Ëngth
, cÚ¡ 
GcmCry±ÜKey
 &
key
)

113 
LOCKS_EXCLUDED
(
mu_
);

115 şas 
	cSaãBy‹sHash”
 {

116 
	gpublic
:

117 
size_t
 
İ”©Ü
()(cÚ¡ 
GcmCry±ÜKey
 &
§ã_by‹s
) const {

118 ià(
§ã_by‹s
.
size
() == 0) {

122 
	g¡d
::
hash
<> 
ušt8_hash
;

124 
size_t
 
	g»suÉ
 = 0;

125 cÚ¡ 
	gušt8_t
 &
	g§ã_by‹
 : 
§ã_by‹s
) {

126 
»suÉ
 ^ğ
ušt8_hash
(
§ã_by‹
);

129  
	g»suÉ
;

133 
	g´iv©e
:

134 
GcmCry±ÜRegi¡ry
() = ;

135 
GcmCry±ÜRegi¡ry
(GcmCry±ÜRegi¡ry cÚ¡ &èğ
d–‘e
;

136 
	gİ”©Ü
=(
GcmCry±ÜRegi¡ry
 cÚ¡ &èğ
d–‘e
;

137 
	gab¦
::
æ©_hash_m­
<
GcmCry±ÜKey
, 
	g¡d
::
unique_±r
<
GcmCry±Ü
>,

138 
	gSaãBy‹sHash”
>

139 
üy±Ü_»gi¡ry_
 
GUARDED_BY
(
mu_
);

140 
	gab¦
::
Mu‹x
 
mu_
;

	@platform/crypto/gcmlib/gcm_cryptor_test.cc

21 
	~<İ’s¦/¿nd.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/¶©fÜm/üy±o/gcmlib/gcm_üy±Ü.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
GcmCry±Ü
;

33 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
GcmCry±ÜKey
;

34 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
GcmCry±ÜRegi¡ry
;

35 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kKeyL’gth
;

36 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kTagL’gth
;

37 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kTok’L’gth
;

39 
cÚ¡ex´
 
size_t
 
	gkBlockL’gth
 = 128;

40 
cÚ¡ex´
 
size_t
 
	gkNÚûL’gth
 = 12;

41 
cÚ¡ex´
 
size_t
 
	gkKeyIdL’gth
 = 32;

42 
cÚ¡ex´
 
size_t
 
	gkKeyIdCyşe
 = 256;

45 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±Aá”Enüy±R‘uºsOrigš®Texts
) {

46 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

47 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

48 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

49 
GcmCry±ÜKey
 
	gkey
;

50 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

51 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

52 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

53 cÚ¡ 
	gkNumMes§ges
 = 1000;

54 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

55 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

56 
ušt8_t
 
	gŞd_tok’
[
kTok’L’gth
];

57 
mem£t
(
Şd_tok’
, 0, 
kTok’L’gth
);

58 
	gi
 = 0; i < 
	gkNumMes§ges
; ++i) {

59 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

60 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

61 
EXPECT_NE
(
memcmp
(
Şd_tok’
, 
tok’
, 
kNÚûL’gth
), 0);

63 ià(
	gi
 % 
	gkKeyIdCyşe
 == 0) {

64 
EXPECT_NE
(

65 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

68 
EXPECT_EQ
(

69 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

73 
memıy
(
Şd_tok’
, 
tok’
, 
kTok’L’gth
);

76 
EXPECT_NE
(
memcmp
(
¶aš‹xt
, 
’üy±Ü_bufãr
, 
kBlockL’gth
), 0);

78 
ASSERT_TRUE
(

79 
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’
, 
deüy±Ü_bufãr
));

81 
EXPECT_EQ
(
memcmp
(
¶aš‹xt
, 
deüy±Ü_bufãr
, 
kBlockL’gth
), 0);

86 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±Aá”Enüy±InPÏûR‘uºsOrigš®Texts
) {

87 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

88 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

89 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

90 
GcmCry±ÜKey
 
	gkey
;

91 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

92 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

93 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

94 cÚ¡ 
	gkNumMes§ges
 = 1000;

95 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

96 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

97 
ušt8_t
 
	gŞd_tok’
[
kTok’L’gth
];

98 
mem£t
(
Şd_tok’
, 0, 
kTok’L’gth
);

99 
	gi
 = 0; i < 
	gkNumMes§ges
; ++i) {

100 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

101 
memıy
(
’üy±Ü_bufãr
, 
¶aš‹xt
, 
kBlockL’gth
);

104 
ASSERT_TRUE
(

105 
’üy±Ü
->
Enüy±Block
(
’üy±Ü_bufãr
, 
tok’
,ƒncryptor_buffer));

106 
EXPECT_NE
(
memcmp
(
Şd_tok’
, 
tok’
, 
kNÚûL’gth
), 0);

108 ià(
	gi
 % 
	gkKeyIdCyşe
 == 0) {

109 
EXPECT_NE
(

110 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

113 
EXPECT_EQ
(

114 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

118 
memıy
(
Şd_tok’
, 
tok’
, 
kTok’L’gth
);

119 
memıy
(
deüy±Ü_bufãr
, 
’üy±Ü_bufãr
, 
kBlockL’gth
 + 
kTagL’gth
);

122 
ASSERT_TRUE
(

123 
deüy±Ü
->
Deüy±Block
(
deüy±Ü_bufãr
, 
tok’
, decryptor_buffer));

125 
EXPECT_EQ
(
memcmp
(
¶aš‹xt
, 
deüy±Ü_bufãr
, 
kBlockL’gth
), 0);

130 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±W™hAÉ”edKeyFas
) {

131 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

132 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

133 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

134 
GcmCry±ÜKey
 
	gkey
;

135 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

136 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

137 
GcmCry±ÜKey
 
®‹»d_key
(
key
);

138 (*
	g®‹»d_key
.
d©a
())++;

139 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
®‹»d_key
);

140 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

141 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

142 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

144 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

146 
ASSERT_FALSE
(

147 
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’
, 
deüy±Ü_bufãr
));

151 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±W™hAÉ”edNÚûFas
) {

152 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

153 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

154 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

155 
GcmCry±ÜKey
 
	gkey
;

156 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

157 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

158 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

159 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

160 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

161 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

163 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

165 
ušt8_t
 
	gtok’_®‹»d_nÚû
[
kTok’L’gth
];

166 
memıy
(
tok’_®‹»d_nÚû
, 
tok’
, 
kTok’L’gth
);

167 
ušt8_t
 *
	g·¹Ÿl_nÚû
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
tok’
);

168 
ušt8_t
 *
	g·¹Ÿl_®‹»d_nÚû
 =

169 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
tok’_®‹»d_nÚû
);

170 *
	g·¹Ÿl_®‹»d_nÚû
 = *
·¹Ÿl_nÚû
 + 1;

172 
ASSERT_FALSE
(
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’_®‹»d_nÚû
,

173 
deüy±Ü_bufãr
));

177 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±W™hAÉ”edCh”‹xtFas
) {

178 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

179 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

180 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

181 
GcmCry±ÜKey
 
	gkey
;

182 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

183 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

184 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

185 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

186 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

187 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

189 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

192 ++
	g’üy±Ü_bufãr
[0];

194 
ASSERT_FALSE
(

195 
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’
, 
deüy±Ü_bufãr
));

199 
TEST
(
GcmCry±ÜTe¡
, 
G‘GcmCry±ÜIsCÚsi¡’t
) {

200 
GcmCry±ÜKey
 
	gkey
;

201 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

202 
GcmCry±Ü
 *
	gc1
 =

203 
GcmCry±ÜRegi¡ry
::
G‘In¡ªû
().
G‘GcmCry±Ü
(
kBlockL’gth
, 
key
);

204 
GcmCry±Ü
 *
	gc2
 =

205 
GcmCry±ÜRegi¡ry
::
G‘In¡ªû
().
G‘GcmCry±Ü
(
kBlockL’gth
, 
key
);

207 
EXPECT_NE
(
c1
, 
nuÎ±r
);

209 
EXPECT_EQ
(
c1
, 
c2
);

	@platform/crypto/gcmlib/gcm_cryptor_test.cc

21 
	~<İ’s¦/¿nd.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/üy±o/ut/by‹s.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/¶©fÜm/üy±o/gcmlib/gcm_üy±Ü.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
GcmCry±Ü
;

33 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
GcmCry±ÜKey
;

34 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
GcmCry±ÜRegi¡ry
;

35 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kKeyL’gth
;

36 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kTagL’gth
;

37 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kTok’L’gth
;

39 
cÚ¡ex´
 
size_t
 
	gkBlockL’gth
 = 128;

40 
cÚ¡ex´
 
size_t
 
	gkNÚûL’gth
 = 12;

41 
cÚ¡ex´
 
size_t
 
	gkKeyIdL’gth
 = 32;

42 
cÚ¡ex´
 
size_t
 
	gkKeyIdCyşe
 = 256;

45 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±Aá”Enüy±R‘uºsOrigš®Texts
) {

46 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

47 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

48 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

49 
GcmCry±ÜKey
 
	gkey
;

50 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

51 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

52 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

53 cÚ¡ 
	gkNumMes§ges
 = 1000;

54 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

55 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

56 
ušt8_t
 
	gŞd_tok’
[
kTok’L’gth
];

57 
mem£t
(
Şd_tok’
, 0, 
kTok’L’gth
);

58 
	gi
 = 0; i < 
	gkNumMes§ges
; ++i) {

59 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

60 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

61 
EXPECT_NE
(
memcmp
(
Şd_tok’
, 
tok’
, 
kNÚûL’gth
), 0);

63 ià(
	gi
 % 
	gkKeyIdCyşe
 == 0) {

64 
EXPECT_NE
(

65 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

68 
EXPECT_EQ
(

69 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

73 
memıy
(
Şd_tok’
, 
tok’
, 
kTok’L’gth
);

76 
EXPECT_NE
(
memcmp
(
¶aš‹xt
, 
’üy±Ü_bufãr
, 
kBlockL’gth
), 0);

78 
ASSERT_TRUE
(

79 
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’
, 
deüy±Ü_bufãr
));

81 
EXPECT_EQ
(
memcmp
(
¶aš‹xt
, 
deüy±Ü_bufãr
, 
kBlockL’gth
), 0);

86 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±Aá”Enüy±InPÏûR‘uºsOrigš®Texts
) {

87 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

88 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

89 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

90 
GcmCry±ÜKey
 
	gkey
;

91 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

92 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

93 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

94 cÚ¡ 
	gkNumMes§ges
 = 1000;

95 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

96 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

97 
ušt8_t
 
	gŞd_tok’
[
kTok’L’gth
];

98 
mem£t
(
Şd_tok’
, 0, 
kTok’L’gth
);

99 
	gi
 = 0; i < 
	gkNumMes§ges
; ++i) {

100 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

101 
memıy
(
’üy±Ü_bufãr
, 
¶aš‹xt
, 
kBlockL’gth
);

104 
ASSERT_TRUE
(

105 
’üy±Ü
->
Enüy±Block
(
’üy±Ü_bufãr
, 
tok’
,ƒncryptor_buffer));

106 
EXPECT_NE
(
memcmp
(
Şd_tok’
, 
tok’
, 
kNÚûL’gth
), 0);

108 ià(
	gi
 % 
	gkKeyIdCyşe
 == 0) {

109 
EXPECT_NE
(

110 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

113 
EXPECT_EQ
(

114 
memcmp
(
Şd_tok’
 + 
kNÚûL’gth
, 
tok’
 + kNÚûL’gth, 
kKeyIdL’gth
),

118 
memıy
(
Şd_tok’
, 
tok’
, 
kTok’L’gth
);

119 
memıy
(
deüy±Ü_bufãr
, 
’üy±Ü_bufãr
, 
kBlockL’gth
 + 
kTagL’gth
);

122 
ASSERT_TRUE
(

123 
deüy±Ü
->
Deüy±Block
(
deüy±Ü_bufãr
, 
tok’
, decryptor_buffer));

125 
EXPECT_EQ
(
memcmp
(
¶aš‹xt
, 
deüy±Ü_bufãr
, 
kBlockL’gth
), 0);

130 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±W™hAÉ”edKeyFas
) {

131 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

132 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

133 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

134 
GcmCry±ÜKey
 
	gkey
;

135 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

136 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

137 
GcmCry±ÜKey
 
®‹»d_key
(
key
);

138 (*
	g®‹»d_key
.
d©a
())++;

139 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
®‹»d_key
);

140 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

141 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

142 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

144 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

146 
ASSERT_FALSE
(

147 
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’
, 
deüy±Ü_bufãr
));

151 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±W™hAÉ”edNÚûFas
) {

152 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

153 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

154 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

155 
GcmCry±ÜKey
 
	gkey
;

156 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

157 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

158 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

159 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

160 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

161 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

163 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

165 
ušt8_t
 
	gtok’_®‹»d_nÚû
[
kTok’L’gth
];

166 
memıy
(
tok’_®‹»d_nÚû
, 
tok’
, 
kTok’L’gth
);

167 
ušt8_t
 *
	g·¹Ÿl_nÚû
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
tok’
);

168 
ušt8_t
 *
	g·¹Ÿl_®‹»d_nÚû
 =

169 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
tok’_®‹»d_nÚû
);

170 *
	g·¹Ÿl_®‹»d_nÚû
 = *
·¹Ÿl_nÚû
 + 1;

172 
ASSERT_FALSE
(
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’_®‹»d_nÚû
,

173 
deüy±Ü_bufãr
));

177 
TEST
(
GcmCry±ÜTe¡
, 
Deüy±W™hAÉ”edCh”‹xtFas
) {

178 
ušt8_t
 
	g¶aš‹xt
[
kBlockL’gth
];

179 
ušt8_t
 
	g’üy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

180 
ušt8_t
 
	gdeüy±Ü_bufãr
[
kBlockL’gth
 + 
kTagL’gth
];

181 
GcmCry±ÜKey
 
	gkey
;

182 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

183 autØ
	g’üy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

184 autØ
	gdeüy±Ü
 = 
GcmCry±Ü
::
C»©e
(
kBlockL’gth
, 
key
);

185 
ušt8_t
 
	gtok’
[
kTok’L’gth
];

186 
mem£t
(
tok’
, 0, 
kTok’L’gth
);

187 
ASSERT_EQ
(
RAND_by‹s
(
¶aš‹xt
, 
kBlockL’gth
), 1);

189 
ASSERT_TRUE
(
’üy±Ü
->
Enüy±Block
(
¶aš‹xt
, 
tok’
, 
’üy±Ü_bufãr
));

192 ++
	g’üy±Ü_bufãr
[0];

194 
ASSERT_FALSE
(

195 
deüy±Ü
->
Deüy±Block
(
’üy±Ü_bufãr
, 
tok’
, 
deüy±Ü_bufãr
));

199 
TEST
(
GcmCry±ÜTe¡
, 
G‘GcmCry±ÜIsCÚsi¡’t
) {

200 
GcmCry±ÜKey
 
	gkey
;

201 
ASSERT_EQ
(
RAND_by‹s
(
key
.
d©a
(), key.
size
()), 1);

202 
GcmCry±Ü
 *
	gc1
 =

203 
GcmCry±ÜRegi¡ry
::
G‘In¡ªû
().
G‘GcmCry±Ü
(
kBlockL’gth
, 
key
);

204 
GcmCry±Ü
 *
	gc2
 =

205 
GcmCry±ÜRegi¡ry
::
G‘In¡ªû
().
G‘GcmCry±Ü
(
kBlockL’gth
, 
key
);

207 
EXPECT_NE
(
c1
, 
nuÎ±r
);

209 
EXPECT_EQ
(
c1
, 
c2
);

	@platform/host_call/exit_handler_constants.h

19 #iâdeà
ASYLO_PLATFORM_HOST_CALL_EXIT_HANDLER_CONSTANTS_H_


20 
	#ASYLO_PLATFORM_HOST_CALL_EXIT_HANDLER_CONSTANTS_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gho¡_ÿÎ
 {

35 
cÚ¡ex´
 
ušt64_t
 
	gkSy¡emC®lHªdËr
 = 
´im™ives
::
kS–eùÜHo¡C®l
;

38 
cÚ¡ex´
 
ušt64_t
 
	gkIsA‰yHªdËr
 = 
´im™ives
::
kS–eùÜHo¡C®l
 + 1;

41 
cÚ¡ex´
 
ušt64_t
 
	gkUSË•HªdËr
 = 
´im™ives
::
kS–eùÜHo¡C®l
 + 2;

	@platform/host_call/test/enclave_test_selectors.h

19 #iâdeà
ASYLO_PLATFORM_HOST_CALL_TEST_ENCLAVE_TEST_SELECTORS_H_


20 
	#ASYLO_PLATFORM_HOST_CALL_TEST_ENCLAVE_TEST_SELECTORS_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

25 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¢o.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gho¡_ÿÎ
 {

33 
cÚ¡ex´
 
ušt64_t
 
	gkAbÜtEnşaveS–eùÜ
 = 
´im™ives
::
kS–eùÜU£r
;

37 
cÚ¡ex´
 
ušt64_t
 
	gkFœ¡S–eùÜ
 = 
´im™ives
::
kS–eùÜU£r
 + 1;

41 
cÚ¡ex´
 
ušt64_t
 
	gkNÚSysÿÎFœ¡S–eùÜ
 = 
´im™ives
::
kS–eùÜU£r
 + 1024;

47 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Acûss
 =

48 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_acûss
;

49 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Chmod
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_chmod
;

50 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Clo£
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_şo£
;

51 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Fchmod
 =

52 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_fchmod
;

53 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡G‘Pid
 =

54 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘pid
;

55 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡G‘Ppid
 =

56 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘µid
;

57 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡S‘Sid
 =

58 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_£tsid
;

59 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Kl
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_kl
;

60 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Lšk
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_lšk
;

61 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡L£ek
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_l£ek
;

62 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Mkdœ
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_mkdœ
;

63 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡O³n
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_İ’
;

64 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡UÆšk
 =

65 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_uÆšk
;

66 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Umask
 =

67 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_umask
;

68 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡G‘Uid
 =

69 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘uid
;

70 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡G‘Gid
 =

71 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘gid
;

72 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡G‘Euid
 =

73 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘euid
;

74 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡G‘Egid
 =

75 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘egid
;

76 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡R’ame
 =

77 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_»Çme
;

78 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡R—d
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_»ad
;

79 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Wr™e
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_wr™e
;

80 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Symlšk
 =

81 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_symlšk
;

82 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡R—dLšk
 =

83 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_»adlšk
;

84 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Trunÿ‹
 =

85 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_Œunÿ‹
;

86 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡FTrunÿ‹
 =

87 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_árunÿ‹
;

88 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Rmdœ
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_rmdœ
;

89 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Sock‘
 =

90 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_sock‘
;

91 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Fú
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
;

92 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Chown
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_chown
;

93 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡FChown
 =

94 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_fchown
;

95 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡S‘SockO±
 =

96 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_£tsockİt
;

97 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Flock
 =

98 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_æock
;

99 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡Fsync
 = 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_fsync
;

100 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡InÙifyIn™1
 =

101 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_š™1
;

102 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡InÙifyAddW©ch
 =

103 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_add_w©ch
;

104 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡InÙifyRmW©ch
 =

105 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_rm_w©ch
;

106 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡SchedY›ld
 =

107 
kFœ¡S–eùÜ
 + 
asylo
::
sy¡em_ÿÎ
::
kSYS_sched_y›ld
;

109 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡IsA‰y
 = 
kNÚSysÿÎFœ¡S–eùÜ
;

110 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡USË•
 = 
kNÚSysÿÎFœ¡S–eùÜ
 + 1;

	@platform/host_call/test/host_call_test.cc

19 
	~<fú.h
>

20 
	~<sys/fe.h
>

21 
	~<sys/šÙify.h
>

22 
	~<sys/sock‘.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/ty³s.h
>

26 
	~<¡ršg
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"ab¦/time/şock.h
"

32 
	~"ab¦/time/time.h
"

33 
	~"asylo/¶©fÜm/ho¡_ÿÎ/‹¡/’şave_‹¡_£ËùÜs.h
"

34 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs_š™Ÿliz”.h
"

35 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

36 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

37 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

38 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_funùiÚs.h
"

39 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

40 
	~"asylo/‹¡/ut/‹¡_æags.h
"

42 
	gusšg
 ::
‹¡šg
::
Eq
;

43 
	gusšg
 ::
‹¡šg
::
Gt
;

44 
	gusšg
 ::
‹¡šg
::
NÙ
;

45 
	gusšg
 ::
‹¡šg
::
SŒEq
;

47 
Çme¥aû
 
	gasylo
 {

48 
Çme¥aû
 
	gho¡_ÿÎ
 {

49 
	gÇme¥aû
 {

51 şas 
	cHo¡C®lTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

52 
´Ùeùed
:

58 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> 
LßdTe¡EnşaveOrD›
(

59 
StusOr
<
¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
>>

60 
ex™_ÿÎ_´ovid”
 = 
G‘Ho¡C®lHªdËrsM­pšg
()) {

61 
ASYLO_EXPECT_OK
(
ex™_ÿÎ_´ovid”
);

62 cÚ¡‡utØ
	gş›Á
 =

63 
´im™ives
::
‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

65 
¡d
::
move
(
ex™_ÿÎ_´ovid”
.
V®ueOrD›
()));

67  
	gş›Á
;

70 
S‘Up
(è
	gov”ride
 {

71 
	gş›Á_
 = 
LßdTe¡EnşaveOrD›
();

72 
ASSERT_FALSE
(
ş›Á_
->
IsClo£d
());

75 
T—rDown
(è
	gov”ride
 {

76 
	gş›Á_
->
De¡roy
();

77 
EXPECT_TRUE
(
ş›Á_
->
IsClo£d
());

80 
	g¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> 
ş›Á_
;

86 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Acûss
) {

87 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

88 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

89 
ASSERT_GE
(
fd
, 0);

91 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

92 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

93 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gR_OK
 | 
	gW_OK
);

95 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Acûss
, &
·¿ms
));

96 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

97 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
acûss
(
·th
.
c_¡r
(), 
R_OK
 | 
W_OK
));

101 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡AcûssNÚExi¡’tP©h
) {

102 cÚ¡ *
	g·th
 = "illegal_path";

104 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

105 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
, 
¡¾’
(
·th
) + 1);

106 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gF_OK
);

108 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Acûss
, &
·¿ms
));

109 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

110 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
acûss
(
·th
, 
F_OK
));

116 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Chmod
) {

117 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

120 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

121 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

124 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
DEFFILEMODE
);

125 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

127 
ASSERT_GE
(
fd
, 0);

128 
¡©
 
	gsb
;

129 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

130 
ASSERT_NE
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

131 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

132 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

133 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gDEFFILEMODE
 ^ 
	gS_IRUSR
);

135 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Chmod
, &
·¿ms
));

136 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

137 
ASSERT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

138 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

139 
ASSERT_EQ
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

140 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

144 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡ChmodNÚExi¡’tFe
) {

145 cÚ¡ *
	g·th
 = "illegal_path";

147 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

148 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
, 
¡¾’
(
·th
) + 1);

149 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gS_IWUSR
);

151 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Chmod
, &
·¿ms
));

152 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

153 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(
acûss
(
·th
, 
F_OK
)));

158 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Clo£
) {

159 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

160 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

161 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

162 
ASSERT_GE
(
fd
, 0);

163 
ASSERT_NE
(
fú
(
fd
, 
F_GETFD
), -1);

165 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

166 
	g·¿ms
.
	gPushByCİy
<>(
	gfd
);

168 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Clo£
, &
·¿ms
));

169 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

170 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

175 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Clo£NÚExi¡’tFe
) {

176 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

177 
	g·¿ms
.
	gPushByCİy
<>( 123456);

179 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Clo£
, &
·¿ms
));

180 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

181 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

187 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Fchmod
) {

188 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

191 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

192 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

195 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
DEFFILEMODE
);

196 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

198 
ASSERT_GE
(
fd
, 0);

199 
¡©
 
	gsb
;

200 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

201 
ASSERT_NE
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

202 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

203 
	g·¿ms
.
	gPushByCİy
<>(
	gfd
);

204 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gDEFFILEMODE
 ^ 
	gS_IRUSR
);

206 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fchmod
, &
·¿ms
));

207 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

208 
ASSERT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

209 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

210 
ASSERT_EQ
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

211 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

215 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FchmodNÚExi¡’tFe
) {

216 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

217 
	g·¿ms
.
	gPushByCİy
<>( -1);

218 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gS_IWUSR
);

220 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fchmod
, &
·¿ms
));

221 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

222 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

227 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘pid
) {

228 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

229 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Pid
, &
·¿ms
));

230 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

231 
EXPECT_THAT
(
·¿ms
.
Pİ
<
pid_t
>(), 
Eq
(
g‘pid
()));

236 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘Ppid
) {

237 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

238 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Ppid
, &
·¿ms
));

239 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

240 
EXPECT_THAT
(
·¿ms
.
Pİ
<
pid_t
>(), 
Eq
(
g‘µid
()));

246 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡S‘Sid
) {

247 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

248 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡S‘Sid
, &
·¿ms
));

249 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

250 
EXPECT_THAT
(
·¿ms
.
Pİ
<
pid_t
>(), 
Eq
(
g‘sid
(0)));

256 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Kl
) {

257 
pid_t
 
	gpid
 = 
fÜk
();

258 ià(
	gpid
 == 0) {

259 
¦“p
(1000);

262 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

263 
	g·¿ms
.
	gPushByCİy
<
	gpid_t
>Ğ
	gpid
);

264 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSIGABRT
);

266 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Kl
, &
·¿ms
));

267 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

268 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

274 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Lšk
) {

275 
	g¡d
::
¡ršg
 
Şd·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/old_name.tmp");

276 
	g¡d
::
¡ršg
 
Ãw·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/new_name.tmp");

278 
	gfd
 = 
İ’
(
Şd·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

279 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

280 
ASSERT_GE
(
fd
, 0);

281 
ASSERT_NE
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), -1);

283 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

284 
	g·¿ms
.
	gPushByCİy
<>(
	gŞd·th
.
c_¡r
(), old·th.
Ëngth
() + 1);

285 
	g·¿ms
.
	gPushByCİy
<>(
	gÃw·th
.
c_¡r
(),‚ew·th.
Ëngth
() + 1);

287 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Lšk
, &
·¿ms
));

288 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

290 
EXPECT_NE
(
acûss
(
Ãw·th
.
c_¡r
(), 
F_OK
), -1);

291 
EXPECT_NE
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), -1);

297 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡L£ek
) {

298 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

300 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

301 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

302 
ASSERT_GE
(
fd
, 0);

303 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

304 
EXPECT_THAT
(
wr™e
(
fd
, "h–lo", 5), 
Eq
(5));

306 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

307 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

308 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>( 2);

309 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSEEK_SET
);

311 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡L£ek
, &
·¿ms
));

312 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

313 
EXPECT_THAT
(
·¿ms
.
Pİ
<
off_t
>(), 
Eq
(2));

316 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡L£ekBadR‘uº
) {

317 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

319 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

320 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

321 
ASSERT_GE
(
fd
, 0);

322 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

323 
EXPECT_THAT
(
wr™e
(
fd
, "h–lo", 5), 
Eq
(5));

325 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

326 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

327 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>( 0);

328 
	g·¿ms
.
	gPushByCİy
<>( 1000);

330 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡L£ek
, &
·¿ms
));

331 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

332 
EXPECT_THAT
(
·¿ms
.
Pİ
<
off_t
>(), 
Eq
(-1));

337 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Mkdœ
) {

338 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/dir_to_make");

340 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

341 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

342 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>( 0777);

344 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Mkdœ
, &
·¿ms
));

345 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

346 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

348 
¡©
 
	gsb
;

349 
EXPECT_TRUE
(
¡©
(
·th
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISDIR
(sb.
¡_mode
));

352 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡MkdœNÚExi¡’tP©h
) {

353 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
("/non-existent-path/dir_to_make");

355 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

356 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

357 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>( 0777);

359 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Mkdœ
, &
·¿ms
));

360 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

361 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

366 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡O³n
) {

367 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

369 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

370 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

371 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gO_RDWR
 | 
	gO_CREAT
 | 
	gO_TRUNC
);

372 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gS_IRUSR
 | 
	gS_IWUSR
);

374 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡O³n
, &
·¿ms
));

375 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

376 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

377 
EXPECT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

382 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡O³nExi¡šgFe
) {

383 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

385 
ü—t
(
·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

386 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

388 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

389 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

390 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gO_RDWR
 | 
	gO_CREAT
 | 
	gO_TRUNC
);

392 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡O³n
, &
·¿ms
));

393 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

394 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

395 
EXPECT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

400 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡UÆšk
) {

401 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

402 
ü—t
(
·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

403 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

405 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

406 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

408 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡UÆšk
, &
·¿ms
));

409 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

410 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

411 
EXPECT_THAT
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), 
Eq
(-1));

414 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡UÆškNÚExi¡šgFe
) {

415 cÚ¡ *
	g·th
 = "obviously-illegal-file.tmp";

416 
ASSERT_THAT
(
acûss
(
·th
, 
F_OK
), 
Eq
(-1));

418 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

419 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
, 
¡¾’
(
·th
) + 1);

421 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡UÆšk
, &
·¿ms
));

422 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

423 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

428 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘uid
) {

429 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

430 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Uid
, &
·¿ms
));

431 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

432 
EXPECT_THAT
(
·¿ms
.
Pİ
<
uid_t
>(), 
Eq
(
g‘uid
()));

438 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Umask
) {

439 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

440 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gS_IWGRP
 | 
	gS_IWOTH
);

441 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Umask
, &
·¿ms
));

442 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

443 
mode_t
 
	gdeçuÉ_mode
 = 
·¿ms
.
Pİ
<mode_t>();

445 
¡©
 
	gsb
;

446 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/dir_to_make");

449 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

450 
EXPECT_NE
(
rmdœ
(
·th
.
c_¡r
()), -1);

453 
EXPECT_NE
(
mkdœ
(
·th
.
c_¡r
(), 
DEFFILEMODE
), -1);

454 
EXPECT_TRUE
(
¡©
(
·th
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISDIR
(sb.
¡_mode
));

455 
EXPECT_TRUE
(!(
sb
.
¡_mode
 & 
S_IWGRP
è&& !(sb.¡_mod& 
S_IWOTH
));

456 
EXPECT_NE
(
rmdœ
(
·th
.
c_¡r
()), -1);

458 
	g·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

460 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

461 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

464 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
DEFFILEMODE
);

465 
ASSERT_GE
(
fd
, 0);

466 
EXPECT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

467 
EXPECT_TRUE
(
¡©
(
·th
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISREG
(sb.
¡_mode
));

468 
EXPECT_TRUE
(!(
sb
.
¡_mode
 & 
S_IWGRP
è&& !(sb.¡_mod& 
S_IWOTH
));

469 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

471 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gdeçuÉ_mode
);

472 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Umask
, &
·¿ms
));

473 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

474 
ASSERT_THAT
(
·¿ms
.
Pİ
<
mode_t
>(), 
Eq
(
S_IWGRP
 | 
S_IWOTH
));

479 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘gid
) {

480 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

481 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Gid
, &
·¿ms
));

482 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

483 
EXPECT_THAT
(
·¿ms
.
Pİ
<
gid_t
>(), 
Eq
(
g‘gid
()));

488 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘Euid
) {

489 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

490 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Euid
, &
·¿ms
));

491 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

492 
EXPECT_THAT
(
·¿ms
.
Pİ
<
uid_t
>(), 
Eq
(
g‘euid
()));

497 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘Egid
) {

498 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

499 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Egid
, &
·¿ms
));

500 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

501 
EXPECT_THAT
(
·¿ms
.
Pİ
<
gid_t
>(), 
Eq
(
g‘egid
()));

506 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡R’ame
) {

507 
	g¡d
::
¡ršg
 
Şd·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/oldname.tmp");

508 
	g¡d
::
¡ršg
 
Ãw·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/newname.tmp");

510 
ü—t
(
Şd·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

511 
ASSERT_NE
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), -1);

513 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

514 
	g·¿ms
.
	gPushByCİy
<>(
	gŞd·th
.
c_¡r
(), 
¡¾’
(
Şd·th
.c_str()) + 1);

515 
	g·¿ms
.
	gPushByCİy
<>(
	gÃw·th
.
c_¡r
(), 
¡¾’
(
Ãw·th
.c_str()) + 1);

517 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡R’ame
, &
·¿ms
));

518 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

519 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

521 
EXPECT_THAT
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), 
Eq
(-1));

522 
EXPECT_NE
(
acûss
(
Ãw·th
.
c_¡r
(), 
F_OK
), -1);

528 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡R—d
) {

529 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

531 
	gfd
 =

532 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

533 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

534 
ASSERT_GE
(
fd
, 0);

535 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

537 
	g¡d
::
¡ršg
 
ex³ùed_cÚ‹Á
 = "this is what's being„ead!";

538 
ASSERT_THAT
(

539 
wr™e
(
fd
, 
ex³ùed_cÚ‹Á
.
c_¡r
(),ƒx³ùed_cÚ‹Á.
Ëngth
() + 1),

540 
Eq
(
ex³ùed_cÚ‹Á
.
Ëngth
() + 1));

541 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

545 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

546 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

547 
	g·¿ms
.
	gPushByCİy
<
	gsize_t
>Ğ
	gex³ùed_cÚ‹Á
.
Ëngth
() + 1);

548 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡R—d
, &
·¿ms
));

549 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(2));

550 
EXPECT_THAT
(
·¿ms
.
Pİ
()->
As
<>(), 
SŒEq
(
ex³ùed_cÚ‹Á
));

551 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ssize_t
>(), 
Eq
(
ex³ùed_cÚ‹Á
.
Ëngth
() + 1));

557 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Wr™e
) {

558 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

560 
	gfd
 =

561 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

562 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

563 
ASSERT_GE
(
fd
, 0);

564 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

566 
	g¡d
::
¡ršg
 
wr™e_buf
 = "texto be written";

567 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

568 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

569 
	g·¿ms
.
	gPushByCİy
<>(
	gwr™e_buf
.
c_¡r
(), wr™e_buf.
Ëngth
() + 1);

570 
	g·¿ms
.
	gPushByCİy
<
	gsize_t
>Ğ
	gwr™e_buf
.
Ëngth
() + 1);

572 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Wr™e
, &
·¿ms
));

573 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

574 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ssize_t
>(), 
Eq
(
wr™e_buf
.
Ëngth
() + 1));

576 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

577 
	g»ad_buf
[20];

578 
EXPECT_THAT
(
»ad
(
fd
, 
»ad_buf
, 
wr™e_buf
.
Ëngth
() + 1),

579 
Eq
(
wr™e_buf
.
Ëngth
() + 1));

580 
EXPECT_THAT
(
»ad_buf
, 
SŒEq
(
wr™e_buf
));

585 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Symlšk
) {

586 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

587 
	g¡d
::
¡ršg
 
rg‘
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/target.tmp");

589 
	gfd
 =

590 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

591 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

592 
ASSERT_GE
(
fd
, 0);

593 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

595 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

596 
	g·¿ms
.
	gPushByCİy
<>(
	g‹¡_fe
.
c_¡r
(),e¡_fe.
Ëngth
() + 1);

597 
	g·¿ms
.
	gPushByCİy
<>(
	grg‘
.
c_¡r
(),¬g‘.
Ëngth
() + 1);

599 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Symlšk
, &
·¿ms
));

600 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

601 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

602 
EXPECT_NE
(
acûss
(
rg‘
.
c_¡r
(), 
F_OK
), -1);

608 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡R—dlšk
) {

609 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

610 
	g¡d
::
¡ršg
 
sym_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_sym_file.tmp");

612 
	gfd
 =

613 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

614 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

615 
ASSERT_GE
(
fd
, 0);

616 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

619 
ASSERT_THAT
(
symlšk
(
‹¡_fe
.
c_¡r
(), 
sym_fe
.c_¡r()), 
Eq
(0));

621 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

622 
	g·¿ms
.
	gPushByCİy
<>(
	gsym_fe
.
c_¡r
(), sym_fe.
Ëngth
() + 1);

624 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡R—dLšk
, &
·¿ms
));

626 
	gbuf_ex³ùed
[
PATH_MAX
];

627 
ssize_t
 
	gËn_ex³ùed
 =

628 
»adlšk
(
sym_fe
.
c_¡r
(), 
buf_ex³ùed
, (buf_expected) - 1);

629 
	gbuf_ex³ùed
[
Ën_ex³ùed
] = '\0';

631 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(2));

632 
EXPECT_THAT
(
·¿ms
.
Pİ
()->
As
<>(), 
SŒEq
(
buf_ex³ùed
));

633 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ssize_t
>(), 
Eq
(
Ën_ex³ùed
));

639 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Trunÿ‹
) {

640 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

641 
	gfd
 =

642 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

643 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

644 
ASSERT_GE
(
fd
, 0);

645 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

648 
	g¡d
::
¡ršg
 
fe_cÚ‹Á
 = "some„andom content.";

649 
ASSERT_THAT
(
wr™e
(
fd
, 
fe_cÚ‹Á
.
c_¡r
(), fe_cÚ‹Á.
Ëngth
() + 1),

650 
Eq
(
fe_cÚ‹Á
.
Ëngth
() + 1));

652 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

653 
cÚ¡ex´
 
	gkTruncL’
 = 5;

654 
	g·¿ms
.
	gPushByCİy
<>(
	g‹¡_fe
.
c_¡r
(),e¡_fe.
Ëngth
() + 1);

655 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>Ğ
	gkTruncL’
);

657 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Trunÿ‹
, &
·¿ms
));

658 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

659 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 0);

662 
	g»ad_buf
[10];

663 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

664 
EXPECT_THAT
(
»ad
(
fd
, 
»ad_buf
, 10), 
Eq
(
kTruncL’
));

665 
	g»ad_buf
[
kTruncL’
] = '\0';

666 
EXPECT_THAT
(
»ad_buf
, 
SŒEq
(
fe_cÚ‹Á
.
sub¡r
(0, 
kTruncL’
)));

672 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FTrunÿ‹
) {

673 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

674 
	gfd
 =

675 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

676 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

677 
ASSERT_GE
(
fd
, 0);

678 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

681 
	g¡d
::
¡ršg
 
fe_cÚ‹Á
 = "some„andom content.";

682 
ASSERT_THAT
(
wr™e
(
fd
, 
fe_cÚ‹Á
.
c_¡r
(), fe_cÚ‹Á.
Ëngth
() + 1),

683 
Eq
(
fe_cÚ‹Á
.
Ëngth
() + 1));

685 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

686 
cÚ¡ex´
 
	gkTruncL’
 = 5;

687 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

688 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>Ğ
	gkTruncL’
);

690 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FTrunÿ‹
, &
·¿ms
));

691 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

692 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 0);

695 
	g»ad_buf
[10];

696 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

697 
EXPECT_THAT
(
»ad
(
fd
, 
»ad_buf
, 10), 
Eq
(
kTruncL’
));

698 
	g»ad_buf
[
kTruncL’
] = '\0';

699 
EXPECT_THAT
(
»ad_buf
, 
SŒEq
(
fe_cÚ‹Á
.
sub¡r
(0, 
kTruncL’
)));

702 
	g·¿ms
.
	gPushByCİy
<>( -1);

703 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>Ğ
	gkTruncL’
);

705 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FTrunÿ‹
, &
·¿ms
));

706 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

707 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), -1);

712 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Rmdœ
) {

713 
	g¡d
::
¡ršg
 
dœ_to_d–
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/dir_to_del");

714 
ASSERT_THAT
(
mkdœ
(
dœ_to_d–
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
), 
Eq
(0));

716 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

717 
	g·¿ms
.
	gPushByCİy
<>(
	gdœ_to_d–
.
c_¡r
(), dœ_to_d–.
Ëngth
() + 1);

719 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Rmdœ
, &
·¿ms
));

720 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

721 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

724 
¡©
 
	gsb
;

725 
EXPECT_FALSE
(
¡©
(
dœ_to_d–
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISDIR
(sb.
¡_mode
));

730 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Sock‘
) {

731 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

733 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gAF_INET6
);

734 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSOCK_STREAM
);

735 
	g·¿ms
.
	gPushByCİy
<>( 0);

737 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Sock‘
, &
·¿ms
));

738 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

739 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

743 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gAF_UNIX
);

744 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSOCK_STREAM
);

745 
	g·¿ms
.
	gPushByCİy
<>( 0);

747 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Sock‘
, &
·¿ms
));

748 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

749 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

755 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Fú
) {

756 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

757 
	gfd
 =

758 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

759 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

760 
ASSERT_GE
(
fd
, 0);

761 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

764 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

765 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

766 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gF_GETFL
);

767 
	g·¿ms
.
	gPushByCİy
<>( 0);

768 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fú
, &
·¿ms
));

769 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

771 
	gfú_»tuº
;

772 
	gklšux_fú_»tuº
 = 
fú
(
fd
, 
F_GETFL
, 0);

773 
FromkLšuxFeStusFÏg
(&
klšux_fú_»tuº
, &
fú_»tuº
);

774 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(
fú_»tuº
));

777 
	gæags_to_£t
 = 
O_APPEND
 | 
O_NONBLOCK
 | 
O_RDONLY
;

778 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

779 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gF_SETFL
);

780 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gæags_to_£t
);

781 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fú
, &
·¿ms
));

782 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

784 
	gklšux_fú_»tuº
 = 
fú
(
fd
, 
F_SETFL
, 
æags_to_£t
);

785 
FromkLšuxFeStusFÏg
(&
klšux_fú_»tuº
, &
fú_»tuº
);

786 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(
fú_»tuº
));

789 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FúInv®idCmd
) {

790 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

791 
	g·¿ms
.
	gPushByCİy
<>( 0);

792 
	g·¿ms
.
	gPushByCİy
<>( 10000000);

793 
	g·¿ms
.
	gPushByCİy
<>( 0);

794 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fú
, &
·¿ms
));

795 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

796 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

801 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Chown
) {

802 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

803 
	gfd
 =

804 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

805 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

806 
ASSERT_GE
(
fd
, 0);

807 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

809 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

810 
	g·¿ms
.
	gPushByCİy
<>(
	g‹¡_fe
.
c_¡r
(),e¡_fe.
Ëngth
() + 1);

811 
	g·¿ms
.
	gPushByCİy
<
	guid_t
>Ğ
g‘uid
());

812 
	g·¿ms
.
	gPushByCİy
<
	ggid_t
>Ğ
g‘gid
());

814 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Chown
, &
·¿ms
));

815 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

816 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

821 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FChown
) {

822 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "test_file.tmp");

823 
	gfd
 =

824 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

825 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

826 
ASSERT_GE
(
fd
, 0);

827 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

829 
¡©
 
	gsb
 = {};

830 
EXPECT_THAT
(
f¡©
(
fd
, &
sb
), 
Eq
(0));

831 
EXPECT_THAT
(
sb
.
¡_uid
, 
Eq
(
g‘uid
()));

832 
EXPECT_THAT
(
sb
.
¡_gid
, 
Eq
(
g‘gid
()));

834 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

835 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

836 
	g·¿ms
.
	gPushByCİy
<
	guid_t
>Ğ
g‘uid
());

837 
	g·¿ms
.
	gPushByCİy
<
	ggid_t
>Ğ
g‘gid
());

839 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FChown
, &
·¿ms
));

840 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

841 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

844 
	g·¿ms
.
	gPushByCİy
<>( -1);

845 
	g·¿ms
.
	gPushByCİy
<
	guid_t
>Ğ
g‘uid
());

846 
	g·¿ms
.
	gPushByCİy
<
	ggid_t
>Ğ
g‘gid
());

848 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FChown
, &
·¿ms
));

849 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

850 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

858 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡S‘SockO±
) {

860 
	gsock‘_fd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

861 
EXPECT_THAT
(
sock‘_fd
, 
Gt
(0));

866 
sockaddr_š6
 
	g§
;

867 
mem£t
(&
§
, 0, (sa));

868 
	g§
.
	gsš6_çmy
 = 
AF_INET6
;

869 
	g§
.
	gsš6_æowšfo
 = 0;

870 
	g§
.
	gsš6_addr
 = 
š6addr_ªy
;

871 
	g§
.
	gsš6_pÜt
 = 
htÚs
(0);

872 
EXPECT_THAT
(

873 
bšd
(
sock‘_fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
§
), (sa)),

874 
NÙ
(
Eq
(-1)));

876 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

877 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gsock‘_fd
);

878 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSOL_SOCKET
);

879 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSO_REUSEADDR
);

880 
	g·¿ms
.
	gPushByCİy
<>( 1);

882 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡S‘SockO±
, &
·¿ms
));

883 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

884 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(-1));

886 
şo£
(
sock‘_fd
);

896 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Flock
) {

897 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

899 
	gfd
 =

900 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

901 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

902 
ASSERT_GE
(
fd
, 0);

903 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

905 
	gklšux_lock
 = 
LOCK_EX
;

906 
	glock
;

907 
FromkLšuxFLockO³¿tiÚ
(&
klšux_lock
, &
lock
);

908 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

909 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

910 
	g·¿ms
.
	gPushByCİy
<>Ğ
	glock
);

912 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Flock
, &
·¿ms
));

913 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

914 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

915 
æock
(
fd
, 
LOCK_UN
);

920 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Fsync
) {

921 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "test_file.tmp");

922 
	gfd
 =

923 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

924 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

925 
ASSERT_GE
(
fd
, 0);

926 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

929 
	g¡d
::
¡ršg
 
fe_cÚ‹Á
 = "some„andom content.";

930 
ASSERT_THAT
(
wr™e
(
fd
, 
fe_cÚ‹Á
.
c_¡r
(), fe_cÚ‹Á.
Ëngth
() + 1),

931 
Eq
(
fe_cÚ‹Á
.
Ëngth
() + 1));

933 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

934 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

936 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fsync
, &
·¿ms
));

937 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

938 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

945 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡InÙifyIn™1
) {

946 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

947 
	gšÙify_æag
;

948 
	gklšux_šÙify_æag
 = 
IN_NONBLOCK
;

949 
FromkLšuxInÙifyFÏg
(&
klšux_šÙify_æag
, &
šÙify_æag
);

950 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gšÙify_æag
);

952 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡InÙifyIn™1
, &
·¿ms
));

953 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

954 
	gšÙify_fd
 = 
·¿ms
.
Pİ
<>();

955 
EXPECT_THAT
(
šÙify_fd
, 
Gt
(0));

956 
şo£
(
šÙify_fd
);

963 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡InÙifyAddW©ch
) {

964 
	gšÙify_fd
 = 
šÙify_š™1
(
IN_NONBLOCK
);

965 
ASSERT_THAT
(
šÙify_fd
, 
Gt
(0));

969 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

970 
	g·¿ms
.
	gPushByCİy
<>(
	gšÙify_fd
);

971 
	g·¿ms
.
	gPushByCİy
<>(
	gFLAGS_‹¡_tmpdœ
.
c_¡r
(),

972 
	gFLAGS_‹¡_tmpdœ
.
Ëngth
() + 1);

974 
	gev’t_mask
;

975 
	gklšux_ev’t_mask
 = 
IN_ALL_EVENTS
;

976 
FromkLšuxInÙifyEv’tMask
(&
klšux_ev’t_mask
, &
ev’t_mask
);

977 
	g·¿ms
.
	gPushByCİy
<>(
	gev’t_mask
);

978 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡InÙifyAddW©ch
, &
·¿ms
));

979 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

980 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(1));

983 
cÚ¡ex´
 
size_t
 
	gev’t_size
 = (
šÙify_ev’t
);

984 
cÚ¡ex´
 
size_t
 
	gbuf_Ën
 = 10 * (
ev’t_size
 + 
NAME_MAX
 + 1);

985 
	gbuf
[
buf_Ën
];

986 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Eq
(-1));

989 
	g¡d
::
¡ršg
 
fe_Çme
 = "test_file.tmp";

990 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
fe_Çme
);

991 
	gfd
 =

992 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

993 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

994 
ASSERT_GE
(
fd
, 0);

995 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

998 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Gt
(0));

1000 autØ*
	gev’t
 = 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[0]);

1001 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_MODIFY
));

1002 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1003 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1005 
	gev’t
 =

1006 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[
ev’t_size
 + 
ev’t
->
Ën
]);

1007 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_OPEN
));

1008 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1009 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1011 
şo£
(
šÙify_fd
);

1017 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡InÙifyRmW©ch
) {

1018 
	gšÙify_fd
 = 
šÙify_š™1
(
IN_NONBLOCK
);

1019 
	gwd
 =

1020 
šÙify_add_w©ch
(
šÙify_fd
, 
FLAGS_‹¡_tmpdœ
.
c_¡r
(), 
IN_ALL_EVENTS
);

1021 
ASSERT_THAT
(
šÙify_fd
, 
Gt
(0));

1022 
ASSERT_THAT
(
wd
, 
Eq
(1));

1025 
	g¡d
::
¡ršg
 
fe_Çme
 = "test_file.tmp";

1026 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
fe_Çme
);

1027 
	gfd
 =

1028 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

1029 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

1030 
ASSERT_GE
(
fd
, 0);

1031 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

1034 
cÚ¡ex´
 
size_t
 
	gev’t_size
 = (
šÙify_ev’t
);

1035 
cÚ¡ex´
 
size_t
 
	gbuf_Ën
 = 10 * (
ev’t_size
 + 
NAME_MAX
 + 1);

1036 
	gbuf
[
buf_Ën
];

1037 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Gt
(0));

1039 autØ*
	gev’t
 = 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[0]);

1040 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_MODIFY
));

1041 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1042 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1044 
	gev’t
 =

1045 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[
ev’t_size
 + 
ev’t
->
Ën
]);

1046 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_OPEN
));

1047 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1048 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1051 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1052 
	g·¿ms
.
	gPushByCİy
<>(
	gšÙify_fd
);

1053 
	g·¿ms
.
	gPushByCİy
<>(
	gwd
);

1054 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡InÙifyRmW©ch
, &
·¿ms
));

1055 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1056 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1059 
ASSERT_THAT
(
uÆšk
(
‹¡_fe
.
c_¡r
()), 
Eq
(0));

1062 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Gt
(-1));

1063 
şo£
(
šÙify_fd
);

1068 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡SchedY›ld
) {

1069 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1071 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡SchedY›ld
, &
·¿ms
));

1072 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1073 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1078 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡IsA‰y
) {

1079 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "test_file.tmp");

1080 
	gfd
 =

1081 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

1082 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

1083 
ASSERT_GE
(
fd
, 0);

1084 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

1086 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1087 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

1089 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡IsA‰y
, &
·¿ms
));

1090 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1091 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1097 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡USË•
) {

1098 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1103 
	g·¿ms
.
	gPushByCİy
<>( 1000000);

1105 
	gab¦
::
Time
 
¡¬t
 = 
ab¦
::
Now
();

1106 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡USË•
, &
·¿ms
));

1107 
	gab¦
::
Time
 
’d
 = 
ab¦
::
Now
();

1109 autØ
	gdu¿tiÚ
 = 
ab¦
::
ToIÁ64Mli£cÚds
(
’d
 - 
¡¬t
);

1111 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1112 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1113 
EXPECT_GE
(
du¿tiÚ
, 1000);

1114 
EXPECT_LE
(
du¿tiÚ
, 1200);

1121 
	$maš
(
¬gc
, *
¬gv
[]) {

1122 ::
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

1123 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

1125  
	`RUN_ALL_TESTS
();

1126 
	}
}

	@platform/host_call/test/host_call_test.cc

19 
	~<fú.h
>

20 
	~<sys/fe.h
>

21 
	~<sys/šÙify.h
>

22 
	~<sys/sock‘.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/ty³s.h
>

26 
	~<¡ršg
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"ab¦/time/şock.h
"

32 
	~"ab¦/time/time.h
"

33 
	~"asylo/¶©fÜm/ho¡_ÿÎ/‹¡/’şave_‹¡_£ËùÜs.h
"

34 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs_š™Ÿliz”.h
"

35 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

36 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

37 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

38 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_funùiÚs.h
"

39 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

40 
	~"asylo/‹¡/ut/‹¡_æags.h
"

42 
	gusšg
 ::
‹¡šg
::
Eq
;

43 
	gusšg
 ::
‹¡šg
::
Gt
;

44 
	gusšg
 ::
‹¡šg
::
NÙ
;

45 
	gusšg
 ::
‹¡šg
::
SŒEq
;

47 
Çme¥aû
 
	gasylo
 {

48 
Çme¥aû
 
	gho¡_ÿÎ
 {

49 
	gÇme¥aû
 {

51 şas 
	cHo¡C®lTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

52 
´Ùeùed
:

58 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> 
LßdTe¡EnşaveOrD›
(

59 
StusOr
<
¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
>>

60 
ex™_ÿÎ_´ovid”
 = 
G‘Ho¡C®lHªdËrsM­pšg
()) {

61 
ASYLO_EXPECT_OK
(
ex™_ÿÎ_´ovid”
);

62 cÚ¡‡utØ
	gş›Á
 =

63 
´im™ives
::
‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

65 
¡d
::
move
(
ex™_ÿÎ_´ovid”
.
V®ueOrD›
()));

67  
	gş›Á
;

70 
S‘Up
(è
	gov”ride
 {

71 
	gş›Á_
 = 
LßdTe¡EnşaveOrD›
();

72 
ASSERT_FALSE
(
ş›Á_
->
IsClo£d
());

75 
T—rDown
(è
	gov”ride
 {

76 
	gş›Á_
->
De¡roy
();

77 
EXPECT_TRUE
(
ş›Á_
->
IsClo£d
());

80 
	g¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> 
ş›Á_
;

86 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Acûss
) {

87 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

88 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

89 
ASSERT_GE
(
fd
, 0);

91 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

92 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

93 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gR_OK
 | 
	gW_OK
);

95 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Acûss
, &
·¿ms
));

96 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

97 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
acûss
(
·th
.
c_¡r
(), 
R_OK
 | 
W_OK
));

101 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡AcûssNÚExi¡’tP©h
) {

102 cÚ¡ *
	g·th
 = "illegal_path";

104 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

105 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
, 
¡¾’
(
·th
) + 1);

106 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gF_OK
);

108 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Acûss
, &
·¿ms
));

109 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

110 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
acûss
(
·th
, 
F_OK
));

116 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Chmod
) {

117 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

120 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

121 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

124 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
DEFFILEMODE
);

125 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

127 
ASSERT_GE
(
fd
, 0);

128 
¡©
 
	gsb
;

129 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

130 
ASSERT_NE
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

131 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

132 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

133 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gDEFFILEMODE
 ^ 
	gS_IRUSR
);

135 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Chmod
, &
·¿ms
));

136 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

137 
ASSERT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

138 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

139 
ASSERT_EQ
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

140 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

144 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡ChmodNÚExi¡’tFe
) {

145 cÚ¡ *
	g·th
 = "illegal_path";

147 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

148 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
, 
¡¾’
(
·th
) + 1);

149 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gS_IWUSR
);

151 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Chmod
, &
·¿ms
));

152 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

153 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(
acûss
(
·th
, 
F_OK
)));

158 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Clo£
) {

159 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

160 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

161 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

162 
ASSERT_GE
(
fd
, 0);

163 
ASSERT_NE
(
fú
(
fd
, 
F_GETFD
), -1);

165 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

166 
	g·¿ms
.
	gPushByCİy
<>(
	gfd
);

168 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Clo£
, &
·¿ms
));

169 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

170 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

175 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Clo£NÚExi¡’tFe
) {

176 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

177 
	g·¿ms
.
	gPushByCİy
<>( 123456);

179 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Clo£
, &
·¿ms
));

180 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

181 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

187 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Fchmod
) {

188 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

191 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

192 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

195 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
DEFFILEMODE
);

196 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

198 
ASSERT_GE
(
fd
, 0);

199 
¡©
 
	gsb
;

200 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

201 
ASSERT_NE
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

202 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

203 
	g·¿ms
.
	gPushByCİy
<>(
	gfd
);

204 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gDEFFILEMODE
 ^ 
	gS_IRUSR
);

206 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fchmod
, &
·¿ms
));

207 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

208 
ASSERT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

209 
ASSERT_NE
(
¡©
(
·th
.
c_¡r
(), &
sb
), -1);

210 
ASSERT_EQ
((
sb
.
¡_mode
 & 
S_IRUSR
), 0);

211 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

215 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FchmodNÚExi¡’tFe
) {

216 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

217 
	g·¿ms
.
	gPushByCİy
<>( -1);

218 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gS_IWUSR
);

220 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fchmod
, &
·¿ms
));

221 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

222 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

227 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘pid
) {

228 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

229 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Pid
, &
·¿ms
));

230 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

231 
EXPECT_THAT
(
·¿ms
.
Pİ
<
pid_t
>(), 
Eq
(
g‘pid
()));

236 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘Ppid
) {

237 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

238 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Ppid
, &
·¿ms
));

239 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

240 
EXPECT_THAT
(
·¿ms
.
Pİ
<
pid_t
>(), 
Eq
(
g‘µid
()));

246 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡S‘Sid
) {

247 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

248 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡S‘Sid
, &
·¿ms
));

249 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

250 
EXPECT_THAT
(
·¿ms
.
Pİ
<
pid_t
>(), 
Eq
(
g‘sid
(0)));

256 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Kl
) {

257 
pid_t
 
	gpid
 = 
fÜk
();

258 ià(
	gpid
 == 0) {

259 
¦“p
(1000);

262 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

263 
	g·¿ms
.
	gPushByCİy
<
	gpid_t
>Ğ
	gpid
);

264 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSIGABRT
);

266 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Kl
, &
·¿ms
));

267 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

268 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

274 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Lšk
) {

275 
	g¡d
::
¡ršg
 
Şd·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/old_name.tmp");

276 
	g¡d
::
¡ršg
 
Ãw·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/new_name.tmp");

278 
	gfd
 = 
İ’
(
Şd·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

279 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

280 
ASSERT_GE
(
fd
, 0);

281 
ASSERT_NE
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), -1);

283 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

284 
	g·¿ms
.
	gPushByCİy
<>(
	gŞd·th
.
c_¡r
(), old·th.
Ëngth
() + 1);

285 
	g·¿ms
.
	gPushByCİy
<>(
	gÃw·th
.
c_¡r
(),‚ew·th.
Ëngth
() + 1);

287 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Lšk
, &
·¿ms
));

288 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

290 
EXPECT_NE
(
acûss
(
Ãw·th
.
c_¡r
(), 
F_OK
), -1);

291 
EXPECT_NE
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), -1);

297 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡L£ek
) {

298 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

300 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

301 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

302 
ASSERT_GE
(
fd
, 0);

303 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

304 
EXPECT_THAT
(
wr™e
(
fd
, "h–lo", 5), 
Eq
(5));

306 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

307 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

308 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>( 2);

309 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSEEK_SET
);

311 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡L£ek
, &
·¿ms
));

312 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

313 
EXPECT_THAT
(
·¿ms
.
Pİ
<
off_t
>(), 
Eq
(2));

316 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡L£ekBadR‘uº
) {

317 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

319 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

320 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

321 
ASSERT_GE
(
fd
, 0);

322 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

323 
EXPECT_THAT
(
wr™e
(
fd
, "h–lo", 5), 
Eq
(5));

325 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

326 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

327 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>( 0);

328 
	g·¿ms
.
	gPushByCİy
<>( 1000);

330 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡L£ek
, &
·¿ms
));

331 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

332 
EXPECT_THAT
(
·¿ms
.
Pİ
<
off_t
>(), 
Eq
(-1));

337 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Mkdœ
) {

338 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/dir_to_make");

340 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

341 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

342 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>( 0777);

344 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Mkdœ
, &
·¿ms
));

345 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

346 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

348 
¡©
 
	gsb
;

349 
EXPECT_TRUE
(
¡©
(
·th
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISDIR
(sb.
¡_mode
));

352 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡MkdœNÚExi¡’tP©h
) {

353 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
("/non-existent-path/dir_to_make");

355 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

356 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

357 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>( 0777);

359 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Mkdœ
, &
·¿ms
));

360 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

361 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

366 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡O³n
) {

367 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

369 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

370 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

371 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gO_RDWR
 | 
	gO_CREAT
 | 
	gO_TRUNC
);

372 
	g·¿ms
.
	gPushByCİy
<
	gmode_t
>Ğ
	gS_IRUSR
 | 
	gS_IWUSR
);

374 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡O³n
, &
·¿ms
));

375 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

376 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

377 
EXPECT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

382 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡O³nExi¡šgFe
) {

383 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

385 
ü—t
(
·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

386 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

388 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

389 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

390 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gO_RDWR
 | 
	gO_CREAT
 | 
	gO_TRUNC
);

392 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡O³n
, &
·¿ms
));

393 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

394 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

395 
EXPECT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

400 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡UÆšk
) {

401 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

402 
ü—t
(
·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

403 
ASSERT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

405 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

406 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
.
c_¡r
(),…©h.
Ëngth
() + 1);

408 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡UÆšk
, &
·¿ms
));

409 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

410 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

411 
EXPECT_THAT
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), 
Eq
(-1));

414 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡UÆškNÚExi¡šgFe
) {

415 cÚ¡ *
	g·th
 = "obviously-illegal-file.tmp";

416 
ASSERT_THAT
(
acûss
(
·th
, 
F_OK
), 
Eq
(-1));

418 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

419 
	g·¿ms
.
	gPushByCİy
<>(
	g·th
, 
¡¾’
(
·th
) + 1);

421 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡UÆšk
, &
·¿ms
));

422 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

423 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

428 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘uid
) {

429 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

430 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Uid
, &
·¿ms
));

431 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

432 
EXPECT_THAT
(
·¿ms
.
Pİ
<
uid_t
>(), 
Eq
(
g‘uid
()));

438 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Umask
) {

439 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

440 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gS_IWGRP
 | 
	gS_IWOTH
);

441 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Umask
, &
·¿ms
));

442 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

443 
mode_t
 
	gdeçuÉ_mode
 = 
·¿ms
.
Pİ
<mode_t>();

445 
¡©
 
	gsb
;

446 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/dir_to_make");

449 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

450 
EXPECT_NE
(
rmdœ
(
·th
.
c_¡r
()), -1);

453 
EXPECT_NE
(
mkdœ
(
·th
.
c_¡r
(), 
DEFFILEMODE
), -1);

454 
EXPECT_TRUE
(
¡©
(
·th
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISDIR
(sb.
¡_mode
));

455 
EXPECT_TRUE
(!(
sb
.
¡_mode
 & 
S_IWGRP
è&& !(sb.¡_mod& 
S_IWOTH
));

456 
EXPECT_NE
(
rmdœ
(
·th
.
c_¡r
()), -1);

458 
	g·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

460 ià(
acûss
(
·th
.
c_¡r
(), 
F_OK
) == 0) {

461 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

464 
	gfd
 = 
ü—t
(
·th
.
c_¡r
(), 
DEFFILEMODE
);

465 
ASSERT_GE
(
fd
, 0);

466 
EXPECT_NE
(
acûss
(
·th
.
c_¡r
(), 
F_OK
), -1);

467 
EXPECT_TRUE
(
¡©
(
·th
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISREG
(sb.
¡_mode
));

468 
EXPECT_TRUE
(!(
sb
.
¡_mode
 & 
S_IWGRP
è&& !(sb.¡_mod& 
S_IWOTH
));

469 
EXPECT_NE
(
uÆšk
(
·th
.
c_¡r
()), -1);

471 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gdeçuÉ_mode
);

472 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Umask
, &
·¿ms
));

473 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

474 
ASSERT_THAT
(
·¿ms
.
Pİ
<
mode_t
>(), 
Eq
(
S_IWGRP
 | 
S_IWOTH
));

479 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘gid
) {

480 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

481 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Gid
, &
·¿ms
));

482 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

483 
EXPECT_THAT
(
·¿ms
.
Pİ
<
gid_t
>(), 
Eq
(
g‘gid
()));

488 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘Euid
) {

489 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

490 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Euid
, &
·¿ms
));

491 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

492 
EXPECT_THAT
(
·¿ms
.
Pİ
<
uid_t
>(), 
Eq
(
g‘euid
()));

497 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡G‘Egid
) {

498 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

499 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡G‘Egid
, &
·¿ms
));

500 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

501 
EXPECT_THAT
(
·¿ms
.
Pİ
<
gid_t
>(), 
Eq
(
g‘egid
()));

506 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡R’ame
) {

507 
	g¡d
::
¡ršg
 
Şd·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/oldname.tmp");

508 
	g¡d
::
¡ršg
 
Ãw·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/newname.tmp");

510 
ü—t
(
Şd·th
.
c_¡r
(), 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IROTH
);

511 
ASSERT_NE
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), -1);

513 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

514 
	g·¿ms
.
	gPushByCİy
<>(
	gŞd·th
.
c_¡r
(), 
¡¾’
(
Şd·th
.c_str()) + 1);

515 
	g·¿ms
.
	gPushByCİy
<>(
	gÃw·th
.
c_¡r
(), 
¡¾’
(
Ãw·th
.c_str()) + 1);

517 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡R’ame
, &
·¿ms
));

518 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

519 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

521 
EXPECT_THAT
(
acûss
(
Şd·th
.
c_¡r
(), 
F_OK
), 
Eq
(-1));

522 
EXPECT_NE
(
acûss
(
Ãw·th
.
c_¡r
(), 
F_OK
), -1);

528 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡R—d
) {

529 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

531 
	gfd
 =

532 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

533 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

534 
ASSERT_GE
(
fd
, 0);

535 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

537 
	g¡d
::
¡ršg
 
ex³ùed_cÚ‹Á
 = "this is what's being„ead!";

538 
ASSERT_THAT
(

539 
wr™e
(
fd
, 
ex³ùed_cÚ‹Á
.
c_¡r
(),ƒx³ùed_cÚ‹Á.
Ëngth
() + 1),

540 
Eq
(
ex³ùed_cÚ‹Á
.
Ëngth
() + 1));

541 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

545 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

546 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

547 
	g·¿ms
.
	gPushByCİy
<
	gsize_t
>Ğ
	gex³ùed_cÚ‹Á
.
Ëngth
() + 1);

548 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡R—d
, &
·¿ms
));

549 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(2));

550 
EXPECT_THAT
(
·¿ms
.
Pİ
()->
As
<>(), 
SŒEq
(
ex³ùed_cÚ‹Á
));

551 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ssize_t
>(), 
Eq
(
ex³ùed_cÚ‹Á
.
Ëngth
() + 1));

557 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Wr™e
) {

558 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

560 
	gfd
 =

561 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

562 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

563 
ASSERT_GE
(
fd
, 0);

564 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

566 
	g¡d
::
¡ršg
 
wr™e_buf
 = "texto be written";

567 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

568 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

569 
	g·¿ms
.
	gPushByCİy
<>(
	gwr™e_buf
.
c_¡r
(), wr™e_buf.
Ëngth
() + 1);

570 
	g·¿ms
.
	gPushByCİy
<
	gsize_t
>Ğ
	gwr™e_buf
.
Ëngth
() + 1);

572 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Wr™e
, &
·¿ms
));

573 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

574 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ssize_t
>(), 
Eq
(
wr™e_buf
.
Ëngth
() + 1));

576 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

577 
	g»ad_buf
[20];

578 
EXPECT_THAT
(
»ad
(
fd
, 
»ad_buf
, 
wr™e_buf
.
Ëngth
() + 1),

579 
Eq
(
wr™e_buf
.
Ëngth
() + 1));

580 
EXPECT_THAT
(
»ad_buf
, 
SŒEq
(
wr™e_buf
));

585 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Symlšk
) {

586 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

587 
	g¡d
::
¡ršg
 
rg‘
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/target.tmp");

589 
	gfd
 =

590 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

591 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

592 
ASSERT_GE
(
fd
, 0);

593 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

595 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

596 
	g·¿ms
.
	gPushByCİy
<>(
	g‹¡_fe
.
c_¡r
(),e¡_fe.
Ëngth
() + 1);

597 
	g·¿ms
.
	gPushByCİy
<>(
	grg‘
.
c_¡r
(),¬g‘.
Ëngth
() + 1);

599 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Symlšk
, &
·¿ms
));

600 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

601 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

602 
EXPECT_NE
(
acûss
(
rg‘
.
c_¡r
(), 
F_OK
), -1);

608 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡R—dlšk
) {

609 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

610 
	g¡d
::
¡ršg
 
sym_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_sym_file.tmp");

612 
	gfd
 =

613 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

614 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

615 
ASSERT_GE
(
fd
, 0);

616 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

619 
ASSERT_THAT
(
symlšk
(
‹¡_fe
.
c_¡r
(), 
sym_fe
.c_¡r()), 
Eq
(0));

621 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

622 
	g·¿ms
.
	gPushByCİy
<>(
	gsym_fe
.
c_¡r
(), sym_fe.
Ëngth
() + 1);

624 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡R—dLšk
, &
·¿ms
));

626 
	gbuf_ex³ùed
[
PATH_MAX
];

627 
ssize_t
 
	gËn_ex³ùed
 =

628 
»adlšk
(
sym_fe
.
c_¡r
(), 
buf_ex³ùed
, (buf_expected) - 1);

629 
	gbuf_ex³ùed
[
Ën_ex³ùed
] = '\0';

631 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(2));

632 
EXPECT_THAT
(
·¿ms
.
Pİ
()->
As
<>(), 
SŒEq
(
buf_ex³ùed
));

633 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ssize_t
>(), 
Eq
(
Ën_ex³ùed
));

639 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Trunÿ‹
) {

640 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

641 
	gfd
 =

642 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

643 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

644 
ASSERT_GE
(
fd
, 0);

645 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

648 
	g¡d
::
¡ršg
 
fe_cÚ‹Á
 = "some„andom content.";

649 
ASSERT_THAT
(
wr™e
(
fd
, 
fe_cÚ‹Á
.
c_¡r
(), fe_cÚ‹Á.
Ëngth
() + 1),

650 
Eq
(
fe_cÚ‹Á
.
Ëngth
() + 1));

652 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

653 
cÚ¡ex´
 
	gkTruncL’
 = 5;

654 
	g·¿ms
.
	gPushByCİy
<>(
	g‹¡_fe
.
c_¡r
(),e¡_fe.
Ëngth
() + 1);

655 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>Ğ
	gkTruncL’
);

657 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Trunÿ‹
, &
·¿ms
));

658 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

659 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 0);

662 
	g»ad_buf
[10];

663 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

664 
EXPECT_THAT
(
»ad
(
fd
, 
»ad_buf
, 10), 
Eq
(
kTruncL’
));

665 
	g»ad_buf
[
kTruncL’
] = '\0';

666 
EXPECT_THAT
(
»ad_buf
, 
SŒEq
(
fe_cÚ‹Á
.
sub¡r
(0, 
kTruncL’
)));

672 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FTrunÿ‹
) {

673 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

674 
	gfd
 =

675 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

676 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

677 
ASSERT_GE
(
fd
, 0);

678 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

681 
	g¡d
::
¡ršg
 
fe_cÚ‹Á
 = "some„andom content.";

682 
ASSERT_THAT
(
wr™e
(
fd
, 
fe_cÚ‹Á
.
c_¡r
(), fe_cÚ‹Á.
Ëngth
() + 1),

683 
Eq
(
fe_cÚ‹Á
.
Ëngth
() + 1));

685 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

686 
cÚ¡ex´
 
	gkTruncL’
 = 5;

687 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

688 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>Ğ
	gkTruncL’
);

690 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FTrunÿ‹
, &
·¿ms
));

691 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

692 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 0);

695 
	g»ad_buf
[10];

696 
ASSERT_THAT
(
l£ek
(
fd
, 0, 
SEEK_SET
), 
Eq
(0));

697 
EXPECT_THAT
(
»ad
(
fd
, 
»ad_buf
, 10), 
Eq
(
kTruncL’
));

698 
	g»ad_buf
[
kTruncL’
] = '\0';

699 
EXPECT_THAT
(
»ad_buf
, 
SŒEq
(
fe_cÚ‹Á
.
sub¡r
(0, 
kTruncL’
)));

702 
	g·¿ms
.
	gPushByCİy
<>( -1);

703 
	g·¿ms
.
	gPushByCİy
<
	goff_t
>Ğ
	gkTruncL’
);

705 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FTrunÿ‹
, &
·¿ms
));

706 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

707 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), -1);

712 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Rmdœ
) {

713 
	g¡d
::
¡ršg
 
dœ_to_d–
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/dir_to_del");

714 
ASSERT_THAT
(
mkdœ
(
dœ_to_d–
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
), 
Eq
(0));

716 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

717 
	g·¿ms
.
	gPushByCİy
<>(
	gdœ_to_d–
.
c_¡r
(), dœ_to_d–.
Ëngth
() + 1);

719 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Rmdœ
, &
·¿ms
));

720 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

721 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

724 
¡©
 
	gsb
;

725 
EXPECT_FALSE
(
¡©
(
dœ_to_d–
.
c_¡r
(), &
sb
è=ğ0 && 
S_ISDIR
(sb.
¡_mode
));

730 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Sock‘
) {

731 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

733 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gAF_INET6
);

734 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSOCK_STREAM
);

735 
	g·¿ms
.
	gPushByCİy
<>( 0);

737 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Sock‘
, &
·¿ms
));

738 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

739 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

743 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gAF_UNIX
);

744 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSOCK_STREAM
);

745 
	g·¿ms
.
	gPushByCİy
<>( 0);

747 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Sock‘
, &
·¿ms
));

748 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

749 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(0));

755 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Fú
) {

756 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

757 
	gfd
 =

758 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

759 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

760 
ASSERT_GE
(
fd
, 0);

761 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

764 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

765 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

766 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gF_GETFL
);

767 
	g·¿ms
.
	gPushByCİy
<>( 0);

768 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fú
, &
·¿ms
));

769 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

771 
	gfú_»tuº
;

772 
	gklšux_fú_»tuº
 = 
fú
(
fd
, 
F_GETFL
, 0);

773 
FromkLšuxFeStusFÏg
(&
klšux_fú_»tuº
, &
fú_»tuº
);

774 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(
fú_»tuº
));

777 
	gæags_to_£t
 = 
O_APPEND
 | 
O_NONBLOCK
 | 
O_RDONLY
;

778 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

779 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gF_SETFL
);

780 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gæags_to_£t
);

781 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fú
, &
·¿ms
));

782 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

784 
	gklšux_fú_»tuº
 = 
fú
(
fd
, 
F_SETFL
, 
æags_to_£t
);

785 
FromkLšuxFeStusFÏg
(&
klšux_fú_»tuº
, &
fú_»tuº
);

786 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(
fú_»tuº
));

789 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FúInv®idCmd
) {

790 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

791 
	g·¿ms
.
	gPushByCİy
<>( 0);

792 
	g·¿ms
.
	gPushByCİy
<>( 10000000);

793 
	g·¿ms
.
	gPushByCİy
<>( 0);

794 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fú
, &
·¿ms
));

795 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

796 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

801 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Chown
) {

802 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

803 
	gfd
 =

804 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

805 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

806 
ASSERT_GE
(
fd
, 0);

807 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

809 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

810 
	g·¿ms
.
	gPushByCİy
<>(
	g‹¡_fe
.
c_¡r
(),e¡_fe.
Ëngth
() + 1);

811 
	g·¿ms
.
	gPushByCİy
<
	guid_t
>Ğ
g‘uid
());

812 
	g·¿ms
.
	gPushByCİy
<
	ggid_t
>Ğ
g‘gid
());

814 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Chown
, &
·¿ms
));

815 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

816 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

821 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡FChown
) {

822 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "test_file.tmp");

823 
	gfd
 =

824 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

825 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

826 
ASSERT_GE
(
fd
, 0);

827 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

829 
¡©
 
	gsb
 = {};

830 
EXPECT_THAT
(
f¡©
(
fd
, &
sb
), 
Eq
(0));

831 
EXPECT_THAT
(
sb
.
¡_uid
, 
Eq
(
g‘uid
()));

832 
EXPECT_THAT
(
sb
.
¡_gid
, 
Eq
(
g‘gid
()));

834 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

835 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

836 
	g·¿ms
.
	gPushByCİy
<
	guid_t
>Ğ
g‘uid
());

837 
	g·¿ms
.
	gPushByCİy
<
	ggid_t
>Ğ
g‘gid
());

839 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FChown
, &
·¿ms
));

840 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

841 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

844 
	g·¿ms
.
	gPushByCİy
<>( -1);

845 
	g·¿ms
.
	gPushByCİy
<
	guid_t
>Ğ
g‘uid
());

846 
	g·¿ms
.
	gPushByCİy
<
	ggid_t
>Ğ
g‘gid
());

848 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡FChown
, &
·¿ms
));

849 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

850 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(-1));

858 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡S‘SockO±
) {

860 
	gsock‘_fd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

861 
EXPECT_THAT
(
sock‘_fd
, 
Gt
(0));

866 
sockaddr_š6
 
	g§
;

867 
mem£t
(&
§
, 0, (sa));

868 
	g§
.
	gsš6_çmy
 = 
AF_INET6
;

869 
	g§
.
	gsš6_æowšfo
 = 0;

870 
	g§
.
	gsš6_addr
 = 
š6addr_ªy
;

871 
	g§
.
	gsš6_pÜt
 = 
htÚs
(0);

872 
EXPECT_THAT
(

873 
bšd
(
sock‘_fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
§
), (sa)),

874 
NÙ
(
Eq
(-1)));

876 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

877 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gsock‘_fd
);

878 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSOL_SOCKET
);

879 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gSO_REUSEADDR
);

880 
	g·¿ms
.
	gPushByCİy
<>( 1);

882 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡S‘SockO±
, &
·¿ms
));

883 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

884 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Gt
(-1));

886 
şo£
(
sock‘_fd
);

896 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Flock
) {

897 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/test_file.tmp");

899 
	gfd
 =

900 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

901 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

902 
ASSERT_GE
(
fd
, 0);

903 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

905 
	gklšux_lock
 = 
LOCK_EX
;

906 
	glock
;

907 
FromkLšuxFLockO³¿tiÚ
(&
klšux_lock
, &
lock
);

908 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

909 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

910 
	g·¿ms
.
	gPushByCİy
<>Ğ
	glock
);

912 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Flock
, &
·¿ms
));

913 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

914 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

915 
æock
(
fd
, 
LOCK_UN
);

920 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡Fsync
) {

921 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "test_file.tmp");

922 
	gfd
 =

923 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

924 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

925 
ASSERT_GE
(
fd
, 0);

926 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

929 
	g¡d
::
¡ršg
 
fe_cÚ‹Á
 = "some„andom content.";

930 
ASSERT_THAT
(
wr™e
(
fd
, 
fe_cÚ‹Á
.
c_¡r
(), fe_cÚ‹Á.
Ëngth
() + 1),

931 
Eq
(
fe_cÚ‹Á
.
Ëngth
() + 1));

933 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

934 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

936 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡Fsync
, &
·¿ms
));

937 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

938 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

945 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡InÙifyIn™1
) {

946 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

947 
	gšÙify_æag
;

948 
	gklšux_šÙify_æag
 = 
IN_NONBLOCK
;

949 
FromkLšuxInÙifyFÏg
(&
klšux_šÙify_æag
, &
šÙify_æag
);

950 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gšÙify_æag
);

952 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡InÙifyIn™1
, &
·¿ms
));

953 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

954 
	gšÙify_fd
 = 
·¿ms
.
Pİ
<>();

955 
EXPECT_THAT
(
šÙify_fd
, 
Gt
(0));

956 
şo£
(
šÙify_fd
);

963 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡InÙifyAddW©ch
) {

964 
	gšÙify_fd
 = 
šÙify_š™1
(
IN_NONBLOCK
);

965 
ASSERT_THAT
(
šÙify_fd
, 
Gt
(0));

969 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

970 
	g·¿ms
.
	gPushByCİy
<>(
	gšÙify_fd
);

971 
	g·¿ms
.
	gPushByCİy
<>(
	gFLAGS_‹¡_tmpdœ
.
c_¡r
(),

972 
	gFLAGS_‹¡_tmpdœ
.
Ëngth
() + 1);

974 
	gev’t_mask
;

975 
	gklšux_ev’t_mask
 = 
IN_ALL_EVENTS
;

976 
FromkLšuxInÙifyEv’tMask
(&
klšux_ev’t_mask
, &
ev’t_mask
);

977 
	g·¿ms
.
	gPushByCİy
<>(
	gev’t_mask
);

978 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡InÙifyAddW©ch
, &
·¿ms
));

979 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

980 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(1));

983 
cÚ¡ex´
 
size_t
 
	gev’t_size
 = (
šÙify_ev’t
);

984 
cÚ¡ex´
 
size_t
 
	gbuf_Ën
 = 10 * (
ev’t_size
 + 
NAME_MAX
 + 1);

985 
	gbuf
[
buf_Ën
];

986 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Eq
(-1));

989 
	g¡d
::
¡ršg
 
fe_Çme
 = "test_file.tmp";

990 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
fe_Çme
);

991 
	gfd
 =

992 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

993 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

994 
ASSERT_GE
(
fd
, 0);

995 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

998 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Gt
(0));

1000 autØ*
	gev’t
 = 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[0]);

1001 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_MODIFY
));

1002 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1003 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1005 
	gev’t
 =

1006 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[
ev’t_size
 + 
ev’t
->
Ën
]);

1007 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_OPEN
));

1008 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1009 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1011 
şo£
(
šÙify_fd
);

1017 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡InÙifyRmW©ch
) {

1018 
	gšÙify_fd
 = 
šÙify_š™1
(
IN_NONBLOCK
);

1019 
	gwd
 =

1020 
šÙify_add_w©ch
(
šÙify_fd
, 
FLAGS_‹¡_tmpdœ
.
c_¡r
(), 
IN_ALL_EVENTS
);

1021 
ASSERT_THAT
(
šÙify_fd
, 
Gt
(0));

1022 
ASSERT_THAT
(
wd
, 
Eq
(1));

1025 
	g¡d
::
¡ršg
 
fe_Çme
 = "test_file.tmp";

1026 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
fe_Çme
);

1027 
	gfd
 =

1028 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

1029 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

1030 
ASSERT_GE
(
fd
, 0);

1031 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

1034 
cÚ¡ex´
 
size_t
 
	gev’t_size
 = (
šÙify_ev’t
);

1035 
cÚ¡ex´
 
size_t
 
	gbuf_Ën
 = 10 * (
ev’t_size
 + 
NAME_MAX
 + 1);

1036 
	gbuf
[
buf_Ën
];

1037 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Gt
(0));

1039 autØ*
	gev’t
 = 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[0]);

1040 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_MODIFY
));

1041 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1042 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1044 
	gev’t
 =

1045 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(&
buf
[
ev’t_size
 + 
ev’t
->
Ën
]);

1046 
EXPECT_THAT
(
ev’t
->
mask
, 
Eq
(
IN_OPEN
));

1047 
EXPECT_THAT
(
ev’t
->
Çme
, 
SŒEq
(
fe_Çme
));

1048 
EXPECT_THAT
(
ev’t
->
cook›
, 
Eq
(0));

1051 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1052 
	g·¿ms
.
	gPushByCİy
<>(
	gšÙify_fd
);

1053 
	g·¿ms
.
	gPushByCİy
<>(
	gwd
);

1054 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡InÙifyRmW©ch
, &
·¿ms
));

1055 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1056 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1059 
ASSERT_THAT
(
uÆšk
(
‹¡_fe
.
c_¡r
()), 
Eq
(0));

1062 
EXPECT_THAT
(
»ad
(
šÙify_fd
, 
buf
, 
buf_Ën
), 
Gt
(-1));

1063 
şo£
(
šÙify_fd
);

1068 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡SchedY›ld
) {

1069 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1071 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡SchedY›ld
, &
·¿ms
));

1072 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1073 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1078 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡IsA‰y
) {

1079 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "test_file.tmp");

1080 
	gfd
 =

1081 
İ’
(
‹¡_fe
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

1082 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

1083 
ASSERT_GE
(
fd
, 0);

1084 
ASSERT_NE
(
acûss
(
‹¡_fe
.
c_¡r
(), 
F_OK
), -1);

1086 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1087 
	g·¿ms
.
	gPushByCİy
<>Ğ
	gfd
);

1089 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡IsA‰y
, &
·¿ms
));

1090 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1091 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1097 
TEST_F
(
Ho¡C®lTe¡
, 
Te¡USË•
) {

1098 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

1103 
	g·¿ms
.
	gPushByCİy
<>( 1000000);

1105 
	gab¦
::
Time
 
¡¬t
 = 
ab¦
::
Now
();

1106 
ASYLO_ASSERT_OK
(
ş›Á_
->
EnşaveC®l
(
kTe¡USË•
, &
·¿ms
));

1107 
	gab¦
::
Time
 
’d
 = 
ab¦
::
Now
();

1109 autØ
	gdu¿tiÚ
 = 
ab¦
::
ToIÁ64Mli£cÚds
(
’d
 - 
¡¬t
);

1111 
ASSERT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

1112 
EXPECT_THAT
(
·¿ms
.
Pİ
<>(), 
Eq
(0));

1113 
EXPECT_GE
(
du¿tiÚ
, 1000);

1114 
EXPECT_LE
(
du¿tiÚ
, 1200);

1121 
	$maš
(
¬gc
, *
¬gv
[]) {

1122 ::
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

1123 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

1125  
	`RUN_ALL_TESTS
();

1126 
	}
}

	@platform/host_call/test/test_enclave.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/‹¡/’şave_‹¡_£ËùÜs.h
"

20 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎ_di¥©ch”.h
"

21 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎs.h
"

22 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

23 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

25 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¡em_ÿÎ.h
"

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_funùiÚs.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gho¡_ÿÎ
 {

33 
	gÇme¥aû
 {

36 
	g´im™ives
::
Prim™iveStus
 
AbÜt
(*
cÚ‹xt
,

37 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

38 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

39 
	g´im™ives
::
Tru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Abortingƒnclave");

40  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

43 
	g´im™ives
::
Prim™iveStus
 
Te¡Acûss
(

44 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

45 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

47 
	gmode
 = 
·¿ms
->
Pİ
<>();

48 cÚ¡‡utØ
	g·th_Çme
 = 
·¿ms
->
Pİ
();

50 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_acûss
(
·th_Çme
->
As
<>(), 
mode
));

51  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

54 
	g´im™ives
::
Prim™iveStus
 
Te¡Chmod
(

55 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

56 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

58 
mode_t
 
	gmode
 = 
·¿ms
->
Pİ
<mode_t>();

59 cÚ¡‡utØ
	g·th_Çme
 = 
·¿ms
->
Pİ
();

61 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_chmod
(
·th_Çme
->
As
<>(), 
mode
));

62  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

65 
	g´im™ives
::
Prim™iveStus
 
Te¡Clo£
(

66 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

67 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

69 
	gfd
 = 
·¿ms
->
Pİ
<>();

70 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_şo£
(
fd
));

71  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

74 
	g´im™ives
::
Prim™iveStus
 
Te¡Fchmod
(

75 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

76 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

78 
mode_t
 
	gmode
 = 
·¿ms
->
Pİ
<mode_t>();

79 
	gfd
 = 
·¿ms
->
Pİ
<>();

81 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fchmod
(
fd
, 
mode
));

82  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

85 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘pid
(

86 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

87 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

89 
	g·¿ms
->
	gPushByCİy
<
	gpid_t
>(
’c_uÁru¡ed_g‘pid
());

90  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

93 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘Ppid
(

94 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

95 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

97 
	g·¿ms
->
	gPushByCİy
<
	gpid_t
>(
’c_uÁru¡ed_g‘µid
());

98  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

101 
	g´im™ives
::
Prim™iveStus
 
Te¡S‘Sid
(

102 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

103 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

105 
	g·¿ms
->
	gPushByCİy
<
	gpid_t
>(
’c_uÁru¡ed_£tsid
());

106  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

109 
	g´im™ives
::
Prim™iveStus
 
Te¡Kl
(

110 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

111 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

113 
	gsig
 = 
·¿ms
->
Pİ
<>();

114 
pid_t
 
	gpid
 = 
·¿ms
->
Pİ
<pid_t>();

116 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_kl
(
pid
, 
sig
));

117  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

120 
	g´im™ives
::
Prim™iveStus
 
Te¡Lšk
(

121 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

122 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

124 cÚ¡‡utØ
	gÃw_·th
 = 
·¿ms
->
Pİ
();

125 cÚ¡‡utØ
	gŞd_·th
 = 
·¿ms
->
Pİ
();

127 
	g·¿ms
->
	gPushByCİy
<>(

128 
’c_uÁru¡ed_lšk
(
Şd_·th
->
As
<>(), 
Ãw_·th
->As<>()));

129  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

132 
	g´im™ives
::
Prim™iveStus
 
Te¡L£ek
(

133 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

134 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

136 
	gwh’û
 = 
·¿ms
->
Pİ
<>();

137 
off_t
 
	goff£t
 = 
·¿ms
->
Pİ
<off_t>();

138 
	gfd
 = 
·¿ms
->
Pİ
<>();

140 
	g·¿ms
->
	gPushByCİy
<
	goff_t
>(
’c_uÁru¡ed_l£ek
(
fd
, 
off£t
, 
wh’û
));

141  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

144 
	g´im™ives
::
Prim™iveStus
 
Te¡Mkdœ
(

145 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

146 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

148 
mode_t
 
	gmode
 = 
·¿ms
->
Pİ
<mode_t>();

149 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

151 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_mkdœ
(
·thÇme
->
As
<>(), 
mode
));

152  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

155 
	g´im™ives
::
Prim™iveStus
 
Te¡O³n
(

156 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

158 ià(
·¿ms
->
size
() == 3) {

159 
mode_t
 
mode
 = 
·¿ms
->
Pİ
<mode_t>();

160 
	gæags
 = 
·¿ms
->
Pİ
<>();

161 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

162 
	g·¿ms
->
	gPushByCİy
<>(

163 
’c_uÁru¡ed_İ’
(
·thÇme
->
As
<>(), 
æags
, 
mode
));

164 } ià(
	g·¿ms
->
size
() == 2) {

165 
æags
 = 
·¿ms
->
Pİ
<>();

166 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

167 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_İ’
(
·thÇme
->
As
<>(), 
æags
));

169  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

173  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

176 
	g´im™ives
::
Prim™iveStus
 
Te¡UÆšk
(

177 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

178 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

180 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

182 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_uÆšk
(
·thÇme
->
As
<>()));

183  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

186 
	g´im™ives
::
Prim™iveStus
 
Te¡Umask
(

187 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

188 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

190 
mode_t
 
	gmask
 = 
·¿ms
->
Pİ
<mode_t>();

192 
	g·¿ms
->
	gPushByCİy
<
	gmode_t
>(
’c_uÁru¡ed_umask
(
mask
));

193  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

196 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘uid
(

197 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

198 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

200 
	g·¿ms
->
	gPushByCİy
<
	guid_t
>(
’c_uÁru¡ed_g‘uid
());

201  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

204 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘gid
(

205 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

206 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

208 
	g·¿ms
->
	gPushByCİy
<
	ggid_t
>(
’c_uÁru¡ed_g‘gid
());

209  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

212 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘euid
(

213 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

214 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

216 
	g·¿ms
->
	gPushByCİy
<
	guid_t
>(
’c_uÁru¡ed_g‘euid
());

217  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

220 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘egid
(

221 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

222 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

224 
	g·¿ms
->
	gPushByCİy
<
	ggid_t
>(
’c_uÁru¡ed_g‘egid
());

225  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

228 
	g´im™ives
::
Prim™iveStus
 
Te¡R’ame
(

229 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

230 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

232 cÚ¡‡utØ
	gÃw·th
 = 
·¿ms
->
Pİ
();

233 cÚ¡‡utØ
	gŞd·th
 = 
·¿ms
->
Pİ
();

235 
	g·¿ms
->
	gPushByCİy
<>(

236 
’c_uÁru¡ed_»Çme
(
Şd·th
->
As
<>(), 
Ãw·th
->As<>()));

237  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

240 
	g´im™ives
::
Prim™iveStus
 
Te¡R—d
(

241 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

242 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

243 
size_t
 
	gcouÁ
 = 
·¿ms
->
Pİ
<size_t>();

244 
	gfd
 = 
·¿ms
->
Pİ
<>();

245 
	g»ad_buf
[20];

247 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(
’c_uÁru¡ed_»ad
(
fd
, 
»ad_buf
, 
couÁ
));

248 
	g·¿ms
->
	gPushByCİy
<>(
	g»ad_buf
, 
¡¾’
(
»ad_buf
) + 1);

249  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

252 
	g´im™ives
::
Prim™iveStus
 
Te¡Wr™e
(

253 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

254 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

255 
size_t
 
	gcouÁ
 = 
·¿ms
->
Pİ
<size_t>();

256 cÚ¡‡utØ
	gwr™e_buf
 = 
·¿ms
->
Pİ
();

257 
	gfd
 = 
·¿ms
->
Pİ
<>();

259 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(

260 
’c_uÁru¡ed_wr™e
(
fd
, 
wr™e_buf
->
As
<>(), 
couÁ
));

261  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

264 
	g´im™ives
::
Prim™iveStus
 
Te¡Symlšk
(

265 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

266 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

267 cÚ¡‡utØ
	glšk·th
 = 
·¿ms
->
Pİ
();

268 cÚ¡‡utØ
	grg‘
 = 
·¿ms
->
Pİ
();

270 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(

271 
’c_uÁru¡ed_symlšk
(
rg‘
->
As
<>(), 
lšk·th
->As<>()));

272  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

275 
	g´im™ives
::
Prim™iveStus
 
Te¡R—dlšk
(

276 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

277 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

278 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

280 
	gbuf
[
PATH_MAX
];

281 
ssize_t
 
	gËn
 =

282 
’c_uÁru¡ed_»adlšk
(
·thÇme
->
As
<>(), 
buf
, (buf) - 1);

283 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(
	gËn
);

285 
	gbuf
[
Ën
] = '\0';

286 
	g·¿ms
->
	gPushByCİy
<>(
	gbuf
, 
¡¾’
(
buf
) + 1);

287  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

290 
	g´im™ives
::
Prim™iveStus
 
Te¡Trunÿ‹
(

291 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

292 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

293 
off_t
 
	gËngth
 = 
·¿ms
->
Pİ
<off_t>();

294 cÚ¡‡utØ
	g·th
 = 
·¿ms
->
Pİ
();

296 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_Œunÿ‹
(
·th
->
As
<>(), 
Ëngth
));

298  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

301 
	g´im™ives
::
Prim™iveStus
 
Te¡FTrunÿ‹
(

302 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

303 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

304 autØ
	gËngth
 = 
·¿ms
->
Pİ
<
off_t
>();

305 
	gfd
 = 
·¿ms
->
Pİ
<>();

307 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_árunÿ‹
(
fd
, 
Ëngth
));

309  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

312 
	g´im™ives
::
Prim™iveStus
 
Te¡Rmdœ
(

313 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

314 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

315 cÚ¡‡utØ
	g·th
 = 
·¿ms
->
Pİ
();

317 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_rmdœ
(
·th
->
As
<>()));

318  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

321 
	g´im™ives
::
Prim™iveStus
 
Te¡Sock‘
(

322 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

323 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

325 
	g´ÙocŞ
 = 
·¿ms
->
Pİ
<>();

326 
	gty³
 = 
·¿ms
->
Pİ
<>();

327 
	gdomaš
 = 
·¿ms
->
Pİ
<>();

328 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
));

330  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

333 
	g´im™ives
::
Prim™iveStus
 
Te¡Fú
(

334 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

335 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

337 
	g¬g
 = 
·¿ms
->
Pİ
<>();

338 
	gcmd
 = 
·¿ms
->
Pİ
<>();

339 
	gfd
 = 
·¿ms
->
Pİ
<>();

340 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fú
(
fd
, 
cmd
, 
¬g
));

342  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

345 
	g´im™ives
::
Prim™iveStus
 
Te¡Chown
(

346 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

347 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

349 
gid_t
 
	ggroup
 = 
·¿ms
->
Pİ
<gid_t>();

350 
uid_t
 
	gowÃr
 = 
·¿ms
->
Pİ
<uid_t>();

351 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

352 
	g·¿ms
->
	gPushByCİy
<>(

353 
’c_uÁru¡ed_chown
(
·thÇme
->
As
<>(), 
owÃr
, 
group
));

354  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

357 
	g´im™ives
::
Prim™iveStus
 
Te¡FChown
(

358 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

359 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

361 autØ
	ggroup
 = 
·¿ms
->
Pİ
<
gid_t
>();

362 autØ
	gowÃr
 = 
·¿ms
->
Pİ
<
uid_t
>();

363 
	gfd
 = 
·¿ms
->
Pİ
<>();

364 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fchown
(
fd
, 
owÃr
, 
group
));

365  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

368 
	g´im™ives
::
Prim™iveStus
 
Te¡S‘sockİt
(

369 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

370 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 4);

372 
	gİtiÚ
 = 
·¿ms
->
Pİ
<>();

373 
	gklšux_İŠame
 = 
·¿ms
->
Pİ
<>();

374 
	gËv–
 = 
·¿ms
->
Pİ
<>();

375 
	gsockfd
 = 
·¿ms
->
Pİ
<>();

377 
	gİŠame
;

378 
FromkLšuxO±iÚName
(&
Ëv–
, &
klšux_İŠame
, &
İŠame
);

379 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_£tsockİt
(

380 
sockfd
, 
Ëv–
, 
İŠame
, (*)&
İtiÚ
, (option)));

382  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

385 
	g´im™ives
::
Prim™iveStus
 
Te¡Flock
(

386 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

387 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

389 
	gİ”©iÚ
 =

390 
·¿ms
->
Pİ
<>();

392 
	gfd
 = 
·¿ms
->
Pİ
<>();

393 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
));

395  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

398 
	g´im™ives
::
Prim™iveStus
 
Te¡Fsync
(

399 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

400 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

402 
	gfd
 = 
·¿ms
->
Pİ
<>();

403 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fsync
(
fd
));

405  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

408 
	g´im™ives
::
Prim™iveStus
 
Te¡InÙifyIn™1
(

409 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

410 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

412 
	gæags
 = 
·¿ms
->
Pİ
<>();

414 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_šÙify_š™1
(
æags
));

415  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

418 
	g´im™ives
::
Prim™iveStus
 
Te¡InÙifyAddW©ch
(

419 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

420 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

422 
ušt32_t
 
	gmask
 =

423 
·¿ms
->
Pİ
<
ušt32_t
>();

425 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

426 
	gfd
 = 
·¿ms
->
Pİ
<>();

427 
	g·¿ms
->
	gPushByCİy
<>(

428 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, 
·thÇme
->
As
<>(), 
mask
));

430  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

433 
	g´im™ives
::
Prim™iveStus
 
Te¡InÙifyRmW©ch
(

434 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

435 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

437 
	gwd
 = 
·¿ms
->
Pİ
<>();

438 
	gfd
 = 
·¿ms
->
Pİ
<>();

439 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
));

440  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

443 
	g´im™ives
::
Prim™iveStus
 
Te¡SchedY›ld
(

444 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

445 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

447 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_sched_y›ld
());

448  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

451 
	g´im™ives
::
Prim™iveStus
 
Te¡IsA‰y
(

452 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

453 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

455 
	gfd
 = 
·¿ms
->
Pİ
<>();

456 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_i§‰y
(
fd
));

457  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

460 
	g´im™ives
::
Prim™iveStus
 
Te¡USË•
(

461 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

462 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

463 autØ
	gu£c
 = 
·¿ms
->
Pİ
<>();

464 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_u¦“p
(
u£c
));

465  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

471 "C" 
´im™ives
::
Prim™iveStus
 
asylo_’şave_š™
() {

473 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

475 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

476 
kAbÜtEnşaveS–eùÜ
, 
´im™ives
::
EÁryHªdËr
{
AbÜt
}));

477 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

478 
kTe¡Acûss
, 
´im™ives
::
EÁryHªdËr
{
Te¡Acûss
}));

479 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

480 
kTe¡Chmod
, 
´im™ives
::
EÁryHªdËr
{
Te¡Chmod
}));

481 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

482 
kTe¡Clo£
, 
´im™ives
::
EÁryHªdËr
{
Te¡Clo£
}));

483 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

484 
kTe¡Fchmod
, 
´im™ives
::
EÁryHªdËr
{
Te¡Fchmod
}));

485 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

486 
kTe¡G‘Pid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘pid
}));

487 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

488 
kTe¡G‘Ppid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘Ppid
}));

489 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

490 
kTe¡S‘Sid
, 
´im™ives
::
EÁryHªdËr
{
Te¡S‘Sid
}));

491 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

492 
kTe¡Kl
, 
´im™ives
::
EÁryHªdËr
{
Te¡Kl
}));

493 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

494 
kTe¡Lšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡Lšk
}));

495 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

496 
kTe¡L£ek
, 
´im™ives
::
EÁryHªdËr
{
Te¡L£ek
}));

497 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

498 
kTe¡Mkdœ
, 
´im™ives
::
EÁryHªdËr
{
Te¡Mkdœ
}));

499 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

500 
kTe¡O³n
, 
´im™ives
::
EÁryHªdËr
{
Te¡O³n
}));

501 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

502 
kTe¡UÆšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡UÆšk
}));

503 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

504 
kTe¡Umask
, 
´im™ives
::
EÁryHªdËr
{
Te¡Umask
}));

505 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

506 
kTe¡G‘Uid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘uid
}));

507 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

508 
kTe¡G‘Gid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘gid
}));

509 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

510 
kTe¡G‘Euid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘euid
}));

511 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

512 
kTe¡G‘Egid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘egid
}));

513 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

514 
kTe¡R’ame
, 
´im™ives
::
EÁryHªdËr
{
Te¡R’ame
}));

515 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

516 
kTe¡R—d
, 
´im™ives
::
EÁryHªdËr
{
Te¡R—d
}));

517 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

518 
kTe¡Wr™e
, 
´im™ives
::
EÁryHªdËr
{
Te¡Wr™e
}));

519 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

520 
kTe¡Symlšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡Symlšk
}));

521 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

522 
kTe¡R—dLšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡R—dlšk
}));

523 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

524 
kTe¡Trunÿ‹
, 
´im™ives
::
EÁryHªdËr
{
Te¡Trunÿ‹
}));

525 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

526 
kTe¡FTrunÿ‹
, 
´im™ives
::
EÁryHªdËr
{
Te¡FTrunÿ‹
}));

527 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

528 
kTe¡Rmdœ
, 
´im™ives
::
EÁryHªdËr
{
Te¡Rmdœ
}));

529 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

530 
kTe¡Sock‘
, 
´im™ives
::
EÁryHªdËr
{
Te¡Sock‘
}));

531 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

532 
kTe¡Fú
, 
´im™ives
::
EÁryHªdËr
{
Te¡Fú
}));

533 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

534 
kTe¡Chown
, 
´im™ives
::
EÁryHªdËr
{
Te¡Chown
}));

535 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

536 
kTe¡FChown
, 
´im™ives
::
EÁryHªdËr
{
Te¡FChown
}));

537 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

538 
kTe¡S‘SockO±
, 
´im™ives
::
EÁryHªdËr
{
Te¡S‘sockİt
}));

539 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

540 
kTe¡Flock
, 
´im™ives
::
EÁryHªdËr
{
Te¡Flock
}));

541 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

542 
kTe¡Fsync
, 
´im™ives
::
EÁryHªdËr
{
Te¡Fsync
}));

543 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

544 
kTe¡InÙifyIn™1
, 
´im™ives
::
EÁryHªdËr
{
Te¡InÙifyIn™1
}));

545 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

546 
kTe¡InÙifyAddW©ch
, 
´im™ives
::
EÁryHªdËr
{
Te¡InÙifyAddW©ch
}));

547 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

548 
kTe¡InÙifyRmW©ch
, 
´im™ives
::
EÁryHªdËr
{
Te¡InÙifyRmW©ch
}));

549 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

550 
kTe¡SchedY›ld
, 
´im™ives
::
EÁryHªdËr
{
Te¡SchedY›ld
}));

551 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

552 
kTe¡IsA‰y
, 
´im™ives
::
EÁryHªdËr
{
Te¡IsA‰y
}));

553 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

554 
kTe¡USË•
, 
´im™ives
::
EÁryHªdËr
{
Te¡USË•
}));

556  
´im™ives
::
Prim™iveStus
::
OkStus
();

560 "C" 
´im™ives
::
Prim™iveStus
 
asylo_’şave_fši
() {

561  
´im™ives
::
Prim™iveStus
::
OkStus
();

567 "C" 
Prim™iveStus
 
	$’c_š™
(è{  
Prim™iveStus
::
	`OkStus
(); 
	}
}

	@platform/host_call/test/test_enclave.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/‹¡/’şave_‹¡_£ËùÜs.h
"

20 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎ_di¥©ch”.h
"

21 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎs.h
"

22 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

23 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

25 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¡em_ÿÎ.h
"

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_funùiÚs.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gho¡_ÿÎ
 {

33 
	gÇme¥aû
 {

36 
	g´im™ives
::
Prim™iveStus
 
AbÜt
(*
cÚ‹xt
,

37 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

38 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

39 
	g´im™ives
::
Tru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Abortingƒnclave");

40  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

43 
	g´im™ives
::
Prim™iveStus
 
Te¡Acûss
(

44 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

45 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

47 
	gmode
 = 
·¿ms
->
Pİ
<>();

48 cÚ¡‡utØ
	g·th_Çme
 = 
·¿ms
->
Pİ
();

50 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_acûss
(
·th_Çme
->
As
<>(), 
mode
));

51  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

54 
	g´im™ives
::
Prim™iveStus
 
Te¡Chmod
(

55 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

56 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

58 
mode_t
 
	gmode
 = 
·¿ms
->
Pİ
<mode_t>();

59 cÚ¡‡utØ
	g·th_Çme
 = 
·¿ms
->
Pİ
();

61 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_chmod
(
·th_Çme
->
As
<>(), 
mode
));

62  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

65 
	g´im™ives
::
Prim™iveStus
 
Te¡Clo£
(

66 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

67 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

69 
	gfd
 = 
·¿ms
->
Pİ
<>();

70 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_şo£
(
fd
));

71  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

74 
	g´im™ives
::
Prim™iveStus
 
Te¡Fchmod
(

75 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

76 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

78 
mode_t
 
	gmode
 = 
·¿ms
->
Pİ
<mode_t>();

79 
	gfd
 = 
·¿ms
->
Pİ
<>();

81 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fchmod
(
fd
, 
mode
));

82  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

85 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘pid
(

86 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

87 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

89 
	g·¿ms
->
	gPushByCİy
<
	gpid_t
>(
’c_uÁru¡ed_g‘pid
());

90  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

93 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘Ppid
(

94 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

95 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

97 
	g·¿ms
->
	gPushByCİy
<
	gpid_t
>(
’c_uÁru¡ed_g‘µid
());

98  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

101 
	g´im™ives
::
Prim™iveStus
 
Te¡S‘Sid
(

102 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

103 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

105 
	g·¿ms
->
	gPushByCİy
<
	gpid_t
>(
’c_uÁru¡ed_£tsid
());

106  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

109 
	g´im™ives
::
Prim™iveStus
 
Te¡Kl
(

110 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

111 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

113 
	gsig
 = 
·¿ms
->
Pİ
<>();

114 
pid_t
 
	gpid
 = 
·¿ms
->
Pİ
<pid_t>();

116 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_kl
(
pid
, 
sig
));

117  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

120 
	g´im™ives
::
Prim™iveStus
 
Te¡Lšk
(

121 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

122 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

124 cÚ¡‡utØ
	gÃw_·th
 = 
·¿ms
->
Pİ
();

125 cÚ¡‡utØ
	gŞd_·th
 = 
·¿ms
->
Pİ
();

127 
	g·¿ms
->
	gPushByCİy
<>(

128 
’c_uÁru¡ed_lšk
(
Şd_·th
->
As
<>(), 
Ãw_·th
->As<>()));

129  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

132 
	g´im™ives
::
Prim™iveStus
 
Te¡L£ek
(

133 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

134 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

136 
	gwh’û
 = 
·¿ms
->
Pİ
<>();

137 
off_t
 
	goff£t
 = 
·¿ms
->
Pİ
<off_t>();

138 
	gfd
 = 
·¿ms
->
Pİ
<>();

140 
	g·¿ms
->
	gPushByCİy
<
	goff_t
>(
’c_uÁru¡ed_l£ek
(
fd
, 
off£t
, 
wh’û
));

141  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

144 
	g´im™ives
::
Prim™iveStus
 
Te¡Mkdœ
(

145 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

146 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

148 
mode_t
 
	gmode
 = 
·¿ms
->
Pİ
<mode_t>();

149 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

151 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_mkdœ
(
·thÇme
->
As
<>(), 
mode
));

152  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

155 
	g´im™ives
::
Prim™iveStus
 
Te¡O³n
(

156 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

158 ià(
·¿ms
->
size
() == 3) {

159 
mode_t
 
mode
 = 
·¿ms
->
Pİ
<mode_t>();

160 
	gæags
 = 
·¿ms
->
Pİ
<>();

161 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

162 
	g·¿ms
->
	gPushByCİy
<>(

163 
’c_uÁru¡ed_İ’
(
·thÇme
->
As
<>(), 
æags
, 
mode
));

164 } ià(
	g·¿ms
->
size
() == 2) {

165 
æags
 = 
·¿ms
->
Pİ
<>();

166 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

167 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_İ’
(
·thÇme
->
As
<>(), 
æags
));

169  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

173  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

176 
	g´im™ives
::
Prim™iveStus
 
Te¡UÆšk
(

177 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

178 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

180 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

182 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_uÆšk
(
·thÇme
->
As
<>()));

183  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

186 
	g´im™ives
::
Prim™iveStus
 
Te¡Umask
(

187 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

188 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

190 
mode_t
 
	gmask
 = 
·¿ms
->
Pİ
<mode_t>();

192 
	g·¿ms
->
	gPushByCİy
<
	gmode_t
>(
’c_uÁru¡ed_umask
(
mask
));

193  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

196 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘uid
(

197 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

198 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

200 
	g·¿ms
->
	gPushByCİy
<
	guid_t
>(
’c_uÁru¡ed_g‘uid
());

201  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

204 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘gid
(

205 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

206 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

208 
	g·¿ms
->
	gPushByCİy
<
	ggid_t
>(
’c_uÁru¡ed_g‘gid
());

209  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

212 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘euid
(

213 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

214 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

216 
	g·¿ms
->
	gPushByCİy
<
	guid_t
>(
’c_uÁru¡ed_g‘euid
());

217  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

220 
	g´im™ives
::
Prim™iveStus
 
Te¡G‘egid
(

221 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

222 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

224 
	g·¿ms
->
	gPushByCİy
<
	ggid_t
>(
’c_uÁru¡ed_g‘egid
());

225  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

228 
	g´im™ives
::
Prim™iveStus
 
Te¡R’ame
(

229 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

230 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

232 cÚ¡‡utØ
	gÃw·th
 = 
·¿ms
->
Pİ
();

233 cÚ¡‡utØ
	gŞd·th
 = 
·¿ms
->
Pİ
();

235 
	g·¿ms
->
	gPushByCİy
<>(

236 
’c_uÁru¡ed_»Çme
(
Şd·th
->
As
<>(), 
Ãw·th
->As<>()));

237  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

240 
	g´im™ives
::
Prim™iveStus
 
Te¡R—d
(

241 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

242 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

243 
size_t
 
	gcouÁ
 = 
·¿ms
->
Pİ
<size_t>();

244 
	gfd
 = 
·¿ms
->
Pİ
<>();

245 
	g»ad_buf
[20];

247 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(
’c_uÁru¡ed_»ad
(
fd
, 
»ad_buf
, 
couÁ
));

248 
	g·¿ms
->
	gPushByCİy
<>(
	g»ad_buf
, 
¡¾’
(
»ad_buf
) + 1);

249  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

252 
	g´im™ives
::
Prim™iveStus
 
Te¡Wr™e
(

253 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

254 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

255 
size_t
 
	gcouÁ
 = 
·¿ms
->
Pİ
<size_t>();

256 cÚ¡‡utØ
	gwr™e_buf
 = 
·¿ms
->
Pİ
();

257 
	gfd
 = 
·¿ms
->
Pİ
<>();

259 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(

260 
’c_uÁru¡ed_wr™e
(
fd
, 
wr™e_buf
->
As
<>(), 
couÁ
));

261  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

264 
	g´im™ives
::
Prim™iveStus
 
Te¡Symlšk
(

265 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

266 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

267 cÚ¡‡utØ
	glšk·th
 = 
·¿ms
->
Pİ
();

268 cÚ¡‡utØ
	grg‘
 = 
·¿ms
->
Pİ
();

270 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(

271 
’c_uÁru¡ed_symlšk
(
rg‘
->
As
<>(), 
lšk·th
->As<>()));

272  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

275 
	g´im™ives
::
Prim™iveStus
 
Te¡R—dlšk
(

276 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

277 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

278 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

280 
	gbuf
[
PATH_MAX
];

281 
ssize_t
 
	gËn
 =

282 
’c_uÁru¡ed_»adlšk
(
·thÇme
->
As
<>(), 
buf
, (buf) - 1);

283 
	g·¿ms
->
	gPushByCİy
<
	gssize_t
>(
	gËn
);

285 
	gbuf
[
Ën
] = '\0';

286 
	g·¿ms
->
	gPushByCİy
<>(
	gbuf
, 
¡¾’
(
buf
) + 1);

287  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

290 
	g´im™ives
::
Prim™iveStus
 
Te¡Trunÿ‹
(

291 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

292 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

293 
off_t
 
	gËngth
 = 
·¿ms
->
Pİ
<off_t>();

294 cÚ¡‡utØ
	g·th
 = 
·¿ms
->
Pİ
();

296 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_Œunÿ‹
(
·th
->
As
<>(), 
Ëngth
));

298  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

301 
	g´im™ives
::
Prim™iveStus
 
Te¡FTrunÿ‹
(

302 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

303 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

304 autØ
	gËngth
 = 
·¿ms
->
Pİ
<
off_t
>();

305 
	gfd
 = 
·¿ms
->
Pİ
<>();

307 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_árunÿ‹
(
fd
, 
Ëngth
));

309  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

312 
	g´im™ives
::
Prim™iveStus
 
Te¡Rmdœ
(

313 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

314 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

315 cÚ¡‡utØ
	g·th
 = 
·¿ms
->
Pİ
();

317 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_rmdœ
(
·th
->
As
<>()));

318  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

321 
	g´im™ives
::
Prim™iveStus
 
Te¡Sock‘
(

322 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

323 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

325 
	g´ÙocŞ
 = 
·¿ms
->
Pİ
<>();

326 
	gty³
 = 
·¿ms
->
Pİ
<>();

327 
	gdomaš
 = 
·¿ms
->
Pİ
<>();

328 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
));

330  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

333 
	g´im™ives
::
Prim™iveStus
 
Te¡Fú
(

334 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

335 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

337 
	g¬g
 = 
·¿ms
->
Pİ
<>();

338 
	gcmd
 = 
·¿ms
->
Pİ
<>();

339 
	gfd
 = 
·¿ms
->
Pİ
<>();

340 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fú
(
fd
, 
cmd
, 
¬g
));

342  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

345 
	g´im™ives
::
Prim™iveStus
 
Te¡Chown
(

346 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

347 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

349 
gid_t
 
	ggroup
 = 
·¿ms
->
Pİ
<gid_t>();

350 
uid_t
 
	gowÃr
 = 
·¿ms
->
Pİ
<uid_t>();

351 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

352 
	g·¿ms
->
	gPushByCİy
<>(

353 
’c_uÁru¡ed_chown
(
·thÇme
->
As
<>(), 
owÃr
, 
group
));

354  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

357 
	g´im™ives
::
Prim™iveStus
 
Te¡FChown
(

358 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

359 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

361 autØ
	ggroup
 = 
·¿ms
->
Pİ
<
gid_t
>();

362 autØ
	gowÃr
 = 
·¿ms
->
Pİ
<
uid_t
>();

363 
	gfd
 = 
·¿ms
->
Pİ
<>();

364 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fchown
(
fd
, 
owÃr
, 
group
));

365  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

368 
	g´im™ives
::
Prim™iveStus
 
Te¡S‘sockİt
(

369 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

370 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 4);

372 
	gİtiÚ
 = 
·¿ms
->
Pİ
<>();

373 
	gklšux_İŠame
 = 
·¿ms
->
Pİ
<>();

374 
	gËv–
 = 
·¿ms
->
Pİ
<>();

375 
	gsockfd
 = 
·¿ms
->
Pİ
<>();

377 
	gİŠame
;

378 
FromkLšuxO±iÚName
(&
Ëv–
, &
klšux_İŠame
, &
İŠame
);

379 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_£tsockİt
(

380 
sockfd
, 
Ëv–
, 
İŠame
, (*)&
İtiÚ
, (option)));

382  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

385 
	g´im™ives
::
Prim™iveStus
 
Te¡Flock
(

386 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

387 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

389 
	gİ”©iÚ
 =

390 
·¿ms
->
Pİ
<>();

392 
	gfd
 = 
·¿ms
->
Pİ
<>();

393 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
));

395  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

398 
	g´im™ives
::
Prim™iveStus
 
Te¡Fsync
(

399 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

400 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

402 
	gfd
 = 
·¿ms
->
Pİ
<>();

403 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_fsync
(
fd
));

405  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

408 
	g´im™ives
::
Prim™iveStus
 
Te¡InÙifyIn™1
(

409 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

410 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

412 
	gæags
 = 
·¿ms
->
Pİ
<>();

414 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_šÙify_š™1
(
æags
));

415  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

418 
	g´im™ives
::
Prim™iveStus
 
Te¡InÙifyAddW©ch
(

419 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

420 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 3);

422 
ušt32_t
 
	gmask
 =

423 
·¿ms
->
Pİ
<
ušt32_t
>();

425 cÚ¡‡utØ
	g·thÇme
 = 
·¿ms
->
Pİ
();

426 
	gfd
 = 
·¿ms
->
Pİ
<>();

427 
	g·¿ms
->
	gPushByCİy
<>(

428 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, 
·thÇme
->
As
<>(), 
mask
));

430  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

433 
	g´im™ives
::
Prim™iveStus
 
Te¡InÙifyRmW©ch
(

434 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

435 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

437 
	gwd
 = 
·¿ms
->
Pİ
<>();

438 
	gfd
 = 
·¿ms
->
Pİ
<>();

439 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
));

440  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

443 
	g´im™ives
::
Prim™iveStus
 
Te¡SchedY›ld
(

444 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

445 
ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
);

447 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_sched_y›ld
());

448  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

451 
	g´im™ives
::
Prim™iveStus
 
Te¡IsA‰y
(

452 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

453 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

455 
	gfd
 = 
·¿ms
->
Pİ
<>();

456 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_i§‰y
(
fd
));

457  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

460 
	g´im™ives
::
Prim™iveStus
 
Te¡USË•
(

461 *
cÚ‹xt
, 
´im™ives
::
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

462 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

463 autØ
	gu£c
 = 
·¿ms
->
Pİ
<>();

464 
	g·¿ms
->
	gPushByCİy
<>(
’c_uÁru¡ed_u¦“p
(
u£c
));

465  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

471 "C" 
´im™ives
::
Prim™iveStus
 
asylo_’şave_š™
() {

473 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

475 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

476 
kAbÜtEnşaveS–eùÜ
, 
´im™ives
::
EÁryHªdËr
{
AbÜt
}));

477 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

478 
kTe¡Acûss
, 
´im™ives
::
EÁryHªdËr
{
Te¡Acûss
}));

479 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

480 
kTe¡Chmod
, 
´im™ives
::
EÁryHªdËr
{
Te¡Chmod
}));

481 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

482 
kTe¡Clo£
, 
´im™ives
::
EÁryHªdËr
{
Te¡Clo£
}));

483 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

484 
kTe¡Fchmod
, 
´im™ives
::
EÁryHªdËr
{
Te¡Fchmod
}));

485 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

486 
kTe¡G‘Pid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘pid
}));

487 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

488 
kTe¡G‘Ppid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘Ppid
}));

489 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

490 
kTe¡S‘Sid
, 
´im™ives
::
EÁryHªdËr
{
Te¡S‘Sid
}));

491 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

492 
kTe¡Kl
, 
´im™ives
::
EÁryHªdËr
{
Te¡Kl
}));

493 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

494 
kTe¡Lšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡Lšk
}));

495 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

496 
kTe¡L£ek
, 
´im™ives
::
EÁryHªdËr
{
Te¡L£ek
}));

497 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

498 
kTe¡Mkdœ
, 
´im™ives
::
EÁryHªdËr
{
Te¡Mkdœ
}));

499 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

500 
kTe¡O³n
, 
´im™ives
::
EÁryHªdËr
{
Te¡O³n
}));

501 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

502 
kTe¡UÆšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡UÆšk
}));

503 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

504 
kTe¡Umask
, 
´im™ives
::
EÁryHªdËr
{
Te¡Umask
}));

505 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

506 
kTe¡G‘Uid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘uid
}));

507 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

508 
kTe¡G‘Gid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘gid
}));

509 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

510 
kTe¡G‘Euid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘euid
}));

511 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

512 
kTe¡G‘Egid
, 
´im™ives
::
EÁryHªdËr
{
Te¡G‘egid
}));

513 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

514 
kTe¡R’ame
, 
´im™ives
::
EÁryHªdËr
{
Te¡R’ame
}));

515 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

516 
kTe¡R—d
, 
´im™ives
::
EÁryHªdËr
{
Te¡R—d
}));

517 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

518 
kTe¡Wr™e
, 
´im™ives
::
EÁryHªdËr
{
Te¡Wr™e
}));

519 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

520 
kTe¡Symlšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡Symlšk
}));

521 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

522 
kTe¡R—dLšk
, 
´im™ives
::
EÁryHªdËr
{
Te¡R—dlšk
}));

523 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

524 
kTe¡Trunÿ‹
, 
´im™ives
::
EÁryHªdËr
{
Te¡Trunÿ‹
}));

525 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

526 
kTe¡FTrunÿ‹
, 
´im™ives
::
EÁryHªdËr
{
Te¡FTrunÿ‹
}));

527 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

528 
kTe¡Rmdœ
, 
´im™ives
::
EÁryHªdËr
{
Te¡Rmdœ
}));

529 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

530 
kTe¡Sock‘
, 
´im™ives
::
EÁryHªdËr
{
Te¡Sock‘
}));

531 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

532 
kTe¡Fú
, 
´im™ives
::
EÁryHªdËr
{
Te¡Fú
}));

533 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

534 
kTe¡Chown
, 
´im™ives
::
EÁryHªdËr
{
Te¡Chown
}));

535 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

536 
kTe¡FChown
, 
´im™ives
::
EÁryHªdËr
{
Te¡FChown
}));

537 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

538 
kTe¡S‘SockO±
, 
´im™ives
::
EÁryHªdËr
{
Te¡S‘sockİt
}));

539 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

540 
kTe¡Flock
, 
´im™ives
::
EÁryHªdËr
{
Te¡Flock
}));

541 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

542 
kTe¡Fsync
, 
´im™ives
::
EÁryHªdËr
{
Te¡Fsync
}));

543 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

544 
kTe¡InÙifyIn™1
, 
´im™ives
::
EÁryHªdËr
{
Te¡InÙifyIn™1
}));

545 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

546 
kTe¡InÙifyAddW©ch
, 
´im™ives
::
EÁryHªdËr
{
Te¡InÙifyAddW©ch
}));

547 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

548 
kTe¡InÙifyRmW©ch
, 
´im™ives
::
EÁryHªdËr
{
Te¡InÙifyRmW©ch
}));

549 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

550 
kTe¡SchedY›ld
, 
´im™ives
::
EÁryHªdËr
{
Te¡SchedY›ld
}));

551 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

552 
kTe¡IsA‰y
, 
´im™ives
::
EÁryHªdËr
{
Te¡IsA‰y
}));

553 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

554 
kTe¡USË•
, 
´im™ives
::
EÁryHªdËr
{
Te¡USË•
}));

556  
´im™ives
::
Prim™iveStus
::
OkStus
();

560 "C" 
´im™ives
::
Prim™iveStus
 
asylo_’şave_fši
() {

561  
´im™ives
::
Prim™iveStus
::
OkStus
();

567 "C" 
Prim™iveStus
 
	$’c_š™
(è{  
Prim™iveStus
::
	`OkStus
(); 
	}
}

	@platform/host_call/trusted/host_call_dispatcher.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎ_di¥©ch”.h
"

20 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

21 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

22 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

23 
	~"asylo/ut/¡©us_maüos.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gho¡_ÿÎ
 {

28 
	g´im™ives
::
Prim™iveStus
 
Sy¡emC®lDi¥©ch”
(cÚ¡ 
ušt8_t
* 
»que¡_bufãr
,

29 
size_t
 
»que¡_size
,

30 
ušt8_t
** 
»¥Ú£_bufãr
,

31 
size_t
* 
»¥Ú£_size
) {

32 
	g´im™ives
::
Tru¡edP¬am‘”Sck
 
·¿m‘”s
;

34 ià(
	g»que¡_size
 =ğ0 || 
»que¡_bufãr
 =ğ
nuÎ±r
) {

35  
´im™ives
::
Prim™iveStus
{

36 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

44 
	g·¿m‘”s
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
»que¡_bufãr
, 
»que¡_size
});

46 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
UÁru¡edC®l
(

47 
kSy¡emC®lHªdËr
, &
·¿m‘”s
));

54 ià(
	g·¿m‘”s
.
em±y
()) {

55  
	g´im™ives
::
Prim™iveStus
{

56 
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

61 autØ
	g»¥Ú£
 = 
·¿m‘”s
.
Pİ
();

62 *
	g»¥Ú£_size
 = 
»¥Ú£
->
size
();

67 *
	g»¥Ú£_bufãr
 = 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(*
»¥Ú£_size
));

68 
memıy
(*
»¥Ú£_bufãr
, 
»¥Ú£
->
As
<
ušt8_t
>(), *
»¥Ú£_size
);

70  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

73 
	g´im™ives
::
Prim™iveStus
 
NÚSy¡emC®lDi¥©ch”
(

74 
ušt64_t
 
ex™_£ËùÜ
, 
´im™ives
::
Tru¡edP¬am‘”Sck
* 
·¿m‘”s
) {

75 ià(
·¿m‘”s
 =ğ
nuÎ±r
 ||…¬am‘”s->
em±y
()) {

76  
´im™ives
::
Prim™iveStus
{

77 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

82 
ASYLO_RETURN_IF_ERROR
(

83 
´im™ives
::
Tru¡edPrim™ives
::
UÁru¡edC®l
(
ex™_£ËùÜ
, 
·¿m‘”s
));

86 ià(
	g·¿m‘”s
->
em±y
()) {

87  
	g´im™ives
::
Prim™iveStus
{

88 
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

93  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

	@platform/host_call/trusted/host_call_dispatcher.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎ_di¥©ch”.h
"

20 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

21 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

22 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

23 
	~"asylo/ut/¡©us_maüos.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gho¡_ÿÎ
 {

28 
	g´im™ives
::
Prim™iveStus
 
Sy¡emC®lDi¥©ch”
(cÚ¡ 
ušt8_t
* 
»que¡_bufãr
,

29 
size_t
 
»que¡_size
,

30 
ušt8_t
** 
»¥Ú£_bufãr
,

31 
size_t
* 
»¥Ú£_size
) {

32 
	g´im™ives
::
Tru¡edP¬am‘”Sck
 
·¿m‘”s
;

34 ià(
	g»que¡_size
 =ğ0 || 
»que¡_bufãr
 =ğ
nuÎ±r
) {

35  
´im™ives
::
Prim™iveStus
{

36 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

44 
	g·¿m‘”s
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
»que¡_bufãr
, 
»que¡_size
});

46 
ASYLO_RETURN_IF_ERROR
(
´im™ives
::
Tru¡edPrim™ives
::
UÁru¡edC®l
(

47 
kSy¡emC®lHªdËr
, &
·¿m‘”s
));

54 ià(
	g·¿m‘”s
.
em±y
()) {

55  
	g´im™ives
::
Prim™iveStus
{

56 
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

61 autØ
	g»¥Ú£
 = 
·¿m‘”s
.
Pİ
();

62 *
	g»¥Ú£_size
 = 
»¥Ú£
->
size
();

67 *
	g»¥Ú£_bufãr
 = 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(*
»¥Ú£_size
));

68 
memıy
(*
»¥Ú£_bufãr
, 
»¥Ú£
->
As
<
ušt8_t
>(), *
»¥Ú£_size
);

70  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

73 
	g´im™ives
::
Prim™iveStus
 
NÚSy¡emC®lDi¥©ch”
(

74 
ušt64_t
 
ex™_£ËùÜ
, 
´im™ives
::
Tru¡edP¬am‘”Sck
* 
·¿m‘”s
) {

75 ià(
·¿m‘”s
 =ğ
nuÎ±r
 ||…¬am‘”s->
em±y
()) {

76  
´im™ives
::
Prim™iveStus
{

77 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

82 
ASYLO_RETURN_IF_ERROR
(

83 
´im™ives
::
Tru¡edPrim™ives
::
UÁru¡edC®l
(
ex™_£ËùÜ
, 
·¿m‘”s
));

86 ià(
	g·¿m‘”s
->
em±y
()) {

87  
	g´im™ives
::
Prim™iveStus
{

88 
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

93  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

	@platform/host_call/trusted/host_call_dispatcher.h

19 #iâdeà
ASYLO_PLATFORM_HOST_CALL_TRUSTED_HOST_CALL_DISPATCHER_H_


20 
	#ASYLO_PLATFORM_HOST_CALL_TRUSTED_HOST_CALL_DISPATCHER_H_


	)

22 
	~<¡ddef.h
>

24 
	~<c¡dšt
>

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

27 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gho¡_ÿÎ
 {

40 
	g´im™ives
::
Prim™iveStus
 
Sy¡emC®lDi¥©ch”
(cÚ¡ 
ušt8_t
* 
»que¡_bufãr
,

41 
size_t
 
»que¡_size
,

42 
ušt8_t
** 
»¥Ú£_bufãr
,

43 
size_t
* 
»¥Ú£_size
);

47 
	g´im™ives
::
Prim™iveStus
 
NÚSy¡emC®lDi¥©ch”
(

48 
ušt64_t
 
ex™_£ËùÜ
, 
´im™ives
::
Tru¡edP¬am‘”Sck
* 
·¿m‘”s
);

	@platform/host_call/trusted/host_calls.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎs.h
"

21 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

22 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎ_di¥©ch”.h
"

23 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

24 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_funùiÚs.h
"

28 
’c_uÁru¡ed_acûss
(cÚ¡ *
·th_Çme
, 
mode
) {

29  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_acûss
, 
·th_Çme
,

30 
mode
);

33 
’c_uÁru¡ed_şo£
(
fd
) {

34  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_şo£
, 
fd
);

37 
pid_t
 
’c_uÁru¡ed_g‘pid
() {

38  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘pid
);

41 
pid_t
 
’c_uÁru¡ed_g‘µid
() {

42  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘µid
);

45 
pid_t
 
’c_uÁru¡ed_£tsid
() {

46  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_£tsid
);

49 
’c_uÁru¡ed_kl
(
pid_t
 
pid
, 
sig
) {

50  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_kl
, 
pid
, 
sig
);

53 
’c_uÁru¡ed_lšk
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

54  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_lšk
, 
Şd·th
, 
Ãw·th
);

57 
off_t
 
’c_uÁru¡ed_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
) {

58  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_l£ek
, 
fd
, 
off£t
,

59 
wh’û
);

62 
’c_uÁru¡ed_mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

63  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_mkdœ
, 
·thÇme
, 
mode
);

66 
’c_uÁru¡ed_İ’
(cÚ¡ *
·thÇme
, 
æags
, ...) {

67 
ušt32_t
 
mode
 = 0;

68 ià(
æags
 & 
O_CREAT
) {

69 
va_li¡
 
­
;

70 
va_¡¬t
(
­
, 
æags
);

71 
mode
 = 
va_¬g
(
­
, 
mode_t
);

72 
va_’d
(
­
);

75 
klšux_æags
;

76 
TokLšuxFeStusFÏg
(&
æags
, &
klšux_æags
);

77  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_İ’
, 
·thÇme
,

78 
klšux_æags
, 
mode
);

81 
’c_uÁru¡ed_uÆšk
(cÚ¡ *
·thÇme
) {

82  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_uÆšk
, 
·thÇme
);

85 
uid_t
 
’c_uÁru¡ed_g‘uid
() {

86  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘uid
);

89 
gid_t
 
’c_uÁru¡ed_g‘gid
() {

90  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘gid
);

93 
uid_t
 
’c_uÁru¡ed_g‘euid
() {

94  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘euid
);

97 
gid_t
 
’c_uÁru¡ed_g‘egid
() {

98  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘egid
);

101 
’c_uÁru¡ed_»Çme
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

102  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_»Çme
, 
Şd·th
,

103 
Ãw·th
);

106 
ssize_t
 
’c_uÁru¡ed_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

107  
¡©ic_ÿ¡
<
ssize_t
>(

108 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_»ad
, 
fd
, 
buf
, 
couÁ
));

111 
ssize_t
 
’c_uÁru¡ed_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

112  
¡©ic_ÿ¡
<
ssize_t
>(

113 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_wr™e
, 
fd
, 
buf
, 
couÁ
));

116 
’c_uÁru¡ed_symlšk
(cÚ¡ *
rg‘
, cÚ¡ *
lšk·th
) {

117  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_symlšk
, 
rg‘
,

118 
lšk·th
);

121 
ssize_t
 
’c_uÁru¡ed_»adlšk
(cÚ¡ *
·thÇme
, *
buf
, 
size_t
 
bufsiz
) {

122  
¡©ic_ÿ¡
<
ssize_t
>(
’c_uÁru¡ed_sysÿÎ
(

123 
asylo
::
sy¡em_ÿÎ
::
kSYS_»adlšk
, 
·thÇme
, 
buf
, 
bufsiz
));

126 
’c_uÁru¡ed_Œunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

127  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_Œunÿ‹
, 
·th
, 
Ëngth
);

130 
’c_uÁru¡ed_árunÿ‹
(
fd
, 
off_t
 
Ëngth
) {

131  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_árunÿ‹
, 
fd
, 
Ëngth
);

134 
’c_uÁru¡ed_rmdœ
(cÚ¡ *
·th
) {

135  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_rmdœ
, 
·th
);

138 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

139 
klšux_domaš
;

140 
klšux_ty³
;

141 
TokLšuxAfFamy
(&
domaš
, &
klšux_domaš
);

142 
TokLšuxSock‘Ty³
(&
ty³
, &
klšux_ty³
);

143  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_sock‘
, 
klšux_domaš
,

144 
klšux_ty³
, 
´ÙocŞ
);

147 
’c_uÁru¡ed_fú
(
fd
, 
cmd
, ... ) {

150 
št64_t
 
¬g
 = 0;

151 
va_li¡
 
­
;

152 
va_¡¬t
(
­
, 
cmd
);

153 
¬g
 = 
va_¬g
(
­
, 
št64_t
);

154 
va_’d
(
­
);

156 
klšux_cmd
;

157 
TokLšuxFúCommªd
(&
cmd
, &
klšux_cmd
);

158 ià(
klšux_cmd
 == -1) {

159 
”ºo
 = 
EINVAL
;

163 
šrg
 = 
¬g
;

164 
cmd
) {

165 
F_SETFL
: {

166 
klšux_¬g
;

167 
TokLšuxFeStusFÏg
(&
šrg
, &
klšux_¬g
);

168  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

169 
klšux_cmd
, 
klšux_¬g
);

171 
F_SETFD
: {

172 
klšux_¬g
;

173 
TokLšuxFDFÏg
(&
šrg
, &
klšux_¬g
);

174  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

175 
klšux_cmd
, 
klšux_¬g
);

177 
F_GETFL
: {

178 
»tv®
 = 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

179 
klšux_cmd
, 
¬g
);

180 ià(
»tv®
 != -1) {

181 
»suÉ
;

182 
FromkLšuxFeStusFÏg
(&
»tv®
, &
»suÉ
);

183 
»tv®
 = 
»suÉ
;

186  
»tv®
;

188 
F_GETFD
: {

189 
»tv®
 = 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

190 
klšux_cmd
, 
¬g
);

191 ià(
»tv®
 != -1) {

192 
»suÉ
;

193 
FromkLšuxFDFÏg
(&
»tv®
, &
»suÉ
);

194 
»tv®
 = 
»suÉ
;

196  
»tv®
;

198 
F_GETPIPE_SZ
:

199 
F_SETPIPE_SZ
: {

200  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

201 
klšux_cmd
, 
¬g
);

207 
”ºo
 = 
EINVAL
;

213 
’c_uÁru¡ed_chown
(cÚ¡ *
·thÇme
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

214  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_chown
, 
·thÇme
, 
owÃr
,

215 
group
);

218 
’c_uÁru¡ed_fchown
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

219  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fchown
, 
fd
, 
owÃr
,

220 
group
);

223 
’c_uÁru¡ed_£tsockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

224 cÚ¡ *
İtv®
, 
sockËn_t
 
İ’
) {

225 
klšux_İtiÚ_Çme
;

226 
TokLšuxO±iÚName
(&
Ëv–
, &
İŠame
, &
klšux_İtiÚ_Çme
);

227  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_£tsockİt
, 
sockfd
,

228 
Ëv–
, 
klšux_İtiÚ_Çme
, 
İtv®
, 
İ’
);

231 
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
) {

232 
klšux_İ”©iÚ
;

233 
TokLšuxFLockO³¿tiÚ
(&
İ”©iÚ
, &
klšux_İ”©iÚ
);

234  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_æock
, 
fd
,

235 
klšux_İ”©iÚ
);

238 
’c_uÁru¡ed_fsync
(
fd
) {

239  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fsync
, 
fd
);

242 
’c_uÁru¡ed_šÙify_š™1
(
æags
) {

243 
klšux_æags
;

244 
TokLšuxInÙifyFÏg
(&
æags
, &
klšux_æags
);

245  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_š™1
,

246 
klšux_æags
);

249 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
,

250 
ušt32_t
 
mask
) {

251 
klšux_mask
, 
šput_mask
 = 
mask
;

252 
TokLšuxInÙifyEv’tMask
(&
šput_mask
, &
klšux_mask
);

253  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_add_w©ch
, 
fd
,

254 
·thÇme
, 
klšux_mask
);

257 
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
) {

258  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_rm_w©ch
, 
fd
,

259 
wd
);

262 
mode_t
 
’c_uÁru¡ed_umask
(mode_ˆ
mask
) {

263  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_umask
, 
mask
);

266 
’c_uÁru¡ed_chmod
(cÚ¡ *
·th_Çme
, 
mode_t
 
mode
) {

267  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_chmod
, 
·th_Çme
, 
mode
);

270 
’c_uÁru¡ed_fchmod
(
fd
, 
mode_t
 
mode
) {

271  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fchmod
, 
fd
, 
mode
);

274 
’c_uÁru¡ed_sched_y›ld
() {

275  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_sched_y›ld
);

278 
’c_uÁru¡ed_i§‰y
(
fd
) {

279 
asylo
::
´im™ives
::
Tru¡edP¬am‘”Sck
 
·¿ms
;

280 
·¿ms
.
PushByCİy
(
fd
);

281 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
 =

282 
asylo
::
ho¡_ÿÎ
::
NÚSy¡emC®lDi¥©ch”
(

283 
asylo
::
ho¡_ÿÎ
::
kIsA‰yHªdËr
, &
·¿ms
);

284 ià(!
¡©us
.
ok
()) {

285 
abÜt
();

287  
·¿ms
.
Pİ
<>();

290 
’c_uÁru¡ed_u¦“p
(
u£cÚds_t
 
u£c
) {

291 
asylo
::
´im™ives
::
Tru¡edP¬am‘”Sck
 
·¿ms
;

292 
·¿ms
.
PushByCİy
(
u£c
);

293 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
 =

294 
asylo
::
ho¡_ÿÎ
::
NÚSy¡emC®lDi¥©ch”
(

295 
asylo
::
ho¡_ÿÎ
::
kUSË•HªdËr
, &
·¿ms
);

296 ià(!
¡©us
.
ok
()) {

297 
abÜt
();

299  
·¿ms
.
Pİ
<>();

	@platform/host_call/trusted/host_calls.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎs.h
"

21 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

22 
	~"asylo/¶©fÜm/ho¡_ÿÎ/Œu¡ed/ho¡_ÿÎ_di¥©ch”.h
"

23 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

24 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_funùiÚs.h
"

28 
’c_uÁru¡ed_acûss
(cÚ¡ *
·th_Çme
, 
mode
) {

29  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_acûss
, 
·th_Çme
,

30 
mode
);

33 
’c_uÁru¡ed_şo£
(
fd
) {

34  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_şo£
, 
fd
);

37 
pid_t
 
’c_uÁru¡ed_g‘pid
() {

38  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘pid
);

41 
pid_t
 
’c_uÁru¡ed_g‘µid
() {

42  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘µid
);

45 
pid_t
 
’c_uÁru¡ed_£tsid
() {

46  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_£tsid
);

49 
’c_uÁru¡ed_kl
(
pid_t
 
pid
, 
sig
) {

50  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_kl
, 
pid
, 
sig
);

53 
’c_uÁru¡ed_lšk
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

54  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_lšk
, 
Şd·th
, 
Ãw·th
);

57 
off_t
 
’c_uÁru¡ed_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
) {

58  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_l£ek
, 
fd
, 
off£t
,

59 
wh’û
);

62 
’c_uÁru¡ed_mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

63  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_mkdœ
, 
·thÇme
, 
mode
);

66 
’c_uÁru¡ed_İ’
(cÚ¡ *
·thÇme
, 
æags
, ...) {

67 
ušt32_t
 
mode
 = 0;

68 ià(
æags
 & 
O_CREAT
) {

69 
va_li¡
 
­
;

70 
va_¡¬t
(
­
, 
æags
);

71 
mode
 = 
va_¬g
(
­
, 
mode_t
);

72 
va_’d
(
­
);

75 
klšux_æags
;

76 
TokLšuxFeStusFÏg
(&
æags
, &
klšux_æags
);

77  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_İ’
, 
·thÇme
,

78 
klšux_æags
, 
mode
);

81 
’c_uÁru¡ed_uÆšk
(cÚ¡ *
·thÇme
) {

82  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_uÆšk
, 
·thÇme
);

85 
uid_t
 
’c_uÁru¡ed_g‘uid
() {

86  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘uid
);

89 
gid_t
 
’c_uÁru¡ed_g‘gid
() {

90  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘gid
);

93 
uid_t
 
’c_uÁru¡ed_g‘euid
() {

94  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘euid
);

97 
gid_t
 
’c_uÁru¡ed_g‘egid
() {

98  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_g‘egid
);

101 
’c_uÁru¡ed_»Çme
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

102  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_»Çme
, 
Şd·th
,

103 
Ãw·th
);

106 
ssize_t
 
’c_uÁru¡ed_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

107  
¡©ic_ÿ¡
<
ssize_t
>(

108 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_»ad
, 
fd
, 
buf
, 
couÁ
));

111 
ssize_t
 
’c_uÁru¡ed_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

112  
¡©ic_ÿ¡
<
ssize_t
>(

113 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_wr™e
, 
fd
, 
buf
, 
couÁ
));

116 
’c_uÁru¡ed_symlšk
(cÚ¡ *
rg‘
, cÚ¡ *
lšk·th
) {

117  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_symlšk
, 
rg‘
,

118 
lšk·th
);

121 
ssize_t
 
’c_uÁru¡ed_»adlšk
(cÚ¡ *
·thÇme
, *
buf
, 
size_t
 
bufsiz
) {

122  
¡©ic_ÿ¡
<
ssize_t
>(
’c_uÁru¡ed_sysÿÎ
(

123 
asylo
::
sy¡em_ÿÎ
::
kSYS_»adlšk
, 
·thÇme
, 
buf
, 
bufsiz
));

126 
’c_uÁru¡ed_Œunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

127  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_Œunÿ‹
, 
·th
, 
Ëngth
);

130 
’c_uÁru¡ed_árunÿ‹
(
fd
, 
off_t
 
Ëngth
) {

131  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_árunÿ‹
, 
fd
, 
Ëngth
);

134 
’c_uÁru¡ed_rmdœ
(cÚ¡ *
·th
) {

135  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_rmdœ
, 
·th
);

138 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

139 
klšux_domaš
;

140 
klšux_ty³
;

141 
TokLšuxAfFamy
(&
domaš
, &
klšux_domaš
);

142 
TokLšuxSock‘Ty³
(&
ty³
, &
klšux_ty³
);

143  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_sock‘
, 
klšux_domaš
,

144 
klšux_ty³
, 
´ÙocŞ
);

147 
’c_uÁru¡ed_fú
(
fd
, 
cmd
, ... ) {

150 
št64_t
 
¬g
 = 0;

151 
va_li¡
 
­
;

152 
va_¡¬t
(
­
, 
cmd
);

153 
¬g
 = 
va_¬g
(
­
, 
št64_t
);

154 
va_’d
(
­
);

156 
klšux_cmd
;

157 
TokLšuxFúCommªd
(&
cmd
, &
klšux_cmd
);

158 ià(
klšux_cmd
 == -1) {

159 
”ºo
 = 
EINVAL
;

163 
šrg
 = 
¬g
;

164 
cmd
) {

165 
F_SETFL
: {

166 
klšux_¬g
;

167 
TokLšuxFeStusFÏg
(&
šrg
, &
klšux_¬g
);

168  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

169 
klšux_cmd
, 
klšux_¬g
);

171 
F_SETFD
: {

172 
klšux_¬g
;

173 
TokLšuxFDFÏg
(&
šrg
, &
klšux_¬g
);

174  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

175 
klšux_cmd
, 
klšux_¬g
);

177 
F_GETFL
: {

178 
»tv®
 = 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

179 
klšux_cmd
, 
¬g
);

180 ià(
»tv®
 != -1) {

181 
»suÉ
;

182 
FromkLšuxFeStusFÏg
(&
»tv®
, &
»suÉ
);

183 
»tv®
 = 
»suÉ
;

186  
»tv®
;

188 
F_GETFD
: {

189 
»tv®
 = 
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

190 
klšux_cmd
, 
¬g
);

191 ià(
»tv®
 != -1) {

192 
»suÉ
;

193 
FromkLšuxFDFÏg
(&
»tv®
, &
»suÉ
);

194 
»tv®
 = 
»suÉ
;

196  
»tv®
;

198 
F_GETPIPE_SZ
:

199 
F_SETPIPE_SZ
: {

200  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fú
, 
fd
,

201 
klšux_cmd
, 
¬g
);

207 
”ºo
 = 
EINVAL
;

213 
’c_uÁru¡ed_chown
(cÚ¡ *
·thÇme
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

214  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_chown
, 
·thÇme
, 
owÃr
,

215 
group
);

218 
’c_uÁru¡ed_fchown
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

219  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fchown
, 
fd
, 
owÃr
,

220 
group
);

223 
’c_uÁru¡ed_£tsockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

224 cÚ¡ *
İtv®
, 
sockËn_t
 
İ’
) {

225 
klšux_İtiÚ_Çme
;

226 
TokLšuxO±iÚName
(&
Ëv–
, &
İŠame
, &
klšux_İtiÚ_Çme
);

227  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_£tsockİt
, 
sockfd
,

228 
Ëv–
, 
klšux_İtiÚ_Çme
, 
İtv®
, 
İ’
);

231 
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
) {

232 
klšux_İ”©iÚ
;

233 
TokLšuxFLockO³¿tiÚ
(&
İ”©iÚ
, &
klšux_İ”©iÚ
);

234  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_æock
, 
fd
,

235 
klšux_İ”©iÚ
);

238 
’c_uÁru¡ed_fsync
(
fd
) {

239  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fsync
, 
fd
);

242 
’c_uÁru¡ed_šÙify_š™1
(
æags
) {

243 
klšux_æags
;

244 
TokLšuxInÙifyFÏg
(&
æags
, &
klšux_æags
);

245  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_š™1
,

246 
klšux_æags
);

249 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
,

250 
ušt32_t
 
mask
) {

251 
klšux_mask
, 
šput_mask
 = 
mask
;

252 
TokLšuxInÙifyEv’tMask
(&
šput_mask
, &
klšux_mask
);

253  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_add_w©ch
, 
fd
,

254 
·thÇme
, 
klšux_mask
);

257 
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
) {

258  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_šÙify_rm_w©ch
, 
fd
,

259 
wd
);

262 
mode_t
 
’c_uÁru¡ed_umask
(mode_ˆ
mask
) {

263  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_umask
, 
mask
);

266 
’c_uÁru¡ed_chmod
(cÚ¡ *
·th_Çme
, 
mode_t
 
mode
) {

267  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_chmod
, 
·th_Çme
, 
mode
);

270 
’c_uÁru¡ed_fchmod
(
fd
, 
mode_t
 
mode
) {

271  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_fchmod
, 
fd
, 
mode
);

274 
’c_uÁru¡ed_sched_y›ld
() {

275  
’c_uÁru¡ed_sysÿÎ
(
asylo
::
sy¡em_ÿÎ
::
kSYS_sched_y›ld
);

278 
’c_uÁru¡ed_i§‰y
(
fd
) {

279 
asylo
::
´im™ives
::
Tru¡edP¬am‘”Sck
 
·¿ms
;

280 
·¿ms
.
PushByCİy
(
fd
);

281 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
 =

282 
asylo
::
ho¡_ÿÎ
::
NÚSy¡emC®lDi¥©ch”
(

283 
asylo
::
ho¡_ÿÎ
::
kIsA‰yHªdËr
, &
·¿ms
);

284 ià(!
¡©us
.
ok
()) {

285 
abÜt
();

287  
·¿ms
.
Pİ
<>();

290 
’c_uÁru¡ed_u¦“p
(
u£cÚds_t
 
u£c
) {

291 
asylo
::
´im™ives
::
Tru¡edP¬am‘”Sck
 
·¿ms
;

292 
·¿ms
.
PushByCİy
(
u£c
);

293 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
 =

294 
asylo
::
ho¡_ÿÎ
::
NÚSy¡emC®lDi¥©ch”
(

295 
asylo
::
ho¡_ÿÎ
::
kUSË•HªdËr
, &
·¿ms
);

296 ià(!
¡©us
.
ok
()) {

297 
abÜt
();

299  
·¿ms
.
Pİ
<>();

	@platform/host_call/trusted/host_calls.h

19 #iâdeà
ASYLO_PLATFORM_HOST_CALL_TRUSTED_HOST_CALLS_H_


20 
	#ASYLO_PLATFORM_HOST_CALL_TRUSTED_HOST_CALLS_H_


	)

26 
	~<fú.h
>

27 
	~<sys/sock‘.h
>

29 
	~<c¡d¬g
>

30 
	~<c¡ddef
>

31 
	~<c¡dšt
>

33 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¢o.h
"

34 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¡em_ÿÎ.h
"

36 #ifdeà
__ılu¥lus


42 
’c_uÁru¡ed_acûss
(cÚ¡ *
·th_Çme
, 
mode
);

43 
’c_uÁru¡ed_şo£
(
fd
);

44 
pid_t
 
’c_uÁru¡ed_g‘pid
();

45 
pid_t
 
’c_uÁru¡ed_g‘µid
();

46 
pid_t
 
’c_uÁru¡ed_£tsid
();

47 
’c_uÁru¡ed_kl
(
pid_t
 
pid
, 
sig
);

48 
’c_uÁru¡ed_lšk
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
);

49 
off_t
 
’c_uÁru¡ed_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
);

50 
’c_uÁru¡ed_mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
);

51 
’c_uÁru¡ed_İ’
(cÚ¡ *
·thÇme
, 
æags
, ...);

52 
’c_uÁru¡ed_uÆšk
(cÚ¡ *
·thÇme
);

53 
uid_t
 
’c_uÁru¡ed_g‘uid
();

54 
gid_t
 
’c_uÁru¡ed_g‘gid
();

55 
uid_t
 
’c_uÁru¡ed_g‘euid
();

56 
gid_t
 
’c_uÁru¡ed_g‘egid
();

57 
’c_uÁru¡ed_»Çme
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
);

58 
ssize_t
 
’c_uÁru¡ed_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
);

59 
ssize_t
 
’c_uÁru¡ed_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

60 
’c_uÁru¡ed_symlšk
(cÚ¡ *
rg‘
, cÚ¡ *
lšk·th
);

61 
ssize_t
 
’c_uÁru¡ed_»adlšk
(cÚ¡ *
·thÇme
, *
buf
, 
size_t
 
bufsiz
);

62 
’c_uÁru¡ed_Œunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
);

63 
’c_uÁru¡ed_árunÿ‹
(
fd
, 
off_t
 
Ëngth
);

64 
’c_uÁru¡ed_rmdœ
(cÚ¡ *
·th
);

65 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

66 
’c_uÁru¡ed_fú
(
fd
, 
cmd
, ... );

67 
’c_uÁru¡ed_chown
(cÚ¡ *
·thÇme
, 
uid_t
 
owÃr
, 
gid_t
 
group
);

68 
’c_uÁru¡ed_fchown
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
);

69 
’c_uÁru¡ed_£tsockİt
(
sockfd
, 
Ëv–
, 
İŠame
,

70 cÚ¡ *
İtv®
, 
sockËn_t
 
İ’
);

71 
’c_uÁru¡ed_æock
(
fd
, 
İ”©iÚ
);

72 
’c_uÁru¡ed_fsync
(
fd
);

73 
’c_uÁru¡ed_šÙify_š™1
(
æags
);

74 
’c_uÁru¡ed_šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
,

75 
ušt32_t
 
mask
);

76 
’c_uÁru¡ed_šÙify_rm_w©ch
(
fd
, 
wd
);

77 
mode_t
 
’c_uÁru¡ed_umask
(mode_ˆ
mask
);

78 
’c_uÁru¡ed_chmod
(cÚ¡ *
·th
, 
mode_t
 
mode
);

79 
’c_uÁru¡ed_fchmod
(
fd
, 
mode_t
 
mode
);

80 
’c_uÁru¡ed_sched_y›ld
();

83 
’c_uÁru¡ed_i§‰y
(
fd
);

84 
’c_uÁru¡ed_u¦“p
(
u£cÚds_t
 
u£c
);

86 #ifdeà
__ılu¥lus


	@platform/host_call/untrusted/host_call_handlers.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs.h
"

21 
	~<uni¡d.h
>

23 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

24 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/uÁru¡ed_švoke.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gho¡_ÿÎ
 {

30 
Stus
 
Sy¡emC®lHªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

31 *
cÚ‹xt
,

32 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
) {

33 ià(
·¿m‘”s
->
em±y
()) {

34  
Stus
(

35 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

39 autØ
	g»que¡
 = 
·¿m‘”s
->
Pİ
();

40 ià(!
	g·¿m‘”s
->
em±y
()) {

41  
Stus
(

42 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

48 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

49 autØ
	g»¥Ú£_ex‹Á_®loÿtÜ
 = [
·¿m‘”s
](
size_t
 
size
) {

50  
·¿m‘”s
->
PushAÎoc
(
size
);

53 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
sy¡em_ÿÎ
::
UÁru¡edInvoke
(

54 *
»que¡
, &
»¥Ú£
, 
»¥Ú£_ex‹Á_®loÿtÜ
);

56  
	g´im™ives
::
MakeStus
(
¡©us
);

59 
Stus
 
IsA‰yHªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

60 *
cÚ‹xt
,

61 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
) {

62 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿m‘”s
, 1);

64 
	gfd
 = 
·¿m‘”s
->
Pİ
<>();

66 
	g·¿m‘”s
->
	gPushByCİy
<>(
i§‰y
(
fd
));

68  
	gStus
::
OkStus
();

71 
Stus
 
USË•HªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

72 *
cÚ‹xt
,

73 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
) {

74 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿m‘”s
, 1);

76 autØ
	gu£c
 = 
·¿m‘”s
->
Pİ
<
u£cÚds_t
>();

78 
	g·¿m‘”s
->
	gPushByCİy
<>(
u¦“p
(
u£c
));

80  
	gStus
::
OkStus
();

	@platform/host_call/untrusted/host_call_handlers.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs.h
"

21 
	~<uni¡d.h
>

23 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

24 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/uÁru¡ed_švoke.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gho¡_ÿÎ
 {

30 
Stus
 
Sy¡emC®lHªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

31 *
cÚ‹xt
,

32 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
) {

33 ià(
·¿m‘”s
->
em±y
()) {

34  
Stus
(

35 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

39 autØ
	g»que¡
 = 
·¿m‘”s
->
Pİ
();

40 ià(!
	g·¿m‘”s
->
em±y
()) {

41  
Stus
(

42 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

48 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

49 autØ
	g»¥Ú£_ex‹Á_®loÿtÜ
 = [
·¿m‘”s
](
size_t
 
size
) {

50  
·¿m‘”s
->
PushAÎoc
(
size
);

53 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
sy¡em_ÿÎ
::
UÁru¡edInvoke
(

54 *
»que¡
, &
»¥Ú£
, 
»¥Ú£_ex‹Á_®loÿtÜ
);

56  
	g´im™ives
::
MakeStus
(
¡©us
);

59 
Stus
 
IsA‰yHªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

60 *
cÚ‹xt
,

61 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
) {

62 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿m‘”s
, 1);

64 
	gfd
 = 
·¿m‘”s
->
Pİ
<>();

66 
	g·¿m‘”s
->
	gPushByCİy
<>(
i§‰y
(
fd
));

68  
	gStus
::
OkStus
();

71 
Stus
 
USË•HªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

72 *
cÚ‹xt
,

73 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
) {

74 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿m‘”s
, 1);

76 autØ
	gu£c
 = 
·¿m‘”s
->
Pİ
<
u£cÚds_t
>();

78 
	g·¿m‘”s
->
	gPushByCİy
<>(
u¦“p
(
u£c
));

80  
	gStus
::
OkStus
();

	@platform/host_call/untrusted/host_call_handlers.h

19 #iâdeà
ASYLO_PLATFORM_HOST_CALL_UNTRUSTED_HOST_CALL_HANDLERS_H_


20 
	#ASYLO_PLATFORM_HOST_CALL_UNTRUSTED_HOST_CALL_HANDLERS_H_


	)

22 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gho¡_ÿÎ
 {

34 
Stus
 
Sy¡emC®lHªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

35 *
cÚ‹xt
,

36 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
);

42 
Stus
 
IsA‰yHªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

43 *
cÚ‹xt
,

44 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
);

50 
Stus
 
USË•HªdËr
(cÚ¡ 
¡d
::
sh¬ed_±r
<
´im™ives
::
Cl›Á
> &
ş›Á
,

51 *
cÚ‹xt
,

52 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿m‘”s
);

	@platform/host_call/untrusted/host_call_handlers_initializer.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs_š™Ÿliz”.h
"

20 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

21 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs.h
"

22 
	~"asylo/ut/¡©us_maüos.h
"

23 
	~"asylo/ut/¡©usÜ.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gho¡_ÿÎ
 {

28 
	gStusOr
<
	g¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
>>

29 
G‘Ho¡C®lHªdËrsM­pšg
() {

30 
¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
> 
di¥©ch_bË
 =

31 
ab¦
::
make_unique
<
´im™ives
::
Di¥©chTabË
>();

33 
ASYLO_RETURN_IF_ERROR
(
di¥©ch_bË
->
Regi¡”Ex™HªdËr
(

34 
kSy¡emC®lHªdËr
, 
´im™ives
::
Ex™HªdËr
{
Sy¡emC®lHªdËr
}));

36 
ASYLO_RETURN_IF_ERROR
(
di¥©ch_bË
->
Regi¡”Ex™HªdËr
(

37 
kIsA‰yHªdËr
, 
´im™ives
::
Ex™HªdËr
{
IsA‰yHªdËr
}));

39 
ASYLO_RETURN_IF_ERROR
(
di¥©ch_bË
->
Regi¡”Ex™HªdËr
(

40 
kUSË•HªdËr
, 
´im™ives
::
Ex™HªdËr
{
USË•HªdËr
}));

42  
	g¡d
::
move
(
di¥©ch_bË
);

	@platform/host_call/untrusted/host_call_handlers_initializer.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs_š™Ÿliz”.h
"

20 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

21 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs.h
"

22 
	~"asylo/ut/¡©us_maüos.h
"

23 
	~"asylo/ut/¡©usÜ.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gho¡_ÿÎ
 {

28 
	gStusOr
<
	g¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
>>

29 
G‘Ho¡C®lHªdËrsM­pšg
() {

30 
¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
> 
di¥©ch_bË
 =

31 
ab¦
::
make_unique
<
´im™ives
::
Di¥©chTabË
>();

33 
ASYLO_RETURN_IF_ERROR
(
di¥©ch_bË
->
Regi¡”Ex™HªdËr
(

34 
kSy¡emC®lHªdËr
, 
´im™ives
::
Ex™HªdËr
{
Sy¡emC®lHªdËr
}));

36 
ASYLO_RETURN_IF_ERROR
(
di¥©ch_bË
->
Regi¡”Ex™HªdËr
(

37 
kIsA‰yHªdËr
, 
´im™ives
::
Ex™HªdËr
{
IsA‰yHªdËr
}));

39 
ASYLO_RETURN_IF_ERROR
(
di¥©ch_bË
->
Regi¡”Ex™HªdËr
(

40 
kUSË•HªdËr
, 
´im™ives
::
Ex™HªdËr
{
USË•HªdËr
}));

42  
	g¡d
::
move
(
di¥©ch_bË
);

	@platform/host_call/untrusted/host_call_handlers_initializer.h

19 #iâdeà
ASYLO_PLATFORM_HOST_CALL_UNTRUSTED_HOST_CALL_HANDLERS_INITIALIZER_H_


20 
	#ASYLO_PLATFORM_HOST_CALL_UNTRUSTED_HOST_CALL_HANDLERS_INITIALIZER_H_


	)

22 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gho¡_ÿÎ
 {

31 
	gStusOr
<
	g¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
>>

32 
G‘Ho¡C®lHªdËrsM­pšg
();

	@platform/host_call/untrusted/host_call_handlers_initializer_test.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs_š™Ÿliz”.h
"

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

23 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gho¡_ÿÎ
 {

29 şas 
	cMockedEnşaveCl›Á
 : 
public
 
´im™ives
::
Cl›Á
 {

30 
public
:

31 
MockedEnşaveCl›Á
(

32 cÚ¡ 
ab¦
::
¡ršg_v›w
 
Çme
,

33 
¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
> 
di¥©ch_bË
)

34 : 
´im™ives
::
Cl›Á
(
Çme
, 
¡d
::
move
(
di¥©ch_bË
)) {}

37 
boŞ
 
IsClo£d
(ècÚ¡ 
ov”ride
 {

38 
LOG
(
FATAL
);

39  
	gçl£
;

42 
Stus
 
De¡roy
(è
	gov”ride
 {

43 
LOG
(
FATAL
);

44  
	gStus
::
OkStus
();

47 
Stus
 
EnşaveC®lIÁ”Çl
(

48 
ušt64_t
 
£ËùÜ
, 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿ms
è
ov”ride
 {

49 
LOG
(
FATAL
);

50  
	gStus
::
OkStus
();

57 
TEST
(
Ho¡C®lHªdËrsIn™Ÿliz”Te¡
, 
Regi¡”Ho¡C®lHªdËrsTe¡
) {

58 
	gStusOr
<
	g¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
>>

59 
di¥©ch_bË
 = 
G‘Ho¡C®lHªdËrsM­pšg
();

61 
ASSERT_THAT
(
di¥©ch_bË
.
¡©us
(), 
IsOk
());

63 cÚ¡‡utØ
	gş›Á
 = 
¡d
::
make_sh¬ed
<
MockedEnşaveCl›Á
>(

64  "mock_’şave", 
	g¡d
::
move
(
di¥©ch_bË
.
V®ueOrD›
()));

68 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

69 
kSy¡emC®lHªdËr
, 
´im™ives
::
Ex™HªdËr
{
nuÎ±r
}),

70 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

74 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

75 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

76 
kSy¡emC®lHªdËr
, &
·¿ms
, 
ş›Á
.
g‘
()),

77 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
));

81 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

82 
kIsA‰yHªdËr
, 
´im™ives
::
Ex™HªdËr
{
nuÎ±r
}),

83 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

87 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

88 
kIsA‰yHªdËr
, &
·¿ms
, 
ş›Á
.
g‘
()),

89 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

93 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

94 
kUSË•HªdËr
, 
´im™ives
::
Ex™HªdËr
{
nuÎ±r
}),

95 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

99 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

100 
kUSË•HªdËr
, &
·¿ms
, 
ş›Á
.
g‘
()),

101 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

	@platform/host_call/untrusted/host_call_handlers_initializer_test.cc

19 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs_š™Ÿliz”.h
"

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/ho¡_ÿÎ/ex™_hªdËr_cÚ¡ªts.h
"

23 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gho¡_ÿÎ
 {

29 şas 
	cMockedEnşaveCl›Á
 : 
public
 
´im™ives
::
Cl›Á
 {

30 
public
:

31 
MockedEnşaveCl›Á
(

32 cÚ¡ 
ab¦
::
¡ršg_v›w
 
Çme
,

33 
¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
> 
di¥©ch_bË
)

34 : 
´im™ives
::
Cl›Á
(
Çme
, 
¡d
::
move
(
di¥©ch_bË
)) {}

37 
boŞ
 
IsClo£d
(ècÚ¡ 
ov”ride
 {

38 
LOG
(
FATAL
);

39  
	gçl£
;

42 
Stus
 
De¡roy
(è
	gov”ride
 {

43 
LOG
(
FATAL
);

44  
	gStus
::
OkStus
();

47 
Stus
 
EnşaveC®lIÁ”Çl
(

48 
ušt64_t
 
£ËùÜ
, 
´im™ives
::
N©iveP¬am‘”Sck
 *
·¿ms
è
ov”ride
 {

49 
LOG
(
FATAL
);

50  
	gStus
::
OkStus
();

57 
TEST
(
Ho¡C®lHªdËrsIn™Ÿliz”Te¡
, 
Regi¡”Ho¡C®lHªdËrsTe¡
) {

58 
	gStusOr
<
	g¡d
::
unique_±r
<
´im™ives
::
Cl›Á
::
Ex™C®lProvid”
>>

59 
di¥©ch_bË
 = 
G‘Ho¡C®lHªdËrsM­pšg
();

61 
ASSERT_THAT
(
di¥©ch_bË
.
¡©us
(), 
IsOk
());

63 cÚ¡‡utØ
	gş›Á
 = 
¡d
::
make_sh¬ed
<
MockedEnşaveCl›Á
>(

64  "mock_’şave", 
	g¡d
::
move
(
di¥©ch_bË
.
V®ueOrD›
()));

68 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

69 
kSy¡emC®lHªdËr
, 
´im™ives
::
Ex™HªdËr
{
nuÎ±r
}),

70 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

74 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

75 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

76 
kSy¡emC®lHªdËr
, &
·¿ms
, 
ş›Á
.
g‘
()),

77 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
));

81 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

82 
kIsA‰yHªdËr
, 
´im™ives
::
Ex™HªdËr
{
nuÎ±r
}),

83 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

87 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

88 
kIsA‰yHªdËr
, &
·¿ms
, 
ş›Á
.
g‘
()),

89 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

93 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

94 
kUSË•HªdËr
, 
´im™ives
::
Ex™HªdËr
{
nuÎ±r
}),

95 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

99 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

100 
kUSË•HªdËr
, &
·¿ms
, 
ş›Á
.
g‘
()),

101 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

	@platform/host_call/untrusted/host_call_handlers_test.cc

19 
	~<sys/sysÿÎ.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs.h
"

24 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

28 
	gusšg
 ::
‹¡šg
::
Eq
;

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gho¡_ÿÎ
 {

32 
	gÇme¥aû
 {

34 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrEm±yP¬am‘”SckTe¡
) {

35 
	g´im™ives
::
N©iveP¬am‘”Sck
 
em±y_·¿ms
;

37 
EXPECT_THAT
(
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
em±y_·¿ms
),

38 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

43 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrMÜeThªOÃReque¡OnSckTe¡
) {

44 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

45 
	g·¿ms
.
PushByCİy
(1);

46 
	g·¿ms
.
PushByCİy
(1);

48 
EXPECT_THAT
(

49 
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

50 
StusIs
(

51 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

61 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrV®idReque¡OnP¬am‘”SckTe¡
) {

62 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gsy¡em_ÿÎ
::
kP¬am‘”Max
> 
»que¡_·¿ms
;

63 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

64 
	g´im™ives
::
Ex‹Á
 
»que¡
;

66 autØ
	g»que¡_ex‹Á_®loÿtÜ
 = [&
·¿ms
](
size_t
 
size
) {

67  
·¿ms
.
PushAÎoc
(
size
);

70 
Stus
 
	g¡©us
 = 
´im™ives
::
MakeStus
(
sy¡em_ÿÎ
::
S”ŸlizeReque¡
(

71 
SYS_g‘pid
, 
»que¡_·¿ms
, &
»que¡
, 
»que¡_ex‹Á_®loÿtÜ
));

73 
ASYLO_ASSERT_OK
(
¡©us
);

74 
EXPECT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

76 
ASSERT_THAT
(
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

77 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

78 
EXPECT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

86 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrInv®idReque¡OnP¬am‘”SckTe¡
) {

87 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

88 
	g»que¡_¡r
[] = "illegal_request";

89 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
»que¡_¡r
, 
¡¾’
(request_str)});

90 autØ
	g¡©us
 = 
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
);

92 
ASSERT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

94 
EXPECT_TRUE
(
·¿ms
.
em±y
());

100 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
IsA‰yIncÜ»ùP¬am‘”SckSizeTe¡
) {

101 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

103 
EXPECT_THAT
(
IsA‰yHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

104 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

106 
	g·¿ms
.
PushByCİy
(1);

107 
	g·¿ms
.
PushByCİy
(2);

109 
EXPECT_THAT
(
IsA‰yHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

110 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

116 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
IsA‰yV®idReque¡Te¡
) {

117 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

119 
	g·¿ms
.
PushByCİy
(0);

120 
EXPECT_THAT
(
IsA‰yHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

121 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

123 
	g»suÉ
 = 
·¿ms
.
Pİ
<>();

124 
EXPECT_EQ
(
»suÉ
, 0);

130 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
USË•IncÜ»ùP¬am‘”SckSizeTe¡
) {

131 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

133 
EXPECT_THAT
(
USË•HªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

134 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

136 
	g·¿ms
.
PushByCİy
(1);

137 
	g·¿ms
.
PushByCİy
(2);

139 
EXPECT_THAT
(
USË•HªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

140 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

146 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
USË•V®idReque¡Te¡
) {

147 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

149 
	g·¿ms
.
PushByCİy
(0);

150 
EXPECT_THAT
(
USË•HªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

153 
	g»suÉ
 = 
·¿ms
.
Pİ
<>();

154 
EXPECT_EQ
(
»suÉ
, 0);

	@platform/host_call/untrusted/host_call_handlers_test.cc

19 
	~<sys/sysÿÎ.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/ho¡_ÿÎ/uÁru¡ed/ho¡_ÿÎ_hªdËrs.h
"

24 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

28 
	gusšg
 ::
‹¡šg
::
Eq
;

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gho¡_ÿÎ
 {

32 
	gÇme¥aû
 {

34 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrEm±yP¬am‘”SckTe¡
) {

35 
	g´im™ives
::
N©iveP¬am‘”Sck
 
em±y_·¿ms
;

37 
EXPECT_THAT
(
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
em±y_·¿ms
),

38 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

43 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrMÜeThªOÃReque¡OnSckTe¡
) {

44 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

45 
	g·¿ms
.
PushByCİy
(1);

46 
	g·¿ms
.
PushByCİy
(1);

48 
EXPECT_THAT
(

49 
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

50 
StusIs
(

51 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

61 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrV®idReque¡OnP¬am‘”SckTe¡
) {

62 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gsy¡em_ÿÎ
::
kP¬am‘”Max
> 
»que¡_·¿ms
;

63 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

64 
	g´im™ives
::
Ex‹Á
 
»que¡
;

66 autØ
	g»que¡_ex‹Á_®loÿtÜ
 = [&
·¿ms
](
size_t
 
size
) {

67  
·¿ms
.
PushAÎoc
(
size
);

70 
Stus
 
	g¡©us
 = 
´im™ives
::
MakeStus
(
sy¡em_ÿÎ
::
S”ŸlizeReque¡
(

71 
SYS_g‘pid
, 
»que¡_·¿ms
, &
»que¡
, 
»que¡_ex‹Á_®loÿtÜ
));

73 
ASYLO_ASSERT_OK
(
¡©us
);

74 
EXPECT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

76 
ASSERT_THAT
(
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

77 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

78 
EXPECT_THAT
(
·¿ms
.
size
(), 
Eq
(1));

86 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
SysÿÎHªdËrInv®idReque¡OnP¬am‘”SckTe¡
) {

87 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

88 
	g»que¡_¡r
[] = "illegal_request";

89 
	g·¿ms
.
PushByCİy
(
´im™ives
::
Ex‹Á
{
»que¡_¡r
, 
¡¾’
(request_str)});

90 autØ
	g¡©us
 = 
Sy¡emC®lHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
);

92 
ASSERT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

94 
EXPECT_TRUE
(
·¿ms
.
em±y
());

100 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
IsA‰yIncÜ»ùP¬am‘”SckSizeTe¡
) {

101 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

103 
EXPECT_THAT
(
IsA‰yHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

104 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

106 
	g·¿ms
.
PushByCİy
(1);

107 
	g·¿ms
.
PushByCİy
(2);

109 
EXPECT_THAT
(
IsA‰yHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

110 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

116 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
IsA‰yV®idReque¡Te¡
) {

117 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

119 
	g·¿ms
.
PushByCİy
(0);

120 
EXPECT_THAT
(
IsA‰yHªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

121 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

123 
	g»suÉ
 = 
·¿ms
.
Pİ
<>();

124 
EXPECT_EQ
(
»suÉ
, 0);

130 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
USË•IncÜ»ùP¬am‘”SckSizeTe¡
) {

131 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

133 
EXPECT_THAT
(
USË•HªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

134 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

136 
	g·¿ms
.
PushByCİy
(1);

137 
	g·¿ms
.
PushByCİy
(2);

139 
EXPECT_THAT
(
USË•HªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

140 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

146 
TEST
(
Ho¡C®lHªdËrsTe¡
, 
USË•V®idReque¡Te¡
) {

147 
	g´im™ives
::
N©iveP¬am‘”Sck
 
·¿ms
;

149 
	g·¿ms
.
PushByCİy
(0);

150 
EXPECT_THAT
(
USË•HªdËr
(
nuÎ±r
,‚uÎ±r, &
·¿ms
),

151 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

153 
	g»suÉ
 = 
·¿ms
.
Pİ
<>();

154 
EXPECT_EQ
(
»suÉ
, 0);

	@platform/posix/bswap_test.cc

19 
	~<by‹sw­.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
	gusšg
 ::
‹¡šg
::
Eq
;

29 
TEST
(
By‹Sw­Te¡
, 
Sw­s
) {

33 autØ
	gsw­1
 = 
bsw­_16
(0x1234);

34 
EXPECT_THAT
(
sw­1
, 
Eq
(0x3412));

35 autØ
	gsw­2
 = 
bsw­_32
(0x12345678);

36 
EXPECT_THAT
(
sw­2
, 
Eq
(0x78563412));

37 autØ
	gsw­3
 = 
bsw­_64
(0x1234567890abcdef);

38 
EXPECT_THAT
(
sw­3
, 
Eq
(0xefcdab9078563412));

	@platform/posix/bswap_test.cc

19 
	~<by‹sw­.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
	gusšg
 ::
‹¡šg
::
Eq
;

29 
TEST
(
By‹Sw­Te¡
, 
Sw­s
) {

33 autØ
	gsw­1
 = 
bsw­_16
(0x1234);

34 
EXPECT_THAT
(
sw­1
, 
Eq
(0x3412));

35 autØ
	gsw­2
 = 
bsw­_32
(0x12345678);

36 
EXPECT_THAT
(
sw­2
, 
Eq
(0x78563412));

37 autØ
	gsw­3
 = 
bsw­_64
(0x1234567890abcdef);

38 
EXPECT_THAT
(
sw­3
, 
Eq
(0xefcdab9078563412));

	@platform/posix/dirent.cc

19 
	~<dœ’t.h
>

21 
	~<c¡dšt
>

22 
	~<c¡dlib
>

24 
	$şo£dœ
(
DIR
 *è{ 
	`abÜt
(); 
	}
}

26 
DIR
 *
	$İ’dœ
(cÚ¡ *è{ 
	`abÜt
(); 
	}
}

28 
dœ’t
 *
	$»addœ
(
DIR
 *) {

29 
	`abÜt
();

30 
	}
}

32 
	$»addœ_r
(
DIR
 *, 
dœ’t
 *, dœ’ˆ**è{ 
	`abÜt
(); 
	}
}

34 
	$»wšddœ
(
DIR
 *è{ 
	`abÜt
(); 
	}
}

36 
	$£ekdœ
(
DIR
 *, 
št64_t
è{ 
	`abÜt
(); 
	}
}

38 
št64_t
 
	$‹Îdœ
(
DIR
 *è{ 
	`abÜt
(); 
	}
}

	@platform/posix/dirent.cc

19 
	~<dœ’t.h
>

21 
	~<c¡dšt
>

22 
	~<c¡dlib
>

24 
	$şo£dœ
(
DIR
 *è{ 
	`abÜt
(); 
	}
}

26 
DIR
 *
	$İ’dœ
(cÚ¡ *è{ 
	`abÜt
(); 
	}
}

28 
dœ’t
 *
	$»addœ
(
DIR
 *) {

29 
	`abÜt
();

30 
	}
}

32 
	$»addœ_r
(
DIR
 *, 
dœ’t
 *, dœ’ˆ**è{ 
	`abÜt
(); 
	}
}

34 
	$»wšddœ
(
DIR
 *è{ 
	`abÜt
(); 
	}
}

36 
	$£ekdœ
(
DIR
 *, 
št64_t
è{ 
	`abÜt
(); 
	}
}

38 
št64_t
 
	$‹Îdœ
(
DIR
 *è{ 
	`abÜt
(); 
	}
}

	@platform/posix/dlfcn.cc

19 
	~<dlfú.h
>

20 
	~<¡dlib.h
>

26 *
dlİ’
(cÚ¡ *
f’ame
, 
æags
è{ 
abÜt
(); }

27 *
dlsym
(*
hªdË
, cÚ¡ *
symbŞ
è{ 
abÜt
(); }

28 
dlşo£
(*
hªdË
è{ 
abÜt
(); }

29 *
dË¼Ü
(è{ 
abÜt
(); }

	@platform/posix/dlfcn.cc

19 
	~<dlfú.h
>

20 
	~<¡dlib.h
>

26 *
dlİ’
(cÚ¡ *
f’ame
, 
æags
è{ 
abÜt
(); }

27 *
dlsym
(*
hªdË
, cÚ¡ *
symbŞ
è{ 
abÜt
(); }

28 
dlşo£
(*
hªdË
è{ 
abÜt
(); }

29 *
dË¼Ü
(è{ 
abÜt
(); }

	@platform/posix/endian.cc

19 
	~<by‹sw­.h
>

20 
	~<’dŸn.h
>

22 
	~<c¡dšt
>

24 #ià
_BYTE_ORDER
 =ğ
_LITTLE_ENDIAN


26 
ušt16_t
 
	$htobe16
(
ušt16_t
 
ho¡_16b™s
è{  
	`bsw­_16
(ho¡_16b™s); 
	}
}

27 
ušt16_t
 
	$htŞe16
(
ušt16_t
 
ho¡_16b™s
è{  ho¡_16b™s; 
	}
}

28 
ušt16_t
 
	$be16toh
(
ušt16_t
 
big_’dŸn_16b™s
) {

29  
	`bsw­_16
(
big_’dŸn_16b™s
);

30 
	}
}

31 
ušt16_t
 
	$Ë16toh
(
ušt16_t
 
l™e_’dŸn_16b™s
è{ †™e_’dŸn_16b™s; 
	}
}

33 
ušt32_t
 
	$htobe32
(
ušt32_t
 
ho¡_32b™s
è{  
	`bsw­_32
(ho¡_32b™s); 
	}
}

34 
ušt32_t
 
	$htŞe32
(
ušt32_t
 
ho¡_32b™s
è{  ho¡_32b™s; 
	}
}

35 
ušt32_t
 
	$be32toh
(
ušt32_t
 
big_’dŸn_32b™s
) {

36  
	`bsw­_32
(
big_’dŸn_32b™s
);

37 
	}
}

38 
ušt32_t
 
	$Ë32toh
(
ušt32_t
 
l™e_’dŸn_32b™s
è{ †™e_’dŸn_32b™s; 
	}
}

40 
ušt64_t
 
	$htobe64
(
ušt64_t
 
ho¡_64b™s
è{  
	`bsw­_64
(ho¡_64b™s); 
	}
}

41 
ušt64_t
 
	$htŞe64
(
ušt64_t
 
ho¡_64b™s
è{  ho¡_64b™s; 
	}
}

42 
ušt64_t
 
	$be64toh
(
ušt64_t
 
big_’dŸn_64b™s
) {

43  
	`bsw­_64
(
big_’dŸn_64b™s
);

44 
	}
}

45 
ušt64_t
 
	$Ë64toh
(
ušt64_t
 
l™e_’dŸn_64b™s
è{ †™e_’dŸn_64b™s; 
	}
}

49 
ušt16_t
 
	$htobe16
(
ušt16_t
 
ho¡_16b™s
è{  ho¡_16b™s; 
	}
}

50 
ušt16_t
 
	$htŞe16
(
ušt16_t
 
ho¡_16b™s
è{  
	`bsw­_16
(ho¡_16b™s); 
	}
}

51 
ušt16_t
 
	$be16toh
(
ušt16_t
 
big_’dŸn_16b™s
è{  big_’dŸn_16b™s; 
	}
}

52 
ušt16_t
 
	$Ë16toh
(
ušt16_t
 
l™e_’dŸn_16b™s
) {

53  
	`bsw­_16
(
l™e_’dŸn_16b™s
);

54 
	}
}

56 
ušt32_t
 
	$htobe32
(
ušt32_t
 
ho¡_32b™s
è{  ho¡_32b™s; 
	}
}

57 
ušt32_t
 
	$htŞe32
(
ušt32_t
 
ho¡_32b™s
è{  
	`bsw­_32
(ho¡_32b™s); 
	}
}

58 
ušt32_t
 
	$be32toh
(
ušt32_t
 
big_’dŸn_32b™s
è{  big_’dŸn_32b™s; 
	}
}

59 
ušt32_t
 
	$Ë32toh
(
ušt32_t
 
l™e_’dŸn_32b™s
) {

60  
	`bsw­_32
(
l™e_’dŸn_32b™s
);

61 
	}
}

63 
ušt64_t
 
	$htobe64
(
ušt64_t
 
ho¡_64b™s
è{  ho¡_64b™s; 
	}
}

64 
ušt64_t
 
	$htŞe64
(
ušt64_t
 
ho¡_64b™s
è{  
	`bsw­_64
(ho¡_64b™s); 
	}
}

65 
ušt64_t
 
	$be64toh
(
ušt64_t
 
big_’dŸn_64b™s
è{  big_’dŸn_64b™s; 
	}
}

66 
ušt64_t
 
	$Ë64toh
(
ušt64_t
 
l™e_’dŸn_64b™s
) {

67  
	`bsw­_64
(
l™e_’dŸn_64b™s
);

68 
	}
}

	@platform/posix/endian.cc

19 
	~<by‹sw­.h
>

20 
	~<’dŸn.h
>

22 
	~<c¡dšt
>

24 #ià
_BYTE_ORDER
 =ğ
_LITTLE_ENDIAN


26 
ušt16_t
 
	$htobe16
(
ušt16_t
 
ho¡_16b™s
è{  
	`bsw­_16
(ho¡_16b™s); 
	}
}

27 
ušt16_t
 
	$htŞe16
(
ušt16_t
 
ho¡_16b™s
è{  ho¡_16b™s; 
	}
}

28 
ušt16_t
 
	$be16toh
(
ušt16_t
 
big_’dŸn_16b™s
) {

29  
	`bsw­_16
(
big_’dŸn_16b™s
);

30 
	}
}

31 
ušt16_t
 
	$Ë16toh
(
ušt16_t
 
l™e_’dŸn_16b™s
è{ †™e_’dŸn_16b™s; 
	}
}

33 
ušt32_t
 
	$htobe32
(
ušt32_t
 
ho¡_32b™s
è{  
	`bsw­_32
(ho¡_32b™s); 
	}
}

34 
ušt32_t
 
	$htŞe32
(
ušt32_t
 
ho¡_32b™s
è{  ho¡_32b™s; 
	}
}

35 
ušt32_t
 
	$be32toh
(
ušt32_t
 
big_’dŸn_32b™s
) {

36  
	`bsw­_32
(
big_’dŸn_32b™s
);

37 
	}
}

38 
ušt32_t
 
	$Ë32toh
(
ušt32_t
 
l™e_’dŸn_32b™s
è{ †™e_’dŸn_32b™s; 
	}
}

40 
ušt64_t
 
	$htobe64
(
ušt64_t
 
ho¡_64b™s
è{  
	`bsw­_64
(ho¡_64b™s); 
	}
}

41 
ušt64_t
 
	$htŞe64
(
ušt64_t
 
ho¡_64b™s
è{  ho¡_64b™s; 
	}
}

42 
ušt64_t
 
	$be64toh
(
ušt64_t
 
big_’dŸn_64b™s
) {

43  
	`bsw­_64
(
big_’dŸn_64b™s
);

44 
	}
}

45 
ušt64_t
 
	$Ë64toh
(
ušt64_t
 
l™e_’dŸn_64b™s
è{ †™e_’dŸn_64b™s; 
	}
}

49 
ušt16_t
 
	$htobe16
(
ušt16_t
 
ho¡_16b™s
è{  ho¡_16b™s; 
	}
}

50 
ušt16_t
 
	$htŞe16
(
ušt16_t
 
ho¡_16b™s
è{  
	`bsw­_16
(ho¡_16b™s); 
	}
}

51 
ušt16_t
 
	$be16toh
(
ušt16_t
 
big_’dŸn_16b™s
è{  big_’dŸn_16b™s; 
	}
}

52 
ušt16_t
 
	$Ë16toh
(
ušt16_t
 
l™e_’dŸn_16b™s
) {

53  
	`bsw­_16
(
l™e_’dŸn_16b™s
);

54 
	}
}

56 
ušt32_t
 
	$htobe32
(
ušt32_t
 
ho¡_32b™s
è{  ho¡_32b™s; 
	}
}

57 
ušt32_t
 
	$htŞe32
(
ušt32_t
 
ho¡_32b™s
è{  
	`bsw­_32
(ho¡_32b™s); 
	}
}

58 
ušt32_t
 
	$be32toh
(
ušt32_t
 
big_’dŸn_32b™s
è{  big_’dŸn_32b™s; 
	}
}

59 
ušt32_t
 
	$Ë32toh
(
ušt32_t
 
l™e_’dŸn_32b™s
) {

60  
	`bsw­_32
(
l™e_’dŸn_32b™s
);

61 
	}
}

63 
ušt64_t
 
	$htobe64
(
ušt64_t
 
ho¡_64b™s
è{  ho¡_64b™s; 
	}
}

64 
ušt64_t
 
	$htŞe64
(
ušt64_t
 
ho¡_64b™s
è{  
	`bsw­_64
(ho¡_64b™s); 
	}
}

65 
ušt64_t
 
	$be64toh
(
ušt64_t
 
big_’dŸn_64b™s
è{  big_’dŸn_64b™s; 
	}
}

66 
ušt64_t
 
	$Ë64toh
(
ušt64_t
 
l™e_’dŸn_64b™s
) {

67  
	`bsw­_64
(
l™e_’dŸn_64b™s
);

68 
	}
}

	@platform/posix/endian_test.cc

19 
	~<by‹sw­.h
>

20 
	~<’dŸn.h
>

22 
	~<c¡dšt
>

23 
	~<lim™s
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/ty³s/¥ª.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

33 
	gusšg
 ::
‹¡šg
::
Te¡
;

34 
	gusšg
 ::
‹¡šg
::
Ty³s
;

41 
ušt16_t
 
By‹sw­
(ušt16_ˆ
v®ue
è{  
bsw­_16
(value); }

42 
ušt32_t
 
By‹sw­
(ušt32_ˆ
v®ue
è{  
bsw­_32
(value); }

43 
ušt64_t
 
By‹sw­
(ušt64_ˆ
v®ue
è{  
bsw­_64
(value); }

45 
ušt16_t
 
Ho¡ToLe
(ušt16_ˆ
v®ue
è{  
htŞe16
(value); }

46 
ušt32_t
 
Ho¡ToLe
(ušt32_ˆ
v®ue
è{  
htŞe32
(value); }

47 
ušt64_t
 
Ho¡ToLe
(ušt64_ˆ
v®ue
è{  
htŞe64
(value); }

49 
ušt16_t
 
Ho¡ToBe
(ušt16_ˆ
v®ue
è{  
htobe16
(value); }

50 
ušt32_t
 
Ho¡ToBe
(ušt32_ˆ
v®ue
è{  
htobe32
(value); }

51 
ušt64_t
 
Ho¡ToBe
(ušt64_ˆ
v®ue
è{  
htobe64
(value); }

53 
ušt16_t
 
LeToHo¡
(ušt16_ˆ
v®ue
è{  
Ë16toh
(value); }

54 
ušt32_t
 
LeToHo¡
(ušt32_ˆ
v®ue
è{  
Ë32toh
(value); }

55 
ušt64_t
 
LeToHo¡
(ušt64_ˆ
v®ue
è{  
Ë64toh
(value); }

57 
ušt16_t
 
BeToHo¡
(ušt16_ˆ
v®ue
è{  
be16toh
(value); }

58 
ušt32_t
 
BeToHo¡
(ušt32_ˆ
v®ue
è{  
be32toh
(value); }

59 
ušt64_t
 
BeToHo¡
(ušt64_ˆ
v®ue
è{  
be64toh
(value); }

62 
	g‹m¶©e
 <
ty³Çme
 
	gUIÁT
>

63 
	gTe¡D©a
;

65 
	g‹m¶©e
 <>

66 
	gTe¡D©a
<
	gušt16_t
> {

67 
cÚ¡ex´
 
ušt16_t
 
	gkTe¡V®ues
[] = {0, 1, 0x0123};

70 
	g‹m¶©e
 <>

71 
	gTe¡D©a
<
	gušt32_t
> {

72 
cÚ¡ex´
 
ušt32_t
 
	gkTe¡V®ues
[] = {0, 1, 0x0123, 0x01234567};

75 
	g‹m¶©e
 <>

76 
	gTe¡D©a
<
	gušt64_t
> {

77 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡V®ues
[] = {0, 1, 0x0123, 0x01234567,

82 
cÚ¡ex´
 
ušt16_t
 
	gTe¡D©a
<
	gušt16_t
>::
kTe¡V®ues
[];

83 
cÚ¡ex´
 
ušt32_t
 
	gTe¡D©a
<
	gušt32_t
>::
kTe¡V®ues
[];

84 
cÚ¡ex´
 
ušt64_t
 
	gTe¡D©a
<
	gušt64_t
>::
kTe¡V®ues
[];

90 
	g‹m¶©e
 <
ty³Çme
 
	gUIÁT
>

91 şas 
	cEndŸnTe¡
 : 
public
 
Te¡
 {

92 
´Ùeùed
:

94 
UIÁT
 
Ho¡ToSame
(UIÁT 
v®ue
) {

95  
IsL™eEndŸn
(è? 
Ho¡ToLe
(
v®ue
è: 
Ho¡ToBe
(value);

99 
UIÁT
 
Ho¡ToDiff
(UIÁT 
v®ue
) {

100  
IsL™eEndŸn
(è? 
Ho¡ToBe
(
v®ue
è: 
Ho¡ToLe
(value);

104 
UIÁT
 
SameToHo¡
(UIÁT 
v®ue
) {

105  
IsL™eEndŸn
(è? 
LeToHo¡
(
v®ue
è: 
BeToHo¡
(value);

109 
UIÁT
 
DiffToHo¡
(UIÁT 
v®ue
) {

110  
IsL™eEndŸn
(è? 
BeToHo¡
(
v®ue
è: 
LeToHo¡
(value);

113 
	g´iv©e
:

115 
boŞ
 
IsL™eEndŸn
(è{  
Ë16toh
(1) == 1; }

118 
usšg
 
	gEndŸnTy³s
 = 
Ty³s
<
ušt16_t
, 
	gušt32_t
, 
	gušt64_t
>;

119 
TYPED_TEST_SUITE
(
EndŸnTe¡
, 
EndŸnTy³s
);

121 
TYPED_TEST
(
EndŸnTe¡
, 
Ho¡ToSameP»£rvesV®ues
) {

122 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

123 
EXPECT_THAT
(
this
->
Ho¡ToSame
(
v®ue
), 
Eq
(value));

127 
TYPED_TEST
(
EndŸnTe¡
, 
Ho¡ToDiffBy‹sw­sV®ues
) {

128 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

129 
EXPECT_THAT
(
this
->
Ho¡ToDiff
(
v®ue
), 
Eq
(
By‹sw­
(value)));

133 
TYPED_TEST
(
EndŸnTe¡
, 
SameToHo¡P»£rvesV®ues
) {

134 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

135 
EXPECT_THAT
(
this
->
SameToHo¡
(
v®ue
), 
Eq
(value));

139 
TYPED_TEST
(
EndŸnTe¡
, 
DiffToHo¡By‹sw­sV®ues
) {

140 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

141 
EXPECT_THAT
(
this
->
DiffToHo¡
(
v®ue
), 
Eq
(
By‹sw­
(value)));

	@platform/posix/endian_test.cc

19 
	~<by‹sw­.h
>

20 
	~<’dŸn.h
>

22 
	~<c¡dšt
>

23 
	~<lim™s
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/ty³s/¥ª.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

33 
	gusšg
 ::
‹¡šg
::
Te¡
;

34 
	gusšg
 ::
‹¡šg
::
Ty³s
;

41 
ušt16_t
 
By‹sw­
(ušt16_ˆ
v®ue
è{  
bsw­_16
(value); }

42 
ušt32_t
 
By‹sw­
(ušt32_ˆ
v®ue
è{  
bsw­_32
(value); }

43 
ušt64_t
 
By‹sw­
(ušt64_ˆ
v®ue
è{  
bsw­_64
(value); }

45 
ušt16_t
 
Ho¡ToLe
(ušt16_ˆ
v®ue
è{  
htŞe16
(value); }

46 
ušt32_t
 
Ho¡ToLe
(ušt32_ˆ
v®ue
è{  
htŞe32
(value); }

47 
ušt64_t
 
Ho¡ToLe
(ušt64_ˆ
v®ue
è{  
htŞe64
(value); }

49 
ušt16_t
 
Ho¡ToBe
(ušt16_ˆ
v®ue
è{  
htobe16
(value); }

50 
ušt32_t
 
Ho¡ToBe
(ušt32_ˆ
v®ue
è{  
htobe32
(value); }

51 
ušt64_t
 
Ho¡ToBe
(ušt64_ˆ
v®ue
è{  
htobe64
(value); }

53 
ušt16_t
 
LeToHo¡
(ušt16_ˆ
v®ue
è{  
Ë16toh
(value); }

54 
ušt32_t
 
LeToHo¡
(ušt32_ˆ
v®ue
è{  
Ë32toh
(value); }

55 
ušt64_t
 
LeToHo¡
(ušt64_ˆ
v®ue
è{  
Ë64toh
(value); }

57 
ušt16_t
 
BeToHo¡
(ušt16_ˆ
v®ue
è{  
be16toh
(value); }

58 
ušt32_t
 
BeToHo¡
(ušt32_ˆ
v®ue
è{  
be32toh
(value); }

59 
ušt64_t
 
BeToHo¡
(ušt64_ˆ
v®ue
è{  
be64toh
(value); }

62 
	g‹m¶©e
 <
ty³Çme
 
	gUIÁT
>

63 
	gTe¡D©a
;

65 
	g‹m¶©e
 <>

66 
	gTe¡D©a
<
	gušt16_t
> {

67 
cÚ¡ex´
 
ušt16_t
 
	gkTe¡V®ues
[] = {0, 1, 0x0123};

70 
	g‹m¶©e
 <>

71 
	gTe¡D©a
<
	gušt32_t
> {

72 
cÚ¡ex´
 
ušt32_t
 
	gkTe¡V®ues
[] = {0, 1, 0x0123, 0x01234567};

75 
	g‹m¶©e
 <>

76 
	gTe¡D©a
<
	gušt64_t
> {

77 
cÚ¡ex´
 
ušt64_t
 
	gkTe¡V®ues
[] = {0, 1, 0x0123, 0x01234567,

82 
cÚ¡ex´
 
ušt16_t
 
	gTe¡D©a
<
	gušt16_t
>::
kTe¡V®ues
[];

83 
cÚ¡ex´
 
ušt32_t
 
	gTe¡D©a
<
	gušt32_t
>::
kTe¡V®ues
[];

84 
cÚ¡ex´
 
ušt64_t
 
	gTe¡D©a
<
	gušt64_t
>::
kTe¡V®ues
[];

90 
	g‹m¶©e
 <
ty³Çme
 
	gUIÁT
>

91 şas 
	cEndŸnTe¡
 : 
public
 
Te¡
 {

92 
´Ùeùed
:

94 
UIÁT
 
Ho¡ToSame
(UIÁT 
v®ue
) {

95  
IsL™eEndŸn
(è? 
Ho¡ToLe
(
v®ue
è: 
Ho¡ToBe
(value);

99 
UIÁT
 
Ho¡ToDiff
(UIÁT 
v®ue
) {

100  
IsL™eEndŸn
(è? 
Ho¡ToBe
(
v®ue
è: 
Ho¡ToLe
(value);

104 
UIÁT
 
SameToHo¡
(UIÁT 
v®ue
) {

105  
IsL™eEndŸn
(è? 
LeToHo¡
(
v®ue
è: 
BeToHo¡
(value);

109 
UIÁT
 
DiffToHo¡
(UIÁT 
v®ue
) {

110  
IsL™eEndŸn
(è? 
BeToHo¡
(
v®ue
è: 
LeToHo¡
(value);

113 
	g´iv©e
:

115 
boŞ
 
IsL™eEndŸn
(è{  
Ë16toh
(1) == 1; }

118 
usšg
 
	gEndŸnTy³s
 = 
Ty³s
<
ušt16_t
, 
	gušt32_t
, 
	gušt64_t
>;

119 
TYPED_TEST_SUITE
(
EndŸnTe¡
, 
EndŸnTy³s
);

121 
TYPED_TEST
(
EndŸnTe¡
, 
Ho¡ToSameP»£rvesV®ues
) {

122 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

123 
EXPECT_THAT
(
this
->
Ho¡ToSame
(
v®ue
), 
Eq
(value));

127 
TYPED_TEST
(
EndŸnTe¡
, 
Ho¡ToDiffBy‹sw­sV®ues
) {

128 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

129 
EXPECT_THAT
(
this
->
Ho¡ToDiff
(
v®ue
), 
Eq
(
By‹sw­
(value)));

133 
TYPED_TEST
(
EndŸnTe¡
, 
SameToHo¡P»£rvesV®ues
) {

134 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

135 
EXPECT_THAT
(
this
->
SameToHo¡
(
v®ue
), 
Eq
(value));

139 
TYPED_TEST
(
EndŸnTe¡
, 
DiffToHo¡By‹sw­sV®ues
) {

140 autØ
	gv®ue
 : 
ab¦
::
MakeS·n
(
Te¡D©a
<
Ty³P¬am
>::
kTe¡V®ues
)) {

141 
EXPECT_THAT
(
this
->
DiffToHo¡
(
v®ue
), 
Eq
(
By‹sw­
(value)));

	@platform/posix/epoll.cc

19 
	~<sys/•Şl.h
>

20 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
•Şl_ü—‹
(
size
) {

28  
IOMªag”
::
G‘In¡ªû
().
EpŞlC»©e
(
size
);

35 
•Şl_ü—‹1
(è{  
•Şl_ü—‹
(1); }

37 
•Şl_ùl
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
) {

38  
IOMªag”
::
G‘In¡ªû
().
EpŞlC
(
•fd
, 
İ
, 
fd
, 
ev’t
);

41 
•Şl_wa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

42 
timeout
) {

43 ià(
maxev’ts
 <= 0) {

44 
”ºo
 = 
EINVAL
;

47  
IOMªag”
::
G‘In¡ªû
().
EpŞlWa™
(
•fd
, 
ev’ts
, 
maxev’ts
, 
timeout
);

	@platform/posix/epoll.cc

19 
	~<sys/•Şl.h
>

20 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
•Şl_ü—‹
(
size
) {

28  
IOMªag”
::
G‘In¡ªû
().
EpŞlC»©e
(
size
);

35 
•Şl_ü—‹1
(è{  
•Şl_ü—‹
(1); }

37 
•Şl_ùl
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
) {

38  
IOMªag”
::
G‘In¡ªû
().
EpŞlC
(
•fd
, 
İ
, 
fd
, 
ev’t
);

41 
•Şl_wa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

42 
timeout
) {

43 ià(
maxev’ts
 <= 0) {

44 
”ºo
 = 
EINVAL
;

47  
IOMªag”
::
G‘In¡ªû
().
EpŞlWa™
(
•fd
, 
ev’ts
, 
maxev’ts
, 
timeout
);

	@platform/posix/errno.cc

19 
	~<”ºo.h
>

21 
	gÇme¥aû
 {

23 
th»ad_loÿl
 
	gloÿl_”ºo
 = 0;

27 *
	$__”ºo
(è{  &
loÿl_”ºo
; 
	}
}

	@platform/posix/errno.cc

19 
	~<”ºo.h
>

21 
	gÇme¥aû
 {

23 
th»ad_loÿl
 
	gloÿl_”ºo
 = 0;

27 *
	$__”ºo
(è{  &
loÿl_”ºo
; 
	}
}

	@platform/posix/errno_test.cc

19 
	~<fú.h
>

20 
	~<uni¡d.h
>

21 
	~<û¼no
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

26 
	~"asylo/‹¡/ut/‹¡_æags.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
cÚ¡ex´
 
	gacûssibË_dœeùÜy
[] = "/tmp";

32 
cÚ¡ex´
 
	gfe_·th
[] = "/errno_test";

33 
cÚ¡ex´
 
	gbad_fe_·th
[] = "/errno_test/disallowed";

34 
cÚ¡ex´
 
	gem±y_·th
[] = "";

36 
CheckHo¡E¼no
(cÚ¡ *
·th
, 
ex³ùed_”ºo
) {

37 
	gfd
 = 
İ’
(
·th
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

38 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

39 
EXPECT_EQ
(
fd
, -1);

40 
EXPECT_EQ
(
”ºo
, 
ex³ùed_”ºo
);

43 
TEST
(
EnşaveE¼noTe¡
, 
ENOTDIRTe¡
) {

45 
	g¡d
::
¡ršg
 
·th
 = 
FLAGS_‹¡_tmpdœ
 + 
fe_·th
;

46 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

47 
ASSERT_NE
(
fd
, -1);

48 
ASSERT_EQ
(
şo£
(
fd
), 0);

51 
	g·th
 = 
FLAGS_‹¡_tmpdœ
 + 
bad_fe_·th
;

52 
CheckHo¡E¼no
(
·th
.
c_¡r
(), 
ENOTDIR
);

55 
TEST
(
EnşaveE¼noTe¡
, 
ENOENTTe¡
è{ 
CheckHo¡E¼no
(
em±y_·th
, 
ENOENT
); }

57 
TEST
(
EnşaveE¼noTe¡
, 
EISDIRTe¡
) {

58 
CheckHo¡E¼no
(
acûssibË_dœeùÜy
, 
EISDIR
);

	@platform/posix/errno_test.cc

19 
	~<fú.h
>

20 
	~<uni¡d.h
>

21 
	~<û¼no
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

26 
	~"asylo/‹¡/ut/‹¡_æags.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
cÚ¡ex´
 
	gacûssibË_dœeùÜy
[] = "/tmp";

32 
cÚ¡ex´
 
	gfe_·th
[] = "/errno_test";

33 
cÚ¡ex´
 
	gbad_fe_·th
[] = "/errno_test/disallowed";

34 
cÚ¡ex´
 
	gem±y_·th
[] = "";

36 
CheckHo¡E¼no
(cÚ¡ *
·th
, 
ex³ùed_”ºo
) {

37 
	gfd
 = 
İ’
(
·th
, 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

38 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

39 
EXPECT_EQ
(
fd
, -1);

40 
EXPECT_EQ
(
”ºo
, 
ex³ùed_”ºo
);

43 
TEST
(
EnşaveE¼noTe¡
, 
ENOTDIRTe¡
) {

45 
	g¡d
::
¡ršg
 
·th
 = 
FLAGS_‹¡_tmpdœ
 + 
fe_·th
;

46 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
, 0644);

47 
ASSERT_NE
(
fd
, -1);

48 
ASSERT_EQ
(
şo£
(
fd
), 0);

51 
	g·th
 = 
FLAGS_‹¡_tmpdœ
 + 
bad_fe_·th
;

52 
CheckHo¡E¼no
(
·th
.
c_¡r
(), 
ENOTDIR
);

55 
TEST
(
EnşaveE¼noTe¡
, 
ENOENTTe¡
è{ 
CheckHo¡E¼no
(
em±y_·th
, 
ENOENT
); }

57 
TEST
(
EnşaveE¼noTe¡
, 
EISDIRTe¡
) {

58 
CheckHo¡E¼no
(
acûssibË_dœeùÜy
, 
EISDIR
);

	@platform/posix/eventfd.cc

19 
	~<sys/ev’tfd.h
>

20 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
ev’tfd
(
š™v®
, 
æags
) {

28  
IOMªag”
::
G‘In¡ªû
().
Ev’tFd
(
š™v®
, 
æags
);

	@platform/posix/eventfd.cc

19 
	~<sys/ev’tfd.h
>

20 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
ev’tfd
(
š™v®
, 
æags
) {

28  
IOMªag”
::
G‘In¡ªû
().
Ev’tFd
(
š™v®
, 
æags
);

	@platform/posix/file.cc

19 
	~<sys/fe.h
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
æock
(
fd
, 
İ”©iÚ
) {

28  
IOMªag”
::
G‘In¡ªû
().
FLock
(
fd
, 
İ”©iÚ
);

	@platform/posix/file.cc

19 
	~<sys/fe.h
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
æock
(
fd
, 
İ”©iÚ
) {

28  
IOMªag”
::
G‘In¡ªû
().
FLock
(
fd
, 
İ”©iÚ
);

	@platform/posix/fnmatch.cc

19 
	~<âm©ch.h
>

21 
	~<¡dlib.h
>

25 
âm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
æags
è{ 
abÜt
(); }

	@platform/posix/fnmatch.cc

19 
	~<âm©ch.h
>

21 
	~<¡dlib.h
>

25 
âm©ch
(cÚ¡ *
·‰”n
, cÚ¡ *
¡ršg
, 
æags
è{ 
abÜt
(); }

	@platform/posix/fork_security_test_driver.cc

19 
	~<İ’s¦/¿nd.h
>

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/ş›Á.h
"

26 
	~"asylo/’şave.pb.h
"

27 
	~"gæags/gæags.h
"

28 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

29 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

30 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

31 
	~"asylo/¶©fÜm/posix/fÜk_£cur™y_‹¡.pb.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/ut/¡©us.h
"

34 
	~"asylo/ut/¡©us_maüos.h
"

36 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 
	gusšg
 ::
‹¡šg
::
NÙ
;

44 şas 
	cSÇpshÙD–‘”
 {

45 
	gpublic
:

47 şas 
	cSÇpshÙEÁryD–‘”
 {

48 
public
:

49 
SÇpshÙEÁryD–‘”
()

50 : 
ch”‹xt_d–‘”_
(
nuÎ±r
), 
nÚû_d–‘”_
(nullptr) {}

52 
Re£t
(cÚ¡ 
SÇpshÙLayoutEÁry
 &
’Œy
) {

53 
	gch”‹xt_d–‘”_
.
»£t
(

54 
»š‹½»t_ÿ¡
<*>(
’Œy
.
ch”‹xt_ba£
()));

55 
	gnÚû_d–‘”_
.
»£t
(
»š‹½»t_ÿ¡
<*>(
’Œy
.
nÚû_ba£
()));

58 
	g´iv©e
:

59 
M®locUniquePŒ
<> 
ch”‹xt_d–‘”_
;

60 
	gM®locUniquePŒ
<> 
	gnÚû_d–‘”_
;

63 
Re£t
(cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
) {

64 
	gd©a_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
d©a_size
());

65 
	gbss_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
bss_size
());

66 
	gh—p_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
h—p_size
());

67 
	gth»ad_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
th»ad_size
());

68 
	g¡ack_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
¡ack_size
());

69 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
d©a_size
(); ++i) {

70 
	gd©a_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
d©a
(i));

72 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
bss_size
(); ++i) {

73 
	gbss_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
bss
(i));

75 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
h—p_size
(); ++i) {

76 
	gh—p_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
h—p
(i));

78 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
th»ad_size
(); ++i) {

79 
	gth»ad_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
th»ad
(i));

81 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
¡ack_size
(); ++i) {

82 
	g¡ack_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
¡ack
(i));

86 
	g´iv©e
:

87 
¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
d©a_d–‘”_
;

88 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
bss_d–‘”_
;

89 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
h—p_d–‘”_
;

90 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
th»ad_d–‘”_
;

91 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
¡ack_d–‘”_
;

94 şas 
	cFÜkSecur™yTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

95 
public
:

96 
FÜkSecur™yTe¡
(è: 
’şave_fš®ized_
(
çl£
) {}

98 
´Ùeùed
:

99 
S‘UpTe¡Su™e
() {

100 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

101 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

102 ià(!
	gmªag”_»suÉ
.
ok
()) {

103 
LOG
(
FATAL
è<< 
	gmªag”_»suÉ
.
¡©us
();

105 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

108 
T—rDown
(è
	gov”ride
 {

109 
ASSERT_NE
(
mªag”_
, 
nuÎ±r
);

110 
ASSERT_NE
(
ş›Á_
, 
nuÎ±r
);

111 
EnşaveFš®
 
	gefš®
;

114 
EXPECT_THAT
(
mªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
,

115  
’şave_fš®ized_
),

116 
IsOk
());

119 
Stus
 
LßdEnşaveAndTakeSÇpshÙ
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_Çme
,

120 
boŞ
 
»que¡_fÜk
) {

121 
SgxLßd”
 
lßd”
(
FLAGS_’şave_·th
, 
Œue
);

122 
EnşaveCÚfig
 
	gcÚfig
;

124 
	gcÚfig
.
£t_’abË_fÜk
(
Œue
);

125 
ASYLO_RETURN_IF_ERROR
(
mªag”_
->
LßdEnşave
(
’şave_Çme
, 
lßd”
, 
cÚfig
));

127 
	gş›Á_
 = 
»š‹½»t_ÿ¡
<
SgxCl›Á
 *>(
mªag”_
->
G‘Cl›Á
(
’şave_Çme
));

130 
EnşaveIÅut
 
	gšput
;

131 
	gšput
.
MubËEx‹nsiÚ
(
fÜk_£cur™y_‹¡_šput
)

132 ->
£t_»que¡_fÜk
(
»que¡_fÜk
);

133 
ASYLO_RETURN_IF_ERROR
(
ş›Á_
->
EÁ”AndRun
(
šput
, 
nuÎ±r
));

136 
ASYLO_RETURN_IF_ERROR
(

137 
ş›Á_
->
EÁ”AndTakeSÇpshÙ
(&
¢­shÙ_Ïyout_
));

138 
	g¢­shÙ_d–‘”_
.
Re£t
(
¢­shÙ_Ïyout_
);

139  
	gStus
::
OkStus
();

144 
FlRªdomSÇpshÙLayoutEÁryB™
(

145 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
SÇpshÙLayoutEÁry
> &
’Œy
) {

147 
ušt8_t
 
¿ndom_šdex
;

148 
RAND_by‹s
(&
¿ndom_šdex
, (random_index));

149 
	g¿ndom_šdex
 %ğ
’Œy
.
size
();

152 
ušt8_t
 
	g¿ndom_by‹_pos™iÚ
;

153 
RAND_by‹s
(&
¿ndom_by‹_pos™iÚ
, (random_byte_position));

154 
	g¿ndom_by‹_pos™iÚ
 %ğ
’Œy
[
¿ndom_šdex
].
ch”‹xt_size
();

155 
ušt8_t
 *
	g¢­shÙ_ch”‹xt
 =

156 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
’Œy
[
¿ndom_šdex
].
ch”‹xt_ba£
());

159 
	g¢­shÙ_ch”‹xt
[
¿ndom_by‹_pos™iÚ
] ^= 1;

162 
EnşaveMªag”
 *
	gmªag”_
;

163 
SgxCl›Á
 *
	gş›Á_
;

164 
SÇpshÙLayout
 
	g¢­shÙ_Ïyout_
;

165 
SÇpshÙD–‘”
 
	g¢­shÙ_d–‘”_
;

166 
boŞ
 
	g’şave_fš®ized_
;

169 
EnşaveMªag”
 *
	gFÜkSecur™yTe¡
::
mªag”_
 = 
nuÎ±r
;

173 
TEST_F
(
FÜkSecur™yTe¡
, 
SÇpshÙFasW™hourFÜkReque¡
) {

174 
Stus
 
	g¡©us
 =

175 
LßdEnşaveAndTakeSÇpshÙ
("SÇpshÙ blocked", 
çl£
);

176 ià(
	g¡©us
 !ğ
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

179 
ASSERT_THAT
(
¡©us
,

180 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

184 
	gasylo
::
FÜkHªdshakeCÚfig
 
fÜk_hªdshake_cÚfig
;

185 
	gfÜk_hªdshake_cÚfig
.
£t_is_·»Á
(
Œue
);

186 
	gfÜk_hªdshake_cÚfig
.
£t_sock‘
(0);

187 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndT¿nsãrSecu»SÇpshÙKey
(

188 
fÜk_hªdshake_cÚfig
),

189 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

196 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeSucûed
) {

197 
Stus
 
	g¡©us
 =

198 
LßdEnşaveAndTakeSÇpshÙ
("Re¡Üsucûed", 
Œue
);

199 ià(
	g¡©us
.
ok
()) {

201 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
IsOk
());

205 
EXPECT_THAT
(
¡©us
,

206 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

212 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyD©a
) {

213 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified data",

214  
Œue
);

215 ià(
	g¡©us
.
ok
()) {

218 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
d©a
());

221 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

222 
	g’şave_fš®ized_
 = 
Œue
;

226 
EXPECT_THAT
(
¡©us
,

227 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

233 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyBss
) {

234 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified bss",

235  
Œue
);

236 ià(
	g¡©us
.
ok
()) {

239 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
bss
());

242 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

243 
	g’şave_fš®ized_
 = 
Œue
;

247 
EXPECT_THAT
(
¡©us
,

248 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

255 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyTh»ad
) {

256 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modifiedhread",

257  
Œue
);

258 ià(
	g¡©us
.
ok
()) {

261 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
th»ad
());

264 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

265 
	g’şave_fš®ized_
 = 
Œue
;

269 
EXPECT_THAT
(
¡©us
,

270 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

276 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifySck
) {

277 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified stack",

278  
Œue
);

279 ià(
	g¡©us
.
ok
()) {

282 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
¡ack
());

285 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

286 
	g’şave_fš®ized_
 = 
Œue
;

290 
EXPECT_THAT
(
¡©us
,

291 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

298 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyH—p
) {

299 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified heap",

300  
Œue
);

301 ià(
	g¡©us
.
ok
()) {

304 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
h—p
());

306 
EXPECT_EXIT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
),

307 ::
‹¡šg
::
KËdBySigÇl
(
SIGSEGV
), ".*");

308 
	g’şave_fš®ized_
 = 
Œue
;

312 
EXPECT_THAT
(
¡©us
,

313 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

	@platform/posix/fork_security_test_driver.cc

19 
	~<İ’s¦/¿nd.h
>

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/ş›Á.h
"

26 
	~"asylo/’şave.pb.h
"

27 
	~"gæags/gæags.h
"

28 
	~"asylo/¶©fÜm/¬ch/fÜk.pb.h
"

29 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

30 
	~"asylo/¶©fÜm/cÜe/’şave_mªag”.h
"

31 
	~"asylo/¶©fÜm/posix/fÜk_£cur™y_‹¡.pb.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/ut/¡©us.h
"

34 
	~"asylo/ut/¡©us_maüos.h
"

36 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclaveo†oad");

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 
	gusšg
 ::
‹¡šg
::
NÙ
;

44 şas 
	cSÇpshÙD–‘”
 {

45 
	gpublic
:

47 şas 
	cSÇpshÙEÁryD–‘”
 {

48 
public
:

49 
SÇpshÙEÁryD–‘”
()

50 : 
ch”‹xt_d–‘”_
(
nuÎ±r
), 
nÚû_d–‘”_
(nullptr) {}

52 
Re£t
(cÚ¡ 
SÇpshÙLayoutEÁry
 &
’Œy
) {

53 
	gch”‹xt_d–‘”_
.
»£t
(

54 
»š‹½»t_ÿ¡
<*>(
’Œy
.
ch”‹xt_ba£
()));

55 
	gnÚû_d–‘”_
.
»£t
(
»š‹½»t_ÿ¡
<*>(
’Œy
.
nÚû_ba£
()));

58 
	g´iv©e
:

59 
M®locUniquePŒ
<> 
ch”‹xt_d–‘”_
;

60 
	gM®locUniquePŒ
<> 
	gnÚû_d–‘”_
;

63 
Re£t
(cÚ¡ 
SÇpshÙLayout
 &
¢­shÙ_Ïyout
) {

64 
	gd©a_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
d©a_size
());

65 
	gbss_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
bss_size
());

66 
	gh—p_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
h—p_size
());

67 
	gth»ad_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
th»ad_size
());

68 
	g¡ack_d–‘”_
.
»size
(
¢­shÙ_Ïyout
.
¡ack_size
());

69 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
d©a_size
(); ++i) {

70 
	gd©a_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
d©a
(i));

72 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
bss_size
(); ++i) {

73 
	gbss_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
bss
(i));

75 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
h—p_size
(); ++i) {

76 
	gh—p_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
h—p
(i));

78 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
th»ad_size
(); ++i) {

79 
	gth»ad_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
th»ad
(i));

81 
	gi
 = 0; i < 
	g¢­shÙ_Ïyout
.
¡ack_size
(); ++i) {

82 
	g¡ack_d–‘”_
[
i
].
Re£t
(
¢­shÙ_Ïyout
.
¡ack
(i));

86 
	g´iv©e
:

87 
¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
d©a_d–‘”_
;

88 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
bss_d–‘”_
;

89 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
h—p_d–‘”_
;

90 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
th»ad_d–‘”_
;

91 
	g¡d
::
veùÜ
<
SÇpshÙEÁryD–‘”
> 
¡ack_d–‘”_
;

94 şas 
	cFÜkSecur™yTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

95 
public
:

96 
FÜkSecur™yTe¡
(è: 
’şave_fš®ized_
(
çl£
) {}

98 
´Ùeùed
:

99 
S‘UpTe¡Su™e
() {

100 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

101 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

102 ià(!
	gmªag”_»suÉ
.
ok
()) {

103 
LOG
(
FATAL
è<< 
	gmªag”_»suÉ
.
¡©us
();

105 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

108 
T—rDown
(è
	gov”ride
 {

109 
ASSERT_NE
(
mªag”_
, 
nuÎ±r
);

110 
ASSERT_NE
(
ş›Á_
, 
nuÎ±r
);

111 
EnşaveFš®
 
	gefš®
;

114 
EXPECT_THAT
(
mªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
,

115  
’şave_fš®ized_
),

116 
IsOk
());

119 
Stus
 
LßdEnşaveAndTakeSÇpshÙ
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_Çme
,

120 
boŞ
 
»que¡_fÜk
) {

121 
SgxLßd”
 
lßd”
(
FLAGS_’şave_·th
, 
Œue
);

122 
EnşaveCÚfig
 
	gcÚfig
;

124 
	gcÚfig
.
£t_’abË_fÜk
(
Œue
);

125 
ASYLO_RETURN_IF_ERROR
(
mªag”_
->
LßdEnşave
(
’şave_Çme
, 
lßd”
, 
cÚfig
));

127 
	gş›Á_
 = 
»š‹½»t_ÿ¡
<
SgxCl›Á
 *>(
mªag”_
->
G‘Cl›Á
(
’şave_Çme
));

130 
EnşaveIÅut
 
	gšput
;

131 
	gšput
.
MubËEx‹nsiÚ
(
fÜk_£cur™y_‹¡_šput
)

132 ->
£t_»que¡_fÜk
(
»que¡_fÜk
);

133 
ASYLO_RETURN_IF_ERROR
(
ş›Á_
->
EÁ”AndRun
(
šput
, 
nuÎ±r
));

136 
ASYLO_RETURN_IF_ERROR
(

137 
ş›Á_
->
EÁ”AndTakeSÇpshÙ
(&
¢­shÙ_Ïyout_
));

138 
	g¢­shÙ_d–‘”_
.
Re£t
(
¢­shÙ_Ïyout_
);

139  
	gStus
::
OkStus
();

144 
FlRªdomSÇpshÙLayoutEÁryB™
(

145 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dPŒF›ld
<
SÇpshÙLayoutEÁry
> &
’Œy
) {

147 
ušt8_t
 
¿ndom_šdex
;

148 
RAND_by‹s
(&
¿ndom_šdex
, (random_index));

149 
	g¿ndom_šdex
 %ğ
’Œy
.
size
();

152 
ušt8_t
 
	g¿ndom_by‹_pos™iÚ
;

153 
RAND_by‹s
(&
¿ndom_by‹_pos™iÚ
, (random_byte_position));

154 
	g¿ndom_by‹_pos™iÚ
 %ğ
’Œy
[
¿ndom_šdex
].
ch”‹xt_size
();

155 
ušt8_t
 *
	g¢­shÙ_ch”‹xt
 =

156 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
’Œy
[
¿ndom_šdex
].
ch”‹xt_ba£
());

159 
	g¢­shÙ_ch”‹xt
[
¿ndom_by‹_pos™iÚ
] ^= 1;

162 
EnşaveMªag”
 *
	gmªag”_
;

163 
SgxCl›Á
 *
	gş›Á_
;

164 
SÇpshÙLayout
 
	g¢­shÙ_Ïyout_
;

165 
SÇpshÙD–‘”
 
	g¢­shÙ_d–‘”_
;

166 
boŞ
 
	g’şave_fš®ized_
;

169 
EnşaveMªag”
 *
	gFÜkSecur™yTe¡
::
mªag”_
 = 
nuÎ±r
;

173 
TEST_F
(
FÜkSecur™yTe¡
, 
SÇpshÙFasW™hourFÜkReque¡
) {

174 
Stus
 
	g¡©us
 =

175 
LßdEnşaveAndTakeSÇpshÙ
("SÇpshÙ blocked", 
çl£
);

176 ià(
	g¡©us
 !ğ
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

179 
ASSERT_THAT
(
¡©us
,

180 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

184 
	gasylo
::
FÜkHªdshakeCÚfig
 
fÜk_hªdshake_cÚfig
;

185 
	gfÜk_hªdshake_cÚfig
.
£t_is_·»Á
(
Œue
);

186 
	gfÜk_hªdshake_cÚfig
.
£t_sock‘
(0);

187 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndT¿nsãrSecu»SÇpshÙKey
(

188 
fÜk_hªdshake_cÚfig
),

189 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
PERMISSION_DENIED
,

196 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeSucûed
) {

197 
Stus
 
	g¡©us
 =

198 
LßdEnşaveAndTakeSÇpshÙ
("Re¡Üsucûed", 
Œue
);

199 ià(
	g¡©us
.
ok
()) {

201 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
IsOk
());

205 
EXPECT_THAT
(
¡©us
,

206 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

212 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyD©a
) {

213 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified data",

214  
Œue
);

215 ià(
	g¡©us
.
ok
()) {

218 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
d©a
());

221 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

222 
	g’şave_fš®ized_
 = 
Œue
;

226 
EXPECT_THAT
(
¡©us
,

227 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

233 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyBss
) {

234 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified bss",

235  
Œue
);

236 ià(
	g¡©us
.
ok
()) {

239 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
bss
());

242 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

243 
	g’şave_fš®ized_
 = 
Œue
;

247 
EXPECT_THAT
(
¡©us
,

248 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

255 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyTh»ad
) {

256 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modifiedhread",

257  
Œue
);

258 ià(
	g¡©us
.
ok
()) {

261 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
th»ad
());

264 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

265 
	g’şave_fš®ized_
 = 
Œue
;

269 
EXPECT_THAT
(
¡©us
,

270 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

276 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifySck
) {

277 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified stack",

278  
Œue
);

279 ià(
	g¡©us
.
ok
()) {

282 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
¡ack
());

285 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
), 
NÙ
(
IsOk
()));

286 
	g’şave_fš®ized_
 = 
Œue
;

290 
EXPECT_THAT
(
¡©us
,

291 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

298 
TEST_F
(
FÜkSecur™yTe¡
, 
Re¡ÜeW™hModifyH—p
) {

299 
Stus
 
	g¡©us
 = 
LßdEnşaveAndTakeSÇpshÙ
("Restore with modified heap",

300  
Œue
);

301 ià(
	g¡©us
.
ok
()) {

304 
FlRªdomSÇpshÙLayoutEÁryB™
(
¢­shÙ_Ïyout_
.
h—p
());

306 
EXPECT_EXIT
(
ş›Á_
->
EÁ”AndRe¡Üe
(
¢­shÙ_Ïyout_
),

307 ::
‹¡šg
::
KËdBySigÇl
(
SIGSEGV
), ".*");

308 
	g’şave_fš®ized_
 = 
Œue
;

312 
EXPECT_THAT
(
¡©us
,

313 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

	@platform/posix/fork_security_test_enclave.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

20 
	~"asylo/¶©fÜm/posix/fÜk_£cur™y_‹¡.pb.h
"

21 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

23 
Çme¥aû
 
	gasylo
 {

25 şas 
	cFÜkSecur™yTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

26 
public
:

27 
FÜkSecur™yTe¡
() = ;

29 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

30 ià(!
IsSecu»FÜkSuµÜ‹d
()) {

31  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

34 ià(!
	gšput
.
HasEx‹nsiÚ
(
fÜk_£cur™y_‹¡_šput
)) {

35  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

38 
FÜkSecur™yTe¡IÅut
 
	g‹¡_šput
 =

39 
šput
.
G‘Ex‹nsiÚ
(
fÜk_£cur™y_‹¡_šput
);

40 ià(!
	g‹¡_šput
.
has_»que¡_fÜk
()) {

41  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

44 ià(
	g‹¡_šput
.
»que¡_fÜk
()) {

45 
S‘FÜkReque¡ed
();

47 
SaveTh»adLayoutFÜSÇpshÙ
();

48  
	gStus
::
OkStus
();

52 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
FÜkSecur™yTe¡
; 
	}
}

	@platform/posix/fork_security_test_enclave.cc

19 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

20 
	~"asylo/¶©fÜm/posix/fÜk_£cur™y_‹¡.pb.h
"

21 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

23 
Çme¥aû
 
	gasylo
 {

25 şas 
	cFÜkSecur™yTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

26 
public
:

27 
FÜkSecur™yTe¡
() = ;

29 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

30 ià(!
IsSecu»FÜkSuµÜ‹d
()) {

31  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNAVAILABLE
,

34 ià(!
	gšput
.
HasEx‹nsiÚ
(
fÜk_£cur™y_‹¡_šput
)) {

35  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

38 
FÜkSecur™yTe¡IÅut
 
	g‹¡_šput
 =

39 
šput
.
G‘Ex‹nsiÚ
(
fÜk_£cur™y_‹¡_šput
);

40 ià(!
	g‹¡_šput
.
has_»que¡_fÜk
()) {

41  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

44 ià(
	g‹¡_šput
.
»que¡_fÜk
()) {

45 
S‘FÜkReque¡ed
();

47 
SaveTh»adLayoutFÜSÇpshÙ
();

48  
	gStus
::
OkStus
();

52 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
FÜkSecur™yTe¡
; 
	}
}

	@platform/posix/fork_test_driver.cc

18 
	~<gmock/gmock.h
>

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/ş›Á.h
"

21 
	~"gæags/gæags.h
"

22 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

23 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
	~"asylo/ut/¡©usÜ.h
"

26 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclave");

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cFÜkTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

32 
´Ùeùed
:

33 
S‘Up
(è
ov”ride
 {

34 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

35 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

36 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

37 
EnşaveCÚfig
 
	gcÚfig
;

38 *
	gcÚfig
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

39 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
();

40 
	gcÚfig
.
£t_’abË_fÜk
(
Œue
);

41 autØ
	glßd”
 = 
ab¦
::
make_unique
<
SgxLßd”
>(
FLAGS_’şave_·th
, 
	gŒue
);

42 
ASSERT_THAT
(
mªag”_
->
LßdEnşave
("/fÜk_‹¡", *
lßd”
, 
cÚfig
), 
IsOk
());

43 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
("/fork_test");

46 
T—rDown
(è
	gov”ride
 {

47 
EXPECT_NE
(
ş›Á_
, 
nuÎ±r
);

48 
EXPECT_NE
(
mªag”_
, 
nuÎ±r
);

49 
EnşaveFš®
 
	gefš®
;

50 
EXPECT_THAT
(
mªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
,

51  
çl£
), 
IsOk
());

54 
EnşaveMªag”
 *
	gmªag”_
;

55 
EnşaveCl›Á
 *
	gş›Á_
;

58 
TEST_F
(
FÜkTe¡
, 
FÜk
) {

59 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
({}, 
nuÎ±r
), 
IsOk
());

	@platform/posix/fork_test_driver.cc

18 
	~<gmock/gmock.h
>

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/ş›Á.h
"

21 
	~"gæags/gæags.h
"

22 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

23 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
	~"asylo/ut/¡©usÜ.h
"

26 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclave");

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cFÜkTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

32 
´Ùeùed
:

33 
S‘Up
(è
ov”ride
 {

34 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

35 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

36 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

37 
EnşaveCÚfig
 
	gcÚfig
;

38 *
	gcÚfig
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

39 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
();

40 
	gcÚfig
.
£t_’abË_fÜk
(
Œue
);

41 autØ
	glßd”
 = 
ab¦
::
make_unique
<
SgxLßd”
>(
FLAGS_’şave_·th
, 
	gŒue
);

42 
ASSERT_THAT
(
mªag”_
->
LßdEnşave
("/fÜk_‹¡", *
lßd”
, 
cÚfig
), 
IsOk
());

43 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
("/fork_test");

46 
T—rDown
(è
	gov”ride
 {

47 
EXPECT_NE
(
ş›Á_
, 
nuÎ±r
);

48 
EXPECT_NE
(
mªag”_
, 
nuÎ±r
);

49 
EnşaveFš®
 
	gefš®
;

50 
EXPECT_THAT
(
mªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
,

51  
çl£
), 
IsOk
());

54 
EnşaveMªag”
 *
	gmªag”_
;

55 
EnşaveCl›Á
 *
	gş›Á_
;

58 
TEST_F
(
FÜkTe¡
, 
FÜk
) {

59 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
({}, 
nuÎ±r
), 
IsOk
());

	@platform/posix/fork_test_enclave.cc

19 
	~<sys/wa™.h
>

20 
	~<uni¡d.h
>

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

31 şas 
	cFÜkTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

32 
public
:

33 
FÜkTe¡
() = ;

34 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

36 *
	g‹¡_h—p
 = 
Ãw
 [10];

37 
	gi
 = 0; i < 10; ++i) {

38 
	g‹¡_h—p
[
i
] = '0' + i;

42 **
	g‹¡_¡ack
 = &
‹¡_h—p
;

44 
pid_t
 
	gpid
 = 
fÜk
();

45 ià(
	gpid
 < 0) {

46 
abÜt
();

48 ià(
	gpid
 == 0) {

52 
i
 = 0; 
	gi
 < 10; ++i) {

53 ià(
	g‹¡_h—p
[
i
] != '0' + i) {

54 
LOG
(
ERROR
) << "Variable on heap inhe childƒnclave does‚ot match "

56 
abÜt
();

59 ià(
	g‹¡_¡ack
 !ğ&
‹¡_h—p
) {

60 
LOG
(
ERROR
) << "Variable on stack inhe childƒnclave does‚ot match "

62 
abÜt
();

65 
_ex™
(0);

70 
	g¡©us
;

71 ià(
wa™
(&
¡©us
) == -1) {

72  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

73 
ab¦
::
SŒC©
("Error waiting for child: ",

74 
¡»¼Ü
(
”ºo
)));

76 ià(!
WIFEXITED
(
¡©us
)) {

77  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "childƒnclave‡borted");

80  
	gStus
::
OkStus
();

84 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
FÜkTe¡
; 
	}
}

	@platform/posix/fork_test_enclave.cc

19 
	~<sys/wa™.h
>

20 
	~<uni¡d.h
>

22 
	~"asylo/ut/loggšg.h
"

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

31 şas 
	cFÜkTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

32 
public
:

33 
FÜkTe¡
() = ;

34 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

36 *
	g‹¡_h—p
 = 
Ãw
 [10];

37 
	gi
 = 0; i < 10; ++i) {

38 
	g‹¡_h—p
[
i
] = '0' + i;

42 **
	g‹¡_¡ack
 = &
‹¡_h—p
;

44 
pid_t
 
	gpid
 = 
fÜk
();

45 ià(
	gpid
 < 0) {

46 
abÜt
();

48 ià(
	gpid
 == 0) {

52 
i
 = 0; 
	gi
 < 10; ++i) {

53 ià(
	g‹¡_h—p
[
i
] != '0' + i) {

54 
LOG
(
ERROR
) << "Variable on heap inhe childƒnclave does‚ot match "

56 
abÜt
();

59 ià(
	g‹¡_¡ack
 !ğ&
‹¡_h—p
) {

60 
LOG
(
ERROR
) << "Variable on stack inhe childƒnclave does‚ot match "

62 
abÜt
();

65 
_ex™
(0);

70 
	g¡©us
;

71 ià(
wa™
(&
¡©us
) == -1) {

72  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

73 
ab¦
::
SŒC©
("Error waiting for child: ",

74 
¡»¼Ü
(
”ºo
)));

76 ià(!
WIFEXITED
(
¡©us
)) {

77  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "childƒnclave‡borted");

80  
	gStus
::
OkStus
();

84 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
FÜkTe¡
; 
	}
}

	@platform/posix/grp.cc

19 
	~<g½.h
>

21 
	~<¡dlib.h
>

22 
	~<sys/ty³s.h
>

26 
g‘grgid_r
(
gid_t
 
gid
, 
group
 *
g½
, *
buf
, 
size_t
 
buæ’
,

27 
group
 **
»suÉ
) {

28 
abÜt
();

31 
g‘gºam_r
(cÚ¡ *
Çme
, 
group
 *
g½
, *
buf
, 
size_t
 
buæ’
,

32 
group
 **
»suÉ
) {

33 
abÜt
();

	@platform/posix/grp.cc

19 
	~<g½.h
>

21 
	~<¡dlib.h
>

22 
	~<sys/ty³s.h
>

26 
g‘grgid_r
(
gid_t
 
gid
, 
group
 *
g½
, *
buf
, 
size_t
 
buæ’
,

27 
group
 **
»suÉ
) {

28 
abÜt
();

31 
g‘gºam_r
(cÚ¡ *
Çme
, 
group
 *
g½
, *
buf
, 
size_t
 
buæ’
,

32 
group
 **
»suÉ
) {

33 
abÜt
();

	@platform/posix/ifaddrs.cc

19 
	~<içddrs.h
>

20 
	~<c¡dlib
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
g‘içddrs
(
içddrs
 **
içp
è{  
’c_uÁru¡ed_g‘içddrs
(ifap); }

28 
ä“içddrs
(
içddrs
 *
iç
è{ 
’c_uÁru¡ed_ä“içddrs
(ifa); }

	@platform/posix/ifaddrs.cc

19 
	~<içddrs.h
>

20 
	~<c¡dlib
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
g‘içddrs
(
içddrs
 **
içp
è{  
’c_uÁru¡ed_g‘içddrs
(ifap); }

28 
ä“içddrs
(
içddrs
 *
iç
è{ 
’c_uÁru¡ed_ä“içddrs
(ifa); }

	@platform/posix/include/arpa/inet.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_ARPA_INET_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_ARPA_INET_H_


	)

22 
	~<Ãtš‘/š.h
>

23 
	~<¡dšt.h
>

24 
	~<sys/sock‘.h
>

26 #ifdeà
__ılu¥lus


30 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
);

31 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
);

33 
š‘_©Ú
(cÚ¡ *
ı
, 
š_addr
 *
šp
);

36 
š_addr_t
 
š‘_addr
(cÚ¡ *
ı
);

38 #ifdeà
__ılu¥lus


	@platform/posix/include/arpa/nameser.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_ARPA_NAMESER_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_ARPA_NAMESER_H_


	)

22 #ifdeà
__ılu¥lus


29 
	e__ns_ty³
 {

30 
ns_t_šv®id
 = 0,

31 
ns_t_a
 = 1,

32 
ns_t_ns
 = 2,

33 
ns_t_md
 = 3,

34 
ns_t_mf
 = 4,

35 
ns_t_úame
 = 5,

36 
ns_t_sß
 = 6,

37 
ns_t_mb
 = 7,

38 
ns_t_mg
 = 8,

39 
ns_t_mr
 = 9,

40 
ns_t_nuÎ
 = 10,

41 
ns_t_wks
 = 11,

42 
ns_t_±r
 = 12,

43 
ns_t_hšfo
 = 13,

44 
ns_t_mšfo
 = 14,

45 
ns_t_mx
 = 15,

46 
ns_t_txt
 = 16,

47 
ns_t_½
 = 17,

48 
ns_t_afsdb
 = 18,

49 
ns_t_x25
 = 19,

50 
ns_t_isdn
 = 20,

51 
ns_t_¹
 = 21,

52 
ns_t_n§p
 = 22,

53 
ns_t_n§p_±r
 = 23,

54 
ns_t_sig
 = 24,

55 
ns_t_key
 = 25,

56 
ns_t_px
 = 26,

57 
ns_t_gpos
 = 27,

58 
ns_t_¯¯
 = 28,

59 
ns_t_loc
 = 29,

60 
ns_t_nxt
 = 30,

61 
ns_t_eid
 = 31,

62 
ns_t_nimloc
 = 32,

63 
ns_t_¤v
 = 33,

64 
ns_t_©ma
 = 34,

65 
ns_t_Ç±r
 = 35,

66 
ns_t_kx
 = 36,

67 
ns_t_û¹
 = 37,

68 
ns_t_a6
 = 38,

69 
ns_t_dÇme
 = 39,

70 
ns_t_sšk
 = 40,

71 
ns_t_İt
 = 41,

72 
ns_t_­l
 = 42,

73 
ns_t_tkey
 = 249,

74 
ns_t_tsig
 = 250,

75 
ns_t_ixä
 = 251,

76 
ns_t_axä
 = 252,

77 
ns_t_mab
 = 253,

78 
ns_t_maa
 = 254,

79 
ns_t_ªy
 = 255,

80 
ns_t_zxä
 = 256,

81 
ns_t_max
 = 65536

82 } 
	tns_ty³
;

87 
	e__ns_İcode
 {

88 
ns_o_qu”y
 = 0,

89 
ns_o_iqu”y
 = 1,

90 
ns_o_¡©us
 = 2,

92 
ns_o_nÙify
 = 4,

93 
ns_o_upd©e
 = 5,

94 
ns_o_max
 = 6

95 } 
	tns_İcode
;

100 
	e__ns_rcode
 {

101 
ns_r_nÛ¼Ü
 = 0,

102 
ns_r_fÜm”r
 = 1,

103 
ns_r_£rvç
 = 2,

104 
ns_r_nxdomaš
 = 3,

105 
ns_r_nÙim¶
 = 4,

106 
ns_r_»fu£d
 = 5,

108 
ns_r_yxdomaš
 = 6,

109 
ns_r_yx¼£t
 = 7,

110 
ns_r_nx¼£t
 = 8,

111 
ns_r_nÙauth
 = 9,

112 
ns_r_nÙzÚe
 = 10,

113 
ns_r_max
 = 11,

115 
ns_r_badv”s
 = 16,

117 
ns_r_badsig
 = 16,

118 
ns_r_badkey
 = 17,

119 
ns_r_badtime
 = 18

120 } 
	tns_rcode
;

125 
	e__ns_şass
 {

126 
ns_c_šv®id
 = 0,

127 
ns_c_š
 = 1,

128 
ns_c_2
 = 2,

129 
ns_c_chaos
 = 3,

130 
ns_c_hs
 = 4,

132 
ns_c_nÚe
 = 254,

133 
ns_c_ªy
 = 255,

134 
ns_c_max
 = 65536

135 } 
	tns_şass
;

140 
	#NS_PACKETSZ
 512

	)

141 
	#NS_MAXDNAME
 1025

	)

142 
	#NS_MAXMSG
 65535

	)

143 
	#NS_MAXCDNAME
 255

	)

144 
	#NS_MAXLABEL
 63

	)

145 
	#NS_HFIXEDSZ
 12

	)

146 
	#NS_QFIXEDSZ
 4

	)

147 
	#NS_RRFIXEDSZ
 10

	)

148 
	#NS_INT32SZ
 4

	)

149 
	#NS_INT16SZ
 2

	)

150 
	#NS_INT8SZ
 1

	)

151 
	#NS_INADDRSZ
 4

	)

152 
	#NS_IN6ADDRSZ
 16

	)

153 
	#NS_CMPRSFLGS
 0xc0

	)

154 
	#NS_DEFAULTPORT
 53

	)

158 
	#T_A
 
ns_t_a


	)

159 
	#T_NS
 
ns_t_ns


	)

160 
	#T_MD
 
ns_t_md


	)

161 
	#T_MF
 
ns_t_mf


	)

162 
	#T_CNAME
 
ns_t_úame


	)

163 
	#T_SOA
 
ns_t_sß


	)

164 
	#T_MB
 
ns_t_mb


	)

165 
	#T_MG
 
ns_t_mg


	)

166 
	#T_MR
 
ns_t_mr


	)

167 
	#T_NULL
 
ns_t_nuÎ


	)

168 
	#T_WKS
 
ns_t_wks


	)

169 
	#T_PTR
 
ns_t_±r


	)

170 
	#T_HINFO
 
ns_t_hšfo


	)

171 
	#T_MINFO
 
ns_t_mšfo


	)

172 
	#T_MX
 
ns_t_mx


	)

173 
	#T_TXT
 
ns_t_txt


	)

174 
	#T_RP
 
ns_t_½


	)

175 
	#T_AFSDB
 
ns_t_afsdb


	)

176 
	#T_X25
 
ns_t_x25


	)

177 
	#T_ISDN
 
ns_t_isdn


	)

178 
	#T_RT
 
ns_t_¹


	)

179 
	#T_NSAP
 
ns_t_n§p


	)

180 
	#T_NSAP_PTR
 
ns_t_n§p_±r


	)

181 
	#T_SIG
 
ns_t_sig


	)

182 
	#T_KEY
 
ns_t_key


	)

183 
	#T_PX
 
ns_t_px


	)

184 
	#T_GPOS
 
ns_t_gpos


	)

185 
	#T_AAAA
 
ns_t_¯¯


	)

186 
	#T_LOC
 
ns_t_loc


	)

187 
	#T_NXT
 
ns_t_nxt


	)

188 
	#T_EID
 
ns_t_eid


	)

189 
	#T_NIMLOC
 
ns_t_nimloc


	)

190 
	#T_SRV
 
ns_t_¤v


	)

191 
	#T_ATMA
 
ns_t_©ma


	)

192 
	#T_NAPTR
 
ns_t_Ç±r


	)

193 
	#T_A6
 
ns_t_a6


	)

194 
	#T_DNAME
 
ns_t_dÇme


	)

195 
	#T_TSIG
 
ns_t_tsig


	)

196 
	#T_IXFR
 
ns_t_ixä


	)

197 
	#T_AXFR
 
ns_t_axä


	)

198 
	#T_MAILB
 
ns_t_mab


	)

199 
	#T_MAILA
 
ns_t_maa


	)

200 
	#T_ANY
 
ns_t_ªy


	)

202 
	#PACKETSZ
 
NS_PACKETSZ


	)

203 
	#MAXDNAME
 
NS_MAXDNAME


	)

204 
	#MAXCDNAME
 
NS_MAXCDNAME


	)

205 
	#MAXLABEL
 
NS_MAXLABEL


	)

206 
	#HFIXEDSZ
 
NS_HFIXEDSZ


	)

207 
	#QFIXEDSZ
 
NS_QFIXEDSZ


	)

208 
	#RRFIXEDSZ
 
NS_RRFIXEDSZ


	)

209 
	#INT32SZ
 
NS_INT32SZ


	)

210 
	#INT16SZ
 
NS_INT16SZ


	)

211 
	#INT8SZ
 
NS_INT8SZ


	)

212 
	#INADDRSZ
 
NS_INADDRSZ


	)

213 
	#IN6ADDRSZ
 
NS_IN6ADDRSZ


	)

214 
	#INDIR_MASK
 
NS_CMPRSFLGS


	)

215 
	#NAMESERVER_PORT
 
NS_DEFAULTPORT


	)

217 
	#QUERY
 
ns_o_qu”y


	)

218 
	#IQUERY
 
ns_o_iqu”y


	)

219 
	#STATUS
 
ns_o_¡©us


	)

220 
	#NS_NOTIFY_OP
 
ns_o_nÙify


	)

221 
	#NS_UPDATE_OP
 
ns_o_upd©e


	)

223 
	#NOERROR
 
ns_r_nÛ¼Ü


	)

224 
	#FORMERR
 
ns_r_fÜm”r


	)

225 
	#SERVFAIL
 
ns_r_£rvç


	)

226 
	#NXDOMAIN
 
ns_r_nxdomaš


	)

227 
	#NOTIMP
 
ns_r_nÙim¶


	)

228 
	#REFUSED
 
ns_r_»fu£d


	)

229 
	#YXDOMAIN
 
ns_r_yxdomaš


	)

230 
	#YXRRSET
 
ns_r_yx¼£t


	)

231 
	#NXRRSET
 
ns_r_nx¼£t


	)

232 
	#NOTAUTH
 
ns_r_nÙauth


	)

233 
	#NOTZONE
 
ns_r_nÙzÚe


	)

235 
	#C_IN
 
ns_c_š


	)

236 
	#C_CHAOS
 
ns_c_chaos


	)

237 
	#C_HS
 
ns_c_hs


	)

238 
	#C_NONE
 
ns_c_nÚe


	)

239 
	#C_ANY
 
ns_c_ªy


	)

241 
	#DELETE
 
ns_uİ_d–‘e


	)

242 
	#ADD
 
ns_uİ_add


	)

244 #ifdeà
__ılu¥lus


	@platform/posix/include/byteswap.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_BYTESWAP_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_BYTESWAP_H_


	)

23 
	~<¡dšt.h
>

25 #ifdeà
__ılu¥lus


29 
šlše
 
ušt16_t
 
bsw­_16
(ušt16_ˆ
n
è{  
__butš_bsw­16
(n); }

31 
šlše
 
ušt32_t
 
bsw­_32
(ušt32_ˆ
n
è{  
__butš_bsw­32
(n); }

33 
šlše
 
ušt64_t
 
bsw­_64
(ušt64_ˆ
n
è{  
__butš_bsw­64
(n); }

35 #ifdeà
__ılu¥lus


	@platform/posix/include/dlfcn.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_DLFCN_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_DLFCN_H_


	)

22 #ifdeà
__ılu¥lus


26 
	#RTLD_LOCAL
 0

	)

28 
	#RTLD_NOW
 2

	)

30 *
dlİ’
(cÚ¡ *
f’ame
, 
æags
);

31 *
dlsym
(*
hªdË
, cÚ¡ *
symbŞ
);

32 
dlşo£
(*
hªdË
);

33 *
dË¼Ü
();

35 #ifdeà
__ılu¥lus


	@platform/posix/include/endian.h

19 #šşude_Ãxˆ<
’dŸn
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_ENDIAN_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_ENDIAN_H_


	)

24 
	~<¡dšt.h
>

26 #ifdeà
__ılu¦us


30 
ušt16_t
 
htobe16
(ušt16_ˆ
ho¡_16b™s
);

31 
ušt16_t
 
htŞe16
(ušt16_ˆ
ho¡_16b™s
);

32 
ušt16_t
 
be16toh
(ušt16_ˆ
big_’dŸn_16b™s
);

33 
ušt16_t
 
Ë16toh
(ušt16_ˆ
l™e_’dŸn_16b™s
);

35 
ušt32_t
 
htobe32
(ušt32_ˆ
ho¡_32b™s
);

36 
ušt32_t
 
htŞe32
(ušt32_ˆ
ho¡_32b™s
);

37 
ušt32_t
 
be32toh
(ušt32_ˆ
big_’dŸn_32b™s
);

38 
ušt32_t
 
Ë32toh
(ušt32_ˆ
l™e_’dŸn_32b™s
);

40 
ušt64_t
 
htobe64
(ušt64_ˆ
ho¡_64b™s
);

41 
ušt64_t
 
htŞe64
(ušt64_ˆ
ho¡_64b™s
);

42 
ušt64_t
 
be64toh
(ušt64_ˆ
big_’dŸn_64b™s
);

43 
ušt64_t
 
Ë64toh
(ušt64_ˆ
l™e_’dŸn_64b™s
);

45 #ifdeà
__ılu¦us


	@platform/posix/include/errno.h

19 #šşude_Ãxˆ<
”ºo
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_ERRNO_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_ERRNO_H_


	)

24 
	~<¡dšt.h
>

26 #ifdeà
__ılu¥lus


33 #iâdeà
TEMP_FAILURE_RETRY


34 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

35 (
	`__ex‹nsiÚ__
({ \

36 
ušt32_t
 
__»suÉ
; \

38 
__»suÉ
 = (
ušt32_t
)(
ex´essiÚ
); \

39 } 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

40 
__»suÉ
; \

41 }))

	)

44 #ifdeà
__ılu¥lus


	@platform/posix/include/fcntl.h

19 #šşude_Ãxˆ<
fú
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_FCNTL_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_FCNTL_H_


	)

24 
	#F_GETPIPE_SZ
 15

	)

25 
	#F_SETPIPE_SZ
 16

	)

27 
	#O_CLOEXEC
 0x10000

	)

28 
	#O_DIRECT
 0x20000

	)

29 
	#O_SECURE
 0x40000000

	)

	@platform/posix/include/ifaddrs.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_IFADDRS_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_IFADDRS_H_


	)

22 
	~<sys/sock‘.h
>

24 #ifdeà
__ılu¥lus


28 
	siçddrs
 {

29 
içddrs
 *
iç_Ãxt
;

30 *
iç_Çme
;

31 
iç_æags
;

32 
sockaddr
 *
iç_addr
;

33 
sockaddr
 *
iç_Ãtmask
;

35 
sockaddr
 *
ifu_brßdaddr
;

36 
sockaddr
 *
ifu_d¡addr
;

37 } 
iç_ifu
;

38 
	#iç_brßdaddr
 
iç_ifu
.
ifu_brßdaddr


	)

39 
	#iç_d¡addr
 
iç_ifu
.
ifu_d¡addr


	)

40 *
iç_d©a
;

43 
g‘içddrs
(
içddrs
 **
içp
);

45 
ä“içddrs
(
içddrs
 *
iç
);

47 #ifdeà
__ılu¥lus


	@platform/posix/include/internal/sched.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_INTERNAL_SCHED_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_INTERNAL_SCHED_H_


	)

22 
	~<¡dšt.h
>

24 #ifdeà
__ılu¥lus


30 
	#CPU_SET_MAX_CPUS
 1024

	)

32 
ušt64_t
 
	tCpuS‘WÜd
;

34 
	#CPU_SET_T_NUM_WORDS
 \

35 ((
CPU_SET_MAX_CPUS
 / 8 + (
CpuS‘WÜd
è- 1è/ (CpuS‘WÜd))

	)

39 
	sCpuS‘
 {

40 
CpuS‘WÜd
 
wÜds
[
CPU_SET_T_NUM_WORDS
];

41 } 
	tCpuS‘
;

45 
CpuS‘Z”o
(
CpuS‘
 *
£t
);

47 
CpuS‘AddB™
(
ıu
, 
CpuS‘
 *
£t
);

49 
CpuS‘CË¬B™
(
ıu
, 
CpuS‘
 *
£t
);

51 
CpuS‘CheckB™
(
ıu
, 
CpuS‘
 *
£t
);

53 
CpuS‘CouÁB™s
(
CpuS‘
 *
£t
);

55 
CpuS‘Equ®
(
CpuS‘
 *
£t1
, CpuS‘ *
£t2
);

57 #ifdeà
__ılu¥lus


	@platform/posix/include/math.h

20 #šşude_Ãxˆ<
m©h
.
h
>

22 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_MATH_H_


23 
	#ASYLO_PLATFORM_POSIX_INCLUDE_MATH_H_


	)

25 #ifdeà
__ılu¥lus


29 
çb¦
(
x
);

31 #ifdeà
__ılu¥lus


	@platform/posix/include/net/if.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_NET_IF_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_NET_IF_H_


	)

24 
	#IFF_UP
 0x1

	)

25 
	#IFF_BROADCAST
 0x2

	)

26 
	#IFF_DEBUG
 0x4

	)

27 
	#IFF_LOOPBACK
 0x8

	)

28 
	#IFF_POINTOPOINT
 0x10

	)

29 
	#IFF_NOTRAILERS
 0x20

	)

30 
	#IFF_RUNNING
 0x40

	)

31 
	#IFF_NOARP
 0x80

	)

32 
	#IFF_PROMISC
 0x100

	)

33 
	#IFF_ALLMULTI
 0x200

	)

34 
	#IFF_MULTICAST
 0x400

	)

	@platform/posix/include/netdb.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_NETDB_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_NETDB_H_


	)

22 #ifdeà
__ılu¥lus


27 cÚ¡ *
gai_¡»¼Ü
(
ecode
);

29 
	#_NETDB_H
 1

	)

31 
	~<Ãtš‘/š.h
>

34 
	#AI_CANONNAME
 0x0002

	)

35 
	#AI_NUMERICHOST
 0x0004

	)

36 
	#AI_V4MAPPED
 0x0008

	)

37 
	#AI_ADDRCONFIG
 0x0010

	)

38 
	#AI_ALL
 0x0020

	)

39 
	#AI_PASSIVE
 0x0040

	)

40 
	#AI_NUMERICSERV
 0x0080

	)

41 
	#AI_IDN
 0x0100

	)

42 
	#AI_CANONIDN
 0x0200

	)

45 
	#EAI_BADFLAGS
 -1

46 
	#EAI_NONAME
 -2

47 
	#EAI_AGAIN
 -3

48 
	#EAI_FAIL
 -4

49 
	#EAI_FAMILY
 -6

50 
	#EAI_SOCKTYPE
 -7

51 
	#EAI_SERVICE
 -8

52 
	#EAI_MEMORY
 -10

53 
	#EAI_SYSTEM
 -11

54 
	#EAI_OVERFLOW
 -12

55 
	#EAI_NODATA
 -5

56 
	#EAI_ADDRFAMILY
 -9

57 
	#EAI_INPROGRESS
 -100

58 
	#EAI_CANCELED
 -101

59 
	#EAI_NOTCANCELED
 -102

60 
	#EAI_ALLDONE
 -103

61 
	#EAI_INTR
 -104

62 
	#EAI_IDN_ENCODE
 -105

63 

	)

65 
	sho¡’t
 {

66 *
h_Çme
;

67 **
h_®Ÿ£s
;

68 
h_add¹y³
;

69 
h_Ëngth
;

70 **
h_addr_li¡
;

71 
	#h_addr
 
h_addr_li¡
[0]

72 };

	)

75 
	s£rv’t
 {

76 *
s_Çme
;

77 **
s_®Ÿ£s
;

78 
s_pÜt
;

79 *
s_´Ùo
;

83 
£rv’t
 *
g‘£rvbypÜt
(
pÜt
, cÚ¡ *
´Ùo
);

85 #ifdeà
__ılu¥lus


	@platform/posix/include/netinet/in.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_NETINET_IN_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_NETINET_IN_H_


	)

22 
	~<¡dšt.h
>

23 
	~<sys/sock‘.h
>

25 #ifdeà
__ılu¥lus


29 
ušt16_t
 
	tš_pÜt_t
;

31 
ušt32_t
 
htÚl
(ušt32_ˆ
ho¡lÚg
);

32 
ušt16_t
 
htÚs
(ušt16_ˆ
ho¡shÜt
);

33 
ušt32_t
 
Áohl
(ušt32_ˆ
ÃÚg
);

34 
ušt16_t
 
Áohs
(ušt16_ˆ
ÃtshÜt
);

37 
ušt32_t
 
	tš_addr_t
;

38 
	sš_addr
 {

39 
š_addr_t
 
s_addr
;

42 
	sš6_addr
 {

44 
ušt8_t
 
s6_addr
[16];

45 
ušt16_t
 
s6_addr16
[8];

46 
ušt32_t
 
s6_addr32
[4];

50 
	ssockaddr_š
 {

51 
§_çmy_t
 
sš_çmy
;

52 
š_pÜt_t
 
sš_pÜt
;

53 
š_addr
 
sš_addr
;

54 
sš_z”o
[8];

55 } 
__©Œibu‹__
((
·cked
));

57 
	ssockaddr_š6
 {

58 
§_çmy_t
 
sš6_çmy
;

59 
š_pÜt_t
 
sš6_pÜt
;

60 
ušt32_t
 
sš6_æowšfo
;

61 
š6_addr
 
sš6_addr
;

62 
ušt32_t
 
sš6_scİe_id
;

63 } 
__©Œibu‹__
((
·cked
));

66 cÚ¡ 
š6_addr
 
š6addr_ªy
;

67 cÚ¡ 
š6_addr
 
š6addr_loİback
;

69 
	#IN6ADDR_ANY_INIT
 \

72 }

	)

73 
	#IN6ADDR_LOOPBACK_INIT
 \

76 }

	)

78 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

79 ((((cÚ¡ 
ušt32_t
 *)(
a
))[0] == 0) && (((const uint32_t *)(a))[1] == 0) && \

80 (((cÚ¡ 
ušt32_t
 *)(
a
))[2] =ğ
	`htÚl
(0xffff)))

	)

83 
	#IPPROTO_IP
 0

84 
	#IPPROTO_ICMP
 1

85 
	#IPPROTO_IGMP
 2

86 
	#IPPROTO_IPIP
 4

87 
	#IPPROTO_TCP
 6

88 
	#IPPROTO_EGP
 8

89 
	#IPPROTO_PUP
 12

90 
	#IPPROTO_UDP
 17

91 
	#IPPROTO_IDP
 22

92 
	#IPPROTO_TP
 29

93 
	#IPPROTO_DCCP
 33

94 
	#IPPROTO_IPV6
 41

95 
	#IPPROTO_RSVP
 46

96 
	#IPPROTO_GRE
 47

97 
	#IPPROTO_ESP
 50

98 
	#IPPROTO_AH
 51

99 
	#IPPROTO_ICMPV6
 58

100 
	#IPPROTO_MTP
 92

101 
	#IPPROTO_BEETPH
 94

102 
	#IPPROTO_ENCAP
 98

103 
	#IPPROTO_PIM
 103

104 
	#IPPROTO_COMP
 108

105 
	#IPPROTO_SCTP
 132

106 
	#IPPROTO_UDPLITE
 136

107 
	#IPPROTO_RAW
 255

108 
	#IPPROTO_MAX


	)

110 
	#IPV6_V6ONLY
 26

	)

112 
	#INET_ADDRSTRLEN
 16

	)

113 
	#INET6_ADDRSTRLEN
 46

	)

115 
	sš_pktšfo
 {

116 
	gi_ifšdex
;

117 
š_addr
 
	gi_¥ec_d¡
;

118 
š_addr
 
	gi_addr
;

122 
	sš6_pktšfo
 {

123 
š6_addr
 
	gi6_addr
;

124 
	gi6_ifšdex
;

128 
	s6_mtušfo
 {

129 
sockaddr_š6
 
	g6m_addr
;

130 
ušt32_t
 
	g6m_mtu
;

133 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

134 
	#IN_CLASSA_NET
 0xff000000

	)

135 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

136 
	#IN_CLASSB_NET
 0xffff0000

	)

137 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

138 
	#IN_CLASSC_NET
 0xffffff00

	)

139 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

141 
	#INADDR_ANY
 
	`UINT32_C
(0x00000000)

142 
	#INADDR_NONE
 
	`UINT32_C
(0xffffffff)

143 

	)

145 #iâdeà
INADDR_LOOPBACK


146 
	#INADDR_LOOPBACK
 ((
š_addr_t
)0x7f000001)

148 

	)

149 
	#IP_TOS
 1

	)

150 
	#IP_TTL
 2

	)

151 
	#IP_HDRINCL
 3

	)

152 
	#IP_OPTIONS
 4

	)

153 
	#IP_ROUTER_ALERT
 5

	)

154 
	#IP_PKTINFO
 8

	)

155 
	#IP_PKTOPTIONS
 9

	)

156 
	#IP_PMTUDISC
 10

	)

157 
	#IP_MTU_DISCOVER
 10

	)

158 
	#IP_RECVERR
 11

	)

159 
	#IP_RECVTTL
 12

	)

160 
	#IP_RECVTOS
 13

	)

161 
	#IP_MTU
 14

	)

162 
	#IP_FREEBIND
 15

	)

163 
	#IP_IPSEC_POLICY
 16

	)

164 
	#IP_XFRM_POLICY
 17

	)

165 
	#IP_PASSSEC
 18

	)

166 
	#IP_TRANSPARENT
 19

	)

168 
	#IP_MULTICAST_IF
 32

	)

169 
	#IP_MULTICAST_TTL
 33

	)

170 
	#IP_MULTICAST_LOOP
 34

	)

171 
	#IP_ADD_MEMBERSHIP
 35

	)

172 
	#IP_DROP_MEMBERSHIP
 36

	)

173 
	#IP_UNBLOCK_SOURCE
 37

	)

174 
	#IP_BLOCK_SOURCE
 38

	)

175 
	#IP_ADD_SOURCE_MEMBERSHIP
 39

	)

176 
	#IP_DROP_SOURCE_MEMBERSHIP
 40

	)

177 
	#IP_MSFILTER
 41

	)

178 
	#MCAST_JOIN_GROUP
 42

	)

179 
	#MCAST_BLOCK_SOURCE
 43

	)

180 
	#MCAST_UNBLOCK_SOURCE
 44

	)

181 
	#MCAST_LEAVE_GROUP
 45

	)

182 
	#MCAST_JOIN_SOURCE_GROUP
 46

	)

183 
	#MCAST_LEAVE_SOURCE_GROUP
 47

	)

184 
	#MCAST_MSFILTER
 48

	)

185 
	#IP_MULTICAST_ALL
 49

	)

186 
	#IP_UNICAST_IF
 50

	)

188 
	#IPV6_RECVPKTINFO
 49

	)

189 
	#IPV6_PKTINFO
 50

	)

190 
	#IPV6_RECVHOPLIMIT
 51

	)

191 
	#IPV6_HOPLIMIT
 52

	)

192 
	#IPV6_RECVHOPOPTS
 53

	)

193 
	#IPV6_HOPOPTS
 54

	)

194 
	#IPV6_RTHDRDSTOPTS
 55

	)

195 
	#IPV6_RECVRTHDR
 56

	)

196 
	#IPV6_RTHDR
 57

	)

197 
	#IPV6_RECVDSTOPTS
 58

	)

198 
	#IPV6_DSTOPTS
 59

	)

199 
	#IPV6_RECVPATHMTU
 60

	)

200 
	#IPV6_PATHMTU
 61

	)

201 
	#IPV6_DONTFRAG
 62

	)

203 
	s_m»q
 {

204 
š_addr
 
	gimr_muÉŸddr
;

205 
š_addr
 
	gimr_š‹rçû
;

208 
	s_m»qn
 {

209 
š_addr
 
	gimr_muÉŸddr
;

210 
š_addr
 
	gimr_add»ss
;

211 
	gimr_ifšdex
;

214 #ifdeà
__ılu¥lus


	@platform/posix/include/netinet/tcp.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_NETINET_TCP_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_NETINET_TCP_H_


	)

22 #ifdeà
__ılu¥lus


26 
	#TCP_NODELAY
 1

	)

27 
	#TCP_KEEPIDLE
 4

	)

28 
	#TCP_KEEPINTVL
 5

	)

29 
	#TCP_KEEPCNT
 6

	)

31 #ifdeà
__ılu¥lus


	@platform/posix/include/netinet/udp.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_NETINET_UDP_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_NETINET_UDP_H_


	)

22 
	~<¡dšt.h
>

24 #ifdeà
__ılu¥lus


28 
	sudphdr
 {

29 
ušt16_t
 
sourû
;

30 
ušt16_t
 
de¡
;

31 
ušt16_t
 
Ën
;

32 
ušt16_t
 
check
;

35 #ifdeà
__ılu¥lus


	@platform/posix/include/poll.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_POLL_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_POLL_H_


	)

22 #ifdeà
__ılu¥lus


26 
	~<¡dšt.h
>

29 
	tnfds_t
;

32 
	spŞlfd
 {

33 
fd
;

34 
ev’ts
;

35 
»v’ts
;

38 
	#POLLIN
 0x001

	)

39 
	#POLLPRI
 0x002

	)

40 
	#POLLOUT
 0x004

	)

41 
	#POLLERR
 0x008

	)

42 
	#POLLHUP
 0x010

	)

43 
	#POLLNVAL
 0x020

	)

44 
	#POLLRDNORM
 0x040

	)

45 
	#POLLRDBAND
 0x080

	)

46 
	#POLLWRNORM
 0x100

	)

47 
	#POLLWRBAND
 0x200

	)

48 
	#POLLRDHUP
 0x400

	)

50 
pŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
);

52 #ifdeà
__ılu¥lus


	@platform/posix/include/sched.h

19 #šşude_Ãxˆ<
sched
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SCHED_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SCHED_H_


	)

24 
	~<š‹º®/sched.h
>

26 #ifdeà
__ılu¥lus


32 
	#CPU_SETSIZE
 
CPU_SET_MAX_CPUS


	)

35 
CpuS‘
 
	tıu_£t_t
;

39 
	#CPU_ZERO
(
£t
è
	`CpuS‘Z”o
((£t))

	)

41 
	#CPU_SET
(
ıu
, 
£t
è
	`CpuS‘AddB™
((ıu), (£t))

	)

43 
	#CPU_CLR
(
ıu
, 
£t
è
	`CpuS‘CË¬B™
((ıu), (£t))

	)

45 
	#CPU_ISSET
(
ıu
, 
£t
è
	`CpuS‘CheckB™
((ıu), (£t))

	)

47 
	#CPU_COUNT
(
£t
è
	`CpuS‘CouÁB™s
((£t))

	)

49 
	#CPU_EQUAL
(
£t1
, 
£t2
è
	`CpuS‘Equ®
((£t1), (£t2))

	)

54 
sched_g‘affš™y
(
pid_t
 
pid
, 
size_t
 
ıu£tsize
, 
ıu_£t_t
 *
mask
);

57 
sched_y›ld
();

59 #ifdeà
__ılu¥lus


	@platform/posix/include/semaphore.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SEMAPHORE_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SEMAPHORE_H_


	)

22 
	~<±h»ad.h
>

23 
	~<time.h
>

25 #ifdeà
__ılu¥lus


29 
	s£m_t
 {

30 
couÁ_
;

31 
±h»ad_mu‹x_t
 
mu_
;

32 
±h»ad_cÚd_t
 
cv_
;

33 } 
	t£m_t
;

37 
£m_š™
(
£m_t
 *
£m
, 
psh¬ed
, 
v®ue
);

38 
£m_de¡roy
(
£m_t
 *
£m
);

39 
£m_po¡
(
£m_t
 *
£m
);

40 
£m_wa™
(
£m_t
 *
£m
);

41 
£m_Œywa™
(
£m_t
 *
£m
);

42 
£m_timedwa™
(
£m_t
 *
£m
, cÚ¡ 
time¥ec
 *
abs_timeout
);

43 
£m_g‘v®ue
(
£m_t
 *
£m
, *
sv®
);

52 #ifdeà
__ılu¥lus


	@platform/posix/include/signal.h

19 #šşude_Ãxˆ<
sigÇl
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SIGNAL_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SIGNAL_H_


	)

24 #ifdeà
__ılu¥lus


28 
	tsig_©omic_t
;

30 #ifdeà
__ılu¥lus


34 
	#SA_NODEFER
 0x08

	)

35 
	#SA_RESETHAND
 0x10

	)

	@platform/posix/include/sys/epoll.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_EPOLL_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_EPOLL_H_


	)

21 #ifdeà
__ılu¥lus


25 
	~<sigÇl.h
>

26 
	~<¡dšt.h
>

29 
	#EPOLLIN
 0x001

	)

30 
	#EPOLLPRI
 0x002

	)

31 
	#EPOLLOUT
 0x004

	)

32 
	#EPOLLMSG
 0x008

	)

33 
	#EPOLLERR
 0x010

	)

34 
	#EPOLLHUP
 0x020

	)

35 
	#EPOLLRDHUP
 0x040

	)

36 
	#EPOLLWAKEUP
 0x080

	)

37 
	#EPOLLONESHOT
 0x100

	)

38 
	#EPOLLET
 0x200

	)

41 
	#EPOLL_CLOEXEC
 0x01

	)

44 
	#EPOLL_CTL_ADD
 1

	)

45 
	#EPOLL_CTL_DEL
 2

	)

46 
	#EPOLL_CTL_MOD
 3

	)

48 
	u•Şl_d©a
 {

49 *
±r
;

50 
fd
;

51 
ušt32_t
 
u32
;

52 
ušt64_t
 
u64
;

53 } 
	t•Şl_d©a_t
;

55 
	s•Şl_ev’t
 {

56 
ušt32_t
 
ev’ts
;

57 
•Şl_d©a_t
 
d©a
;

60 
•Şl_ü—‹
(
size
);

61 
•Şl_ü—‹1
(
æags
);

62 
•Şl_ùl
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
);

63 
•Şl_wa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

64 
timeout
);

66 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/eventfd.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_EVENTFD_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_EVENTFD_H_


	)

22 #ifdeà
__ılu¥lus


26 
	#EFD_CLOEXEC
 0x01

	)

27 
	#EFD_NONBLOCK
 0x02

	)

28 
	#EFD_SEMAPHORE
 0X04

	)

30 
ev’tfd
(
š™v®
, 
æags
);

32 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/inotify.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_INOTIFY_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_INOTIFY_H_


	)

22 
	~<¡dšt.h
>

24 #ifdeà
__ılu¥lus


29 
	#IN_NONBLOCK
 0x01

	)

30 
	#IN_CLOEXEC
 0x02

	)

33 
	#IN_ACCESS
 0x001

	)

34 
	#IN_ATTRIB
 0x002

	)

35 
	#IN_CLOSE_WRITE
 0x004

	)

36 
	#IN_CLOSE_NOWRITE
 0x008

	)

37 
	#IN_CREATE
 0x010

	)

38 
	#IN_DELETE
 0x020

	)

39 
	#IN_DELETE_SELF
 0x040

	)

40 
	#IN_MODIFY
 0x080

	)

41 
	#IN_MOVE_SELF
 0x100

	)

42 
	#IN_MOVED_FROM
 0x200

	)

43 
	#IN_MOVED_TO
 0x400

	)

44 
	#IN_OPEN
 0x800

	)

47 
	#IN_ALL_EVENTS
 \

48 (
IN_ACCESS
 | 
IN_ATTRIB
 | 
IN_CLOSE_WRITE
 | 
IN_CLOSE_NOWRITE
 | 
IN_CREATE
 | \

49 
IN_DELETE
 | 
IN_DELETE_SELF
 | 
IN_MODIFY
 | 
IN_MOVE_SELF
 | 
IN_MOVED_FROM
 | \

50 
IN_MOVED_TO
 | 
IN_OPEN
)

	)

51 
	#IN_MOVE
 (
IN_MOVED_FROM
 | 
IN_MOVED_TO
)

	)

52 
	#IN_CLOSE
 (
IN_CLOSE_WRITE
 | 
IN_CLOSE_NOWRITE
)

	)

55 
	#IN_DONT_FOLLOW
 0x01000

	)

56 
	#IN_EXCL_UNLINK
 0x02000

	)

57 
	#IN_MASK_ADD
 0x04000

	)

58 
	#IN_ONESHOT
 0x08000

	)

59 
	#IN_ONLYDIR
 0x10000

	)

62 
	#IN_IGNORED
 0x020000

	)

63 
	#IN_ISDIR
 0x040000

	)

64 
	#IN_Q_OVERFLOW
 0x080000

	)

65 
	#IN_UNMOUNT
 0x100000

	)

68 
šÙify_š™
();

69 
šÙify_š™1
(
æags
);

70 
šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
);

71 
šÙify_rm_w©ch
(
fd
, 
wd
);

74 
	sšÙify_ev’t
 {

75 
wd
;

76 
ušt32_t
 
mask
;

77 
ušt32_t
 
cook›
;

78 
ušt32_t
 
Ën
;

79 
Çme
[];

82 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/ioctl.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_IOCTL_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_IOCTL_H_


	)

22 
	~<¡dšt.h
>

29 
	#ENCLAVE_STORAGE_IOCTL_TYPE
 0x00880000

	)

32 
	#ENCLAVE_STORAGE_SET_KEY
 (
ENCLAVE_STORAGE_IOCTL_TYPE
 | 0x00000001)

	)

34 
	#TIOCGWINSZ
 0x5413

	)

36 
	swšsize
 {

37 
ušt16_t
 
	mws_row
;

38 
ušt16_t
 
	mws_cŞ
;

39 
ušt16_t
 
	mws_xpix–
;

40 
ušt16_t
 
	mws_ypix–
;

43 
	skey_šfo
 {

44 
ušt32_t
 
	mËngth
;

45 
ušt8_t
 *
	md©a
;

46 } 
__©Œibu‹__
((
·cked
));

48 #ifdeà
__ılu¥lus


52 
ioùl
(
fd
, 
»que¡
, ...);

54 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/mman.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_MMAN_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_MMAN_H_


	)

22 
	~<sys/ty³s.h
>

24 #ifdeà
__ılu¥lus


28 
	#PROT_READ
 0x04

	)

29 
	#PROT_WRITE
 0x02

	)

30 
	#PROT_EXEC
 0x01

	)

32 
	#MAP_FAILED
 ((*)-1)

	)

34 
	#MAP_SHARED
 0x00001

	)

35 
	#MAP_PRIVATE
 0x00002

	)

36 
	#MAP_FIXED
 0x00010

	)

37 
	#MAP_ANONYMOUS
 0x00020

	)

38 
	#MAP_ANON
 
MAP_ANONYMOUS


	)

39 
	#MAP_GROWSDOWN
 0x00100

	)

40 
	#MAP_DENYWRITE
 0x00800

	)

41 
	#MAP_EXECUTABLE
 0x01000

	)

42 
	#MAP_LOCKED
 0x02000

	)

43 
	#MAP_NORESERVE
 0x04000

	)

44 
	#MAP_POPULATE
 0x08000

	)

45 
	#MAP_NONBLOCK
 0x10000

	)

46 
	#MAP_STACK
 0x20000

	)

47 
	#MAP_HUGETLB
 0x40000

	)

49 *
mm­
(*
addr
, 
size_t
 
Ëngth
, 
´Ù
, 
æags
, 
fd
,

50 
off_t
 
off£t
);

52 
munm­
(*
addr
, 
size_t
 
Ëngth
);

55 
mlock
(cÚ¡ *
addr
, 
size_t
 
Ën
);

56 
mlock2
(cÚ¡ *
addr
, 
size_t
 
Ën
, 
æags
);

57 
muÆock
(cÚ¡ *
addr
, 
size_t
 
Ën
);

58 
mlock®l
(
æags
);

59 
muÆock®l
();

61 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/poll.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_POLL_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_POLL_H_


	)

22 
	~<pŞl.h
>

	@platform/posix/include/sys/resource.h

19 #šşude_Ãxˆ<
sys
/
»sourû
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_RESOURCE_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_RESOURCE_H_


	)

24 #ifdeà
__ılu¥lus


28 
	#RLIMIT_CPU
 0

	)

29 
	#RLIMIT_FSIZE
 1

	)

30 
	#RLIMIT_DATA
 2

	)

31 
	#RLIMIT_STACK
 3

	)

32 
	#RLIMIT_CORE
 4

	)

33 
	#RLIMIT_RSS
 5

	)

34 
	#RLIMIT_NPROC
 6

	)

35 
	#RLIMIT_NOFILE
 7

	)

36 
	#RLIMIT_OFILE
 
RLIMIT_NOFILE


	)

37 
	#RLIMIT_MEMLOCK
 8

	)

38 
	#RLIMIT_AS
 9

	)

40 
ušt64_t
 
	t¾im_t
;

42 
	s¾im™
 {

43 
¾im_t
 
¾im_cur
;

44 
¾im_t
 
¾im_max
;

47 
g‘¾im™
(
»sourû
, 
¾im™
 *
¾im
);

48 
£Œlim™
(
»sourû
, cÚ¡ 
¾im™
 *
¾im
);

50 
	#RLIM_INFINITY
 0xffffffffffffffffuLL

	)

52 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/socket.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_SOCKET_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_SOCKET_H_


	)

22 
	~<¡ddef.h
>

23 
	~<¡dšt.h
>

24 
	~<sys/ty³s.h
>

25 
	~<sys/uio.h
>

27 #ifdeà
__ılu¥lus


31 
ušt32_t
 
	t__sockËn_t
;

32 
__sockËn_t
 
	tsockËn_t
;

33 
__§_çmy_t
 
	t§_çmy_t
;

35 
	ssockaddr
 {

36 
§_çmy_t
 
§_çmy
;

37 
§_d©a
[14];

38 } 
__©Œibu‹__
((
·cked
));

40 
	ssockaddr_¡Üage
 {

41 
§_çmy_t
 
ss_çmy
;

42 
ušt64_t
 
__·ddšg
[4];

43 } 
__©Œibu‹__
((
·cked
));

45 
	saddršfo
 {

46 
ai_æags
;

47 
ai_çmy
;

48 
ai_sockty³
;

49 
ai_´ÙocŞ
;

50 
sockËn_t
 
ai_add¾’
;

51 
sockaddr
 *
ai_addr
;

52 *
ai_ÿnÚÇme
;

53 
addršfo
 *
ai_Ãxt
;

54 } 
	taddršfo
;

56 
	smsghdr
 {

57 *
msg_Çme
;

58 
sockËn_t
 
msg_Çm–’
;

59 
iovec
 *
msg_iov
;

60 
size_t
 
msg_iovËn
;

61 *
msg_cÚŒŞ
;

62 
sockËn_t
 
msg_cÚŒŞËn
;

63 
msg_æags
;

66 
acû±
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

67 
bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
);

68 
cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
);

70 
ä“addršfo
(
addršfo
 *
»s
);

72 
g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

73 cÚ¡ 
addršfo
 *
hšts
, addršfØ**
»s
);

75 
g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

76 
sockËn_t
 *
İ’
);

78 
g‘sockÇme
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

80 
g‘³”Çme
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

82 
li¡’
(
sockfd
, 
backlog
);

84 
ssize_t
 
»cv
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
);

86 
ssize_t
 
»cväom
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
,

87 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
);

90 
ssize_t
 
»cvmsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
);

92 
ssize_t
 
£nd
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
);

93 
ssize_t
 
£ndmsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
, 
æags
);

95 
£tsockİt
(
sock‘
, 
Ëv–
, 
İtiÚ_Çme
, cÚ¡ *
İtiÚ_v®ue
,

96 
sockËn_t
 
İtiÚ_Ën
);

99 
shutdown
(
sockfd
, 
how
);

101 
sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

104 
sock‘·œ
(
domaš
, 
ty³
, 
´ÙocŞ
, 
sv
[2]);

107 
	#SOL_SOCKET
 1

	)

109 
	#SO_DEBUG
 1

	)

110 
	#SO_REUSEADDR
 2

	)

111 
	#SO_TYPE
 3

	)

112 
	#SO_ERROR
 4

	)

113 
	#SO_DONTROUTE
 5

	)

114 
	#SO_BROADCAST
 6

	)

115 
	#SO_SNDBUF
 7

	)

116 
	#SO_RCVBUF
 8

	)

117 
	#SO_KEEPALIVE
 9

	)

118 
	#SO_OOBINLINE
 10

	)

119 
	#SO_NO_CHECK
 11

	)

120 
	#SO_PRIORITY
 12

	)

121 
	#SO_LINGER
 13

	)

122 
	#SO_BSDCOMPAT
 14

	)

123 
	#SO_REUSEPORT
 15

	)

124 
	#SO_RCVTIMEO
 20

	)

125 
	#SO_SNDTIMEO
 21

	)

126 
	#SO_SNDBUFFORCE
 32

	)

127 
	#SO_RCVBUFFORCE
 33

	)

130 
	#PF_UNSPEC
 0

131 
	#PF_LOCAL
 1

132 
	#PF_UNIX
 
PF_LOCAL


133 
	#PF_FILE
 
PF_LOCAL


134 
	#PF_INET
 2

135 
	#PF_AX25
 3

136 
	#PF_IPX
 4

137 
	#PF_APPLETALK
 5

138 
	#PF_NETROM
 6

139 
	#PF_BRIDGE
 7

140 
	#PF_ATMPVC
 8

141 
	#PF_X25
 9

142 
	#PF_INET6
 10

143 
	#PF_ROSE
 11

144 
	#PF_DECÃt
 12

145 
	#PF_NETBEUI
 13

146 
	#PF_SECURITY
 14

147 
	#PF_KEY
 15

148 
	#PF_NETLINK
 16

	)

149 
	#PF_ROUTE
 
PF_NETLINK


150 
	#PF_PACKET
 17

151 
	#PF_ASH
 18

152 
	#PF_ECONET
 19

153 
	#PF_ATMSVC
 20

154 
	#PF_RDS
 21

155 
	#PF_SNA
 22

156 
	#PF_IRDA
 23

157 
	#PF_PPPOX
 24

158 
	#PF_WANPIPE
 25

159 
	#PF_LLC
 26

160 
	#PF_CAN
 29

161 
	#PF_TIPC
 30

162 
	#PF_BLUETOOTH
 31

163 
	#PF_IUCV
 32

164 
	#PF_RXRPC
 33

165 
	#PF_ISDN
 34

166 
	#PF_PHONET
 35

167 
	#PF_IEEE802154
 36

168 
	#PF_CAIF
 37

169 
	#PF_ALG
 38

170 
	#PF_NFC
 39

171 
	#PF_VSOCK
 40

172 
	#PF_MAX
 41

173 

	)

175 
	#AF_UNSPEC
 
PF_UNSPEC


	)

176 
	#AF_LOCAL
 
PF_LOCAL


	)

177 
	#AF_UNIX
 
PF_UNIX


	)

178 
	#AF_FILE
 
PF_FILE


	)

179 
	#AF_INET
 
PF_INET


	)

180 
	#AF_AX25
 
PF_AX25


	)

181 
	#AF_IPX
 
PF_IPX


	)

182 
	#AF_APPLETALK
 
PF_APPLETALK


	)

183 
	#AF_NETROM
 
PF_NETROM


	)

184 
	#AF_BRIDGE
 
PF_BRIDGE


	)

185 
	#AF_ATMPVC
 
PF_ATMPVC


	)

186 
	#AF_X25
 
PF_X25


	)

187 
	#AF_INET6
 
PF_INET6


	)

188 
	#AF_ROSE
 
PF_ROSE


	)

189 
	#AF_DECÃt
 
PF_DECÃt


	)

190 
	#AF_NETBEUI
 
PF_NETBEUI


	)

191 
	#AF_SECURITY
 
PF_SECURITY


	)

192 
	#AF_KEY
 
PF_KEY


	)

193 
	#AF_NETLINK
 
PF_NETLINK


	)

194 
	#AF_ROUTE
 
PF_ROUTE


	)

195 
	#AF_PACKET
 
PF_PACKET


	)

196 
	#AF_ASH
 
PF_ASH


	)

197 
	#AF_ECONET
 
PF_ECONET


	)

198 
	#AF_ATMSVC
 
PF_ATMSVC


	)

199 
	#AF_RDS
 
PF_RDS


	)

200 
	#AF_SNA
 
PF_SNA


	)

201 
	#AF_IRDA
 
PF_IRDA


	)

202 
	#AF_PPPOX
 
PF_PPPOX


	)

203 
	#AF_WANPIPE
 
PF_WANPIPE


	)

204 
	#AF_LLC
 
PF_LLC


	)

205 
	#AF_CAN
 
PF_CAN


	)

206 
	#AF_TIPC
 
PF_TIPC


	)

207 
	#AF_BLUETOOTH
 
PF_BLUETOOTH


	)

208 
	#AF_IUCV
 
PF_IUCV


	)

209 
	#AF_RXRPC
 
PF_RXRPC


	)

210 
	#AF_ISDN
 
PF_ISDN


	)

211 
	#AF_PHONET
 
PF_PHONET


	)

212 
	#AF_IEEE802154
 
PF_IEEE802154


	)

213 
	#AF_CAIF
 
PF_CAIF


	)

214 
	#AF_ALG
 
PF_ALG


	)

215 
	#AF_NFC
 
PF_NFC


	)

216 
	#AF_VSOCK
 
PF_VSOCK


	)

217 
	#AF_MAX
 
PF_MAX


	)

219 
	#SOL_RAW
 255

	)

220 
	#SOL_DECNET
 261

	)

221 
	#SOL_X25
 262

	)

222 
	#SOL_PACKET
 263

	)

223 
	#SOL_ATM
 264

224 
	#SOL_AAL
 265

225 
	#SOL_IRDA
 266

	)

229 
MSG_OOB
 = 0x01,

230 
	#MSG_OOB
 
MSG_OOB


	)

231 
MSG_PEEK
 = 0x02,

232 
	#MSG_PEEK
 
MSG_PEEK


	)

233 
MSG_DONTROUTE
 = 0x04,

234 
	#MSG_DONTROUTE
 
MSG_DONTROUTE


	)

235 
MSG_CTRUNC
 = 0x08,

236 
	#MSG_CTRUNC
 
MSG_CTRUNC


	)

237 
MSG_PROXY
 = 0x10,

238 
	#MSG_PROXY
 
MSG_PROXY


	)

239 
MSG_TRUNC
 = 0x20,

240 
	#MSG_TRUNC
 
MSG_TRUNC


	)

241 
MSG_DONTWAIT
 = 0x40,

242 
	#MSG_DONTWAIT
 
MSG_DONTWAIT


	)

243 
MSG_EOR
 = 0x80,

244 
	#MSG_EOR
 
MSG_EOR


	)

245 
MSG_WAITALL
 = 0x100,

246 
	#MSG_WAITALL
 
MSG_WAITALL


	)

247 
MSG_FIN
 = 0x200,

248 
	#MSG_FIN
 
MSG_FIN


	)

249 
MSG_SYN
 = 0x400,

250 
	#MSG_SYN
 
MSG_SYN


	)

251 
MSG_CONFIRM
 = 0x800,

252 
	#MSG_CONFIRM
 
MSG_CONFIRM


	)

253 
MSG_RST
 = 0x1000,

254 
	#MSG_RST
 
MSG_RST


	)

255 
MSG_ERRQUEUE
 = 0x2000,

256 
	#MSG_ERRQUEUE
 
MSG_ERRQUEUE


	)

257 
MSG_NOSIGNAL
 = 0x4000,

258 
	#MSG_NOSIGNAL
 
MSG_NOSIGNAL


	)

259 
MSG_MORE
 = 0x8000,

260 
	#MSG_MORE
 
MSG_MORE


	)

261 
MSG_WAITFORONE
 = 0x10000,

262 
	#MSG_WAITFORONE
 
MSG_WAITFORONE


	)

263 
MSG_FASTOPEN
 = 0x20000000,

264 
	#MSG_FASTOPEN
 
MSG_FASTOPEN


	)

265 
MSG_CMSG_CLOEXEC
 = 0x40000000,

266 
	#MSG_CMSG_CLOEXEC
 
MSG_CMSG_CLOEXEC


	)

270 
	#SOMAXCONN
 128

	)

272 
	#SHUT_RD
 0

	)

273 
	#SHUT_WR
 1

	)

274 
	#SHUT_RDWR
 2

	)

278 
	#SOCK_STREAM
 1

	)

280 
	#SOCK_DGRAM
 2

	)

282 
	#SOCK_RAW
 3

	)

284 
	#SOCK_RDM
 4

	)

286 
	#SOCK_SEQPACKET
 5

	)

288 
	#SOCK_DCCP
 6

	)

291 
	#SOCK_PACKET
 10

	)

297 
	#SOCK_CLOEXEC
 02000000

	)

299 
	#SOCK_NONBLOCK
 00004000

	)

301 
	#SOL_SOCKET
 1

	)

302 
	#SO_REUSEADDR
 2

	)

304 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/stat.h

22 #šşude_Ãxˆ<
sys
/
¡©
.
h
>

24 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_STAT_H_


25 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_STAT_H_


	)

27 #ifdeà
__ılu¥lus


33 
l¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
);

35 
mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
);

37 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/syslog.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_SYSLOG_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_SYSLOG_H_


	)

22 #ifdeà
__ılu¥lus


27 
	#LOG_PID
 0x01

	)

28 
	#LOG_CONS
 0x02

	)

29 
	#LOG_ODELAY
 0x04

	)

30 
	#LOG_NDELAY
 0x08

	)

31 
	#LOG_NOWAIT
 0x10

	)

32 
	#LOG_PERROR
 0x20

	)

35 
	#LOG_EMERG
 0

	)

36 
	#LOG_ALERT
 1

	)

37 
	#LOG_CRIT
 2

	)

38 
	#LOG_ERR
 3

	)

39 
	#LOG_WARNING
 4

	)

40 
	#LOG_NOTICE
 5

	)

41 
	#LOG_INFO
 6

	)

42 
	#LOG_DEBUG
 7

	)

45 
	#LOG_KERN
 (0 << 3)

	)

46 
	#LOG_USER
 (1 << 3)

	)

47 
	#LOG_MAIL
 (2 << 3)

	)

48 
	#LOG_DAEMON
 (3 << 3)

	)

49 
	#LOG_AUTH
 (4 << 3)

	)

50 
	#LOG_SYSLOG
 (5 << 3)

	)

51 
	#LOG_LPR
 (6 << 3)

	)

52 
	#LOG_NEWS
 (7 << 3)

	)

53 
	#LOG_UUCP
 (8 << 3)

	)

54 
	#LOG_CRON
 (9 << 3)

	)

55 
	#LOG_AUTHPRIV
 (10 << 3)

	)

56 
	#LOG_FTP
 (11 << 3)

	)

58 
	#LOG_LOCAL0
 (16 << 3)

	)

59 
	#LOG_LOCAL1
 (17 << 3)

	)

60 
	#LOG_LOCAL2
 (18 << 3)

	)

61 
	#LOG_LOCAL3
 (19 << 3)

	)

62 
	#LOG_LOCAL4
 (20 << 3)

	)

63 
	#LOG_LOCAL5
 (21 << 3)

	)

64 
	#LOG_LOCAL6
 (22 << 3)

	)

65 
	#LOG_LOCAL7
 (23 << 3)

	)

67 
İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
);

69 
sy¦og
(
´iÜ™y
, cÚ¡ *
fÜm©
, ...);

71 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/termios.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_TERMIOS_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_TERMIOS_H_


	)

22 #ifdeà
__ılu¥lus


26 
	tcc_t
;

27 
	t¥“d_t
;

28 
	ttcæag_t
;

30 
	#NCCS
 32

	)

32 
	s‹rmios
 {

33 
tcæag_t
 
c_iæag
;

34 
tcæag_t
 
c_oæag
;

35 
tcæag_t
 
c_cæag
;

36 
tcæag_t
 
c_læag
;

37 
cc_t
 
c_lše
;

38 
cc_t
 
c_cc
[
NCCS
];

39 
¥“d_t
 
c_i¥“d
;

40 
¥“d_t
 
c_o¥“d
;

43 
	#VMIN
 6

	)

44 
	#VTIME
 5

	)

46 
	#BRKINT
 0000002

	)

47 
	#INPCK
 0000020

	)

48 
	#ISTRIP
 0000040

	)

49 
	#ICRNL
 0000400

	)

50 
	#IXON
 0002000

	)

52 
	#OPOST
 0000001

	)

54 
	#CS8
 0000060

	)

56 
	#ECHO
 0000010

	)

58 
	#ISIG
 0000001

	)

59 
	#ICANON
 0000002

	)

60 
	#IEXTEN
 0100000

	)

62 
	#TCSAFLUSH
 2

	)

64 
tcg‘©Œ
(
fdes
, 
‹rmios
 *
‹rmios_p
);

66 
tc£‰r
(
fd
, 
İtiÚ®_aùiÚs
, cÚ¡ 
‹rmios
 *
‹rmios_p
);

68 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/ucontext.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UCONTEXT_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UCONTEXT_H_


	)

22 #ifdeà
__ılu¥lus


26 
	~<¡dšt.h
>

29 
št64_t
 
	tg»g_t
;

32 
	#NGREG
 23

	)

35 
g»g_t
 
	tg»g£t_t
[
NGREG
];

39 
g»g£t_t
 
g»gs
;

40 } 
	tmcÚ‹xt_t
;

43 
	sucÚ‹xt
 {

44 
mcÚ‹xt_t
 
uc_mcÚ‹xt
;

45 } 
	tucÚ‹xt_t
;

47 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/uio.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UIO_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UIO_H_


	)

22 
	~<¡ddef.h
>

23 
	~<sys/ty³s.h
>

25 #ifdeà
__ılu¥lus


29 
	siovec
 {

30 *
iov_ba£
;

31 
size_t
 
iov_Ën
;

34 
ssize_t
 
»adv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
);

36 
ssize_t
 
wr™ev
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
);

38 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/un.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UN_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UN_H_


	)

22 
	~<¡dšt.h
>

23 
	~<sys/cdefs.h
>

25 
	ssockaddr_un
 {

26 
ušt16_t
 
	msun_çmy
;

27 
	msun_·th
[108];

	@platform/posix/include/sys/utsname.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UTSNAME_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_UTSNAME_H_


	)

22 #ifdeà
__ılu¥lus


30 
	#UTSNAME_FIELD_LENGTH
 256

	)

32 
	sut¢ame
 {

33 
sy¢ame
[
UTSNAME_FIELD_LENGTH
];

34 
nod’ame
[
UTSNAME_FIELD_LENGTH
];

35 
»Ëa£
[
UTSNAME_FIELD_LENGTH
];

36 
v”siÚ
[
UTSNAME_FIELD_LENGTH
];

37 
machše
[
UTSNAME_FIELD_LENGTH
];

42 
domašÇme
[
UTSNAME_FIELD_LENGTH
];

45 
uÇme
(
ut¢ame
 *
buf
);

47 #ifdeà
__ılu¥lus


	@platform/posix/include/sys/wait.h

19 #šşude_Ãxˆ<
sys
/
wa™
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYS_WAIT_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYS_WAIT_H_


	)

24 #ifdeà
__ılu¥lus


28 
	#WNOHANG
 1

	)

30 
pid_t
 
wa™3
(*
w¡©us
, 
İtiÚs
, 
ru§ge
 *rusage);

32 #ifdeà
__ılu¥lus


	@platform/posix/include/syslog.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_SYSLOG_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_SYSLOG_H_


	)

22 
	~<sys/sy¦og.h
>

	@platform/posix/include/time.h

19 #šşude_Ãxˆ<
time
.
h
>

21 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_TIME_H_


22 
	#ASYLO_PLATFORM_POSIX_INCLUDE_TIME_H_


	)

24 #ifdeà
__ılu¥lus


30 
Çno¦“p
(cÚ¡ 
time¥ec
 *
»que¡ed
, time¥eø*
»mašd”
);

33 
şock_g‘time
(
şockid_t
 
şock_id
, 
time¥ec
 *
time
);

35 #ifdeà
__ılu¥lus


	@platform/posix/include/ucontext.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_UCONTEXT_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_UCONTEXT_H_


	)

22 
	~<sys/ucÚ‹xt.h
>

	@platform/posix/include/utime.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_INCLUDE_UTIME_H_


20 
	#ASYLO_PLATFORM_POSIX_INCLUDE_UTIME_H_


	)

22 
	~<sys/time.h
>

24 #ifdeà
__ılu¥lus


28 
	sutimbuf
 {

29 
time_t
 
aùime
;

30 
time_t
 
modtime
;

33 
utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
);

35 #ifdeà
__ılu¥lus


	@platform/posix/inotify.cc

19 
	~<sys/šÙify.h
>

20 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
šÙify_š™1
(
æags
) {

28 
boŞ
 
nÚ_block
 = 
æags
 & 
IN_NONBLOCK
;

29  
IOMªag”
::
G‘In¡ªû
().
InÙifyIn™
(
nÚ_block
);

32 
šÙify_š™
(è{  
šÙify_š™1
(0); }

34 
šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
) {

35  
IOMªag”
::
G‘In¡ªû
().
InÙifyAddW©ch
(
fd
, 
·thÇme
, 
mask
);

38 
šÙify_rm_w©ch
(
fd
, 
wd
) {

39  
IOMªag”
::
G‘In¡ªû
().
InÙifyRmW©ch
(
fd
, 
wd
);

	@platform/posix/inotify.cc

19 
	~<sys/šÙify.h
>

20 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
šÙify_š™1
(
æags
) {

28 
boŞ
 
nÚ_block
 = 
æags
 & 
IN_NONBLOCK
;

29  
IOMªag”
::
G‘In¡ªû
().
InÙifyIn™
(
nÚ_block
);

32 
šÙify_š™
(è{  
šÙify_š™1
(0); }

34 
šÙify_add_w©ch
(
fd
, cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
) {

35  
IOMªag”
::
G‘In¡ªû
().
InÙifyAddW©ch
(
fd
, 
·thÇme
, 
mask
);

38 
šÙify_rm_w©ch
(
fd
, 
wd
) {

39  
IOMªag”
::
G‘In¡ªû
().
InÙifyRmW©ch
(
fd
, 
wd
);

	@platform/posix/io/cwd_test.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<lim™s.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<sys/ioùl.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/sysmaüos.h
>

26 
	~<uni¡d.h
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

32 
	~"asylo/‹¡/ut/‹¡_æags.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
	gusšg
 ::
‹¡šg
::
IsNuÎ
;

40 
TEST
(
CwdTe¡
, 
Sim¶eChªge
) {

41 
	gbuf
[
PATH_MAX
];

42 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

43 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

44 
EXPECT_EQ
(
chdœ
("/usr"), 0);

45 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

49 
TEST
(
CwdTe¡
, 
R–©iveChªge
) {

50 
	gbuf
[
PATH_MAX
];

51 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

52 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

53 
EXPECT_EQ
(
chdœ
("../usr"), 0);

54 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

58 
TEST
(
CwdTe¡
, 
AbsŞu‹BackChªge
) {

59 
	gbuf
[
PATH_MAX
];

60 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

61 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

62 
EXPECT_EQ
(
chdœ
("/etc/../usr"), 0);

63 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

67 
TEST
(
CwdTe¡
, 
R–©iveBackChªge
) {

68 
	gbuf
[
PATH_MAX
];

69 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

70 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

71 
EXPECT_EQ
(
chdœ
("../etc/../usr"), 0);

72 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

76 
TEST
(
CwdTe¡
, 
CrossHªdËrChªge
) {

77 
	gbuf
[
PATH_MAX
];

78 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

79 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

80 
EXPECT_EQ
(
chdœ
("../dev/random"), -1);

81 
EXPECT_EQ
(
”ºo
, 
EACCES
);

82 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

86 
TEST
(
CwdTe¡
, 
Pa¡RoÙChªge
) {

87 
	gbuf
[
PATH_MAX
];

88 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

89 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

90 
EXPECT_EQ
(
chdœ
("/../../"), 0);

91 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/");

95 
TEST
(
CwdTe¡
, 
Em±yChªge
) {

96 
	gbuf
[
PATH_MAX
];

97 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

98 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

99 
EXPECT_EQ
(
chdœ
(""), -1);

100 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

101 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

106 
TEST
(
CwdTe¡
, 
CrossHªdËrResŞve
) {

107 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

108 
EXPECT_EQ
(
İ’
("../dev/¿ndom", 
O_RDONLY
), -1);

109 
EXPECT_EQ
(
”ºo
, 
EACCES
);

113 
TEST
(
CwdTe¡
, 
Em±yResŞve
) {

114 
EXPECT_EQ
(
İ’
("", 
O_RDONLY
), -1);

115 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

117 
	gbuf
[
PATH_MAX
];

118 
EXPECT_THAT
(
»®·th
("", 
buf
), 
IsNuÎ
());

119 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

123 
TEST
(
CwdTe¡
, 
R–©iveAbsŞu‹ResŞve
) {

125 
ušt8_t
 
	gd©a
[32];

126 
ASSERT_EQ
(
RAND_by‹s
(
d©a
, (data)), 1);

127 
	gfd
 = 
İ’
(
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/cwd‹¡").
c_¡r
(),

128 
O_RDWR
 | 
O_CREAT
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

129 
ASSERT_NE
(
fd
, -1);

130 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

131 
ASSERT_NE
(
wr™e
(
fd
, 
d©a
, (data)), -1);

134 
EXPECT_EQ
(
chdœ
(
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/foo").
c_¡r
()), 0);

135 
	gfd
 = 
İ’
("../cwd‹¡", 
O_RDONLY
);

136 
ASSERT_NE
(
fd
, -1);

137 
	gfd_şo£r
.
»£t
(
fd
);

138 
ušt8_t
 
	g»suÉ
[32];

139 
ASSERT_NE
(
»ad
(
fd
, 
»suÉ
, (result)), -1);

140 
EXPECT_EQ
(
¡d
::
¡ršg
(&
d©a
[0], &data[(data)]),

141 
¡d
::
¡ršg
(&
»suÉ
[0], &result[(result)]));

145 
TEST
(
CwdTe¡
, 
S¶™HªdËrResŞve
) {

146 
	gfd
 = 
İ’
("/dev/nÙ¿ndom/../u¿ndom", 
O_RDONLY
);

147 
ASSERT_NE
(
fd
, -1);

148 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

157 
EXPECT_EQ
(
ioùl
(
fd
, 0, 0), -1);

158 
EXPECT_EQ
(
”ºo
, 
ENOSYS
);

163 
TEST
(
CwdTe¡
, 
S¶™BackHªdËrResŞve
) {

164 
	gfd
 = 
İ’
("/dev/¿ndom/../u¿ndom", 
O_RDONLY
);

165 
ASSERT_NE
(
fd
, -1);

166 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

175 
EXPECT_EQ
(
ioùl
(
fd
, 0, 0), -1);

176 
EXPECT_EQ
(
”ºo
, 
ENOSYS
);

179 
cÚ¡ex´
 
	gu¿ndom_majÜ
 = 1;

180 
cÚ¡ex´
 
	gu¿ndom_mšÜ
 = 9;

181 
¡©
 
	g¡
;

182 
EXPECT_EQ
(
f¡©
(
fd
, &
¡
), 0);

183 
EXPECT_EQ
(
¡
.
¡_rdev
, 
makedev
(
u¿ndom_majÜ
, 
u¿ndom_mšÜ
));

	@platform/posix/io/cwd_test.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<lim™s.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<sys/ioùl.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/sysmaüos.h
>

26 
	~<uni¡d.h
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

32 
	~"asylo/‹¡/ut/‹¡_æags.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
	gusšg
 ::
‹¡šg
::
IsNuÎ
;

40 
TEST
(
CwdTe¡
, 
Sim¶eChªge
) {

41 
	gbuf
[
PATH_MAX
];

42 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

43 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

44 
EXPECT_EQ
(
chdœ
("/usr"), 0);

45 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

49 
TEST
(
CwdTe¡
, 
R–©iveChªge
) {

50 
	gbuf
[
PATH_MAX
];

51 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

52 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

53 
EXPECT_EQ
(
chdœ
("../usr"), 0);

54 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

58 
TEST
(
CwdTe¡
, 
AbsŞu‹BackChªge
) {

59 
	gbuf
[
PATH_MAX
];

60 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

61 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

62 
EXPECT_EQ
(
chdœ
("/etc/../usr"), 0);

63 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

67 
TEST
(
CwdTe¡
, 
R–©iveBackChªge
) {

68 
	gbuf
[
PATH_MAX
];

69 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

70 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

71 
EXPECT_EQ
(
chdœ
("../etc/../usr"), 0);

72 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/usr");

76 
TEST
(
CwdTe¡
, 
CrossHªdËrChªge
) {

77 
	gbuf
[
PATH_MAX
];

78 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

79 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

80 
EXPECT_EQ
(
chdœ
("../dev/random"), -1);

81 
EXPECT_EQ
(
”ºo
, 
EACCES
);

82 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

86 
TEST
(
CwdTe¡
, 
Pa¡RoÙChªge
) {

87 
	gbuf
[
PATH_MAX
];

88 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

89 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

90 
EXPECT_EQ
(
chdœ
("/../../"), 0);

91 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/");

95 
TEST
(
CwdTe¡
, 
Em±yChªge
) {

96 
	gbuf
[
PATH_MAX
];

97 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

98 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

99 
EXPECT_EQ
(
chdœ
(""), -1);

100 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

101 
EXPECT_STREQ
(
g‘cwd
(
buf
, (buf)), "/tmp");

106 
TEST
(
CwdTe¡
, 
CrossHªdËrResŞve
) {

107 
EXPECT_EQ
(
chdœ
("/tmp"), 0);

108 
EXPECT_EQ
(
İ’
("../dev/¿ndom", 
O_RDONLY
), -1);

109 
EXPECT_EQ
(
”ºo
, 
EACCES
);

113 
TEST
(
CwdTe¡
, 
Em±yResŞve
) {

114 
EXPECT_EQ
(
İ’
("", 
O_RDONLY
), -1);

115 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

117 
	gbuf
[
PATH_MAX
];

118 
EXPECT_THAT
(
»®·th
("", 
buf
), 
IsNuÎ
());

119 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

123 
TEST
(
CwdTe¡
, 
R–©iveAbsŞu‹ResŞve
) {

125 
ušt8_t
 
	gd©a
[32];

126 
ASSERT_EQ
(
RAND_by‹s
(
d©a
, (data)), 1);

127 
	gfd
 = 
İ’
(
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/cwd‹¡").
c_¡r
(),

128 
O_RDWR
 | 
O_CREAT
, 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

129 
ASSERT_NE
(
fd
, -1);

130 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

131 
ASSERT_NE
(
wr™e
(
fd
, 
d©a
, (data)), -1);

134 
EXPECT_EQ
(
chdœ
(
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/foo").
c_¡r
()), 0);

135 
	gfd
 = 
İ’
("../cwd‹¡", 
O_RDONLY
);

136 
ASSERT_NE
(
fd
, -1);

137 
	gfd_şo£r
.
»£t
(
fd
);

138 
ušt8_t
 
	g»suÉ
[32];

139 
ASSERT_NE
(
»ad
(
fd
, 
»suÉ
, (result)), -1);

140 
EXPECT_EQ
(
¡d
::
¡ršg
(&
d©a
[0], &data[(data)]),

141 
¡d
::
¡ršg
(&
»suÉ
[0], &result[(result)]));

145 
TEST
(
CwdTe¡
, 
S¶™HªdËrResŞve
) {

146 
	gfd
 = 
İ’
("/dev/nÙ¿ndom/../u¿ndom", 
O_RDONLY
);

147 
ASSERT_NE
(
fd
, -1);

148 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

157 
EXPECT_EQ
(
ioùl
(
fd
, 0, 0), -1);

158 
EXPECT_EQ
(
”ºo
, 
ENOSYS
);

163 
TEST
(
CwdTe¡
, 
S¶™BackHªdËrResŞve
) {

164 
	gfd
 = 
İ’
("/dev/¿ndom/../u¿ndom", 
O_RDONLY
);

165 
ASSERT_NE
(
fd
, -1);

166 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

175 
EXPECT_EQ
(
ioùl
(
fd
, 0, 0), -1);

176 
EXPECT_EQ
(
”ºo
, 
ENOSYS
);

179 
cÚ¡ex´
 
	gu¿ndom_majÜ
 = 1;

180 
cÚ¡ex´
 
	gu¿ndom_mšÜ
 = 9;

181 
¡©
 
	g¡
;

182 
EXPECT_EQ
(
f¡©
(
fd
, &
¡
), 0);

183 
EXPECT_EQ
(
¡
.
¡_rdev
, 
makedev
(
u¿ndom_majÜ
, 
u¿ndom_mšÜ
));

	@platform/posix/io/epoll_test.cc

19 
	~<sys/•Şl.h
>

20 
	~<uni¡d.h
>

21 
	~<chrÚo
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 cÚ¡ *
	gkTe¡SŒšg
 = "Willhis gohroughhe…ipe?";

33 
cÚ¡ex´
 
size_t
 
	gkBufãrSize
 = 1024;

34 
cÚ¡ex´
 
size_t
 
	gkNumPes
 = 8;

35 
cÚ¡ex´
 
	gkR—d
 = 0;

36 
cÚ¡ex´
 
	gkWr™e
 = 1;

38 şas 
	cEpŞlTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

39 
´Ùeùed
:

40 
Stus
 
Wr™eD©a
(
fd
, cÚ¡ *
¡r
) {

41 
ssize_t
 
	gnum_by‹s_Ëá
 = 
¡¾’
(
¡r
);

42 
	gnum_by‹s_Ëá
 > 0) {

43 
ssize_t
 
	gnum_by‹s_wr™‹n
 = 
wr™e
(
fd
, 
¡r
, 
num_by‹s_Ëá
);

44 ià(
	gnum_by‹s_wr™‹n
 < 0) {

45  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "write() failed");

47 
	gnum_by‹s_Ëá
 -ğ
num_by‹s_wr™‹n
;

49  
	gStus
::
OkStus
();

52 
Stus
 
R—dD©a
(
fd
, *
buf
, 
size_t
 
by‹s_to_»ad
) {

53 
	gby‹s_to_»ad
 > 0) {

54 
	gnum_by‹s_»ad
 = 
»ad
(
fd
, 
buf
, 
by‹s_to_»ad
);

55 ià(
	gnum_by‹s_»ad
 < 0) {

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "read() failed");

58 
	gby‹s_to_»ad
 -ğ
num_by‹s_»ad
;

60  
	gStus
::
OkStus
();

63 
Wr™eToPes
(cÚ¡ 
¡d
::
veùÜ
<> &
wr™e_fds
, cÚ¡ *
¡r
) {

64 
	gfd
 : 
wr™e_fds
) {

65 
EXPECT_THAT
(
Wr™eD©a
(
fd
, 
¡r
), 
IsOk
());

69 
Regi¡”Fds
(
•fd
, 
pe_idx
, 
add™iÚ®_æags
 = 0) {

70 
size_t
 
i
 = 0; 
	gi
 < 
	gkNumPes
; ++i) {

72 
•Şl_ev’t
 
	gev
;

73 
	gev
.
	gev’ts
 = 
pe_idx
 =ğ0 ? 
EPOLLIN
 : 
EPOLLOUT
;

74 
	gev
.
	gev’ts
 |ğ
add™iÚ®_æags
;

75 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
pe_idx
];

76 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_ADD
, 
fd_·œs_
[
i
][
pe_idx
], &
ev
),

81 
In™ŸlizePes
() {

82 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

83 
ASSERT_EQ
(
pe
(
fd_·œs_
[
i
]), 0);

87 
Clo£Pes
() {

88 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

89 
şo£
(
fd_·œs_
[
i
][0]);

90 
şo£
(
fd_·œs_
[
i
][1]);

95 
V”ifyR—dEv’ts
(
•fd
) {

96 
•Şl_ev’t
 
	gev’ts
[
kNumPes
];

97 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 
kNumPes
, -1);

98 
ASSERT_NE
(
num_ev’ts
, -1);

99 
EXPECT_EQ
(
num_ev’ts
, 
kNumPes
 / 2);

100 
	gab¦
::
æ©_hash_£t
<> 
»ad_fds
;

101 
	gi
 = 0; i < 
	gnum_ev’ts
; ++i) {

103 
ASSERT_EQ
(
»ad_fds
.
fšd
(
ev’ts
[
i
].
d©a
.
fd
),„—d_fds.
’d
());

104 
	g»ad_fds
.
š£¹
(
ev’ts
[
i
].
d©a
.
fd
);

107 
	gi
 = 0; i < 
	gkNumPes
 / 2; ++i) {

108 
ASSERT_NE
(
»ad_fds
.
fšd
(
fd_·œs_
[
i
][
kR—d
]),„—d_fds.
’d
());

111 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

112 
ASSERT_EQ
(
»ad_fds
.
fšd
(
fd_·œs_
[
i
][
kR—d
]),„—d_fds.
’d
());

116 
BasicEpŞlTe¡
(
boŞ
 
edge_Œigg”ed
) {

117 
In™ŸlizePes
();

118 
	g•fd
 = 
•Şl_ü—‹
(1);

119 
ASSERT_NE
(
•fd
, -1);

121 ià(
	gedge_Œigg”ed
) {

122 
Regi¡”Fds
(
•fd
, 
kR—d
, 
EPOLLET
);

124 
Regi¡”Fds
(
•fd
, 
kR—d
);

126 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

128 
	gi
 = 0; i < 
	gkNumPes
 / 2; ++i) {

129 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

131 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

132 
V”ifyR—dEv’ts
(
•fd
);

133 
ASSERT_EQ
(
şo£
(
•fd
), 0);

134 
Clo£Pes
();

137 
TimeoutTe¡
(
¦“p_dur
, 
timeout
) {

138 
In™ŸlizePes
();

139 
	g•fd
 = 
•Şl_ü—‹
(1);

140 
ASSERT_NE
(
•fd
, -1);

142 
Regi¡”Fds
(
•fd
, 
kR—d
);

143 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

145 
	gi
 = 0; i < 
	gkNumPes
 / 2; ++i) {

146 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

148 
	g¡d
::
th»ad
 
wr™”
([
wr™e_fds
, 
¦“p_dur
, 
this
]() {

149 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
¦“p_dur
));

150 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

152 
•Şl_ev’t
 
	gev’ts
[
kNumPes
];

153 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 
kNumPes
, 
timeout
);

154 
	gwr™”
.
još
();

155 
ASSERT_NE
(
num_ev’ts
, -1);

156 ià(
	gtimeout
 < 
	g¦“p_dur
) {

157 
EXPECT_EQ
(
num_ev’ts
, 0);

159 
EXPECT_GT
(
num_ev’ts
, 0);

161 
Clo£Pes
();

164 
Lev–EdgeBehaviÜTe¡
(
boŞ
 
edge_Œigg”ed
) {

165 
size_t
 
	g‹¡_¡r_Ën
 = 
¡¾’
(
kTe¡SŒšg
);

166 
	gfds
[2];

167 
ASSERT_EQ
(
pe
(
fds
), 0);

168 
	g•fd
 = 
•Şl_ü—‹
(1);

169 
ASSERT_NE
(
•fd
, -1);

170 
•Şl_ev’t
 
	gev
;

171 
	gev
.
	gev’ts
 = 
EPOLLIN
;

172 ià(
	gedge_Œigg”ed
è
	gev
.
	gev’ts
 |ğ
EPOLLET
;

173 
	gev
.
	gd©a
.
	gfd
 = 
fds
[
kR—d
];

174 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_ADD
, 
fds
[
kR—d
], &
ev
), -1);

175 
EXPECT_THAT
(
Wr™eD©a
(
fds
[
kWr™e
], 
kTe¡SŒšg
), 
IsOk
());

176 
•Şl_ev’t
 
	gev’ts
[1];

177 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 1, -1);

178 
ASSERT_EQ
(
num_ev’ts
, 1);

180 
	gbuf
[
kBufãrSize
];

181 
EXPECT_THAT
(
R—dD©a
(
fds
[
kR—d
], 
buf
, 
‹¡_¡r_Ën
 / 2), 
IsOk
());

182 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 1, 0);

183 ià(
	gedge_Œigg”ed
) {

185 
ASSERT_EQ
(
num_ev’ts
, 0);

188 
ASSERT_EQ
(
num_ev’ts
, 1);

190 
ASSERT_EQ
(
şo£
(
•fd
), 0);

191 
ASSERT_EQ
(
şo£
(
fds
[
kR—d
]), 0);

192 
ASSERT_EQ
(
şo£
(
fds
[
kWr™e
]), 0);

195 
	gfd_·œs_
[
kNumPes
][2];

198 
TEST_F
(
EpŞlTe¡
, 
Lev–Trigg”edBasic
è{ 
BasicEpŞlTe¡
(
çl£
); }

200 
TEST_F
(
EpŞlTe¡
, 
EdgeTrigg”edBasic
è{ 
BasicEpŞlTe¡
(
Œue
); }

202 
TEST_F
(
EpŞlTe¡
, 
EpŞlWa™TimeoutNÙExûeded
è{ 
TimeoutTe¡
(10, 2000); }

204 
TEST_F
(
EpŞlTe¡
, 
EpŞlWa™TimeoutExûeded
è{ 
TimeoutTe¡
(500, 50); }

206 
TEST_F
(
EpŞlTe¡
, 
EpŞlCD–
) {

207 
In™ŸlizePes
();

208 
	g•fd
 = 
•Şl_ü—‹
(1);

209 
ASSERT_NE
(
•fd
, -1);

211 
Regi¡”Fds
(
•fd
, 
kR—d
);

213 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

214 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_DEL
, 
fd_·œs_
[
i
][
kR—d
], 
nuÎ±r
), -1);

216 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

218 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

219 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

221 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

222 
V”ifyR—dEv’ts
(
•fd
);

223 
ASSERT_EQ
(
şo£
(
•fd
), 0);

224 
Clo£Pes
();

227 
TEST_F
(
EpŞlTe¡
, 
EpŞlCMod
) {

228 
In™ŸlizePes
();

229 
	g•fd
 = 
•Şl_ü—‹
(1);

230 
ASSERT_NE
(
•fd
, -1);

232 
Regi¡”Fds
(
•fd
, 
kR—d
);

235 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

236 
•Şl_ev’t
 
	gev
;

237 
	gev
.
	gev’ts
 = 
EPOLLOUT
;

238 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
kR—d
];

239 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_MOD
, 
fd_·œs_
[
i
][
kR—d
], &
ev
), -1);

241 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

243 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

244 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

246 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

247 
V”ifyR—dEv’ts
(
•fd
);

248 
ASSERT_EQ
(
şo£
(
•fd
), 0);

249 
Clo£Pes
();

252 
TEST_F
(
EpŞlTe¡
, 
EpŞlCMix
) {

253 
In™ŸlizePes
();

254 
	g•fd
 = 
•Şl_ü—‹
(1);

255 
ASSERT_NE
(
•fd
, -1);

257 
Regi¡”Fds
(
•fd
, 
kR—d
);

259 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

260 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_DEL
, 
fd_·œs_
[
i
][
kR—d
], 
nuÎ±r
), -1);

263 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

264 
•Şl_ev’t
 
	gev
;

265 
	gev
.
	gev’ts
 = 
EPOLLIN
;

266 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
kR—d
];

267 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_ADD
, 
fd_·œs_
[
i
][
kR—d
], &
ev
), -1);

271 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

272 
•Şl_ev’t
 
	gev
;

273 
	gev
.
	gev’ts
 = 
EPOLLOUT
;

274 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
kR—d
];

275 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_MOD
, 
fd_·œs_
[
i
][
kR—d
], &
ev
), -1);

277 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

279 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

280 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

282 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

283 
V”ifyR—dEv’ts
(
•fd
);

284 
ASSERT_EQ
(
şo£
(
•fd
), 0);

285 
Clo£Pes
();

288 
TEST_F
(
EpŞlTe¡
, 
Lev–Trigg”edBehaviÜ
è{ 
Lev–EdgeBehaviÜTe¡
(
çl£
); }

290 
TEST_F
(
EpŞlTe¡
, 
EdgeTrigg”edBehaviÜ
è{ 
Lev–EdgeBehaviÜTe¡
(
Œue
); }

	@platform/posix/io/epoll_test.cc

19 
	~<sys/•Şl.h
>

20 
	~<uni¡d.h
>

21 
	~<chrÚo
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 cÚ¡ *
	gkTe¡SŒšg
 = "Willhis gohroughhe…ipe?";

33 
cÚ¡ex´
 
size_t
 
	gkBufãrSize
 = 1024;

34 
cÚ¡ex´
 
size_t
 
	gkNumPes
 = 8;

35 
cÚ¡ex´
 
	gkR—d
 = 0;

36 
cÚ¡ex´
 
	gkWr™e
 = 1;

38 şas 
	cEpŞlTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

39 
´Ùeùed
:

40 
Stus
 
Wr™eD©a
(
fd
, cÚ¡ *
¡r
) {

41 
ssize_t
 
	gnum_by‹s_Ëá
 = 
¡¾’
(
¡r
);

42 
	gnum_by‹s_Ëá
 > 0) {

43 
ssize_t
 
	gnum_by‹s_wr™‹n
 = 
wr™e
(
fd
, 
¡r
, 
num_by‹s_Ëá
);

44 ià(
	gnum_by‹s_wr™‹n
 < 0) {

45  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "write() failed");

47 
	gnum_by‹s_Ëá
 -ğ
num_by‹s_wr™‹n
;

49  
	gStus
::
OkStus
();

52 
Stus
 
R—dD©a
(
fd
, *
buf
, 
size_t
 
by‹s_to_»ad
) {

53 
	gby‹s_to_»ad
 > 0) {

54 
	gnum_by‹s_»ad
 = 
»ad
(
fd
, 
buf
, 
by‹s_to_»ad
);

55 ià(
	gnum_by‹s_»ad
 < 0) {

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "read() failed");

58 
	gby‹s_to_»ad
 -ğ
num_by‹s_»ad
;

60  
	gStus
::
OkStus
();

63 
Wr™eToPes
(cÚ¡ 
¡d
::
veùÜ
<> &
wr™e_fds
, cÚ¡ *
¡r
) {

64 
	gfd
 : 
wr™e_fds
) {

65 
EXPECT_THAT
(
Wr™eD©a
(
fd
, 
¡r
), 
IsOk
());

69 
Regi¡”Fds
(
•fd
, 
pe_idx
, 
add™iÚ®_æags
 = 0) {

70 
size_t
 
i
 = 0; 
	gi
 < 
	gkNumPes
; ++i) {

72 
•Şl_ev’t
 
	gev
;

73 
	gev
.
	gev’ts
 = 
pe_idx
 =ğ0 ? 
EPOLLIN
 : 
EPOLLOUT
;

74 
	gev
.
	gev’ts
 |ğ
add™iÚ®_æags
;

75 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
pe_idx
];

76 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_ADD
, 
fd_·œs_
[
i
][
pe_idx
], &
ev
),

81 
In™ŸlizePes
() {

82 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

83 
ASSERT_EQ
(
pe
(
fd_·œs_
[
i
]), 0);

87 
Clo£Pes
() {

88 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

89 
şo£
(
fd_·œs_
[
i
][0]);

90 
şo£
(
fd_·œs_
[
i
][1]);

95 
V”ifyR—dEv’ts
(
•fd
) {

96 
•Şl_ev’t
 
	gev’ts
[
kNumPes
];

97 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 
kNumPes
, -1);

98 
ASSERT_NE
(
num_ev’ts
, -1);

99 
EXPECT_EQ
(
num_ev’ts
, 
kNumPes
 / 2);

100 
	gab¦
::
æ©_hash_£t
<> 
»ad_fds
;

101 
	gi
 = 0; i < 
	gnum_ev’ts
; ++i) {

103 
ASSERT_EQ
(
»ad_fds
.
fšd
(
ev’ts
[
i
].
d©a
.
fd
),„—d_fds.
’d
());

104 
	g»ad_fds
.
š£¹
(
ev’ts
[
i
].
d©a
.
fd
);

107 
	gi
 = 0; i < 
	gkNumPes
 / 2; ++i) {

108 
ASSERT_NE
(
»ad_fds
.
fšd
(
fd_·œs_
[
i
][
kR—d
]),„—d_fds.
’d
());

111 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

112 
ASSERT_EQ
(
»ad_fds
.
fšd
(
fd_·œs_
[
i
][
kR—d
]),„—d_fds.
’d
());

116 
BasicEpŞlTe¡
(
boŞ
 
edge_Œigg”ed
) {

117 
In™ŸlizePes
();

118 
	g•fd
 = 
•Şl_ü—‹
(1);

119 
ASSERT_NE
(
•fd
, -1);

121 ià(
	gedge_Œigg”ed
) {

122 
Regi¡”Fds
(
•fd
, 
kR—d
, 
EPOLLET
);

124 
Regi¡”Fds
(
•fd
, 
kR—d
);

126 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

128 
	gi
 = 0; i < 
	gkNumPes
 / 2; ++i) {

129 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

131 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

132 
V”ifyR—dEv’ts
(
•fd
);

133 
ASSERT_EQ
(
şo£
(
•fd
), 0);

134 
Clo£Pes
();

137 
TimeoutTe¡
(
¦“p_dur
, 
timeout
) {

138 
In™ŸlizePes
();

139 
	g•fd
 = 
•Şl_ü—‹
(1);

140 
ASSERT_NE
(
•fd
, -1);

142 
Regi¡”Fds
(
•fd
, 
kR—d
);

143 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

145 
	gi
 = 0; i < 
	gkNumPes
 / 2; ++i) {

146 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

148 
	g¡d
::
th»ad
 
wr™”
([
wr™e_fds
, 
¦“p_dur
, 
this
]() {

149 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
¦“p_dur
));

150 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

152 
•Şl_ev’t
 
	gev’ts
[
kNumPes
];

153 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 
kNumPes
, 
timeout
);

154 
	gwr™”
.
još
();

155 
ASSERT_NE
(
num_ev’ts
, -1);

156 ià(
	gtimeout
 < 
	g¦“p_dur
) {

157 
EXPECT_EQ
(
num_ev’ts
, 0);

159 
EXPECT_GT
(
num_ev’ts
, 0);

161 
Clo£Pes
();

164 
Lev–EdgeBehaviÜTe¡
(
boŞ
 
edge_Œigg”ed
) {

165 
size_t
 
	g‹¡_¡r_Ën
 = 
¡¾’
(
kTe¡SŒšg
);

166 
	gfds
[2];

167 
ASSERT_EQ
(
pe
(
fds
), 0);

168 
	g•fd
 = 
•Şl_ü—‹
(1);

169 
ASSERT_NE
(
•fd
, -1);

170 
•Şl_ev’t
 
	gev
;

171 
	gev
.
	gev’ts
 = 
EPOLLIN
;

172 ià(
	gedge_Œigg”ed
è
	gev
.
	gev’ts
 |ğ
EPOLLET
;

173 
	gev
.
	gd©a
.
	gfd
 = 
fds
[
kR—d
];

174 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_ADD
, 
fds
[
kR—d
], &
ev
), -1);

175 
EXPECT_THAT
(
Wr™eD©a
(
fds
[
kWr™e
], 
kTe¡SŒšg
), 
IsOk
());

176 
•Şl_ev’t
 
	gev’ts
[1];

177 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 1, -1);

178 
ASSERT_EQ
(
num_ev’ts
, 1);

180 
	gbuf
[
kBufãrSize
];

181 
EXPECT_THAT
(
R—dD©a
(
fds
[
kR—d
], 
buf
, 
‹¡_¡r_Ën
 / 2), 
IsOk
());

182 
	gnum_ev’ts
 = 
•Şl_wa™
(
•fd
, 
ev’ts
, 1, 0);

183 ià(
	gedge_Œigg”ed
) {

185 
ASSERT_EQ
(
num_ev’ts
, 0);

188 
ASSERT_EQ
(
num_ev’ts
, 1);

190 
ASSERT_EQ
(
şo£
(
•fd
), 0);

191 
ASSERT_EQ
(
şo£
(
fds
[
kR—d
]), 0);

192 
ASSERT_EQ
(
şo£
(
fds
[
kWr™e
]), 0);

195 
	gfd_·œs_
[
kNumPes
][2];

198 
TEST_F
(
EpŞlTe¡
, 
Lev–Trigg”edBasic
è{ 
BasicEpŞlTe¡
(
çl£
); }

200 
TEST_F
(
EpŞlTe¡
, 
EdgeTrigg”edBasic
è{ 
BasicEpŞlTe¡
(
Œue
); }

202 
TEST_F
(
EpŞlTe¡
, 
EpŞlWa™TimeoutNÙExûeded
è{ 
TimeoutTe¡
(10, 2000); }

204 
TEST_F
(
EpŞlTe¡
, 
EpŞlWa™TimeoutExûeded
è{ 
TimeoutTe¡
(500, 50); }

206 
TEST_F
(
EpŞlTe¡
, 
EpŞlCD–
) {

207 
In™ŸlizePes
();

208 
	g•fd
 = 
•Şl_ü—‹
(1);

209 
ASSERT_NE
(
•fd
, -1);

211 
Regi¡”Fds
(
•fd
, 
kR—d
);

213 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

214 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_DEL
, 
fd_·œs_
[
i
][
kR—d
], 
nuÎ±r
), -1);

216 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

218 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

219 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

221 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

222 
V”ifyR—dEv’ts
(
•fd
);

223 
ASSERT_EQ
(
şo£
(
•fd
), 0);

224 
Clo£Pes
();

227 
TEST_F
(
EpŞlTe¡
, 
EpŞlCMod
) {

228 
In™ŸlizePes
();

229 
	g•fd
 = 
•Şl_ü—‹
(1);

230 
ASSERT_NE
(
•fd
, -1);

232 
Regi¡”Fds
(
•fd
, 
kR—d
);

235 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

236 
•Şl_ev’t
 
	gev
;

237 
	gev
.
	gev’ts
 = 
EPOLLOUT
;

238 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
kR—d
];

239 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_MOD
, 
fd_·œs_
[
i
][
kR—d
], &
ev
), -1);

241 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

243 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

244 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

246 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

247 
V”ifyR—dEv’ts
(
•fd
);

248 
ASSERT_EQ
(
şo£
(
•fd
), 0);

249 
Clo£Pes
();

252 
TEST_F
(
EpŞlTe¡
, 
EpŞlCMix
) {

253 
In™ŸlizePes
();

254 
	g•fd
 = 
•Şl_ü—‹
(1);

255 
ASSERT_NE
(
•fd
, -1);

257 
Regi¡”Fds
(
•fd
, 
kR—d
);

259 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

260 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_DEL
, 
fd_·œs_
[
i
][
kR—d
], 
nuÎ±r
), -1);

263 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

264 
•Şl_ev’t
 
	gev
;

265 
	gev
.
	gev’ts
 = 
EPOLLIN
;

266 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
kR—d
];

267 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_ADD
, 
fd_·œs_
[
i
][
kR—d
], &
ev
), -1);

271 
	gi
 = 
kNumPes
 / 2; i < 
	gkNumPes
; ++i) {

272 
•Şl_ev’t
 
	gev
;

273 
	gev
.
	gev’ts
 = 
EPOLLOUT
;

274 
	gev
.
	gd©a
.
	gfd
 = 
fd_·œs_
[
i
][
kR—d
];

275 
ASSERT_NE
(
•Şl_ùl
(
•fd
, 
EPOLL_CTL_MOD
, 
fd_·œs_
[
i
][
kR—d
], &
ev
), -1);

277 
	g¡d
::
veùÜ
<> 
wr™e_fds
;

279 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

280 
	gwr™e_fds
.
push_back
(
fd_·œs_
[
i
][
kWr™e
]);

282 
Wr™eToPes
(
wr™e_fds
, 
kTe¡SŒšg
);

283 
V”ifyR—dEv’ts
(
•fd
);

284 
ASSERT_EQ
(
şo£
(
•fd
), 0);

285 
Clo£Pes
();

288 
TEST_F
(
EpŞlTe¡
, 
Lev–Trigg”edBehaviÜ
è{ 
Lev–EdgeBehaviÜTe¡
(
çl£
); }

290 
TEST_F
(
EpŞlTe¡
, 
EdgeTrigg”edBehaviÜ
è{ 
Lev–EdgeBehaviÜTe¡
(
Œue
); }

	@platform/posix/io/eventfd_test.cc

19 
	~<sys/ev’tfd.h
>

20 
	~<uni¡d.h
>

22 
	~<©omic
>

23 
	~<chrÚo
>

24 
	~<th»ad
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

30 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
	gkNumWÜk”s
 = 6;

36 
cÚ¡ex´
 
	gkCouÁ”S¹
 = 6;

37 
cÚ¡ex´
 
	gkCouÁ”S¹MuÉiTh»ad
 = 
kNumWÜk”s
 / 2;

38 
cÚ¡ex´
 
	gkSË•Dur
 = 256;

40 
cÚ¡ex´
 
ušt64_t
 
	gkMaxCouÁ”
 = 0xfffffffffffffffe;

42 şas 
	cEv’tFdTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

43 
´Ùeùed
:

44 
In™ŸlizeEv’tFd
(
boŞ
 
£m­hÜe
, 
ušt64_t
 
¡¬t
 = 
kCouÁ”S¹
,

45 
boŞ
 
nÚblock
 = 
çl£
) {

46 
æags
 = 0;

47 ià(
	g£m­hÜe
è
	gæags
 |ğ
EFD_SEMAPHORE
;

48 ià(
	gnÚblock
è
	gæags
 |ğ
EFD_NONBLOCK
;

49 
	gev’t_fd_
 = 
ev’tfd
(
¡¬t
, 
æags
);

50 
ASSERT_NE
(
ev’t_fd_
, -1);

51 
	gnum_cu¼’t_wÜkšg_th»ads_
.
¡Üe
(0);

54 
Sem­hÜeWa™
(è{ 
EXPECT_EQ
(
R—d
(), 1); }

56 
Sem­hÜeSigÇl
(è{ 
Wr™e
(1); }

59 
ušt64_t
 
R—d
() {

60 
	gbuf
[(
ušt64_t
)];

61 
ssize_t
 
	gnum_by‹s
 = 
»ad
(
ev’t_fd_
, 
buf
, (
ušt64_t
));

62 ià(
	gnum_by‹s
 == -1)  -1;

63 
EXPECT_EQ
(
num_by‹s
, (
ušt64_t
));

64  *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gbuf
);

68 
Wr™e
(
ušt64_t
 
add
) {

69 
	gnum_by‹s
 =

70 
wr™e
(
ev’t_fd_
, 
»š‹½»t_ÿ¡
<*>(&
add
), (
ušt64_t
));

71 ià(
	gnum_by‹s
 == -1)  -1;

72 
EXPECT_EQ
(
num_by‹s
, (
ušt64_t
));

73  
	gnum_by‹s
;

77 
WÜk
(
i
, 
ab¦
::
æ©_hash_£t
<> *
th»ad_šdexes
,

78 
ab¦
::
Mu‹x
 *
th»ad_šdexes_mu‹x
) {

80 
Sem­hÜeWa™
();

82 
	gnum_cu¼’t_wÜkšg_th»ads_
++;

85 
EXPECT_LE
(
num_cu¼’t_wÜkšg_th»ads_
.
lßd
(), 
kCouÁ”S¹MuÉiTh»ad
);

86 
	g¡d
::
this_th»ad
::
¦“p_fÜ
(
¡d
::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

88 
	gth»ad_šdexes_mu‹x
->
Lock
();

89 
	gth»ad_šdexes
->
š£¹
(
i
);

90 
	gth»ad_šdexes_mu‹x
->
UÆock
();

92 
	gnum_cu¼’t_wÜkšg_th»ads_
--;

94 
Sem­hÜeSigÇl
();

97 
	gev’t_fd_
;

98 
	g¡d
::
©omic_št
 
num_cu¼’t_wÜkšg_th»ads_
;

101 
TEST_F
(
Ev’tFdTe¡
, 
Sem­hÜeMuÉËTh»ads
) {

102 
In™ŸlizeEv’tFd
(
Œue
, 
kCouÁ”S¹MuÉiTh»ad
);

103 
	gab¦
::
æ©_hash_£t
<> 
th»ad_šdexes
;

104 
	gab¦
::
Mu‹x
 
th»ad_šdexes_mu‹x
;

105 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
wÜk”s
;

106 
	gi
 = 0; i < 
	gkNumWÜk”s
; ++i) {

107 
	gwÜk”s
.
push_back
(
¡d
::
th»ad
([
this
, 
i
, &
th»ad_šdexes
,

108 &
th»ad_šdexes_mu‹x
] {

109 
WÜk
(
i
, &
th»ad_šdexes
, &
th»ad_šdexes_mu‹x
);

112 
	gi
 = 0; i < 
	gkNumWÜk”s
; ++i) {

113 
	gwÜk”s
[
i
].
još
();

116 
	gi
 = 0; i < 
	gkNumWÜk”s
; ++i) {

117 
EXPECT_NE
(
th»ad_šdexes
.
fšd
(
i
),h»ad_šdexes.
’d
());

121 
TEST_F
(
Ev’tFdTe¡
, 
Sem­hÜeWa™Wh’Z”o
) {

122 
In™ŸlizeEv’tFd
(
Œue
);

123 
	gi
 = 0; i < 
	gkCouÁ”S¹
; ++i) {

124 
Sem­hÜeWa™
();

127 
	g¡d
::
©omic_boŞ
 
wa™_com¶‘e
(
çl£
);

128 
	g¡d
::
th»ad
 
wÜk”
([
this
, &
wa™_com¶‘e
] {

129 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

130 
wa™_com¶‘e
.
¡Üe
(
Œue
);

131 
Sem­hÜeSigÇl
();

133 
Sem­hÜeWa™
();

134 
EXPECT_TRUE
(
wa™_com¶‘e
.
lßd
());

135 
	gwÜk”
.
još
();

138 
TEST_F
(
Ev’tFdTe¡
, 
NÚSem­hÜeWa™Wh’Z”o
) {

139 
In™ŸlizeEv’tFd
(
çl£
);

140 
EXPECT_EQ
(
R—d
(), 
kCouÁ”S¹
);

142 
	g¡d
::
©omic_boŞ
 
wa™_com¶‘e
(
çl£
);

143 
	g¡d
::
th»ad
 
wÜk”
([
this
, &
wa™_com¶‘e
] {

144 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

145 
wa™_com¶‘e
.
¡Üe
(
Œue
);

146 
Wr™e
(
kCouÁ”S¹
);

148 
EXPECT_EQ
(
R—d
(), 
kCouÁ”S¹
);

149 
EXPECT_TRUE
(
wa™_com¶‘e
.
lßd
());

150 
	gwÜk”
.
još
();

153 
TEST_F
(
Ev’tFdTe¡
, 
Sem­hÜeNÚBlock
) {

154 
In™ŸlizeEv’tFd
(
Œue
, 
kCouÁ”S¹
,rue);

155 
	gi
 = 0; i < 
	gkCouÁ”S¹
; ++i) {

156 
Sem­hÜeWa™
();

158 
EXPECT_EQ
(
R—d
(), -1);

159 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

162 
TEST_F
(
Ev’tFdTe¡
, 
NÚSem­hÜeNÚBlock
) {

163 
In™ŸlizeEv’tFd
(
çl£
, 
kCouÁ”S¹
, 
Œue
);

164 
EXPECT_EQ
(
R—d
(), 
kCouÁ”S¹
);

165 
EXPECT_EQ
(
R—d
(), -1);

166 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

169 
TEST_F
(
Ev’tFdTe¡
, 
MaxCouÁ”Block
) {

170 
In™ŸlizeEv’tFd
(
çl£
, 0, false);

172 
ASSERT_EQ
(
Wr™e
(
kMaxCouÁ”
), (
ušt64_t
));

173 
	g¡d
::
©omic_boŞ
 
wa™_com¶‘e
(
çl£
);

174 
	g¡d
::
th»ad
 
wÜk”
([
this
, &
wa™_com¶‘e
] {

175 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

176 
wa™_com¶‘e
.
¡Üe
(
Œue
);

177 
ušt64_t
 
couÁ”
 = 0;

178 
ssize_t
 
num_by‹s
 =

179 
»ad
(
ev’t_fd_
, 
»š‹½»t_ÿ¡
<*>(&
couÁ”
), (
ušt64_t
));

180 
ASSERT_EQ
(
num_by‹s
, (
ušt64_t
));

181 
ASSERT_EQ
(
couÁ”
, 
kMaxCouÁ”
);

185 
Wr™e
(1);

186 
EXPECT_TRUE
(
wa™_com¶‘e
.
lßd
());

187 
	gwÜk”
.
još
();

190 
TEST_F
(
Ev’tFdTe¡
, 
MaxCouÁ”NÚBlock
) {

191 
In™ŸlizeEv’tFd
(
çl£
, 0, 
Œue
);

193 
ASSERT_EQ
(
Wr™e
(
kMaxCouÁ”
), (
ušt64_t
));

194 
EXPECT_EQ
(
Wr™e
(1), -1);

195 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

	@platform/posix/io/eventfd_test.cc

19 
	~<sys/ev’tfd.h
>

20 
	~<uni¡d.h
>

22 
	~<©omic
>

23 
	~<chrÚo
>

24 
	~<th»ad
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

30 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
	gkNumWÜk”s
 = 6;

36 
cÚ¡ex´
 
	gkCouÁ”S¹
 = 6;

37 
cÚ¡ex´
 
	gkCouÁ”S¹MuÉiTh»ad
 = 
kNumWÜk”s
 / 2;

38 
cÚ¡ex´
 
	gkSË•Dur
 = 256;

40 
cÚ¡ex´
 
ušt64_t
 
	gkMaxCouÁ”
 = 0xfffffffffffffffe;

42 şas 
	cEv’tFdTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

43 
´Ùeùed
:

44 
In™ŸlizeEv’tFd
(
boŞ
 
£m­hÜe
, 
ušt64_t
 
¡¬t
 = 
kCouÁ”S¹
,

45 
boŞ
 
nÚblock
 = 
çl£
) {

46 
æags
 = 0;

47 ià(
	g£m­hÜe
è
	gæags
 |ğ
EFD_SEMAPHORE
;

48 ià(
	gnÚblock
è
	gæags
 |ğ
EFD_NONBLOCK
;

49 
	gev’t_fd_
 = 
ev’tfd
(
¡¬t
, 
æags
);

50 
ASSERT_NE
(
ev’t_fd_
, -1);

51 
	gnum_cu¼’t_wÜkšg_th»ads_
.
¡Üe
(0);

54 
Sem­hÜeWa™
(è{ 
EXPECT_EQ
(
R—d
(), 1); }

56 
Sem­hÜeSigÇl
(è{ 
Wr™e
(1); }

59 
ušt64_t
 
R—d
() {

60 
	gbuf
[(
ušt64_t
)];

61 
ssize_t
 
	gnum_by‹s
 = 
»ad
(
ev’t_fd_
, 
buf
, (
ušt64_t
));

62 ià(
	gnum_by‹s
 == -1)  -1;

63 
EXPECT_EQ
(
num_by‹s
, (
ušt64_t
));

64  *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gbuf
);

68 
Wr™e
(
ušt64_t
 
add
) {

69 
	gnum_by‹s
 =

70 
wr™e
(
ev’t_fd_
, 
»š‹½»t_ÿ¡
<*>(&
add
), (
ušt64_t
));

71 ià(
	gnum_by‹s
 == -1)  -1;

72 
EXPECT_EQ
(
num_by‹s
, (
ušt64_t
));

73  
	gnum_by‹s
;

77 
WÜk
(
i
, 
ab¦
::
æ©_hash_£t
<> *
th»ad_šdexes
,

78 
ab¦
::
Mu‹x
 *
th»ad_šdexes_mu‹x
) {

80 
Sem­hÜeWa™
();

82 
	gnum_cu¼’t_wÜkšg_th»ads_
++;

85 
EXPECT_LE
(
num_cu¼’t_wÜkšg_th»ads_
.
lßd
(), 
kCouÁ”S¹MuÉiTh»ad
);

86 
	g¡d
::
this_th»ad
::
¦“p_fÜ
(
¡d
::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

88 
	gth»ad_šdexes_mu‹x
->
Lock
();

89 
	gth»ad_šdexes
->
š£¹
(
i
);

90 
	gth»ad_šdexes_mu‹x
->
UÆock
();

92 
	gnum_cu¼’t_wÜkšg_th»ads_
--;

94 
Sem­hÜeSigÇl
();

97 
	gev’t_fd_
;

98 
	g¡d
::
©omic_št
 
num_cu¼’t_wÜkšg_th»ads_
;

101 
TEST_F
(
Ev’tFdTe¡
, 
Sem­hÜeMuÉËTh»ads
) {

102 
In™ŸlizeEv’tFd
(
Œue
, 
kCouÁ”S¹MuÉiTh»ad
);

103 
	gab¦
::
æ©_hash_£t
<> 
th»ad_šdexes
;

104 
	gab¦
::
Mu‹x
 
th»ad_šdexes_mu‹x
;

105 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
wÜk”s
;

106 
	gi
 = 0; i < 
	gkNumWÜk”s
; ++i) {

107 
	gwÜk”s
.
push_back
(
¡d
::
th»ad
([
this
, 
i
, &
th»ad_šdexes
,

108 &
th»ad_šdexes_mu‹x
] {

109 
WÜk
(
i
, &
th»ad_šdexes
, &
th»ad_šdexes_mu‹x
);

112 
	gi
 = 0; i < 
	gkNumWÜk”s
; ++i) {

113 
	gwÜk”s
[
i
].
još
();

116 
	gi
 = 0; i < 
	gkNumWÜk”s
; ++i) {

117 
EXPECT_NE
(
th»ad_šdexes
.
fšd
(
i
),h»ad_šdexes.
’d
());

121 
TEST_F
(
Ev’tFdTe¡
, 
Sem­hÜeWa™Wh’Z”o
) {

122 
In™ŸlizeEv’tFd
(
Œue
);

123 
	gi
 = 0; i < 
	gkCouÁ”S¹
; ++i) {

124 
Sem­hÜeWa™
();

127 
	g¡d
::
©omic_boŞ
 
wa™_com¶‘e
(
çl£
);

128 
	g¡d
::
th»ad
 
wÜk”
([
this
, &
wa™_com¶‘e
] {

129 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

130 
wa™_com¶‘e
.
¡Üe
(
Œue
);

131 
Sem­hÜeSigÇl
();

133 
Sem­hÜeWa™
();

134 
EXPECT_TRUE
(
wa™_com¶‘e
.
lßd
());

135 
	gwÜk”
.
još
();

138 
TEST_F
(
Ev’tFdTe¡
, 
NÚSem­hÜeWa™Wh’Z”o
) {

139 
In™ŸlizeEv’tFd
(
çl£
);

140 
EXPECT_EQ
(
R—d
(), 
kCouÁ”S¹
);

142 
	g¡d
::
©omic_boŞ
 
wa™_com¶‘e
(
çl£
);

143 
	g¡d
::
th»ad
 
wÜk”
([
this
, &
wa™_com¶‘e
] {

144 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

145 
wa™_com¶‘e
.
¡Üe
(
Œue
);

146 
Wr™e
(
kCouÁ”S¹
);

148 
EXPECT_EQ
(
R—d
(), 
kCouÁ”S¹
);

149 
EXPECT_TRUE
(
wa™_com¶‘e
.
lßd
());

150 
	gwÜk”
.
još
();

153 
TEST_F
(
Ev’tFdTe¡
, 
Sem­hÜeNÚBlock
) {

154 
In™ŸlizeEv’tFd
(
Œue
, 
kCouÁ”S¹
,rue);

155 
	gi
 = 0; i < 
	gkCouÁ”S¹
; ++i) {

156 
Sem­hÜeWa™
();

158 
EXPECT_EQ
(
R—d
(), -1);

159 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

162 
TEST_F
(
Ev’tFdTe¡
, 
NÚSem­hÜeNÚBlock
) {

163 
In™ŸlizeEv’tFd
(
çl£
, 
kCouÁ”S¹
, 
Œue
);

164 
EXPECT_EQ
(
R—d
(), 
kCouÁ”S¹
);

165 
EXPECT_EQ
(
R—d
(), -1);

166 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

169 
TEST_F
(
Ev’tFdTe¡
, 
MaxCouÁ”Block
) {

170 
In™ŸlizeEv’tFd
(
çl£
, 0, false);

172 
ASSERT_EQ
(
Wr™e
(
kMaxCouÁ”
), (
ušt64_t
));

173 
	g¡d
::
©omic_boŞ
 
wa™_com¶‘e
(
çl£
);

174 
	g¡d
::
th»ad
 
wÜk”
([
this
, &
wa™_com¶‘e
] {

175 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

176 
wa™_com¶‘e
.
¡Üe
(
Œue
);

177 
ušt64_t
 
couÁ”
 = 0;

178 
ssize_t
 
num_by‹s
 =

179 
»ad
(
ev’t_fd_
, 
»š‹½»t_ÿ¡
<*>(&
couÁ”
), (
ušt64_t
));

180 
ASSERT_EQ
(
num_by‹s
, (
ušt64_t
));

181 
ASSERT_EQ
(
couÁ”
, 
kMaxCouÁ”
);

185 
Wr™e
(1);

186 
EXPECT_TRUE
(
wa™_com¶‘e
.
lßd
());

187 
	gwÜk”
.
još
();

190 
TEST_F
(
Ev’tFdTe¡
, 
MaxCouÁ”NÚBlock
) {

191 
In™ŸlizeEv’tFd
(
çl£
, 0, 
Œue
);

193 
ASSERT_EQ
(
Wr™e
(
kMaxCouÁ”
), (
ušt64_t
));

194 
EXPECT_EQ
(
Wr™e
(1), -1);

195 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

	@platform/posix/io/inotify_test.cc

18 
	~<fú.h
>

19 
	~<lim™s.h
>

20 
	~<¡dio.h
>

21 
	~<¡ršg.h
>

22 
	~<sys/šÙify.h
>

23 
	~<uni¡d.h
>

25 
	~<chrÚo
>

26 
	~<th»ad
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/‹¡/ut/‹¡_æags.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 cÚ¡ *
	g¡r
 = "Testing inotify.";

37 
cÚ¡ex´
 
size_t
 
	gkSË•Dur
 = 100;

38 
cÚ¡ex´
 
size_t
 
	gkEv’tBufSize
 = 4096;

40 şas 
	cInÙifyTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

41 
´Ùeùed
:

42 
InÙifyTe¡
() {

43 
fe1_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/file1.out");

44 
	gfe2_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/file2.out");

45 
	gfe3_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/file3.out");

47 
»move
(
fe1_
.
c_¡r
());

48 
»move
(
fe2_
.
c_¡r
());

49 
»move
(
fe3_
.
c_¡r
());

51 
	gfd1_
 = 
İ’
(
fe1_
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0644);

52 
	gfd2_
 = 
İ’
(
fe2_
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0644);

53 
	gfd3_
 = 
İ’
(
fe3_
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0644);

54 
	gšfd_
 = 
šÙify_š™
();

55 
EXPECT_GT
(
šfd_
, 0);

58 
Clo£Fds
() {

59 
şo£
(
fd1_
);

60 
şo£
(
fd2_
);

61 
şo£
(
fd3_
);

62 
şo£
(
šfd_
);

65 
	g¡d
::
¡ršg
 
fe1_
;

66 
	g¡d
::
¡ršg
 
fe2_
;

67 
	g¡d
::
¡ršg
 
fe3_
;

68 
	gfd1_
;

69 
	gfd2_
;

70 
	gfd3_
;

71 
	gšfd_
;

74 
TEST_F
(
InÙifyTe¡
, 
SšgËFeWr™e
) {

75 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
);

76 
ASSERT_GT
(
wd1
, 0);

77 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

78 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

79 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

81 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

82 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

83 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

84 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

85 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

86 
Clo£Fds
();

89 
TEST_F
(
InÙifyTe¡
, 
SšgËFeWr™eBlock
) {

90 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
);

91 
ASSERT_GT
(
wd1
, 0);

92 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

93 
	g¡d
::
th»ad
 
wr™”
([
this
, 
Ën
] {

94 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

95 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

97 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

99 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

100 
	gwr™”
.
još
();

101 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

102 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

103 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

104 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

105 
Clo£Fds
();

108 
TEST_F
(
InÙifyTe¡
, 
SšgËFeClo£d
) {

109 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_CLOSE_WRITE
);

110 
ASSERT_GT
(
wd1
, 0);

111 
EXPECT_EQ
(
şo£
(
fd1_
), 0);

112 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

114 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

115 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

116 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

117 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_CLOSE_WRITE
);

118 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

119 
şo£
(
fd2_
);

120 
şo£
(
fd3_
);

121 
şo£
(
šfd_
);

124 
TEST_F
(
InÙifyTe¡
, 
SšgËFeR—d
) {

125 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_ACCESS
);

126 
ASSERT_GT
(
wd1
, 0);

127 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

128 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

129 *
	g»ad_buf
 = 
¡©ic_ÿ¡
<*>(
m®loc
(
Ën
));

130 
	gfd1_»ad
 = 
İ’
(
fe1_
.
c_¡r
(), 
O_RDONLY
, 0644);

131 
EXPECT_GT
(
»ad
(
fd1_»ad
, 
»ad_buf
, 
Ën
), 0);

132 
şo£
(
fd1_»ad
);

133 
ä“
(
»ad_buf
);

134 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

136 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

137 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

138 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

139 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_ACCESS
);

140 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

141 
Clo£Fds
();

144 
TEST_F
(
InÙifyTe¡
, 
SšgËFeWr™eDœ
) {

145 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
FLAGS_‹¡_tmpdœ
.
c_¡r
(), 
IN_MODIFY
);

146 
ASSERT_GT
(
wd1
, 0);

147 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

148 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

149 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

151 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

152 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

153 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

154 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

156 
EXPECT_EQ
(
¡rcmp
(
ev’t
->
Çme
, "file1.out"), 0);

157 
Clo£Fds
();

160 
TEST_F
(
InÙifyTe¡
, 
NÚBlock
) {

161 
şo£
(
šfd_
);

162 
	gšfd_
 = 
šÙify_š™1
(
IN_NONBLOCK
);

163 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_ACCESS
);

164 
ASSERT_GT
(
wd1
, 0);

165 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

167 
EXPECT_EQ
(
»ad
(
šfd_
, 
buf
, (buf)), -1);

168 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

169 
Clo£Fds
();

172 
TEST_F
(
InÙifyTe¡
, 
MuÉËEv’ts
) {

173 
	gwds
[3];

174 
	gwds
[0] = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

175 
ASSERT_GT
(
wds
[0], 0);

176 
	gwds
[1] = 
šÙify_add_w©ch
(
šfd_
, 
fe2_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

177 
ASSERT_GT
(
wds
[1], 0);

178 
	gwds
[2] = 
šÙify_add_w©ch
(
šfd_
, 
fe3_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

179 
ASSERT_GT
(
wds
[2], 0);

180 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

181 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

182 
EXPECT_EQ
(
wr™e
(
fd2_
, 
¡r
, 
Ën
),†en);

183 
EXPECT_EQ
(
wr™e
(
fd3_
, 
¡r
, 
Ën
),†en);

184 
EXPECT_EQ
(
şo£
(
fd1_
), 0);

185 
EXPECT_EQ
(
şo£
(
fd2_
), 0);

186 
EXPECT_EQ
(
şo£
(
fd3_
), 0);

187 
	gbuf
[
kEv’tBufSize
];

189 
ssize_t
 
	gby‹s_»ad
 = 
»ad
(
šfd_
, 
buf
, (buf));

190 
ASSERT_GT
(
by‹s_»ad
, 0);

191 
EXPECT_EQ
(
by‹s_»ad
, 6 * (
šÙify_ev’t
));

192 *
	gcu¼_ev’t_±r
 = 
buf
;

193 
	gi
 = 0; i < (
	gwds
) / (); ++i) {

194 
šÙify_ev’t
 *
	gcu¼_ev’t
 =

195 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
cu¼_ev’t_±r
);

196 
EXPECT_EQ
(
cu¼_ev’t
->
wd
, 
wds
[
i
]);

197 
EXPECT_TRUE
(
cu¼_ev’t
->
mask
 & 
IN_MODIFY
);

198 
EXPECT_EQ
(
cu¼_ev’t
->
Ën
, 0);

199 
	gcu¼_ev’t_±r
 +ğ(
šÙify_ev’t
);

201 
	gi
 = 0; i < (
	gwds
) / (); ++i) {

202 
šÙify_ev’t
 *
	gcu¼_ev’t
 =

203 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
cu¼_ev’t_±r
);

204 
EXPECT_EQ
(
cu¼_ev’t
->
wd
, 
wds
[
i
]);

205 
EXPECT_TRUE
(
cu¼_ev’t
->
mask
 & 
IN_CLOSE_WRITE
);

206 
EXPECT_EQ
(
cu¼_ev’t
->
Ën
, 0);

207 
	gcu¼_ev’t_±r
 +ğ(
šÙify_ev’t
);

209 
şo£
(
šfd_
);

212 
TEST_F
(
InÙifyTe¡
, 
Ev’tsQueued
) {

213 
	gwd1
 =

214 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

215 
ASSERT_GT
(
wd1
, 0);

216 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

217 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

218 
EXPECT_EQ
(
şo£
(
fd1_
), 0);

224 
	gbuf
[(
šÙify_ev’t
)];

226 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

227 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

228 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

229 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

230 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

231 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

232 
	gev’t
 = 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
buf
);

233 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

234 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_CLOSE_WRITE
);

235 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

236 
şo£
(
fd2_
);

237 
şo£
(
fd3_
);

238 
şo£
(
šfd_
);

241 
TEST_F
(
InÙifyTe¡
, 
BufãrTooSm®l
) {

242 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
);

243 
ASSERT_GT
(
wd1
, 0);

244 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

245 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

247 
	gbuf
[(
šÙify_ev’t
) - 1];

249 
EXPECT_EQ
(
»ad
(
šfd_
, 
buf
, (buf)), -1);

250 
EXPECT_EQ
(
”ºo
, 
EINVAL
);

251 
Clo£Fds
();

	@platform/posix/io/inotify_test.cc

18 
	~<fú.h
>

19 
	~<lim™s.h
>

20 
	~<¡dio.h
>

21 
	~<¡ršg.h
>

22 
	~<sys/šÙify.h
>

23 
	~<uni¡d.h
>

25 
	~<chrÚo
>

26 
	~<th»ad
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/‹¡/ut/‹¡_æags.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 cÚ¡ *
	g¡r
 = "Testing inotify.";

37 
cÚ¡ex´
 
size_t
 
	gkSË•Dur
 = 100;

38 
cÚ¡ex´
 
size_t
 
	gkEv’tBufSize
 = 4096;

40 şas 
	cInÙifyTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

41 
´Ùeùed
:

42 
InÙifyTe¡
() {

43 
fe1_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/file1.out");

44 
	gfe2_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/file2.out");

45 
	gfe3_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/file3.out");

47 
»move
(
fe1_
.
c_¡r
());

48 
»move
(
fe2_
.
c_¡r
());

49 
»move
(
fe3_
.
c_¡r
());

51 
	gfd1_
 = 
İ’
(
fe1_
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0644);

52 
	gfd2_
 = 
İ’
(
fe2_
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0644);

53 
	gfd3_
 = 
İ’
(
fe3_
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0644);

54 
	gšfd_
 = 
šÙify_š™
();

55 
EXPECT_GT
(
šfd_
, 0);

58 
Clo£Fds
() {

59 
şo£
(
fd1_
);

60 
şo£
(
fd2_
);

61 
şo£
(
fd3_
);

62 
şo£
(
šfd_
);

65 
	g¡d
::
¡ršg
 
fe1_
;

66 
	g¡d
::
¡ršg
 
fe2_
;

67 
	g¡d
::
¡ršg
 
fe3_
;

68 
	gfd1_
;

69 
	gfd2_
;

70 
	gfd3_
;

71 
	gšfd_
;

74 
TEST_F
(
InÙifyTe¡
, 
SšgËFeWr™e
) {

75 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
);

76 
ASSERT_GT
(
wd1
, 0);

77 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

78 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

79 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

81 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

82 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

83 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

84 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

85 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

86 
Clo£Fds
();

89 
TEST_F
(
InÙifyTe¡
, 
SšgËFeWr™eBlock
) {

90 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
);

91 
ASSERT_GT
(
wd1
, 0);

92 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

93 
	g¡d
::
th»ad
 
wr™”
([
this
, 
Ën
] {

94 
¡d
::
this_th»ad
::
¦“p_fÜ
(¡d::
chrÚo
::
mli£cÚds
(
kSË•Dur
));

95 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

97 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

99 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

100 
	gwr™”
.
još
();

101 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

102 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

103 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

104 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

105 
Clo£Fds
();

108 
TEST_F
(
InÙifyTe¡
, 
SšgËFeClo£d
) {

109 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_CLOSE_WRITE
);

110 
ASSERT_GT
(
wd1
, 0);

111 
EXPECT_EQ
(
şo£
(
fd1_
), 0);

112 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

114 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

115 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

116 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

117 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_CLOSE_WRITE
);

118 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

119 
şo£
(
fd2_
);

120 
şo£
(
fd3_
);

121 
şo£
(
šfd_
);

124 
TEST_F
(
InÙifyTe¡
, 
SšgËFeR—d
) {

125 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_ACCESS
);

126 
ASSERT_GT
(
wd1
, 0);

127 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

128 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

129 *
	g»ad_buf
 = 
¡©ic_ÿ¡
<*>(
m®loc
(
Ën
));

130 
	gfd1_»ad
 = 
İ’
(
fe1_
.
c_¡r
(), 
O_RDONLY
, 0644);

131 
EXPECT_GT
(
»ad
(
fd1_»ad
, 
»ad_buf
, 
Ën
), 0);

132 
şo£
(
fd1_»ad
);

133 
ä“
(
»ad_buf
);

134 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

136 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

137 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

138 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

139 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_ACCESS
);

140 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

141 
Clo£Fds
();

144 
TEST_F
(
InÙifyTe¡
, 
SšgËFeWr™eDœ
) {

145 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
FLAGS_‹¡_tmpdœ
.
c_¡r
(), 
IN_MODIFY
);

146 
ASSERT_GT
(
wd1
, 0);

147 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

148 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

149 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

151 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

152 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

153 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

154 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

156 
EXPECT_EQ
(
¡rcmp
(
ev’t
->
Çme
, "file1.out"), 0);

157 
Clo£Fds
();

160 
TEST_F
(
InÙifyTe¡
, 
NÚBlock
) {

161 
şo£
(
šfd_
);

162 
	gšfd_
 = 
šÙify_š™1
(
IN_NONBLOCK
);

163 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_ACCESS
);

164 
ASSERT_GT
(
wd1
, 0);

165 
	gbuf
[(
šÙify_ev’t
è+ 
PATH_MAX
 + 1];

167 
EXPECT_EQ
(
»ad
(
šfd_
, 
buf
, (buf)), -1);

168 
EXPECT_EQ
(
”ºo
, 
EAGAIN
);

169 
Clo£Fds
();

172 
TEST_F
(
InÙifyTe¡
, 
MuÉËEv’ts
) {

173 
	gwds
[3];

174 
	gwds
[0] = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

175 
ASSERT_GT
(
wds
[0], 0);

176 
	gwds
[1] = 
šÙify_add_w©ch
(
šfd_
, 
fe2_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

177 
ASSERT_GT
(
wds
[1], 0);

178 
	gwds
[2] = 
šÙify_add_w©ch
(
šfd_
, 
fe3_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

179 
ASSERT_GT
(
wds
[2], 0);

180 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

181 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

182 
EXPECT_EQ
(
wr™e
(
fd2_
, 
¡r
, 
Ën
),†en);

183 
EXPECT_EQ
(
wr™e
(
fd3_
, 
¡r
, 
Ën
),†en);

184 
EXPECT_EQ
(
şo£
(
fd1_
), 0);

185 
EXPECT_EQ
(
şo£
(
fd2_
), 0);

186 
EXPECT_EQ
(
şo£
(
fd3_
), 0);

187 
	gbuf
[
kEv’tBufSize
];

189 
ssize_t
 
	gby‹s_»ad
 = 
»ad
(
šfd_
, 
buf
, (buf));

190 
ASSERT_GT
(
by‹s_»ad
, 0);

191 
EXPECT_EQ
(
by‹s_»ad
, 6 * (
šÙify_ev’t
));

192 *
	gcu¼_ev’t_±r
 = 
buf
;

193 
	gi
 = 0; i < (
	gwds
) / (); ++i) {

194 
šÙify_ev’t
 *
	gcu¼_ev’t
 =

195 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
cu¼_ev’t_±r
);

196 
EXPECT_EQ
(
cu¼_ev’t
->
wd
, 
wds
[
i
]);

197 
EXPECT_TRUE
(
cu¼_ev’t
->
mask
 & 
IN_MODIFY
);

198 
EXPECT_EQ
(
cu¼_ev’t
->
Ën
, 0);

199 
	gcu¼_ev’t_±r
 +ğ(
šÙify_ev’t
);

201 
	gi
 = 0; i < (
	gwds
) / (); ++i) {

202 
šÙify_ev’t
 *
	gcu¼_ev’t
 =

203 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
cu¼_ev’t_±r
);

204 
EXPECT_EQ
(
cu¼_ev’t
->
wd
, 
wds
[
i
]);

205 
EXPECT_TRUE
(
cu¼_ev’t
->
mask
 & 
IN_CLOSE_WRITE
);

206 
EXPECT_EQ
(
cu¼_ev’t
->
Ën
, 0);

207 
	gcu¼_ev’t_±r
 +ğ(
šÙify_ev’t
);

209 
şo£
(
šfd_
);

212 
TEST_F
(
InÙifyTe¡
, 
Ev’tsQueued
) {

213 
	gwd1
 =

214 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
 | 
IN_CLOSE_WRITE
);

215 
ASSERT_GT
(
wd1
, 0);

216 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

217 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

218 
EXPECT_EQ
(
şo£
(
fd1_
), 0);

224 
	gbuf
[(
šÙify_ev’t
)];

226 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

227 
šÙify_ev’t
 *
	gev’t
 = 
»š‹½»t_ÿ¡
<šÙify_ev’ˆ*>(
buf
);

228 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

229 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_MODIFY
);

230 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

231 
ASSERT_GT
(
»ad
(
šfd_
, 
buf
, (buf)), 0);

232 
	gev’t
 = 
»š‹½»t_ÿ¡
<
šÙify_ev’t
 *>(
buf
);

233 
EXPECT_EQ
(
ev’t
->
wd
, 
wd1
);

234 
EXPECT_TRUE
(
ev’t
->
mask
 & 
IN_CLOSE_WRITE
);

235 
EXPECT_EQ
(
ev’t
->
Ën
, 0);

236 
şo£
(
fd2_
);

237 
şo£
(
fd3_
);

238 
şo£
(
šfd_
);

241 
TEST_F
(
InÙifyTe¡
, 
BufãrTooSm®l
) {

242 
	gwd1
 = 
šÙify_add_w©ch
(
šfd_
, 
fe1_
.
c_¡r
(), 
IN_MODIFY
);

243 
ASSERT_GT
(
wd1
, 0);

244 
size_t
 
	gËn
 = 
¡¾’
(
¡r
);

245 
EXPECT_EQ
(
wr™e
(
fd1_
, 
¡r
, 
Ën
),†en);

247 
	gbuf
[(
šÙify_ev’t
) - 1];

249 
EXPECT_EQ
(
»ad
(
šfd_
, 
buf
, (buf)), -1);

250 
EXPECT_EQ
(
”ºo
, 
EINVAL
);

251 
Clo£Fds
();

	@platform/posix/io/io_context_epoll.cc

18 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_•Şl.h
"

20 
	~<”ºo.h
>

21 
	~<İ’s¦/¿nd.h
>

22 
	~<¡dšt.h
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gio
 {

30 
	gIOCÚ‹xtEpŞl
::
EpŞlC
(
İ
, 
ho¡fd
, 
•Şl_ev’t
 *
ev’t
) {

31 
•Şl_ev’t
 
	gev’t_cİy
;

32 ià(
	gev’t
) {

33 
	gev’t_cİy
.
	gev’ts
 = 
ev’t
->
ev’ts
;

35 ià(
	gİ
 =ğ
EPOLL_CTL_ADD
) {

36 
ušt64_t
 
key
 = 0;

38 ià(
RAND_by‹s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
key
),

39 (
ušt64_t
)) != 1) {

40 
”ºo
 = 
EBADE
;

43 } 
	gkey_to_d©a
.
fšd
(
key
è!ğ
key_to_d©a
.
’d
());

44 
	gkey_to_d©a
[
key
] = 
ev’t
->
d©a
.
u64
;

45 
	gfd_to_key
[
ho¡fd
] = 
key
;

46 
	gev’t_cİy
.
	gd©a
.
	gu64
 = 
key
;

47 } ià(
	gİ
 =ğ
EPOLL_CTL_MOD
) {

48 ià(
fd_to_key
.
fšd
(
ho¡fd
è=ğfd_to_key.
’d
()) {

49 
”ºo
 = 
ENOENT
;

52 
ušt64_t
 
	gkey
 = 
fd_to_key
[
ho¡fd
];

53 
	gkey_to_d©a
[
key
] = 
ev’t
->
d©a
.
u64
;

54 
	gev’t_cİy
.
	gd©a
.
	gu64
 = 
key
;

55 } ià(
	gİ
 =ğ
EPOLL_CTL_DEL
) {

56 ià(
fd_to_key
.
fšd
(
ho¡fd
è=ğfd_to_key.
’d
()) {

57 
”ºo
 = 
ENOENT
;

60 
ušt64_t
 
	gkey
 = 
fd_to_key
[
ho¡fd
];

61 
	gev’t_cİy
.
	gd©a
.
	gu64
 = 
key
;

62 
	gfd_to_key
.
”a£
(
ho¡fd
);

63 
	gkey_to_d©a
.
”a£
(
key
);

67  
’c_uÁru¡ed_•Şl_ùl
(
ho¡_fd_
, 
İ
, 
ho¡fd
, &
ev’t_cİy
);

70 
	gIOCÚ‹xtEpŞl
::
EpŞlWa™
(
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

71 
timeout
) {

72 
	g»t
 = 
’c_uÁru¡ed_•Şl_wa™
(
ho¡_fd_
, 
ev’ts
, 
maxev’ts
, 
timeout
);

73 ià(
	g»t
 == -1) {

79 
	gi
 = 0; i < 
	g»t
; ++i) {

80 
ušt64_t
 
	gkey
 = 
ev’ts
[
i
].
d©a
.
u64
;

81 ià(
	gkey_to_d©a
.
fšd
(
key
è=ğ
key_to_d©a
.
’d
()) {

82 
”ºo
 = 
EBADE
;

85 
	gev’ts
[
i
].
	gd©a
.
	gu64
 = 
key_to_d©a
[
key
];

87  
	g»t
;

90 
	gIOCÚ‹xtEpŞl
::
G‘Ho¡FeDesütÜ
(è{  
ho¡_fd_
; }

93 
ssize_t
 
	gIOCÚ‹xtEpŞl
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

94 
	g”ºo
 = 
EBADF
;

98 
ssize_t
 
	gIOCÚ‹xtEpŞl
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

99 
	g”ºo
 = 
EBADF
;

103 
	gIOCÚ‹xtEpŞl
::
Clo£
(è{  
’c_uÁru¡ed_şo£
(
ho¡_fd_
); }

	@platform/posix/io/io_context_epoll.cc

18 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_•Şl.h
"

20 
	~<”ºo.h
>

21 
	~<İ’s¦/¿nd.h
>

22 
	~<¡dšt.h
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gio
 {

30 
	gIOCÚ‹xtEpŞl
::
EpŞlC
(
İ
, 
ho¡fd
, 
•Şl_ev’t
 *
ev’t
) {

31 
•Şl_ev’t
 
	gev’t_cİy
;

32 ià(
	gev’t
) {

33 
	gev’t_cİy
.
	gev’ts
 = 
ev’t
->
ev’ts
;

35 ià(
	gİ
 =ğ
EPOLL_CTL_ADD
) {

36 
ušt64_t
 
key
 = 0;

38 ià(
RAND_by‹s
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
key
),

39 (
ušt64_t
)) != 1) {

40 
”ºo
 = 
EBADE
;

43 } 
	gkey_to_d©a
.
fšd
(
key
è!ğ
key_to_d©a
.
’d
());

44 
	gkey_to_d©a
[
key
] = 
ev’t
->
d©a
.
u64
;

45 
	gfd_to_key
[
ho¡fd
] = 
key
;

46 
	gev’t_cİy
.
	gd©a
.
	gu64
 = 
key
;

47 } ià(
	gİ
 =ğ
EPOLL_CTL_MOD
) {

48 ià(
fd_to_key
.
fšd
(
ho¡fd
è=ğfd_to_key.
’d
()) {

49 
”ºo
 = 
ENOENT
;

52 
ušt64_t
 
	gkey
 = 
fd_to_key
[
ho¡fd
];

53 
	gkey_to_d©a
[
key
] = 
ev’t
->
d©a
.
u64
;

54 
	gev’t_cİy
.
	gd©a
.
	gu64
 = 
key
;

55 } ià(
	gİ
 =ğ
EPOLL_CTL_DEL
) {

56 ià(
fd_to_key
.
fšd
(
ho¡fd
è=ğfd_to_key.
’d
()) {

57 
”ºo
 = 
ENOENT
;

60 
ušt64_t
 
	gkey
 = 
fd_to_key
[
ho¡fd
];

61 
	gev’t_cİy
.
	gd©a
.
	gu64
 = 
key
;

62 
	gfd_to_key
.
”a£
(
ho¡fd
);

63 
	gkey_to_d©a
.
”a£
(
key
);

67  
’c_uÁru¡ed_•Şl_ùl
(
ho¡_fd_
, 
İ
, 
ho¡fd
, &
ev’t_cİy
);

70 
	gIOCÚ‹xtEpŞl
::
EpŞlWa™
(
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

71 
timeout
) {

72 
	g»t
 = 
’c_uÁru¡ed_•Şl_wa™
(
ho¡_fd_
, 
ev’ts
, 
maxev’ts
, 
timeout
);

73 ià(
	g»t
 == -1) {

79 
	gi
 = 0; i < 
	g»t
; ++i) {

80 
ušt64_t
 
	gkey
 = 
ev’ts
[
i
].
d©a
.
u64
;

81 ià(
	gkey_to_d©a
.
fšd
(
key
è=ğ
key_to_d©a
.
’d
()) {

82 
”ºo
 = 
EBADE
;

85 
	gev’ts
[
i
].
	gd©a
.
	gu64
 = 
key_to_d©a
[
key
];

87  
	g»t
;

90 
	gIOCÚ‹xtEpŞl
::
G‘Ho¡FeDesütÜ
(è{  
ho¡_fd_
; }

93 
ssize_t
 
	gIOCÚ‹xtEpŞl
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

94 
	g”ºo
 = 
EBADF
;

98 
ssize_t
 
	gIOCÚ‹xtEpŞl
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

99 
	g”ºo
 = 
EBADF
;

103 
	gIOCÚ‹xtEpŞl
::
Clo£
(è{  
’c_uÁru¡ed_şo£
(
ho¡_fd_
); }

	@platform/posix/io/io_context_epoll.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_IO_CONTEXT_EPOLL_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_IO_CONTEXT_EPOLL_H_


	)

22 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

23 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gio
 {

28 şas 
	cIOCÚ‹xtEpŞl
 : 
public
 
IOMªag”
::
IOCÚ‹xt
 {

29 
public
:

30 
ex¶ic™
 
IOCÚ‹xtEpŞl
(
ho¡_fd
è: 
ho¡_fd_
(host_fd) {}

33 
EpŞlC
(
İ
, 
ho¡fd
, 
•Şl_ev’t
 *
ev’t
è
	gov”ride
;

34 
EpŞlWa™
(
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

35 
timeout
è
	gov”ride
;

36 
G‘Ho¡FeDesütÜ
(è
	gov”ride
;

37 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
);

38 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
);

39 
Clo£
();

41 
	g´iv©e
:

43 
ho¡_fd_
;

44 
	gab¦
::
æ©_hash_m­
<
ušt64_t
, 
	gušt64_t
> 
	gkey_to_d©a
;

47 
	gab¦
::
æ©_hash_m­
<, 
	gušt64_t
> 
	gfd_to_key
;

	@platform/posix/io/io_context_eventfd.cc

18 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_ev’tfd.h
"

20 
cÚ¡ex´
 
ušt64_t
 
	gkMaxCouÁ”
 = 0xfffffffffffffffe;

21 
cÚ¡ex´
 
ssize_t
 
	gkCouÁ”BufSize
 = (
ušt64_t
);

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	gio
 {

26 
ssize_t
 
	gIOCÚ‹xtEv’tFd
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

27 ià(
	gcouÁ
 < 
	gkCouÁ”BufSize
) {

28 
	g”ºo
 = 
EINVAL
;

31 
	gab¦
::
Mu‹xLock
 
couÁ”_mu‹x_lock
(&
couÁ”_mu‹x_
);

32 ià(
	gnÚblock_
 && (
	gcouÁ”_
 == 0)) {

33 
”ºo
 = 
EAGAIN
;

36 autØ
	g»ady
 = [
this
](è{  
couÁ”_
 > 0; };

37 
	gcouÁ”_mu‹x_
.
Awa™
(
ab¦
::
CÚd™iÚ
(&
»ady
));

39 ià(
	g£m­hÜe_
) {

40 *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gbuf
) = 1;

41 --
	gcouÁ”_
;

43 *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gbuf
èğ
couÁ”_
;

44 
	gcouÁ”_
 = 0;

46  
	gkCouÁ”BufSize
;

49 
ssize_t
 
	gIOCÚ‹xtEv’tFd
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

50 ià(
	gcouÁ
 < 
	gkCouÁ”BufSize
) {

51 
	g”ºo
 = 
EINVAL
;

54 
ušt64_t
 
	gadd
 = *
»š‹½»t_ÿ¡
<cÚ¡ ušt64_ˆ*>(
buf
);

55 ià(
	gadd
 > 
	gkMaxCouÁ”
) {

56 
	g”ºo
 = 
EINVAL
;

59 
	gab¦
::
Mu‹xLock
 
couÁ”_mu‹x_lock
(&
couÁ”_mu‹x_
);

60 ià(
	gnÚblock_
 && (
	gcouÁ”_
 + 
	gadd
 > 
	gkMaxCouÁ”
)) {

61 
	g”ºo
 = 
EAGAIN
;

64 autØ
	g»ady
 = [
this
, 
add
](è{  (
	gcouÁ”_
 + 
	gadd
è<ğ
kMaxCouÁ”
; };

65 
	gcouÁ”_mu‹x_
.
Awa™
(
ab¦
::
CÚd™iÚ
(&
»ady
));

67 
	gcouÁ”_
 +ğ
add
;

68  
	gkCouÁ”BufSize
;

71 
	gIOCÚ‹xtEv’tFd
::
Clo£
() {

	@platform/posix/io/io_context_eventfd.cc

18 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_ev’tfd.h
"

20 
cÚ¡ex´
 
ušt64_t
 
	gkMaxCouÁ”
 = 0xfffffffffffffffe;

21 
cÚ¡ex´
 
ssize_t
 
	gkCouÁ”BufSize
 = (
ušt64_t
);

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	gio
 {

26 
ssize_t
 
	gIOCÚ‹xtEv’tFd
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

27 ià(
	gcouÁ
 < 
	gkCouÁ”BufSize
) {

28 
	g”ºo
 = 
EINVAL
;

31 
	gab¦
::
Mu‹xLock
 
couÁ”_mu‹x_lock
(&
couÁ”_mu‹x_
);

32 ià(
	gnÚblock_
 && (
	gcouÁ”_
 == 0)) {

33 
”ºo
 = 
EAGAIN
;

36 autØ
	g»ady
 = [
this
](è{  
couÁ”_
 > 0; };

37 
	gcouÁ”_mu‹x_
.
Awa™
(
ab¦
::
CÚd™iÚ
(&
»ady
));

39 ià(
	g£m­hÜe_
) {

40 *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gbuf
) = 1;

41 --
	gcouÁ”_
;

43 *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gbuf
èğ
couÁ”_
;

44 
	gcouÁ”_
 = 0;

46  
	gkCouÁ”BufSize
;

49 
ssize_t
 
	gIOCÚ‹xtEv’tFd
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

50 ià(
	gcouÁ
 < 
	gkCouÁ”BufSize
) {

51 
	g”ºo
 = 
EINVAL
;

54 
ušt64_t
 
	gadd
 = *
»š‹½»t_ÿ¡
<cÚ¡ ušt64_ˆ*>(
buf
);

55 ià(
	gadd
 > 
	gkMaxCouÁ”
) {

56 
	g”ºo
 = 
EINVAL
;

59 
	gab¦
::
Mu‹xLock
 
couÁ”_mu‹x_lock
(&
couÁ”_mu‹x_
);

60 ià(
	gnÚblock_
 && (
	gcouÁ”_
 + 
	gadd
 > 
	gkMaxCouÁ”
)) {

61 
	g”ºo
 = 
EAGAIN
;

64 autØ
	g»ady
 = [
this
, 
add
](è{  (
	gcouÁ”_
 + 
	gadd
è<ğ
kMaxCouÁ”
; };

65 
	gcouÁ”_mu‹x_
.
Awa™
(
ab¦
::
CÚd™iÚ
(&
»ady
));

67 
	gcouÁ”_
 +ğ
add
;

68  
	gkCouÁ”BufSize
;

71 
	gIOCÚ‹xtEv’tFd
::
Clo£
() {

	@platform/posix/io/io_context_eventfd.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_IO_CONTEXT_EVENTFD_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_IO_CONTEXT_EVENTFD_H_


	)

22 
	~<sys/ev’tfd.h
>

24 
	~<th»ad
>

26 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

27 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gio
 {

32 şas 
	cIOCÚ‹xtEv’tFd
 : 
public
 
IOMªag”
::
IOCÚ‹xt
 {

33 
public
:

34 
ex¶ic™
 
IOCÚ‹xtEv’tFd
(
š™v®
, 
æags
)

35 : 
couÁ”_
(
š™v®
) {

36 ià(
æags
 & 
EFD_SEMAPHORE
) {

37 
£m­hÜe_
 = 
Œue
;

39 
	g£m­hÜe_
 = 
çl£
;

41 ià(
	gæags
 & 
	gEFD_NONBLOCK
) {

42 
	gnÚblock_
 = 
Œue
;

44 
	gnÚblock_
 = 
çl£
;

48 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
è
	gov”ride
;

49 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
è
	gov”ride
;

50 
Clo£
(è
	gov”ride
;

52 
	g´iv©e
:

54 
ušt64_t
 
couÁ”_
;

55 
boŞ
 
	g£m­hÜe_
;

56 
boŞ
 
	gnÚblock_
;

57 
	gab¦
::
Mu‹x
 
couÁ”_mu‹x_
;

	@platform/posix/io/io_context_inotify.cc

18 
	~<sys/šÙify.h
>

20 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

21 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

22 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

23 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_šÙify.h
"

24 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gio
 {

29 
	gIOCÚ‹xtInÙify
::
G‘Ho¡FeDesütÜ
(è{  
ho¡_fd_
; }

31 
	gIOCÚ‹xtInÙify
::
InÙifyAddW©ch
(cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
) {

32  
’c_uÁru¡ed_šÙify_add_w©ch
(
ho¡_fd_
, 
·thÇme
, 
mask
);

35 
	gIOCÚ‹xtInÙify
::
InÙifyRmW©ch
(
wd
) {

36  
’c_uÁru¡ed_šÙify_rm_w©ch
(
ho¡_fd_
, 
wd
);

39 
size_t
 
	gIOCÚ‹xtInÙify
::
T¿nsãrFromQueueToBufãr
(*
buf_±r
,

40 
size_t
 
couÁ
) {

41 
size_t
 
	gnum_by‹s_wr™‹n
 = 0;

42 !
	gev’t_queue_
.
em±y
()) {

43 
šÙify_ev’t
 *
	gäÚt_ev’t
 = 
ev’t_queue_
.
äÚt
();

44 
size_t
 
	gäÚt_ev’t_Ën
 = (
šÙify_ev’t
è+ 
äÚt_ev’t
->
Ën
;

45 ià(
	gcouÁ
 < 
	gäÚt_ev’t_Ën
) {

46  
	gnum_by‹s_wr™‹n
;

48 
memıy
(
buf_±r
, 
äÚt_ev’t
, 
äÚt_ev’t_Ën
);

49 
	gbuf_±r
 +ğ
äÚt_ev’t_Ën
;

50 
	gnum_by‹s_wr™‹n
 +ğ
äÚt_ev’t_Ën
;

51 
	gcouÁ
 -ğ
äÚt_ev’t_Ën
;

52 
	gasylo
::
M®locUniquePŒ
<
šÙify_ev’t
> 
ev_±r
(
äÚt_ev’t
);

53 
	gev’t_queue_
.
pİ
();

55  
	gnum_by‹s_wr™‹n
;

58 
ssize_t
 
	gIOCÚ‹xtInÙify
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

60 *
	gbuf_±r
 = 
¡©ic_ÿ¡
<*>(
buf
);

61 
size_t
 
	gnum_by‹s_wr™‹n
 = 
T¿nsãrFromQueueToBufãr
(
buf_±r
, 
couÁ
);

62 
	gbuf_±r
 +ğ
num_by‹s_wr™‹n
;

63 
	gcouÁ
 -ğ
num_by‹s_wr™‹n
; ià(!
	gev’t_queue_
.
em±y
(è&& (
	gnum_by‹s_wr™‹n
 == 0)) {

64 
”ºo
 = 
EINVAL
;

66 } ià(!
	gev’t_queue_
.
em±y
(è|| 
	gcouÁ
 == 0) {

68  
num_by‹s_wr™‹n
;

71 *
	g£rŸlized_ev’ts
 = 
nuÎ±r
;

72 
size_t
 
	gËn
 = 0;

73 ià(
’c_uÁru¡ed_šÙify_»ad
(
ho¡_fd_
, 
couÁ
, &
£rŸlized_ev’ts
, &
Ën
) <

78 
	gasylo
::
UÁru¡edUniquePŒ
<> 
£rŸlized_ev’ts_±r
(
£rŸlized_ev’ts
);

80 
	g¡d
::
¡ršg
 
£rŸlized_ev’ts_¡r
(
£rŸlized_ev’ts
, 
Ën
);

81 ià(!
	gasylo
::
De£rŸlizeInÙifyEv’ts
(
£rŸlized_ev’ts_¡r
, &
ev’t_queue_
)) {

82 
	g”ºo
 = 
EBADE
;

86 
	gnum_by‹s_wr™‹n
 +ğ
T¿nsãrFromQueueToBufãr
(
buf_±r
, 
couÁ
);

87 ià(!
	gev’t_queue_
.
em±y
(è&& (
	gnum_by‹s_wr™‹n
 == 0)) {

88 
”ºo
 = 
EINVAL
;

91  
	gnum_by‹s_wr™‹n
;

94 
ssize_t
 
	gIOCÚ‹xtInÙify
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

95 
	g”ºo
 = 
EBADF
;

99 
	gIOCÚ‹xtInÙify
::
Clo£
(è{  
’c_uÁru¡ed_şo£
(
ho¡_fd_
); }

	@platform/posix/io/io_context_inotify.cc

18 
	~<sys/šÙify.h
>

20 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

21 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

22 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

23 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_šÙify.h
"

24 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gio
 {

29 
	gIOCÚ‹xtInÙify
::
G‘Ho¡FeDesütÜ
(è{  
ho¡_fd_
; }

31 
	gIOCÚ‹xtInÙify
::
InÙifyAddW©ch
(cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
) {

32  
’c_uÁru¡ed_šÙify_add_w©ch
(
ho¡_fd_
, 
·thÇme
, 
mask
);

35 
	gIOCÚ‹xtInÙify
::
InÙifyRmW©ch
(
wd
) {

36  
’c_uÁru¡ed_šÙify_rm_w©ch
(
ho¡_fd_
, 
wd
);

39 
size_t
 
	gIOCÚ‹xtInÙify
::
T¿nsãrFromQueueToBufãr
(*
buf_±r
,

40 
size_t
 
couÁ
) {

41 
size_t
 
	gnum_by‹s_wr™‹n
 = 0;

42 !
	gev’t_queue_
.
em±y
()) {

43 
šÙify_ev’t
 *
	gäÚt_ev’t
 = 
ev’t_queue_
.
äÚt
();

44 
size_t
 
	gäÚt_ev’t_Ën
 = (
šÙify_ev’t
è+ 
äÚt_ev’t
->
Ën
;

45 ià(
	gcouÁ
 < 
	gäÚt_ev’t_Ën
) {

46  
	gnum_by‹s_wr™‹n
;

48 
memıy
(
buf_±r
, 
äÚt_ev’t
, 
äÚt_ev’t_Ën
);

49 
	gbuf_±r
 +ğ
äÚt_ev’t_Ën
;

50 
	gnum_by‹s_wr™‹n
 +ğ
äÚt_ev’t_Ën
;

51 
	gcouÁ
 -ğ
äÚt_ev’t_Ën
;

52 
	gasylo
::
M®locUniquePŒ
<
šÙify_ev’t
> 
ev_±r
(
äÚt_ev’t
);

53 
	gev’t_queue_
.
pİ
();

55  
	gnum_by‹s_wr™‹n
;

58 
ssize_t
 
	gIOCÚ‹xtInÙify
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

60 *
	gbuf_±r
 = 
¡©ic_ÿ¡
<*>(
buf
);

61 
size_t
 
	gnum_by‹s_wr™‹n
 = 
T¿nsãrFromQueueToBufãr
(
buf_±r
, 
couÁ
);

62 
	gbuf_±r
 +ğ
num_by‹s_wr™‹n
;

63 
	gcouÁ
 -ğ
num_by‹s_wr™‹n
; ià(!
	gev’t_queue_
.
em±y
(è&& (
	gnum_by‹s_wr™‹n
 == 0)) {

64 
”ºo
 = 
EINVAL
;

66 } ià(!
	gev’t_queue_
.
em±y
(è|| 
	gcouÁ
 == 0) {

68  
num_by‹s_wr™‹n
;

71 *
	g£rŸlized_ev’ts
 = 
nuÎ±r
;

72 
size_t
 
	gËn
 = 0;

73 ià(
’c_uÁru¡ed_šÙify_»ad
(
ho¡_fd_
, 
couÁ
, &
£rŸlized_ev’ts
, &
Ën
) <

78 
	gasylo
::
UÁru¡edUniquePŒ
<> 
£rŸlized_ev’ts_±r
(
£rŸlized_ev’ts
);

80 
	g¡d
::
¡ršg
 
£rŸlized_ev’ts_¡r
(
£rŸlized_ev’ts
, 
Ën
);

81 ià(!
	gasylo
::
De£rŸlizeInÙifyEv’ts
(
£rŸlized_ev’ts_¡r
, &
ev’t_queue_
)) {

82 
	g”ºo
 = 
EBADE
;

86 
	gnum_by‹s_wr™‹n
 +ğ
T¿nsãrFromQueueToBufãr
(
buf_±r
, 
couÁ
);

87 ià(!
	gev’t_queue_
.
em±y
(è&& (
	gnum_by‹s_wr™‹n
 == 0)) {

88 
”ºo
 = 
EINVAL
;

91  
	gnum_by‹s_wr™‹n
;

94 
ssize_t
 
	gIOCÚ‹xtInÙify
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

95 
	g”ºo
 = 
EBADF
;

99 
	gIOCÚ‹xtInÙify
::
Clo£
(è{  
’c_uÁru¡ed_şo£
(
ho¡_fd_
); }

	@platform/posix/io/io_context_inotify.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_IO_CONTEXT_INOTIFY_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_IO_CONTEXT_INOTIFY_H_


	)

22 
	~<sys/šÙify.h
>

24 
	~<queue
>

25 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gio
 {

30 şas 
	cIOCÚ‹xtInÙify
 : 
public
 
IOMªag”
::
IOCÚ‹xt
 {

31 
public
:

32 
ex¶ic™
 
IOCÚ‹xtInÙify
(
ho¡_fd
è: 
ho¡_fd_
(host_fd) {}

35 
G‘Ho¡FeDesütÜ
(è
ov”ride
;

36 
InÙifyAddW©ch
(cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
è
	gov”ride
;

37 
InÙifyRmW©ch
(
wd
è
	gov”ride
;

38 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
è
	gov”ride
;

39 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
è
	gov”ride
;

40 
Clo£
(è
	gov”ride
;

42 
	g´iv©e
:

43 
size_t
 
T¿nsãrFromQueueToBufãr
(*
buf_±r
, size_ˆ
couÁ
);

45 
	gho¡_fd_
;

46 
	g¡d
::
queue
<
šÙify_ev’t
 *> 
ev’t_queue_
;

	@platform/posix/io/io_manager.cc

19 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

21 
	~<fú.h
>

22 
	~<pŞl.h
>

23 
	~<û¼no
>

24 
	~<c¡dšt
>

25 
	~<memÜy
>

27 
	~"ab¦/®gÜ™hm/cÚš”.h
"

28 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

29 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

30 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

31 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

32 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_•Şl.h
"

33 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_ev’tfd.h
"

34 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_šÙify.h
"

35 
	~"asylo/¶©fÜm/posix/io/Çtive_·ths.h
"

36 
	~"asylo/¶©fÜm/posix/io/ut.h
"

37 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

38 
	~"asylo/ut/¡©usÜ.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
Çme¥aû
 
	gio
 {

43 
	gIOMªag”
::
FeDesütÜTabË
::FileDescriptorTable()

44 : 
maximum_fd_soá_lim™
(
kMaxO³nFes
),

45 
maximum_fd_h¬d_lim™
(
kMaxO³nFes
) {}

47 
	g¡d
::
sh¬ed_±r
<
IOMªag”
::
IOCÚ‹xt
> IOMªag”::
FeDesütÜTabË
::
G‘
(

48 
fd
) {

49 ià(!
IsFeDesütÜV®id
(
fd
è|| !
fd_bË_
[fd]è 
nuÎ±r
;

50  
	gfd_bË_
[
fd
]->
G‘
();

53 
	gIOMªag”
::
FeDesütÜTabË
::
D–‘e
(
fd
) {

54 ià(!
IsFeDesütÜV®id
(
fd
))  0;

55 
	gşo£_»suÉ
 = 0;

56 
	gfd_bË_
[
fd
]->
Wr™eClo£ResuÉTo
(&
şo£_»suÉ
);

57 
	gfd_bË_
[
fd
] = 
nuÎ±r
;

58  
	gşo£_»suÉ
;

61 
boŞ
 
	gIOMªag”
::
FeDesütÜTabË
::
IsFeDesütÜUnu£d
(
fd
) {

62 ià(!
IsFeDesütÜV®id
(
fd
)è 
çl£
;

63  !
	gfd_bË_
[
fd
];

66 
	gIOMªag”
::
FeDesütÜTabË
::
In£¹
(
IOCÚ‹xt
 *
cÚ‹xt
) {

67 
fd
 = 
G‘NextF»eFeDesütÜ
(0);

68 ià(
	gfd
 < 0) {

71 
	gfd_bË_
[
fd
] = 
¡d
::
make_sh¬ed
<
AutoClo£IOCÚ‹xt
>(
cÚ‹xt
);

72  
	gfd
;

75 
	gIOMªag”
::
FeDesütÜTabË
::
CİyFeDesütÜ
(
Şdfd
, 
¡¬tfd
) {

76 
	gÃwfd
 = 
G‘NextF»eFeDesütÜ
(
¡¬tfd
);

77 ià(!
IsFeDesütÜV®id
(
Şdfd
è|| 
	gÃwfd
 == -1) {

80 
	gfd_bË_
[
Ãwfd
] = 
fd_bË_
[
Şdfd
];

81  
	gÃwfd
;

84 
	gIOMªag”
::
FeDesütÜTabË
::
CİyFeDesütÜToS³cif›dT¬g‘
(

85 
Şdfd
, 
Ãwfd
) {

86 ià(!
IsFeDesütÜV®id
(
Şdfd
è|| !IsFeDesütÜV®id(
Ãwfd
) ||

87 
	gfd_bË_
[
Ãwfd
]) {

90 
	gfd_bË_
[
Ãwfd
] = 
fd_bË_
[
Şdfd
];

91  
	gÃwfd
;

94 
boŞ
 
	gIOMªag”
::
FeDesütÜTabË
::
S‘FeDesütÜLim™s
(

95 cÚ¡ 
¾im™
 *
¾im
) {

98 ià(
¾im
->
¾im_max
 <ğ
G‘Highe¡FeDesütÜU£d
()) {

99 
”ºo
 = 
EINVAL
;

100  
	gçl£
;

102 ià(
	g¾im
->
	g¾im_cur
 >„lim->
	g¾im_max
 ||„lim->¾im_max > 
	gkMaxO³nFes
 ||

103 
	g¾im
->
	g¾im_max
 > 
	gmaximum_fd_h¬d_lim™
) {

104 
	g”ºo
 = 
EPERM
;

105  
	gçl£
;

107 
	gmaximum_fd_soá_lim™
 = 
¾im
->
¾im_cur
;

108 
	gmaximum_fd_h¬d_lim™
 = 
¾im
->
¾im_max
;

109  
	gŒue
;

112 
	gIOMªag”
::
FeDesütÜTabË
::
g‘_maximum_fd_soá_lim™
() {

113  
maximum_fd_soá_lim™
;

116 
	gIOMªag”
::
FeDesütÜTabË
::
g‘_maximum_fd_h¬d_lim™
() {

117  
maximum_fd_h¬d_lim™
;

120 
boŞ
 
	gIOMªag”
::
FeDesütÜTabË
::
IsFeDesütÜV®id
(
fd
) {

121  
fd
 >ğ0 && fd < 
kMaxO³nFes
;

124 
	gIOMªag”
::
FeDesütÜTabË
::
G‘Highe¡FeDesütÜU£d
() {

125 
i
 = 
kMaxO³nFes
 - 1; 
	gi
 >= 0; --i) {

126 ià(
	gfd_bË_
[
i
]) {

127  
	gi
;

133 
	gIOMªag”
::
FeDesütÜTabË
::
G‘NextF»eFeDesütÜ
(
¡¬tfd
) {

134 ià(
¡¬tfd
 < 0) {

137 
	gfd
 = -1;

138 
	gi
 = 
¡¬tfd
; i < 
	gmaximum_fd_soá_lim™
; ++i) {

139 ià(!
	gfd_bË_
[
i
]) {

140 
	gfd
 = 
i
;

144  
	gfd
;

147 
	gIOMªag”
::
Acûss
(cÚ¡ *
·th
, 
mode
) {

148  
C®lW™hHªdËr
(

149 
·th
, [
mode
](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

150  
hªdËr
->
Acûss
(
ÿnÚiÿl_·th
, 
mode
);

154 
	gIOMªag”
::
Clo£FeDesütÜ
(
fd
) {

155 
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

156 ià(
	gcÚ‹xt
) {

157  
	gfd_bË_
.
D–‘e
(
fd
);

159 
	g”ºo
 = 
EBADF
;

163 
	gIOMªag”
::
Clo£
(
fd
) {

164 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

165  
Clo£FeDesütÜ
(
fd
);

168 
	gIOMªag”
::
Vœtu®P©hHªdËr
 *
IOMªag”
::
HªdËrFÜP©h
(

169 
ab¦
::
¡ršg_v›w
 
·th
) const {

171 
¡d
::
¡ršg
 
cu¼’t_´efix
(
·th
);

174 
	gŒue
) {

178 autØ
	g™”
 = 
´efix_to_hªdËr_
.
low”_bound
(
cu¼’t_´efix
);

184 ià(
	g™”
 !ğ
´efix_to_hªdËr_
.
’d
(è&& 
cu¼’t_´efix
 =ğ
™”
->
fœ¡
) {

185  
™”
->
£cÚd
.
g‘
();

190 ià(
	g™”
 =ğ
´efix_to_hªdËr_
.
begš
()) ;

191 --
	g™”
;

195 
	g¡d
::
¡ršg
::
cÚ¡_™”©Ü
 
’d_´efix
, 
	g’d_·th
;

196 
	g¡d
::
t›
(
’d_´efix
, 
’d_·th
) =

197 
ab¦
::
c_mism©ch
(
™”
->
fœ¡
, 
cu¼’t_´efix
);

200 ià(
	g’d_´efix
 =ğ
™”
->
fœ¡
.
’d
(è&& *
’d_·th
 == '/') {

201  
™”
->
£cÚd
.
g‘
();

207 *
	g’d_´efix
 !ğ'/'è--
’d_´efix
;

211 
	gcu¼’t_´efix
 = 
¡d
::
¡ršg
(
™”
->
fœ¡
.
begš
(), 
’d_´efix
);

215  
	gnuÎ±r
;

218 
	gIOMªag”
::
O³n
(cÚ¡ *
·th
, 
æags
, 
mode_t
 
mode
) {

219  
C®lW™hHªdËr
(
·th
, [
æags
, 
mode
, 
this
](
Vœtu®P©hHªdËr
 *
hªdËr
,

220 cÚ¡ *
ÿnÚiÿl_·th
) {

221 
¡d
::
unique_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 =

222 
hªdËr
->
O³n
(
ÿnÚiÿl_·th
, 
æags
, 
mode
);

224 ià(
cÚ‹xt
) {

225 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

226 
fd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

227 ià(
fd
 >= 0) {

228 
cÚ‹xt
.
»Ëa£
();

229  
fd
;

231 
”ºo
 = 
ENFILE
;

237 
	gIOMªag”
::
Dup
(
Şdfd
) {

238 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

239 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
Şdfd
)) {

240 
	g»t
 = 
fd_bË_
.
CİyFeDesütÜ
(
Şdfd
, 0);

241 ià(
	g»t
 < 0) {

242 
	g”ºo
 = 
EINVAL
;

244  
	g»t
;

246 
	g”ºo
 = 
EBADF
;

250 
	gIOMªag”
::
Dup2
(
Şdfd
, 
Ãwfd
) {

251 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

252 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
Şdfd
)) {

253 ià(
	gŞdfd
 =ğ
Ãwfd
) {

254  
Ãwfd
;

256 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
Ãwfd
) &&

257 
Clo£FeDesütÜ
(
Ãwfd
) == -1) {

260 
	g»t
 = 
fd_bË_
.
CİyFeDesütÜToS³cif›dT¬g‘
(
Şdfd
, 
Ãwfd
);

261 ià(
	g»t
 < 0) {

262 
	g”ºo
 = 
EINVAL
;

264  
	g»t
;

266 
	g”ºo
 = 
EBADF
;

270 
	gIOMªag”
::
Pe
(
pefd
[2], 
æags
) {

271 
	g»s
 = 
’c_uÁru¡ed_pe2
(
pefd
, 
æags
);

272 ià(
	g»s
 != -1) {

273 
pefd
[0] = 
Regi¡”Ho¡FeDesütÜ
(pipefd[0]);

274 
	gpefd
[1] = 
Regi¡”Ho¡FeDesütÜ
(
pefd
[1]);

275 ià(
	gpefd
[0] < 0 ||…ipefd[1] < 0) {

276 
	g”ºo
 = 
EMFILE
;

280  
	g»s
;

283 
	gIOMªag”
::
S–eù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
,

284 
fd_£t
 *
exû±fds
, 
timev®
 *
timeout
) {

285 ià(
	gnfds
 < 0) {

286 
	g”ºo
 = 
EINVAL
;

291 
fd_£t
 
	gho¡_»adfds
, 
	gho¡_wr™efds
, 
	gho¡_exû±fds
;

292 
FD_ZERO
(&
ho¡_»adfds
);

293 
FD_ZERO
(&
ho¡_wr™efds
);

294 
FD_ZERO
(&
ho¡_exû±fds
);

296 
	gho¡_nfds
 = 0;

297 
	gfd
 = 0; fd < 
	gnfds
; ++fd) {

298 ià(
	g»adfds
 && 
FD_ISSET
(
fd
, 
»adfds
)) {

299 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

300 ià(
	gcÚ‹xt
) {

301 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

302 
FD_SET
(
ho¡_fd
, &
ho¡_»adfds
);

303 
	gho¡_nfds
 = 
¡d
::
max
(
ho¡_nfds
, 
ho¡_fd
 + 1);

306 ià(
	gwr™efds
 && 
FD_ISSET
(
fd
, 
wr™efds
)) {

307 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

308 ià(
	gcÚ‹xt
) {

309 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

310 
FD_SET
(
ho¡_fd
, &
ho¡_wr™efds
);

311 
	gho¡_nfds
 = 
¡d
::
max
(
ho¡_nfds
, 
ho¡_fd
 + 1);

314 ià(
	gexû±fds
 && 
FD_ISSET
(
fd
, 
exû±fds
)) {

315 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

316 ià(
	gcÚ‹xt
) {

317 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

318 
FD_SET
(
ho¡_fd
, &
ho¡_exû±fds
);

319 
	gho¡_nfds
 = 
¡d
::
max
(
ho¡_nfds
, 
ho¡_fd
 + 1);

323 
	g»t
 = 
’c_uÁru¡ed_£Ëù
(
ho¡_nfds
, &
ho¡_»adfds
, &
ho¡_wr™efds
,

324 &
ho¡_exû±fds
, 
timeout
);

327 ià(
	g»t
 < 0) {

328  
	g»t
;

332 
	gab¦
::
æ©_hash_£t
<> 
ho¡_»adfds_£t
, 
	gho¡_wr™efds_£t
,

333 
	gho¡_exû±fds_£t
;

334 
	gfd
 = 0; fd < 
	gnfds
; ++fd) {

335 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

336 ià(
	gcÚ‹xt
) {

337 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

338 ià(
FD_ISSET
(
ho¡_fd
, &
ho¡_»adfds
)) {

339 
	gho¡_»adfds_£t
.
š£¹
(
ho¡_fd
);

341 ià(
FD_ISSET
(
ho¡_fd
, &
ho¡_wr™efds
)) {

342 
	gho¡_wr™efds_£t
.
š£¹
(
ho¡_fd
);

344 ià(
FD_ISSET
(
ho¡_fd
, &
ho¡_exû±fds
)) {

345 
	gho¡_exû±fds_£t
.
š£¹
(
ho¡_fd
);

350 ià(
	g»adfds
) {

351 
FD_ZERO
(
»adfds
);

353 ià(
	gwr™efds
) {

354 
FD_ZERO
(
wr™efds
);

356 ià(
	gexû±fds
) {

357 
FD_ZERO
(
exû±fds
);

362 
	gfd
 = 0; fd < 
	gnfds
; ++fd) {

363 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

364 ià(
	gcÚ‹xt
) {

365 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

366 ià(
	g»adfds
 && 
	gho¡_»adfds_£t
.
fšd
(
ho¡_fd
è!ğ
ho¡_»adfds_£t
.
’d
()) {

367 
FD_SET
(
fd
, 
»adfds
);

369 ià(
	gwr™efds
 &&

370 
	gho¡_wr™efds_£t
.
fšd
(
ho¡_fd
è!ğ
ho¡_wr™efds_£t
.
’d
()) {

371 
FD_SET
(
fd
, 
wr™efds
);

373 ià(
	gexû±fds
 &&

374 
	gho¡_exû±fds_£t
.
fšd
(
ho¡_fd
è!ğ
ho¡_exû±fds_£t
.
’d
()) {

375 
FD_SET
(
fd
, 
exû±fds
);

379  
	g»t
;

382 
	gIOMªag”
::
PŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
) {

383 
	g¡d
::
veùÜ
<> 
’şave_fd
(
nfds
);

385 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

386 
	gi
 = 0; i < 
	gnfds
; ++i) {

387 
	g’şave_fd
[
i
] = 
fds
[i].
fd
;

388 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
’şave_fd
[
i
]);

389 ià(
	gcÚ‹xt
) {

390 
	gfds
[
i
].
	gfd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

392 
	gfds
[
i
].
	gfd
 = -1;

396 
	g»t
 = 
’c_uÁru¡ed_pŞl
(
fds
, 
nfds
, 
timeout
);

397 
	gi
 = 0; i < 
	gnfds
; ++i) {

398 
	gfds
[
i
].
	gfd
 = 
’şave_fd
[i];

400  
	g»t
;

403 
	gIOMªag”
::
EpŞlC»©e
(
size
) {

404 ià(
size
 < 1) {

405 
”ºo
 = 
EINVAL
;

408 
	gho¡fd
 = 
’c_uÁru¡ed_•Şl_ü—‹
(
size
);

409 ià(
	gho¡fd
 == -1) {

412 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtEpŞl
>(
ho¡fd
);

413 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

414 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

415 ià(
	gfd
 >= 0) {

416 
cÚ‹xt
.
»Ëa£
();

417  
	gfd
;

419 
	g”ºo
 = 
EMFILE
;

423 
	gIOMªag”
::
EpŞlC
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
) {

424 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
;

426 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

427 
	gcÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

429 
	gho¡fd
 = 
cÚ‹xt
 ? cÚ‹xt->
G‘Ho¡FeDesütÜ
() : -1;

430 ià(
	gho¡fd
 == -1) {

431 
”ºo
 = 
EBADF
;

434  
C®lW™hCÚ‹xt
(

435 
•fd
, [
İ
, 
ho¡fd
, 
ev’t
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
•Şl_cÚ‹xt
) {

436  
•Şl_cÚ‹xt
->
EpŞlC
(
İ
, 
ho¡fd
, 
ev’t
);

440 
	gIOMªag”
::
EpŞlWa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

441 
timeout
) {

442  
C®lW™hCÚ‹xt
(

443 
•fd
, [
ev’ts
, 
maxev’ts
, 
timeout
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

444  
cÚ‹xt
->
EpŞlWa™
(
ev’ts
, 
maxev’ts
, 
timeout
);

448 
	gIOMªag”
::
Ev’tFd
(
š™v®
, 
æags
) {

449 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtEv’tFd
>(
š™v®
, 
	gæags
);

450 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

451 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

452 ià(
	gfd
 >= 0) {

453 
cÚ‹xt
.
»Ëa£
();

454  
	gfd
;

456 
	g”ºo
 = 
EMFILE
;

460 
	gIOMªag”
::
InÙifyIn™
(
boŞ
 
nÚ_block
) {

461 
ho¡fd
 = 
’c_uÁru¡ed_šÙify_š™1
(
nÚ_block
);

462 ià(
	gho¡fd
 == -1) {

465 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtInÙify
>(
ho¡fd
);

466 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

467 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

468 ià(
	gfd
 >= 0) {

469 
cÚ‹xt
.
»Ëa£
();

470  
	gfd
;

472 
	g”ºo
 = 
EMFILE
;

476 
	gIOMªag”
::
InÙifyAddW©ch
(
fd
, cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
) {

477  
C®lW™hCÚ‹xt
(

478 
fd
, [
·thÇme
, 
mask
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
šÙify_cÚ‹xt
) {

479  
šÙify_cÚ‹xt
->
InÙifyAddW©ch
(
·thÇme
, 
mask
);

483 
	gIOMªag”
::
InÙifyRmW©ch
(
fd
, 
wd
) {

484  
C®lW™hCÚ‹xt
(
fd
, [
wd
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
šÙify_cÚ‹xt
) {

485  
šÙify_cÚ‹xt
->
InÙifyRmW©ch
(
wd
);

490 
	gÇme¥aû
 {

492 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
, 
	gty³Çme
 = >

493 
E¼ÜV®ue
;

497 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
>

498 
	gE¼ÜV®ue
<
	gTy³
,

499 
ty³Çme
 
	g¡d
::
’abË_if
<
¡d
::
is_sigÃd
<
Ty³
>::
v®ue
>::
ty³
> {

500 
cÚ¡ex´
 
Ty³
 
v®ue
 = -1;

504 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
>

505 
	gE¼ÜV®ue
<
	gTy³
,

506 
ty³Çme
 
	g¡d
::
’abË_if
<
¡d
::
is_poš‹r
<
Ty³
>::
v®ue
>::
ty³
> {

507 
cÚ¡ex´
 
Ty³
 
v®ue
 = 
nuÎ±r
;

512 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,y³Çm
	gR‘uºTy³
>

513 
R‘uºTy³
 
	gIOMªag”
::
C®lW™hCÚ‹xt
(
fd
, 
IOAùiÚ
 
aùiÚ
) {

514 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
;

516 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

517 
	gcÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

519 ià(
	gcÚ‹xt
) {

520  
aùiÚ
(
cÚ‹xt
);

522 
	g”ºo
 = 
EBADF
;

523  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

526 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,y³Çm
	gR‘uºTy³
>

527 
R‘uºTy³
 
	gIOMªag”
::
C®lW™hHªdËr
(cÚ¡ *
·th
, 
IOAùiÚ
 
aùiÚ
) {

528 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡©us
 = 
CªÚiÿlizeP©h
(
·th
);

529 ià(!
	g¡©us
.
ok
()) {

530 
	g”ºo
 = 
¡©us
.¡©us().
”rÜ_code
();

531  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

534 
	gab¦
::
¡ršg_v›w
 
ÿnÚiÿl_·th
 = 
¡©us
.
V®ueOrD›
();

535 
Vœtu®P©hHªdËr
 *
	ghªdËr
 = 
HªdËrFÜP©h
(
ÿnÚiÿl_·th
);

536 ià(
	ghªdËr
) {

538  
aùiÚ
(
hªdËr
, 
ÿnÚiÿl_·th
.
d©a
());

541 
	g”ºo
 = 
ENOENT
;

542  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

545 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,y³Çm
	gR‘uºTy³
>

546 
R‘uºTy³
 
	gIOMªag”
::
C®lW™hHªdËr
(cÚ¡ *
·th1
, cÚ¡ *
·th2
,

547 
IOAùiÚ
 
aùiÚ
) {

548 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡©us1
 = 
CªÚiÿlizeP©h
(
·th1
);

549 ià(!
	g¡©us1
.
ok
()) {

550 
	g”ºo
 = 
¡©us1
.
¡©us
().
”rÜ_code
();

551  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

553 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡©us2
 = 
CªÚiÿlizeP©h
(
·th2
);

554 ià(!
	g¡©us2
.
ok
()) {

555 
	g”ºo
 = 
¡©us2
.
¡©us
().
”rÜ_code
();

556  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

559 
	gab¦
::
¡ršg_v›w
 
ÿnÚiÿl_·th1
 = 
¡©us1
.
V®ueOrD›
();

560 
	gab¦
::
¡ršg_v›w
 
ÿnÚiÿl_·th2
 = 
¡©us2
.
V®ueOrD›
();

561 
Vœtu®P©hHªdËr
 *
	ghªdËr1
 = 
HªdËrFÜP©h
(
ÿnÚiÿl_·th1
);

562 
Vœtu®P©hHªdËr
 *
	ghªdËr2
 = 
HªdËrFÜP©h
(
ÿnÚiÿl_·th2
);

563 ià(
	ghªdËr1
 !ğ
hªdËr2
) {

564 
”ºo
 = 
EXDEV
;

565  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

568 ià(
	ghªdËr1
) {

570  
aùiÚ
(
hªdËr1
, 
ÿnÚiÿl_·th1
.
d©a
(), 
ÿnÚiÿl_·th2
.data());

573 
	g”ºo
 = 
ENOENT
;

574  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

577 
	gIOMªag”
::
R—d
(
fd
, *
buf
, 
size_t
 
couÁ
) {

578  
C®lW™hCÚ‹xt
(
fd
, [
buf
, 
couÁ
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

579  
cÚ‹xt
->
R—d
(
buf
, 
couÁ
);

583 
boŞ
 
	gIOMªag”
::
Regi¡”Vœtu®P©hHªdËr
(

584 cÚ¡ 
¡d
::
¡ršg
 &
·th_´efix
,

585 
¡d
::
unique_±r
<
Vœtu®P©hHªdËr
> 
hªdËr
) {

586 ià(!
hªdËr
 || (!
·th_´efix
.
em±y
() &&

587 (
·th_´efix
.
äÚt
(è!ğ'/' ||…©h_´efix.
back
() == '/'))) {

588  
çl£
;

591 
	g´efix_to_hªdËr_
.
em¶aû
(
·th_´efix
, 
¡d
::
move
(
hªdËr
));

592  
	gŒue
;

595 
	gIOMªag”
::
D”egi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th_´efix
) {

596 
´efix_to_hªdËr_
.
”a£
(
·th_´efix
);

599 
Stus
 
	gIOMªag”
::
S‘Cu¼’tWÜkšgDœeùÜy
(
ab¦
::
¡ršg_v›w
 
·th
) {

600 
StusOr
<
¡d
::
¡ršg
> 
wÜkšg_dœeùÜy
 = 
CªÚiÿlizeP©h
(
·th
);

601 
Stus
 
	g¡©us
 = 
wÜkšg_dœeùÜy
.
¡©us
();

602 ià(
	g¡©us
.
ok
()) {

603 
	gcu¼’t_wÜkšg_dœeùÜy_
 = 
wÜkšg_dœeùÜy
.
V®ueOrD›
();

606  
	g¡©us
;

609 
	g¡d
::
¡ršg
 
IOMªag”
::
G‘Cu¼’tWÜkšgDœeùÜy
() const {

610  
cu¼’t_wÜkšg_dœeùÜy_
;

613 
	gStusOr
<
	g¡d
::
¡ršg
> 
IOMªag”
::
CªÚiÿlizeP©h
(

614 
ab¦
::
¡ršg_v›w
 
·th
) const {

616 ià(
·th
.
em±y
()) {

617  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_ENOENT
,

623 
Vœtu®P©hHªdËr
 *
	g»quœed_hªdËr
 = 
nuÎ±r
;

626 
	g¡d
::
¡ršg
 
»Ïtive_·th
;

627 ià(
	g·th
.
äÚt
() != '/') {

628 
¡d
::
¡ršg
 
wÜkšg_dœeùÜy
 = 
G‘Cu¼’tWÜkšgDœeùÜy
();

632 ià(
	gwÜkšg_dœeùÜy
.
em±y
()) {

633  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_ENOENT
,

639 
	g»Ïtive_·th
 = 
ab¦
::
SŒC©
(
wÜkšg_dœeùÜy
, "/", 
·th
);

640 
	g·th
 = 
»Ïtive_·th
;

644 
	g»quœed_hªdËr
 = 
HªdËrFÜP©h
(
wÜkšg_dœeùÜy
);

648 
	g¡d
::
¡ršg
 
»t
 = 
ut
::
NÜm®izeP©h
(
·th
);

652 ià(
	g»quœed_hªdËr
 && 
HªdËrFÜP©h
(
»t
è!ğ
»quœed_hªdËr
) {

653  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EACCES
,

657  
	g»t
;

660 
	gIOMªag”
::
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

661  
C®lW™hCÚ‹xt
(
fd
, [
buf
, 
couÁ
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

662  
cÚ‹xt
->
Wr™e
(
buf
, 
couÁ
);

666 
	gIOMªag”
::
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

667  
C®lW™hHªdËr
(
·th
, [
owÃr
, 
group
](
Vœtu®P©hHªdËr
 *
hªdËr
,

668 cÚ¡ *
ÿnÚiÿl_·th
) {

669  
hªdËr
->
Chown
(
ÿnÚiÿl_·th
, 
owÃr
, 
group
);

673 *
	gIOMªag”
::
R—lP©h
(cÚ¡ *
·th
, *
»sŞved_·th
) {

674 
	gStusOr
<
	g¡d
::
¡ršg
> 
·th_¡r_Ü
 = 
CªÚiÿlizeP©h
(
·th
);

675 ià(!
	g·th_¡r_Ü
.
ok
()) {

676 
	g”ºo
 = 
·th_¡r_Ü
.
¡©us
().
”rÜ_code
();

678  
	gnuÎ±r
;

680 
	g¡d
::
¡ršg
 
·th_¡r
 = 
·th_¡r_Ü
.
V®ueOrD›
();

681 ià(
	g»sŞved_·th
) {

682 
¢´štf
(
»sŞved_·th
, 
PATH_MAX
, "%s", 
·th_¡r
.
c_¡r
());

683  
	g»sŞved_·th
;

685  
¡rdup
(
·th_¡r
.
c_¡r
());

688 
	gIOMªag”
::
Lšk
(cÚ¡ *
äom
, cÚ¡ *
to
) {

689  
C®lW™hHªdËr
(

690 
äom
, 
to
,

691 [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_äom
,

692 cÚ¡ *
ÿnÚiÿl_to
) {

693  
hªdËr
->
Lšk
(
ÿnÚiÿl_äom
, 
ÿnÚiÿl_to
);

697 
	gIOMªag”
::
UÆšk
(cÚ¡ *
·thÇme
) {

698  
C®lW™hHªdËr
(

699 
·thÇme
, [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

700  
hªdËr
->
UÆšk
(
ÿnÚiÿl_·th
);

704 
ssize_t
 
	gIOMªag”
::
R—dLšk
(cÚ¡ *
·th
, *
buf
, 
size_t
 
bufsize
) {

705  
C®lW™hHªdËr
(
·th
, [
buf
, 
bufsize
](
Vœtu®P©hHªdËr
 *
hªdËr
,

706 cÚ¡ *
ÿnÚiÿl_·th
) {

707  
hªdËr
->
R—dLšk
(
ÿnÚiÿl_·th
, 
buf
, 
bufsize
);

711 
	gIOMªag”
::
SymLšk
(cÚ¡ *
äom
, cÚ¡ *
to
) {

712  
C®lW™hHªdËr
(

713 
äom
, 
to
,

714 [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_äom
,

715 cÚ¡ *
ÿnÚiÿl_to
) {

716  
hªdËr
->
SymLšk
(
ÿnÚiÿl_äom
, 
ÿnÚiÿl_to
);

720 
	gIOMªag”
::
Trunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

721  
C®lW™hHªdËr
(

722 
·th
, [
Ëngth
](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

723  
hªdËr
->
Trunÿ‹
(
ÿnÚiÿl_·th
, 
Ëngth
);

727 
	gIOMªag”
::
FTrunÿ‹
(
fd
, 
off_t
 
Ëngth
) {

728  
C®lW™hCÚ‹xt
(
fd
, [
Ëngth
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

729  
cÚ‹xt
->
FTrunÿ‹
(
Ëngth
);

733 
	gIOMªag”
::
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

734  
C®lW™hHªdËr
(
·thÇme
, [
¡©_bufãr
](
Vœtu®P©hHªdËr
 *
hªdËr
,

735 cÚ¡ *
ÿnÚiÿl_·th
) {

736  
hªdËr
->
St
(
ÿnÚiÿl_·th
, 
¡©_bufãr
);

740 
	gIOMªag”
::
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

741  
C®lW™hHªdËr
(
·thÇme
, [
¡©_bufãr
](
Vœtu®P©hHªdËr
 *
hªdËr
,

742 cÚ¡ *
ÿnÚiÿl_·th
) {

743  
hªdËr
->
LSt
(
ÿnÚiÿl_·th
, 
¡©_bufãr
);

747 
	gIOMªag”
::
ChMod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

748  
C®lW™hHªdËr
(
·thÇme
, [
mode
](
Vœtu®P©hHªdËr
 *
hªdËr
,

749 cÚ¡ *
ÿnÚiÿl_·th
) {

750  
hªdËr
->
ChMod
(
ÿnÚiÿl_·th
, 
mode
);

754 
	gIOMªag”
::
FChOwn
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

755  
C®lW™hCÚ‹xt
(
fd
,

756 [
owÃr
, 
group
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

757  
cÚ‹xt
->
FChOwn
(
owÃr
, 
group
);

761 
	gIOMªag”
::
FChMod
(
fd
, 
mode_t
 
mode
) {

762  
C®lW™hCÚ‹xt
(
fd
, [
mode
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

763  
cÚ‹xt
->
FChMod
(
mode
);

767 
	gIOMªag”
::
LS“k
(
fd
, 
off_t
 
off£t
, 
wh’û
) {

768  
C®lW™hCÚ‹xt
(
fd
,

769 [
off£t
, 
wh’û
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

770  
cÚ‹xt
->
LS“k
(
off£t
, 
wh’û
);

774 
	gIOMªag”
::
FCÁl
(
fd
, 
cmd
, 
št64_t
 
¬g
) {

775 ià(
	gcmd
 =ğ
F_DUPFD
) {

776 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

777 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
fd
)) {

778 
	g»t
 = 
fd_bË_
.
CİyFeDesütÜ
(
fd
, 
¬g
);

779 ià(
	g»t
 < 0) {

780 
	g”ºo
 = 
EINVAL
;

782  
	g»t
;

784 
	g”ºo
 = 
EBADF
;

787  
C®lW™hCÚ‹xt
(
fd
, [
cmd
, 
¬g
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

788  
cÚ‹xt
->
FCÁl
(
cmd
, 
¬g
);

792 
	gIOMªag”
::
FSync
(
fd
) {

793  
C®lW™hCÚ‹xt
(

794 
fd
, [](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
è{  cÚ‹xt->
FSync
(); });

797 
	gIOMªag”
::
FD©aSync
(
fd
) {

798  
C®lW™hCÚ‹xt
(
fd
, [](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

799  
cÚ‹xt
->
FD©aSync
();

803 
	gIOMªag”
::
FSt
(
fd
, 
¡©
 *
¡©_bufãr
) {

804  
C®lW™hCÚ‹xt
(
fd
, [
¡©_bufãr
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

805  
cÚ‹xt
->
FSt
(
¡©_bufãr
);

809 
	gIOMªag”
::
I§‰y
(
fd
) {

810  
C®lW™hCÚ‹xt
(

811 
fd
, [](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
è{  cÚ‹xt->
I§‰y
(); });

814 
	gIOMªag”
::
FLock
(
fd
, 
İ”©iÚ
) {

815  
C®lW™hCÚ‹xt
(
fd
, [
İ”©iÚ
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

816  
cÚ‹xt
->
FLock
(
İ”©iÚ
);

820 
	gIOMªag”
::
Ioùl
(
fd
, 
»que¡
, *
¬gp
) {

821  
C®lW™hCÚ‹xt
(
fd
,

822 [
»que¡
, 
¬gp
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

823  
cÚ‹xt
->
Ioùl
(
»que¡
, 
¬gp
);

827 
	gIOMªag”
::
Mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

828  
C®lW™hHªdËr
(

829 
·th
, [
mode
](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

830  
hªdËr
->
Mkdœ
(
ÿnÚiÿl_·th
, 
mode
);

834 
	gIOMªag”
::
RmDœ
(cÚ¡ *
·thÇme
) {

835  
C®lW™hHªdËr
(

836 
·thÇme
, [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

837  
hªdËr
->
RmDœ
(
ÿnÚiÿl_·th
);

841 
	gIOMªag”
::
R’ame
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

842  
C®lW™hHªdËr
(

843 
Şd·th
, 
Ãw·th
,

844 [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_Şd·th
,

845 cÚ¡ *
ÿnÚiÿl_Ãw·th
) {

846  
hªdËr
->
R’ame
(
ÿnÚiÿl_Şd·th
, 
ÿnÚiÿl_Ãw·th
);

850 
	gIOMªag”
::
Utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
) {

851  
C®lW™hHªdËr
(
f’ame
, [
times
](
Vœtu®P©hHªdËr
 *
hªdËr
,

852 cÚ¡ *
ÿnÚiÿl_·th
) {

853  
hªdËr
->
Utime
(
ÿnÚiÿl_·th
, 
times
);

857 
	gIOMªag”
::
Utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]) {

858  
C®lW™hHªdËr
(
f’ame
, [
times
](
Vœtu®P©hHªdËr
 *
hªdËr
,

859 cÚ¡ *
ÿnÚiÿl_·th
) {

860  
hªdËr
->
Utimes
(
ÿnÚiÿl_·th
, 
times
);

864 
ssize_t
 
	gIOMªag”
::
Wr™ev
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

865  
C®lW™hCÚ‹xt
(
fd
, [
iov
, 
iovút
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

866  
cÚ‹xt
->
Wr™ev
(
iov
, 
iovút
);

870 
ssize_t
 
	gIOMªag”
::
R—dv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

871  
C®lW™hCÚ‹xt
(
fd
, [
iov
, 
iovút
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

872  
cÚ‹xt
->
R—dv
(
iov
, 
iovút
);

876 
mode_t
 
	gIOMªag”
::
Umask
(mode_ˆ
mask
è{  
’c_uÁru¡ed_umask
(mask); }

878 
	gIOMªag”
::
G‘RLim™
(
»sourû
, 
¾im™
 *
¾im
) {

879 ià(!
	g¾im
) {

880 
	g”ºo
 = 
EFAULT
;

883 
	g»sourû
) {

884 
	gRLIMIT_NOFILE
:

886 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

887 
	g¾im
->
	g¾im_cur
 = 
fd_bË_
.
g‘_maximum_fd_soá_lim™
();

888 
	g¾im
->
	g¾im_max
 = 
fd_bË_
.
g‘_maximum_fd_h¬d_lim™
();

892 
”ºo
 = 
ENOSYS
;

897 
	gIOMªag”
::
S‘RLim™
(
»sourû
, cÚ¡ 
¾im™
 *
¾im
) {

898 ià(!
	g¾im
) {

899 
	g”ºo
 = 
EFAULT
;

902 ià(
	g¾im
->
	g¾im_cur
 >„lim->
	g¾im_max
) {

903 
	g”ºo
 = 
EINVAL
;

906 
	g»sourû
) {

907 
	gRLIMIT_NOFILE
:

909 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

910 ià(!
	gfd_bË_
.
S‘FeDesütÜLim™s
(
¾im
)) {

916 
”ºo
 = 
ENOSYS
;

921 
	gIOMªag”
::
S‘SockO±
(
sockfd
, 
Ëv–
, 
İtiÚ_Çme
,

922 cÚ¡ *
İtiÚ_v®ue
, 
sockËn_t
 
İtiÚ_Ën
) {

923  
C®lW™hCÚ‹xt
(
sockfd
, [
Ëv–
, 
İtiÚ_Çme
, 
İtiÚ_v®ue
, 
İtiÚ_Ën
](

924 
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

925  
cÚ‹xt
->
S‘SockO±
(
Ëv–
, 
İtiÚ_Çme
, 
İtiÚ_v®ue
, 
İtiÚ_Ën
);

929 
	gIOMªag”
::
CÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

930 
sockËn_t
 
add¾’
) {

931  
C®lW™hCÚ‹xt
(
sockfd
,

932 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

933  
cÚ‹xt
->
CÚÃù
(
addr
, 
add¾’
);

937 
	gIOMªag”
::
Shutdown
(
sockfd
, 
how
) {

938  
C®lW™hCÚ‹xt
(
sockfd
, [
how
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

939  
cÚ‹xt
->
Shutdown
(
how
);

943 
ssize_t
 
	gIOMªag”
::
S’d
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
) {

944  
C®lW™hCÚ‹xt
(
sockfd
,

945 [
buf
, 
Ën
, 
æags
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

946  
cÚ‹xt
->
S’d
(
buf
, 
Ën
, 
æags
);

950 
	gIOMªag”
::
Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

951 
	gsock‘
 = 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

952 ià(
	gsock‘
 == -1) {

956 
	g»t
 = 
this
->
Regi¡”Ho¡FeDesütÜ
(
sock‘
);

957 ià(
	g»t
 < 0) {

958 
	g”ºo
 = 
EMFILE
;

960  
	g»t
;

963 
	gIOMªag”
::
G‘SockO±
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

964 
sockËn_t
 *
İ’
) {

965  
C®lW™hCÚ‹xt
(
sockfd
, [
Ëv–
, 
İŠame
, 
İtv®
,

966 
İ’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

967  
cÚ‹xt
->
G‘SockO±
(
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
);

971 
	gIOMªag”
::
Acû±
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

972 
	g»t
 = 
C®lW™hCÚ‹xt
(

973 
sockfd
, [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

974  
cÚ‹xt
->
Acû±
(
addr
, 
add¾’
);

976 ià(
	g»t
 < 0) {

979 
	g»t
 = 
this
->
Regi¡”Ho¡FeDesütÜ
(
»t
);

980 ià(
	g»t
 < 0) {

981 
	g”ºo
 = 
EMFILE
;

983  
	g»t
;

986 
	gIOMªag”
::
Bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

987 
sockËn_t
 
add¾’
) {

988  
C®lW™hCÚ‹xt
(
sockfd
,

989 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

990  
cÚ‹xt
->
Bšd
(
addr
, 
add¾’
);

994 
	gIOMªag”
::
Li¡’
(
sockfd
, 
backlog
) {

995  
C®lW™hCÚ‹xt
(
sockfd
, [
backlog
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

996  
cÚ‹xt
->
Li¡’
(
backlog
);

1000 
ssize_t
 
	gIOMªag”
::
S’dMsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
, 
æags
) {

1001  
C®lW™hCÚ‹xt
(
sockfd
,

1002 [
msg
, 
æags
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1003  
cÚ‹xt
->
S’dMsg
(
msg
, 
æags
);

1007 
ssize_t
 
	gIOMªag”
::
RecvMsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
) {

1008  
C®lW™hCÚ‹xt
(
sockfd
,

1009 [
msg
, 
æags
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1010  
cÚ‹xt
->
RecvMsg
(
msg
, 
æags
);

1014 
	gIOMªag”
::
G‘SockName
(
sockfd
, 
sockaddr
 *
addr
,

1015 
sockËn_t
 *
add¾’
) {

1016  
C®lW™hCÚ‹xt
(
sockfd
,

1017 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1018  
cÚ‹xt
->
G‘SockName
(
addr
, 
add¾’
);

1022 
	gIOMªag”
::
G‘P“rName
(
sockfd
, 
sockaddr
 *
addr
,

1023 
sockËn_t
 *
add¾’
) {

1024  
C®lW™hCÚ‹xt
(
sockfd
,

1025 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1026  
cÚ‹xt
->
G‘P“rName
(
addr
, 
add¾’
);

1030 
ssize_t
 
	gIOMªag”
::
RecvFrom
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
,

1031 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
) {

1032  
C®lW™hCÚ‹xt
(
sockfd
, [
buf
, 
Ën
, 
æags
, 
¤c_addr
,

1033 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1034  
cÚ‹xt
->
RecvFrom
(
buf
, 
Ën
, 
æags
, 
¤c_addr
, 
add¾’
);

1038 
	gIOMªag”
::
Regi¡”Ho¡FeDesütÜ
(
ho¡_fd
) {

1039 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

1040 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtN©ive
>(
ho¡_fd
);

1041 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

1042 ià(
	gfd
 >= 0) {

1043 
cÚ‹xt
.
»Ëa£
();

1044  
	gfd
;

	@platform/posix/io/io_manager.cc

19 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

21 
	~<fú.h
>

22 
	~<pŞl.h
>

23 
	~<û¼no
>

24 
	~<c¡dšt
>

25 
	~<memÜy
>

27 
	~"ab¦/®gÜ™hm/cÚš”.h
"

28 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

29 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

30 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

31 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

32 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_•Şl.h
"

33 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_ev’tfd.h
"

34 
	~"asylo/¶©fÜm/posix/io/io_cÚ‹xt_šÙify.h
"

35 
	~"asylo/¶©fÜm/posix/io/Çtive_·ths.h
"

36 
	~"asylo/¶©fÜm/posix/io/ut.h
"

37 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

38 
	~"asylo/ut/¡©usÜ.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
Çme¥aû
 
	gio
 {

43 
	gIOMªag”
::
FeDesütÜTabË
::FileDescriptorTable()

44 : 
maximum_fd_soá_lim™
(
kMaxO³nFes
),

45 
maximum_fd_h¬d_lim™
(
kMaxO³nFes
) {}

47 
	g¡d
::
sh¬ed_±r
<
IOMªag”
::
IOCÚ‹xt
> IOMªag”::
FeDesütÜTabË
::
G‘
(

48 
fd
) {

49 ià(!
IsFeDesütÜV®id
(
fd
è|| !
fd_bË_
[fd]è 
nuÎ±r
;

50  
	gfd_bË_
[
fd
]->
G‘
();

53 
	gIOMªag”
::
FeDesütÜTabË
::
D–‘e
(
fd
) {

54 ià(!
IsFeDesütÜV®id
(
fd
))  0;

55 
	gşo£_»suÉ
 = 0;

56 
	gfd_bË_
[
fd
]->
Wr™eClo£ResuÉTo
(&
şo£_»suÉ
);

57 
	gfd_bË_
[
fd
] = 
nuÎ±r
;

58  
	gşo£_»suÉ
;

61 
boŞ
 
	gIOMªag”
::
FeDesütÜTabË
::
IsFeDesütÜUnu£d
(
fd
) {

62 ià(!
IsFeDesütÜV®id
(
fd
)è 
çl£
;

63  !
	gfd_bË_
[
fd
];

66 
	gIOMªag”
::
FeDesütÜTabË
::
In£¹
(
IOCÚ‹xt
 *
cÚ‹xt
) {

67 
fd
 = 
G‘NextF»eFeDesütÜ
(0);

68 ià(
	gfd
 < 0) {

71 
	gfd_bË_
[
fd
] = 
¡d
::
make_sh¬ed
<
AutoClo£IOCÚ‹xt
>(
cÚ‹xt
);

72  
	gfd
;

75 
	gIOMªag”
::
FeDesütÜTabË
::
CİyFeDesütÜ
(
Şdfd
, 
¡¬tfd
) {

76 
	gÃwfd
 = 
G‘NextF»eFeDesütÜ
(
¡¬tfd
);

77 ià(!
IsFeDesütÜV®id
(
Şdfd
è|| 
	gÃwfd
 == -1) {

80 
	gfd_bË_
[
Ãwfd
] = 
fd_bË_
[
Şdfd
];

81  
	gÃwfd
;

84 
	gIOMªag”
::
FeDesütÜTabË
::
CİyFeDesütÜToS³cif›dT¬g‘
(

85 
Şdfd
, 
Ãwfd
) {

86 ià(!
IsFeDesütÜV®id
(
Şdfd
è|| !IsFeDesütÜV®id(
Ãwfd
) ||

87 
	gfd_bË_
[
Ãwfd
]) {

90 
	gfd_bË_
[
Ãwfd
] = 
fd_bË_
[
Şdfd
];

91  
	gÃwfd
;

94 
boŞ
 
	gIOMªag”
::
FeDesütÜTabË
::
S‘FeDesütÜLim™s
(

95 cÚ¡ 
¾im™
 *
¾im
) {

98 ià(
¾im
->
¾im_max
 <ğ
G‘Highe¡FeDesütÜU£d
()) {

99 
”ºo
 = 
EINVAL
;

100  
	gçl£
;

102 ià(
	g¾im
->
	g¾im_cur
 >„lim->
	g¾im_max
 ||„lim->¾im_max > 
	gkMaxO³nFes
 ||

103 
	g¾im
->
	g¾im_max
 > 
	gmaximum_fd_h¬d_lim™
) {

104 
	g”ºo
 = 
EPERM
;

105  
	gçl£
;

107 
	gmaximum_fd_soá_lim™
 = 
¾im
->
¾im_cur
;

108 
	gmaximum_fd_h¬d_lim™
 = 
¾im
->
¾im_max
;

109  
	gŒue
;

112 
	gIOMªag”
::
FeDesütÜTabË
::
g‘_maximum_fd_soá_lim™
() {

113  
maximum_fd_soá_lim™
;

116 
	gIOMªag”
::
FeDesütÜTabË
::
g‘_maximum_fd_h¬d_lim™
() {

117  
maximum_fd_h¬d_lim™
;

120 
boŞ
 
	gIOMªag”
::
FeDesütÜTabË
::
IsFeDesütÜV®id
(
fd
) {

121  
fd
 >ğ0 && fd < 
kMaxO³nFes
;

124 
	gIOMªag”
::
FeDesütÜTabË
::
G‘Highe¡FeDesütÜU£d
() {

125 
i
 = 
kMaxO³nFes
 - 1; 
	gi
 >= 0; --i) {

126 ià(
	gfd_bË_
[
i
]) {

127  
	gi
;

133 
	gIOMªag”
::
FeDesütÜTabË
::
G‘NextF»eFeDesütÜ
(
¡¬tfd
) {

134 ià(
¡¬tfd
 < 0) {

137 
	gfd
 = -1;

138 
	gi
 = 
¡¬tfd
; i < 
	gmaximum_fd_soá_lim™
; ++i) {

139 ià(!
	gfd_bË_
[
i
]) {

140 
	gfd
 = 
i
;

144  
	gfd
;

147 
	gIOMªag”
::
Acûss
(cÚ¡ *
·th
, 
mode
) {

148  
C®lW™hHªdËr
(

149 
·th
, [
mode
](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

150  
hªdËr
->
Acûss
(
ÿnÚiÿl_·th
, 
mode
);

154 
	gIOMªag”
::
Clo£FeDesütÜ
(
fd
) {

155 
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

156 ià(
	gcÚ‹xt
) {

157  
	gfd_bË_
.
D–‘e
(
fd
);

159 
	g”ºo
 = 
EBADF
;

163 
	gIOMªag”
::
Clo£
(
fd
) {

164 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

165  
Clo£FeDesütÜ
(
fd
);

168 
	gIOMªag”
::
Vœtu®P©hHªdËr
 *
IOMªag”
::
HªdËrFÜP©h
(

169 
ab¦
::
¡ršg_v›w
 
·th
) const {

171 
¡d
::
¡ršg
 
cu¼’t_´efix
(
·th
);

174 
	gŒue
) {

178 autØ
	g™”
 = 
´efix_to_hªdËr_
.
low”_bound
(
cu¼’t_´efix
);

184 ià(
	g™”
 !ğ
´efix_to_hªdËr_
.
’d
(è&& 
cu¼’t_´efix
 =ğ
™”
->
fœ¡
) {

185  
™”
->
£cÚd
.
g‘
();

190 ià(
	g™”
 =ğ
´efix_to_hªdËr_
.
begš
()) ;

191 --
	g™”
;

195 
	g¡d
::
¡ršg
::
cÚ¡_™”©Ü
 
’d_´efix
, 
	g’d_·th
;

196 
	g¡d
::
t›
(
’d_´efix
, 
’d_·th
) =

197 
ab¦
::
c_mism©ch
(
™”
->
fœ¡
, 
cu¼’t_´efix
);

200 ià(
	g’d_´efix
 =ğ
™”
->
fœ¡
.
’d
(è&& *
’d_·th
 == '/') {

201  
™”
->
£cÚd
.
g‘
();

207 *
	g’d_´efix
 !ğ'/'è--
’d_´efix
;

211 
	gcu¼’t_´efix
 = 
¡d
::
¡ršg
(
™”
->
fœ¡
.
begš
(), 
’d_´efix
);

215  
	gnuÎ±r
;

218 
	gIOMªag”
::
O³n
(cÚ¡ *
·th
, 
æags
, 
mode_t
 
mode
) {

219  
C®lW™hHªdËr
(
·th
, [
æags
, 
mode
, 
this
](
Vœtu®P©hHªdËr
 *
hªdËr
,

220 cÚ¡ *
ÿnÚiÿl_·th
) {

221 
¡d
::
unique_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 =

222 
hªdËr
->
O³n
(
ÿnÚiÿl_·th
, 
æags
, 
mode
);

224 ià(
cÚ‹xt
) {

225 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

226 
fd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

227 ià(
fd
 >= 0) {

228 
cÚ‹xt
.
»Ëa£
();

229  
fd
;

231 
”ºo
 = 
ENFILE
;

237 
	gIOMªag”
::
Dup
(
Şdfd
) {

238 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

239 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
Şdfd
)) {

240 
	g»t
 = 
fd_bË_
.
CİyFeDesütÜ
(
Şdfd
, 0);

241 ià(
	g»t
 < 0) {

242 
	g”ºo
 = 
EINVAL
;

244  
	g»t
;

246 
	g”ºo
 = 
EBADF
;

250 
	gIOMªag”
::
Dup2
(
Şdfd
, 
Ãwfd
) {

251 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

252 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
Şdfd
)) {

253 ià(
	gŞdfd
 =ğ
Ãwfd
) {

254  
Ãwfd
;

256 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
Ãwfd
) &&

257 
Clo£FeDesütÜ
(
Ãwfd
) == -1) {

260 
	g»t
 = 
fd_bË_
.
CİyFeDesütÜToS³cif›dT¬g‘
(
Şdfd
, 
Ãwfd
);

261 ià(
	g»t
 < 0) {

262 
	g”ºo
 = 
EINVAL
;

264  
	g»t
;

266 
	g”ºo
 = 
EBADF
;

270 
	gIOMªag”
::
Pe
(
pefd
[2], 
æags
) {

271 
	g»s
 = 
’c_uÁru¡ed_pe2
(
pefd
, 
æags
);

272 ià(
	g»s
 != -1) {

273 
pefd
[0] = 
Regi¡”Ho¡FeDesütÜ
(pipefd[0]);

274 
	gpefd
[1] = 
Regi¡”Ho¡FeDesütÜ
(
pefd
[1]);

275 ià(
	gpefd
[0] < 0 ||…ipefd[1] < 0) {

276 
	g”ºo
 = 
EMFILE
;

280  
	g»s
;

283 
	gIOMªag”
::
S–eù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
,

284 
fd_£t
 *
exû±fds
, 
timev®
 *
timeout
) {

285 ià(
	gnfds
 < 0) {

286 
	g”ºo
 = 
EINVAL
;

291 
fd_£t
 
	gho¡_»adfds
, 
	gho¡_wr™efds
, 
	gho¡_exû±fds
;

292 
FD_ZERO
(&
ho¡_»adfds
);

293 
FD_ZERO
(&
ho¡_wr™efds
);

294 
FD_ZERO
(&
ho¡_exû±fds
);

296 
	gho¡_nfds
 = 0;

297 
	gfd
 = 0; fd < 
	gnfds
; ++fd) {

298 ià(
	g»adfds
 && 
FD_ISSET
(
fd
, 
»adfds
)) {

299 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

300 ià(
	gcÚ‹xt
) {

301 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

302 
FD_SET
(
ho¡_fd
, &
ho¡_»adfds
);

303 
	gho¡_nfds
 = 
¡d
::
max
(
ho¡_nfds
, 
ho¡_fd
 + 1);

306 ià(
	gwr™efds
 && 
FD_ISSET
(
fd
, 
wr™efds
)) {

307 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

308 ià(
	gcÚ‹xt
) {

309 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

310 
FD_SET
(
ho¡_fd
, &
ho¡_wr™efds
);

311 
	gho¡_nfds
 = 
¡d
::
max
(
ho¡_nfds
, 
ho¡_fd
 + 1);

314 ià(
	gexû±fds
 && 
FD_ISSET
(
fd
, 
exû±fds
)) {

315 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

316 ià(
	gcÚ‹xt
) {

317 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

318 
FD_SET
(
ho¡_fd
, &
ho¡_exû±fds
);

319 
	gho¡_nfds
 = 
¡d
::
max
(
ho¡_nfds
, 
ho¡_fd
 + 1);

323 
	g»t
 = 
’c_uÁru¡ed_£Ëù
(
ho¡_nfds
, &
ho¡_»adfds
, &
ho¡_wr™efds
,

324 &
ho¡_exû±fds
, 
timeout
);

327 ià(
	g»t
 < 0) {

328  
	g»t
;

332 
	gab¦
::
æ©_hash_£t
<> 
ho¡_»adfds_£t
, 
	gho¡_wr™efds_£t
,

333 
	gho¡_exû±fds_£t
;

334 
	gfd
 = 0; fd < 
	gnfds
; ++fd) {

335 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

336 ià(
	gcÚ‹xt
) {

337 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

338 ià(
FD_ISSET
(
ho¡_fd
, &
ho¡_»adfds
)) {

339 
	gho¡_»adfds_£t
.
š£¹
(
ho¡_fd
);

341 ià(
FD_ISSET
(
ho¡_fd
, &
ho¡_wr™efds
)) {

342 
	gho¡_wr™efds_£t
.
š£¹
(
ho¡_fd
);

344 ià(
FD_ISSET
(
ho¡_fd
, &
ho¡_exû±fds
)) {

345 
	gho¡_exû±fds_£t
.
š£¹
(
ho¡_fd
);

350 ià(
	g»adfds
) {

351 
FD_ZERO
(
»adfds
);

353 ià(
	gwr™efds
) {

354 
FD_ZERO
(
wr™efds
);

356 ià(
	gexû±fds
) {

357 
FD_ZERO
(
exû±fds
);

362 
	gfd
 = 0; fd < 
	gnfds
; ++fd) {

363 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

364 ià(
	gcÚ‹xt
) {

365 
	gho¡_fd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

366 ià(
	g»adfds
 && 
	gho¡_»adfds_£t
.
fšd
(
ho¡_fd
è!ğ
ho¡_»adfds_£t
.
’d
()) {

367 
FD_SET
(
fd
, 
»adfds
);

369 ià(
	gwr™efds
 &&

370 
	gho¡_wr™efds_£t
.
fšd
(
ho¡_fd
è!ğ
ho¡_wr™efds_£t
.
’d
()) {

371 
FD_SET
(
fd
, 
wr™efds
);

373 ià(
	gexû±fds
 &&

374 
	gho¡_exû±fds_£t
.
fšd
(
ho¡_fd
è!ğ
ho¡_exû±fds_£t
.
’d
()) {

375 
FD_SET
(
fd
, 
exû±fds
);

379  
	g»t
;

382 
	gIOMªag”
::
PŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
) {

383 
	g¡d
::
veùÜ
<> 
’şave_fd
(
nfds
);

385 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

386 
	gi
 = 0; i < 
	gnfds
; ++i) {

387 
	g’şave_fd
[
i
] = 
fds
[i].
fd
;

388 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
 = 
fd_bË_
.
G‘
(
’şave_fd
[
i
]);

389 ià(
	gcÚ‹xt
) {

390 
	gfds
[
i
].
	gfd
 = 
cÚ‹xt
->
G‘Ho¡FeDesütÜ
();

392 
	gfds
[
i
].
	gfd
 = -1;

396 
	g»t
 = 
’c_uÁru¡ed_pŞl
(
fds
, 
nfds
, 
timeout
);

397 
	gi
 = 0; i < 
	gnfds
; ++i) {

398 
	gfds
[
i
].
	gfd
 = 
’şave_fd
[i];

400  
	g»t
;

403 
	gIOMªag”
::
EpŞlC»©e
(
size
) {

404 ià(
size
 < 1) {

405 
”ºo
 = 
EINVAL
;

408 
	gho¡fd
 = 
’c_uÁru¡ed_•Şl_ü—‹
(
size
);

409 ià(
	gho¡fd
 == -1) {

412 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtEpŞl
>(
ho¡fd
);

413 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

414 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

415 ià(
	gfd
 >= 0) {

416 
cÚ‹xt
.
»Ëa£
();

417  
	gfd
;

419 
	g”ºo
 = 
EMFILE
;

423 
	gIOMªag”
::
EpŞlC
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
) {

424 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
;

426 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

427 
	gcÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

429 
	gho¡fd
 = 
cÚ‹xt
 ? cÚ‹xt->
G‘Ho¡FeDesütÜ
() : -1;

430 ià(
	gho¡fd
 == -1) {

431 
”ºo
 = 
EBADF
;

434  
C®lW™hCÚ‹xt
(

435 
•fd
, [
İ
, 
ho¡fd
, 
ev’t
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
•Şl_cÚ‹xt
) {

436  
•Şl_cÚ‹xt
->
EpŞlC
(
İ
, 
ho¡fd
, 
ev’t
);

440 
	gIOMªag”
::
EpŞlWa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

441 
timeout
) {

442  
C®lW™hCÚ‹xt
(

443 
•fd
, [
ev’ts
, 
maxev’ts
, 
timeout
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

444  
cÚ‹xt
->
EpŞlWa™
(
ev’ts
, 
maxev’ts
, 
timeout
);

448 
	gIOMªag”
::
Ev’tFd
(
š™v®
, 
æags
) {

449 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtEv’tFd
>(
š™v®
, 
	gæags
);

450 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

451 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

452 ià(
	gfd
 >= 0) {

453 
cÚ‹xt
.
»Ëa£
();

454  
	gfd
;

456 
	g”ºo
 = 
EMFILE
;

460 
	gIOMªag”
::
InÙifyIn™
(
boŞ
 
nÚ_block
) {

461 
ho¡fd
 = 
’c_uÁru¡ed_šÙify_š™1
(
nÚ_block
);

462 ià(
	gho¡fd
 == -1) {

465 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtInÙify
>(
ho¡fd
);

466 
	gab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

467 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

468 ià(
	gfd
 >= 0) {

469 
cÚ‹xt
.
»Ëa£
();

470  
	gfd
;

472 
	g”ºo
 = 
EMFILE
;

476 
	gIOMªag”
::
InÙifyAddW©ch
(
fd
, cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
) {

477  
C®lW™hCÚ‹xt
(

478 
fd
, [
·thÇme
, 
mask
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
šÙify_cÚ‹xt
) {

479  
šÙify_cÚ‹xt
->
InÙifyAddW©ch
(
·thÇme
, 
mask
);

483 
	gIOMªag”
::
InÙifyRmW©ch
(
fd
, 
wd
) {

484  
C®lW™hCÚ‹xt
(
fd
, [
wd
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
šÙify_cÚ‹xt
) {

485  
šÙify_cÚ‹xt
->
InÙifyRmW©ch
(
wd
);

490 
	gÇme¥aû
 {

492 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
, 
	gty³Çme
 = >

493 
E¼ÜV®ue
;

497 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
>

498 
	gE¼ÜV®ue
<
	gTy³
,

499 
ty³Çme
 
	g¡d
::
’abË_if
<
¡d
::
is_sigÃd
<
Ty³
>::
v®ue
>::
ty³
> {

500 
cÚ¡ex´
 
Ty³
 
v®ue
 = -1;

504 
	g‹m¶©e
 <
ty³Çme
 
	gTy³
>

505 
	gE¼ÜV®ue
<
	gTy³
,

506 
ty³Çme
 
	g¡d
::
’abË_if
<
¡d
::
is_poš‹r
<
Ty³
>::
v®ue
>::
ty³
> {

507 
cÚ¡ex´
 
Ty³
 
v®ue
 = 
nuÎ±r
;

512 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,y³Çm
	gR‘uºTy³
>

513 
R‘uºTy³
 
	gIOMªag”
::
C®lW™hCÚ‹xt
(
fd
, 
IOAùiÚ
 
aùiÚ
) {

514 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
;

516 
	gab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

517 
	gcÚ‹xt
 = 
fd_bË_
.
G‘
(
fd
);

519 ià(
	gcÚ‹xt
) {

520  
aùiÚ
(
cÚ‹xt
);

522 
	g”ºo
 = 
EBADF
;

523  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

526 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,y³Çm
	gR‘uºTy³
>

527 
R‘uºTy³
 
	gIOMªag”
::
C®lW™hHªdËr
(cÚ¡ *
·th
, 
IOAùiÚ
 
aùiÚ
) {

528 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡©us
 = 
CªÚiÿlizeP©h
(
·th
);

529 ià(!
	g¡©us
.
ok
()) {

530 
	g”ºo
 = 
¡©us
.¡©us().
”rÜ_code
();

531  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

534 
	gab¦
::
¡ršg_v›w
 
ÿnÚiÿl_·th
 = 
¡©us
.
V®ueOrD›
();

535 
Vœtu®P©hHªdËr
 *
	ghªdËr
 = 
HªdËrFÜP©h
(
ÿnÚiÿl_·th
);

536 ià(
	ghªdËr
) {

538  
aùiÚ
(
hªdËr
, 
ÿnÚiÿl_·th
.
d©a
());

541 
	g”ºo
 = 
ENOENT
;

542  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

545 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,y³Çm
	gR‘uºTy³
>

546 
R‘uºTy³
 
	gIOMªag”
::
C®lW™hHªdËr
(cÚ¡ *
·th1
, cÚ¡ *
·th2
,

547 
IOAùiÚ
 
aùiÚ
) {

548 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡©us1
 = 
CªÚiÿlizeP©h
(
·th1
);

549 ià(!
	g¡©us1
.
ok
()) {

550 
	g”ºo
 = 
¡©us1
.
¡©us
().
”rÜ_code
();

551  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

553 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡©us2
 = 
CªÚiÿlizeP©h
(
·th2
);

554 ià(!
	g¡©us2
.
ok
()) {

555 
	g”ºo
 = 
¡©us2
.
¡©us
().
”rÜ_code
();

556  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

559 
	gab¦
::
¡ršg_v›w
 
ÿnÚiÿl_·th1
 = 
¡©us1
.
V®ueOrD›
();

560 
	gab¦
::
¡ršg_v›w
 
ÿnÚiÿl_·th2
 = 
¡©us2
.
V®ueOrD›
();

561 
Vœtu®P©hHªdËr
 *
	ghªdËr1
 = 
HªdËrFÜP©h
(
ÿnÚiÿl_·th1
);

562 
Vœtu®P©hHªdËr
 *
	ghªdËr2
 = 
HªdËrFÜP©h
(
ÿnÚiÿl_·th2
);

563 ià(
	ghªdËr1
 !ğ
hªdËr2
) {

564 
”ºo
 = 
EXDEV
;

565  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

568 ià(
	ghªdËr1
) {

570  
aùiÚ
(
hªdËr1
, 
ÿnÚiÿl_·th1
.
d©a
(), 
ÿnÚiÿl_·th2
.data());

573 
	g”ºo
 = 
ENOENT
;

574  
	gE¼ÜV®ue
<
	gR‘uºTy³
>::
v®ue
;

577 
	gIOMªag”
::
R—d
(
fd
, *
buf
, 
size_t
 
couÁ
) {

578  
C®lW™hCÚ‹xt
(
fd
, [
buf
, 
couÁ
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

579  
cÚ‹xt
->
R—d
(
buf
, 
couÁ
);

583 
boŞ
 
	gIOMªag”
::
Regi¡”Vœtu®P©hHªdËr
(

584 cÚ¡ 
¡d
::
¡ršg
 &
·th_´efix
,

585 
¡d
::
unique_±r
<
Vœtu®P©hHªdËr
> 
hªdËr
) {

586 ià(!
hªdËr
 || (!
·th_´efix
.
em±y
() &&

587 (
·th_´efix
.
äÚt
(è!ğ'/' ||…©h_´efix.
back
() == '/'))) {

588  
çl£
;

591 
	g´efix_to_hªdËr_
.
em¶aû
(
·th_´efix
, 
¡d
::
move
(
hªdËr
));

592  
	gŒue
;

595 
	gIOMªag”
::
D”egi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th_´efix
) {

596 
´efix_to_hªdËr_
.
”a£
(
·th_´efix
);

599 
Stus
 
	gIOMªag”
::
S‘Cu¼’tWÜkšgDœeùÜy
(
ab¦
::
¡ršg_v›w
 
·th
) {

600 
StusOr
<
¡d
::
¡ršg
> 
wÜkšg_dœeùÜy
 = 
CªÚiÿlizeP©h
(
·th
);

601 
Stus
 
	g¡©us
 = 
wÜkšg_dœeùÜy
.
¡©us
();

602 ià(
	g¡©us
.
ok
()) {

603 
	gcu¼’t_wÜkšg_dœeùÜy_
 = 
wÜkšg_dœeùÜy
.
V®ueOrD›
();

606  
	g¡©us
;

609 
	g¡d
::
¡ršg
 
IOMªag”
::
G‘Cu¼’tWÜkšgDœeùÜy
() const {

610  
cu¼’t_wÜkšg_dœeùÜy_
;

613 
	gStusOr
<
	g¡d
::
¡ršg
> 
IOMªag”
::
CªÚiÿlizeP©h
(

614 
ab¦
::
¡ršg_v›w
 
·th
) const {

616 ià(
·th
.
em±y
()) {

617  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_ENOENT
,

623 
Vœtu®P©hHªdËr
 *
	g»quœed_hªdËr
 = 
nuÎ±r
;

626 
	g¡d
::
¡ršg
 
»Ïtive_·th
;

627 ià(
	g·th
.
äÚt
() != '/') {

628 
¡d
::
¡ršg
 
wÜkšg_dœeùÜy
 = 
G‘Cu¼’tWÜkšgDœeùÜy
();

632 ià(
	gwÜkšg_dœeùÜy
.
em±y
()) {

633  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_ENOENT
,

639 
	g»Ïtive_·th
 = 
ab¦
::
SŒC©
(
wÜkšg_dœeùÜy
, "/", 
·th
);

640 
	g·th
 = 
»Ïtive_·th
;

644 
	g»quœed_hªdËr
 = 
HªdËrFÜP©h
(
wÜkšg_dœeùÜy
);

648 
	g¡d
::
¡ršg
 
»t
 = 
ut
::
NÜm®izeP©h
(
·th
);

652 ià(
	g»quœed_hªdËr
 && 
HªdËrFÜP©h
(
»t
è!ğ
»quœed_hªdËr
) {

653  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EACCES
,

657  
	g»t
;

660 
	gIOMªag”
::
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

661  
C®lW™hCÚ‹xt
(
fd
, [
buf
, 
couÁ
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

662  
cÚ‹xt
->
Wr™e
(
buf
, 
couÁ
);

666 
	gIOMªag”
::
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

667  
C®lW™hHªdËr
(
·th
, [
owÃr
, 
group
](
Vœtu®P©hHªdËr
 *
hªdËr
,

668 cÚ¡ *
ÿnÚiÿl_·th
) {

669  
hªdËr
->
Chown
(
ÿnÚiÿl_·th
, 
owÃr
, 
group
);

673 *
	gIOMªag”
::
R—lP©h
(cÚ¡ *
·th
, *
»sŞved_·th
) {

674 
	gStusOr
<
	g¡d
::
¡ršg
> 
·th_¡r_Ü
 = 
CªÚiÿlizeP©h
(
·th
);

675 ià(!
	g·th_¡r_Ü
.
ok
()) {

676 
	g”ºo
 = 
·th_¡r_Ü
.
¡©us
().
”rÜ_code
();

678  
	gnuÎ±r
;

680 
	g¡d
::
¡ršg
 
·th_¡r
 = 
·th_¡r_Ü
.
V®ueOrD›
();

681 ià(
	g»sŞved_·th
) {

682 
¢´štf
(
»sŞved_·th
, 
PATH_MAX
, "%s", 
·th_¡r
.
c_¡r
());

683  
	g»sŞved_·th
;

685  
¡rdup
(
·th_¡r
.
c_¡r
());

688 
	gIOMªag”
::
Lšk
(cÚ¡ *
äom
, cÚ¡ *
to
) {

689  
C®lW™hHªdËr
(

690 
äom
, 
to
,

691 [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_äom
,

692 cÚ¡ *
ÿnÚiÿl_to
) {

693  
hªdËr
->
Lšk
(
ÿnÚiÿl_äom
, 
ÿnÚiÿl_to
);

697 
	gIOMªag”
::
UÆšk
(cÚ¡ *
·thÇme
) {

698  
C®lW™hHªdËr
(

699 
·thÇme
, [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

700  
hªdËr
->
UÆšk
(
ÿnÚiÿl_·th
);

704 
ssize_t
 
	gIOMªag”
::
R—dLšk
(cÚ¡ *
·th
, *
buf
, 
size_t
 
bufsize
) {

705  
C®lW™hHªdËr
(
·th
, [
buf
, 
bufsize
](
Vœtu®P©hHªdËr
 *
hªdËr
,

706 cÚ¡ *
ÿnÚiÿl_·th
) {

707  
hªdËr
->
R—dLšk
(
ÿnÚiÿl_·th
, 
buf
, 
bufsize
);

711 
	gIOMªag”
::
SymLšk
(cÚ¡ *
äom
, cÚ¡ *
to
) {

712  
C®lW™hHªdËr
(

713 
äom
, 
to
,

714 [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_äom
,

715 cÚ¡ *
ÿnÚiÿl_to
) {

716  
hªdËr
->
SymLšk
(
ÿnÚiÿl_äom
, 
ÿnÚiÿl_to
);

720 
	gIOMªag”
::
Trunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

721  
C®lW™hHªdËr
(

722 
·th
, [
Ëngth
](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

723  
hªdËr
->
Trunÿ‹
(
ÿnÚiÿl_·th
, 
Ëngth
);

727 
	gIOMªag”
::
FTrunÿ‹
(
fd
, 
off_t
 
Ëngth
) {

728  
C®lW™hCÚ‹xt
(
fd
, [
Ëngth
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

729  
cÚ‹xt
->
FTrunÿ‹
(
Ëngth
);

733 
	gIOMªag”
::
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

734  
C®lW™hHªdËr
(
·thÇme
, [
¡©_bufãr
](
Vœtu®P©hHªdËr
 *
hªdËr
,

735 cÚ¡ *
ÿnÚiÿl_·th
) {

736  
hªdËr
->
St
(
ÿnÚiÿl_·th
, 
¡©_bufãr
);

740 
	gIOMªag”
::
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

741  
C®lW™hHªdËr
(
·thÇme
, [
¡©_bufãr
](
Vœtu®P©hHªdËr
 *
hªdËr
,

742 cÚ¡ *
ÿnÚiÿl_·th
) {

743  
hªdËr
->
LSt
(
ÿnÚiÿl_·th
, 
¡©_bufãr
);

747 
	gIOMªag”
::
ChMod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

748  
C®lW™hHªdËr
(
·thÇme
, [
mode
](
Vœtu®P©hHªdËr
 *
hªdËr
,

749 cÚ¡ *
ÿnÚiÿl_·th
) {

750  
hªdËr
->
ChMod
(
ÿnÚiÿl_·th
, 
mode
);

754 
	gIOMªag”
::
FChOwn
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

755  
C®lW™hCÚ‹xt
(
fd
,

756 [
owÃr
, 
group
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

757  
cÚ‹xt
->
FChOwn
(
owÃr
, 
group
);

761 
	gIOMªag”
::
FChMod
(
fd
, 
mode_t
 
mode
) {

762  
C®lW™hCÚ‹xt
(
fd
, [
mode
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

763  
cÚ‹xt
->
FChMod
(
mode
);

767 
	gIOMªag”
::
LS“k
(
fd
, 
off_t
 
off£t
, 
wh’û
) {

768  
C®lW™hCÚ‹xt
(
fd
,

769 [
off£t
, 
wh’û
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

770  
cÚ‹xt
->
LS“k
(
off£t
, 
wh’û
);

774 
	gIOMªag”
::
FCÁl
(
fd
, 
cmd
, 
št64_t
 
¬g
) {

775 ià(
	gcmd
 =ğ
F_DUPFD
) {

776 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

777 ià(!
	gfd_bË_
.
IsFeDesütÜUnu£d
(
fd
)) {

778 
	g»t
 = 
fd_bË_
.
CİyFeDesütÜ
(
fd
, 
¬g
);

779 ià(
	g»t
 < 0) {

780 
	g”ºo
 = 
EINVAL
;

782  
	g»t
;

784 
	g”ºo
 = 
EBADF
;

787  
C®lW™hCÚ‹xt
(
fd
, [
cmd
, 
¬g
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

788  
cÚ‹xt
->
FCÁl
(
cmd
, 
¬g
);

792 
	gIOMªag”
::
FSync
(
fd
) {

793  
C®lW™hCÚ‹xt
(

794 
fd
, [](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
è{  cÚ‹xt->
FSync
(); });

797 
	gIOMªag”
::
FD©aSync
(
fd
) {

798  
C®lW™hCÚ‹xt
(
fd
, [](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

799  
cÚ‹xt
->
FD©aSync
();

803 
	gIOMªag”
::
FSt
(
fd
, 
¡©
 *
¡©_bufãr
) {

804  
C®lW™hCÚ‹xt
(
fd
, [
¡©_bufãr
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

805  
cÚ‹xt
->
FSt
(
¡©_bufãr
);

809 
	gIOMªag”
::
I§‰y
(
fd
) {

810  
C®lW™hCÚ‹xt
(

811 
fd
, [](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
è{  cÚ‹xt->
I§‰y
(); });

814 
	gIOMªag”
::
FLock
(
fd
, 
İ”©iÚ
) {

815  
C®lW™hCÚ‹xt
(
fd
, [
İ”©iÚ
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

816  
cÚ‹xt
->
FLock
(
İ”©iÚ
);

820 
	gIOMªag”
::
Ioùl
(
fd
, 
»que¡
, *
¬gp
) {

821  
C®lW™hCÚ‹xt
(
fd
,

822 [
»que¡
, 
¬gp
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

823  
cÚ‹xt
->
Ioùl
(
»que¡
, 
¬gp
);

827 
	gIOMªag”
::
Mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

828  
C®lW™hHªdËr
(

829 
·th
, [
mode
](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

830  
hªdËr
->
Mkdœ
(
ÿnÚiÿl_·th
, 
mode
);

834 
	gIOMªag”
::
RmDœ
(cÚ¡ *
·thÇme
) {

835  
C®lW™hHªdËr
(

836 
·thÇme
, [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_·th
) {

837  
hªdËr
->
RmDœ
(
ÿnÚiÿl_·th
);

841 
	gIOMªag”
::
R’ame
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

842  
C®lW™hHªdËr
(

843 
Şd·th
, 
Ãw·th
,

844 [](
Vœtu®P©hHªdËr
 *
hªdËr
, cÚ¡ *
ÿnÚiÿl_Şd·th
,

845 cÚ¡ *
ÿnÚiÿl_Ãw·th
) {

846  
hªdËr
->
R’ame
(
ÿnÚiÿl_Şd·th
, 
ÿnÚiÿl_Ãw·th
);

850 
	gIOMªag”
::
Utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
) {

851  
C®lW™hHªdËr
(
f’ame
, [
times
](
Vœtu®P©hHªdËr
 *
hªdËr
,

852 cÚ¡ *
ÿnÚiÿl_·th
) {

853  
hªdËr
->
Utime
(
ÿnÚiÿl_·th
, 
times
);

857 
	gIOMªag”
::
Utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]) {

858  
C®lW™hHªdËr
(
f’ame
, [
times
](
Vœtu®P©hHªdËr
 *
hªdËr
,

859 cÚ¡ *
ÿnÚiÿl_·th
) {

860  
hªdËr
->
Utimes
(
ÿnÚiÿl_·th
, 
times
);

864 
ssize_t
 
	gIOMªag”
::
Wr™ev
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

865  
C®lW™hCÚ‹xt
(
fd
, [
iov
, 
iovút
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

866  
cÚ‹xt
->
Wr™ev
(
iov
, 
iovút
);

870 
ssize_t
 
	gIOMªag”
::
R—dv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

871  
C®lW™hCÚ‹xt
(
fd
, [
iov
, 
iovút
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

872  
cÚ‹xt
->
R—dv
(
iov
, 
iovút
);

876 
mode_t
 
	gIOMªag”
::
Umask
(mode_ˆ
mask
è{  
’c_uÁru¡ed_umask
(mask); }

878 
	gIOMªag”
::
G‘RLim™
(
»sourû
, 
¾im™
 *
¾im
) {

879 ià(!
	g¾im
) {

880 
	g”ºo
 = 
EFAULT
;

883 
	g»sourû
) {

884 
	gRLIMIT_NOFILE
:

886 
ab¦
::
R—d”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

887 
	g¾im
->
	g¾im_cur
 = 
fd_bË_
.
g‘_maximum_fd_soá_lim™
();

888 
	g¾im
->
	g¾im_max
 = 
fd_bË_
.
g‘_maximum_fd_h¬d_lim™
();

892 
”ºo
 = 
ENOSYS
;

897 
	gIOMªag”
::
S‘RLim™
(
»sourû
, cÚ¡ 
¾im™
 *
¾im
) {

898 ià(!
	g¾im
) {

899 
	g”ºo
 = 
EFAULT
;

902 ià(
	g¾im
->
	g¾im_cur
 >„lim->
	g¾im_max
) {

903 
	g”ºo
 = 
EINVAL
;

906 
	g»sourû
) {

907 
	gRLIMIT_NOFILE
:

909 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

910 ià(!
	gfd_bË_
.
S‘FeDesütÜLim™s
(
¾im
)) {

916 
”ºo
 = 
ENOSYS
;

921 
	gIOMªag”
::
S‘SockO±
(
sockfd
, 
Ëv–
, 
İtiÚ_Çme
,

922 cÚ¡ *
İtiÚ_v®ue
, 
sockËn_t
 
İtiÚ_Ën
) {

923  
C®lW™hCÚ‹xt
(
sockfd
, [
Ëv–
, 
İtiÚ_Çme
, 
İtiÚ_v®ue
, 
İtiÚ_Ën
](

924 
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

925  
cÚ‹xt
->
S‘SockO±
(
Ëv–
, 
İtiÚ_Çme
, 
İtiÚ_v®ue
, 
İtiÚ_Ën
);

929 
	gIOMªag”
::
CÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

930 
sockËn_t
 
add¾’
) {

931  
C®lW™hCÚ‹xt
(
sockfd
,

932 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

933  
cÚ‹xt
->
CÚÃù
(
addr
, 
add¾’
);

937 
	gIOMªag”
::
Shutdown
(
sockfd
, 
how
) {

938  
C®lW™hCÚ‹xt
(
sockfd
, [
how
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

939  
cÚ‹xt
->
Shutdown
(
how
);

943 
ssize_t
 
	gIOMªag”
::
S’d
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
) {

944  
C®lW™hCÚ‹xt
(
sockfd
,

945 [
buf
, 
Ën
, 
æags
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

946  
cÚ‹xt
->
S’d
(
buf
, 
Ën
, 
æags
);

950 
	gIOMªag”
::
Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

951 
	gsock‘
 = 
’c_uÁru¡ed_sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

952 ià(
	gsock‘
 == -1) {

956 
	g»t
 = 
this
->
Regi¡”Ho¡FeDesütÜ
(
sock‘
);

957 ià(
	g»t
 < 0) {

958 
	g”ºo
 = 
EMFILE
;

960  
	g»t
;

963 
	gIOMªag”
::
G‘SockO±
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

964 
sockËn_t
 *
İ’
) {

965  
C®lW™hCÚ‹xt
(
sockfd
, [
Ëv–
, 
İŠame
, 
İtv®
,

966 
İ’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

967  
cÚ‹xt
->
G‘SockO±
(
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
);

971 
	gIOMªag”
::
Acû±
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

972 
	g»t
 = 
C®lW™hCÚ‹xt
(

973 
sockfd
, [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

974  
cÚ‹xt
->
Acû±
(
addr
, 
add¾’
);

976 ià(
	g»t
 < 0) {

979 
	g»t
 = 
this
->
Regi¡”Ho¡FeDesütÜ
(
»t
);

980 ià(
	g»t
 < 0) {

981 
	g”ºo
 = 
EMFILE
;

983  
	g»t
;

986 
	gIOMªag”
::
Bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
,

987 
sockËn_t
 
add¾’
) {

988  
C®lW™hCÚ‹xt
(
sockfd
,

989 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

990  
cÚ‹xt
->
Bšd
(
addr
, 
add¾’
);

994 
	gIOMªag”
::
Li¡’
(
sockfd
, 
backlog
) {

995  
C®lW™hCÚ‹xt
(
sockfd
, [
backlog
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

996  
cÚ‹xt
->
Li¡’
(
backlog
);

1000 
ssize_t
 
	gIOMªag”
::
S’dMsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
, 
æags
) {

1001  
C®lW™hCÚ‹xt
(
sockfd
,

1002 [
msg
, 
æags
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1003  
cÚ‹xt
->
S’dMsg
(
msg
, 
æags
);

1007 
ssize_t
 
	gIOMªag”
::
RecvMsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
) {

1008  
C®lW™hCÚ‹xt
(
sockfd
,

1009 [
msg
, 
æags
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1010  
cÚ‹xt
->
RecvMsg
(
msg
, 
æags
);

1014 
	gIOMªag”
::
G‘SockName
(
sockfd
, 
sockaddr
 *
addr
,

1015 
sockËn_t
 *
add¾’
) {

1016  
C®lW™hCÚ‹xt
(
sockfd
,

1017 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1018  
cÚ‹xt
->
G‘SockName
(
addr
, 
add¾’
);

1022 
	gIOMªag”
::
G‘P“rName
(
sockfd
, 
sockaddr
 *
addr
,

1023 
sockËn_t
 *
add¾’
) {

1024  
C®lW™hCÚ‹xt
(
sockfd
,

1025 [
addr
, 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1026  
cÚ‹xt
->
G‘P“rName
(
addr
, 
add¾’
);

1030 
ssize_t
 
	gIOMªag”
::
RecvFrom
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
,

1031 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
) {

1032  
C®lW™hCÚ‹xt
(
sockfd
, [
buf
, 
Ën
, 
æags
, 
¤c_addr
,

1033 
add¾’
](
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt
) {

1034  
cÚ‹xt
->
RecvFrom
(
buf
, 
Ën
, 
æags
, 
¤c_addr
, 
add¾’
);

1038 
	gIOMªag”
::
Regi¡”Ho¡FeDesütÜ
(
ho¡_fd
) {

1039 
ab¦
::
Wr™”Mu‹xLock
 
lock
(&
fd_bË_lock_
);

1040 autØ
	gcÚ‹xt
 = ::
ab¦
::
make_unique
<
IOCÚ‹xtN©ive
>(
ho¡_fd
);

1041 
	gfd
 = 
fd_bË_
.
In£¹
(
cÚ‹xt
.
g‘
());

1042 ià(
	gfd
 >= 0) {

1043 
cÚ‹xt
.
»Ëa£
();

1044  
	gfd
;

	@platform/posix/io/io_manager.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_IO_MANAGER_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_IO_MANAGER_H_


	)

22 
	~<pŞl.h
>

23 
	~<sys/•Şl.h
>

24 
	~<sys/»sourû.h
>

25 
	~<sys/sock‘.h
>

26 
	~<sys/¡©.h
>

27 
	~<sys/time.h
>

28 
	~<sys/ty³s.h
>

29 
	~<utime.h
>

31 
	~<©omic
>

32 
	~<û¼no
>

33 
	~<c¡dšt
>

34 
	~<c¡dlib
>

35 
	~<funùiÚ®
>

36 
	~<m­
>

37 
	~<memÜy
>

38 
	~<queue
>

39 
	~<ty³_Œa™s
>

41 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

42 
	~"ab¦/memÜy/memÜy.h
"

43 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

44 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

45 
	~"asylo/¶©fÜm/¡Üage/£cu»/’şave_¡Üage_£cu».h
"

46 
	~"asylo/ut/¡©usÜ.h
"

48 
Çme¥aû
 
	gasylo
 {

49 
Çme¥aû
 
	gio
 {

53 şas 
	cIOMªag”
 {

54 
	gpublic
:

57 cÚ¡ 
cÚ¡ex´
 
kMaxO³nFes
 = 1024;

63 şas 
	cIOCÚ‹xt
 {

64 
	gpublic
:

65 
vœtu®
 ~
IOCÚ‹xt
() = ;

67 
	g´Ùeùed
:

69 
vœtu®
 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
) = 0;

72 
vœtu®
 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) = 0;

75 
vœtu®
 
Clo£
() = 0;

78 
vœtu®
 
LS“k
(
off_t
 
off£t
, 
wh’û
) {

79 
	g”ºo
 = 
ENOSYS
;

84 
vœtu®
 
FCÁl
(
cmd
, 
št64_t
 
¬g
) {

85 
	g”ºo
 = 
ENOSYS
;

90 
vœtu®
 
FSync
() {

91 
	g”ºo
 = 
ENOSYS
;

96 
vœtu®
 
FD©aSync
(è{  
FSync
(); }

99 
vœtu®
 
FChOwn
(
uid_t
 
owÃr
, 
gid_t
 
group
) {

100 
	g”ºo
 = 
ENOSYS
;

105 
vœtu®
 
FSt
(
¡©
 *
¡
) {

106 
	g”ºo
 = 
ENOSYS
;

111 
vœtu®
 
I§‰y
() {

112 
	g”ºo
 = 
ENOSYS
;

117 
vœtu®
 
FLock
(
İ”©iÚ
) {

118 
	g”ºo
 = 
ENOSYS
;

122 
vœtu®
 
FChMod
(
mode_t
 
mode
) {

123 
	g”ºo
 = 
ENOSYS
;

128 
vœtu®
 
Ioùl
(
»que¡
, *
¬gp
) {

129 
	g”ºo
 = 
ENOSYS
;

134 
vœtu®
 
ssize_t
 
Wr™ev
(cÚ¡ 
iovec
 *
iov
, 
iovút
) {

135 
	g”ºo
 = 
ENOSYS
;

139 
vœtu®
 
ssize_t
 
R—dv
(cÚ¡ 
iovec
 *
iov
, 
iovút
) {

140 
	g”ºo
 = 
ENOSYS
;

144 
vœtu®
 
FTrunÿ‹
(
off_t
 
Ëngth
) {

145 
	g”ºo
 = 
ENOSYS
;

150 
vœtu®
 
S‘SockO±
(
Ëv–
, 
İtiÚ_Çme
, cÚ¡ *
İtiÚ_v®ue
,

151 
sockËn_t
 
İtiÚ_Ën
) {

152 
	g”ºo
 = 
ENOSYS
;

157 
vœtu®
 
CÚÃù
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

158 
	g”ºo
 = 
ENOSYS
;

163 
vœtu®
 
Shutdown
(
how
) {

164 
	g”ºo
 = 
ENOSYS
;

169 
vœtu®
 
ssize_t
 
S’d
(cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
) {

170 
	g”ºo
 = 
ENOSYS
;

175 
vœtu®
 
G‘SockO±
(
Ëv–
, 
İŠame
, *
İtv®
,

176 
sockËn_t
 *
İ’
) {

177 
	g”ºo
 = 
ENOSYS
;

182 
vœtu®
 
Acû±
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

183 
	g”ºo
 = 
ENOSYS
;

188 
vœtu®
 
Bšd
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

189 
	g”ºo
 = 
ENOSYS
;

194 
vœtu®
 
Li¡’
(
backlog
) {

195 
	g”ºo
 = 
ENOSYS
;

200 
vœtu®
 
ssize_t
 
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
) {

201 
	g”ºo
 = 
ENOSYS
;

206 
vœtu®
 
ssize_t
 
RecvMsg
(
msghdr
 *
msg
, 
æags
) {

207 
	g”ºo
 = 
ENOSYS
;

212 
vœtu®
 
G‘SockName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

213 
	g”ºo
 = 
ENOSYS
;

218 
vœtu®
 
G‘P“rName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

219 
	g”ºo
 = 
ENOSYS
;

224 
vœtu®
 
EpŞlC
(
İ
, 
ho¡fd
, 
•Şl_ev’t
 *
ev’t
) {

226 
	g”ºo
 = 
EINVAL
;

231 
vœtu®
 
EpŞlWa™
(
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

232 
timeout
) {

234 
	g”ºo
 = 
EINVAL
;

239 
vœtu®
 
InÙifyAddW©ch
(cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
) {

240 
	g”ºo
 = 
ENOSYS
;

245 
vœtu®
 
InÙifyRmW©ch
(
wd
) {

246 
	g”ºo
 = 
ENOSYS
;

251 
vœtu®
 
ssize_t
 
RecvFrom
(*
buf
, 
size_t
 
Ën
, 
æags
,

252 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
) {

253 
	g”ºo
 = 
ENOSYS
;

257 
vœtu®
 
G‘Ho¡FeDesütÜ
() {  -1; }

259 
	g´iv©e
:

260 
ä›nd
 
şass
 
IOMªag”
;

264 şas 
	cVœtu®P©hHªdËr
 {

265 
	gpublic
:

266 
vœtu®
 ~
Vœtu®P©hHªdËr
() = ;

268 
	g´Ùeùed
:

270 
vœtu®
 
¡d
::
unique_±r
<
IOCÚ‹xt
> 
O³n
(cÚ¡ *
·th
, 
æags
,

271 
mode_t
 
mode
) = 0;

273 
vœtu®
 
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

274 
	g”ºo
 = 
ENOSYS
;

278 
vœtu®
 
Lšk
(cÚ¡ *
exi¡šg
, cÚ¡ *
Ãw_lšk
) {

279 
	g”ºo
 = 
ENOSYS
;

283 
vœtu®
 
ssize_t
 
R—dLšk
(cÚ¡ *
·th_Çme
, *
buf
, 
size_t
 
bufsize
) {

284 
	g”ºo
 = 
ENOSYS
;

288 
vœtu®
 
SymLšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
) {

289 
	g”ºo
 = 
ENOSYS
;

293 
vœtu®
 
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

294 
	g”ºo
 = 
ENOSYS
;

298 
vœtu®
 
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

299 
	g”ºo
 = 
ENOSYS
;

303 
vœtu®
 
Mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

304 
	g”ºo
 = 
ENOSYS
;

308 
vœtu®
 
RmDœ
(cÚ¡ *
·thÇme
) {

309 
	g”ºo
 = 
ENOSYS
;

313 
vœtu®
 
R’ame
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

314 
	g”ºo
 = 
ENOSYS
;

318 
vœtu®
 
UÆšk
(cÚ¡ *
·thÇme
) {

319 
	g”ºo
 = 
ENOSYS
;

323 
vœtu®
 
Acûss
(cÚ¡ *
·th
, 
mode
) {

324 
	g”ºo
 = 
ENOSYS
;

328 
vœtu®
 
Trunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

329 
	g”ºo
 = 
ENOSYS
;

333 
vœtu®
 
ChMod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

334 
	g”ºo
 = 
ENOSYS
;

338 
vœtu®
 
Utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
) {

339 
	g”ºo
 = 
ENOSYS
;

343 
vœtu®
 
Utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]) {

344 
	g”ºo
 = 
ENOSYS
;

348 
	g´iv©e
:

349 
ä›nd
 
şass
 
IOMªag”
;

355 şas 
	cFeDesütÜTabË
 {

356 
	gpublic
:

357 
FeDesütÜTabË
();

361 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
G‘
(
fd
);

367 
D–‘e
(
fd
);

370 
boŞ
 
IsFeDesütÜUnu£d
(
fd
);

378 
In£¹
(
IOCÚ‹xt
 *
cÚ‹xt
);

385 
CİyFeDesütÜ
(
Şdfd
, 
¡¬tfd
);

391 
CİyFeDesütÜToS³cif›dT¬g‘
(
Şdfd
, 
Ãwfd
);

393 
boŞ
 
S‘FeDesütÜLim™s
(cÚ¡ 
¾im™
 *
¾im
);

395 
g‘_maximum_fd_soá_lim™
();

397 
g‘_maximum_fd_h¬d_lim™
();

399 
	g´iv©e
:

406 şas 
	cAutoClo£IOCÚ‹xt
 {

407 
public
:

408 
ex¶ic™
 
AutoClo£IOCÚ‹xt
(
IOCÚ‹xt
 *
cÚ‹xt
)

409 : 
şo£_»suÉ_
(
nuÎ±r
), 
cÚ‹xt_
(
cÚ‹xt
) {}

411 ~
AutoClo£IOCÚ‹xt
() {

412 ià(
	gcÚ‹xt_
->
Clo£
() == -1) {

413 *
şo£_»suÉ
 = 
şo£_»suÉ_
.
lßd
();

414 ià(
	gşo£_»suÉ
) {

415 *
	gşo£_»suÉ
 = -1;

420 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
G‘
(è{  
cÚ‹xt_
; }

425 
Wr™eClo£ResuÉTo
(*
şo£_»suÉ
) {

426 
	gşo£_»suÉ_
.
¡Üe
(
şo£_»suÉ
);

429 
	g´iv©e
:

432 
¡d
::
©omic
<*> 
şo£_»suÉ_
;

437 
	g¡d
::
sh¬ed_±r
<
IOCÚ‹xt
> 
cÚ‹xt_
;

441 
boŞ
 
IsFeDesütÜV®id
(
fd
);

445 
G‘Highe¡FeDesütÜU£d
();

449 
G‘NextF»eFeDesütÜ
(
¡¬tfd
);

451 
	g¡d
::
¬¿y
<
¡d
::
sh¬ed_±r
<
AutoClo£IOCÚ‹xt
>, 
	gkMaxO³nFes
> 
	gfd_bË_
;

454 
	gmaximum_fd_soá_lim™
;

457 
	gmaximum_fd_h¬d_lim™
;

461 
	gIOMªag”
 &
G‘In¡ªû
() {

462 
IOMªag”
 *
	gš¡ªû
 = 
Ãw
 IOManager;

463  *
	gš¡ªû
;

467 
Acûss
(cÚ¡ *
·th
, 
mode
);

471 
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
);

475 
Lšk
(cÚ¡ *
äom
, cÚ¡ *
to
);

479 
ssize_t
 
R—dLšk
(cÚ¡ *
·th
, *
buf
, 
size_t
 
bufsize
);

483 
SymLšk
(cÚ¡ *
äom
, cÚ¡ *
to
);

488 
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
);

494 
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
);

498 *
R—lP©h
(cÚ¡ *
·th
, *
»sŞved_·th
);

501 
O³n
(cÚ¡ *
·th
, 
æags
, 
mode_t
 
mode
);

505 
Dup
(
Şdfd
è
LOCKS_EXCLUDED
(
fd_bË_lock_
);

510 
Dup2
(
Şdfd
, 
Ãwfd
è
LOCKS_EXCLUDED
(
fd_bË_lock_
);

517 
Pe
(
pefd
[2], 
æags
);

521 
R—d
(
fd
, *
buf
, 
size_t
 
couÁ
);

525 
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

528 
Clo£
(
fd
è
LOCKS_EXCLUDED
(
fd_bË_lock_
);

531 
FChOwn
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
);

534 
LS“k
(
fd
, 
off_t
 
off£t
, 
wh’û
);

537 
FChMod
(
fd
, 
mode_t
 
mode
);

540 
FCÁl
(
fd
, 
cmd
, 
št64_t
 
¬g
);

543 
FSync
(
fd
);

546 
FD©aSync
(
fd
);

549 
Ioùl
(
fd
, 
»que¡
, *
¬gp
);

552 
FSt
(
fd
, 
¡©
 *
¡©_bufãr
);

555 
I§‰y
(
fd
);

558 
FLock
(
fd
, 
İ”©iÚ
);

561 
UÆšk
(cÚ¡ *
·thÇme
);

564 
Trunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
);

567 
FTrunÿ‹
(
fd
, 
off_t
 
Ëngth
);

570 
S–eù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
, fd_£ˆ*
exû±fds
,

571 
timev®
 *
timeout
);

574 
PŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
)

575 
LOCKS_EXCLUDED
(
fd_bË_lock_
);

578 
EpŞlC»©e
(
size
è
LOCKS_EXCLUDED
(
fd_bË_lock_
);

581 
EpŞlC
(
•fd
, 
İ
, 
fd
, 
•Şl_ev’t
 *
ev’t
);

584 
EpŞlWa™
(
•fd
, 
•Şl_ev’t
 *
ev’ts
, 
maxev’ts
,

585 
timeout
);

588 
Mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
);

591 
RmDœ
(cÚ¡ *
·thÇme
);

594 
R’ame
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
);

597 
ssize_t
 
Wr™ev
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
);

600 
ssize_t
 
R—dv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
);

603 
mode_t
 
Umask
(mode_ˆ
mask
);

606 
ChMod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
);

609 
Utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
);

612 
Utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]);

615 
G‘RLim™
(
»sourû
, 
¾im™
 *
¾im
)

616 
LOCKS_EXCLUDED
(
fd_bË_lock_
);

619 
S‘RLim™
(
»sourû
, cÚ¡ 
¾im™
 *
¾im
)

620 
LOCKS_EXCLUDED
(
fd_bË_lock_
);

623 
S‘SockO±
(
sockfd
, 
Ëv–
, 
İtiÚ_Çme
,

624 cÚ¡ *
İtiÚ_v®ue
, 
sockËn_t
 
İtiÚ_Ën
);

627 
CÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
);

630 
Shutdown
(
sockfd
, 
how
);

633 
ssize_t
 
S’d
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
);

636 
G‘SockO±
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

637 
sockËn_t
 *
İ’
);

640 
Acû±
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

643 
Bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
);

646 
Li¡’
(
sockfd
, 
backlog
);

649 
ssize_t
 
S’dMsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
, 
æags
);

652 
ssize_t
 
RecvMsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
);

655 
G‘SockName
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

658 
G‘P“rName
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

661 
Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

664 
Ev’tFd
(
š™v®
, 
æags
è
LOCKS_EXCLUDED
(
fd_bË_lock_
);

667 
InÙifyIn™
(
boŞ
 
nÚ_block
è
LOCKS_EXCLUDED
(
fd_bË_lock_
);

670 
InÙifyAddW©ch
(
fd
, cÚ¡ *
·thÇme
, 
ušt32_t
 
mask
);

673 
InÙifyRmW©ch
(
fd
, 
wd
);

676 
ssize_t
 
RecvFrom
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
,

677 
sockaddr
 *
¤c_addr
, 
sockËn_t
 *
add¾’
);

681 
Regi¡”Ho¡FeDesütÜ
(
ho¡_fd
è
LOCKS_EXCLUDED
(
fd_bË_lock_
);

690 
boŞ
 
Regi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th_´efix
,

691 
¡d
::
unique_±r
<
Vœtu®P©hHªdËr
> 
hªdËr
);

694 
D”egi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th_´efix
);

696 
Stus
 
S‘Cu¼’tWÜkšgDœeùÜy
(
ab¦
::
¡ršg_v›w
 
·th
);

697 
	g¡d
::
¡ršg
 
G‘Cu¼’tWÜkšgDœeùÜy
() const;

699 
	g´iv©e
:

700 
IOMªag”
() {}

701 
IOMªag”
(IOMªag” cÚ¡ &èğ
d–‘e
;

702 
	gİ”©Ü
=(
IOMªag”
 cÚ¡ &èğ
d–‘e
;

707 
	gStusOr
<
	g¡d
::
¡ršg
> 
CªÚiÿlizeP©h
(
ab¦
::
¡ršg_v›w
 
·th
) const;

713 
Clo£FeDesütÜ
(
fd
è
EXCLUSIVE_LOCKS_REQUIRED
(
fd_bË_lock_
);

717 
Vœtu®P©hHªdËr
 *
HªdËrFÜP©h
(
ab¦
::
¡ršg_v›w
 
·th
) const;

720 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,y³Çm
	gR‘uºTy³
 =y³Çm
¡d
::
»suÉ_of
<

721 
IOAùiÚ
(
¡d
::
sh¬ed_±r
<
IOCÚ‹xt
>)>::
ty³
>

722 
R‘uºTy³
 
C®lW™hCÚ‹xt
(
fd
, 
IOAùiÚ
 
aùiÚ
)

723 
LOCKS_EXCLUDED
(
fd_bË_lock_
);

728 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,

729 
ty³Çme
 
	gR‘uºTy³
 =y³Çm
¡d
::
»suÉ_of
<

730 
IOAùiÚ
(
IOMªag”
::
Vœtu®P©hHªdËr
 *, cÚ¡ *)>::
ty³
>

731 
R‘uºTy³
 
C®lW™hHªdËr
(cÚ¡ *
·th
, 
IOAùiÚ
 
aùiÚ
);

737 
	g‹m¶©e
 <
ty³Çme
 
	gIOAùiÚ
,

738 
ty³Çme
 
	gR‘uºTy³
 =y³Çm
¡d
::
»suÉ_of
<
IOAùiÚ
(

739 
Vœtu®P©hHªdËr
 *, cÚ¡ *, cÚ¡ *)>::
ty³
>

740 
R‘uºTy³
 
C®lW™hHªdËr
(cÚ¡ *
·th1
, cÚ¡ *
·th2
,

741 
IOAùiÚ
 
aùiÚ
);

744 
	g¡d
::
m­
<
¡d
::
¡ršg
, std::
unique_±r
<
Vœtu®P©hHªdËr
>> 
´efix_to_hªdËr_
;

746 
FeDesütÜTabË
 
	gfd_bË_
;

749 
	gab¦
::
Mu‹x
 
fd_bË_lock_
;

751 
	g¡d
::
¡ršg
 
cu¼’t_wÜkšg_dœeùÜy_
;

	@platform/posix/io/io_syscalls.cc

23 
	~<’şave/’şave_sysÿÎs.h
>

25 
	~<fú.h
>

26 
	~<¡d¬g.h
>

27 
	~<¡dšt.h
>

28 
	~<sys/ty³s.h
>

29 
	~<uni¡d.h
>

31 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

33 
usšg
 
	gasylo
::
io
::
IOMªag”
;

37 
’şave_şo£
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
Clo£
(fd); }

39 
’şave_İ’
(*
·th_Çme
, 
æags
, 
mode
) {

40  
IOMªag”
::
G‘In¡ªû
().
O³n
(
·th_Çme
, 
æags
, 
mode
);

43 
’şave_»ad
(
fd
, *
buf
, 
couÁ
) {

44  
IOMªag”
::
G‘In¡ªû
().
R—d
(
fd
, 
¡©ic_ÿ¡
<*>(
buf
), 
couÁ
);

47 
’şave_wr™e
(
fd
, *
buf
, 
couÁ
) {

48  
IOMªag”
::
G‘In¡ªû
().
Wr™e
(
fd
, 
¡©ic_ÿ¡
<cÚ¡ *>(
buf
),

49 
couÁ
);

52 
’şave_fú
(
fd
, 
cmd
, 
št64_t
 
¬g
) {

53  
IOMªag”
::
G‘In¡ªû
().
FCÁl
(
fd
, 
cmd
, 
¬g
);

56 
’şave_l£ek
(
fd
, 
±r
, 
dœ
) {

57  
IOMªag”
::
G‘In¡ªû
().
LS“k
(
fd
, 
±r
, 
dœ
);

60 
’şave_lšk
(*
exi¡šg
, *
Ãw_lšk
) {

61  
IOMªag”
::
G‘In¡ªû
().
Lšk
(
exi¡šg
, 
Ãw_lšk
);

64 
’şave_mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

65  
IOMªag”
::
G‘In¡ªû
().
Mkdœ
(
·thÇme
, 
mode
);

68 
’şave_¡©
(cÚ¡ *
fe
, 
¡©
 *
¡
) {

69  
IOMªag”
::
G‘In¡ªû
().
St
(
fe
, 
¡
);

72 
»Çme
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

73  
IOMªag”
::
G‘In¡ªû
().
R’ame
(
Şd·th
, 
Ãw·th
);

	@platform/posix/io/io_syscalls.cc

23 
	~<’şave/’şave_sysÿÎs.h
>

25 
	~<fú.h
>

26 
	~<¡d¬g.h
>

27 
	~<¡dšt.h
>

28 
	~<sys/ty³s.h
>

29 
	~<uni¡d.h
>

31 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

33 
usšg
 
	gasylo
::
io
::
IOMªag”
;

37 
’şave_şo£
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
Clo£
(fd); }

39 
’şave_İ’
(*
·th_Çme
, 
æags
, 
mode
) {

40  
IOMªag”
::
G‘In¡ªû
().
O³n
(
·th_Çme
, 
æags
, 
mode
);

43 
’şave_»ad
(
fd
, *
buf
, 
couÁ
) {

44  
IOMªag”
::
G‘In¡ªû
().
R—d
(
fd
, 
¡©ic_ÿ¡
<*>(
buf
), 
couÁ
);

47 
’şave_wr™e
(
fd
, *
buf
, 
couÁ
) {

48  
IOMªag”
::
G‘In¡ªû
().
Wr™e
(
fd
, 
¡©ic_ÿ¡
<cÚ¡ *>(
buf
),

49 
couÁ
);

52 
’şave_fú
(
fd
, 
cmd
, 
št64_t
 
¬g
) {

53  
IOMªag”
::
G‘In¡ªû
().
FCÁl
(
fd
, 
cmd
, 
¬g
);

56 
’şave_l£ek
(
fd
, 
±r
, 
dœ
) {

57  
IOMªag”
::
G‘In¡ªû
().
LS“k
(
fd
, 
±r
, 
dœ
);

60 
’şave_lšk
(*
exi¡šg
, *
Ãw_lšk
) {

61  
IOMªag”
::
G‘In¡ªû
().
Lšk
(
exi¡šg
, 
Ãw_lšk
);

64 
’şave_mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

65  
IOMªag”
::
G‘In¡ªû
().
Mkdœ
(
·thÇme
, 
mode
);

68 
’şave_¡©
(cÚ¡ *
fe
, 
¡©
 *
¡
) {

69  
IOMªag”
::
G‘In¡ªû
().
St
(
fe
, 
¡
);

72 
»Çme
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

73  
IOMªag”
::
G‘In¡ªû
().
R’ame
(
Şd·th
, 
Ãw·th
);

	@platform/posix/io/native_paths.cc

19 
	~"asylo/¶©fÜm/posix/io/Çtive_·ths.h
"

21 
	~<fú.h
>

22 
	~<û¼no
>

23 
	~<c¡ršg
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~"asylo/¶©fÜm/cÜe/bridge_msghdr_w¿µ”.h
"

27 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

28 
	~"asylo/¶©fÜm/posix/io/£cu»_·ths.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gio
 {

33 
	gIOCÚ‹xtN©ive
::
Clo£
(è{  
’c_uÁru¡ed_şo£
(
ho¡_fd_
); }

35 
ssize_t
 
	gIOCÚ‹xtN©ive
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

36  
’c_uÁru¡ed_»ad
(
ho¡_fd_
, 
buf
, 
couÁ
);

39 
ssize_t
 
	gIOCÚ‹xtN©ive
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

40  
’c_uÁru¡ed_wr™e
(
ho¡_fd_
, 
buf
, 
couÁ
);

43 
	gIOCÚ‹xtN©ive
::
FChOwn
(
uid_t
 
owÃr
, 
gid_t
 
group
) {

44  
’c_uÁru¡ed_fchown
(
ho¡_fd_
, 
owÃr
, 
group
);

47 
	gIOCÚ‹xtN©ive
::
LS“k
(
off_t
 
off£t
, 
wh’û
) {

48  
’c_uÁru¡ed_l£ek
(
ho¡_fd_
, 
off£t
, 
wh’û
);

51 
	gIOCÚ‹xtN©ive
::
FCÁl
(
cmd
, 
št64_t
 
¬g
) {

52  
’c_uÁru¡ed_fú
(
ho¡_fd_
, 
cmd
, 
¬g
);

55 
	gIOCÚ‹xtN©ive
::
FSync
(è{  
’c_uÁru¡ed_fsync
(
ho¡_fd_
); }

57 
	gIOCÚ‹xtN©ive
::
FSt
(
¡©
 *
¡©_bufãr
) {

58  
’c_uÁru¡ed_f¡©
(
ho¡_fd_
, 
¡©_bufãr
);

61 
	gIOCÚ‹xtN©ive
::
FTrunÿ‹
(
off_t
 
Ëngth
) {

62  
’c_uÁru¡ed_árunÿ‹
(
ho¡_fd_
, 
Ëngth
);

65 
	gIOCÚ‹xtN©ive
::
FChMod
(
mode_t
 
mode
) {

66  
’c_uÁru¡ed_fchmod
(
ho¡_fd_
, 
mode
);

69 
	gIOCÚ‹xtN©ive
::
I§‰y
(è{  
’c_uÁru¡ed_i§‰y
(
ho¡_fd_
); }

71 
	gIOCÚ‹xtN©ive
::
FLock
(
İ”©iÚ
) {

72  
’c_uÁru¡ed_æock
(
ho¡_fd_
, 
İ”©iÚ
);

75 
boŞ
 
	gIOCÚ‹xtN©ive
::
C»©eUÁru¡edBufãr
(cÚ¡ 
iovec
 *
iov
, 
iovút
,

76 **
buf
, *
size
) {

77 
size_t
 
	gtÙ®_size
 = 0;

78 
	gi
 = 0; i < 
	giovút
; ++i) {

79 
	gtÙ®_size
 +ğ
iov
[
i
].
iov_Ën
;

83 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

84 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

85 *
	gtmp
 = 
»š‹½»t_ÿ¡
<*>(

86 
uÁru¡ed_ÿche_m®loc
->
M®loc
(
tÙ®_size
 * ()));

87 ià(!
	gtmp
) {

88  
	gçl£
;

90 *
	gsize
 = 
tÙ®_size
;

91 *
	gbuf
 = 
tmp
;

92  
	gŒue
;

95 
boŞ
 
	gIOCÚ‹xtN©ive
::
S”ŸlizeIov
(cÚ¡ 
iovec
 *
iov
, 
iovút
,

96 **
buf
, *
size
) {

97 *
	gtmp
;

98 ià(!
C»©eUÁru¡edBufãr
(
iov
, 
iovút
, &
tmp
, 
size
)) {

99  
	gçl£
;

101 
size_t
 
	gcİ›d_by‹s
 = 0;

102 
	gi
 = 0; i < 
	giovút
; ++i) {

103 
size_t
 
	gËn
 = 
iov
[
i
].
iov_Ën
;

104 
memıy
(
tmp
 + 
cİ›d_by‹s
, 
iov
[
i
].
iov_ba£
, 
Ën
);

105 
	gcİ›d_by‹s
 +ğ
Ën
;

107 *
	gbuf
 = 
tmp
;

108  
	gŒue
;

111 
ssize_t
 
	gIOCÚ‹xtN©ive
::
Wr™ev
(cÚ¡ 
iovec
 *
iov
, 
iovút
) {

112 ià(
	giovút
 <= 0) {

113 
”ºo
 = 
EINVAL
;

117 *
	gbuf
;

118 
	gsize
;

119 ià(!
S”ŸlizeIov
(
iov
, 
iovút
, &
buf
, &
size
)) {

122  
’c_uÁru¡ed_wr™ev
(
ho¡_fd_
, 
buf
, 
size
);

125 
ssize_t
 
	gIOCÚ‹xtN©ive
::
R—dv
(cÚ¡ 
iovec
 *
iov
, 
iovút
) {

126 ià(
	giovút
 <= 0) {

127 
”ºo
 = 
EINVAL
;

130 *
	gbuf
;

131 
	gsize
;

132 ià(!
C»©eUÁru¡edBufãr
(
iov
, 
iovút
, &
buf
, &
size
)) {

135  
’c_uÁru¡ed_»adv
(
ho¡_fd_
, 
iov
, 
iovút
, 
buf
, 
size
);

138 
	gIOCÚ‹xtN©ive
::
S‘SockO±
(
Ëv–
, 
İtiÚ_Çme
,

139 cÚ¡ *
İtiÚ_v®ue
,

140 
sockËn_t
 
İtiÚ_Ën
) {

141  
’c_uÁru¡ed_£tsockİt
(
ho¡_fd_
, 
Ëv–
, 
İtiÚ_Çme
, 
İtiÚ_v®ue
,

142 
İtiÚ_Ën
);

145 
	gIOCÚ‹xtN©ive
::
CÚÃù
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

146  
’c_uÁru¡ed_cÚÃù
(
ho¡_fd_
, 
addr
, 
add¾’
);

149 
	gIOCÚ‹xtN©ive
::
Shutdown
(
how
) {

150  
’c_uÁru¡ed_shutdown
(
ho¡_fd_
, 
how
);

153 
ssize_t
 
	gIOCÚ‹xtN©ive
::
S’d
(cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
) {

154  
’c_uÁru¡ed_£nd
(
ho¡_fd_
, 
buf
, 
Ën
, 
æags
);

157 
	gIOCÚ‹xtN©ive
::
G‘SockO±
(
Ëv–
, 
İŠame
, *
İtv®
,

158 
sockËn_t
 *
İ’
) {

159  
’c_uÁru¡ed_g‘sockİt
(
ho¡_fd_
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
);

162 
	gIOCÚ‹xtN©ive
::
Acû±
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

163  
’c_uÁru¡ed_acû±
(
ho¡_fd_
, 
addr
, 
add¾’
);

166 
	gIOCÚ‹xtN©ive
::
Bšd
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

167  
’c_uÁru¡ed_bšd
(
ho¡_fd_
, 
addr
, 
add¾’
);

170 
	gIOCÚ‹xtN©ive
::
Li¡’
(
backlog
) {

171  
’c_uÁru¡ed_li¡’
(
ho¡_fd_
, 
backlog
);

174 
ssize_t
 
	gIOCÚ‹xtN©ive
::
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
) {

175 
	gasylo
::
BridgeMsghdrW¿µ”
 
tmp_w¿µ”
(
msg
);

176 ià(!
	gtmp_w¿µ”
.
CİyAÎBufãrs
()) {

178 
	g”ºo
 = 
EFAULT
;

182  
’c_uÁru¡ed_£ndmsg
(
ho¡_fd_
, 
tmp_w¿µ”
.
g‘_msg
(), 
æags
);

185 
ssize_t
 
	gIOCÚ‹xtN©ive
::
RecvMsg
(
msghdr
 *
msg
, 
æags
) {

186 
	gasylo
::
BridgeMsghdrW¿µ”
 
tmp_w¿µ”
(
msg
);

187 ià(!
	gtmp_w¿µ”
.
CİyAÎBufãrs
()) {

189 
	g”ºo
 = 
EFAULT
;

192  
’c_uÁru¡ed_»cvmsg
(
ho¡_fd_
, 
msg
, 
tmp_w¿µ”
.
g‘_msg
(), 
æags
);

195 
	gIOCÚ‹xtN©ive
::
G‘SockName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

196  
’c_uÁru¡ed_g‘sockÇme
(
ho¡_fd_
, 
addr
, 
add¾’
);

199 
	gIOCÚ‹xtN©ive
::
G‘P“rName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

200  
’c_uÁru¡ed_g‘³”Çme
(
ho¡_fd_
, 
addr
, 
add¾’
);

203 
ssize_t
 
	gIOCÚ‹xtN©ive
::
RecvFrom
(*
buf
, 
size_t
 
Ën
, 
æags
,

204 
sockaddr
 *
¤c_addr
,

205 
sockËn_t
 *
add¾’
) {

206  
’c_uÁru¡ed_»cväom
(
ho¡_fd_
, 
buf
, 
Ën
, 
æags
, 
¤c_addr
, 
add¾’
);

209 
	gIOCÚ‹xtN©ive
::
G‘Ho¡FeDesütÜ
(è{  
ho¡_fd_
; }

211 
	g¡d
::
unique_±r
<
IOMªag”
::
IOCÚ‹xt
> 
N©iveP©hHªdËr
::
O³n
(cÚ¡ *
·th
,

212 
æags
,

213 
mode_t
 
mode
) {

214 ià(
	gæags
 & 
	gO_SECURE
) {

215  
	gIOCÚ‹xtSecu»
::
C»©e
(
·th
, 
æags
, 
mode
);

218 
	gho¡_fd
 = 
’c_uÁru¡ed_İ’
(
·th
, 
æags
, 
mode
);

219 ià(
	gho¡_fd
 < 0) {

220  
	gnuÎ±r
;

223  ::
ab¦
::
make_unique
<
IOCÚ‹xtN©ive
>(
ho¡_fd
);

226 
	gN©iveP©hHªdËr
::
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

227  
’c_uÁru¡ed_chown
(
·th
, 
owÃr
, 
group
);

230 
	gN©iveP©hHªdËr
::
Lšk
(cÚ¡ *
exi¡šg
, cÚ¡ *
Ãw_lšk
) {

231  
’c_uÁru¡ed_lšk
(
exi¡šg
, 
Ãw_lšk
);

234 
	gN©iveP©hHªdËr
::
UÆšk
(cÚ¡ *
·thÇme
) {

235  
’c_uÁru¡ed_uÆšk
(
·thÇme
);

238 
ssize_t
 
	gN©iveP©hHªdËr
::
R—dLšk
(cÚ¡ *
·th_Çme
, *
buf
,

239 
size_t
 
bufsize
) {

240  
’c_uÁru¡ed_»adlšk
(
·th_Çme
, 
buf
, 
bufsize
);

243 
	gN©iveP©hHªdËr
::
SymLšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
) {

244  
’c_uÁru¡ed_symlšk
(
·th1
, 
·th2
);

247 
	gN©iveP©hHªdËr
::
Trunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

248  
’c_uÁru¡ed_Œunÿ‹
(
·th
, 
Ëngth
);

251 
	gN©iveP©hHªdËr
::
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

252  
’c_uÁru¡ed_¡©
(
·thÇme
, 
¡©_bufãr
);

255 
	gN©iveP©hHªdËr
::
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

256  
’c_uÁru¡ed_l¡©
(
·thÇme
, 
¡©_bufãr
);

259 
	gN©iveP©hHªdËr
::
Mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

260  
’c_uÁru¡ed_mkdœ
(
·th
, 
mode
);

263 
	gN©iveP©hHªdËr
::
RmDœ
(cÚ¡ *
·thÇme
) {

264  
’c_uÁru¡ed_rmdœ
(
·thÇme
);

267 
	gN©iveP©hHªdËr
::
R’ame
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

268  
’c_uÁru¡ed_»Çme
(
Şd·th
, 
Ãw·th
);

271 
	gN©iveP©hHªdËr
::
Acûss
(cÚ¡ *
·th
, 
mode
) {

272  
’c_uÁru¡ed_acûss
(
·th
, 
mode
);

275 
	gN©iveP©hHªdËr
::
ChMod
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

276  
’c_uÁru¡ed_chmod
(
·th
, 
mode
);

279 
	gN©iveP©hHªdËr
::
Utime
(cÚ¡ *
f’ame
,

280 cÚ¡ 
utimbuf
 *
times
) {

281  
’c_uÁru¡ed_utime
(
f’ame
, 
times
);

284 
	gN©iveP©hHªdËr
::
Utimes
(cÚ¡ *
f’ame
,

285 cÚ¡ 
timev®
 
times
[2]) {

286  
’c_uÁru¡ed_utimes
(
f’ame
, 
times
);

	@platform/posix/io/native_paths.cc

19 
	~"asylo/¶©fÜm/posix/io/Çtive_·ths.h
"

21 
	~<fú.h
>

22 
	~<û¼no
>

23 
	~<c¡ršg
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~"asylo/¶©fÜm/cÜe/bridge_msghdr_w¿µ”.h
"

27 
	~"asylo/¶©fÜm/cÜe/uÁru¡ed_ÿche_m®loc.h
"

28 
	~"asylo/¶©fÜm/posix/io/£cu»_·ths.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gio
 {

33 
	gIOCÚ‹xtN©ive
::
Clo£
(è{  
’c_uÁru¡ed_şo£
(
ho¡_fd_
); }

35 
ssize_t
 
	gIOCÚ‹xtN©ive
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

36  
’c_uÁru¡ed_»ad
(
ho¡_fd_
, 
buf
, 
couÁ
);

39 
ssize_t
 
	gIOCÚ‹xtN©ive
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

40  
’c_uÁru¡ed_wr™e
(
ho¡_fd_
, 
buf
, 
couÁ
);

43 
	gIOCÚ‹xtN©ive
::
FChOwn
(
uid_t
 
owÃr
, 
gid_t
 
group
) {

44  
’c_uÁru¡ed_fchown
(
ho¡_fd_
, 
owÃr
, 
group
);

47 
	gIOCÚ‹xtN©ive
::
LS“k
(
off_t
 
off£t
, 
wh’û
) {

48  
’c_uÁru¡ed_l£ek
(
ho¡_fd_
, 
off£t
, 
wh’û
);

51 
	gIOCÚ‹xtN©ive
::
FCÁl
(
cmd
, 
št64_t
 
¬g
) {

52  
’c_uÁru¡ed_fú
(
ho¡_fd_
, 
cmd
, 
¬g
);

55 
	gIOCÚ‹xtN©ive
::
FSync
(è{  
’c_uÁru¡ed_fsync
(
ho¡_fd_
); }

57 
	gIOCÚ‹xtN©ive
::
FSt
(
¡©
 *
¡©_bufãr
) {

58  
’c_uÁru¡ed_f¡©
(
ho¡_fd_
, 
¡©_bufãr
);

61 
	gIOCÚ‹xtN©ive
::
FTrunÿ‹
(
off_t
 
Ëngth
) {

62  
’c_uÁru¡ed_árunÿ‹
(
ho¡_fd_
, 
Ëngth
);

65 
	gIOCÚ‹xtN©ive
::
FChMod
(
mode_t
 
mode
) {

66  
’c_uÁru¡ed_fchmod
(
ho¡_fd_
, 
mode
);

69 
	gIOCÚ‹xtN©ive
::
I§‰y
(è{  
’c_uÁru¡ed_i§‰y
(
ho¡_fd_
); }

71 
	gIOCÚ‹xtN©ive
::
FLock
(
İ”©iÚ
) {

72  
’c_uÁru¡ed_æock
(
ho¡_fd_
, 
İ”©iÚ
);

75 
boŞ
 
	gIOCÚ‹xtN©ive
::
C»©eUÁru¡edBufãr
(cÚ¡ 
iovec
 *
iov
, 
iovút
,

76 **
buf
, *
size
) {

77 
size_t
 
	gtÙ®_size
 = 0;

78 
	gi
 = 0; i < 
	giovút
; ++i) {

79 
	gtÙ®_size
 +ğ
iov
[
i
].
iov_Ën
;

83 
	gasylo
::
UÁru¡edCacheM®loc
 *
uÁru¡ed_ÿche_m®loc
 =

84 
asylo
::
UÁru¡edCacheM®loc
::
In¡ªû
();

85 *
	gtmp
 = 
»š‹½»t_ÿ¡
<*>(

86 
uÁru¡ed_ÿche_m®loc
->
M®loc
(
tÙ®_size
 * ()));

87 ià(!
	gtmp
) {

88  
	gçl£
;

90 *
	gsize
 = 
tÙ®_size
;

91 *
	gbuf
 = 
tmp
;

92  
	gŒue
;

95 
boŞ
 
	gIOCÚ‹xtN©ive
::
S”ŸlizeIov
(cÚ¡ 
iovec
 *
iov
, 
iovút
,

96 **
buf
, *
size
) {

97 *
	gtmp
;

98 ià(!
C»©eUÁru¡edBufãr
(
iov
, 
iovút
, &
tmp
, 
size
)) {

99  
	gçl£
;

101 
size_t
 
	gcİ›d_by‹s
 = 0;

102 
	gi
 = 0; i < 
	giovút
; ++i) {

103 
size_t
 
	gËn
 = 
iov
[
i
].
iov_Ën
;

104 
memıy
(
tmp
 + 
cİ›d_by‹s
, 
iov
[
i
].
iov_ba£
, 
Ën
);

105 
	gcİ›d_by‹s
 +ğ
Ën
;

107 *
	gbuf
 = 
tmp
;

108  
	gŒue
;

111 
ssize_t
 
	gIOCÚ‹xtN©ive
::
Wr™ev
(cÚ¡ 
iovec
 *
iov
, 
iovút
) {

112 ià(
	giovút
 <= 0) {

113 
”ºo
 = 
EINVAL
;

117 *
	gbuf
;

118 
	gsize
;

119 ià(!
S”ŸlizeIov
(
iov
, 
iovút
, &
buf
, &
size
)) {

122  
’c_uÁru¡ed_wr™ev
(
ho¡_fd_
, 
buf
, 
size
);

125 
ssize_t
 
	gIOCÚ‹xtN©ive
::
R—dv
(cÚ¡ 
iovec
 *
iov
, 
iovút
) {

126 ià(
	giovút
 <= 0) {

127 
”ºo
 = 
EINVAL
;

130 *
	gbuf
;

131 
	gsize
;

132 ià(!
C»©eUÁru¡edBufãr
(
iov
, 
iovút
, &
buf
, &
size
)) {

135  
’c_uÁru¡ed_»adv
(
ho¡_fd_
, 
iov
, 
iovút
, 
buf
, 
size
);

138 
	gIOCÚ‹xtN©ive
::
S‘SockO±
(
Ëv–
, 
İtiÚ_Çme
,

139 cÚ¡ *
İtiÚ_v®ue
,

140 
sockËn_t
 
İtiÚ_Ën
) {

141  
’c_uÁru¡ed_£tsockİt
(
ho¡_fd_
, 
Ëv–
, 
İtiÚ_Çme
, 
İtiÚ_v®ue
,

142 
İtiÚ_Ën
);

145 
	gIOCÚ‹xtN©ive
::
CÚÃù
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

146  
’c_uÁru¡ed_cÚÃù
(
ho¡_fd_
, 
addr
, 
add¾’
);

149 
	gIOCÚ‹xtN©ive
::
Shutdown
(
how
) {

150  
’c_uÁru¡ed_shutdown
(
ho¡_fd_
, 
how
);

153 
ssize_t
 
	gIOCÚ‹xtN©ive
::
S’d
(cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
) {

154  
’c_uÁru¡ed_£nd
(
ho¡_fd_
, 
buf
, 
Ën
, 
æags
);

157 
	gIOCÚ‹xtN©ive
::
G‘SockO±
(
Ëv–
, 
İŠame
, *
İtv®
,

158 
sockËn_t
 *
İ’
) {

159  
’c_uÁru¡ed_g‘sockİt
(
ho¡_fd_
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
);

162 
	gIOCÚ‹xtN©ive
::
Acû±
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

163  
’c_uÁru¡ed_acû±
(
ho¡_fd_
, 
addr
, 
add¾’
);

166 
	gIOCÚ‹xtN©ive
::
Bšd
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

167  
’c_uÁru¡ed_bšd
(
ho¡_fd_
, 
addr
, 
add¾’
);

170 
	gIOCÚ‹xtN©ive
::
Li¡’
(
backlog
) {

171  
’c_uÁru¡ed_li¡’
(
ho¡_fd_
, 
backlog
);

174 
ssize_t
 
	gIOCÚ‹xtN©ive
::
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
) {

175 
	gasylo
::
BridgeMsghdrW¿µ”
 
tmp_w¿µ”
(
msg
);

176 ià(!
	gtmp_w¿µ”
.
CİyAÎBufãrs
()) {

178 
	g”ºo
 = 
EFAULT
;

182  
’c_uÁru¡ed_£ndmsg
(
ho¡_fd_
, 
tmp_w¿µ”
.
g‘_msg
(), 
æags
);

185 
ssize_t
 
	gIOCÚ‹xtN©ive
::
RecvMsg
(
msghdr
 *
msg
, 
æags
) {

186 
	gasylo
::
BridgeMsghdrW¿µ”
 
tmp_w¿µ”
(
msg
);

187 ià(!
	gtmp_w¿µ”
.
CİyAÎBufãrs
()) {

189 
	g”ºo
 = 
EFAULT
;

192  
’c_uÁru¡ed_»cvmsg
(
ho¡_fd_
, 
msg
, 
tmp_w¿µ”
.
g‘_msg
(), 
æags
);

195 
	gIOCÚ‹xtN©ive
::
G‘SockName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

196  
’c_uÁru¡ed_g‘sockÇme
(
ho¡_fd_
, 
addr
, 
add¾’
);

199 
	gIOCÚ‹xtN©ive
::
G‘P“rName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

200  
’c_uÁru¡ed_g‘³”Çme
(
ho¡_fd_
, 
addr
, 
add¾’
);

203 
ssize_t
 
	gIOCÚ‹xtN©ive
::
RecvFrom
(*
buf
, 
size_t
 
Ën
, 
æags
,

204 
sockaddr
 *
¤c_addr
,

205 
sockËn_t
 *
add¾’
) {

206  
’c_uÁru¡ed_»cväom
(
ho¡_fd_
, 
buf
, 
Ën
, 
æags
, 
¤c_addr
, 
add¾’
);

209 
	gIOCÚ‹xtN©ive
::
G‘Ho¡FeDesütÜ
(è{  
ho¡_fd_
; }

211 
	g¡d
::
unique_±r
<
IOMªag”
::
IOCÚ‹xt
> 
N©iveP©hHªdËr
::
O³n
(cÚ¡ *
·th
,

212 
æags
,

213 
mode_t
 
mode
) {

214 ià(
	gæags
 & 
	gO_SECURE
) {

215  
	gIOCÚ‹xtSecu»
::
C»©e
(
·th
, 
æags
, 
mode
);

218 
	gho¡_fd
 = 
’c_uÁru¡ed_İ’
(
·th
, 
æags
, 
mode
);

219 ià(
	gho¡_fd
 < 0) {

220  
	gnuÎ±r
;

223  ::
ab¦
::
make_unique
<
IOCÚ‹xtN©ive
>(
ho¡_fd
);

226 
	gN©iveP©hHªdËr
::
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

227  
’c_uÁru¡ed_chown
(
·th
, 
owÃr
, 
group
);

230 
	gN©iveP©hHªdËr
::
Lšk
(cÚ¡ *
exi¡šg
, cÚ¡ *
Ãw_lšk
) {

231  
’c_uÁru¡ed_lšk
(
exi¡šg
, 
Ãw_lšk
);

234 
	gN©iveP©hHªdËr
::
UÆšk
(cÚ¡ *
·thÇme
) {

235  
’c_uÁru¡ed_uÆšk
(
·thÇme
);

238 
ssize_t
 
	gN©iveP©hHªdËr
::
R—dLšk
(cÚ¡ *
·th_Çme
, *
buf
,

239 
size_t
 
bufsize
) {

240  
’c_uÁru¡ed_»adlšk
(
·th_Çme
, 
buf
, 
bufsize
);

243 
	gN©iveP©hHªdËr
::
SymLšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
) {

244  
’c_uÁru¡ed_symlšk
(
·th1
, 
·th2
);

247 
	gN©iveP©hHªdËr
::
Trunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

248  
’c_uÁru¡ed_Œunÿ‹
(
·th
, 
Ëngth
);

251 
	gN©iveP©hHªdËr
::
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

252  
’c_uÁru¡ed_¡©
(
·thÇme
, 
¡©_bufãr
);

255 
	gN©iveP©hHªdËr
::
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

256  
’c_uÁru¡ed_l¡©
(
·thÇme
, 
¡©_bufãr
);

259 
	gN©iveP©hHªdËr
::
Mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

260  
’c_uÁru¡ed_mkdœ
(
·th
, 
mode
);

263 
	gN©iveP©hHªdËr
::
RmDœ
(cÚ¡ *
·thÇme
) {

264  
’c_uÁru¡ed_rmdœ
(
·thÇme
);

267 
	gN©iveP©hHªdËr
::
R’ame
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
) {

268  
’c_uÁru¡ed_»Çme
(
Şd·th
, 
Ãw·th
);

271 
	gN©iveP©hHªdËr
::
Acûss
(cÚ¡ *
·th
, 
mode
) {

272  
’c_uÁru¡ed_acûss
(
·th
, 
mode
);

275 
	gN©iveP©hHªdËr
::
ChMod
(cÚ¡ *
·th
, 
mode_t
 
mode
) {

276  
’c_uÁru¡ed_chmod
(
·th
, 
mode
);

279 
	gN©iveP©hHªdËr
::
Utime
(cÚ¡ *
f’ame
,

280 cÚ¡ 
utimbuf
 *
times
) {

281  
’c_uÁru¡ed_utime
(
f’ame
, 
times
);

284 
	gN©iveP©hHªdËr
::
Utimes
(cÚ¡ *
f’ame
,

285 cÚ¡ 
timev®
 
times
[2]) {

286  
’c_uÁru¡ed_utimes
(
f’ame
, 
times
);

	@platform/posix/io/native_paths.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_NATIVE_PATHS_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_NATIVE_PATHS_H_


	)

22 
	~<utime.h
>

24 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gio
 {

31 şas 
	cIOCÚ‹xtN©ive
 : 
public
 
IOMªag”
::
IOCÚ‹xt
 {

32 
public
:

33 
ex¶ic™
 
IOCÚ‹xtN©ive
(
ho¡_fd
è: 
ho¡_fd_
(host_fd) {}

35 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
è
	gov”ride
;

36 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
è
	gov”ride
;

37 
FChOwn
(
uid_t
 
owÃr
, 
gid_t
 
group
è
	gov”ride
;

38 
LS“k
(
off_t
 
off£t
, 
wh’û
è
	gov”ride
;

39 
FCÁl
(
cmd
, 
št64_t
 
¬g
è
	gov”ride
;

40 
FSync
(è
	gov”ride
;

41 
FSt
(
¡©
 *
¡©_bufãr
è
	gov”ride
;

42 
I§‰y
(è
	gov”ride
;

43 
FLock
(
İ”©iÚ
è
	gov”ride
;

44 
Clo£
(è
	gov”ride
;

45 
FTrunÿ‹
(
off_t
 
Ëngth
è
	gov”ride
;

46 
FChMod
(
mode_t
 
mode
è
	gov”ride
;

47 
ssize_t
 
Wr™ev
(cÚ¡ 
iovec
 *
iov
, 
iovút
è
	gov”ride
;

48 
ssize_t
 
R—dv
(cÚ¡ 
iovec
 *
iov
, 
iovút
è
	gov”ride
;

49 
S‘SockO±
(
Ëv–
, 
İtiÚ_Çme
, cÚ¡ *
İtiÚ_v®ue
,

50 
sockËn_t
 
İtiÚ_Ën
è
	gov”ride
;

51 
CÚÃù
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
è
	gov”ride
;

52 
Shutdown
(
how
è
	gov”ride
;

53 
ssize_t
 
S’d
(cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
è
	gov”ride
;

54 
G‘SockO±
(
Ëv–
, 
İŠame
, *
İtv®
,

55 
sockËn_t
 *
İ’
è
	gov”ride
;

56 
Acû±
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
è
	gov”ride
;

57 
Bšd
(cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
è
	gov”ride
;

58 
Li¡’
(
backlog
è
	gov”ride
;

59 
ssize_t
 
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
è
	gov”ride
;

60 
ssize_t
 
RecvMsg
(
msghdr
 *
msg
, 
æags
è
	gov”ride
;

61 
G‘SockName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
è
	gov”ride
;

62 
G‘P“rName
(
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
è
	gov”ride
;

63 
ssize_t
 
RecvFrom
(*
buf
, 
size_t
 
Ën
, 
æags
, 
sockaddr
 *
¤c_addr
,

64 
sockËn_t
 *
add¾’
è
	gov”ride
;

65 
G‘Ho¡FeDesütÜ
(è
	gov”ride
;

67 
	g´iv©e
:

69 
ho¡_fd_
;

70 
boŞ
 
C»©eUÁru¡edBufãr
(cÚ¡ 
iovec
 *
iov
,

71 
iovút
, **
buf
, *
size
);

72 
boŞ
 
S”ŸlizeIov
(cÚ¡ 
iovec
 *
iov
, 
iovút
,

73 **
buf
, *
size
);

77 şas 
	cN©iveP©hHªdËr
 : 
public
 
io
::
IOMªag”
::
Vœtu®P©hHªdËr
 {

78 
public
:

79 
¡d
::
unique_±r
<
io
::
IOMªag”
::
IOCÚ‹xt
> 
O³n
(cÚ¡ *
·th
, 
æags
,

80 
mode_t
 
mode
è
	gov”ride
;

82 
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
è
	gov”ride
;

83 
Lšk
(cÚ¡ *
exi¡šg
, cÚ¡ *
Ãw_lšk
è
	gov”ride
;

84 
UÆšk
(cÚ¡ *
·thÇme
è
	gov”ride
;

85 
ssize_t
 
R—dLšk
(cÚ¡ *
·th_Çme
, *
buf
, 
size_t
 
bufsize
è
	gov”ride
;

86 
SymLšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
è
	gov”ride
;

87 
Trunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
è
	gov”ride
;

88 
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
è
	gov”ride
;

89 
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
è
	gov”ride
;

90 
Mkdœ
(cÚ¡ *
·th
, 
mode_t
 
mode
è
	gov”ride
;

91 
RmDœ
(cÚ¡ *
·thÇme
è
	gov”ride
;

92 
R’ame
(cÚ¡ *
Şd·th
, cÚ¡ *
Ãw·th
è
	gov”ride
;

93 
Acûss
(cÚ¡ *
·th
, 
mode
è
	gov”ride
;

94 
ChMod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
è
	gov”ride
;

95 
Utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
è
	gov”ride
;

96 
Utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]è
	gov”ride
;

	@platform/posix/io/path_normalization_test.cc

19 
	~<ut™y
>

20 
	~<veùÜ
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/¡ršgs/¡r_»¶aû.h
"

24 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

25 
	~"asylo/¶©fÜm/posix/io/ut.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gio
 {

29 
Çme¥aû
 
	gut
 {

30 
	gÇme¥aû
 {

32 
usšg
 
	gP©hP¬ams
 = 
¡d
::
veùÜ
<¡d::
·œ
<
ab¦
::
¡ršg_v›w
, 
	gab¦
::string_view>>;

36 
şass
 
	gP©hNÜm®iz©iÚTe¡


37 : 
public
 ::
‹¡šg
::
Te¡W™hP¬am
<
P©hP¬ams
::
v®ue_ty³
> {};

43 
	g¡d
::
¡ršg
 
P©hP¬amsV®ueToTe¡Name
(

44 ::
‹¡šg
::
Te¡P¬amInfo
<
P©hP¬ams
::
v®ue_ty³
> 
·¿m_šfo
) {

45 
ab¦
::
¡ršg_v›w
 
šput
 = 
·¿m_šfo
.
·¿m
.
fœ¡
;

48 ià(
	gšput
.
em±y
())  "EMPTY";

52  
	gab¦
::
SŒR•ÏûAÎ
(
šput
, {{"/", "_"}, {"\\", "B"}, {".", "D"}});

57 
TEST_P
(
P©hNÜm®iz©iÚTe¡
, 
HasEx³ùedResuÉ
) {

58 
	gP©hP¬ams
::
v®ue_ty³
 
·¿ms
 = 
G‘P¬am
();

59 
EXPECT_EQ
(
NÜm®izeP©h
(
·¿ms
.
fœ¡
),…¬ams.
£cÚd
);

63 
P©hP¬ams
 
G‘Te¡P©hP¬ams
() {

103 
INSTANTIATE_TEST_SUITE_P
(
P©hLi¡
, 
P©hNÜm®iz©iÚTe¡
,

104 ::
‹¡šg
::
V®uesIn
(
G‘Te¡P©hP¬ams
()),

105 
P©hP¬amsV®ueToTe¡Name
);

	@platform/posix/io/path_normalization_test.cc

19 
	~<ut™y
>

20 
	~<veùÜ
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/¡ršgs/¡r_»¶aû.h
"

24 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

25 
	~"asylo/¶©fÜm/posix/io/ut.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gio
 {

29 
Çme¥aû
 
	gut
 {

30 
	gÇme¥aû
 {

32 
usšg
 
	gP©hP¬ams
 = 
¡d
::
veùÜ
<¡d::
·œ
<
ab¦
::
¡ršg_v›w
, 
	gab¦
::string_view>>;

36 
şass
 
	gP©hNÜm®iz©iÚTe¡


37 : 
public
 ::
‹¡šg
::
Te¡W™hP¬am
<
P©hP¬ams
::
v®ue_ty³
> {};

43 
	g¡d
::
¡ršg
 
P©hP¬amsV®ueToTe¡Name
(

44 ::
‹¡šg
::
Te¡P¬amInfo
<
P©hP¬ams
::
v®ue_ty³
> 
·¿m_šfo
) {

45 
ab¦
::
¡ršg_v›w
 
šput
 = 
·¿m_šfo
.
·¿m
.
fœ¡
;

48 ià(
	gšput
.
em±y
())  "EMPTY";

52  
	gab¦
::
SŒR•ÏûAÎ
(
šput
, {{"/", "_"}, {"\\", "B"}, {".", "D"}});

57 
TEST_P
(
P©hNÜm®iz©iÚTe¡
, 
HasEx³ùedResuÉ
) {

58 
	gP©hP¬ams
::
v®ue_ty³
 
·¿ms
 = 
G‘P¬am
();

59 
EXPECT_EQ
(
NÜm®izeP©h
(
·¿ms
.
fœ¡
),…¬ams.
£cÚd
);

63 
P©hP¬ams
 
G‘Te¡P©hP¬ams
() {

103 
INSTANTIATE_TEST_SUITE_P
(
P©hLi¡
, 
P©hNÜm®iz©iÚTe¡
,

104 ::
‹¡šg
::
V®uesIn
(
G‘Te¡P©hP¬ams
()),

105 
P©hP¬amsV®ueToTe¡Name
);

	@platform/posix/io/pipe_test_driver.cc

19 
	~<fú.h
>

20 
	~<uni¡d.h
>

21 
	~<c¡dio
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
SŒEq
;

34 şas 
	cPeOuutTe¡
 : 
public
 
EnşaveTe¡
 {

35 
public
:

36 
S‘Up
(è
ov”ride
 {

38 
·œ_¡dš
[2];

39 
	g·œ_¡dout
[2];

40 
	g·œ_¡d”r
[2];

42 
CHECK_EQ
(
pe
(
·œ_¡dš
), 0);

43 
CHECK_EQ
(
pe
(
·œ_¡dout
), 0);

44 
CHECK_EQ
(
pe
(
·œ_¡d”r
), 0);

47 
£t_¡dš
(
·œ_¡dš
[0]);

48 
£t_¡dout
(
·œ_¡dout
[1]);

49 
£t_¡d”r
(
·œ_¡d”r
[1]);

52 
	g’şave_š_
 = 
fdİ’
(
·œ_¡dš
[1], "w");

53 
	g’şave_out_
 = 
fdİ’
(
·œ_¡dout
[0], "r");

54 
	g’şave_”r_
 = 
fdİ’
(
·œ_¡d”r
[0], "r");

56 
S‘UpBa£
();

59 
	g´Ùeùed
:

61 
FILE
 *
’şave_š_
;

62 
FILE
 *
	g’şave_out_
;

63 
FILE
 *
	g’şave_”r_
;

66 
TEST_F
(
PeOuutTe¡
, 
Wr™eTe¡
) {

67 
EnşaveIÅut
 
	g’şave_šput
;

70 
åuts
("H–lØäomhdriv”!", 
’şave_š_
);

71 
fşo£
(
’şave_š_
);

73 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

75 
	gbuf
[1024];

78 
ASSERT_NE
(
fg‘s
(
buf
, (buf), 
’şave_out_
), 
nuÎ±r
);

79 
EXPECT_THAT
(
buf
, 
SŒEq
("Hello fromƒnclave stdout!\n"));

82 
ASSERT_NE
(
fg‘s
(
buf
, (buf), 
’şave_”r_
), 
nuÎ±r
);

83 
EXPECT_THAT
(
buf
, 
SŒEq
("Hello fromƒnclave stderr!\n"));

	@platform/posix/io/pipe_test_driver.cc

19 
	~<fú.h
>

20 
	~<uni¡d.h
>

21 
	~<c¡dio
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
SŒEq
;

34 şas 
	cPeOuutTe¡
 : 
public
 
EnşaveTe¡
 {

35 
public
:

36 
S‘Up
(è
ov”ride
 {

38 
·œ_¡dš
[2];

39 
	g·œ_¡dout
[2];

40 
	g·œ_¡d”r
[2];

42 
CHECK_EQ
(
pe
(
·œ_¡dš
), 0);

43 
CHECK_EQ
(
pe
(
·œ_¡dout
), 0);

44 
CHECK_EQ
(
pe
(
·œ_¡d”r
), 0);

47 
£t_¡dš
(
·œ_¡dš
[0]);

48 
£t_¡dout
(
·œ_¡dout
[1]);

49 
£t_¡d”r
(
·œ_¡d”r
[1]);

52 
	g’şave_š_
 = 
fdİ’
(
·œ_¡dš
[1], "w");

53 
	g’şave_out_
 = 
fdİ’
(
·œ_¡dout
[0], "r");

54 
	g’şave_”r_
 = 
fdİ’
(
·œ_¡d”r
[0], "r");

56 
S‘UpBa£
();

59 
	g´Ùeùed
:

61 
FILE
 *
’şave_š_
;

62 
FILE
 *
	g’şave_out_
;

63 
FILE
 *
	g’şave_”r_
;

66 
TEST_F
(
PeOuutTe¡
, 
Wr™eTe¡
) {

67 
EnşaveIÅut
 
	g’şave_šput
;

70 
åuts
("H–lØäomhdriv”!", 
’şave_š_
);

71 
fşo£
(
’şave_š_
);

73 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

75 
	gbuf
[1024];

78 
ASSERT_NE
(
fg‘s
(
buf
, (buf), 
’şave_out_
), 
nuÎ±r
);

79 
EXPECT_THAT
(
buf
, 
SŒEq
("Hello fromƒnclave stdout!\n"));

82 
ASSERT_NE
(
fg‘s
(
buf
, (buf), 
’şave_”r_
), 
nuÎ±r
);

83 
EXPECT_THAT
(
buf
, 
SŒEq
("Hello fromƒnclave stderr!\n"));

	@platform/posix/io/pipe_test_enclave.cc

19 
	~<¡dio.h
>

20 
	~<uni¡d.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
Çme¥aû
 
	gasylo
 {

27 şas 
	cPeTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

28 
public
:

29 
PeTe¡
() = ;

31 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

33 
´štf
("Hello fromƒnclave stdout!\n");

34 
årštf
(
¡d”r
, "Hello fromƒnclave stderr!\n");

37 
fşo£
(
¡dout
);

38 
fşo£
(
¡d”r
);

41 
	gbuf
[1024];

42 
fg‘s
(
buf
, (buf), 
¡dš
);

43 ià(
¡ºcmp
(
buf
, "Hello fromhe driver!", (buf)) != 0) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Read bad input from stdin");

47  
	gStus
::
OkStus
();

51 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
PeTe¡
; 
	}
}

	@platform/posix/io/pipe_test_enclave.cc

19 
	~<¡dio.h
>

20 
	~<uni¡d.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

25 
Çme¥aû
 
	gasylo
 {

27 şas 
	cPeTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

28 
public
:

29 
PeTe¡
() = ;

31 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

33 
´štf
("Hello fromƒnclave stdout!\n");

34 
årštf
(
¡d”r
, "Hello fromƒnclave stderr!\n");

37 
fşo£
(
¡dout
);

38 
fşo£
(
¡d”r
);

41 
	gbuf
[1024];

42 
fg‘s
(
buf
, (buf), 
¡dš
);

43 ià(
¡ºcmp
(
buf
, "Hello fromhe driver!", (buf)) != 0) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Read bad input from stdin");

47  
	gStus
::
OkStus
();

51 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
PeTe¡
; 
	}
}

	@platform/posix/io/random_devices.cc

19 
	~"asylo/¶©fÜm/posix/io/¿ndom_deviûs.h
"

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/sysmaüos.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/h¬dw¬e_¿ndom.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
G‘St
(
¡©
 *
¡©_bufãr
, 
boŞ
 
is_u¿ndom
) {

35 
cÚ¡ex´
 
	gmajÜ_dev
 = 0;

36 
cÚ¡ex´
 
	gmšÜ_dev
 = 0;

37 
cÚ¡ex´
 
	gmajÜ_rdev
 = 1;

38 cÚ¡ 
	gmšÜ_rdev
 = 
is_u¿ndom
 ? 9 : 8;

40 
cÚ¡ex´
 
	gmode
 =

41 
S_IFCHR
 | 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
 | 
S_IROTH
 | 
S_IWOTH
;

42 
cÚ¡ex´
 
	gblksize
 = 4096;

44 
	g¡©_bufãr
->
	g¡_dev
 = 
makedev
(
majÜ_dev
, 
mšÜ_dev
);

45 
	g¡©_bufãr
->
	g¡_šo
 = -1;

46 
	g¡©_bufãr
->
	g¡_mode
 = 
mode
;

47 
	g¡©_bufãr
->
	g¡_Æšk
 = 0;

48 
	g¡©_bufãr
->
	g¡_uid
 = 0;

49 
	g¡©_bufãr
->
	g¡_gid
 = 0;

50 
	g¡©_bufãr
->
	g¡_rdev
 = 
makedev
(
majÜ_rdev
, 
mšÜ_rdev
);

51 
	g¡©_bufãr
->
	g¡_size
 = 0;

52 
	g¡©_bufãr
->
	g¡_blksize
 = 
blksize
;

53 
	g¡©_bufãr
->
	g¡_blocks
 = 0;

60 
ssize_t
 
	gRªdomIOCÚ‹xt
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

62  
’c_h¬dw¬e_¿ndom
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
buf
), 
couÁ
);

65 
ssize_t
 
	gRªdomIOCÚ‹xt
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

67 
	g”ºo
 = 
EBADF
;

71 
	gRªdomIOCÚ‹xt
::
Clo£
() {

76 
	gRªdomIOCÚ‹xt
::
LS“k
(
off_t
 
off£t
, 
wh’û
) {

81 
	gRªdomIOCÚ‹xt
::
FSync
() {

86 
	gRªdomIOCÚ‹xt
::
FSt
(
¡©
 *
¡©_bufãr
) {

87  
G‘St
(
¡©_bufãr
, 
IsURªdom
());

90 
	gRªdomIOCÚ‹xt
::
I§‰y
() {

95 
	g¡d
::
unique_±r
<
io
::
IOMªag”
::
IOCÚ‹xt
> 
RªdomP©hHªdËr
::
O³n
(

96 cÚ¡ *
·th
, 
æags
, 
mode_t
 
mode
) {

97 
boŞ
 
	gis_¿ndom
 = 
¡rcmp
(
·th
, 
kRªdomP©h
) == 0;

98 
boŞ
 
	gis_u¿ndom
 = 
¡rcmp
(
·th
, 
kURªdomP©h
) == 0;

99 ià(
	gis_¿ndom
 || 
	gis_u¿ndom
) {

100  ::
ab¦
::
make_unique
<
RªdomIOCÚ‹xt
>(
is_u¿ndom
);

103 
	g”ºo
 = 
ENOENT
;

104  
	gnuÎ±r
;

107 
	gRªdomP©hHªdËr
::
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

108 
	g”ºo
 = 
ENOSYS
;

112 
	gRªdomP©hHªdËr
::
Lšk
(cÚ¡ *
exi¡šg
, cÚ¡ *
Ãw_lšk
) {

113 
	g”ºo
 = 
ENOSYS
;

117 
	gRªdomP©hHªdËr
::
UÆšk
(cÚ¡ *
·thÇme
) {

118 
”ºo
 = 
EPERM
;

122 
ssize_t
 
	gRªdomP©hHªdËr
::
R—dLšk
(cÚ¡ *
·th_Çme
, *
buf
,

123 
size_t
 
bufsize
) {

124 
	g”ºo
 = 
ENOSYS
;

128 
	gRªdomP©hHªdËr
::
SymLšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
) {

129 
	g”ºo
 = 
ENOSYS
;

133 
	gRªdomP©hHªdËr
::
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

134 
boŞ
 
	gis_¿ndom
 = 
¡rcmp
(
·thÇme
, 
kRªdomP©h
) == 0;

135 
boŞ
 
	gis_u¿ndom
 = 
¡rcmp
(
·thÇme
, 
kURªdomP©h
) == 0;

136 ià(
	gis_¿ndom
 || 
	gis_u¿ndom
) {

137  
G‘St
(
¡©_bufãr
, 
is_u¿ndom
);

139 
	g”ºo
 = 
ENOENT
;

143 
	gRªdomP©hHªdËr
::
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

144  
St
(
·thÇme
, 
¡©_bufãr
);

	@platform/posix/io/random_devices.cc

19 
	~"asylo/¶©fÜm/posix/io/¿ndom_deviûs.h
"

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<¡ršg.h
>

24 
	~<sys/sysmaüos.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/h¬dw¬e_¿ndom.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
G‘St
(
¡©
 *
¡©_bufãr
, 
boŞ
 
is_u¿ndom
) {

35 
cÚ¡ex´
 
	gmajÜ_dev
 = 0;

36 
cÚ¡ex´
 
	gmšÜ_dev
 = 0;

37 
cÚ¡ex´
 
	gmajÜ_rdev
 = 1;

38 cÚ¡ 
	gmšÜ_rdev
 = 
is_u¿ndom
 ? 9 : 8;

40 
cÚ¡ex´
 
	gmode
 =

41 
S_IFCHR
 | 
S_IRUSR
 | 
S_IWUSR
 | 
S_IRGRP
 | 
S_IWGRP
 | 
S_IROTH
 | 
S_IWOTH
;

42 
cÚ¡ex´
 
	gblksize
 = 4096;

44 
	g¡©_bufãr
->
	g¡_dev
 = 
makedev
(
majÜ_dev
, 
mšÜ_dev
);

45 
	g¡©_bufãr
->
	g¡_šo
 = -1;

46 
	g¡©_bufãr
->
	g¡_mode
 = 
mode
;

47 
	g¡©_bufãr
->
	g¡_Æšk
 = 0;

48 
	g¡©_bufãr
->
	g¡_uid
 = 0;

49 
	g¡©_bufãr
->
	g¡_gid
 = 0;

50 
	g¡©_bufãr
->
	g¡_rdev
 = 
makedev
(
majÜ_rdev
, 
mšÜ_rdev
);

51 
	g¡©_bufãr
->
	g¡_size
 = 0;

52 
	g¡©_bufãr
->
	g¡_blksize
 = 
blksize
;

53 
	g¡©_bufãr
->
	g¡_blocks
 = 0;

60 
ssize_t
 
	gRªdomIOCÚ‹xt
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

62  
’c_h¬dw¬e_¿ndom
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
buf
), 
couÁ
);

65 
ssize_t
 
	gRªdomIOCÚ‹xt
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

67 
	g”ºo
 = 
EBADF
;

71 
	gRªdomIOCÚ‹xt
::
Clo£
() {

76 
	gRªdomIOCÚ‹xt
::
LS“k
(
off_t
 
off£t
, 
wh’û
) {

81 
	gRªdomIOCÚ‹xt
::
FSync
() {

86 
	gRªdomIOCÚ‹xt
::
FSt
(
¡©
 *
¡©_bufãr
) {

87  
G‘St
(
¡©_bufãr
, 
IsURªdom
());

90 
	gRªdomIOCÚ‹xt
::
I§‰y
() {

95 
	g¡d
::
unique_±r
<
io
::
IOMªag”
::
IOCÚ‹xt
> 
RªdomP©hHªdËr
::
O³n
(

96 cÚ¡ *
·th
, 
æags
, 
mode_t
 
mode
) {

97 
boŞ
 
	gis_¿ndom
 = 
¡rcmp
(
·th
, 
kRªdomP©h
) == 0;

98 
boŞ
 
	gis_u¿ndom
 = 
¡rcmp
(
·th
, 
kURªdomP©h
) == 0;

99 ià(
	gis_¿ndom
 || 
	gis_u¿ndom
) {

100  ::
ab¦
::
make_unique
<
RªdomIOCÚ‹xt
>(
is_u¿ndom
);

103 
	g”ºo
 = 
ENOENT
;

104  
	gnuÎ±r
;

107 
	gRªdomP©hHªdËr
::
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

108 
	g”ºo
 = 
ENOSYS
;

112 
	gRªdomP©hHªdËr
::
Lšk
(cÚ¡ *
exi¡šg
, cÚ¡ *
Ãw_lšk
) {

113 
	g”ºo
 = 
ENOSYS
;

117 
	gRªdomP©hHªdËr
::
UÆšk
(cÚ¡ *
·thÇme
) {

118 
”ºo
 = 
EPERM
;

122 
ssize_t
 
	gRªdomP©hHªdËr
::
R—dLšk
(cÚ¡ *
·th_Çme
, *
buf
,

123 
size_t
 
bufsize
) {

124 
	g”ºo
 = 
ENOSYS
;

128 
	gRªdomP©hHªdËr
::
SymLšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
) {

129 
	g”ºo
 = 
ENOSYS
;

133 
	gRªdomP©hHªdËr
::
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

134 
boŞ
 
	gis_¿ndom
 = 
¡rcmp
(
·thÇme
, 
kRªdomP©h
) == 0;

135 
boŞ
 
	gis_u¿ndom
 = 
¡rcmp
(
·thÇme
, 
kURªdomP©h
) == 0;

136 ià(
	gis_¿ndom
 || 
	gis_u¿ndom
) {

137  
G‘St
(
¡©_bufãr
, 
is_u¿ndom
);

139 
	g”ºo
 = 
ENOENT
;

143 
	gRªdomP©hHªdËr
::
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

144  
St
(
·thÇme
, 
¡©_bufãr
);

	@platform/posix/io/random_devices.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_RANDOM_DEVICES_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_RANDOM_DEVICES_H_


	)

22 
	~<sys/¡©.h
>

23 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

25 
Çme¥aû
 
	gasylo
 {

28 şas 
	cRªdomIOCÚ‹xt
 : 
public
 
io
::
IOMªag”
::
IOCÚ‹xt
 {

29 
public
:

30 
RªdomIOCÚ‹xt
(
boŞ
 
is_u¿ndom
è: 
is_u¿ndom_
(is_urandom) {}

31 cÚ¡ 
boŞ
 &
IsURªdom
(ècÚ¡ {  
is_u¿ndom_
; }

33 
	g´Ùeùed
:

34 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
è
	gov”ride
;

35 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
è
	gov”ride
;

36 
Clo£
(è
	gov”ride
;

37 
LS“k
(
off_t
 
off£t
, 
wh’û
è
	gov”ride
;

38 
FSync
(è
	gov”ride
;

39 
FSt
(
¡©
 *
¡©_bufãr
è
	gov”ride
;

40 
I§‰y
(è
	gov”ride
;

42 
	g´iv©e
:

43 
boŞ
 
is_u¿ndom_
;

47 şas 
	cRªdomP©hHªdËr
 : 
public
 
io
::
IOMªag”
::
Vœtu®P©hHªdËr
 {

48 
public
:

49 
cÚ¡ex´
 cÚ¡ *cÚ¡ 
kRªdomP©h
 = "/dev/random";

50 
cÚ¡ex´
 cÚ¡ *cÚ¡ 
	gkURªdomP©h
 = "/dev/urandom";

52 
	g´Ùeùed
:

53 
¡d
::
unique_±r
<
io
::
IOMªag”
::
IOCÚ‹xt
> 
O³n
(cÚ¡ *
·th
, 
æags
,

54 
mode_t
 
mode
è
	gov”ride
;

56 
Chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
è
	gov”ride
;

58 
Lšk
(cÚ¡ *
exi¡šg
, cÚ¡ *
Ãw_lšk
è
	gov”ride
;

60 
ssize_t
 
R—dLšk
(cÚ¡ *
·th_Çme
, *
buf
, 
size_t
 
bufsize
è
	gov”ride
;

62 
SymLšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
è
	gov”ride
;

64 
St
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
è
	gov”ride
;

66 
LSt
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
è
	gov”ride
;

68 
UÆšk
(cÚ¡ *
·thÇme
è
	gov”ride
;

	@platform/posix/io/read_write_multithread_test.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<¡dio.h
>

22 
	~<uni¡d.h
>

23 
	~<futu»
>

24 
	~<s¡»am
>

25 
	~<¡ršg
>

26 
	~<th»ad
>

27 
	~<veùÜ
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

34 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

35 
	~"asylo/‹¡/ut/‹¡_æags.h
"

36 
	~"asylo/ut/ş—nup.h
"

37 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

38 
	~"asylo/ut/¡©us.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

44 
cÚ¡ex´
 
	gkNumTh»ads
 = 9;

47 
	g¡d
::
¡ršg
 
G’”©eRªdomSŒšg
() {

48 
cÚ¡ex´
 
»s_Ën
 = 10;

49 
	g¡d
::
¡ršg
 
®pha_num
 =

51 
	g¡d
::
¡ršg
 
»s
;

52 
	gi
 = 0; i < 
	g»s_Ën
; ++i) {

53 
	g»s
.
push_back
(
®pha_num
[
¿nd
(è%‡Íha_num.
size
()]);

55  
	g»s
;

58 
Stus
 
G’”©eE¼ÜStusFromE¼no
(cÚ¡ *
mes§ge
, cÚ¡ *
·th
) {

59  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

60 
ab¦
::
SŒC©
(
mes§ge
, ":", 
·th
));

67 
Stus
 
Wr™eR—d
(cÚ¡ *
·th
) {

69 
	g¡d
::
¡ršg
 
mes§ge
 = 
G’”©eRªdomSŒšg
();

70 ià(!
	g·th
 || !*·th || 
	gmes§ge
.
em±y
()) {

71  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_ENOMSG
, "File…ath or message isƒmpty");

74 
	gfd
 = 
İ’
(
·th
, 
O_CREAT
 | 
O_RDWR
 | 
O_APPEND
, 0644);

75 ià(
	gfd
 < 0) {

76  
G’”©eE¼ÜStusFromE¼no
("FaedØİ’ fe", 
·th
);

78 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

79 ià(
	grc
 !ğ
mes§ge
.
size
()) {

80  
G’”©eE¼ÜStusFromE¼no
("FaedØwr™tØfe", 
·th
);

82 ià(
şo£
(
fd
) != 0) {

83  
G’”©eE¼ÜStusFromE¼no
("FaedØşo£ fe", 
·th
);

85 
	gfd
 = 
İ’
(
·th
, 
O_CREAT
 | 
O_RDWR
 | 
O_APPEND
, 0664);

86 ià(
	gfd
 < 0) {

87  
G’”©eE¼ÜStusFromE¼no
("FaedØİ’ fe", 
·th
);

90 
	gbuf
[1024];

91 
	grc
 = 
»ad
(
fd
, 
buf
, (buf));

92 ià(
	grc
 == -1) {

93  
G’”©eE¼ÜStusFromE¼no
("FaedØ»ad from fe", 
·th
);

95 ià(
	grc
 >ğ(
buf
è|| 
rc
 < 
mes§ge
.
size
()) {

96  
Stus
(

97 
”rÜ
::
PosixE¼Ü
::
P_EFAULT
,

98 
ab¦
::
SŒC©
("UÃx³ùed‚umb” oàby‹ »ad from fe:", 
·th
));

100 ià(!
¡r¡r
(
buf
, 
mes§ge
.
c_¡r
())) {

101  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EFAULT
,

102 
ab¦
::
SŒC©
("UÃx³ùed mes§g»ad from fe:", 
·th
));

104 ià(
şo£
(
fd
) != 0) {

105  
G’”©eE¼ÜStusFromE¼no
("FaedØşo£ fe", 
·th
);

107  
	gStus
::
OkStus
();

110 
TEST
(
R—dWr™eMuÉiTh»adTe¡
, 
MuÉiTh»adTe¡
) {

113 
	gM®locUniquePŒ
<> 
‹¡_fe
(
‹m²am
(
FLAGS_‹¡_tmpdœ
.
c_¡r
(), "MRWT"));

114 
CËªup
 
»move_fe
([&
‹¡_fe
] { 
»move
Ñe¡_fe.
g‘
()); });

118 
	g¡d
::
veùÜ
<
¡d
::
futu»
<
Stus
>> 
futu»s
;

120 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

121 
	gfutu»s
.
push_back
(

122 
¡d
::
async
(¡d::
Ïunch
::async, &
Wr™eR—d
, 
‹¡_fe
.
g‘
()));

125 autØ&
	g»suÉ
 : 
futu»s
) {

126 
EXPECT_THAT
(
»suÉ
.
g‘
(), 
IsOk
());

	@platform/posix/io/read_write_multithread_test.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<¡dio.h
>

22 
	~<uni¡d.h
>

23 
	~<futu»
>

24 
	~<s¡»am
>

25 
	~<¡ršg
>

26 
	~<th»ad
>

27 
	~<veùÜ
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

33 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

34 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

35 
	~"asylo/‹¡/ut/‹¡_æags.h
"

36 
	~"asylo/ut/ş—nup.h
"

37 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

38 
	~"asylo/ut/¡©us.h
"

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

44 
cÚ¡ex´
 
	gkNumTh»ads
 = 9;

47 
	g¡d
::
¡ršg
 
G’”©eRªdomSŒšg
() {

48 
cÚ¡ex´
 
»s_Ën
 = 10;

49 
	g¡d
::
¡ršg
 
®pha_num
 =

51 
	g¡d
::
¡ršg
 
»s
;

52 
	gi
 = 0; i < 
	g»s_Ën
; ++i) {

53 
	g»s
.
push_back
(
®pha_num
[
¿nd
(è%‡Íha_num.
size
()]);

55  
	g»s
;

58 
Stus
 
G’”©eE¼ÜStusFromE¼no
(cÚ¡ *
mes§ge
, cÚ¡ *
·th
) {

59  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

60 
ab¦
::
SŒC©
(
mes§ge
, ":", 
·th
));

67 
Stus
 
Wr™eR—d
(cÚ¡ *
·th
) {

69 
	g¡d
::
¡ršg
 
mes§ge
 = 
G’”©eRªdomSŒšg
();

70 ià(!
	g·th
 || !*·th || 
	gmes§ge
.
em±y
()) {

71  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_ENOMSG
, "File…ath or message isƒmpty");

74 
	gfd
 = 
İ’
(
·th
, 
O_CREAT
 | 
O_RDWR
 | 
O_APPEND
, 0644);

75 ià(
	gfd
 < 0) {

76  
G’”©eE¼ÜStusFromE¼no
("FaedØİ’ fe", 
·th
);

78 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

79 ià(
	grc
 !ğ
mes§ge
.
size
()) {

80  
G’”©eE¼ÜStusFromE¼no
("FaedØwr™tØfe", 
·th
);

82 ià(
şo£
(
fd
) != 0) {

83  
G’”©eE¼ÜStusFromE¼no
("FaedØşo£ fe", 
·th
);

85 
	gfd
 = 
İ’
(
·th
, 
O_CREAT
 | 
O_RDWR
 | 
O_APPEND
, 0664);

86 ià(
	gfd
 < 0) {

87  
G’”©eE¼ÜStusFromE¼no
("FaedØİ’ fe", 
·th
);

90 
	gbuf
[1024];

91 
	grc
 = 
»ad
(
fd
, 
buf
, (buf));

92 ià(
	grc
 == -1) {

93  
G’”©eE¼ÜStusFromE¼no
("FaedØ»ad from fe", 
·th
);

95 ià(
	grc
 >ğ(
buf
è|| 
rc
 < 
mes§ge
.
size
()) {

96  
Stus
(

97 
”rÜ
::
PosixE¼Ü
::
P_EFAULT
,

98 
ab¦
::
SŒC©
("UÃx³ùed‚umb” oàby‹ »ad from fe:", 
·th
));

100 ià(!
¡r¡r
(
buf
, 
mes§ge
.
c_¡r
())) {

101  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EFAULT
,

102 
ab¦
::
SŒC©
("UÃx³ùed mes§g»ad from fe:", 
·th
));

104 ià(
şo£
(
fd
) != 0) {

105  
G’”©eE¼ÜStusFromE¼no
("FaedØşo£ fe", 
·th
);

107  
	gStus
::
OkStus
();

110 
TEST
(
R—dWr™eMuÉiTh»adTe¡
, 
MuÉiTh»adTe¡
) {

113 
	gM®locUniquePŒ
<> 
‹¡_fe
(
‹m²am
(
FLAGS_‹¡_tmpdœ
.
c_¡r
(), "MRWT"));

114 
CËªup
 
»move_fe
([&
‹¡_fe
] { 
»move
Ñe¡_fe.
g‘
()); });

118 
	g¡d
::
veùÜ
<
¡d
::
futu»
<
Stus
>> 
futu»s
;

120 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

121 
	gfutu»s
.
push_back
(

122 
¡d
::
async
(¡d::
Ïunch
::async, &
Wr™eR—d
, 
‹¡_fe
.
g‘
()));

125 autØ&
	g»suÉ
 : 
futu»s
) {

126 
EXPECT_THAT
(
»suÉ
.
g‘
(), 
IsOk
());

	@platform/posix/io/read_write_test.cc

19 
	~<fú.h
>

20 
	~<İ’s¦/¿nd.h
>

21 
	~<¡dio.h
>

22 
	~<sys/ioùl.h
>

23 
	~<uni¡d.h
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

30 
	~"asylo/ut/loggšg.h
"

31 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/‹¡/ut/‹¡_æags.h
"

34 
	~"asylo/ut/ş—nsšg_ty³s.h
"

35 
	~"asylo/ut/¡©us.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 
cÚ¡ex´
 
size_t
 
	gkKeyL’gth
 = 32;

41 
cÚ¡ex´
 
size_t
 
	gkBlockL’gth
 = 128;

43 cÚ¡ *
	gkUÁru¡edTe¡Text
 = "Lorem ipsum dolor sit‡met...\n";

44 cÚ¡ *
	gkSecu»Te¡Text
 =

48 şas 
	cR—dWr™eTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

49 
´Ùeùed
:

50 
S‘Up
(è
ov”ride
 {

53 
‹¡_fe_
.
»£t
(
‹m²am
(
FLAGS_‹¡_tmpdœ
.
c_¡r
(), "RWT"));

56 
T—rDown
(è
	gov”ride
 {

57 ià(
	g‹¡_fe_
) {

58 
»move
(
‹¡_fe_
.
g‘
());

62 
	gasylo
::
M®locUniquePŒ
<> 
‹¡_fe_
;

65 
TEST_F
(
R—dWr™eTe¡
, 
FeDesütÜOrd”šgTe¡
) {

66 
	gfd1
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

67 
	gfd2
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

68 
	gfd3
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

71 
EXPECT_EQ
(
fd2
, 
fd1
 + 1);

72 
EXPECT_EQ
(
fd3
, 
fd2
 + 1);

75 
şo£
(
fd1
);

76 
şo£
(
fd2
);

77 
şo£
(
fd3
);

78 
EXPECT_EQ
(
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644), 
fd1
);

79 
EXPECT_EQ
(
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644), 
fd2
);

80 
EXPECT_EQ
(
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644), 
fd3
);

83 
TEST_F
(
R—dWr™eTe¡
, 
R—dWr™eUÁru¡edTe¡
) {

85 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

86 
ASSERT_GE
(
fd
, 0);

89 
size_t
 
	grc
 = 
wr™e
(
fd
, 
kUÁru¡edTe¡Text
, 
¡¾’
(kUntrustedTestText));

90 
EXPECT_EQ
(
rc
, 
¡¾’
(
kUÁru¡edTe¡Text
));

93 
EXPECT_EQ
(
şo£
(
fd
), 0);

96 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_RDONLY
);

97 
ASSERT_GE
(
fd
, 0);

100 
	gbuf1
[1024];

101 
	grc
 = 
»ad
(
fd
, 
buf1
, 
¡¾’
(
kUÁru¡edTe¡Text
));

102 
ASSERT_LT
(
rc
, (
buf1
));

103 
EXPECT_EQ
(
rc
, 
¡¾’
(
kUÁru¡edTe¡Text
));

104 
	gbuf1
[
rc
] = '\0';

105 
EXPECT_EQ
(
¡rcmp
(
buf1
, 
kUÁru¡edTe¡Text
), 0);

108 
off_t
 
	goff£t
 = 10;

109 
ASSERT_NE
(
l£ek
(
fd
, 
off£t
, 
SEEK_SET
), -1);

110 
	gbuf2
[1024];

111 
	grc
 = 
»ad
(
fd
, 
buf2
, 
¡¾’
(
kUÁru¡edTe¡Text
è- 
off£t
);

112 
ASSERT_LT
(
rc
, (
buf2
));

113 
EXPECT_EQ
(
rc
, 
¡¾’
(
kUÁru¡edTe¡Text
è- 
off£t
);

114 
	gbuf2
[
rc
] = '\0';

115 
EXPECT_EQ
(
¡rcmp
(
buf2
, 
kUÁru¡edTe¡Text
 + 
off£t
), 0);

117 
EXPECT_EQ
(
fsync
(
fd
), 0);

120 
EXPECT_EQ
(
şo£
(
fd
), 0);

123 
TEST_F
(
R—dWr™eTe¡
, 
R—dWr™eSecu»Te¡
) {

125 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£cu»_key
;

126 
	g£cu»_key
.
»size
(
kKeyL’gth
);

127 
ASSERT_EQ
(
RAND_by‹s
(
£cu»_key
.
d©a
(), secu»_key.
size
()), 1)

130 
key_šfo
 
	gioùl_·¿m
;

131 
	gioùl_·¿m
.
	gËngth
 = 
£cu»_key
.
size
();

132 
	gioùl_·¿m
.
	gd©a
 = 
£cu»_key
.
d©a
();

135 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
 | 
O_SECURE
, 0644);

136 
ASSERT_GE
(
fd
, 0);

138 
EXPECT_EQ
(
ioùl
(
fd
, 
ENCLAVE_STORAGE_SET_KEY
, &
ioùl_·¿m
), 0);

141 
size_t
 
	grc
 = 
wr™e
(
fd
, 
kSecu»Te¡Text
, 
¡¾’
(kSecureTestText));

142 
EXPECT_EQ
(
rc
, 
¡¾’
(
kSecu»Te¡Text
));

145 
EXPECT_EQ
(
şo£
(
fd
), 0);

148 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_RDONLY
 | 
O_SECURE
);

149 
ASSERT_GE
(
fd
, 0);

151 
EXPECT_EQ
(
ioùl
(
fd
, 
ENCLAVE_STORAGE_SET_KEY
, &
ioùl_·¿m
), 0);

154 
	gbuf1
[1024];

155 
	grc
 = 
»ad
(
fd
, 
buf1
, 
¡¾’
(
kSecu»Te¡Text
));

156 
ASSERT_LT
(
rc
, (
buf1
));

157 
EXPECT_EQ
(
rc
, 
¡¾’
(
kSecu»Te¡Text
));

158 
	gbuf1
[
rc
] = '\0';

159 
EXPECT_EQ
(
¡ºcmp
(
buf1
, 
kSecu»Te¡Text
, 
kBlockL’gth
), 0);

162 
ASSERT_NE
(
l£ek
(
fd
, 0, 
SEEK_SET
), -1);

163 
	gbuf2
[1024];

164 
	grc
 = 
»ad
(
fd
, 
buf2
, 
¡¾’
(
kSecu»Te¡Text
));

165 
ASSERT_LT
(
rc
, (
buf2
));

166 
EXPECT_EQ
(
rc
, 
¡¾’
(
kSecu»Te¡Text
));

167 
	gbuf2
[
rc
] = '\0';

168 
EXPECT_EQ
(
¡ºcmp
(
buf2
, 
kSecu»Te¡Text
, 
kBlockL’gth
), 0);

170 
EXPECT_EQ
(
fsync
(
fd
), 0);

173 
EXPECT_EQ
(
şo£
(
fd
), 0);

	@platform/posix/io/read_write_test.cc

19 
	~<fú.h
>

20 
	~<İ’s¦/¿nd.h
>

21 
	~<¡dio.h
>

22 
	~<sys/ioùl.h
>

23 
	~<uni¡d.h
>

24 
	~<¡ršg
>

25 
	~<veùÜ
>

27 
	~<gmock/gmock.h
>

28 
	~<g‹¡/g‹¡.h
>

29 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

30 
	~"asylo/ut/loggšg.h
"

31 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/‹¡/ut/‹¡_æags.h
"

34 
	~"asylo/ut/ş—nsšg_ty³s.h
"

35 
	~"asylo/ut/¡©us.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 
cÚ¡ex´
 
size_t
 
	gkKeyL’gth
 = 32;

41 
cÚ¡ex´
 
size_t
 
	gkBlockL’gth
 = 128;

43 cÚ¡ *
	gkUÁru¡edTe¡Text
 = "Lorem ipsum dolor sit‡met...\n";

44 cÚ¡ *
	gkSecu»Te¡Text
 =

48 şas 
	cR—dWr™eTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

49 
´Ùeùed
:

50 
S‘Up
(è
ov”ride
 {

53 
‹¡_fe_
.
»£t
(
‹m²am
(
FLAGS_‹¡_tmpdœ
.
c_¡r
(), "RWT"));

56 
T—rDown
(è
	gov”ride
 {

57 ià(
	g‹¡_fe_
) {

58 
»move
(
‹¡_fe_
.
g‘
());

62 
	gasylo
::
M®locUniquePŒ
<> 
‹¡_fe_
;

65 
TEST_F
(
R—dWr™eTe¡
, 
FeDesütÜOrd”šgTe¡
) {

66 
	gfd1
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

67 
	gfd2
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

68 
	gfd3
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

71 
EXPECT_EQ
(
fd2
, 
fd1
 + 1);

72 
EXPECT_EQ
(
fd3
, 
fd2
 + 1);

75 
şo£
(
fd1
);

76 
şo£
(
fd2
);

77 
şo£
(
fd3
);

78 
EXPECT_EQ
(
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644), 
fd1
);

79 
EXPECT_EQ
(
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644), 
fd2
);

80 
EXPECT_EQ
(
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644), 
fd3
);

83 
TEST_F
(
R—dWr™eTe¡
, 
R—dWr™eUÁru¡edTe¡
) {

85 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
, 0644);

86 
ASSERT_GE
(
fd
, 0);

89 
size_t
 
	grc
 = 
wr™e
(
fd
, 
kUÁru¡edTe¡Text
, 
¡¾’
(kUntrustedTestText));

90 
EXPECT_EQ
(
rc
, 
¡¾’
(
kUÁru¡edTe¡Text
));

93 
EXPECT_EQ
(
şo£
(
fd
), 0);

96 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_RDONLY
);

97 
ASSERT_GE
(
fd
, 0);

100 
	gbuf1
[1024];

101 
	grc
 = 
»ad
(
fd
, 
buf1
, 
¡¾’
(
kUÁru¡edTe¡Text
));

102 
ASSERT_LT
(
rc
, (
buf1
));

103 
EXPECT_EQ
(
rc
, 
¡¾’
(
kUÁru¡edTe¡Text
));

104 
	gbuf1
[
rc
] = '\0';

105 
EXPECT_EQ
(
¡rcmp
(
buf1
, 
kUÁru¡edTe¡Text
), 0);

108 
off_t
 
	goff£t
 = 10;

109 
ASSERT_NE
(
l£ek
(
fd
, 
off£t
, 
SEEK_SET
), -1);

110 
	gbuf2
[1024];

111 
	grc
 = 
»ad
(
fd
, 
buf2
, 
¡¾’
(
kUÁru¡edTe¡Text
è- 
off£t
);

112 
ASSERT_LT
(
rc
, (
buf2
));

113 
EXPECT_EQ
(
rc
, 
¡¾’
(
kUÁru¡edTe¡Text
è- 
off£t
);

114 
	gbuf2
[
rc
] = '\0';

115 
EXPECT_EQ
(
¡rcmp
(
buf2
, 
kUÁru¡edTe¡Text
 + 
off£t
), 0);

117 
EXPECT_EQ
(
fsync
(
fd
), 0);

120 
EXPECT_EQ
(
şo£
(
fd
), 0);

123 
TEST_F
(
R—dWr™eTe¡
, 
R—dWr™eSecu»Te¡
) {

125 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	g£cu»_key
;

126 
	g£cu»_key
.
»size
(
kKeyL’gth
);

127 
ASSERT_EQ
(
RAND_by‹s
(
£cu»_key
.
d©a
(), secu»_key.
size
()), 1)

130 
key_šfo
 
	gioùl_·¿m
;

131 
	gioùl_·¿m
.
	gËngth
 = 
£cu»_key
.
size
();

132 
	gioùl_·¿m
.
	gd©a
 = 
£cu»_key
.
d©a
();

135 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_CREAT
 | 
O_RDWR
 | 
O_SECURE
, 0644);

136 
ASSERT_GE
(
fd
, 0);

138 
EXPECT_EQ
(
ioùl
(
fd
, 
ENCLAVE_STORAGE_SET_KEY
, &
ioùl_·¿m
), 0);

141 
size_t
 
	grc
 = 
wr™e
(
fd
, 
kSecu»Te¡Text
, 
¡¾’
(kSecureTestText));

142 
EXPECT_EQ
(
rc
, 
¡¾’
(
kSecu»Te¡Text
));

145 
EXPECT_EQ
(
şo£
(
fd
), 0);

148 
	gfd
 = 
İ’
(
‹¡_fe_
.
g‘
(), 
O_RDONLY
 | 
O_SECURE
);

149 
ASSERT_GE
(
fd
, 0);

151 
EXPECT_EQ
(
ioùl
(
fd
, 
ENCLAVE_STORAGE_SET_KEY
, &
ioùl_·¿m
), 0);

154 
	gbuf1
[1024];

155 
	grc
 = 
»ad
(
fd
, 
buf1
, 
¡¾’
(
kSecu»Te¡Text
));

156 
ASSERT_LT
(
rc
, (
buf1
));

157 
EXPECT_EQ
(
rc
, 
¡¾’
(
kSecu»Te¡Text
));

158 
	gbuf1
[
rc
] = '\0';

159 
EXPECT_EQ
(
¡ºcmp
(
buf1
, 
kSecu»Te¡Text
, 
kBlockL’gth
), 0);

162 
ASSERT_NE
(
l£ek
(
fd
, 0, 
SEEK_SET
), -1);

163 
	gbuf2
[1024];

164 
	grc
 = 
»ad
(
fd
, 
buf2
, 
¡¾’
(
kSecu»Te¡Text
));

165 
ASSERT_LT
(
rc
, (
buf2
));

166 
EXPECT_EQ
(
rc
, 
¡¾’
(
kSecu»Te¡Text
));

167 
	gbuf2
[
rc
] = '\0';

168 
EXPECT_EQ
(
¡ºcmp
(
buf2
, 
kSecu»Te¡Text
, 
kBlockL’gth
), 0);

170 
EXPECT_EQ
(
fsync
(
fd
), 0);

173 
EXPECT_EQ
(
şo£
(
fd
), 0);

	@platform/posix/io/realpath_test.cc

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/‹¡/ut/‹¡_æags.h
"

25 
	gÇme¥aû
 {

27 
TEST
(
R—Í©hTe¡
, 
Sim¶eNoBuf
) {

28 *
	g»s_·th
 = 
»®·th
("/tmp", 
nuÎ±r
);

29 
EXPECT_STREQ
(
»s_·th
, "/tmp");

30 
ä“
(
»s_·th
);

33 
TEST
(
R—Í©hTe¡
, 
Sim¶eBuf
) {

34 
	gbuf
[
PATH_MAX
];

35 
EXPECT_EQ
(
»®·th
("/tmp", 
buf
), buf);

36 
EXPECT_STREQ
(
buf
, "/tmp");

39 
TEST
(
R—Í©hTe¡
, 
P¬’tDœ
) {

40 *
	g»s_·th
 = 
»®·th
("/tmp/../u¤/../tmp", 
nuÎ±r
);

41 
EXPECT_STREQ
(
»s_·th
, "/tmp");

42 
ä“
(
»s_·th
);

	@platform/posix/io/realpath_test.cc

18 
	~<¡dlib.h
>

19 
	~<uni¡d.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/‹¡/ut/‹¡_æags.h
"

25 
	gÇme¥aû
 {

27 
TEST
(
R—Í©hTe¡
, 
Sim¶eNoBuf
) {

28 *
	g»s_·th
 = 
»®·th
("/tmp", 
nuÎ±r
);

29 
EXPECT_STREQ
(
»s_·th
, "/tmp");

30 
ä“
(
»s_·th
);

33 
TEST
(
R—Í©hTe¡
, 
Sim¶eBuf
) {

34 
	gbuf
[
PATH_MAX
];

35 
EXPECT_EQ
(
»®·th
("/tmp", 
buf
), buf);

36 
EXPECT_STREQ
(
buf
, "/tmp");

39 
TEST
(
R—Í©hTe¡
, 
P¬’tDœ
) {

40 *
	g»s_·th
 = 
»®·th
("/tmp/../u¤/../tmp", 
nuÎ±r
);

41 
EXPECT_STREQ
(
»s_·th
, "/tmp");

42 
ä“
(
»s_·th
);

	@platform/posix/io/secure_paths.cc

19 
	~"asylo/¶©fÜm/posix/io/£cu»_·ths.h
"

21 
	~<sys/ioùl.h
>

22 
	~<û¼no
>

23 
	~<c¡dšt
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~"asylo/¶©fÜm/üy±o/gcmlib/gcm_üy±Ü.h
"

27 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

28 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

29 
	~"asylo/¶©fÜm/¡Üage/£cu»/’şave_¡Üage_£cu».h
"

31 
usšg
 
	gasylo
::
¶©fÜm
::
üy±o
::
gcmlib
::
kKeyL’gth
;

32 
usšg
 
	gasylo
::
¶©fÜm
::
¡Üage
::
A—dHªdËr
;

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gio
 {

37 
	gIOCÚ‹xtSecu»
::
Clo£
() {

38  
¶©fÜm
::
¡Üage
::
£cu»_şo£
(
ho¡_fd_
);

41 
ssize_t
 
	gIOCÚ‹xtSecu»
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

42  
	g¶©fÜm
::
¡Üage
::
£cu»_»ad
(
ho¡_fd_
, 
buf
, 
couÁ
);

45 
ssize_t
 
	gIOCÚ‹xtSecu»
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

46  
	g¶©fÜm
::
¡Üage
::
£cu»_wr™e
(
ho¡_fd_
, 
buf
, 
couÁ
);

49 
	gIOCÚ‹xtSecu»
::
LS“k
(
off_t
 
off£t
, 
wh’û
) {

50  
	g¶©fÜm
::
¡Üage
::
£cu»_l£ek
(
ho¡_fd_
, 
off£t
, 
wh’û
);

53 
	gIOCÚ‹xtSecu»
::
FSync
(è{  
’c_uÁru¡ed_fsync
(
ho¡_fd_
); }

55 
	gIOCÚ‹xtSecu»
::
FSt
(
¡©
 *
¡
) {

56  
¶©fÜm
::
¡Üage
::
£cu»_f¡©
(
ho¡_fd_
, 
¡
);

59 
	gIOCÚ‹xtSecu»
::
I§‰y
(è{  
’c_uÁru¡ed_i§‰y
(
ho¡_fd_
); }

61 
	gIOCÚ‹xtSecu»
::
Ioùl
(
»que¡
, *
¬gp
) {

62 
	g»que¡
) {

63 
	gENCLAVE_STORAGE_SET_KEY
: {

64 
key_šfo
 *
ioùl_·¿m
 = 
»š‹½»t_ÿ¡
<key_šfØ*>(
¬gp
);

65  
	gA—dHªdËr
::
G‘In¡ªû
().
S‘Ma¡”Key
(

66 
ho¡_fd_
, 
ioùl_·¿m
->
d©a
, ioùl_·¿m->
Ëngth
);

69 
”ºo
 = 
ENOSYS
;

	@platform/posix/io/secure_paths.cc

19 
	~"asylo/¶©fÜm/posix/io/£cu»_·ths.h
"

21 
	~<sys/ioùl.h
>

22 
	~<û¼no
>

23 
	~<c¡dšt
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~"asylo/¶©fÜm/üy±o/gcmlib/gcm_üy±Ü.h
"

27 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

28 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

29 
	~"asylo/¶©fÜm/¡Üage/£cu»/’şave_¡Üage_£cu».h
"

31 
usšg
 
	gasylo
::
¶©fÜm
::
üy±o
::
gcmlib
::
kKeyL’gth
;

32 
usšg
 
	gasylo
::
¶©fÜm
::
¡Üage
::
A—dHªdËr
;

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	gio
 {

37 
	gIOCÚ‹xtSecu»
::
Clo£
() {

38  
¶©fÜm
::
¡Üage
::
£cu»_şo£
(
ho¡_fd_
);

41 
ssize_t
 
	gIOCÚ‹xtSecu»
::
R—d
(*
buf
, 
size_t
 
couÁ
) {

42  
	g¶©fÜm
::
¡Üage
::
£cu»_»ad
(
ho¡_fd_
, 
buf
, 
couÁ
);

45 
ssize_t
 
	gIOCÚ‹xtSecu»
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
) {

46  
	g¶©fÜm
::
¡Üage
::
£cu»_wr™e
(
ho¡_fd_
, 
buf
, 
couÁ
);

49 
	gIOCÚ‹xtSecu»
::
LS“k
(
off_t
 
off£t
, 
wh’û
) {

50  
	g¶©fÜm
::
¡Üage
::
£cu»_l£ek
(
ho¡_fd_
, 
off£t
, 
wh’û
);

53 
	gIOCÚ‹xtSecu»
::
FSync
(è{  
’c_uÁru¡ed_fsync
(
ho¡_fd_
); }

55 
	gIOCÚ‹xtSecu»
::
FSt
(
¡©
 *
¡
) {

56  
¶©fÜm
::
¡Üage
::
£cu»_f¡©
(
ho¡_fd_
, 
¡
);

59 
	gIOCÚ‹xtSecu»
::
I§‰y
(è{  
’c_uÁru¡ed_i§‰y
(
ho¡_fd_
); }

61 
	gIOCÚ‹xtSecu»
::
Ioùl
(
»que¡
, *
¬gp
) {

62 
	g»que¡
) {

63 
	gENCLAVE_STORAGE_SET_KEY
: {

64 
key_šfo
 *
ioùl_·¿m
 = 
»š‹½»t_ÿ¡
<key_šfØ*>(
¬gp
);

65  
	gA—dHªdËr
::
G‘In¡ªû
().
S‘Ma¡”Key
(

66 
ho¡_fd_
, 
ioùl_·¿m
->
d©a
, ioùl_·¿m->
Ëngth
);

69 
”ºo
 = 
ENOSYS
;

	@platform/posix/io/secure_paths.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_SECURE_PATHS_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_SECURE_PATHS_H_


	)

22 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gio
 {

28 şas 
	cIOCÚ‹xtSecu»
 : 
public
 
IOMªag”
::
IOCÚ‹xt
 {

29 
public
:

31 
¡d
::
unique_±r
<
IOMªag”
::
IOCÚ‹xt
> 
C»©e
(cÚ¡ *
·th
,

32 
æags
, 
mode_t
 
mode
) {

33 
	gho¡_fd
 = 
¶©fÜm
::
¡Üage
::
£cu»_İ’
(
·th
, 
æags
, 
mode
);

34 ià(
	gho¡_fd
 == -1) {

35  
nuÎ±r
;

37  
	g¡d
::
unique_±r
<
IOMªag”
::
IOCÚ‹xt
>(
Ãw
 
IOCÚ‹xtSecu»
(
ho¡_fd
));

40 
	g´Ùeùed
:

41 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
è
	gov”ride
;

42 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
è
	gov”ride
;

43 
Clo£
(è
	gov”ride
;

44 
LS“k
(
off_t
 
off£t
, 
wh’û
è
	gov”ride
;

45 
FSync
(è
	gov”ride
;

46 
FSt
(
¡©
 *
¡
è
	gov”ride
;

47 
I§‰y
(è
	gov”ride
;

48 
Ioùl
(
»que¡
, *
¬gp
è
	gov”ride
;

50 
	g´iv©e
:

51 
ex¶ic™
 
IOCÚ‹xtSecu»
(
ho¡_fd
è: 
ho¡_fd_
(host_fd) {}

54 
ho¡_fd_
;

	@platform/posix/io/util.cc

19 
	~"asylo/¶©fÜm/posix/io/ut.h
"

21 
	~<veùÜ
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"ab¦/¡ršgs/¡r_još.h
"

25 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gio
 {

29 
Çme¥aû
 
	gut
 {

31 
	g¡d
::
¡ršg
 
NÜm®izeP©h
(
ab¦
::
¡ršg_v›w
 
·th
) {

33 
¡d
::
veùÜ
<
ab¦
::
¡ršg_v›w
> 
dœeùÜ›s
;

36 
size_t
 
	gcu¼’t_dœeùÜy
 = 0;

37 
	gcu¼’t_dœeùÜy
 < 
	g·th
.
size
()) {

39 
size_t
 
	gÃxt_dœeùÜy
 = 
·th
.
fšd_fœ¡_of
('/', 
cu¼’t_dœeùÜy
);

40 ià(
	gÃxt_dœeùÜy
 =ğ
¡d
::
¡ršg
::
Åos
è
Ãxt_dœeùÜy
 = 
·th
.
size
();

41 
	gab¦
::
¡ršg_v›w
 
Çme
 =

42 
·th
.
sub¡r
(
cu¼’t_dœeùÜy
, 
Ãxt_dœeùÜy
 - current_directory);

45 
	gcu¼’t_dœeùÜy
 = 
Ãxt_dœeùÜy
 + 1;

48 ià(
	gÇme
.
em±y
() ||‚ame == ".") ;

51 ià(
	gÇme
 == "..") {

53 ià(!
dœeùÜ›s
.
em±y
()èdœeùÜ›s.
pİ_back
();

58 
	gdœeùÜ›s
.
push_back
(
Çme
);

61  
	gab¦
::
SŒC©
("/", 
ab¦
::
SŒJoš
(
dœeùÜ›s
, "/"));

	@platform/posix/io/util.cc

19 
	~"asylo/¶©fÜm/posix/io/ut.h
"

21 
	~<veùÜ
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"ab¦/¡ršgs/¡r_još.h
"

25 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gio
 {

29 
Çme¥aû
 
	gut
 {

31 
	g¡d
::
¡ršg
 
NÜm®izeP©h
(
ab¦
::
¡ršg_v›w
 
·th
) {

33 
¡d
::
veùÜ
<
ab¦
::
¡ršg_v›w
> 
dœeùÜ›s
;

36 
size_t
 
	gcu¼’t_dœeùÜy
 = 0;

37 
	gcu¼’t_dœeùÜy
 < 
	g·th
.
size
()) {

39 
size_t
 
	gÃxt_dœeùÜy
 = 
·th
.
fšd_fœ¡_of
('/', 
cu¼’t_dœeùÜy
);

40 ià(
	gÃxt_dœeùÜy
 =ğ
¡d
::
¡ršg
::
Åos
è
Ãxt_dœeùÜy
 = 
·th
.
size
();

41 
	gab¦
::
¡ršg_v›w
 
Çme
 =

42 
·th
.
sub¡r
(
cu¼’t_dœeùÜy
, 
Ãxt_dœeùÜy
 - current_directory);

45 
	gcu¼’t_dœeùÜy
 = 
Ãxt_dœeùÜy
 + 1;

48 ià(
	gÇme
.
em±y
() ||‚ame == ".") ;

51 ià(
	gÇme
 == "..") {

53 ià(!
dœeùÜ›s
.
em±y
()èdœeùÜ›s.
pİ_back
();

58 
	gdœeùÜ›s
.
push_back
(
Çme
);

61  
	gab¦
::
SŒC©
("/", 
ab¦
::
SŒJoš
(
dœeùÜ›s
, "/"));

	@platform/posix/io/util.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_IO_UTIL_H_


20 
	#ASYLO_PLATFORM_POSIX_IO_UTIL_H_


	)

22 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gio
 {

26 
Çme¥aû
 
	gut
 {

28 
	g¡d
::
¡ršg
 
NÜm®izeP©h
(
ab¦
::
¡ršg_v›w
 
·th
);

	@platform/posix/io/virtual_test.cc

19 
	~<fú.h
>

20 
	~<¡dio.h
>

21 
	~<uni¡d.h
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/¡©us.h
"

32 
	~"asylo/ut/¡©usÜ.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 şas 
	cVœtu®HªdËrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
public
:

41 
Regi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th
,

42 cÚ¡ 
¡d
::
¡ršg
 &
Ïb–
) {

43 
io
::
IOMªag”
 &
mgr
 = io::IOMªag”::
G‘In¡ªû
();

44 
	gmgr
.
Regi¡”Vœtu®P©hHªdËr
(
·th
,

45 ::
ab¦
::
make_unique
<
Te¡HªdËr
>(
Ïb–
));

48 
D”egi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

49 
io
::
IOMªag”
 &
mgr
 = io::IOMªag”::
G‘In¡ªû
();

50 
	gmgr
.
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

53 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—d
(cÚ¡ 
¡d
::¡ršg &
·th
) {

54 
fd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDONLY
);

55 ià(
	gfd
 < 0) {

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

57 
ab¦
::
SŒC©
("E¼Ü: CªnÙ o³À", 
·th
));

60 
	gbuf
[128] = {};

61 
	gcouÁ
 = 
»ad
(
fd
, 
buf
, (buf));

62 ià(
	gcouÁ
 < 0) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Cannot„ead…ath");

65 
	gbuf
[(
buf
) - 1] = '\0';

66 
şo£
(
fd
);

67  
	g¡d
::
¡ršg
(
buf
);

70 
	g´iv©e
:

71 şas 
	cTe¡CÚ‹xt
 : 
public
 
io
::
IOMªag”
::
IOCÚ‹xt
 {

72 
public
:

73 
Te¡CÚ‹xt
(
¡d
::
¡ršg
 
Ïb–
è: 
Ïb–_
(label) {}

74 
vœtu®
 ~
Te¡CÚ‹xt
() = ;

77 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
è
	gov”ride
 {

78 *
	gd©a
 = 
»š‹½»t_ÿ¡
<*>(
buf
);

79 
size_t
 
	g»t
 = 
Ïb–_
.
cİy
(
d©a
, 
couÁ
 - 1);

80 
	gd©a
[
»t
] = '\0';

81  
	g»t
 + 1;

85 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
è
	gov”ride
 {  -1; }

88 
Clo£
(è
	gov”ride
 {  0; }

90 
	g´iv©e
:

91 
¡d
::
¡ršg
 
Ïb–_
;

94 şas 
	cTe¡HªdËr
 : 
public
 
io
::
IOMªag”
::
Vœtu®P©hHªdËr
 {

95 
public
:

96 
Te¡HªdËr
(
¡d
::
¡ršg
 
Ïb–
è: 
Ïb–_
(label) {}

97 
vœtu®
 ~
Te¡HªdËr
() = ;

99 
	g¡d
::
unique_±r
<
io
::
IOMªag”
::
IOCÚ‹xt
> 
O³n
(cÚ¡ *
·th
, 
æags
,

100 
mode_t
 
mode
è
	gov”ride
 {

101  ::
ab¦
::
make_unique
<
Te¡CÚ‹xt
>(
Ïb–_
);

104 
	g´iv©e
:

105 
¡d
::
¡ršg
 
Ïb–_
;

109 
TEST_F
(
Vœtu®HªdËrTe¡
, 
BasicFeM©ch
) {

110 cÚ¡ 
	g¡d
::
¡ršg
 
·th
 = "/test/foo/bar";

111 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–
 = "BasicFileMatch";

114 
Regi¡”Vœtu®P©hHªdËr
(
·th
, 
Ïb–
);

117 
EXPECT_THAT
(
R—d
(
·th
), 
IsOkAndHŞds
(
Ïb–
));

120 
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

123 
TEST_F
(
Vœtu®HªdËrTe¡
, 
BasicP»fixM©ch
) {

124 cÚ¡ 
	g¡d
::
¡ršg
 
·th
 = "/test/foo/baz";

125 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–
 = "BasicPrefixMatch";

128 
Regi¡”Vœtu®P©hHªdËr
(
·th
, 
Ïb–
);

131 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th
, "/qux")), 
IsOkAndHŞds
(
Ïb–
));

134 
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

137 
TEST_F
(
Vœtu®HªdËrTe¡
, 
P¬tŸlFeM©ch
) {

138 cÚ¡ 
	g¡d
::
¡ršg
 
·th
 = "/test/foo/qu";

139 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–
 = "PartialFileMatch";

142 
Regi¡”Vœtu®P©hHªdËr
(
·th
, 
Ïb–
);

145 autØ
	g»suÉ_Ü_”rÜ
 = 
R—d
(
·th
 + "x");

146 
ASSERT_THAT
(
»suÉ_Ü_”rÜ
, 
NÙ
(
IsOk
()));

147 
EXPECT_THAT
(
»suÉ_Ü_”rÜ
.
¡©us
(),

148 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

152 
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

155 
TEST_F
(
Vœtu®HªdËrTe¡
, 
Ov”ÏµšgP»fixM©chFœ¡
) {

156 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test/foo/qu";

157 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/foo/qux";

158 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "OverlappingPrefixMatchFirst1";

159 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "OverlappingPrefixMatchFirst2";

162 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

163 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

166 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th1
, "/b¬")), 
IsOkAndHŞds
(
Ïb–1
));

169 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

170 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

173 
TEST_F
(
Vœtu®HªdËrTe¡
, 
Ov”ÏµšgP»fixM©chSecÚd
) {

174 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test/foo/qu";

175 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/foo/qux";

176 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "OverlappingPrefixMatchSecond1";

177 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "OverlappingPrefixMatchSecond2";

180 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

181 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

184 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th2
, "/b¬")), 
IsOkAndHŞds
(
Ïb–2
));

187 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

188 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

191 
TEST_F
(
Vœtu®HªdËrTe¡
, 
NoM©ch
) {

192 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test/dummy";

193 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/dummydir";

194 cÚ¡ 
	g¡d
::
¡ršg
 
·th3
 = "/test/another/dummy";

195 cÚ¡ 
	g¡d
::
¡ršg
 
·th4
 = "/test/another/dummydir";

197 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "NoMatch1";

198 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "NoMatch2";

199 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–3
 = "NoMatch3";

200 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–4
 = "NoMatch4";

203 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

204 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

205 
Regi¡”Vœtu®P©hHªdËr
(
·th3
, 
Ïb–3
);

206 
Regi¡”Vœtu®P©hHªdËr
(
·th4
, 
Ïb–4
);

209 
ASSERT_THAT
(
R—d
("/‹¡/bÏnk"), 
NÙ
(
IsOk
()));

212 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

213 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

214 
D”egi¡”Vœtu®P©hHªdËr
(
·th3
);

215 
D”egi¡”Vœtu®P©hHªdËr
(
·th4
);

218 
TEST_F
(
Vœtu®HªdËrTe¡
, 
SiblšgM©ch
) {

219 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test";

220 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/dummy";

222 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "Sibling1";

223 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "Sibling2";

226 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

227 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

230 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th1
, "/exam¶e")), 
IsOkAndHŞds
(
Ïb–1
));

233 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

234 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

	@platform/posix/io/virtual_test.cc

19 
	~<fú.h
>

20 
	~<¡dio.h
>

21 
	~<uni¡d.h
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/¡©us.h
"

32 
	~"asylo/ut/¡©usÜ.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 şas 
	cVœtu®HªdËrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
public
:

41 
Regi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th
,

42 cÚ¡ 
¡d
::
¡ršg
 &
Ïb–
) {

43 
io
::
IOMªag”
 &
mgr
 = io::IOMªag”::
G‘In¡ªû
();

44 
	gmgr
.
Regi¡”Vœtu®P©hHªdËr
(
·th
,

45 ::
ab¦
::
make_unique
<
Te¡HªdËr
>(
Ïb–
));

48 
D”egi¡”Vœtu®P©hHªdËr
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

49 
io
::
IOMªag”
 &
mgr
 = io::IOMªag”::
G‘In¡ªû
();

50 
	gmgr
.
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

53 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—d
(cÚ¡ 
¡d
::¡ršg &
·th
) {

54 
fd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDONLY
);

55 ià(
	gfd
 < 0) {

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

57 
ab¦
::
SŒC©
("E¼Ü: CªnÙ o³À", 
·th
));

60 
	gbuf
[128] = {};

61 
	gcouÁ
 = 
»ad
(
fd
, 
buf
, (buf));

62 ià(
	gcouÁ
 < 0) {

63  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Cannot„ead…ath");

65 
	gbuf
[(
buf
) - 1] = '\0';

66 
şo£
(
fd
);

67  
	g¡d
::
¡ršg
(
buf
);

70 
	g´iv©e
:

71 şas 
	cTe¡CÚ‹xt
 : 
public
 
io
::
IOMªag”
::
IOCÚ‹xt
 {

72 
public
:

73 
Te¡CÚ‹xt
(
¡d
::
¡ršg
 
Ïb–
è: 
Ïb–_
(label) {}

74 
vœtu®
 ~
Te¡CÚ‹xt
() = ;

77 
ssize_t
 
R—d
(*
buf
, 
size_t
 
couÁ
è
	gov”ride
 {

78 *
	gd©a
 = 
»š‹½»t_ÿ¡
<*>(
buf
);

79 
size_t
 
	g»t
 = 
Ïb–_
.
cİy
(
d©a
, 
couÁ
 - 1);

80 
	gd©a
[
»t
] = '\0';

81  
	g»t
 + 1;

85 
ssize_t
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
couÁ
è
	gov”ride
 {  -1; }

88 
Clo£
(è
	gov”ride
 {  0; }

90 
	g´iv©e
:

91 
¡d
::
¡ršg
 
Ïb–_
;

94 şas 
	cTe¡HªdËr
 : 
public
 
io
::
IOMªag”
::
Vœtu®P©hHªdËr
 {

95 
public
:

96 
Te¡HªdËr
(
¡d
::
¡ršg
 
Ïb–
è: 
Ïb–_
(label) {}

97 
vœtu®
 ~
Te¡HªdËr
() = ;

99 
	g¡d
::
unique_±r
<
io
::
IOMªag”
::
IOCÚ‹xt
> 
O³n
(cÚ¡ *
·th
, 
æags
,

100 
mode_t
 
mode
è
	gov”ride
 {

101  ::
ab¦
::
make_unique
<
Te¡CÚ‹xt
>(
Ïb–_
);

104 
	g´iv©e
:

105 
¡d
::
¡ršg
 
Ïb–_
;

109 
TEST_F
(
Vœtu®HªdËrTe¡
, 
BasicFeM©ch
) {

110 cÚ¡ 
	g¡d
::
¡ršg
 
·th
 = "/test/foo/bar";

111 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–
 = "BasicFileMatch";

114 
Regi¡”Vœtu®P©hHªdËr
(
·th
, 
Ïb–
);

117 
EXPECT_THAT
(
R—d
(
·th
), 
IsOkAndHŞds
(
Ïb–
));

120 
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

123 
TEST_F
(
Vœtu®HªdËrTe¡
, 
BasicP»fixM©ch
) {

124 cÚ¡ 
	g¡d
::
¡ršg
 
·th
 = "/test/foo/baz";

125 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–
 = "BasicPrefixMatch";

128 
Regi¡”Vœtu®P©hHªdËr
(
·th
, 
Ïb–
);

131 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th
, "/qux")), 
IsOkAndHŞds
(
Ïb–
));

134 
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

137 
TEST_F
(
Vœtu®HªdËrTe¡
, 
P¬tŸlFeM©ch
) {

138 cÚ¡ 
	g¡d
::
¡ršg
 
·th
 = "/test/foo/qu";

139 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–
 = "PartialFileMatch";

142 
Regi¡”Vœtu®P©hHªdËr
(
·th
, 
Ïb–
);

145 autØ
	g»suÉ_Ü_”rÜ
 = 
R—d
(
·th
 + "x");

146 
ASSERT_THAT
(
»suÉ_Ü_”rÜ
, 
NÙ
(
IsOk
()));

147 
EXPECT_THAT
(
»suÉ_Ü_”rÜ
.
¡©us
(),

148 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

152 
D”egi¡”Vœtu®P©hHªdËr
(
·th
);

155 
TEST_F
(
Vœtu®HªdËrTe¡
, 
Ov”ÏµšgP»fixM©chFœ¡
) {

156 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test/foo/qu";

157 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/foo/qux";

158 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "OverlappingPrefixMatchFirst1";

159 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "OverlappingPrefixMatchFirst2";

162 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

163 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

166 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th1
, "/b¬")), 
IsOkAndHŞds
(
Ïb–1
));

169 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

170 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

173 
TEST_F
(
Vœtu®HªdËrTe¡
, 
Ov”ÏµšgP»fixM©chSecÚd
) {

174 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test/foo/qu";

175 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/foo/qux";

176 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "OverlappingPrefixMatchSecond1";

177 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "OverlappingPrefixMatchSecond2";

180 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

181 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

184 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th2
, "/b¬")), 
IsOkAndHŞds
(
Ïb–2
));

187 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

188 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

191 
TEST_F
(
Vœtu®HªdËrTe¡
, 
NoM©ch
) {

192 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test/dummy";

193 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/dummydir";

194 cÚ¡ 
	g¡d
::
¡ršg
 
·th3
 = "/test/another/dummy";

195 cÚ¡ 
	g¡d
::
¡ršg
 
·th4
 = "/test/another/dummydir";

197 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "NoMatch1";

198 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "NoMatch2";

199 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–3
 = "NoMatch3";

200 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–4
 = "NoMatch4";

203 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

204 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

205 
Regi¡”Vœtu®P©hHªdËr
(
·th3
, 
Ïb–3
);

206 
Regi¡”Vœtu®P©hHªdËr
(
·th4
, 
Ïb–4
);

209 
ASSERT_THAT
(
R—d
("/‹¡/bÏnk"), 
NÙ
(
IsOk
()));

212 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

213 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

214 
D”egi¡”Vœtu®P©hHªdËr
(
·th3
);

215 
D”egi¡”Vœtu®P©hHªdËr
(
·th4
);

218 
TEST_F
(
Vœtu®HªdËrTe¡
, 
SiblšgM©ch
) {

219 cÚ¡ 
	g¡d
::
¡ršg
 
·th1
 = "/test";

220 cÚ¡ 
	g¡d
::
¡ršg
 
·th2
 = "/test/dummy";

222 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–1
 = "Sibling1";

223 cÚ¡ 
	g¡d
::
¡ršg
 
Ïb–2
 = "Sibling2";

226 
Regi¡”Vœtu®P©hHªdËr
(
·th1
, 
Ïb–1
);

227 
Regi¡”Vœtu®P©hHªdËr
(
·th2
, 
Ïb–2
);

230 
EXPECT_THAT
(
R—d
(
ab¦
::
SŒC©
(
·th1
, "/exam¶e")), 
IsOkAndHŞds
(
Ïb–1
));

233 
D”egi¡”Vœtu®P©hHªdËr
(
·th1
);

234 
D”egi¡”Vœtu®P©hHªdËr
(
·th2
);

	@platform/posix/ioctl.cc

19 
	~"asylo/¶©fÜm/posix/šşude/sys/ioùl.h
"

21 
	~<¡d¬g.h
>

23 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

27 
ioùl
(
fd
, 
»que¡
, ...) {

28 
va_li¡
 
­
;

29 
va_¡¬t
(
­
, 
»que¡
);

30 *
¬gp
 = 
va_¬g
(
­
, *);

31 
»suÉ
 = 
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
Ioùl
(
fd
, 
»que¡
, 
¬gp
);

32 
va_’d
(
­
);

33  
»suÉ
;

	@platform/posix/ioctl.cc

19 
	~"asylo/¶©fÜm/posix/šşude/sys/ioùl.h
"

21 
	~<¡d¬g.h
>

23 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

27 
ioùl
(
fd
, 
»que¡
, ...) {

28 
va_li¡
 
­
;

29 
va_¡¬t
(
­
, 
»que¡
);

30 *
¬gp
 = 
va_¬g
(
­
, *);

31 
»suÉ
 = 
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
Ioùl
(
fd
, 
»que¡
, 
¬gp
);

32 
va_’d
(
­
);

33  
»suÉ
;

	@platform/posix/malloc_lock.cc

19 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

29 
	#CACHE_ALIGNED
 
	`__©Œibu‹__
((
	`®igÃd
(64)))

	)

34 vŞ©
ušt64_t
 
lock_owÃr
 
	gCACHE_ALIGNED
 = 
kInv®idTh»ad
;

40 
lock_couÁ
 
	gCACHE_ALIGNED
 = 0;

44 
__m®loc_lock
(
»’t
 *) {

45 cÚ¡ 
ušt64_t
 
£lf
 = 
’c_th»ad_£lf
();

47 
lock_owÃr
 !ğ
£lf
) {

48 
ušt64_t
 
´ev
 = 0;

54 ià(
__©omic_com·»_exchªge_n
(&
lock_owÃr
,

55  &
´ev
,

56  
£lf
,

57  
çl£
,

58  
__ATOMIC_SEQ_CST
,

59  
__ATOMIC_SEQ_CST
) !=

60 
kInv®idTh»ad
) {

66 
lock_owÃr
 !ğ
kInv®idTh»ad
) {

68 
’c_·u£
();

72 
lock_couÁ
++;

75 
__m®loc_uÆock
(
»’t
 *) {

78 ià(
lock_owÃr
 !ğ
’c_th»ad_£lf
()) {

79 
abÜt
();

82 
lock_couÁ
--;

83 ià(
lock_couÁ
 == 0) {

86 
__©omic_¡Üe_n
(&
lock_owÃr
, 
kInv®idTh»ad
, 
__ATOMIC_RELEASE
);

	@platform/posix/malloc_lock.cc

19 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

29 
	#CACHE_ALIGNED
 
	`__©Œibu‹__
((
	`®igÃd
(64)))

	)

34 vŞ©
ušt64_t
 
lock_owÃr
 
	gCACHE_ALIGNED
 = 
kInv®idTh»ad
;

40 
lock_couÁ
 
	gCACHE_ALIGNED
 = 0;

44 
__m®loc_lock
(
»’t
 *) {

45 cÚ¡ 
ušt64_t
 
£lf
 = 
’c_th»ad_£lf
();

47 
lock_owÃr
 !ğ
£lf
) {

48 
ušt64_t
 
´ev
 = 0;

54 ià(
__©omic_com·»_exchªge_n
(&
lock_owÃr
,

55  &
´ev
,

56  
£lf
,

57  
çl£
,

58  
__ATOMIC_SEQ_CST
,

59  
__ATOMIC_SEQ_CST
) !=

60 
kInv®idTh»ad
) {

66 
lock_owÃr
 !ğ
kInv®idTh»ad
) {

68 
’c_·u£
();

72 
lock_couÁ
++;

75 
__m®loc_uÆock
(
»’t
 *) {

78 ià(
lock_owÃr
 !ğ
’c_th»ad_£lf
()) {

79 
abÜt
();

82 
lock_couÁ
--;

83 ià(
lock_couÁ
 == 0) {

86 
__©omic_¡Üe_n
(&
lock_owÃr
, 
kInv®idTh»ad
, 
__ATOMIC_RELEASE
);

	@platform/posix/memory/heap_switch_test.cc

19 
	~<¡dlib.h
>

21 
	~<c¡ddef
>

22 
	~<memÜy
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/¶©fÜm/posix/memÜy/memÜy.h
"

28 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
boŞ
 
IsAdd»ssInRªge
(*
addr
, *
ba£
, 
size_t
 
size
) {

34 ià(!
	gaddr
) {

35  
	gçl£
;

37 
size_t
 
	g¡¬t
 = 
»š‹½»t_ÿ¡
<size_t>(
ba£
);

38 
size_t
 
	g’d
 = 
¡¬t
 + 
size
;

39 
size_t
 
	grg‘
 = 
»š‹½»t_ÿ¡
<size_t>(
addr
);

40  
	grg‘
 >ğ
¡¬t
 && 
rg‘
 < 
’d
;

43 
TEST
(
H—pSw™chTe¡
, 
H—pSw™ch
) {

44 
EnşaveMemÜyLayout
 
	g’şave_memÜy_Ïyout
;

45 
’c_g‘_memÜy_Ïyout
(&
’şave_memÜy_Ïyout
);

48 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p_befÜe_sw™ch
 =

49 
ab¦
::
make_unique
<>(0);

50 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p_befÜe_sw™ch
.
g‘
(),

51 
’şave_memÜy_Ïyout
.
h—p_ba£
,

52 
’şave_memÜy_Ïyout
.
h—p_size
));

56 
	gsw™ched_h—p
[16];

57 
h—p_sw™ch
(
sw™ched_h—p
, (switched_heap));

59 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p
 = 
ab¦
::
make_unique
<>(0);

60 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p
.
g‘
(), 
sw™ched_h—p
,

61 (
sw™ched_h—p
)));

66 
h—p_sw™ch
(
nuÎ±r
, 0);

67 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p_aá”_sw™ch
 =

68 
ab¦
::
make_unique
<>(0);

69 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p_aá”_sw™ch
.
g‘
(),

70 
’şave_memÜy_Ïyout
.
h—p_ba£
,

71 
’şave_memÜy_Ïyout
.
h—p_size
));

74 
TEST
(
H—pSw™chTe¡
, 
MemÜyAlignm’t
) {

75 
	gsw™ched_h—p
[64];

76 
size_t
 
	g®ign
 = 
®ignof
(
¡d
::
max_®ign_t
);

77 
h—p_sw™ch
(
sw™ched_h—p
, (switched_heap));

81 
	g¡d
::
unique_±r
<
ušt8_t
> 
fœ¡_poš‹r_Ú_sw™ched_h—p
 =

82 
ab¦
::
make_unique
<
ušt8_t
>(0);

83 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
fœ¡_poš‹r_Ú_sw™ched_h—p
.
g‘
(),

84 
sw™ched_h—p
, (switched_heap)));

85 
EXPECT_EQ
(

86 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
fœ¡_poš‹r_Ú_sw™ched_h—p
.
g‘
()) %

87 
®ign
,

92 
	g¡d
::
unique_±r
<
ušt8_t
> 
£cÚd_poš‹r_Ú_sw™ched_h—p
 =

93 
ab¦
::
make_unique
<
ušt8_t
>(0);

94 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
£cÚd_poš‹r_Ú_sw™ched_h—p
.
g‘
(),

95 
sw™ched_h—p
, (switched_heap)));

96 
EXPECT_EQ
(

97 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
£cÚd_poš‹r_Ú_sw™ched_h—p
.
g‘
()) %

98 
®ign
,

104 
	gshiá
 = 29;

105 
h—p_sw™ch
(
sw™ched_h—p
 + 
shiá
, (switched_heap) - shift);

107 
	g¡d
::
unique_±r
<
ušt8_t
> 
poš‹r_Ú_shiáed_sw™ched_h—p
 =

108 
ab¦
::
make_unique
<
ušt8_t
>(0);

109 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
poš‹r_Ú_shiáed_sw™ched_h—p
.
g‘
(),

110 
sw™ched_h—p
 + 
shiá
,

111 (
sw™ched_h—p
è- 
shiá
));

112 
EXPECT_EQ
(

113 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
poš‹r_Ú_shiáed_sw™ched_h—p
.
g‘
()) %

114 
®ign
,

117 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

	@platform/posix/memory/heap_switch_test.cc

19 
	~<¡dlib.h
>

21 
	~<c¡ddef
>

22 
	~<memÜy
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/¶©fÜm/posix/memÜy/memÜy.h
"

28 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
boŞ
 
IsAdd»ssInRªge
(*
addr
, *
ba£
, 
size_t
 
size
) {

34 ià(!
	gaddr
) {

35  
	gçl£
;

37 
size_t
 
	g¡¬t
 = 
»š‹½»t_ÿ¡
<size_t>(
ba£
);

38 
size_t
 
	g’d
 = 
¡¬t
 + 
size
;

39 
size_t
 
	grg‘
 = 
»š‹½»t_ÿ¡
<size_t>(
addr
);

40  
	grg‘
 >ğ
¡¬t
 && 
rg‘
 < 
’d
;

43 
TEST
(
H—pSw™chTe¡
, 
H—pSw™ch
) {

44 
EnşaveMemÜyLayout
 
	g’şave_memÜy_Ïyout
;

45 
’c_g‘_memÜy_Ïyout
(&
’şave_memÜy_Ïyout
);

48 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p_befÜe_sw™ch
 =

49 
ab¦
::
make_unique
<>(0);

50 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p_befÜe_sw™ch
.
g‘
(),

51 
’şave_memÜy_Ïyout
.
h—p_ba£
,

52 
’şave_memÜy_Ïyout
.
h—p_size
));

56 
	gsw™ched_h—p
[16];

57 
h—p_sw™ch
(
sw™ched_h—p
, (switched_heap));

59 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p
 = 
ab¦
::
make_unique
<>(0);

60 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p
.
g‘
(), 
sw™ched_h—p
,

61 (
sw™ched_h—p
)));

66 
h—p_sw™ch
(
nuÎ±r
, 0);

67 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p_aá”_sw™ch
 =

68 
ab¦
::
make_unique
<>(0);

69 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p_aá”_sw™ch
.
g‘
(),

70 
’şave_memÜy_Ïyout
.
h—p_ba£
,

71 
’şave_memÜy_Ïyout
.
h—p_size
));

74 
TEST
(
H—pSw™chTe¡
, 
MemÜyAlignm’t
) {

75 
	gsw™ched_h—p
[64];

76 
size_t
 
	g®ign
 = 
®ignof
(
¡d
::
max_®ign_t
);

77 
h—p_sw™ch
(
sw™ched_h—p
, (switched_heap));

81 
	g¡d
::
unique_±r
<
ušt8_t
> 
fœ¡_poš‹r_Ú_sw™ched_h—p
 =

82 
ab¦
::
make_unique
<
ušt8_t
>(0);

83 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
fœ¡_poš‹r_Ú_sw™ched_h—p
.
g‘
(),

84 
sw™ched_h—p
, (switched_heap)));

85 
EXPECT_EQ
(

86 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
fœ¡_poš‹r_Ú_sw™ched_h—p
.
g‘
()) %

87 
®ign
,

92 
	g¡d
::
unique_±r
<
ušt8_t
> 
£cÚd_poš‹r_Ú_sw™ched_h—p
 =

93 
ab¦
::
make_unique
<
ušt8_t
>(0);

94 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
£cÚd_poš‹r_Ú_sw™ched_h—p
.
g‘
(),

95 
sw™ched_h—p
, (switched_heap)));

96 
EXPECT_EQ
(

97 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
£cÚd_poš‹r_Ú_sw™ched_h—p
.
g‘
()) %

98 
®ign
,

104 
	gshiá
 = 29;

105 
h—p_sw™ch
(
sw™ched_h—p
 + 
shiá
, (switched_heap) - shift);

107 
	g¡d
::
unique_±r
<
ušt8_t
> 
poš‹r_Ú_shiáed_sw™ched_h—p
 =

108 
ab¦
::
make_unique
<
ušt8_t
>(0);

109 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
poš‹r_Ú_shiáed_sw™ched_h—p
.
g‘
(),

110 
sw™ched_h—p
 + 
shiá
,

111 (
sw™ched_h—p
è- 
shiá
));

112 
EXPECT_EQ
(

113 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
poš‹r_Ú_shiáed_sw™ched_h—p
.
g‘
()) %

114 
®ign
,

117 
h—p_sw™ch
Ğ
nuÎ±r
, 0);

	@platform/posix/memory/memory.cc

19 
	~"asylo/¶©fÜm/posix/memÜy/memÜy.h
"

21 
	~<m®loc.h
>

22 
	~<¡dšt.h
>

23 
	~<¡dlib.h
>

25 
	~<c¡ddef
>

27 
	gÇme¥aû
 {

32 
ušt8_t
 *
	gsw™ched_h—p_Ãxt
 = 
nuÎ±r
;

38 
size_t
 
	gsw™ched_h—p_»maššg
 = 0;

44 *
AÎoÿ‹MemÜyOnSw™chedH—p
(
size_t
 
size
, *
poŞ
) {

46 
size_t
 
	g®ign
 = 
®ignof
(
¡d
::
max_®ign_t
);

47 
	gshiá
 =

48 (
®ign
 - (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
sw™ched_h—p_Ãxt
) %‡lign)) %

49 
®ign
;

51 
	gsize
 +ğ
shiá
;

52 ià(!
	gsw™ched_h—p_Ãxt
 || 
	gsw™ched_h—p_»maššg
 < 
	gsize
) {

53  
	gnuÎ±r
;

56 *
	g»t
 = 
sw™ched_h—p_Ãxt
 + 
shiá
;

57 
	gsw™ched_h—p_Ãxt
 +ğ
size
;

58 
	gsw™ched_h—p_»maššg
 -ğ
size
;

60  
	g»t
;

63 *
M®locHook
(
size_t
 
size
, *
poŞ
) {

64  
AÎoÿ‹MemÜyOnSw™chedH—p
(
size
, 
poŞ
);

69 *
R—ÎocHook
(*
±r
, 
size_t
 
size
, *
poŞ
) {

70  
AÎoÿ‹MemÜyOnSw™chedH—p
(
size
, 
poŞ
);

75 
F»eHook
(*
add»ss
, *
poŞ
) { ; }

79 *
	$G‘Sw™chedH—pNext
(è{  
sw™ched_h—p_Ãxt
; 
	}
}

81 
size_t
 
	$G‘Sw™chedH—pRemaššg
(è{  
sw™ched_h—p_»maššg
; 
	}
}

84 
	$h—p_sw™ch
(*
ba£
, 
size_t
 
size
) {

85 ià(
ba£
 && 
size
 > 0) {

86 
sw™ched_h—p_Ãxt
 = 
¡©ic_ÿ¡
<
ušt8_t
 *>(
ba£
);

87 
sw™ched_h—p_»maššg
 = 
size
;

88 
	`£t_m®loc_hook
(&
M®locHook
, 
nuÎ±r
);

89 
	`£t_»®loc_hook
(&
R—ÎocHook
, 
nuÎ±r
);

90 
	`£t_ä“_hook
(&
F»eHook
, 
nuÎ±r
);

92 
sw™ched_h—p_Ãxt
 = 
nuÎ±r
;

93 
sw™ched_h—p_»maššg
 = 0;

94 
	`£t_m®loc_hook
Ğ
nuÎ±r
,‚ullptr);

95 
	`£t_»®loc_hook
Ğ
nuÎ±r
,‚ullptr);

96 
	`£t_ä“_hook
Ğ
nuÎ±r
,‚ullptr);

98 
	}
}

	@platform/posix/memory/memory.cc

19 
	~"asylo/¶©fÜm/posix/memÜy/memÜy.h
"

21 
	~<m®loc.h
>

22 
	~<¡dšt.h
>

23 
	~<¡dlib.h
>

25 
	~<c¡ddef
>

27 
	gÇme¥aû
 {

32 
ušt8_t
 *
	gsw™ched_h—p_Ãxt
 = 
nuÎ±r
;

38 
size_t
 
	gsw™ched_h—p_»maššg
 = 0;

44 *
AÎoÿ‹MemÜyOnSw™chedH—p
(
size_t
 
size
, *
poŞ
) {

46 
size_t
 
	g®ign
 = 
®ignof
(
¡d
::
max_®ign_t
);

47 
	gshiá
 =

48 (
®ign
 - (
»š‹½»t_ÿ¡
<
ušŒ_t
>(
sw™ched_h—p_Ãxt
) %‡lign)) %

49 
®ign
;

51 
	gsize
 +ğ
shiá
;

52 ià(!
	gsw™ched_h—p_Ãxt
 || 
	gsw™ched_h—p_»maššg
 < 
	gsize
) {

53  
	gnuÎ±r
;

56 *
	g»t
 = 
sw™ched_h—p_Ãxt
 + 
shiá
;

57 
	gsw™ched_h—p_Ãxt
 +ğ
size
;

58 
	gsw™ched_h—p_»maššg
 -ğ
size
;

60  
	g»t
;

63 *
M®locHook
(
size_t
 
size
, *
poŞ
) {

64  
AÎoÿ‹MemÜyOnSw™chedH—p
(
size
, 
poŞ
);

69 *
R—ÎocHook
(*
±r
, 
size_t
 
size
, *
poŞ
) {

70  
AÎoÿ‹MemÜyOnSw™chedH—p
(
size
, 
poŞ
);

75 
F»eHook
(*
add»ss
, *
poŞ
) { ; }

79 *
	$G‘Sw™chedH—pNext
(è{  
sw™ched_h—p_Ãxt
; 
	}
}

81 
size_t
 
	$G‘Sw™chedH—pRemaššg
(è{  
sw™ched_h—p_»maššg
; 
	}
}

84 
	$h—p_sw™ch
(*
ba£
, 
size_t
 
size
) {

85 ià(
ba£
 && 
size
 > 0) {

86 
sw™ched_h—p_Ãxt
 = 
¡©ic_ÿ¡
<
ušt8_t
 *>(
ba£
);

87 
sw™ched_h—p_»maššg
 = 
size
;

88 
	`£t_m®loc_hook
(&
M®locHook
, 
nuÎ±r
);

89 
	`£t_»®loc_hook
(&
R—ÎocHook
, 
nuÎ±r
);

90 
	`£t_ä“_hook
(&
F»eHook
, 
nuÎ±r
);

92 
sw™ched_h—p_Ãxt
 = 
nuÎ±r
;

93 
sw™ched_h—p_»maššg
 = 0;

94 
	`£t_m®loc_hook
Ğ
nuÎ±r
,‚ullptr);

95 
	`£t_»®loc_hook
Ğ
nuÎ±r
,‚ullptr);

96 
	`£t_ä“_hook
Ğ
nuÎ±r
,‚ullptr);

98 
	}
}

	@platform/posix/memory/memory.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_MEMORY_MEMORY_H_


20 
	#ASYLO_PLATFORM_POSIX_MEMORY_MEMORY_H_


	)

22 
	~<¡ddef.h
>

23 
	~<¡dlib.h
>

25 #ifdeà
__ılu¥lus


30 *
G‘Sw™chedH—pNext
();

33 
size_t
 
G‘Sw™chedH—pRemaššg
();

41 
h—p_sw™ch
(*
add»ss
, 
size_t
 
size
);

43 #ifdeà
__ılu¥lus


	@platform/posix/mman.cc

19 
	~<sys/mmª.h
>

21 
	~<”ºo.h
>

22 
	~<m®loc.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

27 
cÚ¡ex´
 
size_t
 
	gkPageSize
 = 4096;

31 *
mm­
(*
addr
, 
size_t
 
Ëngth
, 
´Ù
, 
æags
, 
fd
,

32 
off_t
 
off£t
) {

33 ià(
addr
 || 
´Ù
 !ğ(
PROT_READ
 | 
PROT_WRITE
) ||

34 
æags
 !ğ(
MAP_ANONYMOUS
 | 
MAP_PRIVATE
è|| 
fd
 !ğ-1 || 
off£t
 != 0) {

35 
”ºo
 = 
ENOSYS
;

36  
MAP_FAILED
;

38 *
±r
 = 
mem®ign
(
kPageSize
, 
Ëngth
);

39 ià(
±r
 =ğ
nuÎ±r
) {

40  
MAP_FAILED
;

43 
mem£t
(
±r
, 0, 
Ëngth
);

44  
±r
;

47 
munm­
(*
addr
, 
size_t
 
Ëngth
) {

48 
ä“
(
addr
);

52 
posix_mem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
) {

55 ià(
size
 == 0) {

56 *
mem±r
 = 
nuÎ±r
;

60 *
±r
 = 
mem®ign
(
®ignm’t
, 
size
);

65 ià(
±r
 =ğ
nuÎ±r
) {

66  
ENOMEM
;

69 *
mem±r
 = 
±r
;

73 
mlock
(cÚ¡ *
addr
, 
size_t
 
Ën
) {

74 
”ºo
 = 
ENOSYS
;

78 
mlock2
(cÚ¡ *
addr
, 
size_t
 
Ën
, 
æags
) {

79 
”ºo
 = 
ENOSYS
;

83 
muÆock
(cÚ¡ *
addr
, 
size_t
 
Ën
) {

84 
”ºo
 = 
ENOSYS
;

88 
mlock®l
(
æags
) {

89 
”ºo
 = 
ENOSYS
;

93 
muÆock®l
() {

94 
”ºo
 = 
ENOSYS
;

	@platform/posix/mman.cc

19 
	~<sys/mmª.h
>

21 
	~<”ºo.h
>

22 
	~<m®loc.h
>

23 
	~<¡dlib.h
>

24 
	~<¡ršg.h
>

27 
cÚ¡ex´
 
size_t
 
	gkPageSize
 = 4096;

31 *
mm­
(*
addr
, 
size_t
 
Ëngth
, 
´Ù
, 
æags
, 
fd
,

32 
off_t
 
off£t
) {

33 ià(
addr
 || 
´Ù
 !ğ(
PROT_READ
 | 
PROT_WRITE
) ||

34 
æags
 !ğ(
MAP_ANONYMOUS
 | 
MAP_PRIVATE
è|| 
fd
 !ğ-1 || 
off£t
 != 0) {

35 
”ºo
 = 
ENOSYS
;

36  
MAP_FAILED
;

38 *
±r
 = 
mem®ign
(
kPageSize
, 
Ëngth
);

39 ià(
±r
 =ğ
nuÎ±r
) {

40  
MAP_FAILED
;

43 
mem£t
(
±r
, 0, 
Ëngth
);

44  
±r
;

47 
munm­
(*
addr
, 
size_t
 
Ëngth
) {

48 
ä“
(
addr
);

52 
posix_mem®ign
(**
mem±r
, 
size_t
 
®ignm’t
, size_ˆ
size
) {

55 ià(
size
 == 0) {

56 *
mem±r
 = 
nuÎ±r
;

60 *
±r
 = 
mem®ign
(
®ignm’t
, 
size
);

65 ià(
±r
 =ğ
nuÎ±r
) {

66  
ENOMEM
;

69 *
mem±r
 = 
±r
;

73 
mlock
(cÚ¡ *
addr
, 
size_t
 
Ën
) {

74 
”ºo
 = 
ENOSYS
;

78 
mlock2
(cÚ¡ *
addr
, 
size_t
 
Ën
, 
æags
) {

79 
”ºo
 = 
ENOSYS
;

83 
muÆock
(cÚ¡ *
addr
, 
size_t
 
Ën
) {

84 
”ºo
 = 
ENOSYS
;

88 
mlock®l
(
æags
) {

89 
”ºo
 = 
ENOSYS
;

93 
muÆock®l
() {

94 
”ºo
 = 
ENOSYS
;

	@platform/posix/pipe_test.cc

24 #iâdeà
_GNU_SOURCE


25 
	#_GNU_SOURCE


	)

28 
	~<fú.h
>

29 
	~<sys/¡©.h
>

30 
	~<uni¡d.h
>

31 
	~<b™£t
>

32 
	~<û¼no
>

33 
	~<şim™s
>

34 
	~<c¡dšt
>

35 
	~<c¡ršg
>

36 
	~<o¡»am
>

37 
	~<veùÜ
>

39 
	~<gmock/gmock.h
>

40 
	~<g‹¡/g‹¡.h
>

41 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

42 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

43 
	~"ab¦/ty³s/¥ª.h
"

44 
	~"asylo/ut/ş—nup.h
"

46 
Çme¥aû
 
	gasylo
 {

47 
	gÇme¥aû
 {

49 
	gusšg
 ::
‹¡šg
::
Eq
;

50 
	gusšg
 ::
‹¡šg
::
Ge
;

51 
	gusšg
 ::
‹¡šg
::
Gt
;

52 
	gusšg
 ::
‹¡šg
::
Ne
;

56 
cÚ¡ex´
 
size_t
 
	gkDeçuÉPeSize
 = 16 * 4096;

59 
cÚ¡ex´
 
	gkSm®lPeSize
 = 4096;

62 
şass
 
	gMemEqM©ch”
 : 
public
 ::
‹¡šg
::
M©ch”IÁ”çû
<const *> {

63 
public
:

67 
MemEqM©ch”
(cÚ¡ *
bufãr
, 
size_t
 
size
)

68 : 
ex³ùed_bufãr_
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
bufãr
), 
size
) {}

71 
DesüibeTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

72 *
os
 << 
ab¦
::
SŒC©
("containshe same bytes‡she buffer of size ",

73 
ex³ùed_bufãr_
.
size
(), "‡t‡ddress ",

74 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
ex³ùed_bufãr_
.
d©a
()));

78 
DesüibeNeg©iÚTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

79 *
os
 << 
ab¦
::
SŒC©
("contains different bytes fromhe buffer of size ",

80 
ex³ùed_bufãr_
.
size
(), "‡t‡ddress ",

81 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
ex³ùed_bufãr_
.
d©a
()));

85 
boŞ
 
M©chAndEx¶aš
(

86 cÚ¡ *
bufãr
,

87 ::
‹¡šg
::
M©chResuÉLi¡’”
 *
li¡’”
ècÚ¡ 
ov”ride
 {

88 cÚ¡ 
ušt8_t
 *
by‹_bufãr
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
bufãr
);

89 
	gi
 = 0; i < 
	gex³ùed_bufãr_
.
size
(); ++i) {

90 ià(
	gby‹_bufãr
[
i
] !ğ
ex³ùed_bufãr_
[i]) {

91 *
li¡’”
 << 
ab¦
::
SŒFÜm©
(

93 
by‹_bufãr
[
i
], i, 
ex³ùed_bufãr_
[i]);

94  
	gçl£
;

97  
	gŒue
;

100 
	g´iv©e
:

101 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
ex³ùed_bufãr_
;

112 ::
‹¡šg
::
M©ch”
<cÚ¡ *> 
MemEq
(cÚ¡ *
bufãr
, 
size_t
 
size
) {

113  ::
‹¡šg
::
MakeM©ch”
(
Ãw
 
MemEqM©ch”
(
bufãr
, 
size
));

116 şas 
	cPeTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

117 
public
:

118 
PeTe¡
()

119 : 
sm®l_d©a_
({'f', 'o', 'o', 'b', 'a', 'r', '\0'}),

120 
·ck‘_d©a_
(
PIPE_BUF
),

121 
medium_d©a_
(
kDeçuÉPeSize
),

122 
Ïrge_d©a_
(4 * 
kDeçuÉPeSize
) {

123 
	gi
 = 0; i < 
	g·ck‘_d©a_
.
size
(); ++i) {

124 
	g·ck‘_d©a_
[
i
] = 
¡d
::
b™£t
<8 * (i)>(i).
couÁ
();

127 
	gi
 = 0; i < 
	gmedium_d©a_
.
size
(); ++i) {

128 
	gmedium_d©a_
[
i
] = ~
¡d
::
b™£t
<8 * (i)>(i).
couÁ
();

131 
	gi
 = 0; i < 
	gÏrge_d©a_
.
size
(); ++i) {

132 
	gÏrge_d©a_
[
i
] = 0x¯ ^ 
¡d
::
b™£t
<8 * (i)>(i).
couÁ
();

136 
	g´Ùeùed
:

139 
¡d
::
veùÜ
<
ušt8_t
> 
sm®l_d©a_
;

142 
	g¡d
::
veùÜ
<
ušt8_t
> 
·ck‘_d©a_
;

146 
	g¡d
::
veùÜ
<
ušt8_t
> 
medium_d©a_
;

149 
	g¡d
::
veùÜ
<
ušt8_t
> 
Ïrge_d©a_
;

154 
TEST_F
(
PeTe¡
, 
PeGivesV®idFeDesütÜPaœs
) {

155 
	gpe_fds
[2];

156 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

157 
	g»ad_fd
 = 
pe_fds
[0];

158 
	gwr™e_fd
 = 
pe_fds
[1];

159 
CËªup
 
şo£_»ad
(

160 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

161 
CËªup
 
şo£_wr™e
(

162 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

164 
EXPECT_THAT
(
»ad_fd
, 
Ge
(0));

165 
EXPECT_THAT
(
wr™e_fd
, 
Ge
(0));

166 
EXPECT_THAT
(
»ad_fd
, 
Ne
(
wr™e_fd
));

171 
TEST_F
(
PeTe¡
, 
Pe2GivesV®idFeDesütÜPaœs
) {

172 
	gpe_fds
[2];

173 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

174 
	g»ad_fd
 = 
pe_fds
[0];

175 
	gwr™e_fd
 = 
pe_fds
[1];

176 
CËªup
 
şo£_»ad
(

177 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

178 
CËªup
 
şo£_wr™e
(

179 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

181 
EXPECT_THAT
(
»ad_fd
, 
Ge
(0));

182 
EXPECT_THAT
(
wr™e_fd
, 
Ge
(0));

183 
EXPECT_THAT
(
»ad_fd
, 
Ne
(
wr™e_fd
));

187 
TEST_F
(
PeTe¡
, 
PeFdsA»Fifos
) {

188 
	gpe_fds
[2];

189 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

190 
	g»ad_fd
 = 
pe_fds
[0];

191 
	gwr™e_fd
 = 
pe_fds
[1];

192 
CËªup
 
şo£_»ad
(

193 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

194 
CËªup
 
şo£_wr™e
(

195 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

197 
¡©
 
	g¡©buf
;

198 
ASSERT_THAT
(
f¡©
(
»ad_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

199 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

201 
ASSERT_THAT
(
f¡©
(
wr™e_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

202 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

206 
TEST_F
(
PeTe¡
, 
Pe2FdsA»Fifos
) {

207 
	gpe_fds
[2];

208 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

209 
	g»ad_fd
 = 
pe_fds
[0];

210 
	gwr™e_fd
 = 
pe_fds
[1];

211 
CËªup
 
şo£_»ad
(

212 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

213 
CËªup
 
şo£_wr™e
(

214 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

216 
¡©
 
	g¡©buf
;

217 
ASSERT_THAT
(
f¡©
(
»ad_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

218 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

220 
ASSERT_THAT
(
f¡©
(
wr™e_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

221 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

225 
TEST_F
(
PeTe¡
, 
Sm®lWr™šgToO³nPesSucûeds
) {

226 
	gpe_fds
[2];

227 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

228 
	g»ad_fd
 = 
pe_fds
[0];

229 
	gwr™e_fd
 = 
pe_fds
[1];

230 
CËªup
 
şo£_»ad
(

231 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

232 
CËªup
 
şo£_wr™e
(

233 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

235 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

236 << 
¡»¼Ü
(
”ºo
);

240 
TEST_F
(
PeTe¡
, 
MediumWr™šgToO³nPesSucûeds
) {

241 
	gpe_fds
[2];

242 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

243 
	g»ad_fd
 = 
pe_fds
[0];

244 
	gwr™e_fd
 = 
pe_fds
[1];

245 
CËªup
 
şo£_»ad
(

246 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

247 
CËªup
 
şo£_wr™e
(

248 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

250 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

251 << 
¡»¼Ü
(
”ºo
);

255 
TEST_F
(
PeTe¡
, 
Sm®lWr™šgToO³nPe2PesSucûeds
) {

256 
	gpe_fds
[2];

257 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

258 
	g»ad_fd
 = 
pe_fds
[0];

259 
	gwr™e_fd
 = 
pe_fds
[1];

260 
CËªup
 
şo£_»ad
(

261 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

262 
CËªup
 
şo£_wr™e
(

263 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

265 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

266 << 
¡»¼Ü
(
”ºo
);

270 
TEST_F
(
PeTe¡
, 
MediumWr™šgToO³nPe2PesSucûeds
) {

271 
	gpe_fds
[2];

272 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

273 
	g»ad_fd
 = 
pe_fds
[0];

274 
	gwr™e_fd
 = 
pe_fds
[1];

275 
CËªup
 
şo£_»ad
(

276 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

277 
CËªup
 
şo£_wr™e
(

278 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

280 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

281 << 
¡»¼Ü
(
”ºo
);

285 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPesSucûedsW™hSm®lD©a
) {

286 
	gpe_fds
[2];

287 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

288 
	g»ad_fd
 = 
pe_fds
[0];

289 
	gwr™e_fd
 = 
pe_fds
[1];

290 
CËªup
 
şo£_»ad
(

291 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

292 
CËªup
 
şo£_wr™e
(

293 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

295 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

296 << 
¡»¼Ü
(
”ºo
);

298 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
sm®l_d©a_
.
size
());

300 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

301 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

302 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
sm®l_d©a_
.d©a(), 
»ad_»suÉ
));

307 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPe2PesSucûedsW™hSm®lD©a
) {

308 
	gpe_fds
[2];

309 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

310 
	g»ad_fd
 = 
pe_fds
[0];

311 
	gwr™e_fd
 = 
pe_fds
[1];

312 
CËªup
 
şo£_»ad
(

313 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

314 
CËªup
 
şo£_wr™e
(

315 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

317 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

318 << 
¡»¼Ü
(
”ºo
);

320 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
sm®l_d©a_
.
size
());

322 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

323 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

324 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
sm®l_d©a_
.d©a(), 
»ad_»suÉ
));

328 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPesSucûedsW™hMediumD©a
) {

329 
	gpe_fds
[2];

330 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

331 
	g»ad_fd
 = 
pe_fds
[0];

332 
	gwr™e_fd
 = 
pe_fds
[1];

333 
CËªup
 
şo£_»ad
(

334 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

335 
CËªup
 
şo£_wr™e
(

336 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

338 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

339 << 
¡»¼Ü
(
”ºo
);

341 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

343 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

344 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

345 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

350 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPe2PesSucûedsW™hMediumD©a
) {

351 
	gpe_fds
[2];

352 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

353 
	g»ad_fd
 = 
pe_fds
[0];

354 
	gwr™e_fd
 = 
pe_fds
[1];

355 
CËªup
 
şo£_»ad
(

356 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

357 
CËªup
 
şo£_wr™e
(

358 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

360 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

361 << 
¡»¼Ü
(
”ºo
);

363 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

365 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

366 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

367 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

372 
TEST_F
(
PeTe¡
,

373 
R—dšgFromO³nNÚEm±yPesSucûedsWh’R—dšgP¬tOfWr™‹nD©a
) {

374 
	gpe_fds
[2];

375 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

376 
	g»ad_fd
 = 
pe_fds
[0];

377 
	gwr™e_fd
 = 
pe_fds
[1];

378 
CËªup
 
şo£_»ad
(

379 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

380 
CËªup
 
şo£_wr™e
(

381 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

383 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

384 << 
¡»¼Ü
(
”ºo
);

386 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
() / 2);

388 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

389 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

390 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

395 
TEST_F
(
PeTe¡
,

396 
R—dšgFromO³nNÚEm±yPe2PesSucûedsWh’R—dšgP¬tOfWr™‹nD©a
) {

397 
	gpe_fds
[2];

398 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

399 
	g»ad_fd
 = 
pe_fds
[0];

400 
	gwr™e_fd
 = 
pe_fds
[1];

401 
CËªup
 
şo£_»ad
(

402 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

403 
CËªup
 
şo£_wr™e
(

404 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

406 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

407 << 
¡»¼Ü
(
”ºo
);

409 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
() / 2);

411 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

412 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

413 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

418 
TEST_F
(
PeTe¡
, 
Pe2RejeùsUnknownFÏgs
) {

419 
cÚ¡ex´
 
	gkBadFÏgs
 = 0xà& ~(
O_CLOEXEC
 | 
O_DIRECT
 | 
O_NONBLOCK
);

421 
	gpe_fds
[2];

422 
EXPECT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
 | 
kBadFÏgs
), 
Eq
(-1));

423 
EXPECT_THAT
(
”ºo
, 
Eq
(
EINVAL
));

427 
TEST_F
(
PeTe¡
, 
MªyPesCªBeO³Ãd
) {

428 
cÚ¡ex´
 
	gkNumPes
 = 500;

430 
	g¡d
::
veùÜ
<
¡d
::
¬¿y
<, 2>> 
	gpes
;

431 
	gpes
.
»£rve
(
kNumPes
);

432 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

433 
	gpes
.
em¶aû_back
();

434 
ASSERT_THAT
(
pe
(
pes
.
back
().
d©a
()), 
Eq
(0))

435 << 
¡»¼Ü
(
”ºo
è<< "‡ˆp" << 
	gi
;

438 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

439 
EXPECT_THAT
(
şo£
(
pes
[
i
][0]), 
Eq
(0))

440 << 
¡»¼Ü
(
”ºo
è<< "‡ˆp" << 
	gi
;

441 
EXPECT_THAT
(
şo£
(
pes
[
i
][1]), 
Eq
(0))

442 << 
¡»¼Ü
(
”ºo
è<< "‡ˆp" << 
	gi
;

448 
TEST_F
(
PeTe¡
, 
OClÛxecPesA»NÜm®Pes
) {

449 
	gpe_fds
[2];

450 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_CLOEXEC
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

451 
	g»ad_fd
 = 
pe_fds
[0];

452 
	gwr™e_fd
 = 
pe_fds
[1];

453 
CËªup
 
şo£_»ad
(

454 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

455 
CËªup
 
şo£_wr™e
(

456 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

458 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

459 << 
¡»¼Ü
(
”ºo
);

461 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

463 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
medium_d©a_
.
size
());

464 
ASSERT_THAT
(
»ad_»suÉ
, 
Ge
(0)è<< 
¡»¼Ü
(
”ºo
);

465 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

469 
TEST_F
(
PeTe¡
, 
OClÛxecPesHaveFdClÛxecFÏgS‘
) {

470 
	gpe_fds
[2];

471 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_CLOEXEC
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

472 
	g»ad_fd
 = 
pe_fds
[0];

473 
	gwr™e_fd
 = 
pe_fds
[1];

474 
CËªup
 
şo£_»ad
(

475 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

476 
CËªup
 
şo£_wr™e
(

477 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

479 
	gfd_æags
 = 
fú
(
»ad_fd
, 
F_GETFD
, 0);

480 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

481 
EXPECT_TRUE
(
fd_æags
 & 
FD_CLOEXEC
);

483 
	gfd_æags
 = 
fú
(
wr™e_fd
, 
F_GETFD
, 0);

484 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

485 
EXPECT_TRUE
(
fd_æags
 & 
FD_CLOEXEC
);

489 
TEST_F
(
PeTe¡
, 
Pe2W™hODœeùGivesDi¡šùV®idFeDesütÜs
) {

490 
	gpe_fds
[2];

491 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

492 
	g»ad_fd
 = 
pe_fds
[0];

493 
	gwr™e_fd
 = 
pe_fds
[1];

494 
EXPECT_THAT
(
»ad_fd
, 
Ge
(0));

495 
EXPECT_THAT
(
wr™e_fd
, 
Ge
(0));

496 
EXPECT_THAT
(
»ad_fd
, 
Ne
(
wr™e_fd
));

498 
ASSERT_THAT
(
şo£
(
»ad_fd
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

499 
ASSERT_THAT
(
şo£
(
wr™e_fd
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

504 
TEST_F
(
PeTe¡
, 
Wr™eFdOnODœeùPeHasODœeùFÏgS‘
) {

505 
	gpe_fds
[2];

506 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

507 
	g»ad_fd
 = 
pe_fds
[0];

508 
	gwr™e_fd
 = 
pe_fds
[1];

509 
CËªup
 
şo£_»ad
(

510 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

511 
CËªup
 
şo£_wr™e
(

512 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

514 
	gfd_æags
 = 
fú
(
wr™e_fd
, 
F_GETFL
, 0);

515 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

516 
EXPECT_TRUE
(
fd_æags
 & 
O_DIRECT
);

521 
TEST_F
(
PeTe¡
, 
Sm®lWr™esToODœeùPesSucûedAndWr™eAÎD©a
) {

522 
	gpe_fds
[2];

523 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

524 
	g»ad_fd
 = 
pe_fds
[0];

525 
	gwr™e_fd
 = 
pe_fds
[1];

526 
CËªup
 
şo£_»ad
(

527 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

528 
CËªup
 
şo£_wr™e
(

529 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

531 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()),

532 
Eq
(
sm®l_d©a_
.
size
()))

533 << 
¡»¼Ü
(
”ºo
);

538 
TEST_F
(
PeTe¡
, 
MediumWr™esToODœeùPesSucûedAndWr™eAÎD©a
) {

539 
	gpe_fds
[2];

540 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

541 
	g»ad_fd
 = 
pe_fds
[0];

542 
	gwr™e_fd
 = 
pe_fds
[1];

543 
CËªup
 
şo£_»ad
(

544 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

545 
CËªup
 
şo£_wr™e
(

546 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

548 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

549 
Eq
(
medium_d©a_
.
size
()))

550 << 
¡»¼Ü
(
”ºo
);

555 
TEST_F
(
PeTe¡
, 
L¬geWr™esToODœeùPesSucûedAndWr™eOÆyPeBufBy‹s
) {

556 
	gpe_fds
[2];

557 
ASSERT_EQ
(
pe2
(
pe_fds
, 
O_DIRECT
 | 
O_NONBLOCK
), 0è<< 
¡»¼Ü
(
”ºo
);

558 
	g»ad_fd
 = 
pe_fds
[0];

559 
	gwr™e_fd
 = 
pe_fds
[1];

560 
CËªup
 
şo£_»ad
(

561 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

562 
CËªup
 
şo£_wr™e
(

563 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

565 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
Ïrge_d©a_
.
d©a
(),†¬ge_d©a_.
size
()),

566 
Eq
(
kDeçuÉPeSize
))

567 << 
¡»¼Ü
(
”ºo
);

572 
TEST_F
(
PeTe¡
, 
Sm®lR—dsFromODœeùPesSucûedAndDisÿrdRe¡OfPack‘
) {

573 
	gpe_fds
[2];

574 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

575 
	g»ad_fd
 = 
pe_fds
[0];

576 
	gwr™e_fd
 = 
pe_fds
[1];

577 
CËªup
 
şo£_»ad
(

578 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

579 
CËªup
 
şo£_wr™e
(

580 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

582 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

583 
Eq
(
PIPE_BUF
))

584 << 
¡»¼Ü
(
”ºo
);

585 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

586 
Eq
(
PIPE_BUF
))

587 << 
¡»¼Ü
(
”ºo
);

589 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
PIPE_BUF
 / 2);

591 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
PIPE_BUF
 / 2), 
Eq
(PIPE_BUF / 2));

592 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
 / 2));

594 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
PIPE_BUF
 / 2), 
Eq
(PIPE_BUF / 2));

595 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
 / 2));

599 
TEST_F
(
PeTe¡
, 
PeBufSizedR—dsFromODœeùPesSucûed
) {

600 
	gpe_fds
[2];

601 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

602 
	g»ad_fd
 = 
pe_fds
[0];

603 
	gwr™e_fd
 = 
pe_fds
[1];

604 
CËªup
 
şo£_»ad
(

605 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

606 
CËªup
 
şo£_wr™e
(

607 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

609 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

610 
Eq
(
PIPE_BUF
))

611 << 
¡»¼Ü
(
”ºo
);

613 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
PIPE_BUF
);

615 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
PIPE_BUF
), 
Eq
(PIPE_BUF));

616 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
));

621 
TEST_F
(
PeTe¡
, 
L¬geR—dsFromODœeùPesSucûedButOÆyR—dPeBufBy‹s
) {

622 
	gpe_fds
[2];

623 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

624 
	g»ad_fd
 = 
pe_fds
[0];

625 
	gwr™e_fd
 = 
pe_fds
[1];

626 
CËªup
 
şo£_»ad
(

627 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

628 
CËªup
 
şo£_wr™e
(

629 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

631 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

632 
Eq
(
PIPE_BUF
))

633 << 
¡»¼Ü
(
”ºo
);

634 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

635 
Eq
(
PIPE_BUF
))

636 << 
¡»¼Ü
(
”ºo
);

638 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

640 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
()), 
Eq
(
PIPE_BUF
));

641 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
));

645 
TEST_F
(
PeTe¡
, 
NÚBlockšgPesHaveONÚblockFeStusFÏg
) {

646 
	gpe_fds
[2];

647 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

648 
	g»ad_fd
 = 
pe_fds
[0];

649 
	gwr™e_fd
 = 
pe_fds
[1];

650 
CËªup
 
şo£_»ad
(

651 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

652 
CËªup
 
şo£_wr™e
(

653 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

655 
	gfd_æags
 = 
fú
(
»ad_fd
, 
F_GETFL
, 0);

656 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

657 
EXPECT_TRUE
(
fd_æags
 & 
O_NONBLOCK
);

659 
	gfd_æags
 = 
fú
(
wr™e_fd
, 
F_GETFL
, 0);

660 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

661 
EXPECT_TRUE
(
fd_æags
 & 
O_NONBLOCK
);

665 
TEST_F
(
PeTe¡
, 
MediumWr™esToNÚBlockšgPesSucûed
) {

666 
	gpe_fds
[2];

667 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

668 
	g»ad_fd
 = 
pe_fds
[0];

669 
	gwr™e_fd
 = 
pe_fds
[1];

670 
CËªup
 
şo£_»ad
(

671 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

672 
CËªup
 
şo£_wr™e
(

673 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

675 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

676 
Eq
(
medium_d©a_
.
size
()))

677 << 
¡»¼Ü
(
”ºo
);

681 
TEST_F
(
PeTe¡
, 
L¬geWr™esToNÚBlockšgPesFaW™hEAgaš
) {

682 
	gpe_fds
[2];

683 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

684 
	g»ad_fd
 = 
pe_fds
[0];

685 
	gwr™e_fd
 = 
pe_fds
[1];

686 
CËªup
 
şo£_»ad
(

687 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

688 
CËªup
 
şo£_wr™e
(

689 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

691 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

692 
Eq
(
medium_d©a_
.
size
()))

693 << 
¡»¼Ü
(
”ºo
);

695 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Eq
(-1));

696 
EXPECT_THAT
(
”ºo
, 
Eq
(
EAGAIN
));

700 
TEST_F
(
PeTe¡
, 
R—dsFromEm±yNÚBlockšgPesFaW™hEAgaš
) {

701 
	gpe_fds
[2];

702 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

703 
	g»ad_fd
 = 
pe_fds
[0];

704 
	gwr™e_fd
 = 
pe_fds
[1];

705 
CËªup
 
şo£_»ad
(

706 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

707 
CËªup
 
şo£_wr™e
(

708 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

710 
ušt8_t
 
	g»ad_v®
;

711 
ASSERT_THAT
(
»ad
(
»ad_fd
, &
»ad_v®
, 1), 
Eq
(-1));

712 
EXPECT_THAT
(
”ºo
, 
Eq
(
EAGAIN
));

716 
TEST_F
(
PeTe¡
, 
MediumR—dsFromFuÎNÚBlockšgPesSucûed
) {

717 
	gpe_fds
[2];

718 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

719 
	g»ad_fd
 = 
pe_fds
[0];

720 
	gwr™e_fd
 = 
pe_fds
[1];

721 
CËªup
 
şo£_»ad
(

722 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

723 
CËªup
 
şo£_wr™e
(

724 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

726 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

727 
Eq
(
medium_d©a_
.
size
()))

728 << 
¡»¼Ü
(
”ºo
);

730 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

732 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
()),

733 
Eq
(
»ad_buf
.
size
()))

734 << 
¡»¼Ü
(
”ºo
);

735 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), medium_d©a_.
size
()));

739 
TEST_F
(
PeTe¡
, 
L¬geR—dsFromFuÎNÚBlockšgPesSucûed
) {

740 
	gpe_fds
[2];

741 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

742 
	g»ad_fd
 = 
pe_fds
[0];

743 
	gwr™e_fd
 = 
pe_fds
[1];

744 
CËªup
 
şo£_»ad
(

745 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

746 
CËªup
 
şo£_wr™e
(

747 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

749 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

750 
Eq
(
medium_d©a_
.
size
()))

751 << 
¡»¼Ü
(
”ºo
);

753 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
Ïrge_d©a_
.
size
());

755 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
()),

756 
Eq
(
medium_d©a_
.
size
()))

757 << 
¡»¼Ü
(
”ºo
);

758 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), medium_d©a_.
size
()));

762 
TEST_F
(
PeTe¡
, 
FúFS‘peSzChªgesPeSize
) {

763 
	gpe_fds
[2];

764 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

765 
	g»ad_fd
 = 
pe_fds
[0];

766 
	gwr™e_fd
 = 
pe_fds
[1];

767 
CËªup
 
şo£_»ad
(

768 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

769 
CËªup
 
şo£_wr™e
(

770 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

772 
	gpe_size
 = 
fú
(
wr™e_fd
, 
F_GETPIPE_SZ
, 0);

773 
ASSERT_THAT
(
pe_size
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

774 
EXPECT_THAT
(
pe_size
, 
Eq
(
kDeçuÉPeSize
));

776 
ASSERT_THAT
(
fú
(
wr™e_fd
, 
F_SETPIPE_SZ
, 
kSm®lPeSize
), 
Eq
(kSmallPipeSize))

777 << 
¡»¼Ü
(
”ºo
);

779 
	gpe_size
 = 
fú
(
wr™e_fd
, 
F_GETPIPE_SZ
, 0);

780 
ASSERT_THAT
(
pe_size
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

781 
EXPECT_THAT
(
pe_size
, 
Eq
(
kSm®lPeSize
));

786 
TEST_F
(
PeTe¡
, 
ResizedPesHaveSm®ËrC­ac™y
) {

787 
	gpe_fds
[2];

788 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

789 
	g»ad_fd
 = 
pe_fds
[0];

790 
	gwr™e_fd
 = 
pe_fds
[1];

791 
CËªup
 
şo£_»ad
(

792 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

793 
CËªup
 
şo£_wr™e
(

794 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

796 
ASSERT_THAT
(
fú
(
wr™e_fd
, 
F_SETPIPE_SZ
, 
kSm®lPeSize
), 
Eq
(kSmallPipeSize))

797 << 
¡»¼Ü
(
”ºo
);

799 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), 
kSm®lPeSize
),

800 
Eq
(
kSm®lPeSize
))

801 << 
¡»¼Ü
(
”ºo
);

802 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Eq
(-1));

803 
EXPECT_THAT
(
”ºo
, 
Eq
(
EAGAIN
));

808 
TEST_F
(
PeTe¡
, 
FúCªnÙShrškPeB–owCu¼’yH–dBy‹s
) {

809 
	gpe_fds
[2];

810 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

811 
	g»ad_fd
 = 
pe_fds
[0];

812 
	gwr™e_fd
 = 
pe_fds
[1];

813 
CËªup
 
şo£_»ad
(

814 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

815 
CËªup
 
şo£_wr™e
(

816 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

818 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

819 
Eq
(
medium_d©a_
.
size
()))

820 << 
¡»¼Ü
(
”ºo
);

822 
ASSERT_THAT
(
fú
(
wr™e_fd
, 
F_SETPIPE_SZ
, 
kSm®lPeSize
), 
Eq
(-1));

823 
EXPECT_THAT
(
”ºo
, 
Eq
(
EBUSY
));

	@platform/posix/pipe_test.cc

24 #iâdeà
_GNU_SOURCE


25 
	#_GNU_SOURCE


	)

28 
	~<fú.h
>

29 
	~<sys/¡©.h
>

30 
	~<uni¡d.h
>

31 
	~<b™£t
>

32 
	~<û¼no
>

33 
	~<şim™s
>

34 
	~<c¡dšt
>

35 
	~<c¡ršg
>

36 
	~<o¡»am
>

37 
	~<veùÜ
>

39 
	~<gmock/gmock.h
>

40 
	~<g‹¡/g‹¡.h
>

41 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

42 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

43 
	~"ab¦/ty³s/¥ª.h
"

44 
	~"asylo/ut/ş—nup.h
"

46 
Çme¥aû
 
	gasylo
 {

47 
	gÇme¥aû
 {

49 
	gusšg
 ::
‹¡šg
::
Eq
;

50 
	gusšg
 ::
‹¡šg
::
Ge
;

51 
	gusšg
 ::
‹¡šg
::
Gt
;

52 
	gusšg
 ::
‹¡šg
::
Ne
;

56 
cÚ¡ex´
 
size_t
 
	gkDeçuÉPeSize
 = 16 * 4096;

59 
cÚ¡ex´
 
	gkSm®lPeSize
 = 4096;

62 
şass
 
	gMemEqM©ch”
 : 
public
 ::
‹¡šg
::
M©ch”IÁ”çû
<const *> {

63 
public
:

67 
MemEqM©ch”
(cÚ¡ *
bufãr
, 
size_t
 
size
)

68 : 
ex³ùed_bufãr_
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
bufãr
), 
size
) {}

71 
DesüibeTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

72 *
os
 << 
ab¦
::
SŒC©
("containshe same bytes‡she buffer of size ",

73 
ex³ùed_bufãr_
.
size
(), "‡t‡ddress ",

74 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
ex³ùed_bufãr_
.
d©a
()));

78 
DesüibeNeg©iÚTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

79 *
os
 << 
ab¦
::
SŒC©
("contains different bytes fromhe buffer of size ",

80 
ex³ùed_bufãr_
.
size
(), "‡t‡ddress ",

81 
»š‹½»t_ÿ¡
<
ušŒ_t
>(
ex³ùed_bufãr_
.
d©a
()));

85 
boŞ
 
M©chAndEx¶aš
(

86 cÚ¡ *
bufãr
,

87 ::
‹¡šg
::
M©chResuÉLi¡’”
 *
li¡’”
ècÚ¡ 
ov”ride
 {

88 cÚ¡ 
ušt8_t
 *
by‹_bufãr
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
bufãr
);

89 
	gi
 = 0; i < 
	gex³ùed_bufãr_
.
size
(); ++i) {

90 ià(
	gby‹_bufãr
[
i
] !ğ
ex³ùed_bufãr_
[i]) {

91 *
li¡’”
 << 
ab¦
::
SŒFÜm©
(

93 
by‹_bufãr
[
i
], i, 
ex³ùed_bufãr_
[i]);

94  
	gçl£
;

97  
	gŒue
;

100 
	g´iv©e
:

101 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
ex³ùed_bufãr_
;

112 ::
‹¡šg
::
M©ch”
<cÚ¡ *> 
MemEq
(cÚ¡ *
bufãr
, 
size_t
 
size
) {

113  ::
‹¡šg
::
MakeM©ch”
(
Ãw
 
MemEqM©ch”
(
bufãr
, 
size
));

116 şas 
	cPeTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

117 
public
:

118 
PeTe¡
()

119 : 
sm®l_d©a_
({'f', 'o', 'o', 'b', 'a', 'r', '\0'}),

120 
·ck‘_d©a_
(
PIPE_BUF
),

121 
medium_d©a_
(
kDeçuÉPeSize
),

122 
Ïrge_d©a_
(4 * 
kDeçuÉPeSize
) {

123 
	gi
 = 0; i < 
	g·ck‘_d©a_
.
size
(); ++i) {

124 
	g·ck‘_d©a_
[
i
] = 
¡d
::
b™£t
<8 * (i)>(i).
couÁ
();

127 
	gi
 = 0; i < 
	gmedium_d©a_
.
size
(); ++i) {

128 
	gmedium_d©a_
[
i
] = ~
¡d
::
b™£t
<8 * (i)>(i).
couÁ
();

131 
	gi
 = 0; i < 
	gÏrge_d©a_
.
size
(); ++i) {

132 
	gÏrge_d©a_
[
i
] = 0x¯ ^ 
¡d
::
b™£t
<8 * (i)>(i).
couÁ
();

136 
	g´Ùeùed
:

139 
¡d
::
veùÜ
<
ušt8_t
> 
sm®l_d©a_
;

142 
	g¡d
::
veùÜ
<
ušt8_t
> 
·ck‘_d©a_
;

146 
	g¡d
::
veùÜ
<
ušt8_t
> 
medium_d©a_
;

149 
	g¡d
::
veùÜ
<
ušt8_t
> 
Ïrge_d©a_
;

154 
TEST_F
(
PeTe¡
, 
PeGivesV®idFeDesütÜPaœs
) {

155 
	gpe_fds
[2];

156 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

157 
	g»ad_fd
 = 
pe_fds
[0];

158 
	gwr™e_fd
 = 
pe_fds
[1];

159 
CËªup
 
şo£_»ad
(

160 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

161 
CËªup
 
şo£_wr™e
(

162 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

164 
EXPECT_THAT
(
»ad_fd
, 
Ge
(0));

165 
EXPECT_THAT
(
wr™e_fd
, 
Ge
(0));

166 
EXPECT_THAT
(
»ad_fd
, 
Ne
(
wr™e_fd
));

171 
TEST_F
(
PeTe¡
, 
Pe2GivesV®idFeDesütÜPaœs
) {

172 
	gpe_fds
[2];

173 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

174 
	g»ad_fd
 = 
pe_fds
[0];

175 
	gwr™e_fd
 = 
pe_fds
[1];

176 
CËªup
 
şo£_»ad
(

177 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

178 
CËªup
 
şo£_wr™e
(

179 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

181 
EXPECT_THAT
(
»ad_fd
, 
Ge
(0));

182 
EXPECT_THAT
(
wr™e_fd
, 
Ge
(0));

183 
EXPECT_THAT
(
»ad_fd
, 
Ne
(
wr™e_fd
));

187 
TEST_F
(
PeTe¡
, 
PeFdsA»Fifos
) {

188 
	gpe_fds
[2];

189 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

190 
	g»ad_fd
 = 
pe_fds
[0];

191 
	gwr™e_fd
 = 
pe_fds
[1];

192 
CËªup
 
şo£_»ad
(

193 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

194 
CËªup
 
şo£_wr™e
(

195 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

197 
¡©
 
	g¡©buf
;

198 
ASSERT_THAT
(
f¡©
(
»ad_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

199 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

201 
ASSERT_THAT
(
f¡©
(
wr™e_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

202 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

206 
TEST_F
(
PeTe¡
, 
Pe2FdsA»Fifos
) {

207 
	gpe_fds
[2];

208 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

209 
	g»ad_fd
 = 
pe_fds
[0];

210 
	gwr™e_fd
 = 
pe_fds
[1];

211 
CËªup
 
şo£_»ad
(

212 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

213 
CËªup
 
şo£_wr™e
(

214 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

216 
¡©
 
	g¡©buf
;

217 
ASSERT_THAT
(
f¡©
(
»ad_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

218 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

220 
ASSERT_THAT
(
f¡©
(
wr™e_fd
, &
¡©buf
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

221 
EXPECT_TRUE
(
S_ISFIFO
(
¡©buf
.
¡_mode
));

225 
TEST_F
(
PeTe¡
, 
Sm®lWr™šgToO³nPesSucûeds
) {

226 
	gpe_fds
[2];

227 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

228 
	g»ad_fd
 = 
pe_fds
[0];

229 
	gwr™e_fd
 = 
pe_fds
[1];

230 
CËªup
 
şo£_»ad
(

231 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

232 
CËªup
 
şo£_wr™e
(

233 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

235 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

236 << 
¡»¼Ü
(
”ºo
);

240 
TEST_F
(
PeTe¡
, 
MediumWr™šgToO³nPesSucûeds
) {

241 
	gpe_fds
[2];

242 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

243 
	g»ad_fd
 = 
pe_fds
[0];

244 
	gwr™e_fd
 = 
pe_fds
[1];

245 
CËªup
 
şo£_»ad
(

246 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

247 
CËªup
 
şo£_wr™e
(

248 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

250 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

251 << 
¡»¼Ü
(
”ºo
);

255 
TEST_F
(
PeTe¡
, 
Sm®lWr™šgToO³nPe2PesSucûeds
) {

256 
	gpe_fds
[2];

257 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

258 
	g»ad_fd
 = 
pe_fds
[0];

259 
	gwr™e_fd
 = 
pe_fds
[1];

260 
CËªup
 
şo£_»ad
(

261 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

262 
CËªup
 
şo£_wr™e
(

263 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

265 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

266 << 
¡»¼Ü
(
”ºo
);

270 
TEST_F
(
PeTe¡
, 
MediumWr™šgToO³nPe2PesSucûeds
) {

271 
	gpe_fds
[2];

272 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

273 
	g»ad_fd
 = 
pe_fds
[0];

274 
	gwr™e_fd
 = 
pe_fds
[1];

275 
CËªup
 
şo£_»ad
(

276 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

277 
CËªup
 
şo£_wr™e
(

278 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

280 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

281 << 
¡»¼Ü
(
”ºo
);

285 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPesSucûedsW™hSm®lD©a
) {

286 
	gpe_fds
[2];

287 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

288 
	g»ad_fd
 = 
pe_fds
[0];

289 
	gwr™e_fd
 = 
pe_fds
[1];

290 
CËªup
 
şo£_»ad
(

291 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

292 
CËªup
 
şo£_wr™e
(

293 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

295 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

296 << 
¡»¼Ü
(
”ºo
);

298 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
sm®l_d©a_
.
size
());

300 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

301 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

302 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
sm®l_d©a_
.d©a(), 
»ad_»suÉ
));

307 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPe2PesSucûedsW™hSm®lD©a
) {

308 
	gpe_fds
[2];

309 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

310 
	g»ad_fd
 = 
pe_fds
[0];

311 
	gwr™e_fd
 = 
pe_fds
[1];

312 
CËªup
 
şo£_»ad
(

313 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

314 
CËªup
 
şo£_wr™e
(

315 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

317 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Ge
(0))

318 << 
¡»¼Ü
(
”ºo
);

320 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
sm®l_d©a_
.
size
());

322 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

323 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

324 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
sm®l_d©a_
.d©a(), 
»ad_»suÉ
));

328 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPesSucûedsW™hMediumD©a
) {

329 
	gpe_fds
[2];

330 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

331 
	g»ad_fd
 = 
pe_fds
[0];

332 
	gwr™e_fd
 = 
pe_fds
[1];

333 
CËªup
 
şo£_»ad
(

334 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

335 
CËªup
 
şo£_wr™e
(

336 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

338 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

339 << 
¡»¼Ü
(
”ºo
);

341 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

343 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

344 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

345 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

350 
TEST_F
(
PeTe¡
, 
R—dšgFromO³nNÚEm±yPe2PesSucûedsW™hMediumD©a
) {

351 
	gpe_fds
[2];

352 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

353 
	g»ad_fd
 = 
pe_fds
[0];

354 
	gwr™e_fd
 = 
pe_fds
[1];

355 
CËªup
 
şo£_»ad
(

356 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

357 
CËªup
 
şo£_wr™e
(

358 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

360 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

361 << 
¡»¼Ü
(
”ºo
);

363 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

365 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

366 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

367 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

372 
TEST_F
(
PeTe¡
,

373 
R—dšgFromO³nNÚEm±yPesSucûedsWh’R—dšgP¬tOfWr™‹nD©a
) {

374 
	gpe_fds
[2];

375 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

376 
	g»ad_fd
 = 
pe_fds
[0];

377 
	gwr™e_fd
 = 
pe_fds
[1];

378 
CËªup
 
şo£_»ad
(

379 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

380 
CËªup
 
şo£_wr™e
(

381 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

383 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

384 << 
¡»¼Ü
(
”ºo
);

386 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
() / 2);

388 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

389 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

390 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

395 
TEST_F
(
PeTe¡
,

396 
R—dšgFromO³nNÚEm±yPe2PesSucûedsWh’R—dšgP¬tOfWr™‹nD©a
) {

397 
	gpe_fds
[2];

398 
ASSERT_THAT
(
pe2
(
pe_fds
, 0), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

399 
	g»ad_fd
 = 
pe_fds
[0];

400 
	gwr™e_fd
 = 
pe_fds
[1];

401 
CËªup
 
şo£_»ad
(

402 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

403 
CËªup
 
şo£_wr™e
(

404 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

406 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

407 << 
¡»¼Ü
(
”ºo
);

409 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
() / 2);

411 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
());

412 
ASSERT_THAT
(
»ad_»suÉ
, 
Gt
(0));

413 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

418 
TEST_F
(
PeTe¡
, 
Pe2RejeùsUnknownFÏgs
) {

419 
cÚ¡ex´
 
	gkBadFÏgs
 = 0xà& ~(
O_CLOEXEC
 | 
O_DIRECT
 | 
O_NONBLOCK
);

421 
	gpe_fds
[2];

422 
EXPECT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
 | 
kBadFÏgs
), 
Eq
(-1));

423 
EXPECT_THAT
(
”ºo
, 
Eq
(
EINVAL
));

427 
TEST_F
(
PeTe¡
, 
MªyPesCªBeO³Ãd
) {

428 
cÚ¡ex´
 
	gkNumPes
 = 500;

430 
	g¡d
::
veùÜ
<
¡d
::
¬¿y
<, 2>> 
	gpes
;

431 
	gpes
.
»£rve
(
kNumPes
);

432 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

433 
	gpes
.
em¶aû_back
();

434 
ASSERT_THAT
(
pe
(
pes
.
back
().
d©a
()), 
Eq
(0))

435 << 
¡»¼Ü
(
”ºo
è<< "‡ˆp" << 
	gi
;

438 
	gi
 = 0; i < 
	gkNumPes
; ++i) {

439 
EXPECT_THAT
(
şo£
(
pes
[
i
][0]), 
Eq
(0))

440 << 
¡»¼Ü
(
”ºo
è<< "‡ˆp" << 
	gi
;

441 
EXPECT_THAT
(
şo£
(
pes
[
i
][1]), 
Eq
(0))

442 << 
¡»¼Ü
(
”ºo
è<< "‡ˆp" << 
	gi
;

448 
TEST_F
(
PeTe¡
, 
OClÛxecPesA»NÜm®Pes
) {

449 
	gpe_fds
[2];

450 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_CLOEXEC
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

451 
	g»ad_fd
 = 
pe_fds
[0];

452 
	gwr™e_fd
 = 
pe_fds
[1];

453 
CËªup
 
şo£_»ad
(

454 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

455 
CËªup
 
şo£_wr™e
(

456 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

458 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()), 
Ge
(0))

459 << 
¡»¼Ü
(
”ºo
);

461 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

463 
ssize_t
 
	g»ad_»suÉ
 = 
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
medium_d©a_
.
size
());

464 
ASSERT_THAT
(
»ad_»suÉ
, 
Ge
(0)è<< 
¡»¼Ü
(
”ºo
);

465 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), 
»ad_»suÉ
));

469 
TEST_F
(
PeTe¡
, 
OClÛxecPesHaveFdClÛxecFÏgS‘
) {

470 
	gpe_fds
[2];

471 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_CLOEXEC
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

472 
	g»ad_fd
 = 
pe_fds
[0];

473 
	gwr™e_fd
 = 
pe_fds
[1];

474 
CËªup
 
şo£_»ad
(

475 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

476 
CËªup
 
şo£_wr™e
(

477 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

479 
	gfd_æags
 = 
fú
(
»ad_fd
, 
F_GETFD
, 0);

480 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

481 
EXPECT_TRUE
(
fd_æags
 & 
FD_CLOEXEC
);

483 
	gfd_æags
 = 
fú
(
wr™e_fd
, 
F_GETFD
, 0);

484 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

485 
EXPECT_TRUE
(
fd_æags
 & 
FD_CLOEXEC
);

489 
TEST_F
(
PeTe¡
, 
Pe2W™hODœeùGivesDi¡šùV®idFeDesütÜs
) {

490 
	gpe_fds
[2];

491 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

492 
	g»ad_fd
 = 
pe_fds
[0];

493 
	gwr™e_fd
 = 
pe_fds
[1];

494 
EXPECT_THAT
(
»ad_fd
, 
Ge
(0));

495 
EXPECT_THAT
(
wr™e_fd
, 
Ge
(0));

496 
EXPECT_THAT
(
»ad_fd
, 
Ne
(
wr™e_fd
));

498 
ASSERT_THAT
(
şo£
(
»ad_fd
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

499 
ASSERT_THAT
(
şo£
(
wr™e_fd
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

504 
TEST_F
(
PeTe¡
, 
Wr™eFdOnODœeùPeHasODœeùFÏgS‘
) {

505 
	gpe_fds
[2];

506 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

507 
	g»ad_fd
 = 
pe_fds
[0];

508 
	gwr™e_fd
 = 
pe_fds
[1];

509 
CËªup
 
şo£_»ad
(

510 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

511 
CËªup
 
şo£_wr™e
(

512 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

514 
	gfd_æags
 = 
fú
(
wr™e_fd
, 
F_GETFL
, 0);

515 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

516 
EXPECT_TRUE
(
fd_æags
 & 
O_DIRECT
);

521 
TEST_F
(
PeTe¡
, 
Sm®lWr™esToODœeùPesSucûedAndWr™eAÎD©a
) {

522 
	gpe_fds
[2];

523 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

524 
	g»ad_fd
 = 
pe_fds
[0];

525 
	gwr™e_fd
 = 
pe_fds
[1];

526 
CËªup
 
şo£_»ad
(

527 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

528 
CËªup
 
şo£_wr™e
(

529 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

531 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()),

532 
Eq
(
sm®l_d©a_
.
size
()))

533 << 
¡»¼Ü
(
”ºo
);

538 
TEST_F
(
PeTe¡
, 
MediumWr™esToODœeùPesSucûedAndWr™eAÎD©a
) {

539 
	gpe_fds
[2];

540 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

541 
	g»ad_fd
 = 
pe_fds
[0];

542 
	gwr™e_fd
 = 
pe_fds
[1];

543 
CËªup
 
şo£_»ad
(

544 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

545 
CËªup
 
şo£_wr™e
(

546 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

548 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

549 
Eq
(
medium_d©a_
.
size
()))

550 << 
¡»¼Ü
(
”ºo
);

555 
TEST_F
(
PeTe¡
, 
L¬geWr™esToODœeùPesSucûedAndWr™eOÆyPeBufBy‹s
) {

556 
	gpe_fds
[2];

557 
ASSERT_EQ
(
pe2
(
pe_fds
, 
O_DIRECT
 | 
O_NONBLOCK
), 0è<< 
¡»¼Ü
(
”ºo
);

558 
	g»ad_fd
 = 
pe_fds
[0];

559 
	gwr™e_fd
 = 
pe_fds
[1];

560 
CËªup
 
şo£_»ad
(

561 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

562 
CËªup
 
şo£_wr™e
(

563 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

565 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
Ïrge_d©a_
.
d©a
(),†¬ge_d©a_.
size
()),

566 
Eq
(
kDeçuÉPeSize
))

567 << 
¡»¼Ü
(
”ºo
);

572 
TEST_F
(
PeTe¡
, 
Sm®lR—dsFromODœeùPesSucûedAndDisÿrdRe¡OfPack‘
) {

573 
	gpe_fds
[2];

574 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

575 
	g»ad_fd
 = 
pe_fds
[0];

576 
	gwr™e_fd
 = 
pe_fds
[1];

577 
CËªup
 
şo£_»ad
(

578 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

579 
CËªup
 
şo£_wr™e
(

580 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

582 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

583 
Eq
(
PIPE_BUF
))

584 << 
¡»¼Ü
(
”ºo
);

585 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

586 
Eq
(
PIPE_BUF
))

587 << 
¡»¼Ü
(
”ºo
);

589 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
PIPE_BUF
 / 2);

591 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
PIPE_BUF
 / 2), 
Eq
(PIPE_BUF / 2));

592 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
 / 2));

594 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
PIPE_BUF
 / 2), 
Eq
(PIPE_BUF / 2));

595 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
 / 2));

599 
TEST_F
(
PeTe¡
, 
PeBufSizedR—dsFromODœeùPesSucûed
) {

600 
	gpe_fds
[2];

601 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

602 
	g»ad_fd
 = 
pe_fds
[0];

603 
	gwr™e_fd
 = 
pe_fds
[1];

604 
CËªup
 
şo£_»ad
(

605 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

606 
CËªup
 
şo£_wr™e
(

607 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

609 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

610 
Eq
(
PIPE_BUF
))

611 << 
¡»¼Ü
(
”ºo
);

613 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
PIPE_BUF
);

615 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(), 
PIPE_BUF
), 
Eq
(PIPE_BUF));

616 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
));

621 
TEST_F
(
PeTe¡
, 
L¬geR—dsFromODœeùPesSucûedButOÆyR—dPeBufBy‹s
) {

622 
	gpe_fds
[2];

623 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_DIRECT
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

624 
	g»ad_fd
 = 
pe_fds
[0];

625 
	gwr™e_fd
 = 
pe_fds
[1];

626 
CËªup
 
şo£_»ad
(

627 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

628 
CËªup
 
şo£_wr™e
(

629 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

631 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

632 
Eq
(
PIPE_BUF
))

633 << 
¡»¼Ü
(
”ºo
);

634 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
·ck‘_d©a_
.
d©a
(),…ack‘_d©a_.
size
()),

635 
Eq
(
PIPE_BUF
))

636 << 
¡»¼Ü
(
”ºo
);

638 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

640 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
()), 
Eq
(
PIPE_BUF
));

641 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
·ck‘_d©a_
.d©a(), 
PIPE_BUF
));

645 
TEST_F
(
PeTe¡
, 
NÚBlockšgPesHaveONÚblockFeStusFÏg
) {

646 
	gpe_fds
[2];

647 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

648 
	g»ad_fd
 = 
pe_fds
[0];

649 
	gwr™e_fd
 = 
pe_fds
[1];

650 
CËªup
 
şo£_»ad
(

651 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

652 
CËªup
 
şo£_wr™e
(

653 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

655 
	gfd_æags
 = 
fú
(
»ad_fd
, 
F_GETFL
, 0);

656 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

657 
EXPECT_TRUE
(
fd_æags
 & 
O_NONBLOCK
);

659 
	gfd_æags
 = 
fú
(
wr™e_fd
, 
F_GETFL
, 0);

660 
ASSERT_THAT
(
fd_æags
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

661 
EXPECT_TRUE
(
fd_æags
 & 
O_NONBLOCK
);

665 
TEST_F
(
PeTe¡
, 
MediumWr™esToNÚBlockšgPesSucûed
) {

666 
	gpe_fds
[2];

667 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

668 
	g»ad_fd
 = 
pe_fds
[0];

669 
	gwr™e_fd
 = 
pe_fds
[1];

670 
CËªup
 
şo£_»ad
(

671 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

672 
CËªup
 
şo£_wr™e
(

673 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

675 
EXPECT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

676 
Eq
(
medium_d©a_
.
size
()))

677 << 
¡»¼Ü
(
”ºo
);

681 
TEST_F
(
PeTe¡
, 
L¬geWr™esToNÚBlockšgPesFaW™hEAgaš
) {

682 
	gpe_fds
[2];

683 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

684 
	g»ad_fd
 = 
pe_fds
[0];

685 
	gwr™e_fd
 = 
pe_fds
[1];

686 
CËªup
 
şo£_»ad
(

687 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

688 
CËªup
 
şo£_wr™e
(

689 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

691 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

692 
Eq
(
medium_d©a_
.
size
()))

693 << 
¡»¼Ü
(
”ºo
);

695 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Eq
(-1));

696 
EXPECT_THAT
(
”ºo
, 
Eq
(
EAGAIN
));

700 
TEST_F
(
PeTe¡
, 
R—dsFromEm±yNÚBlockšgPesFaW™hEAgaš
) {

701 
	gpe_fds
[2];

702 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

703 
	g»ad_fd
 = 
pe_fds
[0];

704 
	gwr™e_fd
 = 
pe_fds
[1];

705 
CËªup
 
şo£_»ad
(

706 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

707 
CËªup
 
şo£_wr™e
(

708 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

710 
ušt8_t
 
	g»ad_v®
;

711 
ASSERT_THAT
(
»ad
(
»ad_fd
, &
»ad_v®
, 1), 
Eq
(-1));

712 
EXPECT_THAT
(
”ºo
, 
Eq
(
EAGAIN
));

716 
TEST_F
(
PeTe¡
, 
MediumR—dsFromFuÎNÚBlockšgPesSucûed
) {

717 
	gpe_fds
[2];

718 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

719 
	g»ad_fd
 = 
pe_fds
[0];

720 
	gwr™e_fd
 = 
pe_fds
[1];

721 
CËªup
 
şo£_»ad
(

722 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

723 
CËªup
 
şo£_wr™e
(

724 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

726 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

727 
Eq
(
medium_d©a_
.
size
()))

728 << 
¡»¼Ü
(
”ºo
);

730 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
medium_d©a_
.
size
());

732 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
()),

733 
Eq
(
»ad_buf
.
size
()))

734 << 
¡»¼Ü
(
”ºo
);

735 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), medium_d©a_.
size
()));

739 
TEST_F
(
PeTe¡
, 
L¬geR—dsFromFuÎNÚBlockšgPesSucûed
) {

740 
	gpe_fds
[2];

741 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

742 
	g»ad_fd
 = 
pe_fds
[0];

743 
	gwr™e_fd
 = 
pe_fds
[1];

744 
CËªup
 
şo£_»ad
(

745 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

746 
CËªup
 
şo£_wr™e
(

747 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

749 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

750 
Eq
(
medium_d©a_
.
size
()))

751 << 
¡»¼Ü
(
”ºo
);

753 
	g¡d
::
veùÜ
<
ušt8_t
> 
»ad_buf
(
Ïrge_d©a_
.
size
());

755 
ASSERT_THAT
(
»ad
(
»ad_fd
, 
»ad_buf
.
d©a
(),„—d_buf.
size
()),

756 
Eq
(
medium_d©a_
.
size
()))

757 << 
¡»¼Ü
(
”ºo
);

758 
EXPECT_THAT
(
»ad_buf
.
d©a
(), 
MemEq
(
medium_d©a_
.d©a(), medium_d©a_.
size
()));

762 
TEST_F
(
PeTe¡
, 
FúFS‘peSzChªgesPeSize
) {

763 
	gpe_fds
[2];

764 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

765 
	g»ad_fd
 = 
pe_fds
[0];

766 
	gwr™e_fd
 = 
pe_fds
[1];

767 
CËªup
 
şo£_»ad
(

768 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

769 
CËªup
 
şo£_wr™e
(

770 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

772 
	gpe_size
 = 
fú
(
wr™e_fd
, 
F_GETPIPE_SZ
, 0);

773 
ASSERT_THAT
(
pe_size
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

774 
EXPECT_THAT
(
pe_size
, 
Eq
(
kDeçuÉPeSize
));

776 
ASSERT_THAT
(
fú
(
wr™e_fd
, 
F_SETPIPE_SZ
, 
kSm®lPeSize
), 
Eq
(kSmallPipeSize))

777 << 
¡»¼Ü
(
”ºo
);

779 
	gpe_size
 = 
fú
(
wr™e_fd
, 
F_GETPIPE_SZ
, 0);

780 
ASSERT_THAT
(
pe_size
, 
Ne
(-1)è<< 
¡»¼Ü
(
”ºo
);

781 
EXPECT_THAT
(
pe_size
, 
Eq
(
kSm®lPeSize
));

786 
TEST_F
(
PeTe¡
, 
ResizedPesHaveSm®ËrC­ac™y
) {

787 
	gpe_fds
[2];

788 
ASSERT_THAT
(
pe2
(
pe_fds
, 
O_NONBLOCK
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

789 
	g»ad_fd
 = 
pe_fds
[0];

790 
	gwr™e_fd
 = 
pe_fds
[1];

791 
CËªup
 
şo£_»ad
(

792 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

793 
CËªup
 
şo£_wr™e
(

794 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

796 
ASSERT_THAT
(
fú
(
wr™e_fd
, 
F_SETPIPE_SZ
, 
kSm®lPeSize
), 
Eq
(kSmallPipeSize))

797 << 
¡»¼Ü
(
”ºo
);

799 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), 
kSm®lPeSize
),

800 
Eq
(
kSm®lPeSize
))

801 << 
¡»¼Ü
(
”ºo
);

802 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
sm®l_d©a_
.
d©a
(), sm®l_d©a_.
size
()), 
Eq
(-1));

803 
EXPECT_THAT
(
”ºo
, 
Eq
(
EAGAIN
));

808 
TEST_F
(
PeTe¡
, 
FúCªnÙShrškPeB–owCu¼’yH–dBy‹s
) {

809 
	gpe_fds
[2];

810 
ASSERT_THAT
(
pe
(
pe_fds
), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
);

811 
	g»ad_fd
 = 
pe_fds
[0];

812 
	gwr™e_fd
 = 
pe_fds
[1];

813 
CËªup
 
şo£_»ad
(

814 [
»ad_fd
] { 
ASSERT_THAT
(
şo£
Ô—d_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

815 
CËªup
 
şo£_wr™e
(

816 [
wr™e_fd
] { 
ASSERT_THAT
(
şo£
(wr™e_fd), 
Eq
(0)è<< 
¡»¼Ü
(
”ºo
); });

818 
ASSERT_THAT
(
wr™e
(
wr™e_fd
, 
medium_d©a_
.
d©a
(), medium_d©a_.
size
()),

819 
Eq
(
medium_d©a_
.
size
()))

820 << 
¡»¼Ü
(
”ºo
);

822 
ASSERT_THAT
(
fú
(
wr™e_fd
, 
F_SETPIPE_SZ
, 
kSm®lPeSize
), 
Eq
(-1));

823 
EXPECT_THAT
(
”ºo
, 
Eq
(
EBUSY
));

	@platform/posix/poll.cc

19 
	~<pŞl.h
>

21 
	~<sys/£Ëù.h
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

27 
usšg
 
	gasylo
::
io
::
IOMªag”
;

31 
pŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
) {

32  
IOMªag”
::
G‘In¡ªû
().
PŞl
(
fds
, 
nfds
, 
timeout
);

	@platform/posix/poll.cc

19 
	~<pŞl.h
>

21 
	~<sys/£Ëù.h
>

22 
	~<c¡dlib
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

27 
usšg
 
	gasylo
::
io
::
IOMªag”
;

31 
pŞl
(
pŞlfd
 *
fds
, 
nfds_t
 
nfds
, 
timeout
) {

32  
IOMªag”
::
G‘In¡ªû
().
PŞl
(
fds
, 
nfds
, 
timeout
);

	@platform/posix/pthread.cc

19 
	~<±h»ad.h
>

21 
	~<sigÇl.h
>

22 
	~<û¼no
>

23 
	~<c¡dio
>

24 
	~<c¡dlib
>

25 
	~<funùiÚ®
>

26 
	~<ty³_Œa™s
>

27 
	~<¬¿y
>

28 
	~<b™£t
>

30 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

31 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

32 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

33 
	~"asylo/¶©fÜm/posix/šşude/£m­hÜe.h
"

34 
	~"asylo/¶©fÜm/posix/±h»ad_im¶.h
"

35 
	~"asylo/¶©fÜm/posix/th»adšg/th»ad_mªag”.h
"

36 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

37 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

39 
	gÇme¥aû
 {

41 
šlše
 
IÁ”lockedExchªge
(
±h»ad_¥šlock_t
 *
de¡
,

42 
±h»ad_¥šlock_t
 
Şd_v®ue
,

43 
±h»ad_¥šlock_t
 
Ãw_v®ue
) {

44  
__sync_v®_com·»_ªd_sw­
(
de¡
, 
Şd_v®ue
, 
Ãw_v®ue
);

47 
cÚ¡ex´
 
size_t
 
	gPTHREAD_KEYS_MAX
 = 64;

48 
th»ad_loÿl
 
	g¡d
::
¬¿y
<const *,

49 
	gPTHREAD_KEYS_MAX
> 
	gth»ad_¥ecific
 = {
nuÎ±r
};

51 
±h»ad_mu‹x_t
 
	gu£d_th»ad_keys_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

52 
	g¡d
::
b™£t
<
PTHREAD_KEYS_MAX
> 
u£d_th»ad_keys
;

54 
šlše
 
±h»ad_¥š_lock
(
±h»ad_¥šlock_t
 *
lock
) {

55 
IÁ”lockedExchªge
(
lock
, 0, 1) != 0) {

56 *
lock
) {

57 
’c_·u£
();

63 
šlše
 
±h»ad_¥š_uÆock
(
±h»ad_¥šlock_t
 *
lock
) {

64 *
	glock
 = 0;

71 şas 
	cLockabËGu¬d
 {

72 
	gpublic
:

73 
‹m¶©e
 <
şass
 
LockabËTy³
>

74 
LockabËGu¬d
(
LockabËTy³
 *
lockabË
è: LockabËGu¬d(&lockabË->
_lock
) {}

78 
LockabËGu¬d
(
±h»ad_¥šlock_t
 *
lock
è: 
lock_
(lock) {

79 
±h»ad_¥š_lock
(
lock_
);

82 ~
LockabËGu¬d
(è{ 
±h»ad_¥š_uÆock
(
lock_
); }

84 
Lock
(è{ 
±h»ad_¥š_lock
(
lock_
); }

86 
UÆock
(è{ 
±h»ad_¥š_uÆock
(
lock_
); }

88 
	g´iv©e
:

89 
±h»ad_¥šlock_t
 *cÚ¡ 
lock_
;

92 
__±h»ad_li¡_node_t
 *
	$®loc_li¡_node
(
±h»ad_t
 
th»ad_id
) {

93 
__±h»ad_li¡_node_t
 *
node
 = 
Ãw
 __pthread_list_node_t;

94 
node
->
_th»ad_id
 = 
th»ad_id
;

95 
node
->
_Ãxt
 = 
nuÎ±r
;

96  
node
;

97 
	}
}

99 
	$ä“_li¡_node
(
__±h»ad_li¡_node_t
 *
node
è{ 
d–‘e
‚ode; 
	}
}

101 
	$±h»ad_mu‹x_check_·¿m‘”
(
±h»ad_mu‹x_t
 *
mu‹x
) {

102 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

103  
EFAULT
;

106 ià(
mu‹x
->
_cÚŒŞ
 !ğ
PTHREAD_MUTEX_RECURSIVE
 &&

107 
mu‹x
->
_cÚŒŞ
 !ğ
PTHREAD_MUTEX_NONRECURSIVE
) {

108  
EINVAL
;

111 
	}
}

115 
	$±h»ad_mu‹x_lock_š‹º®
(
±h»ad_mu‹x_t
 *
mu‹x
) {

116 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

118 ià(
mu‹x
->
_cÚŒŞ
 =ğ
PTHREAD_MUTEX_RECURSIVE
 && mu‹x->
_owÃr
 =ğ
£lf
) {

119 
mu‹x
->
_»fcouÁ
++;

123 ià(
mu‹x
->
_owÃr
 !ğ
PTHREAD_T_NULL
) {

124  
EBUSY
;

127 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`li¡
(
mu‹x
);

128 ià(
li¡
.
	`Em±y
(è||†i¡.
	`FrÚt
(è=ğ
£lf
) {

129 
li¡
.
	`Dequeue
();

130 
mu‹x
->
_owÃr
 = 
£lf
;

131 
mu‹x
->
_»fcouÁ
++;

136  
EBUSY
;

137 
	}
}

144 
	$±h»ad_rwlock_Œyrdlock_š‹º®
(
±h»ad_rwlock_t
 *
rwlock
) {

146 ià(
rwlock
->
_wr™e_owÃr
 !ğ
PTHREAD_T_NULL
) {

147  
EBUSY
;

150 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`queue
(
rwlock
);

151 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

155 ià(
queue
.
	`Em±y
(è|| queue.
	`FrÚt
(è=ğ
£lf
) {

156 
queue
.
	`Dequeue
();

157 
rwlock
->
_»ad”_couÁ
++;

162  
EBUSY
;

163 
	}
}

170 
	$±h»ad_rwlock_Œyw¾ock_š‹º®
(
±h»ad_rwlock_t
 *
rwlock
) {

172 ià(
rwlock
->
_»ad”_couÁ
 != 0) {

173  
EBUSY
;

177 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

178 ià(
rwlock
->
_wr™e_owÃr
 =ğ
£lf
) {

179  
EDEADLK
;

183 ià(
rwlock
->
_wr™e_owÃr
 !ğ
PTHREAD_T_NULL
) {

184  
EBUSY
;

189 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`queue
(
rwlock
);

190 ià(
queue
.
	`Em±y
(è|| queue.
	`FrÚt
(è=ğ
£lf
) {

191 
queue
.
	`Dequeue
();

192 
rwlock
->
_wr™e_owÃr
 = 
£lf
;

197  
EBUSY
;

198 
	}
}

205 
	$CÚv”tToE¼no
(
”r_v®ue
) {

206 ià(
”r_v®ue
 == 0) {

210 
”ºo
 = 
”r_v®ue
;

212 
	}
}

215 
	gasylo
::
Th»adMªag”
::
Th»adO±iÚs
 
	$C»©eO±iÚs
(

216 cÚ¡ 
±h»ad_©Œ_t
 *cÚ¡ 
©Œ
) {

217 
asylo
::
Th»adMªag”
::
Th»adO±iÚs
 
İtiÚs
;

219 ià(
©Œ
 !ğ
nuÎ±r
 &&‡‰r->
d‘ach_¡©e
 =ğ
PTHREAD_CREATE_DETACHED
) {

220 
İtiÚs
.
d‘ached
 = 
Œue
;

223  
İtiÚs
;

224 
	}
}

229 
	g‹m¶©e
 <(
TryLockFunc
)(
±h»ad_rwlock_t
 *)>

230 
	$±h»ad_rwlock_lock
(
±h»ad_rwlock_t
 *
rwlock
) {

231 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

232  
	`CÚv”tToE¼no
(
EFAULT
);

235 
LockabËGu¬d
 
	`lock_gu¬d
(
rwlock
);

236 
»t
 = 
	`TryLockFunc
(
rwlock
);

237 ià(
»t
 == 0) {

241 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

242 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`queue
(
rwlock
);

243 ià(
queue
.
	`CÚšs
(
£lf
)) {

244  
EDEADLK
;

246 
queue
.
	`Enqueue
(
£lf
);

248 
»t
 =ğ
EBUSY
) {

249 
lock_gu¬d
.
	`UÆock
();

250 
	`’c_uÁru¡ed_sched_y›ld
();

251 
lock_gu¬d
.
	`Lock
();

253 
»t
 = 
	`TryLockFunc
(
rwlock
);

256  
»t
;

257 
	}
}

261 
Çme¥aû
 
	gasylo
 {

262 
Çme¥aû
 
	g±h»ad_im¶
 {

264 
	gQueueO³¿tiÚs
::
QueueO³¿tiÚs
(
__±h»ad_li¡_t
 *
li¡
è: 
li¡_
(list) {

265 ià(
li¡_
 =ğ
nuÎ±r
) {

266 
abÜt
();

270 
	gQueueO³¿tiÚs
::
Dequeue
() {

271 ià(
li¡_
->
_fœ¡
 =ğ
nuÎ±r
) {

275 
__±h»ad_li¡_node_t
 *
	gŞd_fœ¡
 = 
li¡_
->
_fœ¡
;

276 
	gli¡_
->
	g_fœ¡
 = 
Şd_fœ¡
->
_Ãxt
;

277 
ä“_li¡_node
(
Şd_fœ¡
);

280 
±h»ad_t
 
	gQueueO³¿tiÚs
::
FrÚt
() const {

281 ià(
li¡_
->
_fœ¡
 =ğ
nuÎ±r
) {

282  
PTHREAD_T_NULL
;

284  
	gli¡_
->
	g_fœ¡
->
	g_th»ad_id
;

287 
	gQueueO³¿tiÚs
::
Enqueue
(cÚ¡ 
±h»ad_t
 
id
) {

288 
__±h»ad_li¡_node_t
 *
Ï¡
 = 
®loc_li¡_node
(
id
);

290 ià(!
	gli¡_
->
	g_fœ¡
) {

291 
	gli¡_
->
	g_fœ¡
 = 
Ï¡
;

295 
__±h»ad_li¡_node_t
 *
	gcu¼’t
 = 
li¡_
->
_fœ¡
;

296 
	gcu¼’t
->
	g_Ãxt
) {

297 
	gcu¼’t
 = 
cu¼’t
->
_Ãxt
;

299 
	gcu¼’t
->
	g_Ãxt
 = 
Ï¡
;

302 
boŞ
 
	gQueueO³¿tiÚs
::
Remove
(cÚ¡ 
±h»ad_t
 
id
) {

303 
__±h»ad_li¡_node_t
 *
cu¼
, *
	g´ev
;

305 
	gcu¼
 = 
li¡_
->
_fœ¡
, 
	g´ev
 = 
nuÎ±r
; curr !=‚ullptr;

306 
	g´ev
 = 
cu¼
, 
	gcu¼
 = cu¼->
_Ãxt
) {

307 ià(
cu¼
->
_th»ad_id
 =ğ
id
) {

308 ià(
´ev
 =ğ
nuÎ±r
) {

310 
li¡_
->
_fœ¡
 = 
cu¼
->
_Ãxt
;

313 
	g´ev
->
	g_Ãxt
 = 
cu¼
->
_Ãxt
;

316 
ä“_li¡_node
(
cu¼
);

317  
	gŒue
;

321  
	gçl£
;

324 
boŞ
 
	gQueueO³¿tiÚs
::
CÚšs
(cÚ¡ 
±h»ad_t
 
id
) const {

325 
__±h»ad_li¡_node_t
 *
cu¼’t
 = 
li¡_
->
_fœ¡
;

326 
	gcu¼’t
) {

327 ià(
	gcu¼’t
->
	g_th»ad_id
 =ğ
id
) {

328  
Œue
;

330 
	gcu¼’t
 = 
cu¼’t
->
_Ãxt
;

332  
	gçl£
;

335 
	gQueueO³¿tiÚs
::
CË¬
() {

336 !
Em±y
()) {

337 
Dequeue
();

341 
boŞ
 
	gQueueO³¿tiÚs
::
Em±y
() const {

342 cÚ¡ 
__±h»ad_li¡_node_t
 *
cu¼’t
 = 
li¡_
->
_fœ¡
;

343  
	gcu¼’t
 =ğ
PTHREAD_T_NULL
;

353 
±h»ad_t
 
±h»ad_£lf
() {

354 
¡©ic_as£¹
((
±h»ad_t
è=ğ(
ušt64_t
) &&

355 (
¡d
::
is_poš‹r
<
±h»ad_t
>::
v®ue
 ||

356 
¡d
::
is_š‹g¿l
<
±h»ad_t
>::
v®ue
),

358  
¡©ic_ÿ¡
<
±h»ad_t
>(
’c_th»ad_£lf
());

361 
±h»ad_ü—‹
(
±h»ad_t
 *
th»ad
, cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
,

362 *(*
¡¬t_routše
)(*), *
¬g
) {

363 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

364 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

365  
th»ad_mªag”
->
C»©eTh»ad
(
¡d
::
bšd
(
¡¬t_routše
, 
¬g
),

366 
C»©eO±iÚs
(
©Œ
), 
th»ad
);

369 
±h»ad_još
(
±h»ad_t
 
th»ad
, **
v®ue_±r
) {

370 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

371 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

372  
th»ad_mªag”
->
JošTh»ad
(
th»ad
, 
v®ue_±r
);

375 
±h»ad_d‘ach
(
±h»ad_t
 
th»ad
) {

376 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

377 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

378  
th»ad_mªag”
->
D‘achTh»ad
(
th»ad
);

381 
boŞ
 
assign_key
(
±h»ad_key_t
 *
key
) {

382 
boŞ
 
»t
 = 
çl£
;

383 
±h»ad_key_t
 
Ãxt_key
;

384 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
u£d_th»ad_keys_lock
);

385 
Ãxt_key
 = 0;‚ext_key < 
PTHREAD_KEYS_MAX
;‚ext_key++) {

386 ià(!
u£d_th»ad_keys
[
Ãxt_key
]) {

387 
u£d_th»ad_keys
[
Ãxt_key
] = 
Œue
;

388 *
key
 = 
Ãxt_key
;

389 
»t
 = 
Œue
;

393  
»t
;

396 
±h»ad_key_ü—‹
(
±h»ad_key_t
 *
key
, (*
de¡ruùÜ
)(*)) {

397 ià(!
assign_key
(
key
)) {

399  
EAGAIN
;

404 
±h»ad_key_d–‘e
(
±h»ad_key_t
 
key
) {

405 ià(
key
 > 
PTHREAD_KEYS_MAX
) {

406  
EINVAL
;

408 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
u£d_th»ad_keys_lock
);

409 
u£d_th»ad_keys
[
key
] = 
çl£
;

413 *
±h»ad_g‘¥ecific
(
±h»ad_key_t
 
key
) {

416 ià(
key
 >ğ
PTHREAD_KEYS_MAX
) {

417  
nuÎ±r
;

422  
cÚ¡_ÿ¡
<*>(
th»ad_¥ecific
[
key
]);

425 
±h»ad_£t¥ecific
(
±h»ad_key_t
 
key
, cÚ¡ *
v®ue
) {

428 ià(
key
 >ğ
PTHREAD_KEYS_MAX
) {

429  
EINVAL
;

432 
th»ad_¥ecific
[
key
] = 
v®ue
;

436 
±h»ad_mu‹x_š™
(
±h»ad_mu‹x_t
 *
mu‹x
,

437 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
©Œ
) {

438 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

439  
EFAULT
;

442 *
mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

447 
±h»ad_mu‹x_de¡roy
(
±h»ad_mu‹x_t
 *
mu‹x
) {

448 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

449  
EFAULT
;

452 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

453 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
mu‹x
);

454 ià(!
li¡
.
Em±y
()) {

455  
EBUSY
;

462 
±h»ad_mu‹x_lock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

463 
»t
 = 
±h»ad_mu‹x_check_·¿m‘”
(
mu‹x
);

464 ià(
»t
 != 0) {

465  
»t
;

468 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
mu‹x
);

470 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

471 
li¡
.
Enqueue
(
±h»ad_£lf
());

474 
Œue
) {

476 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

477 
»t
 = 
±h»ad_mu‹x_lock_š‹º®
(
mu‹x
);

479 ià(
»t
 == 0) {

480  
»t
;

483 
’c_uÁru¡ed_sched_y›ld
();

487 
±h»ad_mu‹x_Œylock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

488 
»t
 = 
±h»ad_mu‹x_check_·¿m‘”
(
mu‹x
);

489 ià(
»t
 != 0) {

490  
»t
;

493 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

494 
»t
 = 
±h»ad_mu‹x_lock_š‹º®
(
mu‹x
);

496  
»t
;

500 
±h»ad_mu‹x_uÆock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

501 
»t
 = 
±h»ad_mu‹x_check_·¿m‘”
(
mu‹x
);

502 ià(
»t
 != 0) {

503  
»t
;

506 cÚ¡ 
±h»ad_t
 
£lf
 = 
±h»ad_£lf
();

508 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

510 ià(
mu‹x
->
_owÃr
 =ğ
PTHREAD_T_NULL
) {

511  
EINVAL
;

514 ià(
mu‹x
->
_owÃr
 !ğ
£lf
) {

515  
EPERM
;

518 
mu‹x
->
_»fcouÁ
--;

519 ià(
mu‹x
->
_»fcouÁ
 == 0) {

520 
mu‹x
->
_owÃr
 = 
PTHREAD_T_NULL
;

527 
±h»ad_Úû
(
±h»ad_Úû_t
 *
Úû
, (*
š™_routše
)()) {

528 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
Úû
->
_mu‹x
);

529 ià(!
Úû
->
_¿n
) {

530 
š™_routše
();

531 
Úû
->
_¿n
 = 
Œue
;

537 
±h»ad_cÚd_š™
(
±h»ad_cÚd_t
 *
cÚd
, cÚ¡ 
±h»ad_cÚd©Œ_t
 *
©Œ
) {

538 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

539  
EFAULT
;

542 *
cÚd
 = 
PTHREAD_COND_INITIALIZER
;

547 
±h»ad_cÚd_de¡roy
(
±h»ad_cÚd_t
 *
cÚd
) {

548 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

549  
EFAULT
;

552 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

553 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

554 ià(!
li¡
.
Em±y
()) {

555  
EBUSY
;

570 
±h»ad_cÚd_timedwa™
(
±h»ad_cÚd_t
 *
cÚd
, 
±h»ad_mu‹x_t
 *
mu‹x
,

571 cÚ¡ 
time¥ec
 *
d—dlše
) {

572 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
) ||

573 !
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

574  
EFAULT
;

578 ià(
d—dlše
 !ğ
nuÎ±r
 &&

579 !
asylo
::
IsV®idEnşaveAdd»ss
<
time¥ec
>(
d—dlše
)) {

580  
EFAULT
;

583 cÚ¡ 
±h»ad_t
 
£lf
 = 
±h»ad_£lf
();

585 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

587 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

588 
li¡
.
Enqueue
(
£lf
);

591 
»t
 = 
±h»ad_mu‹x_uÆock
(
mu‹x
);

592 ià(
»t
 != 0) {

593  
»t
;

596 
Œue
) {

597 
’c_uÁru¡ed_sched_y›ld
();

600 ià(
d—dlše
 !ğ
nuÎ±r
) {

601 
time¥ec
 
cu¼_time
;

602 
»t
 = 
şock_g‘time
(
CLOCK_REALTIME
, &
cu¼_time
);

603 ià(
»t
 != 0) {

608 
time¥ec
 
time_Ëá
;

609 ià(
asylo
::
TimeS³cSubŒaù
(*
d—dlše
, 
cu¼_time
, &
time_Ëá
)) {

610 
»t
 = 
ETIMEDOUT
;

615 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

616 ià(!
li¡
.
CÚšs
(
£lf
)) {

621 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

622 
li¡
.
Remove
(
£lf
);

629 
»lock_»t
 = 
±h»ad_mu‹x_lock
(
mu‹x
);

630 ià(
»t
 != 0) {

631  
»t
;

633  
»lock_»t
;

638 
±h»ad_cÚd_wa™
(
±h»ad_cÚd_t
 *
cÚd
, 
±h»ad_mu‹x_t
 *
mu‹x
) {

639  
±h»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, 
nuÎ±r
);

642 
±h»ad_cÚd©Œ_š™
(
±h»ad_cÚd©Œ_t
 *
©Œ
) {  0; }

644 
±h»ad_cÚd©Œ_de¡roy
(
±h»ad_cÚd©Œ_t
 *
©Œ
) {  0; }

647 
±h»ad_cÚd_sigÇl
(
±h»ad_cÚd_t
 *
cÚd
) {

648 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

649  
EFAULT
;

652 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

653 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

654 ià(
li¡
.
Em±y
()) {

658 
li¡
.
Dequeue
();

664 
±h»ad_cÚd_brßdÿ¡
(
±h»ad_cÚd_t
 *
cÚd
) {

665 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

666  
EFAULT
;

669 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

671 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

672 
li¡
.
CË¬
();

680 
£m_š™
(
£m_t
 *
£m
, cÚ¡ 
psh¬ed
, cÚ¡ 
v®ue
) {

681 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

682  
CÚv”tToE¼no
(
EFAULT
);

686 ià(
psh¬ed
) {

687  
CÚv”tToE¼no
(
ENOSYS
);

690 
£m
->
couÁ_
 = 
v®ue
;

692 
»t
 = 
±h»ad_mu‹x_š™
(&
£m
->
mu_
, 
nuÎ±r
);

693 ià(
»t
 != 0) {

694  
CÚv”tToE¼no
(
»t
);

697 
»t
 = 
±h»ad_cÚd_š™
(&
£m
->
cv_
, 
nuÎ±r
);

698 ià(
»t
 != 0) {

699  
CÚv”tToE¼no
(
»t
);

706 
£m_g‘v®ue
(
£m_t
 *
£m
, *
sv®
) {

707 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
) ||

708 !
asylo
::
IsV®idEnşaveAdd»ss
<>(
sv®
)) {

709  
CÚv”tToE¼no
(
EFAULT
);

712 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
£m
->
mu_
);

713 *
sv®
 = 
£m
->
couÁ_
;

718 
£m_po¡
(
£m_t
 *
£m
) {

719 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

720  
CÚv”tToE¼no
(
EFAULT
);

723 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
£m
->
mu_
);

724 
£m
->
couÁ_
++;

725  
CÚv”tToE¼no
(
±h»ad_cÚd_sigÇl
(&
£m
->
cv_
));

732 
£m_timedwa™
(
£m_t
 *
£m
, cÚ¡ 
time¥ec
 *
abs_timeout
) {

733 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

734  
CÚv”tToE¼no
(
EFAULT
);

737 ià(
abs_timeout
 !ğ
nuÎ±r
 &&

738 !
asylo
::
IsV®idEnşaveAdd»ss
<
time¥ec
>(
abs_timeout
)) {

739  
CÚv”tToE¼no
(
EFAULT
);

742 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
£m
->
mu_
);

744 
»t
 = 0;

745 
£m
->
couÁ_
 == 0) {

746 
»t
 = 
±h»ad_cÚd_timedwa™
(&
£m
->
cv_
, &£m->
mu_
, 
abs_timeout
);

748 ià(
»t
 != 0) {

755 ià(
»t
 == 0) {

756 
£m
->
couÁ_
--;

762  
CÚv”tToE¼no
(
»t
);

766 
£m_wa™
(
£m_t
 *
£m
è{  
£m_timedwa™
(£m, 
nuÎ±r
); }

768 
£m_Œywa™
(
£m_t
 *
£m
) {

769 
time¥ec
 
d—dlše
 = {0, 0};

770 
»t
 = 
£m_timedwa™
(
£m
, &
d—dlše
);

771 ià(
»t
 !ğ0 && 
”ºo
 =ğ
ETIMEDOUT
) {

772 
”ºo
 = 
EAGAIN
;

775  
»t
;

778 
£m_de¡roy
(
£m_t
 *
£m
) {

779 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

780  
CÚv”tToE¼no
(
EFAULT
);

783 
»t
 = 
±h»ad_cÚd_de¡roy
(&
£m
->
cv_
);

784 ià(
»t
 != 0) {

785  
CÚv”tToE¼no
(
»t
);

788 
»t
 = 
±h»ad_mu‹x_de¡roy
(&
£m
->
mu_
);

789 ià(
»t
 != 0) {

790  
CÚv”tToE¼no
(
»t
);

796 
±h»ad_rwlock_š™
(
±h»ad_rwlock_t
 *
rwlock
,

797 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
©Œ
) {

798 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

799  
CÚv”tToE¼no
(
EFAULT
);

802 *
rwlock
 = 
PTHREAD_RWLOCK_INITIALIZER
;

807 
±h»ad_rwlock_Œyrdlock
(
±h»ad_rwlock_t
 *
rwlock
) {

808 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

809  
CÚv”tToE¼no
(
EFAULT
);

812 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

813  
±h»ad_rwlock_Œyrdlock_š‹º®
(
rwlock
);

816 
±h»ad_rwlock_Œyw¾ock
(
±h»ad_rwlock_t
 *
rwlock
) {

817 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

818  
CÚv”tToE¼no
(
EFAULT
);

821 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

822  
±h»ad_rwlock_Œyw¾ock_š‹º®
(
rwlock
);

825 
±h»ad_rwlock_rdlock
(
±h»ad_rwlock_t
 *
rwlock
) {

826  
±h»ad_rwlock_lock
<
±h»ad_rwlock_Œyrdlock_š‹º®
>(
rwlock
);

829 
±h»ad_rwlock_w¾ock
(
±h»ad_rwlock_t
 *
rwlock
) {

830  
±h»ad_rwlock_lock
<
±h»ad_rwlock_Œyw¾ock_š‹º®
>(
rwlock
);

833 
±h»ad_rwlock_uÆock
(
±h»ad_rwlock_t
 *
rwlock
) {

834 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

835  
CÚv”tToE¼no
(
EFAULT
);

838 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

840 cÚ¡ 
±h»ad_t
 
£lf
 = 
±h»ad_£lf
();

841 ià(
rwlock
->
_wr™e_owÃr
 =ğ
£lf
) {

842 
rwlock
->
_wr™e_owÃr
 = 
PTHREAD_T_NULL
;

846 
rwlock
->
_»ad”_couÁ
--;

850 
±h»ad_rwlock_de¡roy
(
±h»ad_rwlock_t
 *
rwlock
) {

851 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

852  
CÚv”tToE¼no
(
EFAULT
);

855 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

856 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
queue
(
rwlock
);

857 ià(
rwlock
->
_wr™e_owÃr
 =ğ
PTHREAD_T_NULL
 && 
queue
.
Em±y
()) {

861  
EBUSY
;

864 
±h»ad_equ®
(
±h»ad_t
 
th»ad_Úe
,…th»ad_ˆ
th»ad_two
) {

865 ià(
th»ad_Úe
 =ğ
th»ad_two
) {

871 
_±h»ad_ş—nup_push
(
_±h»ad_ş—nup_cÚ‹xt
 *
cÚ‹xt
,

872 (*
routše
)(*), *
¬g
) {

873 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

874 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

875 
th»ad_mªag”
->
PushCËªupRoutše
(
¡d
::
bšd
(
routše
, 
¬g
));

878 
_±h»ad_ş—nup_pİ
(
_±h»ad_ş—nup_cÚ‹xt
 *
cÚ‹xt
,

879 
execu‹
) {

880 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

881 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

882 
th»ad_mªag”
->
PİCËªupRoutše
(
execu‹
 != 0);

885 
±h»ad_mu‹x©Œ_š™
(
±h»ad_mu‹x©Œ_t
 *
mu‹x©Œ
) {  0; }

886 
±h»ad_mu‹x©Œ_de¡roy
(
±h»ad_mu‹x©Œ_t
 *
mu‹x©Œ
) {  0; }

887 
±h»ad_mu‹x©Œ_£‰y³
(
±h»ad_mu‹x©Œ_t
 *
mu‹x©Œ
, 
ty³
) {

891 
±h»ad_©Œ_š™
(
±h»ad_©Œ_t
 *
©Œ
) {

892 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_©Œ_t
>(
©Œ
)) {

893  
CÚv”tToE¼no
(
EFAULT
);

896 
©Œ
->
d‘ach_¡©e
 = 
PTHREAD_CREATE_JOINABLE
;

900 
±h»ad_©Œ_de¡roy
(
±h»ad_©Œ_t
 *
©Œ
) {

901 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_©Œ_t
>(
©Œ
)) {

902  
CÚv”tToE¼no
(
EFAULT
);

907 
±h»ad_©Œ_£td‘ach¡©e
(
±h»ad_©Œ_t
 *
©Œ
, 
ty³
) {

908 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_©Œ_t
>(
©Œ
)) {

909  
CÚv”tToE¼no
(
EFAULT
);

912 ià(
ty³
 !ğ
PTHREAD_CREATE_JOINABLE
 &&y³ !ğ
PTHREAD_CREATE_DETACHED
) {

913  
EINVAL
;

916 
©Œ
->
d‘ach_¡©e
 = 
ty³
;

920 
±h»ad_©Œ_g‘schedpŞicy
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
, *
pŞicy
) {

921  
ENOSYS
;

923 
±h»ad_©Œ_£tschedpŞicy
(
±h»ad_©Œ_t
 *
©Œ
, 
pŞicy
) {

924  
ENOSYS
;

926 
±h»ad_©Œ_g‘scİe
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
, *
scİe
) {

927  
ENOSYS
;

929 
±h»ad_©Œ_£tscİe
(
±h»ad_©Œ_t
 *
©Œ
, 
scİe
è{  
ENOSYS
; }

930 
±h»ad_©Œ_g‘sched·¿m
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
,

931 
sched_·¿m
 *
·¿m
) {

932  
ENOSYS
;

934 
±h»ad_©Œ_£tsched·¿m
(
±h»ad_©Œ_t
 *
©Œ
,

935 cÚ¡ 
sched_·¿m
 *
·¿m
) {

936  
ENOSYS
;

938 
±h»ad_©Œ_g‘¡acksize
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
, 
size_t
 *
¡acksize
) {

939  
ENOSYS
;

941 
±h»ad_©Œ_£t¡acksize
(
±h»ad_©Œ_t
 *
©Œ
, 
size_t
 
¡acksize
) {

942  
ENOSYS
;

945 
±h»ad_ÿnûl
(
±h»ad_t
 
unu£d
è{  
ENOSYS
; }

946 
±h»ad_£tÿnûl¡©e
(
¡©e
, *
Şd¡©e
è{  
ENOSYS
; }

947 
±h»ad_£tÿnûÉy³
(
ty³
, *
Şdty³
è{  
ENOSYS
; }

	@platform/posix/pthread.cc

19 
	~<±h»ad.h
>

21 
	~<sigÇl.h
>

22 
	~<û¼no
>

23 
	~<c¡dio
>

24 
	~<c¡dlib
>

25 
	~<funùiÚ®
>

26 
	~<ty³_Œa™s
>

27 
	~<¬¿y
>

28 
	~<b™£t
>

30 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

31 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

32 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

33 
	~"asylo/¶©fÜm/posix/šşude/£m­hÜe.h
"

34 
	~"asylo/¶©fÜm/posix/±h»ad_im¶.h
"

35 
	~"asylo/¶©fÜm/posix/th»adšg/th»ad_mªag”.h
"

36 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

37 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_memÜy.h
"

39 
	gÇme¥aû
 {

41 
šlše
 
IÁ”lockedExchªge
(
±h»ad_¥šlock_t
 *
de¡
,

42 
±h»ad_¥šlock_t
 
Şd_v®ue
,

43 
±h»ad_¥šlock_t
 
Ãw_v®ue
) {

44  
__sync_v®_com·»_ªd_sw­
(
de¡
, 
Şd_v®ue
, 
Ãw_v®ue
);

47 
cÚ¡ex´
 
size_t
 
	gPTHREAD_KEYS_MAX
 = 64;

48 
th»ad_loÿl
 
	g¡d
::
¬¿y
<const *,

49 
	gPTHREAD_KEYS_MAX
> 
	gth»ad_¥ecific
 = {
nuÎ±r
};

51 
±h»ad_mu‹x_t
 
	gu£d_th»ad_keys_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

52 
	g¡d
::
b™£t
<
PTHREAD_KEYS_MAX
> 
u£d_th»ad_keys
;

54 
šlše
 
±h»ad_¥š_lock
(
±h»ad_¥šlock_t
 *
lock
) {

55 
IÁ”lockedExchªge
(
lock
, 0, 1) != 0) {

56 *
lock
) {

57 
’c_·u£
();

63 
šlše
 
±h»ad_¥š_uÆock
(
±h»ad_¥šlock_t
 *
lock
) {

64 *
	glock
 = 0;

71 şas 
	cLockabËGu¬d
 {

72 
	gpublic
:

73 
‹m¶©e
 <
şass
 
LockabËTy³
>

74 
LockabËGu¬d
(
LockabËTy³
 *
lockabË
è: LockabËGu¬d(&lockabË->
_lock
) {}

78 
LockabËGu¬d
(
±h»ad_¥šlock_t
 *
lock
è: 
lock_
(lock) {

79 
±h»ad_¥š_lock
(
lock_
);

82 ~
LockabËGu¬d
(è{ 
±h»ad_¥š_uÆock
(
lock_
); }

84 
Lock
(è{ 
±h»ad_¥š_lock
(
lock_
); }

86 
UÆock
(è{ 
±h»ad_¥š_uÆock
(
lock_
); }

88 
	g´iv©e
:

89 
±h»ad_¥šlock_t
 *cÚ¡ 
lock_
;

92 
__±h»ad_li¡_node_t
 *
	$®loc_li¡_node
(
±h»ad_t
 
th»ad_id
) {

93 
__±h»ad_li¡_node_t
 *
node
 = 
Ãw
 __pthread_list_node_t;

94 
node
->
_th»ad_id
 = 
th»ad_id
;

95 
node
->
_Ãxt
 = 
nuÎ±r
;

96  
node
;

97 
	}
}

99 
	$ä“_li¡_node
(
__±h»ad_li¡_node_t
 *
node
è{ 
d–‘e
‚ode; 
	}
}

101 
	$±h»ad_mu‹x_check_·¿m‘”
(
±h»ad_mu‹x_t
 *
mu‹x
) {

102 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

103  
EFAULT
;

106 ià(
mu‹x
->
_cÚŒŞ
 !ğ
PTHREAD_MUTEX_RECURSIVE
 &&

107 
mu‹x
->
_cÚŒŞ
 !ğ
PTHREAD_MUTEX_NONRECURSIVE
) {

108  
EINVAL
;

111 
	}
}

115 
	$±h»ad_mu‹x_lock_š‹º®
(
±h»ad_mu‹x_t
 *
mu‹x
) {

116 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

118 ià(
mu‹x
->
_cÚŒŞ
 =ğ
PTHREAD_MUTEX_RECURSIVE
 && mu‹x->
_owÃr
 =ğ
£lf
) {

119 
mu‹x
->
_»fcouÁ
++;

123 ià(
mu‹x
->
_owÃr
 !ğ
PTHREAD_T_NULL
) {

124  
EBUSY
;

127 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`li¡
(
mu‹x
);

128 ià(
li¡
.
	`Em±y
(è||†i¡.
	`FrÚt
(è=ğ
£lf
) {

129 
li¡
.
	`Dequeue
();

130 
mu‹x
->
_owÃr
 = 
£lf
;

131 
mu‹x
->
_»fcouÁ
++;

136  
EBUSY
;

137 
	}
}

144 
	$±h»ad_rwlock_Œyrdlock_š‹º®
(
±h»ad_rwlock_t
 *
rwlock
) {

146 ià(
rwlock
->
_wr™e_owÃr
 !ğ
PTHREAD_T_NULL
) {

147  
EBUSY
;

150 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`queue
(
rwlock
);

151 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

155 ià(
queue
.
	`Em±y
(è|| queue.
	`FrÚt
(è=ğ
£lf
) {

156 
queue
.
	`Dequeue
();

157 
rwlock
->
_»ad”_couÁ
++;

162  
EBUSY
;

163 
	}
}

170 
	$±h»ad_rwlock_Œyw¾ock_š‹º®
(
±h»ad_rwlock_t
 *
rwlock
) {

172 ià(
rwlock
->
_»ad”_couÁ
 != 0) {

173  
EBUSY
;

177 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

178 ià(
rwlock
->
_wr™e_owÃr
 =ğ
£lf
) {

179  
EDEADLK
;

183 ià(
rwlock
->
_wr™e_owÃr
 !ğ
PTHREAD_T_NULL
) {

184  
EBUSY
;

189 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`queue
(
rwlock
);

190 ià(
queue
.
	`Em±y
(è|| queue.
	`FrÚt
(è=ğ
£lf
) {

191 
queue
.
	`Dequeue
();

192 
rwlock
->
_wr™e_owÃr
 = 
£lf
;

197  
EBUSY
;

198 
	}
}

205 
	$CÚv”tToE¼no
(
”r_v®ue
) {

206 ià(
”r_v®ue
 == 0) {

210 
”ºo
 = 
”r_v®ue
;

212 
	}
}

215 
	gasylo
::
Th»adMªag”
::
Th»adO±iÚs
 
	$C»©eO±iÚs
(

216 cÚ¡ 
±h»ad_©Œ_t
 *cÚ¡ 
©Œ
) {

217 
asylo
::
Th»adMªag”
::
Th»adO±iÚs
 
İtiÚs
;

219 ià(
©Œ
 !ğ
nuÎ±r
 &&‡‰r->
d‘ach_¡©e
 =ğ
PTHREAD_CREATE_DETACHED
) {

220 
İtiÚs
.
d‘ached
 = 
Œue
;

223  
İtiÚs
;

224 
	}
}

229 
	g‹m¶©e
 <(
TryLockFunc
)(
±h»ad_rwlock_t
 *)>

230 
	$±h»ad_rwlock_lock
(
±h»ad_rwlock_t
 *
rwlock
) {

231 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

232  
	`CÚv”tToE¼no
(
EFAULT
);

235 
LockabËGu¬d
 
	`lock_gu¬d
(
rwlock
);

236 
»t
 = 
	`TryLockFunc
(
rwlock
);

237 ià(
»t
 == 0) {

241 cÚ¡ 
±h»ad_t
 
£lf
 = 
	`±h»ad_£lf
();

242 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
	`queue
(
rwlock
);

243 ià(
queue
.
	`CÚšs
(
£lf
)) {

244  
EDEADLK
;

246 
queue
.
	`Enqueue
(
£lf
);

248 
»t
 =ğ
EBUSY
) {

249 
lock_gu¬d
.
	`UÆock
();

250 
	`’c_uÁru¡ed_sched_y›ld
();

251 
lock_gu¬d
.
	`Lock
();

253 
»t
 = 
	`TryLockFunc
(
rwlock
);

256  
»t
;

257 
	}
}

261 
Çme¥aû
 
	gasylo
 {

262 
Çme¥aû
 
	g±h»ad_im¶
 {

264 
	gQueueO³¿tiÚs
::
QueueO³¿tiÚs
(
__±h»ad_li¡_t
 *
li¡
è: 
li¡_
(list) {

265 ià(
li¡_
 =ğ
nuÎ±r
) {

266 
abÜt
();

270 
	gQueueO³¿tiÚs
::
Dequeue
() {

271 ià(
li¡_
->
_fœ¡
 =ğ
nuÎ±r
) {

275 
__±h»ad_li¡_node_t
 *
	gŞd_fœ¡
 = 
li¡_
->
_fœ¡
;

276 
	gli¡_
->
	g_fœ¡
 = 
Şd_fœ¡
->
_Ãxt
;

277 
ä“_li¡_node
(
Şd_fœ¡
);

280 
±h»ad_t
 
	gQueueO³¿tiÚs
::
FrÚt
() const {

281 ià(
li¡_
->
_fœ¡
 =ğ
nuÎ±r
) {

282  
PTHREAD_T_NULL
;

284  
	gli¡_
->
	g_fœ¡
->
	g_th»ad_id
;

287 
	gQueueO³¿tiÚs
::
Enqueue
(cÚ¡ 
±h»ad_t
 
id
) {

288 
__±h»ad_li¡_node_t
 *
Ï¡
 = 
®loc_li¡_node
(
id
);

290 ià(!
	gli¡_
->
	g_fœ¡
) {

291 
	gli¡_
->
	g_fœ¡
 = 
Ï¡
;

295 
__±h»ad_li¡_node_t
 *
	gcu¼’t
 = 
li¡_
->
_fœ¡
;

296 
	gcu¼’t
->
	g_Ãxt
) {

297 
	gcu¼’t
 = 
cu¼’t
->
_Ãxt
;

299 
	gcu¼’t
->
	g_Ãxt
 = 
Ï¡
;

302 
boŞ
 
	gQueueO³¿tiÚs
::
Remove
(cÚ¡ 
±h»ad_t
 
id
) {

303 
__±h»ad_li¡_node_t
 *
cu¼
, *
	g´ev
;

305 
	gcu¼
 = 
li¡_
->
_fœ¡
, 
	g´ev
 = 
nuÎ±r
; curr !=‚ullptr;

306 
	g´ev
 = 
cu¼
, 
	gcu¼
 = cu¼->
_Ãxt
) {

307 ià(
cu¼
->
_th»ad_id
 =ğ
id
) {

308 ià(
´ev
 =ğ
nuÎ±r
) {

310 
li¡_
->
_fœ¡
 = 
cu¼
->
_Ãxt
;

313 
	g´ev
->
	g_Ãxt
 = 
cu¼
->
_Ãxt
;

316 
ä“_li¡_node
(
cu¼
);

317  
	gŒue
;

321  
	gçl£
;

324 
boŞ
 
	gQueueO³¿tiÚs
::
CÚšs
(cÚ¡ 
±h»ad_t
 
id
) const {

325 
__±h»ad_li¡_node_t
 *
cu¼’t
 = 
li¡_
->
_fœ¡
;

326 
	gcu¼’t
) {

327 ià(
	gcu¼’t
->
	g_th»ad_id
 =ğ
id
) {

328  
Œue
;

330 
	gcu¼’t
 = 
cu¼’t
->
_Ãxt
;

332  
	gçl£
;

335 
	gQueueO³¿tiÚs
::
CË¬
() {

336 !
Em±y
()) {

337 
Dequeue
();

341 
boŞ
 
	gQueueO³¿tiÚs
::
Em±y
() const {

342 cÚ¡ 
__±h»ad_li¡_node_t
 *
cu¼’t
 = 
li¡_
->
_fœ¡
;

343  
	gcu¼’t
 =ğ
PTHREAD_T_NULL
;

353 
±h»ad_t
 
±h»ad_£lf
() {

354 
¡©ic_as£¹
((
±h»ad_t
è=ğ(
ušt64_t
) &&

355 (
¡d
::
is_poš‹r
<
±h»ad_t
>::
v®ue
 ||

356 
¡d
::
is_š‹g¿l
<
±h»ad_t
>::
v®ue
),

358  
¡©ic_ÿ¡
<
±h»ad_t
>(
’c_th»ad_£lf
());

361 
±h»ad_ü—‹
(
±h»ad_t
 *
th»ad
, cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
,

362 *(*
¡¬t_routše
)(*), *
¬g
) {

363 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

364 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

365  
th»ad_mªag”
->
C»©eTh»ad
(
¡d
::
bšd
(
¡¬t_routše
, 
¬g
),

366 
C»©eO±iÚs
(
©Œ
), 
th»ad
);

369 
±h»ad_još
(
±h»ad_t
 
th»ad
, **
v®ue_±r
) {

370 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

371 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

372  
th»ad_mªag”
->
JošTh»ad
(
th»ad
, 
v®ue_±r
);

375 
±h»ad_d‘ach
(
±h»ad_t
 
th»ad
) {

376 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

377 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

378  
th»ad_mªag”
->
D‘achTh»ad
(
th»ad
);

381 
boŞ
 
assign_key
(
±h»ad_key_t
 *
key
) {

382 
boŞ
 
»t
 = 
çl£
;

383 
±h»ad_key_t
 
Ãxt_key
;

384 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
u£d_th»ad_keys_lock
);

385 
Ãxt_key
 = 0;‚ext_key < 
PTHREAD_KEYS_MAX
;‚ext_key++) {

386 ià(!
u£d_th»ad_keys
[
Ãxt_key
]) {

387 
u£d_th»ad_keys
[
Ãxt_key
] = 
Œue
;

388 *
key
 = 
Ãxt_key
;

389 
»t
 = 
Œue
;

393  
»t
;

396 
±h»ad_key_ü—‹
(
±h»ad_key_t
 *
key
, (*
de¡ruùÜ
)(*)) {

397 ià(!
assign_key
(
key
)) {

399  
EAGAIN
;

404 
±h»ad_key_d–‘e
(
±h»ad_key_t
 
key
) {

405 ià(
key
 > 
PTHREAD_KEYS_MAX
) {

406  
EINVAL
;

408 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
u£d_th»ad_keys_lock
);

409 
u£d_th»ad_keys
[
key
] = 
çl£
;

413 *
±h»ad_g‘¥ecific
(
±h»ad_key_t
 
key
) {

416 ià(
key
 >ğ
PTHREAD_KEYS_MAX
) {

417  
nuÎ±r
;

422  
cÚ¡_ÿ¡
<*>(
th»ad_¥ecific
[
key
]);

425 
±h»ad_£t¥ecific
(
±h»ad_key_t
 
key
, cÚ¡ *
v®ue
) {

428 ià(
key
 >ğ
PTHREAD_KEYS_MAX
) {

429  
EINVAL
;

432 
th»ad_¥ecific
[
key
] = 
v®ue
;

436 
±h»ad_mu‹x_š™
(
±h»ad_mu‹x_t
 *
mu‹x
,

437 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
©Œ
) {

438 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

439  
EFAULT
;

442 *
mu‹x
 = 
PTHREAD_MUTEX_INITIALIZER
;

447 
±h»ad_mu‹x_de¡roy
(
±h»ad_mu‹x_t
 *
mu‹x
) {

448 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

449  
EFAULT
;

452 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

453 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
mu‹x
);

454 ià(!
li¡
.
Em±y
()) {

455  
EBUSY
;

462 
±h»ad_mu‹x_lock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

463 
»t
 = 
±h»ad_mu‹x_check_·¿m‘”
(
mu‹x
);

464 ià(
»t
 != 0) {

465  
»t
;

468 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
mu‹x
);

470 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

471 
li¡
.
Enqueue
(
±h»ad_£lf
());

474 
Œue
) {

476 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

477 
»t
 = 
±h»ad_mu‹x_lock_š‹º®
(
mu‹x
);

479 ià(
»t
 == 0) {

480  
»t
;

483 
’c_uÁru¡ed_sched_y›ld
();

487 
±h»ad_mu‹x_Œylock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

488 
»t
 = 
±h»ad_mu‹x_check_·¿m‘”
(
mu‹x
);

489 ià(
»t
 != 0) {

490  
»t
;

493 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

494 
»t
 = 
±h»ad_mu‹x_lock_š‹º®
(
mu‹x
);

496  
»t
;

500 
±h»ad_mu‹x_uÆock
(
±h»ad_mu‹x_t
 *
mu‹x
) {

501 
»t
 = 
±h»ad_mu‹x_check_·¿m‘”
(
mu‹x
);

502 ià(
»t
 != 0) {

503  
»t
;

506 cÚ¡ 
±h»ad_t
 
£lf
 = 
±h»ad_£lf
();

508 
LockabËGu¬d
 
lock_gu¬d
(
mu‹x
);

510 ià(
mu‹x
->
_owÃr
 =ğ
PTHREAD_T_NULL
) {

511  
EINVAL
;

514 ià(
mu‹x
->
_owÃr
 !ğ
£lf
) {

515  
EPERM
;

518 
mu‹x
->
_»fcouÁ
--;

519 ià(
mu‹x
->
_»fcouÁ
 == 0) {

520 
mu‹x
->
_owÃr
 = 
PTHREAD_T_NULL
;

527 
±h»ad_Úû
(
±h»ad_Úû_t
 *
Úû
, (*
š™_routše
)()) {

528 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
Úû
->
_mu‹x
);

529 ià(!
Úû
->
_¿n
) {

530 
š™_routše
();

531 
Úû
->
_¿n
 = 
Œue
;

537 
±h»ad_cÚd_š™
(
±h»ad_cÚd_t
 *
cÚd
, cÚ¡ 
±h»ad_cÚd©Œ_t
 *
©Œ
) {

538 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

539  
EFAULT
;

542 *
cÚd
 = 
PTHREAD_COND_INITIALIZER
;

547 
±h»ad_cÚd_de¡roy
(
±h»ad_cÚd_t
 *
cÚd
) {

548 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

549  
EFAULT
;

552 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

553 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

554 ià(!
li¡
.
Em±y
()) {

555  
EBUSY
;

570 
±h»ad_cÚd_timedwa™
(
±h»ad_cÚd_t
 *
cÚd
, 
±h»ad_mu‹x_t
 *
mu‹x
,

571 cÚ¡ 
time¥ec
 *
d—dlše
) {

572 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
) ||

573 !
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_mu‹x_t
>(
mu‹x
)) {

574  
EFAULT
;

578 ià(
d—dlše
 !ğ
nuÎ±r
 &&

579 !
asylo
::
IsV®idEnşaveAdd»ss
<
time¥ec
>(
d—dlše
)) {

580  
EFAULT
;

583 cÚ¡ 
±h»ad_t
 
£lf
 = 
±h»ad_£lf
();

585 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

587 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

588 
li¡
.
Enqueue
(
£lf
);

591 
»t
 = 
±h»ad_mu‹x_uÆock
(
mu‹x
);

592 ià(
»t
 != 0) {

593  
»t
;

596 
Œue
) {

597 
’c_uÁru¡ed_sched_y›ld
();

600 ià(
d—dlše
 !ğ
nuÎ±r
) {

601 
time¥ec
 
cu¼_time
;

602 
»t
 = 
şock_g‘time
(
CLOCK_REALTIME
, &
cu¼_time
);

603 ià(
»t
 != 0) {

608 
time¥ec
 
time_Ëá
;

609 ià(
asylo
::
TimeS³cSubŒaù
(*
d—dlše
, 
cu¼_time
, &
time_Ëá
)) {

610 
»t
 = 
ETIMEDOUT
;

615 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

616 ià(!
li¡
.
CÚšs
(
£lf
)) {

621 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

622 
li¡
.
Remove
(
£lf
);

629 
»lock_»t
 = 
±h»ad_mu‹x_lock
(
mu‹x
);

630 ià(
»t
 != 0) {

631  
»t
;

633  
»lock_»t
;

638 
±h»ad_cÚd_wa™
(
±h»ad_cÚd_t
 *
cÚd
, 
±h»ad_mu‹x_t
 *
mu‹x
) {

639  
±h»ad_cÚd_timedwa™
(
cÚd
, 
mu‹x
, 
nuÎ±r
);

642 
±h»ad_cÚd©Œ_š™
(
±h»ad_cÚd©Œ_t
 *
©Œ
) {  0; }

644 
±h»ad_cÚd©Œ_de¡roy
(
±h»ad_cÚd©Œ_t
 *
©Œ
) {  0; }

647 
±h»ad_cÚd_sigÇl
(
±h»ad_cÚd_t
 *
cÚd
) {

648 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

649  
EFAULT
;

652 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

653 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

654 ià(
li¡
.
Em±y
()) {

658 
li¡
.
Dequeue
();

664 
±h»ad_cÚd_brßdÿ¡
(
±h»ad_cÚd_t
 *
cÚd
) {

665 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_cÚd_t
>(
cÚd
)) {

666  
EFAULT
;

669 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
li¡
(
cÚd
);

671 
LockabËGu¬d
 
lock_gu¬d
(
cÚd
);

672 
li¡
.
CË¬
();

680 
£m_š™
(
£m_t
 *
£m
, cÚ¡ 
psh¬ed
, cÚ¡ 
v®ue
) {

681 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

682  
CÚv”tToE¼no
(
EFAULT
);

686 ià(
psh¬ed
) {

687  
CÚv”tToE¼no
(
ENOSYS
);

690 
£m
->
couÁ_
 = 
v®ue
;

692 
»t
 = 
±h»ad_mu‹x_š™
(&
£m
->
mu_
, 
nuÎ±r
);

693 ià(
»t
 != 0) {

694  
CÚv”tToE¼no
(
»t
);

697 
»t
 = 
±h»ad_cÚd_š™
(&
£m
->
cv_
, 
nuÎ±r
);

698 ià(
»t
 != 0) {

699  
CÚv”tToE¼no
(
»t
);

706 
£m_g‘v®ue
(
£m_t
 *
£m
, *
sv®
) {

707 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
) ||

708 !
asylo
::
IsV®idEnşaveAdd»ss
<>(
sv®
)) {

709  
CÚv”tToE¼no
(
EFAULT
);

712 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
£m
->
mu_
);

713 *
sv®
 = 
£m
->
couÁ_
;

718 
£m_po¡
(
£m_t
 *
£m
) {

719 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

720  
CÚv”tToE¼no
(
EFAULT
);

723 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
£m
->
mu_
);

724 
£m
->
couÁ_
++;

725  
CÚv”tToE¼no
(
±h»ad_cÚd_sigÇl
(&
£m
->
cv_
));

732 
£m_timedwa™
(
£m_t
 *
£m
, cÚ¡ 
time¥ec
 *
abs_timeout
) {

733 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

734  
CÚv”tToE¼no
(
EFAULT
);

737 ià(
abs_timeout
 !ğ
nuÎ±r
 &&

738 !
asylo
::
IsV®idEnşaveAdd»ss
<
time¥ec
>(
abs_timeout
)) {

739  
CÚv”tToE¼no
(
EFAULT
);

742 
asylo
::
±h»ad_im¶
::
Pth»adMu‹xLock
 
lock
(&
£m
->
mu_
);

744 
»t
 = 0;

745 
£m
->
couÁ_
 == 0) {

746 
»t
 = 
±h»ad_cÚd_timedwa™
(&
£m
->
cv_
, &£m->
mu_
, 
abs_timeout
);

748 ià(
»t
 != 0) {

755 ià(
»t
 == 0) {

756 
£m
->
couÁ_
--;

762  
CÚv”tToE¼no
(
»t
);

766 
£m_wa™
(
£m_t
 *
£m
è{  
£m_timedwa™
(£m, 
nuÎ±r
); }

768 
£m_Œywa™
(
£m_t
 *
£m
) {

769 
time¥ec
 
d—dlše
 = {0, 0};

770 
»t
 = 
£m_timedwa™
(
£m
, &
d—dlše
);

771 ià(
»t
 !ğ0 && 
”ºo
 =ğ
ETIMEDOUT
) {

772 
”ºo
 = 
EAGAIN
;

775  
»t
;

778 
£m_de¡roy
(
£m_t
 *
£m
) {

779 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
£m_t
>(
£m
)) {

780  
CÚv”tToE¼no
(
EFAULT
);

783 
»t
 = 
±h»ad_cÚd_de¡roy
(&
£m
->
cv_
);

784 ià(
»t
 != 0) {

785  
CÚv”tToE¼no
(
»t
);

788 
»t
 = 
±h»ad_mu‹x_de¡roy
(&
£m
->
mu_
);

789 ià(
»t
 != 0) {

790  
CÚv”tToE¼no
(
»t
);

796 
±h»ad_rwlock_š™
(
±h»ad_rwlock_t
 *
rwlock
,

797 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
©Œ
) {

798 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

799  
CÚv”tToE¼no
(
EFAULT
);

802 *
rwlock
 = 
PTHREAD_RWLOCK_INITIALIZER
;

807 
±h»ad_rwlock_Œyrdlock
(
±h»ad_rwlock_t
 *
rwlock
) {

808 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

809  
CÚv”tToE¼no
(
EFAULT
);

812 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

813  
±h»ad_rwlock_Œyrdlock_š‹º®
(
rwlock
);

816 
±h»ad_rwlock_Œyw¾ock
(
±h»ad_rwlock_t
 *
rwlock
) {

817 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

818  
CÚv”tToE¼no
(
EFAULT
);

821 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

822  
±h»ad_rwlock_Œyw¾ock_š‹º®
(
rwlock
);

825 
±h»ad_rwlock_rdlock
(
±h»ad_rwlock_t
 *
rwlock
) {

826  
±h»ad_rwlock_lock
<
±h»ad_rwlock_Œyrdlock_š‹º®
>(
rwlock
);

829 
±h»ad_rwlock_w¾ock
(
±h»ad_rwlock_t
 *
rwlock
) {

830  
±h»ad_rwlock_lock
<
±h»ad_rwlock_Œyw¾ock_š‹º®
>(
rwlock
);

833 
±h»ad_rwlock_uÆock
(
±h»ad_rwlock_t
 *
rwlock
) {

834 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

835  
CÚv”tToE¼no
(
EFAULT
);

838 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

840 cÚ¡ 
±h»ad_t
 
£lf
 = 
±h»ad_£lf
();

841 ià(
rwlock
->
_wr™e_owÃr
 =ğ
£lf
) {

842 
rwlock
->
_wr™e_owÃr
 = 
PTHREAD_T_NULL
;

846 
rwlock
->
_»ad”_couÁ
--;

850 
±h»ad_rwlock_de¡roy
(
±h»ad_rwlock_t
 *
rwlock
) {

851 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_rwlock_t
>(
rwlock
)) {

852  
CÚv”tToE¼no
(
EFAULT
);

855 
LockabËGu¬d
 
lock_gu¬d
(
rwlock
);

856 
asylo
::
±h»ad_im¶
::
QueueO³¿tiÚs
 
queue
(
rwlock
);

857 ià(
rwlock
->
_wr™e_owÃr
 =ğ
PTHREAD_T_NULL
 && 
queue
.
Em±y
()) {

861  
EBUSY
;

864 
±h»ad_equ®
(
±h»ad_t
 
th»ad_Úe
,…th»ad_ˆ
th»ad_two
) {

865 ià(
th»ad_Úe
 =ğ
th»ad_two
) {

871 
_±h»ad_ş—nup_push
(
_±h»ad_ş—nup_cÚ‹xt
 *
cÚ‹xt
,

872 (*
routše
)(*), *
¬g
) {

873 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

874 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

875 
th»ad_mªag”
->
PushCËªupRoutše
(
¡d
::
bšd
(
routše
, 
¬g
));

878 
_±h»ad_ş—nup_pİ
(
_±h»ad_ş—nup_cÚ‹xt
 *
cÚ‹xt
,

879 
execu‹
) {

880 
asylo
::
Th»adMªag”
 *cÚ¡ 
th»ad_mªag”
 =

881 
asylo
::
Th»adMªag”
::
G‘In¡ªû
();

882 
th»ad_mªag”
->
PİCËªupRoutše
(
execu‹
 != 0);

885 
±h»ad_mu‹x©Œ_š™
(
±h»ad_mu‹x©Œ_t
 *
mu‹x©Œ
) {  0; }

886 
±h»ad_mu‹x©Œ_de¡roy
(
±h»ad_mu‹x©Œ_t
 *
mu‹x©Œ
) {  0; }

887 
±h»ad_mu‹x©Œ_£‰y³
(
±h»ad_mu‹x©Œ_t
 *
mu‹x©Œ
, 
ty³
) {

891 
±h»ad_©Œ_š™
(
±h»ad_©Œ_t
 *
©Œ
) {

892 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_©Œ_t
>(
©Œ
)) {

893  
CÚv”tToE¼no
(
EFAULT
);

896 
©Œ
->
d‘ach_¡©e
 = 
PTHREAD_CREATE_JOINABLE
;

900 
±h»ad_©Œ_de¡roy
(
±h»ad_©Œ_t
 *
©Œ
) {

901 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_©Œ_t
>(
©Œ
)) {

902  
CÚv”tToE¼no
(
EFAULT
);

907 
±h»ad_©Œ_£td‘ach¡©e
(
±h»ad_©Œ_t
 *
©Œ
, 
ty³
) {

908 ià(!
asylo
::
IsV®idEnşaveAdd»ss
<
±h»ad_©Œ_t
>(
©Œ
)) {

909  
CÚv”tToE¼no
(
EFAULT
);

912 ià(
ty³
 !ğ
PTHREAD_CREATE_JOINABLE
 &&y³ !ğ
PTHREAD_CREATE_DETACHED
) {

913  
EINVAL
;

916 
©Œ
->
d‘ach_¡©e
 = 
ty³
;

920 
±h»ad_©Œ_g‘schedpŞicy
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
, *
pŞicy
) {

921  
ENOSYS
;

923 
±h»ad_©Œ_£tschedpŞicy
(
±h»ad_©Œ_t
 *
©Œ
, 
pŞicy
) {

924  
ENOSYS
;

926 
±h»ad_©Œ_g‘scİe
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
, *
scİe
) {

927  
ENOSYS
;

929 
±h»ad_©Œ_£tscİe
(
±h»ad_©Œ_t
 *
©Œ
, 
scİe
è{  
ENOSYS
; }

930 
±h»ad_©Œ_g‘sched·¿m
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
,

931 
sched_·¿m
 *
·¿m
) {

932  
ENOSYS
;

934 
±h»ad_©Œ_£tsched·¿m
(
±h»ad_©Œ_t
 *
©Œ
,

935 cÚ¡ 
sched_·¿m
 *
·¿m
) {

936  
ENOSYS
;

938 
±h»ad_©Œ_g‘¡acksize
(cÚ¡ 
±h»ad_©Œ_t
 *
©Œ
, 
size_t
 *
¡acksize
) {

939  
ENOSYS
;

941 
±h»ad_©Œ_£t¡acksize
(
±h»ad_©Œ_t
 *
©Œ
, 
size_t
 
¡acksize
) {

942  
ENOSYS
;

945 
±h»ad_ÿnûl
(
±h»ad_t
 
unu£d
è{  
ENOSYS
; }

946 
±h»ad_£tÿnûl¡©e
(
¡©e
, *
Şd¡©e
è{  
ENOSYS
; }

947 
±h»ad_£tÿnûÉy³
(
ty³
, *
Şdty³
è{  
ENOSYS
; }

	@platform/posix/pthread_impl.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_PTHREAD_IMPL_H_


20 
	#ASYLO_PLATFORM_POSIX_PTHREAD_IMPL_H_


	)

22 
	~<±h»ad.h
>

23 
	~<funùiÚ®
>

25 
	~"asylo/ut/loggšg.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	g±h»ad_im¶
 {

31 şas 
	cQueueO³¿tiÚs
 {

32 
	gpublic
:

35 
‹m¶©e
 <
şass
 
QueueTy³
>

36 
ex¶ic™
 
QueueO³¿tiÚs
(
QueueTy³
 *
queue
)

37 : 
QueueO³¿tiÚs
(&
queue
->
_queue
) {}

39 
ex¶ic™
 
QueueO³¿tiÚs
(
__±h»ad_li¡_t
 *
li¡
);

42 
Dequeue
();

45 
Enqueue
(cÚ¡ 
±h»ad_t
 
id
);

49 
boŞ
 
Remove
(cÚ¡ 
±h»ad_t
 
id
);

52 
CË¬
();

55 
boŞ
 
CÚšs
(cÚ¡ 
±h»ad_t
 
id
) const;

58 
±h»ad_t
 
FrÚt
() const;

61 
boŞ
 
Em±y
() const;

63 
	g´iv©e
:

64 
__±h»ad_li¡_t
 *cÚ¡ 
li¡_
;

71 şas 
	cPth»adMu‹xLock
 {

72 
	gpublic
:

73 
Pth»adMu‹xLock
(
±h»ad_mu‹x_t
 *
mu‹x
è: 
mu‹x_
(mutex) {

74 
»t
 = 
±h»ad_mu‹x_lock
(
mu‹x_
);

75 
CHECK_EQ
(
»t
, 0);

78 ~
Pth»adMu‹xLock
() {

79 
	g»t
 = 
±h»ad_mu‹x_uÆock
(
mu‹x_
);

80 
CHECK_EQ
(
»t
, 0);

83 
	g´iv©e
:

84 
±h»ad_mu‹x_t
 *cÚ¡ 
mu‹x_
;

	@platform/posix/pwd.cc

19 
	~<pwd.h
>

20 
	~<¡dlib.h
>

21 
	~<sys/ty³s.h
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
g‘pwuid_r
(
uid_t
 
uid
, 
·sswd
 *
pwd
, *
buf
, 
size_t
 
buæ’
,

28 
·sswd
 **
»suÉ
) {

29 
abÜt
();

32 
g‘pwÇm_r
(cÚ¡ *
Çme
, 
·sswd
 *
pwd
, *
buf
, 
size_t
 
buæ’
,

33 
·sswd
 **
»suÉ
) {

34 
abÜt
();

37 
·sswd
 *
g‘pwuid
(
uid_t
 
uid
) {

38  
’c_uÁru¡ed_g‘pwuid
(
uid
);

	@platform/posix/pwd.cc

19 
	~<pwd.h
>

20 
	~<¡dlib.h
>

21 
	~<sys/ty³s.h
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
g‘pwuid_r
(
uid_t
 
uid
, 
·sswd
 *
pwd
, *
buf
, 
size_t
 
buæ’
,

28 
·sswd
 **
»suÉ
) {

29 
abÜt
();

32 
g‘pwÇm_r
(cÚ¡ *
Çme
, 
·sswd
 *
pwd
, *
buf
, 
size_t
 
buæ’
,

33 
·sswd
 **
»suÉ
) {

34 
abÜt
();

37 
·sswd
 *
g‘pwuid
(
uid_t
 
uid
) {

38  
’c_uÁru¡ed_g‘pwuid
(
uid
);

	@platform/posix/resource.cc

19 #iâdeà
THIRD_PARTY_ASYLO_PLATFORM_POSIX_SRC_RESOURCE_H_


20 
	#THIRD_PARTY_ASYLO_PLATFORM_POSIX_SRC_RESOURCE_H_


	)

22 
	~<sys/»sourû.h
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

29 
g‘¾im™
(
»sourû
, 
¾im™
 *
¾im
) {

30 
»sourû
) {

31 
RLIMIT_NOFILE
:

32  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
G‘RLim™
(
»sourû
, 
¾im
);

34 
”ºo
 = 
ENOSYS
;

39 
£Œlim™
(
»sourû
, cÚ¡ 
¾im™
 *
¾im
) {

40 
»sourû
) {

41 
RLIMIT_NOFILE
:

42  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
S‘RLim™
(
»sourû
, 
¾im
);

44 
”ºo
 = 
ENOSYS
;

49 
g‘ru§ge
(
who
, 
ru§ge
 *
u§ge
) {

50  
’c_uÁru¡ed_g‘ru§ge
(
who
, 
u§ge
);

	@platform/posix/resource.cc

19 #iâdeà
THIRD_PARTY_ASYLO_PLATFORM_POSIX_SRC_RESOURCE_H_


20 
	#THIRD_PARTY_ASYLO_PLATFORM_POSIX_SRC_RESOURCE_H_


	)

22 
	~<sys/»sourû.h
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

29 
g‘¾im™
(
»sourû
, 
¾im™
 *
¾im
) {

30 
»sourû
) {

31 
RLIMIT_NOFILE
:

32  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
G‘RLim™
(
»sourû
, 
¾im
);

34 
”ºo
 = 
ENOSYS
;

39 
£Œlim™
(
»sourû
, cÚ¡ 
¾im™
 *
¾im
) {

40 
»sourû
) {

41 
RLIMIT_NOFILE
:

42  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
S‘RLim™
(
»sourû
, 
¾im
);

44 
”ºo
 = 
ENOSYS
;

49 
g‘ru§ge
(
who
, 
ru§ge
 *
u§ge
) {

50  
’c_uÁru¡ed_g‘ru§ge
(
who
, 
u§ge
);

	@platform/posix/sched.cc

19 
	~<sched.h
>

21 
	~<¡ršg.h
>

22 
	~<b™£t
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
šlše
 
size_t
 
	$WÜdNum
(
ıu
è{  cpu / (8 * (
CpuS‘WÜd
)); 
	}
}

28 
šlše
 
CpuS‘WÜd
 
	$B™Num
(
ıu
è{  cpu % (8 * (
CpuS‘WÜd
)); 
	}
}

30 
	$CpuS‘Z”o
(
CpuS‘
 *
£t
è{ 
	`mem£t
(£t->
wÜds
, 0, (£t->wÜds)); 
	}
}

32 
cÚ¡ex´
 
CpuS‘WÜd
 
	gÚe_wÜd
 = 1;

34 
	$CpuS‘AddB™
(
ıu
, 
CpuS‘
 *
£t
) {

35 
£t
->
wÜds
[
	`WÜdNum
(
ıu
)] |ğ
Úe_wÜd
 << 
	`B™Num
(cpu);

36 
	}
}

38 
	$CpuS‘CË¬B™
(
ıu
, 
CpuS‘
 *
£t
) {

39 
£t
->
wÜds
[
	`WÜdNum
(
ıu
)] &ğ~(
Úe_wÜd
 << 
	`B™Num
(cpu));

40 
	}
}

42 
	$CpuS‘CheckB™
(
ıu
, 
CpuS‘
 *
£t
) {

43  ((
£t
->
wÜds
[
	`WÜdNum
(
ıu
)] & (
Úe_wÜd
 << 
	`B™Num
(cpu))) ? 1 : 0);

44 
	}
}

46 
	$CpuS‘CouÁB™s
(
CpuS‘
 *
£t
) {

47 
ıu_couÁ
 = 0;

48 
CpuS‘WÜd
 
wÜd
;

51 
size_t
 
i
 = 0; i < 
CPU_SET_T_NUM_WORDS
; ++i) {

52 
wÜd
 = 
£t
->
wÜds
[
i
];

54 
ıu_couÁ
 +ğ
¡d
::
b™£t
<8 * (
CpuS‘WÜd
)>(
wÜd
).
	`couÁ
();

56  
ıu_couÁ
;

57 
	}
}

59 
	$CpuS‘Equ®
(
CpuS‘
 *
£t1
, CpuS‘ *
£t2
) {

61 
size_t
 
i
 = 0; i < 
CPU_SET_T_NUM_WORDS
; ++i) {

63 ià(
£t1
->
wÜds
[
i
] !ğ
£t2
->words[i]) {

69 
	}
}

71 
	$sched_g‘affš™y
(
pid_t
 
pid
, 
size_t
 
ıu£tsize
, 
ıu_£t_t
 *
mask
) {

72  
	`’c_uÁru¡ed_sched_g‘affš™y
(
pid
, 
ıu£tsize
, 
mask
);

73 
	}
}

75 
	$sched_y›ld
(è{  
	`’c_uÁru¡ed_sched_y›ld
(); 
	}
}

	@platform/posix/sched.cc

19 
	~<sched.h
>

21 
	~<¡ršg.h
>

22 
	~<b™£t
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
šlše
 
size_t
 
	$WÜdNum
(
ıu
è{  cpu / (8 * (
CpuS‘WÜd
)); 
	}
}

28 
šlše
 
CpuS‘WÜd
 
	$B™Num
(
ıu
è{  cpu % (8 * (
CpuS‘WÜd
)); 
	}
}

30 
	$CpuS‘Z”o
(
CpuS‘
 *
£t
è{ 
	`mem£t
(£t->
wÜds
, 0, (£t->wÜds)); 
	}
}

32 
cÚ¡ex´
 
CpuS‘WÜd
 
	gÚe_wÜd
 = 1;

34 
	$CpuS‘AddB™
(
ıu
, 
CpuS‘
 *
£t
) {

35 
£t
->
wÜds
[
	`WÜdNum
(
ıu
)] |ğ
Úe_wÜd
 << 
	`B™Num
(cpu);

36 
	}
}

38 
	$CpuS‘CË¬B™
(
ıu
, 
CpuS‘
 *
£t
) {

39 
£t
->
wÜds
[
	`WÜdNum
(
ıu
)] &ğ~(
Úe_wÜd
 << 
	`B™Num
(cpu));

40 
	}
}

42 
	$CpuS‘CheckB™
(
ıu
, 
CpuS‘
 *
£t
) {

43  ((
£t
->
wÜds
[
	`WÜdNum
(
ıu
)] & (
Úe_wÜd
 << 
	`B™Num
(cpu))) ? 1 : 0);

44 
	}
}

46 
	$CpuS‘CouÁB™s
(
CpuS‘
 *
£t
) {

47 
ıu_couÁ
 = 0;

48 
CpuS‘WÜd
 
wÜd
;

51 
size_t
 
i
 = 0; i < 
CPU_SET_T_NUM_WORDS
; ++i) {

52 
wÜd
 = 
£t
->
wÜds
[
i
];

54 
ıu_couÁ
 +ğ
¡d
::
b™£t
<8 * (
CpuS‘WÜd
)>(
wÜd
).
	`couÁ
();

56  
ıu_couÁ
;

57 
	}
}

59 
	$CpuS‘Equ®
(
CpuS‘
 *
£t1
, CpuS‘ *
£t2
) {

61 
size_t
 
i
 = 0; i < 
CPU_SET_T_NUM_WORDS
; ++i) {

63 ià(
£t1
->
wÜds
[
i
] !ğ
£t2
->words[i]) {

69 
	}
}

71 
	$sched_g‘affš™y
(
pid_t
 
pid
, 
size_t
 
ıu£tsize
, 
ıu_£t_t
 *
mask
) {

72  
	`’c_uÁru¡ed_sched_g‘affš™y
(
pid
, 
ıu£tsize
, 
mask
);

73 
	}
}

75 
	$sched_y›ld
(è{  
	`’c_uÁru¡ed_sched_y›ld
(); 
	}
}

	@platform/posix/select.cc

19 
	~<sys/£Ëù.h
>

21 
	~<sys/time.h
>

22 
	~<sys/ty³s.h
>

24 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

26 
usšg
 
	gasylo
::
io
::
IOMªag”
;

30 
£Ëù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
, fd_£ˆ*
exû±fds
,

31 
timev®
 *
timeout
) {

32  
IOMªag”
::
G‘In¡ªû
().
S–eù
(
nfds
, 
»adfds
, 
wr™efds
, 
exû±fds
,

33 
timeout
);

	@platform/posix/select.cc

19 
	~<sys/£Ëù.h
>

21 
	~<sys/time.h
>

22 
	~<sys/ty³s.h
>

24 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

26 
usšg
 
	gasylo
::
io
::
IOMªag”
;

30 
£Ëù
(
nfds
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
, fd_£ˆ*
exû±fds
,

31 
timev®
 *
timeout
) {

32  
IOMªag”
::
G‘In¡ªû
().
S–eù
(
nfds
, 
»adfds
, 
wr™efds
, 
exû±fds
,

33 
timeout
);

	@platform/posix/select_test.cc

19 
	~<sys/£Ëù.h
>

20 
	~<®gÜ™hm
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 cÚ¡ *
	gkMes§ge
 = "Pipe message";

33 
cÚ¡ex´
 
	gkR—d
 = 0;

34 
cÚ¡ex´
 
	gkWr™e
 = 1;

36 şas 
	cS–eùTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

37 
´Ùeùed
:

38 
Stus
 
Wr™eToFe
(
fd
, cÚ¡ *
mes§ge
) {

39 
size_t
 
	gby‹s_Ëá
 = 
¡¾’
(
mes§ge
);

40 
	gby‹s_Ëá
 > 0) {

41 
ssize_t
 
	gby‹s_wr™‹n
 = 
wr™e
(
fd
, 
mes§ge
, 
by‹s_Ëá
);

42 ià(
	gby‹s_wr™‹n
 < 0) {

43  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

44 
ab¦
::
SŒC©
("wr™çed: ", 
¡»¼Ü
(
”ºo
)));

46 
	gby‹s_Ëá
 -ğ
by‹s_wr™‹n
;

48  
	gStus
::
OkStus
();

51 
RunS–eùTe¡
(
boŞ
 
is_»ad_‹¡
) {

54 
ASSERT_EQ
(
pe
(
fd_·œs_
), 0);

55 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r_»ad
(
fd_·œs_
[0]);

56 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r_wr™e
(
fd_·œs_
[1]);

57 
EXPECT_THAT
(
Wr™eToFe
(
fd_·œs_
[
kWr™e
], 
kMes§ge
), 
IsOk
());

59 
fd_£t
 
	gfds
;

60 
FD_ZERO
(&
fds
);

61 
FD_SET
(
fd_·œs_
[
kR—d
], &
fds
);

62 
FD_SET
(
fd_·œs_
[
kWr™e
], &
fds
);

64 
timev®
 
	gtimeout
;

65 
	gtimeout
.
	gtv_£c
 = 3;

66 
	gtimeout
.
	gtv_u£c
 = 0;

67 
	gnfds
 = 
¡d
::
max
(
fd_·œs_
[
kR—d
], fd_·œs_[
kWr™e
]) + 1;

69 ià(
	gis_»ad_‹¡
) {

70 
ASSERT_EQ
(
£Ëù
(
nfds
, &
fds
, 
nuÎ±r
,‚ullptr,

71 &
timeout
),

75 
EXPECT_TRUE
(
FD_ISSET
(
fd_·œs_
[
kR—d
], &
fds
));

76 
EXPECT_FALSE
(
FD_ISSET
(
fd_·œs_
[
kWr™e
], &
fds
));

78 
ASSERT_EQ
(
£Ëù
(
nfds
, 
nuÎ±r
, &
fds
,‚ullptr,

79 &
timeout
),

83 
EXPECT_TRUE
(
FD_ISSET
(
fd_·œs_
[
kWr™e
], &
fds
));

84 
EXPECT_FALSE
(
FD_ISSET
(
fd_·œs_
[
kR—d
], &
fds
));

88 
	g´iv©e
:

89 
fd_·œs_
[2];

92 
TEST_F
(
S–eùTe¡
, 
R—d
è{ 
RunS–eùTe¡
(
Œue
); }

94 
TEST_F
(
S–eùTe¡
, 
Wr™e
è{ 
RunS–eùTe¡
(
çl£
); }

	@platform/posix/select_test.cc

19 
	~<sys/£Ëù.h
>

20 
	~<®gÜ™hm
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

26 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 cÚ¡ *
	gkMes§ge
 = "Pipe message";

33 
cÚ¡ex´
 
	gkR—d
 = 0;

34 
cÚ¡ex´
 
	gkWr™e
 = 1;

36 şas 
	cS–eùTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

37 
´Ùeùed
:

38 
Stus
 
Wr™eToFe
(
fd
, cÚ¡ *
mes§ge
) {

39 
size_t
 
	gby‹s_Ëá
 = 
¡¾’
(
mes§ge
);

40 
	gby‹s_Ëá
 > 0) {

41 
ssize_t
 
	gby‹s_wr™‹n
 = 
wr™e
(
fd
, 
mes§ge
, 
by‹s_Ëá
);

42 ià(
	gby‹s_wr™‹n
 < 0) {

43  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

44 
ab¦
::
SŒC©
("wr™çed: ", 
¡»¼Ü
(
”ºo
)));

46 
	gby‹s_Ëá
 -ğ
by‹s_wr™‹n
;

48  
	gStus
::
OkStus
();

51 
RunS–eùTe¡
(
boŞ
 
is_»ad_‹¡
) {

54 
ASSERT_EQ
(
pe
(
fd_·œs_
), 0);

55 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r_»ad
(
fd_·œs_
[0]);

56 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r_wr™e
(
fd_·œs_
[1]);

57 
EXPECT_THAT
(
Wr™eToFe
(
fd_·œs_
[
kWr™e
], 
kMes§ge
), 
IsOk
());

59 
fd_£t
 
	gfds
;

60 
FD_ZERO
(&
fds
);

61 
FD_SET
(
fd_·œs_
[
kR—d
], &
fds
);

62 
FD_SET
(
fd_·œs_
[
kWr™e
], &
fds
);

64 
timev®
 
	gtimeout
;

65 
	gtimeout
.
	gtv_£c
 = 3;

66 
	gtimeout
.
	gtv_u£c
 = 0;

67 
	gnfds
 = 
¡d
::
max
(
fd_·œs_
[
kR—d
], fd_·œs_[
kWr™e
]) + 1;

69 ià(
	gis_»ad_‹¡
) {

70 
ASSERT_EQ
(
£Ëù
(
nfds
, &
fds
, 
nuÎ±r
,‚ullptr,

71 &
timeout
),

75 
EXPECT_TRUE
(
FD_ISSET
(
fd_·œs_
[
kR—d
], &
fds
));

76 
EXPECT_FALSE
(
FD_ISSET
(
fd_·œs_
[
kWr™e
], &
fds
));

78 
ASSERT_EQ
(
£Ëù
(
nfds
, 
nuÎ±r
, &
fds
,‚ullptr,

79 &
timeout
),

83 
EXPECT_TRUE
(
FD_ISSET
(
fd_·œs_
[
kWr™e
], &
fds
));

84 
EXPECT_FALSE
(
FD_ISSET
(
fd_·œs_
[
kR—d
], &
fds
));

88 
	g´iv©e
:

89 
fd_·œs_
[2];

92 
TEST_F
(
S–eùTe¡
, 
R—d
è{ 
RunS–eùTe¡
(
Œue
); }

94 
TEST_F
(
S–eùTe¡
, 
Wr™e
è{ 
RunS–eùTe¡
(
çl£
); }

	@platform/posix/signal.cc

19 #iâdeà
_GNU_SOURCE


20 
	#_GNU_SOURCE


	)

22 
	~<sigÇl.h
>

24 
	~<±h»ad.h
>

25 
	~<c¡dlib
>

27 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

28 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/»gi¡”_sigÇl.h
"

30 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

31 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

52 
sigaùiÚ
(
signum
, cÚ¡ sigaùiÚ *
aù
,

53 
sigaùiÚ
 *
Şdaù
) {

54 ià(
signum
 =ğ
SIGILL
) {

55 
”ºo
 = 
EINVAL
;

59 
asylo
::
SigÇlMªag”
 *
sigÇl_mªag”
 =‡sylo::SigÇlMªag”::
G‘In¡ªû
();

62 
ab¦
::
Mu‹x
 
sigaùiÚ_lock
;

64 
ab¦
::
Mu‹xLock
 
lock
(&
sigaùiÚ_lock
);

65 ià(
Şdaù
) {

66 ià(
sigÇl_mªag”
->
G‘SigAùiÚ
(
signum
)) {

67 
Şdaù
 = 
cÚ¡_ÿ¡
<
sigaùiÚ
 *>(

68 
sigÇl_mªag”
->
G‘SigAùiÚ
(
signum
));

70 
Şdaù
->
§_hªdËr
 = 
SIG_DFL
;

73 
sigÇl_mªag”
->
S‘SigAùiÚ
(
signum
, *
aù
);

75 
sig£t_t
 
mask
;

76 
sigem±y£t
(&
mask
);

77 
æags
 = 0;

78 ià(
aù
) {

79 
mask
 = 
aù
->
§_mask
;

80 
æags
 = 
aù
->
§_æags
;

82 ià(
æags
 & 
SA_RESETHAND
) {

83 
sigÇl_mªag”
->
S‘Re£tOnHªdË
(
signum
);

85 cÚ¡ 
¡d
::
¡ršg
 
’şave_Çme
 = 
asylo
::
G‘EnşaveName
();

88  
’c_»gi¡”_sigÇl
(
signum
, 
mask
, 
æags
, 
’şave_Çme
.
c_¡r
());

104 
sig´ocmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
) {

105 ià(
how
 !ğ
SIG_BLOCK
 && how !ğ
SIG_UNBLOCK
 && how !ğ
SIG_SETMASK
) {

106 
”ºo
 = 
EINVAL
;

109 
asylo
::
SigÇlMªag”
 *
sigÇl_mªag”
 =‡sylo::SigÇlMªag”::
G‘In¡ªû
();

110 ià(
Şd£t
) {

111 *
Şd£t
 = 
sigÇl_mªag”
->
G‘SigÇlMask
();

113 ià(!
£t
) {

116 
sig£t_t
 
sigÇls_to_block
;

117 
sigem±y£t
(&
sigÇls_to_block
);

118 
sig£t_t
 
sigÇls_to_unblock
;

119 
sigem±y£t
(&
sigÇls_to_unblock
);

120 ià(
how
 =ğ
SIG_BLOCK
 || how =ğ
SIG_SETMASK
) {

121 
sigÇls_to_block
 = *
£t
;

124 ià(
how
 =ğ
SIG_UNBLOCK
) {

125 
sigÇls_to_unblock
 = *
£t
;

126 } ià(
how
 =ğ
SIG_SETMASK
) {

127 
sigÇls_to_unblock
 = 
sigÇl_mªag”
->
G‘UnblockedS‘
(*
£t
);

131 
sigÇl_mªag”
->
UnblockSigÇls
(
sigÇls_to_unblock
);

134 
»s
 = 
’c_uÁru¡ed_sig´ocmask
(
how
, 
£t
, 
nuÎ±r
);

137 
sigÇl_mªag”
->
BlockSigÇls
(
sigÇls_to_block
);

139  
»s
;

142 
±h»ad_sigmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
) {

143  
sig´ocmask
(
how
, 
£t
, 
Şd£t
);

150 
sighªdËr_t
 
sigÇl
(
signum
, sighªdËr_ˆ
hªdËr
) {

151 
sigaùiÚ
 
aù
;

152 
aù
.
§_hªdËr
 = 
hªdËr
;

153 
sigem±y£t
(&
aù
.
§_mask
);

154 
sigaùiÚ
 
Şdaù
;

155 ià(
sigaùiÚ
(
signum
, &
aù
, &
Şdaù
)) {

157  
SIG_ERR
;

159  
Şdaù
.
§_hªdËr
;

168 
¿i£
(
sig
è{  
’c_uÁru¡ed_¿i£
(sig); }

	@platform/posix/signal.cc

19 #iâdeà
_GNU_SOURCE


20 
	#_GNU_SOURCE


	)

22 
	~<sigÇl.h
>

24 
	~<±h»ad.h
>

25 
	~<c¡dlib
>

27 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

28 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/»gi¡”_sigÇl.h
"

30 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

31 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

52 
sigaùiÚ
(
signum
, cÚ¡ sigaùiÚ *
aù
,

53 
sigaùiÚ
 *
Şdaù
) {

54 ià(
signum
 =ğ
SIGILL
) {

55 
”ºo
 = 
EINVAL
;

59 
asylo
::
SigÇlMªag”
 *
sigÇl_mªag”
 =‡sylo::SigÇlMªag”::
G‘In¡ªû
();

62 
ab¦
::
Mu‹x
 
sigaùiÚ_lock
;

64 
ab¦
::
Mu‹xLock
 
lock
(&
sigaùiÚ_lock
);

65 ià(
Şdaù
) {

66 ià(
sigÇl_mªag”
->
G‘SigAùiÚ
(
signum
)) {

67 
Şdaù
 = 
cÚ¡_ÿ¡
<
sigaùiÚ
 *>(

68 
sigÇl_mªag”
->
G‘SigAùiÚ
(
signum
));

70 
Şdaù
->
§_hªdËr
 = 
SIG_DFL
;

73 
sigÇl_mªag”
->
S‘SigAùiÚ
(
signum
, *
aù
);

75 
sig£t_t
 
mask
;

76 
sigem±y£t
(&
mask
);

77 
æags
 = 0;

78 ià(
aù
) {

79 
mask
 = 
aù
->
§_mask
;

80 
æags
 = 
aù
->
§_æags
;

82 ià(
æags
 & 
SA_RESETHAND
) {

83 
sigÇl_mªag”
->
S‘Re£tOnHªdË
(
signum
);

85 cÚ¡ 
¡d
::
¡ršg
 
’şave_Çme
 = 
asylo
::
G‘EnşaveName
();

88  
’c_»gi¡”_sigÇl
(
signum
, 
mask
, 
æags
, 
’şave_Çme
.
c_¡r
());

104 
sig´ocmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
) {

105 ià(
how
 !ğ
SIG_BLOCK
 && how !ğ
SIG_UNBLOCK
 && how !ğ
SIG_SETMASK
) {

106 
”ºo
 = 
EINVAL
;

109 
asylo
::
SigÇlMªag”
 *
sigÇl_mªag”
 =‡sylo::SigÇlMªag”::
G‘In¡ªû
();

110 ià(
Şd£t
) {

111 *
Şd£t
 = 
sigÇl_mªag”
->
G‘SigÇlMask
();

113 ià(!
£t
) {

116 
sig£t_t
 
sigÇls_to_block
;

117 
sigem±y£t
(&
sigÇls_to_block
);

118 
sig£t_t
 
sigÇls_to_unblock
;

119 
sigem±y£t
(&
sigÇls_to_unblock
);

120 ià(
how
 =ğ
SIG_BLOCK
 || how =ğ
SIG_SETMASK
) {

121 
sigÇls_to_block
 = *
£t
;

124 ià(
how
 =ğ
SIG_UNBLOCK
) {

125 
sigÇls_to_unblock
 = *
£t
;

126 } ià(
how
 =ğ
SIG_SETMASK
) {

127 
sigÇls_to_unblock
 = 
sigÇl_mªag”
->
G‘UnblockedS‘
(*
£t
);

131 
sigÇl_mªag”
->
UnblockSigÇls
(
sigÇls_to_unblock
);

134 
»s
 = 
’c_uÁru¡ed_sig´ocmask
(
how
, 
£t
, 
nuÎ±r
);

137 
sigÇl_mªag”
->
BlockSigÇls
(
sigÇls_to_block
);

139  
»s
;

142 
±h»ad_sigmask
(
how
, cÚ¡ 
sig£t_t
 *
£t
, sig£t_ˆ*
Şd£t
) {

143  
sig´ocmask
(
how
, 
£t
, 
Şd£t
);

150 
sighªdËr_t
 
sigÇl
(
signum
, sighªdËr_ˆ
hªdËr
) {

151 
sigaùiÚ
 
aù
;

152 
aù
.
§_hªdËr
 = 
hªdËr
;

153 
sigem±y£t
(&
aù
.
§_mask
);

154 
sigaùiÚ
 
Şdaù
;

155 ià(
sigaùiÚ
(
signum
, &
aù
, &
Şdaù
)) {

157  
SIG_ERR
;

159  
Şdaù
.
§_hªdËr
;

168 
¿i£
(
sig
è{  
’c_uÁru¡ed_¿i£
(sig); }

	@platform/posix/signal/signal_manager.cc

19 
	~<sigÇl.h
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

24 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkMaxSigÇlsInMask
 = (
sig£t_t
) * 8;

31 
sig£t_t
 
Em±ySigS‘
() {

32 
sig£t_t
 
	g£t
;

33 
sigem±y£t
(&
£t
);

34  
	g£t
;

39 
th»ad_loÿl
 
sig£t_t
 
	gSigÇlMªag”
::
sigÇl_mask_
 = 
Em±ySigS‘
();

41 
SigÇlMªag”
 *
	gSigÇlMªag”
::
G‘In¡ªû
() {

42 
SigÇlMªag”
 *
š¡ªû
 = 
Ãw
 SignalManager();

43  
	gš¡ªû
;

46 
Stus
 
	gSigÇlMªag”
::
HªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
,

47 *
ucÚ‹xt
) {

48 
	g¡d
::
unique_±r
<
sigaùiÚ
> 
aù
 =

49 ::
ab¦
::
make_unique
<
sigaùiÚ
>(*
G‘SigAùiÚ
(
signum
));

50 ià(!
	gaù
) {

51  
Stus
(

52 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

53 
ab¦
::
SŒC©
("NØhªdË¸ha b“À»gi¡”ed fÜ sigÇl: ", 
signum
));

55 ià(
IsRe£tOnHªdË
(
signum
)) {

56 
CË¬SigAùiÚ
(
signum
);

58 
Stus
 
	g¡©us
;

59 
sig£t_t
 
	gŞd_mask
 = 
G‘SigÇlMask
();

60 
BlockSigÇls
(
aù
->
§_mask
);

61 
boŞ
 
	gis_sigšfo
 = 
aù
->
§_æags
 & 
SA_SIGINFO
;

62 ià(
	gis_sigšfo
 && 
	gaù
->
	g§_sigaùiÚ
) {

63 
	gaù
->
§_sigaùiÚ
(
signum
, 
šfo
, 
ucÚ‹xt
);

64 } ià(!
	gis_sigšfo
 && 
	gaù
->
	g§_hªdËr
) {

65 
	gaù
->
§_hªdËr
(
signum
);

67 
	g¡©us
 = 
Stus
(

68 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

69 
ab¦
::
SŒC©
("HªdË¸»gi¡”ed fÜ sigÇl: ", 
signum
, " is invalid"));

71 
S‘SigÇlMask
(
Şd_mask
);

72  
	g¡©us
;

75 
	gSigÇlMªag”
::
S‘SigAùiÚ
(
signum
, cÚ¡ 
sigaùiÚ
 &
aù
) {

77 
sig£t_t
 
	gmask
;

78 
sigfl£t
(&
mask
);

79 
sig£t_t
 
	gŞd_mask
;

80 
sig´ocmask
(
SIG_SETMASK
, &
mask
, &
Şd_mask
);

82 
	gab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_sigaùiÚ_lock_
);

83 
	gsigÇl_to_sigaùiÚ_
[
signum
] = 
ab¦
::
make_unique
<
sigaùiÚ
>(
aù
);

86 
sig´ocmask
(
SIG_SETMASK
, &
Şd_mask
, 
nuÎ±r
);

89 cÚ¡ 
sigaùiÚ
 *
	gSigÇlMªag”
::
G‘SigAùiÚ
(
signum
) const {

90 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_sigaùiÚ_lock_
);

91 autØ
	gsigaùiÚ_™”©Ü
 = 
sigÇl_to_sigaùiÚ_
.
fšd
(
signum
);

92 ià(
	gsigaùiÚ_™”©Ü
 =ğ
sigÇl_to_sigaùiÚ_
.
’d
()) {

93  
nuÎ±r
;

95  
	gsigaùiÚ_™”©Ü
->
	g£cÚd
.
g‘
();

98 
	gSigÇlMªag”
::
CË¬SigAùiÚ
(
signum
) {

99 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_sigaùiÚ_lock_
);

100 
	gsigÇl_to_sigaùiÚ_
.
”a£
(
signum
);

103 
	gSigÇlMªag”
::
BlockSigÇls
(cÚ¡ 
sig£t_t
 &
£t
) {

104 
signum
 = 0; 
	gsignum
 < 
	gkMaxSigÇlsInMask
; ++signum) {

105 ià(
sigismemb”
(&
£t
, 
signum
)) {

106 
sigadd£t
(&
sigÇl_mask_
, 
signum
);

111 
	gSigÇlMªag”
::
UnblockSigÇls
(cÚ¡ 
sig£t_t
 &
£t
) {

112 
signum
 = 0; 
	gsignum
 < 
	gkMaxSigÇlsInMask
; ++signum) {

113 ià(
sigismemb”
(&
£t
, 
signum
)) {

114 
sigd–£t
(&
sigÇl_mask_
, 
signum
);

119 
sig£t_t
 
	gSigÇlMªag”
::
G‘SigÇlMask
(ècÚ¡ {  
sigÇl_mask_
; }

121 
	gSigÇlMªag”
::
S‘SigÇlMask
(cÚ¡ 
sig£t_t
 &
mask
è{ 
sigÇl_mask_
 = mask; }

123 
sig£t_t
 
	gSigÇlMªag”
::
G‘UnblockedS‘
(cÚ¡ sig£t_ˆ&
£t
) {

124 
sig£t_t
 
sigÇls_to_unblock
;

125 
sigem±y£t
(&
sigÇls_to_unblock
);

126 
	gsignum
 = 0; signum < 
	gkMaxSigÇlsInMask
; ++signum) {

127 ià(!
sigismemb”
(&
£t
, 
signum
)) {

128 
sigadd£t
(&
sigÇls_to_unblock
, 
signum
);

131  
	gsigÇls_to_unblock
;

134 
	gSigÇlMªag”
::
S‘Re£tOnHªdË
(
signum
) {

135 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_»£t_lock_
);

136 
	gsigÇl_to_»£t_
.
š£¹
(
signum
);

139 
boŞ
 
	gSigÇlMªag”
::
IsRe£tOnHªdË
(
signum
) {

140 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_»£t_lock_
);

141  
	gsigÇl_to_»£t_
.
fšd
(
signum
è!ğ
sigÇl_to_»£t_
.
’d
();

	@platform/posix/signal/signal_manager.cc

19 
	~<sigÇl.h
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

24 
	~"asylo/¶©fÜm/posix/sigÇl/sigÇl_mªag”.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkMaxSigÇlsInMask
 = (
sig£t_t
) * 8;

31 
sig£t_t
 
Em±ySigS‘
() {

32 
sig£t_t
 
	g£t
;

33 
sigem±y£t
(&
£t
);

34  
	g£t
;

39 
th»ad_loÿl
 
sig£t_t
 
	gSigÇlMªag”
::
sigÇl_mask_
 = 
Em±ySigS‘
();

41 
SigÇlMªag”
 *
	gSigÇlMªag”
::
G‘In¡ªû
() {

42 
SigÇlMªag”
 *
š¡ªû
 = 
Ãw
 SignalManager();

43  
	gš¡ªû
;

46 
Stus
 
	gSigÇlMªag”
::
HªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
,

47 *
ucÚ‹xt
) {

48 
	g¡d
::
unique_±r
<
sigaùiÚ
> 
aù
 =

49 ::
ab¦
::
make_unique
<
sigaùiÚ
>(*
G‘SigAùiÚ
(
signum
));

50 ià(!
	gaù
) {

51  
Stus
(

52 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

53 
ab¦
::
SŒC©
("NØhªdË¸ha b“À»gi¡”ed fÜ sigÇl: ", 
signum
));

55 ià(
IsRe£tOnHªdË
(
signum
)) {

56 
CË¬SigAùiÚ
(
signum
);

58 
Stus
 
	g¡©us
;

59 
sig£t_t
 
	gŞd_mask
 = 
G‘SigÇlMask
();

60 
BlockSigÇls
(
aù
->
§_mask
);

61 
boŞ
 
	gis_sigšfo
 = 
aù
->
§_æags
 & 
SA_SIGINFO
;

62 ià(
	gis_sigšfo
 && 
	gaù
->
	g§_sigaùiÚ
) {

63 
	gaù
->
§_sigaùiÚ
(
signum
, 
šfo
, 
ucÚ‹xt
);

64 } ià(!
	gis_sigšfo
 && 
	gaù
->
	g§_hªdËr
) {

65 
	gaù
->
§_hªdËr
(
signum
);

67 
	g¡©us
 = 
Stus
(

68 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

69 
ab¦
::
SŒC©
("HªdË¸»gi¡”ed fÜ sigÇl: ", 
signum
, " is invalid"));

71 
S‘SigÇlMask
(
Şd_mask
);

72  
	g¡©us
;

75 
	gSigÇlMªag”
::
S‘SigAùiÚ
(
signum
, cÚ¡ 
sigaùiÚ
 &
aù
) {

77 
sig£t_t
 
	gmask
;

78 
sigfl£t
(&
mask
);

79 
sig£t_t
 
	gŞd_mask
;

80 
sig´ocmask
(
SIG_SETMASK
, &
mask
, &
Şd_mask
);

82 
	gab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_sigaùiÚ_lock_
);

83 
	gsigÇl_to_sigaùiÚ_
[
signum
] = 
ab¦
::
make_unique
<
sigaùiÚ
>(
aù
);

86 
sig´ocmask
(
SIG_SETMASK
, &
Şd_mask
, 
nuÎ±r
);

89 cÚ¡ 
sigaùiÚ
 *
	gSigÇlMªag”
::
G‘SigAùiÚ
(
signum
) const {

90 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_sigaùiÚ_lock_
);

91 autØ
	gsigaùiÚ_™”©Ü
 = 
sigÇl_to_sigaùiÚ_
.
fšd
(
signum
);

92 ià(
	gsigaùiÚ_™”©Ü
 =ğ
sigÇl_to_sigaùiÚ_
.
’d
()) {

93  
nuÎ±r
;

95  
	gsigaùiÚ_™”©Ü
->
	g£cÚd
.
g‘
();

98 
	gSigÇlMªag”
::
CË¬SigAùiÚ
(
signum
) {

99 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_sigaùiÚ_lock_
);

100 
	gsigÇl_to_sigaùiÚ_
.
”a£
(
signum
);

103 
	gSigÇlMªag”
::
BlockSigÇls
(cÚ¡ 
sig£t_t
 &
£t
) {

104 
signum
 = 0; 
	gsignum
 < 
	gkMaxSigÇlsInMask
; ++signum) {

105 ià(
sigismemb”
(&
£t
, 
signum
)) {

106 
sigadd£t
(&
sigÇl_mask_
, 
signum
);

111 
	gSigÇlMªag”
::
UnblockSigÇls
(cÚ¡ 
sig£t_t
 &
£t
) {

112 
signum
 = 0; 
	gsignum
 < 
	gkMaxSigÇlsInMask
; ++signum) {

113 ià(
sigismemb”
(&
£t
, 
signum
)) {

114 
sigd–£t
(&
sigÇl_mask_
, 
signum
);

119 
sig£t_t
 
	gSigÇlMªag”
::
G‘SigÇlMask
(ècÚ¡ {  
sigÇl_mask_
; }

121 
	gSigÇlMªag”
::
S‘SigÇlMask
(cÚ¡ 
sig£t_t
 &
mask
è{ 
sigÇl_mask_
 = mask; }

123 
sig£t_t
 
	gSigÇlMªag”
::
G‘UnblockedS‘
(cÚ¡ sig£t_ˆ&
£t
) {

124 
sig£t_t
 
sigÇls_to_unblock
;

125 
sigem±y£t
(&
sigÇls_to_unblock
);

126 
	gsignum
 = 0; signum < 
	gkMaxSigÇlsInMask
; ++signum) {

127 ià(!
sigismemb”
(&
£t
, 
signum
)) {

128 
sigadd£t
(&
sigÇls_to_unblock
, 
signum
);

131  
	gsigÇls_to_unblock
;

134 
	gSigÇlMªag”
::
S‘Re£tOnHªdË
(
signum
) {

135 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_»£t_lock_
);

136 
	gsigÇl_to_»£t_
.
š£¹
(
signum
);

139 
boŞ
 
	gSigÇlMªag”
::
IsRe£tOnHªdË
(
signum
) {

140 
ab¦
::
Mu‹xLock
 
lock
(&
sigÇl_to_»£t_lock_
);

141  
	gsigÇl_to_»£t_
.
fšd
(
signum
è!ğ
sigÇl_to_»£t_
.
’d
();

	@platform/posix/signal/signal_manager.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_SIGNAL_SIGNAL_MANAGER_H_


20 
	#ASYLO_PLATFORM_POSIX_SIGNAL_SIGNAL_MANAGER_H_


	)

22 
	~<sigÇl.h
>

23 
	~<memÜy
>

25 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

34 şas 
	cSigÇlMªag”
 {

35 
	gpublic
:

36 
SigÇlMªag”
 *
G‘In¡ªû
();

39 
Stus
 
HªdËSigÇl
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
);

42 
S‘SigAùiÚ
(
signum
, cÚ¡ 
sigaùiÚ
 &
aù
)

43 
LOCKS_EXCLUDED
(
sigÇl_to_sigaùiÚ_lock_
);

46 cÚ¡ 
sigaùiÚ
 *
G‘SigAùiÚ
(
signum
) const

47 
LOCKS_EXCLUDED
(
sigÇl_to_sigaùiÚ_lock_
);

50 
CË¬SigAùiÚ
(
signum
è
LOCKS_EXCLUDED
(
sigÇl_to_sigaùiÚ_lock_
);

53 
BlockSigÇls
(cÚ¡ 
sig£t_t
 &
£t
);

56 
UnblockSigÇls
(cÚ¡ 
sig£t_t
 &
£t
);

59 
sig£t_t
 
G‘SigÇlMask
() const;

62 
S‘SigÇlMask
(cÚ¡ 
sig£t_t
 &
mask
);

65 
sig£t_t
 
G‘UnblockedS‘
(cÚ¡ sig£t_ˆ&
£t
);

68 
S‘Re£tOnHªdË
(
signum
è
LOCKS_EXCLUDED
(
sigÇl_to_»£t_lock_
);

71 
boŞ
 
IsRe£tOnHªdË
(
signum
è
LOCKS_EXCLUDED
(
sigÇl_to_»£t_lock_
);

73 
	g´iv©e
:

74 
SigÇlMªag”
() = ;

75 
SigÇlMªag”
(SigÇlMªag” cÚ¡ &èğ
d–‘e
;

76 
	gİ”©Ü
=(
SigÇlMªag”
 cÚ¡ &èğ
d–‘e
;

78 
mubË
 
	gab¦
::
Mu‹x
 
sigÇl_to_sigaùiÚ_lock_
;

79 
	gab¦
::
æ©_hash_m­
<, 
	g¡d
::
unique_±r
<
sigaùiÚ
>>

80 
sigÇl_to_sigaùiÚ_
 
GUARDED_BY
(
sigÇl_to_sigaùiÚ_lock_
);

82 
mubË
 
	gab¦
::
Mu‹x
 
sigÇl_to_»£t_lock_
;

83 
	gab¦
::
æ©_hash_£t
<> 
sigÇl_to_»£t_
 
GUARDED_BY
(
sigÇl_to_»£t_lock_
);

85 
th»ad_loÿl
 
sig£t_t
 
	gsigÇl_mask_
;

	@platform/posix/sockets/addrinfo_test_driver.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

21 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

22 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 şas 
	cAddršfoTe¡
 : 
public
 
EnşaveTe¡
 {

28 
´Ùeùed
:

29 
S‘EnşaveIÅut
(
EnşaveIÅut
 *
’şave_šput
,

30 cÚ¡ 
AddrInfoTe¡IÅut
::
Te¡Mode
 
mode
) {

31 
AddrInfoTe¡IÅut
 
‹¡_šput
;

32 
	g‹¡_šput
.
£t_mode
(
mode
);

33 *
	g’şave_šput
->
MubËEx‹nsiÚ
(
addršfo_‹¡_šput
èğ
‹¡_šput
;

38 
TEST_F
(
AddršfoTe¡
, 
AddršfoNoHštsTe¡
) {

39 
EnşaveIÅut
 
	g’şave_šput
;

40 
S‘EnşaveIÅut
(&
’şave_šput
, 
AddrInfoTe¡IÅut
::
NO_HINTS
);

41 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

45 
TEST_F
(
AddršfoTe¡
, 
AddršfoUn¥ecHštsTe¡
) {

46 
EnşaveIÅut
 
	g’şave_šput
;

47 
S‘EnşaveIÅut
(&
’şave_šput
, 
AddrInfoTe¡IÅut
::
UNSPEC_HINTS
);

48 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

52 
TEST_F
(
AddršfoTe¡
, 
AddršfoIpHštsTe¡
) {

53 
EnşaveIÅut
 
	g’şave_šput
;

54 
S‘EnşaveIÅut
(&
’şave_šput
, 
AddrInfoTe¡IÅut
::
IP_HINTS
);

55 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

	@platform/posix/sockets/addrinfo_test_driver.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

21 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

22 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 şas 
	cAddršfoTe¡
 : 
public
 
EnşaveTe¡
 {

28 
´Ùeùed
:

29 
S‘EnşaveIÅut
(
EnşaveIÅut
 *
’şave_šput
,

30 cÚ¡ 
AddrInfoTe¡IÅut
::
Te¡Mode
 
mode
) {

31 
AddrInfoTe¡IÅut
 
‹¡_šput
;

32 
	g‹¡_šput
.
£t_mode
(
mode
);

33 *
	g’şave_šput
->
MubËEx‹nsiÚ
(
addršfo_‹¡_šput
èğ
‹¡_šput
;

38 
TEST_F
(
AddršfoTe¡
, 
AddršfoNoHštsTe¡
) {

39 
EnşaveIÅut
 
	g’şave_šput
;

40 
S‘EnşaveIÅut
(&
’şave_šput
, 
AddrInfoTe¡IÅut
::
NO_HINTS
);

41 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

45 
TEST_F
(
AddršfoTe¡
, 
AddršfoUn¥ecHštsTe¡
) {

46 
EnşaveIÅut
 
	g’şave_šput
;

47 
S‘EnşaveIÅut
(&
’şave_šput
, 
AddrInfoTe¡IÅut
::
UNSPEC_HINTS
);

48 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

52 
TEST_F
(
AddršfoTe¡
, 
AddršfoIpHštsTe¡
) {

53 
EnşaveIÅut
 
	g’şave_šput
;

54 
S‘EnşaveIÅut
(&
’şave_šput
, 
AddrInfoTe¡IÅut
::
IP_HINTS
);

55 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

	@platform/posix/sockets/addrinfo_test_enclave.cc

19 
	~<Ãtdb.h
>

20 
	~<Ãtš‘/š.h
>

21 
	~<sys/sock‘.h
>

22 
	~<¡ršg
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cAddršfoTe¡Enşave
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
AddršfoTe¡Enşave
() = ;

34 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

35 ià(!
	gšput
.
HasEx‹nsiÚ
(
addršfo_‹¡_šput
)) {

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

40 
	gAddrInfoTe¡IÅut
::
Te¡Mode
 
mode
 =

41 
šput
.
G‘Ex‹nsiÚ
(
addršfo_‹¡_šput
).
mode
();

43 
	gmode
) {

44 
	gAddrInfoTe¡IÅut
::
NO_HINTS
:

45  
AddrInfoTe¡_NoHšts
();

46 
	gAddrInfoTe¡IÅut
::
UNSPEC_HINTS
:

47  
AddrInfoTe¡_Un¥ecHšts
();

48 
	gAddrInfoTe¡IÅut
::
IP_HINTS
:

49  
AddrInfoTe¡_IpHšts
();

51  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

56 
	g´iv©e
:

57 
boŞ
 
V”ifyLoÿlHo¡AddrInfoCªÚÇme
(cÚ¡ 
addršfo
 *
šfo
) {

61 ià(
šfo
 =ğ
nuÎ±r
) {

62 
LOG
(
ERROR
) << "No‡ddrinfo„eturned!";

63  
	gçl£
;

65 ià(
	gšfo
->
	gai_ÿnÚÇme
 =ğ
nuÎ±r
) {

66 
LOG
(
ERROR
) << "No canonname„eturned!";

67  
	gçl£
;

69 ià(!
¡r¡r
(
šfo
->
ai_ÿnÚÇme
, "localhost")) {

70 
LOG
(
ERROR
è<< "UÃx³ùed cªÚ ho¡Çm" << 
	gšfo
->
	gai_ÿnÚÇme
;

71  
	gçl£
;

73  
	gŒue
;

76 
boŞ
 
V”ifyLoÿlHo¡AddrInfoAdd»ss
(cÚ¡ 
addršfo
 *
šfo
) {

77 
	gaddr_buf
[
INET_ADDRSTRLEN
];

78 cÚ¡ 
addršfo
 *
	gi
 = 
šfo
; i !ğ
nuÎ±r
; i = 
i
->
ai_Ãxt
) {

79 
mem£t
(
addr_buf
, 0, (addr_buf));

82 ià(
	gi
->
	gai_çmy
 =ğ
AF_INET6
) {

83 
š6_addr
 *
sš_addr6
 =

84 &(
»š‹½»t_ÿ¡
<
sockaddr_š6
 *>(
i
->
ai_addr
)->
sš6_addr
);

85 
š‘_Áİ
(
i
->
ai_çmy
, 
sš_addr6
, 
addr_buf
, (addr_buf));

86 ià(
¡rcmp
(
addr_buf
, "::1"è!ğ0è 
çl£
;

87 } ià(
	gi
->
	gai_çmy
 =ğ
AF_INET
) {

88 
š_addr
 *
sš_addr
 =

89 &(
»š‹½»t_ÿ¡
<
sockaddr_š
 *>(
i
->
ai_addr
)->
sš_addr
);

90 
š‘_Áİ
(
i
->
ai_çmy
, 
sš_addr
, 
addr_buf
, (addr_buf));

91 ià(
¡rcmp
(
addr_buf
, "127.0.0.1"è!ğ0è 
çl£
;

94  
	gŒue
;

97 
boŞ
 
G‘AddrInfoFÜLoÿlHo¡
(cÚ¡ 
addršfo
 *
hšts
,

98 
addršfo
 **
»s
) {

99  
g‘addršfo
("loÿlho¡", 
nuÎ±r
, 
hšts
, 
»s
) == 0;

102 
Stus
 
AddrInfoTe¡_NoHšts
() {

103 
addršfo
 *
	gšfo
 = 
nuÎ±r
;

104 ià(!
G‘AddrInfoFÜLoÿlHo¡
Ğ
nuÎ±r
, &
šfo
)) {

105  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

108 ià(!
V”ifyLoÿlHo¡AddrInfoAdd»ss
(
šfo
)) {

109  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

112 
ä“addršfo
(
šfo
);

113  
	gStus
::
OkStus
();

116 
Stus
 
AddrInfoTe¡_Un¥ecHšts
() {

117 
addršfo
 *
	gšfo
 = 
nuÎ±r
;

118 
addršfo
 
	ghšts
;

119 
mem£t
(&
hšts
, 0, (hints));

120 
	ghšts
.
	gai_çmy
 = 
AF_UNSPEC
;

121 
	ghšts
.
	gai_sockty³
 = 
SOCK_STREAM
;

122 
	ghšts
.
	gai_æags
 = 
AI_CANONNAME
;

123 ià(!
G‘AddrInfoFÜLoÿlHo¡
(&
hšts
, &
šfo
)) {

124  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

127 ià(!
V”ifyLoÿlHo¡AddrInfoAdd»ss
(
šfo
)) {

128  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

131 ià(!
V”ifyLoÿlHo¡AddrInfoCªÚÇme
(
šfo
)) {

132  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

135 
ä“addršfo
(
šfo
);

136  
	gStus
::
OkStus
();

139 
Stus
 
AddrInfoTe¡_IpHšts
() {

140 
addršfo
 *
	gšfo
 = 
nuÎ±r
;

141 
addršfo
 
	ghšts
;

142 
mem£t
(&
hšts
, 0, (hints));

143 
	ghšts
.
	gai_çmy
 = 
AF_INET
 | 
AF_INET6
;

144 
	ghšts
.
	gai_sockty³
 = 
SOCK_STREAM
;

145 
	ghšts
.
	gai_æags
 = 
AI_CANONNAME
;

146 ià(!
G‘AddrInfoFÜLoÿlHo¡
(&
hšts
, &
šfo
)) {

147  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

150 ià(!
V”ifyLoÿlHo¡AddrInfoAdd»ss
(
šfo
)) {

151  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

154 ià(!
V”ifyLoÿlHo¡AddrInfoCªÚÇme
(
šfo
)) {

155  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

158 
ä“addršfo
(
šfo
);

159  
	gStus
::
OkStus
();

163 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

164  
Ãw
 
AddršfoTe¡Enşave
;

165 
	}
}

	@platform/posix/sockets/addrinfo_test_enclave.cc

19 
	~<Ãtdb.h
>

20 
	~<Ãtš‘/š.h
>

21 
	~<sys/sock‘.h
>

22 
	~<¡ršg
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cAddršfoTe¡Enşave
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
AddršfoTe¡Enşave
() = ;

34 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

35 ià(!
	gšput
.
HasEx‹nsiÚ
(
addršfo_‹¡_šput
)) {

36  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

40 
	gAddrInfoTe¡IÅut
::
Te¡Mode
 
mode
 =

41 
šput
.
G‘Ex‹nsiÚ
(
addršfo_‹¡_šput
).
mode
();

43 
	gmode
) {

44 
	gAddrInfoTe¡IÅut
::
NO_HINTS
:

45  
AddrInfoTe¡_NoHšts
();

46 
	gAddrInfoTe¡IÅut
::
UNSPEC_HINTS
:

47  
AddrInfoTe¡_Un¥ecHšts
();

48 
	gAddrInfoTe¡IÅut
::
IP_HINTS
:

49  
AddrInfoTe¡_IpHšts
();

51  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

56 
	g´iv©e
:

57 
boŞ
 
V”ifyLoÿlHo¡AddrInfoCªÚÇme
(cÚ¡ 
addršfo
 *
šfo
) {

61 ià(
šfo
 =ğ
nuÎ±r
) {

62 
LOG
(
ERROR
) << "No‡ddrinfo„eturned!";

63  
	gçl£
;

65 ià(
	gšfo
->
	gai_ÿnÚÇme
 =ğ
nuÎ±r
) {

66 
LOG
(
ERROR
) << "No canonname„eturned!";

67  
	gçl£
;

69 ià(!
¡r¡r
(
šfo
->
ai_ÿnÚÇme
, "localhost")) {

70 
LOG
(
ERROR
è<< "UÃx³ùed cªÚ ho¡Çm" << 
	gšfo
->
	gai_ÿnÚÇme
;

71  
	gçl£
;

73  
	gŒue
;

76 
boŞ
 
V”ifyLoÿlHo¡AddrInfoAdd»ss
(cÚ¡ 
addršfo
 *
šfo
) {

77 
	gaddr_buf
[
INET_ADDRSTRLEN
];

78 cÚ¡ 
addršfo
 *
	gi
 = 
šfo
; i !ğ
nuÎ±r
; i = 
i
->
ai_Ãxt
) {

79 
mem£t
(
addr_buf
, 0, (addr_buf));

82 ià(
	gi
->
	gai_çmy
 =ğ
AF_INET6
) {

83 
š6_addr
 *
sš_addr6
 =

84 &(
»š‹½»t_ÿ¡
<
sockaddr_š6
 *>(
i
->
ai_addr
)->
sš6_addr
);

85 
š‘_Áİ
(
i
->
ai_çmy
, 
sš_addr6
, 
addr_buf
, (addr_buf));

86 ià(
¡rcmp
(
addr_buf
, "::1"è!ğ0è 
çl£
;

87 } ià(
	gi
->
	gai_çmy
 =ğ
AF_INET
) {

88 
š_addr
 *
sš_addr
 =

89 &(
»š‹½»t_ÿ¡
<
sockaddr_š
 *>(
i
->
ai_addr
)->
sš_addr
);

90 
š‘_Áİ
(
i
->
ai_çmy
, 
sš_addr
, 
addr_buf
, (addr_buf));

91 ià(
¡rcmp
(
addr_buf
, "127.0.0.1"è!ğ0è 
çl£
;

94  
	gŒue
;

97 
boŞ
 
G‘AddrInfoFÜLoÿlHo¡
(cÚ¡ 
addršfo
 *
hšts
,

98 
addršfo
 **
»s
) {

99  
g‘addršfo
("loÿlho¡", 
nuÎ±r
, 
hšts
, 
»s
) == 0;

102 
Stus
 
AddrInfoTe¡_NoHšts
() {

103 
addršfo
 *
	gšfo
 = 
nuÎ±r
;

104 ià(!
G‘AddrInfoFÜLoÿlHo¡
Ğ
nuÎ±r
, &
šfo
)) {

105  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

108 ià(!
V”ifyLoÿlHo¡AddrInfoAdd»ss
(
šfo
)) {

109  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

112 
ä“addršfo
(
šfo
);

113  
	gStus
::
OkStus
();

116 
Stus
 
AddrInfoTe¡_Un¥ecHšts
() {

117 
addršfo
 *
	gšfo
 = 
nuÎ±r
;

118 
addršfo
 
	ghšts
;

119 
mem£t
(&
hšts
, 0, (hints));

120 
	ghšts
.
	gai_çmy
 = 
AF_UNSPEC
;

121 
	ghšts
.
	gai_sockty³
 = 
SOCK_STREAM
;

122 
	ghšts
.
	gai_æags
 = 
AI_CANONNAME
;

123 ià(!
G‘AddrInfoFÜLoÿlHo¡
(&
hšts
, &
šfo
)) {

124  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

127 ià(!
V”ifyLoÿlHo¡AddrInfoAdd»ss
(
šfo
)) {

128  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

131 ià(!
V”ifyLoÿlHo¡AddrInfoCªÚÇme
(
šfo
)) {

132  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

135 
ä“addršfo
(
šfo
);

136  
	gStus
::
OkStus
();

139 
Stus
 
AddrInfoTe¡_IpHšts
() {

140 
addršfo
 *
	gšfo
 = 
nuÎ±r
;

141 
addršfo
 
	ghšts
;

142 
mem£t
(&
hšts
, 0, (hints));

143 
	ghšts
.
	gai_çmy
 = 
AF_INET
 | 
AF_INET6
;

144 
	ghšts
.
	gai_sockty³
 = 
SOCK_STREAM
;

145 
	ghšts
.
	gai_æags
 = 
AI_CANONNAME
;

146 ià(!
G‘AddrInfoFÜLoÿlHo¡
(&
hšts
, &
šfo
)) {

147  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

150 ià(!
V”ifyLoÿlHo¡AddrInfoAdd»ss
(
šfo
)) {

151  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

154 ià(!
V”ifyLoÿlHo¡AddrInfoCªÚÇme
(
šfo
)) {

155  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

158 
ä“addršfo
(
šfo
);

159  
	gStus
::
OkStus
();

163 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

164  
Ãw
 
AddršfoTe¡Enşave
;

165 
	}
}

	@platform/posix/sockets/domain_socket_test_driver.cc

19 
	~<¡dio.h
>

20 
	~<sys/¡©.h
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/ş›Á.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

30 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

31 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

32 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

33 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

34 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

35 
	~"asylo/‹¡/ut/‹¡_æags.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 
	gusšg
 ::
‹¡šg
::
Lt
;

44 
cÚ¡ex´
 
	gkMaxSock‘NameL’
 = 108;

46 şas 
	cDomašSock‘Driv”
 : 
public
 
EnşaveTe¡
 {

47 
´Ùeùed
:

49 
EnşaveIÅut
 
BudEnşaveIÅut
(cÚ¡ 
Sock‘Te¡IÅut
::
Sock‘AùiÚ
 &
aùiÚ
,

50 cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
,

51 
boŞ
 
u£_·th_Ën
) {

52 
Sock‘Te¡IÅut
 
	g‹¡_šput
;

53 
	g‹¡_šput
.
£t_aùiÚ
(
aùiÚ
);

54 
	g‹¡_šput
.
£t_sock‘_Çme
(
sock‘_Çme
);

55 
	g‹¡_šput
.
£t_u£_·th_Ën
(
u£_·th_Ën
);

57 
EnşaveIÅut
 
	g»t
;

58 *
	g»t
.
MubËEx‹nsiÚ
(
sock‘_‹¡_šput
èğ
‹¡_šput
;

60  
	g»t
;

64 
	g¡d
::
¡ršg
 
G‘S”v”Sock‘
(
¡d
::¡ršg 
sub_·th
) {

65 
¡d
::
¡ršg
 
£rv”_sock‘
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, 
sub_·th
);

72 ià(
	g£rv”_sock‘
.
Ëngth
(è>ğ
kMaxSock‘NameL’
) {

73 
¡©
 
¡©_buf
;

74 
EXPECT_TRUE
(!
¡©
("/tmp", &
¡©_buf
è&& 
S_ISDIR
(¡©_buf.
¡_mode
) &&

75 (
¡©_buf
.
¡_mode
 & 
S_IRUSR
è&& (¡©_buf.¡_mod& 
S_IWUSR
));

76 
	g£rv”_sock‘
 = 
ab¦
::
SŒC©
("/tmp", 
sub_·th
);

78 
EXPECT_THAT
(
£rv”_sock‘
.
Ëngth
(), 
Lt
(
kMaxSock‘NameL’
));

79 
LOG
(
INFO
) << "Cleaning up socket file if…resent, server_socket = "

80 << 
	g£rv”_sock‘
;

81 
	g»s
 = 
»move
(
£rv”_sock‘
.
c_¡r
());

82 ià(
	g»s
 != 0) {

83 
LOG
(
INFO
) << "remove failed";

85  
	g£rv”_sock‘
;

89 
AµS”v”S‘up
(
Sock‘S”v”
 *
­p_sock‘_£rv”
,

90 cÚ¡ 
¡d
::
¡ršg
 &
­p_£rv”_sock‘
,

91 
boŞ
 
u£_·th_Ën
) {

92 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”S‘up
(
­p_£rv”_sock‘
, 
u£_·th_Ën
),

93 
IsOk
());

97 
AµS”v”Th»ad
(
Sock‘S”v”
 *
­p_sock‘_£rv”
) {

98 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”Acû±
(), 
IsOk
());

99 
EXPECT_THAT
(
S”v”T¿nsm™
(
­p_sock‘_£rv”
), 
IsOk
());

103 
AµCl›ÁTh»ad
(cÚ¡ 
¡d
::
¡ršg
 &
’c_£rv”_sock‘
,

104 
boŞ
 
u£_·th_Ën
) {

105 
Sock‘Cl›Á
 
	g­p_sock‘_ş›Á
;

106 
EXPECT_THAT
(

107 
­p_sock‘_ş›Á
.
Cl›ÁS‘up
(
’c_£rv”_sock‘
, 
nuÎ±r
, 
u£_·th_Ën
),

108 
IsOk
());

109 
EXPECT_THAT
(
Cl›ÁT¿nsm™
(&
­p_sock‘_ş›Á
), 
IsOk
());

116 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveCl›ÁTe¡W™hU£P©hL’F®£
) {

117 
	g¡d
::
¡ršg
 
­p_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/app_server_socket");

118 
Sock‘S”v”
 
	g­p_sock‘_£rv”
;

119 
AµS”v”S‘up
(&
­p_sock‘_£rv”
, 
­p_£rv”_sock‘
, 
çl£
);

120 
	g¡d
::
th»ad
 
­p_£rv”_th»ad
(&
AµS”v”Th»ad
, &
­p_sock‘_£rv”
);

121 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(

122 
Sock‘Te¡IÅut
::
RUNCLIENT
, 
­p_£rv”_sock‘
, 
çl£
);

123 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

124 
	g­p_£rv”_th»ad
.
još
();

130 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveCl›ÁTe¡W™hU£P©hL’True
) {

131 
	g¡d
::
¡ršg
 
­p_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/app_server_socket");

132 
Sock‘S”v”
 
	g­p_sock‘_£rv”
;

133 
AµS”v”S‘up
(&
­p_sock‘_£rv”
, 
­p_£rv”_sock‘
, 
Œue
);

134 
	g¡d
::
th»ad
 
­p_£rv”_th»ad
(&
AµS”v”Th»ad
, &
­p_sock‘_£rv”
);

135 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(

136 
Sock‘Te¡IÅut
::
RUNCLIENT
, 
­p_£rv”_sock‘
, 
Œue
);

137 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

138 
	g­p_£rv”_th»ad
.
još
();

144 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveS”v”Te¡W™hU£P©hL’True
) {

145 
	g¡d
::
¡ršg
 
’c_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/enc_server_socket");

146 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(

147 
Sock‘Te¡IÅut
::
INITSERVER
, 
’c_£rv”_sock‘
, 
Œue
);

148 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

149 
	g¡d
::
th»ad
 
­p_ş›Á_th»ad
(&
AµCl›ÁTh»ad
, 
’c_£rv”_sock‘
,

150  
Œue
);

151 
	g’şave_šput
 = 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNSERVER
,

152 
’c_£rv”_sock‘
, 
Œue
);

153 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

154 
	g­p_ş›Á_th»ad
.
još
();

160 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveS”v”Te¡W™hU£P©hL’F®£
) {

161 
	g¡d
::
¡ršg
 
’c_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/enc_server_socket");

162 
EnşaveIÅut
 
	g’şave_šput
 =

163 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
INITSERVER
, 
’c_£rv”_sock‘
, 
çl£
);

164 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

165 
	g¡d
::
th»ad
 
­p_ş›Á_th»ad
(&
AµCl›ÁTh»ad
, 
’c_£rv”_sock‘
,

166  
çl£
);

167 
	g’şave_šput
 = 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNSERVER
,

168 
’c_£rv”_sock‘
, 
çl£
);

169 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

170 
	g­p_ş›Á_th»ad
.
još
();

	@platform/posix/sockets/domain_socket_test_driver.cc

19 
	~<¡dio.h
>

20 
	~<sys/¡©.h
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/ş›Á.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

30 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

31 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

32 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

33 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

34 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

35 
	~"asylo/‹¡/ut/‹¡_æags.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 
	gusšg
 ::
‹¡šg
::
Lt
;

44 
cÚ¡ex´
 
	gkMaxSock‘NameL’
 = 108;

46 şas 
	cDomašSock‘Driv”
 : 
public
 
EnşaveTe¡
 {

47 
´Ùeùed
:

49 
EnşaveIÅut
 
BudEnşaveIÅut
(cÚ¡ 
Sock‘Te¡IÅut
::
Sock‘AùiÚ
 &
aùiÚ
,

50 cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
,

51 
boŞ
 
u£_·th_Ën
) {

52 
Sock‘Te¡IÅut
 
	g‹¡_šput
;

53 
	g‹¡_šput
.
£t_aùiÚ
(
aùiÚ
);

54 
	g‹¡_šput
.
£t_sock‘_Çme
(
sock‘_Çme
);

55 
	g‹¡_šput
.
£t_u£_·th_Ën
(
u£_·th_Ën
);

57 
EnşaveIÅut
 
	g»t
;

58 *
	g»t
.
MubËEx‹nsiÚ
(
sock‘_‹¡_šput
èğ
‹¡_šput
;

60  
	g»t
;

64 
	g¡d
::
¡ršg
 
G‘S”v”Sock‘
(
¡d
::¡ršg 
sub_·th
) {

65 
¡d
::
¡ršg
 
£rv”_sock‘
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, 
sub_·th
);

72 ià(
	g£rv”_sock‘
.
Ëngth
(è>ğ
kMaxSock‘NameL’
) {

73 
¡©
 
¡©_buf
;

74 
EXPECT_TRUE
(!
¡©
("/tmp", &
¡©_buf
è&& 
S_ISDIR
(¡©_buf.
¡_mode
) &&

75 (
¡©_buf
.
¡_mode
 & 
S_IRUSR
è&& (¡©_buf.¡_mod& 
S_IWUSR
));

76 
	g£rv”_sock‘
 = 
ab¦
::
SŒC©
("/tmp", 
sub_·th
);

78 
EXPECT_THAT
(
£rv”_sock‘
.
Ëngth
(), 
Lt
(
kMaxSock‘NameL’
));

79 
LOG
(
INFO
) << "Cleaning up socket file if…resent, server_socket = "

80 << 
	g£rv”_sock‘
;

81 
	g»s
 = 
»move
(
£rv”_sock‘
.
c_¡r
());

82 ià(
	g»s
 != 0) {

83 
LOG
(
INFO
) << "remove failed";

85  
	g£rv”_sock‘
;

89 
AµS”v”S‘up
(
Sock‘S”v”
 *
­p_sock‘_£rv”
,

90 cÚ¡ 
¡d
::
¡ršg
 &
­p_£rv”_sock‘
,

91 
boŞ
 
u£_·th_Ën
) {

92 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”S‘up
(
­p_£rv”_sock‘
, 
u£_·th_Ën
),

93 
IsOk
());

97 
AµS”v”Th»ad
(
Sock‘S”v”
 *
­p_sock‘_£rv”
) {

98 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”Acû±
(), 
IsOk
());

99 
EXPECT_THAT
(
S”v”T¿nsm™
(
­p_sock‘_£rv”
), 
IsOk
());

103 
AµCl›ÁTh»ad
(cÚ¡ 
¡d
::
¡ršg
 &
’c_£rv”_sock‘
,

104 
boŞ
 
u£_·th_Ën
) {

105 
Sock‘Cl›Á
 
	g­p_sock‘_ş›Á
;

106 
EXPECT_THAT
(

107 
­p_sock‘_ş›Á
.
Cl›ÁS‘up
(
’c_£rv”_sock‘
, 
nuÎ±r
, 
u£_·th_Ën
),

108 
IsOk
());

109 
EXPECT_THAT
(
Cl›ÁT¿nsm™
(&
­p_sock‘_ş›Á
), 
IsOk
());

116 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveCl›ÁTe¡W™hU£P©hL’F®£
) {

117 
	g¡d
::
¡ršg
 
­p_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/app_server_socket");

118 
Sock‘S”v”
 
	g­p_sock‘_£rv”
;

119 
AµS”v”S‘up
(&
­p_sock‘_£rv”
, 
­p_£rv”_sock‘
, 
çl£
);

120 
	g¡d
::
th»ad
 
­p_£rv”_th»ad
(&
AµS”v”Th»ad
, &
­p_sock‘_£rv”
);

121 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(

122 
Sock‘Te¡IÅut
::
RUNCLIENT
, 
­p_£rv”_sock‘
, 
çl£
);

123 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

124 
	g­p_£rv”_th»ad
.
još
();

130 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveCl›ÁTe¡W™hU£P©hL’True
) {

131 
	g¡d
::
¡ršg
 
­p_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/app_server_socket");

132 
Sock‘S”v”
 
	g­p_sock‘_£rv”
;

133 
AµS”v”S‘up
(&
­p_sock‘_£rv”
, 
­p_£rv”_sock‘
, 
Œue
);

134 
	g¡d
::
th»ad
 
­p_£rv”_th»ad
(&
AµS”v”Th»ad
, &
­p_sock‘_£rv”
);

135 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(

136 
Sock‘Te¡IÅut
::
RUNCLIENT
, 
­p_£rv”_sock‘
, 
Œue
);

137 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

138 
	g­p_£rv”_th»ad
.
još
();

144 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveS”v”Te¡W™hU£P©hL’True
) {

145 
	g¡d
::
¡ršg
 
’c_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/enc_server_socket");

146 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(

147 
Sock‘Te¡IÅut
::
INITSERVER
, 
’c_£rv”_sock‘
, 
Œue
);

148 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

149 
	g¡d
::
th»ad
 
­p_ş›Á_th»ad
(&
AµCl›ÁTh»ad
, 
’c_£rv”_sock‘
,

150  
Œue
);

151 
	g’şave_šput
 = 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNSERVER
,

152 
’c_£rv”_sock‘
, 
Œue
);

153 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

154 
	g­p_ş›Á_th»ad
.
još
();

160 
TEST_F
(
DomašSock‘Driv”
, 
EnşaveS”v”Te¡W™hU£P©hL’F®£
) {

161 
	g¡d
::
¡ršg
 
’c_£rv”_sock‘
 = 
G‘S”v”Sock‘
("/enc_server_socket");

162 
EnşaveIÅut
 
	g’şave_šput
 =

163 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
INITSERVER
, 
’c_£rv”_sock‘
, 
çl£
);

164 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

165 
	g¡d
::
th»ad
 
­p_ş›Á_th»ad
(&
AµCl›ÁTh»ad
, 
’c_£rv”_sock‘
,

166  
çl£
);

167 
	g’şave_šput
 = 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNSERVER
,

168 
’c_£rv”_sock‘
, 
çl£
);

169 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

170 
	g­p_ş›Á_th»ad
.
još
();

	@platform/posix/sockets/domain_socket_test_enclave.cc

19 
	~<sys/un.h
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

23 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

24 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cDomašSock‘Te¡
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

33 ià(!
	gšput
.
HasEx‹nsiÚ
(
sock‘_‹¡_šput
)) {

34  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

37 
Sock‘Te¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sock‘_‹¡_šput
);

38 ià(!
	g‹¡_šput
.
has_aùiÚ
(è|| !‹¡_šput.
has_sock‘_Çme
()) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 
	gSock‘Te¡IÅut
::
Sock‘AùiÚ
 
’c_commªd
 = 
‹¡_šput
.
aùiÚ
();

43 
	g¡d
::
¡ršg
 
sock‘_Çme
 = 
‹¡_šput
.socket_name();

45 ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
INITSERVER
) {

46  
EncS‘upS”v”
(
sock‘_Çme
, 
‹¡_šput
.
u£_·th_Ën
());

47 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNSERVER
) {

48  
EncRunS”v”
();

49 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNCLIENT
) {

50  
EncRunCl›Á
(
sock‘_Çme
, 
‹¡_šput
.
u£_·th_Ën
());

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57 
	g´iv©e
:

59 
Stus
 
EncS‘upS”v”
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
, 
boŞ
 
u£_·th_Ën
) {

60 ià(!
	g’c_sock‘_£rv”_
.
S”v”S‘up
(
sock‘_Çme
, 
u£_·th_Ën
).
ok
()) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server setup failed");

63  
	gStus
::
OkStus
();

67 
Stus
 
EncRunS”v”
() {

68 ià(!
	g’c_sock‘_£rv”_
.
S”v”Acû±
().
ok
()) {

69  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server‡ccept failed");

71 ià(!
S”v”T¿nsm™
(&
’c_sock‘_£rv”_
).
ok
()) {

72  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Serverransmit failed");

74  
	gStus
::
OkStus
();

78 
Stus
 
EncRunCl›Á
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
, 
boŞ
 
u£_·th_Ën
) {

79 
Sock‘Cl›Á
 
	g’c_sock‘_ş›Á
;

80 
sockaddr_un
 
	g­p_£rv”_sockaddr
;

81 ià(!
	g’c_sock‘_ş›Á


82 .
Cl›ÁS‘up
(
sock‘_Çme
, &
­p_£rv”_sockaddr
, 
u£_·th_Ën
)

83 .
ok
()) {

84  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Client setup failed");

90 
sockaddr_¡Üage
 
	g³”_sockaddr
;

91 
sockËn_t
 
	g³”_sockaddr_Ën
 = (
³”_sockaddr
);

92 
Stus
 
	g»tv®
 = 
’c_sock‘_ş›Á
.
G‘P“ºame
(

93 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
³”_sockaddr
),

94 &
³”_sockaddr_Ën
);

95 ià(!
	g»tv®
.
ok
()) {

96  
	g»tv®
;

98 
sockaddr_un
 *
	g³”_sockaddr_un
 = (sockaddr_uÀ*)&
³”_sockaddr
;

99 ià(
	g­p_£rv”_sockaddr
.
	gsun_çmy
 !ğ
³”_sockaddr_un
->
sun_çmy
) {

100 
LOG
(
ERROR
) << "peer‡ddr is incorrect family";

101  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getpeername failure 2");

104 ià(!
Cl›ÁT¿nsm™
(&
’c_sock‘_ş›Á
).
ok
()) {

105  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Clientransmit failed");

107  
	gStus
::
OkStus
();

110 
Sock‘S”v”
 
	g’c_sock‘_£rv”_
;

112 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
DomašSock‘Te¡
; 
	}
}

	@platform/posix/sockets/domain_socket_test_enclave.cc

19 
	~<sys/un.h
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

23 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

24 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cDomašSock‘Te¡
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

33 ià(!
	gšput
.
HasEx‹nsiÚ
(
sock‘_‹¡_šput
)) {

34  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

37 
Sock‘Te¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sock‘_‹¡_šput
);

38 ià(!
	g‹¡_šput
.
has_aùiÚ
(è|| !‹¡_šput.
has_sock‘_Çme
()) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 
	gSock‘Te¡IÅut
::
Sock‘AùiÚ
 
’c_commªd
 = 
‹¡_šput
.
aùiÚ
();

43 
	g¡d
::
¡ršg
 
sock‘_Çme
 = 
‹¡_šput
.socket_name();

45 ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
INITSERVER
) {

46  
EncS‘upS”v”
(
sock‘_Çme
, 
‹¡_šput
.
u£_·th_Ën
());

47 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNSERVER
) {

48  
EncRunS”v”
();

49 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNCLIENT
) {

50  
EncRunCl›Á
(
sock‘_Çme
, 
‹¡_šput
.
u£_·th_Ën
());

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

57 
	g´iv©e
:

59 
Stus
 
EncS‘upS”v”
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
, 
boŞ
 
u£_·th_Ën
) {

60 ià(!
	g’c_sock‘_£rv”_
.
S”v”S‘up
(
sock‘_Çme
, 
u£_·th_Ën
).
ok
()) {

61  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server setup failed");

63  
	gStus
::
OkStus
();

67 
Stus
 
EncRunS”v”
() {

68 ià(!
	g’c_sock‘_£rv”_
.
S”v”Acû±
().
ok
()) {

69  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server‡ccept failed");

71 ià(!
S”v”T¿nsm™
(&
’c_sock‘_£rv”_
).
ok
()) {

72  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Serverransmit failed");

74  
	gStus
::
OkStus
();

78 
Stus
 
EncRunCl›Á
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
, 
boŞ
 
u£_·th_Ën
) {

79 
Sock‘Cl›Á
 
	g’c_sock‘_ş›Á
;

80 
sockaddr_un
 
	g­p_£rv”_sockaddr
;

81 ià(!
	g’c_sock‘_ş›Á


82 .
Cl›ÁS‘up
(
sock‘_Çme
, &
­p_£rv”_sockaddr
, 
u£_·th_Ën
)

83 .
ok
()) {

84  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Client setup failed");

90 
sockaddr_¡Üage
 
	g³”_sockaddr
;

91 
sockËn_t
 
	g³”_sockaddr_Ën
 = (
³”_sockaddr
);

92 
Stus
 
	g»tv®
 = 
’c_sock‘_ş›Á
.
G‘P“ºame
(

93 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
³”_sockaddr
),

94 &
³”_sockaddr_Ën
);

95 ià(!
	g»tv®
.
ok
()) {

96  
	g»tv®
;

98 
sockaddr_un
 *
	g³”_sockaddr_un
 = (sockaddr_uÀ*)&
³”_sockaddr
;

99 ià(
	g­p_£rv”_sockaddr
.
	gsun_çmy
 !ğ
³”_sockaddr_un
->
sun_çmy
) {

100 
LOG
(
ERROR
) << "peer‡ddr is incorrect family";

101  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getpeername failure 2");

104 ià(!
Cl›ÁT¿nsm™
(&
’c_sock‘_ş›Á
).
ok
()) {

105  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Clientransmit failed");

107  
	gStus
::
OkStus
();

110 
Sock‘S”v”
 
	g’c_sock‘_£rv”_
;

112 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
DomašSock‘Te¡
; 
	}
}

	@platform/posix/sockets/in.cc

19 
	~<Ãtš‘/š.h
>

23 cÚ¡ 
š6_addr
 
š6addr_ªy
 = 
IN6ADDR_ANY_INIT
;

24 cÚ¡ 
š6_addr
 
š6addr_loİback
 = 
IN6ADDR_LOOPBACK_INIT
;

	@platform/posix/sockets/in.cc

19 
	~<Ãtš‘/š.h
>

23 cÚ¡ 
š6_addr
 
š6addr_ªy
 = 
IN6ADDR_ANY_INIT
;

24 cÚ¡ 
š6_addr
 
š6addr_loİback
 = 
IN6ADDR_LOOPBACK_INIT
;

	@platform/posix/sockets/inet.cc

19 
	~<¬·/š‘.h
>

20 
	~<by‹sw­.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
ušt32_t
 
htÚl
(ušt32_ˆ
ho¡lÚg
) {

27 #ifdeà
__LITTLE_ENDIAN


28  
bsw­_32
(
ho¡lÚg
);

30  
ho¡lÚg
;

34 
ušt16_t
 
htÚs
(ušt16_ˆ
ho¡shÜt
) {

35 #ifdeà
__LITTLE_ENDIAN


36  
bsw­_16
(
ho¡shÜt
);

38  
ho¡shÜt
;

42 
ušt32_t
 
Áohl
(ušt32_ˆ
ÃÚg
) {

43 #ifdeà
__LITTLE_ENDIAN


44  
bsw­_32
(
ÃÚg
);

46  
ÃÚg
;

50 
ušt16_t
 
Áohs
(ušt16_ˆ
ÃtshÜt
) {

51 #ifdeà
__LITTLE_ENDIAN


52  
bsw­_16
(
ÃtshÜt
);

54  
ÃtshÜt
;

58 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
) {

59  
’c_uÁru¡ed_š‘_Áİ
(
af
, 
¤c
, 
d¡
, 
size
);

62 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
) {

63  
’c_uÁru¡ed_š‘_±Ú
(
af
, 
¤c
, 
d¡
);

	@platform/posix/sockets/inet.cc

19 
	~<¬·/š‘.h
>

20 
	~<by‹sw­.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
ušt32_t
 
htÚl
(ušt32_ˆ
ho¡lÚg
) {

27 #ifdeà
__LITTLE_ENDIAN


28  
bsw­_32
(
ho¡lÚg
);

30  
ho¡lÚg
;

34 
ušt16_t
 
htÚs
(ušt16_ˆ
ho¡shÜt
) {

35 #ifdeà
__LITTLE_ENDIAN


36  
bsw­_16
(
ho¡shÜt
);

38  
ho¡shÜt
;

42 
ušt32_t
 
Áohl
(ušt32_ˆ
ÃÚg
) {

43 #ifdeà
__LITTLE_ENDIAN


44  
bsw­_32
(
ÃÚg
);

46  
ÃÚg
;

50 
ušt16_t
 
Áohs
(ušt16_ˆ
ÃtshÜt
) {

51 #ifdeà
__LITTLE_ENDIAN


52  
bsw­_16
(
ÃtshÜt
);

54  
ÃtshÜt
;

58 cÚ¡ *
š‘_Áİ
(
af
, cÚ¡ *
¤c
, *
d¡
, 
sockËn_t
 
size
) {

59  
’c_uÁru¡ed_š‘_Áİ
(
af
, 
¤c
, 
d¡
, 
size
);

62 
š‘_±Ú
(
af
, cÚ¡ *
¤c
, *
d¡
) {

63  
’c_uÁru¡ed_š‘_±Ú
(
af
, 
¤c
, 
d¡
);

	@platform/posix/sockets/inet6_socket_test_driver.cc

19 
	~<th»ad
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

26 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

27 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

28 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 şas 
	cIÃt6Sock‘Driv”
 : 
public
 
EnşaveTe¡
 {

35 
´Ùeùed
:

37 
EnşaveIÅut
 
BudEnşaveIÅut
(cÚ¡ 
Sock‘Te¡IÅut
::
Sock‘AùiÚ
 &
aùiÚ
,

38 
£rv”_pÜt
 = 0) {

39 
Sock‘Te¡IÅut
 
‹¡_šput
;

40 
	g‹¡_šput
.
£t_aùiÚ
(
aùiÚ
);

41 
	g‹¡_šput
.
£t_£rv”_pÜt
(
£rv”_pÜt
);

43 
EnşaveIÅut
 
	g»t
;

44 *
	g»t
.
MubËEx‹nsiÚ
(
sock‘_‹¡_šput
èğ
‹¡_šput
;

46  
	g»t
;

50 
AµS”v”S‘up
(
Sock‘S”v”
 *
­p_sock‘_£rv”
) {

51 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”S‘up
(), 
IsOk
());

55 
AµS”v”Th»ad
(
Sock‘S”v”
 *
­p_sock‘_£rv”
) {

56 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”Acû±
(), 
IsOk
());

57 
EXPECT_THAT
(
S”v”T¿nsm™
(
­p_sock‘_£rv”
), 
IsOk
());

61 
AµCl›ÁTh»ad
(
’c_£rv”_pÜt
) {

62 
Sock‘Cl›Á
 
	g­p_sock‘_ş›Á
;

63 
EXPECT_TRUE
(
­p_sock‘_ş›Á


64 .
Cl›ÁS‘up
(
kLoÿlIpv6AddrSŒ
, 
’c_£rv”_pÜt
, 
nuÎ±r
)

65 .
ok
());

66 
EXPECT_THAT
(
Cl›ÁT¿nsm™
(&
­p_sock‘_ş›Á
), 
IsOk
());

72 
TEST_F
(
IÃt6Sock‘Driv”
, 
EnşaveCl›ÁTe¡
) {

73 
Sock‘S”v”
 
	g­p_sock‘_£rv”
;

74 
AµS”v”S‘up
(&
­p_sock‘_£rv”
);

75 
	g­p_£rv”_pÜt
 = 
­p_sock‘_£rv”
.
G‘PÜt
();

76 
ASSERT_NE
(
­p_£rv”_pÜt
, -1);

77 
	g¡d
::
th»ad
 
­p_£rv”_th»ad
(&
AµS”v”Th»ad
, &
­p_sock‘_£rv”
);

78 
EnşaveIÅut
 
	g’şave_šput
 =

79 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNCLIENT
, 
­p_£rv”_pÜt
);

80 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

81 
	g­p_£rv”_th»ad
.
još
();

87 
TEST_F
(
IÃt6Sock‘Driv”
, 
EnşaveS”v”Te¡
) {

88 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
INITSERVER
);

89 
EnşaveOuut
 
	g’şave_ouut
;

90 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
), 
IsOk
());

91 
	g’c_£rv”_pÜt
 =

92 
’şave_ouut
.
G‘Ex‹nsiÚ
(
sock‘_‹¡_ouut
).
£rv”_pÜt
();

93 
ASSERT_NE
(
’c_£rv”_pÜt
, -1);

94 
	g¡d
::
th»ad
 
­p_ş›Á_th»ad
(&
AµCl›ÁTh»ad
, 
’c_£rv”_pÜt
);

95 
	g’şave_šput
 =

96 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNSERVER
, 
’c_£rv”_pÜt
);

97 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

98 
	g­p_ş›Á_th»ad
.
još
();

	@platform/posix/sockets/inet6_socket_test_driver.cc

19 
	~<th»ad
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

26 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

27 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

28 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 şas 
	cIÃt6Sock‘Driv”
 : 
public
 
EnşaveTe¡
 {

35 
´Ùeùed
:

37 
EnşaveIÅut
 
BudEnşaveIÅut
(cÚ¡ 
Sock‘Te¡IÅut
::
Sock‘AùiÚ
 &
aùiÚ
,

38 
£rv”_pÜt
 = 0) {

39 
Sock‘Te¡IÅut
 
‹¡_šput
;

40 
	g‹¡_šput
.
£t_aùiÚ
(
aùiÚ
);

41 
	g‹¡_šput
.
£t_£rv”_pÜt
(
£rv”_pÜt
);

43 
EnşaveIÅut
 
	g»t
;

44 *
	g»t
.
MubËEx‹nsiÚ
(
sock‘_‹¡_šput
èğ
‹¡_šput
;

46  
	g»t
;

50 
AµS”v”S‘up
(
Sock‘S”v”
 *
­p_sock‘_£rv”
) {

51 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”S‘up
(), 
IsOk
());

55 
AµS”v”Th»ad
(
Sock‘S”v”
 *
­p_sock‘_£rv”
) {

56 
EXPECT_THAT
(
­p_sock‘_£rv”
->
S”v”Acû±
(), 
IsOk
());

57 
EXPECT_THAT
(
S”v”T¿nsm™
(
­p_sock‘_£rv”
), 
IsOk
());

61 
AµCl›ÁTh»ad
(
’c_£rv”_pÜt
) {

62 
Sock‘Cl›Á
 
	g­p_sock‘_ş›Á
;

63 
EXPECT_TRUE
(
­p_sock‘_ş›Á


64 .
Cl›ÁS‘up
(
kLoÿlIpv6AddrSŒ
, 
’c_£rv”_pÜt
, 
nuÎ±r
)

65 .
ok
());

66 
EXPECT_THAT
(
Cl›ÁT¿nsm™
(&
­p_sock‘_ş›Á
), 
IsOk
());

72 
TEST_F
(
IÃt6Sock‘Driv”
, 
EnşaveCl›ÁTe¡
) {

73 
Sock‘S”v”
 
	g­p_sock‘_£rv”
;

74 
AµS”v”S‘up
(&
­p_sock‘_£rv”
);

75 
	g­p_£rv”_pÜt
 = 
­p_sock‘_£rv”
.
G‘PÜt
();

76 
ASSERT_NE
(
­p_£rv”_pÜt
, -1);

77 
	g¡d
::
th»ad
 
­p_£rv”_th»ad
(&
AµS”v”Th»ad
, &
­p_sock‘_£rv”
);

78 
EnşaveIÅut
 
	g’şave_šput
 =

79 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNCLIENT
, 
­p_£rv”_pÜt
);

80 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

81 
	g­p_£rv”_th»ad
.
još
();

87 
TEST_F
(
IÃt6Sock‘Driv”
, 
EnşaveS”v”Te¡
) {

88 
EnşaveIÅut
 
	g’şave_šput
 = 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
INITSERVER
);

89 
EnşaveOuut
 
	g’şave_ouut
;

90 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
), 
IsOk
());

91 
	g’c_£rv”_pÜt
 =

92 
’şave_ouut
.
G‘Ex‹nsiÚ
(
sock‘_‹¡_ouut
).
£rv”_pÜt
();

93 
ASSERT_NE
(
’c_£rv”_pÜt
, -1);

94 
	g¡d
::
th»ad
 
­p_ş›Á_th»ad
(&
AµCl›ÁTh»ad
, 
’c_£rv”_pÜt
);

95 
	g’şave_šput
 =

96 
BudEnşaveIÅut
(
Sock‘Te¡IÅut
::
RUNSERVER
, 
’c_£rv”_pÜt
);

97 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

98 
	g­p_ş›Á_th»ad
.
još
();

	@platform/posix/sockets/inet6_socket_test_enclave.cc

19 
	~<Ãtš‘/š.h
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

23 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

24 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cIÃt6Sock‘Te¡
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

33 ià(!
	gšput
.
HasEx‹nsiÚ
(
sock‘_‹¡_šput
)) {

34  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

37 
Sock‘Te¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sock‘_‹¡_šput
);

38 ià(!
	g‹¡_šput
.
has_aùiÚ
(è|| !‹¡_šput.
has_£rv”_pÜt
()) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 
	gSock‘Te¡IÅut
::
Sock‘AùiÚ
 
’c_commªd
 = 
‹¡_šput
.
aùiÚ
();

43 
	g£rv”_pÜt
 = 
‹¡_šput
.
£rv”_pÜt
();

45 ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
INITSERVER
) {

46 
Sock‘Te¡Ouut
 *
‹¡_ouut
 = 
nuÎ±r
;

47 ià(
	gouut
) {

48 
	g‹¡_ouut
 = 
ouut
->
MubËEx‹nsiÚ
(
sock‘_‹¡_ouut
);

50  
EncS‘upS”v”
(
£rv”_pÜt
, 
‹¡_ouut
);

51 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNSERVER
) {

52  
EncRunS”v”
();

53 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNCLIENT
) {

54  
EncRunCl›Á
(
£rv”_pÜt
);

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
	g´iv©e
:

63 
Stus
 
EncS‘upS”v”
(
’c_£rv”_pÜt
, 
Sock‘Te¡Ouut
 *
ouut
) {

64 ià(!
	g’c_sock‘_£rv”_
.
S”v”S‘up
(
’c_£rv”_pÜt
).
ok
()) {

65  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server setup failed");

67 ià(
	gouut
) {

68 
	gouut
->
£t_£rv”_pÜt
(
’c_sock‘_£rv”_
.
G‘PÜt
());

70  
	gStus
::
OkStus
();

74 
Stus
 
EncRunS”v”
() {

75 ià(!
	g’c_sock‘_£rv”_
.
S”v”Acû±
().
ok
()) {

76  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server‡ccept failed");

78 ià(!
S”v”T¿nsm™
(&
’c_sock‘_£rv”_
).
ok
()) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Serverransmit failed");

81  
	gStus
::
OkStus
();

85 
Stus
 
EncRunCl›Á
(
­p_£rv”_pÜt
) {

86 
Sock‘Cl›Á
 
	g’c_sock‘_ş›Á
;

87 
sockaddr_š6
 
	g­p_£rv”_sockaddr
;

88 ià(!
	g’c_sock‘_ş›Á


89 .
Cl›ÁS‘up
(
kLoÿlIpv6AddrSŒ
, 
­p_£rv”_pÜt
,

90 &
­p_£rv”_sockaddr
)

91 .
ok
()) {

92  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Client setup failed");

97 
sockaddr_¡Üage
 
	g³”_sockaddr
;

98 
sockËn_t
 
	g³”_sockaddr_Ën
 = (
³”_sockaddr
);

99 
Stus
 
	g»tv®
 = 
’c_sock‘_ş›Á
.
G‘P“ºame
(

100 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
³”_sockaddr
),

101 &
³”_sockaddr_Ën
);

102 ià(!
	g»tv®
.
ok
()) {

103  
	g»tv®
;

105 ià(
	g³”_sockaddr_Ën
 !ğ(
sockaddr_š6
)) {

106 
LOG
(
ERROR
è<< "³”‡dd¾’ " << 
³”_sockaddr_Ën


107 << " dÛ¢'ˆm©ch s”v”‡dd¸ËÀ" << (
sockaddr_š6
);

108  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getpeername failure 1");

110 ià(
memcmp
(&
³”_sockaddr
, &
­p_£rv”_sockaddr
, (
sockaddr_š6
))) {

111 
LOG
(
ERROR
) << "peer‡ddr doesn't match server‡ddr!";

112  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getpeername failure 2");

115 ià(!
Cl›ÁT¿nsm™
(&
’c_sock‘_ş›Á
).
ok
()) {

116  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Clientransmit failed");

118  
	gStus
::
OkStus
();

121 
Sock‘S”v”
 
	g’c_sock‘_£rv”_
;

123 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
IÃt6Sock‘Te¡
; 
	}
}

	@platform/posix/sockets/inet6_socket_test_enclave.cc

19 
	~<Ãtš‘/š.h
>

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

23 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

24 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡.pb.h
"

25 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cIÃt6Sock‘Te¡
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

33 ià(!
	gšput
.
HasEx‹nsiÚ
(
sock‘_‹¡_šput
)) {

34  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

37 
Sock‘Te¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sock‘_‹¡_šput
);

38 ià(!
	g‹¡_šput
.
has_aùiÚ
(è|| !‹¡_šput.
has_£rv”_pÜt
()) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42 
	gSock‘Te¡IÅut
::
Sock‘AùiÚ
 
’c_commªd
 = 
‹¡_šput
.
aùiÚ
();

43 
	g£rv”_pÜt
 = 
‹¡_šput
.
£rv”_pÜt
();

45 ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
INITSERVER
) {

46 
Sock‘Te¡Ouut
 *
‹¡_ouut
 = 
nuÎ±r
;

47 ià(
	gouut
) {

48 
	g‹¡_ouut
 = 
ouut
->
MubËEx‹nsiÚ
(
sock‘_‹¡_ouut
);

50  
EncS‘upS”v”
(
£rv”_pÜt
, 
‹¡_ouut
);

51 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNSERVER
) {

52  
EncRunS”v”
();

53 } ià(
	g’c_commªd
 =ğ
Sock‘Te¡IÅut
::
RUNCLIENT
) {

54  
EncRunCl›Á
(
£rv”_pÜt
);

56  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
	g´iv©e
:

63 
Stus
 
EncS‘upS”v”
(
’c_£rv”_pÜt
, 
Sock‘Te¡Ouut
 *
ouut
) {

64 ià(!
	g’c_sock‘_£rv”_
.
S”v”S‘up
(
’c_£rv”_pÜt
).
ok
()) {

65  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server setup failed");

67 ià(
	gouut
) {

68 
	gouut
->
£t_£rv”_pÜt
(
’c_sock‘_£rv”_
.
G‘PÜt
());

70  
	gStus
::
OkStus
();

74 
Stus
 
EncRunS”v”
() {

75 ià(!
	g’c_sock‘_£rv”_
.
S”v”Acû±
().
ok
()) {

76  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Server‡ccept failed");

78 ià(!
S”v”T¿nsm™
(&
’c_sock‘_£rv”_
).
ok
()) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Serverransmit failed");

81  
	gStus
::
OkStus
();

85 
Stus
 
EncRunCl›Á
(
­p_£rv”_pÜt
) {

86 
Sock‘Cl›Á
 
	g’c_sock‘_ş›Á
;

87 
sockaddr_š6
 
	g­p_£rv”_sockaddr
;

88 ià(!
	g’c_sock‘_ş›Á


89 .
Cl›ÁS‘up
(
kLoÿlIpv6AddrSŒ
, 
­p_£rv”_pÜt
,

90 &
­p_£rv”_sockaddr
)

91 .
ok
()) {

92  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Client setup failed");

97 
sockaddr_¡Üage
 
	g³”_sockaddr
;

98 
sockËn_t
 
	g³”_sockaddr_Ën
 = (
³”_sockaddr
);

99 
Stus
 
	g»tv®
 = 
’c_sock‘_ş›Á
.
G‘P“ºame
(

100 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
³”_sockaddr
),

101 &
³”_sockaddr_Ën
);

102 ià(!
	g»tv®
.
ok
()) {

103  
	g»tv®
;

105 ià(
	g³”_sockaddr_Ën
 !ğ(
sockaddr_š6
)) {

106 
LOG
(
ERROR
è<< "³”‡dd¾’ " << 
³”_sockaddr_Ën


107 << " dÛ¢'ˆm©ch s”v”‡dd¸ËÀ" << (
sockaddr_š6
);

108  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getpeername failure 1");

110 ià(
memcmp
(&
³”_sockaddr
, &
­p_£rv”_sockaddr
, (
sockaddr_š6
))) {

111 
LOG
(
ERROR
) << "peer‡ddr doesn't match server‡ddr!";

112  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getpeername failure 2");

115 ià(!
Cl›ÁT¿nsm™
(&
’c_sock‘_ş›Á
).
ok
()) {

116  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Clientransmit failed");

118  
	gStus
::
OkStus
();

121 
Sock‘S”v”
 
	g’c_sock‘_£rv”_
;

123 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
IÃt6Sock‘Te¡
; 
	}
}

	@platform/posix/sockets/inet_aton_test.cc

19 
	~<¬·/š‘.h
>

20 
	~<Ãtš‘/š.h
>

21 
	~<sys/sock‘.h
>

22 
	~<c¡dlib
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

27 
	~"asylo/ut/loggšg.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

34 
ušt32_t
 
P¬£Add»ss
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

35 
š_addr
 
addr
;

36 
CHECK_NE
(
š‘_©Ú
(
¡r
.
c_¡r
(), &
addr
), 0è<< "Could‚Ù…¬£: " << 
	g¡r
;

37  
	gaddr
.
	gs_addr
;

40 
TEST
(
IÃtAtÚTe¡
, 
OÃChunk
) {

41 
EXPECT_EQ
(
P¬£Add»ss
("0"), 0);

42 
EXPECT_EQ
(
P¬£Add»ss
("1734575198"), 1585734503);

43 
EXPECT_EQ
(
P¬£Add»ss
("1973594324"), 3567821429);

44 
EXPECT_EQ
(
P¬£Add»ss
("149798315"), 2881350920);

45 
EXPECT_EQ
(
P¬£Add»ss
("2038664370"), 2995553145);

46 
EXPECT_EQ
(
P¬£Add»ss
("1129566413"), 3452982083);

49 
TEST
(
IÃtAtÚTe¡
, 
TwoChunks
) {

50 
EXPECT_EQ
(
P¬£Add»ss
("0.0"), 0);

51 
EXPECT_EQ
(
P¬£Add»ss
("61.2996848"), 1891249469);

52 
EXPECT_EQ
(
P¬£Add»ss
("82.7418056"), 3358617938);

53 
EXPECT_EQ
(
P¬£Add»ss
("213.7102824"), 1751215317);

54 
EXPECT_EQ
(
P¬£Add»ss
("74.3846456"), 951138890);

55 
EXPECT_EQ
(
P¬£Add»ss
("142.4434044"), 2091402126);

58 
TEST
(
IÃtAtÚTe¡
, 
Th»eChunks
) {

59 
EXPECT_EQ
(
P¬£Add»ss
("0.0.0"), 0);

60 
EXPECT_EQ
(
P¬£Add»ss
("39.87.2303"), 4278736679);

61 
EXPECT_EQ
(
P¬£Add»ss
("212.5.9092"), 2216887764);

62 
EXPECT_EQ
(
P¬£Add»ss
("130.82.32848"), 1350587010);

63 
EXPECT_EQ
(
P¬£Add»ss
("27.117.1649"), 1896248603);

64 
EXPECT_EQ
(
P¬£Add»ss
("237.74.33558"), 377703149);

67 
TEST
(
IÃtAtÚTe¡
, 
FourChunks
) {

68 
EXPECT_EQ
(
P¬£Add»ss
("0.0.0.0"), 0);

69 
EXPECT_EQ
(
P¬£Add»ss
("83.85.162.151"), 2543998291);

70 
EXPECT_EQ
(
P¬£Add»ss
("249.252.241.190"), 3203529977);

71 
EXPECT_EQ
(
P¬£Add»ss
("20.82.107.121"), 2037076500);

72 
EXPECT_EQ
(
P¬£Add»ss
("45.226.233.19"), 334094893);

73 
EXPECT_EQ
(
P¬£Add»ss
("86.31.142.81"), 1368268630);

75 
EXPECT_EQ
(
P¬£Add»ss
("86.31.142.81"), 1368268630);

78 
EXPECT_EQ
(
P¬£Add»ss
("0x56.0x1f.0x8e.0x51"), 1368268630);

81 
EXPECT_EQ
(
P¬£Add»ss
("0126.0037.0216.0121"), 1368268630);

84 
EXPECT_EQ
(
P¬£Add»ss
("86.0x1f.0216.81"), 1368268630);

87 
TEST
(
IÃtAtÚTe¡
, 
BadAdd»ss
) {

88 
š_addr
 
	gaddr
;

91 #ifdeà
__ASYLO__


92 
EXPECT_EQ
(
š‘_©Ú
(
nuÎ±r
, &
addr
), 0);

94 
EXPECT_EQ
(
š‘_©Ú
("", &
addr
), 0);

95 
EXPECT_EQ
(
š‘_©Ú
("h–lØwÜld", &
addr
), 0);

96 
EXPECT_EQ
(
š‘_©Ú
("256.1.1.1", &
addr
), 0);

97 
EXPECT_EQ
(
š‘_©Ú
("255.1.1.1.1", &
addr
), 0);

98 
EXPECT_EQ
(
š‘_©Ú
("1000.1", &
addr
), 0);

99 
EXPECT_EQ
(
š‘_©Ú
("1000.1!", &
addr
), 0);

100 
EXPECT_EQ
(
š‘_©Ú
("-255.1.1.1", &
addr
), 0);

101 
EXPECT_EQ
(
š‘_©Ú
("+255.1.1.1", &
addr
), 0);

104 
TEST
(
IÃtAtÚTe¡
, 
Enum”©eMªy
) {

105 
cÚ¡ex´
 
size_t
 
	gkS‹pSize
 = 0xFEFE;

106 
ušt32_t
 
	gi
 = 0; 
	gUINT32_MAX
 - i > 
	gkS‹pSize
; i +ğ
kS‹pSize
) {

107 cÚ¡ 
¡d
::
¡ršg
 
add»ss
 = 
ab¦
::
SŒFÜm©
(

108 "%u.%u.%u.%u", 
i
 >> 24 & 0xFF, i >> 16 & 0xFF, i >> 8 & 0xFF, i & 0xFF);

109 
EXPECT_EQ
(
htÚl
(
i
), 
P¬£Add»ss
(
add»ss
));

	@platform/posix/sockets/inet_aton_test.cc

19 
	~<¬·/š‘.h
>

20 
	~<Ãtš‘/š.h
>

21 
	~<sys/sock‘.h
>

22 
	~<c¡dlib
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

27 
	~"asylo/ut/loggšg.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

34 
ušt32_t
 
P¬£Add»ss
(cÚ¡ 
¡d
::
¡ršg
 &
¡r
) {

35 
š_addr
 
addr
;

36 
CHECK_NE
(
š‘_©Ú
(
¡r
.
c_¡r
(), &
addr
), 0è<< "Could‚Ù…¬£: " << 
	g¡r
;

37  
	gaddr
.
	gs_addr
;

40 
TEST
(
IÃtAtÚTe¡
, 
OÃChunk
) {

41 
EXPECT_EQ
(
P¬£Add»ss
("0"), 0);

42 
EXPECT_EQ
(
P¬£Add»ss
("1734575198"), 1585734503);

43 
EXPECT_EQ
(
P¬£Add»ss
("1973594324"), 3567821429);

44 
EXPECT_EQ
(
P¬£Add»ss
("149798315"), 2881350920);

45 
EXPECT_EQ
(
P¬£Add»ss
("2038664370"), 2995553145);

46 
EXPECT_EQ
(
P¬£Add»ss
("1129566413"), 3452982083);

49 
TEST
(
IÃtAtÚTe¡
, 
TwoChunks
) {

50 
EXPECT_EQ
(
P¬£Add»ss
("0.0"), 0);

51 
EXPECT_EQ
(
P¬£Add»ss
("61.2996848"), 1891249469);

52 
EXPECT_EQ
(
P¬£Add»ss
("82.7418056"), 3358617938);

53 
EXPECT_EQ
(
P¬£Add»ss
("213.7102824"), 1751215317);

54 
EXPECT_EQ
(
P¬£Add»ss
("74.3846456"), 951138890);

55 
EXPECT_EQ
(
P¬£Add»ss
("142.4434044"), 2091402126);

58 
TEST
(
IÃtAtÚTe¡
, 
Th»eChunks
) {

59 
EXPECT_EQ
(
P¬£Add»ss
("0.0.0"), 0);

60 
EXPECT_EQ
(
P¬£Add»ss
("39.87.2303"), 4278736679);

61 
EXPECT_EQ
(
P¬£Add»ss
("212.5.9092"), 2216887764);

62 
EXPECT_EQ
(
P¬£Add»ss
("130.82.32848"), 1350587010);

63 
EXPECT_EQ
(
P¬£Add»ss
("27.117.1649"), 1896248603);

64 
EXPECT_EQ
(
P¬£Add»ss
("237.74.33558"), 377703149);

67 
TEST
(
IÃtAtÚTe¡
, 
FourChunks
) {

68 
EXPECT_EQ
(
P¬£Add»ss
("0.0.0.0"), 0);

69 
EXPECT_EQ
(
P¬£Add»ss
("83.85.162.151"), 2543998291);

70 
EXPECT_EQ
(
P¬£Add»ss
("249.252.241.190"), 3203529977);

71 
EXPECT_EQ
(
P¬£Add»ss
("20.82.107.121"), 2037076500);

72 
EXPECT_EQ
(
P¬£Add»ss
("45.226.233.19"), 334094893);

73 
EXPECT_EQ
(
P¬£Add»ss
("86.31.142.81"), 1368268630);

75 
EXPECT_EQ
(
P¬£Add»ss
("86.31.142.81"), 1368268630);

78 
EXPECT_EQ
(
P¬£Add»ss
("0x56.0x1f.0x8e.0x51"), 1368268630);

81 
EXPECT_EQ
(
P¬£Add»ss
("0126.0037.0216.0121"), 1368268630);

84 
EXPECT_EQ
(
P¬£Add»ss
("86.0x1f.0216.81"), 1368268630);

87 
TEST
(
IÃtAtÚTe¡
, 
BadAdd»ss
) {

88 
š_addr
 
	gaddr
;

91 #ifdeà
__ASYLO__


92 
EXPECT_EQ
(
š‘_©Ú
(
nuÎ±r
, &
addr
), 0);

94 
EXPECT_EQ
(
š‘_©Ú
("", &
addr
), 0);

95 
EXPECT_EQ
(
š‘_©Ú
("h–lØwÜld", &
addr
), 0);

96 
EXPECT_EQ
(
š‘_©Ú
("256.1.1.1", &
addr
), 0);

97 
EXPECT_EQ
(
š‘_©Ú
("255.1.1.1.1", &
addr
), 0);

98 
EXPECT_EQ
(
š‘_©Ú
("1000.1", &
addr
), 0);

99 
EXPECT_EQ
(
š‘_©Ú
("1000.1!", &
addr
), 0);

100 
EXPECT_EQ
(
š‘_©Ú
("-255.1.1.1", &
addr
), 0);

101 
EXPECT_EQ
(
š‘_©Ú
("+255.1.1.1", &
addr
), 0);

104 
TEST
(
IÃtAtÚTe¡
, 
Enum”©eMªy
) {

105 
cÚ¡ex´
 
size_t
 
	gkS‹pSize
 = 0xFEFE;

106 
ušt32_t
 
	gi
 = 0; 
	gUINT32_MAX
 - i > 
	gkS‹pSize
; i +ğ
kS‹pSize
) {

107 cÚ¡ 
¡d
::
¡ršg
 
add»ss
 = 
ab¦
::
SŒFÜm©
(

108 "%u.%u.%u.%u", 
i
 >> 24 & 0xFF, i >> 16 & 0xFF, i >> 8 & 0xFF, i & 0xFF);

109 
EXPECT_EQ
(
htÚl
(
i
), 
P¬£Add»ss
(
add»ss
));

	@platform/posix/sockets/inet_pton_test.cc

19 
	~<¬·/š‘.h
>

20 
	~<Ãtš‘/š.h
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

25 
	gÇme¥aû
 {

27 cÚ¡ 
ušt8_t
 
	gloÿlho¡_v4_by‹s
[4] = {127, 0, 0, 1};

28 cÚ¡ 
ušt8_t
 
	gloÿlho¡_v6_by‹s
[16] = {0, 0, 0, 0, 0, 0, 0, 0,

30 
TEST
(
IÃtPtÚTe¡
, 
IPv4
) {

31 
š_addr
 
	gaddr
;

32 
EXPECT_EQ
(
š‘_±Ú
(
AF_INET
, "127.0.0.1", &
addr
), 1);

33 
ušt8_t
 *
	gaddr_¬r
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(&
addr
.
s_addr
);

34 
	gi
 = 0; i < (
	gš_addr_t
); ++i) {

35 
EXPECT_EQ
(
addr_¬r
[
i
], 
loÿlho¡_v4_by‹s
[i]);

39 
TEST
(
IÃtPtÚTe¡
, 
IPv6
) {

40 
š6_addr
 
	gaddr
;

41 
EXPECT_EQ
(
š‘_±Ú
(
AF_INET6
, "::1", &
addr
), 1);

42 
	gi
 = 0; i < (
	gš6_addr
); ++i) {

43 
EXPECT_EQ
(
addr
.
s6_addr
[
i
], 
loÿlho¡_v6_by‹s
[i]);

	@platform/posix/sockets/inet_pton_test.cc

19 
	~<¬·/š‘.h
>

20 
	~<Ãtš‘/š.h
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

25 
	gÇme¥aû
 {

27 cÚ¡ 
ušt8_t
 
	gloÿlho¡_v4_by‹s
[4] = {127, 0, 0, 1};

28 cÚ¡ 
ušt8_t
 
	gloÿlho¡_v6_by‹s
[16] = {0, 0, 0, 0, 0, 0, 0, 0,

30 
TEST
(
IÃtPtÚTe¡
, 
IPv4
) {

31 
š_addr
 
	gaddr
;

32 
EXPECT_EQ
(
š‘_±Ú
(
AF_INET
, "127.0.0.1", &
addr
), 1);

33 
ušt8_t
 *
	gaddr_¬r
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(&
addr
.
s_addr
);

34 
	gi
 = 0; i < (
	gš_addr_t
); ++i) {

35 
EXPECT_EQ
(
addr_¬r
[
i
], 
loÿlho¡_v4_by‹s
[i]);

39 
TEST
(
IÃtPtÚTe¡
, 
IPv6
) {

40 
š6_addr
 
	gaddr
;

41 
EXPECT_EQ
(
š‘_±Ú
(
AF_INET6
, "::1", &
addr
), 1);

42 
	gi
 = 0; i < (
	gš6_addr
); ++i) {

43 
EXPECT_EQ
(
addr
.
s6_addr
[
i
], 
loÿlho¡_v6_by‹s
[i]);

	@platform/posix/sockets/netdb.cc

19 
	~<Ãtdb.h
>

20 
	~<¡dlib.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 cÚ¡ *
gai_¡»¼Ü
(
ecode
è{ 
abÜt
(); }

29 
g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

30 cÚ¡ 
addršfo
 *
hšts
, addršfØ**
»s
) {

31  
’c_uÁru¡ed_g‘addršfo
(
node
, 
£rviû
, 
hšts
, 
»s
);

34 
ä“addršfo
(
addršfo
 *
»s
) {

35  
’c_uÁru¡ed_ä“addršfo
(
»s
);

	@platform/posix/sockets/netdb.cc

19 
	~<Ãtdb.h
>

20 
	~<¡dlib.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 cÚ¡ *
gai_¡»¼Ü
(
ecode
è{ 
abÜt
(); }

29 
g‘addršfo
(cÚ¡ *
node
, cÚ¡ *
£rviû
,

30 cÚ¡ 
addršfo
 *
hšts
, addršfØ**
»s
) {

31  
’c_uÁru¡ed_g‘addršfo
(
node
, 
£rviû
, 
hšts
, 
»s
);

34 
ä“addršfo
(
addršfo
 *
»s
) {

35  
’c_uÁru¡ed_ä“addršfo
(
»s
);

	@platform/posix/sockets/socket.cc

18 
	~<¬·/š‘.h
>

19 
	~<sys/sock‘.h
>

21 
	~<¡dlib.h
>

22 
	~<c¡ršg
>

23 
	~<¡ršg
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

27 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

29 
usšg
 
	gasylo
::
io
::
IOMªag”
;

33 
£tsockİt
(
sockfd
, 
Ëv–
, 
İtiÚ_Çme
, cÚ¡ *
İtiÚ_v®ue
,

34 
sockËn_t
 
İtiÚ_Ën
) {

35  
IOMªag”
::
G‘In¡ªû
().
S‘SockO±
(
sockfd
, 
Ëv–
, 
İtiÚ_Çme
,

36 
İtiÚ_v®ue
, 
İtiÚ_Ën
);

39 
cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

40  
IOMªag”
::
G‘In¡ªû
().
CÚÃù
(
sockfd
, 
addr
, 
add¾’
);

43 
shutdown
(
sockfd
, 
how
) {

44  
IOMªag”
::
G‘In¡ªû
().
Shutdown
(
sockfd
, 
how
);

47 
ssize_t
 
£nd
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
) {

48  
IOMªag”
::
G‘In¡ªû
().
S’d
(
sockfd
, 
buf
, 
Ën
, 
æags
);

51 
sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

52  
IOMªag”
::
G‘In¡ªû
().
Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

55 
ssize_t
 
»cv
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
) {

56  
»cväom
(
sockfd
, 
buf
, 
Ën
, 
æags
, 
nuÎ±r
,‚ullptr);

59 
g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

60 
sockËn_t
 *
İ’
) {

61  
IOMªag”
::
G‘In¡ªû
().
G‘SockO±
(
sockfd
, 
Ëv–
, 
İŠame
, 
İtv®
,

62 
İ’
);

65 
acû±
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

66  
IOMªag”
::
G‘In¡ªû
().
Acû±
(
sockfd
, 
addr
, 
add¾’
);

69 
bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

70  
IOMªag”
::
G‘In¡ªû
().
Bšd
(
sockfd
, 
addr
, 
add¾’
);

73 
li¡’
(
sockfd
, 
backlog
) {

74  
IOMªag”
::
G‘In¡ªû
().
Li¡’
(
sockfd
, 
backlog
);

77 
ssize_t
 
£ndmsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
, 
æags
) {

78  
IOMªag”
::
G‘In¡ªû
().
S’dMsg
(
sockfd
, 
msg
, 
æags
);

81 
ssize_t
 
»cvmsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
) {

82  
IOMªag”
::
G‘In¡ªû
().
RecvMsg
(
sockfd
, 
msg
, 
æags
);

85 
g‘sockÇme
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

86  
IOMªag”
::
G‘In¡ªû
().
G‘SockName
(
sockfd
, 
addr
, 
add¾’
);

89 
g‘³”Çme
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

90  
IOMªag”
::
G‘In¡ªû
().
G‘P“rName
(
sockfd
, 
addr
, 
add¾’
);

93 
š_addr_t
 
š‘_addr
(cÚ¡ *
ı
) {

94 
š_addr
 
addr
;

95 
»t
 = 
š‘_©Ú
(
ı
, &
addr
);

96 ià(
»t
 == 0) {

97  
INADDR_NONE
;

99  
addr
.
s_addr
;

102 
š‘_©Ú
(cÚ¡ *
ı
, 
š_addr
 *
šp
) {

103 ià(!
ı
 || *ı =ğ'\0' || !
šp
) {

107 
ušt64_t
 
tok’s
[4];

108 
acû±ed
 = 0;

109 cÚ¡ *
ci
 = 
ı
;

115 ià(!
isdig™
(*
ci
)) {

119 *
Ãxt
;

120 
tok’s
[
acû±ed
] = 
¡¹Şl
(
ci
, &
Ãxt
, 0);

121 ià(
tok’s
[
acû±ed
] > 
UINT32_MAX
)  0;

124 ià(
ci
 =ğ
Ãxt
) {

127 
ci
 = 
Ãxt
;

128 
acû±ed
++;

131 ià(*
ci
) {

132 ià(*
ci
 == '.') {

133 
ci
++;

141 ià(
acû±ed
 =ğ4 && *
ci
) {

144 } *
ci
);

146 ià(
acû±ed
 == 4) {

148 ià(
šp
) {

149 
šp
->
s_addr
 = 0;

151 
i
 = 3; i >= 0; i--) {

152 ià(
tok’s
[
i
] > 
UINT8_MAX
) {

155 ià(
šp
) {

156 
šp
->
s_addr
 = iÅ->s_add¸<< 8 | 
tok’s
[
i
];

159 } ià(
acû±ed
 == 3) {

161 ià(
tok’s
[0] > 
UINT8_MAX
 ||okens[1] > UINT8_MAX ||

162 
tok’s
[2] > 
UINT16_MAX
) {

166 ià(
šp
) {

167 
šp
->
s_addr
 = 
htÚl
(
tok’s
[0] << 24 |okens[1] << 16 |okens[2]);

169 } ià(
acû±ed
 == 2) {

171 ià(
tok’s
[0] > 
UINT8_MAX
 ||okens[1] > 0x00FFFFFF) {

174 ià(
šp
) {

175 
šp
->
s_addr
 = 
htÚl
(
tok’s
[0] << 24 |okens[1]);

177 } ià(
acû±ed
 == 1) {

179 ià(
šp
) {

180 
šp
->
s_addr
 = 
htÚl
(
tok’s
[0]);

188 
ssize_t
 
»cväom
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
, 
æags
,

189 
sockaddr
 *
add»ss
, 
sockËn_t
 *
add»ss_Ën
) {

190  
IOMªag”
::
G‘In¡ªû
().
RecvFrom
(
sock‘
, 
bufãr
, 
Ëngth
, 
æags
,

191 
add»ss
, 
add»ss_Ën
);

194 
£rv’t
 *
g‘£rvbypÜt
(
pÜt
, cÚ¡ *
´Ùo
) {

195 
abÜt
();

198 
sock‘·œ
(
domaš
, 
ty³
, 
´ÙocŞ
, 
sv
[2]è{ 
abÜt
(); }

	@platform/posix/sockets/socket.cc

18 
	~<¬·/š‘.h
>

19 
	~<sys/sock‘.h
>

21 
	~<¡dlib.h
>

22 
	~<c¡ršg
>

23 
	~<¡ršg
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

26 
	~"asylo/¶©fÜm/commÚ/memÜy.h
"

27 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

29 
usšg
 
	gasylo
::
io
::
IOMªag”
;

33 
£tsockİt
(
sockfd
, 
Ëv–
, 
İtiÚ_Çme
, cÚ¡ *
İtiÚ_v®ue
,

34 
sockËn_t
 
İtiÚ_Ën
) {

35  
IOMªag”
::
G‘In¡ªû
().
S‘SockO±
(
sockfd
, 
Ëv–
, 
İtiÚ_Çme
,

36 
İtiÚ_v®ue
, 
İtiÚ_Ën
);

39 
cÚÃù
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

40  
IOMªag”
::
G‘In¡ªû
().
CÚÃù
(
sockfd
, 
addr
, 
add¾’
);

43 
shutdown
(
sockfd
, 
how
) {

44  
IOMªag”
::
G‘In¡ªû
().
Shutdown
(
sockfd
, 
how
);

47 
ssize_t
 
£nd
(
sockfd
, cÚ¡ *
buf
, 
size_t
 
Ën
, 
æags
) {

48  
IOMªag”
::
G‘In¡ªû
().
S’d
(
sockfd
, 
buf
, 
Ën
, 
æags
);

51 
sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
) {

52  
IOMªag”
::
G‘In¡ªû
().
Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

55 
ssize_t
 
»cv
(
sockfd
, *
buf
, 
size_t
 
Ën
, 
æags
) {

56  
»cväom
(
sockfd
, 
buf
, 
Ën
, 
æags
, 
nuÎ±r
,‚ullptr);

59 
g‘sockİt
(
sockfd
, 
Ëv–
, 
İŠame
, *
İtv®
,

60 
sockËn_t
 *
İ’
) {

61  
IOMªag”
::
G‘In¡ªû
().
G‘SockO±
(
sockfd
, 
Ëv–
, 
İŠame
, 
İtv®
,

62 
İ’
);

65 
acû±
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

66  
IOMªag”
::
G‘In¡ªû
().
Acû±
(
sockfd
, 
addr
, 
add¾’
);

69 
bšd
(
sockfd
, cÚ¡ 
sockaddr
 *
addr
, 
sockËn_t
 
add¾’
) {

70  
IOMªag”
::
G‘In¡ªû
().
Bšd
(
sockfd
, 
addr
, 
add¾’
);

73 
li¡’
(
sockfd
, 
backlog
) {

74  
IOMªag”
::
G‘In¡ªû
().
Li¡’
(
sockfd
, 
backlog
);

77 
ssize_t
 
£ndmsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
, 
æags
) {

78  
IOMªag”
::
G‘In¡ªû
().
S’dMsg
(
sockfd
, 
msg
, 
æags
);

81 
ssize_t
 
»cvmsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
) {

82  
IOMªag”
::
G‘In¡ªû
().
RecvMsg
(
sockfd
, 
msg
, 
æags
);

85 
g‘sockÇme
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

86  
IOMªag”
::
G‘In¡ªû
().
G‘SockName
(
sockfd
, 
addr
, 
add¾’
);

89 
g‘³”Çme
(
sockfd
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
) {

90  
IOMªag”
::
G‘In¡ªû
().
G‘P“rName
(
sockfd
, 
addr
, 
add¾’
);

93 
š_addr_t
 
š‘_addr
(cÚ¡ *
ı
) {

94 
š_addr
 
addr
;

95 
»t
 = 
š‘_©Ú
(
ı
, &
addr
);

96 ià(
»t
 == 0) {

97  
INADDR_NONE
;

99  
addr
.
s_addr
;

102 
š‘_©Ú
(cÚ¡ *
ı
, 
š_addr
 *
šp
) {

103 ià(!
ı
 || *ı =ğ'\0' || !
šp
) {

107 
ušt64_t
 
tok’s
[4];

108 
acû±ed
 = 0;

109 cÚ¡ *
ci
 = 
ı
;

115 ià(!
isdig™
(*
ci
)) {

119 *
Ãxt
;

120 
tok’s
[
acû±ed
] = 
¡¹Şl
(
ci
, &
Ãxt
, 0);

121 ià(
tok’s
[
acû±ed
] > 
UINT32_MAX
)  0;

124 ià(
ci
 =ğ
Ãxt
) {

127 
ci
 = 
Ãxt
;

128 
acû±ed
++;

131 ià(*
ci
) {

132 ià(*
ci
 == '.') {

133 
ci
++;

141 ià(
acû±ed
 =ğ4 && *
ci
) {

144 } *
ci
);

146 ià(
acû±ed
 == 4) {

148 ià(
šp
) {

149 
šp
->
s_addr
 = 0;

151 
i
 = 3; i >= 0; i--) {

152 ià(
tok’s
[
i
] > 
UINT8_MAX
) {

155 ià(
šp
) {

156 
šp
->
s_addr
 = iÅ->s_add¸<< 8 | 
tok’s
[
i
];

159 } ià(
acû±ed
 == 3) {

161 ià(
tok’s
[0] > 
UINT8_MAX
 ||okens[1] > UINT8_MAX ||

162 
tok’s
[2] > 
UINT16_MAX
) {

166 ià(
šp
) {

167 
šp
->
s_addr
 = 
htÚl
(
tok’s
[0] << 24 |okens[1] << 16 |okens[2]);

169 } ià(
acû±ed
 == 2) {

171 ià(
tok’s
[0] > 
UINT8_MAX
 ||okens[1] > 0x00FFFFFF) {

174 ià(
šp
) {

175 
šp
->
s_addr
 = 
htÚl
(
tok’s
[0] << 24 |okens[1]);

177 } ià(
acû±ed
 == 1) {

179 ià(
šp
) {

180 
šp
->
s_addr
 = 
htÚl
(
tok’s
[0]);

188 
ssize_t
 
»cväom
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
, 
æags
,

189 
sockaddr
 *
add»ss
, 
sockËn_t
 *
add»ss_Ën
) {

190  
IOMªag”
::
G‘In¡ªû
().
RecvFrom
(
sock‘
, 
bufãr
, 
Ëngth
, 
æags
,

191 
add»ss
, 
add»ss_Ën
);

194 
£rv’t
 *
g‘£rvbypÜt
(
pÜt
, cÚ¡ *
´Ùo
) {

195 
abÜt
();

198 
sock‘·œ
(
domaš
, 
ty³
, 
´ÙocŞ
, 
sv
[2]è{ 
abÜt
(); }

	@platform/posix/sockets/socket_client.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

21 
	~<¬·/š‘.h
>

22 
	~<”ºo.h
>

23 
	~<Ãtš‘/š.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/un.h
>

26 
	~<time.h
>

27 
	~<uni¡d.h
>

29 
	~<memÜy
>

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 #ifdeà
__ASYLO__


38 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "WITHIN ENCLAVE: ";

40 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "OUTSIDE ENCLAVE: ";

45 
	gSock‘Cl›Á
::
Sock‘Cl›Á
(è: 
cÚÃùiÚ_fd_
(-1) {}

47 
Stus
 
Sock‘Cl›Á
::
R—d
(*
buf
, 
size_t
 
»ad_Ën
) {

48  
	gsock_Œªsm™_
.
R—d
(
cÚÃùiÚ_fd_
, 
buf
, 
»ad_Ën
);

51 
Stus
 
	gSock‘Cl›Á
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
) {

52  
	gsock_Œªsm™_
.
Wr™e
(
cÚÃùiÚ_fd_
, 
buf
, 
wr™e_Ën
);

55 
Stus
 
	gSock‘Cl›Á
::
RecvMsg
(
msghdr
 *
msg
, 
æags
) {

56  
	gsock_Œªsm™_
.
RecvMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

59 
Stus
 
	gSock‘Cl›Á
::
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
) {

60  
	gsock_Œªsm™_
.
S’dMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

63 
Stus
 
	gSock‘Cl›Á
::
RecvFrom
(*
bufãr
, 
size_t
 
Ëngth
, 
æags
,

64 
sockaddr
 *
add»ss
,

65 
sockËn_t
 *
add»ss_Ën
) {

66  
	gsock_Œªsm™_
.
RecvFrom
(
cÚÃùiÚ_fd_
, 
bufãr
, 
Ëngth
, 
æags
, 
add»ss
,

67 
add»ss_Ën
);

70 
Stus
 
	gSock‘Cl›Á
::
G‘P“ºame
(
sockaddr
 *
³”addr_out
,

71 
sockËn_t
 *
³”addr_Ën_out
) {

72 ià(
g‘³”Çme
(
cÚÃùiÚ_fd_
, 
³”addr_out
, 
³”addr_Ën_out
) < 0) {

73 
LOG
(
ERROR
è<< "g‘³”Çmçu»: " << 
¡»¼Ü
(
”ºo
);

74  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "getpeername failure");

77  
	gStus
::
OkStus
();

80 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁS‘up
(cÚ¡ 
¡d
::
¡ršg
 &
£rv”_
, 
£rv”_pÜt
,

81 
sockaddr_š6
 *
out_addr
) {

82 
	gcÚÃùiÚ_fd_
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

83 ià(
	gcÚÃùiÚ_fd_
 < 0) {

84 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "client socketƒrror";

85  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

88 
	gfd_şo£r_
.
»£t
(
cÚÃùiÚ_fd_
);

90 
sockaddr_š6
 
	g£rv_addr
;

91 
mem£t
(&
£rv_addr
, 0, (serv_addr));

92 
	g£rv_addr
.
	gsš6_çmy
 = 
AF_INET6
;

93 
	g£rv_addr
.
	gsš6_æowšfo
 = 0;

94 
	g£rv_addr
.
	gsš6_pÜt
 = 
htÚs
(
£rv”_pÜt
);

95 ià(
š‘_±Ú
(
AF_INET6
, 
£rv”_
.
c_¡r
(), &
£rv_addr
.
sš6_addr
) <= 0) {

96 
LOG
(
ERROR
è<< 
kLogOrigš
 << "client inet_ptonƒrror";

97  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "inet_ptonƒrror");

100 ià(
	gout_addr
 !ğ
nuÎ±r
) {

101 *
out_addr
 = 
£rv_addr
;

104 
Stus
 
	g¡©us
 = 
Cl›ÁCÚÃùiÚ
(

105 
cÚÃùiÚ_fd_
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

106 (
£rv_addr
));

107  
	g¡©us
;

110 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁS‘up
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
,

111 
sockaddr_un
 *
out_addr
, 
boŞ
 
u£_·th_Ën
) {

112 
	gcÚÃùiÚ_fd_
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

113 ià(
	gcÚÃùiÚ_fd_
 < 0) {

114 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "client socketƒrror";

115  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

118 
	gfd_şo£r_
.
»£t
(
cÚÃùiÚ_fd_
);

120 
sockaddr_un
 
	g£rv_addr
;

121 
mem£t
(&
£rv_addr
, 0, (serv_addr));

122 
	g£rv_addr
.
	gsun_çmy
 = 
AF_UNIX
;

123 
¡ºıy
(
£rv_addr
.
sun_·th
, 
sock‘_Çme
.
c_¡r
(),

124 (
£rv_addr
.
sun_·th
) - 1);

126 ià(
	gout_addr
 !ğ
nuÎ±r
) {

127 *
out_addr
 = 
£rv_addr
;

130 ià(
	gu£_·th_Ën
) {

131  
Cl›ÁCÚÃùiÚ
(

132 
cÚÃùiÚ_fd_
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

133 (
£rv_addr
.
sun_çmy
è+ 
¡¾’
(£rv_addr.
sun_·th
) + 1);

135  
Cl›ÁCÚÃùiÚ
(
cÚÃùiÚ_fd_
,

136 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

137 (
£rv_addr
));

141 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁRoundŒT¿nsm™
(
buf_Ën
, 
round_Œ
) {

142 
Stus
 
	g¡©us
 = Stus::
OkStus
();

143 
	g¡d
::
unique_±r
<[]> 
Œªsm™_buf
(
Ãw
 [
buf_Ën
]);

144 *
	gbuf
 = 
Œªsm™_buf
.
g‘
();

149 
	ground_Œ
--) {

150 ià(!(
	g¡©us
 = 
R—d
(
buf
, 
buf_Ën
)).
ok
()) {

153 ià(!(
	g¡©us
 = 
Wr™e
(
buf
, 
buf_Ën
)).
ok
()) {

157  
	g¡©us
;

160 
	gSock‘Cl›Á
::
LogCl›ÁIOSts
() {

161 
LOG
(
INFO
è<< 
kLogOrigš
 << "ş›Á mad" << 
sock_Œªsm™_
.
G‘Wr™e
()

163 
LOG
(
INFO
è<< 
	gkLogOrigš
 << "ş›Á mad" << 
	gsock_Œªsm™_
.
G‘R—d
()

167 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁCÚÃùiÚ
(
fd
, 
sockaddr
 *
£rv_addr
,

168 
sockËn_t
 
add¾’
) {

169 ià(
cÚÃù
(
fd
, 
£rv_addr
, 
add¾’
) < 0) {

170 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "ş›Á cÚÃù fau»: " << 
¡»¼Ü
(
”ºo
);

171  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "connect failure");

174  
	gStus
::
OkStus
();

	@platform/posix/sockets/socket_client.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

21 
	~<¬·/š‘.h
>

22 
	~<”ºo.h
>

23 
	~<Ãtš‘/š.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/un.h
>

26 
	~<time.h
>

27 
	~<uni¡d.h
>

29 
	~<memÜy
>

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
	gÇme¥aû
 {

37 #ifdeà
__ASYLO__


38 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "WITHIN ENCLAVE: ";

40 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "OUTSIDE ENCLAVE: ";

45 
	gSock‘Cl›Á
::
Sock‘Cl›Á
(è: 
cÚÃùiÚ_fd_
(-1) {}

47 
Stus
 
Sock‘Cl›Á
::
R—d
(*
buf
, 
size_t
 
»ad_Ën
) {

48  
	gsock_Œªsm™_
.
R—d
(
cÚÃùiÚ_fd_
, 
buf
, 
»ad_Ën
);

51 
Stus
 
	gSock‘Cl›Á
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
) {

52  
	gsock_Œªsm™_
.
Wr™e
(
cÚÃùiÚ_fd_
, 
buf
, 
wr™e_Ën
);

55 
Stus
 
	gSock‘Cl›Á
::
RecvMsg
(
msghdr
 *
msg
, 
æags
) {

56  
	gsock_Œªsm™_
.
RecvMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

59 
Stus
 
	gSock‘Cl›Á
::
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
) {

60  
	gsock_Œªsm™_
.
S’dMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

63 
Stus
 
	gSock‘Cl›Á
::
RecvFrom
(*
bufãr
, 
size_t
 
Ëngth
, 
æags
,

64 
sockaddr
 *
add»ss
,

65 
sockËn_t
 *
add»ss_Ën
) {

66  
	gsock_Œªsm™_
.
RecvFrom
(
cÚÃùiÚ_fd_
, 
bufãr
, 
Ëngth
, 
æags
, 
add»ss
,

67 
add»ss_Ën
);

70 
Stus
 
	gSock‘Cl›Á
::
G‘P“ºame
(
sockaddr
 *
³”addr_out
,

71 
sockËn_t
 *
³”addr_Ën_out
) {

72 ià(
g‘³”Çme
(
cÚÃùiÚ_fd_
, 
³”addr_out
, 
³”addr_Ën_out
) < 0) {

73 
LOG
(
ERROR
è<< "g‘³”Çmçu»: " << 
¡»¼Ü
(
”ºo
);

74  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "getpeername failure");

77  
	gStus
::
OkStus
();

80 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁS‘up
(cÚ¡ 
¡d
::
¡ršg
 &
£rv”_
, 
£rv”_pÜt
,

81 
sockaddr_š6
 *
out_addr
) {

82 
	gcÚÃùiÚ_fd_
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

83 ià(
	gcÚÃùiÚ_fd_
 < 0) {

84 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "client socketƒrror";

85  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

88 
	gfd_şo£r_
.
»£t
(
cÚÃùiÚ_fd_
);

90 
sockaddr_š6
 
	g£rv_addr
;

91 
mem£t
(&
£rv_addr
, 0, (serv_addr));

92 
	g£rv_addr
.
	gsš6_çmy
 = 
AF_INET6
;

93 
	g£rv_addr
.
	gsš6_æowšfo
 = 0;

94 
	g£rv_addr
.
	gsš6_pÜt
 = 
htÚs
(
£rv”_pÜt
);

95 ià(
š‘_±Ú
(
AF_INET6
, 
£rv”_
.
c_¡r
(), &
£rv_addr
.
sš6_addr
) <= 0) {

96 
LOG
(
ERROR
è<< 
kLogOrigš
 << "client inet_ptonƒrror";

97  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "inet_ptonƒrror");

100 ià(
	gout_addr
 !ğ
nuÎ±r
) {

101 *
out_addr
 = 
£rv_addr
;

104 
Stus
 
	g¡©us
 = 
Cl›ÁCÚÃùiÚ
(

105 
cÚÃùiÚ_fd_
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

106 (
£rv_addr
));

107  
	g¡©us
;

110 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁS‘up
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
,

111 
sockaddr_un
 *
out_addr
, 
boŞ
 
u£_·th_Ën
) {

112 
	gcÚÃùiÚ_fd_
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

113 ià(
	gcÚÃùiÚ_fd_
 < 0) {

114 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "client socketƒrror";

115  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

118 
	gfd_şo£r_
.
»£t
(
cÚÃùiÚ_fd_
);

120 
sockaddr_un
 
	g£rv_addr
;

121 
mem£t
(&
£rv_addr
, 0, (serv_addr));

122 
	g£rv_addr
.
	gsun_çmy
 = 
AF_UNIX
;

123 
¡ºıy
(
£rv_addr
.
sun_·th
, 
sock‘_Çme
.
c_¡r
(),

124 (
£rv_addr
.
sun_·th
) - 1);

126 ià(
	gout_addr
 !ğ
nuÎ±r
) {

127 *
out_addr
 = 
£rv_addr
;

130 ià(
	gu£_·th_Ën
) {

131  
Cl›ÁCÚÃùiÚ
(

132 
cÚÃùiÚ_fd_
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

133 (
£rv_addr
.
sun_çmy
è+ 
¡¾’
(£rv_addr.
sun_·th
) + 1);

135  
Cl›ÁCÚÃùiÚ
(
cÚÃùiÚ_fd_
,

136 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

137 (
£rv_addr
));

141 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁRoundŒT¿nsm™
(
buf_Ën
, 
round_Œ
) {

142 
Stus
 
	g¡©us
 = Stus::
OkStus
();

143 
	g¡d
::
unique_±r
<[]> 
Œªsm™_buf
(
Ãw
 [
buf_Ën
]);

144 *
	gbuf
 = 
Œªsm™_buf
.
g‘
();

149 
	ground_Œ
--) {

150 ià(!(
	g¡©us
 = 
R—d
(
buf
, 
buf_Ën
)).
ok
()) {

153 ià(!(
	g¡©us
 = 
Wr™e
(
buf
, 
buf_Ën
)).
ok
()) {

157  
	g¡©us
;

160 
	gSock‘Cl›Á
::
LogCl›ÁIOSts
() {

161 
LOG
(
INFO
è<< 
kLogOrigš
 << "ş›Á mad" << 
sock_Œªsm™_
.
G‘Wr™e
()

163 
LOG
(
INFO
è<< 
	gkLogOrigš
 << "ş›Á mad" << 
	gsock_Œªsm™_
.
G‘R—d
()

167 
Stus
 
	gSock‘Cl›Á
::
Cl›ÁCÚÃùiÚ
(
fd
, 
sockaddr
 *
£rv_addr
,

168 
sockËn_t
 
add¾’
) {

169 ià(
cÚÃù
(
fd
, 
£rv_addr
, 
add¾’
) < 0) {

170 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "ş›Á cÚÃù fau»: " << 
¡»¼Ü
(
”ºo
);

171  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "connect failure");

174  
	gStus
::
OkStus
();

	@platform/posix/sockets/socket_client.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_CLIENT_H_


20 
	#ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_CLIENT_H_


	)

22 
	~<Ãtš‘/š.h
>

23 
	~<sys/sock‘.h
>

24 
	~<sys/un.h
>

26 
	~<¡ršg
>

28 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_Œªsm™.h
"

29 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

31 
Çme¥aû
 
	gasylo
 {

35 şas 
	cSock‘Cl›Á
 {

36 
	gpublic
:

39 
Sock‘Cl›Á
();

47 
Stus
 
Cl›ÁS‘up
(cÚ¡ 
¡d
::
¡ršg
 &
£rv”_
, 
£rv”_pÜt
,

48 
sockaddr_š6
 *
out_addr
);

58 
Stus
 
Cl›ÁS‘up
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
, 
sockaddr_un
 *
out_addr
,

59 
boŞ
 
u£_·th_Ën
);

63 
Stus
 
R—d
(*
buf
, 
size_t
 
»ad_Ën
);

67 
Stus
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
);

71 
Stus
 
RecvMsg
(
msghdr
 *
msg
, 
æags
);

75 
Stus
 
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
);

79 
Stus
 
RecvFrom
(*
bufãr
, 
size_t
 
Ëngth
, 
æags
,

80 
sockaddr
 *
add»ss
, 
sockËn_t
 *
add»ss_Ën
);

85 
Stus
 
Cl›ÁRoundŒT¿nsm™
(
buf_Ën
, 
round_Œ
);

90 
Stus
 
G‘P“ºame
(
sockaddr
 *
³”addr_out
,

91 
sockËn_t
 *
³”addr_Ën_out
);

94 
LogCl›ÁIOSts
();

96 
	g´iv©e
:

97 
cÚÃùiÚ_fd_
;

103 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r_
;

105 
Sock‘T¿nsm™
 
	gsock_Œªsm™_
;

110 
Stus
 
Cl›ÁCÚÃùiÚ
(
fd
, 
sockaddr
 *
£rv_addr
,

111 
sockËn_t
 
add¾’
);

	@platform/posix/sockets/socket_server.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

21 
	~<¬·/š‘.h
>

22 
	~<”ºo.h
>

23 
	~<Ãtš‘/š.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/sock‘.h
>

26 
	~<sys/un.h
>

27 
	~<uni¡d.h
>

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 #ifdeà
__ASYLO__


36 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "WITHIN ENCLAVE: ";

38 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "OUTSIDE ENCLAVE: ";

41 
cÚ¡ex´
 
	gkEÇbËAddrReu£
 = 1;

43 
MakeSockaddrReu§bË
(
fd
) {

44 
	gaddr_»u£
 = 
kEÇbËAddrReu£
;

45  
£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
addr_»u£
,

46 (
addr_»u£
));

51 
	gSock‘S”v”
::
Sock‘S”v”
(è: 
cÚÃùiÚ_fd_
(-1) {}

53 
Stus
 
Sock‘S”v”
::
R—d
(*
buf
, 
size_t
 
»ad_Ën
) {

54  
	gsock_Œªsm™_
.
R—d
(
cÚÃùiÚ_fd_
, 
buf
, 
»ad_Ën
);

57 
Stus
 
	gSock‘S”v”
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
) {

58  
	gsock_Œªsm™_
.
Wr™e
(
cÚÃùiÚ_fd_
, 
buf
, 
wr™e_Ën
);

61 
Stus
 
	gSock‘S”v”
::
RecvMsg
(
msghdr
 *
msg
, 
æags
) {

62  
	gsock_Œªsm™_
.
RecvMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

65 
Stus
 
	gSock‘S”v”
::
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
) {

66  
	gsock_Œªsm™_
.
S’dMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

69 
Stus
 
	gSock‘S”v”
::
RecvFrom
(*
bufãr
, 
size_t
 
Ëngth
, 
æags
,

70 
sockaddr
 *
add»ss
,

71 
sockËn_t
 *
add»ss_Ën
) {

72  
	gsock_Œªsm™_
.
RecvFrom
(
cÚÃùiÚ_fd_
, 
bufãr
, 
Ëngth
, 
æags
, 
add»ss
,

73 
add»ss_Ën
);

76 
Stus
 
	gSock‘S”v”
::
S”v”S‘up
(
£rv”_pÜt
) {

77 
fd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

78 ià(
	gfd
 < 0) {

79 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server socketƒrror";

80  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

83 
	gsock‘_fd_
.
»£t
(
fd
);

85 ià(
MakeSockaddrReu§bË
(
fd
)) {

86 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server setsockoptƒrror";

87  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "setsockoptƒrror");

90 
sockaddr_š6
 
	g£rv_addr
;

91 
mem£t
(&
£rv_addr
, 0, (serv_addr));

92 
	g£rv_addr
.
	gsš6_çmy
 = 
AF_INET6
;

93 
	g£rv_addr
.
	gsš6_æowšfo
 = 0;

94 
	g£rv_addr
.
	gsš6_addr
 = 
š6addr_ªy
;

95 
	g£rv_addr
.
	gsš6_pÜt
 = 
htÚs
(
£rv”_pÜt
);

97 
Stus
 
	g¡©us
 = 
S”v”CÚÃùiÚ
(

98 
fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
), (serv_addr));

99  
	g¡©us
;

102 
Stus
 
	gSock‘S”v”
::
S”v”S‘up
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
,

103 
boŞ
 
u£_·th_Ën
) {

104 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

105 ià(
	gfd
 < 0) {

106 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server socketƒrror";

107  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

110 
	gsock‘_fd_
.
»£t
(
fd
);

112 
sockaddr_un
 
	g£rv_addr
;

113 
mem£t
(&
£rv_addr
, 0, (serv_addr));

114 
	g£rv_addr
.
	gsun_çmy
 = 
AF_UNIX
;

115 
¡ºıy
(
£rv_addr
.
sun_·th
, 
sock‘_Çme
.
c_¡r
(),

116 (
£rv_addr
.
sun_·th
) - 1);

117 ià(
	gu£_·th_Ën
) {

118  
S”v”CÚÃùiÚ
(

119 
fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

120 (
£rv_addr
.
sun_çmy
è+ 
¡¾’
(£rv_addr.
sun_·th
) + 1);

122  
S”v”CÚÃùiÚ
(
fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

123 (
£rv_addr
));

127 
Stus
 
	gSock‘S”v”
::
S”v”Acû±
() {

128 
cÚÃùiÚ_fd_
 = 
acû±
(
sock‘_fd_
.
g‘
(), 
nuÎ±r
,‚ullptr);

129 ià(
	gcÚÃùiÚ_fd_
 < 0) {

130 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server‡cceptƒrror";

131  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "acceptƒrror");

133  
	gStus
::
OkStus
();

136 
Stus
 
	gSock‘S”v”
::
S”v”RoundŒT¿nsm™
(
buf_Ën
, 
round_Œ
) {

137 
Stus
 
	g¡©us
 = Stus::
OkStus
();

138 
	g¡d
::
unique_±r
<[]> 
Œªsm™_buf
(
Ãw
 [
buf_Ën
]);

139 *
	gbuf
 = 
Œªsm™_buf
.
g‘
();

144 
	ground_Œ
--) {

145 ià(!(
	g¡©us
 = 
Wr™e
(
buf
, 
buf_Ën
)).
ok
()) {

148 ià(!(
	g¡©us
 = 
R—d
(
buf
, 
buf_Ën
)).
ok
()) {

152  
	g¡©us
;

155 
	gSock‘S”v”
::
G‘PÜt
() {

156 
sockaddr_š6
 
£rv_addr6
;

157 
sockaddr
 *
	g£rv_addr
 = 
»š‹½»t_ÿ¡
<sockadd¸*>(&
£rv_addr6
);

158 
sockËn_t
 
	g£rv_addr_size
 = (
sockaddr_š6
);

159 ià(
g‘sockÇme
(
sock‘_fd_
.
g‘
(), 
£rv_addr
, &
£rv_addr_size
) != 0) {

160 
LOG
(
ERROR
è<< 
kLogOrigš
 << "g‘sockÇm”rÜ: " << 
¡»¼Ü
(
”ºo
);

165 ià(
	g£rv_addr
->
	g§_çmy
 !ğ
AF_INET6
) {

166 
LOG
(
ERROR
è<< 
kLogOrigš
 << "getsockname‚ot IPv6";

170  
Áohs
(
£rv_addr6
.
sš6_pÜt
);

173 
	gSock‘S”v”
::
LogS”v”IOSts
() {

174 
LOG
(
INFO
è<< 
kLogOrigš
 << "£rv” mad" << 
sock_Œªsm™_
.
G‘Wr™e
()

176 
LOG
(
INFO
è<< 
	gkLogOrigš
 << "£rv” mad" << 
	gsock_Œªsm™_
.
G‘R—d
()

180 
Stus
 
	gSock‘S”v”
::
S”v”CÚÃùiÚ
(
fd
, 
sockaddr
 *
£rv_addr
,

181 
sockËn_t
 
add¾’
) {

182 ià(
bšd
(
fd
, 
£rv_addr
, 
add¾’
)) {

183 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server bindƒrror";

184  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "bindƒrror");

186 ià(
li¡’
(
fd
, 1)) {

187 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server†istenƒrror";

188  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "listenƒrror");

190  
	gStus
::
OkStus
();

	@platform/posix/sockets/socket_server.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

21 
	~<¬·/š‘.h
>

22 
	~<”ºo.h
>

23 
	~<Ãtš‘/š.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/sock‘.h
>

26 
	~<sys/un.h
>

27 
	~<uni¡d.h
>

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
	gÇme¥aû
 {

35 #ifdeà
__ASYLO__


36 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "WITHIN ENCLAVE: ";

38 
cÚ¡ex´
 cÚ¡ 
	gkLogOrigš
[] = "OUTSIDE ENCLAVE: ";

41 
cÚ¡ex´
 
	gkEÇbËAddrReu£
 = 1;

43 
MakeSockaddrReu§bË
(
fd
) {

44 
	gaddr_»u£
 = 
kEÇbËAddrReu£
;

45  
£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, &
addr_»u£
,

46 (
addr_»u£
));

51 
	gSock‘S”v”
::
Sock‘S”v”
(è: 
cÚÃùiÚ_fd_
(-1) {}

53 
Stus
 
Sock‘S”v”
::
R—d
(*
buf
, 
size_t
 
»ad_Ën
) {

54  
	gsock_Œªsm™_
.
R—d
(
cÚÃùiÚ_fd_
, 
buf
, 
»ad_Ën
);

57 
Stus
 
	gSock‘S”v”
::
Wr™e
(cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
) {

58  
	gsock_Œªsm™_
.
Wr™e
(
cÚÃùiÚ_fd_
, 
buf
, 
wr™e_Ën
);

61 
Stus
 
	gSock‘S”v”
::
RecvMsg
(
msghdr
 *
msg
, 
æags
) {

62  
	gsock_Œªsm™_
.
RecvMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

65 
Stus
 
	gSock‘S”v”
::
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
) {

66  
	gsock_Œªsm™_
.
S’dMsg
(
cÚÃùiÚ_fd_
, 
msg
, 
æags
);

69 
Stus
 
	gSock‘S”v”
::
RecvFrom
(*
bufãr
, 
size_t
 
Ëngth
, 
æags
,

70 
sockaddr
 *
add»ss
,

71 
sockËn_t
 *
add»ss_Ën
) {

72  
	gsock_Œªsm™_
.
RecvFrom
(
cÚÃùiÚ_fd_
, 
bufãr
, 
Ëngth
, 
æags
, 
add»ss
,

73 
add»ss_Ën
);

76 
Stus
 
	gSock‘S”v”
::
S”v”S‘up
(
£rv”_pÜt
) {

77 
fd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

78 ià(
	gfd
 < 0) {

79 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server socketƒrror";

80  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

83 
	gsock‘_fd_
.
»£t
(
fd
);

85 ià(
MakeSockaddrReu§bË
(
fd
)) {

86 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server setsockoptƒrror";

87  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "setsockoptƒrror");

90 
sockaddr_š6
 
	g£rv_addr
;

91 
mem£t
(&
£rv_addr
, 0, (serv_addr));

92 
	g£rv_addr
.
	gsš6_çmy
 = 
AF_INET6
;

93 
	g£rv_addr
.
	gsš6_æowšfo
 = 0;

94 
	g£rv_addr
.
	gsš6_addr
 = 
š6addr_ªy
;

95 
	g£rv_addr
.
	gsš6_pÜt
 = 
htÚs
(
£rv”_pÜt
);

97 
Stus
 
	g¡©us
 = 
S”v”CÚÃùiÚ
(

98 
fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
), (serv_addr));

99  
	g¡©us
;

102 
Stus
 
	gSock‘S”v”
::
S”v”S‘up
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
,

103 
boŞ
 
u£_·th_Ën
) {

104 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

105 ià(
	gfd
 < 0) {

106 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server socketƒrror";

107  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "socketƒrror");

110 
	gsock‘_fd_
.
»£t
(
fd
);

112 
sockaddr_un
 
	g£rv_addr
;

113 
mem£t
(&
£rv_addr
, 0, (serv_addr));

114 
	g£rv_addr
.
	gsun_çmy
 = 
AF_UNIX
;

115 
¡ºıy
(
£rv_addr
.
sun_·th
, 
sock‘_Çme
.
c_¡r
(),

116 (
£rv_addr
.
sun_·th
) - 1);

117 ià(
	gu£_·th_Ën
) {

118  
S”v”CÚÃùiÚ
(

119 
fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

120 (
£rv_addr
.
sun_çmy
è+ 
¡¾’
(£rv_addr.
sun_·th
) + 1);

122  
S”v”CÚÃùiÚ
(
fd
, 
»š‹½»t_ÿ¡
<
sockaddr
 *>(&
£rv_addr
),

123 (
£rv_addr
));

127 
Stus
 
	gSock‘S”v”
::
S”v”Acû±
() {

128 
cÚÃùiÚ_fd_
 = 
acû±
(
sock‘_fd_
.
g‘
(), 
nuÎ±r
,‚ullptr);

129 ià(
	gcÚÃùiÚ_fd_
 < 0) {

130 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server‡cceptƒrror";

131  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "acceptƒrror");

133  
	gStus
::
OkStus
();

136 
Stus
 
	gSock‘S”v”
::
S”v”RoundŒT¿nsm™
(
buf_Ën
, 
round_Œ
) {

137 
Stus
 
	g¡©us
 = Stus::
OkStus
();

138 
	g¡d
::
unique_±r
<[]> 
Œªsm™_buf
(
Ãw
 [
buf_Ën
]);

139 *
	gbuf
 = 
Œªsm™_buf
.
g‘
();

144 
	ground_Œ
--) {

145 ià(!(
	g¡©us
 = 
Wr™e
(
buf
, 
buf_Ën
)).
ok
()) {

148 ià(!(
	g¡©us
 = 
R—d
(
buf
, 
buf_Ën
)).
ok
()) {

152  
	g¡©us
;

155 
	gSock‘S”v”
::
G‘PÜt
() {

156 
sockaddr_š6
 
£rv_addr6
;

157 
sockaddr
 *
	g£rv_addr
 = 
»š‹½»t_ÿ¡
<sockadd¸*>(&
£rv_addr6
);

158 
sockËn_t
 
	g£rv_addr_size
 = (
sockaddr_š6
);

159 ià(
g‘sockÇme
(
sock‘_fd_
.
g‘
(), 
£rv_addr
, &
£rv_addr_size
) != 0) {

160 
LOG
(
ERROR
è<< 
kLogOrigš
 << "g‘sockÇm”rÜ: " << 
¡»¼Ü
(
”ºo
);

165 ià(
	g£rv_addr
->
	g§_çmy
 !ğ
AF_INET6
) {

166 
LOG
(
ERROR
è<< 
kLogOrigš
 << "getsockname‚ot IPv6";

170  
Áohs
(
£rv_addr6
.
sš6_pÜt
);

173 
	gSock‘S”v”
::
LogS”v”IOSts
() {

174 
LOG
(
INFO
è<< 
kLogOrigš
 << "£rv” mad" << 
sock_Œªsm™_
.
G‘Wr™e
()

176 
LOG
(
INFO
è<< 
	gkLogOrigš
 << "£rv” mad" << 
	gsock_Œªsm™_
.
G‘R—d
()

180 
Stus
 
	gSock‘S”v”
::
S”v”CÚÃùiÚ
(
fd
, 
sockaddr
 *
£rv_addr
,

181 
sockËn_t
 
add¾’
) {

182 ià(
bšd
(
fd
, 
£rv_addr
, 
add¾’
)) {

183 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server bindƒrror";

184  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "bindƒrror");

186 ià(
li¡’
(
fd
, 1)) {

187 
LOG
(
ERROR
è<< 
	gkLogOrigš
 << "server†istenƒrror";

188  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "listenƒrror");

190  
	gStus
::
OkStus
();

	@platform/posix/sockets/socket_server.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_SERVER_H_


20 
	#ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_SERVER_H_


	)

22 
	~<sys/sock‘.h
>

24 
	~<¡ršg
>

26 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_Œªsm™.h
"

27 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

29 
Çme¥aû
 
	gasylo
 {

35 şas 
	cSock‘S”v”
 {

36 
	gpublic
:

39 
Sock‘S”v”
();

45 
Stus
 
S”v”S‘up
(
£rv”_pÜt
 = 0);

53 
Stus
 
S”v”S‘up
(cÚ¡ 
¡d
::
¡ršg
 &
sock‘_Çme
, 
boŞ
 
u£_·th_Ën
);

57 
Stus
 
S”v”Acû±
();

61 
Stus
 
R—d
(*
buf
, 
size_t
 
»ad_Ën
);

65 
Stus
 
Wr™e
(cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
);

69 
Stus
 
RecvMsg
(
msghdr
 *
msg
, 
æags
);

73 
Stus
 
S’dMsg
(cÚ¡ 
msghdr
 *
msg
, 
æags
);

77 
Stus
 
RecvFrom
(*
bufãr
, 
size_t
 
Ëngth
, 
æags
,

78 
sockaddr
 *
add»ss
, 
sockËn_t
 *
add»ss_Ën
);

83 
Stus
 
S”v”RoundŒT¿nsm™
(
buf_Ën
, 
round_Œ
);

86 
LogS”v”IOSts
();

90 
G‘PÜt
();

92 
	g´iv©e
:

93 
cÚÃùiÚ_fd_
;

94 
Sock‘T¿nsm™
 
	gsock_Œªsm™_
;

95 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
sock‘_fd_
;

101 
Stus
 
S”v”CÚÃùiÚ
(
fd
, 
sockaddr
 *
£rv_addr
,

102 
sockËn_t
 
add¾’
);

	@platform/posix/sockets/socket_test_transmit.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

21 
	~<¡ršg.h
>

22 
	~<sys/sock‘.h
>

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkCl›ÁWr™eSucûssSŒ
[] = "Client Write is successful.";

30 
cÚ¡ex´
 
	gkS”v”Wr™eSucûssSŒ
[] = "Server Write is successful.";

31 
cÚ¡ex´
 
	gkCl›ÁMsgSucûssSŒ1
[] = "First Client SendMsg is successful.";

32 
cÚ¡ex´
 
	gkCl›ÁMsgSucûssSŒ2
[] = "Second Client SendMsg is successful.";

33 
cÚ¡ex´
 
	gkS”v”MsgSucûssSŒ1
[] = "First Server RecvMsg is successful.";

34 
cÚ¡ex´
 
	gkS”v”MsgSucûssSŒ2
[] = "Second Server RecvMsg is successful.";

35 
cÚ¡ex´
 
	gkNumMsgs
 = 2;

37 
As£mbËMsgHdr
(
msghdr
 *
msg
, 
iovec
 *
iov
, cÚ¡ *
msg1
,

38 cÚ¡ *
msg2
, *
buf1
, *
buf2
, 
boŞ
 
isS’d
) {

39 
mem£t
(
iov
, 0, (*iov));

40 ià(
	gisS’d
) {

41 
	giov
[0].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
cÚ¡_ÿ¡
<*>(
msg1
));

42 
	giov
[1].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
cÚ¡_ÿ¡
<*>(
msg2
));

44 
	giov
[0].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf1
);

45 
	giov
[1].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf2
);

47 
	giov
[0].
	giov_Ën
 = (
msg1
);

48 
	giov
[1].
	giov_Ën
 = (
msg2
);

49 
mem£t
(
msg
, 0, (*msg));

50 
	gmsg
->
	gmsg_iov
 = 
iov
;

51 
	gmsg
->
	gmsg_iovËn
 = 
kNumMsgs
;

56 
Stus
 
S”v”T¿nsm™
(
Sock‘S”v”
 *
sock‘_£rv”
) {

57 
Stus
 
	g¡©us
;

58 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
Wr™e
(
kS”v”Wr™eSucûssSŒ
,

59 (
kS”v”Wr™eSucûssSŒ
)))

60 .
ok
()) {

61  
	g¡©us
;

63 
	gsock‘_buf
[(
kCl›ÁWr™eSucûssSŒ
)];

64 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
R—d
(
sock‘_buf
, (sock‘_buf))).
ok
()) {

65  
	g¡©us
;

67 ià(
¡ºcmp
(
sock‘_buf
, 
kCl›ÁWr™eSucûssSŒ
, (socket_buf))) {

68  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

72 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
Wr™e
(
kS”v”Wr™eSucûssSŒ
,

73 (
kS”v”Wr™eSucûssSŒ
)))

74 .
ok
()) {

75  
	g¡©us
;

78 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
RecvFrom
(
sock‘_buf
, (socket_buf), 0,

79 
nuÎ±r
,‚ullptr))

80 .
ok
()) {

81  
	g¡©us
;

83 ià(
¡ºcmp
(
sock‘_buf
, 
kCl›ÁWr™eSucûssSŒ
, (socket_buf))) {

84  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

88 
iovec
 
	gmsg_iov_£nd
[
kNumMsgs
];

89 
msghdr
 
	gmsg_£nd
;

90 
As£mbËMsgHdr
(&
msg_£nd
, 
msg_iov_£nd
, 
kS”v”MsgSucûssSŒ1
,

91 
kS”v”MsgSucûssSŒ2
, 
nuÎ±r
,‚uÎ±r, 
Œue
);

92 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
S’dMsg
(&
msg_£nd
, 0)).
ok
()) {

93  
	g¡©us
;

96 
iovec
 
	gmsg_iov_»cv
[
kNumMsgs
];

97 
msghdr
 
	gmsg_»cv
;

98 
	gbuf1
[(
kCl›ÁMsgSucûssSŒ1
)];

99 
	gbuf2
[(
kCl›ÁMsgSucûssSŒ2
)];

100 
As£mbËMsgHdr
(&
msg_»cv
, 
msg_iov_»cv
, 
kCl›ÁMsgSucûssSŒ1
,

101 
kCl›ÁMsgSucûssSŒ2
, 
buf1
, 
buf2
, 
çl£
);

102 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
RecvMsg
(&
msg_»cv
, 0)).
ok
()) {

103  
	g¡©us
;

105 ià(
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[0].
iov_ba£
),

106 
kCl›ÁMsgSucûssSŒ1
, 
msg_»cv
.
msg_iov
[0].
iov_Ën
) ||

107 
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[1].
iov_ba£
),

108 
kCl›ÁMsgSucûssSŒ2
, 
msg_»cv
.
msg_iov
[1].
iov_Ën
)) {

109  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

112  
	gStus
::
OkStus
();

115 
Stus
 
Cl›ÁT¿nsm™
(
Sock‘Cl›Á
 *
sock‘_ş›Á
) {

116 
	gsock‘_buf
[(
kS”v”Wr™eSucûssSŒ
)];

117 
Stus
 
	g¡©us
;

118 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
R—d
(
sock‘_buf
, (sock‘_buf))).
ok
()) {

119  
	g¡©us
;

121 ià(
¡ºcmp
(
sock‘_buf
, 
kS”v”Wr™eSucûssSŒ
, (socket_buf))) {

122  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

125 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
Wr™e
(
kCl›ÁWr™eSucûssSŒ
,

126 (
kCl›ÁWr™eSucûssSŒ
)))

127 .
ok
()) {

128  
	g¡©us
;

131 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
RecvFrom
(
sock‘_buf
, (socket_buf), 0,

132 
nuÎ±r
,‚ullptr))

133 .
ok
()) {

134  
	g¡©us
;

136 ià(
¡ºcmp
(
sock‘_buf
, 
kS”v”Wr™eSucûssSŒ
, (socket_buf))) {

137  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

140 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
Wr™e
(
kCl›ÁWr™eSucûssSŒ
,

141 (
kCl›ÁWr™eSucûssSŒ
)))

142 .
ok
()) {

143  
	g¡©us
;

146 
iovec
 
	gmsg_iov_»cv
[
kNumMsgs
];

147 
msghdr
 
	gmsg_»cv
;

148 
	gbuf1
[(
kS”v”MsgSucûssSŒ1
)];

149 
	gbuf2
[(
kS”v”MsgSucûssSŒ2
)];

150 
As£mbËMsgHdr
(&
msg_»cv
, 
msg_iov_»cv
, 
kS”v”MsgSucûssSŒ1
,

151 
kS”v”MsgSucûssSŒ2
, 
buf1
, 
buf2
, 
çl£
);

152 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
RecvMsg
(&
msg_»cv
, 0)).
ok
()) {

153  
	g¡©us
;

155 ià(
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[0].
iov_ba£
),

156 
kS”v”MsgSucûssSŒ1
, 
msg_»cv
.
msg_iov
[0].
iov_Ën
) ||

157 
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[1].
iov_ba£
),

158 
kS”v”MsgSucûssSŒ2
, 
msg_»cv
.
msg_iov
[1].
iov_Ën
)) {

159  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

162 
iovec
 
	gmsg_iov_£nd
[
kNumMsgs
];

163 
msghdr
 
	gmsg_£nd
;

164 
As£mbËMsgHdr
(&
msg_£nd
, 
msg_iov_£nd
, 
kCl›ÁMsgSucûssSŒ1
,

165 
kCl›ÁMsgSucûssSŒ2
, 
nuÎ±r
,‚uÎ±r, 
Œue
);

166 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
S’dMsg
(&
msg_£nd
, 0)).
ok
()) {

167  
	g¡©us
;

169  
	gStus
::
OkStus
();

	@platform/posix/sockets/socket_test_transmit.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_‹¡_Œªsm™.h
"

21 
	~<¡ršg.h
>

22 
	~<sys/sock‘.h
>

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkCl›ÁWr™eSucûssSŒ
[] = "Client Write is successful.";

30 
cÚ¡ex´
 
	gkS”v”Wr™eSucûssSŒ
[] = "Server Write is successful.";

31 
cÚ¡ex´
 
	gkCl›ÁMsgSucûssSŒ1
[] = "First Client SendMsg is successful.";

32 
cÚ¡ex´
 
	gkCl›ÁMsgSucûssSŒ2
[] = "Second Client SendMsg is successful.";

33 
cÚ¡ex´
 
	gkS”v”MsgSucûssSŒ1
[] = "First Server RecvMsg is successful.";

34 
cÚ¡ex´
 
	gkS”v”MsgSucûssSŒ2
[] = "Second Server RecvMsg is successful.";

35 
cÚ¡ex´
 
	gkNumMsgs
 = 2;

37 
As£mbËMsgHdr
(
msghdr
 *
msg
, 
iovec
 *
iov
, cÚ¡ *
msg1
,

38 cÚ¡ *
msg2
, *
buf1
, *
buf2
, 
boŞ
 
isS’d
) {

39 
mem£t
(
iov
, 0, (*iov));

40 ià(
	gisS’d
) {

41 
	giov
[0].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
cÚ¡_ÿ¡
<*>(
msg1
));

42 
	giov
[1].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
cÚ¡_ÿ¡
<*>(
msg2
));

44 
	giov
[0].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf1
);

45 
	giov
[1].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf2
);

47 
	giov
[0].
	giov_Ën
 = (
msg1
);

48 
	giov
[1].
	giov_Ën
 = (
msg2
);

49 
mem£t
(
msg
, 0, (*msg));

50 
	gmsg
->
	gmsg_iov
 = 
iov
;

51 
	gmsg
->
	gmsg_iovËn
 = 
kNumMsgs
;

56 
Stus
 
S”v”T¿nsm™
(
Sock‘S”v”
 *
sock‘_£rv”
) {

57 
Stus
 
	g¡©us
;

58 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
Wr™e
(
kS”v”Wr™eSucûssSŒ
,

59 (
kS”v”Wr™eSucûssSŒ
)))

60 .
ok
()) {

61  
	g¡©us
;

63 
	gsock‘_buf
[(
kCl›ÁWr™eSucûssSŒ
)];

64 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
R—d
(
sock‘_buf
, (sock‘_buf))).
ok
()) {

65  
	g¡©us
;

67 ià(
¡ºcmp
(
sock‘_buf
, 
kCl›ÁWr™eSucûssSŒ
, (socket_buf))) {

68  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

72 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
Wr™e
(
kS”v”Wr™eSucûssSŒ
,

73 (
kS”v”Wr™eSucûssSŒ
)))

74 .
ok
()) {

75  
	g¡©us
;

78 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
RecvFrom
(
sock‘_buf
, (socket_buf), 0,

79 
nuÎ±r
,‚ullptr))

80 .
ok
()) {

81  
	g¡©us
;

83 ià(
¡ºcmp
(
sock‘_buf
, 
kCl›ÁWr™eSucûssSŒ
, (socket_buf))) {

84  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

88 
iovec
 
	gmsg_iov_£nd
[
kNumMsgs
];

89 
msghdr
 
	gmsg_£nd
;

90 
As£mbËMsgHdr
(&
msg_£nd
, 
msg_iov_£nd
, 
kS”v”MsgSucûssSŒ1
,

91 
kS”v”MsgSucûssSŒ2
, 
nuÎ±r
,‚uÎ±r, 
Œue
);

92 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
S’dMsg
(&
msg_£nd
, 0)).
ok
()) {

93  
	g¡©us
;

96 
iovec
 
	gmsg_iov_»cv
[
kNumMsgs
];

97 
msghdr
 
	gmsg_»cv
;

98 
	gbuf1
[(
kCl›ÁMsgSucûssSŒ1
)];

99 
	gbuf2
[(
kCl›ÁMsgSucûssSŒ2
)];

100 
As£mbËMsgHdr
(&
msg_»cv
, 
msg_iov_»cv
, 
kCl›ÁMsgSucûssSŒ1
,

101 
kCl›ÁMsgSucûssSŒ2
, 
buf1
, 
buf2
, 
çl£
);

102 ià(!(
	g¡©us
 = 
sock‘_£rv”
->
RecvMsg
(&
msg_»cv
, 0)).
ok
()) {

103  
	g¡©us
;

105 ià(
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[0].
iov_ba£
),

106 
kCl›ÁMsgSucûssSŒ1
, 
msg_»cv
.
msg_iov
[0].
iov_Ën
) ||

107 
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[1].
iov_ba£
),

108 
kCl›ÁMsgSucûssSŒ2
, 
msg_»cv
.
msg_iov
[1].
iov_Ën
)) {

109  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

112  
	gStus
::
OkStus
();

115 
Stus
 
Cl›ÁT¿nsm™
(
Sock‘Cl›Á
 *
sock‘_ş›Á
) {

116 
	gsock‘_buf
[(
kS”v”Wr™eSucûssSŒ
)];

117 
Stus
 
	g¡©us
;

118 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
R—d
(
sock‘_buf
, (sock‘_buf))).
ok
()) {

119  
	g¡©us
;

121 ià(
¡ºcmp
(
sock‘_buf
, 
kS”v”Wr™eSucûssSŒ
, (socket_buf))) {

122  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

125 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
Wr™e
(
kCl›ÁWr™eSucûssSŒ
,

126 (
kCl›ÁWr™eSucûssSŒ
)))

127 .
ok
()) {

128  
	g¡©us
;

131 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
RecvFrom
(
sock‘_buf
, (socket_buf), 0,

132 
nuÎ±r
,‚ullptr))

133 .
ok
()) {

134  
	g¡©us
;

136 ià(
¡ºcmp
(
sock‘_buf
, 
kS”v”Wr™eSucûssSŒ
, (socket_buf))) {

137  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

140 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
Wr™e
(
kCl›ÁWr™eSucûssSŒ
,

141 (
kCl›ÁWr™eSucûssSŒ
)))

142 .
ok
()) {

143  
	g¡©us
;

146 
iovec
 
	gmsg_iov_»cv
[
kNumMsgs
];

147 
msghdr
 
	gmsg_»cv
;

148 
	gbuf1
[(
kS”v”MsgSucûssSŒ1
)];

149 
	gbuf2
[(
kS”v”MsgSucûssSŒ2
)];

150 
As£mbËMsgHdr
(&
msg_»cv
, 
msg_iov_»cv
, 
kS”v”MsgSucûssSŒ1
,

151 
kS”v”MsgSucûssSŒ2
, 
buf1
, 
buf2
, 
çl£
);

152 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
RecvMsg
(&
msg_»cv
, 0)).
ok
()) {

153  
	g¡©us
;

155 ià(
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[0].
iov_ba£
),

156 
kS”v”MsgSucûssSŒ1
, 
msg_»cv
.
msg_iov
[0].
iov_Ën
) ||

157 
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
msg_»cv
.
msg_iov
[1].
iov_ba£
),

158 
kS”v”MsgSucûssSŒ2
, 
msg_»cv
.
msg_iov
[1].
iov_Ën
)) {

159  
Stus
(
”rÜ
::
GoogËE¼Ü
::
DATA_LOSS
,

162 
iovec
 
	gmsg_iov_£nd
[
kNumMsgs
];

163 
msghdr
 
	gmsg_£nd
;

164 
As£mbËMsgHdr
(&
msg_£nd
, 
msg_iov_£nd
, 
kCl›ÁMsgSucûssSŒ1
,

165 
kCl›ÁMsgSucûssSŒ2
, 
nuÎ±r
,‚uÎ±r, 
Œue
);

166 ià(!(
	g¡©us
 = 
sock‘_ş›Á
->
S’dMsg
(&
msg_£nd
, 0)).
ok
()) {

167  
	g¡©us
;

169  
	gStus
::
OkStus
();

	@platform/posix/sockets/socket_test_transmit.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_TEST_TRANSMIT_H_


20 
	#ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_TEST_TRANSMIT_H_


	)

22 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_ş›Á.h
"

23 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_£rv”.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
cÚ¡ex´
 
	gkLoÿlIpv6AddrSŒ
[] = "::1";

32 
Stus
 
S”v”T¿nsm™
(
Sock‘S”v”
 *
sock‘_£rv”
);

36 
Stus
 
Cl›ÁT¿nsm™
(
Sock‘Cl›Á
 *
sock‘_ş›Á
);

	@platform/posix/sockets/socket_transmit.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_Œªsm™.h
"

21 
	~<”ºo.h
>

22 
	~<uni¡d.h
>

24 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gSock‘T¿nsm™
::
Sock‘T¿nsm™
(è: 
wr™e_couÁ_
(0), 
»ad_couÁ_
(0) {}

30 
Stus
 
	gSock‘T¿nsm™
::
R—d
(
fd
, *
buf
, 
size_t
 
»ad_Ën
) {

31 
	g»ad_by‹s
 = 0;

32 
	gnby‹s
 = 0;

33 
	g»ad_by‹s
 < 
	g»ad_Ën
) {

34 
	gnby‹s
 = 
»ad
(
fd
, 
»š‹½»t_ÿ¡
<*>(
buf
è+ 
»ad_by‹s
,

35 
»ad_Ën
 - 
»ad_by‹s
);

36 ià(
	gnby‹s
 < 0) {

37 
	g”ºo
) {

38 
	gEINTR
:

39 
EAGAIN
:

44 } ià(!
	gnby‹s
) {

45  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EPIPE
, "connection closed by…eer");

47 
	g»ad_by‹s
 +ğ
nby‹s
;

48 ++
	g»ad_couÁ_
;

51 ià(
	g»ad_by‹s
 < 
	g»ad_Ën
) {

52  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "readƒrror");

54  
	gStus
::
OkStus
();

57 
Stus
 
	gSock‘T¿nsm™
::
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
) {

58 
	gwr™e_by‹s
 = 0;

59 
	gnby‹s
 = 0;

60 
	gwr™e_by‹s
 < 
	gwr™e_Ën
) {

61 
	gnby‹s
 = 
wr™e
(
fd
, 
»š‹½»t_ÿ¡
<cÚ¡ *>(
buf
è+ 
wr™e_by‹s
,

62 
wr™e_Ën
 - 
wr™e_by‹s
);

63 ià(
	gnby‹s
 < 0) {

64 
	g”ºo
) {

65 
	gEINTR
:

66 
EAGAIN
:

72 
	gwr™e_by‹s
 +ğ
nby‹s
;

73 ++
	gwr™e_couÁ_
;

76 ià(
	gwr™e_by‹s
 < 
	gwr™e_Ën
) {

77  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "writeƒrror");

79  
	gStus
::
OkStus
();

82 
Stus
 
	gSock‘T¿nsm™
::
RecvMsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
) {

83 ià(
»cvmsg
(
sockfd
, 
msg
, 
æags
) == -1) {

84  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

85 
¡d
::
¡ršg
("»cvmsgƒ¼Ü:"è+ 
¡»¼Ü
(
”ºo
));

87  
	gStus
::
OkStus
();

90 
Stus
 
	gSock‘T¿nsm™
::
S’dMsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
,

91 
æags
) {

92 ià(
£ndmsg
(
sockfd
, 
msg
, 
æags
) == -1) {

93  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

94 
¡d
::
¡ršg
("£ndmsgƒ¼Ü:"è+ 
¡»¼Ü
(
”ºo
));

96  
	gStus
::
OkStus
();

99 
Stus
 
	gSock‘T¿nsm™
::
RecvFrom
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
,

100 
æags
, 
sockaddr
 *
add»ss
,

101 
sockËn_t
 *
add»ss_Ën
) {

102 ià(
»cväom
(
sock‘
, 
bufãr
, 
Ëngth
, 
æags
, 
add»ss
, 
add»ss_Ën
) == -1) {

103  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

104 
¡d
::
¡ršg
("»cväomƒ¼Ü:"è+ 
¡»¼Ü
(
”ºo
));

106  
	gStus
::
OkStus
();

109 
	gSock‘T¿nsm™
::
G‘Wr™e
(ècÚ¡ {  
wr™e_couÁ_
; }

111 
	gSock‘T¿nsm™
::
G‘R—d
(ècÚ¡ {  
»ad_couÁ_
; }

113 
	gSock‘T¿nsm™
::
»£t
() {

114 
wr™e_couÁ_
 = 0;

115 
	g»ad_couÁ_
 = 0;

	@platform/posix/sockets/socket_transmit.cc

19 
	~"asylo/¶©fÜm/posix/sock‘s/sock‘_Œªsm™.h
"

21 
	~<”ºo.h
>

22 
	~<uni¡d.h
>

24 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gSock‘T¿nsm™
::
Sock‘T¿nsm™
(è: 
wr™e_couÁ_
(0), 
»ad_couÁ_
(0) {}

30 
Stus
 
	gSock‘T¿nsm™
::
R—d
(
fd
, *
buf
, 
size_t
 
»ad_Ën
) {

31 
	g»ad_by‹s
 = 0;

32 
	gnby‹s
 = 0;

33 
	g»ad_by‹s
 < 
	g»ad_Ën
) {

34 
	gnby‹s
 = 
»ad
(
fd
, 
»š‹½»t_ÿ¡
<*>(
buf
è+ 
»ad_by‹s
,

35 
»ad_Ën
 - 
»ad_by‹s
);

36 ià(
	gnby‹s
 < 0) {

37 
	g”ºo
) {

38 
	gEINTR
:

39 
EAGAIN
:

44 } ià(!
	gnby‹s
) {

45  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EPIPE
, "connection closed by…eer");

47 
	g»ad_by‹s
 +ğ
nby‹s
;

48 ++
	g»ad_couÁ_
;

51 ià(
	g»ad_by‹s
 < 
	g»ad_Ën
) {

52  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "readƒrror");

54  
	gStus
::
OkStus
();

57 
Stus
 
	gSock‘T¿nsm™
::
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
) {

58 
	gwr™e_by‹s
 = 0;

59 
	gnby‹s
 = 0;

60 
	gwr™e_by‹s
 < 
	gwr™e_Ën
) {

61 
	gnby‹s
 = 
wr™e
(
fd
, 
»š‹½»t_ÿ¡
<cÚ¡ *>(
buf
è+ 
wr™e_by‹s
,

62 
wr™e_Ën
 - 
wr™e_by‹s
);

63 ià(
	gnby‹s
 < 0) {

64 
	g”ºo
) {

65 
	gEINTR
:

66 
EAGAIN
:

72 
	gwr™e_by‹s
 +ğ
nby‹s
;

73 ++
	gwr™e_couÁ_
;

76 ià(
	gwr™e_by‹s
 < 
	gwr™e_Ën
) {

77  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
), "writeƒrror");

79  
	gStus
::
OkStus
();

82 
Stus
 
	gSock‘T¿nsm™
::
RecvMsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
) {

83 ià(
»cvmsg
(
sockfd
, 
msg
, 
æags
) == -1) {

84  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

85 
¡d
::
¡ršg
("»cvmsgƒ¼Ü:"è+ 
¡»¼Ü
(
”ºo
));

87  
	gStus
::
OkStus
();

90 
Stus
 
	gSock‘T¿nsm™
::
S’dMsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
,

91 
æags
) {

92 ià(
£ndmsg
(
sockfd
, 
msg
, 
æags
) == -1) {

93  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

94 
¡d
::
¡ršg
("£ndmsgƒ¼Ü:"è+ 
¡»¼Ü
(
”ºo
));

96  
	gStus
::
OkStus
();

99 
Stus
 
	gSock‘T¿nsm™
::
RecvFrom
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
,

100 
æags
, 
sockaddr
 *
add»ss
,

101 
sockËn_t
 *
add»ss_Ën
) {

102 ià(
»cväom
(
sock‘
, 
bufãr
, 
Ëngth
, 
æags
, 
add»ss
, 
add»ss_Ën
) == -1) {

103  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

104 
¡d
::
¡ršg
("»cväomƒ¼Ü:"è+ 
¡»¼Ü
(
”ºo
));

106  
	gStus
::
OkStus
();

109 
	gSock‘T¿nsm™
::
G‘Wr™e
(ècÚ¡ {  
wr™e_couÁ_
; }

111 
	gSock‘T¿nsm™
::
G‘R—d
(ècÚ¡ {  
»ad_couÁ_
; }

113 
	gSock‘T¿nsm™
::
»£t
() {

114 
wr™e_couÁ_
 = 0;

115 
	g»ad_couÁ_
 = 0;

	@platform/posix/sockets/socket_transmit.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_TRANSMIT_H_


20 
	#ASYLO_PLATFORM_POSIX_SOCKETS_SOCKET_TRANSMIT_H_


	)

22 
	~<sys/sock‘.h
>

23 
	~<c¡ršg
>

25 
	~"asylo/ut/¡©us.h
"

27 
Çme¥aû
 
	gasylo
 {

33 şas 
	cSock‘T¿nsm™
 {

34 
	gpublic
:

37 
Sock‘T¿nsm™
();

46 
Stus
 
R—d
(
fd
, *
buf
, 
size_t
 
»ad_Ën
);

55 
Stus
 
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
wr™e_Ën
);

58 
Stus
 
RecvMsg
(
sockfd
, 
msghdr
 *
msg
, 
æags
);

61 
Stus
 
S’dMsg
(
sockfd
, cÚ¡ 
msghdr
 *
msg
, 
æags
);

65 
Stus
 
RecvFrom
(
sock‘
, *
bufãr
, 
size_t
 
Ëngth
, 
æags
,

66 
sockaddr
 *
add»ss
, 
sockËn_t
 *
add»ss_Ën
);

69 
G‘Wr™e
() const;

72 
G‘R—d
() const;

75 
»£t
();

77 
	g´iv©e
:

78 
wr™e_couÁ_
;

79 
	g»ad_couÁ_
;

	@platform/posix/stat.cc

19 
	~<sys/¡©.h
>

20 
	~<sys/ty³s.h
>

22 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

24 
usšg
 
	gasylo
::
io
::
IOMªag”
;

28 
l¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

29  
IOMªag”
::
G‘In¡ªû
().
LSt
(
·thÇme
, 
¡©_bufãr
);

32 
mode_t
 
umask
(mode_ˆ
mask
è{  
IOMªag”
::
G‘In¡ªû
().
Umask
(mask); }

34 
chmod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

35  
IOMªag”
::
G‘In¡ªû
().
ChMod
(
·thÇme
, 
mode
);

38 
fchmod
(
fd
, 
mode_t
 
mode
) {

39  
IOMªag”
::
G‘In¡ªû
().
FChMod
(
fd
, 
mode
);

42 
mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

43  
IOMªag”
::
G‘In¡ªû
().
Mkdœ
(
·thÇme
, 
mode
);

	@platform/posix/stat.cc

19 
	~<sys/¡©.h
>

20 
	~<sys/ty³s.h
>

22 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

24 
usšg
 
	gasylo
::
io
::
IOMªag”
;

28 
l¡©
(cÚ¡ *
·thÇme
, 
¡©
 *
¡©_bufãr
) {

29  
IOMªag”
::
G‘In¡ªû
().
LSt
(
·thÇme
, 
¡©_bufãr
);

32 
mode_t
 
umask
(mode_ˆ
mask
è{  
IOMªag”
::
G‘In¡ªû
().
Umask
(mask); }

34 
chmod
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

35  
IOMªag”
::
G‘In¡ªû
().
ChMod
(
·thÇme
, 
mode
);

38 
fchmod
(
fd
, 
mode_t
 
mode
) {

39  
IOMªag”
::
G‘In¡ªû
().
FChMod
(
fd
, 
mode
);

42 
mkdœ
(cÚ¡ *
·thÇme
, 
mode_t
 
mode
) {

43  
IOMªag”
::
G‘In¡ªû
().
Mkdœ
(
·thÇme
, 
mode
);

	@platform/posix/stdlib.cc

19 
	~<¡dlib.h
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

25 *
»®·th
(cÚ¡ *
·th
, *
»sŞved_·th
) {

26  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
R—lP©h
(
·th
, 
»sŞved_·th
);

	@platform/posix/stdlib.cc

19 
	~<¡dlib.h
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

25 *
»®·th
(cÚ¡ *
·th
, *
»sŞved_·th
) {

26  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
R—lP©h
(
·th
, 
»sŞved_·th
);

	@platform/posix/syscalls_test_driver.cc

19 
	~<dœ’t.h
>

20 
	~<”ºo.h
>

21 
	~<fú.h
>

22 
	~<içddrs.h
>

23 
	~<Ãt/if.h
>

24 
	~<Ãtš‘/š.h
>

25 
	~<pwd.h
>

26 
	~<sched.h
>

27 
	~<sys/¡©.h
>

28 
	~<sys/ty³s.h
>

29 
	~<sys/ut¢ame.h
>

30 
	~<uni¡d.h
>

32 
	~<c¡ršg
>

33 
	~<io¡»am
>

35 
	~<gmock/gmock.h
>

36 
	~<g‹¡/g‹¡.h
>

37 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

38 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

39 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

40 
	~"asylo/¶©fÜm/posix/sysÿÎs_‹¡.pb.h
"

41 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

42 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

43 
	~"asylo/ut/¡©us.h
"

48 
	$PrštTo
(cÚ¡ 
¡©
 &
¡©_bufãr
, 
¡d
::
o¡»am
 *
ouut_¡»am
) {

49 *
ouut_¡»am
 << 
ab¦
::
	`SŒC©
(

50 "¡ruù sˆ{ st_dev = ", 
¡©_bufãr
.
¡_dev
,

51 " , st_šØğ", 
¡©_bufãr
.
¡_šo
, " , st_modğ", st_bufãr.
¡_mode
,

52 " , st_Æšk = ", 
¡©_bufãr
.
¡_Æšk
,

53 " , st_uid = ", 
¡©_bufãr
.
¡_uid
, " , st_gid = ", st_bufãr.
¡_gid
,

54 " , st_rdev = ", 
¡©_bufãr
.
¡_rdev
,

55 " , st_sizğ", 
¡©_bufãr
.
¡_size
,

56 " , st_©imğ", 
¡©_bufãr
.
¡_©ime
,

57 " , st_mtimğ", 
¡©_bufãr
.
¡_mtime
,

58 " , st_ùimğ", 
¡©_bufãr
.
¡_ùime
,

59 " , st_blksizğ", 
¡©_bufãr
.
¡_blksize
,

60 " , st_block ğ", 
¡©_bufãr
.
¡_blocks
, " }");

61 
	}
}

63 
Çme¥aû
 
	gasylo
 {

64 
	gÇme¥aû
 {

66 
	gusšg
 ::
‹¡šg
::
Eq
;

67 
	gusšg
 ::
‹¡šg
::
NÙ
;

68 
	gusšg
 ::
‹¡šg
::
UnÜd”edEËm’tsA»A¼ay
;

70 cÚ¡ *
	gkCu¡omHo¡Name
 = "CustomHostName";

71 cÚ¡ *
	gkCu¡omWÜkšgDœeùÜy
 = "/tmp/testworkingdir";

72 cÚ¡ 
	gkSšZ”oPadSize
 = 8;

76 
Stus
 
RunEnşaveSysÿÎ
(
EnşaveCl›Á
 *
ş›Á
,

77 cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

78 cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
, 
boŞ
 
´ovide_bufãr
,

79 
št32_t
 
bufãr_size
, 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

80 
EnşaveIÅut
 
	g’şave_šput
;

81 
SysÿÎsTe¡IÅut
 *
	g‹¡_šput
 =

82 
’şave_šput
.
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_šput
);

83 
	g‹¡_šput
->
£t_‹¡_rg‘
(
‹¡ed_sysÿÎ
);

84 ià(!
	gfe_·th
.
em±y
()) {

85 
	g‹¡_šput
->
£t_·th_Çme
(
fe_·th
);

87 
	g‹¡_šput
->
£t_´ovide_bufãr
(
´ovide_bufãr
);

88 
	g‹¡_šput
->
£t_bufãr_size
(
bufãr_size
);

90 
EnşaveOuut
 
	g’şave_ouut
;

91 
Stus
 
	g‹¡_¡©us
 = 
ş›Á
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
);

92 ià(!
	g‹¡_¡©us
.
ok
()) {

93  
	g‹¡_¡©us
;

95 ià(
	g‹¡_ouut
) {

96 ià(!
	g’şave_ouut
.
HasEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)) {

97  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Noƒxpectedƒnclave output");

99 *
	g‹¡_ouut
 = 
’şave_ouut
.
G‘Ex‹nsiÚ
(
sysÿÎs_‹¡_ouut
);

101  
	gStus
::
OkStus
();

106 
ExŒaùCpuS‘FromTe¡Ouut
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

107 
ıu_£t_t
 *
mask
) {

108 
CPU_ZERO
(
mask
);

109 
	gıu
 = 0;

110 cÚ¡ 
	gušt64_t
 &
	gwÜd
 : 
‹¡_ouut
.
b™_mask_sysÿÎ_ouŒ
()) {

111 
ušt64_t
 
b™_f›ld
 = 1; 
	gb™_f›ld
 != 0; bit_field <<= 1) {

112 ià(
wÜd
 & 
b™_f›ld
) {

113 
CPU_SET
(
ıu
, 
mask
);

115 ++
	gıu
;

122 
ExŒaùStBufãrFromTe¡Ouut
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

123 
¡©
 *
¡©_bufãr
) {

124 cÚ¡ 
	gSysÿÎsTe¡Ouut
::
StV®ue
 &
´Ùo_¡©_bufãr
 =

125 
‹¡_ouut
.
¡©_bufãr_sysÿÎ_»tuº
();

127 
	g¡©_bufãr
->
	g¡_dev
 = 
¡©ic_ÿ¡
<
dev_t
>(
´Ùo_¡©_bufãr
.
¡_dev
());

128 
	g¡©_bufãr
->
	g¡_šo
 = 
¡©ic_ÿ¡
<
šo_t
>(
´Ùo_¡©_bufãr
.
¡_šo
());

129 
	g¡©_bufãr
->
	g¡_mode
 = 
¡©ic_ÿ¡
<
mode_t
>(
´Ùo_¡©_bufãr
.
¡_mode
());

130 
	g¡©_bufãr
->
	g¡_Æšk
 = 
¡©ic_ÿ¡
<
Æšk_t
>(
´Ùo_¡©_bufãr
.
¡_Æšk
());

131 
	g¡©_bufãr
->
	g¡_uid
 = 
¡©ic_ÿ¡
<
uid_t
>(
´Ùo_¡©_bufãr
.
¡_uid
());

132 
	g¡©_bufãr
->
	g¡_gid
 = 
¡©ic_ÿ¡
<
gid_t
>(
´Ùo_¡©_bufãr
.
¡_gid
());

133 
	g¡©_bufãr
->
	g¡_rdev
 = 
¡©ic_ÿ¡
<
dev_t
>(
´Ùo_¡©_bufãr
.
¡_rdev
());

134 
	g¡©_bufãr
->
	g¡_size
 = 
¡©ic_ÿ¡
<
off_t
>(
´Ùo_¡©_bufãr
.
¡_size
());

135 
	g¡©_bufãr
->
	g¡_©ime
 = 
¡©ic_ÿ¡
<
time_t
>(
´Ùo_¡©_bufãr
.
¡_©ime_v®
());

136 
	g¡©_bufãr
->
	g¡_mtime
 = 
¡©ic_ÿ¡
<
time_t
>(
´Ùo_¡©_bufãr
.
¡_mtime_v®
());

137 
	g¡©_bufãr
->
	g¡_ùime
 = 
¡©ic_ÿ¡
<
time_t
>(
´Ùo_¡©_bufãr
.
¡_ùime_v®
());

138 
	g¡©_bufãr
->
	g¡_blksize
 =

139 
¡©ic_ÿ¡
<
blksize_t
>(
´Ùo_¡©_bufãr
.
¡_blksize
());

140 
	g¡©_bufãr
->
	g¡_blocks
 = 
¡©ic_ÿ¡
<
blkút_t
>(
´Ùo_¡©_bufãr
.
¡_blocks
());

145 
boŞ
 
ExŒaùUtsNameFromTe¡Ouut
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

146 
ut¢ame
 *
ut¢ame_buf
) {

147 ià(!
	g‹¡_ouut
.
has_ut¢ame_sysÿÎ_»tuº
()) {

148  
	gçl£
;

151 cÚ¡ 
	gSysÿÎsTe¡Ouut
::
UtsName
 &
´Ùo_ut¢ame
 =

152 
‹¡_ouut
.
ut¢ame_sysÿÎ_»tuº
();

154 ià(
	g´Ùo_ut¢ame
.
has_sy¢ame
()) {

155 
	g´Ùo_ut¢ame
.
sy¢ame
().
cİy
(
ut¢ame_buf
->sysname,

156 (
ut¢ame_buf
->
sy¢ame
));

158  
	gçl£
;

161 ià(
	g´Ùo_ut¢ame
.
has_nod’ame
()) {

162 
	g´Ùo_ut¢ame
.
nod’ame
().
cİy
(
ut¢ame_buf
->nodename,

163 (
ut¢ame_buf
->
nod’ame
));

165  
	gçl£
;

168 ià(
	g´Ùo_ut¢ame
.
has_»Ëa£
()) {

169 
	g´Ùo_ut¢ame
.
»Ëa£
().
cİy
(
ut¢ame_buf
->release,

170 (
ut¢ame_buf
->
»Ëa£
));

172  
	gçl£
;

175 ià(
	g´Ùo_ut¢ame
.
has_v”siÚ
()) {

176 
	g´Ùo_ut¢ame
.
v”siÚ
().
cİy
(
ut¢ame_buf
->version,

177 (
ut¢ame_buf
->
v”siÚ
));

179  
	gçl£
;

182 ià(
	g´Ùo_ut¢ame
.
has_machše
()) {

183 
	g´Ùo_ut¢ame
.
machše
().
cİy
(
ut¢ame_buf
->machine,

184 (
ut¢ame_buf
->
machše
));

186  
	gçl£
;

189 ià(
	g´Ùo_ut¢ame
.
has_domašÇme
()) {

190 
	g´Ùo_ut¢ame
.
domašÇme
().
cİy
(
ut¢ame_buf
->domainname,

191 (
ut¢ame_buf
->
domašÇme
));

194  
	gŒue
;

199 
MATCHER_P
(
Equ®sUtsName
, 
rhs_ut¢ame_buf
, "") {

200  (
¡ºcmp
(
¬g
.
sy¢ame
, 
rhs_ut¢ame_buf
.sysname, (arg.sysname)) ==

202 (
¡ºcmp
(
¬g
.
nod’ame
, 
rhs_ut¢ame_buf
.nodename,

203 (
¬g
.
nod’ame
)) == 0) &&

204 (
¡ºcmp
(
¬g
.
»Ëa£
, 
rhs_ut¢ame_buf
.release, (arg.release)) ==

206 (
¡ºcmp
(
¬g
.
v”siÚ
, 
rhs_ut¢ame_buf
.version, (arg.version)) ==

208 (
¡ºcmp
(
¬g
.
machše
, 
rhs_ut¢ame_buf
.machine, (arg.machine)) ==

210 (
¡ºcmp
(
¬g
.
domašÇme
, 
rhs_ut¢ame_buf
.domainname,

211 (
¬g
.
domašÇme
)) == 0);

216 
boŞ
 
SockaddrsEqu®
(cÚ¡ 
sockaddr
 *
§1
, cÚ¡ sockadd¸*
§2
) {

217 ià(!
	g§1
 || !
	g§2
è sa1 =ğ
§2
;

218 ià(
	g§1
->
	g§_çmy
 !ğ
§2
->
§_çmy
è 
çl£
;

219 ià(
	g§1
->
	g§_çmy
 =ğ
AF_INET
) {

220 cÚ¡ 
sockaddr_š
 *
addr1
 =

221 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
§1
);

222 cÚ¡ 
sockaddr_š
 *
	gaddr2
 =

223 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
§2
);

224  (
	gaddr1
->
	gsš_çmy
 =ğ
addr2
->
sš_çmy
) &&

225 (
addr1
->
sš_pÜt
 =ğ
addr2
->sin_port) &&

226 (
addr1
->
sš_addr
.
s_addr
 =ğ
addr2
->sin_addr.s_addr) &&

227 (
memcmp
(&(
addr1
->
sš_z”o
), &(
addr2
->sš_z”o), 
kSšZ”oPadSize
) ==

229 } ià(
	g§1
->
	g§_çmy
 =ğ
AF_INET6
) {

230 cÚ¡ 
sockaddr_š6
 *
addr1
 =

231 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
§1
);

232 cÚ¡ 
sockaddr_š6
 *
	gaddr2
 =

233 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
§2
);

234  (
	gaddr1
->
	gsš6_çmy
 =ğ
addr2
->
sš6_çmy
) &&

235 (
addr1
->
sš6_pÜt
 =ğ
addr2
->sin6_port) &&

236 (
addr1
->
sš6_æowšfo
 =ğ
addr2
->sin6_flowinfo) &&

237 (
memcmp
(&(
addr1
->
sš6_addr
.
s6_addr
), &(
addr2
->sin6_addr.s6_addr),

238 
asylo
::
kIn6AddrNumBy‹s
) == 0) &&

239 (
addr1
->
sš6_scİe_id
 =ğ
addr2
->sin6_scope_id);

241  
	gçl£
;

245 
boŞ
 
IfAddrsFÏgsEqu®
(
æags1
, 
æags2
) {

246 
	gsuµÜ‹d_æags
 = 
IFF_UP
 | 
IFF_BROADCAST
 | 
IFF_DEBUG
 | 
IFF_LOOPBACK
 |

247 
IFF_POINTOPOINT
 | 
IFF_NOTRAILERS
 | 
IFF_RUNNING
 |

248 
IFF_NOARP
 | 
IFF_PROMISC
 | 
IFF_ALLMULTI
;

249  (
	gæags1
 & 
	gsuµÜ‹d_æags
è=ğ(
æags2
 & 
suµÜ‹d_æags
);

254 
MATCHER_P
(
Equ®sSt
, 
rhs_¡©_bufãr
, "") {

255  (
	g¬g
.
	g¡_dev
 =ğ
rhs_¡©_bufãr
.
¡_dev
) &&

256 (
¬g
.
¡_šo
 =ğ
rhs_¡©_bufãr
.st_ino) &&

257 (
¬g
.
¡_mode
 =ğ
rhs_¡©_bufãr
.st_mode) &&

258 (
¬g
.
¡_Æšk
 =ğ
rhs_¡©_bufãr
.st_nlink) &&

259 (
¬g
.
¡_uid
 =ğ
rhs_¡©_bufãr
.st_uid) &&

260 (
¬g
.
¡_gid
 =ğ
rhs_¡©_bufãr
.st_gid) &&

261 (
¬g
.
¡_rdev
 =ğ
rhs_¡©_bufãr
.st_rdev) &&

262 (
¬g
.
¡_size
 =ğ
rhs_¡©_bufãr
.st_size) &&

263 (
¬g
.
¡_©ime
 =ğ
rhs_¡©_bufãr
.st_atime) &&

264 (
¬g
.
¡_mtime
 =ğ
rhs_¡©_bufãr
.st_mtime) &&

265 (
¬g
.
¡_ùime
 =ğ
rhs_¡©_bufãr
.st_ctime) &&

266 (
¬g
.
¡_blksize
 =ğ
rhs_¡©_bufãr
.st_blksize) &&

267 (
¬g
.
¡_blocks
 =ğ
rhs_¡©_bufãr
.st_blocks);

272 
boŞ
 
Com·»PassWd
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

273 
·sswd
 *
·sswÜd
) {

274 ià(!
	g‹¡_ouut
.
has_·sswd_sysÿÎ_»tuº
(è|| !
	g·sswÜd
) {

275  
	gçl£
;

278 cÚ¡ 
	gSysÿÎsTe¡Ouut
::
PassWd
 &
´Ùo_·sswd
 =

279 
‹¡_ouut
.
·sswd_sysÿÎ_»tuº
();

281 ià(!
	g´Ùo_·sswd
.
has_pw_Çme
() ||

282 
	g´Ùo_·sswd
.
pw_Çme
(è!ğ
·sswÜd
->pw_name ||

283 !
´Ùo_·sswd
.
has_pw_·sswd
() ||

284 
´Ùo_·sswd
.
pw_·sswd
(è!ğ
·sswÜd
->pw_passwd ||

285 !
´Ùo_·sswd
.
has_pw_uid
(è||…rÙo_·sswd.
pw_uid
(è!ğ
·sswÜd
->pw_uid ||

286 !
´Ùo_·sswd
.
has_pw_gid
(è||…rÙo_·sswd.
pw_gid
(è!ğ
·sswÜd
->pw_gid ||

287 !
´Ùo_·sswd
.
has_pw_gecos
() ||

288 
´Ùo_·sswd
.
pw_gecos
(è!ğ
·sswÜd
->pw_gecos ||

289 !
´Ùo_·sswd
.
has_pw_dœ
(è||…rÙo_·sswd.
pw_dœ
(è!ğ
·sswÜd
->pw_dir ||

290 !
´Ùo_·sswd
.
has_pw_sh–l
() ||

291 
´Ùo_·sswd
.
pw_sh–l
(è!ğ
·sswÜd
->pw_shell) {

292  
çl£
;

295  
	gŒue
;

299 şas 
	cSysÿÎsTe¡
 : 
public
 
EnşaveTe¡
 {

300 
´Ùeùed
:

301 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

302 cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
,

303 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

304  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, 
fe_·th
, 
çl£
, 0,

305 
‹¡_ouut
);

308 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

309 
boŞ
 
´ovide_bufãr
, 
št32_t
 
bufãr_size
,

310 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

311  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, "", 
´ovide_bufãr
,

312 
bufãr_size
, 
‹¡_ouut
);

317 şas 
	cCu¡omCÚfigSysÿÎsTe¡
 : 
public
 
EnşaveTe¡
 {

318 
´Ùeùed
:

319 
S‘Up
(è
ov”ride
 {

320 
cÚfig_
.
£t_ho¡_Çme
(
kCu¡omHo¡Name
);

321 
	gcÚfig_
.
£t_cu¼’t_wÜkšg_dœeùÜy
(
kCu¡omWÜkšgDœeùÜy
);

322 
	gEnşaveTe¡
::
S‘Up
();

325 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

326 cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
,

327 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

328  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, 
fe_·th
, 
çl£
, 0,

329 
‹¡_ouut
);

332 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

333 
boŞ
 
´ovide_bufãr
, 
št32_t
 
bufãr_size
,

334 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

335  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, "", 
´ovide_bufãr
,

336 
bufãr_size
, 
‹¡_ouut
);

342 
TEST_F
(
SysÿÎsTe¡
, 
SyscÚfScN´oûssÜsCÚf
) {

343 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

344 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sysconf(_SC_NPROCESSORS_CONF)", "",

345 &
‹¡_ouut
),

346 
IsOk
());

347 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

348 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
syscÚf
(
_SC_NPROCESSORS_CONF
));

353 
TEST_F
(
SysÿÎsTe¡
, 
SyscÚfScN´oûssÜsOÆn
) {

354 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

355 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sysconf(_SC_NPROCESSORS_ONLN)", "",

356 &
‹¡_ouut
),

357 
IsOk
());

358 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

359 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
syscÚf
(
_SC_NPROCESSORS_ONLN
));

364 
TEST_F
(
SysÿÎsTe¡
, 
SyscÚfScPagesize
) {

365 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

366 
ASSERT_THAT
(

367 
RunSysÿÎInsideEnşave
("syscÚf(_SC_PAGESIZE)", "", &
‹¡_ouut
),

368 
IsOk
());

369 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

370 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 4096);

375 
TEST_F
(
SysÿÎsTe¡
, 
G‘Pid
) {

376 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

377 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘pid", "", &
‹¡_ouut
), 
IsOk
());

378 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

379 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘pid
());

384 
TEST_F
(
SysÿÎsTe¡
, 
UÆšk
) {

385 
EXPECT_THAT
(

386 
RunSysÿÎInsideEnşave
("uÆšk", 
FLAGS_‹¡_tmpdœ
 + "/uÆšk", 
nuÎ±r
),

387 
IsOk
());

392 
TEST_F
(
SysÿÎsTe¡
, 
Fú
) {

393 
EXPECT_THAT
(

394 
RunSysÿÎInsideEnşave
("fú", 
FLAGS_‹¡_tmpdœ
 + "/fú", 
nuÎ±r
),

395 
IsOk
());

400 
TEST_F
(
SysÿÎsTe¡
, 
Mkdœ
) {

401 
EXPECT_THAT
(

402 
RunSysÿÎInsideEnşave
("mkdœ", 
FLAGS_‹¡_tmpdœ
 + "/mkdœ", 
nuÎ±r
),

403 
IsOk
());

404 
DIR
 *
	gdœeùÜy
 = 
İ’dœ
((
FLAGS_‹¡_tmpdœ
 + "/mkdœ").
c_¡r
());

405 
EXPECT_TRUE
(
dœeùÜy
);

406 
şo£dœ
(
dœeùÜy
);

412 
TEST_F
(
SysÿÎsTe¡
, 
Rmdœ
) {

413 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœeùÜy
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/rmdir");

414 
EXPECT_EQ
(
mkdœ
(
‹¡_dœeùÜy
.
c_¡r
(), 0644), 0);

415 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rmdœ", 
‹¡_dœeùÜy
, 
nuÎ±r
),

416 
IsOk
());

417 
DIR
 *
	gdœeùÜy
 = 
İ’dœ
(
‹¡_dœeùÜy
.
c_¡r
());

418 
EXPECT_EQ
(
dœeùÜy
, 
nuÎ±r
);

423 
TEST_F
(
SysÿÎsTe¡
, 
Dup
) {

424 
EXPECT_THAT
(

425 
RunSysÿÎInsideEnşave
("dup", 
FLAGS_‹¡_tmpdœ
 + "/dup", 
nuÎ±r
),

426 
IsOk
());

431 
TEST_F
(
SysÿÎsTe¡
, 
G‘Ho¡Name
) {

432 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

433 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘ho¡Çme", "", &
‹¡_ouut
), 
IsOk
());

434 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

435 
	gbuf
[1024];

436 
ASSERT_EQ
(
g‘ho¡Çme
(
buf
, (buf)), 0);

437 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

443 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘Ho¡Name
) {

444 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

445 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘ho¡Çme", "", &
‹¡_ouut
), 
IsOk
());

446 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

447 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
kCu¡omHo¡Name
);

452 
TEST_F
(
SysÿÎsTe¡
, 
Lšk
) {

453 
EXPECT_THAT
(

454 
RunSysÿÎInsideEnşave
("lšk", 
FLAGS_‹¡_tmpdœ
 + "/lšk", 
nuÎ±r
),

455 
IsOk
());

460 
TEST_F
(
SysÿÎsTe¡
, 
G‘Cwd
) {

461 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

462 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
Œue
, 
PATH_MAX
, &
‹¡_ouut
),

463 
IsOk
());

464 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

465 
	gbuf
[
PATH_MAX
];

466 
ASSERT_NE
(
g‘cwd
(
buf
, (buf)), 
nuÎ±r
);

467 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

472 
TEST_F
(
SysÿÎsTe¡
, 
G‘CwdNoSize
) {

473 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
Œue
, 0, 
nuÎ±r
), 
NÙ
(
IsOk
()));

478 
TEST_F
(
SysÿÎsTe¡
, 
G‘CwdNoBufãr
) {

479 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

480 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
çl£
, 
PATH_MAX
, &
‹¡_ouut
),

481 
IsOk
());

482 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

483 
	gbuf
[
PATH_MAX
];

484 
ASSERT_NE
(
g‘cwd
(
buf
, (buf)), 
nuÎ±r
);

485 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

490 
TEST_F
(
SysÿÎsTe¡
, 
G‘CwdNoBufãrNoSize
) {

491 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

492 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
çl£
, 0, &
‹¡_ouut
),

493 
IsOk
());

494 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

495 
	gbuf
[
PATH_MAX
];

496 
ASSERT_NE
(
g‘cwd
(
buf
, (buf)), 
nuÎ±r
);

497 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

503 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘Cwd
) {

504 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

505 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", "", &
‹¡_ouut
), 
IsOk
());

506 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

507 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
kCu¡omWÜkšgDœeùÜy
);

513 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘CwdInsuffic›ÁSize
) {

514 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
Œue
,

515 
¡¾’
(
kCu¡omWÜkšgDœeùÜy
), 
nuÎ±r
),

516 
NÙ
(
IsOk
()));

522 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘CwdNoBufãrInsuffic›ÁSize
) {

523 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
çl£
,

524 
¡¾’
(
kCu¡omWÜkšgDœeùÜy
), 
nuÎ±r
),

525 
NÙ
(
IsOk
()));

530 
TEST_F
(
SysÿÎsTe¡
, 
Umask
) {

531 
ASSERT_THAT
(

532 
RunSysÿÎInsideEnşave
("umask", 
FLAGS_‹¡_tmpdœ
 + "/umask", 
nuÎ±r
),

533 
IsOk
());

538 
TEST_F
(
SysÿÎsTe¡
, 
G‘Uid
) {

539 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

540 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘uid", "", &
‹¡_ouut
), 
IsOk
());

541 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

542 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘uid
());

547 
TEST_F
(
SysÿÎsTe¡
, 
G‘Euid
) {

548 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

549 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘euid", "", &
‹¡_ouut
), 
IsOk
());

550 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

551 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘euid
());

556 
TEST_F
(
SysÿÎsTe¡
, 
G‘Gid
) {

557 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

558 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘gid", "", &
‹¡_ouut
), 
IsOk
());

559 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

560 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘gid
());

565 
TEST_F
(
SysÿÎsTe¡
, 
G‘Egid
) {

566 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

567 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘egid", "", &
‹¡_ouut
), 
IsOk
());

568 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

569 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘egid
());

574 
TEST_F
(
SysÿÎsTe¡
, 
G‘Ppid
) {

575 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

576 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘µid", "", &
‹¡_ouut
), 
IsOk
());

577 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

578 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘µid
());

585 
TEST_F
(
SysÿÎsTe¡
, 
SchedG‘Affš™y
) {

586 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

588 
ıu_£t_t
 
	gho¡_mask
;

589 
ASSERT_EQ
(
sched_g‘affš™y
(
g‘pid
(), (
ıu_£t_t
), &
ho¡_mask
), 0);

591 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sched_getaffinity", "",

592 &
‹¡_ouut
),

593 
IsOk
());

595 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

596 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0);

598 
ıu_£t_t
 
	g’şave_mask
;

601 
ExŒaùCpuS‘FromTe¡Ouut
(
‹¡_ouut
, &
’şave_mask
);

603 
EXPECT_TRUE
(
CPU_EQUAL
(&
ho¡_mask
, &
’şave_mask
));

608 
TEST_F
(
SysÿÎsTe¡
, 
SchedG‘Affš™yFau»
) {

609 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

611 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sched_getaffinity failure",

612  "", &
‹¡_ouut
),

613 
IsOk
());

615 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

616 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), -1);

618 
ASSERT_TRUE
(
‹¡_ouut
.
has_”ºo_sysÿÎ_v®ue
());

619 
EXPECT_EQ
(
‹¡_ouut
.
”ºo_sysÿÎ_v®ue
(),

620 
SysÿÎsTe¡Ouut
::
ERRNO_EINVAL
);

626 
TEST_F
(
SysÿÎsTe¡
, 
SchedG‘Affš™yAá”S‘
) {

627 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

629 
ıu_£t_t
 
	gš™Ÿl_mask
;

630 
ASSERT_EQ
(
sched_g‘affš™y
(
g‘pid
(), (
ıu_£t_t
), &
š™Ÿl_mask
), 0);

632 
	gtÙ®_ıus
 = 
CPU_COUNT
(&
š™Ÿl_mask
);

633 ià(
	gtÙ®_ıus
 < 2) {

635 
SUCCEED
() << "Only one CPU in‡ffinity mask. Not continuing withest.";

638 
boŞ
 
	gun£t_ıu
 = 
çl£
;

639 
	gıu
 = 0, 
	gıus_so_çr
 = 0; cpus_so_ç¸< 
	gtÙ®_ıus
; ++cpu) {

640 ià(
CPU_ISSET
(
ıu
, &
š™Ÿl_mask
)) {

641 ià(
	gun£t_ıu
) {

642 
CPU_CLR
(
ıu
, &
š™Ÿl_mask
);

644 
	gun£t_ıu
 = !
un£t_ıu
;

645 ++
	gıus_so_çr
;

648 
ASSERT_EQ
(
sched_£ffš™y
(
g‘pid
(), (
ıu_£t_t
), &
š™Ÿl_mask
), 0);

650 
ıu_£t_t
 
	gho¡_mask
;

651 
ASSERT_EQ
(
sched_g‘affš™y
(
g‘pid
(), (
ıu_£t_t
), &
ho¡_mask
), 0);

652 
ASSERT_TRUE
(
CPU_EQUAL
(&
š™Ÿl_mask
, &
ho¡_mask
));

654 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sched_getaffinity", "",

655 &
‹¡_ouut
),

656 
IsOk
());

658 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

659 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0);

661 
ıu_£t_t
 
	g’şave_mask
;

664 
ExŒaùCpuS‘FromTe¡Ouut
(
‹¡_ouut
, &
’şave_mask
);

666 
EXPECT_TRUE
(
CPU_EQUAL
(&
ho¡_mask
, &
’şave_mask
));

672 
TEST_F
(
SysÿÎsTe¡
, 
CpuS‘Maüos
) {

673 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("CPU_SET macros", "",

674  
nuÎ±r
),

675 
IsOk
());

680 
TEST_F
(
SysÿÎsTe¡
, 
St
) {

681 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

682 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/stat");

684 
umask
(
S_IWGRP
 | 
S_IWOTH
);

685 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

686 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

688 
¡©
 
	gho¡_¡©_bufãr
;

689 
ASSERT_EQ
(
¡©
(
‹¡_dœ
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

690 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_dœ
, ", ...) failed on host");

692 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("¡©", 
‹¡_dœ
, &
‹¡_ouut
), 
IsOk
())

695 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

697 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

698 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_dœ
, ", ...) failed inƒnclave");

700 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

703 
¡©
 
	g’şave_¡©_bufãr
;

704 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

706 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

713 
TEST_F
(
SysÿÎsTe¡
, 
StOnSymlšk
) {

714 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

715 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 =

716 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/stat_on_symlink");

717 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_lšk
 =

718 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/stat_on_symlink_link");

720 
umask
(
S_IWGRP
 | 
S_IWOTH
);

721 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

722 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

724 
ASSERT_EQ
(
symlšk
(
‹¡_dœ
.
c_¡r
(), 
‹¡_lšk
.c_str()), 0)

725 << 
	gab¦
::
SŒC©
("FaedØü—‹†šk ", 
‹¡_lšk
, "Ø", 
‹¡_dœ
);

727 
¡©
 
	gho¡_¡©_bufãr
;

728 
ASSERT_EQ
(
¡©
(
‹¡_lšk
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

729 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_lšk
, ", ...) failed on host");

731 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("¡©", 
‹¡_lšk
, &
‹¡_ouut
), 
IsOk
())

734 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

736 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

737 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_lšk
, ", ...) failed inƒnclave");

739 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

742 
¡©
 
	g’şave_¡©_bufãr
;

743 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

745 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

751 
TEST_F
(
SysÿÎsTe¡
, 
FSt
) {

752 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

753 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/fstat");

755 
umask
(
S_IWGRP
 | 
S_IWOTH
);

756 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

757 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

759 
	gfd
 = 
İ’
(
‹¡_dœ
.
c_¡r
(), 
O_RDONLY
);

760 
ASSERT_NE
(
fd
, -1è<< 
	gab¦
::
SŒC©
("FaedØİ’ ", 
‹¡_dœ
);

762 
¡©
 
	gho¡_¡©_bufãr
;

763 
ASSERT_EQ
(
f¡©
(
fd
, &
ho¡_¡©_bufãr
), 0)

764 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_dœ
, "], ...) failed on host");

766 
ASSERT_EQ
(
şo£
(
fd
), 0è<< 
	gab¦
::
SŒC©
("FaedØşo£ ", 
‹¡_dœ
);

768 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("f¡©", 
‹¡_dœ
, &
‹¡_ouut
), 
IsOk
())

771 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

773 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

774 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_dœ
, "], ...) failed inƒnclave");

776 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

779 
¡©
 
	g’şave_¡©_bufãr
;

780 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

782 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

789 
TEST_F
(
SysÿÎsTe¡
, 
FStOnSymlšk
) {

790 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

791 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 =

792 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
 + "/fstat_on_symlink");

793 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_lšk
 =

794 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
 + "/fstat_on_symlink_link");

796 
umask
(
S_IWGRP
 | 
S_IWOTH
);

797 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

798 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

800 
ASSERT_EQ
(
symlšk
(
‹¡_dœ
.
c_¡r
(), 
‹¡_lšk
.c_str()), 0)

801 << 
	gab¦
::
SŒC©
("FaedØü—‹†šk ", 
‹¡_lšk
, "Ø", 
‹¡_dœ
);

803 
	gfd
 = 
İ’
(
‹¡_lšk
.
c_¡r
(), 
O_RDONLY
);

804 
ASSERT_NE
(
fd
, -1è<< 
	gab¦
::
SŒC©
("FaedØİ’ ", 
‹¡_lšk
);

806 
¡©
 
	gho¡_¡©_bufãr
;

807 
ASSERT_EQ
(
f¡©
(
fd
, &
ho¡_¡©_bufãr
), 0)

808 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_lšk
, "], ...) failed on host");

810 
ASSERT_EQ
(
şo£
(
fd
), 0è<< 
	gab¦
::
SŒC©
("FaedØşo£ ", 
‹¡_dœ
);

812 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("f¡©", 
‹¡_lšk
, &
‹¡_ouut
), 
IsOk
())

815 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

817 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

818 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_lšk
, "], ...) failed inƒnclave");

820 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

823 
¡©
 
	g’şave_¡©_bufãr
;

824 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

826 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

832 
TEST_F
(
SysÿÎsTe¡
, 
LSt
) {

833 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

834 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/lstat");

836 
umask
(
S_IWGRP
 | 
S_IWOTH
);

837 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

838 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

840 
¡©
 
	gho¡_¡©_bufãr
;

841 
ASSERT_EQ
(
l¡©
(
‹¡_dœ
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

842 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_dœ
, ", ...) failed on host");

844 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("l¡©", 
‹¡_dœ
, &
‹¡_ouut
), 
IsOk
())

847 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

849 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

850 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_dœ
, ", ...) failed inƒnclave");

852 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

855 
¡©
 
	g’şave_¡©_bufãr
;

856 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

858 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

865 
TEST_F
(
SysÿÎsTe¡
, 
LStOnSymlšk
) {

866 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

867 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 =

868 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/lstat_on_symlink");

869 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_lšk
 =

870 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/lstat_on_symlink_link");

872 
umask
(
S_IWGRP
 | 
S_IWOTH
);

873 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

874 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

876 
ASSERT_EQ
(
symlšk
(
‹¡_dœ
.
c_¡r
(), 
‹¡_lšk
.c_str()), 0)

877 << 
	gab¦
::
SŒC©
("FaedØü—‹†šk ", 
‹¡_lšk
, "Ø", 
‹¡_dœ
);

879 
¡©
 
	gho¡_¡©_bufãr
;

880 
ASSERT_EQ
(
l¡©
(
‹¡_lšk
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

881 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_lšk
, ", ...) failed on host");

883 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("l¡©", 
‹¡_lšk
, &
‹¡_ouut
), 
IsOk
())

886 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

888 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

889 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_lšk
, ", ...) failed inƒnclave");

891 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

894 
¡©
 
	g’şave_¡©_bufãr
;

895 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

897 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

904 
TEST_F
(
SysÿÎsTe¡
, 
UÇme
) {

905 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

907 
ut¢ame
 
	gho¡_ut¢ame_buf
;

908 
ASSERT_EQ
(
uÇme
(&
ho¡_ut¢ame_buf
), 0) << "Could‚ot fetch host utsname";

910 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("uÇme", "", &
‹¡_ouut
),

911 
IsOk
())

914 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

916 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

918 << (
	g‹¡_ouut
.
has_”ºo_sysÿÎ_v®ue
(è? 
¡»¼Ü
(
”ºo
)

922 
ut¢ame
 
	g’şave_ut¢ame_buf
;

923 
EXPECT_TRUE
(
ExŒaùUtsNameFromTe¡Ouut
(
‹¡_ouut
, &
’şave_ut¢ame_buf
))

926 
EXPECT_THAT
(
ho¡_ut¢ame_buf
, 
Equ®sUtsName
(
’şave_ut¢ame_buf
));

932 
TEST_F
(
SysÿÎsTe¡
, 
Wr™ev
) {

933 
EXPECT_THAT
(

934 
RunSysÿÎInsideEnşave
("wr™ev", 
FLAGS_‹¡_tmpdœ
 + "/wr™ev", 
nuÎ±r
),

935 
IsOk
());

940 
TEST_F
(
SysÿÎsTe¡
, 
R—dv
) {

941 
EXPECT_THAT
(

942 
RunSysÿÎInsideEnşave
("»adv", 
FLAGS_‹¡_tmpdœ
 + "/»adv", 
nuÎ±r
),

943 
IsOk
());

948 
TEST_F
(
SysÿÎsTe¡
, 
Rlim™NoFe
) {

949 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rlimit‚ofile",

950 
FLAGS_‹¡_tmpdœ
 + "/¾im™", 
nuÎ±r
),

951 
IsOk
());

957 
TEST_F
(
SysÿÎsTe¡
, 
Rlim™LowNoFe
) {

958 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rlimit†ow‚ofile",

959 
FLAGS_‹¡_tmpdœ
 + "/¾im™", 
nuÎ±r
),

960 
IsOk
());

965 
TEST_F
(
SysÿÎsTe¡
, 
Rlim™Inv®idNoFe
) {

966 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rlimit invalid‚ofile",

967 
FLAGS_‹¡_tmpdœ
 + "/¾im™", 
nuÎ±r
),

968 
IsOk
());

973 
TEST_F
(
SysÿÎsTe¡
, 
ChMod
) {

974 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/chmod");

975 
ASSERT_NE
(
İ’
(
‹¡_fe
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0777), -1);

976 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("chmod", 
‹¡_fe
, 
nuÎ±r
), 
IsOk
());

977 
¡©
 
	g¡©_bufãr
;

978 
ASSERT_EQ
(
¡©
(
‹¡_fe
.
c_¡r
(), &
¡©_bufãr
), 0);

979 
EXPECT_EQ
(
¡©_bufãr
.
¡_mode
 & 0777, 0644);

984 
TEST_F
(
SysÿÎsTe¡
, 
FChMod
) {

985 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/chmod");

986 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("fchmod", 
‹¡_fe
, 
nuÎ±r
), 
IsOk
());

987 
¡©
 
	g¡©_bufãr
;

988 
ASSERT_EQ
(
¡©
(
‹¡_fe
.
c_¡r
(), &
¡©_bufãr
), 0);

989 
EXPECT_EQ
(
¡©_bufãr
.
¡_mode
 & 0777, 0644);

992 
MATCHER_P
(
M©chIfAddrs
, 
th©
, "") {

993  
SockaddrsEqu®
(
¬g
->
iç_addr
, 
th©
->ifa_addr) &&

994 
SockaddrsEqu®
(
¬g
->
iç_Ãtmask
, 
th©
->ifa_netmask) &&

995 
SockaddrsEqu®
(
¬g
->
iç_ifu
.
ifu_d¡addr
, 
th©
->ifa_ifu.ifu_dstaddr) &&

996 (
¡rcmp
(
¬g
->
iç_Çme
, 
th©
->ifa_name) == 0) &&

997 
IfAddrsFÏgsEqu®
(
¬g
->
iç_æags
, 
th©
->iç_æagsè&& !
	g¬g
->
	giç_d©a
 &&

998 !
	gth©
->
	giç_d©a
;

1008 
TEST_F
(
SysÿÎsTe¡
, 
G‘IfAddrs
) {

1009 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

1010 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘içddrs", "", &
‹¡_ouut
), 
IsOk
());

1011 
ASSERT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0);

1012 
ASSERT_TRUE
(
‹¡_ouut
.
has_£rŸlized_´Ùo_»tuº
());

1013 
içddrs
 *
	gho¡_äÚt
 = 
nuÎ±r
;

1014 
	g»t
 = 
g‘içddrs
(&
ho¡_äÚt
);

1015 
ASSERT_EQ
(
»t
, 0);

1016 
içddrs
 *
	g’şave_äÚt
 = 
nuÎ±r
;

1017 
	g¡d
::
¡ršg
 
£rŸlized_içddrs
 = 
‹¡_ouut
.
£rŸlized_´Ùo_»tuº
();

1018 
ASSERT_TRUE
(
asylo
::
De£rŸlizeIfAddrs
(
£rŸlized_içddrs
, &
’şave_äÚt
));

1024 
	gab¦
::
æ©_hash_£t
<
içddrs
 *> 
found_š_’şave
;

1025 
	g¡d
::
veùÜ
<::
‹¡šg
::
M©ch”
<
içddrs
 *>> 
ex³ùed
;

1026 
içddrs
 *
	g’şave_li¡_cu¼
 = 
’şave_äÚt
;

1027 
	g’şave_li¡_cu¼
 !ğ
nuÎ±r
;

1028 
	g’şave_li¡_cu¼
 = 
’şave_li¡_cu¼
->
iç_Ãxt
) {

1029 
ex³ùed
.
push_back
(
M©chIfAddrs
(
’şave_li¡_cu¼
));

1031 
	g¡d
::
veùÜ
<
içddrs
 *> 
suµÜ‹d_ho¡
;

1034 
içddrs
 *
	gho¡_li¡_cu¼
 = 
ho¡_äÚt
; ho¡_li¡_cu¼ !ğ
nuÎ±r
;

1035 
	gho¡_li¡_cu¼
 = 
ho¡_li¡_cu¼
->
iç_Ãxt
) {

1036 ià(
IfAddrSuµÜ‹d
(
ho¡_li¡_cu¼
)) {

1037 
suµÜ‹d_ho¡
.
push_back
(
ho¡_li¡_cu¼
);

1040 
EXPECT_THAT
(
suµÜ‹d_ho¡
.
size
(), 
Eq
(
ex³ùed
.size())è<< 
	g£rŸlized_içddrs
;

1041 
EXPECT_THAT
(
suµÜ‹d_ho¡
, 
UnÜd”edEËm’tsA»A¼ay
(
ex³ùed
));

1042 
	gasylo
::
F»eDe£rŸlizedIfAddrs
(
’şave_äÚt
);

1043 
ä“içddrs
(
ho¡_äÚt
);

1047 
TEST_F
(
SysÿÎsTe¡
, 
SockÇme_SUCCESS
) {

1048 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_sucûss", "", 
nuÎ±r
),

1049 
IsOk
());

1054 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_EBADF
) {

1055 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_ebadf", "", 
nuÎ±r
),

1056 
IsOk
());

1059 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_EFAULT
) {

1060 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_eçuÉ", "", 
nuÎ±r
),

1061 
IsOk
());

1064 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_EINVAL
) {

1065 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_ešv®", "", 
nuÎ±r
),

1066 
IsOk
());

1069 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_ENOTSOCK
) {

1070 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_’Ùsock", "", 
nuÎ±r
),

1071 
IsOk
());

1076 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_EBADF
) {

1077 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_ebadf", "", 
nuÎ±r
),

1078 
IsOk
());

1081 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_EFAULT
) {

1082 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_eçuÉ", "", 
nuÎ±r
),

1083 
IsOk
());

1086 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_EINVAL
) {

1087 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_ešv®", "", 
nuÎ±r
),

1088 
IsOk
());

1091 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_ENOTCONN
) {

1092 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_’ÙcÚn", "", 
nuÎ±r
),

1093 
IsOk
());

1096 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_ENOTSOCK
) {

1097 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_’Ùsock", "", 
nuÎ±r
),

1098 
IsOk
());

1103 
TEST_F
(
SysÿÎsTe¡
, 
Trunÿ‹
) {

1104 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("truncate",

1105 
FLAGS_‹¡_tmpdœ
 + "/Œunÿ‹", 
nuÎ±r
),

1106 
IsOk
());

1111 
TEST_F
(
SysÿÎsTe¡
, 
Mm­
) {

1112 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("mm­", "", 
nuÎ±r
), 
IsOk
());

1115 
TEST_F
(
SysÿÎsTe¡
, 
Itim”
) {

1116 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("™im”", "", 
nuÎ±r
), 
IsOk
());

1121 
TEST_F
(
SysÿÎsTe¡
, 
R’ame
) {

1122 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("»Çme", 
FLAGS_‹¡_tmpdœ
, 
nuÎ±r
),

1123 
IsOk
());

1124 
	gfd
 = 
İ’
((
FLAGS_‹¡_tmpdœ
 + "/»Çme").
c_¡r
(), 
O_RDWR
);

1125 
EXPECT_GE
(
fd
, 0);

1126 
şo£
(
fd
);

1132 
TEST_F
(
SysÿÎsTe¡
, 
Utimes
) {

1133 
EXPECT_THAT
(

1134 
RunSysÿÎInsideEnşave
("utimes", 
FLAGS_‹¡_tmpdœ
 + "/utimes", 
nuÎ±r
),

1135 
IsOk
());

1141 
TEST_F
(
SysÿÎsTe¡
, 
G‘PWUid
) {

1142 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

1144 
ASSERT_THAT
(

1145 
RunSysÿÎInsideEnşave
("g‘pwuid", "", &
‹¡_ouut
),

1146 
IsOk
());

1149 
EXPECT_TRUE
(
Com·»PassWd
(
‹¡_ouut
, 
g‘pwuid
(
g‘uid
())));

	@platform/posix/syscalls_test_driver.cc

19 
	~<dœ’t.h
>

20 
	~<”ºo.h
>

21 
	~<fú.h
>

22 
	~<içddrs.h
>

23 
	~<Ãt/if.h
>

24 
	~<Ãtš‘/š.h
>

25 
	~<pwd.h
>

26 
	~<sched.h
>

27 
	~<sys/¡©.h
>

28 
	~<sys/ty³s.h
>

29 
	~<sys/ut¢ame.h
>

30 
	~<uni¡d.h
>

32 
	~<c¡ršg
>

33 
	~<io¡»am
>

35 
	~<gmock/gmock.h
>

36 
	~<g‹¡/g‹¡.h
>

37 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

38 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

39 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

40 
	~"asylo/¶©fÜm/posix/sysÿÎs_‹¡.pb.h
"

41 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

42 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

43 
	~"asylo/ut/¡©us.h
"

48 
	$PrštTo
(cÚ¡ 
¡©
 &
¡©_bufãr
, 
¡d
::
o¡»am
 *
ouut_¡»am
) {

49 *
ouut_¡»am
 << 
ab¦
::
	`SŒC©
(

50 "¡ruù sˆ{ st_dev = ", 
¡©_bufãr
.
¡_dev
,

51 " , st_šØğ", 
¡©_bufãr
.
¡_šo
, " , st_modğ", st_bufãr.
¡_mode
,

52 " , st_Æšk = ", 
¡©_bufãr
.
¡_Æšk
,

53 " , st_uid = ", 
¡©_bufãr
.
¡_uid
, " , st_gid = ", st_bufãr.
¡_gid
,

54 " , st_rdev = ", 
¡©_bufãr
.
¡_rdev
,

55 " , st_sizğ", 
¡©_bufãr
.
¡_size
,

56 " , st_©imğ", 
¡©_bufãr
.
¡_©ime
,

57 " , st_mtimğ", 
¡©_bufãr
.
¡_mtime
,

58 " , st_ùimğ", 
¡©_bufãr
.
¡_ùime
,

59 " , st_blksizğ", 
¡©_bufãr
.
¡_blksize
,

60 " , st_block ğ", 
¡©_bufãr
.
¡_blocks
, " }");

61 
	}
}

63 
Çme¥aû
 
	gasylo
 {

64 
	gÇme¥aû
 {

66 
	gusšg
 ::
‹¡šg
::
Eq
;

67 
	gusšg
 ::
‹¡šg
::
NÙ
;

68 
	gusšg
 ::
‹¡šg
::
UnÜd”edEËm’tsA»A¼ay
;

70 cÚ¡ *
	gkCu¡omHo¡Name
 = "CustomHostName";

71 cÚ¡ *
	gkCu¡omWÜkšgDœeùÜy
 = "/tmp/testworkingdir";

72 cÚ¡ 
	gkSšZ”oPadSize
 = 8;

76 
Stus
 
RunEnşaveSysÿÎ
(
EnşaveCl›Á
 *
ş›Á
,

77 cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

78 cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
, 
boŞ
 
´ovide_bufãr
,

79 
št32_t
 
bufãr_size
, 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

80 
EnşaveIÅut
 
	g’şave_šput
;

81 
SysÿÎsTe¡IÅut
 *
	g‹¡_šput
 =

82 
’şave_šput
.
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_šput
);

83 
	g‹¡_šput
->
£t_‹¡_rg‘
(
‹¡ed_sysÿÎ
);

84 ià(!
	gfe_·th
.
em±y
()) {

85 
	g‹¡_šput
->
£t_·th_Çme
(
fe_·th
);

87 
	g‹¡_šput
->
£t_´ovide_bufãr
(
´ovide_bufãr
);

88 
	g‹¡_šput
->
£t_bufãr_size
(
bufãr_size
);

90 
EnşaveOuut
 
	g’şave_ouut
;

91 
Stus
 
	g‹¡_¡©us
 = 
ş›Á
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
);

92 ià(!
	g‹¡_¡©us
.
ok
()) {

93  
	g‹¡_¡©us
;

95 ià(
	g‹¡_ouut
) {

96 ià(!
	g’şave_ouut
.
HasEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)) {

97  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Noƒxpectedƒnclave output");

99 *
	g‹¡_ouut
 = 
’şave_ouut
.
G‘Ex‹nsiÚ
(
sysÿÎs_‹¡_ouut
);

101  
	gStus
::
OkStus
();

106 
ExŒaùCpuS‘FromTe¡Ouut
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

107 
ıu_£t_t
 *
mask
) {

108 
CPU_ZERO
(
mask
);

109 
	gıu
 = 0;

110 cÚ¡ 
	gušt64_t
 &
	gwÜd
 : 
‹¡_ouut
.
b™_mask_sysÿÎ_ouŒ
()) {

111 
ušt64_t
 
b™_f›ld
 = 1; 
	gb™_f›ld
 != 0; bit_field <<= 1) {

112 ià(
wÜd
 & 
b™_f›ld
) {

113 
CPU_SET
(
ıu
, 
mask
);

115 ++
	gıu
;

122 
ExŒaùStBufãrFromTe¡Ouut
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

123 
¡©
 *
¡©_bufãr
) {

124 cÚ¡ 
	gSysÿÎsTe¡Ouut
::
StV®ue
 &
´Ùo_¡©_bufãr
 =

125 
‹¡_ouut
.
¡©_bufãr_sysÿÎ_»tuº
();

127 
	g¡©_bufãr
->
	g¡_dev
 = 
¡©ic_ÿ¡
<
dev_t
>(
´Ùo_¡©_bufãr
.
¡_dev
());

128 
	g¡©_bufãr
->
	g¡_šo
 = 
¡©ic_ÿ¡
<
šo_t
>(
´Ùo_¡©_bufãr
.
¡_šo
());

129 
	g¡©_bufãr
->
	g¡_mode
 = 
¡©ic_ÿ¡
<
mode_t
>(
´Ùo_¡©_bufãr
.
¡_mode
());

130 
	g¡©_bufãr
->
	g¡_Æšk
 = 
¡©ic_ÿ¡
<
Æšk_t
>(
´Ùo_¡©_bufãr
.
¡_Æšk
());

131 
	g¡©_bufãr
->
	g¡_uid
 = 
¡©ic_ÿ¡
<
uid_t
>(
´Ùo_¡©_bufãr
.
¡_uid
());

132 
	g¡©_bufãr
->
	g¡_gid
 = 
¡©ic_ÿ¡
<
gid_t
>(
´Ùo_¡©_bufãr
.
¡_gid
());

133 
	g¡©_bufãr
->
	g¡_rdev
 = 
¡©ic_ÿ¡
<
dev_t
>(
´Ùo_¡©_bufãr
.
¡_rdev
());

134 
	g¡©_bufãr
->
	g¡_size
 = 
¡©ic_ÿ¡
<
off_t
>(
´Ùo_¡©_bufãr
.
¡_size
());

135 
	g¡©_bufãr
->
	g¡_©ime
 = 
¡©ic_ÿ¡
<
time_t
>(
´Ùo_¡©_bufãr
.
¡_©ime_v®
());

136 
	g¡©_bufãr
->
	g¡_mtime
 = 
¡©ic_ÿ¡
<
time_t
>(
´Ùo_¡©_bufãr
.
¡_mtime_v®
());

137 
	g¡©_bufãr
->
	g¡_ùime
 = 
¡©ic_ÿ¡
<
time_t
>(
´Ùo_¡©_bufãr
.
¡_ùime_v®
());

138 
	g¡©_bufãr
->
	g¡_blksize
 =

139 
¡©ic_ÿ¡
<
blksize_t
>(
´Ùo_¡©_bufãr
.
¡_blksize
());

140 
	g¡©_bufãr
->
	g¡_blocks
 = 
¡©ic_ÿ¡
<
blkút_t
>(
´Ùo_¡©_bufãr
.
¡_blocks
());

145 
boŞ
 
ExŒaùUtsNameFromTe¡Ouut
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

146 
ut¢ame
 *
ut¢ame_buf
) {

147 ià(!
	g‹¡_ouut
.
has_ut¢ame_sysÿÎ_»tuº
()) {

148  
	gçl£
;

151 cÚ¡ 
	gSysÿÎsTe¡Ouut
::
UtsName
 &
´Ùo_ut¢ame
 =

152 
‹¡_ouut
.
ut¢ame_sysÿÎ_»tuº
();

154 ià(
	g´Ùo_ut¢ame
.
has_sy¢ame
()) {

155 
	g´Ùo_ut¢ame
.
sy¢ame
().
cİy
(
ut¢ame_buf
->sysname,

156 (
ut¢ame_buf
->
sy¢ame
));

158  
	gçl£
;

161 ià(
	g´Ùo_ut¢ame
.
has_nod’ame
()) {

162 
	g´Ùo_ut¢ame
.
nod’ame
().
cİy
(
ut¢ame_buf
->nodename,

163 (
ut¢ame_buf
->
nod’ame
));

165  
	gçl£
;

168 ià(
	g´Ùo_ut¢ame
.
has_»Ëa£
()) {

169 
	g´Ùo_ut¢ame
.
»Ëa£
().
cİy
(
ut¢ame_buf
->release,

170 (
ut¢ame_buf
->
»Ëa£
));

172  
	gçl£
;

175 ià(
	g´Ùo_ut¢ame
.
has_v”siÚ
()) {

176 
	g´Ùo_ut¢ame
.
v”siÚ
().
cİy
(
ut¢ame_buf
->version,

177 (
ut¢ame_buf
->
v”siÚ
));

179  
	gçl£
;

182 ià(
	g´Ùo_ut¢ame
.
has_machše
()) {

183 
	g´Ùo_ut¢ame
.
machše
().
cİy
(
ut¢ame_buf
->machine,

184 (
ut¢ame_buf
->
machše
));

186  
	gçl£
;

189 ià(
	g´Ùo_ut¢ame
.
has_domašÇme
()) {

190 
	g´Ùo_ut¢ame
.
domašÇme
().
cİy
(
ut¢ame_buf
->domainname,

191 (
ut¢ame_buf
->
domašÇme
));

194  
	gŒue
;

199 
MATCHER_P
(
Equ®sUtsName
, 
rhs_ut¢ame_buf
, "") {

200  (
¡ºcmp
(
¬g
.
sy¢ame
, 
rhs_ut¢ame_buf
.sysname, (arg.sysname)) ==

202 (
¡ºcmp
(
¬g
.
nod’ame
, 
rhs_ut¢ame_buf
.nodename,

203 (
¬g
.
nod’ame
)) == 0) &&

204 (
¡ºcmp
(
¬g
.
»Ëa£
, 
rhs_ut¢ame_buf
.release, (arg.release)) ==

206 (
¡ºcmp
(
¬g
.
v”siÚ
, 
rhs_ut¢ame_buf
.version, (arg.version)) ==

208 (
¡ºcmp
(
¬g
.
machše
, 
rhs_ut¢ame_buf
.machine, (arg.machine)) ==

210 (
¡ºcmp
(
¬g
.
domašÇme
, 
rhs_ut¢ame_buf
.domainname,

211 (
¬g
.
domašÇme
)) == 0);

216 
boŞ
 
SockaddrsEqu®
(cÚ¡ 
sockaddr
 *
§1
, cÚ¡ sockadd¸*
§2
) {

217 ià(!
	g§1
 || !
	g§2
è sa1 =ğ
§2
;

218 ià(
	g§1
->
	g§_çmy
 !ğ
§2
->
§_çmy
è 
çl£
;

219 ià(
	g§1
->
	g§_çmy
 =ğ
AF_INET
) {

220 cÚ¡ 
sockaddr_š
 *
addr1
 =

221 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
§1
);

222 cÚ¡ 
sockaddr_š
 *
	gaddr2
 =

223 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š
 *>(
§2
);

224  (
	gaddr1
->
	gsš_çmy
 =ğ
addr2
->
sš_çmy
) &&

225 (
addr1
->
sš_pÜt
 =ğ
addr2
->sin_port) &&

226 (
addr1
->
sš_addr
.
s_addr
 =ğ
addr2
->sin_addr.s_addr) &&

227 (
memcmp
(&(
addr1
->
sš_z”o
), &(
addr2
->sš_z”o), 
kSšZ”oPadSize
) ==

229 } ià(
	g§1
->
	g§_çmy
 =ğ
AF_INET6
) {

230 cÚ¡ 
sockaddr_š6
 *
addr1
 =

231 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
§1
);

232 cÚ¡ 
sockaddr_š6
 *
	gaddr2
 =

233 
»š‹½»t_ÿ¡
<cÚ¡ 
sockaddr_š6
 *>(
§2
);

234  (
	gaddr1
->
	gsš6_çmy
 =ğ
addr2
->
sš6_çmy
) &&

235 (
addr1
->
sš6_pÜt
 =ğ
addr2
->sin6_port) &&

236 (
addr1
->
sš6_æowšfo
 =ğ
addr2
->sin6_flowinfo) &&

237 (
memcmp
(&(
addr1
->
sš6_addr
.
s6_addr
), &(
addr2
->sin6_addr.s6_addr),

238 
asylo
::
kIn6AddrNumBy‹s
) == 0) &&

239 (
addr1
->
sš6_scİe_id
 =ğ
addr2
->sin6_scope_id);

241  
	gçl£
;

245 
boŞ
 
IfAddrsFÏgsEqu®
(
æags1
, 
æags2
) {

246 
	gsuµÜ‹d_æags
 = 
IFF_UP
 | 
IFF_BROADCAST
 | 
IFF_DEBUG
 | 
IFF_LOOPBACK
 |

247 
IFF_POINTOPOINT
 | 
IFF_NOTRAILERS
 | 
IFF_RUNNING
 |

248 
IFF_NOARP
 | 
IFF_PROMISC
 | 
IFF_ALLMULTI
;

249  (
	gæags1
 & 
	gsuµÜ‹d_æags
è=ğ(
æags2
 & 
suµÜ‹d_æags
);

254 
MATCHER_P
(
Equ®sSt
, 
rhs_¡©_bufãr
, "") {

255  (
	g¬g
.
	g¡_dev
 =ğ
rhs_¡©_bufãr
.
¡_dev
) &&

256 (
¬g
.
¡_šo
 =ğ
rhs_¡©_bufãr
.st_ino) &&

257 (
¬g
.
¡_mode
 =ğ
rhs_¡©_bufãr
.st_mode) &&

258 (
¬g
.
¡_Æšk
 =ğ
rhs_¡©_bufãr
.st_nlink) &&

259 (
¬g
.
¡_uid
 =ğ
rhs_¡©_bufãr
.st_uid) &&

260 (
¬g
.
¡_gid
 =ğ
rhs_¡©_bufãr
.st_gid) &&

261 (
¬g
.
¡_rdev
 =ğ
rhs_¡©_bufãr
.st_rdev) &&

262 (
¬g
.
¡_size
 =ğ
rhs_¡©_bufãr
.st_size) &&

263 (
¬g
.
¡_©ime
 =ğ
rhs_¡©_bufãr
.st_atime) &&

264 (
¬g
.
¡_mtime
 =ğ
rhs_¡©_bufãr
.st_mtime) &&

265 (
¬g
.
¡_ùime
 =ğ
rhs_¡©_bufãr
.st_ctime) &&

266 (
¬g
.
¡_blksize
 =ğ
rhs_¡©_bufãr
.st_blksize) &&

267 (
¬g
.
¡_blocks
 =ğ
rhs_¡©_bufãr
.st_blocks);

272 
boŞ
 
Com·»PassWd
(cÚ¡ 
SysÿÎsTe¡Ouut
 &
‹¡_ouut
,

273 
·sswd
 *
·sswÜd
) {

274 ià(!
	g‹¡_ouut
.
has_·sswd_sysÿÎ_»tuº
(è|| !
	g·sswÜd
) {

275  
	gçl£
;

278 cÚ¡ 
	gSysÿÎsTe¡Ouut
::
PassWd
 &
´Ùo_·sswd
 =

279 
‹¡_ouut
.
·sswd_sysÿÎ_»tuº
();

281 ià(!
	g´Ùo_·sswd
.
has_pw_Çme
() ||

282 
	g´Ùo_·sswd
.
pw_Çme
(è!ğ
·sswÜd
->pw_name ||

283 !
´Ùo_·sswd
.
has_pw_·sswd
() ||

284 
´Ùo_·sswd
.
pw_·sswd
(è!ğ
·sswÜd
->pw_passwd ||

285 !
´Ùo_·sswd
.
has_pw_uid
(è||…rÙo_·sswd.
pw_uid
(è!ğ
·sswÜd
->pw_uid ||

286 !
´Ùo_·sswd
.
has_pw_gid
(è||…rÙo_·sswd.
pw_gid
(è!ğ
·sswÜd
->pw_gid ||

287 !
´Ùo_·sswd
.
has_pw_gecos
() ||

288 
´Ùo_·sswd
.
pw_gecos
(è!ğ
·sswÜd
->pw_gecos ||

289 !
´Ùo_·sswd
.
has_pw_dœ
(è||…rÙo_·sswd.
pw_dœ
(è!ğ
·sswÜd
->pw_dir ||

290 !
´Ùo_·sswd
.
has_pw_sh–l
() ||

291 
´Ùo_·sswd
.
pw_sh–l
(è!ğ
·sswÜd
->pw_shell) {

292  
çl£
;

295  
	gŒue
;

299 şas 
	cSysÿÎsTe¡
 : 
public
 
EnşaveTe¡
 {

300 
´Ùeùed
:

301 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

302 cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
,

303 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

304  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, 
fe_·th
, 
çl£
, 0,

305 
‹¡_ouut
);

308 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

309 
boŞ
 
´ovide_bufãr
, 
št32_t
 
bufãr_size
,

310 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

311  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, "", 
´ovide_bufãr
,

312 
bufãr_size
, 
‹¡_ouut
);

317 şas 
	cCu¡omCÚfigSysÿÎsTe¡
 : 
public
 
EnşaveTe¡
 {

318 
´Ùeùed
:

319 
S‘Up
(è
ov”ride
 {

320 
cÚfig_
.
£t_ho¡_Çme
(
kCu¡omHo¡Name
);

321 
	gcÚfig_
.
£t_cu¼’t_wÜkšg_dœeùÜy
(
kCu¡omWÜkšgDœeùÜy
);

322 
	gEnşaveTe¡
::
S‘Up
();

325 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

326 cÚ¡ 
¡d
::
¡ršg
 &
fe_·th
,

327 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

328  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, 
fe_·th
, 
çl£
, 0,

329 
‹¡_ouut
);

332 
Stus
 
RunSysÿÎInsideEnşave
(cÚ¡ 
¡d
::
¡ršg
 &
‹¡ed_sysÿÎ
,

333 
boŞ
 
´ovide_bufãr
, 
št32_t
 
bufãr_size
,

334 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

335  
RunEnşaveSysÿÎ
(
ş›Á_
, 
‹¡ed_sysÿÎ
, "", 
´ovide_bufãr
,

336 
bufãr_size
, 
‹¡_ouut
);

342 
TEST_F
(
SysÿÎsTe¡
, 
SyscÚfScN´oûssÜsCÚf
) {

343 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

344 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sysconf(_SC_NPROCESSORS_CONF)", "",

345 &
‹¡_ouut
),

346 
IsOk
());

347 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

348 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
syscÚf
(
_SC_NPROCESSORS_CONF
));

353 
TEST_F
(
SysÿÎsTe¡
, 
SyscÚfScN´oûssÜsOÆn
) {

354 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

355 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sysconf(_SC_NPROCESSORS_ONLN)", "",

356 &
‹¡_ouut
),

357 
IsOk
());

358 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

359 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
syscÚf
(
_SC_NPROCESSORS_ONLN
));

364 
TEST_F
(
SysÿÎsTe¡
, 
SyscÚfScPagesize
) {

365 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

366 
ASSERT_THAT
(

367 
RunSysÿÎInsideEnşave
("syscÚf(_SC_PAGESIZE)", "", &
‹¡_ouut
),

368 
IsOk
());

369 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

370 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 4096);

375 
TEST_F
(
SysÿÎsTe¡
, 
G‘Pid
) {

376 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

377 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘pid", "", &
‹¡_ouut
), 
IsOk
());

378 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

379 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘pid
());

384 
TEST_F
(
SysÿÎsTe¡
, 
UÆšk
) {

385 
EXPECT_THAT
(

386 
RunSysÿÎInsideEnşave
("uÆšk", 
FLAGS_‹¡_tmpdœ
 + "/uÆšk", 
nuÎ±r
),

387 
IsOk
());

392 
TEST_F
(
SysÿÎsTe¡
, 
Fú
) {

393 
EXPECT_THAT
(

394 
RunSysÿÎInsideEnşave
("fú", 
FLAGS_‹¡_tmpdœ
 + "/fú", 
nuÎ±r
),

395 
IsOk
());

400 
TEST_F
(
SysÿÎsTe¡
, 
Mkdœ
) {

401 
EXPECT_THAT
(

402 
RunSysÿÎInsideEnşave
("mkdœ", 
FLAGS_‹¡_tmpdœ
 + "/mkdœ", 
nuÎ±r
),

403 
IsOk
());

404 
DIR
 *
	gdœeùÜy
 = 
İ’dœ
((
FLAGS_‹¡_tmpdœ
 + "/mkdœ").
c_¡r
());

405 
EXPECT_TRUE
(
dœeùÜy
);

406 
şo£dœ
(
dœeùÜy
);

412 
TEST_F
(
SysÿÎsTe¡
, 
Rmdœ
) {

413 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœeùÜy
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/rmdir");

414 
EXPECT_EQ
(
mkdœ
(
‹¡_dœeùÜy
.
c_¡r
(), 0644), 0);

415 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rmdœ", 
‹¡_dœeùÜy
, 
nuÎ±r
),

416 
IsOk
());

417 
DIR
 *
	gdœeùÜy
 = 
İ’dœ
(
‹¡_dœeùÜy
.
c_¡r
());

418 
EXPECT_EQ
(
dœeùÜy
, 
nuÎ±r
);

423 
TEST_F
(
SysÿÎsTe¡
, 
Dup
) {

424 
EXPECT_THAT
(

425 
RunSysÿÎInsideEnşave
("dup", 
FLAGS_‹¡_tmpdœ
 + "/dup", 
nuÎ±r
),

426 
IsOk
());

431 
TEST_F
(
SysÿÎsTe¡
, 
G‘Ho¡Name
) {

432 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

433 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘ho¡Çme", "", &
‹¡_ouut
), 
IsOk
());

434 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

435 
	gbuf
[1024];

436 
ASSERT_EQ
(
g‘ho¡Çme
(
buf
, (buf)), 0);

437 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

443 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘Ho¡Name
) {

444 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

445 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘ho¡Çme", "", &
‹¡_ouut
), 
IsOk
());

446 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

447 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
kCu¡omHo¡Name
);

452 
TEST_F
(
SysÿÎsTe¡
, 
Lšk
) {

453 
EXPECT_THAT
(

454 
RunSysÿÎInsideEnşave
("lšk", 
FLAGS_‹¡_tmpdœ
 + "/lšk", 
nuÎ±r
),

455 
IsOk
());

460 
TEST_F
(
SysÿÎsTe¡
, 
G‘Cwd
) {

461 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

462 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
Œue
, 
PATH_MAX
, &
‹¡_ouut
),

463 
IsOk
());

464 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

465 
	gbuf
[
PATH_MAX
];

466 
ASSERT_NE
(
g‘cwd
(
buf
, (buf)), 
nuÎ±r
);

467 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

472 
TEST_F
(
SysÿÎsTe¡
, 
G‘CwdNoSize
) {

473 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
Œue
, 0, 
nuÎ±r
), 
NÙ
(
IsOk
()));

478 
TEST_F
(
SysÿÎsTe¡
, 
G‘CwdNoBufãr
) {

479 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

480 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
çl£
, 
PATH_MAX
, &
‹¡_ouut
),

481 
IsOk
());

482 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

483 
	gbuf
[
PATH_MAX
];

484 
ASSERT_NE
(
g‘cwd
(
buf
, (buf)), 
nuÎ±r
);

485 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

490 
TEST_F
(
SysÿÎsTe¡
, 
G‘CwdNoBufãrNoSize
) {

491 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

492 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
çl£
, 0, &
‹¡_ouut
),

493 
IsOk
());

494 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

495 
	gbuf
[
PATH_MAX
];

496 
ASSERT_NE
(
g‘cwd
(
buf
, (buf)), 
nuÎ±r
);

497 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
buf
);

503 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘Cwd
) {

504 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

505 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", "", &
‹¡_ouut
), 
IsOk
());

506 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡ršg_sysÿÎ_»tuº
());

507 
EXPECT_EQ
(
‹¡_ouut
.
¡ršg_sysÿÎ_»tuº
(), 
kCu¡omWÜkšgDœeùÜy
);

513 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘CwdInsuffic›ÁSize
) {

514 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
Œue
,

515 
¡¾’
(
kCu¡omWÜkšgDœeùÜy
), 
nuÎ±r
),

516 
NÙ
(
IsOk
()));

522 
TEST_F
(
Cu¡omCÚfigSysÿÎsTe¡
, 
G‘CwdNoBufãrInsuffic›ÁSize
) {

523 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘cwd", 
çl£
,

524 
¡¾’
(
kCu¡omWÜkšgDœeùÜy
), 
nuÎ±r
),

525 
NÙ
(
IsOk
()));

530 
TEST_F
(
SysÿÎsTe¡
, 
Umask
) {

531 
ASSERT_THAT
(

532 
RunSysÿÎInsideEnşave
("umask", 
FLAGS_‹¡_tmpdœ
 + "/umask", 
nuÎ±r
),

533 
IsOk
());

538 
TEST_F
(
SysÿÎsTe¡
, 
G‘Uid
) {

539 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

540 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘uid", "", &
‹¡_ouut
), 
IsOk
());

541 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

542 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘uid
());

547 
TEST_F
(
SysÿÎsTe¡
, 
G‘Euid
) {

548 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

549 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘euid", "", &
‹¡_ouut
), 
IsOk
());

550 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

551 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘euid
());

556 
TEST_F
(
SysÿÎsTe¡
, 
G‘Gid
) {

557 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

558 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘gid", "", &
‹¡_ouut
), 
IsOk
());

559 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

560 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘gid
());

565 
TEST_F
(
SysÿÎsTe¡
, 
G‘Egid
) {

566 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

567 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘egid", "", &
‹¡_ouut
), 
IsOk
());

568 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

569 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘egid
());

574 
TEST_F
(
SysÿÎsTe¡
, 
G‘Ppid
) {

575 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

576 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘µid", "", &
‹¡_ouut
), 
IsOk
());

577 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

578 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 
g‘µid
());

585 
TEST_F
(
SysÿÎsTe¡
, 
SchedG‘Affš™y
) {

586 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

588 
ıu_£t_t
 
	gho¡_mask
;

589 
ASSERT_EQ
(
sched_g‘affš™y
(
g‘pid
(), (
ıu_£t_t
), &
ho¡_mask
), 0);

591 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sched_getaffinity", "",

592 &
‹¡_ouut
),

593 
IsOk
());

595 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

596 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0);

598 
ıu_£t_t
 
	g’şave_mask
;

601 
ExŒaùCpuS‘FromTe¡Ouut
(
‹¡_ouut
, &
’şave_mask
);

603 
EXPECT_TRUE
(
CPU_EQUAL
(&
ho¡_mask
, &
’şave_mask
));

608 
TEST_F
(
SysÿÎsTe¡
, 
SchedG‘Affš™yFau»
) {

609 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

611 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sched_getaffinity failure",

612  "", &
‹¡_ouut
),

613 
IsOk
());

615 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

616 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), -1);

618 
ASSERT_TRUE
(
‹¡_ouut
.
has_”ºo_sysÿÎ_v®ue
());

619 
EXPECT_EQ
(
‹¡_ouut
.
”ºo_sysÿÎ_v®ue
(),

620 
SysÿÎsTe¡Ouut
::
ERRNO_EINVAL
);

626 
TEST_F
(
SysÿÎsTe¡
, 
SchedG‘Affš™yAá”S‘
) {

627 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

629 
ıu_£t_t
 
	gš™Ÿl_mask
;

630 
ASSERT_EQ
(
sched_g‘affš™y
(
g‘pid
(), (
ıu_£t_t
), &
š™Ÿl_mask
), 0);

632 
	gtÙ®_ıus
 = 
CPU_COUNT
(&
š™Ÿl_mask
);

633 ià(
	gtÙ®_ıus
 < 2) {

635 
SUCCEED
() << "Only one CPU in‡ffinity mask. Not continuing withest.";

638 
boŞ
 
	gun£t_ıu
 = 
çl£
;

639 
	gıu
 = 0, 
	gıus_so_çr
 = 0; cpus_so_ç¸< 
	gtÙ®_ıus
; ++cpu) {

640 ià(
CPU_ISSET
(
ıu
, &
š™Ÿl_mask
)) {

641 ià(
	gun£t_ıu
) {

642 
CPU_CLR
(
ıu
, &
š™Ÿl_mask
);

644 
	gun£t_ıu
 = !
un£t_ıu
;

645 ++
	gıus_so_çr
;

648 
ASSERT_EQ
(
sched_£ffš™y
(
g‘pid
(), (
ıu_£t_t
), &
š™Ÿl_mask
), 0);

650 
ıu_£t_t
 
	gho¡_mask
;

651 
ASSERT_EQ
(
sched_g‘affš™y
(
g‘pid
(), (
ıu_£t_t
), &
ho¡_mask
), 0);

652 
ASSERT_TRUE
(
CPU_EQUAL
(&
š™Ÿl_mask
, &
ho¡_mask
));

654 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("sched_getaffinity", "",

655 &
‹¡_ouut
),

656 
IsOk
());

658 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
());

659 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0);

661 
ıu_£t_t
 
	g’şave_mask
;

664 
ExŒaùCpuS‘FromTe¡Ouut
(
‹¡_ouut
, &
’şave_mask
);

666 
EXPECT_TRUE
(
CPU_EQUAL
(&
ho¡_mask
, &
’şave_mask
));

672 
TEST_F
(
SysÿÎsTe¡
, 
CpuS‘Maüos
) {

673 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("CPU_SET macros", "",

674  
nuÎ±r
),

675 
IsOk
());

680 
TEST_F
(
SysÿÎsTe¡
, 
St
) {

681 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

682 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/stat");

684 
umask
(
S_IWGRP
 | 
S_IWOTH
);

685 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

686 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

688 
¡©
 
	gho¡_¡©_bufãr
;

689 
ASSERT_EQ
(
¡©
(
‹¡_dœ
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

690 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_dœ
, ", ...) failed on host");

692 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("¡©", 
‹¡_dœ
, &
‹¡_ouut
), 
IsOk
())

695 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

697 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

698 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_dœ
, ", ...) failed inƒnclave");

700 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

703 
¡©
 
	g’şave_¡©_bufãr
;

704 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

706 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

713 
TEST_F
(
SysÿÎsTe¡
, 
StOnSymlšk
) {

714 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

715 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 =

716 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/stat_on_symlink");

717 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_lšk
 =

718 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/stat_on_symlink_link");

720 
umask
(
S_IWGRP
 | 
S_IWOTH
);

721 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

722 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

724 
ASSERT_EQ
(
symlšk
(
‹¡_dœ
.
c_¡r
(), 
‹¡_lšk
.c_str()), 0)

725 << 
	gab¦
::
SŒC©
("FaedØü—‹†šk ", 
‹¡_lšk
, "Ø", 
‹¡_dœ
);

727 
¡©
 
	gho¡_¡©_bufãr
;

728 
ASSERT_EQ
(
¡©
(
‹¡_lšk
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

729 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_lšk
, ", ...) failed on host");

731 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("¡©", 
‹¡_lšk
, &
‹¡_ouut
), 
IsOk
())

734 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

736 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

737 << 
	gab¦
::
SŒC©
("¡©(", 
‹¡_lšk
, ", ...) failed inƒnclave");

739 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

742 
¡©
 
	g’şave_¡©_bufãr
;

743 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

745 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

751 
TEST_F
(
SysÿÎsTe¡
, 
FSt
) {

752 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

753 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/fstat");

755 
umask
(
S_IWGRP
 | 
S_IWOTH
);

756 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

757 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

759 
	gfd
 = 
İ’
(
‹¡_dœ
.
c_¡r
(), 
O_RDONLY
);

760 
ASSERT_NE
(
fd
, -1è<< 
	gab¦
::
SŒC©
("FaedØİ’ ", 
‹¡_dœ
);

762 
¡©
 
	gho¡_¡©_bufãr
;

763 
ASSERT_EQ
(
f¡©
(
fd
, &
ho¡_¡©_bufãr
), 0)

764 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_dœ
, "], ...) failed on host");

766 
ASSERT_EQ
(
şo£
(
fd
), 0è<< 
	gab¦
::
SŒC©
("FaedØşo£ ", 
‹¡_dœ
);

768 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("f¡©", 
‹¡_dœ
, &
‹¡_ouut
), 
IsOk
())

771 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

773 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

774 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_dœ
, "], ...) failed inƒnclave");

776 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

779 
¡©
 
	g’şave_¡©_bufãr
;

780 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

782 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

789 
TEST_F
(
SysÿÎsTe¡
, 
FStOnSymlšk
) {

790 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

791 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 =

792 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
 + "/fstat_on_symlink");

793 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_lšk
 =

794 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
 + "/fstat_on_symlink_link");

796 
umask
(
S_IWGRP
 | 
S_IWOTH
);

797 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

798 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

800 
ASSERT_EQ
(
symlšk
(
‹¡_dœ
.
c_¡r
(), 
‹¡_lšk
.c_str()), 0)

801 << 
	gab¦
::
SŒC©
("FaedØü—‹†šk ", 
‹¡_lšk
, "Ø", 
‹¡_dœ
);

803 
	gfd
 = 
İ’
(
‹¡_lšk
.
c_¡r
(), 
O_RDONLY
);

804 
ASSERT_NE
(
fd
, -1è<< 
	gab¦
::
SŒC©
("FaedØİ’ ", 
‹¡_lšk
);

806 
¡©
 
	gho¡_¡©_bufãr
;

807 
ASSERT_EQ
(
f¡©
(
fd
, &
ho¡_¡©_bufãr
), 0)

808 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_lšk
, "], ...) failed on host");

810 
ASSERT_EQ
(
şo£
(
fd
), 0è<< 
	gab¦
::
SŒC©
("FaedØşo£ ", 
‹¡_dœ
);

812 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("f¡©", 
‹¡_lšk
, &
‹¡_ouut
), 
IsOk
())

815 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

817 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

818 << 
	gab¦
::
SŒC©
("f¡©([fd oà", 
‹¡_lšk
, "], ...) failed inƒnclave");

820 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

823 
¡©
 
	g’şave_¡©_bufãr
;

824 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

826 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

832 
TEST_F
(
SysÿÎsTe¡
, 
LSt
) {

833 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

834 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/lstat");

836 
umask
(
S_IWGRP
 | 
S_IWOTH
);

837 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

838 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

840 
¡©
 
	gho¡_¡©_bufãr
;

841 
ASSERT_EQ
(
l¡©
(
‹¡_dœ
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

842 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_dœ
, ", ...) failed on host");

844 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("l¡©", 
‹¡_dœ
, &
‹¡_ouut
), 
IsOk
())

847 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

849 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

850 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_dœ
, ", ...) failed inƒnclave");

852 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

855 
¡©
 
	g’şave_¡©_bufãr
;

856 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

858 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

865 
TEST_F
(
SysÿÎsTe¡
, 
LStOnSymlšk
) {

866 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

867 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_dœ
 =

868 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/lstat_on_symlink");

869 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_lšk
 =

870 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/lstat_on_symlink_link");

872 
umask
(
S_IWGRP
 | 
S_IWOTH
);

873 
ASSERT_EQ
(
mkdœ
(
‹¡_dœ
.
c_¡r
(), 0777), 0)

874 << 
	gab¦
::
SŒC©
("FaedØü—‹ ", 
‹¡_dœ
);

876 
ASSERT_EQ
(
symlšk
(
‹¡_dœ
.
c_¡r
(), 
‹¡_lšk
.c_str()), 0)

877 << 
	gab¦
::
SŒC©
("FaedØü—‹†šk ", 
‹¡_lšk
, "Ø", 
‹¡_dœ
);

879 
¡©
 
	gho¡_¡©_bufãr
;

880 
ASSERT_EQ
(
l¡©
(
‹¡_lšk
.
c_¡r
(), &
ho¡_¡©_bufãr
), 0)

881 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_lšk
, ", ...) failed on host");

883 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("l¡©", 
‹¡_lšk
, &
‹¡_ouut
), 
IsOk
())

886 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

888 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

889 << 
	gab¦
::
SŒC©
("l¡©(", 
‹¡_lšk
, ", ...) failed inƒnclave");

891 
ASSERT_TRUE
(
‹¡_ouut
.
has_¡©_bufãr_sysÿÎ_»tuº
())

894 
¡©
 
	g’şave_¡©_bufãr
;

895 
ExŒaùStBufãrFromTe¡Ouut
(
‹¡_ouut
, &
’şave_¡©_bufãr
);

897 
EXPECT_THAT
(
ho¡_¡©_bufãr
, 
Equ®sSt
(
’şave_¡©_bufãr
))

904 
TEST_F
(
SysÿÎsTe¡
, 
UÇme
) {

905 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

907 
ut¢ame
 
	gho¡_ut¢ame_buf
;

908 
ASSERT_EQ
(
uÇme
(&
ho¡_ut¢ame_buf
), 0) << "Could‚ot fetch host utsname";

910 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("uÇme", "", &
‹¡_ouut
),

911 
IsOk
())

914 
ASSERT_TRUE
(
‹¡_ouut
.
has_št_sysÿÎ_»tuº
())

916 
EXPECT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0)

918 << (
	g‹¡_ouut
.
has_”ºo_sysÿÎ_v®ue
(è? 
¡»¼Ü
(
”ºo
)

922 
ut¢ame
 
	g’şave_ut¢ame_buf
;

923 
EXPECT_TRUE
(
ExŒaùUtsNameFromTe¡Ouut
(
‹¡_ouut
, &
’şave_ut¢ame_buf
))

926 
EXPECT_THAT
(
ho¡_ut¢ame_buf
, 
Equ®sUtsName
(
’şave_ut¢ame_buf
));

932 
TEST_F
(
SysÿÎsTe¡
, 
Wr™ev
) {

933 
EXPECT_THAT
(

934 
RunSysÿÎInsideEnşave
("wr™ev", 
FLAGS_‹¡_tmpdœ
 + "/wr™ev", 
nuÎ±r
),

935 
IsOk
());

940 
TEST_F
(
SysÿÎsTe¡
, 
R—dv
) {

941 
EXPECT_THAT
(

942 
RunSysÿÎInsideEnşave
("»adv", 
FLAGS_‹¡_tmpdœ
 + "/»adv", 
nuÎ±r
),

943 
IsOk
());

948 
TEST_F
(
SysÿÎsTe¡
, 
Rlim™NoFe
) {

949 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rlimit‚ofile",

950 
FLAGS_‹¡_tmpdœ
 + "/¾im™", 
nuÎ±r
),

951 
IsOk
());

957 
TEST_F
(
SysÿÎsTe¡
, 
Rlim™LowNoFe
) {

958 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rlimit†ow‚ofile",

959 
FLAGS_‹¡_tmpdœ
 + "/¾im™", 
nuÎ±r
),

960 
IsOk
());

965 
TEST_F
(
SysÿÎsTe¡
, 
Rlim™Inv®idNoFe
) {

966 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("rlimit invalid‚ofile",

967 
FLAGS_‹¡_tmpdœ
 + "/¾im™", 
nuÎ±r
),

968 
IsOk
());

973 
TEST_F
(
SysÿÎsTe¡
, 
ChMod
) {

974 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/chmod");

975 
ASSERT_NE
(
İ’
(
‹¡_fe
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0777), -1);

976 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("chmod", 
‹¡_fe
, 
nuÎ±r
), 
IsOk
());

977 
¡©
 
	g¡©_bufãr
;

978 
ASSERT_EQ
(
¡©
(
‹¡_fe
.
c_¡r
(), &
¡©_bufãr
), 0);

979 
EXPECT_EQ
(
¡©_bufãr
.
¡_mode
 & 0777, 0644);

984 
TEST_F
(
SysÿÎsTe¡
, 
FChMod
) {

985 cÚ¡ 
	g¡d
::
¡ršg
 
‹¡_fe
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/chmod");

986 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("fchmod", 
‹¡_fe
, 
nuÎ±r
), 
IsOk
());

987 
¡©
 
	g¡©_bufãr
;

988 
ASSERT_EQ
(
¡©
(
‹¡_fe
.
c_¡r
(), &
¡©_bufãr
), 0);

989 
EXPECT_EQ
(
¡©_bufãr
.
¡_mode
 & 0777, 0644);

992 
MATCHER_P
(
M©chIfAddrs
, 
th©
, "") {

993  
SockaddrsEqu®
(
¬g
->
iç_addr
, 
th©
->ifa_addr) &&

994 
SockaddrsEqu®
(
¬g
->
iç_Ãtmask
, 
th©
->ifa_netmask) &&

995 
SockaddrsEqu®
(
¬g
->
iç_ifu
.
ifu_d¡addr
, 
th©
->ifa_ifu.ifu_dstaddr) &&

996 (
¡rcmp
(
¬g
->
iç_Çme
, 
th©
->ifa_name) == 0) &&

997 
IfAddrsFÏgsEqu®
(
¬g
->
iç_æags
, 
th©
->iç_æagsè&& !
	g¬g
->
	giç_d©a
 &&

998 !
	gth©
->
	giç_d©a
;

1008 
TEST_F
(
SysÿÎsTe¡
, 
G‘IfAddrs
) {

1009 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

1010 
ASSERT_THAT
(
RunSysÿÎInsideEnşave
("g‘içddrs", "", &
‹¡_ouut
), 
IsOk
());

1011 
ASSERT_EQ
(
‹¡_ouut
.
št_sysÿÎ_»tuº
(), 0);

1012 
ASSERT_TRUE
(
‹¡_ouut
.
has_£rŸlized_´Ùo_»tuº
());

1013 
içddrs
 *
	gho¡_äÚt
 = 
nuÎ±r
;

1014 
	g»t
 = 
g‘içddrs
(&
ho¡_äÚt
);

1015 
ASSERT_EQ
(
»t
, 0);

1016 
içddrs
 *
	g’şave_äÚt
 = 
nuÎ±r
;

1017 
	g¡d
::
¡ršg
 
£rŸlized_içddrs
 = 
‹¡_ouut
.
£rŸlized_´Ùo_»tuº
();

1018 
ASSERT_TRUE
(
asylo
::
De£rŸlizeIfAddrs
(
£rŸlized_içddrs
, &
’şave_äÚt
));

1024 
	gab¦
::
æ©_hash_£t
<
içddrs
 *> 
found_š_’şave
;

1025 
	g¡d
::
veùÜ
<::
‹¡šg
::
M©ch”
<
içddrs
 *>> 
ex³ùed
;

1026 
içddrs
 *
	g’şave_li¡_cu¼
 = 
’şave_äÚt
;

1027 
	g’şave_li¡_cu¼
 !ğ
nuÎ±r
;

1028 
	g’şave_li¡_cu¼
 = 
’şave_li¡_cu¼
->
iç_Ãxt
) {

1029 
ex³ùed
.
push_back
(
M©chIfAddrs
(
’şave_li¡_cu¼
));

1031 
	g¡d
::
veùÜ
<
içddrs
 *> 
suµÜ‹d_ho¡
;

1034 
içddrs
 *
	gho¡_li¡_cu¼
 = 
ho¡_äÚt
; ho¡_li¡_cu¼ !ğ
nuÎ±r
;

1035 
	gho¡_li¡_cu¼
 = 
ho¡_li¡_cu¼
->
iç_Ãxt
) {

1036 ià(
IfAddrSuµÜ‹d
(
ho¡_li¡_cu¼
)) {

1037 
suµÜ‹d_ho¡
.
push_back
(
ho¡_li¡_cu¼
);

1040 
EXPECT_THAT
(
suµÜ‹d_ho¡
.
size
(), 
Eq
(
ex³ùed
.size())è<< 
	g£rŸlized_içddrs
;

1041 
EXPECT_THAT
(
suµÜ‹d_ho¡
, 
UnÜd”edEËm’tsA»A¼ay
(
ex³ùed
));

1042 
	gasylo
::
F»eDe£rŸlizedIfAddrs
(
’şave_äÚt
);

1043 
ä“içddrs
(
ho¡_äÚt
);

1047 
TEST_F
(
SysÿÎsTe¡
, 
SockÇme_SUCCESS
) {

1048 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_sucûss", "", 
nuÎ±r
),

1049 
IsOk
());

1054 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_EBADF
) {

1055 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_ebadf", "", 
nuÎ±r
),

1056 
IsOk
());

1059 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_EFAULT
) {

1060 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_eçuÉ", "", 
nuÎ±r
),

1061 
IsOk
());

1064 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_EINVAL
) {

1065 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_ešv®", "", 
nuÎ±r
),

1066 
IsOk
());

1069 
TEST_F
(
SysÿÎsTe¡
, 
SockÇmeFau»_ENOTSOCK
) {

1070 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘sockÇme_’Ùsock", "", 
nuÎ±r
),

1071 
IsOk
());

1076 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_EBADF
) {

1077 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_ebadf", "", 
nuÎ±r
),

1078 
IsOk
());

1081 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_EFAULT
) {

1082 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_eçuÉ", "", 
nuÎ±r
),

1083 
IsOk
());

1086 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_EINVAL
) {

1087 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_ešv®", "", 
nuÎ±r
),

1088 
IsOk
());

1091 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_ENOTCONN
) {

1092 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_’ÙcÚn", "", 
nuÎ±r
),

1093 
IsOk
());

1096 
TEST_F
(
SysÿÎsTe¡
, 
P“ºameFau»_ENOTSOCK
) {

1097 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("g‘³”Çme_’Ùsock", "", 
nuÎ±r
),

1098 
IsOk
());

1103 
TEST_F
(
SysÿÎsTe¡
, 
Trunÿ‹
) {

1104 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("truncate",

1105 
FLAGS_‹¡_tmpdœ
 + "/Œunÿ‹", 
nuÎ±r
),

1106 
IsOk
());

1111 
TEST_F
(
SysÿÎsTe¡
, 
Mm­
) {

1112 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("mm­", "", 
nuÎ±r
), 
IsOk
());

1115 
TEST_F
(
SysÿÎsTe¡
, 
Itim”
) {

1116 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("™im”", "", 
nuÎ±r
), 
IsOk
());

1121 
TEST_F
(
SysÿÎsTe¡
, 
R’ame
) {

1122 
EXPECT_THAT
(
RunSysÿÎInsideEnşave
("»Çme", 
FLAGS_‹¡_tmpdœ
, 
nuÎ±r
),

1123 
IsOk
());

1124 
	gfd
 = 
İ’
((
FLAGS_‹¡_tmpdœ
 + "/»Çme").
c_¡r
(), 
O_RDWR
);

1125 
EXPECT_GE
(
fd
, 0);

1126 
şo£
(
fd
);

1132 
TEST_F
(
SysÿÎsTe¡
, 
Utimes
) {

1133 
EXPECT_THAT
(

1134 
RunSysÿÎInsideEnşave
("utimes", 
FLAGS_‹¡_tmpdœ
 + "/utimes", 
nuÎ±r
),

1135 
IsOk
());

1141 
TEST_F
(
SysÿÎsTe¡
, 
G‘PWUid
) {

1142 
SysÿÎsTe¡Ouut
 
	g‹¡_ouut
;

1144 
ASSERT_THAT
(

1145 
RunSysÿÎInsideEnşave
("g‘pwuid", "", &
‹¡_ouut
),

1146 
IsOk
());

1149 
EXPECT_TRUE
(
Com·»PassWd
(
‹¡_ouut
, 
g‘pwuid
(
g‘uid
())));

	@platform/posix/syscalls_test_enclave.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<içddrs.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<pwd.h
>

24 
	~<»gex.h
>

25 
	~<sched.h
>

26 
	~<¡dio.h
>

27 
	~<sys/mmª.h
>

28 
	~<sys/»sourû.h
>

29 
	~<sys/¡©.h
>

30 
	~<sys/uio.h
>

31 
	~<sys/ut¢ame.h
>

32 
	~<uni¡d.h
>

33 
	~<utime.h
>

35 
	~<®gÜ™hm
>

37 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

38 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

39 
	~"asylo/ut/loggšg.h
"

40 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

41 
	~"asylo/¶©fÜm/posix/sysÿÎs_‹¡.pb.h
"

42 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

43 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

44 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

45 
	~"asylo/ut/¡©us_maüos.h
"

46 
	~"asylo/ut/¡©usÜ.h
"

48 
Çme¥aû
 
	gasylo
 {

51 şas 
	cSysÿÎsEnşave
 : 
public
 
EnşaveTe¡Ca£
 {

52 
public
:

53 
SysÿÎsEnşave
() = ;

55 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

56 ià(!
	gšput
.
HasEx‹nsiÚ
(
sysÿÎs_‹¡_šput
)) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

60 
SysÿÎsTe¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sysÿÎs_‹¡_šput
);

61 ià(!
	g‹¡_šput
.
has_‹¡_rg‘
()) {

62  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

66 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

67 ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sysconf(_SC_NPROCESSORS_CONF)") {

68  
RunSyscÚfTe¡
(
ouut
, 
_SC_NPROCESSORS_CONF
);

69 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sysconf(_SC_NPROCESSORS_ONLN)") {

70  
RunSyscÚfTe¡
(
ouut
, 
_SC_NPROCESSORS_ONLN
);

71 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sysconf(_SC_PAGESIZE)") {

72  
RunSyscÚfTe¡
(
ouut
, 
_SC_PAGESIZE
);

73 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpid") {

74  
RunG‘PidTe¡
(
ouut
);

75 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "unlink") {

76  
RunUÆškTe¡
(
‹¡_šput
.
·th_Çme
());

77 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "fcntl") {

78  
RunFúTe¡
(
‹¡_šput
.
·th_Çme
());

79 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "mkdir") {

80  
RunMkdœTe¡
(
‹¡_šput
.
·th_Çme
());

81 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rmdir") {

82  
RunRmDœTe¡
(
‹¡_šput
.
·th_Çme
());

83 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "dup") {

84  
RunDupTe¡
(
‹¡_šput
.
·th_Çme
());

85 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "gethostname") {

86  
RunG‘Ho¡NameTe¡
(
ouut
);

87 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "link") {

88  
RunLškTe¡
(
‹¡_šput
.
·th_Çme
());

89 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getcwd") {

90  
RunG‘CwdTe¡
(
‹¡_šput
.
´ovide_bufãr
(),

91 
‹¡_šput
.
bufãr_size
(), 
ouut
);

92 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "umask") {

93  
RunUmaskTe¡
(
‹¡_šput
.
·th_Çme
());

94 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getuid") {

95  
RunG‘UidTe¡
(
ouut
);

96 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "geteuid") {

97  
RunG‘EuidTe¡
(
ouut
);

98 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getgid") {

99  
RunG‘GidTe¡
(
ouut
);

100 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getegid") {

101  
RunG‘EgidTe¡
(
ouut
);

102 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getppid") {

103  
RunG‘PpidTe¡
(
ouut
);

104 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sched_getaffinity") {

105  
RunSchedG‘Affš™yTe¡
(
ouut
);

106 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sched_getaffinity failure") {

107  
RunSchedG‘Affš™yFau»Te¡
(
ouut
);

108 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "CPU_SET macros") {

109  
RunCpuS‘MaüosTe¡
(
ouut
);

110 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "stat") {

111  
RunStTe¡
(
‹¡_šput
.
·th_Çme
(), 
ouut
);

112 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "fstat") {

113  
RunFStTe¡
(
‹¡_šput
.
·th_Çme
(), 
ouut
);

114 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "lstat") {

115  
RunLStTe¡
(
‹¡_šput
.
·th_Çme
(), 
ouut
);

116 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "uname") {

117  
RunUÇmeTe¡
(
ouut
);

118 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "writev") {

119  
RunWr™evTe¡
(
‹¡_šput
.
·th_Çme
());

120 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "readv") {

121  
RunR—dvTe¡
(
‹¡_šput
.
·th_Çme
());

122 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rlimit‚ofile") {

123  
RunRlim™NoFeTe¡
(
‹¡_šput
.
·th_Çme
());

124 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rlimit†ow‚ofile") {

125  
RunRlim™LowNoFeTe¡
(
‹¡_šput
.
·th_Çme
());

126 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rlimit invalid‚ofile") {

127  
RunRlim™Inv®idNoFeTe¡
(
‹¡_šput
.
·th_Çme
());

128 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "chmod") {

129  
RunChModTe¡
(
‹¡_šput
.
·th_Çme
());

130 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "fchmod") {

131  
RunFChModTe¡
(
‹¡_šput
.
·th_Çme
());

132 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getifaddrs") {

133  
RunG‘IfAddrsTe¡
(
ouut
);

134 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_success") {

135  
RunG‘SockÇmeTe¡_SUCCESS
();

136 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_ebadf") {

137  
RunG‘SockÇmeFau»Te¡_EBADF
();

138 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_efault") {

139  
RunG‘SockÇmeFau»Te¡_EFAULT
();

140 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_einval") {

141  
RunG‘SockÇmeFau»Te¡_EINVAL
();

142 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_enotsock") {

143  
RunG‘SockÇmeFau»Te¡_ENOTSOCK
();

144 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_ebadf") {

145  
RunG‘P“ºameFau»Te¡_EBADF
();

146 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_efault") {

147  
RunG‘P“ºameFau»Te¡_EFAULT
();

148 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_einval") {

149  
RunG‘P“ºameFau»Te¡_EINVAL
();

150 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_enotsock") {

151  
RunG‘P“ºameFau»Te¡_ENOTSOCK
();

152 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_enotconn") {

153  
RunG‘P“ºameFau»Te¡_ENOTCONN
();

154 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "truncate") {

155  
RunTrunÿ‹Te¡
(
‹¡_šput
.
·th_Çme
());

156 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "mmap") {

157  
RunMm­Te¡
();

158 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "itimer") {

159  
RunItim”Te¡
();

160 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rename") {

161  
RunR’ameTe¡
(
‹¡_šput
.
·th_Çme
());

162 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "utimes") {

163  
RunUtimesTe¡
(
‹¡_šput
.
·th_Çme
());

164 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpwuid") {

165  
RunG‘PWUidTe¡
(
ouut
);

168 
LOG
(
ERROR
) << "Failedo identifyestoƒxecute.";

170 
»gex_t
 
	g»gex
;

171 ià(
»gcomp
(&
»gex
, "", 0)) {

172  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "recompƒrror");

174 
»gä“
(&
»gex
);

176  
	gStus
::
OkStus
();

179 
	g´iv©e
:

180 
EncodeE¼noV®ueInTe¡Ouut
(
”ºo_v®ue
,

181 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

182 
	g‹¡_ouut
->
ş—r_”ºo_sysÿÎ_v®ue
();

183 
	g”ºo_v®ue
) {

185 
‹¡_ouut
->
£t_”ºo_sysÿÎ_v®ue
(
SysÿÎsTe¡Ouut
::
ERRNO_ZERO
);

187 
	gEINVAL
:

188 
‹¡_ouut
->
£t_”ºo_sysÿÎ_v®ue
(
SysÿÎsTe¡Ouut
::
ERRNO_EINVAL
);

191 
‹¡_ouut
->
£t_”ºo_sysÿÎ_v®ue
(
SysÿÎsTe¡Ouut
::
UNSUPPORTED
);

197 
EncodeCpuS‘InTe¡Ouut
(
ıu_£t_t
 &
mask
,

198 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

199 
	g‹¡_ouut
->
ş—r_b™_mask_sysÿÎ_ouŒ
();

200 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

201 
	gwÜd_num
 = 
ıu
 / (8 * (
ušt64_t
));

202 
	gb™_num
 = 
ıu
 % (8 * (
ušt64_t
));

203 ià(
	gb™_num
 == 0) {

204 
‹¡_ouut
->
add_b™_mask_sysÿÎ_ouŒ
(0);

206 ià(
CPU_ISSET
(
ıu
, &
mask
)) {

207 *
	g‹¡_ouut
->
mubË_b™_mask_sysÿÎ_ouŒ
()->
MubË
(
wÜd_num
) |=

208 
¡©ic_ÿ¡
<
ušt64_t
>(1è<< 
b™_num
;

215 
EncodeStBufãrInTe¡Ouut
(cÚ¡ 
¡©
 &
¡©_bufãr
,

216 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

217 
usšg
 
	ggoogË
::
´Ùobuf
::
št64
;

219 
	gSysÿÎsTe¡Ouut
::
StV®ue
 *
´Ùo_¡©_bufãr
 =

220 
‹¡_ouut
->
mubË_¡©_bufãr_sysÿÎ_»tuº
();

222 
	g´Ùo_¡©_bufãr
->
£t_¡_dev
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_dev
));

223 
	g´Ùo_¡©_bufãr
->
£t_¡_šo
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_šo
));

224 
	g´Ùo_¡©_bufãr
->
£t_¡_mode
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_mode
));

225 
	g´Ùo_¡©_bufãr
->
£t_¡_Æšk
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_Æšk
));

226 
	g´Ùo_¡©_bufãr
->
£t_¡_uid
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_uid
));

227 
	g´Ùo_¡©_bufãr
->
£t_¡_gid
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_gid
));

228 
	g´Ùo_¡©_bufãr
->
£t_¡_rdev
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_rdev
));

229 
	g´Ùo_¡©_bufãr
->
£t_¡_size
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_size
));

230 
	g´Ùo_¡©_bufãr
->
£t_¡_©ime_v®
(

231 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_©ime
));

232 
	g´Ùo_¡©_bufãr
->
£t_¡_mtime_v®
(

233 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_mtime
));

234 
	g´Ùo_¡©_bufãr
->
£t_¡_ùime_v®
(

235 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_ùime
));

236 
	g´Ùo_¡©_bufãr
->
£t_¡_blksize
(

237 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_blksize
));

238 
	g´Ùo_¡©_bufãr
->
£t_¡_blocks
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_blocks
));

243 
EncodeUtsNameInTe¡Ouut
(
ut¢ame
 &
ut¢ame_buf
,

244 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

245 
	gSysÿÎsTe¡Ouut
::
UtsName
 *
´Ùo_ut¢ame
 =

246 
‹¡_ouut
->
mubË_ut¢ame_sysÿÎ_»tuº
();

248 
	g´Ùo_ut¢ame
->
£t_sy¢ame
(
ut¢ame_buf
.
sy¢ame
,

249 (
ut¢ame_buf
.
sy¢ame
));

250 
	g´Ùo_ut¢ame
->
£t_nod’ame
(
ut¢ame_buf
.
nod’ame
,

251 (
ut¢ame_buf
.
nod’ame
));

252 
	g´Ùo_ut¢ame
->
£t_»Ëa£
(
ut¢ame_buf
.
»Ëa£
,

253 (
ut¢ame_buf
.
»Ëa£
));

254 
	g´Ùo_ut¢ame
->
£t_v”siÚ
(
ut¢ame_buf
.
v”siÚ
,

255 (
ut¢ame_buf
.
v”siÚ
));

256 
	g´Ùo_ut¢ame
->
£t_machše
(
ut¢ame_buf
.
machše
,

257 (
ut¢ame_buf
.
machše
));

258 
	g´Ùo_ut¢ame
->
£t_domašÇme
(
ut¢ame_buf
.
domašÇme
,

259 (
ut¢ame_buf
.
domašÇme
));

264 
boŞ
 
EncodePassWdInTe¡Ouut
(
·sswd
 *
·sswÜd
,

265 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

266 ià(!
	g·sswÜd
 || !
	g‹¡_ouut
) {

267  
	gçl£
;

270 
	gSysÿÎsTe¡Ouut
::
PassWd
 *
´Ùo_·sswd
 =

271 
‹¡_ouut
->
mubË_·sswd_sysÿÎ_»tuº
();

273 
	g´Ùo_·sswd
->
£t_pw_Çme
(
·sswÜd
->
pw_Çme
, 
¡¾’
(password->pw_name));

274 
	g´Ùo_·sswd
->
£t_pw_·sswd
(
·sswÜd
->
pw_·sswd
,

275 
¡¾’
(
·sswÜd
->
pw_·sswd
));

276 
	g´Ùo_·sswd
->
£t_pw_uid
(
·sswÜd
->
pw_uid
);

277 
	g´Ùo_·sswd
->
£t_pw_gid
(
·sswÜd
->
pw_gid
);

278 
	g´Ùo_·sswd
->
£t_pw_gecos
(
·sswÜd
->
pw_gecos
, 
¡¾’
(password->pw_gecos));

279 
	g´Ùo_·sswd
->
£t_pw_dœ
(
·sswÜd
->
pw_dœ
, 
¡¾’
(password->pw_dir));

280 
	g´Ùo_·sswd
->
£t_pw_sh–l
(
·sswÜd
->
pw_sh–l
, 
¡¾’
(password->pw_shell));

281  
	gŒue
;

284 
	gStusOr
<> 
O³nFe
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
æags
, 
mode_t
 
mode
) {

285 ià(
	g·th
.
em±y
()) {

286  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath isƒmpty");

288 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
æags
, 
mode
);

289 ià(
	gfd
 < 0) {

290  
Stus
(

291 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

292 
ab¦
::
SŒC©
("O³À·th ", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

294  
	gfd
;

297 
Stus
 
R—dFe
(
fd
, *
buf
, 
size
) {

298 
	g»ad_by‹s
 = 0;

299 
	g»ad_by‹s
 < 
	gsize
) {

300 
	grc
 = 
»ad
(
fd
, 
buf
 + 
»ad_by‹s
, 
size
 -„ead_bytes);

301 
	g»ad_by‹s
 +ğ
rc
;

302 ià(
	g»ad_by‹s
 > 
	gsize
 || 
	grc
 < 0) {

303  
Stus
(

304 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

305 
ab¦
::
SŒC©
("FaedØ»ad from fe,ƒ¼Ü:", 
¡»¼Ü
(
”ºo
)));

308 ià(
	g»ad_by‹s
 !ğ
size
) {

309  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

312  
	gStus
::
OkStus
();

315 
Stus
 
RunSyscÚfTe¡
(
EnşaveOuut
 *
ouut
, 
Çme
) {

316 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

317 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
syscÚf
(
Çme
));

318 ià(
	gouut
) {

319 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

321  
	gStus
::
OkStus
();

324 
Stus
 
RunG‘PidTe¡
(
EnşaveOuut
 *
ouut
) {

325 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

326 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘pid
());

327 ià(
	gouut
) {

328 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

330  
	gStus
::
OkStus
();

333 
Stus
 
RunUÆškTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

334 
fd
;

335 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

336 
şo£
(
fd
);

337 ià(
uÆšk
(
·th
.
c_¡r
()) == -1) {

338  
Stus
(

339 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

340 
ab¦
::
SŒC©
("UÆšk f", 
·th
, "çed: ", 
¡»¼Ü
(
”ºo
)));

342 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
);

343 ià(
	gfd
 >= 0) {

344 
şo£
(
fd
);

345  
Stus
(

346 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

347 
ab¦
::
SŒC©
("F", 
·th
, " is still‡vailable‡fter unlink"));

349  
	gStus
::
OkStus
();

352 
Stus
 
RunFúTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

353 
fd
;

354 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

355 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

358 ià(
fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
 | 
O_APPEND
) == -1) {

359 
şo£
(
fd
);

360  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

361 
ab¦
::
SŒC©
("Fú s‘ fÏg fÜ f", 
·th
,

362 " faed: ", 
¡»¼Ü
(
”ºo
)));

364 
	gæags
 = 
fú
(
fd
, 
F_GETFL
);

365 ià(!(
	gæags
 & 
	gO_NONBLOCK
è|| !(æag & 
	gO_APPEND
)) {

366  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

367 
ab¦
::
SŒC©
("Fú g‘ fÏg oàf", 
·th
,

368 "„‘uºed uÃx³ùed„esuÉ: ", 
æags
));

372 ià(
fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

373 
şo£
(
fd
);

374  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

375 
ab¦
::
SŒC©
("Fú s‘ FD fÏg fÜ f", 
·th
,

376 "çed: ", 
¡»¼Ü
(
”ºo
)));

378 
	gfd_æags
 = 
fú
(
fd
, 
F_GETFD
);

379 ià(!(
	gfd_æags
 & 
	gFD_CLOEXEC
)) {

380  
Stus
(

381 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

382 
ab¦
::
SŒC©
("Fú g‘ FD fÏg fÜ f", 
·th
,

383 "»tuºed uÃx³ùed„esuÉ: ", 
¡»¼Ü
(
”ºo
)));

387 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
·th
;

388 
size_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

389 ià(
	grc
 !ğ
mes§ge
.
size
()) {

390  
Stus
(

391 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

392 
ab¦
::
SŒC©
("Wr™tØfe:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

395 
	gdup_fd
 = 
fú
(
fd
, 
F_DUPFD
, -1);

396 ià(
	gdup_fd
 !ğ-1 || 
”ºo
 !ğ
EINVAL
) {

397  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

401 
cÚ¡ex´
 
	gkMaxO³nFes
 = 1024;

402 
	gdup_fd
 = 
fú
(
fd
, 
F_DUPFD
, 
kMaxO³nFes
);

403 ià(
	gdup_fd
 !ğ-1 || 
”ºo
 !ğ
EINVAL
) {

404  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

408 
	gdup_fd
 = 
fú
(
fd
, 
F_DUPFD
, fd);

409 ià(
	gdup_fd
 == -1) {

410  
Stus
(

411 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

412 
ab¦
::
SŒC©
("fú du°fd:", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

414 ià(
	gdup_fd
 <ğ
fd
) {

415  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

416 
ab¦
::
SŒC©
("fú du°fd:", 
dup_fd
,

417 " i sm®Ë¸thª o¸equ®Ø¬g:", 
fd
));

419  
Com·»Fes
(
fd
, 
dup_fd
, 
mes§ge
.
size
());

422 
Stus
 
RunMkdœTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

423 ià(
·th
.
em±y
()) {

424  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

428 
	g¡d
::
¡ršg
 
¿ndom_·th
 = "/dev/random";

429 ià(
mkdœ
(
¿ndom_·th
.
c_¡r
(), 0644) != -1) {

430  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

431 
ab¦
::
SŒC©
("Mkdir in„egistered„andom…ath:",

432 
¿ndom_·th
, "should be forbidden."));

435 ià(
mkdœ
(
·th
.
c_¡r
(), 0644) == -1) {

436  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

437 
ab¦
::
SŒC©
("Mkdœ:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

439  
	gStus
::
OkStus
();

442 
Stus
 
RunRmDœTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

443 ià(
·th
.
em±y
()) {

444  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

447 ià(
rmdœ
(
·th
.
c_¡r
()) != 0) {

448  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

449 
ab¦
::
SŒC©
("Rmdœ:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

451  
	gStus
::
OkStus
();

454 
Stus
 
RunDupTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

455 cÚ¡ 
¡d
::
¡ršg
 
mes§ge
 = 
·th
;

456 
	gfd
;

457 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

458 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

459 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

460 ià(
	grc
 !ğ
mes§ge
.
size
()) {

461  
Stus
(

462 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

463 
ab¦
::
SŒC©
("Wr™tØfe:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

467 
	gdup_fd
 = 
dup
(
fd
);

468 ià(
	gdup_fd
 == -1) {

469  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

470 
ab¦
::
SŒC©
("du°fd:", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

472 ià(
	gdup_fd
 =ğ
fd
) {

473  
Stus
(

474 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

475 
ab¦
::
SŒC©
("du°fd:", 
dup_fd
, " i th§ma Üigš® fd:", 
fd
));

477 
ASYLO_RETURN_IF_ERROR
(
Com·»Fes
(
fd
, 
dup_fd
, 
mes§ge
.
size
()));

480 
	gdup2_fd
 = 
dup2
(
fd
, 
dup_fd
);

481 ià(
	gdup2_fd
 !ğ
dup_fd
) {

482  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

483 
ab¦
::
SŒC©
("dup2 fd:", 
fd
, "Øfd:", 
dup_fd
,

484 " faed: ", 
¡»¼Ü
(
”ºo
)));

486 
ASYLO_RETURN_IF_ERROR
(
Com·»Fes
(
fd
, 
dup2_fd
, 
mes§ge
.
size
()));

489 
	gÃwfd
 = 1000;

490 
	gdup2_fd
 = 
dup2
(
fd
, 
Ãwfd
);

491 ià(
	gdup2_fd
 !ğ
Ãwfd
) {

492  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

493 
ab¦
::
SŒC©
("dup2 fd:", 
fd
, "Øfd:", 
Ãwfd
,

494 " faed: ", 
¡»¼Ü
(
”ºo
)));

496 
ASYLO_RETURN_IF_ERROR
(
Com·»Fes
(
fd
, 
dup2_fd
, 
mes§ge
.
size
()));

500 ià(
şo£
(
fd
) == -1) {

501  
Stus
(

502 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

503 
ab¦
::
SŒC©
("şo£ fd:", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

505 
	gbuf
[1024];

506 
	grc
 = 
»ad
(
Ãwfd
, 
buf
, (buf));

507 ià(
	grc
 >ğ(
buf
è|| 
rc
 < 0) {

508  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

509 
ab¦
::
SŒC©
("R—d from‚ewfd:", 
Ãwfd
,

510 " faed‡á” closšg fd: ", 
fd
,

511 "ƒ¼Ü:", 
¡»¼Ü
(
”ºo
)));

514  
	gStus
::
OkStus
();

517 
Stus
 
Com·»Fes
(
fd1
, 
fd2
, 
size
) {

518 ià(
l£ek
(
fd1
, 0, 
SEEK_SET
) == -1) {

519  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

520 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd1
,

521 " faed: ", 
¡»¼Ü
(
”ºo
)));

523 
	gbuf1
[1024];

524 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
fd1
, 
buf1
, 
size
));

526 ià(
l£ek
(
fd2
, 0, 
SEEK_SET
) == -1) {

527  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

528 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd2
,

529 " faed: ", 
¡»¼Ü
(
”ºo
)));

531 
	gbuf2
[1024];

532 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
fd2
, 
buf2
, 
size
));

534 ià(
memcmp
(
buf1
, 
buf2
, 
size
) != 0) {

535  
Stus
(

536 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

537 
ab¦
::
SŒC©
("Fd:", 
fd1
, "‡nd fd:", 
fd2
, "‡re different"));

539  
	gStus
::
OkStus
();

542 
Stus
 
RunG‘Ho¡NameTe¡
(
EnşaveOuut
 *
ouut
) {

543 
	gbuf
[1024];

544 ià(
g‘ho¡Çme
(
buf
, (buf)) == -1) {

545  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

546 
ab¦
::
SŒC©
("g‘ho¡Çmçed:", 
¡»¼Ü
(
”ºo
)));

548 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

549 
	gouut_»t
.
£t_¡ršg_sysÿÎ_»tuº
(
¡d
::
¡ršg
(
buf
));

550 ià(
	gouut
) {

551 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

553  
	gStus
::
OkStus
();

556 
Stus
 
RunLškTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

557 ià(
·th
.
em±y
()) {

558  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

560 cÚ¡ 
	g¡d
::
¡ršg
 
äom_·th
 = 
¡d
::¡ršg(
·th
) + "from";

561 cÚ¡ 
	g¡d
::
¡ršg
 
to_·th
 = 
¡d
::¡ršg(
·th
) + "to";

562 
	gäom_fd
;

563 
ASYLO_ASSIGN_OR_RETURN
(
äom_fd
,

564 
O³nFe
(
äom_·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

566 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
äom_fd_şo£r
(
äom_fd
);

567 
size_t
 
	grc
 = 
wr™e
(
äom_fd
, 
·th
.
c_¡r
(),…©h.
size
());

568 ià(
	grc
 !ğ
·th
.
size
()) {

569  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

570 
ab¦
::
SŒC©
("FaedØwr™tØfe:", 
äom_·th
,

571 "ƒ¼Ü:", 
¡»¼Ü
(
”ºo
)));

573 ià(
lšk
(
äom_·th
.
c_¡r
(), 
to_·th
.c_str()) == -1) {

574  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

575 
ab¦
::
SŒC©
("Lšk…©h ", 
äom_·th
, "Ø", 
to_·th
,

576 " faed: ", 
¡»¼Ü
(
”ºo
)));

578 
	gto_fd
;

579 
ASYLO_ASSIGN_OR_RETURN
(
to_fd
, 
O³nFe
(
to_·th
, 
O_RDWR
, 0));

580 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
to_fd_şo£r
(
to_fd
);

582 
	gbuf
[1024];

583 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
to_fd
, 
buf
, 
·th
.
size
()));

584 ià(
memcmp
(
buf
, 
·th
.
c_¡r
(),…©h.
size
()) != 0) {

585  
Stus
(

586 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

587 
ab¦
::
SŒC©
("ThcÚ‹Á:", 
buf
, " from†šked…©h:", 
to_·th
,

588 " i difã»Á fromhÜigš®…©h:", 
äom_·th
));

590  
	gStus
::
OkStus
();

593 
Stus
 
RunG‘CwdTe¡
(
boŞ
 
´ovide_bufãr
, 
št32_t
 
bufãr_size
,

594 
EnşaveOuut
 *
ouut
) {

595 
	g¡ack_bufãr
[
PATH_MAX
];

596 *
	gbuf
 = 
g‘cwd
(
´ovide_bufãr
 ? 
¡ack_bufãr
 : 
nuÎ±r
,

597 
¡d
::
mš
(
bufãr_size
, 
PATH_MAX
));

598 ià(!
	gbuf
) {

599  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

600 
ab¦
::
SŒC©
("g‘cwd faed:", 
¡»¼Ü
(
”ºo
)));

602 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

603 
	gouut_»t
.
£t_¡ršg_sysÿÎ_»tuº
(
¡d
::
¡ršg
(
buf
));

604 ià(
	gouut
) {

605 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

607  
	gStus
::
OkStus
();

610 
Stus
 
RunUmaskTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

611 
umask
(
S_IWGRP
 | 
S_IWOTH
);

612 ià(
mkdœ
(
·th
.
c_¡r
(), 0777) == -1) {

613  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

614 
ab¦
::
SŒC©
("mkdœ faed:", 
¡»¼Ü
(
”ºo
)));

616 
¡©
 
	g¡
;

617 ià(
¡©
(
·th
.
c_¡r
(), &
¡
) == -1) {

618  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

619 
ab¦
::
SŒC©
("¡© faed:", 
¡»¼Ü
(
”ºo
)));

621 ià(
	g¡
.
	g¡_mode
 & 
	gS_IWGRP
 || st.¡_mod& 
	gS_IWOTH
) {

622  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

625 cÚ¡ 
	g¡d
::
¡ršg
 
fe_·th
 = 
·th
 + "OpenWithUmask";

626 
	gfd
;

627 
ASYLO_ASSIGN_OR_RETURN
(
fd
,

628 
O³nFe
(
fe_·th
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0777));

629 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

630 ià(
f¡©
(
fd
, &
¡
) == -1) {

631  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

632 
ab¦
::
SŒC©
("f¡© faed:", 
¡»¼Ü
(
”ºo
)));

634 ià(
	g¡
.
	g¡_mode
 & 
	gS_IWGRP
 || st.¡_mod& 
	gS_IWOTH
) {

635  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

638  
	gStus
::
OkStus
();

641 
Stus
 
RunG‘UidTe¡
(
EnşaveOuut
 *
ouut
) {

642 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

643 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘uid
());

644 ià(
	gouut
) {

645 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

647  
	gStus
::
OkStus
();

650 
Stus
 
RunG‘EuidTe¡
(
EnşaveOuut
 *
ouut
) {

651 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

652 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘euid
());

653 ià(
	gouut
) {

654 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

656  
	gStus
::
OkStus
();

659 
Stus
 
RunG‘GidTe¡
(
EnşaveOuut
 *
ouut
) {

660 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

661 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘gid
());

662 ià(
	gouut
) {

663 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

665  
	gStus
::
OkStus
();

668 
Stus
 
RunG‘EgidTe¡
(
EnşaveOuut
 *
ouut
) {

669 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

670 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘egid
());

671 ià(
	gouut
) {

672 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

674  
	gStus
::
OkStus
();

677 
Stus
 
RunG‘PpidTe¡
(
EnşaveOuut
 *
ouut
) {

678 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

679 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘µid
());

680 ià(
	gouut
) {

681 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

683  
	gStus
::
OkStus
();

686 
Stus
 
RunSchedG‘Affš™yTe¡
(
EnşaveOuut
 *
ouut
) {

687 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

688 
pid_t
 
	gmy_pid
 = 
g‘pid
();

689 
ıu_£t_t
 
	gmask
;

691 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(

692 
sched_g‘affš™y
(
my_pid
, (
ıu_£t_t
), &
mask
));

693 
	gouut_»t
.
ş—r_b™_mask_sysÿÎ_ouŒ
();

696 
EncodeCpuS‘InTe¡Ouut
(
mask
, &
ouut_»t
);

698 ià(
	gouut
) {

699 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

701  
	gStus
::
OkStus
();

704 
Stus
 
RunSchedG‘Affš™yFau»Te¡
(
EnşaveOuut
 *
ouut
) {

705 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

706 
pid_t
 
	gmy_pid
 = 
g‘pid
();

707 
ıu_£t_t
 
	gmask
;

708 
size_t
 
	gbad_ıu_£t_size
 = (
ıu_£t_t
) / 2;

710 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(

711 
sched_g‘affš™y
(
my_pid
, 
bad_ıu_£t_size
, &
mask
));

713 
EncodeE¼noV®ueInTe¡Ouut
(
”ºo
, &
ouut_»t
);

715 ià(
	gouut
) {

716 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

718  
	gStus
::
OkStus
();

721 
Stus
 
RunCpuS‘MaüosTe¡
(
EnşaveOuut
 *
ouut
) {

722 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

723 
ıu_£t_t
 
	gmask
;

726 
CPU_ZERO
(&
mask
);

727 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

728 ià(
CPU_ISSET
(
ıu
, &
mask
)) {

729  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

730 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is set‡fter CPU_ZERO."));

737 cÚ¡ 
	gab¦
::
æ©_hash_£t
<> 
‹¡_ıu_£t_ıus
(

739 
CPU_ZERO
(&
mask
);

740 
	gıu
 : 
‹¡_ıu_£t_ıus
) {

741 
CPU_SET
(
ıu
, &
mask
);

743 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

744 ià(!
CPU_ISSET
(
ıu
, &
mask
è&& 
	g‹¡_ıu_£t_ıus
.
couÁ
(cpu)) {

745  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

746 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is‚ot set‡fter CPU_SET."));

747 } ià(
CPU_ISSET
(
ıu
, &
mask
è&& !
	g‹¡_ıu_£t_ıus
.
couÁ
(cpu)) {

748  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

749 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is set without CPU_SET."));

757 cÚ¡ 
	gab¦
::
æ©_hash_£t
<> 
‹¡_ıu_şr_ıus_to_£t
(

759 cÚ¡ 
	gab¦
::
æ©_hash_£t
<> 
‹¡_ıu_şr_ıus_to_ş—r
({2, 5, 132});

760 
CPU_ZERO
(&
mask
);

761 
	gıu
 : 
‹¡_ıu_şr_ıus_to_£t
) {

762 
CPU_SET
(
ıu
, &
mask
);

764 
	gıu
 : 
‹¡_ıu_şr_ıus_to_ş—r
) {

765 
CPU_CLR
(
ıu
, &
mask
);

767 
	gıu
 : 
‹¡_ıu_şr_ıus_to_£t
) {

768 ià(
CPU_ISSET
(
ıu
, &
mask
è&& 
	g‹¡_ıu_şr_ıus_to_ş—r
.
couÁ
(cpu)) {

769  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

770 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is set‡fter CPU_CLR."));

771 } ià(!
CPU_ISSET
(
ıu
, &
mask
) &&

772 !
	g‹¡_ıu_şr_ıus_to_ş—r
.
couÁ
(
ıu
)) {

773  
Stus
(

774 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

775 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is‚ot set without CPU_CLR."));

781 
CPU_ZERO
(&
mask
);

782 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

783 ià(
	gıu
 % 10 =ğ1 || 
ıu
 % 10 == 3 || cpu % 10 == 7 || cpu % 10 == 9) {

784 
CPU_SET
(
ıu
, &
mask
);

787 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

788 
boŞ
 
	gex³ùed_v®ue
 =

789 (
ıu
 % 10 == 1 || cpu % 10 == 3 || cpu % 10 == 7 || cpu % 10 == 9);

790 ià(
	g¡©ic_ÿ¡
<
	gboŞ
>(
CPU_ISSET
(
ıu
, &
mask
)è!ğ
ex³ùed_v®ue
) {

791  
Stus
(

792 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

793 
ab¦
::
SŒC©
("CPU_ISSET(", 
ıu
, "è»tuº ", !
ex³ùed_v®ue
,

794 "buˆshould„‘uº ", 
ex³ùed_v®ue
, "."));

800 cÚ¡ 
	g‹¡_ıu_couÁ_ıus
[] = {1, 2, 5, 14, 42, 132, 429};

801 cÚ¡ 
	g‹¡_ıu_couÁ_ex³ùed_couÁ
 = 7;

802 
CPU_ZERO
(&
mask
);

803 
	gıu
 : 
‹¡_ıu_couÁ_ıus
) {

804 
CPU_SET
(
ıu
, &
mask
);

806 cÚ¡ 
	gıu_couÁ
 = 
CPU_COUNT
(&
mask
);

807 ià(
	gıu_couÁ
 !ğ
‹¡_ıu_couÁ_ex³ùed_couÁ
) {

808  
Stus
(

809 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

810 
ab¦
::
SŒC©
("CPU_COUNT„‘uº ", 
ıu_couÁ
, " but should„eturn ",

811 
‹¡_ıu_couÁ_ex³ùed_couÁ
, "."));

815 cÚ¡ 
	g‹¡_ıu_equ®_ıus
[] = {1, 2, 5, 14, 42, 132, 429};

816 cÚ¡ 
	g‹¡_ıu_equ®_ıus_difã»Á
[] = {1, 2, 3, 6, 11,

818 
CPU_ZERO
(&
mask
);

819 
	gıu
 : 
‹¡_ıu_equ®_ıus
) {

820 
CPU_SET
(
ıu
, &
mask
);

822 ià(!
CPU_EQUAL
(&
mask
, &mask)) {

823  
Stus
(

824 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

825 
ab¦
::
SŒC©
("CPU_EQUAL claims‡ mask is‚otƒqualo itself."));

828 
ıu_£t_t
 
	gdifã»Á_mask
;

829 
CPU_ZERO
(&
difã»Á_mask
);

830 
	gıu
 : 
‹¡_ıu_equ®_ıus_difã»Á
) {

831 
CPU_SET
(
ıu
, &
difã»Á_mask
);

833 ià(
CPU_EQUAL
(&
mask
, &
difã»Á_mask
)) {

834  
Stus
(

835 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

836 
ab¦
::
SŒC©
("CPU_EQUAL claimswo different masks‡reƒqual."));

839 ià(
	gouut
) {

840 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

842  
	gStus
::
OkStus
();

845 
Stus
 
RunStTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
EnşaveOuut
 *
ouut
) {

846 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

848 
¡©
 
	g¡©_bufãr
;

849 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
¡©
(
·th
.
c_¡r
(), &
¡©_bufãr
));

851 
EncodeStBufãrInTe¡Ouut
(
¡©_bufãr
, &
ouut_»t
);

853 ià(
	gouut
) {

854 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

856  
	gStus
::
OkStus
();

859 
Stus
 
RunFStTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
EnşaveOuut
 *
ouut
) {

860 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

862 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDONLY
);

863 ià(
	gfd
 == -1) {

864  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

865 
ab¦
::
SŒC©
("İ’ faed:", 
¡»¼Ü
(
”ºo
)));

868 
¡©
 
	g¡©_bufãr
;

869 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
f¡©
(
fd
, &
¡©_bufãr
));

871 ià(
şo£
(
fd
) == -1) {

872  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

873 
ab¦
::
SŒC©
("şo£ faed:", 
¡»¼Ü
(
”ºo
)));

876 
EncodeStBufãrInTe¡Ouut
(
¡©_bufãr
, &
ouut_»t
);

878 ià(
	gouut
) {

879 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

881  
	gStus
::
OkStus
();

884 
Stus
 
RunLStTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
EnşaveOuut
 *
ouut
) {

885 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

887 
¡©
 
	g¡©_bufãr
;

888 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
l¡©
(
·th
.
c_¡r
(), &
¡©_bufãr
));

890 
EncodeStBufãrInTe¡Ouut
(
¡©_bufãr
, &
ouut_»t
);

892 ià(
	gouut
) {

893 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

895  
	gStus
::
OkStus
();

898 
Stus
 
RunUÇmeTe¡
(
EnşaveOuut
 *
ouut
) {

899 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

900 
ut¢ame
 
	gut¢ame_buf
;

902 
	g»t
 = 
uÇme
(&
ut¢ame_buf
);

903 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
»t
);

905 ià(
	g»t
 == 0) {

906 
EncodeUtsNameInTe¡Ouut
(
ut¢ame_buf
, &
ouut_»t
);

908 
EncodeE¼noV®ueInTe¡Ouut
(
”ºo
, &
ouut_»t
);

911 ià(
	gouut
) {

912 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

914  
	gStus
::
OkStus
();

917 
Stus
 
RunWr™evTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

918 
fd
;

919 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

920 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

921 
cÚ¡ex´
 
	gnum_mes§ges
 = 2;

922 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge1
 = "First writev message";

923 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge2
 = "Second writev message";

924 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
mes§ge1
 + 
mes§ge2
;

925 
iovec
 
	giov
[
num_mes§ges
];

926 
mem£t
(
iov
, 0, (iov));

927 
	giov
[0].
	giov_ba£
 = 
cÚ¡_ÿ¡
<*>(
mes§ge1
.
c_¡r
());

928 
	giov
[1].
	giov_ba£
 = 
cÚ¡_ÿ¡
<*>(
mes§ge2
.
c_¡r
());

929 
	giov
[0].
	giov_Ën
 = 
mes§ge1
.
size
();

930 
	giov
[1].
	giov_Ën
 = 
mes§ge2
.
size
();

931 
	gsize
 = 
mes§ge
.
size
();

932 
ssize_t
 
	grc
 = 
wr™ev
(
fd
, 
iov
, 
num_mes§ges
);

933 ià(
	grc
 !ğ
size
) {

934  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

935 
ab¦
::
SŒC©
("wr™ev„‘uº:", 
rc
,

936 " dÛ nÙ m©ch mes§gsize:", 
size
));

939 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

940  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

941 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

942 " faed: ", 
¡»¼Ü
(
”ºo
)));

945 
	gbuf
[1024];

946 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
fd
, 
buf
, 
size
));

947 ià(
memcmp
(
buf
, 
mes§ge
.
c_¡r
(), mes§ge.
size
()) != 0) {

948  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

949 
ab¦
::
SŒC©
("Mes§g»ad from fd:", 
fd
, ":", 
buf
,

952  
	gStus
::
OkStus
();

955 
Stus
 
RunR—dvTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

956 
fd
;

957 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

958 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

959 
cÚ¡ex´
 
	gnum_mes§ges
 = 2;

960 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge1
 = "First„eadv message";

961 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge2
 = "Second„eadv message";

962 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
mes§ge1
 + 
mes§ge2
;

963 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

964 ià(
	grc
 !ğ
mes§ge
.
size
()) {

965  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

968 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

969  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

970 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

971 " faed: ", 
¡»¼Ü
(
”ºo
)));

973 
iovec
 
	giov
[
num_mes§ges
];

974 
mem£t
(
iov
, 0, (iov));

975 
	gbuf1
[
mes§ge1
.
size
()];

976 
	gbuf2
[
mes§ge2
.
size
()];

977 
	giov
[0].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf1
);

978 
	giov
[1].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf2
);

979 
	giov
[0].
	giov_Ën
 = 
mes§ge1
.
size
();

980 
	giov
[1].
	giov_Ën
 = 
mes§ge2
.
size
();

981 
	grc
 = 
»adv
(
fd
, 
iov
, 
num_mes§ges
);

982 ià(
	grc
 !ğ
mes§ge
.
size
()) {

983  
Stus
(

984 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

985 
ab¦
::
SŒC©
("»adv„‘uº:", 
rc
,

986 " dÛ nÙ m©ch mes§gsize:", 
mes§ge
.
size
()));

988 ià(
memcmp
(
»š‹½»t_ÿ¡
<*>(
iov
[0].
iov_ba£
), 
mes§ge1
.
c_¡r
(),

989 
iov
[0].
iov_Ën
) ||

990 
memcmp
(
»š‹½»t_ÿ¡
<*>(
iov
[1].
iov_ba£
), 
mes§ge2
.
c_¡r
(),

991 
iov
[1].
iov_Ën
)) {

992  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

995  
	gStus
::
OkStus
();

998 
Stus
 
RunRlim™NoFeTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

999 
cÚ¡ex´
 
soá_lim™
 = 100;

1000 
cÚ¡ex´
 
	gh¬d_lim™
 = 200;

1001 
¾im™
 
	g£t_lim™
;

1002 
	g£t_lim™
.
	g¾im_cur
 = 
soá_lim™
;

1003 
	g£t_lim™
.
	g¾im_max
 = 
h¬d_lim™
;

1004 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != 0) {

1005  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1006 
ab¦
::
SŒC©
("£Œlim™ faed:", 
¡»¼Ü
(
”ºo
)));

1008 
¾im™
 
	gg‘_lim™
;

1009 ià(
g‘¾im™
(
RLIMIT_NOFILE
, &
g‘_lim™
) != 0) {

1010  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1011 
ab¦
::
SŒC©
("g‘¾im™ faed:", 
¡»¼Ü
(
”ºo
)));

1013 ià(
	gg‘_lim™
.
	g¾im_cur
 !ğ
soá_lim™
 || 
g‘_lim™
.
¾im_max
 !ğ
h¬d_lim™
) {

1014  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1018  
	gStus
::
OkStus
();

1021 
Stus
 
RunRlim™LowNoFeTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1022 
cÚ¡ex´
 
fe_desütÜ_u£d
 = 3;

1023 
¾im™
 
	g£t_lim™
;

1026 
	g£t_lim™
.
	g¾im_cur
 = 
fe_desütÜ_u£d
;

1027 
	g£t_lim™
.
	g¾im_max
 = 
fe_desütÜ_u£d
;

1028 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != 0) {

1029  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1030 
ab¦
::
SŒC©
("£Œlim™ faed:", 
¡»¼Ü
(
”ºo
)));

1032 autØ
	gfd_Ü_”rÜ
 = 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644);

1033 ià(
	gfd_Ü_”rÜ
.
ok
()) {

1034  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1035 
ab¦
::
SŒC©
("FdesütÜ: ", 
fd_Ü_”rÜ
.
V®ueOrD›
(),

1037 
fe_desütÜ_u£d
));

1039  
	gStus
::
OkStus
();

1042 
Stus
 
RunRlim™Inv®idNoFeTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1043 
¾im™
 
g‘_lim™
;

1044 ià(
g‘¾im™
(
RLIMIT_NOFILE
, &
g‘_lim™
) != 0) {

1045  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1046 
ab¦
::
SŒC©
("g‘¾im™ faed:", 
¡»¼Ü
(
”ºo
)));

1048 
	gŞd_soá_lim™
 = 
g‘_lim™
.
¾im_cur
;

1049 
	gŞd_h¬d_lim™
 = 
g‘_lim™
.
¾im_max
;

1051 
cÚ¡ex´
 
	gšv®id_lim™
 = 2;

1052 
¾im™
 
	g£t_lim™
;

1053 
	g£t_lim™
.
	g¾im_cur
 = 
šv®id_lim™
;

1054 
	g£t_lim™
.
	g¾im_max
 = 
šv®id_lim™
;

1057 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1058  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1063 ià(
g‘¾im™
(
RLIMIT_NOFILE
, &
g‘_lim™
) != 0) {

1064  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1065 
ab¦
::
SŒC©
("g‘¾im™ faed:", 
¡»¼Ü
(
”ºo
)));

1069 
	g£t_lim™
.
	g¾im_cur
 = 200;

1070 
	g£t_lim™
.
	g¾im_max
 = 100;

1071 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1072  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1079 
	g£t_lim™
.
	g¾im_cur
 = 2000;

1080 
	g£t_lim™
.
	g¾im_max
 = 2000;

1081 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1082  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1087 ià(
	gg‘_lim™
.
	g¾im_cur
 !ğ
Şd_soá_lim™
 ||

1088 
g‘_lim™
.
¾im_max
 !ğ
Şd_h¬d_lim™
) {

1089  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1090 
ab¦
::
SŒC©
("NOFILE†imit has changed‡fter‡ series of"

1092 
Şd_soá_lim™
,

1093 " cu¼’ˆsoá†im™: ", 
g‘_lim™
.
¾im_cur
,

1094 " origš® h¬d†im™: ", 
Şd_h¬d_lim™
,

1095 " cu¼’ˆh¬d†im™: ", 
g‘_lim™
.
¾im_max
));

1100 
	g£t_lim™
.
	g¾im_cur
 = 100;

1101 
	g£t_lim™
.
	g¾im_max
 = 100;

1102 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != 0) {

1103  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1104 
ab¦
::
SŒC©
("£Œlim™ faed:", 
¡»¼Ü
(
”ºo
)));

1106 
	g£t_lim™
.
	g¾im_cur
 = 200;

1107 
	g£t_lim™
.
	g¾im_max
 = 200;

1108 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1109  
Stus
(

1110 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1114  
	gStus
::
OkStus
();

1117 
Stus
 
RunChModTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1118 ià(
chmod
(
·th
.
c_¡r
(), 0644) != 0) {

1119  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1120 
ab¦
::
SŒC©
("chmod faed: ", 
¡»¼Ü
(
”ºo
)));

1122  
	gStus
::
OkStus
();

1125 
Stus
 
RunFChModTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1126 
fd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 0777);

1127 ià(
	gfd
 < 0) {

1128  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1129 
ab¦
::
SŒC©
("çedØİ’ fe: ", 
¡»¼Ü
(
”ºo
)));

1132 ià(
fchmod
(
fd
, 0644) != 0) {

1133  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1134 
ab¦
::
SŒC©
("fchmod faed: ", 
¡»¼Ü
(
”ºo
)));

1136  
	gStus
::
OkStus
();

1139 
Stus
 
RunG‘IfAddrsTe¡
(
EnşaveOuut
 *
ouut
) {

1140 
içddrs
 *
	gäÚt
 = 
nuÎ±r
;

1141 
	g»t
 = 
g‘içddrs
(&
äÚt
);

1142 *
	g£rŸlized_içddrs
 = 
nuÎ±r
;

1143 
size_t
 
	gËn
;

1144 
	gasylo
::
S”ŸlizeIfAddrs
(
äÚt
, &
£rŸlized_içddrs
, &
Ën
);

1145 
ä“içddrs
(
äÚt
);

1146 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

1147 
	gouut_»t
.
£t_£rŸlized_´Ùo_»tuº
(

1148 
¡d
::
¡ršg
(
£rŸlized_içddrs
, 
Ën
));

1149 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
»t
);

1150 ià(
	gouut
) {

1151 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

1153  
	gStus
::
OkStus
();

1156 
Stus
 
Ex³ùE¼no
(
ex³ùed_”ºo
, 
»tv®
) {

1157 
	g§ved_”ºo
 = 
”ºo
;

1159 ià(
	g»tv®
 != -1) {

1160  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1161 
ab¦
::
SŒC©
("Ex³ùed„‘v® oà-1, gÙ ", 
»tv®
));

1164 ià(
	g§ved_”ºo
 !ğ
ex³ùed_”ºo
) {

1165  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1166 
ab¦
::
SŒC©
("Ex³ùedƒ¼nØoà", 
ex³ùed_”ºo
, "; got ",

1167 
§ved_”ºo
));

1170  
	gStus
::
OkStus
();

1175 
Stus
 
RunG‘SockÇmeTe¡_SUCCESS
() {

1176 
sockaddr
 
	g§
;

1177 
sockËn_t
 
	g§_Ën
 = (
§
);

1179 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

1181 ià(
	gfd
 < 0) {

1182  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1183 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1186 ià(
g‘sockÇme
(
fd
, &
§
, &
§_Ën
) != 0) {

1187  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1190  
	gStus
::
OkStus
();

1193 
Stus
 
RunG‘SockÇmeFau»Te¡_EBADF
() {

1194 
sockaddr
 
	g§
;

1195 
sockËn_t
 
	g§_Ën
 = (
§
);

1197  
Ex³ùE¼no
(
EBADF
, 
g‘sockÇme
(-1, &
§
, &
§_Ën
));

1201 
Stus
 
RunG‘SockÇmeFau»Te¡_EFAULT
() {

1202 
sockaddr
 
	g§
;

1203 
sockËn_t
 
	g§_Ën
 = (
§
);

1205 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1207 ià(
	gfd
 < 0) {

1208  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1209 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1212  
Ex³ùE¼no
(
EFAULT
, 
g‘sockÇme
(
fd
, 
nuÎ±r
, &
§_Ën
));

1216 
Stus
 
RunG‘SockÇmeFau»Te¡_EINVAL
() {

1217 
sockaddr
 
	g§
;

1218 
sockËn_t
 
	g§_Ën
 = -1;

1219 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1221 ià(
	gfd
 < 0) {

1222  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1223 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1226  
Ex³ùE¼no
(
EINVAL
, 
g‘sockÇme
(
fd
, &
§
, &
§_Ën
));

1230 
Stus
 
RunG‘SockÇmeFau»Te¡_ENOTSOCK
() {

1231 
	gfds
[2];

1232 
	g»t
 = 
pe
(
fds
);

1233 ià(
	g»t
 != 0) {

1234  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1238 
sockaddr
 
	g§
;

1239 
sockËn_t
 
	g§_Ën
 = (
§
);

1240  
Ex³ùE¼no
(
ENOTSOCK
, 
g‘sockÇme
(
fds
[0], &
§
, &
§_Ën
));

1246 
Stus
 
RunG‘P“ºameFau»Te¡_EBADF
() {

1247 
sockaddr
 
	g§
;

1248 
sockËn_t
 
	g§_Ën
 = (
§
);

1250  
Ex³ùE¼no
(
EBADF
, 
g‘³”Çme
(-1, &
§
, &
§_Ën
));

1254 
Stus
 
RunG‘P“ºameFau»Te¡_EFAULT
() {

1255 
sockaddr
 
	g§
;

1256 
sockËn_t
 
	g§_Ën
 = (
§
);

1258 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1260 ià(
	gfd
 < 0) {

1261  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1262 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1265  
Ex³ùE¼no
(
EFAULT
, 
g‘³”Çme
(
fd
, 
nuÎ±r
, &
§_Ën
));

1269 
Stus
 
RunG‘P“ºameFau»Te¡_EINVAL
() {

1270 
sockaddr
 
	g§
;

1271 
sockËn_t
 
	g§_Ën
 = -1;

1272 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1274 ià(
	gfd
 < 0) {

1275  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1276 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1279  
Ex³ùE¼no
(
EINVAL
, 
g‘³”Çme
(
fd
, &
§
, &
§_Ën
));

1283 
Stus
 
RunG‘P“ºameFau»Te¡_ENOTCONN
() {

1284 
sockaddr
 
	g§
;

1285 
sockËn_t
 
	g§_Ën
 = (
§
);

1286 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1288 ià(
	gfd
 < 0) {

1289  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1290 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1293  
Ex³ùE¼no
(
ENOTCONN
, 
g‘³”Çme
(
fd
, &
§
, &
§_Ën
));

1297 
Stus
 
RunG‘P“ºameFau»Te¡_ENOTSOCK
() {

1298 
	gfds
[2];

1299 
	g»t
 = 
pe
(
fds
);

1300 ià(
	g»t
 != 0) {

1301  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1305 
sockaddr
 
	g§
;

1306 
sockËn_t
 
	g§_Ën
 = (
§
);

1307  
Ex³ùE¼no
(
ENOTSOCK
, 
g‘³”Çme
(
fds
[0], &
§
, &
§_Ën
));

1310 
Stus
 
RunTrunÿ‹Te¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1311 
fd
;

1312 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

1313 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

1314 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge1
 = "First message ";

1315 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge2
 = "Second message ";

1316 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge3
 = "Third message";

1317 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
mes§ge1
 + 
mes§ge2
 + 
mes§ge3
;

1318 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

1319 ià(
	grc
 !ğ
mes§ge
.
size
()) {

1320  
Stus
(

1321 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1322 
ab¦
::
SŒC©
("wr™»tuºs: ", 
rc
,

1323 " dÛ nÙ m©ch mes§gsize: ", 
mes§ge
.
size
()));

1328 
	g¡d
::
¡ršg
 
Œunÿ‹d_mes§ge
 = 
mes§ge1
 + 
mes§ge2
;

1329 ià(
Œunÿ‹
(
·th
.
c_¡r
(), 
Œunÿ‹d_mes§ge
.
size
()) != 0) {

1330  
Stus
(

1331 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1332 
ab¦
::
SŒC©
("Trunÿ‹ fe: ", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

1334 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

1335  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

1336 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

1337 " faed: ", 
¡»¼Ü
(
”ºo
)));

1339 
	gbuf1
[1024];

1340 
	grc
 = 
»ad
(
fd
, 
buf1
, 
mes§ge
.
size
());

1341 ià(
	grc
 !ğ
Œunÿ‹d_mes§ge
.
size
() ||

1342 
memcmp
(
buf1
, 
Œunÿ‹d_mes§ge
.
c_¡r
(),runÿ‹d_mes§ge.
size
()) !=

1344  
Stus
(

1345 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1346 
ab¦
::
SŒC©
("Mes§g»ad fromrunÿ‹d fis: ", 
buf1
,

1347 "‡nd dÛ nÙ m©chƒx³ùed: ", 
Œunÿ‹d_mes§ge
));

1351 
	gŒunÿ‹d_mes§ge
 = 
mes§ge1
;

1352 ià(
árunÿ‹
(
fd
, 
Œunÿ‹d_mes§ge
.
size
()) != 0) {

1353  
Stus
(

1354 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1355 
ab¦
::
SŒC©
("FŒunÿ‹ fe: ", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

1357 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

1358  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

1359 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

1360 " faed: ", 
¡»¼Ü
(
”ºo
)));

1362 
	gbuf2
[1024];

1363 
	grc
 = 
»ad
(
fd
, 
buf2
, 
mes§ge
.
size
());

1364 ià(
	grc
 !ğ
Œunÿ‹d_mes§ge
.
size
() ||

1365 
memcmp
(
buf2
, 
Œunÿ‹d_mes§ge
.
c_¡r
(),runÿ‹d_mes§ge.
size
()) !=

1367  
Stus
(

1368 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1369 
ab¦
::
SŒC©
("Mes§g»ad fromrunÿ‹d fis: ", 
buf1
,

1370 "‡nd dÛ nÙ m©chƒx³ùed: ", 
Œunÿ‹d_mes§ge
));

1372  
	gStus
::
OkStus
();

1375 
Stus
 
RunMm­Te¡
() {

1377 *
	g±r
 = 
mm­
(
nuÎ±r
, 10000, 
PROT_READ
 | 
PROT_WRITE
,

1378 
MAP_ANONYMOUS
 | 
MAP_PRIVATE
, -1, 0);

1379 ià(
	g±r
 =ğ
MAP_FAILED
) {

1380  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1383 
šŒ_t
 
	gadd»ss
 = 
»š‹½»t_ÿ¡
<šŒ_t>(
±r
);

1384 ià((
	gadd»ss
 & 4095) != 0) {

1385  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1388 *
	gıŒ
 = 
¡©ic_ÿ¡
<*>(
±r
);

1389 ià(
	g¡d
::
couÁ
(
ıŒ
, cptr + 10000, '\0') != 10000) {

1390  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1393 ià(
munm­
(
±r
, 10000) != 0) {

1394  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1397  
	gStus
::
OkStus
();

1400 
Stus
 
RunItim”Te¡
() {

1401 
™im”v®
 
	gtim”_v®
;

1402 
	gtim”_v®
.
	g™_š‹rv®
.
	gtv_£c
 = 100;

1403 
	gtim”_v®
.
	g™_š‹rv®
.
	gtv_u£c
 = 12;

1404 
	gtim”_v®
.
	g™_v®ue
.
	gtv_£c
 = 100;

1405 
	gtim”_v®
.
	g™_v®ue
.
	gtv_u£c
 = 0;

1408 ià(
£t™im”
(
ITIMER_REAL
, &
tim”_v®
, 
nuÎ±r
) != 0) {

1409 
³¼Ü
("setitimer");

1410  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 1");

1415 
™im”v®
 
	gtime_tl_Ãxt
;

1416 ià(
£t™im”
(
ITIMER_REAL
, &
tim”_v®
, &
time_tl_Ãxt
) != 0) {

1417 
³¼Ü
("setitimer");

1418  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 2");

1420 ià(
	gtime_tl_Ãxt
.
	g™_š‹rv®
.
	gtv_£c
 !ğ
tim”_v®
.
™_š‹rv®
.
tv_£c
 ||

1421 
time_tl_Ãxt
.
™_š‹rv®
.
tv_u£c
 !ğ
tim”_v®
.it_interval.tv_usec) {

1422  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 3");

1424 ià(
	gtime_tl_Ãxt
.
	g™_v®ue
.
	gtv_£c
 >ğ
tim”_v®
.
™_š‹rv®
.
tv_£c
) {

1425  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 4");

1429 
™im”v®
 
	gcu¼_v®
;

1430 ià(
g‘™im”
(
ITIMER_REAL
, &
cu¼_v®
) != 0) {

1431  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getitimer failure 1");

1433 ià(
	gcu¼_v®
.
	g™_š‹rv®
.
	gtv_£c
 !ğ
tim”_v®
.
™_š‹rv®
.
tv_£c
 ||

1434 
cu¼_v®
.
™_š‹rv®
.
tv_u£c
 !ğ
tim”_v®
.it_interval.tv_usec) {

1435  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getitimer failure 2");

1438  
	gStus
::
OkStus
();

1441 
Stus
 
RunR’ameTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1442 ià(
·th
.
em±y
()) {

1443  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

1447 
	gfd
 = 
İ’
((
·th
 + "/ŞdÇme").
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 0777);

1448 ià(
	gfd
 < 0) {

1449  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1450 
ab¦
::
SŒC©
("çedØü—‹ fš: ", 
·th
,

1451 ",ƒ¼Ü: ", 
¡»¼Ü
(
”ºo
)));

1453 
şo£
(
fd
);

1454 ià(
»Çme
((
·th
 + "/ŞdÇme").
c_¡r
(), (path + "/rename").c_str()) < 0) {

1455  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1456 
ab¦
::
SŒC©
("çedØ»Çmfš: ", 
·th
,

1457 ",ƒ¼Ü: ", 
¡»¼Ü
(
”ºo
)));

1460  
	gStus
::
OkStus
();

1463 
Stus
 
RunUtimesTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1464 ià(
·th
.
em±y
()) {

1465  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

1468 ià(
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 0777) < 0) {

1469  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1470 
ab¦
::
SŒC©
("çedØü—‹ fš: ", 
·th
,

1471 ",ƒ¼Ü: ", 
¡»¼Ü
(
”ºo
)));

1476 
timev®
 
	gtimes
[2];

1477 
g‘timeofday
(&
times
[0], 
nuÎ±r
);

1478 
g‘timeofday
(&
times
[1], 
nuÎ±r
);

1480 
ušt8_t
 
	g¿ndom_acûss_time_shiá
, 
	g¿ndom_modifiÿtiÚ_time_shiá
;

1481 
RAND_by‹s
(&
¿ndom_acûss_time_shiá
, (random_access_time_shift));

1482 
RAND_by‹s
(&
¿ndom_modifiÿtiÚ_time_shiá
,

1483 (
¿ndom_modifiÿtiÚ_time_shiá
));

1484 
	gtimes
[0].
	gtv_£c
 +ğ
¿ndom_acûss_time_shiá
;

1485 
	gtimes
[1].
	gtv_£c
 +ğ
¿ndom_modifiÿtiÚ_time_shiá
;

1487 ià(
utimes
(
·th
.
c_¡r
(), 
times
) != 0) {

1488  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1489 
ab¦
::
SŒC©
("utime çed: ", 
¡»¼Ü
(
”ºo
)));

1494 
¡©
 
	g¡©_bufãr
;

1495 ià(
¡©
(
·th
.
c_¡r
(), &
¡©_bufãr
) != 0) {

1496  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1497 
ab¦
::
SŒC©
("¡© faed: ", 
¡»¼Ü
(
”ºo
)));

1500 ià(
	g¡©_bufãr
.
	g¡_©ime
 !ğ
times
[0].
tv_£c
) {

1501  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1505 ià(
	g¡©_bufãr
.
	g¡_mtime
 !ğ
times
[1].
tv_£c
) {

1506  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1510  
	gStus
::
OkStus
();

1513 
Stus
 
RunG‘PWUidTe¡
(
EnşaveOuut
 *
ouut
) {

1514 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

1515 ià(!
EncodePassWdInTe¡Ouut
(
g‘pwuid
(
g‘uid
()), &
ouut_»t
)) {

1516  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1520 ià(
	gouut
) {

1521 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

1523  
	gStus
::
OkStus
();

1527 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
SysÿÎsEnşave
; 
	}
}

	@platform/posix/syscalls_test_enclave.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<içddrs.h
>

22 
	~<İ’s¦/¿nd.h
>

23 
	~<pwd.h
>

24 
	~<»gex.h
>

25 
	~<sched.h
>

26 
	~<¡dio.h
>

27 
	~<sys/mmª.h
>

28 
	~<sys/»sourû.h
>

29 
	~<sys/¡©.h
>

30 
	~<sys/uio.h
>

31 
	~<sys/ut¢ame.h
>

32 
	~<uni¡d.h
>

33 
	~<utime.h
>

35 
	~<®gÜ™hm
>

37 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

38 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

39 
	~"asylo/ut/loggšg.h
"

40 
	~"asylo/¶©fÜm/commÚ/bridge_´Ùo_£rŸliz”.h
"

41 
	~"asylo/¶©fÜm/posix/sysÿÎs_‹¡.pb.h
"

42 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

43 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

44 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

45 
	~"asylo/ut/¡©us_maüos.h
"

46 
	~"asylo/ut/¡©usÜ.h
"

48 
Çme¥aû
 
	gasylo
 {

51 şas 
	cSysÿÎsEnşave
 : 
public
 
EnşaveTe¡Ca£
 {

52 
public
:

53 
SysÿÎsEnşave
() = ;

55 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

56 ià(!
	gšput
.
HasEx‹nsiÚ
(
sysÿÎs_‹¡_šput
)) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

60 
SysÿÎsTe¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sysÿÎs_‹¡_šput
);

61 ià(!
	g‹¡_šput
.
has_‹¡_rg‘
()) {

62  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

66 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

67 ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sysconf(_SC_NPROCESSORS_CONF)") {

68  
RunSyscÚfTe¡
(
ouut
, 
_SC_NPROCESSORS_CONF
);

69 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sysconf(_SC_NPROCESSORS_ONLN)") {

70  
RunSyscÚfTe¡
(
ouut
, 
_SC_NPROCESSORS_ONLN
);

71 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sysconf(_SC_PAGESIZE)") {

72  
RunSyscÚfTe¡
(
ouut
, 
_SC_PAGESIZE
);

73 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpid") {

74  
RunG‘PidTe¡
(
ouut
);

75 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "unlink") {

76  
RunUÆškTe¡
(
‹¡_šput
.
·th_Çme
());

77 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "fcntl") {

78  
RunFúTe¡
(
‹¡_šput
.
·th_Çme
());

79 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "mkdir") {

80  
RunMkdœTe¡
(
‹¡_šput
.
·th_Çme
());

81 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rmdir") {

82  
RunRmDœTe¡
(
‹¡_šput
.
·th_Çme
());

83 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "dup") {

84  
RunDupTe¡
(
‹¡_šput
.
·th_Çme
());

85 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "gethostname") {

86  
RunG‘Ho¡NameTe¡
(
ouut
);

87 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "link") {

88  
RunLškTe¡
(
‹¡_šput
.
·th_Çme
());

89 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getcwd") {

90  
RunG‘CwdTe¡
(
‹¡_šput
.
´ovide_bufãr
(),

91 
‹¡_šput
.
bufãr_size
(), 
ouut
);

92 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "umask") {

93  
RunUmaskTe¡
(
‹¡_šput
.
·th_Çme
());

94 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getuid") {

95  
RunG‘UidTe¡
(
ouut
);

96 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "geteuid") {

97  
RunG‘EuidTe¡
(
ouut
);

98 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getgid") {

99  
RunG‘GidTe¡
(
ouut
);

100 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getegid") {

101  
RunG‘EgidTe¡
(
ouut
);

102 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getppid") {

103  
RunG‘PpidTe¡
(
ouut
);

104 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sched_getaffinity") {

105  
RunSchedG‘Affš™yTe¡
(
ouut
);

106 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "sched_getaffinity failure") {

107  
RunSchedG‘Affš™yFau»Te¡
(
ouut
);

108 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "CPU_SET macros") {

109  
RunCpuS‘MaüosTe¡
(
ouut
);

110 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "stat") {

111  
RunStTe¡
(
‹¡_šput
.
·th_Çme
(), 
ouut
);

112 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "fstat") {

113  
RunFStTe¡
(
‹¡_šput
.
·th_Çme
(), 
ouut
);

114 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "lstat") {

115  
RunLStTe¡
(
‹¡_šput
.
·th_Çme
(), 
ouut
);

116 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "uname") {

117  
RunUÇmeTe¡
(
ouut
);

118 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "writev") {

119  
RunWr™evTe¡
(
‹¡_šput
.
·th_Çme
());

120 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "readv") {

121  
RunR—dvTe¡
(
‹¡_šput
.
·th_Çme
());

122 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rlimit‚ofile") {

123  
RunRlim™NoFeTe¡
(
‹¡_šput
.
·th_Çme
());

124 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rlimit†ow‚ofile") {

125  
RunRlim™LowNoFeTe¡
(
‹¡_šput
.
·th_Çme
());

126 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rlimit invalid‚ofile") {

127  
RunRlim™Inv®idNoFeTe¡
(
‹¡_šput
.
·th_Çme
());

128 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "chmod") {

129  
RunChModTe¡
(
‹¡_šput
.
·th_Çme
());

130 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "fchmod") {

131  
RunFChModTe¡
(
‹¡_šput
.
·th_Çme
());

132 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getifaddrs") {

133  
RunG‘IfAddrsTe¡
(
ouut
);

134 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_success") {

135  
RunG‘SockÇmeTe¡_SUCCESS
();

136 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_ebadf") {

137  
RunG‘SockÇmeFau»Te¡_EBADF
();

138 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_efault") {

139  
RunG‘SockÇmeFau»Te¡_EFAULT
();

140 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_einval") {

141  
RunG‘SockÇmeFau»Te¡_EINVAL
();

142 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getsockname_enotsock") {

143  
RunG‘SockÇmeFau»Te¡_ENOTSOCK
();

144 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_ebadf") {

145  
RunG‘P“ºameFau»Te¡_EBADF
();

146 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_efault") {

147  
RunG‘P“ºameFau»Te¡_EFAULT
();

148 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_einval") {

149  
RunG‘P“ºameFau»Te¡_EINVAL
();

150 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_enotsock") {

151  
RunG‘P“ºameFau»Te¡_ENOTSOCK
();

152 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpeername_enotconn") {

153  
RunG‘P“ºameFau»Te¡_ENOTCONN
();

154 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "truncate") {

155  
RunTrunÿ‹Te¡
(
‹¡_šput
.
·th_Çme
());

156 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "mmap") {

157  
RunMm­Te¡
();

158 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "itimer") {

159  
RunItim”Te¡
();

160 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "rename") {

161  
RunR’ameTe¡
(
‹¡_šput
.
·th_Çme
());

162 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "utimes") {

163  
RunUtimesTe¡
(
‹¡_šput
.
·th_Çme
());

164 } ià(
	g‹¡_šput
.
‹¡_rg‘
() == "getpwuid") {

165  
RunG‘PWUidTe¡
(
ouut
);

168 
LOG
(
ERROR
) << "Failedo identifyestoƒxecute.";

170 
»gex_t
 
	g»gex
;

171 ià(
»gcomp
(&
»gex
, "", 0)) {

172  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "recompƒrror");

174 
»gä“
(&
»gex
);

176  
	gStus
::
OkStus
();

179 
	g´iv©e
:

180 
EncodeE¼noV®ueInTe¡Ouut
(
”ºo_v®ue
,

181 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

182 
	g‹¡_ouut
->
ş—r_”ºo_sysÿÎ_v®ue
();

183 
	g”ºo_v®ue
) {

185 
‹¡_ouut
->
£t_”ºo_sysÿÎ_v®ue
(
SysÿÎsTe¡Ouut
::
ERRNO_ZERO
);

187 
	gEINVAL
:

188 
‹¡_ouut
->
£t_”ºo_sysÿÎ_v®ue
(
SysÿÎsTe¡Ouut
::
ERRNO_EINVAL
);

191 
‹¡_ouut
->
£t_”ºo_sysÿÎ_v®ue
(
SysÿÎsTe¡Ouut
::
UNSUPPORTED
);

197 
EncodeCpuS‘InTe¡Ouut
(
ıu_£t_t
 &
mask
,

198 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

199 
	g‹¡_ouut
->
ş—r_b™_mask_sysÿÎ_ouŒ
();

200 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

201 
	gwÜd_num
 = 
ıu
 / (8 * (
ušt64_t
));

202 
	gb™_num
 = 
ıu
 % (8 * (
ušt64_t
));

203 ià(
	gb™_num
 == 0) {

204 
‹¡_ouut
->
add_b™_mask_sysÿÎ_ouŒ
(0);

206 ià(
CPU_ISSET
(
ıu
, &
mask
)) {

207 *
	g‹¡_ouut
->
mubË_b™_mask_sysÿÎ_ouŒ
()->
MubË
(
wÜd_num
) |=

208 
¡©ic_ÿ¡
<
ušt64_t
>(1è<< 
b™_num
;

215 
EncodeStBufãrInTe¡Ouut
(cÚ¡ 
¡©
 &
¡©_bufãr
,

216 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

217 
usšg
 
	ggoogË
::
´Ùobuf
::
št64
;

219 
	gSysÿÎsTe¡Ouut
::
StV®ue
 *
´Ùo_¡©_bufãr
 =

220 
‹¡_ouut
->
mubË_¡©_bufãr_sysÿÎ_»tuº
();

222 
	g´Ùo_¡©_bufãr
->
£t_¡_dev
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_dev
));

223 
	g´Ùo_¡©_bufãr
->
£t_¡_šo
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_šo
));

224 
	g´Ùo_¡©_bufãr
->
£t_¡_mode
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_mode
));

225 
	g´Ùo_¡©_bufãr
->
£t_¡_Æšk
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_Æšk
));

226 
	g´Ùo_¡©_bufãr
->
£t_¡_uid
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_uid
));

227 
	g´Ùo_¡©_bufãr
->
£t_¡_gid
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_gid
));

228 
	g´Ùo_¡©_bufãr
->
£t_¡_rdev
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_rdev
));

229 
	g´Ùo_¡©_bufãr
->
£t_¡_size
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_size
));

230 
	g´Ùo_¡©_bufãr
->
£t_¡_©ime_v®
(

231 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_©ime
));

232 
	g´Ùo_¡©_bufãr
->
£t_¡_mtime_v®
(

233 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_mtime
));

234 
	g´Ùo_¡©_bufãr
->
£t_¡_ùime_v®
(

235 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_ùime
));

236 
	g´Ùo_¡©_bufãr
->
£t_¡_blksize
(

237 
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_blksize
));

238 
	g´Ùo_¡©_bufãr
->
£t_¡_blocks
(
¡©ic_ÿ¡
<
št64
>(
¡©_bufãr
.
¡_blocks
));

243 
EncodeUtsNameInTe¡Ouut
(
ut¢ame
 &
ut¢ame_buf
,

244 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

245 
	gSysÿÎsTe¡Ouut
::
UtsName
 *
´Ùo_ut¢ame
 =

246 
‹¡_ouut
->
mubË_ut¢ame_sysÿÎ_»tuº
();

248 
	g´Ùo_ut¢ame
->
£t_sy¢ame
(
ut¢ame_buf
.
sy¢ame
,

249 (
ut¢ame_buf
.
sy¢ame
));

250 
	g´Ùo_ut¢ame
->
£t_nod’ame
(
ut¢ame_buf
.
nod’ame
,

251 (
ut¢ame_buf
.
nod’ame
));

252 
	g´Ùo_ut¢ame
->
£t_»Ëa£
(
ut¢ame_buf
.
»Ëa£
,

253 (
ut¢ame_buf
.
»Ëa£
));

254 
	g´Ùo_ut¢ame
->
£t_v”siÚ
(
ut¢ame_buf
.
v”siÚ
,

255 (
ut¢ame_buf
.
v”siÚ
));

256 
	g´Ùo_ut¢ame
->
£t_machše
(
ut¢ame_buf
.
machše
,

257 (
ut¢ame_buf
.
machše
));

258 
	g´Ùo_ut¢ame
->
£t_domašÇme
(
ut¢ame_buf
.
domašÇme
,

259 (
ut¢ame_buf
.
domašÇme
));

264 
boŞ
 
EncodePassWdInTe¡Ouut
(
·sswd
 *
·sswÜd
,

265 
SysÿÎsTe¡Ouut
 *
‹¡_ouut
) {

266 ià(!
	g·sswÜd
 || !
	g‹¡_ouut
) {

267  
	gçl£
;

270 
	gSysÿÎsTe¡Ouut
::
PassWd
 *
´Ùo_·sswd
 =

271 
‹¡_ouut
->
mubË_·sswd_sysÿÎ_»tuº
();

273 
	g´Ùo_·sswd
->
£t_pw_Çme
(
·sswÜd
->
pw_Çme
, 
¡¾’
(password->pw_name));

274 
	g´Ùo_·sswd
->
£t_pw_·sswd
(
·sswÜd
->
pw_·sswd
,

275 
¡¾’
(
·sswÜd
->
pw_·sswd
));

276 
	g´Ùo_·sswd
->
£t_pw_uid
(
·sswÜd
->
pw_uid
);

277 
	g´Ùo_·sswd
->
£t_pw_gid
(
·sswÜd
->
pw_gid
);

278 
	g´Ùo_·sswd
->
£t_pw_gecos
(
·sswÜd
->
pw_gecos
, 
¡¾’
(password->pw_gecos));

279 
	g´Ùo_·sswd
->
£t_pw_dœ
(
·sswÜd
->
pw_dœ
, 
¡¾’
(password->pw_dir));

280 
	g´Ùo_·sswd
->
£t_pw_sh–l
(
·sswÜd
->
pw_sh–l
, 
¡¾’
(password->pw_shell));

281  
	gŒue
;

284 
	gStusOr
<> 
O³nFe
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
æags
, 
mode_t
 
mode
) {

285 ià(
	g·th
.
em±y
()) {

286  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath isƒmpty");

288 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
æags
, 
mode
);

289 ià(
	gfd
 < 0) {

290  
Stus
(

291 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

292 
ab¦
::
SŒC©
("O³À·th ", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

294  
	gfd
;

297 
Stus
 
R—dFe
(
fd
, *
buf
, 
size
) {

298 
	g»ad_by‹s
 = 0;

299 
	g»ad_by‹s
 < 
	gsize
) {

300 
	grc
 = 
»ad
(
fd
, 
buf
 + 
»ad_by‹s
, 
size
 -„ead_bytes);

301 
	g»ad_by‹s
 +ğ
rc
;

302 ià(
	g»ad_by‹s
 > 
	gsize
 || 
	grc
 < 0) {

303  
Stus
(

304 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

305 
ab¦
::
SŒC©
("FaedØ»ad from fe,ƒ¼Ü:", 
¡»¼Ü
(
”ºo
)));

308 ià(
	g»ad_by‹s
 !ğ
size
) {

309  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

312  
	gStus
::
OkStus
();

315 
Stus
 
RunSyscÚfTe¡
(
EnşaveOuut
 *
ouut
, 
Çme
) {

316 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

317 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
syscÚf
(
Çme
));

318 ià(
	gouut
) {

319 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

321  
	gStus
::
OkStus
();

324 
Stus
 
RunG‘PidTe¡
(
EnşaveOuut
 *
ouut
) {

325 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

326 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘pid
());

327 ià(
	gouut
) {

328 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

330  
	gStus
::
OkStus
();

333 
Stus
 
RunUÆškTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

334 
fd
;

335 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

336 
şo£
(
fd
);

337 ià(
uÆšk
(
·th
.
c_¡r
()) == -1) {

338  
Stus
(

339 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

340 
ab¦
::
SŒC©
("UÆšk f", 
·th
, "çed: ", 
¡»¼Ü
(
”ºo
)));

342 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
);

343 ià(
	gfd
 >= 0) {

344 
şo£
(
fd
);

345  
Stus
(

346 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

347 
ab¦
::
SŒC©
("F", 
·th
, " is still‡vailable‡fter unlink"));

349  
	gStus
::
OkStus
();

352 
Stus
 
RunFúTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

353 
fd
;

354 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

355 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

358 ià(
fú
(
fd
, 
F_SETFL
, 
O_NONBLOCK
 | 
O_APPEND
) == -1) {

359 
şo£
(
fd
);

360  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

361 
ab¦
::
SŒC©
("Fú s‘ fÏg fÜ f", 
·th
,

362 " faed: ", 
¡»¼Ü
(
”ºo
)));

364 
	gæags
 = 
fú
(
fd
, 
F_GETFL
);

365 ià(!(
	gæags
 & 
	gO_NONBLOCK
è|| !(æag & 
	gO_APPEND
)) {

366  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

367 
ab¦
::
SŒC©
("Fú g‘ fÏg oàf", 
·th
,

368 "„‘uºed uÃx³ùed„esuÉ: ", 
æags
));

372 ià(
fú
(
fd
, 
F_SETFD
, 
FD_CLOEXEC
) == -1) {

373 
şo£
(
fd
);

374  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

375 
ab¦
::
SŒC©
("Fú s‘ FD fÏg fÜ f", 
·th
,

376 "çed: ", 
¡»¼Ü
(
”ºo
)));

378 
	gfd_æags
 = 
fú
(
fd
, 
F_GETFD
);

379 ià(!(
	gfd_æags
 & 
	gFD_CLOEXEC
)) {

380  
Stus
(

381 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

382 
ab¦
::
SŒC©
("Fú g‘ FD fÏg fÜ f", 
·th
,

383 "»tuºed uÃx³ùed„esuÉ: ", 
¡»¼Ü
(
”ºo
)));

387 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
·th
;

388 
size_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

389 ià(
	grc
 !ğ
mes§ge
.
size
()) {

390  
Stus
(

391 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

392 
ab¦
::
SŒC©
("Wr™tØfe:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

395 
	gdup_fd
 = 
fú
(
fd
, 
F_DUPFD
, -1);

396 ià(
	gdup_fd
 !ğ-1 || 
”ºo
 !ğ
EINVAL
) {

397  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

401 
cÚ¡ex´
 
	gkMaxO³nFes
 = 1024;

402 
	gdup_fd
 = 
fú
(
fd
, 
F_DUPFD
, 
kMaxO³nFes
);

403 ià(
	gdup_fd
 !ğ-1 || 
”ºo
 !ğ
EINVAL
) {

404  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

408 
	gdup_fd
 = 
fú
(
fd
, 
F_DUPFD
, fd);

409 ià(
	gdup_fd
 == -1) {

410  
Stus
(

411 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

412 
ab¦
::
SŒC©
("fú du°fd:", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

414 ià(
	gdup_fd
 <ğ
fd
) {

415  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

416 
ab¦
::
SŒC©
("fú du°fd:", 
dup_fd
,

417 " i sm®Ë¸thª o¸equ®Ø¬g:", 
fd
));

419  
Com·»Fes
(
fd
, 
dup_fd
, 
mes§ge
.
size
());

422 
Stus
 
RunMkdœTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

423 ià(
·th
.
em±y
()) {

424  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

428 
	g¡d
::
¡ršg
 
¿ndom_·th
 = "/dev/random";

429 ià(
mkdœ
(
¿ndom_·th
.
c_¡r
(), 0644) != -1) {

430  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

431 
ab¦
::
SŒC©
("Mkdir in„egistered„andom…ath:",

432 
¿ndom_·th
, "should be forbidden."));

435 ià(
mkdœ
(
·th
.
c_¡r
(), 0644) == -1) {

436  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

437 
ab¦
::
SŒC©
("Mkdœ:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

439  
	gStus
::
OkStus
();

442 
Stus
 
RunRmDœTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

443 ià(
·th
.
em±y
()) {

444  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

447 ià(
rmdœ
(
·th
.
c_¡r
()) != 0) {

448  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

449 
ab¦
::
SŒC©
("Rmdœ:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

451  
	gStus
::
OkStus
();

454 
Stus
 
RunDupTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

455 cÚ¡ 
¡d
::
¡ršg
 
mes§ge
 = 
·th
;

456 
	gfd
;

457 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

458 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

459 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

460 ià(
	grc
 !ğ
mes§ge
.
size
()) {

461  
Stus
(

462 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

463 
ab¦
::
SŒC©
("Wr™tØfe:", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

467 
	gdup_fd
 = 
dup
(
fd
);

468 ià(
	gdup_fd
 == -1) {

469  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

470 
ab¦
::
SŒC©
("du°fd:", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

472 ià(
	gdup_fd
 =ğ
fd
) {

473  
Stus
(

474 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

475 
ab¦
::
SŒC©
("du°fd:", 
dup_fd
, " i th§ma Üigš® fd:", 
fd
));

477 
ASYLO_RETURN_IF_ERROR
(
Com·»Fes
(
fd
, 
dup_fd
, 
mes§ge
.
size
()));

480 
	gdup2_fd
 = 
dup2
(
fd
, 
dup_fd
);

481 ià(
	gdup2_fd
 !ğ
dup_fd
) {

482  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

483 
ab¦
::
SŒC©
("dup2 fd:", 
fd
, "Øfd:", 
dup_fd
,

484 " faed: ", 
¡»¼Ü
(
”ºo
)));

486 
ASYLO_RETURN_IF_ERROR
(
Com·»Fes
(
fd
, 
dup2_fd
, 
mes§ge
.
size
()));

489 
	gÃwfd
 = 1000;

490 
	gdup2_fd
 = 
dup2
(
fd
, 
Ãwfd
);

491 ià(
	gdup2_fd
 !ğ
Ãwfd
) {

492  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

493 
ab¦
::
SŒC©
("dup2 fd:", 
fd
, "Øfd:", 
Ãwfd
,

494 " faed: ", 
¡»¼Ü
(
”ºo
)));

496 
ASYLO_RETURN_IF_ERROR
(
Com·»Fes
(
fd
, 
dup2_fd
, 
mes§ge
.
size
()));

500 ià(
şo£
(
fd
) == -1) {

501  
Stus
(

502 
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

503 
ab¦
::
SŒC©
("şo£ fd:", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

505 
	gbuf
[1024];

506 
	grc
 = 
»ad
(
Ãwfd
, 
buf
, (buf));

507 ià(
	grc
 >ğ(
buf
è|| 
rc
 < 0) {

508  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

509 
ab¦
::
SŒC©
("R—d from‚ewfd:", 
Ãwfd
,

510 " faed‡á” closšg fd: ", 
fd
,

511 "ƒ¼Ü:", 
¡»¼Ü
(
”ºo
)));

514  
	gStus
::
OkStus
();

517 
Stus
 
Com·»Fes
(
fd1
, 
fd2
, 
size
) {

518 ià(
l£ek
(
fd1
, 0, 
SEEK_SET
) == -1) {

519  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

520 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd1
,

521 " faed: ", 
¡»¼Ü
(
”ºo
)));

523 
	gbuf1
[1024];

524 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
fd1
, 
buf1
, 
size
));

526 ià(
l£ek
(
fd2
, 0, 
SEEK_SET
) == -1) {

527  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

528 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd2
,

529 " faed: ", 
¡»¼Ü
(
”ºo
)));

531 
	gbuf2
[1024];

532 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
fd2
, 
buf2
, 
size
));

534 ià(
memcmp
(
buf1
, 
buf2
, 
size
) != 0) {

535  
Stus
(

536 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

537 
ab¦
::
SŒC©
("Fd:", 
fd1
, "‡nd fd:", 
fd2
, "‡re different"));

539  
	gStus
::
OkStus
();

542 
Stus
 
RunG‘Ho¡NameTe¡
(
EnşaveOuut
 *
ouut
) {

543 
	gbuf
[1024];

544 ià(
g‘ho¡Çme
(
buf
, (buf)) == -1) {

545  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

546 
ab¦
::
SŒC©
("g‘ho¡Çmçed:", 
¡»¼Ü
(
”ºo
)));

548 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

549 
	gouut_»t
.
£t_¡ršg_sysÿÎ_»tuº
(
¡d
::
¡ršg
(
buf
));

550 ià(
	gouut
) {

551 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

553  
	gStus
::
OkStus
();

556 
Stus
 
RunLškTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

557 ià(
·th
.
em±y
()) {

558  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

560 cÚ¡ 
	g¡d
::
¡ršg
 
äom_·th
 = 
¡d
::¡ršg(
·th
) + "from";

561 cÚ¡ 
	g¡d
::
¡ršg
 
to_·th
 = 
¡d
::¡ršg(
·th
) + "to";

562 
	gäom_fd
;

563 
ASYLO_ASSIGN_OR_RETURN
(
äom_fd
,

564 
O³nFe
(
äom_·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

566 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
äom_fd_şo£r
(
äom_fd
);

567 
size_t
 
	grc
 = 
wr™e
(
äom_fd
, 
·th
.
c_¡r
(),…©h.
size
());

568 ià(
	grc
 !ğ
·th
.
size
()) {

569  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

570 
ab¦
::
SŒC©
("FaedØwr™tØfe:", 
äom_·th
,

571 "ƒ¼Ü:", 
¡»¼Ü
(
”ºo
)));

573 ià(
lšk
(
äom_·th
.
c_¡r
(), 
to_·th
.c_str()) == -1) {

574  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

575 
ab¦
::
SŒC©
("Lšk…©h ", 
äom_·th
, "Ø", 
to_·th
,

576 " faed: ", 
¡»¼Ü
(
”ºo
)));

578 
	gto_fd
;

579 
ASYLO_ASSIGN_OR_RETURN
(
to_fd
, 
O³nFe
(
to_·th
, 
O_RDWR
, 0));

580 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
to_fd_şo£r
(
to_fd
);

582 
	gbuf
[1024];

583 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
to_fd
, 
buf
, 
·th
.
size
()));

584 ià(
memcmp
(
buf
, 
·th
.
c_¡r
(),…©h.
size
()) != 0) {

585  
Stus
(

586 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

587 
ab¦
::
SŒC©
("ThcÚ‹Á:", 
buf
, " from†šked…©h:", 
to_·th
,

588 " i difã»Á fromhÜigš®…©h:", 
äom_·th
));

590  
	gStus
::
OkStus
();

593 
Stus
 
RunG‘CwdTe¡
(
boŞ
 
´ovide_bufãr
, 
št32_t
 
bufãr_size
,

594 
EnşaveOuut
 *
ouut
) {

595 
	g¡ack_bufãr
[
PATH_MAX
];

596 *
	gbuf
 = 
g‘cwd
(
´ovide_bufãr
 ? 
¡ack_bufãr
 : 
nuÎ±r
,

597 
¡d
::
mš
(
bufãr_size
, 
PATH_MAX
));

598 ià(!
	gbuf
) {

599  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

600 
ab¦
::
SŒC©
("g‘cwd faed:", 
¡»¼Ü
(
”ºo
)));

602 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

603 
	gouut_»t
.
£t_¡ršg_sysÿÎ_»tuº
(
¡d
::
¡ršg
(
buf
));

604 ià(
	gouut
) {

605 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

607  
	gStus
::
OkStus
();

610 
Stus
 
RunUmaskTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

611 
umask
(
S_IWGRP
 | 
S_IWOTH
);

612 ià(
mkdœ
(
·th
.
c_¡r
(), 0777) == -1) {

613  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

614 
ab¦
::
SŒC©
("mkdœ faed:", 
¡»¼Ü
(
”ºo
)));

616 
¡©
 
	g¡
;

617 ià(
¡©
(
·th
.
c_¡r
(), &
¡
) == -1) {

618  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

619 
ab¦
::
SŒC©
("¡© faed:", 
¡»¼Ü
(
”ºo
)));

621 ià(
	g¡
.
	g¡_mode
 & 
	gS_IWGRP
 || st.¡_mod& 
	gS_IWOTH
) {

622  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

625 cÚ¡ 
	g¡d
::
¡ršg
 
fe_·th
 = 
·th
 + "OpenWithUmask";

626 
	gfd
;

627 
ASYLO_ASSIGN_OR_RETURN
(
fd
,

628 
O³nFe
(
fe_·th
.
c_¡r
(), 
O_CREAT
 | 
O_RDWR
, 0777));

629 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

630 ià(
f¡©
(
fd
, &
¡
) == -1) {

631  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

632 
ab¦
::
SŒC©
("f¡© faed:", 
¡»¼Ü
(
”ºo
)));

634 ià(
	g¡
.
	g¡_mode
 & 
	gS_IWGRP
 || st.¡_mod& 
	gS_IWOTH
) {

635  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

638  
	gStus
::
OkStus
();

641 
Stus
 
RunG‘UidTe¡
(
EnşaveOuut
 *
ouut
) {

642 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

643 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘uid
());

644 ià(
	gouut
) {

645 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

647  
	gStus
::
OkStus
();

650 
Stus
 
RunG‘EuidTe¡
(
EnşaveOuut
 *
ouut
) {

651 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

652 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘euid
());

653 ià(
	gouut
) {

654 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

656  
	gStus
::
OkStus
();

659 
Stus
 
RunG‘GidTe¡
(
EnşaveOuut
 *
ouut
) {

660 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

661 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘gid
());

662 ià(
	gouut
) {

663 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

665  
	gStus
::
OkStus
();

668 
Stus
 
RunG‘EgidTe¡
(
EnşaveOuut
 *
ouut
) {

669 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

670 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘egid
());

671 ià(
	gouut
) {

672 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

674  
	gStus
::
OkStus
();

677 
Stus
 
RunG‘PpidTe¡
(
EnşaveOuut
 *
ouut
) {

678 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

679 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
g‘µid
());

680 ià(
	gouut
) {

681 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

683  
	gStus
::
OkStus
();

686 
Stus
 
RunSchedG‘Affš™yTe¡
(
EnşaveOuut
 *
ouut
) {

687 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

688 
pid_t
 
	gmy_pid
 = 
g‘pid
();

689 
ıu_£t_t
 
	gmask
;

691 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(

692 
sched_g‘affš™y
(
my_pid
, (
ıu_£t_t
), &
mask
));

693 
	gouut_»t
.
ş—r_b™_mask_sysÿÎ_ouŒ
();

696 
EncodeCpuS‘InTe¡Ouut
(
mask
, &
ouut_»t
);

698 ià(
	gouut
) {

699 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

701  
	gStus
::
OkStus
();

704 
Stus
 
RunSchedG‘Affš™yFau»Te¡
(
EnşaveOuut
 *
ouut
) {

705 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

706 
pid_t
 
	gmy_pid
 = 
g‘pid
();

707 
ıu_£t_t
 
	gmask
;

708 
size_t
 
	gbad_ıu_£t_size
 = (
ıu_£t_t
) / 2;

710 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(

711 
sched_g‘affš™y
(
my_pid
, 
bad_ıu_£t_size
, &
mask
));

713 
EncodeE¼noV®ueInTe¡Ouut
(
”ºo
, &
ouut_»t
);

715 ià(
	gouut
) {

716 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

718  
	gStus
::
OkStus
();

721 
Stus
 
RunCpuS‘MaüosTe¡
(
EnşaveOuut
 *
ouut
) {

722 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

723 
ıu_£t_t
 
	gmask
;

726 
CPU_ZERO
(&
mask
);

727 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

728 ià(
CPU_ISSET
(
ıu
, &
mask
)) {

729  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

730 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is set‡fter CPU_ZERO."));

737 cÚ¡ 
	gab¦
::
æ©_hash_£t
<> 
‹¡_ıu_£t_ıus
(

739 
CPU_ZERO
(&
mask
);

740 
	gıu
 : 
‹¡_ıu_£t_ıus
) {

741 
CPU_SET
(
ıu
, &
mask
);

743 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

744 ià(!
CPU_ISSET
(
ıu
, &
mask
è&& 
	g‹¡_ıu_£t_ıus
.
couÁ
(cpu)) {

745  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

746 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is‚ot set‡fter CPU_SET."));

747 } ià(
CPU_ISSET
(
ıu
, &
mask
è&& !
	g‹¡_ıu_£t_ıus
.
couÁ
(cpu)) {

748  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

749 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is set without CPU_SET."));

757 cÚ¡ 
	gab¦
::
æ©_hash_£t
<> 
‹¡_ıu_şr_ıus_to_£t
(

759 cÚ¡ 
	gab¦
::
æ©_hash_£t
<> 
‹¡_ıu_şr_ıus_to_ş—r
({2, 5, 132});

760 
CPU_ZERO
(&
mask
);

761 
	gıu
 : 
‹¡_ıu_şr_ıus_to_£t
) {

762 
CPU_SET
(
ıu
, &
mask
);

764 
	gıu
 : 
‹¡_ıu_şr_ıus_to_ş—r
) {

765 
CPU_CLR
(
ıu
, &
mask
);

767 
	gıu
 : 
‹¡_ıu_şr_ıus_to_£t
) {

768 ià(
CPU_ISSET
(
ıu
, &
mask
è&& 
	g‹¡_ıu_şr_ıus_to_ş—r
.
couÁ
(cpu)) {

769  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

770 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is set‡fter CPU_CLR."));

771 } ià(!
CPU_ISSET
(
ıu
, &
mask
) &&

772 !
	g‹¡_ıu_şr_ıus_to_ş—r
.
couÁ
(
ıu
)) {

773  
Stus
(

774 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

775 
ab¦
::
SŒC©
("CPU ", 
ıu
, " is‚ot set without CPU_CLR."));

781 
CPU_ZERO
(&
mask
);

782 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

783 ià(
	gıu
 % 10 =ğ1 || 
ıu
 % 10 == 3 || cpu % 10 == 7 || cpu % 10 == 9) {

784 
CPU_SET
(
ıu
, &
mask
);

787 
	gıu
 = 0; cpu < 
	gCPU_SETSIZE
; ++cpu) {

788 
boŞ
 
	gex³ùed_v®ue
 =

789 (
ıu
 % 10 == 1 || cpu % 10 == 3 || cpu % 10 == 7 || cpu % 10 == 9);

790 ià(
	g¡©ic_ÿ¡
<
	gboŞ
>(
CPU_ISSET
(
ıu
, &
mask
)è!ğ
ex³ùed_v®ue
) {

791  
Stus
(

792 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

793 
ab¦
::
SŒC©
("CPU_ISSET(", 
ıu
, "è»tuº ", !
ex³ùed_v®ue
,

794 "buˆshould„‘uº ", 
ex³ùed_v®ue
, "."));

800 cÚ¡ 
	g‹¡_ıu_couÁ_ıus
[] = {1, 2, 5, 14, 42, 132, 429};

801 cÚ¡ 
	g‹¡_ıu_couÁ_ex³ùed_couÁ
 = 7;

802 
CPU_ZERO
(&
mask
);

803 
	gıu
 : 
‹¡_ıu_couÁ_ıus
) {

804 
CPU_SET
(
ıu
, &
mask
);

806 cÚ¡ 
	gıu_couÁ
 = 
CPU_COUNT
(&
mask
);

807 ià(
	gıu_couÁ
 !ğ
‹¡_ıu_couÁ_ex³ùed_couÁ
) {

808  
Stus
(

809 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

810 
ab¦
::
SŒC©
("CPU_COUNT„‘uº ", 
ıu_couÁ
, " but should„eturn ",

811 
‹¡_ıu_couÁ_ex³ùed_couÁ
, "."));

815 cÚ¡ 
	g‹¡_ıu_equ®_ıus
[] = {1, 2, 5, 14, 42, 132, 429};

816 cÚ¡ 
	g‹¡_ıu_equ®_ıus_difã»Á
[] = {1, 2, 3, 6, 11,

818 
CPU_ZERO
(&
mask
);

819 
	gıu
 : 
‹¡_ıu_equ®_ıus
) {

820 
CPU_SET
(
ıu
, &
mask
);

822 ià(!
CPU_EQUAL
(&
mask
, &mask)) {

823  
Stus
(

824 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

825 
ab¦
::
SŒC©
("CPU_EQUAL claims‡ mask is‚otƒqualo itself."));

828 
ıu_£t_t
 
	gdifã»Á_mask
;

829 
CPU_ZERO
(&
difã»Á_mask
);

830 
	gıu
 : 
‹¡_ıu_equ®_ıus_difã»Á
) {

831 
CPU_SET
(
ıu
, &
difã»Á_mask
);

833 ià(
CPU_EQUAL
(&
mask
, &
difã»Á_mask
)) {

834  
Stus
(

835 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

836 
ab¦
::
SŒC©
("CPU_EQUAL claimswo different masks‡reƒqual."));

839 ià(
	gouut
) {

840 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

842  
	gStus
::
OkStus
();

845 
Stus
 
RunStTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
EnşaveOuut
 *
ouut
) {

846 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

848 
¡©
 
	g¡©_bufãr
;

849 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
¡©
(
·th
.
c_¡r
(), &
¡©_bufãr
));

851 
EncodeStBufãrInTe¡Ouut
(
¡©_bufãr
, &
ouut_»t
);

853 ià(
	gouut
) {

854 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

856  
	gStus
::
OkStus
();

859 
Stus
 
RunFStTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
EnşaveOuut
 *
ouut
) {

860 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

862 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDONLY
);

863 ià(
	gfd
 == -1) {

864  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

865 
ab¦
::
SŒC©
("İ’ faed:", 
¡»¼Ü
(
”ºo
)));

868 
¡©
 
	g¡©_bufãr
;

869 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
f¡©
(
fd
, &
¡©_bufãr
));

871 ià(
şo£
(
fd
) == -1) {

872  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

873 
ab¦
::
SŒC©
("şo£ faed:", 
¡»¼Ü
(
”ºo
)));

876 
EncodeStBufãrInTe¡Ouut
(
¡©_bufãr
, &
ouut_»t
);

878 ià(
	gouut
) {

879 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

881  
	gStus
::
OkStus
();

884 
Stus
 
RunLStTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
, 
EnşaveOuut
 *
ouut
) {

885 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

887 
¡©
 
	g¡©_bufãr
;

888 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
l¡©
(
·th
.
c_¡r
(), &
¡©_bufãr
));

890 
EncodeStBufãrInTe¡Ouut
(
¡©_bufãr
, &
ouut_»t
);

892 ià(
	gouut
) {

893 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

895  
	gStus
::
OkStus
();

898 
Stus
 
RunUÇmeTe¡
(
EnşaveOuut
 *
ouut
) {

899 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

900 
ut¢ame
 
	gut¢ame_buf
;

902 
	g»t
 = 
uÇme
(&
ut¢ame_buf
);

903 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
»t
);

905 ià(
	g»t
 == 0) {

906 
EncodeUtsNameInTe¡Ouut
(
ut¢ame_buf
, &
ouut_»t
);

908 
EncodeE¼noV®ueInTe¡Ouut
(
”ºo
, &
ouut_»t
);

911 ià(
	gouut
) {

912 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

914  
	gStus
::
OkStus
();

917 
Stus
 
RunWr™evTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

918 
fd
;

919 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

920 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

921 
cÚ¡ex´
 
	gnum_mes§ges
 = 2;

922 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge1
 = "First writev message";

923 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge2
 = "Second writev message";

924 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
mes§ge1
 + 
mes§ge2
;

925 
iovec
 
	giov
[
num_mes§ges
];

926 
mem£t
(
iov
, 0, (iov));

927 
	giov
[0].
	giov_ba£
 = 
cÚ¡_ÿ¡
<*>(
mes§ge1
.
c_¡r
());

928 
	giov
[1].
	giov_ba£
 = 
cÚ¡_ÿ¡
<*>(
mes§ge2
.
c_¡r
());

929 
	giov
[0].
	giov_Ën
 = 
mes§ge1
.
size
();

930 
	giov
[1].
	giov_Ën
 = 
mes§ge2
.
size
();

931 
	gsize
 = 
mes§ge
.
size
();

932 
ssize_t
 
	grc
 = 
wr™ev
(
fd
, 
iov
, 
num_mes§ges
);

933 ià(
	grc
 !ğ
size
) {

934  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

935 
ab¦
::
SŒC©
("wr™ev„‘uº:", 
rc
,

936 " dÛ nÙ m©ch mes§gsize:", 
size
));

939 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

940  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

941 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

942 " faed: ", 
¡»¼Ü
(
”ºo
)));

945 
	gbuf
[1024];

946 
ASYLO_RETURN_IF_ERROR
(
R—dFe
(
fd
, 
buf
, 
size
));

947 ià(
memcmp
(
buf
, 
mes§ge
.
c_¡r
(), mes§ge.
size
()) != 0) {

948  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

949 
ab¦
::
SŒC©
("Mes§g»ad from fd:", 
fd
, ":", 
buf
,

952  
	gStus
::
OkStus
();

955 
Stus
 
RunR—dvTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

956 
fd
;

957 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

958 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

959 
cÚ¡ex´
 
	gnum_mes§ges
 = 2;

960 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge1
 = "First„eadv message";

961 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge2
 = "Second„eadv message";

962 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
mes§ge1
 + 
mes§ge2
;

963 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

964 ià(
	grc
 !ğ
mes§ge
.
size
()) {

965  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

968 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

969  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

970 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

971 " faed: ", 
¡»¼Ü
(
”ºo
)));

973 
iovec
 
	giov
[
num_mes§ges
];

974 
mem£t
(
iov
, 0, (iov));

975 
	gbuf1
[
mes§ge1
.
size
()];

976 
	gbuf2
[
mes§ge2
.
size
()];

977 
	giov
[0].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf1
);

978 
	giov
[1].
	giov_ba£
 = 
»š‹½»t_ÿ¡
<*>(
buf2
);

979 
	giov
[0].
	giov_Ën
 = 
mes§ge1
.
size
();

980 
	giov
[1].
	giov_Ën
 = 
mes§ge2
.
size
();

981 
	grc
 = 
»adv
(
fd
, 
iov
, 
num_mes§ges
);

982 ià(
	grc
 !ğ
mes§ge
.
size
()) {

983  
Stus
(

984 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

985 
ab¦
::
SŒC©
("»adv„‘uº:", 
rc
,

986 " dÛ nÙ m©ch mes§gsize:", 
mes§ge
.
size
()));

988 ià(
memcmp
(
»š‹½»t_ÿ¡
<*>(
iov
[0].
iov_ba£
), 
mes§ge1
.
c_¡r
(),

989 
iov
[0].
iov_Ën
) ||

990 
memcmp
(
»š‹½»t_ÿ¡
<*>(
iov
[1].
iov_ba£
), 
mes§ge2
.
c_¡r
(),

991 
iov
[1].
iov_Ën
)) {

992  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

995  
	gStus
::
OkStus
();

998 
Stus
 
RunRlim™NoFeTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

999 
cÚ¡ex´
 
soá_lim™
 = 100;

1000 
cÚ¡ex´
 
	gh¬d_lim™
 = 200;

1001 
¾im™
 
	g£t_lim™
;

1002 
	g£t_lim™
.
	g¾im_cur
 = 
soá_lim™
;

1003 
	g£t_lim™
.
	g¾im_max
 = 
h¬d_lim™
;

1004 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != 0) {

1005  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1006 
ab¦
::
SŒC©
("£Œlim™ faed:", 
¡»¼Ü
(
”ºo
)));

1008 
¾im™
 
	gg‘_lim™
;

1009 ià(
g‘¾im™
(
RLIMIT_NOFILE
, &
g‘_lim™
) != 0) {

1010  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1011 
ab¦
::
SŒC©
("g‘¾im™ faed:", 
¡»¼Ü
(
”ºo
)));

1013 ià(
	gg‘_lim™
.
	g¾im_cur
 !ğ
soá_lim™
 || 
g‘_lim™
.
¾im_max
 !ğ
h¬d_lim™
) {

1014  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1018  
	gStus
::
OkStus
();

1021 
Stus
 
RunRlim™LowNoFeTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1022 
cÚ¡ex´
 
fe_desütÜ_u£d
 = 3;

1023 
¾im™
 
	g£t_lim™
;

1026 
	g£t_lim™
.
	g¾im_cur
 = 
fe_desütÜ_u£d
;

1027 
	g£t_lim™
.
	g¾im_max
 = 
fe_desütÜ_u£d
;

1028 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != 0) {

1029  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1030 
ab¦
::
SŒC©
("£Œlim™ faed:", 
¡»¼Ü
(
”ºo
)));

1032 autØ
	gfd_Ü_”rÜ
 = 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644);

1033 ià(
	gfd_Ü_”rÜ
.
ok
()) {

1034  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1035 
ab¦
::
SŒC©
("FdesütÜ: ", 
fd_Ü_”rÜ
.
V®ueOrD›
(),

1037 
fe_desütÜ_u£d
));

1039  
	gStus
::
OkStus
();

1042 
Stus
 
RunRlim™Inv®idNoFeTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1043 
¾im™
 
g‘_lim™
;

1044 ià(
g‘¾im™
(
RLIMIT_NOFILE
, &
g‘_lim™
) != 0) {

1045  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1046 
ab¦
::
SŒC©
("g‘¾im™ faed:", 
¡»¼Ü
(
”ºo
)));

1048 
	gŞd_soá_lim™
 = 
g‘_lim™
.
¾im_cur
;

1049 
	gŞd_h¬d_lim™
 = 
g‘_lim™
.
¾im_max
;

1051 
cÚ¡ex´
 
	gšv®id_lim™
 = 2;

1052 
¾im™
 
	g£t_lim™
;

1053 
	g£t_lim™
.
	g¾im_cur
 = 
šv®id_lim™
;

1054 
	g£t_lim™
.
	g¾im_max
 = 
šv®id_lim™
;

1057 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1058  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1063 ià(
g‘¾im™
(
RLIMIT_NOFILE
, &
g‘_lim™
) != 0) {

1064  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1065 
ab¦
::
SŒC©
("g‘¾im™ faed:", 
¡»¼Ü
(
”ºo
)));

1069 
	g£t_lim™
.
	g¾im_cur
 = 200;

1070 
	g£t_lim™
.
	g¾im_max
 = 100;

1071 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1072  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1079 
	g£t_lim™
.
	g¾im_cur
 = 2000;

1080 
	g£t_lim™
.
	g¾im_max
 = 2000;

1081 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1082  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1087 ià(
	gg‘_lim™
.
	g¾im_cur
 !ğ
Şd_soá_lim™
 ||

1088 
g‘_lim™
.
¾im_max
 !ğ
Şd_h¬d_lim™
) {

1089  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1090 
ab¦
::
SŒC©
("NOFILE†imit has changed‡fter‡ series of"

1092 
Şd_soá_lim™
,

1093 " cu¼’ˆsoá†im™: ", 
g‘_lim™
.
¾im_cur
,

1094 " origš® h¬d†im™: ", 
Şd_h¬d_lim™
,

1095 " cu¼’ˆh¬d†im™: ", 
g‘_lim™
.
¾im_max
));

1100 
	g£t_lim™
.
	g¾im_cur
 = 100;

1101 
	g£t_lim™
.
	g¾im_max
 = 100;

1102 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != 0) {

1103  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1104 
ab¦
::
SŒC©
("£Œlim™ faed:", 
¡»¼Ü
(
”ºo
)));

1106 
	g£t_lim™
.
	g¾im_cur
 = 200;

1107 
	g£t_lim™
.
	g¾im_max
 = 200;

1108 ià(
£Œlim™
(
RLIMIT_NOFILE
, &
£t_lim™
) != -1) {

1109  
Stus
(

1110 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1114  
	gStus
::
OkStus
();

1117 
Stus
 
RunChModTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1118 ià(
chmod
(
·th
.
c_¡r
(), 0644) != 0) {

1119  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1120 
ab¦
::
SŒC©
("chmod faed: ", 
¡»¼Ü
(
”ºo
)));

1122  
	gStus
::
OkStus
();

1125 
Stus
 
RunFChModTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1126 
fd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 0777);

1127 ià(
	gfd
 < 0) {

1128  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1129 
ab¦
::
SŒC©
("çedØİ’ fe: ", 
¡»¼Ü
(
”ºo
)));

1132 ià(
fchmod
(
fd
, 0644) != 0) {

1133  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1134 
ab¦
::
SŒC©
("fchmod faed: ", 
¡»¼Ü
(
”ºo
)));

1136  
	gStus
::
OkStus
();

1139 
Stus
 
RunG‘IfAddrsTe¡
(
EnşaveOuut
 *
ouut
) {

1140 
içddrs
 *
	gäÚt
 = 
nuÎ±r
;

1141 
	g»t
 = 
g‘içddrs
(&
äÚt
);

1142 *
	g£rŸlized_içddrs
 = 
nuÎ±r
;

1143 
size_t
 
	gËn
;

1144 
	gasylo
::
S”ŸlizeIfAddrs
(
äÚt
, &
£rŸlized_içddrs
, &
Ën
);

1145 
ä“içddrs
(
äÚt
);

1146 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

1147 
	gouut_»t
.
£t_£rŸlized_´Ùo_»tuº
(

1148 
¡d
::
¡ršg
(
£rŸlized_içddrs
, 
Ën
));

1149 
	gouut_»t
.
£t_št_sysÿÎ_»tuº
(
»t
);

1150 ià(
	gouut
) {

1151 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

1153  
	gStus
::
OkStus
();

1156 
Stus
 
Ex³ùE¼no
(
ex³ùed_”ºo
, 
»tv®
) {

1157 
	g§ved_”ºo
 = 
”ºo
;

1159 ià(
	g»tv®
 != -1) {

1160  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1161 
ab¦
::
SŒC©
("Ex³ùed„‘v® oà-1, gÙ ", 
»tv®
));

1164 ià(
	g§ved_”ºo
 !ğ
ex³ùed_”ºo
) {

1165  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1166 
ab¦
::
SŒC©
("Ex³ùedƒ¼nØoà", 
ex³ùed_”ºo
, "; got ",

1167 
§ved_”ºo
));

1170  
	gStus
::
OkStus
();

1175 
Stus
 
RunG‘SockÇmeTe¡_SUCCESS
() {

1176 
sockaddr
 
	g§
;

1177 
sockËn_t
 
	g§_Ën
 = (
§
);

1179 
	gfd
 = 
sock‘
(
AF_UNIX
, 
SOCK_STREAM
, 0);

1181 ià(
	gfd
 < 0) {

1182  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1183 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1186 ià(
g‘sockÇme
(
fd
, &
§
, &
§_Ën
) != 0) {

1187  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1190  
	gStus
::
OkStus
();

1193 
Stus
 
RunG‘SockÇmeFau»Te¡_EBADF
() {

1194 
sockaddr
 
	g§
;

1195 
sockËn_t
 
	g§_Ën
 = (
§
);

1197  
Ex³ùE¼no
(
EBADF
, 
g‘sockÇme
(-1, &
§
, &
§_Ën
));

1201 
Stus
 
RunG‘SockÇmeFau»Te¡_EFAULT
() {

1202 
sockaddr
 
	g§
;

1203 
sockËn_t
 
	g§_Ën
 = (
§
);

1205 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1207 ià(
	gfd
 < 0) {

1208  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1209 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1212  
Ex³ùE¼no
(
EFAULT
, 
g‘sockÇme
(
fd
, 
nuÎ±r
, &
§_Ën
));

1216 
Stus
 
RunG‘SockÇmeFau»Te¡_EINVAL
() {

1217 
sockaddr
 
	g§
;

1218 
sockËn_t
 
	g§_Ën
 = -1;

1219 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1221 ià(
	gfd
 < 0) {

1222  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1223 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1226  
Ex³ùE¼no
(
EINVAL
, 
g‘sockÇme
(
fd
, &
§
, &
§_Ën
));

1230 
Stus
 
RunG‘SockÇmeFau»Te¡_ENOTSOCK
() {

1231 
	gfds
[2];

1232 
	g»t
 = 
pe
(
fds
);

1233 ià(
	g»t
 != 0) {

1234  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1238 
sockaddr
 
	g§
;

1239 
sockËn_t
 
	g§_Ën
 = (
§
);

1240  
Ex³ùE¼no
(
ENOTSOCK
, 
g‘sockÇme
(
fds
[0], &
§
, &
§_Ën
));

1246 
Stus
 
RunG‘P“ºameFau»Te¡_EBADF
() {

1247 
sockaddr
 
	g§
;

1248 
sockËn_t
 
	g§_Ën
 = (
§
);

1250  
Ex³ùE¼no
(
EBADF
, 
g‘³”Çme
(-1, &
§
, &
§_Ën
));

1254 
Stus
 
RunG‘P“ºameFau»Te¡_EFAULT
() {

1255 
sockaddr
 
	g§
;

1256 
sockËn_t
 
	g§_Ën
 = (
§
);

1258 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1260 ià(
	gfd
 < 0) {

1261  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1262 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1265  
Ex³ùE¼no
(
EFAULT
, 
g‘³”Çme
(
fd
, 
nuÎ±r
, &
§_Ën
));

1269 
Stus
 
RunG‘P“ºameFau»Te¡_EINVAL
() {

1270 
sockaddr
 
	g§
;

1271 
sockËn_t
 
	g§_Ën
 = -1;

1272 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1274 ià(
	gfd
 < 0) {

1275  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1276 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1279  
Ex³ùE¼no
(
EINVAL
, 
g‘³”Çme
(
fd
, &
§
, &
§_Ën
));

1283 
Stus
 
RunG‘P“ºameFau»Te¡_ENOTCONN
() {

1284 
sockaddr
 
	g§
;

1285 
sockËn_t
 
	g§_Ën
 = (
§
);

1286 
	gfd
 = 
sock‘
(
AF_INET6
, 
SOCK_STREAM
, 0);

1288 ià(
	gfd
 < 0) {

1289  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1290 
ab¦
::
SŒC©
("couldn'ˆü—‹ sock‘,ƒ¼nØ", 
”ºo
));

1293  
Ex³ùE¼no
(
ENOTCONN
, 
g‘³”Çme
(
fd
, &
§
, &
§_Ën
));

1297 
Stus
 
RunG‘P“ºameFau»Te¡_ENOTSOCK
() {

1298 
	gfds
[2];

1299 
	g»t
 = 
pe
(
fds
);

1300 ià(
	g»t
 != 0) {

1301  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1305 
sockaddr
 
	g§
;

1306 
sockËn_t
 
	g§_Ën
 = (
§
);

1307  
Ex³ùE¼no
(
ENOTSOCK
, 
g‘³”Çme
(
fds
[0], &
§
, &
§_Ën
));

1310 
Stus
 
RunTrunÿ‹Te¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1311 
fd
;

1312 
ASYLO_ASSIGN_OR_RETURN
(
fd
, 
O³nFe
(
·th
, 
O_CREAT
 | 
O_RDWR
, 0644));

1313 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
);

1314 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge1
 = "First message ";

1315 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge2
 = "Second message ";

1316 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge3
 = "Third message";

1317 cÚ¡ 
	g¡d
::
¡ršg
 
mes§ge
 = 
mes§ge1
 + 
mes§ge2
 + 
mes§ge3
;

1318 
ssize_t
 
	grc
 = 
wr™e
(
fd
, 
mes§ge
.
c_¡r
(), mes§ge.
size
());

1319 ià(
	grc
 !ğ
mes§ge
.
size
()) {

1320  
Stus
(

1321 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1322 
ab¦
::
SŒC©
("wr™»tuºs: ", 
rc
,

1323 " dÛ nÙ m©ch mes§gsize: ", 
mes§ge
.
size
()));

1328 
	g¡d
::
¡ršg
 
Œunÿ‹d_mes§ge
 = 
mes§ge1
 + 
mes§ge2
;

1329 ià(
Œunÿ‹
(
·th
.
c_¡r
(), 
Œunÿ‹d_mes§ge
.
size
()) != 0) {

1330  
Stus
(

1331 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1332 
ab¦
::
SŒC©
("Trunÿ‹ fe: ", 
·th
, " faed: ", 
¡»¼Ü
(
”ºo
)));

1334 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

1335  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

1336 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

1337 " faed: ", 
¡»¼Ü
(
”ºo
)));

1339 
	gbuf1
[1024];

1340 
	grc
 = 
»ad
(
fd
, 
buf1
, 
mes§ge
.
size
());

1341 ià(
	grc
 !ğ
Œunÿ‹d_mes§ge
.
size
() ||

1342 
memcmp
(
buf1
, 
Œunÿ‹d_mes§ge
.
c_¡r
(),runÿ‹d_mes§ge.
size
()) !=

1344  
Stus
(

1345 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1346 
ab¦
::
SŒC©
("Mes§g»ad fromrunÿ‹d fis: ", 
buf1
,

1347 "‡nd dÛ nÙ m©chƒx³ùed: ", 
Œunÿ‹d_mes§ge
));

1351 
	gŒunÿ‹d_mes§ge
 = 
mes§ge1
;

1352 ià(
árunÿ‹
(
fd
, 
Œunÿ‹d_mes§ge
.
size
()) != 0) {

1353  
Stus
(

1354 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1355 
ab¦
::
SŒC©
("FŒunÿ‹ fe: ", 
fd
, " faed: ", 
¡»¼Ü
(
”ºo
)));

1357 ià(
l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

1358  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
”ºo
),

1359 
ab¦
::
SŒC©
("MovšgØbegšnšg oàfd:", 
fd
,

1360 " faed: ", 
¡»¼Ü
(
”ºo
)));

1362 
	gbuf2
[1024];

1363 
	grc
 = 
»ad
(
fd
, 
buf2
, 
mes§ge
.
size
());

1364 ià(
	grc
 !ğ
Œunÿ‹d_mes§ge
.
size
() ||

1365 
memcmp
(
buf2
, 
Œunÿ‹d_mes§ge
.
c_¡r
(),runÿ‹d_mes§ge.
size
()) !=

1367  
Stus
(

1368 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1369 
ab¦
::
SŒC©
("Mes§g»ad fromrunÿ‹d fis: ", 
buf1
,

1370 "‡nd dÛ nÙ m©chƒx³ùed: ", 
Œunÿ‹d_mes§ge
));

1372  
	gStus
::
OkStus
();

1375 
Stus
 
RunMm­Te¡
() {

1377 *
	g±r
 = 
mm­
(
nuÎ±r
, 10000, 
PROT_READ
 | 
PROT_WRITE
,

1378 
MAP_ANONYMOUS
 | 
MAP_PRIVATE
, -1, 0);

1379 ià(
	g±r
 =ğ
MAP_FAILED
) {

1380  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1383 
šŒ_t
 
	gadd»ss
 = 
»š‹½»t_ÿ¡
<šŒ_t>(
±r
);

1384 ià((
	gadd»ss
 & 4095) != 0) {

1385  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1388 *
	gıŒ
 = 
¡©ic_ÿ¡
<*>(
±r
);

1389 ià(
	g¡d
::
couÁ
(
ıŒ
, cptr + 10000, '\0') != 10000) {

1390  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1393 ià(
munm­
(
±r
, 10000) != 0) {

1394  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1397  
	gStus
::
OkStus
();

1400 
Stus
 
RunItim”Te¡
() {

1401 
™im”v®
 
	gtim”_v®
;

1402 
	gtim”_v®
.
	g™_š‹rv®
.
	gtv_£c
 = 100;

1403 
	gtim”_v®
.
	g™_š‹rv®
.
	gtv_u£c
 = 12;

1404 
	gtim”_v®
.
	g™_v®ue
.
	gtv_£c
 = 100;

1405 
	gtim”_v®
.
	g™_v®ue
.
	gtv_u£c
 = 0;

1408 ià(
£t™im”
(
ITIMER_REAL
, &
tim”_v®
, 
nuÎ±r
) != 0) {

1409 
³¼Ü
("setitimer");

1410  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 1");

1415 
™im”v®
 
	gtime_tl_Ãxt
;

1416 ià(
£t™im”
(
ITIMER_REAL
, &
tim”_v®
, &
time_tl_Ãxt
) != 0) {

1417 
³¼Ü
("setitimer");

1418  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 2");

1420 ià(
	gtime_tl_Ãxt
.
	g™_š‹rv®
.
	gtv_£c
 !ğ
tim”_v®
.
™_š‹rv®
.
tv_£c
 ||

1421 
time_tl_Ãxt
.
™_š‹rv®
.
tv_u£c
 !ğ
tim”_v®
.it_interval.tv_usec) {

1422  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 3");

1424 ià(
	gtime_tl_Ãxt
.
	g™_v®ue
.
	gtv_£c
 >ğ
tim”_v®
.
™_š‹rv®
.
tv_£c
) {

1425  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "setitimer failure 4");

1429 
™im”v®
 
	gcu¼_v®
;

1430 ià(
g‘™im”
(
ITIMER_REAL
, &
cu¼_v®
) != 0) {

1431  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getitimer failure 1");

1433 ià(
	gcu¼_v®
.
	g™_š‹rv®
.
	gtv_£c
 !ğ
tim”_v®
.
™_š‹rv®
.
tv_£c
 ||

1434 
cu¼_v®
.
™_š‹rv®
.
tv_u£c
 !ğ
tim”_v®
.it_interval.tv_usec) {

1435  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "getitimer failure 2");

1438  
	gStus
::
OkStus
();

1441 
Stus
 
RunR’ameTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1442 ià(
·th
.
em±y
()) {

1443  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

1447 
	gfd
 = 
İ’
((
·th
 + "/ŞdÇme").
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 0777);

1448 ià(
	gfd
 < 0) {

1449  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1450 
ab¦
::
SŒC©
("çedØü—‹ fš: ", 
·th
,

1451 ",ƒ¼Ü: ", 
¡»¼Ü
(
”ºo
)));

1453 
şo£
(
fd
);

1454 ià(
»Çme
((
·th
 + "/ŞdÇme").
c_¡r
(), (path + "/rename").c_str()) < 0) {

1455  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1456 
ab¦
::
SŒC©
("çedØ»Çmfš: ", 
·th
,

1457 ",ƒ¼Ü: ", 
¡»¼Ü
(
”ºo
)));

1460  
	gStus
::
OkStus
();

1463 
Stus
 
RunUtimesTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
·th
) {

1464 ià(
·th
.
em±y
()) {

1465  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "File…ath‚ot set");

1468 ià(
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
, 0777) < 0) {

1469  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1470 
ab¦
::
SŒC©
("çedØü—‹ fš: ", 
·th
,

1471 ",ƒ¼Ü: ", 
¡»¼Ü
(
”ºo
)));

1476 
timev®
 
	gtimes
[2];

1477 
g‘timeofday
(&
times
[0], 
nuÎ±r
);

1478 
g‘timeofday
(&
times
[1], 
nuÎ±r
);

1480 
ušt8_t
 
	g¿ndom_acûss_time_shiá
, 
	g¿ndom_modifiÿtiÚ_time_shiá
;

1481 
RAND_by‹s
(&
¿ndom_acûss_time_shiá
, (random_access_time_shift));

1482 
RAND_by‹s
(&
¿ndom_modifiÿtiÚ_time_shiá
,

1483 (
¿ndom_modifiÿtiÚ_time_shiá
));

1484 
	gtimes
[0].
	gtv_£c
 +ğ
¿ndom_acûss_time_shiá
;

1485 
	gtimes
[1].
	gtv_£c
 +ğ
¿ndom_modifiÿtiÚ_time_shiá
;

1487 ià(
utimes
(
·th
.
c_¡r
(), 
times
) != 0) {

1488  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1489 
ab¦
::
SŒC©
("utime çed: ", 
¡»¼Ü
(
”ºo
)));

1494 
¡©
 
	g¡©_bufãr
;

1495 ià(
¡©
(
·th
.
c_¡r
(), &
¡©_bufãr
) != 0) {

1496  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

1497 
ab¦
::
SŒC©
("¡© faed: ", 
¡»¼Ü
(
”ºo
)));

1500 ià(
	g¡©_bufãr
.
	g¡_©ime
 !ğ
times
[0].
tv_£c
) {

1501  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1505 ià(
	g¡©_bufãr
.
	g¡_mtime
 !ğ
times
[1].
tv_£c
) {

1506  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1510  
	gStus
::
OkStus
();

1513 
Stus
 
RunG‘PWUidTe¡
(
EnşaveOuut
 *
ouut
) {

1514 
SysÿÎsTe¡Ouut
 
	gouut_»t
;

1515 ià(!
EncodePassWdInTe¡Ouut
(
g‘pwuid
(
g‘uid
()), &
ouut_»t
)) {

1516  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

1520 ià(
	gouut
) {

1521 
	gouut
->
MubËEx‹nsiÚ
(
sysÿÎs_‹¡_ouut
)->
CİyFrom
(
ouut_»t
);

1523  
	gStus
::
OkStus
();

1527 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
SysÿÎsEnşave
; 
	}
}

	@platform/posix/syslog.cc

19 
	~<sys/sy¦og.h
>

21 
	~<¡d¬g.h
>

22 
	~<c¡dio
>

23 
	~<memÜy
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

29 
İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
) {

30 
’c_uÁru¡ed_İ’log
(
id’t
, 
İtiÚ
, 
çc™y
);

33 
sy¦og
(
´iÜ™y
, cÚ¡ *
fÜm©
, ...) {

34 
va_li¡
 
¬gs
;

35 
va_¡¬t
(
¬gs
, 
fÜm©
);

37 
size
 = 
v¢´štf
(
nuÎ±r
, 0, 
fÜm©
, 
¬gs
);

38 
va_’d
(
¬gs
);

41 
va_¡¬t
(
¬gs
, 
fÜm©
);

43 
¡d
::
unique_±r
<[]> 
bufãr
(
Ãw
 [
size
]);

45 
v¢´štf
(
bufãr
.
g‘
(), 
size
, 
fÜm©
, 
¬gs
);

46 
va_’d
(
¬gs
);

47 
’c_uÁru¡ed_sy¦og
(
´iÜ™y
, 
bufãr
.
g‘
());

	@platform/posix/syslog.cc

19 
	~<sys/sy¦og.h
>

21 
	~<¡d¬g.h
>

22 
	~<c¡dio
>

23 
	~<memÜy
>

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

29 
İ’log
(cÚ¡ *
id’t
, 
İtiÚ
, 
çc™y
) {

30 
’c_uÁru¡ed_İ’log
(
id’t
, 
İtiÚ
, 
çc™y
);

33 
sy¦og
(
´iÜ™y
, cÚ¡ *
fÜm©
, ...) {

34 
va_li¡
 
¬gs
;

35 
va_¡¬t
(
¬gs
, 
fÜm©
);

37 
size
 = 
v¢´štf
(
nuÎ±r
, 0, 
fÜm©
, 
¬gs
);

38 
va_’d
(
¬gs
);

41 
va_¡¬t
(
¬gs
, 
fÜm©
);

43 
¡d
::
unique_±r
<[]> 
bufãr
(
Ãw
 [
size
]);

45 
v¢´štf
(
bufãr
.
g‘
(), 
size
, 
fÜm©
, 
¬gs
);

46 
va_’d
(
¬gs
);

47 
’c_uÁru¡ed_sy¦og
(
´iÜ™y
, 
bufãr
.
g‘
());

	@platform/posix/syslog_test.cc

19 
	~<sys/sy¦og.h
>

20 
	~<sy¦og.h
>

22 
	~<funùiÚ®
>

23 
	~<¡ršg
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
LogNoScİe
(
´iÜ™y
, cÚ¡ 
¡d
::
¡ršg
 &
s
) {

32 
sy¦og
(
´iÜ™y
, "%s", 
s
.
c_¡r
());

35 
LogScİe
(
´iÜ™y
, cÚ¡ 
¡d
::
¡ršg
 &
s
) {

36 
¡d
::
¡ršg
 
Ãw_¡ršg
(
s
);

37 
sy¦og
(
´iÜ™y
, "%s", 
Ãw_¡ršg
.
c_¡r
());

40 
	g¡d
::
funùiÚ
<(, cÚ¡ std::
¡ršg
 &)> 
G‘Logg”FuncInScİe
() {

41  [](
´iÜ™y
, cÚ¡ 
	g¡d
::
¡ršg
 &
s
) {

42 
¡d
::
¡ršg
 
Ãw_¡ršg
(
s
);

43 
sy¦og
(
´iÜ™y
, "%s", 
Ãw_¡ršg
.
c_¡r
());

47 
	g¡d
::
funùiÚ
<(, cÚ¡ std::
¡ršg
 &)> 
G‘Logg”FuncOutScİe
() {

48  [](
´iÜ™y
, cÚ¡ 
	g¡d
::
¡ršg
 &
s
) {

49 
sy¦og
(
´iÜ™y
, "%s", 
s
.
c_¡r
());

53 
TEST
(
AsyloLambdaTe¡
, 
LambdaScİedTe¡
) {

54 
G‘Logg”FuncInScİe
()(
	gLOG_INFO
, "This is‡ message");

57 
TEST
(
AsyloLambdaTe¡
, 
NoLambdaScİeTe¡
) {

58 
LogScİe
(
LOG_INFO
, "This is‡ message");

61 
TEST
(
AsyloLambdaTe¡
, 
NoLambdaNoScİeTe¡
) {

62 
LogNoScİe
(
LOG_INFO
, "This is‡ message");

65 
TEST
(
AsyloLambdaTe¡
, 
LambdaNoScİedTe¡
) {

66 
G‘Logg”FuncOutScİe
()(
	gLOG_INFO
, "This is‡ message");

	@platform/posix/syslog_test.cc

19 
	~<sys/sy¦og.h
>

20 
	~<sy¦og.h
>

22 
	~<funùiÚ®
>

23 
	~<¡ršg
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
LogNoScİe
(
´iÜ™y
, cÚ¡ 
¡d
::
¡ršg
 &
s
) {

32 
sy¦og
(
´iÜ™y
, "%s", 
s
.
c_¡r
());

35 
LogScİe
(
´iÜ™y
, cÚ¡ 
¡d
::
¡ršg
 &
s
) {

36 
¡d
::
¡ršg
 
Ãw_¡ršg
(
s
);

37 
sy¦og
(
´iÜ™y
, "%s", 
Ãw_¡ršg
.
c_¡r
());

40 
	g¡d
::
funùiÚ
<(, cÚ¡ std::
¡ršg
 &)> 
G‘Logg”FuncInScİe
() {

41  [](
´iÜ™y
, cÚ¡ 
	g¡d
::
¡ršg
 &
s
) {

42 
¡d
::
¡ršg
 
Ãw_¡ršg
(
s
);

43 
sy¦og
(
´iÜ™y
, "%s", 
Ãw_¡ršg
.
c_¡r
());

47 
	g¡d
::
funùiÚ
<(, cÚ¡ std::
¡ršg
 &)> 
G‘Logg”FuncOutScİe
() {

48  [](
´iÜ™y
, cÚ¡ 
	g¡d
::
¡ršg
 &
s
) {

49 
sy¦og
(
´iÜ™y
, "%s", 
s
.
c_¡r
());

53 
TEST
(
AsyloLambdaTe¡
, 
LambdaScİedTe¡
) {

54 
G‘Logg”FuncInScİe
()(
	gLOG_INFO
, "This is‡ message");

57 
TEST
(
AsyloLambdaTe¡
, 
NoLambdaScİeTe¡
) {

58 
LogScİe
(
LOG_INFO
, "This is‡ message");

61 
TEST
(
AsyloLambdaTe¡
, 
NoLambdaNoScİeTe¡
) {

62 
LogNoScİe
(
LOG_INFO
, "This is‡ message");

65 
TEST
(
AsyloLambdaTe¡
, 
LambdaNoScİedTe¡
) {

66 
G‘Logg”FuncOutScİe
()(
	gLOG_INFO
, "This is‡ message");

	@platform/posix/termios.cc

19 
	~<sys/‹rmios.h
>

21 
	~<¡dlib.h
>

27 
tcg‘©Œ
(
fdes
, 
‹rmios
 *
‹rmios_p
è{ 
abÜt
(); }

29 
tc£‰r
(
fd
, 
İtiÚ®_aùiÚs
, cÚ¡ 
‹rmios
 *
‹rmios_p
) {

30 
abÜt
();

	@platform/posix/termios.cc

19 
	~<sys/‹rmios.h
>

21 
	~<¡dlib.h
>

27 
tcg‘©Œ
(
fdes
, 
‹rmios
 *
‹rmios_p
è{ 
abÜt
(); }

29 
tc£‰r
(
fd
, 
İtiÚ®_aùiÚs
, cÚ¡ 
‹rmios
 *
‹rmios_p
) {

30 
abÜt
();

	@platform/posix/threading/thread_manager.cc

19 
	~"asylo/¶©fÜm/posix/th»adšg/th»ad_mªag”.h
"

20 
	~<±h»ad.h
>

22 
	~<®gÜ™hm
>

23 
	~<c¡dlib
>

24 
	~<memÜy
>

26 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

28 
	~"asylo/¶©fÜm/posix/±h»ad_im¶.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

34 
Wa™FÜ
(cÚ¡ 
¡d
::
funùiÚ
<
boŞ
()> &
´ediÿ‹
, 
±h»ad_cÚd_t
 *
cÚd
,

35 
±h»ad_mu‹x_t
 *
mu‹x
) {

36 !
´ediÿ‹
()) {

37 
	g»t
 = 
±h»ad_cÚd_wa™
(
cÚd
, 
mu‹x
);

38 
CHECK_EQ
(
»t
, 0);

44 
usšg
 
	g±h»ad_im¶
::
Pth»adMu‹xLock
;

46 
boŞ
 
R‘uºF®£
(è{  
	gçl£
; }

48 
	gTh»adMªag”
::
Th»ad
::Th»ad(cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
,

49 
¡d
::
funùiÚ
<*()> 
¡¬t_routše
)

50 : 
¡¬t_routše_
(
¡d
::
move
(
¡¬t_routše
)), 
d‘ached_
(
İtiÚs
.
d‘ached
) {}

52 
	gTh»adMªag”
::
Th»ad
::
Run
() {

54 
Upd©eTh»adS‹
(
Th»adS‹
::
RUNNING
);

57 
	g»t_
 = 
¡¬t_routše_
();

60 
RunCËªupRoutšes
();

63 
Upd©eTh»adS‹
(
Th»adS‹
::
DONE
);

66 *
	gTh»adMªag”
::
Th»ad
::
G‘R‘uºV®ue
(ècÚ¡ {  
»t_
; }

68 
boŞ
 
	gTh»adMªag”
::
Th»ad
::
d‘ached
(ècÚ¡ {  
d‘ached_
; }

70 
	gTh»adMªag”
::
Th»ad
::
Upd©eTh»adId
(cÚ¡ 
±h»ad_t
 
th»ad_id
) {

71 
Pth»adMu‹xLock
 
lock
(&
lock_
);

72 
	gth»ad_id_
 = 
th»ad_id
;

75 
±h»ad_t
 
	gTh»adMªag”
::
Th»ad
::
G‘Th»adId
() {

76 
Pth»adMu‹xLock
 
lock
(&
lock_
);

77  
	gth»ad_id_
;

80 
	gTh»adMªag”
::
Th»ad
::
Upd©eTh»adS‹
(cÚ¡ 
Th»adS‹
 &
Ãw_¡©e
) {

81 
Pth»adMu‹xLock
 
lock
(&
lock_
);

82 
	gthis
->
	g¡©e_
 = 
Ãw_¡©e
;

83 
	g»t
 = 
±h»ad_cÚd_brßdÿ¡
(&
¡©e_chªge_cÚd_
);

84 
CHECK_EQ
(
»t
, 0);

87 
	gTh»adMªag”
::
Th»ad
::
Wa™FÜTh»adToEÁ”S‹
(

88 cÚ¡ 
Th»adS‹
 &
desœed_¡©e
,

89 cÚ¡ 
¡d
::
funùiÚ
<
boŞ
()> &
®‹º©ive_´ediÿ‹
) {

90 
Pth»adMu‹xLock
 
lock
(&
lock_
);

91 
Wa™FÜ
(

92 [
this
, 
desœed_¡©e
, 
®‹º©ive_´ediÿ‹
]() {

93  
¡©e_
 =ğ
desœed_¡©e
 || 
®‹º©ive_´ediÿ‹
();

95 &
¡©e_chªge_cÚd_
, &
lock_
);

98 
	gTh»adMªag”
::
Th»ad
::
Wa™FÜTh»adToEx™S‹
(

99 cÚ¡ 
Th»adS‹
 &
undesœed_¡©e
) {

100 
Pth»adMu‹xLock
 
lock
(&
lock_
);

101 
Wa™FÜ
([
this
, 
undesœed_¡©e
](è{  
¡©e_
 != undesired_state; },

102 &
¡©e_chªge_cÚd_
, &
lock_
);

105 
	gTh»adMªag”
::
Th»ad
::
D‘ach
() {

106 
Pth»adMu‹xLock
 
lock
(&
lock_
);

107 
	g»t
 = 
±h»ad_cÚd_brßdÿ¡
(&
¡©e_chªge_cÚd_
);

108 
CHECK_EQ
(
»t
, 0);

109 
	gd‘ached_
 = 
Œue
;

112 
	gTh»adMªag”
::
Th»ad
::
PushCËªupRoutše
(

113 cÚ¡ 
¡d
::
funùiÚ
<()> &
func
) {

114 
ş—nup_funùiÚs_
.
push
(
func
);

117 
	gTh»adMªag”
::
Th»ad
::
PİCËªupRoutše
(
boŞ
 
execu‹
) {

121 
CHECK
(!
ş—nup_funùiÚs_
.
em±y
());

123 
	g¡d
::
funùiÚ
<()> 
func
 = 
ş—nup_funùiÚs_
.
tİ
();

124 
	gş—nup_funùiÚs_
.
pİ
();

126 ià(
	gexecu‹
) {

127 
func
();

131 
	gTh»adMªag”
::
Th»ad
::
RunCËªupRoutšes
() {

132 !
ş—nup_funùiÚs_
.
em±y
()) {

133 
PİCËªupRoutše
Ğ
Œue
);

137 
Th»adMªag”
 *
	gTh»adMªag”
::
G‘In¡ªû
() {

138 
Th»adMªag”
 *
š¡ªû
 = 
Ãw
 ThreadManager();

139  
	gš¡ªû
;

142 
	g¡d
::
sh¬ed_±r
<
Th»adMªag”
::
Th»ad
> Th»adMªag”::
EnqueueTh»ad
(

143 cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
,

144 cÚ¡ 
¡d
::
funùiÚ
<*()> &
¡¬t_routše
) {

145 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

147 
	gqueued_th»ads_
.
em¶aû
(
¡d
::
make_sh¬ed
<
Th»ad
>(
İtiÚs
, 
¡¬t_routše
));

148 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
queued_th»ads_
.
back
();

151 
CHECK
(
th»ad
 !ğ
nuÎ±r
);

153 
±h»ad_cÚd_brßdÿ¡
(&
th»ads_cÚd_
);

154  
	gth»ad
;

157 
	g¡d
::
sh¬ed_±r
<
Th»adMªag”
::
Th»ad
> Th»adMªag”::
DequeueTh»ad
() {

158 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

163 
CHECK
(!
queued_th»ads_
.
em±y
());

165 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
queued_th»ads_
.
äÚt
();

166 
	gqueued_th»ads_
.
pİ
();

170 cÚ¡ 
±h»ad_t
 
	gth»ad_id
 = 
±h»ad_£lf
();

171 
	gth»ad
->
Upd©eTh»adId
(
th»ad_id
);

173 
	gth»ads_
[
th»ad_id
] = 
th»ad
;

175 
±h»ad_cÚd_brßdÿ¡
(&
th»ads_cÚd_
);

176  
	gth»ad
;

179 
	gTh»adMªag”
::
C»©eTh»ad
(cÚ¡ 
¡d
::
funùiÚ
<*()> &
¡¬t_routše
,

180 cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
,

181 
±h»ad_t
 *cÚ¡ 
th»ad_id_out
) {

182 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
EnqueueTh»ad
(
İtiÚs
, 
¡¬t_routše
);

185 ià(
’c_uÁru¡ed_ü—‹_th»ad
(
G‘EnşaveName
().
c_¡r
())) {

186  
	gECHILD
;

190 
	gth»ad
->
Wa™FÜTh»adToEx™S‹
(
Th»ad
::
Th»adS‹
::
QUEUED
);

192 ià(
	gth»ad_id_out
 !ğ
nuÎ±r
) {

193 *
th»ad_id_out
 = 
th»ad
->
G‘Th»adId
();

201 
	gTh»adMªag”
::
S¹Th»ad
() {

202 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
DequeueTh»ad
();

205 
	gth»ad
->
Run
();

209 
	gth»ad
->
Wa™FÜTh»adToEÁ”S‹
(
Th»ad
::
Th»adS‹
::
JOINED
,

210 
¡d
::
bšd
(&
Th»ad
::
d‘ached
, 
th»ad
));

212 
Pth»adMu‹xLock
 
th»ads_lock
(&
th»ads_lock_
);

213 
	gth»ads_
.
”a£
(
±h»ad_£lf
());

214 
±h»ad_cÚd_brßdÿ¡
(&
th»ads_cÚd_
);

219 
	gTh»adMªag”
::
JošTh»ad
(cÚ¡ 
±h»ad_t
 
th»ad_id
,

220 **
»tuº_v®ue_out
) {

221 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
th»ad_id
);

222 ià(
	gth»ad
 =ğ
nuÎ±r
) {

223  
ESRCH
;

227 
	gth»ad
->
Wa™FÜTh»adToEÁ”S‹
(
Th»ad
::
Th»adS‹
::
DONE
,

228 
¡d
::
bšd
(&
Th»ad
::
d‘ached
, 
th»ad
));

230 ià(
	gth»ad
->
d‘ached
()) {

231  
	gEINVAL
;

234 ià(
	g»tuº_v®ue_out
 !ğ
nuÎ±r
) {

235 *
»tuº_v®ue_out
 = 
th»ad
->
G‘R‘uºV®ue
();

238 
	gth»ad
->
Upd©eTh»adS‹
(
Th»ad
::
Th»adS‹
::
JOINED
);

243 
	gTh»adMªag”
::
D‘achTh»ad
(cÚ¡ 
±h»ad_t
 
th»ad_id
) {

244 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
th»ad_id
);

245 ià(
	gth»ad
 =ğ
nuÎ±r
) {

246  
ESRCH
;

249 ià(
	gth»ad
->
d‘ached
()) {

250  
	gEINVAL
;

253 
	gth»ad
->
D‘ach
();

258 
	g¡d
::
sh¬ed_±r
<
Th»adMªag”
::
Th»ad
> Th»adMªag”::
G‘Th»ad
(

259 
±h»ad_t
 
th»ad_id
) {

260 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

261 autØ
	g™
 = 
th»ads_
.
fšd
(
th»ad_id
);

262 ià(
	g™
 =ğ
th»ads_
.
’d
()) {

263  
nuÎ±r
;

265  
	g™
->
	g£cÚd
;

268 
	gTh»adMªag”
::
PushCËªupRoutše
(cÚ¡ 
¡d
::
funùiÚ
<()> &
func
) {

269 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
±h»ad_£lf
());

273 
CHECK
(
th»ad
 !ğ
nuÎ±r
);

276 
	gth»ad
->
PushCËªupRoutše
(
func
);

279 
	gTh»adMªag”
::
PİCËªupRoutše
(
boŞ
 
execu‹
) {

280 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
±h»ad_£lf
());

284 
CHECK
(
th»ad
 !ğ
nuÎ±r
);

287 
	gth»ad
->
PİCËªupRoutše
(
execu‹
);

290 
	gTh»adMªag”
::
Fš®ize
() {

293 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

294 
Wa™FÜ
([
this
](è{  
queued_th»ads_
.
em±y
(è&& 
th»ads_
.empty(); },

295 &
th»ads_cÚd_
, &
th»ads_lock_
);

	@platform/posix/threading/thread_manager.cc

19 
	~"asylo/¶©fÜm/posix/th»adšg/th»ad_mªag”.h
"

20 
	~<±h»ad.h
>

22 
	~<®gÜ™hm
>

23 
	~<c¡dlib
>

24 
	~<memÜy
>

26 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

28 
	~"asylo/¶©fÜm/posix/±h»ad_im¶.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

34 
Wa™FÜ
(cÚ¡ 
¡d
::
funùiÚ
<
boŞ
()> &
´ediÿ‹
, 
±h»ad_cÚd_t
 *
cÚd
,

35 
±h»ad_mu‹x_t
 *
mu‹x
) {

36 !
´ediÿ‹
()) {

37 
	g»t
 = 
±h»ad_cÚd_wa™
(
cÚd
, 
mu‹x
);

38 
CHECK_EQ
(
»t
, 0);

44 
usšg
 
	g±h»ad_im¶
::
Pth»adMu‹xLock
;

46 
boŞ
 
R‘uºF®£
(è{  
	gçl£
; }

48 
	gTh»adMªag”
::
Th»ad
::Th»ad(cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
,

49 
¡d
::
funùiÚ
<*()> 
¡¬t_routše
)

50 : 
¡¬t_routše_
(
¡d
::
move
(
¡¬t_routše
)), 
d‘ached_
(
İtiÚs
.
d‘ached
) {}

52 
	gTh»adMªag”
::
Th»ad
::
Run
() {

54 
Upd©eTh»adS‹
(
Th»adS‹
::
RUNNING
);

57 
	g»t_
 = 
¡¬t_routše_
();

60 
RunCËªupRoutšes
();

63 
Upd©eTh»adS‹
(
Th»adS‹
::
DONE
);

66 *
	gTh»adMªag”
::
Th»ad
::
G‘R‘uºV®ue
(ècÚ¡ {  
»t_
; }

68 
boŞ
 
	gTh»adMªag”
::
Th»ad
::
d‘ached
(ècÚ¡ {  
d‘ached_
; }

70 
	gTh»adMªag”
::
Th»ad
::
Upd©eTh»adId
(cÚ¡ 
±h»ad_t
 
th»ad_id
) {

71 
Pth»adMu‹xLock
 
lock
(&
lock_
);

72 
	gth»ad_id_
 = 
th»ad_id
;

75 
±h»ad_t
 
	gTh»adMªag”
::
Th»ad
::
G‘Th»adId
() {

76 
Pth»adMu‹xLock
 
lock
(&
lock_
);

77  
	gth»ad_id_
;

80 
	gTh»adMªag”
::
Th»ad
::
Upd©eTh»adS‹
(cÚ¡ 
Th»adS‹
 &
Ãw_¡©e
) {

81 
Pth»adMu‹xLock
 
lock
(&
lock_
);

82 
	gthis
->
	g¡©e_
 = 
Ãw_¡©e
;

83 
	g»t
 = 
±h»ad_cÚd_brßdÿ¡
(&
¡©e_chªge_cÚd_
);

84 
CHECK_EQ
(
»t
, 0);

87 
	gTh»adMªag”
::
Th»ad
::
Wa™FÜTh»adToEÁ”S‹
(

88 cÚ¡ 
Th»adS‹
 &
desœed_¡©e
,

89 cÚ¡ 
¡d
::
funùiÚ
<
boŞ
()> &
®‹º©ive_´ediÿ‹
) {

90 
Pth»adMu‹xLock
 
lock
(&
lock_
);

91 
Wa™FÜ
(

92 [
this
, 
desœed_¡©e
, 
®‹º©ive_´ediÿ‹
]() {

93  
¡©e_
 =ğ
desœed_¡©e
 || 
®‹º©ive_´ediÿ‹
();

95 &
¡©e_chªge_cÚd_
, &
lock_
);

98 
	gTh»adMªag”
::
Th»ad
::
Wa™FÜTh»adToEx™S‹
(

99 cÚ¡ 
Th»adS‹
 &
undesœed_¡©e
) {

100 
Pth»adMu‹xLock
 
lock
(&
lock_
);

101 
Wa™FÜ
([
this
, 
undesœed_¡©e
](è{  
¡©e_
 != undesired_state; },

102 &
¡©e_chªge_cÚd_
, &
lock_
);

105 
	gTh»adMªag”
::
Th»ad
::
D‘ach
() {

106 
Pth»adMu‹xLock
 
lock
(&
lock_
);

107 
	g»t
 = 
±h»ad_cÚd_brßdÿ¡
(&
¡©e_chªge_cÚd_
);

108 
CHECK_EQ
(
»t
, 0);

109 
	gd‘ached_
 = 
Œue
;

112 
	gTh»adMªag”
::
Th»ad
::
PushCËªupRoutše
(

113 cÚ¡ 
¡d
::
funùiÚ
<()> &
func
) {

114 
ş—nup_funùiÚs_
.
push
(
func
);

117 
	gTh»adMªag”
::
Th»ad
::
PİCËªupRoutše
(
boŞ
 
execu‹
) {

121 
CHECK
(!
ş—nup_funùiÚs_
.
em±y
());

123 
	g¡d
::
funùiÚ
<()> 
func
 = 
ş—nup_funùiÚs_
.
tİ
();

124 
	gş—nup_funùiÚs_
.
pİ
();

126 ià(
	gexecu‹
) {

127 
func
();

131 
	gTh»adMªag”
::
Th»ad
::
RunCËªupRoutšes
() {

132 !
ş—nup_funùiÚs_
.
em±y
()) {

133 
PİCËªupRoutše
Ğ
Œue
);

137 
Th»adMªag”
 *
	gTh»adMªag”
::
G‘In¡ªû
() {

138 
Th»adMªag”
 *
š¡ªû
 = 
Ãw
 ThreadManager();

139  
	gš¡ªû
;

142 
	g¡d
::
sh¬ed_±r
<
Th»adMªag”
::
Th»ad
> Th»adMªag”::
EnqueueTh»ad
(

143 cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
,

144 cÚ¡ 
¡d
::
funùiÚ
<*()> &
¡¬t_routše
) {

145 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

147 
	gqueued_th»ads_
.
em¶aû
(
¡d
::
make_sh¬ed
<
Th»ad
>(
İtiÚs
, 
¡¬t_routše
));

148 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
queued_th»ads_
.
back
();

151 
CHECK
(
th»ad
 !ğ
nuÎ±r
);

153 
±h»ad_cÚd_brßdÿ¡
(&
th»ads_cÚd_
);

154  
	gth»ad
;

157 
	g¡d
::
sh¬ed_±r
<
Th»adMªag”
::
Th»ad
> Th»adMªag”::
DequeueTh»ad
() {

158 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

163 
CHECK
(!
queued_th»ads_
.
em±y
());

165 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
queued_th»ads_
.
äÚt
();

166 
	gqueued_th»ads_
.
pİ
();

170 cÚ¡ 
±h»ad_t
 
	gth»ad_id
 = 
±h»ad_£lf
();

171 
	gth»ad
->
Upd©eTh»adId
(
th»ad_id
);

173 
	gth»ads_
[
th»ad_id
] = 
th»ad
;

175 
±h»ad_cÚd_brßdÿ¡
(&
th»ads_cÚd_
);

176  
	gth»ad
;

179 
	gTh»adMªag”
::
C»©eTh»ad
(cÚ¡ 
¡d
::
funùiÚ
<*()> &
¡¬t_routše
,

180 cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
,

181 
±h»ad_t
 *cÚ¡ 
th»ad_id_out
) {

182 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
EnqueueTh»ad
(
İtiÚs
, 
¡¬t_routše
);

185 ià(
’c_uÁru¡ed_ü—‹_th»ad
(
G‘EnşaveName
().
c_¡r
())) {

186  
	gECHILD
;

190 
	gth»ad
->
Wa™FÜTh»adToEx™S‹
(
Th»ad
::
Th»adS‹
::
QUEUED
);

192 ià(
	gth»ad_id_out
 !ğ
nuÎ±r
) {

193 *
th»ad_id_out
 = 
th»ad
->
G‘Th»adId
();

201 
	gTh»adMªag”
::
S¹Th»ad
() {

202 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
DequeueTh»ad
();

205 
	gth»ad
->
Run
();

209 
	gth»ad
->
Wa™FÜTh»adToEÁ”S‹
(
Th»ad
::
Th»adS‹
::
JOINED
,

210 
¡d
::
bšd
(&
Th»ad
::
d‘ached
, 
th»ad
));

212 
Pth»adMu‹xLock
 
th»ads_lock
(&
th»ads_lock_
);

213 
	gth»ads_
.
”a£
(
±h»ad_£lf
());

214 
±h»ad_cÚd_brßdÿ¡
(&
th»ads_cÚd_
);

219 
	gTh»adMªag”
::
JošTh»ad
(cÚ¡ 
±h»ad_t
 
th»ad_id
,

220 **
»tuº_v®ue_out
) {

221 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
th»ad_id
);

222 ià(
	gth»ad
 =ğ
nuÎ±r
) {

223  
ESRCH
;

227 
	gth»ad
->
Wa™FÜTh»adToEÁ”S‹
(
Th»ad
::
Th»adS‹
::
DONE
,

228 
¡d
::
bšd
(&
Th»ad
::
d‘ached
, 
th»ad
));

230 ià(
	gth»ad
->
d‘ached
()) {

231  
	gEINVAL
;

234 ià(
	g»tuº_v®ue_out
 !ğ
nuÎ±r
) {

235 *
»tuº_v®ue_out
 = 
th»ad
->
G‘R‘uºV®ue
();

238 
	gth»ad
->
Upd©eTh»adS‹
(
Th»ad
::
Th»adS‹
::
JOINED
);

243 
	gTh»adMªag”
::
D‘achTh»ad
(cÚ¡ 
±h»ad_t
 
th»ad_id
) {

244 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
th»ad_id
);

245 ià(
	gth»ad
 =ğ
nuÎ±r
) {

246  
ESRCH
;

249 ià(
	gth»ad
->
d‘ached
()) {

250  
	gEINVAL
;

253 
	gth»ad
->
D‘ach
();

258 
	g¡d
::
sh¬ed_±r
<
Th»adMªag”
::
Th»ad
> Th»adMªag”::
G‘Th»ad
(

259 
±h»ad_t
 
th»ad_id
) {

260 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

261 autØ
	g™
 = 
th»ads_
.
fšd
(
th»ad_id
);

262 ià(
	g™
 =ğ
th»ads_
.
’d
()) {

263  
nuÎ±r
;

265  
	g™
->
	g£cÚd
;

268 
	gTh»adMªag”
::
PushCËªupRoutše
(cÚ¡ 
¡d
::
funùiÚ
<()> &
func
) {

269 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
±h»ad_£lf
());

273 
CHECK
(
th»ad
 !ğ
nuÎ±r
);

276 
	gth»ad
->
PushCËªupRoutše
(
func
);

279 
	gTh»adMªag”
::
PİCËªupRoutše
(
boŞ
 
execu‹
) {

280 
¡d
::
sh¬ed_±r
<
Th»ad
> 
th»ad
 = 
G‘Th»ad
(
±h»ad_£lf
());

284 
CHECK
(
th»ad
 !ğ
nuÎ±r
);

287 
	gth»ad
->
PİCËªupRoutše
(
execu‹
);

290 
	gTh»adMªag”
::
Fš®ize
() {

293 
Pth»adMu‹xLock
 
lock
(&
th»ads_lock_
);

294 
Wa™FÜ
([
this
](è{  
queued_th»ads_
.
em±y
(è&& 
th»ads_
.empty(); },

295 &
th»ads_cÚd_
, &
th»ads_lock_
);

	@platform/posix/threading/thread_manager.h

19 #iâdeà
ASYLO_PLATFORM_POSIX_THREADING_THREAD_MANAGER_H_


20 
	#ASYLO_PLATFORM_POSIX_THREADING_THREAD_MANAGER_H_


	)

22 
	~<±h»ad.h
>

23 
	~<©omic
>

24 
	~<funùiÚ®
>

25 
	~<memÜy
>

26 
	~<queue
>

27 
	~<¡ack
>

28 
	~<ut™y
>

30 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

32 
Çme¥aû
 
	gasylo
 {

34 
boŞ
 
R‘uºF®£
();

38 şas 
	cTh»adMªag”
 {

39 
	gpublic
:

40 
Th»adMªag”
 *
G‘In¡ªû
();

43 
	sTh»adO±iÚs
 {

45 
boŞ
 
	gd‘ached
 = 
çl£
;

52 
C»©eTh»ad
(cÚ¡ 
¡d
::
funùiÚ
<*()> &
¡¬t_routše
,

53 cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
, 
±h»ad_t
 *
th»ad_id_out
);

57 
S¹Th»ad
();

61 
JošTh»ad
(
±h»ad_t
 
th»ad_id
, **
»tuº_v®ue_out
);

64 
D‘achTh»ad
(
±h»ad_t
 
th»ad_id
);

67 
PushCËªupRoutše
(cÚ¡ 
¡d
::
funùiÚ
<()> &
func
);

71 
PİCËªupRoutše
(
boŞ
 
execu‹
);

77 
Fš®ize
();

79 
	g´iv©e
:

80 
Th»adMªag”
() = ;

81 
Th»adMªag”
(Th»adMªag” cÚ¡ &èğ
d–‘e
;

82 
	gİ”©Ü
=(
Th»adMªag”
 cÚ¡ &èğ
d–‘e
;

85 şas 
	cTh»ad
 {

86 
	gpublic
:

87 şas 
	cTh»adS‹
 { 
QUEUED
, 
	gRUNNING
, 
	gDONE
, 
	gJOINED
 };

90 
Th»ad
(cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
, 
¡d
::
funùiÚ
<*()> 
¡¬t_routše
);

92 ~
Th»ad
() = ;

96 
Run
();

99 *
G‘R‘uºV®ue
() const;

103 
boŞ
 
d‘ached
() const;

107 
Upd©eTh»adId
(
±h»ad_t
 
th»ad_id
);

110 
±h»ad_t
 
G‘Th»adId
();

114 
Upd©eTh»adS‹
(cÚ¡ 
Th»adS‹
 &
¡©e
);

118 
Wa™FÜTh»adToEÁ”S‹
(

119 cÚ¡ 
Th»adS‹
 &
¡©e
,

120 cÚ¡ 
¡d
::
funùiÚ
<
boŞ
()> &
®‹º©ive_´ediÿ‹
 = 
R‘uºF®£
);

123 
Wa™FÜTh»adToEx™S‹
(cÚ¡ 
Th»adS‹
 &
¡©e
);

126 
D‘ach
();

129 
PushCËªupRoutše
(cÚ¡ 
¡d
::
funùiÚ
<()> &
func
);

133 
PİCËªupRoutše
(
boŞ
 
execu‹
);

135 
	g´iv©e
:

138 
RunCËªupRoutšes
();

141 cÚ¡ 
	g¡d
::
funùiÚ
<*()> 
¡¬t_routše_
;

144 *
	g»t_
;

147 
±h»ad_t
 
	gth»ad_id_
;

150 
±h»ad_mu‹x_t
 
	glock_
 = 
PTHREAD_MUTEX_INITIALIZER
;

151 
±h»ad_cÚd_t
 
	g¡©e_chªge_cÚd_
 = 
PTHREAD_COND_INITIALIZER
;

152 
Th»adS‹
 
	g¡©e_
 = Th»adS‹::
QUEUED
;

153 
boŞ
 
	gd‘ached_
 = 
çl£
;

157 
	g¡d
::
¡ack
<
¡d
::
funùiÚ
<()>> 
ş—nup_funùiÚs_
;

163 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
EnqueueTh»ad
(

164 cÚ¡ 
Th»adO±iÚs
 &
İtiÚs
,

165 cÚ¡ 
¡d
::
funùiÚ
<*()> &
¡¬t_routše
);

170 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
DequeueTh»ad
();

173 
	g¡d
::
sh¬ed_±r
<
Th»ad
> 
G‘Th»ad
(
±h»ad_t
 
th»ad_id
);

176 
±h»ad_mu‹x_t
 
	gth»ads_lock_
 = 
PTHREAD_MUTEX_INITIALIZER
;

177 
±h»ad_cÚd_t
 
	gth»ads_cÚd_
 = 
PTHREAD_COND_INITIALIZER
;

182 
	g¡d
::
queue
<
¡d
::
sh¬ed_±r
<
Th»ad
>> 
queued_th»ads_
;

185 
	gab¦
::
æ©_hash_m­
<
±h»ad_t
, 
	g¡d
::
sh¬ed_±r
<
Th»ad
>> 
th»ads_
;

	@platform/posix/time.cc

19 
	~<sys/time.h
>

20 
	~<time.h
>

21 
	~<©omic
>

22 
	~<c¡ršg
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/time.h
"

26 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

27 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme.h
"

28 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

29 
	~"šşude/sgx_Œts.h
"

31 
usšg
 
	gasylo
::
Nªo£cÚdsToTimeS³c
;

32 
usšg
 
	gasylo
::
Nªo£cÚdsToTimeV®
;

33 
usšg
 
	gasylo
::
Sh¬edName
;

34 
usšg
 
	gasylo
::
TimeS³cToNªo£cÚds
;

36 
	gÇme¥aû
 {

39 
¡©ic_as£¹
((
¡d
::
©omic
<
št64_t
>) == (int64_t),

44 
	g¡d
::
©omic
<
št64_t
> *
G‘ClockAdd»ssOrD›
(cÚ¡ *
Çme
) {

45 *
addr
 = 
’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(
kAdd»ssName
, 
Çme
);

46 ià(!
	gaddr
 || !
’c_is_outside_’şave
(
addr
, (
¡d
::
©omic
<
št64_t
>))) {

47 
abÜt
();

49  
	g¡©ic_ÿ¡
<
	g¡d
::
©omic
<
št64_t
> *>(
addr
);

53 
šlše
 
št64_t
 
MÚÙÚicClock
() {

54 
	g¡d
::
©omic
<
št64_t
> *
şock_mÚÙÚic
 =

55 
G‘ClockAdd»ssOrD›
("clock_monotonic");

56 
th»ad_loÿl
 
št64_t
 
	gÏ¡_tick
 = *
şock_mÚÙÚic
;

57 ià(*
	gşock_mÚÙÚic
 < 
	gÏ¡_tick
è
abÜt
();

58 
	gÏ¡_tick
 = *
şock_mÚÙÚic
;

59  *
	gşock_mÚÙÚic
;

63 
šlše
 
št64_t
 
R—ÉimeClock
() {

64 
	g¡d
::
©omic
<
št64_t
> *
şock_»®time
 =

65 
G‘ClockAdd»ssOrD›
("clock_realtime");

66  *
	gşock_»®time
;

70 
busy_¦“p
(cÚ¡ 
time¥ec
 *
»que¡ed
) {

71 
št64_t
 
	gd—dlše
 = 
MÚÙÚicClock
(è+ 
TimeS³cToNªo£cÚds
(
»que¡ed
);

72 
MÚÙÚicClock
(è< 
	gd—dlše
) {

73 
__butš_Ÿ32_·u£
();

85 
Çno¦“p
(cÚ¡ 
time¥ec
 *
»que¡ed
, time¥eø*
»mašd”
) {

87 
cÚ¡ex´
 
št64_t
 
kEx™Th»shŞd
 = 
INT64_C
(3000000);

88 
št64_t
 
d–ay
 = 
TimeS³cToNªo£cÚds
(
»que¡ed
);

89 ià(
d–ay
 > 
kEx™Th»shŞd
) {

90  
’c_uÁru¡ed_Çno¦“p
(
»que¡ed
, 
»mašd”
);

93 ià(
»mašd”
) {

94 
Nªo£cÚdsToTimeS³c
(
»mašd”
, 0);

96  
busy_¦“p
(
»que¡ed
);

99 
’şave_g‘timeofday
(
timev®
 *
__»¡riù
 
time
, *
timezÚe
) {

100 
Nªo£cÚdsToTimeV®
(
time
, 
R—ÉimeClock
());

102 ià(
timezÚe
) {

109 
’şave_times
(
tms
 *
buf
è{  
’c_uÁru¡ed_times
(buf); }

111 
şock_g‘time
(
şockid_t
 
şock_id
, 
time¥ec
 *
time
) {

112 
şock_id
) {

113 
CLOCK_MONOTONIC
:

114 
Nªo£cÚdsToTimeS³c
(
time
, 
MÚÙÚicClock
());

116 
CLOCK_REALTIME
:

117 
Nªo£cÚdsToTimeS³c
(
time
, 
R—ÉimeClock
());

124 
g‘™im”
(
which
, 
™im”v®
 *
cu¼_v®ue
) {

125  
’c_uÁru¡ed_g‘™im”
(
which
, 
cu¼_v®ue
);

128 
£t™im”
(
which
, cÚ¡ 
™im”v®
 *
Ãw_v®ue
,

129 
™im”v®
 *
Şd_v®ue
) {

130  
’c_uÁru¡ed_£t™im”
(
which
, 
Ãw_v®ue
, 
Şd_v®ue
);

	@platform/posix/time.cc

19 
	~<sys/time.h
>

20 
	~<time.h
>

21 
	~<©omic
>

22 
	~<c¡ršg
>

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/time.h
"

26 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

27 
	~"asylo/¶©fÜm/cÜe/sh¬ed_Çme.h
"

28 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

29 
	~"šşude/sgx_Œts.h
"

31 
usšg
 
	gasylo
::
Nªo£cÚdsToTimeS³c
;

32 
usšg
 
	gasylo
::
Nªo£cÚdsToTimeV®
;

33 
usšg
 
	gasylo
::
Sh¬edName
;

34 
usšg
 
	gasylo
::
TimeS³cToNªo£cÚds
;

36 
	gÇme¥aû
 {

39 
¡©ic_as£¹
((
¡d
::
©omic
<
št64_t
>) == (int64_t),

44 
	g¡d
::
©omic
<
št64_t
> *
G‘ClockAdd»ssOrD›
(cÚ¡ *
Çme
) {

45 *
addr
 = 
’c_uÁru¡ed_acquœe_sh¬ed_»sourû
(
kAdd»ssName
, 
Çme
);

46 ià(!
	gaddr
 || !
’c_is_outside_’şave
(
addr
, (
¡d
::
©omic
<
št64_t
>))) {

47 
abÜt
();

49  
	g¡©ic_ÿ¡
<
	g¡d
::
©omic
<
št64_t
> *>(
addr
);

53 
šlše
 
št64_t
 
MÚÙÚicClock
() {

54 
	g¡d
::
©omic
<
št64_t
> *
şock_mÚÙÚic
 =

55 
G‘ClockAdd»ssOrD›
("clock_monotonic");

56 
th»ad_loÿl
 
št64_t
 
	gÏ¡_tick
 = *
şock_mÚÙÚic
;

57 ià(*
	gşock_mÚÙÚic
 < 
	gÏ¡_tick
è
abÜt
();

58 
	gÏ¡_tick
 = *
şock_mÚÙÚic
;

59  *
	gşock_mÚÙÚic
;

63 
šlše
 
št64_t
 
R—ÉimeClock
() {

64 
	g¡d
::
©omic
<
št64_t
> *
şock_»®time
 =

65 
G‘ClockAdd»ssOrD›
("clock_realtime");

66  *
	gşock_»®time
;

70 
busy_¦“p
(cÚ¡ 
time¥ec
 *
»que¡ed
) {

71 
št64_t
 
	gd—dlše
 = 
MÚÙÚicClock
(è+ 
TimeS³cToNªo£cÚds
(
»que¡ed
);

72 
MÚÙÚicClock
(è< 
	gd—dlše
) {

73 
__butš_Ÿ32_·u£
();

85 
Çno¦“p
(cÚ¡ 
time¥ec
 *
»que¡ed
, time¥eø*
»mašd”
) {

87 
cÚ¡ex´
 
št64_t
 
kEx™Th»shŞd
 = 
INT64_C
(3000000);

88 
št64_t
 
d–ay
 = 
TimeS³cToNªo£cÚds
(
»que¡ed
);

89 ià(
d–ay
 > 
kEx™Th»shŞd
) {

90  
’c_uÁru¡ed_Çno¦“p
(
»que¡ed
, 
»mašd”
);

93 ià(
»mašd”
) {

94 
Nªo£cÚdsToTimeS³c
(
»mašd”
, 0);

96  
busy_¦“p
(
»que¡ed
);

99 
’şave_g‘timeofday
(
timev®
 *
__»¡riù
 
time
, *
timezÚe
) {

100 
Nªo£cÚdsToTimeV®
(
time
, 
R—ÉimeClock
());

102 ià(
timezÚe
) {

109 
’şave_times
(
tms
 *
buf
è{  
’c_uÁru¡ed_times
(buf); }

111 
şock_g‘time
(
şockid_t
 
şock_id
, 
time¥ec
 *
time
) {

112 
şock_id
) {

113 
CLOCK_MONOTONIC
:

114 
Nªo£cÚdsToTimeS³c
(
time
, 
MÚÙÚicClock
());

116 
CLOCK_REALTIME
:

117 
Nªo£cÚdsToTimeS³c
(
time
, 
R—ÉimeClock
());

124 
g‘™im”
(
which
, 
™im”v®
 *
cu¼_v®ue
) {

125  
’c_uÁru¡ed_g‘™im”
(
which
, 
cu¼_v®ue
);

128 
£t™im”
(
which
, cÚ¡ 
™im”v®
 *
Ãw_v®ue
,

129 
™im”v®
 *
Şd_v®ue
) {

130  
’c_uÁru¡ed_£t™im”
(
which
, 
Ãw_v®ue
, 
Şd_v®ue
);

	@platform/posix/times_test.cc

19 
	~<sys/times.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
TEST
(
TimesTe¡
, 
TimesInüem’tšg
) {

28 
tms
 
	gfœ¡_times
;

29 
şock_t
 
	g”rÜ_v®ue
 = 
¡©ic_ÿ¡
<clock_t>(-1);

30 
	gfœ¡_times
.
	gtms_utime
 = 
”rÜ_v®ue
;

31 
	gfœ¡_times
.
	gtms_¡ime
 = 
”rÜ_v®ue
;

32 
EXPECT_NE
(
times
(&
fœ¡_times
), 
”rÜ_v®ue
);

33 
EXPECT_NE
(
fœ¡_times
.
tms_utime
, 
”rÜ_v®ue
);

34 
EXPECT_NE
(
fœ¡_times
.
tms_¡ime
, 
”rÜ_v®ue
);

35 
tms
 
	g£cÚd_times
;

36 
	g£cÚd_times
.
	gtms_utime
 = 
”rÜ_v®ue
;

37 
	g£cÚd_times
.
	gtms_¡ime
 = 
”rÜ_v®ue
;

38 
EXPECT_NE
(
times
(&
£cÚd_times
), 
”rÜ_v®ue
);

39 
EXPECT_NE
(
£cÚd_times
.
tms_utime
, 
”rÜ_v®ue
);

40 
EXPECT_NE
(
£cÚd_times
.
tms_¡ime
, 
”rÜ_v®ue
);

41 
EXPECT_GE
(
£cÚd_times
.
tms_utime
, 
fœ¡_times
.tms_utime);

42 
EXPECT_GE
(
£cÚd_times
.
tms_¡ime
, 
fœ¡_times
.tms_stime);

	@platform/posix/times_test.cc

19 
	~<sys/times.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
TEST
(
TimesTe¡
, 
TimesInüem’tšg
) {

28 
tms
 
	gfœ¡_times
;

29 
şock_t
 
	g”rÜ_v®ue
 = 
¡©ic_ÿ¡
<clock_t>(-1);

30 
	gfœ¡_times
.
	gtms_utime
 = 
”rÜ_v®ue
;

31 
	gfœ¡_times
.
	gtms_¡ime
 = 
”rÜ_v®ue
;

32 
EXPECT_NE
(
times
(&
fœ¡_times
), 
”rÜ_v®ue
);

33 
EXPECT_NE
(
fœ¡_times
.
tms_utime
, 
”rÜ_v®ue
);

34 
EXPECT_NE
(
fœ¡_times
.
tms_¡ime
, 
”rÜ_v®ue
);

35 
tms
 
	g£cÚd_times
;

36 
	g£cÚd_times
.
	gtms_utime
 = 
”rÜ_v®ue
;

37 
	g£cÚd_times
.
	gtms_¡ime
 = 
”rÜ_v®ue
;

38 
EXPECT_NE
(
times
(&
£cÚd_times
), 
”rÜ_v®ue
);

39 
EXPECT_NE
(
£cÚd_times
.
tms_utime
, 
”rÜ_v®ue
);

40 
EXPECT_NE
(
£cÚd_times
.
tms_¡ime
, 
”rÜ_v®ue
);

41 
EXPECT_GE
(
£cÚd_times
.
tms_utime
, 
fœ¡_times
.tms_utime);

42 
EXPECT_GE
(
£cÚd_times
.
tms_¡ime
, 
fœ¡_times
.tms_stime);

	@platform/posix/uio.cc

19 
	~<sys/uio.h
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
ssize_t
 
wr™ev
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

28  
IOMªag”
::
G‘In¡ªû
().
Wr™ev
(
fd
, 
iov
, 
iovút
);

31 
ssize_t
 
»adv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

32  
IOMªag”
::
G‘In¡ªû
().
R—dv
(
fd
, 
iov
, 
iovút
);

	@platform/posix/uio.cc

19 
	~<sys/uio.h
>

21 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

23 
usšg
 
	gasylo
::
io
::
IOMªag”
;

27 
ssize_t
 
wr™ev
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

28  
IOMªag”
::
G‘In¡ªû
().
Wr™ev
(
fd
, 
iov
, 
iovút
);

31 
ssize_t
 
»adv
(
fd
, cÚ¡ 
iovec
 *
iov
, 
iovút
) {

32  
IOMªag”
::
G‘In¡ªû
().
R—dv
(
fd
, 
iov
, 
iovút
);

	@platform/posix/unistd.cc

19 
	~<uni¡d.h
>

21 
	~<sys/¡©.h
>

22 
	~<sys/wa™.h
>

23 
	~<c¡dlib
>

24 
	~<c¡ršg
>

26 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

27 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

28 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

29 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
usšg
 
	gasylo
::
io
::
IOMªag”
;

35 
cÚ¡ex´
 
size_t
 
	gkPageSize
 = 4096;

37 
	gÇme¥aû
 {

39 
pid_t
 
FÜkEnşave
() {

40 
	gasylo
::
StusOr
<cÚ¡ 
asylo
::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

41 
asylo
::
G‘EnşaveCÚfig
();

43 ià(!
	gcÚfig_»suÉ
.
ok
()) {

44 
	g”ºo
 = 
EFAULT
;

48 cÚ¡ 
	gasylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

49 ià(!
	gcÚfig
->
has_’abË_fÜk
()) {

50 
	g”ºo
 = 
EFAULT
;

53 ià(!
	gcÚfig
->
’abË_fÜk
()) {

54 
	g”ºo
 = 
ENOSYS
;

58  
	gasylo
::
’c_fÜk
(
asylo
::
G‘EnşaveName
().
c_¡r
(), *
cÚfig
);

65 
acûss
(cÚ¡ *
·th_Çme
, 
mode
) {

66  
IOMªag”
::
G‘In¡ªû
().
Acûss
(
·th_Çme
, 
mode
);

69 
chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

70  
IOMªag”
::
G‘In¡ªû
().
Chown
(
·th
, 
owÃr
, 
group
);

73 
fchown
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

74  
IOMªag”
::
G‘In¡ªû
().
FChOwn
(
fd
, 
owÃr
, 
group
);

77 
ssize_t
 
»adlšk
(cÚ¡ *
·th_Çme
, *
buf
, 
size_t
 
bufsize
) {

78  
IOMªag”
::
G‘In¡ªû
().
R—dLšk
(
·th_Çme
, 
buf
, 
bufsize
);

81 
symlšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
) {

82  
IOMªag”
::
G‘In¡ªû
().
SymLšk
(
·th1
, 
·th2
);

85 
pe
(
pefd
[2]è{  
IOMªag”
::
G‘In¡ªû
().
Pe
(pipefd, 0); }

87 
pe2
(
pefd
[2], 
æags
) {

88  
IOMªag”
::
G‘In¡ªû
().
Pe
(
pefd
, 
æags
);

91 
g‘ho¡Çme
(*
Çme
, 
size_t
 
Ën
) {

92 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

93 
asylo
::
G‘EnşaveCÚfig
();

95 ià(!
cÚfig_»suÉ
.
ok
()) {

96 
”ºo
 = 
EFAULT
;

100 cÚ¡ 
asylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

101 ià(!
cÚfig
->
has_ho¡_Çme
()) {

102 
”ºo
 = 
EFAULT
;

105 
¡d
::
¡ršg
 
ho¡_Çme
 = 
cÚfig
->host_name();

106 
size
 = 
ho¡_Çme
.size();

108 ià(
size
 >ğ
Ën
) {

109 
size
 = 
Ën
 - 1;

111 
memıy
(
Çme
, 
ho¡_Çme
.
c_¡r
(), 
size
);

112 
Çme
[
size
] = '\0';

122 
syscÚf
(
Çme
) {

123 
Çme
) {

124 
_SC_NPROCESSORS_CONF
:

125 
_SC_NPROCESSORS_ONLN
:

126  
’c_uÁru¡ed_syscÚf
(
Çme
);

127 
_SC_PAGESIZE
:

130  
kPageSize
;

132 
”ºo
 = 
ENOSYS
;

137 
g‘·gesize
(è{  
kPageSize
; }

139 
ušt32_t
 
¦“p
(ušt32_ˆ
£cÚds
è{  
’c_uÁru¡ed_¦“p
(seconds); }

141 
u¦“p
(
u£cÚds_t
 
u£c
è{  
’c_uÁru¡ed_u¦“p
(usec); }

148 
dup
(
Şdfd
è{  
IOMªag”
::
G‘In¡ªû
().
Dup
(oldfd); }

151 
dup2
(
Şdfd
, 
Ãwfd
) {

152  
IOMªag”
::
G‘In¡ªû
().
Dup2
(
Şdfd
, 
Ãwfd
);

155 
fsync
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
FSync
(fd); }

157 
fd©async
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
FD©aSync
(fd); }

159 *
g‘cwd
(*
buf
, 
size_t
 
bufsize
) {

160 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

161 
asylo
::
G‘EnşaveCÚfig
();

165 ià(!
cÚfig_»suÉ
.
ok
()) {

166 cÚ¡ *
dœ
 = "./";

167 
memıy
(
buf
, 
dœ
, 3);

168  
buf
;

171 
¡d
::
¡ršg
 
cu¼’t_wÜkšg_dœeùÜy
 =

172 
IOMªag”
::
G‘In¡ªû
().
G‘Cu¼’tWÜkšgDœeùÜy
();

173 
size
 = 
cu¼’t_wÜkšg_dœeùÜy
.size();

175 ià(
cu¼’t_wÜkšg_dœeùÜy
.
em±y
()) {

176 
”ºo
 = 
ENOENT
;

177  
nuÎ±r
;

181 ià(!
buf
 && !
bufsize
èbufsizğ
size
 + 1;

182 ià(
bufsize
 <ğ
size
) {

183 
”ºo
 = 
ERANGE
;

184  
nuÎ±r
;

188 ià(!
buf
) {

189 
buf
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(
bufsize
));

190 ià(!
buf
) {

191 
”ºo
 = 
ENOMEM
;

192  
nuÎ±r
;

197 
cu¼’t_wÜkšg_dœeùÜy
.
cİy
(
buf
, 
size
);

198 
buf
[
size
] = '\0';

200  
buf
;

203 
chdœ
(cÚ¡ *
·th
) {

204 
asylo
::
Stus
 
¡©us
 =

205 
IOMªag”
::
G‘In¡ªû
().
S‘Cu¼’tWÜkšgDœeùÜy
(
·th
);

206 ià(!
¡©us
.
ok
()) {

207 
”ºo
 = 
¡©us
.
”rÜ_code
();

214 
rmdœ
(cÚ¡ *
·thÇme
) {

215  
IOMªag”
::
G‘In¡ªû
().
RmDœ
(
·thÇme
);

218 
uid_t
 
g‘uid
(è{  
’c_uÁru¡ed_g‘uid
(); }

220 
uid_t
 
g‘euid
(è{  
’c_uÁru¡ed_g‘euid
(); }

222 
gid_t
 
g‘gid
(è{  
’c_uÁru¡ed_g‘gid
(); }

224 
gid_t
 
g‘egid
(è{  
’c_uÁru¡ed_g‘egid
(); }

226 
pid_t
 
g‘µid
(è{  
’c_uÁru¡ed_g‘µid
(); }

228 
pid_t
 
£tsid
(è{  
’c_uÁru¡ed_£tsid
(); }

230 
Œunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

231  
IOMªag”
::
G‘In¡ªû
().
Trunÿ‹
(
·th
, 
Ëngth
);

234 
árunÿ‹
(
fd
, 
off_t
 
Ëngth
) {

235  
IOMªag”
::
G‘In¡ªû
().
FTrunÿ‹
(
fd
, 
Ëngth
);

238 
pid_t
 
vfÜk
() {

239 
pid_t
 
»t
 = 
FÜkEnşave
();

240 ià(
»t
 < 0) {

241  
»t
;

244 ià(
»t
 != 0) {

245 
¡©us
;

246 ià(
wa™
(&
¡©us
) == -1) {

251  
»t
;

256 
’şave_g‘pid
() {

257 
pid
 = 
’c_uÁru¡ed_g‘pid
();

258 ià(
pid
 == 0) {

259 
’c_uÁru¡ed_puts
("FATAL ERROR: Host„eturned 0 from getpid()");

260 
abÜt
();

262  
pid
;

265 
’şave_f¡©
(
fd
, 
¡©
 *
¡
) {

266  
IOMªag”
::
G‘In¡ªû
().
FSt
(
fd
, 
¡
);

269 
’şave_i§‰y
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
I§‰y
(fd); }

271 
’şave_uÆšk
(cÚ¡ *
·thÇme
) {

272  
IOMªag”
::
G‘In¡ªû
().
UÆšk
(
·thÇme
);

275 
’şave_ex™
(
rc
) {

276 
’c_uÁru¡ed__ex™
(
rc
);

279 
pid_t
 
’şave_fÜk
(è{  
FÜkEnşave
(); }

	@platform/posix/unistd.cc

19 
	~<uni¡d.h
>

21 
	~<sys/¡©.h
>

22 
	~<sys/wa™.h
>

23 
	~<c¡dlib
>

24 
	~<c¡ršg
>

26 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/fÜk.h
"

27 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

28 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_glob®_¡©e.h
"

29 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
usšg
 
	gasylo
::
io
::
IOMªag”
;

35 
cÚ¡ex´
 
size_t
 
	gkPageSize
 = 4096;

37 
	gÇme¥aû
 {

39 
pid_t
 
FÜkEnşave
() {

40 
	gasylo
::
StusOr
<cÚ¡ 
asylo
::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

41 
asylo
::
G‘EnşaveCÚfig
();

43 ià(!
	gcÚfig_»suÉ
.
ok
()) {

44 
	g”ºo
 = 
EFAULT
;

48 cÚ¡ 
	gasylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

49 ià(!
	gcÚfig
->
has_’abË_fÜk
()) {

50 
	g”ºo
 = 
EFAULT
;

53 ià(!
	gcÚfig
->
’abË_fÜk
()) {

54 
	g”ºo
 = 
ENOSYS
;

58  
	gasylo
::
’c_fÜk
(
asylo
::
G‘EnşaveName
().
c_¡r
(), *
cÚfig
);

65 
acûss
(cÚ¡ *
·th_Çme
, 
mode
) {

66  
IOMªag”
::
G‘In¡ªû
().
Acûss
(
·th_Çme
, 
mode
);

69 
chown
(cÚ¡ *
·th
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

70  
IOMªag”
::
G‘In¡ªû
().
Chown
(
·th
, 
owÃr
, 
group
);

73 
fchown
(
fd
, 
uid_t
 
owÃr
, 
gid_t
 
group
) {

74  
IOMªag”
::
G‘In¡ªû
().
FChOwn
(
fd
, 
owÃr
, 
group
);

77 
ssize_t
 
»adlšk
(cÚ¡ *
·th_Çme
, *
buf
, 
size_t
 
bufsize
) {

78  
IOMªag”
::
G‘In¡ªû
().
R—dLšk
(
·th_Çme
, 
buf
, 
bufsize
);

81 
symlšk
(cÚ¡ *
·th1
, cÚ¡ *
·th2
) {

82  
IOMªag”
::
G‘In¡ªû
().
SymLšk
(
·th1
, 
·th2
);

85 
pe
(
pefd
[2]è{  
IOMªag”
::
G‘In¡ªû
().
Pe
(pipefd, 0); }

87 
pe2
(
pefd
[2], 
æags
) {

88  
IOMªag”
::
G‘In¡ªû
().
Pe
(
pefd
, 
æags
);

91 
g‘ho¡Çme
(*
Çme
, 
size_t
 
Ën
) {

92 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

93 
asylo
::
G‘EnşaveCÚfig
();

95 ià(!
cÚfig_»suÉ
.
ok
()) {

96 
”ºo
 = 
EFAULT
;

100 cÚ¡ 
asylo
::
EnşaveCÚfig
 *
cÚfig
 = 
cÚfig_»suÉ
.
V®ueOrD›
();

101 ià(!
cÚfig
->
has_ho¡_Çme
()) {

102 
”ºo
 = 
EFAULT
;

105 
¡d
::
¡ršg
 
ho¡_Çme
 = 
cÚfig
->host_name();

106 
size
 = 
ho¡_Çme
.size();

108 ià(
size
 >ğ
Ën
) {

109 
size
 = 
Ën
 - 1;

111 
memıy
(
Çme
, 
ho¡_Çme
.
c_¡r
(), 
size
);

112 
Çme
[
size
] = '\0';

122 
syscÚf
(
Çme
) {

123 
Çme
) {

124 
_SC_NPROCESSORS_CONF
:

125 
_SC_NPROCESSORS_ONLN
:

126  
’c_uÁru¡ed_syscÚf
(
Çme
);

127 
_SC_PAGESIZE
:

130  
kPageSize
;

132 
”ºo
 = 
ENOSYS
;

137 
g‘·gesize
(è{  
kPageSize
; }

139 
ušt32_t
 
¦“p
(ušt32_ˆ
£cÚds
è{  
’c_uÁru¡ed_¦“p
(seconds); }

141 
u¦“p
(
u£cÚds_t
 
u£c
è{  
’c_uÁru¡ed_u¦“p
(usec); }

148 
dup
(
Şdfd
è{  
IOMªag”
::
G‘In¡ªû
().
Dup
(oldfd); }

151 
dup2
(
Şdfd
, 
Ãwfd
) {

152  
IOMªag”
::
G‘In¡ªû
().
Dup2
(
Şdfd
, 
Ãwfd
);

155 
fsync
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
FSync
(fd); }

157 
fd©async
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
FD©aSync
(fd); }

159 *
g‘cwd
(*
buf
, 
size_t
 
bufsize
) {

160 
asylo
::
StusOr
<cÚ¡‡sylo::
EnşaveCÚfig
 *> 
cÚfig_»suÉ
 =

161 
asylo
::
G‘EnşaveCÚfig
();

165 ià(!
cÚfig_»suÉ
.
ok
()) {

166 cÚ¡ *
dœ
 = "./";

167 
memıy
(
buf
, 
dœ
, 3);

168  
buf
;

171 
¡d
::
¡ršg
 
cu¼’t_wÜkšg_dœeùÜy
 =

172 
IOMªag”
::
G‘In¡ªû
().
G‘Cu¼’tWÜkšgDœeùÜy
();

173 
size
 = 
cu¼’t_wÜkšg_dœeùÜy
.size();

175 ià(
cu¼’t_wÜkšg_dœeùÜy
.
em±y
()) {

176 
”ºo
 = 
ENOENT
;

177  
nuÎ±r
;

181 ià(!
buf
 && !
bufsize
èbufsizğ
size
 + 1;

182 ià(
bufsize
 <ğ
size
) {

183 
”ºo
 = 
ERANGE
;

184  
nuÎ±r
;

188 ià(!
buf
) {

189 
buf
 = 
»š‹½»t_ÿ¡
<*>(
m®loc
(
bufsize
));

190 ià(!
buf
) {

191 
”ºo
 = 
ENOMEM
;

192  
nuÎ±r
;

197 
cu¼’t_wÜkšg_dœeùÜy
.
cİy
(
buf
, 
size
);

198 
buf
[
size
] = '\0';

200  
buf
;

203 
chdœ
(cÚ¡ *
·th
) {

204 
asylo
::
Stus
 
¡©us
 =

205 
IOMªag”
::
G‘In¡ªû
().
S‘Cu¼’tWÜkšgDœeùÜy
(
·th
);

206 ià(!
¡©us
.
ok
()) {

207 
”ºo
 = 
¡©us
.
”rÜ_code
();

214 
rmdœ
(cÚ¡ *
·thÇme
) {

215  
IOMªag”
::
G‘In¡ªû
().
RmDœ
(
·thÇme
);

218 
uid_t
 
g‘uid
(è{  
’c_uÁru¡ed_g‘uid
(); }

220 
uid_t
 
g‘euid
(è{  
’c_uÁru¡ed_g‘euid
(); }

222 
gid_t
 
g‘gid
(è{  
’c_uÁru¡ed_g‘gid
(); }

224 
gid_t
 
g‘egid
(è{  
’c_uÁru¡ed_g‘egid
(); }

226 
pid_t
 
g‘µid
(è{  
’c_uÁru¡ed_g‘µid
(); }

228 
pid_t
 
£tsid
(è{  
’c_uÁru¡ed_£tsid
(); }

230 
Œunÿ‹
(cÚ¡ *
·th
, 
off_t
 
Ëngth
) {

231  
IOMªag”
::
G‘In¡ªû
().
Trunÿ‹
(
·th
, 
Ëngth
);

234 
árunÿ‹
(
fd
, 
off_t
 
Ëngth
) {

235  
IOMªag”
::
G‘In¡ªû
().
FTrunÿ‹
(
fd
, 
Ëngth
);

238 
pid_t
 
vfÜk
() {

239 
pid_t
 
»t
 = 
FÜkEnşave
();

240 ià(
»t
 < 0) {

241  
»t
;

244 ià(
»t
 != 0) {

245 
¡©us
;

246 ià(
wa™
(&
¡©us
) == -1) {

251  
»t
;

256 
’şave_g‘pid
() {

257 
pid
 = 
’c_uÁru¡ed_g‘pid
();

258 ià(
pid
 == 0) {

259 
’c_uÁru¡ed_puts
("FATAL ERROR: Host„eturned 0 from getpid()");

260 
abÜt
();

262  
pid
;

265 
’şave_f¡©
(
fd
, 
¡©
 *
¡
) {

266  
IOMªag”
::
G‘In¡ªû
().
FSt
(
fd
, 
¡
);

269 
’şave_i§‰y
(
fd
è{  
IOMªag”
::
G‘In¡ªû
().
I§‰y
(fd); }

271 
’şave_uÆšk
(cÚ¡ *
·thÇme
) {

272  
IOMªag”
::
G‘In¡ªû
().
UÆšk
(
·thÇme
);

275 
’şave_ex™
(
rc
) {

276 
’c_uÁru¡ed__ex™
(
rc
);

279 
pid_t
 
’şave_fÜk
(è{  
FÜkEnşave
(); }

	@platform/posix/utime.cc

19 
	~<sys/time.h
>

20 
	~<utime.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

23 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

27 
utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
) {

28  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
Utime
(
f’ame
, 
times
);

31 
utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]) {

32  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
Utimes
(
f’ame
, 
times
);

	@platform/posix/utime.cc

19 
	~<sys/time.h
>

20 
	~<utime.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

23 
	~"asylo/¶©fÜm/posix/io/io_mªag”.h
"

27 
utime
(cÚ¡ *
f’ame
, cÚ¡ 
utimbuf
 *
times
) {

28  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
Utime
(
f’ame
, 
times
);

31 
utimes
(cÚ¡ *
f’ame
, cÚ¡ 
timev®
 
times
[2]) {

32  
asylo
::
io
::
IOMªag”
::
G‘In¡ªû
().
Utimes
(
f’ame
, 
times
);

	@platform/posix/utsname.cc

19 
	~<¡dlib.h
>

20 
	~<sys/ut¢ame.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
uÇme
(
ut¢ame
 *
buf
è{  
’c_uÁru¡ed_uÇme
(buf); }

	@platform/posix/utsname.cc

19 
	~<¡dlib.h
>

20 
	~<sys/ut¢ame.h
>

22 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

27 
uÇme
(
ut¢ame
 *
buf
è{  
’c_uÁru¡ed_uÇme
(buf); }

	@platform/posix/wait.cc

19 
	~<sys/wa™.h
>

21 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
’şave_wa™
(*
w¡©us
è{  
’c_uÁru¡ed_wa™
(wstatus); }

27 
pid_t
 
wa™3
(*
w¡©us
, 
İtiÚs
, 
ru§ge
 *
u§ge
) {

28  
’c_uÁru¡ed_wa™3
(
w¡©us
, 
İtiÚs
, 
u§ge
);

31 
pid_t
 
wa™pid
Õid_ˆ
pid
, *
w¡©us
, 
İtiÚs
) {

32  
’c_uÁru¡ed_wa™pid
(
pid
, 
w¡©us
, 
İtiÚs
);

	@platform/posix/wait.cc

19 
	~<sys/wa™.h
>

21 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
’şave_wa™
(*
w¡©us
è{  
’c_uÁru¡ed_wa™
(wstatus); }

27 
pid_t
 
wa™3
(*
w¡©us
, 
İtiÚs
, 
ru§ge
 *
u§ge
) {

28  
’c_uÁru¡ed_wa™3
(
w¡©us
, 
İtiÚs
, 
u§ge
);

31 
pid_t
 
wa™pid
Õid_ˆ
pid
, *
w¡©us
, 
İtiÚs
) {

32  
’c_uÁru¡ed_wa™pid
(
pid
, 
w¡©us
, 
İtiÚs
);

	@platform/primitives/examples/hello_driver.cc

18 
	~"asylo/¶©fÜm/´im™ives/exam¶es/h–lo_’şave.h
"

20 
	~<io¡»am
>

21 
	~<¡ršg
>

23 
	~"gæags/gæags.h
"

24 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

25 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

26 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g´im™ives
 {

32 
cÚ¡ex´
 
	gkH–lo
[] = "Hello";

35 
Stus
 
h–lo_hªdËr
(
¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
, *
cÚ‹xt
,

36 
N©iveP¬am‘”Sck
 *
·¿ms
) {

38 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
cÚ¡_ÿ¡
<*>(
kH–lo
), 
¡¾’
(kHello)});

39  
	gStus
::
OkStus
();

42 
Stus
 
ÿÎ_’şave
() {

51 
	g¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
 =

52 
‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

53  "h–lo_‹¡", 
ab¦
::
make_unique
<
Di¥©chTabË
>());

55 autØ
	g¡©us
 = 
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

56 
kEx‹º®H–loHªdËr
, 
Ex™HªdËr
{
h–lo_hªdËr
});

58 
N©iveP¬am‘”Sck
 
	g·¿ms
;

59 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kH–loEnşaveS–eùÜ
, &
·¿ms
);

60 ià(
	g¡©us
.
ok
()) {

61 autØ
	g¥ª
 = 
·¿ms
.
Pİ
();

62 *
	gh–lo
 = 
»š‹½»t_ÿ¡
<*>(
¥ª
->
d©a
());

63 
	g¡d
::
û¼
 << 
h–lo
 << 
¡d
::
’dl
;

65 
	g¡d
::
û¼
 << 
¡©us
.
ToSŒšg
(è<< 
¡d
::
’dl
;

67  
	gStus
::
OkStus
();

73 
	$maš
(
¬gc
, *
¬gv
[]) {

74 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

75 autØ
¡©us
 = ::
asylo
::
´im™ives
::
	`ÿÎ_’şave
();

76 
¡d
::
cout
 << 
¡©us
.
	`ToSŒšg
(è<< std::
’dl
;

78 
	}
}

	@platform/primitives/examples/hello_driver.cc

18 
	~"asylo/¶©fÜm/´im™ives/exam¶es/h–lo_’şave.h
"

20 
	~<io¡»am
>

21 
	~<¡ršg
>

23 
	~"gæags/gæags.h
"

24 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

25 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

26 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g´im™ives
 {

32 
cÚ¡ex´
 
	gkH–lo
[] = "Hello";

35 
Stus
 
h–lo_hªdËr
(
¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
, *
cÚ‹xt
,

36 
N©iveP¬am‘”Sck
 *
·¿ms
) {

38 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
cÚ¡_ÿ¡
<*>(
kH–lo
), 
¡¾’
(kHello)});

39  
	gStus
::
OkStus
();

42 
Stus
 
ÿÎ_’şave
() {

51 
	g¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
 =

52 
‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

53  "h–lo_‹¡", 
ab¦
::
make_unique
<
Di¥©chTabË
>());

55 autØ
	g¡©us
 = 
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

56 
kEx‹º®H–loHªdËr
, 
Ex™HªdËr
{
h–lo_hªdËr
});

58 
N©iveP¬am‘”Sck
 
	g·¿ms
;

59 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kH–loEnşaveS–eùÜ
, &
·¿ms
);

60 ià(
	g¡©us
.
ok
()) {

61 autØ
	g¥ª
 = 
·¿ms
.
Pİ
();

62 *
	gh–lo
 = 
»š‹½»t_ÿ¡
<*>(
¥ª
->
d©a
());

63 
	g¡d
::
û¼
 << 
h–lo
 << 
¡d
::
’dl
;

65 
	g¡d
::
û¼
 << 
¡©us
.
ToSŒšg
(è<< 
¡d
::
’dl
;

67  
	gStus
::
OkStus
();

73 
	$maš
(
¬gc
, *
¬gv
[]) {

74 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

75 autØ
¡©us
 = ::
asylo
::
´im™ives
::
	`ÿÎ_’şave
();

76 
¡d
::
cout
 << 
¡©us
.
	`ToSŒšg
(è<< std::
’dl
;

78 
	}
}

	@platform/primitives/examples/hello_enclave.cc

18 
	~"asylo/¶©fÜm/´im™ives/exam¶es/h–lo_’şave.h
"

20 
	~<¡ršg
>

22 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

23 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

26 
	~"asylo/ut/¡©us_maüos.h
"

28 
usšg
 
	gasylo
::
´im™ives
::
EÁryHªdËr
;

29 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

30 
usšg
 
	gasylo
::
´im™ives
::
Tru¡edPrim™ives
;

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	g´im™ives
 {

35 
	gÇme¥aû
 {

38 
Prim™iveStus
 
AbÜt
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

39 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Abortingƒnclave");

40  
	gPrim™iveStus
::
OkStus
();

44 
Prim™iveStus
 
H–lo
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

45 
	gwÜld_¡r
[] = ", World!";

46 
	gwÜld_Ën
 = 
¡¾’
(
wÜld_¡r
);

48 
Tru¡edP¬am‘”Sck
 
	gex‹º®_·¿ms
;

49 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
UÁru¡edC®l
(
kEx‹º®H–loHªdËr
,

50 &
ex‹º®_·¿ms
));

51 autØ
	gh–lo_ex‹Á
 = 
ex‹º®_·¿ms
.
Pİ
();

52 
	gh–lo_Ën
 = 
h–lo_ex‹Á
->
size
();

53 *
	gh–lo_¡r
 = 
h–lo_ex‹Á
->
As
<>();

55 
	gËn
 = 
h–lo_Ën
 + 
wÜld_Ën
 + 1;

58 
Ex‹Á
 
	gh–lo_wÜld
 = 
·¿ms
->
PushAÎoc
(
Ën
);

59 
memıy
(
h–lo_wÜld
.
As
<>(), 
h–lo_¡r
, 
h–lo_Ën
);

60 
memıy
(
h–lo_wÜld
.
As
<>(è+ 
h–lo_Ën
, 
wÜld_¡r
, 
wÜld_Ën
);

61 
	gh–lo_wÜld
.
	gAs
<>()[
Ën
 - 1] = '\0';

62  
	gPrim™iveStus
::
OkStus
();

67 "C" 
Prim™iveStus
 
asylo_’şave_š™
() {

68  
Prim™iveStus
::
OkStus
();

71 "C" 
Prim™iveStus
 
asylo_’şave_fši
() {

72  
Prim™iveStus
::
OkStus
();

78 "C" 
Prim™iveStus
 
	$’c_š™
() {

79 
	`ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
	`Regi¡”EÁryHªdËr
(

80 
asylo
::
´im™ives
::
kAbÜtEnşaveS–eùÜ
,

81 
EÁryHªdËr
{
asylo
::
´im™ives
::
AbÜt
}));

82 
	`ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
	`Regi¡”EÁryHªdËr
(

83 
asylo
::
´im™ives
::
kH–loEnşaveS–eùÜ
,

84 
EÁryHªdËr
{
asylo
::
´im™ives
::
H–lo
}));

85  
Prim™iveStus
::
	`OkStus
();

86 
	}
}

	@platform/primitives/examples/hello_enclave.cc

18 
	~"asylo/¶©fÜm/´im™ives/exam¶es/h–lo_’şave.h
"

20 
	~<¡ršg
>

22 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

23 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

26 
	~"asylo/ut/¡©us_maüos.h
"

28 
usšg
 
	gasylo
::
´im™ives
::
EÁryHªdËr
;

29 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

30 
usšg
 
	gasylo
::
´im™ives
::
Tru¡edPrim™ives
;

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	g´im™ives
 {

35 
	gÇme¥aû
 {

38 
Prim™iveStus
 
AbÜt
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

39 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Abortingƒnclave");

40  
	gPrim™iveStus
::
OkStus
();

44 
Prim™iveStus
 
H–lo
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

45 
	gwÜld_¡r
[] = ", World!";

46 
	gwÜld_Ën
 = 
¡¾’
(
wÜld_¡r
);

48 
Tru¡edP¬am‘”Sck
 
	gex‹º®_·¿ms
;

49 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
UÁru¡edC®l
(
kEx‹º®H–loHªdËr
,

50 &
ex‹º®_·¿ms
));

51 autØ
	gh–lo_ex‹Á
 = 
ex‹º®_·¿ms
.
Pİ
();

52 
	gh–lo_Ën
 = 
h–lo_ex‹Á
->
size
();

53 *
	gh–lo_¡r
 = 
h–lo_ex‹Á
->
As
<>();

55 
	gËn
 = 
h–lo_Ën
 + 
wÜld_Ën
 + 1;

58 
Ex‹Á
 
	gh–lo_wÜld
 = 
·¿ms
->
PushAÎoc
(
Ën
);

59 
memıy
(
h–lo_wÜld
.
As
<>(), 
h–lo_¡r
, 
h–lo_Ën
);

60 
memıy
(
h–lo_wÜld
.
As
<>(è+ 
h–lo_Ën
, 
wÜld_¡r
, 
wÜld_Ën
);

61 
	gh–lo_wÜld
.
	gAs
<>()[
Ën
 - 1] = '\0';

62  
	gPrim™iveStus
::
OkStus
();

67 "C" 
Prim™iveStus
 
asylo_’şave_š™
() {

68  
Prim™iveStus
::
OkStus
();

71 "C" 
Prim™iveStus
 
asylo_’şave_fši
() {

72  
Prim™iveStus
::
OkStus
();

78 "C" 
Prim™iveStus
 
	$’c_š™
() {

79 
	`ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
	`Regi¡”EÁryHªdËr
(

80 
asylo
::
´im™ives
::
kAbÜtEnşaveS–eùÜ
,

81 
EÁryHªdËr
{
asylo
::
´im™ives
::
AbÜt
}));

82 
	`ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
	`Regi¡”EÁryHªdËr
(

83 
asylo
::
´im™ives
::
kH–loEnşaveS–eùÜ
,

84 
EÁryHªdËr
{
asylo
::
´im™ives
::
H–lo
}));

85  
Prim™iveStus
::
	`OkStus
();

86 
	}
}

	@platform/primitives/examples/hello_enclave.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_EXAMPLES_HELLO_ENCLAVE_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_EXAMPLES_HELLO_ENCLAVE_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g´im™ives
 {

30 
cÚ¡ex´
 
ušt64_t
 
	gkAbÜtEnşaveS–eùÜ
 = 
kS–eùÜU£r
 + 1;

31 
cÚ¡ex´
 
ušt64_t
 
	gkH–loEnşaveS–eùÜ
 = 
kS–eùÜU£r
 + 2;

35 
cÚ¡ex´
 
ušt64_t
 
	gkEx‹º®H–loHªdËr
 = 
kS–eùÜU£r
 + 1;

	@platform/primitives/examples/hello_test.cc

19 
	~<¬¿y
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"gæags/gæags.h
"

26 
	~"asylo/¶©fÜm/´im™ives/exam¶es/h–lo_’şave.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

29 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

30 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/¡©us_maüos.h
"

33 
	~"asylo/ut/¡©usÜ.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	g´im™ives
 {

37 
Çme¥aû
 
	g‹¡
 {

39 şas 
	cH–loTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
´Ùeùed
:

42 
S‘Up
(è
ov”ride
 {

43 
ş›Á_
 = 
‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

44  "h–lo_‹¡", 
ab¦
::
make_unique
<
Di¥©chTabË
>());

45 
ASYLO_EXPECT_OK
(
ş›Á_
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

46 
kEx‹º®H–loHªdËr
, 
Ex™HªdËr
{
‹¡_hªdËr
}));

49 
T—rDown
(è
	gov”ride
 {

50 
ASYLO_EXPECT_OK
(
ş›Á_
->
De¡roy
());

53 
	g¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á_
;

55 
	g´iv©e
:

57 
Stus
 
‹¡_hªdËr
(
¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
, *
cÚ‹xt
,

58 
N©iveP¬am‘”Sck
 *
·¿ms
) {

59 
	g¡d
::
¬¿y
<, 4> 
	g‹¡_d©a
{{'T', 'e', 's', 't'}};

61 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
‹¡_d©a
.
d©a
(),e¡_d©a.
size
()});

62  
	gStus
::
OkStus
();

66 
TEST_F
(
H–loTe¡
, 
H–lo
) {

67 
N©iveP¬am‘”Sck
 
	g·¿ms
;

68 autØ
	g¡©us
 = 
ş›Á_
->
EnşaveC®l
(
kH–loEnşaveS–eùÜ
, &
·¿ms
);

69 
EXPECT_FALSE
(
·¿ms
.
em±y
());

70 autØ
	gmes§ge
 = 
·¿ms
.
Pİ
();

71 
EXPECT_TRUE
(
·¿ms
.
em±y
());

72 cÚ¡ *
	gmes§ge_c¡r
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
mes§ge
->
d©a
());

73 
	g¡d
::
¡ršg
 
mes§ge_¡ršg
(
mes§ge_c¡r
);

74 
EXPECT_THAT
(
mes§ge_¡ršg
, ::
‹¡šg
::
SŒEq
("Test, World!"));

75 
EXPECT_THAT
(
¡©us
, 
IsOk
());

	@platform/primitives/examples/hello_test.cc

19 
	~<¬¿y
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/memÜy/memÜy.h
"

25 
	~"gæags/gæags.h
"

26 
	~"asylo/¶©fÜm/´im™ives/exam¶es/h–lo_’şave.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

29 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

30 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/¡©us_maüos.h
"

33 
	~"asylo/ut/¡©usÜ.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	g´im™ives
 {

37 
Çme¥aû
 
	g‹¡
 {

39 şas 
	cH–loTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

40 
´Ùeùed
:

42 
S‘Up
(è
ov”ride
 {

43 
ş›Á_
 = 
‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

44  "h–lo_‹¡", 
ab¦
::
make_unique
<
Di¥©chTabË
>());

45 
ASYLO_EXPECT_OK
(
ş›Á_
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

46 
kEx‹º®H–loHªdËr
, 
Ex™HªdËr
{
‹¡_hªdËr
}));

49 
T—rDown
(è
	gov”ride
 {

50 
ASYLO_EXPECT_OK
(
ş›Á_
->
De¡roy
());

53 
	g¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á_
;

55 
	g´iv©e
:

57 
Stus
 
‹¡_hªdËr
(
¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
, *
cÚ‹xt
,

58 
N©iveP¬am‘”Sck
 *
·¿ms
) {

59 
	g¡d
::
¬¿y
<, 4> 
	g‹¡_d©a
{{'T', 'e', 's', 't'}};

61 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
‹¡_d©a
.
d©a
(),e¡_d©a.
size
()});

62  
	gStus
::
OkStus
();

66 
TEST_F
(
H–loTe¡
, 
H–lo
) {

67 
N©iveP¬am‘”Sck
 
	g·¿ms
;

68 autØ
	g¡©us
 = 
ş›Á_
->
EnşaveC®l
(
kH–loEnşaveS–eùÜ
, &
·¿ms
);

69 
EXPECT_FALSE
(
·¿ms
.
em±y
());

70 autØ
	gmes§ge
 = 
·¿ms
.
Pİ
();

71 
EXPECT_TRUE
(
·¿ms
.
em±y
());

72 cÚ¡ *
	gmes§ge_c¡r
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
mes§ge
->
d©a
());

73 
	g¡d
::
¡ršg
 
mes§ge_¡ršg
(
mes§ge_c¡r
);

74 
EXPECT_THAT
(
mes§ge_¡ršg
, ::
‹¡šg
::
SŒEq
("Test, World!"));

75 
EXPECT_THAT
(
¡©us
, 
IsOk
());

	@platform/primitives/extent.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_EXTENT_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_EXTENT_H_


	)

22 
	~<c¡ddef
>

23 
	~<c¡dšt
>

24 
	~<funùiÚ®
>

25 
	~<ty³_Œa™s
>

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	g´im™ives
 {

32 şas 
	cEx‹Á
 {

33 
	gpublic
:

35 
cÚ¡ex´
 
Ex‹Á
(è: 
d©a_
(
nuÎ±r
), 
size_
(0) {}

38 
ex¶ic™
 
cÚ¡ex´
 
Ex‹Á
(*
d©a
, 
size_t
 
by‹s
)

39 : 
d©a_
(
d©a
), 
size_
(
by‹s
) {}

42 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

43 
ex¶ic™
 
cÚ¡ex´
 
Ex‹Á
(
T
 *
d©a
)

44 : 
d©a_
(
¿w_poš‹r
(
d©a
)), 
size_
((
T
)) {}

48 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

49 
cÚ¡ex´
 
Ex‹Á
(
T
 *
d©a
, 
size_t
 
couÁ
)

50 : 
d©a_
(
¿w_poš‹r
(
d©a
)), 
size_
(
couÁ
 * (
T
)) {}

53 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

56 *
d©a
(è{  
	gd©a_
; }

59 cÚ¡ *
d©a
(ècÚ¡ {  
	gd©a_
; }

62 
boŞ
 
em±y
(ècÚ¡ {  
	gd©a_
 =ğ
nuÎ±r
 || 
size_
 == 0; }

66 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

67 
T
 *
As
() {

68  
	gsize_
 >ğ(
T
è? 
»š‹½»t_ÿ¡
<T *>(
d©a_
è: 
nuÎ±r
;

71 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

72 cÚ¡ 
T
 *
As
() const {

73  
	gsize_
 >ğ(
T
è? 
»š‹½»t_ÿ¡
<cÚ¡ T *>(
d©a_
è: 
nuÎ±r
;

76 
	g´iv©e
:

77 
‹m¶©e
 <
ty³Çme
 
T
>

78 
cÚ¡ex´
 *
¿w_poš‹r
(cÚ¡ 
T
 *
±r
) {

79  
»š‹½»t_ÿ¡
<*>(
cÚ¡_ÿ¡
<
T
 *>(
±r
));

82 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

83 
cÚ¡ex´
 *
¿w_poš‹r
(
T
 *
±r
) {

84  
	g»š‹½»t_ÿ¡
<*>(
	g±r
);

90 
CheckLayout
() {

91 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
Ex‹Á
>::
v®ue
,

93 
¡©ic_as£¹
(
¡d
::
is_¡ªd¬d_Ïyout
<
Ex‹Á
>::
v®ue
,

95 
¡©ic_as£¹
((
size_t
) == 8, "Unexpected size forype size_t");

96 
¡©ic_as£¹
(
off£tof
(
Ex‹Á
, 
d©a_
) == 0x0,

98 
¡©ic_as£¹
(
off£tof
(
Ex‹Á
, 
size_
è=ğ(
ušt64_t
),

102 *
	gd©a_
;

103 
size_t
 
	gsize_
;

108 
usšg
 
	gEx‹ÁAÎoÿtÜ
 = 
¡d
::
funùiÚ
<
´im™ives
::
Ex‹Á
(
size_t
)>;

	@platform/primitives/extent_test.cc

19 
	~<c¡ršg
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/ba£/maüos.h
"

26 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	g´im™ives
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

35 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁDeçuÉEx‹ÁIsEm±y
è{ 
EXPECT_TRUE
(
Ex‹Á
().
em±y
()); }

38 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁFromCÚ¡
) {

39 
	gx
 = 5;

40 cÚ¡ * 
	gcÚ¡_addr_x
 = &
x
;

41 * 
	gaddr_x
 = &
x
;

43 
Ex‹Á
 
cÚ¡_ex‹Á
(
cÚ¡_addr_x
);

44 
Ex‹Á
 
ex‹Á
(
addr_x
);

46 
EXPECT_THAT
(
cÚ¡_ex‹Á
.
As
<>(), 
Eq
(&
x
));

47 
EXPECT_THAT
(
ex‹Á
.
As
<>(), 
Eq
(&
x
));

52 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁOfPoš‹rReãrsToObjeùMemÜyLoÿtiÚ
) {

53 
cÚ¡ex´
 
ušt64_t
 
	gkS¹V®ue
 = 1729;

55 
ušt64_t
 
	g‹¡_objeù
 = 
kS¹V®ue
;

56 
Ex‹Á
 
‹¡_objeù_ex‹Á
(&
‹¡_objeù
);

57 
EXPECT_THAT
(
‹¡_objeù_ex‹Á
.
As
<
ušt64_t
>(), 
Eq
(&
‹¡_objeù
));

58 
ušt8_t
* 
	g‹¡_objeù_¬¿y
 = 
‹¡_objeù_ex‹Á
.
As
<uint8_t>();

60 
	gi
 = 0; i < 
	g‹¡_objeù_ex‹Á
.
size
(); ++i) {

62 
	g‹¡_objeù_¬¿y
[
i
] ^= ~0;

64 
EXPECT_THAT
(
‹¡_objeù
, 
Eq
(~
kS¹V®ue
));

69 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁOfPoš‹rAndCouÁReãrsToA¼ay
) {

70 
	g‹¡_d©a
[] = {1.6449, 1.0823, 1.0173, 1.00407,

74 
Ex‹Á
 
¬¿y_ex‹Á
(
‹¡_d©a
, 
ABSL_ARRAYSIZE
(test_data));

75 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
‹¡_d©a
); ++i) {

76 
EXPECT_THAT
(&
¬¿y_ex‹Á
.
As
<>()[
i
], 
Eq
(&
‹¡_d©a
[i]));

80 
	g‹¡_d©a_cİy
[
ABSL_ARRAYSIZE
(
‹¡_d©a
)];

81 
memıy
(
‹¡_d©a_cİy
, 
‹¡_d©a
, 
ABSL_ARRAYSIZE
(test_data));

82 
Ex‹Á
 
poš‹r_ex‹Á
(
‹¡_d©a_cİy
, 
ABSL_ARRAYSIZE
(
‹¡_d©a
));

83 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
‹¡_d©a
); ++i) {

84 
EXPECT_THAT
(&
poš‹r_ex‹Á
.
As
<>()[
i
], 
Eq
(&
‹¡_d©a_cİy
[i]));

	@platform/primitives/extent_test.cc

19 
	~<c¡ršg
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/ba£/maüos.h
"

26 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	g´im™ives
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

35 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁDeçuÉEx‹ÁIsEm±y
è{ 
EXPECT_TRUE
(
Ex‹Á
().
em±y
()); }

38 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁFromCÚ¡
) {

39 
	gx
 = 5;

40 cÚ¡ * 
	gcÚ¡_addr_x
 = &
x
;

41 * 
	gaddr_x
 = &
x
;

43 
Ex‹Á
 
cÚ¡_ex‹Á
(
cÚ¡_addr_x
);

44 
Ex‹Á
 
ex‹Á
(
addr_x
);

46 
EXPECT_THAT
(
cÚ¡_ex‹Á
.
As
<>(), 
Eq
(&
x
));

47 
EXPECT_THAT
(
ex‹Á
.
As
<>(), 
Eq
(&
x
));

52 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁOfPoš‹rReãrsToObjeùMemÜyLoÿtiÚ
) {

53 
cÚ¡ex´
 
ušt64_t
 
	gkS¹V®ue
 = 1729;

55 
ušt64_t
 
	g‹¡_objeù
 = 
kS¹V®ue
;

56 
Ex‹Á
 
‹¡_objeù_ex‹Á
(&
‹¡_objeù
);

57 
EXPECT_THAT
(
‹¡_objeù_ex‹Á
.
As
<
ušt64_t
>(), 
Eq
(&
‹¡_objeù
));

58 
ušt8_t
* 
	g‹¡_objeù_¬¿y
 = 
‹¡_objeù_ex‹Á
.
As
<uint8_t>();

60 
	gi
 = 0; i < 
	g‹¡_objeù_ex‹Á
.
size
(); ++i) {

62 
	g‹¡_objeù_¬¿y
[
i
] ^= ~0;

64 
EXPECT_THAT
(
‹¡_objeù
, 
Eq
(~
kS¹V®ue
));

69 
TEST
(
Ex‹ÁTe¡
, 
Ex‹ÁOfPoš‹rAndCouÁReãrsToA¼ay
) {

70 
	g‹¡_d©a
[] = {1.6449, 1.0823, 1.0173, 1.00407,

74 
Ex‹Á
 
¬¿y_ex‹Á
(
‹¡_d©a
, 
ABSL_ARRAYSIZE
(test_data));

75 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
‹¡_d©a
); ++i) {

76 
EXPECT_THAT
(&
¬¿y_ex‹Á
.
As
<>()[
i
], 
Eq
(&
‹¡_d©a
[i]));

80 
	g‹¡_d©a_cİy
[
ABSL_ARRAYSIZE
(
‹¡_d©a
)];

81 
memıy
(
‹¡_d©a_cİy
, 
‹¡_d©a
, 
ABSL_ARRAYSIZE
(test_data));

82 
Ex‹Á
 
poš‹r_ex‹Á
(
‹¡_d©a_cİy
, 
ABSL_ARRAYSIZE
(
‹¡_d©a
));

83 
	gi
 = 0; i < 
ABSL_ARRAYSIZE
(
‹¡_d©a
); ++i) {

84 
EXPECT_THAT
(&
poš‹r_ex‹Á
.
As
<>()[
i
], 
Eq
(&
‹¡_d©a_cİy
[i]));

	@platform/primitives/parameter_stack.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_PARAMETER_STACK_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_PARAMETER_STACK_H_


	)

22 
	~<¬¿y
>

23 
	~<c¡dio
>

24 
	~<memÜy
>

25 
	~<ty³_Œa™s
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

29 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

49 
	g‹m¶©e
 <*(*
	gALLOCATOR
)(
	gsize_t
), (*
	gFREER
)(*)>

50 şas 
	cP¬am‘”Sck
 {

51 
	gpublic
:

52 
¡©ic_as£¹
(
ALLOCATOR
 !ğ
nuÎ±r
 && 
FREER
 !=‚ullptr,

57 
	sI‹m
 {

58 
I‹m
 *
	gÃxt
;

59 
Ex‹Á
 
	gex‹Á
;

62 
I‹m
(cÚ¡ I‹m &
Ùh”
èğ
d–‘e
;

63 
	gI‹m
 &
	gİ”©Ü
=(cÚ¡ 
I‹m
 &
Ùh”
èğ
d–‘e
;

66 ~
I‹m
(èğ
d–‘e
;

71 
CheckLayout
() {

72 
¡©ic_as£¹
((
size_t
è=ğ(
ušt64_t
),

74 
¡©ic_as£¹
(

75 
¡d
::
is_¡ªd¬d_Ïyout
<
I‹m
>::
v®ue
,

77 
¡©ic_as£¹
(
off£tof
(
I‹m
, 
Ãxt
) == 0x0,

80 
¡©ic_as£¹
(
off£tof
(
I‹m
, 
ex‹Á
è=ğ2 * (
ušt64_t
),

83 
¡©ic_as£¹
((
size_t
) == 8, "Unexpected size forype size_t");

89 
D–‘e
() {

90 (*
	gFREER
)(
	gex‹Á
.
d©a
());

91 (*
	gFREER
)(
	gthis
);

96 şas 
	cI‹mD–‘”
 {

97 
	gpublic
:

98 
ex¶ic™
 
I‹mD–‘”
(
I‹m
 *
™em
è: 
™em_
(item) {}

99 
İ”©Ü
()(
Ex‹Á
 *
ex‹Á
è{ 
™em_
->
D–‘e
(); }

101 
	g´iv©e
:

102 
I‹m
 *
™em_
;

106 
usšg
 
	gEx‹ÁPŒ
 = 
¡d
::
unique_±r
<
Ex‹Á
, 
	gI‹mD–‘”
>;

108 
P¬am‘”Sck
() = ;

109 
P¬am‘”Sck
(cÚ¡ P¬am‘”Sck &
Ùh”
èğ
d–‘e
;

110 
P¬am‘”Sck
 
	gİ”©Ü
=(cÚ¡ P¬am‘”Sck &
Ùh”
èğ
d–‘e
;

112 ~
P¬am‘”Sck
() {

113 
	gtİ_
) {

114 autØ
	g™em
 = 
tİ_
;

115 
	gtİ_
 = 
tİ_
->
Ãxt
;

116 
	g™em
->
D–‘e
();

117 
	gsize_
--;

122 
boŞ
 
em±y
(ècÚ¡ {  
	gtİ_
 =ğ
nuÎ±r
; }

125 
size_t
 
size
(ècÚ¡ {  
	gsize_
; }

129 
Ex‹ÁPŒ
 
Pİ
() {

130 autØ
	g™em
 = 
tİ_
;

131 
	gtİ_
 = 
™em
->
Ãxt
;

132 
	g™em
->
	gÃxt
 = 
nuÎ±r
;

133 
	gsize_
--;

134  
	g¡d
::
unique_±r
<
Ex‹Á
, 
	gI‹mD–‘”
>(&
	g™em
->
	gex‹Á
,

135 
I‹mD–‘”
(
™em
));

139 
Ex‹Á
 
Tİ
(è{  
	gtİ_
->
	gex‹Á
; }

142 
Ex‹Á
 
PushAÎoc
(
size_t
 
ex‹Á_size
) {

143 autØ
	g™em
 = 
¡©ic_ÿ¡
<
I‹m
 *>((*
ALLOCATOR
)((Item)));

144 
	g™em
->
	gex‹Á
 =

145 
Ex‹Á
{
¡©ic_ÿ¡
<*>((*
ALLOCATOR
)(
ex‹Á_size
)),ƒxtent_size};

146 
	g™em
->
	gÃxt
 = 
tİ_
;

147 
	gtİ_
 = 
™em
;

148 
	gsize_
++;

149  
	g™em
->
	gex‹Á
;

159 
PushByCİy
(
Ex‹Á
 
ex‹Á
) {

160 autØ
	g™em
 = 
PushAÎoc
(
ex‹Á
.
size
());

161 ià(!
	gex‹Á
.
em±y
()) {

162 
memıy
(
™em
.
d©a
(), 
ex‹Á
.d©a(),ƒx‹Á.
size
());

171 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

172 
T
 
Pİ
() {

173 
¡©ic_as£¹
(!
¡d
::
is_poš‹r
<
T
>::
v®ue
,

175  *
Pİ
()->
‹m¶©e
 
	gAs
<
	gT
>();

178 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

179 
T
 *
PushAÎoc
() {

180 
¡©ic_as£¹
(!
¡d
::
is_poš‹r
<
T
>::
v®ue
,

182  
PushAÎoc
((
T
)).
‹m¶©e
 
	gAs
<
	gT
>();

187 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

188 
PushByCİy
(cÚ¡ 
T
 *
bufãr
, 
size_t
 
size
) {

189 
¡©ic_as£¹
(!
¡d
::
is_poš‹r
<
T
>::
v®ue
,

191 
Ex‹Á
 
	g»¥Ú£_ex‹Á
 = 
PushAÎoc
(
size
);

192 ià(
	gsize
 > 0) {

193 
memıy
(
»¥Ú£_ex‹Á
.
As
<
T
>(), 
bufãr
, 
size
);

197 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

198 
PushByCİy
(cÚ¡ 
T
 &
v®ue
) {

199 
¡©ic_as£¹
(!
¡d
::
is_poš‹r
<
T
>::
v®ue
,

201  
PushByCİy
(
Ex‹Á
{
cÚ¡_ÿ¡
<
T
 *>(&
v®ue
)});

204 
	#ASYLO_RETURN_IF_STACK_EMPTY
(
·¿ms
) \

206 ià(!
·¿ms
->
	`em±y
()) { \

207  {
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, \

210 } 
çl£
)

	)

212 
	#ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 
ex³ùed_¬gs
) \

214 ià(
·¿ms
->
	`size
(è!ğ
ex³ùed_¬gs
) { \

215  {
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, \

216 
ab¦
::
	`SŒC©
(
ex³ùed_¬gs
, \

219 } 
çl£
)

	)

221 
	g´iv©e
:

225 
CheckLayout
() {

226 
¡©ic_as£¹
(
¡d
::
is_¡ªd¬d_Ïyout
<
P¬am‘”Sck
>::
v®ue
,

228 
¡©ic_as£¹
(
off£tof
(
P¬am‘”Sck
, 
äÚt_
) == 0x0,

230 
¡©ic_as£¹
(
off£tof
(
P¬am‘”Sck
, 
back_
è=ğ(
ušt64_t
),

234 
I‹m
 *
	gtİ_
 = 
nuÎ±r
;

235 
size_t
 
	gsize_
 = 0;

240 
usšg
 
	gN©iveP¬am‘”Sck
 = 
P¬am‘”Sck
<
m®loc
, 
	gä“
>;

244 
usšg
 
	gEnşaveC®lPŒ
 =

245 
Prim™iveStus
 (*)(
ušt64_t
 
Œu¡ed_£ËùÜ
,

246 
N©iveP¬am‘”Sck
 *
	g·¿ms
);

	@platform/primitives/parameter_stack_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

20 
	~<®gÜ™hm
>

21 
	~<¬¿y
>

22 
	~<memÜy
>

23 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
	gusšg
 ::
‹¡šg
::
Eq
;

29 
	gusšg
 ::
‹¡šg
::
SŒEq
;

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
size_t
 
	gkNumI‹¿tiÚs
 = 64;

36 
cÚ¡ex´
 
size_t
 
	gkNumP¬ams
 = 256;

38 
TEST
(
P¬am‘”SckTe¡
, 
PushPİS·ns
) {

39 
N©iveP¬am‘”Sck
 
	g·¿ms
;

40 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

41 
EXPECT_TRUE
(
·¿ms
.
em±y
());

42 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

43 
št32_t
 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

44 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
i
 * 
	gi
);

46 
EXPECT_FALSE
(
·¿ms
.
em±y
());

47 
EXPECT_EQ
(
·¿ms
.
size
(), 
kNumP¬ams
);

48 
št32_t
 
	gi
 = 
kNumP¬ams
; --i >= 0;) {

49 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
i
 * i));

51 
EXPECT_TRUE
(
·¿ms
.
em±y
());

52 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

56 
TEST
(
P¬am‘”SckTe¡
, 
PushPİMixtu»
) {

57 
N©iveP¬am‘”Sck
 
	g·¿ms
;

58 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

60 
EXPECT_TRUE
(
·¿ms
.
em±y
());

61 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

62 
št32_t
 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

63 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
i
 * 
	gi
);

66 
EXPECT_FALSE
(
·¿ms
.
em±y
());

67 
EXPECT_EQ
(
·¿ms
.
size
(), 
kNumP¬ams
);

68 
št32_t
 
	gj
 = 
kNumP¬ams
; --j >ğ
™”
;) {

69 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
j
 * j));

72 
EXPECT_FALSE
(
·¿ms
.
em±y
());

73 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

74 
št32_t
 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

75 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
i
 * 
	gi
);

78 
EXPECT_FALSE
(
·¿ms
.
em±y
());

79 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
 + 
kNumP¬ams
);

80 
št32_t
 
	gi
 = 
kNumP¬ams
; --i >= 0;) {

81 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
i
 * i));

83 
EXPECT_FALSE
(
·¿ms
.
em±y
());

84 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

85 
št32_t
 
	gj
 = 
™”
; --j >= 0;) {

86 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
j
 * j));

88 
EXPECT_TRUE
(
·¿ms
.
em±y
());

89 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

93 
TEST
(
P¬am‘”SckTe¡
, 
PushByCİyPoš‹rCİyTe¡
) {

94 
N©iveP¬am‘”Sck
 
	g·¿ms
;

96 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

97 cÚ¡ *
	gbufãr
 = "hello world";

98 
	g·¿ms
.
	gPushByCİy
<>(
	gbufãr
, 
¡¾’
(
bufãr
) + 1);

99 
EXPECT_THAT
(
·¿ms
.
Tİ
().
As
<>(), 
SŒEq
(
bufãr
));

100 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

104 
TEST
(
P¬am‘”SckTe¡
, 
PushCİyTe¡
) {

105 
N©iveP¬am‘”Sck
 
	g·¿ms
;

107 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

108 
	g·¿ms
.
PushByCİy
(
Ex‹Á
{&
™”
, (iter)});

109 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

111 
št32_t
 
	g™”
 = 
kNumI‹¿tiÚs
; iter >= 1; --iter) {

112 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
™”
);

114 
EXPECT_TRUE
(
·¿ms
.
em±y
());

	@platform/primitives/parameter_stack_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

20 
	~<®gÜ™hm
>

21 
	~<¬¿y
>

22 
	~<memÜy
>

23 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
	gusšg
 ::
‹¡šg
::
Eq
;

29 
	gusšg
 ::
‹¡šg
::
SŒEq
;

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

33 
	gÇme¥aû
 {

35 
cÚ¡ex´
 
size_t
 
	gkNumI‹¿tiÚs
 = 64;

36 
cÚ¡ex´
 
size_t
 
	gkNumP¬ams
 = 256;

38 
TEST
(
P¬am‘”SckTe¡
, 
PushPİS·ns
) {

39 
N©iveP¬am‘”Sck
 
	g·¿ms
;

40 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

41 
EXPECT_TRUE
(
·¿ms
.
em±y
());

42 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

43 
št32_t
 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

44 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
i
 * 
	gi
);

46 
EXPECT_FALSE
(
·¿ms
.
em±y
());

47 
EXPECT_EQ
(
·¿ms
.
size
(), 
kNumP¬ams
);

48 
št32_t
 
	gi
 = 
kNumP¬ams
; --i >= 0;) {

49 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
i
 * i));

51 
EXPECT_TRUE
(
·¿ms
.
em±y
());

52 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

56 
TEST
(
P¬am‘”SckTe¡
, 
PushPİMixtu»
) {

57 
N©iveP¬am‘”Sck
 
	g·¿ms
;

58 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

60 
EXPECT_TRUE
(
·¿ms
.
em±y
());

61 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

62 
št32_t
 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

63 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
i
 * 
	gi
);

66 
EXPECT_FALSE
(
·¿ms
.
em±y
());

67 
EXPECT_EQ
(
·¿ms
.
size
(), 
kNumP¬ams
);

68 
št32_t
 
	gj
 = 
kNumP¬ams
; --j >ğ
™”
;) {

69 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
j
 * j));

72 
EXPECT_FALSE
(
·¿ms
.
em±y
());

73 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

74 
št32_t
 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

75 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
i
 * 
	gi
);

78 
EXPECT_FALSE
(
·¿ms
.
em±y
());

79 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
 + 
kNumP¬ams
);

80 
št32_t
 
	gi
 = 
kNumP¬ams
; --i >= 0;) {

81 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
i
 * i));

83 
EXPECT_FALSE
(
·¿ms
.
em±y
());

84 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

85 
št32_t
 
	gj
 = 
™”
; --j >= 0;) {

86 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
Eq
(
j
 * j));

88 
EXPECT_TRUE
(
·¿ms
.
em±y
());

89 
EXPECT_EQ
(
·¿ms
.
size
(), 0);

93 
TEST
(
P¬am‘”SckTe¡
, 
PushByCİyPoš‹rCİyTe¡
) {

94 
N©iveP¬am‘”Sck
 
	g·¿ms
;

96 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

97 cÚ¡ *
	gbufãr
 = "hello world";

98 
	g·¿ms
.
	gPushByCİy
<>(
	gbufãr
, 
¡¾’
(
bufãr
) + 1);

99 
EXPECT_THAT
(
·¿ms
.
Tİ
().
As
<>(), 
SŒEq
(
bufãr
));

100 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

104 
TEST
(
P¬am‘”SckTe¡
, 
PushCİyTe¡
) {

105 
N©iveP¬am‘”Sck
 
	g·¿ms
;

107 
št32_t
 
	g™”
 = 1; i‹¸<ğ
kNumI‹¿tiÚs
; ++iter) {

108 
	g·¿ms
.
PushByCİy
(
Ex‹Á
{&
™”
, (iter)});

109 
EXPECT_EQ
(
·¿ms
.
size
(), 
™”
);

111 
št32_t
 
	g™”
 = 
kNumI‹¿tiÚs
; iter >= 1; --iter) {

112 
EXPECT_THAT
(
·¿ms
.
Pİ
<
št32_t
>(), 
™”
);

114 
EXPECT_TRUE
(
·¿ms
.
em±y
());

	@platform/primitives/primitive_status.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_PRIMITIVE_STATUS_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_PRIMITIVE_STATUS_H_


	)

22 
	~<®gÜ™hm
>

23 
	~<c¡ddef
>

24 
	~<c¡dšt
>

25 
	~<c¡ršg
>

26 
	~<¡ršg
>

27 
	~<ty³_Œa™s
>

29 
	~"asylo/ut/”rÜ_codes.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

56 
¡©ic_as£¹
((
size_t
) == 8, "Unexpected size forype size_t");

60 şas 
	cPrim™iveStus
 {

61 
	gpublic
:

63 
cÚ¡ex´
 
size_t
 
kMes§geMax
 = 1024;

66 
Prim™iveStus
(è: 
”rÜ_code_
(
”rÜ
::
GoogËE¼Ü
::
OK
) {

67 
mes§ge_
[0] = '\0';

71 
Prim™iveStus
(
code
è: 
”rÜ_code_
(codeè{ 
mes§ge_
[0] = '\0'; }

74 
Prim™iveStus
(
code
, cÚ¡ *
mes§ge
è: 
”rÜ_code_
(code) {

75 
size_t
 
size
 = 
¡d
::
mš
(
¡¾’
(
mes§ge
), 
kMes§geMax
 - 1);

76 
memıy
(
mes§ge_
, 
mes§ge
, 
size
);

77 
	gmes§ge_
[
size
] = '\0';

81 
Prim™iveStus
(
code
, cÚ¡ *
mes§ge
, 
size_t
 
mes§ge_size
)

82 : 
”rÜ_code_
(
code
) {

83 
mes§ge_size
 = 
¡d
::
mš
(mes§ge_size, 
kMes§geMax
 - 1);

84 
memıy
(
mes§ge_
, 
mes§ge
, 
mes§ge_size
);

85 
	gmes§ge_
[
mes§ge_size
] = '\0';

89 
Prim™iveStus
(
code
, cÚ¡ 
¡d
::
¡ršg
 &
mes§ge
è: 
”rÜ_code_
(code) {

90 
size_t
 
size
 = 
¡d
::
mš
(
mes§ge
.
Ëngth
(), 
kMes§geMax
 - 1);

91 
memıy
(
mes§ge_
, 
mes§ge
.
d©a
(), 
size
);

92 
	gmes§ge_
[
size
] = '\0';

95 
Prim™iveStus
(cÚ¡ Prim™iveStu &
Ùh”
) {

96 
	g”rÜ_code_
 = 
Ùh”
.
”rÜ_code_
;

97 
size_t
 
	gsize
 = 
¡d
::
mš
(
¡¾’
(
Ùh”
.
mes§ge_
), 
kMes§geMax
 - 1);

98 
memıy
(
mes§ge_
, 
Ùh”
.mes§ge_, 
size
);

99 
	gmes§ge_
[
size
] = '\0';

102 
	gPrim™iveStus
 &
	gİ”©Ü
=(cÚ¡ 
Prim™iveStus
 &
Ùh”
) {

103 
”rÜ_code_
 = 
Ùh”
.error_code_;

104 
size_t
 
	gsize
 = 
¡d
::
mš
(
¡¾’
(
Ùh”
.
mes§ge_
), 
kMes§geMax
 - 1);

105 
memıy
(
mes§ge_
, 
Ùh”
.mes§ge_, 
size
);

106  *
	gthis
;

110 
Prim™iveStus
 
OkStus
(è{  
	gPrim™iveStus
{}; }

113 
”rÜ_code
(ècÚ¡ {  
	g”rÜ_code_
; }

116 cÚ¡ *
”rÜ_mes§ge
(ècÚ¡ {  
	gmes§ge_
; }

119 
boŞ
 
ok
(ècÚ¡ {  
	g”rÜ_code_
 =ğ
”rÜ
::
GoogËE¼Ü
::
OK
; }

121 
	g´iv©e
:

125 
CheckLayout
() {

126 
¡©ic_as£¹
(
¡d
::
is_¡ªd¬d_Ïyout
<
Prim™iveStus
>::
v®ue
,

128 
¡©ic_as£¹
(
off£tof
(
Prim™iveStus
, 
”rÜ_code_
) == 0x0,

130 
¡©ic_as£¹
(
off£tof
(
Prim™iveStus
, 
mes§ge_
è=ğ(
ušt32_t
),

134 
št32_t
 
	g”rÜ_code_
;

135 
	gmes§ge_
[
kMes§geMax
];

	@platform/primitives/primitive_status_test.cc

19 
	~<c¡ršg
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/ba£/maüos.h
"

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	g´im™ives
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

34 
TEST
(
Prim™iveStusTe¡
, 
Prim™iveStusFromL’gthAndSize
) {

35 
	g¡d
::
¡ršg
 
bufãr
;

36 
	gi
 = 0; i < 256; i++) {

37 
	gbufãr
.
push_back
('a' + 
i
 % 26);

42 
	gi
 = 0; i < 
	gbufãr
.
size
(); i++) {

43 
	gj
 = 
i
; j < 
	gbufãr
.
size
(); j++) {

44 cÚ¡ *
	gd©a
 = 
bufãr
.
d©a
(è+ 
i
;

45 
size_t
 
	gËngth
 = 
j
 - 
i
;

46 
Prim™iveStus
 
	g¡©us
{0, 
	gd©a
, 
	gËngth
};

47 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(), 
Eq
(
bufãr
.
sub¡r
(
i
, 
Ëngth
)));

	@platform/primitives/primitive_status_test.cc

19 
	~<c¡ršg
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/ba£/maüos.h
"

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	g´im™ives
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

34 
TEST
(
Prim™iveStusTe¡
, 
Prim™iveStusFromL’gthAndSize
) {

35 
	g¡d
::
¡ršg
 
bufãr
;

36 
	gi
 = 0; i < 256; i++) {

37 
	gbufãr
.
push_back
('a' + 
i
 % 26);

42 
	gi
 = 0; i < 
	gbufãr
.
size
(); i++) {

43 
	gj
 = 
i
; j < 
	gbufãr
.
size
(); j++) {

44 cÚ¡ *
	gd©a
 = 
bufãr
.
d©a
(è+ 
i
;

45 
size_t
 
	gËngth
 = 
j
 - 
i
;

46 
Prim™iveStus
 
	g¡©us
{0, 
	gd©a
, 
	gËngth
};

47 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(), 
Eq
(
bufãr
.
sub¡r
(
i
, 
Ëngth
)));

	@platform/primitives/primitives.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_PRIMITIVES_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_PRIMITIVES_H_


	)

22 
	~<c¡ddef
>

23 
	~<c¡dšt
>

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	g´im™ives
 {

32 
cÚ¡ex´
 
ušt64_t
 
	gkS–eùÜAsyloInv®id
 = 0;

35 
cÚ¡ex´
 
ušt64_t
 
	gkS–eùÜAsyloIn™
 = 1;

38 
cÚ¡ex´
 
ušt64_t
 
	gkS–eùÜAsyloRun
 = 2;

41 
cÚ¡ex´
 
ušt64_t
 
	gkS–eùÜAsyloDÚ©eTh»ad
 = 3;

44 
cÚ¡ex´
 
ušt64_t
 
	gkS–eùÜAsyloFši
 = 4;

48 
cÚ¡ex´
 
ušt64_t
 
	gkS–eùÜU£r
 = 128;

52 
cÚ¡ex´
 
ušt64_t
 
	gkS–eùÜHo¡C®l
 = 112;

	@platform/primitives/sgx/sgx_error_space.cc

19 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
	gSgxE¼ÜS·û
::
G‘In¡ªû
() {

25 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
SgxE¼ÜS·û
();

26  
	gš¡ªû
;

29 
	gSgxE¼ÜS·û
::
SgxE¼ÜS·û
()

30 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
SgxE¼ÜS·û
>(

32 
AddT¿n¦©iÚM­EÁry
(
SGX_SUCCESS
, "SGX_SUCCESS", 
GoogËE¼Ü
::
OK
);

33 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_UNEXPECTED
, "Unexpectedƒrror",

34 
GoogËE¼Ü
::
UNKNOWN
);

35 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_PARAMETER
, "Invalid…arameter",

36 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

37 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OUT_OF_MEMORY
, "Out of memory",

38 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

39 
AddT¿n¦©iÚM­EÁry
(

40 
SGX_ERROR_ENCLAVE_LOST
,

42 
GoogËE¼Ü
::
INTERNAL
);

43 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_STATE
,

45 
GoogËE¼Ü
::
INTERNAL
);

46 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_FUNCTION
, "Invalidƒcall or ocall",

47 
GoogËE¼Ü
::
INTERNAL
);

48 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OUT_OF_TCS
, "Out of TCS",

49 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

50 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_ENCLAVE_CRASHED
, "Enclave crashed",

51 
GoogËE¼Ü
::
INTERNAL
);

52 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_ECALL_NOT_ALLOWED
, "Ecall‚ot‡llowed",

53 
GoogËE¼Ü
::
PERMISSION_DENIED
);

54 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OCALL_NOT_ALLOWED
, "Ocall‚ot‡llowed",

55 
GoogËE¼Ü
::
PERMISSION_DENIED
);

56 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_STACK_OVERRUN
, "Out of stack",

57 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

58 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_UNDEFINED_SYMBOL
, "Undefined symbol",

59 
GoogËE¼Ü
::
INTERNAL
);

60 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ENCLAVE
, "Invalidƒnclave image",

61 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

62 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ENCLAVE_ID
, "Invalidƒnclave ID",

63 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

64 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_SIGNATURE
,

66 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

67 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_NDEBUG_ENCLAVE
,

68 "CªnÙ c»©debugƒnşave", 
GoogËE¼Ü
::
INTERNAL
);

69 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OUT_OF_EPC
, "Out of EPC",

70 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

71 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_NO_DEVICE
, "Cannot open SGX device",

72 
GoogËE¼Ü
::
INTERNAL
);

73 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MEMORY_MAP_CONFLICT
, "Memory map conflict",

74 
GoogËE¼Ü
::
INTERNAL
);

75 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_METADATA
, "Invalid metadata",

76 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

77 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_DEVICE_BUSY
, "Device busy",

78 
GoogËE¼Ü
::
UNAVAILABLE
);

79 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_VERSION
, "Invalid metadata version",

80 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

81 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MODE_INCOMPATIBLE
, "Mode incompatible",

82 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

83 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_ENCLAVE_FILE_ACCESS
,

84 "CªnÙ o³À’şavfe", 
GoogËE¼Ü
::
INTERNAL
);

85 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_MISC
,

87 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

88 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MAC_MISMATCH
, "MAC verification failed",

89 
GoogËE¼Ü
::
INTERNAL
);

90 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ATTRIBUTE
, "Invalid‡ttribute",

91 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

92 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_CPUSVN
, "Invalid CPUSVN",

93 
GoogËE¼Ü
::
PERMISSION_DENIED
);

94 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ISVSVN
, "Invalid ISVSVN",

95 
GoogËE¼Ü
::
PERMISSION_DENIED
);

96 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_KEYNAME
, "Invalid keyname",

97 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

98 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_SERVICE_UNAVAILABLE
,

99 "AESM s”viû uÇvaabË", 
GoogËE¼Ü
::
UNAVAILABLE
);

100 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_SERVICE_TIMEOUT
, "AESM serviceimeout",

101 
GoogËE¼Ü
::
DEADLINE_EXCEEDED
);

102 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_AE_INVALID_EPIDBLOB
,

104 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

105 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_SERVICE_INVALID_PRIVILEGE
,

107 
GoogËE¼Ü
::
PERMISSION_DENIED
);

108 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_EPID_MEMBER_REVOKED
,

110 
GoogËE¼Ü
::
PERMISSION_DENIED
);

111 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_UPDATE_NEEDED
, "SGX update‚eeded",

112 
GoogËE¼Ü
::
INTERNAL
);

113 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_NETWORK_FAILURE
, "Network failure",

114 
GoogËE¼Ü
::
INTERNAL
);

115 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_AE_SESSION_INVALID
,

117 
GoogËE¼Ü
::
INTERNAL
);

118 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_BUSY
, "Service busy",

119 
GoogËE¼Ü
::
UNAVAILABLE
);

120 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_NOT_FOUND
, "Monotonic counter‚ot found",

121 
GoogËE¼Ü
::
NOT_FOUND
);

122 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_NO_ACCESS_RIGHT
,

124 
GoogËE¼Ü
::
PERMISSION_DENIED
);

125 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_USED_UP
, "Monotonic counter used up",

126 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

127 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_OVER_QUOTA
,

129 
GoogËE¼Ü
::
UNAVAILABLE
);

130 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_KDF_MISMATCH
,

132 
GoogËE¼Ü
::
FAILED_PRECONDITION
);

135 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
sgx_¡©us_t
> 
g
) {

136  
	gSgxE¼ÜS·û
::
G‘In¡ªû
();

	@platform/primitives/sgx/sgx_error_space.cc

19 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
	gSgxE¼ÜS·û
::
G‘In¡ªû
() {

25 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
SgxE¼ÜS·û
();

26  
	gš¡ªû
;

29 
	gSgxE¼ÜS·û
::
SgxE¼ÜS·û
()

30 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
SgxE¼ÜS·û
>(

32 
AddT¿n¦©iÚM­EÁry
(
SGX_SUCCESS
, "SGX_SUCCESS", 
GoogËE¼Ü
::
OK
);

33 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_UNEXPECTED
, "Unexpectedƒrror",

34 
GoogËE¼Ü
::
UNKNOWN
);

35 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_PARAMETER
, "Invalid…arameter",

36 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

37 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OUT_OF_MEMORY
, "Out of memory",

38 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

39 
AddT¿n¦©iÚM­EÁry
(

40 
SGX_ERROR_ENCLAVE_LOST
,

42 
GoogËE¼Ü
::
INTERNAL
);

43 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_STATE
,

45 
GoogËE¼Ü
::
INTERNAL
);

46 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_FUNCTION
, "Invalidƒcall or ocall",

47 
GoogËE¼Ü
::
INTERNAL
);

48 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OUT_OF_TCS
, "Out of TCS",

49 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

50 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_ENCLAVE_CRASHED
, "Enclave crashed",

51 
GoogËE¼Ü
::
INTERNAL
);

52 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_ECALL_NOT_ALLOWED
, "Ecall‚ot‡llowed",

53 
GoogËE¼Ü
::
PERMISSION_DENIED
);

54 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OCALL_NOT_ALLOWED
, "Ocall‚ot‡llowed",

55 
GoogËE¼Ü
::
PERMISSION_DENIED
);

56 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_STACK_OVERRUN
, "Out of stack",

57 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

58 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_UNDEFINED_SYMBOL
, "Undefined symbol",

59 
GoogËE¼Ü
::
INTERNAL
);

60 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ENCLAVE
, "Invalidƒnclave image",

61 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

62 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ENCLAVE_ID
, "Invalidƒnclave ID",

63 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

64 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_SIGNATURE
,

66 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

67 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_NDEBUG_ENCLAVE
,

68 "CªnÙ c»©debugƒnşave", 
GoogËE¼Ü
::
INTERNAL
);

69 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_OUT_OF_EPC
, "Out of EPC",

70 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

71 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_NO_DEVICE
, "Cannot open SGX device",

72 
GoogËE¼Ü
::
INTERNAL
);

73 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MEMORY_MAP_CONFLICT
, "Memory map conflict",

74 
GoogËE¼Ü
::
INTERNAL
);

75 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_METADATA
, "Invalid metadata",

76 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

77 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_DEVICE_BUSY
, "Device busy",

78 
GoogËE¼Ü
::
UNAVAILABLE
);

79 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_VERSION
, "Invalid metadata version",

80 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

81 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MODE_INCOMPATIBLE
, "Mode incompatible",

82 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

83 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_ENCLAVE_FILE_ACCESS
,

84 "CªnÙ o³À’şavfe", 
GoogËE¼Ü
::
INTERNAL
);

85 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_MISC
,

87 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

88 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MAC_MISMATCH
, "MAC verification failed",

89 
GoogËE¼Ü
::
INTERNAL
);

90 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ATTRIBUTE
, "Invalid‡ttribute",

91 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

92 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_CPUSVN
, "Invalid CPUSVN",

93 
GoogËE¼Ü
::
PERMISSION_DENIED
);

94 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_ISVSVN
, "Invalid ISVSVN",

95 
GoogËE¼Ü
::
PERMISSION_DENIED
);

96 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_INVALID_KEYNAME
, "Invalid keyname",

97 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

98 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_SERVICE_UNAVAILABLE
,

99 "AESM s”viû uÇvaabË", 
GoogËE¼Ü
::
UNAVAILABLE
);

100 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_SERVICE_TIMEOUT
, "AESM serviceimeout",

101 
GoogËE¼Ü
::
DEADLINE_EXCEEDED
);

102 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_AE_INVALID_EPIDBLOB
,

104 
GoogËE¼Ü
::
INVALID_ARGUMENT
);

105 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_SERVICE_INVALID_PRIVILEGE
,

107 
GoogËE¼Ü
::
PERMISSION_DENIED
);

108 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_EPID_MEMBER_REVOKED
,

110 
GoogËE¼Ü
::
PERMISSION_DENIED
);

111 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_UPDATE_NEEDED
, "SGX update‚eeded",

112 
GoogËE¼Ü
::
INTERNAL
);

113 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_NETWORK_FAILURE
, "Network failure",

114 
GoogËE¼Ü
::
INTERNAL
);

115 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_AE_SESSION_INVALID
,

117 
GoogËE¼Ü
::
INTERNAL
);

118 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_BUSY
, "Service busy",

119 
GoogËE¼Ü
::
UNAVAILABLE
);

120 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_NOT_FOUND
, "Monotonic counter‚ot found",

121 
GoogËE¼Ü
::
NOT_FOUND
);

122 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_NO_ACCESS_RIGHT
,

124 
GoogËE¼Ü
::
PERMISSION_DENIED
);

125 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_USED_UP
, "Monotonic counter used up",

126 
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
);

127 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_MC_OVER_QUOTA
,

129 
GoogËE¼Ü
::
UNAVAILABLE
);

130 
AddT¿n¦©iÚM­EÁry
(
SGX_ERROR_KDF_MISMATCH
,

132 
GoogËE¼Ü
::
FAILED_PRECONDITION
);

135 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
sgx_¡©us_t
> 
g
) {

136  
	gSgxE¼ÜS·û
::
G‘In¡ªû
();

	@platform/primitives/sgx/sgx_error_space.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_SGX_SGX_ERROR_SPACE_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_SGX_SGX_ERROR_SPACE_H_


	)

22 
	~"asylo/ut/¡©us.h
"

23 
	~"šşude/sgx_”rÜ.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	g”rÜ
 {

29 
şass
 
	gSgxE¼ÜS·û
 : 
public
 
E¼ÜS·ûIm¶em’tiÚH–³r
<
SgxE¼ÜS·û
> {

30 
public
:

31 
usšg
 
code_ty³
 = 
sgx_¡©us_t
;

33 
SgxE¼ÜS·û
(cÚ¡ SgxE¼ÜS·û &èğ
d–‘e
;

34 
	gSgxE¼ÜS·û
 &
	gİ”©Ü
=(cÚ¡ 
SgxE¼ÜS·û
 &èğ
d–‘e
;

37 
E¼ÜS·û
 cÚ¡ *
G‘In¡ªû
();

39 
	g´iv©e
:

40 
SgxE¼ÜS·û
();

45 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
sgx_¡©us_t
> 
g
);

	@platform/primitives/sgx/trusted_runtime.cc

19 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

21 
	~<”ºo.h
>

22 
	~<¡dlib.h
>

23 
	~<sys/ty³s.h
>

25 
	~"šşude/sgx_th»ad.h
"

26 
	~"šşude/sgx_Œts.h
"

28 
	gÇme¥aû
 {

31 *
	gh—p_ba£
 = 
nuÎ±r
;

34 
size_t
 
	gh—p_max_size
 = 0;

37 
size_t
 
	gh—p_size
 = 0;

43 
size_t
 
g_³ak_h—p_u£d
 
__©Œibu‹__
((
visib™y
("default"))) = 0;

45 
h—p_š™
(*
_h—p_ba£
, 
size_t
 
_h—p_max_size
, size_ˆ
_h—p_mš_size
,

46 
_is_edmm_suµÜ‹d
) {

47 
h—p_ba£
 = 
_h—p_ba£
;

48 
h—p_max_size
 = 
_h—p_max_size
;

54 *
’şave_sbrk
(
šŒ_t
 
šüem’t
) {

55 
ssize_t
 
Ãw_h—p_size
 = 
h—p_size
 + 
šüem’t
;

56 ià(
h—p_ba£
 =ğ
nuÎ±r
 || 
Ãw_h—p_size
 < 0 ||

57 
Ãw_h—p_size
 > 
h—p_max_size
) {

58 
”ºo
 = 
ENOMEM
;

59  
»š‹½»t_ÿ¡
<*>(-1);

62 ià(
g_³ak_h—p_u£d
 < 
Ãw_h—p_size
) {

63 
g_³ak_h—p_u£d
 = 
Ãw_h—p_size
;

66 
ušŒ_t
 
´ev_h—p_’d
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
h—p_ba£
è+ 
h—p_size
;

67 
h—p_size
 = 
Ãw_h—p_size
;

68  
»š‹½»t_ÿ¡
<*>(
´ev_h—p_’d
);

77 
ušt64_t
 
’c_th»ad_£lf
() {

78 
th»ad_loÿl
 
th»ad_id’t™y
;

79  
»š‹½»t_ÿ¡
<
ušt64_t
>(&
th»ad_id’t™y
);

82 
boŞ
 
’c_is_w™hš_’şave
(cÚ¡ *
add»ss
, 
size_t
 
size
) {

83  
sgx_is_w™hš_’şave
(
add»ss
, 
size
) == 1;

86 
boŞ
 
’c_is_outside_’şave
(cÚ¡ *
add»ss
, 
size_t
 
size
) {

87  
sgx_is_outside_’şave
(
add»ss
, 
size
) == 1;

90 
’c_block_eÿÎs
(è{ 
sgx_block_eÿÎs
(); }

92 
’c_unblock_eÿÎs
(è{ 
sgx_unblock_eÿÎs
(); }

94 
’c_g‘_memÜy_Ïyout
(
EnşaveMemÜyLayout
 *
’şave_memÜy_Ïyout
) {

95 ià(!
’şave_memÜy_Ïyout
) ;

96 
SgxMemÜyLayout
 
memÜy_Ïyout
;

97 
sgx_memÜy_Ïyout
(&
memÜy_Ïyout
);

98 
’şave_memÜy_Ïyout
->
d©a_ba£
 = 
memÜy_Ïyout
.data_base;

99 
’şave_memÜy_Ïyout
->
d©a_size
 = 
memÜy_Ïyout
.data_size;

100 
’şave_memÜy_Ïyout
->
bss_ba£
 = 
memÜy_Ïyout
.bss_base;

101 
’şave_memÜy_Ïyout
->
bss_size
 = 
memÜy_Ïyout
.bss_size;

102 
’şave_memÜy_Ïyout
->
h—p_ba£
 = 
memÜy_Ïyout
.heap_base;

103 
’şave_memÜy_Ïyout
->
h—p_size
 = 
memÜy_Ïyout
.heap_size;

104 
’şave_memÜy_Ïyout
->
th»ad_ba£
 = 
memÜy_Ïyout
.thread_base;

105 
’şave_memÜy_Ïyout
->
th»ad_size
 = 
memÜy_Ïyout
.thread_size;

106 
’şave_memÜy_Ïyout
->
¡ack_ba£
 = 
memÜy_Ïyout
.stack_base;

107 
’şave_memÜy_Ïyout
->
¡ack_lim™
 = 
memÜy_Ïyout
.stack_limit;

108 
’şave_memÜy_Ïyout
->
»£rved_d©a_ba£
 = 
memÜy_Ïyout
.reserved_data_base;

109 
’şave_memÜy_Ïyout
->
»£rved_d©a_size
 = 
memÜy_Ïyout
.reserved_data_size;

110 
’şave_memÜy_Ïyout
->
»£rved_bss_ba£
 = 
memÜy_Ïyout
.reserved_bss_base;

111 
’şave_memÜy_Ïyout
->
»£rved_bss_size
 = 
memÜy_Ïyout
.reserved_bss_size;

112 
’şave_memÜy_Ïyout
->
»£rved_h—p_ba£
 = 
memÜy_Ïyout
.reserved_heap_base;

113 
’şave_memÜy_Ïyout
->
»£rved_h—p_size
 = 
memÜy_Ïyout
.reserved_heap_size;

116 
g‘_aùive_’şave_’Œ›s
(è{  
sgx_g‘_aùive_’şave_’Œ›s
(); }

	@platform/primitives/sgx/trusted_runtime.cc

19 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

21 
	~<”ºo.h
>

22 
	~<¡dlib.h
>

23 
	~<sys/ty³s.h
>

25 
	~"šşude/sgx_th»ad.h
"

26 
	~"šşude/sgx_Œts.h
"

28 
	gÇme¥aû
 {

31 *
	gh—p_ba£
 = 
nuÎ±r
;

34 
size_t
 
	gh—p_max_size
 = 0;

37 
size_t
 
	gh—p_size
 = 0;

43 
size_t
 
g_³ak_h—p_u£d
 
__©Œibu‹__
((
visib™y
("default"))) = 0;

45 
h—p_š™
(*
_h—p_ba£
, 
size_t
 
_h—p_max_size
, size_ˆ
_h—p_mš_size
,

46 
_is_edmm_suµÜ‹d
) {

47 
h—p_ba£
 = 
_h—p_ba£
;

48 
h—p_max_size
 = 
_h—p_max_size
;

54 *
’şave_sbrk
(
šŒ_t
 
šüem’t
) {

55 
ssize_t
 
Ãw_h—p_size
 = 
h—p_size
 + 
šüem’t
;

56 ià(
h—p_ba£
 =ğ
nuÎ±r
 || 
Ãw_h—p_size
 < 0 ||

57 
Ãw_h—p_size
 > 
h—p_max_size
) {

58 
”ºo
 = 
ENOMEM
;

59  
»š‹½»t_ÿ¡
<*>(-1);

62 ià(
g_³ak_h—p_u£d
 < 
Ãw_h—p_size
) {

63 
g_³ak_h—p_u£d
 = 
Ãw_h—p_size
;

66 
ušŒ_t
 
´ev_h—p_’d
 = 
»š‹½»t_ÿ¡
<ušŒ_t>(
h—p_ba£
è+ 
h—p_size
;

67 
h—p_size
 = 
Ãw_h—p_size
;

68  
»š‹½»t_ÿ¡
<*>(
´ev_h—p_’d
);

77 
ušt64_t
 
’c_th»ad_£lf
() {

78 
th»ad_loÿl
 
th»ad_id’t™y
;

79  
»š‹½»t_ÿ¡
<
ušt64_t
>(&
th»ad_id’t™y
);

82 
boŞ
 
’c_is_w™hš_’şave
(cÚ¡ *
add»ss
, 
size_t
 
size
) {

83  
sgx_is_w™hš_’şave
(
add»ss
, 
size
) == 1;

86 
boŞ
 
’c_is_outside_’şave
(cÚ¡ *
add»ss
, 
size_t
 
size
) {

87  
sgx_is_outside_’şave
(
add»ss
, 
size
) == 1;

90 
’c_block_eÿÎs
(è{ 
sgx_block_eÿÎs
(); }

92 
’c_unblock_eÿÎs
(è{ 
sgx_unblock_eÿÎs
(); }

94 
’c_g‘_memÜy_Ïyout
(
EnşaveMemÜyLayout
 *
’şave_memÜy_Ïyout
) {

95 ià(!
’şave_memÜy_Ïyout
) ;

96 
SgxMemÜyLayout
 
memÜy_Ïyout
;

97 
sgx_memÜy_Ïyout
(&
memÜy_Ïyout
);

98 
’şave_memÜy_Ïyout
->
d©a_ba£
 = 
memÜy_Ïyout
.data_base;

99 
’şave_memÜy_Ïyout
->
d©a_size
 = 
memÜy_Ïyout
.data_size;

100 
’şave_memÜy_Ïyout
->
bss_ba£
 = 
memÜy_Ïyout
.bss_base;

101 
’şave_memÜy_Ïyout
->
bss_size
 = 
memÜy_Ïyout
.bss_size;

102 
’şave_memÜy_Ïyout
->
h—p_ba£
 = 
memÜy_Ïyout
.heap_base;

103 
’şave_memÜy_Ïyout
->
h—p_size
 = 
memÜy_Ïyout
.heap_size;

104 
’şave_memÜy_Ïyout
->
th»ad_ba£
 = 
memÜy_Ïyout
.thread_base;

105 
’şave_memÜy_Ïyout
->
th»ad_size
 = 
memÜy_Ïyout
.thread_size;

106 
’şave_memÜy_Ïyout
->
¡ack_ba£
 = 
memÜy_Ïyout
.stack_base;

107 
’şave_memÜy_Ïyout
->
¡ack_lim™
 = 
memÜy_Ïyout
.stack_limit;

108 
’şave_memÜy_Ïyout
->
»£rved_d©a_ba£
 = 
memÜy_Ïyout
.reserved_data_base;

109 
’şave_memÜy_Ïyout
->
»£rved_d©a_size
 = 
memÜy_Ïyout
.reserved_data_size;

110 
’şave_memÜy_Ïyout
->
»£rved_bss_ba£
 = 
memÜy_Ïyout
.reserved_bss_base;

111 
’şave_memÜy_Ïyout
->
»£rved_bss_size
 = 
memÜy_Ïyout
.reserved_bss_size;

112 
’şave_memÜy_Ïyout
->
»£rved_h—p_ba£
 = 
memÜy_Ïyout
.reserved_heap_base;

113 
’şave_memÜy_Ïyout
->
»£rved_h—p_size
 = 
memÜy_Ïyout
.reserved_heap_size;

116 
g‘_aùive_’şave_’Œ›s
(è{  
sgx_g‘_aùive_’şave_’Œ›s
(); }

	@platform/primitives/sgx/trusted_sgx.cc

19 
	~"asylo/¶©fÜm/´im™ives/sgx/Œu¡ed_sgx.h
"

21 
	~<veùÜ
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/¶©fÜm/¬ch/sgx/Œu¡ed/g’”©ed_bridge_t.h
"

26 
	~"asylo/¶©fÜm/cÜe/’Œy_pošts.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

29 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

30 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

31 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

32 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

33 
	~"asylo/¶©fÜm/´im™ives/ut/´im™ive_locks.h
"

34 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_ruÁime_h–³r.h
"

35 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

36 
	~"asylo/ut/¡©us.h
"

37 
	~"asylo/ut/¡©us_maüos.h
"

38 
	~"šşude/sgx_Œts.h
"

40 "C" *
’c_uÁru¡ed_m®loc
(
size_t
 
size
);

41 "C" 
’c_uÁru¡ed_ä“
(*
±r
);

43 
Çme¥aû
 
	gasylo
 {

44 
Çme¥aû
 
	g´im™ives
 {

46 
	gÇme¥aû
 {

48 
usšg
 
	gUÁru¡edAÎoÿtÜSck
 =

49 
P¬am‘”Sck
<
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
,

50 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
>;

52 
	#CHECK_OCALL
(
¡©us_
) \

54 
sgx_¡©us_t
 
¡©us
##
__COUNTER__
 = 
¡©us_
; \

55 ià(
¡©us
##
__COUNTER__
 !ğ
SGX_SUCCESS
) { \

56 
Tru¡edPrim™ives
::
	`DebugPuts
( \

57 
ab¦
::
	`SŒC©
( \

58 
__FILE__
, ":", 
__LINE__
, ": ", \

59 
asylo
::
	`Stus
(
¡©us
##
__COUNTER__
, "oÿÎ faed").
	`ToSŒšg
()) \

60 .
	`c_¡r
()); \

61 
	`abÜt
(); \

63 } 0)

	)

67 
Prim™iveStus
 
V”ifyUÁru¡edAdd»ssRªge
(*
add»ss
, 
size_t
 
size
) {

68 ià(!
’c_is_outside_’şave
(
add»ss
, 
size
)) {

69  
Prim™iveStus
(
SGX_ERROR_INVALID_PARAMETER
,

72  
	gPrim™iveStus
::
OkStus
();

76 
Prim™iveStus
 
In™Ÿlize
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

77 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

78 
	gTru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
 
šput_ex‹Á
 = 
·¿ms
->
Pİ
();

79 
	gTru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
 
Çme_ex‹Á
 = 
·¿ms
->
Pİ
();

81 *
	gtmp_šput
 = 
šput_ex‹Á
->
d©a
();

82 
size_t
 
	gšput_Ën
 = 
šput_ex‹Á
->
size
();

83 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_šput
, 
šput_Ën
));

84 
	g¡d
::
unique_±r
<> 
šput
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
šput_Ën
)));

85 
memıy
(
šput
.
g‘
(), 
tmp_šput
, 
šput_Ën
);

87 *
	gtmp_Çme
 = 
Çme_ex‹Á
->
d©a
();

88 
size_t
 
	gÇme_Ën
 = 
Çme_ex‹Á
->
size
();

89 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_Çme
, 
Çme_Ën
));

90 
	g¡d
::
unique_±r
<> 
Çme
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
Çme_Ën
)));

91 
memıy
(
Çme
.
g‘
(), 
tmp_Çme
, 
Çme_Ën
);

93 *
	gouut
 = 
nuÎ±r
;

94 
size_t
 
	gouut_Ën
 = 0;

95 
	g»suÉ
 = 0;

96 
	gŒy
 {

97 
	g»suÉ
 = 
asylo
::
__asylo_u£r_š™
(
Çme
.
g‘
(), 
šput
.get(),

98  
šput_Ën
, &
ouut
,

99 &
ouut_Ën
);

100 } 
ÿtch
 (...) {

101 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

103 ià(!
	g»suÉ
) {

104 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
ouut
, 
ouut_Ën
});

106 
’c_uÁru¡ed_ä“
(
ouut
);

107  
Prim™iveStus
(
»suÉ
);

111 
Prim™iveStus
 
Run
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

112 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

113 autØ
	gšput_ex‹Á
 = 
·¿ms
->
Pİ
();

114 *
	gtmp_šput
 = 
šput_ex‹Á
->
d©a
();

115 
size_t
 
	gšput_Ën
 = 
šput_ex‹Á
->
size
();

116 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_šput
, 
šput_Ën
));

117 
	g¡d
::
unique_±r
<> 
šput
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
šput_Ën
)));

118 
memıy
(
šput
.
g‘
(), 
tmp_šput
, 
šput_Ën
);

120 *
	gouut
 = 
nuÎ±r
;

121 
size_t
 
	gouut_Ën
 = 0;

122 
	g»suÉ
 = 0;

123 
	gŒy
 {

124 
	g»suÉ
 = 
asylo
::
__asylo_u£r_run
(
šput
.
g‘
(), 
šput_Ën
, &
ouut
,

125 &
ouut_Ën
);

126 } 
ÿtch
 (...) {

127 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

129 ià(!
	g»suÉ
) {

130 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
ouut
, 
ouut_Ën
});

132 
’c_uÁru¡ed_ä“
(
ouut
);

133  
Prim™iveStus
(
»suÉ
);

138 
Prim™iveStus
 
Fš®ize
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

139 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

140 autØ
	gšput_ex‹Á
 = 
·¿ms
->
Pİ
();

141 *
	gtmp_šput
 = 
šput_ex‹Á
->
d©a
();

142 
size_t
 
	gšput_Ën
 = 
šput_ex‹Á
->
size
();

143 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_šput
, 
šput_Ën
));

144 
	g¡d
::
unique_±r
<> 
šput
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
šput_Ën
)));

145 
memıy
(
šput
.
g‘
(), 
tmp_šput
, 
šput_Ën
);

147 *
	gouut
 = 
nuÎ±r
;

148 
size_t
 
	gouut_Ën
 = 0;

149 
	g»suÉ
 = 0;

150 
	gŒy
 {

151 
	g»suÉ
 = 
asylo
::
__asylo_u£r_fši
(
šput
.
g‘
(), 
šput_Ën
, &
ouut
,

152 &
ouut_Ën
);

153 } 
ÿtch
 (...) {

154 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

156 ià(!
	g»suÉ
) {

157 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
ouut
, 
ouut_Ën
});

159 
’c_uÁru¡ed_ä“
(
ouut
);

160  
Prim™iveStus
(
»suÉ
);

165 
Prim™iveStus
 
DÚ©eTh»ad
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

166 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 0);

167 
	g»suÉ
 = 0;

168 
	gŒy
 {

169 
	g»suÉ
 = 
asylo
::
__asylo_th»adšg_dÚ©e
();

170 } 
ÿtch
 (...) {

171 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

173  
Prim™iveStus
(
»suÉ
);

176 
	g¡d
::
unique_±r
<
UÁru¡edAÎoÿtÜSck
,

177 
deşty³
(
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
) *>

178 
In™UÁru¡edSck
() {

179 autØ
uÁru¡ed_¡ack
 =

180 
¡d
::
unique_±r
<
UÁru¡edAÎoÿtÜSck
,

181 
deşty³
(
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
) *>{

182 
»š‹½»t_ÿ¡
<
UÁru¡edAÎoÿtÜSck
 *>(

183 
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(

184 (
UÁru¡edAÎoÿtÜSck
))),

185 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
};

190 
UÁru¡edAÎoÿtÜSck
 
	gem±y_¡ack
;

191 
memıy
(
»š‹½»t_ÿ¡
<*>(
uÁru¡ed_¡ack
.
g‘
()),

192 
»š‹½»t_ÿ¡
<*>(&
em±y_¡ack
), (empty_stack));

193 ià(!
’c_is_outside_’şave
(
uÁru¡ed_¡ack
.
g‘
(),

194 (
UÁru¡edAÎoÿtÜSck
)) ||

195 
	guÁru¡ed_¡ack
.
g‘
()->
size
(è!ğ0 || !
uÁru¡ed_¡ack
->
em±y
()) {

196 
abÜt
();

199  
	guÁru¡ed_¡ack
;

205 
Regi¡”IÁ”ÇlHªdËrs
() {

207 
EÁryHªdËr
 
š™_hªdËr
(
In™Ÿlize
);

208 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
kS–eùÜAsyloIn™
, 
š™_hªdËr
)

209 .
ok
()) {

210 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

214 
EÁryHªdËr
 
run_hªdËr
(
Run
);

215 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
kS–eùÜAsyloRun
, 
run_hªdËr
)

216 .
ok
()) {

217 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

221 
EÁryHªdËr
 
	gfš®ize_hªdËr
{
	gFš®ize
};

222 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

223 
kS–eùÜAsyloFši
, 
fš®ize_hªdËr
).
ok
()) {

224 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

228 
EÁryHªdËr
 
	gdÚ©e_th»ad_hªdËr
{
	gDÚ©eTh»ad
};

229 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

230 
kS–eùÜAsyloDÚ©eTh»ad
, 
dÚ©e_th»ad_hªdËr
).
ok
()) {

231 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

235 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
(cÚ¡ *
mes§ge
) {

236 
’c_block_eÿÎs
();

237 
M¬kEnşaveAbÜ‹d
();

238 
abÜt
();

241 
Prim™iveStus
 
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

242 
ušt64_t
 
£ËùÜ
, cÚ¡ 
EÁryHªdËr
 &
hªdËr
) {

243  
	gasylo
::
´im™ives
::
Regi¡”EÁryHªdËr
(
£ËùÜ
, 
hªdËr
);

246 
asylo_’şave_ÿÎ
(
ušt64_t
 
£ËùÜ
, *
·¿ms
) {

247 
Prim™iveStus
 
	g¡©us
 = 
InvokeEÁryHªdËr
(

248 
£ËùÜ
, 
»š‹½»t_ÿ¡
<
Tru¡edP¬am‘”Sck
 *>(
·¿ms
));

249  !
	g¡©us
.
ok
();

252 *
	gTru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(
size_t
 
size
) {

253  
’c_uÁru¡ed_m®loc
(
size
);

256 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
(*
±r
) {

257 
’c_uÁru¡ed_ä“
(
±r
);

260 
	gTru¡edPrim™ives
::
DebugPuts
(cÚ¡ *
mes§ge
) {

261 
abÜt
();

264 
Prim™iveStus
 
	gTru¡edPrim™ives
::
UÁru¡edC®l
(

265 
ušt64_t
 
uÁru¡ed_£ËùÜ
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

266 
	g»t
;

271 ià(
’c_is_outside_’şave
(
·¿ms
, (*params))) {

272 
CHECK_OCALL
(
oÿÎ_di¥©ch_uÁru¡ed_ÿÎ
(

273 &
»t
, 
uÁru¡ed_£ËùÜ
, 
»š‹½»t_ÿ¡
<*>(
·¿ms
)));

274  
Prim™iveStus
(
»t
);

277 autØ
	guÁru¡ed_¡ack
 = 
In™UÁru¡edSck
();

285 
	g¡d
::
veùÜ
<
Tru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
> 
š_·¿ms
;

286 
	gš_·¿ms
.
»£rve
(
·¿ms
->
size
());

287 !
	g·¿ms
->
em±y
()) {

288 
	gš_·¿ms
.
em¶aû_back
(
·¿ms
->
Pİ
());

293 autØ
	g™
 = 
š_·¿ms
.
rbegš
(); iˆ!ğš_·¿ms.
»nd
(); ++it) {

294 
	guÁru¡ed_¡ack
->
PushByCİy
(
Ex‹Á
{(*
™
)->
d©a
(), (*™)->
size
()});

296 ià(!
’c_is_outside_’şave
(
uÁru¡ed_¡ack
->
Tİ
().
d©a
(),

297 
uÁru¡ed_¡ack
->
Tİ
().
size
())) {

298 
abÜt
();

303 
CHECK_OCALL
(
oÿÎ_di¥©ch_uÁru¡ed_ÿÎ
(

304 &
»t
, 
uÁru¡ed_£ËùÜ
,

305 
»š‹½»t_ÿ¡
<*>(
uÁru¡ed_¡ack
.
g‘
())));

309 
	g¡d
::
veùÜ
<
UÁru¡edAÎoÿtÜSck
::
Ex‹ÁPŒ
> 
»suÉ_·¿ms
;

310 
	g»suÉ_·¿ms
.
»£rve
(
uÁru¡ed_¡ack
->
size
());

311 !
	guÁru¡ed_¡ack
->
em±y
()) {

312 
	g»suÉ_·¿ms
.
em¶aû_back
(
uÁru¡ed_¡ack
->
Pİ
());

318 autØ
	g™
 = 
»suÉ_·¿ms
.
rbegš
(); iˆ!ğ»suÉ_·¿ms.
»nd
(); ++it) {

319 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{(*
™
)->
d©a
(), (*™)->
size
()});

322  
	gPrim™iveStus
::
OkStus
();

	@platform/primitives/sgx/trusted_sgx.cc

19 
	~"asylo/¶©fÜm/´im™ives/sgx/Œu¡ed_sgx.h
"

21 
	~<veùÜ
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/¶©fÜm/¬ch/sgx/Œu¡ed/g’”©ed_bridge_t.h
"

26 
	~"asylo/¶©fÜm/cÜe/’Œy_pošts.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

29 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

30 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

31 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

32 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

33 
	~"asylo/¶©fÜm/´im™ives/ut/´im™ive_locks.h
"

34 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_ruÁime_h–³r.h
"

35 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

36 
	~"asylo/ut/¡©us.h
"

37 
	~"asylo/ut/¡©us_maüos.h
"

38 
	~"šşude/sgx_Œts.h
"

40 "C" *
’c_uÁru¡ed_m®loc
(
size_t
 
size
);

41 "C" 
’c_uÁru¡ed_ä“
(*
±r
);

43 
Çme¥aû
 
	gasylo
 {

44 
Çme¥aû
 
	g´im™ives
 {

46 
	gÇme¥aû
 {

48 
usšg
 
	gUÁru¡edAÎoÿtÜSck
 =

49 
P¬am‘”Sck
<
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
,

50 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
>;

52 
	#CHECK_OCALL
(
¡©us_
) \

54 
sgx_¡©us_t
 
¡©us
##
__COUNTER__
 = 
¡©us_
; \

55 ià(
¡©us
##
__COUNTER__
 !ğ
SGX_SUCCESS
) { \

56 
Tru¡edPrim™ives
::
	`DebugPuts
( \

57 
ab¦
::
	`SŒC©
( \

58 
__FILE__
, ":", 
__LINE__
, ": ", \

59 
asylo
::
	`Stus
(
¡©us
##
__COUNTER__
, "oÿÎ faed").
	`ToSŒšg
()) \

60 .
	`c_¡r
()); \

61 
	`abÜt
(); \

63 } 0)

	)

67 
Prim™iveStus
 
V”ifyUÁru¡edAdd»ssRªge
(*
add»ss
, 
size_t
 
size
) {

68 ià(!
’c_is_outside_’şave
(
add»ss
, 
size
)) {

69  
Prim™iveStus
(
SGX_ERROR_INVALID_PARAMETER
,

72  
	gPrim™iveStus
::
OkStus
();

76 
Prim™iveStus
 
In™Ÿlize
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

77 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 2);

78 
	gTru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
 
šput_ex‹Á
 = 
·¿ms
->
Pİ
();

79 
	gTru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
 
Çme_ex‹Á
 = 
·¿ms
->
Pİ
();

81 *
	gtmp_šput
 = 
šput_ex‹Á
->
d©a
();

82 
size_t
 
	gšput_Ën
 = 
šput_ex‹Á
->
size
();

83 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_šput
, 
šput_Ën
));

84 
	g¡d
::
unique_±r
<> 
šput
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
šput_Ën
)));

85 
memıy
(
šput
.
g‘
(), 
tmp_šput
, 
šput_Ën
);

87 *
	gtmp_Çme
 = 
Çme_ex‹Á
->
d©a
();

88 
size_t
 
	gÇme_Ën
 = 
Çme_ex‹Á
->
size
();

89 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_Çme
, 
Çme_Ën
));

90 
	g¡d
::
unique_±r
<> 
Çme
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
Çme_Ën
)));

91 
memıy
(
Çme
.
g‘
(), 
tmp_Çme
, 
Çme_Ën
);

93 *
	gouut
 = 
nuÎ±r
;

94 
size_t
 
	gouut_Ën
 = 0;

95 
	g»suÉ
 = 0;

96 
	gŒy
 {

97 
	g»suÉ
 = 
asylo
::
__asylo_u£r_š™
(
Çme
.
g‘
(), 
šput
.get(),

98  
šput_Ën
, &
ouut
,

99 &
ouut_Ën
);

100 } 
ÿtch
 (...) {

101 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

103 ià(!
	g»suÉ
) {

104 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
ouut
, 
ouut_Ën
});

106 
’c_uÁru¡ed_ä“
(
ouut
);

107  
Prim™iveStus
(
»suÉ
);

111 
Prim™iveStus
 
Run
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

112 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

113 autØ
	gšput_ex‹Á
 = 
·¿ms
->
Pİ
();

114 *
	gtmp_šput
 = 
šput_ex‹Á
->
d©a
();

115 
size_t
 
	gšput_Ën
 = 
šput_ex‹Á
->
size
();

116 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_šput
, 
šput_Ën
));

117 
	g¡d
::
unique_±r
<> 
šput
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
šput_Ën
)));

118 
memıy
(
šput
.
g‘
(), 
tmp_šput
, 
šput_Ën
);

120 *
	gouut
 = 
nuÎ±r
;

121 
size_t
 
	gouut_Ën
 = 0;

122 
	g»suÉ
 = 0;

123 
	gŒy
 {

124 
	g»suÉ
 = 
asylo
::
__asylo_u£r_run
(
šput
.
g‘
(), 
šput_Ën
, &
ouut
,

125 &
ouut_Ën
);

126 } 
ÿtch
 (...) {

127 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

129 ià(!
	g»suÉ
) {

130 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
ouut
, 
ouut_Ën
});

132 
’c_uÁru¡ed_ä“
(
ouut
);

133  
Prim™iveStus
(
»suÉ
);

138 
Prim™iveStus
 
Fš®ize
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

139 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 1);

140 autØ
	gšput_ex‹Á
 = 
·¿ms
->
Pİ
();

141 *
	gtmp_šput
 = 
šput_ex‹Á
->
d©a
();

142 
size_t
 
	gšput_Ën
 = 
šput_ex‹Á
->
size
();

143 
ASYLO_RETURN_IF_ERROR
(
V”ifyUÁru¡edAdd»ssRªge
(
tmp_šput
, 
šput_Ën
));

144 
	g¡d
::
unique_±r
<> 
šput
(
»š‹½»t_ÿ¡
<*>(
m®loc
(
šput_Ën
)));

145 
memıy
(
šput
.
g‘
(), 
tmp_šput
, 
šput_Ën
);

147 *
	gouut
 = 
nuÎ±r
;

148 
size_t
 
	gouut_Ën
 = 0;

149 
	g»suÉ
 = 0;

150 
	gŒy
 {

151 
	g»suÉ
 = 
asylo
::
__asylo_u£r_fši
(
šput
.
g‘
(), 
šput_Ën
, &
ouut
,

152 &
ouut_Ën
);

153 } 
ÿtch
 (...) {

154 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

156 ià(!
	g»suÉ
) {

157 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{
ouut
, 
ouut_Ën
});

159 
’c_uÁru¡ed_ä“
(
ouut
);

160  
Prim™iveStus
(
»suÉ
);

165 
Prim™iveStus
 
DÚ©eTh»ad
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

166 
ASYLO_RETURN_IF_INCORRECT_ARGUMENTS
(
·¿ms
, 0);

167 
	g»suÉ
 = 0;

168 
	gŒy
 {

169 
	g»suÉ
 = 
asylo
::
__asylo_th»adšg_dÚ©e
();

170 } 
ÿtch
 (...) {

171 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Uncaughtƒxception inƒnclave");

173  
Prim™iveStus
(
»suÉ
);

176 
	g¡d
::
unique_±r
<
UÁru¡edAÎoÿtÜSck
,

177 
deşty³
(
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
) *>

178 
In™UÁru¡edSck
() {

179 autØ
uÁru¡ed_¡ack
 =

180 
¡d
::
unique_±r
<
UÁru¡edAÎoÿtÜSck
,

181 
deşty³
(
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
) *>{

182 
»š‹½»t_ÿ¡
<
UÁru¡edAÎoÿtÜSck
 *>(

183 
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(

184 (
UÁru¡edAÎoÿtÜSck
))),

185 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
};

190 
UÁru¡edAÎoÿtÜSck
 
	gem±y_¡ack
;

191 
memıy
(
»š‹½»t_ÿ¡
<*>(
uÁru¡ed_¡ack
.
g‘
()),

192 
»š‹½»t_ÿ¡
<*>(&
em±y_¡ack
), (empty_stack));

193 ià(!
’c_is_outside_’şave
(
uÁru¡ed_¡ack
.
g‘
(),

194 (
UÁru¡edAÎoÿtÜSck
)) ||

195 
	guÁru¡ed_¡ack
.
g‘
()->
size
(è!ğ0 || !
uÁru¡ed_¡ack
->
em±y
()) {

196 
abÜt
();

199  
	guÁru¡ed_¡ack
;

205 
Regi¡”IÁ”ÇlHªdËrs
() {

207 
EÁryHªdËr
 
š™_hªdËr
(
In™Ÿlize
);

208 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
kS–eùÜAsyloIn™
, 
š™_hªdËr
)

209 .
ok
()) {

210 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

214 
EÁryHªdËr
 
run_hªdËr
(
Run
);

215 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
kS–eùÜAsyloRun
, 
run_hªdËr
)

216 .
ok
()) {

217 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

221 
EÁryHªdËr
 
	gfš®ize_hªdËr
{
	gFš®ize
};

222 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

223 
kS–eùÜAsyloFši
, 
fš®ize_hªdËr
).
ok
()) {

224 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

228 
EÁryHªdËr
 
	gdÚ©e_th»ad_hªdËr
{
	gDÚ©eTh»ad
};

229 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

230 
kS–eùÜAsyloDÚ©eTh»ad
, 
dÚ©e_th»ad_hªdËr
).
ok
()) {

231 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

235 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
(cÚ¡ *
mes§ge
) {

236 
’c_block_eÿÎs
();

237 
M¬kEnşaveAbÜ‹d
();

238 
abÜt
();

241 
Prim™iveStus
 
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

242 
ušt64_t
 
£ËùÜ
, cÚ¡ 
EÁryHªdËr
 &
hªdËr
) {

243  
	gasylo
::
´im™ives
::
Regi¡”EÁryHªdËr
(
£ËùÜ
, 
hªdËr
);

246 
asylo_’şave_ÿÎ
(
ušt64_t
 
£ËùÜ
, *
·¿ms
) {

247 
Prim™iveStus
 
	g¡©us
 = 
InvokeEÁryHªdËr
(

248 
£ËùÜ
, 
»š‹½»t_ÿ¡
<
Tru¡edP¬am‘”Sck
 *>(
·¿ms
));

249  !
	g¡©us
.
ok
();

252 *
	gTru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(
size_t
 
size
) {

253  
’c_uÁru¡ed_m®loc
(
size
);

256 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
(*
±r
) {

257 
’c_uÁru¡ed_ä“
(
±r
);

260 
	gTru¡edPrim™ives
::
DebugPuts
(cÚ¡ *
mes§ge
) {

261 
abÜt
();

264 
Prim™iveStus
 
	gTru¡edPrim™ives
::
UÁru¡edC®l
(

265 
ušt64_t
 
uÁru¡ed_£ËùÜ
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

266 
	g»t
;

271 ià(
’c_is_outside_’şave
(
·¿ms
, (*params))) {

272 
CHECK_OCALL
(
oÿÎ_di¥©ch_uÁru¡ed_ÿÎ
(

273 &
»t
, 
uÁru¡ed_£ËùÜ
, 
»š‹½»t_ÿ¡
<*>(
·¿ms
)));

274  
Prim™iveStus
(
»t
);

277 autØ
	guÁru¡ed_¡ack
 = 
In™UÁru¡edSck
();

285 
	g¡d
::
veùÜ
<
Tru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
> 
š_·¿ms
;

286 
	gš_·¿ms
.
»£rve
(
·¿ms
->
size
());

287 !
	g·¿ms
->
em±y
()) {

288 
	gš_·¿ms
.
em¶aû_back
(
·¿ms
->
Pİ
());

293 autØ
	g™
 = 
š_·¿ms
.
rbegš
(); iˆ!ğš_·¿ms.
»nd
(); ++it) {

294 
	guÁru¡ed_¡ack
->
PushByCİy
(
Ex‹Á
{(*
™
)->
d©a
(), (*™)->
size
()});

296 ià(!
’c_is_outside_’şave
(
uÁru¡ed_¡ack
->
Tİ
().
d©a
(),

297 
uÁru¡ed_¡ack
->
Tİ
().
size
())) {

298 
abÜt
();

303 
CHECK_OCALL
(
oÿÎ_di¥©ch_uÁru¡ed_ÿÎ
(

304 &
»t
, 
uÁru¡ed_£ËùÜ
,

305 
»š‹½»t_ÿ¡
<*>(
uÁru¡ed_¡ack
.
g‘
())));

309 
	g¡d
::
veùÜ
<
UÁru¡edAÎoÿtÜSck
::
Ex‹ÁPŒ
> 
»suÉ_·¿ms
;

310 
	g»suÉ_·¿ms
.
»£rve
(
uÁru¡ed_¡ack
->
size
());

311 !
	guÁru¡ed_¡ack
->
em±y
()) {

312 
	g»suÉ_·¿ms
.
em¶aû_back
(
uÁru¡ed_¡ack
->
Pİ
());

318 autØ
	g™
 = 
»suÉ_·¿ms
.
rbegš
(); iˆ!ğ»suÉ_·¿ms.
»nd
(); ++it) {

319 
	g·¿ms
->
PushByCİy
(
Ex‹Á
{(*
™
)->
d©a
(), (*™)->
size
()});

322  
	gPrim™iveStus
::
OkStus
();

	@platform/primitives/sgx/trusted_sgx.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_SGX_TRUSTED_SGX_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_SGX_TRUSTED_SGX_H_


	)

24 
	~<c¡dšt
>

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g´im™ives
 {

32 
asylo_’şave_ÿÎ
(
ušt64_t
 
£ËùÜ
, *
·¿ms
);

	@platform/primitives/sgx/untrusted_sgx.cc

19 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

21 
	~<sys/mmª.h
>

22 
	~<uni¡d.h
>

23 
	~<c¡dlib
>

25 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

26 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

27 
	~"asylo/ut/–f_»ad”.h
"

28 
	~"asylo/ut/fe_m­pšg.h
"

29 
	~"asylo/ut/¡©us.h
"

30 
	~"asylo/ut/¡©us_maüos.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

32 
	~"šşude/sgx_edg”8r.h
"

33 
	~"šşude/sgx_u¹s.h
"

36 
	soÿÎ_bË_t
 {

37 
size_t
 
	mÄ_oÿÎ
;

38 *
	mbË
[];

43 "C" 
ABSL_CONST_INIT
 cÚ¡ 
oÿÎ_bË_t
 
oÿÎ_bË_bridge
;

45 
Çme¥aû
 
	gasylo
 {

46 
Çme¥aû
 
	g´im™ives
 {

48 
	gÇme¥aû
 {

50 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kC®lšgProûssBš¬yFe
 = "/proc/self/exe";

52 
cÚ¡ex´
 
	gkMaxEnşaveC»©eA‰em±s
 = 5;

55 
	sms_eÿÎ_di¥©ch_Œu¡ed_ÿÎ_t
 {

57 
	gms_»tv®
;

60 
ušt64_t
 
	gms_£ËùÜ
;

65 * 
	gms_bufãr
;

70 
	gSgxEnşaveCl›Á
::~
SgxEnşaveCl›Á
() = ;

72 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SgxBack’d
::
Lßd
(

73 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
, *
ba£_add»ss
,

74 
ab¦
::
¡ršg_v›w
 
’şave_·th
, 
size_t
 
’şave_size
,

75 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
, 
boŞ
 
debug
,

76 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

77 
¡d
::
sh¬ed_±r
<
SgxEnşaveCl›Á
> 
ş›Á
(

78 
Ãw
 
SgxEnşaveCl›Á
(
’şave_Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)));

79 
	gş›Á
->
	gba£_add»ss_
 = 
ba£_add»ss
;

81 
	gupd©ed
;

82 
sgx_¡©us_t
 
	g¡©us
;

83 cÚ¡ 
ušt32_t
 
	gex_ã©u»s
 = 
SGX_CREATE_ENCLAVE_EX_ASYLO
;

84 
asylo_sgx_cÚfig_t
 
	gü—‹_cÚfig
 = {

85 .
ba£_add»ss
 = &
ş›Á
->
ba£_add»ss_
,

86 .
	g’şave_size
 = 
’şave_size
,

87 .
	g’abË_u£r_ut™y
 = 
cÚfig
.
’abË_fÜk
()

89 cÚ¡ * 
	gex_ã©u»s_p
[32] = { 
nuÎ±r
 };

90 
	gex_ã©u»s_p
[
SGX_CREATE_ENCLAVE_EX_ASYLO_BIT_IDX
] = &
ü—‹_cÚfig
;

91 
	gi
 = 0; i < 
	gkMaxEnşaveC»©eA‰em±s
; ++i) {

92 
	g¡©us
 = 
sgx_ü—‹_’şave_ex
(

93 
¡d
::
¡ršg
(
’şave_·th
).
c_¡r
(), 
debug
, &
ş›Á
->
tok’_
, &
upd©ed
,

94 &
ş›Á
->
id_
, 
nuÎ±r
, 
ex_ã©u»s
, 
ex_ã©u»s_p
);

96 
LOG_IF
(
WARNING
, 
¡©us
 !ğ
SGX_SUCCESS
)

97 << "FaedØü—‹‡À’şave,‡‰em±=" << 
i


98 << ", stus=" << 
¡©us
;

99 ià(
	g¡©us
 !ğ
SGX_INTERNAL_ERROR_ENCLAVE_CREATE_INTERRUPTED
) {

104 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

105  
Stus
(
¡©us
, "Failedo create‡nƒnclave");

108 
	gş›Á
->
	gsize_
 = 
sgx_’şave_size
(
ş›Á
->
id_
);

109  
	gş›Á
;

112 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SgxEmbeddedBack’d
::
Lßd
(

113 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
, *
ba£_add»ss
,

114 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
, 
size_t
 
’şave_size
,

115 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
, 
boŞ
 
debug
,

116 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

117 
¡d
::
sh¬ed_±r
<
SgxEnşaveCl›Á
> 
ş›Á
(

118 
Ãw
 
SgxEnşaveCl›Á
(
’şave_Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)));

119 
	gş›Á
->
	gba£_add»ss_
 = 
ba£_add»ss
;

123 ià(
	gba£_add»ss
 && 
	g’şave_size
 > 0 &&

124 
mm­
(
ba£_add»ss
, 
’şave_size
, 
PROT_NONE
, 
MAP_SHARED
 | 
MAP_ANONYMOUS
,

125 -1, 0è!ğ
ba£_add»ss
) {

126  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

130 
FeM­pšg
 
	g£lf_bš¬y_m­pšg
;

131 
ASYLO_ASSIGN_OR_RETURN
(
£lf_bš¬y_m­pšg
, 
FeM­pšg
::
C»©eFromFe
(

132 
kC®lšgProûssBš¬yFe
));

134 
ElfR—d”
 
	g£lf_bš¬y_»ad”
;

135 
ASYLO_ASSIGN_OR_RETURN
(
£lf_bš¬y_»ad”
, 
ElfR—d”
::
C»©eFromS·n
(

136 
£lf_bš¬y_m­pšg
.
bufãr
()));

138 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
’şave_bufãr
;

139 
ASYLO_ASSIGN_OR_RETURN
(
’şave_bufãr
, 
£lf_bš¬y_»ad”
.
G‘SeùiÚD©a
(

140 
¡d
::
¡ršg
(
£ùiÚ_Çme
)));

142 ià(
	gba£_add»ss
 && 
	g’şave_size
 > 0 &&

143 
munm­
(
ba£_add»ss
, 
’şave_size
) < 0) {

144  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

148 
sgx_¡©us_t
 
	g¡©us
;

149 cÚ¡ 
ušt32_t
 
	gex_ã©u»s
 = 
SGX_CREATE_ENCLAVE_EX_ASYLO
;

150 
asylo_sgx_cÚfig_t
 
	gü—‹_cÚfig
 = {

151 .
ba£_add»ss
 = &
ş›Á
->
ba£_add»ss_
,

152 .
	g’şave_size
 = 
’şave_size
,

153 .
	g’abË_u£r_ut™y
 = 
cÚfig
.
’abË_fÜk
()

155 cÚ¡ * 
	gex_ã©u»s_p
[32] = { 
nuÎ±r
 };

156 
	gex_ã©u»s_p
[
SGX_CREATE_ENCLAVE_EX_ASYLO_BIT_IDX
] = &
ü—‹_cÚfig
;

157 
	gi
 = 0; i < 
	gkMaxEnşaveC»©eA‰em±s
; ++i) {

158 
	g¡©us
 = 
sgx_ü—‹_’şave_äom_bufãr_ex
(

159 
cÚ¡_ÿ¡
<
ušt8_t
 *>(
’şave_bufãr
.
d©a
()),ƒnşave_bufãr.
size
(),

160 
debug
, &
ş›Á
->
id_
, 
nuÎ±r
, 
ex_ã©u»s
,

161 
ex_ã©u»s_p
);

163 ià(
	g¡©us
 !ğ
SGX_INTERNAL_ERROR_ENCLAVE_CREATE_INTERRUPTED
) {

168 
	gş›Á
->
	gsize_
 = 
sgx_’şave_size
(
ş›Á
->
id_
);

170 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

171  
Stus
(
¡©us
, "Failedo create‡nƒnclave");

174  
	gş›Á
;

177 
Stus
 
	gSgxEnşaveCl›Á
::
De¡roy
() {

178 
sgx_¡©us_t
 
¡©us
 = 
sgx_de¡roy_’şave
(
id_
);

179 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

180  
Stus
(
¡©us
, "Failedo destroyƒnclave");

182  
	gStus
::
OkStus
();

185 
sgx_’şave_id_t
 
	gSgxEnşaveCl›Á
::
G‘EnşaveId
(ècÚ¡ {  
id_
; }

187 
size_t
 
	gSgxEnşaveCl›Á
::
G‘EnşaveSize
(ècÚ¡ {  
size_
; }

189 *
	gSgxEnşaveCl›Á
::
G‘Ba£Add»ss
(ècÚ¡ {  
ba£_add»ss_
; }

191 
	gSgxEnşaveCl›Á
::
G‘LaunchTok’
(
sgx_Ïunch_tok’_t
 *
tok’
) const {

192 
memıy
(
tok’
, &
tok’_
, (token_));

195 
boŞ
 
	gSgxEnşaveCl›Á
::
IsClo£d
() const {

196 
abÜt
();

199 
Stus
 
	gSgxEnşaveCl›Á
::
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

200 
N©iveP¬am‘”Sck
 *
·¿ms
) {

201 
ms_eÿÎ_di¥©ch_Œu¡ed_ÿÎ_t
 
	gms
;

202 
	gms
.
	gms_£ËùÜ
 = 
£ËùÜ
;

203 
	gms
.
	gms_bufãr
 = 
»š‹½»t_ÿ¡
<*>(
·¿ms
);

205 cÚ¡ 
oÿÎ_bË_t
* 
	gbË
 = &
oÿÎ_bË_bridge
;

207 
sgx_¡©us_t
 
	g¡©us
 =

208 
sgx_eÿÎ
(
id_
, 0, 
bË
, &
ms
, 
çl£
);

210 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

212  
Stus
(
¡©us
, "Callo…rimitivesƒcallƒndpoint failed");

214 ià(
	gms
.
	gms_»tv®
) {

215  
Stus
(

216 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Enclave call failed insideƒnclave");

218  
	gStus
::
OkStus
();

	@platform/primitives/sgx/untrusted_sgx.cc

19 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

21 
	~<sys/mmª.h
>

22 
	~<uni¡d.h
>

23 
	~<c¡dlib
>

25 
	~"asylo/¶©fÜm/´im™ives/sgx/sgx_”rÜ_¥aû.h
"

26 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

27 
	~"asylo/ut/–f_»ad”.h
"

28 
	~"asylo/ut/fe_m­pšg.h
"

29 
	~"asylo/ut/¡©us.h
"

30 
	~"asylo/ut/¡©us_maüos.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

32 
	~"šşude/sgx_edg”8r.h
"

33 
	~"šşude/sgx_u¹s.h
"

36 
	soÿÎ_bË_t
 {

37 
size_t
 
	mÄ_oÿÎ
;

38 *
	mbË
[];

43 "C" 
ABSL_CONST_INIT
 cÚ¡ 
oÿÎ_bË_t
 
oÿÎ_bË_bridge
;

45 
Çme¥aû
 
	gasylo
 {

46 
Çme¥aû
 
	g´im™ives
 {

48 
	gÇme¥aû
 {

50 
cÚ¡ex´
 
	gab¦
::
¡ršg_v›w
 
kC®lšgProûssBš¬yFe
 = "/proc/self/exe";

52 
cÚ¡ex´
 
	gkMaxEnşaveC»©eA‰em±s
 = 5;

55 
	sms_eÿÎ_di¥©ch_Œu¡ed_ÿÎ_t
 {

57 
	gms_»tv®
;

60 
ušt64_t
 
	gms_£ËùÜ
;

65 * 
	gms_bufãr
;

70 
	gSgxEnşaveCl›Á
::~
SgxEnşaveCl›Á
() = ;

72 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SgxBack’d
::
Lßd
(

73 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
, *
ba£_add»ss
,

74 
ab¦
::
¡ršg_v›w
 
’şave_·th
, 
size_t
 
’şave_size
,

75 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
, 
boŞ
 
debug
,

76 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

77 
¡d
::
sh¬ed_±r
<
SgxEnşaveCl›Á
> 
ş›Á
(

78 
Ãw
 
SgxEnşaveCl›Á
(
’şave_Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)));

79 
	gş›Á
->
	gba£_add»ss_
 = 
ba£_add»ss
;

81 
	gupd©ed
;

82 
sgx_¡©us_t
 
	g¡©us
;

83 cÚ¡ 
ušt32_t
 
	gex_ã©u»s
 = 
SGX_CREATE_ENCLAVE_EX_ASYLO
;

84 
asylo_sgx_cÚfig_t
 
	gü—‹_cÚfig
 = {

85 .
ba£_add»ss
 = &
ş›Á
->
ba£_add»ss_
,

86 .
	g’şave_size
 = 
’şave_size
,

87 .
	g’abË_u£r_ut™y
 = 
cÚfig
.
’abË_fÜk
()

89 cÚ¡ * 
	gex_ã©u»s_p
[32] = { 
nuÎ±r
 };

90 
	gex_ã©u»s_p
[
SGX_CREATE_ENCLAVE_EX_ASYLO_BIT_IDX
] = &
ü—‹_cÚfig
;

91 
	gi
 = 0; i < 
	gkMaxEnşaveC»©eA‰em±s
; ++i) {

92 
	g¡©us
 = 
sgx_ü—‹_’şave_ex
(

93 
¡d
::
¡ršg
(
’şave_·th
).
c_¡r
(), 
debug
, &
ş›Á
->
tok’_
, &
upd©ed
,

94 &
ş›Á
->
id_
, 
nuÎ±r
, 
ex_ã©u»s
, 
ex_ã©u»s_p
);

96 
LOG_IF
(
WARNING
, 
¡©us
 !ğ
SGX_SUCCESS
)

97 << "FaedØü—‹‡À’şave,‡‰em±=" << 
i


98 << ", stus=" << 
¡©us
;

99 ià(
	g¡©us
 !ğ
SGX_INTERNAL_ERROR_ENCLAVE_CREATE_INTERRUPTED
) {

104 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

105  
Stus
(
¡©us
, "Failedo create‡nƒnclave");

108 
	gş›Á
->
	gsize_
 = 
sgx_’şave_size
(
ş›Á
->
id_
);

109  
	gş›Á
;

112 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SgxEmbeddedBack’d
::
Lßd
(

113 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
, *
ba£_add»ss
,

114 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
, 
size_t
 
’şave_size
,

115 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
, 
boŞ
 
debug
,

116 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

117 
¡d
::
sh¬ed_±r
<
SgxEnşaveCl›Á
> 
ş›Á
(

118 
Ãw
 
SgxEnşaveCl›Á
(
’şave_Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)));

119 
	gş›Á
->
	gba£_add»ss_
 = 
ba£_add»ss
;

123 ià(
	gba£_add»ss
 && 
	g’şave_size
 > 0 &&

124 
mm­
(
ba£_add»ss
, 
’şave_size
, 
PROT_NONE
, 
MAP_SHARED
 | 
MAP_ANONYMOUS
,

125 -1, 0è!ğ
ba£_add»ss
) {

126  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

130 
FeM­pšg
 
	g£lf_bš¬y_m­pšg
;

131 
ASYLO_ASSIGN_OR_RETURN
(
£lf_bš¬y_m­pšg
, 
FeM­pšg
::
C»©eFromFe
(

132 
kC®lšgProûssBš¬yFe
));

134 
ElfR—d”
 
	g£lf_bš¬y_»ad”
;

135 
ASYLO_ASSIGN_OR_RETURN
(
£lf_bš¬y_»ad”
, 
ElfR—d”
::
C»©eFromS·n
(

136 
£lf_bš¬y_m­pšg
.
bufãr
()));

138 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
’şave_bufãr
;

139 
ASYLO_ASSIGN_OR_RETURN
(
’şave_bufãr
, 
£lf_bš¬y_»ad”
.
G‘SeùiÚD©a
(

140 
¡d
::
¡ršg
(
£ùiÚ_Çme
)));

142 ià(
	gba£_add»ss
 && 
	g’şave_size
 > 0 &&

143 
munm­
(
ba£_add»ss
, 
’şave_size
) < 0) {

144  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

148 
sgx_¡©us_t
 
	g¡©us
;

149 cÚ¡ 
ušt32_t
 
	gex_ã©u»s
 = 
SGX_CREATE_ENCLAVE_EX_ASYLO
;

150 
asylo_sgx_cÚfig_t
 
	gü—‹_cÚfig
 = {

151 .
ba£_add»ss
 = &
ş›Á
->
ba£_add»ss_
,

152 .
	g’şave_size
 = 
’şave_size
,

153 .
	g’abË_u£r_ut™y
 = 
cÚfig
.
’abË_fÜk
()

155 cÚ¡ * 
	gex_ã©u»s_p
[32] = { 
nuÎ±r
 };

156 
	gex_ã©u»s_p
[
SGX_CREATE_ENCLAVE_EX_ASYLO_BIT_IDX
] = &
ü—‹_cÚfig
;

157 
	gi
 = 0; i < 
	gkMaxEnşaveC»©eA‰em±s
; ++i) {

158 
	g¡©us
 = 
sgx_ü—‹_’şave_äom_bufãr_ex
(

159 
cÚ¡_ÿ¡
<
ušt8_t
 *>(
’şave_bufãr
.
d©a
()),ƒnşave_bufãr.
size
(),

160 
debug
, &
ş›Á
->
id_
, 
nuÎ±r
, 
ex_ã©u»s
,

161 
ex_ã©u»s_p
);

163 ià(
	g¡©us
 !ğ
SGX_INTERNAL_ERROR_ENCLAVE_CREATE_INTERRUPTED
) {

168 
	gş›Á
->
	gsize_
 = 
sgx_’şave_size
(
ş›Á
->
id_
);

170 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

171  
Stus
(
¡©us
, "Failedo create‡nƒnclave");

174  
	gş›Á
;

177 
Stus
 
	gSgxEnşaveCl›Á
::
De¡roy
() {

178 
sgx_¡©us_t
 
¡©us
 = 
sgx_de¡roy_’şave
(
id_
);

179 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

180  
Stus
(
¡©us
, "Failedo destroyƒnclave");

182  
	gStus
::
OkStus
();

185 
sgx_’şave_id_t
 
	gSgxEnşaveCl›Á
::
G‘EnşaveId
(ècÚ¡ {  
id_
; }

187 
size_t
 
	gSgxEnşaveCl›Á
::
G‘EnşaveSize
(ècÚ¡ {  
size_
; }

189 *
	gSgxEnşaveCl›Á
::
G‘Ba£Add»ss
(ècÚ¡ {  
ba£_add»ss_
; }

191 
	gSgxEnşaveCl›Á
::
G‘LaunchTok’
(
sgx_Ïunch_tok’_t
 *
tok’
) const {

192 
memıy
(
tok’
, &
tok’_
, (token_));

195 
boŞ
 
	gSgxEnşaveCl›Á
::
IsClo£d
() const {

196 
abÜt
();

199 
Stus
 
	gSgxEnşaveCl›Á
::
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

200 
N©iveP¬am‘”Sck
 *
·¿ms
) {

201 
ms_eÿÎ_di¥©ch_Œu¡ed_ÿÎ_t
 
	gms
;

202 
	gms
.
	gms_£ËùÜ
 = 
£ËùÜ
;

203 
	gms
.
	gms_bufãr
 = 
»š‹½»t_ÿ¡
<*>(
·¿ms
);

205 cÚ¡ 
oÿÎ_bË_t
* 
	gbË
 = &
oÿÎ_bË_bridge
;

207 
sgx_¡©us_t
 
	g¡©us
 =

208 
sgx_eÿÎ
(
id_
, 0, 
bË
, &
ms
, 
çl£
);

210 ià(
	g¡©us
 !ğ
SGX_SUCCESS
) {

212  
Stus
(
¡©us
, "Callo…rimitivesƒcallƒndpoint failed");

214 ià(
	gms
.
	gms_»tv®
) {

215  
Stus
(

216 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Enclave call failed insideƒnclave");

218  
	gStus
::
OkStus
();

	@platform/primitives/sgx/untrusted_sgx.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_SGX_UNTRUSTED_SGX_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_SGX_UNTRUSTED_SGX_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/’şave.pb.h
"

25 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

27 
	~"šşude/sgx_u¹s.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g´im™ives
 {

35 
	sSgxBack’d
 {

38 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
Lßd
(

39 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
, *
ba£_add»ss
,

40 
ab¦
::
¡ršg_v›w
 
’şave_·th
, 
size_t
 
’şave_size
,

41 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
, 
boŞ
 
debug
,

42 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
);

48 
	sSgxEmbeddedBack’d
 {

51 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
Lßd
(

52 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
, *
ba£_add»ss
,

53 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
, 
size_t
 
’şave_size
,

54 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
, 
boŞ
 
debug
,

55 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
);

59 şas 
	cSgxEnşaveCl›Á
 : 
public
 
Cl›Á
 {

60 
public
:

61 ~
SgxEnşaveCl›Á
(è
ov”ride
;

62 
Stus
 
De¡roy
(è
	gov”ride
;

66 
sgx_’şave_id_t
 
G‘EnşaveId
() const;

69 
size_t
 
G‘EnşaveSize
() const;

72 *
G‘Ba£Add»ss
() const;

75 
G‘LaunchTok’
(
sgx_Ïunch_tok’_t
 *
tok’
) const;

77 
	g´Ùeùed
:

78 
Stus
 
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

79 
N©iveP¬am‘”Sck
 *
·¿ms
è
	gov”ride
;

80 
boŞ
 
IsClo£d
(ècÚ¡ 
	gov”ride
;

82 
	g´iv©e
:

83 
ä›nd
 
SgxBack’d
;

84 
ä›nd
 
	gSgxEmbeddedBack’d
;

87 
SgxEnşaveCl›Á
(

88 cÚ¡ 
ab¦
::
¡ršg_v›w
 
Çme
,

89 
¡d
::
unique_±r
<
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
)

90 : 
Cl›Á
(
Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)) {}

92 
sgx_Ïunch_tok’_t
 
tok’_
 = {0};

93 
sgx_’şave_id_t
 
	gid_
;

94 *
	gba£_add»ss_
;

95 
size_t
 
	gsize_
;

	@platform/primitives/sim/malloc_lock.cc

19 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/´im™ives/ut/´im™ive_locks.h
"

22 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g´im™ives
 {

34 
asylo_¥šlock_t
 
	gh—p_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

39 
th»ad_loÿl
 
št64_t
 
	gth»ad_lock_couÁ
 = 0;

43 
__m®loc_lock
(
»’t
 *) {

44 ià(
th»ad_lock_couÁ
 == 0) {

45 
asylo_¥š_lock
(&
h—p_lock
);

47 ++
th»ad_lock_couÁ
;

50 
__m®loc_uÆock
(
»’t
 *) {

51 ià(--
th»ad_lock_couÁ
 == 0) {

52 
asylo_¥š_uÆock
(&
h—p_lock
);

	@platform/primitives/sim/malloc_lock.cc

19 
	~<c¡dlib
>

21 
	~"asylo/¶©fÜm/´im™ives/ut/´im™ive_locks.h
"

22 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g´im™ives
 {

34 
asylo_¥šlock_t
 
	gh—p_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

39 
th»ad_loÿl
 
št64_t
 
	gth»ad_lock_couÁ
 = 0;

43 
__m®loc_lock
(
»’t
 *) {

44 ià(
th»ad_lock_couÁ
 == 0) {

45 
asylo_¥š_lock
(&
h—p_lock
);

47 ++
th»ad_lock_couÁ
;

50 
__m®loc_uÆock
(
»’t
 *) {

51 ià(--
th»ad_lock_couÁ
 == 0) {

52 
asylo_¥š_uÆock
(&
h—p_lock
);

	@platform/primitives/sim/runtime_stubs.c

24 
	$acûss
(è{  0; 
	}
}

25 
	$şock_g‘time
(è{  0; 
	}
}

26 
	$’şave_şo£
(è{  0; 
	}
}

27 
	$’şave_execve
(è{  0; 
	}
}

28 
	$’şave_ex™
(è{  0; 
	}
}

29 
	$’şave_fú
(è{  0; 
	}
}

30 
	$’şave_fÜk
(è{  0; 
	}
}

31 
	$’şave_f¡©
(è{  0; 
	}
}

32 
	$’şave_g‘pid
(è{  0; 
	}
}

33 
	$’şave_g‘timeofday
(è{  0; 
	}
}

34 
	$’şave_kl
(è{  0; 
	}
}

35 
	$’şave_lšk
(è{  0; 
	}
}

36 
	$’şave_l£ek
(è{  0; 
	}
}

37 
	$’şave_mkdœ
(è{  0; 
	}
}

38 
	$’şave_İ’
(è{  0; 
	}
}

39 
	$’şave_»ad
(è{  0; 
	}
}

40 
	$’şave_¡©
(è{  0; 
	}
}

41 
	$’şave_times
(è{  0; 
	}
}

42 
	$’şave_uÆšk
(è{  0; 
	}
}

43 
	$’şave_wa™
(è{  0; 
	}
}

44 
	$g‘euid
(è{  0; 
	}
}

45 
	$g‘grgid_r
(è{  0; 
	}
}

46 
	$g‘gºam_r
(è{  0; 
	}
}

47 
	$g‘pwÇm_r
(è{  0; 
	}
}

48 
	$g‘pwuid_r
(è{  0; 
	}
}

49 
	$Çno¦“p
(è{  0; 
	}
}

50 
	$±h»ad_cÚd_brßdÿ¡
(è{  0; 
	}
}

51 
	$±h»ad_cÚd_de¡roy
(è{  0; 
	}
}

52 
	$±h»ad_cÚd_š™
(è{  0; 
	}
}

53 
	$±h»ad_cÚd_sigÇl
(è{  0; 
	}
}

54 
	$±h»ad_cÚd_timedwa™
(è{  0; 
	}
}

55 
	$±h»ad_cÚd_wa™
(è{  0; 
	}
}

56 
	$±h»ad_g‘¥ecific
(è{  0; 
	}
}

57 
	$±h»ad_key_ü—‹
(è{  0; 
	}
}

58 
	$±h»ad_mu‹x_de¡roy
(è{  0; 
	}
}

59 
	$±h»ad_mu‹x_š™
(è{  0; 
	}
}

60 
	$±h»ad_mu‹x_lock
(è{  0; 
	}
}

61 
	$±h»ad_mu‹x_Œylock
(è{  0; 
	}
}

62 
	$±h»ad_mu‹x_uÆock
(è{  0; 
	}
}

63 
	$±h»ad_£t¥ecific
(è{  0; 
	}
}

64 
	$±h»ad_sigmask
(è{  0; 
	}
}

65 
	$sched_y›ld
(è{  0; 
	}
}

	@platform/primitives/sim/runtime_syscalls.c

19 
	~<as£¹.h
>

20 
	~<”ºo.h
>

21 
	~<m®loc.h
>

22 
	~<¡ršg.h
>

23 
	~<sys/mmª.h
>

24 
	~<uni¡d.h
>

28 cÚ¡ 
size_t
 
	gkPageSize
 = 4096;

30 *
	$mm­
(*
addr
, 
size_t
 
Ëngth
, 
´Ù
, 
æags
, 
fd
,

31 
off_t
 
off£t
) {

32 ià(
addr
 || 
´Ù
 !ğ(
PROT_READ
 | 
PROT_WRITE
) ||

33 
æags
 !ğ(
MAP_ANON
 | 
MAP_PRIVATE
è|| 
fd
 !ğ-1 || 
off£t
 != 0) {

34 
”ºo
 = 
ENOSYS
;

35  
MAP_FAILED
;

37 *
±r
 = 
	`mem®ign
(
kPageSize
, 
Ëngth
);

38 
	`mem£t
(
±r
, 0, 
Ëngth
);

39  
±r
;

40 
	}
}

42 
	$munm­
(*
addr
, 
size_t
 
Ëngth
) {

43 
	`ä“
(
addr
);

45 
	}
}

48 
	$syscÚf
(
Çme
) {

49 
Çme
) {

50 
_SC_PAGESIZE
:

51  
kPageSize
;

53 
”ºo
 = 
ENOSYS
;

56 
	}
}

	@platform/primitives/sim/shared_sim.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_SIM_SHARED_SIM_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_SIM_SHARED_SIM_H_


	)

22 
	~<c¡ddef
>

23 
	~<c¡dšt
>

24 
	~<ty³_Œa™s
>

26 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

27 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g´im™ives
 {

34 
Prim™iveStus
 
asylo_’şave_š™
();

37 
Prim™iveStus
 
asylo_’şave_fši
();

41 
cÚ¡ex´
 
ušt64_t
 
sim_ŒampŞše_add»ss
 = 0x7e0000000000;

44 
cÚ¡ex´
 
ušt64_t
 
	gkT¿mpŞšeMagicNumb”
 = 0x53696d54724d6167;

45 
cÚ¡ex´
 
ušt64_t
 
	gkT¿mpŞšeV”siÚ
 = 0;

56 
	sSimT¿mpŞše
 {

57 
ušt64_t
 
	gmagic_numb”
;

58 
ušt64_t
 
	gv”siÚ
;

59 
Prim™iveStus
 (*
asylo_ex™_ÿÎ
)(
ušt64_t
 
	guÁru¡ed_£ËùÜ
, *
	g·¿ms
);

60 *(*
	gasylo_loÿl_®loc_hªdËr
)(
size_t
 
	gsize
);

61 (*
	gasylo_loÿl_ä“_hªdËr
)(*
	g±r
);

66 
šlše
 
SimT¿mpŞše
 *
G‘SimT¿mpŞše
() {

67  
	g»š‹½»t_ÿ¡
<
	gSimT¿mpŞše
 *>(
	gsim_ŒampŞše_add»ss
);

	@platform/primitives/sim/trusted_runtime.cc

19 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

21 
	~<c¡dlib
>

23 "C" 
	$’şave_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

27 
»t
;

28 
asm
 volatile(

34 : "÷"(
»t
)

35 : "g"(
fd
), "g"(
buf
), "g"(
couÁ
)

38  
»t
;

39 
	}
}

	@platform/primitives/sim/trusted_runtime.cc

19 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

21 
	~<c¡dlib
>

23 "C" 
	$’şave_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

27 
»t
;

28 
asm
 volatile(

34 : "÷"(
»t
)

35 : "g"(
fd
), "g"(
buf
), "g"(
couÁ
)

38  
»t
;

39 
	}
}

	@platform/primitives/sim/trusted_sim.cc

19 
	~<uni¡d.h
>

20 
	~<c¡dio
>

21 
	~<c¡ršg
>

23 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

24 
	~"asylo/¶©fÜm/´im™ives/sim/sh¬ed_sim.h
"

25 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

26 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_ruÁime_h–³r.h
"

28 
	~"asylo/ut/¡©us_maüos.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g´im™ives
 {

33 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
size_t
 
	gkSimuÏtÜH—pSize
 = 128 * 1024 * 1024;

45 
ušt8_t
 
	gh—p
[
kSimuÏtÜH—pSize
] 
__©Œibu‹__
((
®igÃd
(8)));

49 
ušt8_t
 *
	gbrk
 = 
h—p
;

50 } 
	gsimuÏtÜ
;

56 
Prim™iveStus
 
Fš®izeEnşave
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

57 ià(!
	g·¿ms
->
em±y
()) {

58  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
Prim™iveStus
 
	g¡©us
 = 
asylo_’şave_fši
();

62 
mem£t
(&
simuÏtÜ
, 0, (simulator));

63  
	g¡©us
;

67 
Regi¡”IÁ”ÇlHªdËrs
() {

69 
EÁryHªdËr
 
	ghªdËr
{
	gFš®izeEnşave
};

70 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
kS–eùÜAsyloFši
, 
hªdËr
)

71 .
ok
()) {

72 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

75 ià(!
asylo_’şave_š™
().
ok
()) {

76 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
(

82 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
(cÚ¡ *
mes§ge
) {

83 
M¬kEnşaveAbÜ‹d
();

86 
	gTru¡edPrim™ives
::
DebugPuts
(cÚ¡ *
mes§ge
) {

87 
åuts
(
mes§ge
, 
¡d”r
);

90 
Prim™iveStus
 
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

91 
ušt64_t
 
Œu¡ed_£ËùÜ
, cÚ¡ 
EÁryHªdËr
 &
hªdËr
) {

92  
	gasylo
::
´im™ives
::
Regi¡”EÁryHªdËr
(
Œu¡ed_£ËùÜ
, 
hªdËr
);

95 "C" *
’şave_sbrk
(
šŒ_t
 
šüem’t
) {

96 ià(
simuÏtÜ
.
brk
 + 
šüem’t
 > simuÏtÜ.
h—p
 + 
kSimuÏtÜH—pSize
) {

97  
»š‹½»t_ÿ¡
<*>(
INT64_C
(-1));

99 *
»suÉ
 = 
simuÏtÜ
.
brk
;

100 
simuÏtÜ
.
brk
 +ğ
šüem’t
;

101  
»suÉ
;

104 "C" 
Prim™iveStus
 
asylo_’şave_ÿÎ
(
ušt64_t
 
£ËùÜ
,

105 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

106 ià(
G‘SimT¿mpŞše
()->
magic_numb”
 !ğ
kT¿mpŞšeMagicNumb”
 ||

107 
G‘SimT¿mpŞše
()->
v”siÚ
 !ğ
kT¿mpŞšeV”siÚ
) {

108 
Tru¡edPrim™ives
::
Be¡EffÜtAbÜt
(

110  
Prim™iveStus
::
OkStus
();

112  
InvokeEÁryHªdËr
(
£ËùÜ
, 
·¿ms
);

115 
boŞ
 
Tru¡edPrim™ives
::
IsTru¡edEx‹Á
(cÚ¡ *
addr
, 
size_t
 
size
) {

116 autØ
begš
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
simuÏtÜ
);

117 cÚ¡ 
ušt8_t
 *
’d
 = 
begš
 + (
simuÏtÜ
);

118  
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
addr
è>ğ
begš
 &&

119 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
addr
è+ 
size
 < 
’d
;

122 *
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(
size_t
 
size
) {

123  
G‘SimT¿mpŞše
()->
asylo_loÿl_®loc_hªdËr
(
size
);

126 
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
(*
±r
) {

127 
G‘SimT¿mpŞše
()->
asylo_loÿl_ä“_hªdËr
(
±r
);

130 
Prim™iveStus
 
Tru¡edPrim™ives
::
UÁru¡edC®l
(

131 
ušt64_t
 
uÁru¡ed_£ËùÜ
,

132 
P¬am‘”Sck
<
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
,

133 
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
> *
·¿ms
) {

134  
G‘SimT¿mpŞše
()->
asylo_ex™_ÿÎ
(
uÁru¡ed_£ËùÜ
, 
·¿ms
);

	@platform/primitives/sim/trusted_sim.cc

19 
	~<uni¡d.h
>

20 
	~<c¡dio
>

21 
	~<c¡ršg
>

23 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

24 
	~"asylo/¶©fÜm/´im™ives/sim/sh¬ed_sim.h
"

25 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

26 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_ruÁime_h–³r.h
"

28 
	~"asylo/ut/¡©us_maüos.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g´im™ives
 {

33 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
size_t
 
	gkSimuÏtÜH—pSize
 = 128 * 1024 * 1024;

45 
ušt8_t
 
	gh—p
[
kSimuÏtÜH—pSize
] 
__©Œibu‹__
((
®igÃd
(8)));

49 
ušt8_t
 *
	gbrk
 = 
h—p
;

50 } 
	gsimuÏtÜ
;

56 
Prim™iveStus
 
Fš®izeEnşave
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

57 ià(!
	g·¿ms
->
em±y
()) {

58  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61 
Prim™iveStus
 
	g¡©us
 = 
asylo_’şave_fši
();

62 
mem£t
(&
simuÏtÜ
, 0, (simulator));

63  
	g¡©us
;

67 
Regi¡”IÁ”ÇlHªdËrs
() {

69 
EÁryHªdËr
 
	ghªdËr
{
	gFš®izeEnşave
};

70 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
kS–eùÜAsyloFši
, 
hªdËr
)

71 .
ok
()) {

72 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

75 ià(!
asylo_’şave_š™
().
ok
()) {

76 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
(

82 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
(cÚ¡ *
mes§ge
) {

83 
M¬kEnşaveAbÜ‹d
();

86 
	gTru¡edPrim™ives
::
DebugPuts
(cÚ¡ *
mes§ge
) {

87 
åuts
(
mes§ge
, 
¡d”r
);

90 
Prim™iveStus
 
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

91 
ušt64_t
 
Œu¡ed_£ËùÜ
, cÚ¡ 
EÁryHªdËr
 &
hªdËr
) {

92  
	gasylo
::
´im™ives
::
Regi¡”EÁryHªdËr
(
Œu¡ed_£ËùÜ
, 
hªdËr
);

95 "C" *
’şave_sbrk
(
šŒ_t
 
šüem’t
) {

96 ià(
simuÏtÜ
.
brk
 + 
šüem’t
 > simuÏtÜ.
h—p
 + 
kSimuÏtÜH—pSize
) {

97  
»š‹½»t_ÿ¡
<*>(
INT64_C
(-1));

99 *
»suÉ
 = 
simuÏtÜ
.
brk
;

100 
simuÏtÜ
.
brk
 +ğ
šüem’t
;

101  
»suÉ
;

104 "C" 
Prim™iveStus
 
asylo_’şave_ÿÎ
(
ušt64_t
 
£ËùÜ
,

105 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

106 ià(
G‘SimT¿mpŞše
()->
magic_numb”
 !ğ
kT¿mpŞšeMagicNumb”
 ||

107 
G‘SimT¿mpŞše
()->
v”siÚ
 !ğ
kT¿mpŞšeV”siÚ
) {

108 
Tru¡edPrim™ives
::
Be¡EffÜtAbÜt
(

110  
Prim™iveStus
::
OkStus
();

112  
InvokeEÁryHªdËr
(
£ËùÜ
, 
·¿ms
);

115 
boŞ
 
Tru¡edPrim™ives
::
IsTru¡edEx‹Á
(cÚ¡ *
addr
, 
size_t
 
size
) {

116 autØ
begš
 = 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(&
simuÏtÜ
);

117 cÚ¡ 
ušt8_t
 *
’d
 = 
begš
 + (
simuÏtÜ
);

118  
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
addr
è>ğ
begš
 &&

119 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
addr
è+ 
size
 < 
’d
;

122 *
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(
size_t
 
size
) {

123  
G‘SimT¿mpŞše
()->
asylo_loÿl_®loc_hªdËr
(
size
);

126 
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
(*
±r
) {

127 
G‘SimT¿mpŞše
()->
asylo_loÿl_ä“_hªdËr
(
±r
);

130 
Prim™iveStus
 
Tru¡edPrim™ives
::
UÁru¡edC®l
(

131 
ušt64_t
 
uÁru¡ed_£ËùÜ
,

132 
P¬am‘”Sck
<
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
,

133 
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
> *
·¿ms
) {

134  
G‘SimT¿mpŞše
()->
asylo_ex™_ÿÎ
(
uÁru¡ed_£ËùÜ
, 
·¿ms
);

	@platform/primitives/sim/untrusted_sim.cc

19 
	~"asylo/¶©fÜm/´im™ives/sim/uÁru¡ed_sim.h
"

21 
	~<dlfú.h
>

22 
	~<sys/mmª.h
>

23 
	~<uni¡d.h
>

24 
	~<c¡ddef
>

25 
	~<c¡dlib
>

26 
	~<memÜy
>

27 
	~<ut™y
>

29 
	~"ab¦/ba£/ÿÎ_Úû.h
"

30 
	~"ab¦/debuggšg/Ëak_check.h
"

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

33 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

34 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

35 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

36 
	~"asylo/¶©fÜm/´im™ives/sim/sh¬ed_sim.h
"

37 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

38 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©usÜ.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
Çme¥aû
 
	g´im™ives
 {

45 
	gÇme¥aû
 {

47 
Prim™iveStus
 
sim_asylo_ex™_ÿÎ
(
ušt64_t
 
uÁru¡ed_£ËùÜ
, *
·¿ms
) {

48  
	gCl›Á
::
Ex™C®lback
(
uÁru¡ed_£ËùÜ
,

49 
»š‹½»t_ÿ¡
<
N©iveP¬am‘”Sck
 *>(
·¿ms
));

52 *
sim_asylo_loÿl_®loc_hªdËr
(
size_t
 
size
è{  
m®loc
(size); }

54 
sim_asylo_loÿl_ä“_hªdËr
(*
±r
è{  
ä“
(ptr); }

56 
šlše
 
size_t
 
RoundUpToPageBound¬y
(size_ˆ
size
) {

57 cÚ¡ 
size_t
 
	gkPageSize
 = 
g‘·gesize
();

58  ((
	gsize
 + 
	gkPageSize
 - 1) / kPageSize) * kPageSize;

61 
	gab¦
::
Úû_æag
 
š™_ŒampŞše_Úû
;

63 
In™T¿mpŞšeOnû
() {

64 
SimT¿mpŞše
 *
	gsim_ŒampŞše
 = 
nuÎ±r
;

65 ià(
	gsim_ŒampŞše
 !ğ
nuÎ±r
) {

68 
	gsim_ŒampŞše
 = 
¡©ic_ÿ¡
<
SimT¿mpŞše
 *>(
mm­
(

69  
»š‹½»t_ÿ¡
<*>(
sim_ŒampŞše_add»ss
),

70  
RoundUpToPageBound¬y
((
SimT¿mpŞše
)),

71  
PROT_EXEC
 | 
PROT_READ
 | 
PROT_WRITE
,

72  
MAP_ANONYMOUS
 | 
MAP_PRIVATE
,

75 
CHECK_EQ
(
sim_ŒampŞše
, 
G‘SimT¿mpŞše
())

76 << "FaedØm­ sim_ŒampŞše,ƒ¼no=" << 
¡»¼Ü
(
”ºo
);

77 
G‘SimT¿mpŞše
()->
	gmagic_numb”
 = 
kT¿mpŞšeMagicNumb”
;

78 
G‘SimT¿mpŞše
()->
	gv”siÚ
 = 
kT¿mpŞšeV”siÚ
;

79 
G‘SimT¿mpŞše
()->
	gasylo_ex™_ÿÎ
 = &
sim_asylo_ex™_ÿÎ
;

80 
G‘SimT¿mpŞše
()->
	gasylo_loÿl_®loc_hªdËr
 =

81 &
sim_asylo_loÿl_®loc_hªdËr
;

82 
G‘SimT¿mpŞše
()->
	gasylo_loÿl_ä“_hªdËr
 = &
sim_asylo_loÿl_ä“_hªdËr
;

87 
	gSimEnşaveCl›Á
::~
SimEnşaveCl›Á
() {

88 ià(
dl_hªdË_
) {

89 ià(
’şave_ÿÎ_
) {

90 
N©iveP¬am‘”Sck
 
fši_·¿ms
;

91 
’şave_ÿÎ_
(
kS–eùÜAsyloFši
, &
fši_·¿ms
);

93 
dlşo£
(
dl_hªdË_
);

97 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SimBack’d
::
Lßd
(

98 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

99 cÚ¡ 
¡d
::
¡ršg
 &
·th
,

100 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

104 
ab¦
::
ÿÎ_Úû
(
š™_ŒampŞše_Úû
, &
In™T¿mpŞšeOnû
);

106 
	g¡d
::
sh¬ed_±r
<
SimEnşaveCl›Á
> 
ş›Á
(

107 
Ãw
 
SimEnşaveCl›Á
(
’şave_Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)));

114 
	gCl›Á
::
ScİedCu¼’tCl›Á
 
scİed_ş›Á
(
ş›Á
.
g‘
());

117 
	gab¦
::
L—kCheckDi§bËr
 
di§bËr
;

118 
	gş›Á
->
	gdl_hªdË_
 = 
dlİ’
(
·th
.
c_¡r
(), 
RTLD_LAZY
 | 
RTLD_LOCAL
);

120 ià(!
	gş›Á
->
	gdl_hªdË_
) {

121  
	gStus
{

122 
	g”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
,

123 
	gab¦
::
SŒC©
("dlİ’ oà", 
·th
, " faed w™h: ", 
dË¼Ü
())};

127 *
	gasylo_’şave_ÿÎ
 = 
dlsym
(
ş›Á
->
dl_hªdË_
, "asylo_enclave_call");

128 ià(!
	gasylo_’şave_ÿÎ
) {

129  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
,

133 
	gş›Á
->
	g’şave_ÿÎ_
 = 
»š‹½»t_ÿ¡
<
EnşaveC®lPŒ
>(
asylo_’şave_ÿÎ
);

135  
	gş›Á
;

138 
Stus
 
	gSimEnşaveCl›Á
::
De¡roy
() {

139 ià(
dl_hªdË_
) {

140 
dlşo£
(
dl_hªdË_
);

141 
	gdl_hªdË_
 = 
nuÎ±r
;

143  
	gStus
::
OkStus
();

146 
Stus
 
	gSimEnşaveCl›Á
::
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

147 
N©iveP¬am‘”Sck
 *
·¿ms
) {

148 
Prim™iveStus
 
	g´im™ive_¡©us
;

151 ià(!
	gdl_hªdË_
 || !
	g’şave_ÿÎ_
) {

152  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

156 cÚ¡‡utØ
	g¡©us
 = 
’şave_ÿÎ_
(
£ËùÜ
, 
·¿ms
);

157  
MakeStus
(
¡©us
);

160 
boŞ
 
	gSimEnşaveCl›Á
::
IsClo£d
(ècÚ¡ {  
dl_hªdË_
 =ğ
nuÎ±r
; }

	@platform/primitives/sim/untrusted_sim.cc

19 
	~"asylo/¶©fÜm/´im™ives/sim/uÁru¡ed_sim.h
"

21 
	~<dlfú.h
>

22 
	~<sys/mmª.h
>

23 
	~<uni¡d.h
>

24 
	~<c¡ddef
>

25 
	~<c¡dlib
>

26 
	~<memÜy
>

27 
	~<ut™y
>

29 
	~"ab¦/ba£/ÿÎ_Úû.h
"

30 
	~"ab¦/debuggšg/Ëak_check.h
"

31 
	~"ab¦/memÜy/memÜy.h
"

32 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

33 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

34 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

35 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

36 
	~"asylo/¶©fÜm/´im™ives/sim/sh¬ed_sim.h
"

37 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

38 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/¡©usÜ.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
Çme¥aû
 
	g´im™ives
 {

45 
	gÇme¥aû
 {

47 
Prim™iveStus
 
sim_asylo_ex™_ÿÎ
(
ušt64_t
 
uÁru¡ed_£ËùÜ
, *
·¿ms
) {

48  
	gCl›Á
::
Ex™C®lback
(
uÁru¡ed_£ËùÜ
,

49 
»š‹½»t_ÿ¡
<
N©iveP¬am‘”Sck
 *>(
·¿ms
));

52 *
sim_asylo_loÿl_®loc_hªdËr
(
size_t
 
size
è{  
m®loc
(size); }

54 
sim_asylo_loÿl_ä“_hªdËr
(*
±r
è{  
ä“
(ptr); }

56 
šlše
 
size_t
 
RoundUpToPageBound¬y
(size_ˆ
size
) {

57 cÚ¡ 
size_t
 
	gkPageSize
 = 
g‘·gesize
();

58  ((
	gsize
 + 
	gkPageSize
 - 1) / kPageSize) * kPageSize;

61 
	gab¦
::
Úû_æag
 
š™_ŒampŞše_Úû
;

63 
In™T¿mpŞšeOnû
() {

64 
SimT¿mpŞše
 *
	gsim_ŒampŞše
 = 
nuÎ±r
;

65 ià(
	gsim_ŒampŞše
 !ğ
nuÎ±r
) {

68 
	gsim_ŒampŞše
 = 
¡©ic_ÿ¡
<
SimT¿mpŞše
 *>(
mm­
(

69  
»š‹½»t_ÿ¡
<*>(
sim_ŒampŞše_add»ss
),

70  
RoundUpToPageBound¬y
((
SimT¿mpŞše
)),

71  
PROT_EXEC
 | 
PROT_READ
 | 
PROT_WRITE
,

72  
MAP_ANONYMOUS
 | 
MAP_PRIVATE
,

75 
CHECK_EQ
(
sim_ŒampŞše
, 
G‘SimT¿mpŞše
())

76 << "FaedØm­ sim_ŒampŞše,ƒ¼no=" << 
¡»¼Ü
(
”ºo
);

77 
G‘SimT¿mpŞše
()->
	gmagic_numb”
 = 
kT¿mpŞšeMagicNumb”
;

78 
G‘SimT¿mpŞše
()->
	gv”siÚ
 = 
kT¿mpŞšeV”siÚ
;

79 
G‘SimT¿mpŞše
()->
	gasylo_ex™_ÿÎ
 = &
sim_asylo_ex™_ÿÎ
;

80 
G‘SimT¿mpŞše
()->
	gasylo_loÿl_®loc_hªdËr
 =

81 &
sim_asylo_loÿl_®loc_hªdËr
;

82 
G‘SimT¿mpŞše
()->
	gasylo_loÿl_ä“_hªdËr
 = &
sim_asylo_loÿl_ä“_hªdËr
;

87 
	gSimEnşaveCl›Á
::~
SimEnşaveCl›Á
() {

88 ià(
dl_hªdË_
) {

89 ià(
’şave_ÿÎ_
) {

90 
N©iveP¬am‘”Sck
 
fši_·¿ms
;

91 
’şave_ÿÎ_
(
kS–eùÜAsyloFši
, &
fši_·¿ms
);

93 
dlşo£
(
dl_hªdË_
);

97 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SimBack’d
::
Lßd
(

98 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

99 cÚ¡ 
¡d
::
¡ršg
 &
·th
,

100 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

104 
ab¦
::
ÿÎ_Úû
(
š™_ŒampŞše_Úû
, &
In™T¿mpŞšeOnû
);

106 
	g¡d
::
sh¬ed_±r
<
SimEnşaveCl›Á
> 
ş›Á
(

107 
Ãw
 
SimEnşaveCl›Á
(
’şave_Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)));

114 
	gCl›Á
::
ScİedCu¼’tCl›Á
 
scİed_ş›Á
(
ş›Á
.
g‘
());

117 
	gab¦
::
L—kCheckDi§bËr
 
di§bËr
;

118 
	gş›Á
->
	gdl_hªdË_
 = 
dlİ’
(
·th
.
c_¡r
(), 
RTLD_LAZY
 | 
RTLD_LOCAL
);

120 ià(!
	gş›Á
->
	gdl_hªdË_
) {

121  
	gStus
{

122 
	g”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
,

123 
	gab¦
::
SŒC©
("dlİ’ oà", 
·th
, " faed w™h: ", 
dË¼Ü
())};

127 *
	gasylo_’şave_ÿÎ
 = 
dlsym
(
ş›Á
->
dl_hªdË_
, "asylo_enclave_call");

128 ià(!
	gasylo_’şave_ÿÎ
) {

129  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
,

133 
	gş›Á
->
	g’şave_ÿÎ_
 = 
»š‹½»t_ÿ¡
<
EnşaveC®lPŒ
>(
asylo_’şave_ÿÎ
);

135  
	gş›Á
;

138 
Stus
 
	gSimEnşaveCl›Á
::
De¡roy
() {

139 ià(
dl_hªdË_
) {

140 
dlşo£
(
dl_hªdË_
);

141 
	gdl_hªdË_
 = 
nuÎ±r
;

143  
	gStus
::
OkStus
();

146 
Stus
 
	gSimEnşaveCl›Á
::
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

147 
N©iveP¬am‘”Sck
 *
·¿ms
) {

148 
Prim™iveStus
 
	g´im™ive_¡©us
;

151 ià(!
	gdl_hªdË_
 || !
	g’şave_ÿÎ_
) {

152  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

156 cÚ¡‡utØ
	g¡©us
 = 
’şave_ÿÎ_
(
£ËùÜ
, 
·¿ms
);

157  
MakeStus
(
¡©us
);

160 
boŞ
 
	gSimEnşaveCl›Á
::
IsClo£d
(ècÚ¡ {  
dl_hªdË_
 =ğ
nuÎ±r
; }

	@platform/primitives/sim/untrusted_sim.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_SIM_UNTRUSTED_SIM_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_SIM_UNTRUSTED_SIM_H_


	)

22 
	~<c¡dšt
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

26 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

27 
	~"asylo/¶©fÜm/´im™ives/sim/sh¬ed_sim.h
"

28 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

42 
Çme¥aû
 
	gasylo
 {

43 
Çme¥aû
 
	g´im™ives
 {

46 
	sSimBack’d
 {

50 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
Lßd
(

51 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

52 cÚ¡ 
¡d
::
¡ršg
 &
·th
,

53 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
);

57 şas 
	cSimEnşaveCl›Á
 : 
public
 
Cl›Á
 {

58 
public
:

59 ~
SimEnşaveCl›Á
(è
ov”ride
;

60 
Stus
 
De¡roy
(è
	gov”ride
;

61 
Stus
 
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

62 
N©iveP¬am‘”Sck
 *
·¿ms
è
	gov”ride
;

63 
boŞ
 
IsClo£d
(ècÚ¡ 
	gov”ride
;

65 
	g´iv©e
:

67 
ä›nd
 
SimBack’d
;

70 
SimEnşaveCl›Á
(

71 cÚ¡ 
ab¦
::
¡ršg_v›w
 
Çme
,

72 
¡d
::
unique_±r
<
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
)

73 : 
Cl›Á
(
Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
)) {}

76 *
dl_hªdË_
 = 
nuÎ±r
;

81 
EnşaveC®lPŒ
 
	g’şave_ÿÎ_
 = 
nuÎ±r
;

	@platform/primitives/test/primitives_test.cc

19 
	~<¬¿y
>

20 
	~<c¡dšt
>

21 
	~<memÜy
>

22 
	~<th»ad
>

23 
	~<ut™y
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/debuggšg/Ëak_check.h
"

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"gæags/gæags.h
"

30 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

31 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

32 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

33 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

34 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_£ËùÜs.h
"

35 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

36 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

37 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/th»ad.h
"

42 
	gusšg
 ::
‹¡šg
::
_
;

43 
	gusšg
 ::
‹¡šg
::
Eq
;

44 
	gusšg
 ::
‹¡šg
::
MockFunùiÚ
;

45 
	gusšg
 ::
‹¡šg
::
NÙ
;

46 
	gusšg
 ::
‹¡šg
::
NÙNuÎ
;

47 
	gusšg
 ::
‹¡šg
::
R‘uº
;

48 
	gusšg
 ::
‹¡šg
::
SŒEq
;

50 
Çme¥aû
 
	gasylo
 {

51 
Çme¥aû
 
	g´im™ives
 {

52 
	gÇme¥aû
 {

54 şas 
	cPrim™ivesTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

55 
´Ùeùed
:

58 
¡d
::
sh¬ed_±r
<
Cl›Á
> 
LßdTe¡EnşaveOrD›
(
boŞ
 
»lßd
) {

59 autØ
ex™_ÿÎ_´ovid”
 = 
ab¦
::
make_unique
<
Di¥©chTabË
>();

61 
	gMockFunùiÚ
<
Stus
(
¡d
::
sh¬ed_±r
<
şass
 
Cl›Á
> 
’şave
, *,

62 
N©iveP¬am‘”Sck
 *
·¿ms
)>

63 
	gmock_š™_hªdËr
;

64 ià(
	g»lßd
) {

65 
EXPECT_CALL
(
mock_š™_hªdËr
, 
C®l
(
NÙNuÎ
(), 
_
, _))

66 .
WlR•—‹dly
(
R‘uº
(
Stus
::
OkStus
()));

68 
EXPECT_CALL
(
mock_š™_hªdËr
, 
C®l
(
NÙNuÎ
(), 
_
, _))

69 .
WlOnû
(
R‘uº
(
Stus
::
OkStus
()));

71 
ASYLO_EXPECT_OK
(
ex™_ÿÎ_´ovid”
->
Regi¡”Ex™HªdËr
(

72 
kUÁru¡edIn™
, 
Ex™HªdËr
{
mock_š™_hªdËr
.
AsStdFunùiÚ
()}));

73  
	g‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

74  "´im™ives_‹¡", 
¡d
::
move
(
ex™_ÿÎ_´ovid”
));

77 
T—rDownTe¡Su™e
() {

79 
d–‘e
 
	g‹¡
::
Te¡Back’d
::
G‘
();

85 
št32_t
 
MuÉlyByTwoOrD›
(cÚ¡ 
¡d
::
sh¬ed_±r
<
Cl›Á
> &
ş›Á
,

86 
št32_t
 
v®ue
) {

87 
N©iveP¬am‘”Sck
 
	g·¿ms
;

88 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gv®ue
);

89 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
));

90 
EXPECT_FALSE
(
·¿ms
.
em±y
());

91 cÚ¡ 
št32_t
 
	g»s
 = 
·¿ms
.
Pİ
<int32_t>();

92 
EXPECT_TRUE
(
·¿ms
.
em±y
());

93  
	g»s
;

98 
št64_t
 
Av”ageP”Th»adOrD›
(cÚ¡ 
¡d
::
sh¬ed_±r
<
Cl›Á
> &
ş›Á
,

99 
št64_t
 
v®ue
) {

100 
N©iveP¬am‘”Sck
 
	g·¿ms
;

101 
	g·¿ms
.
	gPushByCİy
<
	gšt64_t
>(
	gv®ue
);

102 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kAv”ageP”Th»adS–eùÜ
, &
·¿ms
));

103 
EXPECT_FALSE
(
·¿ms
.
em±y
());

104 cÚ¡ 
št64_t
 
	g»s
 = 
·¿ms
.
Pİ
<int64_t>();

105 
EXPECT_TRUE
(
·¿ms
.
em±y
());

106  
	g»s
;

109 
ušt64_t
 
SŒessM®locsOrD›
(cÚ¡ 
¡d
::
sh¬ed_±r
<
Cl›Á
> &
ş›Á
,

110 
ušt64_t
 
m®loc_couÁ
, ušt64_ˆ
m®loc_size
) {

111 
N©iveP¬am‘”Sck
 
	g·¿ms
;

112 
	g·¿ms
.
	gPushByCİy
<
	gušt64_t
>(
	gm®loc_size
);

113 
	g·¿ms
.
	gPushByCİy
<
	gušt64_t
>(
	gm®loc_couÁ
);

114 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kSŒessM®locs
, &
·¿ms
));

115 
EXPECT_FALSE
(
·¿ms
.
em±y
());

116 cÚ¡ 
ušt64_t
 
	g»s
 = 
·¿ms
.
Pİ
<uint64_t>();

117 
EXPECT_TRUE
(
·¿ms
.
em±y
());

118  
	g»s
;

123 
TEST_F
(
Prim™ivesTe¡
, 
BadC®l
) {

124 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

127 
N©iveP¬am‘”Sck
 
	g·¿ms
;

128 
	g·¿ms
.
PushAÎoc
(4096);

129 
Stus
 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kNÙRegi¡”edS–eùÜ
, &
·¿ms
);

130 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

133 
N©iveP¬am‘”Sck
 
	g·¿ms_0_¬g
;

134 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms_0_¬g
);

135 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

136 
N©iveP¬am‘”Sck
 
	g·¿ms_2_¬g
;

137 
	g·¿ms_2_¬g
.
PushAÎoc
(4096);

138 
	g·¿ms_2_¬g
.
PushAÎoc
(4096);

139 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms_2_¬g
);

140 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

143 
TEST_F
(
Prim™ivesTe¡
, 
EnşaveLiãtime
) {

145 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

146 autØ
	gfœ¡_cİy
 = 
ş›Á
;

147 autØ
	g£cÚd_cİy
 = 
ş›Á
;

149 
	gfœ¡_cİy
.
»£t
();

150 
EXPECT_FALSE
(
ş›Á
->
IsClo£d
());

151 
	g£cÚd_cİy
.
»£t
();

152 
EXPECT_FALSE
(
ş›Á
->
IsClo£d
());

155 
	gfœ¡_cİy
 = 
ş›Á
;

156 
	g£cÚd_cİy
 = 
ş›Á
;

157 
EXPECT_FALSE
(
fœ¡_cİy
->
IsClo£d
());

158 
EXPECT_FALSE
(
£cÚd_cİy
->
IsClo£d
());

159 
	gş›Á
->
De¡roy
();

160 
EXPECT_TRUE
(
ş›Á
->
IsClo£d
());

161 
EXPECT_TRUE
(
fœ¡_cİy
->
IsClo£d
());

162 
EXPECT_TRUE
(
£cÚd_cİy
->
IsClo£d
());

165 autØ
	gfœ¡_š¡ªû
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

166 autØ
	g£cÚd_š¡ªû
 = 
LßdTe¡EnşaveOrD›
Ğ
Œue
);

168 
EXPECT_FALSE
(
fœ¡_š¡ªû
->
IsClo£d
());

169 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
fœ¡_š¡ªû
, 1), 
Eq
(2));

170 
EXPECT_FALSE
(
£cÚd_š¡ªû
->
IsClo£d
());

171 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
£cÚd_š¡ªû
, 2), 
Eq
(4));

173 
	gfœ¡_š¡ªû
->
De¡roy
();

174 
EXPECT_TRUE
(
fœ¡_š¡ªû
->
IsClo£d
());

175 
EXPECT_FALSE
(
£cÚd_š¡ªû
->
IsClo£d
());

176 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
£cÚd_š¡ªû
, 3), 
Eq
(6));

178 
	g£cÚd_š¡ªû
->
De¡roy
();

179 
EXPECT_TRUE
(
fœ¡_š¡ªû
->
IsClo£d
());

180 
EXPECT_TRUE
(
£cÚd_š¡ªû
->
IsClo£d
());

184 
TEST_F
(
Prim™ivesTe¡
, 
LßdEnşave
) {

185 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

186 
EXPECT_FALSE
(
ş›Á
->
IsClo£d
());

189 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
ş›Á
, 1), 
Eq
(2));

192 
	gş›Á
->
De¡roy
();

193 
EXPECT_TRUE
(
ş›Á
->
IsClo£d
());

196 
N©iveP¬am‘”Sck
 
	g·¿ms
;

197 
št32_t
 
	gšput
 = 1;

198 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gšput
);

199 
Stus
 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
);

200 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

204 
TEST_F
(
Prim™ivesTe¡
, 
AbÜtEnşave
) {

207 cÚ¡ 
	g¡d
::
unique_±r
<
ab¦
::
L—kCheckDi§bËr
> 
ignÜe_Ëak_check
(

208 
‹¡
::
Te¡Back’d
::
G‘
()->
L—ksMemÜyOnAbÜt
()

209 ? 
Ãw
 
ab¦
::
L—kCheckDi§bËr
()

210 : 
nuÎ±r
);

212 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

213 
	g¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á_cİy
 = 
ş›Á
;

216 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
ş›Á
, 1), 
Eq
(2));

219 
N©iveP¬am‘”Sck
 
	gabÜt_·¿ms
;

220 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kAbÜtEnşaveS–eùÜ
, &
abÜt_·¿ms
));

223 
št32_t
 
	gv®ue
 = 10;

224 
N©iveP¬am‘”Sck
 
	g·¿ms
;

225 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gv®ue
);

226 
Stus
 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
);

227 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

230 
	g¡©us
 = 
ş›Á_cİy
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
);

231 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

235 
TEST_F
(
Prim™ivesTe¡
, 
C®lChaš
) {

236 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

238 autØ
	gŒu¡ed_fibÚacci
 = [&
ş›Á
](
št32_t
 
n
) -> int32_t {

239 
N©iveP¬am‘”Sck
 
·¿ms
;

240 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gn
);

241 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kTru¡edFibÚacci
, &
·¿ms
));

242 
EXPECT_FALSE
(
·¿ms
.
em±y
());

243 cÚ¡ 
št32_t
 
	g»s
 = 
·¿ms
.
Pİ
<int32_t>();

244 
EXPECT_TRUE
(
·¿ms
.
em±y
());

245  
	g»s
;

250 
	gEx™HªdËr
::
C®lback
 
fibÚacci_hªdËr
 =

251 [&](
¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
, *
	gcÚ‹xt
,

252 
N©iveP¬am‘”Sck
 *
	g·¿ms
è-> 
	gStus
 {

253 ià(
	g·¿ms
->
em±y
()) {

254  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

257 cÚ¡ 
št32_t
 
	gn
 = 
·¿ms
->
Pİ
<int32_t>();

258 ià(!
	g·¿ms
->
em±y
()) {

259  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

262 ià(
	gn
 >= 50) {

263  
Stus
{
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

266 
	g·¿ms
->
	gPushByCİy
<
	gšt32_t
>(

267 
	gn
 < 2 ?‚ : 
Œu¡ed_fibÚacci
(
n
 - 1) +rusted_fibonacci(n - 2));

268  
	gStus
::
OkStus
();

272 
ASYLO_EXPECT_OK
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

273 
kUÁru¡edFibÚacci
, 
Ex™HªdËr
{
fibÚacci_hªdËr
}));

274 
EXPECT_THAT
(
Œu¡ed_fibÚacci
(20), 
Eq
(6765));

278 
TEST_F
(
Prim™ivesTe¡
, 
Th»adedTe¡
) {

279 
cÚ¡ex´
 
	gkNumTh»ads
 = 64;

280 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

281 
	gi
 = 0; i < 32; i++) {

282 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

283 
	gj
 = 0; j < 
	gkNumTh»ads
; j++) {

284 
	gth»ads
.
em¶aû_back
([&
ş›Á
, 
j
]() {

285 autØ
»suÉ
 = 
MuÉlyByTwoOrD›
(
ş›Á
, 
j
);

286 
EXPECT_THAT
(
»suÉ
, 
Eq
(2 * 
j
));

289 autØ&
	gth»ad
 : 
th»ads
) {

290 
th»ad
.
Još
();

295 
TEST_F
(
Prim™ivesTe¡
, 
Th»adedSŒessM®locsTe¡
) {

296 
cÚ¡ex´
 
	gkNumTh»ads
 = 64;

297 
cÚ¡ex´
 
ušt64_t
 
	gkM®locCouÁ
 = 64;

298 
cÚ¡ex´
 
ušt64_t
 
	gkM®locSize
 = 16;

299 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

300 
	gi
 = 0; i < 32; i++) {

301 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

302 
	gj
 = 0; j < 
	gkNumTh»ads
; j++) {

303 
	gth»ads
.
em¶aû_back
([&
ş›Á
]() {

304 autØ
»suÉ
 = 
SŒessM®locsOrD›
(
ş›Á
, 
kM®locCouÁ
, 
kM®locSize
);

305 
EXPECT_THAT
(
»suÉ
, 
Eq
(0));

308 autØ&
	gth»ad
 : 
th»ads
) {

309 
th»ad
.
Još
();

315 
TEST_F
(
Prim™ivesTe¡
, 
Th»adLoÿlStÜageTe¡
) {

316 
cÚ¡ex´
 
	gkNumCouÁ
 = 256;

317 
cÚ¡ex´
 
	gkNumTh»ads
 = 64;

318 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

319 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

320 
št64_t
 
	gth»ad_šdex
 = 0;h»ad_šdex < 
	gkNumTh»ads
;hread_index++) {

321 
	gth»ads
.
em¶aû_back
([&
ş›Á
, 
th»ad_šdex
]() {

322 
št64_t
 
sum
 = 0;

323 
št64_t
 
couÁ
 = 0;

324 
št64_t
 
i
 = 0; i < 
kNumCouÁ
; i++) {

325 
num
 = 
th»ad_šdex
 * 
kNumTh»ads
 + 
i
;

326 
sum
 +ğ
num
;

327 ++
couÁ
;

328 autØ
»suÉ
 = 
Av”ageP”Th»adOrD›
(
ş›Á
, 
num
);

329 
EXPECT_THAT
(
»suÉ
, 
Eq
(
sum
 / 
couÁ
)è<< 
th»ad_šdex
 << " " << 
i
;

333 autØ&
	gth»ad
 : 
th»ads
) {

334 
th»ad
.
Još
();

340 
TEST_F
(
Prim™ivesTe¡
, 
Tru¡edM®loc
) {

341 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

342 
N©iveP¬am‘”Sck
 
	g·¿ms
;

343 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kTru¡edM®locTe¡
, &
·¿ms
));

344 
EXPECT_FALSE
(
·¿ms
.
em±y
());

345 
EXPECT_TRUE
(
·¿ms
.
Pİ
<
boŞ
>());

346 
EXPECT_TRUE
(
·¿ms
.
em±y
());

351 
TEST_F
(
Prim™ivesTe¡
, 
UÄu¡edAÎoc
) {

352 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

353 
N©iveP¬am‘”Sck
 
	g·¿ms
;

354 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kUÁru¡edLoÿlAÎocTe¡
, &
·¿ms
));

355 
EXPECT_FALSE
(
·¿ms
.
em±y
());

356 
EXPECT_TRUE
(
·¿ms
.
Pİ
<
boŞ
>());

357 
EXPECT_TRUE
(
·¿ms
.
em±y
());

361 
TEST_F
(
Prim™ivesTe¡
, 
CİyMuÉËP¬ams
) {

362 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

363 cÚ¡ 
	g¡d
::
¡ršg
 
š1
 = "Param1";

364 cÚ¡ 
ušt64_t
 
	gš2
 = 12345;

365 cÚ¡ 
	gš3
[] = "Param3";

366 
N©iveP¬am‘”Sck
 
	g·¿ms
;

367 
	g·¿ms
.
	gPushByCİy
<>(
	gš1
.
d©a
(), in1.
size
());

368 
	g·¿ms
.
	gPushByCİy
<
	gušt64_t
>(
	gš2
);

369 
	g·¿ms
.
	gPushByCİy
<>(
	gš3
, 
¡¾’
(
š3
) + 1);

370 
ASYLO_ASSERT_OK
(
ş›Á
->
EnşaveC®l
(
kCİyMuÉËP¬amsS–eùÜ
, &
·¿ms
));

371 
EXPECT_THAT
(
·¿ms
.
size
(), 
Eq
(4));

373 autØ
	gou4
 = 
·¿ms
.
Pİ
();

374 
	g¡d
::
¡ršg
 
out4
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
ou4
->
d©a
()),

375 
ou4
->
size
());

376 
EXPECT_THAT
(
out4
, 
SŒEq
("Foo"));

379 autØ
	gou3
 = 
·¿ms
.
Pİ
();

380 
	g¡d
::
¡ršg
 
out3
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
ou3
->
d©a
()),

381 
ou3
->
size
());

382 
EXPECT_THAT
(
out3
, 
SŒEq
(
š1
));

384 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ušt64_t
>(), 
Eq
(
š2
));

386 autØ
	gou1
 = 
·¿ms
.
Pİ
();

387 
ASSERT_THAT
(
ou1
->
size
(), 
¡¾’
(
š3
) + 1);

388 cÚ¡ *
	gout1s
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
ou1
->
d©a
());

389 
EXPECT_THAT
(
out1s
, 
SŒEq
(
š3
));

391 
EXPECT_TRUE
(
·¿ms
.
em±y
());

398 
	$maš
(
¬gc
, *
¬gv
[]) {

399 ::
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

400 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

401  
Œue
);

403  
	`RUN_ALL_TESTS
();

404 
	}
}

	@platform/primitives/test/primitives_test.cc

19 
	~<¬¿y
>

20 
	~<c¡dšt
>

21 
	~<memÜy
>

22 
	~<th»ad
>

23 
	~<ut™y
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/debuggšg/Ëak_check.h
"

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"gæags/gæags.h
"

30 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

31 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

32 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

33 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

34 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_£ËùÜs.h
"

35 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

36 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

37 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

38 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

39 
	~"asylo/ut/¡©us.h
"

40 
	~"asylo/ut/th»ad.h
"

42 
	gusšg
 ::
‹¡šg
::
_
;

43 
	gusšg
 ::
‹¡šg
::
Eq
;

44 
	gusšg
 ::
‹¡šg
::
MockFunùiÚ
;

45 
	gusšg
 ::
‹¡šg
::
NÙ
;

46 
	gusšg
 ::
‹¡šg
::
NÙNuÎ
;

47 
	gusšg
 ::
‹¡šg
::
R‘uº
;

48 
	gusšg
 ::
‹¡šg
::
SŒEq
;

50 
Çme¥aû
 
	gasylo
 {

51 
Çme¥aû
 
	g´im™ives
 {

52 
	gÇme¥aû
 {

54 şas 
	cPrim™ivesTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

55 
´Ùeùed
:

58 
¡d
::
sh¬ed_±r
<
Cl›Á
> 
LßdTe¡EnşaveOrD›
(
boŞ
 
»lßd
) {

59 autØ
ex™_ÿÎ_´ovid”
 = 
ab¦
::
make_unique
<
Di¥©chTabË
>();

61 
	gMockFunùiÚ
<
Stus
(
¡d
::
sh¬ed_±r
<
şass
 
Cl›Á
> 
’şave
, *,

62 
N©iveP¬am‘”Sck
 *
·¿ms
)>

63 
	gmock_š™_hªdËr
;

64 ià(
	g»lßd
) {

65 
EXPECT_CALL
(
mock_š™_hªdËr
, 
C®l
(
NÙNuÎ
(), 
_
, _))

66 .
WlR•—‹dly
(
R‘uº
(
Stus
::
OkStus
()));

68 
EXPECT_CALL
(
mock_š™_hªdËr
, 
C®l
(
NÙNuÎ
(), 
_
, _))

69 .
WlOnû
(
R‘uº
(
Stus
::
OkStus
()));

71 
ASYLO_EXPECT_OK
(
ex™_ÿÎ_´ovid”
->
Regi¡”Ex™HªdËr
(

72 
kUÁru¡edIn™
, 
Ex™HªdËr
{
mock_š™_hªdËr
.
AsStdFunùiÚ
()}));

73  
	g‹¡
::
Te¡Back’d
::
G‘
()->
LßdTe¡EnşaveOrD›
(

74  "´im™ives_‹¡", 
¡d
::
move
(
ex™_ÿÎ_´ovid”
));

77 
T—rDownTe¡Su™e
() {

79 
d–‘e
 
	g‹¡
::
Te¡Back’d
::
G‘
();

85 
št32_t
 
MuÉlyByTwoOrD›
(cÚ¡ 
¡d
::
sh¬ed_±r
<
Cl›Á
> &
ş›Á
,

86 
št32_t
 
v®ue
) {

87 
N©iveP¬am‘”Sck
 
	g·¿ms
;

88 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gv®ue
);

89 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
));

90 
EXPECT_FALSE
(
·¿ms
.
em±y
());

91 cÚ¡ 
št32_t
 
	g»s
 = 
·¿ms
.
Pİ
<int32_t>();

92 
EXPECT_TRUE
(
·¿ms
.
em±y
());

93  
	g»s
;

98 
št64_t
 
Av”ageP”Th»adOrD›
(cÚ¡ 
¡d
::
sh¬ed_±r
<
Cl›Á
> &
ş›Á
,

99 
št64_t
 
v®ue
) {

100 
N©iveP¬am‘”Sck
 
	g·¿ms
;

101 
	g·¿ms
.
	gPushByCİy
<
	gšt64_t
>(
	gv®ue
);

102 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kAv”ageP”Th»adS–eùÜ
, &
·¿ms
));

103 
EXPECT_FALSE
(
·¿ms
.
em±y
());

104 cÚ¡ 
št64_t
 
	g»s
 = 
·¿ms
.
Pİ
<int64_t>();

105 
EXPECT_TRUE
(
·¿ms
.
em±y
());

106  
	g»s
;

109 
ušt64_t
 
SŒessM®locsOrD›
(cÚ¡ 
¡d
::
sh¬ed_±r
<
Cl›Á
> &
ş›Á
,

110 
ušt64_t
 
m®loc_couÁ
, ušt64_ˆ
m®loc_size
) {

111 
N©iveP¬am‘”Sck
 
	g·¿ms
;

112 
	g·¿ms
.
	gPushByCİy
<
	gušt64_t
>(
	gm®loc_size
);

113 
	g·¿ms
.
	gPushByCİy
<
	gušt64_t
>(
	gm®loc_couÁ
);

114 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kSŒessM®locs
, &
·¿ms
));

115 
EXPECT_FALSE
(
·¿ms
.
em±y
());

116 cÚ¡ 
ušt64_t
 
	g»s
 = 
·¿ms
.
Pİ
<uint64_t>();

117 
EXPECT_TRUE
(
·¿ms
.
em±y
());

118  
	g»s
;

123 
TEST_F
(
Prim™ivesTe¡
, 
BadC®l
) {

124 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

127 
N©iveP¬am‘”Sck
 
	g·¿ms
;

128 
	g·¿ms
.
PushAÎoc
(4096);

129 
Stus
 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kNÙRegi¡”edS–eùÜ
, &
·¿ms
);

130 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

133 
N©iveP¬am‘”Sck
 
	g·¿ms_0_¬g
;

134 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms_0_¬g
);

135 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

136 
N©iveP¬am‘”Sck
 
	g·¿ms_2_¬g
;

137 
	g·¿ms_2_¬g
.
PushAÎoc
(4096);

138 
	g·¿ms_2_¬g
.
PushAÎoc
(4096);

139 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms_2_¬g
);

140 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

143 
TEST_F
(
Prim™ivesTe¡
, 
EnşaveLiãtime
) {

145 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

146 autØ
	gfœ¡_cİy
 = 
ş›Á
;

147 autØ
	g£cÚd_cİy
 = 
ş›Á
;

149 
	gfœ¡_cİy
.
»£t
();

150 
EXPECT_FALSE
(
ş›Á
->
IsClo£d
());

151 
	g£cÚd_cİy
.
»£t
();

152 
EXPECT_FALSE
(
ş›Á
->
IsClo£d
());

155 
	gfœ¡_cİy
 = 
ş›Á
;

156 
	g£cÚd_cİy
 = 
ş›Á
;

157 
EXPECT_FALSE
(
fœ¡_cİy
->
IsClo£d
());

158 
EXPECT_FALSE
(
£cÚd_cİy
->
IsClo£d
());

159 
	gş›Á
->
De¡roy
();

160 
EXPECT_TRUE
(
ş›Á
->
IsClo£d
());

161 
EXPECT_TRUE
(
fœ¡_cİy
->
IsClo£d
());

162 
EXPECT_TRUE
(
£cÚd_cİy
->
IsClo£d
());

165 autØ
	gfœ¡_š¡ªû
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

166 autØ
	g£cÚd_š¡ªû
 = 
LßdTe¡EnşaveOrD›
Ğ
Œue
);

168 
EXPECT_FALSE
(
fœ¡_š¡ªû
->
IsClo£d
());

169 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
fœ¡_š¡ªû
, 1), 
Eq
(2));

170 
EXPECT_FALSE
(
£cÚd_š¡ªû
->
IsClo£d
());

171 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
£cÚd_š¡ªû
, 2), 
Eq
(4));

173 
	gfœ¡_š¡ªû
->
De¡roy
();

174 
EXPECT_TRUE
(
fœ¡_š¡ªû
->
IsClo£d
());

175 
EXPECT_FALSE
(
£cÚd_š¡ªû
->
IsClo£d
());

176 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
£cÚd_š¡ªû
, 3), 
Eq
(6));

178 
	g£cÚd_š¡ªû
->
De¡roy
();

179 
EXPECT_TRUE
(
fœ¡_š¡ªû
->
IsClo£d
());

180 
EXPECT_TRUE
(
£cÚd_š¡ªû
->
IsClo£d
());

184 
TEST_F
(
Prim™ivesTe¡
, 
LßdEnşave
) {

185 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

186 
EXPECT_FALSE
(
ş›Á
->
IsClo£d
());

189 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
ş›Á
, 1), 
Eq
(2));

192 
	gş›Á
->
De¡roy
();

193 
EXPECT_TRUE
(
ş›Á
->
IsClo£d
());

196 
N©iveP¬am‘”Sck
 
	g·¿ms
;

197 
št32_t
 
	gšput
 = 1;

198 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gšput
);

199 
Stus
 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
);

200 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

204 
TEST_F
(
Prim™ivesTe¡
, 
AbÜtEnşave
) {

207 cÚ¡ 
	g¡d
::
unique_±r
<
ab¦
::
L—kCheckDi§bËr
> 
ignÜe_Ëak_check
(

208 
‹¡
::
Te¡Back’d
::
G‘
()->
L—ksMemÜyOnAbÜt
()

209 ? 
Ãw
 
ab¦
::
L—kCheckDi§bËr
()

210 : 
nuÎ±r
);

212 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

213 
	g¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á_cİy
 = 
ş›Á
;

216 
EXPECT_THAT
(
MuÉlyByTwoOrD›
(
ş›Á
, 1), 
Eq
(2));

219 
N©iveP¬am‘”Sck
 
	gabÜt_·¿ms
;

220 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kAbÜtEnşaveS–eùÜ
, &
abÜt_·¿ms
));

223 
št32_t
 
	gv®ue
 = 10;

224 
N©iveP¬am‘”Sck
 
	g·¿ms
;

225 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gv®ue
);

226 
Stus
 
	g¡©us
 = 
ş›Á
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
);

227 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

230 
	g¡©us
 = 
ş›Á_cİy
->
EnşaveC®l
(
kTimesTwoS–eùÜ
, &
·¿ms
);

231 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

235 
TEST_F
(
Prim™ivesTe¡
, 
C®lChaš
) {

236 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

238 autØ
	gŒu¡ed_fibÚacci
 = [&
ş›Á
](
št32_t
 
n
) -> int32_t {

239 
N©iveP¬am‘”Sck
 
·¿ms
;

240 
	g·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gn
);

241 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kTru¡edFibÚacci
, &
·¿ms
));

242 
EXPECT_FALSE
(
·¿ms
.
em±y
());

243 cÚ¡ 
št32_t
 
	g»s
 = 
·¿ms
.
Pİ
<int32_t>();

244 
EXPECT_TRUE
(
·¿ms
.
em±y
());

245  
	g»s
;

250 
	gEx™HªdËr
::
C®lback
 
fibÚacci_hªdËr
 =

251 [&](
¡d
::
sh¬ed_±r
<
Cl›Á
> 
ş›Á
, *
	gcÚ‹xt
,

252 
N©iveP¬am‘”Sck
 *
	g·¿ms
è-> 
	gStus
 {

253 ià(
	g·¿ms
->
em±y
()) {

254  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

257 cÚ¡ 
št32_t
 
	gn
 = 
·¿ms
->
Pİ
<int32_t>();

258 ià(!
	g·¿ms
->
em±y
()) {

259  
	gStus
{
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

262 ià(
	gn
 >= 50) {

263  
Stus
{
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

266 
	g·¿ms
->
	gPushByCİy
<
	gšt32_t
>(

267 
	gn
 < 2 ?‚ : 
Œu¡ed_fibÚacci
(
n
 - 1) +rusted_fibonacci(n - 2));

268  
	gStus
::
OkStus
();

272 
ASYLO_EXPECT_OK
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

273 
kUÁru¡edFibÚacci
, 
Ex™HªdËr
{
fibÚacci_hªdËr
}));

274 
EXPECT_THAT
(
Œu¡ed_fibÚacci
(20), 
Eq
(6765));

278 
TEST_F
(
Prim™ivesTe¡
, 
Th»adedTe¡
) {

279 
cÚ¡ex´
 
	gkNumTh»ads
 = 64;

280 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

281 
	gi
 = 0; i < 32; i++) {

282 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

283 
	gj
 = 0; j < 
	gkNumTh»ads
; j++) {

284 
	gth»ads
.
em¶aû_back
([&
ş›Á
, 
j
]() {

285 autØ
»suÉ
 = 
MuÉlyByTwoOrD›
(
ş›Á
, 
j
);

286 
EXPECT_THAT
(
»suÉ
, 
Eq
(2 * 
j
));

289 autØ&
	gth»ad
 : 
th»ads
) {

290 
th»ad
.
Još
();

295 
TEST_F
(
Prim™ivesTe¡
, 
Th»adedSŒessM®locsTe¡
) {

296 
cÚ¡ex´
 
	gkNumTh»ads
 = 64;

297 
cÚ¡ex´
 
ušt64_t
 
	gkM®locCouÁ
 = 64;

298 
cÚ¡ex´
 
ušt64_t
 
	gkM®locSize
 = 16;

299 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

300 
	gi
 = 0; i < 32; i++) {

301 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

302 
	gj
 = 0; j < 
	gkNumTh»ads
; j++) {

303 
	gth»ads
.
em¶aû_back
([&
ş›Á
]() {

304 autØ
»suÉ
 = 
SŒessM®locsOrD›
(
ş›Á
, 
kM®locCouÁ
, 
kM®locSize
);

305 
EXPECT_THAT
(
»suÉ
, 
Eq
(0));

308 autØ&
	gth»ad
 : 
th»ads
) {

309 
th»ad
.
Još
();

315 
TEST_F
(
Prim™ivesTe¡
, 
Th»adLoÿlStÜageTe¡
) {

316 
cÚ¡ex´
 
	gkNumCouÁ
 = 256;

317 
cÚ¡ex´
 
	gkNumTh»ads
 = 64;

318 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

319 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

320 
št64_t
 
	gth»ad_šdex
 = 0;h»ad_šdex < 
	gkNumTh»ads
;hread_index++) {

321 
	gth»ads
.
em¶aû_back
([&
ş›Á
, 
th»ad_šdex
]() {

322 
št64_t
 
sum
 = 0;

323 
št64_t
 
couÁ
 = 0;

324 
št64_t
 
i
 = 0; i < 
kNumCouÁ
; i++) {

325 
num
 = 
th»ad_šdex
 * 
kNumTh»ads
 + 
i
;

326 
sum
 +ğ
num
;

327 ++
couÁ
;

328 autØ
»suÉ
 = 
Av”ageP”Th»adOrD›
(
ş›Á
, 
num
);

329 
EXPECT_THAT
(
»suÉ
, 
Eq
(
sum
 / 
couÁ
)è<< 
th»ad_šdex
 << " " << 
i
;

333 autØ&
	gth»ad
 : 
th»ads
) {

334 
th»ad
.
Još
();

340 
TEST_F
(
Prim™ivesTe¡
, 
Tru¡edM®loc
) {

341 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

342 
N©iveP¬am‘”Sck
 
	g·¿ms
;

343 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kTru¡edM®locTe¡
, &
·¿ms
));

344 
EXPECT_FALSE
(
·¿ms
.
em±y
());

345 
EXPECT_TRUE
(
·¿ms
.
Pİ
<
boŞ
>());

346 
EXPECT_TRUE
(
·¿ms
.
em±y
());

351 
TEST_F
(
Prim™ivesTe¡
, 
UÄu¡edAÎoc
) {

352 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

353 
N©iveP¬am‘”Sck
 
	g·¿ms
;

354 
ASYLO_EXPECT_OK
(
ş›Á
->
EnşaveC®l
(
kUÁru¡edLoÿlAÎocTe¡
, &
·¿ms
));

355 
EXPECT_FALSE
(
·¿ms
.
em±y
());

356 
EXPECT_TRUE
(
·¿ms
.
Pİ
<
boŞ
>());

357 
EXPECT_TRUE
(
·¿ms
.
em±y
());

361 
TEST_F
(
Prim™ivesTe¡
, 
CİyMuÉËP¬ams
) {

362 autØ
	gş›Á
 = 
LßdTe¡EnşaveOrD›
Ğ
çl£
);

363 cÚ¡ 
	g¡d
::
¡ršg
 
š1
 = "Param1";

364 cÚ¡ 
ušt64_t
 
	gš2
 = 12345;

365 cÚ¡ 
	gš3
[] = "Param3";

366 
N©iveP¬am‘”Sck
 
	g·¿ms
;

367 
	g·¿ms
.
	gPushByCİy
<>(
	gš1
.
d©a
(), in1.
size
());

368 
	g·¿ms
.
	gPushByCİy
<
	gušt64_t
>(
	gš2
);

369 
	g·¿ms
.
	gPushByCİy
<>(
	gš3
, 
¡¾’
(
š3
) + 1);

370 
ASYLO_ASSERT_OK
(
ş›Á
->
EnşaveC®l
(
kCİyMuÉËP¬amsS–eùÜ
, &
·¿ms
));

371 
EXPECT_THAT
(
·¿ms
.
size
(), 
Eq
(4));

373 autØ
	gou4
 = 
·¿ms
.
Pİ
();

374 
	g¡d
::
¡ršg
 
out4
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
ou4
->
d©a
()),

375 
ou4
->
size
());

376 
EXPECT_THAT
(
out4
, 
SŒEq
("Foo"));

379 autØ
	gou3
 = 
·¿ms
.
Pİ
();

380 
	g¡d
::
¡ršg
 
out3
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
ou3
->
d©a
()),

381 
ou3
->
size
());

382 
EXPECT_THAT
(
out3
, 
SŒEq
(
š1
));

384 
EXPECT_THAT
(
·¿ms
.
Pİ
<
ušt64_t
>(), 
Eq
(
š2
));

386 autØ
	gou1
 = 
·¿ms
.
Pİ
();

387 
ASSERT_THAT
(
ou1
->
size
(), 
¡¾’
(
š3
) + 1);

388 cÚ¡ *
	gout1s
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
ou1
->
d©a
());

389 
EXPECT_THAT
(
out1s
, 
SŒEq
(
š3
));

391 
EXPECT_TRUE
(
·¿ms
.
em±y
());

398 
	$maš
(
¬gc
, *
¬gv
[]) {

399 ::
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

400 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

401  
Œue
);

403  
	`RUN_ALL_TESTS
();

404 
	}
}

	@platform/primitives/test/sgx_test_backend.cc

19 
	~"asylo/¶©fÜm/´im™ives/‹¡/sgx_‹¡_back’d.h
"

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

25 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

26 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

28 
	~"asylo/ut/¡©us_maüos.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

33 
Çme¥aû
 
	g‹¡
 {

35 *
	glßd”_cÚfig
 = 
nuÎ±r
;

37 
Te¡Back’d
 *
	gTe¡Back’d
::
G‘
() {

38 
Te¡Back’d
 *
back’d
 = 
Ãw
 
SgxTe¡Back’d
;

39  
	gback’d
;

	@platform/primitives/test/sgx_test_backend.cc

19 
	~"asylo/¶©fÜm/´im™ives/‹¡/sgx_‹¡_back’d.h
"

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

25 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

26 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

28 
	~"asylo/ut/¡©us_maüos.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

33 
Çme¥aû
 
	g‹¡
 {

35 *
	glßd”_cÚfig
 = 
nuÎ±r
;

37 
Te¡Back’d
 *
	gTe¡Back’d
::
G‘
() {

38 
Te¡Back’d
 *
back’d
 = 
Ãw
 
SgxTe¡Back’d
;

39  
	gback’d
;

	@platform/primitives/test/sgx_test_backend.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_TEST_SGX_TEST_BACKEND_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_TEST_SGX_TEST_BACKEND_H_


	)

22 
	~"asylo/’şave.pb.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/¶©fÜm/´im™ives/sgx/uÁru¡ed_sgx.h
"

25 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

28 
DEFINE_¡ršg
(
’şave_bš¬y
, "",

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

33 
Çme¥aû
 
	g‹¡
 {

35 *
lßd”_cÚfig
;

37 şas 
	cSgxTe¡Back’d
 : 
public
 
Te¡Back’d
 {

38 
public
:

39 
SgxTe¡Back’d
();

42 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
LßdTe¡Enşave
(

43 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

44 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
è
ov”ride
 {

45 
LßdEnşaveCÚfig
 *
cÚfig
 =

46 
»š‹½»t_ÿ¡
<
LßdEnşaveCÚfig
 *>(
lßd”_cÚfig
);

47  
	gLßdEnşave
<
	gSgxBack’d
>(
	g’şave_Çme
, 
	gcÚfig
->
	gba£_add»ss
,

48 
	gFLAGS_’şave_bš¬y
, 
	gcÚfig
->
	g’şave_size
,

49 
	gcÚfig
->cÚfig, cÚfig->
	gdebug
,

50 
	g¡d
::
move
(
ex™_ÿÎ_´ovid”
));

54 
	sLßdEnşaveCÚfig
 {

55 *
	gba£_add»ss
;

56 
	gab¦
::
¡ršg_v›w
 
’şave_·th
;

57 
size_t
 
	g’şave_size
;

58 
EnşaveCÚfig
 
	gcÚfig
;

59 
boŞ
 
	gdebug
;

	@platform/primitives/test/sim_test_backend.cc

19 
	~"asylo/¶©fÜm/´im™ives/‹¡/sim_‹¡_back’d.h
"

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"gæags/gæags.h
"

25 
	~"asylo/¶©fÜm/´im™ives/sim/uÁru¡ed_sim.h
"

26 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

27 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

28 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
DEFINE_¡ršg
(
’şave_bš¬y
, "",

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	g´im™ives
 {

37 
Çme¥aû
 
	g‹¡
 {

39 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SimTe¡Back’d
::
LßdTe¡Enşave
(

40 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

41 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

42  
LßdEnşave
<
SimBack’d
>(
’şave_Çme
,

43 
	gFLAGS_’şave_bš¬y
,

44 
	g¡d
::
move
(
ex™_ÿÎ_´ovid”
));

47 
Te¡Back’d
 *
	gTe¡Back’d
::
G‘
() {

48 
Te¡Back’d
 *
back’d
 = 
Ãw
 
SimTe¡Back’d
;

49  
	gback’d
;

	@platform/primitives/test/sim_test_backend.cc

19 
	~"asylo/¶©fÜm/´im™ives/‹¡/sim_‹¡_back’d.h
"

21 
	~<memÜy
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"gæags/gæags.h
"

25 
	~"asylo/¶©fÜm/´im™ives/sim/uÁru¡ed_sim.h
"

26 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

27 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

28 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
DEFINE_¡ršg
(
’şave_bš¬y
, "",

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	g´im™ives
 {

37 
Çme¥aû
 
	g‹¡
 {

39 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
SimTe¡Back’d
::
LßdTe¡Enşave
(

40 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

41 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

42  
LßdEnşave
<
SimBack’d
>(
’şave_Çme
,

43 
	gFLAGS_’şave_bš¬y
,

44 
	g¡d
::
move
(
ex™_ÿÎ_´ovid”
));

47 
Te¡Back’d
 *
	gTe¡Back’d
::
G‘
() {

48 
Te¡Back’d
 *
back’d
 = 
Ãw
 
SimTe¡Back’d
;

49  
	gback’d
;

	@platform/primitives/test/sim_test_backend.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_TEST_SIM_TEST_BACKEND_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_TEST_SIM_TEST_BACKEND_H_


	)

22 
	~"asylo/¶©fÜm/´im™ives/sim/uÁru¡ed_sim.h
"

23 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_back’d.h
"

24 
	~"asylo/ut/¡©usÜ.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g´im™ives
 {

28 
Çme¥aû
 
	g‹¡
 {

30 şas 
	cSimTe¡Back’d
 : 
public
 
Te¡Back’d
 {

31 
public
:

32 
SimTe¡Back’d
() = ;

35 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
Cl›Á
>> 
LßdTe¡Enşave
(

36 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

37 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
è
ov”ride
;

40 
boŞ
 
L—ksMemÜyOnAbÜt
(è
	gov”ride
 {  
	gŒue
; }

	@platform/primitives/test/test_backend.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_TEST_TEST_BACKEND_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_TEST_TEST_BACKEND_H_


	)

22 
	~<memÜy
>

24 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	g´im™ives
 {

29 
Çme¥aû
 
	g‹¡
 {

32 şas 
	cTe¡Back’d
 {

33 
	gpublic
:

36 
Te¡Back’d
 *
G‘
();

38 
Te¡Back’d
() = ;

39 
	gvœtu®
 ~
Te¡Back’d
() = ;

42 
	g¡d
::
sh¬ed_±r
<
Cl›Á
> 
LßdTe¡EnşaveOrD›
(

43 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

44 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) {

45 autØ
»suÉ
 = 
LßdTe¡Enşave
(
’şave_Çme
, 
¡d
::
move
(
ex™_ÿÎ_´ovid”
));

46 
EXPECT_THAT
(
»suÉ
.
¡©us
(), 
IsOk
());

47  
	g»suÉ
.
V®ueOrD›
();

51 
vœtu®
 
boŞ
 
L—ksMemÜyOnAbÜt
(è{  
	gçl£
; }

53 
	g´iv©e
:

55 
vœtu®
 
StusOr
<
¡d
::
sh¬ed_±r
<
Cl›Á
>> 
LßdTe¡Enşave
(

56 cÚ¡ 
ab¦
::
¡ršg_v›w
 
’şave_Çme
,

57 
¡d
::
unique_±r
<
Cl›Á
::
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
) = 0;

	@platform/primitives/test/test_enclave.cc

19 
	~<veùÜ
>

21 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

22 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

23 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

24 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_£ËùÜs.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

26 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

34 
	gÇme¥aû
 {

36 
boŞ
 
	gš™Ÿlized
 = 
çl£
;

40 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
In™CÚ¡ruùÜ
() {

41 
	gTru¡edPrim™ives
::
DebugPuts
("InitConstructor start\n");

42 
cÚ¡ex´
 
	gš™_mes§ge
[] = "InitConstructor";

43 
Tru¡edP¬am‘”Sck
 
	gš™_·¿ms
;

44 
	gš™_·¿ms
.
PushByCİy
(
Ex‹Á
{
š™_mes§ge
, (init_message)});

45 cÚ¡‡utØ
	g¡©us
 =

46 
Tru¡edPrim™ives
::
UÁru¡edC®l
(
kUÁru¡edIn™
, &
š™_·¿ms
);

47 
	gTru¡edPrim™ives
::
DebugPuts
("InitConstructor done: ");

48 ià(
	g¡©us
.
ok
()) {

49 cÚ¡‡utØ
	g»s
 = 
š™_·¿ms
.
Pİ
();

50 
	gTru¡edPrim™ives
::
DebugPuts
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»s
->
d©a
()));

51 
	gš™Ÿlized
 = 
Œue
;

53 
	gTru¡edPrim™ives
::
DebugPuts
(
¡©us
.
”rÜ_mes§ge
());

55 
	gTru¡edPrim™ives
::
DebugPuts
("\n");

59 
Prim™iveStus
 
AbÜt
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

60 ià(!
	g·¿ms
->
em±y
()) {

61  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

64 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Abortingƒnclave");

65  
	gPrim™iveStus
::
OkStus
();

71 
Prim™iveStus
 
MuÉlyByTwo
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

72 ià(
	g·¿ms
->
em±y
()) {

73  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 cÚ¡ 
št32_t
 
	gšput
 = 
·¿ms
->
Pİ
<int32_t>();

77 ià(!
	g·¿ms
->
em±y
()) {

78  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

81 
	g·¿ms
->
	gPushByCİy
<
	gšt32_t
>(2 * 
	gšput
);

82  
	gPrim™iveStus
::
OkStus
();

87 
Prim™iveStus
 
Av”ageP”Th»ad
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

88 
ABSL_CONST_INIT
 
th»ad_loÿl
 
št64_t
 
	g³r_th»ad_sum
 = 0;

89 
ABSL_CONST_INIT
 
th»ad_loÿl
 
št64_t
 
	g³r_th»ad_couÁ
 = 0;

90 ià(
	g·¿ms
->
em±y
()) {

91  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

94 cÚ¡ 
št64_t
 
	gšput
 = 
·¿ms
->
Pİ
<int64_t>();

95 ià(!
	g·¿ms
->
em±y
()) {

96  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

100 
	g³r_th»ad_sum
 +ğ
šput
;

101 ++
	g³r_th»ad_couÁ
;

102 
	g·¿ms
->
	gPushByCİy
<
	gšt64_t
>(
	g³r_th»ad_sum
 / 
	g³r_th»ad_couÁ
);

103  
	gPrim™iveStus
::
OkStus
();

108 
Prim™iveStus
 
Tru¡edFibÚacci
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

109 ià(
	g·¿ms
->
em±y
()) {

110  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

113 cÚ¡ 
št32_t
 
	gn
 = 
·¿ms
->
Pİ
<int32_t>();

114 ià(!
	g·¿ms
->
em±y
()) {

115  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

118 ià(
	gn
 >= 50) {

119  {
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

123 
Prim™iveStus
 
	g¡©us
;

124 autØ
	guÁru¡ed_fibÚacci
 = [&
¡©us
](
št32_t
 
n
) -> int32_t {

125 
Tru¡edP¬am‘”Sck
 
Ã¡ed_·¿ms
;

126 
	gÃ¡ed_·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gn
);

127 
	g¡©us
 =

128 
Tru¡edPrim™ives
::
UÁru¡edC®l
(
kUÁru¡edFibÚacci
, &
Ã¡ed_·¿ms
);

129 cÚ¡ 
št32_t
 
	g»s
 = 
Ã¡ed_·¿ms
.
Pİ
<int32_t>();

130  
	g»s
;

132 
ASYLO_RETURN_IF_ERROR
(
¡©us
);

134 
	g·¿ms
->
	gPushByCİy
<
	gšt32_t
>(

135 
	gn
 <ğ1 ? 
n
 : 
uÁru¡ed_fibÚacci
(n - 1) + untrusted_fibonacci(n - 2));

136  
	gPrim™iveStus
{};

141 
Prim™iveStus
 
Tru¡edM®locTe¡
(*
cÚ‹xt
,

142 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

143 ià(!
	g·¿ms
->
em±y
()) {

144  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

147 
boŞ
 
	g·s£d
 = 
Œue
;

148 
	gi
 = 0; i < 20; i++) {

149 
size_t
 
	gsz
 = 1 << 
i
;

150 *
	gbufãr
 = 
m®loc
(
sz
);

151 
	g·s£d
 = 
·s£d
 && 
Tru¡edPrim™ives
::
IsTru¡edEx‹Á
(
bufãr
, 
sz
);

152 
ä“
(
bufãr
);

154 
	g·¿ms
->
	gPushByCİy
<
	gboŞ
>(
	g·s£d
);

155  
	gPrim™iveStus
::
OkStus
();

160 
Prim™iveStus
 
UÁru¡edLoÿlAÎocTe¡
(*
cÚ‹xt
,

161 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

162 ià(!
	g·¿ms
->
em±y
()) {

163  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

166 
boŞ
 
	g·s£d
 = 
Œue
;

167 
	gi
 = 0; i < 20; i++) {

168 
size_t
 
	gsz
 = 1 << 
i
;

169 *
	gbufãr
 = 
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(
sz
);

170 
	g·s£d
 = 
·s£d
 && !
Tru¡edPrim™ives
::
IsTru¡edEx‹Á
(
bufãr
, 
sz
);

171 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
(
bufãr
);

173 
	g·¿ms
->
	gPushByCİy
<
	gboŞ
>(
	g·s£d
);

174  
	gPrim™iveStus
::
OkStus
();

178 
Prim™iveStus
 
CİyMuÉËP¬ams
(*
cÚ‹xt
,

179 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

182 
	g¡d
::
veùÜ
<
Tru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
> 
·¿ms_veùÜ
;

183 
	g·¿ms_veùÜ
.
»£rve
(
·¿ms
->
size
());

184 !
	g·¿ms
->
em±y
()) {

185 
	g·¿ms_veùÜ
.
em¶aû_back
(
·¿ms
->
Pİ
());

189 autØ&
	g·¿m
 : 
·¿ms_veùÜ
) {

190 
·¿ms
->
PushByCİy
(
Ex‹Á
{
·¿m
->
d©a
(),…¬am->
size
()});

192 
	g·¿m
.
»£t
();

195 
cÚ¡ex´
 
	gfoo
[] = "Foo";

196 
	g·¿ms
->
	gPushByCİy
<>(
	gfoo
, 
¡¾’
(
foo
));

197  
	gPrim™iveStus
::
OkStus
();

201 
Prim™iveStus
 
SŒessM®locs
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

202 ià(
	g·¿ms
->
size
() != 2) {

203  {
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

207 
ušt64_t
 
	gnum_®locs
 = 
·¿ms
->
Pİ
<uint64_t>();

208 
ušt64_t
 
	gmax_®loc_size
 = 
·¿ms
->
Pİ
<uint64_t>();

209 autØ
	g®locs
 = 
¡©ic_ÿ¡
<**>(
ÿÎoc
(
num_®locs
, (*)));

210 
ušt64_t
 
	gi
 = 0; i < 
	gnum_®locs
; ++i) {

211 
	g®locs
[
i
] = 
m®loc
(
max_®loc_size
);

213 
ušt64_t
 
	gçed_couÁ
 = 0;

214 
ušt64_t
 
	gi
 = 0; i < 
	gnum_®locs
; ++i) {

215 ià(
	g®locs
[
i
]) {

216 
ä“
(
®locs
[
i
]);

218 
	gçed_couÁ
++;

221 
ä“
(
®locs
);

223 
	g·¿ms
->
	gPushByCİy
<
	gušt64_t
>(
	gçed_couÁ
);

224  
	gPrim™iveStus
::
OkStus
();

230 "C" 
Prim™iveStus
 
asylo_’şave_š™
() {

231 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

232 
kAbÜtEnşaveS–eùÜ
, 
EÁryHªdËr
{
AbÜt
}));

233 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

234 
kTru¡edFibÚacci
, 
EÁryHªdËr
{
Tru¡edFibÚacci
}));

235 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

236 
kTimesTwoS–eùÜ
, 
EÁryHªdËr
{
MuÉlyByTwo
}));

237 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

238 
kAv”ageP”Th»adS–eùÜ
, 
EÁryHªdËr
{
Av”ageP”Th»ad
}));

239 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

240 
kTru¡edM®locTe¡
, 
EÁryHªdËr
{
Tru¡edM®locTe¡
}));

241 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

242 
kUÁru¡edLoÿlAÎocTe¡
, 
EÁryHªdËr
{
UÁru¡edLoÿlAÎocTe¡
}));

243 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

244 
kCİyMuÉËP¬amsS–eùÜ
, 
EÁryHªdËr
{
CİyMuÉËP¬ams
}));

245 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

246 
kSŒessM®locs
, 
EÁryHªdËr
{
SŒessM®locs
}));

247  
š™Ÿlized


248 ? 
Prim™iveStus
::
OkStus
()

249 : 
Prim™iveStus
{::
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

254 "C" 
Prim™iveStus
 
asylo_’şave_fši
() {

255  
Prim™iveStus
::
OkStus
();

261 "C" 
Prim™iveStus
 
	$’c_š™
(è{  
Prim™iveStus
::
	`OkStus
(); 
	}
}

	@platform/primitives/test/test_enclave.cc

19 
	~<veùÜ
>

21 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

22 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

23 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

24 
	~"asylo/¶©fÜm/´im™ives/‹¡/‹¡_£ËùÜs.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

26 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

27 
	~"asylo/ut/¡©us_maüos.h
"

29 
usšg
 
	gasylo
::
´im™ives
::
Prim™iveStus
;

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

34 
	gÇme¥aû
 {

36 
boŞ
 
	gš™Ÿlized
 = 
çl£
;

40 
__©Œibu‹__
((
cÚ¡ruùÜ
)è
In™CÚ¡ruùÜ
() {

41 
	gTru¡edPrim™ives
::
DebugPuts
("InitConstructor start\n");

42 
cÚ¡ex´
 
	gš™_mes§ge
[] = "InitConstructor";

43 
Tru¡edP¬am‘”Sck
 
	gš™_·¿ms
;

44 
	gš™_·¿ms
.
PushByCİy
(
Ex‹Á
{
š™_mes§ge
, (init_message)});

45 cÚ¡‡utØ
	g¡©us
 =

46 
Tru¡edPrim™ives
::
UÁru¡edC®l
(
kUÁru¡edIn™
, &
š™_·¿ms
);

47 
	gTru¡edPrim™ives
::
DebugPuts
("InitConstructor done: ");

48 ià(
	g¡©us
.
ok
()) {

49 cÚ¡‡utØ
	g»s
 = 
š™_·¿ms
.
Pİ
();

50 
	gTru¡edPrim™ives
::
DebugPuts
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
»s
->
d©a
()));

51 
	gš™Ÿlized
 = 
Œue
;

53 
	gTru¡edPrim™ives
::
DebugPuts
(
¡©us
.
”rÜ_mes§ge
());

55 
	gTru¡edPrim™ives
::
DebugPuts
("\n");

59 
Prim™iveStus
 
AbÜt
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

60 ià(!
	g·¿ms
->
em±y
()) {

61  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

64 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Abortingƒnclave");

65  
	gPrim™iveStus
::
OkStus
();

71 
Prim™iveStus
 
MuÉlyByTwo
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

72 ià(
	g·¿ms
->
em±y
()) {

73  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 cÚ¡ 
št32_t
 
	gšput
 = 
·¿ms
->
Pİ
<int32_t>();

77 ià(!
	g·¿ms
->
em±y
()) {

78  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

81 
	g·¿ms
->
	gPushByCİy
<
	gšt32_t
>(2 * 
	gšput
);

82  
	gPrim™iveStus
::
OkStus
();

87 
Prim™iveStus
 
Av”ageP”Th»ad
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

88 
ABSL_CONST_INIT
 
th»ad_loÿl
 
št64_t
 
	g³r_th»ad_sum
 = 0;

89 
ABSL_CONST_INIT
 
th»ad_loÿl
 
št64_t
 
	g³r_th»ad_couÁ
 = 0;

90 ià(
	g·¿ms
->
em±y
()) {

91  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

94 cÚ¡ 
št64_t
 
	gšput
 = 
·¿ms
->
Pİ
<int64_t>();

95 ià(!
	g·¿ms
->
em±y
()) {

96  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

100 
	g³r_th»ad_sum
 +ğ
šput
;

101 ++
	g³r_th»ad_couÁ
;

102 
	g·¿ms
->
	gPushByCİy
<
	gšt64_t
>(
	g³r_th»ad_sum
 / 
	g³r_th»ad_couÁ
);

103  
	gPrim™iveStus
::
OkStus
();

108 
Prim™iveStus
 
Tru¡edFibÚacci
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

109 ià(
	g·¿ms
->
em±y
()) {

110  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

113 cÚ¡ 
št32_t
 
	gn
 = 
·¿ms
->
Pİ
<int32_t>();

114 ià(!
	g·¿ms
->
em±y
()) {

115  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

118 ià(
	gn
 >= 50) {

119  {
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

123 
Prim™iveStus
 
	g¡©us
;

124 autØ
	guÁru¡ed_fibÚacci
 = [&
¡©us
](
št32_t
 
n
) -> int32_t {

125 
Tru¡edP¬am‘”Sck
 
Ã¡ed_·¿ms
;

126 
	gÃ¡ed_·¿ms
.
	gPushByCİy
<
	gšt32_t
>(
	gn
);

127 
	g¡©us
 =

128 
Tru¡edPrim™ives
::
UÁru¡edC®l
(
kUÁru¡edFibÚacci
, &
Ã¡ed_·¿ms
);

129 cÚ¡ 
št32_t
 
	g»s
 = 
Ã¡ed_·¿ms
.
Pİ
<int32_t>();

130  
	g»s
;

132 
ASYLO_RETURN_IF_ERROR
(
¡©us
);

134 
	g·¿ms
->
	gPushByCİy
<
	gšt32_t
>(

135 
	gn
 <ğ1 ? 
n
 : 
uÁru¡ed_fibÚacci
(n - 1) + untrusted_fibonacci(n - 2));

136  
	gPrim™iveStus
{};

141 
Prim™iveStus
 
Tru¡edM®locTe¡
(*
cÚ‹xt
,

142 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

143 ià(!
	g·¿ms
->
em±y
()) {

144  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

147 
boŞ
 
	g·s£d
 = 
Œue
;

148 
	gi
 = 0; i < 20; i++) {

149 
size_t
 
	gsz
 = 1 << 
i
;

150 *
	gbufãr
 = 
m®loc
(
sz
);

151 
	g·s£d
 = 
·s£d
 && 
Tru¡edPrim™ives
::
IsTru¡edEx‹Á
(
bufãr
, 
sz
);

152 
ä“
(
bufãr
);

154 
	g·¿ms
->
	gPushByCİy
<
	gboŞ
>(
	g·s£d
);

155  
	gPrim™iveStus
::
OkStus
();

160 
Prim™iveStus
 
UÁru¡edLoÿlAÎocTe¡
(*
cÚ‹xt
,

161 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

162 ià(!
	g·¿ms
->
em±y
()) {

163  {
	g”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

166 
boŞ
 
	g·s£d
 = 
Œue
;

167 
	gi
 = 0; i < 20; i++) {

168 
size_t
 
	gsz
 = 1 << 
i
;

169 *
	gbufãr
 = 
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
(
sz
);

170 
	g·s£d
 = 
·s£d
 && !
Tru¡edPrim™ives
::
IsTru¡edEx‹Á
(
bufãr
, 
sz
);

171 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
(
bufãr
);

173 
	g·¿ms
->
	gPushByCİy
<
	gboŞ
>(
	g·s£d
);

174  
	gPrim™iveStus
::
OkStus
();

178 
Prim™iveStus
 
CİyMuÉËP¬ams
(*
cÚ‹xt
,

179 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

182 
	g¡d
::
veùÜ
<
Tru¡edP¬am‘”Sck
::
Ex‹ÁPŒ
> 
·¿ms_veùÜ
;

183 
	g·¿ms_veùÜ
.
»£rve
(
·¿ms
->
size
());

184 !
	g·¿ms
->
em±y
()) {

185 
	g·¿ms_veùÜ
.
em¶aû_back
(
·¿ms
->
Pİ
());

189 autØ&
	g·¿m
 : 
·¿ms_veùÜ
) {

190 
·¿ms
->
PushByCİy
(
Ex‹Á
{
·¿m
->
d©a
(),…¬am->
size
()});

192 
	g·¿m
.
»£t
();

195 
cÚ¡ex´
 
	gfoo
[] = "Foo";

196 
	g·¿ms
->
	gPushByCİy
<>(
	gfoo
, 
¡¾’
(
foo
));

197  
	gPrim™iveStus
::
OkStus
();

201 
Prim™iveStus
 
SŒessM®locs
(*
cÚ‹xt
, 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

202 ià(
	g·¿ms
->
size
() != 2) {

203  {
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

207 
ušt64_t
 
	gnum_®locs
 = 
·¿ms
->
Pİ
<uint64_t>();

208 
ušt64_t
 
	gmax_®loc_size
 = 
·¿ms
->
Pİ
<uint64_t>();

209 autØ
	g®locs
 = 
¡©ic_ÿ¡
<**>(
ÿÎoc
(
num_®locs
, (*)));

210 
ušt64_t
 
	gi
 = 0; i < 
	gnum_®locs
; ++i) {

211 
	g®locs
[
i
] = 
m®loc
(
max_®loc_size
);

213 
ušt64_t
 
	gçed_couÁ
 = 0;

214 
ušt64_t
 
	gi
 = 0; i < 
	gnum_®locs
; ++i) {

215 ià(
	g®locs
[
i
]) {

216 
ä“
(
®locs
[
i
]);

218 
	gçed_couÁ
++;

221 
ä“
(
®locs
);

223 
	g·¿ms
->
	gPushByCİy
<
	gušt64_t
>(
	gçed_couÁ
);

224  
	gPrim™iveStus
::
OkStus
();

230 "C" 
Prim™iveStus
 
asylo_’şave_š™
() {

231 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

232 
kAbÜtEnşaveS–eùÜ
, 
EÁryHªdËr
{
AbÜt
}));

233 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

234 
kTru¡edFibÚacci
, 
EÁryHªdËr
{
Tru¡edFibÚacci
}));

235 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

236 
kTimesTwoS–eùÜ
, 
EÁryHªdËr
{
MuÉlyByTwo
}));

237 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

238 
kAv”ageP”Th»adS–eùÜ
, 
EÁryHªdËr
{
Av”ageP”Th»ad
}));

239 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

240 
kTru¡edM®locTe¡
, 
EÁryHªdËr
{
Tru¡edM®locTe¡
}));

241 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

242 
kUÁru¡edLoÿlAÎocTe¡
, 
EÁryHªdËr
{
UÁru¡edLoÿlAÎocTe¡
}));

243 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

244 
kCİyMuÉËP¬amsS–eùÜ
, 
EÁryHªdËr
{
CİyMuÉËP¬ams
}));

245 
ASYLO_RETURN_IF_ERROR
(
Tru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(

246 
kSŒessM®locs
, 
EÁryHªdËr
{
SŒessM®locs
}));

247  
š™Ÿlized


248 ? 
Prim™iveStus
::
OkStus
()

249 : 
Prim™iveStus
{::
asylo
::
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

254 "C" 
Prim™iveStus
 
asylo_’şave_fši
() {

255  
Prim™iveStus
::
OkStus
();

261 "C" 
Prim™iveStus
 
	$’c_š™
(è{  
Prim™iveStus
::
	`OkStus
(); 
	}
}

	@platform/primitives/test/test_selectors.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_TEST_TEST_SELECTORS_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_TEST_TEST_SELECTORS_H_


	)

22 
	~<c¡dšt
>

24 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g´im™ives
 {

30 
cÚ¡ex´
 
ušt64_t
 
	gkAbÜtEnşaveS–eùÜ
 = 
kS–eùÜU£r
 + 1;

31 
cÚ¡ex´
 
ušt64_t
 
	gkTimesTwoS–eùÜ
 = 
kS–eùÜU£r
 + 2;

32 
cÚ¡ex´
 
ušt64_t
 
	gkTru¡edFibÚacci
 = 
kS–eùÜU£r
 + 3;

33 
cÚ¡ex´
 
ušt64_t
 
	gkTru¡edM®locTe¡
 = 
kS–eùÜU£r
 + 4;

34 
cÚ¡ex´
 
ušt64_t
 
	gkUÁru¡edLoÿlAÎocTe¡
 = 
kS–eùÜU£r
 + 5;

35 
cÚ¡ex´
 
ušt64_t
 
	gkAv”ageP”Th»adS–eùÜ
 = 
kS–eùÜU£r
 + 6;

36 
cÚ¡ex´
 
ušt64_t
 
	gkCİyMuÉËP¬amsS–eùÜ
 = 
kS–eùÜU£r
 + 7;

37 
cÚ¡ex´
 
ušt64_t
 
	gkSŒessM®locs
 = 
kS–eùÜU£r
 + 8;

40 
cÚ¡ex´
 
ušt64_t
 
	gkNÙRegi¡”edS–eùÜ
 = 
kS–eùÜU£r
 + 100;

43 
cÚ¡ex´
 
ušt64_t
 
	gkUÁru¡edIn™
 = 
kS–eùÜU£r
 + 1;

44 
cÚ¡ex´
 
ušt64_t
 
	gkUÁru¡edFibÚacci
 = 
kS–eùÜU£r
 + 2;

	@platform/primitives/trusted_primitives.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_TRUSTED_PRIMITIVES_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_TRUSTED_PRIMITIVES_H_


	)

22 
	~<c¡ddef
>

23 
	~<c¡dšt
>

25 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

26 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

27 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

28 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

29 
	~"asylo/ut/asylo_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	g´im™ives
 {

38 
	gEÁryHªdËr
;

41 şas 
	cTru¡edPrim™ives
 {

42 
	gpublic
:

47 
Be¡EffÜtAbÜt
(cÚ¡ *
mes§ge
);

55 
DebugPuts
(cÚ¡ *
mes§ge
);

59 
boŞ
 
IsTru¡edEx‹Á
(cÚ¡ *
addr
,

60 
size_t
 
size
è
	gASYLO_MUST_USE_RESULT
;

70 *
UÁru¡edLoÿlAÎoc
(
size_t
 
size
è
	gASYLO_MUST_USE_RESULT
;

74 
UÁru¡edLoÿlF»e
(*
±r
);

87 
Prim™iveStus
 
UÁru¡edC®l
(

88 
ušt64_t
 
uÁru¡ed_£ËùÜ
,

89 
P¬am‘”Sck
<
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
,

90 
Tru¡edPrim™ives
::
UÁru¡edLoÿlF»e
> *
·¿ms
)

91 
ASYLO_MUST_USE_RESULT
;

97 
Prim™iveStus
 
Regi¡”EÁryHªdËr
(
ušt64_t
 
Œu¡ed_£ËùÜ
,

98 cÚ¡ 
EÁryHªdËr
 &
hªdËr
)

99 
	gASYLO_MUST_USE_RESULT
;

103 
usšg
 
	gTru¡edP¬am‘”Sck
 =

104 
P¬am‘”Sck
<
Tru¡edPrim™ives
::
UÁru¡edLoÿlAÎoc
,

105 
	gTru¡edPrim™ives
::
UÁru¡edLoÿlF»e
>;

108 
	sEÁryHªdËr
 {

109 
usšg
 
	gC®lback
 = 
Prim™iveStus
 (*)(*, 
	gTru¡edP¬am‘”Sck
 *);

111 
EÁryHªdËr
(è: 
ÿÎback
(
nuÎ±r
), 
cÚ‹xt
(nullptr) {}

114 
ex¶ic™
 
EÁryHªdËr
(
C®lback
 
ÿÎback
)

115 : 
ÿÎback
(ÿÎback), 
cÚ‹xt
(
nuÎ±r
) {}

118 
EÁryHªdËr
(
C®lback
 
ÿÎback
, *
cÚ‹xt
)

119 : 
ÿÎback
(ÿÎback), 
cÚ‹xt
(context) {}

122 
boŞ
 
IsNuÎ
(ècÚ¡ {  
	gÿÎback
 =ğ
nuÎ±r
; }

125 
C®lback
 
	gÿÎback
;

128 *
	gcÚ‹xt
;

	@platform/primitives/trusted_runtime.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_TRUSTED_RUNTIME_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_TRUSTED_RUNTIME_H_


	)

22 
	~<c¡dšt
>

23 
	~<c¡dlib
>

24 
	~<c¡ršg
>

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

31 
asylo
::
´im™ives
::
Prim™iveStus
 
’c_š™
();

35 *
’şave_sbrk
(
šŒ_t
 
šüem’t
);

39 
ušt64_t
 
’c_th»ad_£lf
();

43 
cÚ¡ex´
 
ušt64_t
 
kInv®idTh»ad
 = 0;

47 
boŞ
 
’c_is_w™hš_’şave
(cÚ¡ *
add»ss
, 
size_t
 
size
);

51 
boŞ
 
’c_is_outside_’şave
(cÚ¡ *
add»ss
, 
size_t
 
size
);

53 
	sEnşaveMemÜyLayout
 {

55 *
d©a_ba£
;

57 
size_t
 
d©a_size
;

59 *
bss_ba£
;

61 
size_t
 
bss_size
;

63 *
h—p_ba£
;

65 
size_t
 
h—p_size
;

67 *
th»ad_ba£
;

69 
size_t
 
th»ad_size
;

72 *
¡ack_ba£
;

75 *
¡ack_lim™
;

77 *
»£rved_d©a_ba£
;

79 
size_t
 
»£rved_d©a_size
;

81 *
»£rved_bss_ba£
;

83 
size_t
 
»£rved_bss_size
;

85 *
»£rved_h—p_ba£
;

87 
size_t
 
»£rved_h—p_size
;

91 
’c_block_eÿÎs
();

94 
’c_unblock_eÿÎs
();

96 
’c_g‘_memÜy_Ïyout
(
EnşaveMemÜyLayout
 *
’şave_memÜy_Ïyout
);

99 
g‘_aùive_’şave_’Œ›s
();

103 #ifdeà
__x86_64__


104 
	#’c_·u£
(è
	`__butš_Ÿ32_·u£
()

	)

106 
	#’c_·u£
() \

108 } 0)

	)

	@platform/primitives/untrusted_primitives.cc

19 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

21 
	~<c¡dšt
>

22 
	~<memÜy
>

23 
	~<ut™y
>

25 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

27 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

28 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

29 
	~"asylo/ut/asylo_maüos.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	g´im™ives
 {

36 
th»ad_loÿl
 
Cl›Á
 *
	gCl›Á
::
cu¼’t_ş›Á_
 = 
nuÎ±r
;

38 
Stus
 
	gCl›Á
::
EnşaveC®l
(
ušt64_t
 
£ËùÜ
, 
N©iveP¬am‘”Sck
 *
·¿ms
) {

39 
ScİedCu¼’tCl›Á
 
scİed_ş›Á
(
this
);

40  
EnşaveC®lIÁ”Çl
(
£ËùÜ
, 
·¿ms
);

43 
Prim™iveStus
 
	gCl›Á
::
Ex™C®lback
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

44 
N©iveP¬am‘”Sck
 *
·¿ms
) {

45 ià(!
	gcu¼’t_ş›Á_
->
ex™_ÿÎ_´ovid”
()) {

46  
	gPrim™iveStus
{
	g”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

49  
MakePrim™iveStus
(

50 
cu¼’t_ş›Á_
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

51 
uÁru¡ed_£ËùÜ
, 
·¿ms
, 
cu¼’t_ş›Á_
));

	@platform/primitives/untrusted_primitives.cc

19 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

21 
	~<c¡dšt
>

22 
	~<memÜy
>

23 
	~<ut™y
>

25 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

27 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

28 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

29 
	~"asylo/ut/asylo_maüos.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©usÜ.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	g´im™ives
 {

36 
th»ad_loÿl
 
Cl›Á
 *
	gCl›Á
::
cu¼’t_ş›Á_
 = 
nuÎ±r
;

38 
Stus
 
	gCl›Á
::
EnşaveC®l
(
ušt64_t
 
£ËùÜ
, 
N©iveP¬am‘”Sck
 *
·¿ms
) {

39 
ScİedCu¼’tCl›Á
 
scİed_ş›Á
(
this
);

40  
EnşaveC®lIÁ”Çl
(
£ËùÜ
, 
·¿ms
);

43 
Prim™iveStus
 
	gCl›Á
::
Ex™C®lback
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

44 
N©iveP¬am‘”Sck
 *
·¿ms
) {

45 ià(!
	gcu¼’t_ş›Á_
->
ex™_ÿÎ_´ovid”
()) {

46  
	gPrim™iveStus
{
	g”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

49  
MakePrim™iveStus
(

50 
cu¼’t_ş›Á_
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

51 
uÁru¡ed_£ËùÜ
, 
·¿ms
, 
cu¼’t_ş›Á_
));

	@platform/primitives/untrusted_primitives.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_UNTRUSTED_PRIMITIVES_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_UNTRUSTED_PRIMITIVES_H_


	)

22 
	~<c¡dšt
>

23 
	~<memÜy
>

24 
	~<ut™y
>

26 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

27 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

28 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

29 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

30 
	~"asylo/ut/asylo_maüos.h
"

31 
	~"asylo/ut/¡©us.h
"

32 
	~"asylo/ut/¡©usÜ.h
"

34 
Çme¥aû
 
	gasylo
 {

35 
Çme¥aû
 
	g´im™ives
 {

53 
	g‹m¶©e
 <
ty³Çme
 
	gBack’d
, 
	gty³Çme
... 
	gArgs
>

54 
	gStusOr
<
	g¡d
::
sh¬ed_±r
<
şass
 
Cl›Á
>> 
LßdEnşave
(
Args
 &&... 
¬gs
) {

55  
Back’d
::
Lßd
(
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

59 
	sEx™HªdËr
 {

60 
usšg
 
	gC®lback
 = 
¡d
::
funùiÚ
<
Stus
(¡d::
sh¬ed_±r
<
şass
 
Cl›Á
> 
’şave
,

61 *, 
N©iveP¬am‘”Sck
 *)>;

63 
Ex™HªdËr
(è: 
cÚ‹xt
(
nuÎ±r
) {}

66 
ex¶ic™
 
Ex™HªdËr
(
C®lback
 
ÿÎback
)

67 : 
ÿÎback
(ÿÎback), 
cÚ‹xt
(
nuÎ±r
) {}

70 
Ex™HªdËr
(
C®lback
 
ÿÎback
, *
cÚ‹xt
)

71 : 
ÿÎback
(ÿÎback), 
cÚ‹xt
(context) {}

74 
boŞ
 
IsNuÎ
(ècÚ¡ {  
	gÿÎback
 =ğ
nuÎ±r
; }

77 
C®lback
 
	gÿÎback
;

80 *
	gcÚ‹xt
;

84 
şass
 
	gCl›Á
 : 
public
 
¡d
::
’abË_sh¬ed_äom_this
<
Cl›Á
> {

85 
public
:

87 şas 
	cEx™C®lProvid”
 {

88 
public
:

89 
vœtu®
 ~
Ex™C®lProvid”
() = ;

95 
vœtu®
 
Stus
 
Regi¡”Ex™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

96 cÚ¡ 
Ex™HªdËr
 &
hªdËr
)

97 
	gASYLO_MUST_USE_RESULT
 = 0;

100 
vœtu®
 
Stus
 
InvokeEx™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

101 
N©iveP¬am‘”Sck
 *
·¿ms
,

102 
Cl›Á
 *
ş›Á
è
	gASYLO_MUST_USE_RESULT
 = 0;

107 şas 
	cScİedCu¼’tCl›Á
 {

108 
	gpublic
:

109 
ex¶ic™
 
ScİedCu¼’tCl›Á
(
Cl›Á
 *
ş›Á
)

110 : 
§ved_ş›Á_
(
Cl›Á
::
cu¼’t_ş›Á_
) {

111 
cu¼’t_ş›Á_
 = 
ş›Á
;

113 ~
ScİedCu¼’tCl›Á
(è{ 
	gcu¼’t_ş›Á_
 = 
§ved_ş›Á_
; }

115 
ScİedCu¼’tCl›Á
(cÚ¡ ScİedCu¼’tCl›Á &
Ùh”
èğ
d–‘e
;

116 
	gScİedCu¼’tCl›Á
 &
	gİ”©Ü
=(cÚ¡ 
ScİedCu¼’tCl›Á
 &
Ùh”
èğ
d–‘e
;

118 
	g´iv©e
:

119 
Cl›Á
 *
§ved_ş›Á_
;

122 
	gvœtu®
 ~
Cl›Á
() = ;

127 
vœtu®
 
boŞ
 
IsClo£d
() const = 0;

131 
vœtu®
 
Stus
 
De¡roy
() = 0;

136 
vœtu®
 cÚ¡ 
	gab¦
::
¡ršg_v›w
 &
Name
(ècÚ¡ {  
Çme_
; }

143 
Stus
 
EnşaveC®l
(
ušt64_t
 
£ËùÜ
,

144 
N©iveP¬am‘”Sck
 *
·¿ms
è
	gASYLO_MUST_USE_RESULT
;

147 
Prim™iveStus
 
Ex™C®lback
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

148 
N©iveP¬am‘”Sck
 *
·¿ms
);

151 
Ex™C®lProvid”
 *
ex™_ÿÎ_´ovid”
(è{  
	gex™_ÿÎ_´ovid”_
.
g‘
(); }

153 
	g´Ùeùed
:

154 
Cl›Á
(cÚ¡ 
ab¦
::
¡ršg_v›w
 
Çme
,

155 
¡d
::
unique_±r
<
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”
)

156 : 
ex™_ÿÎ_´ovid”_
(
¡d
::
move
(
ex™_ÿÎ_´ovid”
)), 
Çme_
(
Çme
) {}

159 
vœtu®
 
Stus
 
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

160 
N©iveP¬am‘”Sck
 *
·¿ms
)

161 
	gASYLO_MUST_USE_RESULT
 = 0;

163 
	g´iv©e
:

165 cÚ¡ 
¡d
::
unique_±r
<
Ex™C®lProvid”
> 
ex™_ÿÎ_´ovid”_
;

169 
th»ad_loÿl
 
Cl›Á
 *
	gcu¼’t_ş›Á_
;

172 
	gab¦
::
¡ršg_v›w
 
Çme_
;

	@platform/primitives/util/dispatch_table.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

21 
	~<memÜy
>

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	g´im™ives
 {

30 
Stus
 
	gDi¥©chTabË
::
Regi¡”Ex™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

31 cÚ¡ 
Ex™HªdËr
 &
hªdËr
) {

33 autØ
	glocked_ex™_bË
 = 
ex™_bË_
.
Lock
();

34 ià(
	glocked_ex™_bË
->
cÚšs
(
uÁru¡ed_£ËùÜ
)) {

35  {
	g”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
,

38 
	glocked_ex™_bË
->
em¶aû
(
uÁru¡ed_£ËùÜ
, 
hªdËr
);

39  
	gStus
::
OkStus
();

43 
Stus
 
	gDi¥©chTabË
::
InvokeEx™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

44 
N©iveP¬am‘”Sck
 *
·¿ms
,

45 
Cl›Á
 *
ş›Á
) {

46 
Ex™HªdËr
 
	ghªdËr
;

48 autØ
	glocked_ex™_bË
 = 
ex™_bË_
.
R—d”Lock
();

49 autØ
	g™
 = 
locked_ex™_bË
->
fšd
(
uÁru¡ed_£ËùÜ
);

50 ià(
	g™
 =ğ
locked_ex™_bË
->
’d
()) {

51  {
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

54 
	ghªdËr
 = 
™
->
£cÚd
;

56  
	ghªdËr
.
ÿÎback
(
ş›Á
->
sh¬ed_äom_this
(), 
hªdËr
.
cÚ‹xt
, 
·¿ms
);

	@platform/primitives/util/dispatch_table.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

21 
	~<memÜy
>

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	g´im™ives
 {

30 
Stus
 
	gDi¥©chTabË
::
Regi¡”Ex™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

31 cÚ¡ 
Ex™HªdËr
 &
hªdËr
) {

33 autØ
	glocked_ex™_bË
 = 
ex™_bË_
.
Lock
();

34 ià(
	glocked_ex™_bË
->
cÚšs
(
uÁru¡ed_£ËùÜ
)) {

35  {
	g”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
,

38 
	glocked_ex™_bË
->
em¶aû
(
uÁru¡ed_£ËùÜ
, 
hªdËr
);

39  
	gStus
::
OkStus
();

43 
Stus
 
	gDi¥©chTabË
::
InvokeEx™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

44 
N©iveP¬am‘”Sck
 *
·¿ms
,

45 
Cl›Á
 *
ş›Á
) {

46 
Ex™HªdËr
 
	ghªdËr
;

48 autØ
	glocked_ex™_bË
 = 
ex™_bË_
.
R—d”Lock
();

49 autØ
	g™
 = 
locked_ex™_bË
->
fšd
(
uÁru¡ed_£ËùÜ
);

50 ià(
	g™
 =ğ
locked_ex™_bË
->
’d
()) {

51  {
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

54 
	ghªdËr
 = 
™
->
£cÚd
;

56  
	ghªdËr
.
ÿÎback
(
ş›Á
->
sh¬ed_äom_this
(), 
hªdËr
.
cÚ‹xt
, 
·¿ms
);

	@platform/primitives/util/dispatch_table.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_UTIL_DISPATCH_TABLE_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_UTIL_DISPATCH_TABLE_H_


	)

22 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

23 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

24 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

25 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

26 
	~"asylo/ut/asylo_maüos.h
"

27 
	~"asylo/ut/mu‹x_gu¬ded.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g´im™ives
 {

33 şas 
	cDi¥©chTabË
 : 
public
 
Cl›Á
::
Ex™C®lProvid”
 {

34 
public
:

35 
Di¥©chTabË
(è: 
ex™_bË_
(
ab¦
::
æ©_hash_m­
<
ušt64_t
, 
Ex™HªdËr
>()) {}

41 
Stus
 
Regi¡”Ex™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

42 cÚ¡ 
Ex™HªdËr
 &
hªdËr
è
	gov”ride
;

45 
Stus
 
InvokeEx™HªdËr
(
ušt64_t
 
uÁru¡ed_£ËùÜ
,

46 
N©iveP¬am‘”Sck
 *
·¿ms
,

47 
Cl›Á
 *
ş›Á
è
ov”ride
 
	gASYLO_MUST_USE_RESULT
;

49 
	g´iv©e
:

50 
Mu‹xGu¬ded
<
ab¦
::
æ©_hash_m­
<
ušt64_t
, 
	gEx™HªdËr
>> 
	gex™_bË_
;

	@platform/primitives/util/dispatch_table_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

21 
	~<c¡dlib
>

22 
	~<memÜy
>

23 
	~<¿ndom
>

24 
	~<th»ad
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"ab¦/time/şock.h
"

30 
	~"ab¦/time/time.h
"

31 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

32 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
	~"asylo/ut/th»ad.h
"

36 
	gusšg
 ::
‹¡šg
::
_
;

37 
	gusšg
 ::
‹¡šg
::
Eq
;

38 
	gusšg
 ::
‹¡šg
::
MockFunùiÚ
;

40 
Çme¥aû
 
	gasylo
 {

41 
Çme¥aû
 
	g´im™ives
 {

42 
	gÇme¥aû
 {

44 şas 
	cMockedEnşaveCl›Á
 : 
public
 
Cl›Á
 {

45 
public
:

46 
usšg
 
MockEx™HªdËrC®lback
 =

47 
MockFunùiÚ
<
Stus
(
¡d
::
sh¬ed_±r
<
şass
 
Cl›Á
> 
’şave
, *,

48 
N©iveP¬am‘”Sck
 *
·¿ms
)>;

50 
MockedEnşaveCl›Á
(è: 
Cl›Á
(

51  "mock_’şave", 
ab¦
::
make_unique
<
Di¥©chTabË
>()) {}

54 
boŞ
 
IsClo£d
(ècÚ¡ 
ov”ride
 {  
çl£
; }

55 
Stus
 
De¡roy
(è
	gov”ride
 {  
	gStus
::
OkStus
(); }

56 
Stus
 
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

57 
N©iveP¬am‘”Sck
 *
·¿ms
è
	gov”ride
 {

58  
	gStus
::
OkStus
();

62 
TEST
(
Di¥©chTabËTe¡
, 
HªdËrsRegi¡¿tiÚ
) {

63 
Di¥©chTabË
 
	gdi¥©ch_bË
;

64 
	gMockedEnşaveCl›Á
::
MockEx™HªdËrC®lback
 
ÿÎback
;

65 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

66 0, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

67 
IsOk
());

68 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

69 10, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

70 
IsOk
());

71 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

72 0, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

73 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

74 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

75 10, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

76 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

77 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

78 20, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

79 
IsOk
());

82 
TEST
(
Di¥©chTabËTe¡
, 
HªdËrsInvoÿtiÚ
) {

83 cÚ¡‡utØ
	gş›Á
 = 
¡d
::
make_sh¬ed
<
MockedEnşaveCl›Á
>();

84 
	gMockedEnşaveCl›Á
::
MockEx™HªdËrC®lback
 
ÿÎbacks
[3];

85 
EXPECT_CALL
(
ÿÎbacks
[0], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(2);

86 
EXPECT_CALL
(
ÿÎbacks
[1], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(1);

87 
EXPECT_CALL
(
ÿÎbacks
[2], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(0);

88 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

89 0, 
Ex™HªdËr
{
ÿÎbacks
[0].
AsStdFunùiÚ
()}),

90 
IsOk
());

91 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

92 10, 
Ex™HªdËr
{
ÿÎbacks
[1].
AsStdFunùiÚ
()}),

93 
IsOk
());

94 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

95 20, 
Ex™HªdËr
{
ÿÎbacks
[2].
AsStdFunùiÚ
()}),

96 
IsOk
());

97 
N©iveP¬am‘”Sck
 
	g·¿ms
;

98 
EXPECT_THAT
(

99 
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(0, &
·¿ms
, cl›Á.
g‘
()),

100 
IsOk
());

101 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(10, &
·¿ms
,

102 
ş›Á
.
g‘
()),

103 
IsOk
());

104 
EXPECT_THAT
(

105 
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(0, &
·¿ms
, cl›Á.
g‘
()),

106 
IsOk
());

107 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(30, &
·¿ms
,

108 
ş›Á
.
g‘
()),

109 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

112 
TEST
(
Di¥©chTabËTe¡
, 
HªdËrsInMuÉËTh»ads
) {

113 cÚ¡ 
size_t
 
	gkTh»ads
 = 64;

114 cÚ¡ 
size_t
 
	gkCouÁ
 = 256;

115 cÚ¡‡utØ
	gş›Á
 = 
¡d
::
make_sh¬ed
<
MockedEnşaveCl›Á
>();

116 
	gMockedEnşaveCl›Á
::
MockEx™HªdËrC®lback
 
ÿÎbacks
[
kTh»ads
];

117 
size_t
 
	gi
 = 0; i < 
	gkTh»ads
; ++i) {

118 
EXPECT_CALL
(
ÿÎbacks
[
i
], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(
kCouÁ
);

120 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

121 
	gth»ads
.
»£rve
(
kTh»ads
);

122 
size_t
 
	gi
 = 0; i < 
	gkTh»ads
; ++i) {

123 
	gth»ads
.
em¶aû_back
([
i
, &
ş›Á
, &
ÿÎbacks
] {

124 
¡d
::
mt19937
 
¿nd_’gše
;

125 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt64_t
> 
¿nd_g’
(10, 100);

126 
ab¦
::
SË•FÜ
×b¦::
Mli£cÚds
(
¿nd_g’
(
¿nd_’gše
)));

127 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

128 
i
, 
Ex™HªdËr
{
ÿÎbacks
[i].
AsStdFunùiÚ
()}),

129 
IsOk
());

130 
N©iveP¬am‘”Sck
 
·¿ms
;

131 
size_t
 
c
 = 0; c < 
kCouÁ
; ++c) {

132 
ab¦
::
SË•FÜ
×b¦::
Mli£cÚds
(
¿nd_g’
(
¿nd_’gše
)));

133 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

134 
i
, &
·¿ms
, 
ş›Á
.
g‘
()),

135 
IsOk
());

139 autØ&
	gth»ad
 : 
th»ads
) {

140 
th»ad
.
Još
();

	@platform/primitives/util/dispatch_table_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/di¥©ch_bË.h
"

21 
	~<c¡dlib
>

22 
	~<memÜy
>

23 
	~<¿ndom
>

24 
	~<th»ad
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"ab¦/time/şock.h
"

30 
	~"ab¦/time/time.h
"

31 
	~"asylo/¶©fÜm/´im™ives/·¿m‘”_¡ack.h
"

32 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
	~"asylo/ut/th»ad.h
"

36 
	gusšg
 ::
‹¡šg
::
_
;

37 
	gusšg
 ::
‹¡šg
::
Eq
;

38 
	gusšg
 ::
‹¡šg
::
MockFunùiÚ
;

40 
Çme¥aû
 
	gasylo
 {

41 
Çme¥aû
 
	g´im™ives
 {

42 
	gÇme¥aû
 {

44 şas 
	cMockedEnşaveCl›Á
 : 
public
 
Cl›Á
 {

45 
public
:

46 
usšg
 
MockEx™HªdËrC®lback
 =

47 
MockFunùiÚ
<
Stus
(
¡d
::
sh¬ed_±r
<
şass
 
Cl›Á
> 
’şave
, *,

48 
N©iveP¬am‘”Sck
 *
·¿ms
)>;

50 
MockedEnşaveCl›Á
(è: 
Cl›Á
(

51  "mock_’şave", 
ab¦
::
make_unique
<
Di¥©chTabË
>()) {}

54 
boŞ
 
IsClo£d
(ècÚ¡ 
ov”ride
 {  
çl£
; }

55 
Stus
 
De¡roy
(è
	gov”ride
 {  
	gStus
::
OkStus
(); }

56 
Stus
 
EnşaveC®lIÁ”Çl
(
ušt64_t
 
£ËùÜ
,

57 
N©iveP¬am‘”Sck
 *
·¿ms
è
	gov”ride
 {

58  
	gStus
::
OkStus
();

62 
TEST
(
Di¥©chTabËTe¡
, 
HªdËrsRegi¡¿tiÚ
) {

63 
Di¥©chTabË
 
	gdi¥©ch_bË
;

64 
	gMockedEnşaveCl›Á
::
MockEx™HªdËrC®lback
 
ÿÎback
;

65 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

66 0, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

67 
IsOk
());

68 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

69 10, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

70 
IsOk
());

71 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

72 0, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

73 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

74 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

75 10, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

76 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
ALREADY_EXISTS
));

77 
ASSERT_THAT
(
di¥©ch_bË
.
Regi¡”Ex™HªdËr
(

78 20, 
Ex™HªdËr
{
ÿÎback
.
AsStdFunùiÚ
()}),

79 
IsOk
());

82 
TEST
(
Di¥©chTabËTe¡
, 
HªdËrsInvoÿtiÚ
) {

83 cÚ¡‡utØ
	gş›Á
 = 
¡d
::
make_sh¬ed
<
MockedEnşaveCl›Á
>();

84 
	gMockedEnşaveCl›Á
::
MockEx™HªdËrC®lback
 
ÿÎbacks
[3];

85 
EXPECT_CALL
(
ÿÎbacks
[0], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(2);

86 
EXPECT_CALL
(
ÿÎbacks
[1], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(1);

87 
EXPECT_CALL
(
ÿÎbacks
[2], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(0);

88 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

89 0, 
Ex™HªdËr
{
ÿÎbacks
[0].
AsStdFunùiÚ
()}),

90 
IsOk
());

91 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

92 10, 
Ex™HªdËr
{
ÿÎbacks
[1].
AsStdFunùiÚ
()}),

93 
IsOk
());

94 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

95 20, 
Ex™HªdËr
{
ÿÎbacks
[2].
AsStdFunùiÚ
()}),

96 
IsOk
());

97 
N©iveP¬am‘”Sck
 
	g·¿ms
;

98 
EXPECT_THAT
(

99 
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(0, &
·¿ms
, cl›Á.
g‘
()),

100 
IsOk
());

101 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(10, &
·¿ms
,

102 
ş›Á
.
g‘
()),

103 
IsOk
());

104 
EXPECT_THAT
(

105 
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(0, &
·¿ms
, cl›Á.
g‘
()),

106 
IsOk
());

107 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(30, &
·¿ms
,

108 
ş›Á
.
g‘
()),

109 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

112 
TEST
(
Di¥©chTabËTe¡
, 
HªdËrsInMuÉËTh»ads
) {

113 cÚ¡ 
size_t
 
	gkTh»ads
 = 64;

114 cÚ¡ 
size_t
 
	gkCouÁ
 = 256;

115 cÚ¡‡utØ
	gş›Á
 = 
¡d
::
make_sh¬ed
<
MockedEnşaveCl›Á
>();

116 
	gMockedEnşaveCl›Á
::
MockEx™HªdËrC®lback
 
ÿÎbacks
[
kTh»ads
];

117 
size_t
 
	gi
 = 0; i < 
	gkTh»ads
; ++i) {

118 
EXPECT_CALL
(
ÿÎbacks
[
i
], 
C®l
(
Eq
(
ş›Á
), 
_
, _)).
Times
(
kCouÁ
);

120 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

121 
	gth»ads
.
»£rve
(
kTh»ads
);

122 
size_t
 
	gi
 = 0; i < 
	gkTh»ads
; ++i) {

123 
	gth»ads
.
em¶aû_back
([
i
, &
ş›Á
, &
ÿÎbacks
] {

124 
¡d
::
mt19937
 
¿nd_’gše
;

125 
¡d
::
unifÜm_št_di¡ributiÚ
<
ušt64_t
> 
¿nd_g’
(10, 100);

126 
ab¦
::
SË•FÜ
×b¦::
Mli£cÚds
(
¿nd_g’
(
¿nd_’gše
)));

127 
ASSERT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
Regi¡”Ex™HªdËr
(

128 
i
, 
Ex™HªdËr
{
ÿÎbacks
[i].
AsStdFunùiÚ
()}),

129 
IsOk
());

130 
N©iveP¬am‘”Sck
 
·¿ms
;

131 
size_t
 
c
 = 0; c < 
kCouÁ
; ++c) {

132 
ab¦
::
SË•FÜ
×b¦::
Mli£cÚds
(
¿nd_g’
(
¿nd_’gše
)));

133 
EXPECT_THAT
(
ş›Á
->
ex™_ÿÎ_´ovid”
()->
InvokeEx™HªdËr
(

134 
i
, &
·¿ms
, 
ş›Á
.
g‘
()),

135 
IsOk
());

139 autØ&
	gth»ad
 : 
th»ads
) {

140 
th»ad
.
Još
();

	@platform/primitives/util/message.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_UTIL_MESSAGE_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_UTIL_MESSAGE_H_


	)

22 
	~<c¡ršg
>

23 
	~<funùiÚ®
>

24 
	~<memÜy
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g´im™ives
 {

44 şas 
	cMes§geWr™”
 {

45 
	gpublic
:

46 
Mes§geWr™”
() = ;

49 
Mes§geWr™”
(cÚ¡ Mes§geWr™” &
Ùh”
èğ
d–‘e
;

50 
Mes§geWr™”
 
	gİ”©Ü
=(cÚ¡ Mes§geWr™” &
Ùh”
èğ
d–‘e
;

53 
Mes§geWr™”
(Mes§geWr™” &&
Ùh”
è
	gnÛxû±
 = ;

54 
	gMes§geWr™”
 &
	gİ”©Ü
=(
Mes§geWr™”
 &&
Ùh”
) = ;

57 
boŞ
 
em±y
(ècÚ¡ {  
	gex‹Ás_
.empty(); }

60 
size_t
 
size
(ècÚ¡ {  
	gex‹Ás_
.size(); }

63 
size_t
 
Mes§geSize
() const {

64 
size_t
 
	g»suÉ
 = (
ušt64_t
è* 
ex‹Ás_
.
size
();

65 cÚ¡‡utØ&
	gex‹Á
 : 
ex‹Ás_
) {

66 
»suÉ
 +ğ
ex‹Á
.
size
();

68  
	g»suÉ
;

75 
Wr™e
(*
mes§ge
) const {

76 autØ
	g±r
 = 
»š‹½»t_ÿ¡
<*>(
mes§ge
);

77 cÚ¡‡utØ&
	gex‹Á
 : 
ex‹Ás_
) {

78 
ušt64_t
 
size
 = 
ex‹Á
.size();

80 
memıy
(
±r
, &
size
, (
ušt64_t
));

81 
	g±r
 +ğ(
ušt64_t
);

82 
memıy
(
±r
, 
ex‹Á
.
d©a
(), 
size
);

83 
	g±r
 +ğ
size
;

88 
PushByReã»nû
(
Ex‹Á
 
ex‹Á
è{ 
	gex‹Ás_
.
em¶aû_back
(extent); }

92 
PushByCİy
(
Ex‹Á
 
ex‹Á
) {

93 *
	gex‹Á_d©a
 = 
Ãw
 [
ex‹Á
.
size
()];

94 
	gcİ›d_d©a_owÃr_
.
em¶aû_back
(
ex‹Á_d©a
);

95 
memıy
(
ex‹Á_d©a
, 
ex‹Á
.
d©a
(),ƒx‹Á.
size
());

96 
PushByReã»nû
(
Ex‹Á
{
ex‹Á_d©a
, 
ex‹Á
.
size
()});

102 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

103 
Push
(cÚ¡ 
T
 &
v®ue
) {

104 
¡©ic_as£¹
(!
¡d
::
is_poš‹r
<
T
>::
v®ue
,

106 
PushByCİy
(
Ex‹Á
{
cÚ¡_ÿ¡
<
T
 *>(&
v®ue
)});

111 
Push
(cÚ¡ 
¡d
::
¡ršg
 &
s
) {

112 
PushByCİy
(
Ex‹Á
{
s
.
c_¡r
(), s.
size
() + 1});

115 
	g´iv©e
:

116 
¡d
::
veùÜ
<
Ex‹Á
> 
ex‹Ás_
;

117 
	g¡d
::
veùÜ
<
¡d
::
unique_±r
<[]>> 
cİ›d_d©a_owÃr_
;

123 şas 
	cMes§geR—d”
 {

124 
	gpublic
:

125 
Mes§geR—d”
() = ;

128 
Mes§geR—d”
(cÚ¡ Mes§geR—d” &
Ùh”
èğ
d–‘e
;

129 
Mes§geR—d”
 
	gİ”©Ü
=(cÚ¡ Mes§geR—d” &
Ùh”
èğ
d–‘e
;

132 
Mes§geR—d”
(Mes§geR—d” &&
Ùh”
è
	gnÛxû±
 = ;

133 
	gMes§geR—d”
 &
	gİ”©Ü
=(
Mes§geR—d”
 &&
Ùh”
) = ;

142 
Mes§geR—d”
(cÚ¡ *
d©a
, 
size_t
 
size
) {

143 cÚ¡ *
	g±r
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(
d©a
);

144 cÚ¡ *
	g’d_±r
 = 
±r
 + 
size
;

145 
	g±r
 < 
	g’d_±r
) {

146 
ušt64_t
 
	gex‹Á_Ën
;

147 
memıy
(&
ex‹Á_Ën
, 
±r
, (
ušt64_t
));

148 
	g±r
 +ğ(
ušt64_t
);

150 *
	gex‹Á_d©a
 = 
Ãw
 [
ex‹Á_Ën
];

151 
	gex‹Ás_
.
em¶aû_back
(
¡d
::
unique_±r
<[]>(
ex‹Á_d©a
), 
ex‹Á_Ën
);

152 
memıy
(
ex‹Á_d©a
, 
±r
, 
ex‹Á_Ën
);

153 
	g±r
 +ğ
ex‹Á_Ën
;

158 
size_t
 
size
(ècÚ¡ {  
	gex‹Ás_
.size(); }

162 
Ex‹Á
 
Ãxt
() {

163 
Ex‹Á
 
	g»suÉ
 = Ex‹Á{
ex‹Ás_
[
pos_
].
fœ¡
.
g‘
(),ƒx‹Ás_[pos_].
£cÚd
};

164 
	gpos_
++;

165  
	g»suÉ
;

168 
	g´iv©e
:

169 
¡d
::
veùÜ
<¡d::
·œ
<¡d::
unique_±r
<[]>, 
	gsize_t
>> 
	gex‹Ás_
;

170 
	gpos_
 = 0;

	@platform/primitives/util/message_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/mes§ge.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
	gusšg
 ::
‹¡šg
::
Eq
;

27 
	gusšg
 ::
‹¡šg
::
SŒEq
;

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g´im™ives
 {

31 
	gÇme¥aû
 {

33 
cÚ¡ex´
 
size_t
 
	gkNumP¬ams
 = 10;

35 
TEST
(
Mes§geTe¡
, 
Em±yWr™”R—d”Te¡
) {

36 
Mes§geWr™”
 
	gwr™”
;

37 
EXPECT_TRUE
(
wr™”
.
em±y
());

38 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(0));

40 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

41 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

42 
	gwr™”
.
Wr™e
(
mes§ge
);

44 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

45 
ä“
(
mes§ge
);

46 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(0));

49 
TEST
(
Mes§geTe¡
, 
PushPİD©aByV®ue
) {

50 
Mes§geWr™”
 
	gwr™”
;

51 
	gwr™”
.
PushByCİy
(
Ex‹Á
{"h–lo", 
¡¾’
("hello") + 1});

52 
	gwr™”
.
PushByCİy
(
Ex‹Á
{"wÜld", 
¡¾’
("world") + 1});

53 
	gwr™”
.
Push
(1);

54 
	gwr™”
.
Push
(2);

56 
EXPECT_FALSE
(
wr™”
.
em±y
());

57 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(4));

59 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

60 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

61 
	gwr™”
.
Wr™e
(
mes§ge
);

63 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

64 
ä“
(
mes§ge
);

66 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(4));

67 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
("hello"));

68 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
("world"));

69 
EXPECT_THAT
(*(
»ad”
.
Ãxt
().
As
<>()), 
Eq
(1));

70 
EXPECT_THAT
(*(
»ad”
.
Ãxt
().
As
<>()), 
Eq
(2));

73 
TEST
(
Mes§geTe¡
, 
PushPİNums
) {

74 
Mes§geWr™”
 
	gwr™”
;

75 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

76 
	gwr™”
.
Push
(
i
);

78 
EXPECT_FALSE
(
wr™”
.
em±y
());

79 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(
kNumP¬ams
));

81 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

82 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

83 
	gwr™”
.
Wr™e
(
mes§ge
);

85 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

86 
ä“
(
mes§ge
);

88 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(
kNumP¬ams
));

89 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

90 
EXPECT_THAT
(*(
»ad”
.
Ãxt
().
As
<>()), 
Eq
(
i
));

94 
TEST
(
Mes§geTe¡
, 
PushByReã»nûTe¡
) {

95 cÚ¡ *
	gh–lo
 = "hello";

96 cÚ¡ *
	gwÜld
 = "world";

97 
Mes§geWr™”
 
	gwr™”
;

98 
	gwr™”
.
PushByReã»nû
(
Ex‹Á
{
h–lo
, 
¡¾’
(hello) + 1});

99 
	gwr™”
.
PushByReã»nû
(
Ex‹Á
{
wÜld
, 
¡¾’
(world) + 1});

101 
EXPECT_FALSE
(
wr™”
.
em±y
());

102 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(2));

104 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

105 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

106 
	gwr™”
.
Wr™e
(
mes§ge
);

108 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

109 
ä“
(
mes§ge
);

111 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(2));

112 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
h–lo
));

113 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
wÜld
));

116 
TEST
(
Mes§geTe¡
, 
PushPİSŒšgs
) {

117 
Mes§geWr™”
 
	gwr™”
;

118 
	g¡d
::
¡ršg
 
h–lo
("h–lo"), 
wÜld
("world");

119 
	gwr™”
.
Push
(
h–lo
);

120 
	gwr™”
.
Push
(
wÜld
);

122 
EXPECT_FALSE
(
wr™”
.
em±y
());

123 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(2));

125 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

126 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

127 
	gwr™”
.
Wr™e
(
mes§ge
);

129 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

130 
ä“
(
mes§ge
);

132 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(2));

133 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
h–lo
));

134 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
wÜld
));

	@platform/primitives/util/message_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/mes§ge.h
"

21 
	~<memÜy
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
	gusšg
 ::
‹¡šg
::
Eq
;

27 
	gusšg
 ::
‹¡šg
::
SŒEq
;

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g´im™ives
 {

31 
	gÇme¥aû
 {

33 
cÚ¡ex´
 
size_t
 
	gkNumP¬ams
 = 10;

35 
TEST
(
Mes§geTe¡
, 
Em±yWr™”R—d”Te¡
) {

36 
Mes§geWr™”
 
	gwr™”
;

37 
EXPECT_TRUE
(
wr™”
.
em±y
());

38 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(0));

40 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

41 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

42 
	gwr™”
.
Wr™e
(
mes§ge
);

44 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

45 
ä“
(
mes§ge
);

46 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(0));

49 
TEST
(
Mes§geTe¡
, 
PushPİD©aByV®ue
) {

50 
Mes§geWr™”
 
	gwr™”
;

51 
	gwr™”
.
PushByCİy
(
Ex‹Á
{"h–lo", 
¡¾’
("hello") + 1});

52 
	gwr™”
.
PushByCİy
(
Ex‹Á
{"wÜld", 
¡¾’
("world") + 1});

53 
	gwr™”
.
Push
(1);

54 
	gwr™”
.
Push
(2);

56 
EXPECT_FALSE
(
wr™”
.
em±y
());

57 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(4));

59 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

60 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

61 
	gwr™”
.
Wr™e
(
mes§ge
);

63 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

64 
ä“
(
mes§ge
);

66 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(4));

67 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
("hello"));

68 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
("world"));

69 
EXPECT_THAT
(*(
»ad”
.
Ãxt
().
As
<>()), 
Eq
(1));

70 
EXPECT_THAT
(*(
»ad”
.
Ãxt
().
As
<>()), 
Eq
(2));

73 
TEST
(
Mes§geTe¡
, 
PushPİNums
) {

74 
Mes§geWr™”
 
	gwr™”
;

75 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

76 
	gwr™”
.
Push
(
i
);

78 
EXPECT_FALSE
(
wr™”
.
em±y
());

79 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(
kNumP¬ams
));

81 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

82 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

83 
	gwr™”
.
Wr™e
(
mes§ge
);

85 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

86 
ä“
(
mes§ge
);

88 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(
kNumP¬ams
));

89 
	gi
 = 0; i < 
	gkNumP¬ams
; ++i) {

90 
EXPECT_THAT
(*(
»ad”
.
Ãxt
().
As
<>()), 
Eq
(
i
));

94 
TEST
(
Mes§geTe¡
, 
PushByReã»nûTe¡
) {

95 cÚ¡ *
	gh–lo
 = "hello";

96 cÚ¡ *
	gwÜld
 = "world";

97 
Mes§geWr™”
 
	gwr™”
;

98 
	gwr™”
.
PushByReã»nû
(
Ex‹Á
{
h–lo
, 
¡¾’
(hello) + 1});

99 
	gwr™”
.
PushByReã»nû
(
Ex‹Á
{
wÜld
, 
¡¾’
(world) + 1});

101 
EXPECT_FALSE
(
wr™”
.
em±y
());

102 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(2));

104 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

105 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

106 
	gwr™”
.
Wr™e
(
mes§ge
);

108 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

109 
ä“
(
mes§ge
);

111 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(2));

112 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
h–lo
));

113 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
wÜld
));

116 
TEST
(
Mes§geTe¡
, 
PushPİSŒšgs
) {

117 
Mes§geWr™”
 
	gwr™”
;

118 
	g¡d
::
¡ršg
 
h–lo
("h–lo"), 
wÜld
("world");

119 
	gwr™”
.
Push
(
h–lo
);

120 
	gwr™”
.
Push
(
wÜld
);

122 
EXPECT_FALSE
(
wr™”
.
em±y
());

123 
EXPECT_THAT
(
wr™”
.
size
(), 
Eq
(2));

125 
size_t
 
	gmes§ge_Ën
 = 
wr™”
.
Mes§geSize
();

126 *
	gmes§ge
 = 
m®loc
(
mes§ge_Ën
);

127 
	gwr™”
.
Wr™e
(
mes§ge
);

129 
Mes§geR—d”
 
»ad”
(
mes§ge
, 
mes§ge_Ën
);

130 
ä“
(
mes§ge
);

132 
EXPECT_THAT
(
»ad”
.
size
(), 
Eq
(2));

133 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
h–lo
));

134 
EXPECT_THAT
(
»ad”
.
Ãxt
().
As
<>(), 
SŒEq
(
wÜld
));

	@platform/primitives/util/primitive_locks.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_UTIL_PRIMITIVE_LOCKS_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_UTIL_PRIMITIVE_LOCKS_H_


	)

22 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g´im™ives
 {

29 şas 
	cSpšLockGu¬d
 {

30 
	gpublic
:

31 
ex¶ic™
 
SpšLockGu¬d
(
asylo_¥šlock_t
 *
lock
è: 
lock_
(lock) {

32 
asylo_¥š_lock
(
lock_
);

34 ~
SpšLockGu¬d
(è{ 
asylo_¥š_uÆock
(
lock_
); }

36 
	g´iv©e
:

37 
asylo_¥šlock_t
 *
lock_
;

	@platform/primitives/util/status_conversions.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g´im™ives
 {

24 
Prim™iveStus
 
MakePrim™iveStus
(cÚ¡ 
Stus
& 
¡©us
) {

25 ià(
	g¡©us
.
”rÜ_¥aû
(è!ğ
”rÜ
::
GoogËE¼ÜS·û
::
G‘In¡ªû
()) {

26 
¡d
::
¡ršg
 
”rÜ_mes§ge
 = 
ab¦
::
SŒC©
(

27 "Could‚Ù cÚv”ˆ”rÜ s·û '", 
¡©us
.
”rÜ_¥aû
()->
S·ûName
(),

29 
¡©us
.
ToSŒšg
());

31  
Prim™iveStus
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
, 
”rÜ_mes§ge
);

34  
	gPrim™iveStus
{
	g¡©us
.
”rÜ_code
(), stus.
”rÜ_mes§ge
().
d©a
(),

35 
	g¡©us
.
”rÜ_mes§ge
().
size
()};

38 
Stus
 
MakeStus
(cÚ¡ 
Prim™iveStus
& 
´im™iveStus
) {

39  
	gStus
{
	g”rÜ
::
GoogËE¼ÜS·û
::
G‘In¡ªû
(),

40 
	g´im™iveStus
.
”rÜ_code
(),…rim™iveStus.
”rÜ_mes§ge
()};

	@platform/primitives/util/status_conversions.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g´im™ives
 {

24 
Prim™iveStus
 
MakePrim™iveStus
(cÚ¡ 
Stus
& 
¡©us
) {

25 ià(
	g¡©us
.
”rÜ_¥aû
(è!ğ
”rÜ
::
GoogËE¼ÜS·û
::
G‘In¡ªû
()) {

26 
¡d
::
¡ršg
 
”rÜ_mes§ge
 = 
ab¦
::
SŒC©
(

27 "Could‚Ù cÚv”ˆ”rÜ s·û '", 
¡©us
.
”rÜ_¥aû
()->
S·ûName
(),

29 
¡©us
.
ToSŒšg
());

31  
Prim™iveStus
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
, 
”rÜ_mes§ge
);

34  
	gPrim™iveStus
{
	g¡©us
.
”rÜ_code
(), stus.
”rÜ_mes§ge
().
d©a
(),

35 
	g¡©us
.
”rÜ_mes§ge
().
size
()};

38 
Stus
 
MakeStus
(cÚ¡ 
Prim™iveStus
& 
´im™iveStus
) {

39  
	gStus
{
	g”rÜ
::
GoogËE¼ÜS·û
::
G‘In¡ªû
(),

40 
	g´im™iveStus
.
”rÜ_code
(),…rim™iveStus.
”rÜ_mes§ge
()};

	@platform/primitives/util/status_conversions.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_UTIL_STATUS_CONVERSIONS_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_UTIL_STATUS_CONVERSIONS_H_


	)

22 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	g´im™ives
 {

29 
Prim™iveStus
 
MakePrim™iveStus
(cÚ¡ 
Stus
 &
¡©us
);

32 
Stus
 
MakeStus
(cÚ¡ 
Prim™iveStus
 &
´im™iveStus
);

	@platform/primitives/util/status_conversions_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
	gusšg
 ::
‹¡šg
::
Eq
;

24 
	gusšg
 ::
‹¡šg
::
SŒEq
;

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g´im™ives
 {

28 
	gÇme¥aû
 {

30 şas 
	cStusCÚv”siÚsTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

31 
´Ùeùed
:

32 
NÚGoogËE¼Ü
 : { 
OK
 = 0, 
	gNOT_OK
 = 1 };

34 şas 
	cNÚGoogËE¼ÜS·û
 : 
public
 
”rÜ
::
E¼ÜS·û
 {

35 
public
:

36 
¡d
::
¡ršg
 
S·ûName
(ècÚ¡ 
ov”ride
 {  
¥aû_Çme_
; }

37 
	g¡d
::
¡ršg
 
SŒšg
(
code
ècÚ¡ 
ov”ride
 {  "OK"; }

38 
	g”rÜ
::
GoogËE¼Ü
 
GoogËE¼ÜCode
(
code
ècÚ¡ 
ov”ride
 {

39  
”rÜ
::
GoogËE¼Ü
::
OK
;

42 
ex¶ic™
 
NÚGoogËE¼ÜS·û
(è: 
¥aû_Çme_
{"non-googleƒrror space"} {}

44 
E¼ÜS·û
 cÚ¡ *
G‘In¡ªû
() {

45 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
NÚGoogËE¼ÜS·û
();

46  
	gš¡ªû
;

49 
	g´iv©e
:

50 cÚ¡ 
¡d
::
¡ršg
 
¥aû_Çme_
;

53 cÚ¡ *
	g”rÜ_mes§ge_
 = "someƒrror message";

55 
	g”rÜ
::
E¼ÜS·û
 cÚ¡ *
googË_”rÜ_¥aû_
 =

56 
”rÜ
::
GoogËE¼ÜS·û
::
G‘In¡ªû
();

58 
Prim™iveStus
 
	g»ã»nû_´im™ive_¡©us_
{
	g”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

59 
	g”rÜ_mes§ge_
};

60 
Stus
 
	g»ã»nû_googË_”rÜ_¡©us_
 =

61 
Stus
(
googË_”rÜ_¥aû_
, 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
”rÜ_mes§ge_
);

62 
Stus
 
	g»ã»nû_nÚ_googË_”rÜ_¡©us_
 =

63 
Stus
(
NÚGoogËE¼ÜS·û
::
G‘In¡ªû
(), 
NÚGoogËE¼Ü
::
NOT_OK
,

64 
”rÜ_mes§ge_
);

68 
TEST_F
(
StusCÚv”siÚsTe¡
, 
V®id©eStus
) {

69 
Stus
 
	gg’”©edStus
 = 
MakeStus
(
»ã»nû_´im™ive_¡©us_
);

71 
EXPECT_THAT
(
g’”©edStus
.
”rÜ_code
(),

72 
Eq
(
»ã»nû_´im™ive_¡©us_
.
”rÜ_code
()));

73 
EXPECT_THAT
(
g’”©edStus
.
”rÜ_¥aû
(), 
Eq
(
googË_”rÜ_¥aû_
));

74 
EXPECT_THAT
(
g’”©edStus
.
”rÜ_mes§ge
(),

75 
Eq
(
»ã»nû_´im™ive_¡©us_
.
”rÜ_mes§ge
()));

80 
TEST_F
(
StusCÚv”siÚsTe¡
, 
Prim™iveStusTe¡FÜStusInGoogËE¼Ü
) {

81 
Prim™iveStus
 
	gg’”©edPrim™iveStus
 =

82 
MakePrim™iveStus
(
»ã»nû_googË_”rÜ_¡©us_
);

83 
EXPECT_THAT
(
g’”©edPrim™iveStus
.
”rÜ_code
(),

84 
Eq
(
»ã»nû_googË_”rÜ_¡©us_
.
”rÜ_code
()));

85 
EXPECT_THAT
(
g’”©edPrim™iveStus
.
”rÜ_mes§ge
(),

86 
Eq
(
»ã»nû_googË_”rÜ_¡©us_
.
”rÜ_mes§ge
()));

91 
TEST_F
(
StusCÚv”siÚsTe¡
, 
Prim™iveStusTe¡FÜStusNÙInGoogËE¼Ü
) {

92 
Prim™iveStus
 
	gg’”©edPrim™iveStus
 =

93 
MakePrim™iveStus
(
»ã»nû_nÚ_googË_”rÜ_¡©us_
);

95 
EXPECT_THAT
(
g’”©edPrim™iveStus
.
”rÜ_code
(),

96 
Eq
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

97 
EXPECT_THAT
(
¡d
::
¡ršg
(
g’”©edPrim™iveStus
.
”rÜ_mes§ge
()),

98 
SŒEq
(
ab¦
::
SŒC©
(

100 
»ã»nû_nÚ_googË_”rÜ_¡©us_
.
”rÜ_¥aû
()->
S·ûName
(),

103 
»ã»nû_nÚ_googË_”rÜ_¡©us_
.
ToSŒšg
())));

	@platform/primitives/util/status_conversions_test.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/¡©us_cÚv”siÚs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
	gusšg
 ::
‹¡šg
::
Eq
;

24 
	gusšg
 ::
‹¡šg
::
SŒEq
;

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g´im™ives
 {

28 
	gÇme¥aû
 {

30 şas 
	cStusCÚv”siÚsTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

31 
´Ùeùed
:

32 
NÚGoogËE¼Ü
 : { 
OK
 = 0, 
	gNOT_OK
 = 1 };

34 şas 
	cNÚGoogËE¼ÜS·û
 : 
public
 
”rÜ
::
E¼ÜS·û
 {

35 
public
:

36 
¡d
::
¡ršg
 
S·ûName
(ècÚ¡ 
ov”ride
 {  
¥aû_Çme_
; }

37 
	g¡d
::
¡ršg
 
SŒšg
(
code
ècÚ¡ 
ov”ride
 {  "OK"; }

38 
	g”rÜ
::
GoogËE¼Ü
 
GoogËE¼ÜCode
(
code
ècÚ¡ 
ov”ride
 {

39  
”rÜ
::
GoogËE¼Ü
::
OK
;

42 
ex¶ic™
 
NÚGoogËE¼ÜS·û
(è: 
¥aû_Çme_
{"non-googleƒrror space"} {}

44 
E¼ÜS·û
 cÚ¡ *
G‘In¡ªû
() {

45 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
NÚGoogËE¼ÜS·û
();

46  
	gš¡ªû
;

49 
	g´iv©e
:

50 cÚ¡ 
¡d
::
¡ršg
 
¥aû_Çme_
;

53 cÚ¡ *
	g”rÜ_mes§ge_
 = "someƒrror message";

55 
	g”rÜ
::
E¼ÜS·û
 cÚ¡ *
googË_”rÜ_¥aû_
 =

56 
”rÜ
::
GoogËE¼ÜS·û
::
G‘In¡ªû
();

58 
Prim™iveStus
 
	g»ã»nû_´im™ive_¡©us_
{
	g”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

59 
	g”rÜ_mes§ge_
};

60 
Stus
 
	g»ã»nû_googË_”rÜ_¡©us_
 =

61 
Stus
(
googË_”rÜ_¥aû_
, 
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
”rÜ_mes§ge_
);

62 
Stus
 
	g»ã»nû_nÚ_googË_”rÜ_¡©us_
 =

63 
Stus
(
NÚGoogËE¼ÜS·û
::
G‘In¡ªû
(), 
NÚGoogËE¼Ü
::
NOT_OK
,

64 
”rÜ_mes§ge_
);

68 
TEST_F
(
StusCÚv”siÚsTe¡
, 
V®id©eStus
) {

69 
Stus
 
	gg’”©edStus
 = 
MakeStus
(
»ã»nû_´im™ive_¡©us_
);

71 
EXPECT_THAT
(
g’”©edStus
.
”rÜ_code
(),

72 
Eq
(
»ã»nû_´im™ive_¡©us_
.
”rÜ_code
()));

73 
EXPECT_THAT
(
g’”©edStus
.
”rÜ_¥aû
(), 
Eq
(
googË_”rÜ_¥aû_
));

74 
EXPECT_THAT
(
g’”©edStus
.
”rÜ_mes§ge
(),

75 
Eq
(
»ã»nû_´im™ive_¡©us_
.
”rÜ_mes§ge
()));

80 
TEST_F
(
StusCÚv”siÚsTe¡
, 
Prim™iveStusTe¡FÜStusInGoogËE¼Ü
) {

81 
Prim™iveStus
 
	gg’”©edPrim™iveStus
 =

82 
MakePrim™iveStus
(
»ã»nû_googË_”rÜ_¡©us_
);

83 
EXPECT_THAT
(
g’”©edPrim™iveStus
.
”rÜ_code
(),

84 
Eq
(
»ã»nû_googË_”rÜ_¡©us_
.
”rÜ_code
()));

85 
EXPECT_THAT
(
g’”©edPrim™iveStus
.
”rÜ_mes§ge
(),

86 
Eq
(
»ã»nû_googË_”rÜ_¡©us_
.
”rÜ_mes§ge
()));

91 
TEST_F
(
StusCÚv”siÚsTe¡
, 
Prim™iveStusTe¡FÜStusNÙInGoogËE¼Ü
) {

92 
Prim™iveStus
 
	gg’”©edPrim™iveStus
 =

93 
MakePrim™iveStus
(
»ã»nû_nÚ_googË_”rÜ_¡©us_
);

95 
EXPECT_THAT
(
g’”©edPrim™iveStus
.
”rÜ_code
(),

96 
Eq
(
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
));

97 
EXPECT_THAT
(
¡d
::
¡ršg
(
g’”©edPrim™iveStus
.
”rÜ_mes§ge
()),

98 
SŒEq
(
ab¦
::
SŒC©
(

100 
»ã»nû_nÚ_googË_”rÜ_¡©us_
.
”rÜ_¥aû
()->
S·ûName
(),

103 
»ã»nû_nÚ_googË_”rÜ_¡©us_
.
ToSŒšg
())));

	@platform/primitives/util/trusted_memory.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_UTIL_TRUSTED_MEMORY_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_UTIL_TRUSTED_MEMORY_H_


	)

22 
	~<memÜy
>

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

30 "C" 
uÁru¡ed_ÿche_ä“
(*
bufãr
);

32 
Çme¥aû
 
	gasylo
 {

36 
	sUÁru¡edD–‘”
 {

37 
šlše
 
İ”©Ü
()(*
	g±r
ècÚ¡ { 
uÁru¡ed_ÿche_ä“
(
±r
); }

40 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

41 
usšg
 
	gUÁru¡edUniquePŒ
 = 
¡d
::
unique_±r
<
T
, 
	gUÁru¡edD–‘”
>;

45 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

46 
boŞ
 
IsV®idEnşaveAdd»ss
(cÚ¡ 
T
 *
poš‹r
) {

47 ià(
	gpoš‹r
 =ğ
nuÎ±r
 || !
’c_is_w™hš_’şave
(
poš‹r
, (*pointer))) {

48  
	gçl£
;

50  
	gŒue
;

	@platform/primitives/util/trusted_runtime_helper.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_ruÁime_h–³r.h
"

21 
	~<uni¡d.h
>

23 
	~<c¡dio
>

24 
	~<c¡ršg
>

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

27 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

28 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

29 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

30 
	~"asylo/¶©fÜm/´im™ives/ut/´im™ive_locks.h
"

31 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	g´im™ives
 {

36 
	gÇme¥aû
 {

39 
cÚ¡ex´
 
size_t
 
	gkEÁryPoštMax
 = 4096;

42 
	gFÏg
 : 
ušt64_t
 { 
kIn™Ÿlized
 = 0x1, 
	gkAbÜ‹d
 = 0x2 };

48 
asylo_¥šlock_t
 
	gš™Ÿliz©iÚ_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

51 
ušt64_t
 
	gæags
 = 0;

54 
asylo_¥šlock_t
 
	gæags_wr™e_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

57 
EÁryHªdËr
 
	g’Œy_bË
[
kEÁryPoštMax
];

60 
asylo_¥šlock_t
 
	g’Œy_bË_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

61 } 
	g’şave_¡©e
;

64 
Upd©eEnşaveS‹
(cÚ¡ 
FÏg
 &
æag
) {

65 
SpšLockGu¬d
 
lock
(&
’şave_¡©e
.
æags_wr™e_lock
);

66 
	g’şave_¡©e
.
	gæags
 |ğ
æag
;

69 
Prim™iveStus
 
Re£rvedEÁry
(

70 * , 
Tru¡edP¬am‘”Sck
* ) {

71  {
	g”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Invalid callo„eserved selector."};

75 
Ensu»In™Ÿlized
() {

76 
SpšLockGu¬d
 
lock
(&
’şave_¡©e
.
š™Ÿliz©iÚ_lock
);

77 ià(!(
	g’şave_¡©e
.
	gæags
 & 
	gFÏg
::
kIn™Ÿlized
)) {

79 
ušt64_t
 
i
 = 
kS–eùÜAsyloFši
 + 1; 
	gi
 < 
	gkS–eùÜU£r
; i++) {

80 
EÁryHªdËr
 
	ghªdËr
{
	gRe£rvedEÁry
};

81 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
i
, 
hªdËr
).
ok
()) {

82 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

87 ià(!
’c_š™
().
ok
()) {

88 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("enc_init()„eturned failure.");

93 
Regi¡”IÁ”ÇlHªdËrs
();

95 
M¬kEnşaveIn™Ÿlized
();

101 
Prim™iveStus
 
Regi¡”EÁryHªdËr
(

102 
ušt64_t
 
Œu¡ed_£ËùÜ
, cÚ¡ 
EÁryHªdËr
 &
hªdËr
) {

103 
SpšLockGu¬d
 
lock
(&
’şave_¡©e
.
’Œy_bË_lock
);

104 ià(
	gŒu¡ed_£ËùÜ
 >ğ
kEÁryPoštMax
 ||

105 !
’şave_¡©e
.
’Œy_bË
[
Œu¡ed_£ËùÜ
].
IsNuÎ
()) {

106  {
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

110 
	g’şave_¡©e
.
	g’Œy_bË
[
Œu¡ed_£ËùÜ
] = 
hªdËr
;

111  
	gPrim™iveStus
::
OkStus
();

114 
Prim™iveStus
 
InvokeEÁryHªdËr
(
ušt64_t
 
£ËùÜ
,

115 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

117 
Ensu»In™Ÿlized
();

120 ià(
	g’şave_¡©e
.
	gæags
 & 
	gFÏg
::
kAbÜ‹d
) {

121  {
”rÜ
::
GoogËE¼Ü
::
ABORTED
, "Invalid callo‡bortedƒnclave."};

125 ià(
	g£ËùÜ
 >ğ
kEÁryPoštMax


126 || 
’şave_¡©e
.
’Œy_bË
[
£ËùÜ
].
IsNuÎ
()) {

127  {
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

132 autØ&
	ghªdËr
 = 
’şave_¡©e
.
’Œy_bË
[
£ËùÜ
];

133  
	ghªdËr
.
ÿÎback
(
hªdËr
.
cÚ‹xt
, 
·¿ms
);

136 
M¬kEnşaveIn™Ÿlized
() {

137 
Upd©eEnşaveS‹
(
FÏg
::
kIn™Ÿlized
);

140 
M¬kEnşaveAbÜ‹d
() {

141 
Upd©eEnşaveS‹
(
FÏg
::
kAbÜ‹d
);

	@platform/primitives/util/trusted_runtime_helper.cc

19 
	~"asylo/¶©fÜm/´im™ives/ut/Œu¡ed_ruÁime_h–³r.h
"

21 
	~<uni¡d.h
>

23 
	~<c¡dio
>

24 
	~<c¡ršg
>

26 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

27 
	~"asylo/¶©fÜm/´im™ives/´im™ives.h
"

28 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

29 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

30 
	~"asylo/¶©fÜm/´im™ives/ut/´im™ive_locks.h
"

31 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	g´im™ives
 {

36 
	gÇme¥aû
 {

39 
cÚ¡ex´
 
size_t
 
	gkEÁryPoštMax
 = 4096;

42 
	gFÏg
 : 
ušt64_t
 { 
kIn™Ÿlized
 = 0x1, 
	gkAbÜ‹d
 = 0x2 };

48 
asylo_¥šlock_t
 
	gš™Ÿliz©iÚ_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

51 
ušt64_t
 
	gæags
 = 0;

54 
asylo_¥šlock_t
 
	gæags_wr™e_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

57 
EÁryHªdËr
 
	g’Œy_bË
[
kEÁryPoštMax
];

60 
asylo_¥šlock_t
 
	g’Œy_bË_lock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

61 } 
	g’şave_¡©e
;

64 
Upd©eEnşaveS‹
(cÚ¡ 
FÏg
 &
æag
) {

65 
SpšLockGu¬d
 
lock
(&
’şave_¡©e
.
æags_wr™e_lock
);

66 
	g’şave_¡©e
.
	gæags
 |ğ
æag
;

69 
Prim™iveStus
 
Re£rvedEÁry
(

70 * , 
Tru¡edP¬am‘”Sck
* ) {

71  {
	g”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Invalid callo„eserved selector."};

75 
Ensu»In™Ÿlized
() {

76 
SpšLockGu¬d
 
lock
(&
’şave_¡©e
.
š™Ÿliz©iÚ_lock
);

77 ià(!(
	g’şave_¡©e
.
	gæags
 & 
	gFÏg
::
kIn™Ÿlized
)) {

79 
ušt64_t
 
i
 = 
kS–eùÜAsyloFši
 + 1; 
	gi
 < 
	gkS–eùÜU£r
; i++) {

80 
EÁryHªdËr
 
	ghªdËr
{
	gRe£rvedEÁry
};

81 ià(!
	gTru¡edPrim™ives
::
Regi¡”EÁryHªdËr
(
i
, 
hªdËr
).
ok
()) {

82 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("Could‚ot„egisterƒntry handler");

87 ià(!
’c_š™
().
ok
()) {

88 
	gTru¡edPrim™ives
::
Be¡EffÜtAbÜt
("enc_init()„eturned failure.");

93 
Regi¡”IÁ”ÇlHªdËrs
();

95 
M¬kEnşaveIn™Ÿlized
();

101 
Prim™iveStus
 
Regi¡”EÁryHªdËr
(

102 
ušt64_t
 
Œu¡ed_£ËùÜ
, cÚ¡ 
EÁryHªdËr
 &
hªdËr
) {

103 
SpšLockGu¬d
 
lock
(&
’şave_¡©e
.
’Œy_bË_lock
);

104 ià(
	gŒu¡ed_£ËùÜ
 >ğ
kEÁryPoštMax
 ||

105 !
’şave_¡©e
.
’Œy_bË
[
Œu¡ed_£ËùÜ
].
IsNuÎ
()) {

106  {
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

110 
	g’şave_¡©e
.
	g’Œy_bË
[
Œu¡ed_£ËùÜ
] = 
hªdËr
;

111  
	gPrim™iveStus
::
OkStus
();

114 
Prim™iveStus
 
InvokeEÁryHªdËr
(
ušt64_t
 
£ËùÜ
,

115 
Tru¡edP¬am‘”Sck
 *
·¿ms
) {

117 
Ensu»In™Ÿlized
();

120 ià(
	g’şave_¡©e
.
	gæags
 & 
	gFÏg
::
kAbÜ‹d
) {

121  {
”rÜ
::
GoogËE¼Ü
::
ABORTED
, "Invalid callo‡bortedƒnclave."};

125 ià(
	g£ËùÜ
 >ğ
kEÁryPoštMax


126 || 
’şave_¡©e
.
’Œy_bË
[
£ËùÜ
].
IsNuÎ
()) {

127  {
”rÜ
::
GoogËE¼Ü
::
OUT_OF_RANGE
,

132 autØ&
	ghªdËr
 = 
’şave_¡©e
.
’Œy_bË
[
£ËùÜ
];

133  
	ghªdËr
.
ÿÎback
(
hªdËr
.
cÚ‹xt
, 
·¿ms
);

136 
M¬kEnşaveIn™Ÿlized
() {

137 
Upd©eEnşaveS‹
(
FÏg
::
kIn™Ÿlized
);

140 
M¬kEnşaveAbÜ‹d
() {

141 
Upd©eEnşaveS‹
(
FÏg
::
kAbÜ‹d
);

	@platform/primitives/util/trusted_runtime_helper.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_UTIL_TRUSTED_RUNTIME_HELPER_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_UTIL_TRUSTED_RUNTIME_HELPER_H_


	)

22 
	~<c¡dio
>

24 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_´im™ives.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	g´im™ives
 {

37 
Regi¡”IÁ”ÇlHªdËrs
();

41 
Prim™iveStus
 
Regi¡”EÁryHªdËr
(
ušt64_t
 
Œu¡ed_£ËùÜ
,

42 cÚ¡ 
EÁryHªdËr
 &
hªdËr
);

45 
Prim™iveStus
 
InvokeEÁryHªdËr
(
ušt64_t
 
£ËùÜ
,

46 
Tru¡edP¬am‘”Sck
 *
·¿ms
);

49 
M¬kEnşaveIn™Ÿlized
();

52 
M¬kEnşaveAbÜ‹d
();

	@platform/primitives/x86/spin_lock.h

19 #iâdeà
ASYLO_PLATFORM_PRIMITIVES_X86_SPIN_LOCK_H_


20 
	#ASYLO_PLATFORM_PRIMITIVES_X86_SPIN_LOCK_H_


	)

22 
	~<¡dšt.h
>

24 #ifdeà
__ılu¥lus


33 vŞ©
	tušt32_t
 
	tasylo_¥šlock_t
 
	t__©Œibu‹__
((
	t®igÃd
(64)));

36 
	#ASYLO_SPIN_LOCK_INITIALIZER
 0

	)

45 #´agm¨
GCC
 
dŸgno¡ic
 
push


46 #´agm¨
GCC
 
dŸgno¡ic
 
ignÜed
 "-Wunused-but-set-parameter"

47 
šlše
 
asylo_¥š_uÆock
(
asylo_¥šlock_t
 *
lock
) {

48 
ušt32_t
 
kUÆocked
 = 0;

49 
__©omic_¡Üe
(
lock
, &
kUÆocked
, 
__ATOMIC_RELEASE
);

51 #´agm¨
GCC
 
dŸgno¡ic
 
pİ


56 
šlše
 
boŞ
 
asylo_¥š_Œylock
(
asylo_¥šlock_t
 *
lock
) {

57 
ušt32_t
 
´evious
 = 0;

58 
__©omic_com·»_exchªge_n
(
lock
,

59  &
´evious
,

61  
çl£
,

62  
__ATOMIC_ACQUIRE
,

63  
__ATOMIC_ACQUIRE
);

64  
´evious
 == 0;

71 
šlše
 
asylo_¥š_lock
(
asylo_¥šlock_t
 *
lock
) {

72 !
asylo_¥š_Œylock
(
lock
)) {

73 *
lock
) {

74 
__butš_Ÿ32_·u£
();

79 #ifdeà 
__ılu¥lus


	@platform/primitives/x86/spin_lock_test.cc

19 
	~<th»ad
>

20 
	~<veùÜ
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkMªyTh»ads
 = 128;

31 
TEST
(
LockTe¡
, 
MªyTh»adsTe¡
) {

32 
	gsh¬ed_couÁ”
 = 0;

33 
asylo_¥šlock_t
 
	glock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

34 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

35 
	gth»ads
.
»£rve
(
kMªyTh»ads
);

36 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

37 
	gth»ads
.
em¶aû_back
([&]() {

38 
i
 = 0; i < 256; i++) {

39 ià(!
asylo_¥š_Œylock
(&
lock
)) {

40 
asylo_¥š_lock
(&
lock
);

42 
sh¬ed_couÁ”
++;

43 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

44 
sh¬ed_couÁ”
--;

45 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

46 
asylo_¥š_uÆock
(&
lock
);

51 autØ&
	gth»ad
 : 
th»ads
) {

52 
th»ad
.
još
();

55 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

	@platform/primitives/x86/spin_lock_test.cc

19 
	~<th»ad
>

20 
	~<veùÜ
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/´im™ives/x86/¥š_lock.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkMªyTh»ads
 = 128;

31 
TEST
(
LockTe¡
, 
MªyTh»adsTe¡
) {

32 
	gsh¬ed_couÁ”
 = 0;

33 
asylo_¥šlock_t
 
	glock
 = 
ASYLO_SPIN_LOCK_INITIALIZER
;

34 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

35 
	gth»ads
.
»£rve
(
kMªyTh»ads
);

36 
	gi
 = 0; i < 
	gkMªyTh»ads
; i++) {

37 
	gth»ads
.
em¶aû_back
([&]() {

38 
i
 = 0; i < 256; i++) {

39 ià(!
asylo_¥š_Œylock
(&
lock
)) {

40 
asylo_¥š_lock
(&
lock
);

42 
sh¬ed_couÁ”
++;

43 
EXPECT_EQ
(
sh¬ed_couÁ”
, 1);

44 
sh¬ed_couÁ”
--;

45 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

46 
asylo_¥š_uÆock
(&
lock
);

51 autØ&
	gth»ad
 : 
th»ads
) {

52 
th»ad
.
još
();

55 
EXPECT_EQ
(
sh¬ed_couÁ”
, 0);

	@platform/storage/secure/aead_handler.cc

21 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

24 
	~<fú.h
>

26 
	~<iomª
>

27 
	~<memÜy
>

29 
	~"ab¦/¡ršgs/esÿpšg.h
"

30 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

31 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

32 
	~"asylo/üy±o/ut/by‹s.h
"

33 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

34 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

36 
Çme¥aû
 
	gasylo
 {

37 
Çme¥aû
 
	g¶©fÜm
 {

38 
Çme¥aû
 
	g¡Üage
 {

40 
usšg
 
	güy±o
::
gcmlib
::
GcmCry±Ü
;

41 
usšg
 
	güy±o
::
gcmlib
::
GcmCry±ÜRegi¡ry
;

43 
	gÇme¥aû
 {

46 
boŞ
 
IsP©hNameV®id
(cÚ¡ *
·th_Çme
) {

47  
	g·th_Çme
 && 
¡¾’
(
·th_Çme
) &&…ath_name[0] == '/';

50 
boŞ
 
is_Œªs›Á_”rÜ
(
”r
è{  (
	g”r
 =ğ
EAGAIN
è|| (”¸=ğ
EINTR
); }

53 
ssize_t
 
»ad_®l
(
fd
, *
buf
, 
size_t
 
Ën
) {

54 
size_t
 
	gby‹s_to_»ad
 = 
Ën
;

55 
size_t
 
	goff£t
 = 0;

57 
	gby‹s_to_»ad
 > 0) {

58 
ssize_t
 
	gby‹s_»ad
;

60 
	gby‹s_»ad
 = 
’c_uÁru¡ed_»ad
(
fd
, 
¡©ic_ÿ¡
<
ušt8_t
 *>(
buf
è+ 
off£t
,

61 
by‹s_to_»ad
);

62 } (
	gby‹s_»ad
 =ğ-1è&& 
is_Œªs›Á_”rÜ
(
”ºo
));

63 ià(
	gby‹s_»ad
 == -1) {

66 ià(
	gby‹s_»ad
 == 0) {

67  
off£t
;

70 
	gby‹s_to_»ad
 -ğ
by‹s_»ad
;

71 
	goff£t
 +ğ
by‹s_»ad
;

74  
	goff£t
;

78 
ssize_t
 
wr™e_®l
(
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

79 
size_t
 
	gby‹s_to_wr™e
 = 
Ën
;

80 
size_t
 
	goff£t
 = 0;

82 
	gby‹s_to_wr™e
 > 0) {

83 
ssize_t
 
	gby‹s_wr™‹n
;

85 
	gby‹s_wr™‹n
 = 
’c_uÁru¡ed_wr™e
(

86 
fd
, 
¡©ic_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
è+ 
off£t
, 
by‹s_to_wr™e
);

87 } (
	gby‹s_wr™‹n
 =ğ-1è&& 
is_Œªs›Á_”rÜ
(
”ºo
));

88 ià(
	gby‹s_wr™‹n
 == -1) {

92 
	gby‹s_to_wr™e
 -ğ
by‹s_wr™‹n
;

93 
	goff£t
 +ğ
by‹s_wr™‹n
;

97 ià(
	goff£t
 !ğ
Ën
) {

101  
	goff£t
;

106 cÚ¡ 
ušt8_t
 *
G‘PÏš‹xtBufãr
(
size_t
 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

107 
št64_t
 
block_šdex
, cÚ¡ *
buf
) {

108 cÚ¡ 
ušt8_t
 *
	g¶aš‹xt_d©a
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
buf
);

109 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

110 ià(
	gblock_šdex
 > 0) {

111 
	g¶aš‹xt_d©a
 +ğ
fœ¡_·¹Ÿl_block_by‹s_couÁ
;

113 ià(
	gblock_šdex
 > 1) {

114 
	g¶aš‹xt_d©a
 +ğ(
block_šdex
 - 1è* 
kBlockL’gth
;

117 
	g¶aš‹xt_d©a
 +ğ
block_šdex
 * 
kBlockL’gth
;

120  
	g¶aš‹xt_d©a
;

123 
ušt8_t
 *
G‘PÏš‹xtBufãr
(
size_t
 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

124 
št64_t
 
block_šdex
, *
buf
) {

125  
	gcÚ¡_ÿ¡
<
	gušt8_t
 *>(

126 
G‘PÏš‹xtBufãr
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
block_šdex
,

127 
cÚ¡_ÿ¡
<cÚ¡ *>(
buf
)));

132 
usšg
 
	gTag
 = 
Un§ãBy‹s
<
kTagL’gth
>;

133 
usšg
 
	gTok’
 = 
Un§ãBy‹s
<
kTok’L’gth
>;

134 
usšg
 
	gBlock
 = 
Un§ãBy‹s
<
kBlockL’gth
>;

135 
usšg
 
	gCh”‹xt
 = 
Un§ãBy‹s
<
kCh”BlockL’gth
>;

136 
usšg
 
	gSecu»Block
 = 
Un§ãBy‹s
<
kSecu»BlockL’gth
>;

138 
usšg
 
	gTagV›w
 = 
By‹CÚš”V›w
;

139 
usšg
 
	gTok’V›w
 = 
By‹CÚš”V›w
;

140 
usšg
 
	gBlockV›w
 = 
By‹CÚš”V›w
;

141 
usšg
 
	gCh”‹xtV›w
 = 
By‹CÚš”V›w
;

142 
usšg
 
	gSecu»BlockV›w
 = 
By‹CÚš”V›w
;

144 
	gA—dHªdËr
::
A—dHªdËr
()

145 : 
off£t_Œª¦©Ü_
(
Off£tT¿n¦©Ü
::
C»©e
(

146 (
FeH—d”
), 
kBlockL’gth
, 
kSecu»BlockL’gth
)) {}

148 
boŞ
 
	gA—dHªdËr
::
De£rŸlize
(
FeCÚŒŞ
 *
fe_ù¾
) {

149 ià(!
fe_ù¾
) {

150 
”ºo
 = 
EINVAL
;

151  
	gçl£
;

153 
	gfe_ù¾
->
	gmu
.
As£¹H–d
();

155 cÚ¡ 
GcmCry±Ü
 *
	güy±Ü
 = 
G‘GcmCry±Ü
(*
fe_ù¾
);

156 ià(!
	güy±Ü
) {

157  
	gçl£
;

160 ià(
	gfe_ù¾
->
	gis_Ãw
) {

161 ià(!
Upd©eDige¡
(
fe_ù¾
, *
üy±Ü
)) {

162 
LOG
(
ERROR
) << "Failedo update header on‡‚ew file,…ath="

163 << 
	gfe_ù¾
->
	g·th
 << ",ƒ¼nØğ" << 
	g”ºo
;

164  
	gçl£
;

167 
	gfe_ù¾
->
	gis_Ãw
 = 
çl£
;

170  
	gŒue
;

174 
	gfd
 = 
’c_uÁru¡ed_İ’
(
fe_ù¾
->
·th
.
c_¡r
(), 
O_RDONLY
);

175 ià(
	gfd
 == -1) {

176 
LOG
(
ERROR
) << "Failedo open file for collecting security metadata,…ath="

177 << 
fe_ù¾
->
·th
 << ",ƒ¼nØğ" << 
”ºo
;

178  
	gçl£
;

181 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

184 
FeH—d”
 
	gfe_h—d”
;

185 
ssize_t
 
	gby‹s_»ad
 = 
»ad_®l
(
fd
, 
fe_h—d”
.
d©a
(), (
FeH—d”
));

186 ià(
	gby‹s_»ad
 !ğ(
FeH—d”
)) {

187 
LOG
(
ERROR
è<< "FaedØ»adhfh—d”, by‹ »ad = " << 
by‹s_»ad
;

188  
	gçl£
;

195 cÚ¡ 
št64_t
 
	gblocks_couÁ
 =

196 (
fe_h—d”
.
fe_size
 + 
kBlockL’gth
 - 1) / kBlockLength;

197 
Tag
 
	gg
;

198 
št64_t
 
	gblock_šdex
 = 0; block_šdex < 
	gblocks_couÁ
; block_index++) {

199 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
kBlockL’gth
, 
SEEK_CUR
);

200 ià(
	goff£t
 == -1) {

201 
LOG
(
ERROR
)

203  
	gçl£
;

206 
	gby‹s_»ad
 = 
»ad_®l
(
fd
, 
g
.
d©a
(), 
kTagL’gth
);

207 ià(
	gby‹s_»ad
 !ğ
kTagL’gth
) {

208 
LOG
(
ERROR
) << "Failedo„ead integrity metadata, bytes_read="

209 << 
by‹s_»ad
;

210  
	gçl£
;

213 
	g¡d
::
¡ršg
 
g_¡ršg
(
»š‹½»t_ÿ¡
<*>(
g
.
d©a
()), 
kTagL’gth
);

214 
VLOG
(2) << "Adding‡uthag‡s†eafo„ebuild Merkleree: "

215 << 
	gab¦
::
By‹sToHexSŒšg
(
g_¡ršg
);

216 
	gfe_ù¾
->
	gad
->
AddL—f
(
g_¡ršg
);

218 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
kTok’L’gth
, 
SEEK_CUR
);

219 ià(
	goff£t
 == -1) {

220 
LOG
(
ERROR
)

222  
	gçl£
;

226 
VLOG
(2) << "Pushed block‡uthags on initialization.";

229 
D©aDige¡
 
	gd©a_dige¡
;

230 
	g¡d
::
cİy_n
(

231 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
fe_ù¾
->
ad
->
Cu¼’tRoÙ
().
d©a
()),

232 
kRoÙHashL’gth
, 
d©a_dige¡
.
d©a
());

233 
	gd©a_dige¡
.
	gfe_size
 = 
fe_h—d”
.
fe_size
;

236 
FeHash
 
	gÃw_hash
;

237 ià(!
	güy±Ü
->
G‘AuthTag
(
Ãw_hash
.
d©a
(), 
d©a_dige¡
.data(),

238 (
D©aDige¡
))) {

239 
LOG
(
ERROR
) << "Failedo generate CMAC for integrity verification,„oot="

240 << 
	gfe_ù¾
->
	gad
->
Cu¼’tRoÙ
();

241  
	gçl£
;

244 ià(
	gÃw_hash
 !ğ
fe_h—d”
.
fe_hash
) {

245 
LOG
(
ERROR
) << "Failure validating integrity„oot for file "

246 << 
fe_ù¾
->
·th
 << ", current„oot: "

247 << 
ab¦
::
By‹sToHexSŒšg
(
fe_ù¾
->
ad
->
Cu¼’tRoÙ
());

248  
	gçl£
;

251 
	gfe_ù¾
->
	glogiÿl_size
 = 
fe_h—d”
.
fe_size
;

252  
	gŒue
;

255 
boŞ
 
	gA—dHªdËr
::
In™ŸlizeFe
(
fd
, cÚ¡ *
·th_Çme
,

256 
boŞ
 
is_Ãw_fe
) {

257 ià(!
IsP©hNameV®id
(
·th_Çme
)) {

258 
LOG
(
ERROR
) << "Invalid input when initializing file,…ath_name="

259 << 
	g·th_Çme
;

260 
	g”ºo
 = 
EINVAL
;

261  
	gçl£
;

264 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

266 autØ
	gfd_™
 = 
fm­_
.
fšd
(
fd
);

267 ià(
	gfd_™
 !ğ
fm­_
.
’d
()) {

268 
LOG
(
ERROR
) << "Attempt madeo initialize‡lready initialized file, fd="

269 << 
fd
 << ",…©h_Çmğ" << 
·th_Çme


270 << ", is_Ãw_fğ" << 
is_Ãw_fe
;

271 
	g”ºo
 = 
EEXIST
;

272  
	gçl£
;

275 
VLOG
(2è<< "In™Ÿlizšg secu» fe, fd = " << 
	gfd


276 << ",…©h_Çmğ" << 
	g·th_Çme
;

277 autØ
	g·th_™
 = 
İ’ed_fes_
.
fšd
(
·th_Çme
);

278 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
 =

279 (
·th_™
 =ğ
İ’ed_fes_
.
’d
())

280 ? 
¡d
::
make_sh¬ed
<
FeCÚŒŞ
>(
·th_Çme
, 
	gis_Ãw_fe
)

281 : 
·th_™
->
£cÚd
;

282 
	gfm­_
.
em¶aû
(
fd
, 
fe_ù¾
);

283 
	gİ’ed_fes_
.
em¶aû
(
·th_Çme
, 
fe_ù¾
);

285  
	gŒue
;

288 
boŞ
 
	gA—dHªdËr
::
R‘r›veLogiÿlOff£t
(
fd
, 
off_t
 *
logiÿl_off£t
) const {

289 ià(
	gfd
 < 0) {

290 
	g”ºo
 = 
EINVAL
;

291  
	gçl£
;

294 
off_t
 
	gphysiÿl_off£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 0, 
SEEK_CUR
);

295 ià(
	gphysiÿl_off£t
 == -1) {

296 
LOG
(
ERROR
è<< "FaedØ»Œ›vSEEK_CUR off£ˆÚ desütÜ: " << 
fd
;

297  
	gçl£
;

300 *
	glogiÿl_off£t
 = 
off£t_Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
physiÿl_off£t
);

301 ià(*
	glogiÿl_off£t
 =ğ
Off£tT¿n¦©Ü
::
kInv®idOff£t
) {

302 
LOG
(
ERROR
è<< "Thfi cÜru±ed, fd = " << 
fd
;

303  
	gçl£
;

306  
	gŒue
;

309 
GcmCry±Ü
 *
	gA—dHªdËr
::
G‘GcmCry±Ü
(cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
) const {

310 
fe_ù¾
.
mu
.
As£¹H–d
();

311 ià(!
	gfe_ù¾
.
	gma¡”_key
) {

312 
LOG
(
ERROR
è<< "Ma¡” key ha nÙ b“À£t,…©h = " << 
	gfe_ù¾
.
	g·th
;

313  
	gnuÎ±r
;

316 
GcmCry±Ü
 *
	güy±Ü
 = 
GcmCry±ÜRegi¡ry
::
G‘In¡ªû
().
G‘GcmCry±Ü
(

317 
kBlockL’gth
, *
fe_ù¾
.
ma¡”_key
);

318 ià(!
	güy±Ü
) {

319 
LOG
(
ERROR
) << "Unableo instantiate GCM cryptor.";

322  
	güy±Ü
;

325 
ssize_t
 
	gA—dHªdËr
::
Deüy±AndV”ify
(
fd
, *
buf
, 
size_t
 
couÁ
) {

326 ià(!
	gbuf
) {

327 
	g”ºo
 = 
EINVAL
;

331 
off_t
 
	glogiÿl_off£t
;

332 ià(!
R‘r›veLogiÿlOff£t
(
fd
, &
logiÿl_off£t
)) {

336 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
;

338 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

340 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

341 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

342 
LOG
(
ERROR
è<< "A‰em± madtØ»ad from‡Àunİ’ed fe, fd = " << 
fd
;

343 
	g”ºo
 = 
ENOENT
;

347 
	gfe_ù¾
 = 
’Œy
->
£cÚd
;

350 
	gab¦
::
Mu‹xLock
 
lock
(&
fe_ù¾
->
mu
);

351  
Deüy±AndV”ifyIÁ”Çl
(
fd
, 
buf
, 
couÁ
, *
fe_ù¾
, 
logiÿl_off£t
);

354 
ssize_t
 
	gA—dHªdËr
::
Deüy±AndV”ifyIÁ”Çl
(
fd
, *
buf
, 
size_t
 
couÁ
,

355 cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
,

356 
off_t
 
logiÿl_off£t
) const {

357 
	gfe_ù¾
.
	gmu
.
As£¹H–d
();

358 ià(
	gcouÁ
 == 0) {

363 ià(
	glogiÿl_off£t
 >ğ
fe_ù¾
.
logiÿl_size
) {

368 ià(
	glogiÿl_off£t
 + 
	gcouÁ
 >ğ
fe_ù¾
.
logiÿl_size
) {

369 
couÁ
 = 
fe_ù¾
.
logiÿl_size
 - 
logiÿl_off£t
;

373 
size_t
 
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
;

374 
size_t
 
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
;

375 
size_t
 
	gfuÎ_šşusive_blocks_by‹s_couÁ
;

376 
	goff£t_Œª¦©Ü_
->
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

377 
logiÿl_off£t
, 
couÁ
, &
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

378 &
Ï¡_·¹Ÿl_block_by‹s_couÁ
, &
fuÎ_šşusive_blocks_by‹s_couÁ
);

381 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
;

382 cÚ¡ 
size_t
 
	gphysiÿl_by‹s_couÁ
 =

383 (
fuÎ_šşusive_blocks_by‹s_couÁ
 / 
kBlockL’gth
è* 
kSecu»BlockL’gth
;

384 
	gbufãr
.
»size
(
physiÿl_by‹s_couÁ
);

387 cÚ¡ 
off_t
 
	gfœ¡_logiÿl_block_off£t
 =

388 (
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0)

389 ? (
logiÿl_off£t
 + 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 - 
kBlockL’gth
)

390 : 
logiÿl_off£t
;

391 cÚ¡ 
off_t
 
	gfœ¡_physiÿl_block_off£t
 =

392 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
fœ¡_logiÿl_block_off£t
);

393 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

394 
off_t
 
	goff£t
 =

395 
’c_uÁru¡ed_l£ek
(
fd
, 
fœ¡_physiÿl_block_off£t
, 
SEEK_SET
);

396 ià(
	goff£t
 == -1) {

397 
LOG
(
ERROR
)

406 
ssize_t
 
	gby‹s_»ad
 =

407 
’c_uÁru¡ed_»ad
(
fd
, 
bufãr
.
d©a
(), 
physiÿl_by‹s_couÁ
);

408 ià(
	gby‹s_»ad
 <= 0) {

409 
LOG
(
ERROR
è<< "CªnÙ v”ify d©¨- d©¨ha nÙ b“À»ad, fd = " << 
fd
;

415 
	gby‹s_»ad
 = (
by‹s_»ad
 / 
kSecu»BlockL’gth
) * kSecureBlockLength;

416 ià(
	gby‹s_»ad
 == 0) {

417 
LOG
(
ERROR
è<< "CªnÙ v”ify d©¨- d©¨ha nÙ b“À»ad, fd = " << 
fd
;

422 
off_t
 
	gÃw_cur_logiÿl_off£t
 = 
logiÿl_off£t
 + 
couÁ
;

423 ià(
	gby‹s_»ad
 !ğ
physiÿl_by‹s_couÁ
) {

424 
št64_t
 
blocks_nÙ_»ad
 =

425 (
physiÿl_by‹s_couÁ
 - 
by‹s_»ad
è/ 
kSecu»BlockL’gth
;

426 ià(
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

427 
	gÃw_cur_logiÿl_off£t
 -ğ
Ï¡_·¹Ÿl_block_by‹s_couÁ
;

428 
	gblocks_nÙ_»ad
--;

430 
	gÃw_cur_logiÿl_off£t
 -ğ
blocks_nÙ_»ad
 * 
kBlockL’gth
;

432 cÚ¡ 
off_t
 
	gÃw_cur_physiÿl_off£t
 =

433 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
Ãw_cur_logiÿl_off£t
);

434 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
Ãw_cur_physiÿl_off£t
, 
SEEK_SET
);

435 ià(
	goff£t
 == -1) {

436 
LOG
(
ERROR
) << "Failed†seekoheƒnd of„ead„ange.";

440 
GcmCry±Ü
 *
	güy±Ü
 = 
G‘GcmCry±Ü
(
fe_ù¾
);

441 ià(!
	güy±Ü
) {

446 cÚ¡ 
št64_t
 
	gblocks_»ad
 = 
by‹s_»ad
 / 
kSecu»BlockL’gth
;

447 cÚ¡ 
št64_t
 
	gblocks_»ad_max
 = 
physiÿl_by‹s_couÁ
 / 
kSecu»BlockL’gth
;

448 cÚ¡ 
off_t
 
	gfœ¡_block_šdex
 =

449 (
fœ¡_physiÿl_block_off£t
 - (
FeH—d”
)è/ 
kSecu»BlockL’gth
;

450 
size_t
 
	g»ad_couÁ
 = 0;

451 
št64_t
 
	gblock_šdex
 = 0; block_šdex < 
	gblocks_»ad
; block_index++) {

452 cÚ¡ 
size_t
 
	gm”kË_block_idx
 = 
fœ¡_block_šdex
 + 
block_šdex
 + 1;

454 
ušt8_t
 *
	g¶aš‹xt_d©a
 =

455 
G‘PÏš‹xtBufãr
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
block_šdex
, 
buf
);

459 ià(
	gfe_ù¾
.
	gad
->
L—fHash
(
m”kË_block_idx
è=ğ
fe_ù¾
.
z”o_hash
) {

460 
VLOG
(2) << "A sparse„egion block detected.";

461 
mem£t
(
¶aš‹xt_d©a
, 0, 
kBlockL’gth
);

462 
	g»ad_couÁ
 +ğ
kBlockL’gth
;

466 
Ch”‹xtV›w
 
ch”‹xt
(
bufãr
.
d©a
(è+ 
block_šdex
 * 
kSecu»BlockL’gth
,

467 
kCh”BlockL’gth
);

468 
VLOG
(2) << "Ciphertext„ead: "

469 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

470 
»š‹½»t_ÿ¡
<cÚ¡ *>(
ch”‹xt
.
d©a
()),

471 
kCh”BlockL’gth
));

473 
TagV›w
 
g
(
bufãr
.
d©a
(è+ 
block_šdex
 * 
kSecu»BlockL’gth
 + 
kBlockL’gth
,

474 
kTagL’gth
);

475 
VLOG
(2) << "Authag„ead: "

476 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

477 
»š‹½»t_ÿ¡
<cÚ¡ *>(
g
.
d©a
()), 
kTagL’gth
));

479 
Tok’V›w
 
tok’
(

480 
bufãr
.
d©a
(è+ 
block_šdex
 * 
kSecu»BlockL’gth
 + 
kCh”BlockL’gth
,

481 
kTok’L’gth
);

482 
VLOG
(2) << "Token„ead: "

483 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

484 
»š‹½»t_ÿ¡
<cÚ¡ *>(
tok’
.
d©a
()), 
kTok’L’gth
));

489 ià(
	gfe_ù¾
.
	gad
->
L—fHash
(
m”kË_block_idx
) !=

490 
fe_ù¾
.
ad
->
L—fHash
(
¡d
::
¡ršg
(

491 
»š‹½»t_ÿ¡
<cÚ¡ *>(
g
.
d©a
()), 
kTagL’gth
))) {

492 
LOG
(
ERROR
è<< "IÁegr™y v”ifiÿtiÚ faed, fd = " << 
	gfd
;

497 
Block
 
	gbounû_block
;

499 
ušt8_t
 *
	gdeüy±_rg‘
;

502 ià((
	gblock_šdex
 =ğ0 && 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) ||

503 (
block_šdex
 =ğ
blocks_»ad_max
 - 1 &&

504 
Ï¡_·¹Ÿl_block_by‹s_couÁ
 > 0)) {

505 
deüy±_rg‘
 = 
bounû_block
.
d©a
();

507 
	gdeüy±_rg‘
 = 
¶aš‹xt_d©a
;

511 ià(!
	güy±Ü
->
Deüy±Block
(
ch”‹xt
.
d©a
(), 
tok’
.data(),

512 
deüy±_rg‘
)) {

513 
LOG
(
ERROR
è<< "Deüy±iÚ faed, fd = " << 
	gfd
;

519 ià(
	gblock_šdex
 =ğ0 && 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

520 
¡d
::
cİy_n
(

521 
bounû_block
.
begš
(è+ 
kBlockL’gth
 - 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

522 
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
¶aš‹xt_d©a
);

523 
	g»ad_couÁ
 +ğ
fœ¡_·¹Ÿl_block_by‹s_couÁ
;

524 } ià(
	gblock_šdex
 =ğ
blocks_»ad_max
 - 1 &&

525 
Ï¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

526 
¡d
::
cİy_n
(
bounû_block
.
begš
(), 
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

527 
¶aš‹xt_d©a
);

528 
	g»ad_couÁ
 +ğ
Ï¡_·¹Ÿl_block_by‹s_couÁ
;

530 
	g»ad_couÁ
 +ğ
kBlockL’gth
;

534 
VLOG
(2è<< "V”if›d„—d blocks, blocks_»ad = " << 
	gblocks_»ad


535 << ", by‹s_»ad = " << 
	gby‹s_»ad
;

536  
	g»ad_couÁ
;

539 
boŞ
 
	gA—dHªdËr
::
Upd©eDige¡
(
FeCÚŒŞ
 *
fe_ù¾
,

540 cÚ¡ 
GcmCry±Ü
 &
üy±Ü
) const {

541 ià(!
	gfe_ù¾
) {

542 
	g”ºo
 = 
EINVAL
;

543  
	gçl£
;

545 
	gfe_ù¾
->
	gmu
.
As£¹H–d
();

547 
	gfd
 = 
’c_uÁru¡ed_İ’
(
fe_ù¾
->
·th
.
c_¡r
(), 
O_WRONLY
);

548 ià(
	gfd
 == -1) {

549 
LOG
(
ERROR
) << "Failedo open fileo save data digest,…ath="

550 << 
fe_ù¾
->
·th
 << ",ƒ¼nØğ" << 
”ºo
;

551  
	gçl£
;

554 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

556 
	g¡d
::
¡ršg
 
roÙ
 = 
fe_ù¾
->
ad
->
Cu¼’tRoÙ
();

557 ià(
	groÙ
.
size
(è!ğ
kRoÙHashL’gth
) {

558 
LOG
(
ERROR
) << "Unexpected size of„oot hashƒncountered, size="

559 << 
roÙ
.
size
();

560  
	gçl£
;

564 
D©aDige¡
 
	gd©a_dige¡
;

565 
	g¡d
::
cİy_n
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
roÙ
.
d©a
()), 
kRoÙHashL’gth
,

566 
d©a_dige¡
.
d©a
());

567 
	gd©a_dige¡
.
	gfe_size
 = 
fe_ù¾
->
logiÿl_size
;

569 
FeH—d”
 
	gh—d”
;

570 ià(!
	güy±Ü
.
G‘AuthTag
(
h—d”
.
d©a
(), 
d©a_dige¡
.data(),

571 (
D©aDige¡
))) {

572 
LOG
(
ERROR
è<< "FaedØg’”©CMAC,„oÙ = " << 
	groÙ
;

573  
	gçl£
;

575 
	gh—d”
.
	gfe_size
 = 
fe_ù¾
->
logiÿl_size
;

577 
VLOG
(2è<< "Upd©šghdige¡ fÜ fe: " << 
	gfe_ù¾
->
	g·th


578 << ",„oÙ hash: " << 
	gab¦
::
By‹sToHexSŒšg
(
roÙ
);

579 
ssize_t
 
	gby‹s_wr™‹n
 = 
wr™e_®l
(
fd
, 
h—d”
.
d©a
(), (
FeH—d”
));

580 ià(
	gby‹s_wr™‹n
 !ğ(
FeH—d”
)) {

581 
LOG
(
ERROR
) << "Failedo write full digesto file,…ath="

582 << 
fe_ù¾
->
·th
 << ", by‹ wr™‹Àğ" << 
by‹s_wr™‹n
;

583  
	gçl£
;

586 ià(!
	gfd_şo£r
.
»£t
()) {

587 
LOG
(
ERROR
) << "Failedo closehe file‡fter digest update,…ath="

588 << 
	gfe_ù¾
->
	g·th
;

589  
	gçl£
;

592  
	gŒue
;

595 
boŞ
 
	gA—dHªdËr
::
R—dFuÎBlock
(cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
,

596 
off_t
 
logiÿl_off£t
, 
Block
 *
block
) const {

597 
	gfe_ù¾
.
	gmu
.
As£¹H–d
();

598 ià(
	glogiÿl_off£t
 < 0 ||†ogiÿl_off£ˆ% 
	gkBlockL’gth
 != 0) {

599 
”ºo
 = 
EINVAL
;

600  
	gçl£
;

603 
	gfd
 = 
’c_uÁru¡ed_İ’
(
fe_ù¾
.
·th
.
c_¡r
(), 
O_RDONLY
);

604 ià(
	gfd
 == -1) {

605 
LOG
(
ERROR
è<< "FaedØİ’ ftØ»ad‡ block,…©h=" << 
fe_ù¾
.
·th


606 << ",ƒ¼nØğ" << 
”ºo
;

607  
	gçl£
;

610 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

612 
off_t
 
	gphysiÿl_off£t
 = 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
logiÿl_off£t
);

613 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
physiÿl_off£t
, 
SEEK_SET
);

614 ià(
	goff£t
 == -1) {

615 
LOG
(
ERROR
) << "Failed†seek when„eading‡ full block.";

616  
	gçl£
;

619 
ssize_t
 
	gby‹s_»ad
 = 
Deüy±AndV”ifyIÁ”Çl
(
fd
, 
block
->
d©a
(), 
kBlockL’gth
,

620 
fe_ù¾
, 
logiÿl_off£t
);

621 ià(
	gby‹s_»ad
 == -1) {

625 ià(
	gby‹s_»ad
 < 
	gkBlockL’gth
) {

626 
mem£t
(
block
->
d©a
(è+ 
by‹s_»ad
, 0, 
kBlockL’gth
 - bytes_read);

629  
	gŒue
;

632 
ssize_t
 
	gA—dHªdËr
::
Enüy±AndP”si¡
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

633 ià(!
	gbuf
) {

634 
	g”ºo
 = 
EINVAL
;

638 
off_t
 
	glogiÿl_off£t
;

639 ià(!
R‘r›veLogiÿlOff£t
(
fd
, &
logiÿl_off£t
)) {

643 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
;

645 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

647 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

648 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

649 
LOG
(
ERROR
è<< "A‰em± madtØwr™tØª unİ’ed fe, fd = " << 
fd
;

650 
	g”ºo
 = 
ENOENT
;

654 
	gfe_ù¾
 = 
’Œy
->
£cÚd
;

657 ià(
	gcouÁ
 == 0) {

661 
	gab¦
::
Mu‹xLock
 
lock
(&
fe_ù¾
->
mu
);

664 
size_t
 
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
;

665 
size_t
 
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
;

666 
size_t
 
	gfuÎ_šşusive_blocks_by‹s_couÁ
;

667 
	goff£t_Œª¦©Ü_
->
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

668 
logiÿl_off£t
, 
couÁ
, &
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

669 &
Ï¡_·¹Ÿl_block_by‹s_couÁ
, &
fuÎ_šşusive_blocks_by‹s_couÁ
);

672 
Block
 
	gfœ¡_block
;

673 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

674 ià(!
R—dFuÎBlock
(

675 *
fe_ù¾
,

676 
logiÿl_off£t
 + 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 - 
kBlockL’gth
,

677 &
fœ¡_block
)) {

678 
LOG
(
ERROR
)

680 << 
	gfd
;

684 
	g¡d
::
cİy_n
(

685 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
), 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

686 
fœ¡_block
.
d©a
(è+ 
kBlockL’gth
 - 
fœ¡_·¹Ÿl_block_by‹s_couÁ
);

690 
Block
 
	gÏ¡_block
;

691 ià(
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

692 ià(!
R—dFuÎBlock
(*
fe_ù¾
,

693 
logiÿl_off£t
 + 
couÁ
 - 
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

694 &
Ï¡_block
)) {

695 
LOG
(
ERROR
)

697 << 
	gfd
;

701 
	g¡d
::
cİy_n
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
è+ 
couÁ
 -

702 
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

703 
Ï¡_·¹Ÿl_block_by‹s_couÁ
, 
Ï¡_block
.
d©a
());

706 cÚ¡ 
off_t
 
	gfœ¡_logiÿl_block_off£t
 =

707 (
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0)

708 ? (
logiÿl_off£t
 + 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 - 
kBlockL’gth
)

709 : 
logiÿl_off£t
;

710 cÚ¡ 
off_t
 
	gfœ¡_physiÿl_block_off£t
 =

711 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
fœ¡_logiÿl_block_off£t
);

712 cÚ¡ 
št64_t
 
	geof_block_šdex
 = 
fe_ù¾
->
ad
->
L—fCouÁ
();

713 
št64_t
 
	g¡¬t_block_to_wr™e
 = 0;

714 ià(
	gfœ¡_physiÿl_block_off£t
 > 
	gfe_ù¾
->
physiÿl_size
()) {

716 
št64_t
 
	g¥¬£_blocks_couÁ
 =

717 (
fœ¡_physiÿl_block_off£t
 - 
fe_ù¾
->
physiÿl_size
()) /

718 
kSecu»BlockL’gth
;

719 
št64_t
 
	gidx
 = 0; idx < 
	g¥¬£_blocks_couÁ
; idx++) {

720 
VLOG
(2) << "Adding‡nƒmpty‡uthago AD for‡ block "

722 << 
	gab¦
::
By‹sToHexSŒšg
(
fe_ù¾
->
z”o_hash
);

723 
	gfe_ù¾
->
	gad
->
AddL—fHash
(
fe_ù¾
->
z”o_hash
);

725 
	g¡¬t_block_to_wr™e
 = 
eof_block_šdex
 + 
¥¬£_blocks_couÁ
;

727 
št64_t
 
	gblocks_to_eof
 =

728 (
fe_ù¾
->
physiÿl_size
(è- 
fœ¡_physiÿl_block_off£t
) /

729 
kSecu»BlockL’gth
;

730 
	g¡¬t_block_to_wr™e
 = 
eof_block_šdex
 - 
blocks_to_eof
;

733 
GcmCry±Ü
 *
	güy±Ü
 = 
G‘GcmCry±Ü
(*
fe_ù¾
);

734 ià(!
	güy±Ü
) {

738 
VLOG
(2è<< "Wr™šg d©¨tØfe, couÁ = " << 
	gcouÁ
 << ", fd = " << 
	gfd
;

741 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
;

742 cÚ¡ 
št64_t
 
	gblocks_to_wr™e
 =

743 
fuÎ_šşusive_blocks_by‹s_couÁ
 / 
kBlockL’gth
;

744 cÚ¡ 
size_t
 
	gphysiÿl_by‹s_couÁ
 = 
blocks_to_wr™e
 * 
kSecu»BlockL’gth
;

745 
	gbufãr
.
»size
(
physiÿl_by‹s_couÁ
);

748 
	g¡d
::
veùÜ
<
Tag
> 
gs
;

749 
št64_t
 
	gblock_šdex
 = 0; block_šdex < 
	gblocks_to_wr™e
; block_index++) {

750 cÚ¡ 
ušt8_t
 *
	g¶aš‹xt_d©a
 =

751 
G‘PÏš‹xtBufãr
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
block_šdex
, 
buf
);

754 cÚ¡ 
ušt8_t
 *
	g’üy±_sourû
;

757 ià(
	gblock_šdex
 =ğ0 && 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

758 
’üy±_sourû
 = 
fœ¡_block
.
d©a
();

759 } ià(
	gblock_šdex
 =ğ
blocks_to_wr™e
 - 1 &&

760 
Ï¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

761 
’üy±_sourû
 = 
Ï¡_block
.
d©a
();

763 
	g’üy±_sourû
 = 
¶aš‹xt_d©a
;

766 
Ch”‹xt
 *
	gch”‹xt
 =

767 
Ch”‹xt
::
PÏû
(&
bufãr
, 
block_šdex
 * 
kSecu»BlockL’gth
);

768 
Tok’
 *
	gtok’
 = Tok’::
PÏû
(

769 &
bufãr
, 
block_šdex
 * 
kSecu»BlockL’gth
 + 
kCh”BlockL’gth
);

772 ià(!
	güy±Ü
->
Enüy±Block
(
’üy±_sourû
, 
tok’
->
d©a
(),

773 
ch”‹xt
->
d©a
())) {

774 
LOG
(
ERROR
è<< "Enüy±iÚ faed, fd = " << 
	gfd
;

777 
VLOG
(2) << "Ciphertext generated: "

778 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

779 
»š‹½»t_ÿ¡
<cÚ¡ *>(
ch”‹xt
->
d©a
()),

780 
kBlockL’gth
));

781 
VLOG
(2) << "Token generated: "

782 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

783 
»š‹½»t_ÿ¡
<cÚ¡ *>(
tok’
->
d©a
()),

784 
kTok’L’gth
));

786 
TagV›w
 
g
(
ch”‹xt
->
d©a
(è+ 
kBlockL’gth
, 
kTagL’gth
);

787 
	ggs
.
push_back
(
g
);

788 
VLOG
(2) << "Authag generated: "

789 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

790 
»š‹½»t_ÿ¡
<cÚ¡ *>(
g
.
d©a
()), 
kTagL’gth
));

794 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

795 
off_t
 
	goff£t
 =

796 
’c_uÁru¡ed_l£ek
(
fd
, 
fœ¡_physiÿl_block_off£t
, 
SEEK_SET
);

797 ià(
	goff£t
 == -1) {

798 
LOG
(
ERROR
)

812 
ssize_t
 
	gby‹s_wr™‹n
 = 
wr™e_®l
(
fd
, 
bufãr
.
d©a
(), 
physiÿl_by‹s_couÁ
);

813 ià(
	gby‹s_wr™‹n
 !ğ
physiÿl_by‹s_couÁ
) {

814 
LOG
(
ERROR
) << "Failedo writeƒncrypted datao file,…ath="

815 << 
fe_ù¾
->
·th
 << ", by‹ wr™‹Àğ" << 
by‹s_wr™‹n
;

820 ià(
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

821 
off_t
 
	gÃw_cur_logiÿl_off£t
 = 
logiÿl_off£t
 + 
couÁ
;

822 
off_t
 
	gÃw_cur_physiÿl_off£t
 =

823 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
Ãw_cur_logiÿl_off£t
);

824 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
Ãw_cur_physiÿl_off£t
, 
SEEK_SET
);

825 ià(
	goff£t
 == -1) {

826 
LOG
(
ERROR
)

832 
št64_t
 
	gidx
 = 0; idx < 
	ggs
.
size
(); idx++) {

833 
	g¡d
::
¡ršg
 
g_¡ršg
(
»š‹½»t_ÿ¡
<*>(
gs
[
idx
].
d©a
()),

834 
kTagL’gth
);

835 
št64_t
 
	gblock_šdex
 = 
¡¬t_block_to_wr™e
 + 
idx
;

836 ià(
	gblock_šdex
 < 
	geof_block_šdex
) {

837 
VLOG
(2) << "Updating‡uthag on AD: "

838 << 
	gab¦
::
By‹sToHexSŒšg
(
g_¡ršg
);

839 
	gfe_ù¾
->
	gad
->
Upd©eL—f
(
block_šdex
 + 1, 
g_¡ršg
);

841 
VLOG
(2) << "Appending‡uthago AD: "

842 << 
	gab¦
::
By‹sToHexSŒšg
(
g_¡ršg
);

843 
	gfe_ù¾
->
	gad
->
AddL—f
(
g_¡ršg
);

847 
	gfe_ù¾
->
	glogiÿl_size
 = 
logiÿl_off£t
 + 
couÁ
;

849 ià(!
Upd©eDige¡
(
fe_ù¾
.
g‘
(), *
üy±Ü
)) {

853 
VLOG
(2è<< "WrÙd©¨tØfe, by‹s_wr™‹Àğ" << 
	gby‹s_wr™‹n
;

855  
	gcouÁ
;

858 
boŞ
 
	gA—dHªdËr
::
Fš®izeFe
(
fd
) {

859 
ab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

861 ià(
	gfd
 < 0) {

862 
	g”ºo
 = 
EINVAL
;

863  
	gçl£
;

866 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

867 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

868 
LOG
(
ERROR
è<< "A‰em± madtØfš®izunš™Ÿlized fe, fd = " << 
fd
;

869 
	g”ºo
 = 
ENOENT
;

870  
	gçl£
;

878 
VLOG
(2è<< "Fš®izšg secu» fe, fd = " << 
	gfd


879 << ",…©hÇmğ" << 
	g’Œy
->
	g£cÚd
->
	g·th
;

880 
	gİ’ed_fes_
.
”a£
(
’Œy
->
£cÚd
->
·th
);

881 
	gfm­_
.
”a£
(
’Œy
);

883  
	gŒue
;

890 
	gA—dHªdËr
::
S‘Ma¡”Key
(
fd
, cÚ¡ 
ušt8_t
 *
key_d©a
,

891 
ušt32_t
 
key_Ëngth
) {

892 ià(!
	gkey_d©a
 || 
	gkey_Ëngth
 !ğ
kKeyL’gth
) {

893 
LOG
(
ERROR
) << "Attempt madeo set‡n invalid key.";

894 
	g”ºo
 = 
EINVAL
;

898 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
;

900 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

902 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

903 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

904 
LOG
(
ERROR
è<< "A‰em± madtØ£ˆkey oÀª unİ’ed fe, fd = " << 
fd
;

905 
	g”ºo
 = 
ENOENT
;

909 
	gfe_ù¾
 = 
’Œy
->
£cÚd
;

912 
	gab¦
::
Mu‹xLock
 
lock
(&
fe_ù¾
->
mu
);

914 ià(
	gfe_ù¾
->
	gis_de£rŸlized
) {

915 ià(
memcmp
(
fe_ù¾
->
ma¡”_key
->
d©a
(), 
key_d©a
, 
kKeyL’gth
) != 0) {

916 
LOG
(
ERROR
) << "Attempt madeo set‡‚ew key on‡nƒxisting file, fd="

917 << 
fd
;

924 
	gfe_ù¾
->
	gma¡”_key
 =

925 
ab¦
::
make_unique
<
GcmCry±ÜKey
>(
key_d©a
, 
	gkey_Ëngth
);

926 ià(!
De£rŸlize
(
fe_ù¾
.
g‘
())) {

927 
LOG
(
ERROR
) << "Failedo deserialize integrity metadata for file,…ath="

928 << 
	gfe_ù¾
->
	g·th
;

932 
	gfe_ù¾
->
	gis_de£rŸlized
 = 
Œue
;

936 cÚ¡ 
	gOff£tT¿n¦©Ü
 &
	gA—dHªdËr
::
G‘Off£tT¿n¦©Ü
() const {

937  *
off£t_Œª¦©Ü_
;

940 
off_t
 
	gA—dHªdËr
::
G‘LogiÿlFeSize
(
fd
) {

941 
ab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

942 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

943 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

944 
LOG
(
ERROR
)

946 << 
fd
;

949  
	g’Œy
->
	g£cÚd
->
	glogiÿl_size
;

	@platform/storage/secure/aead_handler.cc

21 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

24 
	~<fú.h
>

26 
	~<iomª
>

27 
	~<memÜy
>

29 
	~"ab¦/¡ršgs/esÿpšg.h
"

30 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

31 
	~"asylo/üy±o/ut/by‹_cÚš”_v›w.h
"

32 
	~"asylo/üy±o/ut/by‹s.h
"

33 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

34 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

36 
Çme¥aû
 
	gasylo
 {

37 
Çme¥aû
 
	g¶©fÜm
 {

38 
Çme¥aû
 
	g¡Üage
 {

40 
usšg
 
	güy±o
::
gcmlib
::
GcmCry±Ü
;

41 
usšg
 
	güy±o
::
gcmlib
::
GcmCry±ÜRegi¡ry
;

43 
	gÇme¥aû
 {

46 
boŞ
 
IsP©hNameV®id
(cÚ¡ *
·th_Çme
) {

47  
	g·th_Çme
 && 
¡¾’
(
·th_Çme
) &&…ath_name[0] == '/';

50 
boŞ
 
is_Œªs›Á_”rÜ
(
”r
è{  (
	g”r
 =ğ
EAGAIN
è|| (”¸=ğ
EINTR
); }

53 
ssize_t
 
»ad_®l
(
fd
, *
buf
, 
size_t
 
Ën
) {

54 
size_t
 
	gby‹s_to_»ad
 = 
Ën
;

55 
size_t
 
	goff£t
 = 0;

57 
	gby‹s_to_»ad
 > 0) {

58 
ssize_t
 
	gby‹s_»ad
;

60 
	gby‹s_»ad
 = 
’c_uÁru¡ed_»ad
(
fd
, 
¡©ic_ÿ¡
<
ušt8_t
 *>(
buf
è+ 
off£t
,

61 
by‹s_to_»ad
);

62 } (
	gby‹s_»ad
 =ğ-1è&& 
is_Œªs›Á_”rÜ
(
”ºo
));

63 ià(
	gby‹s_»ad
 == -1) {

66 ià(
	gby‹s_»ad
 == 0) {

67  
off£t
;

70 
	gby‹s_to_»ad
 -ğ
by‹s_»ad
;

71 
	goff£t
 +ğ
by‹s_»ad
;

74  
	goff£t
;

78 
ssize_t
 
wr™e_®l
(
fd
, cÚ¡ *
buf
, 
size_t
 
Ën
) {

79 
size_t
 
	gby‹s_to_wr™e
 = 
Ën
;

80 
size_t
 
	goff£t
 = 0;

82 
	gby‹s_to_wr™e
 > 0) {

83 
ssize_t
 
	gby‹s_wr™‹n
;

85 
	gby‹s_wr™‹n
 = 
’c_uÁru¡ed_wr™e
(

86 
fd
, 
¡©ic_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
è+ 
off£t
, 
by‹s_to_wr™e
);

87 } (
	gby‹s_wr™‹n
 =ğ-1è&& 
is_Œªs›Á_”rÜ
(
”ºo
));

88 ià(
	gby‹s_wr™‹n
 == -1) {

92 
	gby‹s_to_wr™e
 -ğ
by‹s_wr™‹n
;

93 
	goff£t
 +ğ
by‹s_wr™‹n
;

97 ià(
	goff£t
 !ğ
Ën
) {

101  
	goff£t
;

106 cÚ¡ 
ušt8_t
 *
G‘PÏš‹xtBufãr
(
size_t
 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

107 
št64_t
 
block_šdex
, cÚ¡ *
buf
) {

108 cÚ¡ 
ušt8_t
 *
	g¶aš‹xt_d©a
 = 
»š‹½»t_ÿ¡
<cÚ¡ ušt8_ˆ*>(
buf
);

109 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

110 ià(
	gblock_šdex
 > 0) {

111 
	g¶aš‹xt_d©a
 +ğ
fœ¡_·¹Ÿl_block_by‹s_couÁ
;

113 ià(
	gblock_šdex
 > 1) {

114 
	g¶aš‹xt_d©a
 +ğ(
block_šdex
 - 1è* 
kBlockL’gth
;

117 
	g¶aš‹xt_d©a
 +ğ
block_šdex
 * 
kBlockL’gth
;

120  
	g¶aš‹xt_d©a
;

123 
ušt8_t
 *
G‘PÏš‹xtBufãr
(
size_t
 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

124 
št64_t
 
block_šdex
, *
buf
) {

125  
	gcÚ¡_ÿ¡
<
	gušt8_t
 *>(

126 
G‘PÏš‹xtBufãr
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
block_šdex
,

127 
cÚ¡_ÿ¡
<cÚ¡ *>(
buf
)));

132 
usšg
 
	gTag
 = 
Un§ãBy‹s
<
kTagL’gth
>;

133 
usšg
 
	gTok’
 = 
Un§ãBy‹s
<
kTok’L’gth
>;

134 
usšg
 
	gBlock
 = 
Un§ãBy‹s
<
kBlockL’gth
>;

135 
usšg
 
	gCh”‹xt
 = 
Un§ãBy‹s
<
kCh”BlockL’gth
>;

136 
usšg
 
	gSecu»Block
 = 
Un§ãBy‹s
<
kSecu»BlockL’gth
>;

138 
usšg
 
	gTagV›w
 = 
By‹CÚš”V›w
;

139 
usšg
 
	gTok’V›w
 = 
By‹CÚš”V›w
;

140 
usšg
 
	gBlockV›w
 = 
By‹CÚš”V›w
;

141 
usšg
 
	gCh”‹xtV›w
 = 
By‹CÚš”V›w
;

142 
usšg
 
	gSecu»BlockV›w
 = 
By‹CÚš”V›w
;

144 
	gA—dHªdËr
::
A—dHªdËr
()

145 : 
off£t_Œª¦©Ü_
(
Off£tT¿n¦©Ü
::
C»©e
(

146 (
FeH—d”
), 
kBlockL’gth
, 
kSecu»BlockL’gth
)) {}

148 
boŞ
 
	gA—dHªdËr
::
De£rŸlize
(
FeCÚŒŞ
 *
fe_ù¾
) {

149 ià(!
fe_ù¾
) {

150 
”ºo
 = 
EINVAL
;

151  
	gçl£
;

153 
	gfe_ù¾
->
	gmu
.
As£¹H–d
();

155 cÚ¡ 
GcmCry±Ü
 *
	güy±Ü
 = 
G‘GcmCry±Ü
(*
fe_ù¾
);

156 ià(!
	güy±Ü
) {

157  
	gçl£
;

160 ià(
	gfe_ù¾
->
	gis_Ãw
) {

161 ià(!
Upd©eDige¡
(
fe_ù¾
, *
üy±Ü
)) {

162 
LOG
(
ERROR
) << "Failedo update header on‡‚ew file,…ath="

163 << 
	gfe_ù¾
->
	g·th
 << ",ƒ¼nØğ" << 
	g”ºo
;

164  
	gçl£
;

167 
	gfe_ù¾
->
	gis_Ãw
 = 
çl£
;

170  
	gŒue
;

174 
	gfd
 = 
’c_uÁru¡ed_İ’
(
fe_ù¾
->
·th
.
c_¡r
(), 
O_RDONLY
);

175 ià(
	gfd
 == -1) {

176 
LOG
(
ERROR
) << "Failedo open file for collecting security metadata,…ath="

177 << 
fe_ù¾
->
·th
 << ",ƒ¼nØğ" << 
”ºo
;

178  
	gçl£
;

181 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

184 
FeH—d”
 
	gfe_h—d”
;

185 
ssize_t
 
	gby‹s_»ad
 = 
»ad_®l
(
fd
, 
fe_h—d”
.
d©a
(), (
FeH—d”
));

186 ià(
	gby‹s_»ad
 !ğ(
FeH—d”
)) {

187 
LOG
(
ERROR
è<< "FaedØ»adhfh—d”, by‹ »ad = " << 
by‹s_»ad
;

188  
	gçl£
;

195 cÚ¡ 
št64_t
 
	gblocks_couÁ
 =

196 (
fe_h—d”
.
fe_size
 + 
kBlockL’gth
 - 1) / kBlockLength;

197 
Tag
 
	gg
;

198 
št64_t
 
	gblock_šdex
 = 0; block_šdex < 
	gblocks_couÁ
; block_index++) {

199 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
kBlockL’gth
, 
SEEK_CUR
);

200 ià(
	goff£t
 == -1) {

201 
LOG
(
ERROR
)

203  
	gçl£
;

206 
	gby‹s_»ad
 = 
»ad_®l
(
fd
, 
g
.
d©a
(), 
kTagL’gth
);

207 ià(
	gby‹s_»ad
 !ğ
kTagL’gth
) {

208 
LOG
(
ERROR
) << "Failedo„ead integrity metadata, bytes_read="

209 << 
by‹s_»ad
;

210  
	gçl£
;

213 
	g¡d
::
¡ršg
 
g_¡ršg
(
»š‹½»t_ÿ¡
<*>(
g
.
d©a
()), 
kTagL’gth
);

214 
VLOG
(2) << "Adding‡uthag‡s†eafo„ebuild Merkleree: "

215 << 
	gab¦
::
By‹sToHexSŒšg
(
g_¡ršg
);

216 
	gfe_ù¾
->
	gad
->
AddL—f
(
g_¡ršg
);

218 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
kTok’L’gth
, 
SEEK_CUR
);

219 ià(
	goff£t
 == -1) {

220 
LOG
(
ERROR
)

222  
	gçl£
;

226 
VLOG
(2) << "Pushed block‡uthags on initialization.";

229 
D©aDige¡
 
	gd©a_dige¡
;

230 
	g¡d
::
cİy_n
(

231 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
fe_ù¾
->
ad
->
Cu¼’tRoÙ
().
d©a
()),

232 
kRoÙHashL’gth
, 
d©a_dige¡
.
d©a
());

233 
	gd©a_dige¡
.
	gfe_size
 = 
fe_h—d”
.
fe_size
;

236 
FeHash
 
	gÃw_hash
;

237 ià(!
	güy±Ü
->
G‘AuthTag
(
Ãw_hash
.
d©a
(), 
d©a_dige¡
.data(),

238 (
D©aDige¡
))) {

239 
LOG
(
ERROR
) << "Failedo generate CMAC for integrity verification,„oot="

240 << 
	gfe_ù¾
->
	gad
->
Cu¼’tRoÙ
();

241  
	gçl£
;

244 ià(
	gÃw_hash
 !ğ
fe_h—d”
.
fe_hash
) {

245 
LOG
(
ERROR
) << "Failure validating integrity„oot for file "

246 << 
fe_ù¾
->
·th
 << ", current„oot: "

247 << 
ab¦
::
By‹sToHexSŒšg
(
fe_ù¾
->
ad
->
Cu¼’tRoÙ
());

248  
	gçl£
;

251 
	gfe_ù¾
->
	glogiÿl_size
 = 
fe_h—d”
.
fe_size
;

252  
	gŒue
;

255 
boŞ
 
	gA—dHªdËr
::
In™ŸlizeFe
(
fd
, cÚ¡ *
·th_Çme
,

256 
boŞ
 
is_Ãw_fe
) {

257 ià(!
IsP©hNameV®id
(
·th_Çme
)) {

258 
LOG
(
ERROR
) << "Invalid input when initializing file,…ath_name="

259 << 
	g·th_Çme
;

260 
	g”ºo
 = 
EINVAL
;

261  
	gçl£
;

264 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

266 autØ
	gfd_™
 = 
fm­_
.
fšd
(
fd
);

267 ià(
	gfd_™
 !ğ
fm­_
.
’d
()) {

268 
LOG
(
ERROR
) << "Attempt madeo initialize‡lready initialized file, fd="

269 << 
fd
 << ",…©h_Çmğ" << 
·th_Çme


270 << ", is_Ãw_fğ" << 
is_Ãw_fe
;

271 
	g”ºo
 = 
EEXIST
;

272  
	gçl£
;

275 
VLOG
(2è<< "In™Ÿlizšg secu» fe, fd = " << 
	gfd


276 << ",…©h_Çmğ" << 
	g·th_Çme
;

277 autØ
	g·th_™
 = 
İ’ed_fes_
.
fšd
(
·th_Çme
);

278 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
 =

279 (
·th_™
 =ğ
İ’ed_fes_
.
’d
())

280 ? 
¡d
::
make_sh¬ed
<
FeCÚŒŞ
>(
·th_Çme
, 
	gis_Ãw_fe
)

281 : 
·th_™
->
£cÚd
;

282 
	gfm­_
.
em¶aû
(
fd
, 
fe_ù¾
);

283 
	gİ’ed_fes_
.
em¶aû
(
·th_Çme
, 
fe_ù¾
);

285  
	gŒue
;

288 
boŞ
 
	gA—dHªdËr
::
R‘r›veLogiÿlOff£t
(
fd
, 
off_t
 *
logiÿl_off£t
) const {

289 ià(
	gfd
 < 0) {

290 
	g”ºo
 = 
EINVAL
;

291  
	gçl£
;

294 
off_t
 
	gphysiÿl_off£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 0, 
SEEK_CUR
);

295 ià(
	gphysiÿl_off£t
 == -1) {

296 
LOG
(
ERROR
è<< "FaedØ»Œ›vSEEK_CUR off£ˆÚ desütÜ: " << 
fd
;

297  
	gçl£
;

300 *
	glogiÿl_off£t
 = 
off£t_Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
physiÿl_off£t
);

301 ià(*
	glogiÿl_off£t
 =ğ
Off£tT¿n¦©Ü
::
kInv®idOff£t
) {

302 
LOG
(
ERROR
è<< "Thfi cÜru±ed, fd = " << 
fd
;

303  
	gçl£
;

306  
	gŒue
;

309 
GcmCry±Ü
 *
	gA—dHªdËr
::
G‘GcmCry±Ü
(cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
) const {

310 
fe_ù¾
.
mu
.
As£¹H–d
();

311 ià(!
	gfe_ù¾
.
	gma¡”_key
) {

312 
LOG
(
ERROR
è<< "Ma¡” key ha nÙ b“À£t,…©h = " << 
	gfe_ù¾
.
	g·th
;

313  
	gnuÎ±r
;

316 
GcmCry±Ü
 *
	güy±Ü
 = 
GcmCry±ÜRegi¡ry
::
G‘In¡ªû
().
G‘GcmCry±Ü
(

317 
kBlockL’gth
, *
fe_ù¾
.
ma¡”_key
);

318 ià(!
	güy±Ü
) {

319 
LOG
(
ERROR
) << "Unableo instantiate GCM cryptor.";

322  
	güy±Ü
;

325 
ssize_t
 
	gA—dHªdËr
::
Deüy±AndV”ify
(
fd
, *
buf
, 
size_t
 
couÁ
) {

326 ià(!
	gbuf
) {

327 
	g”ºo
 = 
EINVAL
;

331 
off_t
 
	glogiÿl_off£t
;

332 ià(!
R‘r›veLogiÿlOff£t
(
fd
, &
logiÿl_off£t
)) {

336 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
;

338 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

340 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

341 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

342 
LOG
(
ERROR
è<< "A‰em± madtØ»ad from‡Àunİ’ed fe, fd = " << 
fd
;

343 
	g”ºo
 = 
ENOENT
;

347 
	gfe_ù¾
 = 
’Œy
->
£cÚd
;

350 
	gab¦
::
Mu‹xLock
 
lock
(&
fe_ù¾
->
mu
);

351  
Deüy±AndV”ifyIÁ”Çl
(
fd
, 
buf
, 
couÁ
, *
fe_ù¾
, 
logiÿl_off£t
);

354 
ssize_t
 
	gA—dHªdËr
::
Deüy±AndV”ifyIÁ”Çl
(
fd
, *
buf
, 
size_t
 
couÁ
,

355 cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
,

356 
off_t
 
logiÿl_off£t
) const {

357 
	gfe_ù¾
.
	gmu
.
As£¹H–d
();

358 ià(
	gcouÁ
 == 0) {

363 ià(
	glogiÿl_off£t
 >ğ
fe_ù¾
.
logiÿl_size
) {

368 ià(
	glogiÿl_off£t
 + 
	gcouÁ
 >ğ
fe_ù¾
.
logiÿl_size
) {

369 
couÁ
 = 
fe_ù¾
.
logiÿl_size
 - 
logiÿl_off£t
;

373 
size_t
 
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
;

374 
size_t
 
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
;

375 
size_t
 
	gfuÎ_šşusive_blocks_by‹s_couÁ
;

376 
	goff£t_Œª¦©Ü_
->
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

377 
logiÿl_off£t
, 
couÁ
, &
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

378 &
Ï¡_·¹Ÿl_block_by‹s_couÁ
, &
fuÎ_šşusive_blocks_by‹s_couÁ
);

381 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
;

382 cÚ¡ 
size_t
 
	gphysiÿl_by‹s_couÁ
 =

383 (
fuÎ_šşusive_blocks_by‹s_couÁ
 / 
kBlockL’gth
è* 
kSecu»BlockL’gth
;

384 
	gbufãr
.
»size
(
physiÿl_by‹s_couÁ
);

387 cÚ¡ 
off_t
 
	gfœ¡_logiÿl_block_off£t
 =

388 (
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0)

389 ? (
logiÿl_off£t
 + 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 - 
kBlockL’gth
)

390 : 
logiÿl_off£t
;

391 cÚ¡ 
off_t
 
	gfœ¡_physiÿl_block_off£t
 =

392 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
fœ¡_logiÿl_block_off£t
);

393 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

394 
off_t
 
	goff£t
 =

395 
’c_uÁru¡ed_l£ek
(
fd
, 
fœ¡_physiÿl_block_off£t
, 
SEEK_SET
);

396 ià(
	goff£t
 == -1) {

397 
LOG
(
ERROR
)

406 
ssize_t
 
	gby‹s_»ad
 =

407 
’c_uÁru¡ed_»ad
(
fd
, 
bufãr
.
d©a
(), 
physiÿl_by‹s_couÁ
);

408 ià(
	gby‹s_»ad
 <= 0) {

409 
LOG
(
ERROR
è<< "CªnÙ v”ify d©¨- d©¨ha nÙ b“À»ad, fd = " << 
fd
;

415 
	gby‹s_»ad
 = (
by‹s_»ad
 / 
kSecu»BlockL’gth
) * kSecureBlockLength;

416 ià(
	gby‹s_»ad
 == 0) {

417 
LOG
(
ERROR
è<< "CªnÙ v”ify d©¨- d©¨ha nÙ b“À»ad, fd = " << 
fd
;

422 
off_t
 
	gÃw_cur_logiÿl_off£t
 = 
logiÿl_off£t
 + 
couÁ
;

423 ià(
	gby‹s_»ad
 !ğ
physiÿl_by‹s_couÁ
) {

424 
št64_t
 
blocks_nÙ_»ad
 =

425 (
physiÿl_by‹s_couÁ
 - 
by‹s_»ad
è/ 
kSecu»BlockL’gth
;

426 ià(
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

427 
	gÃw_cur_logiÿl_off£t
 -ğ
Ï¡_·¹Ÿl_block_by‹s_couÁ
;

428 
	gblocks_nÙ_»ad
--;

430 
	gÃw_cur_logiÿl_off£t
 -ğ
blocks_nÙ_»ad
 * 
kBlockL’gth
;

432 cÚ¡ 
off_t
 
	gÃw_cur_physiÿl_off£t
 =

433 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
Ãw_cur_logiÿl_off£t
);

434 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
Ãw_cur_physiÿl_off£t
, 
SEEK_SET
);

435 ià(
	goff£t
 == -1) {

436 
LOG
(
ERROR
) << "Failed†seekoheƒnd of„ead„ange.";

440 
GcmCry±Ü
 *
	güy±Ü
 = 
G‘GcmCry±Ü
(
fe_ù¾
);

441 ià(!
	güy±Ü
) {

446 cÚ¡ 
št64_t
 
	gblocks_»ad
 = 
by‹s_»ad
 / 
kSecu»BlockL’gth
;

447 cÚ¡ 
št64_t
 
	gblocks_»ad_max
 = 
physiÿl_by‹s_couÁ
 / 
kSecu»BlockL’gth
;

448 cÚ¡ 
off_t
 
	gfœ¡_block_šdex
 =

449 (
fœ¡_physiÿl_block_off£t
 - (
FeH—d”
)è/ 
kSecu»BlockL’gth
;

450 
size_t
 
	g»ad_couÁ
 = 0;

451 
št64_t
 
	gblock_šdex
 = 0; block_šdex < 
	gblocks_»ad
; block_index++) {

452 cÚ¡ 
size_t
 
	gm”kË_block_idx
 = 
fœ¡_block_šdex
 + 
block_šdex
 + 1;

454 
ušt8_t
 *
	g¶aš‹xt_d©a
 =

455 
G‘PÏš‹xtBufãr
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
block_šdex
, 
buf
);

459 ià(
	gfe_ù¾
.
	gad
->
L—fHash
(
m”kË_block_idx
è=ğ
fe_ù¾
.
z”o_hash
) {

460 
VLOG
(2) << "A sparse„egion block detected.";

461 
mem£t
(
¶aš‹xt_d©a
, 0, 
kBlockL’gth
);

462 
	g»ad_couÁ
 +ğ
kBlockL’gth
;

466 
Ch”‹xtV›w
 
ch”‹xt
(
bufãr
.
d©a
(è+ 
block_šdex
 * 
kSecu»BlockL’gth
,

467 
kCh”BlockL’gth
);

468 
VLOG
(2) << "Ciphertext„ead: "

469 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

470 
»š‹½»t_ÿ¡
<cÚ¡ *>(
ch”‹xt
.
d©a
()),

471 
kCh”BlockL’gth
));

473 
TagV›w
 
g
(
bufãr
.
d©a
(è+ 
block_šdex
 * 
kSecu»BlockL’gth
 + 
kBlockL’gth
,

474 
kTagL’gth
);

475 
VLOG
(2) << "Authag„ead: "

476 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

477 
»š‹½»t_ÿ¡
<cÚ¡ *>(
g
.
d©a
()), 
kTagL’gth
));

479 
Tok’V›w
 
tok’
(

480 
bufãr
.
d©a
(è+ 
block_šdex
 * 
kSecu»BlockL’gth
 + 
kCh”BlockL’gth
,

481 
kTok’L’gth
);

482 
VLOG
(2) << "Token„ead: "

483 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

484 
»š‹½»t_ÿ¡
<cÚ¡ *>(
tok’
.
d©a
()), 
kTok’L’gth
));

489 ià(
	gfe_ù¾
.
	gad
->
L—fHash
(
m”kË_block_idx
) !=

490 
fe_ù¾
.
ad
->
L—fHash
(
¡d
::
¡ršg
(

491 
»š‹½»t_ÿ¡
<cÚ¡ *>(
g
.
d©a
()), 
kTagL’gth
))) {

492 
LOG
(
ERROR
è<< "IÁegr™y v”ifiÿtiÚ faed, fd = " << 
	gfd
;

497 
Block
 
	gbounû_block
;

499 
ušt8_t
 *
	gdeüy±_rg‘
;

502 ià((
	gblock_šdex
 =ğ0 && 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) ||

503 (
block_šdex
 =ğ
blocks_»ad_max
 - 1 &&

504 
Ï¡_·¹Ÿl_block_by‹s_couÁ
 > 0)) {

505 
deüy±_rg‘
 = 
bounû_block
.
d©a
();

507 
	gdeüy±_rg‘
 = 
¶aš‹xt_d©a
;

511 ià(!
	güy±Ü
->
Deüy±Block
(
ch”‹xt
.
d©a
(), 
tok’
.data(),

512 
deüy±_rg‘
)) {

513 
LOG
(
ERROR
è<< "Deüy±iÚ faed, fd = " << 
	gfd
;

519 ià(
	gblock_šdex
 =ğ0 && 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

520 
¡d
::
cİy_n
(

521 
bounû_block
.
begš
(è+ 
kBlockL’gth
 - 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

522 
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
¶aš‹xt_d©a
);

523 
	g»ad_couÁ
 +ğ
fœ¡_·¹Ÿl_block_by‹s_couÁ
;

524 } ià(
	gblock_šdex
 =ğ
blocks_»ad_max
 - 1 &&

525 
Ï¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

526 
¡d
::
cİy_n
(
bounû_block
.
begš
(), 
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

527 
¶aš‹xt_d©a
);

528 
	g»ad_couÁ
 +ğ
Ï¡_·¹Ÿl_block_by‹s_couÁ
;

530 
	g»ad_couÁ
 +ğ
kBlockL’gth
;

534 
VLOG
(2è<< "V”if›d„—d blocks, blocks_»ad = " << 
	gblocks_»ad


535 << ", by‹s_»ad = " << 
	gby‹s_»ad
;

536  
	g»ad_couÁ
;

539 
boŞ
 
	gA—dHªdËr
::
Upd©eDige¡
(
FeCÚŒŞ
 *
fe_ù¾
,

540 cÚ¡ 
GcmCry±Ü
 &
üy±Ü
) const {

541 ià(!
	gfe_ù¾
) {

542 
	g”ºo
 = 
EINVAL
;

543  
	gçl£
;

545 
	gfe_ù¾
->
	gmu
.
As£¹H–d
();

547 
	gfd
 = 
’c_uÁru¡ed_İ’
(
fe_ù¾
->
·th
.
c_¡r
(), 
O_WRONLY
);

548 ià(
	gfd
 == -1) {

549 
LOG
(
ERROR
) << "Failedo open fileo save data digest,…ath="

550 << 
fe_ù¾
->
·th
 << ",ƒ¼nØğ" << 
”ºo
;

551  
	gçl£
;

554 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

556 
	g¡d
::
¡ršg
 
roÙ
 = 
fe_ù¾
->
ad
->
Cu¼’tRoÙ
();

557 ià(
	groÙ
.
size
(è!ğ
kRoÙHashL’gth
) {

558 
LOG
(
ERROR
) << "Unexpected size of„oot hashƒncountered, size="

559 << 
roÙ
.
size
();

560  
	gçl£
;

564 
D©aDige¡
 
	gd©a_dige¡
;

565 
	g¡d
::
cİy_n
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
roÙ
.
d©a
()), 
kRoÙHashL’gth
,

566 
d©a_dige¡
.
d©a
());

567 
	gd©a_dige¡
.
	gfe_size
 = 
fe_ù¾
->
logiÿl_size
;

569 
FeH—d”
 
	gh—d”
;

570 ià(!
	güy±Ü
.
G‘AuthTag
(
h—d”
.
d©a
(), 
d©a_dige¡
.data(),

571 (
D©aDige¡
))) {

572 
LOG
(
ERROR
è<< "FaedØg’”©CMAC,„oÙ = " << 
	groÙ
;

573  
	gçl£
;

575 
	gh—d”
.
	gfe_size
 = 
fe_ù¾
->
logiÿl_size
;

577 
VLOG
(2è<< "Upd©šghdige¡ fÜ fe: " << 
	gfe_ù¾
->
	g·th


578 << ",„oÙ hash: " << 
	gab¦
::
By‹sToHexSŒšg
(
roÙ
);

579 
ssize_t
 
	gby‹s_wr™‹n
 = 
wr™e_®l
(
fd
, 
h—d”
.
d©a
(), (
FeH—d”
));

580 ià(
	gby‹s_wr™‹n
 !ğ(
FeH—d”
)) {

581 
LOG
(
ERROR
) << "Failedo write full digesto file,…ath="

582 << 
fe_ù¾
->
·th
 << ", by‹ wr™‹Àğ" << 
by‹s_wr™‹n
;

583  
	gçl£
;

586 ià(!
	gfd_şo£r
.
»£t
()) {

587 
LOG
(
ERROR
) << "Failedo closehe file‡fter digest update,…ath="

588 << 
	gfe_ù¾
->
	g·th
;

589  
	gçl£
;

592  
	gŒue
;

595 
boŞ
 
	gA—dHªdËr
::
R—dFuÎBlock
(cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
,

596 
off_t
 
logiÿl_off£t
, 
Block
 *
block
) const {

597 
	gfe_ù¾
.
	gmu
.
As£¹H–d
();

598 ià(
	glogiÿl_off£t
 < 0 ||†ogiÿl_off£ˆ% 
	gkBlockL’gth
 != 0) {

599 
”ºo
 = 
EINVAL
;

600  
	gçl£
;

603 
	gfd
 = 
’c_uÁru¡ed_İ’
(
fe_ù¾
.
·th
.
c_¡r
(), 
O_RDONLY
);

604 ià(
	gfd
 == -1) {

605 
LOG
(
ERROR
è<< "FaedØİ’ ftØ»ad‡ block,…©h=" << 
fe_ù¾
.
·th


606 << ",ƒ¼nØğ" << 
”ºo
;

607  
	gçl£
;

610 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

612 
off_t
 
	gphysiÿl_off£t
 = 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
logiÿl_off£t
);

613 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
physiÿl_off£t
, 
SEEK_SET
);

614 ià(
	goff£t
 == -1) {

615 
LOG
(
ERROR
) << "Failed†seek when„eading‡ full block.";

616  
	gçl£
;

619 
ssize_t
 
	gby‹s_»ad
 = 
Deüy±AndV”ifyIÁ”Çl
(
fd
, 
block
->
d©a
(), 
kBlockL’gth
,

620 
fe_ù¾
, 
logiÿl_off£t
);

621 ià(
	gby‹s_»ad
 == -1) {

625 ià(
	gby‹s_»ad
 < 
	gkBlockL’gth
) {

626 
mem£t
(
block
->
d©a
(è+ 
by‹s_»ad
, 0, 
kBlockL’gth
 - bytes_read);

629  
	gŒue
;

632 
ssize_t
 
	gA—dHªdËr
::
Enüy±AndP”si¡
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

633 ià(!
	gbuf
) {

634 
	g”ºo
 = 
EINVAL
;

638 
off_t
 
	glogiÿl_off£t
;

639 ià(!
R‘r›veLogiÿlOff£t
(
fd
, &
logiÿl_off£t
)) {

643 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
;

645 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

647 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

648 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

649 
LOG
(
ERROR
è<< "A‰em± madtØwr™tØª unİ’ed fe, fd = " << 
fd
;

650 
	g”ºo
 = 
ENOENT
;

654 
	gfe_ù¾
 = 
’Œy
->
£cÚd
;

657 ià(
	gcouÁ
 == 0) {

661 
	gab¦
::
Mu‹xLock
 
lock
(&
fe_ù¾
->
mu
);

664 
size_t
 
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
;

665 
size_t
 
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
;

666 
size_t
 
	gfuÎ_šşusive_blocks_by‹s_couÁ
;

667 
	goff£t_Œª¦©Ü_
->
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

668 
logiÿl_off£t
, 
couÁ
, &
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

669 &
Ï¡_·¹Ÿl_block_by‹s_couÁ
, &
fuÎ_šşusive_blocks_by‹s_couÁ
);

672 
Block
 
	gfœ¡_block
;

673 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

674 ià(!
R—dFuÎBlock
(

675 *
fe_ù¾
,

676 
logiÿl_off£t
 + 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 - 
kBlockL’gth
,

677 &
fœ¡_block
)) {

678 
LOG
(
ERROR
)

680 << 
	gfd
;

684 
	g¡d
::
cİy_n
(

685 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
), 
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

686 
fœ¡_block
.
d©a
(è+ 
kBlockL’gth
 - 
fœ¡_·¹Ÿl_block_by‹s_couÁ
);

690 
Block
 
	gÏ¡_block
;

691 ià(
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

692 ià(!
R—dFuÎBlock
(*
fe_ù¾
,

693 
logiÿl_off£t
 + 
couÁ
 - 
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

694 &
Ï¡_block
)) {

695 
LOG
(
ERROR
)

697 << 
	gfd
;

701 
	g¡d
::
cİy_n
(
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
buf
è+ 
couÁ
 -

702 
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

703 
Ï¡_·¹Ÿl_block_by‹s_couÁ
, 
Ï¡_block
.
d©a
());

706 cÚ¡ 
off_t
 
	gfœ¡_logiÿl_block_off£t
 =

707 (
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0)

708 ? (
logiÿl_off£t
 + 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 - 
kBlockL’gth
)

709 : 
logiÿl_off£t
;

710 cÚ¡ 
off_t
 
	gfœ¡_physiÿl_block_off£t
 =

711 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
fœ¡_logiÿl_block_off£t
);

712 cÚ¡ 
št64_t
 
	geof_block_šdex
 = 
fe_ù¾
->
ad
->
L—fCouÁ
();

713 
št64_t
 
	g¡¬t_block_to_wr™e
 = 0;

714 ià(
	gfœ¡_physiÿl_block_off£t
 > 
	gfe_ù¾
->
physiÿl_size
()) {

716 
št64_t
 
	g¥¬£_blocks_couÁ
 =

717 (
fœ¡_physiÿl_block_off£t
 - 
fe_ù¾
->
physiÿl_size
()) /

718 
kSecu»BlockL’gth
;

719 
št64_t
 
	gidx
 = 0; idx < 
	g¥¬£_blocks_couÁ
; idx++) {

720 
VLOG
(2) << "Adding‡nƒmpty‡uthago AD for‡ block "

722 << 
	gab¦
::
By‹sToHexSŒšg
(
fe_ù¾
->
z”o_hash
);

723 
	gfe_ù¾
->
	gad
->
AddL—fHash
(
fe_ù¾
->
z”o_hash
);

725 
	g¡¬t_block_to_wr™e
 = 
eof_block_šdex
 + 
¥¬£_blocks_couÁ
;

727 
št64_t
 
	gblocks_to_eof
 =

728 (
fe_ù¾
->
physiÿl_size
(è- 
fœ¡_physiÿl_block_off£t
) /

729 
kSecu»BlockL’gth
;

730 
	g¡¬t_block_to_wr™e
 = 
eof_block_šdex
 - 
blocks_to_eof
;

733 
GcmCry±Ü
 *
	güy±Ü
 = 
G‘GcmCry±Ü
(*
fe_ù¾
);

734 ià(!
	güy±Ü
) {

738 
VLOG
(2è<< "Wr™šg d©¨tØfe, couÁ = " << 
	gcouÁ
 << ", fd = " << 
	gfd
;

741 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
;

742 cÚ¡ 
št64_t
 
	gblocks_to_wr™e
 =

743 
fuÎ_šşusive_blocks_by‹s_couÁ
 / 
kBlockL’gth
;

744 cÚ¡ 
size_t
 
	gphysiÿl_by‹s_couÁ
 = 
blocks_to_wr™e
 * 
kSecu»BlockL’gth
;

745 
	gbufãr
.
»size
(
physiÿl_by‹s_couÁ
);

748 
	g¡d
::
veùÜ
<
Tag
> 
gs
;

749 
št64_t
 
	gblock_šdex
 = 0; block_šdex < 
	gblocks_to_wr™e
; block_index++) {

750 cÚ¡ 
ušt8_t
 *
	g¶aš‹xt_d©a
 =

751 
G‘PÏš‹xtBufãr
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
, 
block_šdex
, 
buf
);

754 cÚ¡ 
ušt8_t
 *
	g’üy±_sourû
;

757 ià(
	gblock_šdex
 =ğ0 && 
fœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

758 
’üy±_sourû
 = 
fœ¡_block
.
d©a
();

759 } ià(
	gblock_šdex
 =ğ
blocks_to_wr™e
 - 1 &&

760 
Ï¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

761 
’üy±_sourû
 = 
Ï¡_block
.
d©a
();

763 
	g’üy±_sourû
 = 
¶aš‹xt_d©a
;

766 
Ch”‹xt
 *
	gch”‹xt
 =

767 
Ch”‹xt
::
PÏû
(&
bufãr
, 
block_šdex
 * 
kSecu»BlockL’gth
);

768 
Tok’
 *
	gtok’
 = Tok’::
PÏû
(

769 &
bufãr
, 
block_šdex
 * 
kSecu»BlockL’gth
 + 
kCh”BlockL’gth
);

772 ià(!
	güy±Ü
->
Enüy±Block
(
’üy±_sourû
, 
tok’
->
d©a
(),

773 
ch”‹xt
->
d©a
())) {

774 
LOG
(
ERROR
è<< "Enüy±iÚ faed, fd = " << 
	gfd
;

777 
VLOG
(2) << "Ciphertext generated: "

778 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

779 
»š‹½»t_ÿ¡
<cÚ¡ *>(
ch”‹xt
->
d©a
()),

780 
kBlockL’gth
));

781 
VLOG
(2) << "Token generated: "

782 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

783 
»š‹½»t_ÿ¡
<cÚ¡ *>(
tok’
->
d©a
()),

784 
kTok’L’gth
));

786 
TagV›w
 
g
(
ch”‹xt
->
d©a
(è+ 
kBlockL’gth
, 
kTagL’gth
);

787 
	ggs
.
push_back
(
g
);

788 
VLOG
(2) << "Authag generated: "

789 << 
	gab¦
::
By‹sToHexSŒšg
(
ab¦
::
¡ršg_v›w
(

790 
»š‹½»t_ÿ¡
<cÚ¡ *>(
g
.
d©a
()), 
kTagL’gth
));

794 ià(
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

795 
off_t
 
	goff£t
 =

796 
’c_uÁru¡ed_l£ek
(
fd
, 
fœ¡_physiÿl_block_off£t
, 
SEEK_SET
);

797 ià(
	goff£t
 == -1) {

798 
LOG
(
ERROR
)

812 
ssize_t
 
	gby‹s_wr™‹n
 = 
wr™e_®l
(
fd
, 
bufãr
.
d©a
(), 
physiÿl_by‹s_couÁ
);

813 ià(
	gby‹s_wr™‹n
 !ğ
physiÿl_by‹s_couÁ
) {

814 
LOG
(
ERROR
) << "Failedo writeƒncrypted datao file,…ath="

815 << 
fe_ù¾
->
·th
 << ", by‹ wr™‹Àğ" << 
by‹s_wr™‹n
;

820 ià(
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

821 
off_t
 
	gÃw_cur_logiÿl_off£t
 = 
logiÿl_off£t
 + 
couÁ
;

822 
off_t
 
	gÃw_cur_physiÿl_off£t
 =

823 
off£t_Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
Ãw_cur_logiÿl_off£t
);

824 
off_t
 
	goff£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
Ãw_cur_physiÿl_off£t
, 
SEEK_SET
);

825 ià(
	goff£t
 == -1) {

826 
LOG
(
ERROR
)

832 
št64_t
 
	gidx
 = 0; idx < 
	ggs
.
size
(); idx++) {

833 
	g¡d
::
¡ršg
 
g_¡ršg
(
»š‹½»t_ÿ¡
<*>(
gs
[
idx
].
d©a
()),

834 
kTagL’gth
);

835 
št64_t
 
	gblock_šdex
 = 
¡¬t_block_to_wr™e
 + 
idx
;

836 ià(
	gblock_šdex
 < 
	geof_block_šdex
) {

837 
VLOG
(2) << "Updating‡uthag on AD: "

838 << 
	gab¦
::
By‹sToHexSŒšg
(
g_¡ršg
);

839 
	gfe_ù¾
->
	gad
->
Upd©eL—f
(
block_šdex
 + 1, 
g_¡ršg
);

841 
VLOG
(2) << "Appending‡uthago AD: "

842 << 
	gab¦
::
By‹sToHexSŒšg
(
g_¡ršg
);

843 
	gfe_ù¾
->
	gad
->
AddL—f
(
g_¡ršg
);

847 
	gfe_ù¾
->
	glogiÿl_size
 = 
logiÿl_off£t
 + 
couÁ
;

849 ià(!
Upd©eDige¡
(
fe_ù¾
.
g‘
(), *
üy±Ü
)) {

853 
VLOG
(2è<< "WrÙd©¨tØfe, by‹s_wr™‹Àğ" << 
	gby‹s_wr™‹n
;

855  
	gcouÁ
;

858 
boŞ
 
	gA—dHªdËr
::
Fš®izeFe
(
fd
) {

859 
ab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

861 ià(
	gfd
 < 0) {

862 
	g”ºo
 = 
EINVAL
;

863  
	gçl£
;

866 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

867 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

868 
LOG
(
ERROR
è<< "A‰em± madtØfš®izunš™Ÿlized fe, fd = " << 
fd
;

869 
	g”ºo
 = 
ENOENT
;

870  
	gçl£
;

878 
VLOG
(2è<< "Fš®izšg secu» fe, fd = " << 
	gfd


879 << ",…©hÇmğ" << 
	g’Œy
->
	g£cÚd
->
	g·th
;

880 
	gİ’ed_fes_
.
”a£
(
’Œy
->
£cÚd
->
·th
);

881 
	gfm­_
.
”a£
(
’Œy
);

883  
	gŒue
;

890 
	gA—dHªdËr
::
S‘Ma¡”Key
(
fd
, cÚ¡ 
ušt8_t
 *
key_d©a
,

891 
ušt32_t
 
key_Ëngth
) {

892 ià(!
	gkey_d©a
 || 
	gkey_Ëngth
 !ğ
kKeyL’gth
) {

893 
LOG
(
ERROR
) << "Attempt madeo set‡n invalid key.";

894 
	g”ºo
 = 
EINVAL
;

898 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
> 
fe_ù¾
;

900 
	gab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

902 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

903 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

904 
LOG
(
ERROR
è<< "A‰em± madtØ£ˆkey oÀª unİ’ed fe, fd = " << 
fd
;

905 
	g”ºo
 = 
ENOENT
;

909 
	gfe_ù¾
 = 
’Œy
->
£cÚd
;

912 
	gab¦
::
Mu‹xLock
 
lock
(&
fe_ù¾
->
mu
);

914 ià(
	gfe_ù¾
->
	gis_de£rŸlized
) {

915 ià(
memcmp
(
fe_ù¾
->
ma¡”_key
->
d©a
(), 
key_d©a
, 
kKeyL’gth
) != 0) {

916 
LOG
(
ERROR
) << "Attempt madeo set‡‚ew key on‡nƒxisting file, fd="

917 << 
fd
;

924 
	gfe_ù¾
->
	gma¡”_key
 =

925 
ab¦
::
make_unique
<
GcmCry±ÜKey
>(
key_d©a
, 
	gkey_Ëngth
);

926 ià(!
De£rŸlize
(
fe_ù¾
.
g‘
())) {

927 
LOG
(
ERROR
) << "Failedo deserialize integrity metadata for file,…ath="

928 << 
	gfe_ù¾
->
	g·th
;

932 
	gfe_ù¾
->
	gis_de£rŸlized
 = 
Œue
;

936 cÚ¡ 
	gOff£tT¿n¦©Ü
 &
	gA—dHªdËr
::
G‘Off£tT¿n¦©Ü
() const {

937  *
off£t_Œª¦©Ü_
;

940 
off_t
 
	gA—dHªdËr
::
G‘LogiÿlFeSize
(
fd
) {

941 
ab¦
::
Mu‹xLock
 
glob®_lock
(&
mu_
);

942 autØ
	g’Œy
 = 
fm­_
.
fšd
(
fd
);

943 ià(
	g’Œy
 =ğ
fm­_
.
’d
()) {

944 
LOG
(
ERROR
)

946 << 
fd
;

949  
	g’Œy
->
	g£cÚd
->
	glogiÿl_size
;

	@platform/storage/secure/aead_handler.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_SECURE_AEAD_HANDLER_H_


20 
	#ASYLO_PLATFORM_STORAGE_SECURE_AEAD_HANDLER_H_


	)

22 
	~<¡dšt.h
>

23 
	~<memÜy
>

24 
	~<¡ršg
>

26 
	~"ab¦/ba£/©Œibu‹s.h
"

27 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

28 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

29 
	~"asylo/üy±o/ut/by‹s.h
"

30 
	~"asylo/¶©fÜm/üy±o/gcmlib/gcm_üy±Ü.h
"

31 
	~"asylo/¶©fÜm/¡Üage/£cu»/auth’tiÿ‹d_diùiÚ¬y.h
"

32 
	~"asylo/¶©fÜm/¡Üage/£cu»/ùmmt_auth’tiÿ‹d_diùiÚ¬y.h
"

33 
	~"asylo/¶©fÜm/¡Üage/uts/off£t_Œª¦©Ü.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	g¶©fÜm
 {

37 
Çme¥aû
 
	g¡Üage
 {

39 
usšg
 
	güy±o
::
gcmlib
::
GcmCry±Ü
;

40 
usšg
 
	güy±o
::
gcmlib
::
GcmCry±ÜKey
;

41 
usšg
 
	güy±o
::
gcmlib
::
kKeyL’gth
;

42 
usšg
 
	güy±o
::
gcmlib
::
kTagL’gth
;

43 
usšg
 
	güy±o
::
gcmlib
::
kTok’L’gth
;

46 
cÚ¡ex´
 
size_t
 
	gkBlockL’gth
 = 128;

47 
usšg
 
	gBlock
 = 
Un§ãBy‹s
<
kBlockL’gth
>;

50 
cÚ¡ex´
 
št64_t
 
	gkRoÙHashL’gth
 = 32;

53 
cÚ¡ex´
 
št64_t
 
	gkFeHashL’gth
 = 16;

58 
cÚ¡ex´
 
size_t
 
	gkCh”BlockL’gth
 = 
kBlockL’gth
 + 
kTagL’gth
;

59 
cÚ¡ex´
 
size_t
 
	gkSecu»BlockL’gth
 = 
kCh”BlockL’gth
 + 
kTok’L’gth
;

61 
usšg
 
	gFeHash
 = 
Un§ãBy‹s
<
kFeHashL’gth
>;

62 
usšg
 
	gFeDige¡
 = 
Un§ãBy‹s
<
kRoÙHashL’gth
>;

72 şas 
	cA—dHªdËr
 {

73 
	gpublic
:

74 
A—dHªdËr
 &
G‘In¡ªû
() {

75 
A—dHªdËr
 *
š¡ªû
 = 
Ãw
 AeadHandler;

76  *
	gš¡ªû
;

83 
boŞ
 
In™ŸlizeFe
(
fd
, cÚ¡ *
·th_Çme
, boŞ 
is_Ãw_fe
)

84 
LOCKS_EXCLUDED
(
mu_
);

88 
ssize_t
 
Deüy±AndV”ify
(
fd
, *
buf
, 
size_t
 
couÁ
è
LOCKS_EXCLUDED
(
mu_
);

92 
ssize_t
 
Enüy±AndP”si¡
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

93 
LOCKS_EXCLUDED
(
mu_
);

98 
boŞ
 
Fš®izeFe
(
fd
è
LOCKS_EXCLUDED
(
mu_
);

101 
S‘Ma¡”Key
(
fd
, cÚ¡ 
ušt8_t
 *
key_d©a
, 
ušt32_t
 
key_Ëngth
)

102 
LOCKS_EXCLUDED
(
mu_
);

105 
off_t
 
G‘LogiÿlFeSize
(
fd
è
LOCKS_EXCLUDED
(
mu_
);

107 cÚ¡ 
	gOff£tT¿n¦©Ü
 &
G‘Off£tT¿n¦©Ü
() const;

109 
	g´iv©e
:

111 
	sFeH—d”
 {

113 
FeHash
 
fe_hash
;

117 
size_t
 
	gfe_size
;

120 
ušt8_t
 *
d©a
(è{  
	gfe_hash
.data(); }

121 } 
	gABSL_ATTRIBUTE_PACKED
;

125 
	sD©aDige¡
 {

127 
FeDige¡
 
	gfe_dige¡
;

130 
size_t
 
	gfe_size
;

133 
ušt8_t
 *
d©a
(è{  
	gfe_dige¡
.data(); }

134 } 
	gABSL_ATTRIBUTE_PACKED
;

137 
	sFeCÚŒŞ
 {

138 cÚ¡ 
	g¡d
::
¡ršg
 
·th
;

139 
size_t
 
	glogiÿl_size
;

140 
boŞ
 
	gis_Ãw
;

141 
boŞ
 
	gis_de£rŸlized
;

142 
	g¡d
::
unique_±r
<
Auth’tiÿ‹dDiùiÚ¬y
> 
ad
;

143 
	g¡d
::
¡ršg
 
z”o_hash
;

144 
	g¡d
::
unique_±r
<
GcmCry±ÜKey
> 
ma¡”_key
;

147 
	gab¦
::
Mu‹x
 
mu
;

149 
FeCÚŒŞ
(cÚ¡ *
·th_Çme
, 
boŞ
 
is_Ãw_fe
)

150 : 
·th
(
·th_Çme
),

151 
logiÿl_size
(0),

152 
is_Ãw
(
is_Ãw_fe
),

153 
is_de£rŸlized
(
çl£
),

154 
ad
(
ab¦
::
make_unique
<
CTMMTAuth’tiÿ‹dDiùiÚ¬y
>()) {

155 
Un§ãBy‹s
<
kTagL’gth
> 
g
;

156 
mem£t
(
g
.
d©a
(), 0, 
kTagL’gth
);

157 
	g¡d
::
¡ršg
 
g_¡ršg
(
»š‹½»t_ÿ¡
<*>(
g
.
d©a
()), 
kTagL’gth
);

158 
	gz”o_hash
 = 
ad
->
L—fHash
(
g_¡ršg
);

164 
size_t
 
physiÿl_size
() {

165  (
	gFeH—d”
è+ 
	gad
->
L—fCouÁ
(è* 
	gkSecu»BlockL’gth
;

169 
A—dHªdËr
();

170 
A—dHªdËr
(A—dHªdË¸cÚ¡&èğ
d–‘e
;

171 
	gİ”©Ü
=(
A—dHªdËr
 cÚ¡&èğ
d–‘e
;

174 
boŞ
 
De£rŸlize
(
FeCÚŒŞ
 *
fe_ù¾
)

175 
EXCLUSIVE_LOCKS_REQUIRED
(
fe_ù¾
->
mu
);

179 
boŞ
 
R‘r›veLogiÿlOff£t
(
fd
, 
off_t
 *
logiÿl_off£t
) const;

182 
boŞ
 
Upd©eDige¡
(
FeCÚŒŞ
 *
fe_ù¾
, cÚ¡ 
GcmCry±Ü
 &
üy±Ü
) const

183 
EXCLUSIVE_LOCKS_REQUIRED
(
fe_ù¾
->
mu
);

187 
GcmCry±Ü
 *
G‘GcmCry±Ü
(cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
) const

188 
EXCLUSIVE_LOCKS_REQUIRED
(
fe_ù¾
.
mu
);

193 
ssize_t
 
Deüy±AndV”ifyIÁ”Çl
(
fd
, *
buf
, 
size_t
 
couÁ
,

194 cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
,

195 
off_t
 
logiÿl_off£t
) const

196 
EXCLUSIVE_LOCKS_REQUIRED
(
fe_ù¾
.
mu
);

200 
boŞ
 
R—dFuÎBlock
(cÚ¡ 
FeCÚŒŞ
 &
fe_ù¾
, 
off_t
 
logiÿl_off£t
,

201 
Block
 *
block
ècÚ¡ 
EXCLUSIVE_LOCKS_REQUIRED
(
fe_ù¾
.
mu
);

205 
	gab¦
::
æ©_hash_m­
<, 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
>> 
fm­_
 
GUARDED_BY
(
mu_
);

209 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	g¡d
::
sh¬ed_±r
<
FeCÚŒŞ
>> 
İ’ed_fes_


210 
GUARDED_BY
(
mu_
);

213 
	g¡d
::
unique_±r
<
Off£tT¿n¦©Ü
> 
off£t_Œª¦©Ü_
;

216 
	gab¦
::
Mu‹x
 
mu_
;

	@platform/storage/secure/authenticated_dictionary.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_SECURE_AUTHENTICATED_DICTIONARY_H_


20 
	#ASYLO_PLATFORM_STORAGE_SECURE_AUTHENTICATED_DICTIONARY_H_


	)

22 
	~<¡ršg
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g¶©fÜm
 {

26 
Çme¥aû
 
	g¡Üage
 {

33 şas 
	cAuth’tiÿ‹dDiùiÚ¬y
 {

34 
	gpublic
:

35 
vœtu®
 ~
Auth’tiÿ‹dDiùiÚ¬y
() = ;

38 
vœtu®
 
size_t
 
L—fCouÁ
() const = 0;

43 
vœtu®
 
size_t
 
AddL—f
(cÚ¡ 
¡d
::
¡ršg
 &
d©a
) = 0;

49 
vœtu®
 
size_t
 
AddL—fHash
(cÚ¡ 
¡d
::
¡ršg
 &
hash
) = 0;

53 
vœtu®
 
	g¡d
::
¡ršg
 
Cu¼’tRoÙ
() = 0;

56 
vœtu®
 
	g¡d
::
¡ršg
 
L—fHash
(
size_t
 
Ëaf
) const = 0;

59 
vœtu®
 
	g¡d
::
¡ršg
 
L—fHash
(cÚ¡ 
¡d
::¡ršg &
d©a
) const = 0;

63 
vœtu®
 
boŞ
 
Upd©eL—f
(
size_t
 
Ëaf
, cÚ¡ 
¡d
::
¡ršg
 &
d©a
) = 0;

	@platform/storage/secure/ctmmt_authenticated_dictionary.cc

19 
	~"asylo/¶©fÜm/¡Üage/£cu»/ùmmt_auth’tiÿ‹d_diùiÚ¬y.h
"

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~<m”kËŒ“/m”kË_Œ“.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g¶©fÜm
 {

26 
Çme¥aû
 
	g¡Üage
 {

28 
boŞ
 
	gCTMMTAuth’tiÿ‹dDiùiÚ¬y
::
Upd©eL—f
(
size_t
 
Ëaf
,

29 cÚ¡ 
¡d
::
¡ršg
 &
d©a
) {

30  
mŒ“_
->
Upd©eL—fHash
(
Ëaf
, mŒ“_->
L—fHash
(
d©a
));

	@platform/storage/secure/ctmmt_authenticated_dictionary.cc

19 
	~"asylo/¶©fÜm/¡Üage/£cu»/ùmmt_auth’tiÿ‹d_diùiÚ¬y.h
"

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~<m”kËŒ“/m”kË_Œ“.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g¶©fÜm
 {

26 
Çme¥aû
 
	g¡Üage
 {

28 
boŞ
 
	gCTMMTAuth’tiÿ‹dDiùiÚ¬y
::
Upd©eL—f
(
size_t
 
Ëaf
,

29 cÚ¡ 
¡d
::
¡ršg
 &
d©a
) {

30  
mŒ“_
->
Upd©eL—fHash
(
Ëaf
, mŒ“_->
L—fHash
(
d©a
));

	@platform/storage/secure/ctmmt_authenticated_dictionary.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_SECURE_CTMMT_AUTHENTICATED_DICTIONARY_H_


20 
	#ASYLO_PLATFORM_STORAGE_SECURE_CTMMT_AUTHENTICATED_DICTIONARY_H_


	)

22 
	~"ab¦/memÜy/memÜy.h
"

23 
	~"asylo/¶©fÜm/¡Üage/£cu»/auth’tiÿ‹d_diùiÚ¬y.h
"

24 
	~<m”kËŒ“/m”kË_Œ“.h
>

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g¶©fÜm
 {

28 
Çme¥aû
 
	g¡Üage
 {

32 şas 
	cCTMMTAuth’tiÿ‹dDiùiÚ¬y
 : 
public
 
Auth’tiÿ‹dDiùiÚ¬y
 {

33 
public
:

34 
CTMMTAuth’tiÿ‹dDiùiÚ¬y
()

35 : 
mŒ“_
(
ab¦
::
make_unique
<
MubËM”kËT»e
>(

36 
ab¦
::
make_unique
<
Sha256Hash”
>())) {}

38 
size_t
 
L—fCouÁ
(ècÚ¡ 
fš®
 {  
mŒ“_
->LeafCount(); }

40 
size_t
 
AddL—f
(cÚ¡ 
¡d
::
¡ršg
 &
d©a
è
fš®
 {

41  
mŒ“_
->
AddL—f
(
d©a
);

44 
size_t
 
AddL—fHash
(cÚ¡ 
¡d
::
¡ršg
 &
hash
è
fš®
 {

45  
mŒ“_
->
AddL—fHash
(
hash
);

48 
	g¡d
::
¡ršg
 
Cu¼’tRoÙ
(è
fš®
 {  
mŒ“_
->CurrentRoot(); }

50 
	g¡d
::
¡ršg
 
L—fHash
(
size_t
 
Ëaf
ècÚ¡ 
fš®
 {

51  
mŒ“_
->
L—fHash
(
Ëaf
);

54 
	g¡d
::
¡ršg
 
L—fHash
(cÚ¡ 
¡d
::¡ršg &
d©a
ècÚ¡ 
fš®
 {

55  
mŒ“_
->
L—fHash
(
d©a
);

58 
boŞ
 
Upd©eL—f
(
size_t
 
Ëaf
, cÚ¡ 
¡d
::
¡ršg
 &
d©a
è
fš®
;

60 
	g´iv©e
:

61 
¡d
::
unique_±r
<
MubËM”kËT»e
> 
mŒ“_
;

	@platform/storage/secure/enclave_storage_secure.cc

19 
	~"asylo/¶©fÜm/¡Üage/£cu»/’şave_¡Üage_£cu».h
"

22 
	~<sys/ty³s.h
>

25 
	~<fú.h
>

27 
	~<¡d¬g.h
>

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

30 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

31 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

32 
	~"asylo/¶©fÜm/¡Üage/uts/off£t_Œª¦©Ü.h
"

33 
	~"asylo/ut/loggšg.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	g¶©fÜm
 {

37 
Çme¥aû
 
	g¡Üage
 {

39 
£cu»_İ’
(cÚ¡ *
·thÇme
, 
æags
, ...) {

40 ià((
	gæags
 & 
	gO_APPEND
è|| (æag & 
	gO_TRUNC
)) {

41 
LOG
(
ERROR
) << "Currently O_APPEND‡nd O_TRUNC file creation flags‡re‚ot "

46 
mode_t
 
	gmode
 = 0;

47 ià(
	gæags
 & 
	gO_CREAT
) {

48 
va_li¡
 
	g­
;

49 
va_¡¬t
(
­
, 
æags
);

50 
	gmode
 = 
va_¬g
(
­
, 
mode_t
);

51 
va_’d
(
­
);

54 
boŞ
 
	gis_Ãw_fe
 = (
’c_uÁru¡ed_acûss
(
·thÇme
, 
F_OK
) == -1);

55 
	gfd
 = 
’c_uÁru¡ed_İ’
(
·thÇme
, 
æags
, 
mode
);

56 ià(
	gfd
 == -1) {

57 
LOG
(
ERROR
è<< "FaedØ£cu»ly o³Àfe: " << 
·thÇme
;

61 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

64 ià(
£cu»_l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

65 
LOG
(
ERROR
) << "Failedo initialize cursorohe†ogical offset of 0, fd="

66 << 
fd
;

70 ià(!
	gA—dHªdËr
::
G‘In¡ªû
().
In™ŸlizeFe
(
fd
, 
·thÇme
, 
is_Ãw_fe
)) {

71 
LOG
(
ERROR
è<< "FaedØš™Ÿliz£cu» hªdlšg oàfe: " << 
	g·thÇme
;

75 
	gfd_şo£r
.
»Ëa£
();

76  
	gfd
;

79 
ssize_t
 
£cu»_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

80  
	gA—dHªdËr
::
G‘In¡ªû
().
Deüy±AndV”ify
(
fd
, 
buf
, 
couÁ
);

83 
ssize_t
 
£cu»_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

84  
	gA—dHªdËr
::
G‘In¡ªû
().
Enüy±AndP”si¡
(
fd
, 
buf
, 
couÁ
);

87 
£cu»_şo£
(
fd
) {

88 
boŞ
 
	gfš®ize_»suÉ
 = 
A—dHªdËr
::
G‘In¡ªû
().
Fš®izeFe
(
fd
);

89  (
	gfš®ize_»suÉ
 && 
’c_uÁru¡ed_şo£
(
fd
) == 0) ? 0 : -1;

92 
off_t
 
£cu»_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
) {

93 ià(
	goff£t
 < 0) {

97 cÚ¡ 
	gOff£tT¿n¦©Ü
 &
	goff£t_Œª¦©Ü
 =

98 
A—dHªdËr
::
G‘In¡ªû
().
G‘Off£tT¿n¦©Ü
();

101 
off_t
 
	glogiÿl_off£t
;

102 
	gwh’û
) {

103 
	gSEEK_SET
: {

104 
logiÿl_off£t
 = 
off£t
;

106 
	gSEEK_CUR
: {

107 
off_t
 
physiÿl_cur_off£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 0, 
SEEK_CUR
);

108 ià(
	gphysiÿl_cur_off£t
 == -1) {

109 
LOG
(
ERROR
è<< "FaedØ»Œ›vcursÜ off£ˆÚ desütÜ: " << 
fd
;

112 
off_t
 
	glogiÿl_cur_off£t
 =

113 
off£t_Œª¦©Ü
.
PhysiÿlToLogiÿl
(
physiÿl_cur_off£t
);

114 
	glogiÿl_off£t
 = 
logiÿl_cur_off£t
 + 
off£t
;

116 
	gSEEK_END
: {

117 
off_t
 
logiÿl_eof_off£t
 =

118 
A—dHªdËr
::
G‘In¡ªû
().
G‘LogiÿlFeSize
(
fd
);

119 
	glogiÿl_off£t
 = 
logiÿl_eof_off£t
 + 
off£t
;

121 : 
logiÿl_off£t
 = 0;

125 
off_t
 
	gphysiÿl_off£t
 = 
off£t_Œª¦©Ü
.
LogiÿlToPhysiÿl
(
logiÿl_off£t
);

126 
	gphysiÿl_off£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
physiÿl_off£t
, 
SEEK_SET
);

127 ià(
	gphysiÿl_off£t
 == -1) {

128 
LOG
(
ERROR
è<< "’şave_l£ek faed, fd = " << 
fd


129 << ", off£ˆğ" << 
off£t
;

132  
	goff£t_Œª¦©Ü
.
PhysiÿlToLogiÿl
(
physiÿl_off£t
);

135 
£cu»_f¡©
(
fd
, 
¡©
 *
¡
) {

136 
	g»t
 = 
’c_uÁru¡ed_f¡©
(
fd
, 
¡
);

137 ià(
	g»t
 == 0) {

139 
¡
->
¡_size
 = 
A—dHªdËr
::
G‘In¡ªû
().
G‘LogiÿlFeSize
(
fd
);

141  
	g»t
;

	@platform/storage/secure/enclave_storage_secure.cc

19 
	~"asylo/¶©fÜm/¡Üage/£cu»/’şave_¡Üage_£cu».h
"

22 
	~<sys/ty³s.h
>

25 
	~<fú.h
>

27 
	~<¡d¬g.h
>

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

30 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

31 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

32 
	~"asylo/¶©fÜm/¡Üage/uts/off£t_Œª¦©Ü.h
"

33 
	~"asylo/ut/loggšg.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	g¶©fÜm
 {

37 
Çme¥aû
 
	g¡Üage
 {

39 
£cu»_İ’
(cÚ¡ *
·thÇme
, 
æags
, ...) {

40 ià((
	gæags
 & 
	gO_APPEND
è|| (æag & 
	gO_TRUNC
)) {

41 
LOG
(
ERROR
) << "Currently O_APPEND‡nd O_TRUNC file creation flags‡re‚ot "

46 
mode_t
 
	gmode
 = 0;

47 ià(
	gæags
 & 
	gO_CREAT
) {

48 
va_li¡
 
	g­
;

49 
va_¡¬t
(
­
, 
æags
);

50 
	gmode
 = 
va_¬g
(
­
, 
mode_t
);

51 
va_’d
(
­
);

54 
boŞ
 
	gis_Ãw_fe
 = (
’c_uÁru¡ed_acûss
(
·thÇme
, 
F_OK
) == -1);

55 
	gfd
 = 
’c_uÁru¡ed_İ’
(
·thÇme
, 
æags
, 
mode
);

56 ià(
	gfd
 == -1) {

57 
LOG
(
ERROR
è<< "FaedØ£cu»ly o³Àfe: " << 
·thÇme
;

61 
FdClo£r
 
fd_şo£r
(
fd
, &
’c_uÁru¡ed_şo£
);

64 ià(
£cu»_l£ek
(
fd
, 0, 
SEEK_SET
) == -1) {

65 
LOG
(
ERROR
) << "Failedo initialize cursorohe†ogical offset of 0, fd="

66 << 
fd
;

70 ià(!
	gA—dHªdËr
::
G‘In¡ªû
().
In™ŸlizeFe
(
fd
, 
·thÇme
, 
is_Ãw_fe
)) {

71 
LOG
(
ERROR
è<< "FaedØš™Ÿliz£cu» hªdlšg oàfe: " << 
	g·thÇme
;

75 
	gfd_şo£r
.
»Ëa£
();

76  
	gfd
;

79 
ssize_t
 
£cu»_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
) {

80  
	gA—dHªdËr
::
G‘In¡ªû
().
Deüy±AndV”ify
(
fd
, 
buf
, 
couÁ
);

83 
ssize_t
 
£cu»_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
) {

84  
	gA—dHªdËr
::
G‘In¡ªû
().
Enüy±AndP”si¡
(
fd
, 
buf
, 
couÁ
);

87 
£cu»_şo£
(
fd
) {

88 
boŞ
 
	gfš®ize_»suÉ
 = 
A—dHªdËr
::
G‘In¡ªû
().
Fš®izeFe
(
fd
);

89  (
	gfš®ize_»suÉ
 && 
’c_uÁru¡ed_şo£
(
fd
) == 0) ? 0 : -1;

92 
off_t
 
£cu»_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
) {

93 ià(
	goff£t
 < 0) {

97 cÚ¡ 
	gOff£tT¿n¦©Ü
 &
	goff£t_Œª¦©Ü
 =

98 
A—dHªdËr
::
G‘In¡ªû
().
G‘Off£tT¿n¦©Ü
();

101 
off_t
 
	glogiÿl_off£t
;

102 
	gwh’û
) {

103 
	gSEEK_SET
: {

104 
logiÿl_off£t
 = 
off£t
;

106 
	gSEEK_CUR
: {

107 
off_t
 
physiÿl_cur_off£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 0, 
SEEK_CUR
);

108 ià(
	gphysiÿl_cur_off£t
 == -1) {

109 
LOG
(
ERROR
è<< "FaedØ»Œ›vcursÜ off£ˆÚ desütÜ: " << 
fd
;

112 
off_t
 
	glogiÿl_cur_off£t
 =

113 
off£t_Œª¦©Ü
.
PhysiÿlToLogiÿl
(
physiÿl_cur_off£t
);

114 
	glogiÿl_off£t
 = 
logiÿl_cur_off£t
 + 
off£t
;

116 
	gSEEK_END
: {

117 
off_t
 
logiÿl_eof_off£t
 =

118 
A—dHªdËr
::
G‘In¡ªû
().
G‘LogiÿlFeSize
(
fd
);

119 
	glogiÿl_off£t
 = 
logiÿl_eof_off£t
 + 
off£t
;

121 : 
logiÿl_off£t
 = 0;

125 
off_t
 
	gphysiÿl_off£t
 = 
off£t_Œª¦©Ü
.
LogiÿlToPhysiÿl
(
logiÿl_off£t
);

126 
	gphysiÿl_off£t
 = 
’c_uÁru¡ed_l£ek
(
fd
, 
physiÿl_off£t
, 
SEEK_SET
);

127 ià(
	gphysiÿl_off£t
 == -1) {

128 
LOG
(
ERROR
è<< "’şave_l£ek faed, fd = " << 
fd


129 << ", off£ˆğ" << 
off£t
;

132  
	goff£t_Œª¦©Ü
.
PhysiÿlToLogiÿl
(
physiÿl_off£t
);

135 
£cu»_f¡©
(
fd
, 
¡©
 *
¡
) {

136 
	g»t
 = 
’c_uÁru¡ed_f¡©
(
fd
, 
¡
);

137 ià(
	g»t
 == 0) {

139 
¡
->
¡_size
 = 
A—dHªdËr
::
G‘In¡ªû
().
G‘LogiÿlFeSize
(
fd
);

141  
	g»t
;

	@platform/storage/secure/enclave_storage_secure.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_SECURE_ENCLAVE_STORAGE_SECURE_H_


20 
	#ASYLO_PLATFORM_STORAGE_SECURE_ENCLAVE_STORAGE_SECURE_H_


	)

26 
	~<sys/¡©.h
>

28 
	~<sys/ty³s.h
>

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g¶©fÜm
 {

32 
Çme¥aû
 
	g¡Üage
 {

36 
£cu»_İ’
(cÚ¡ *
·thÇme
, 
æags
, ...);

40 
ssize_t
 
£cu»_»ad
(
fd
, *
buf
, 
size_t
 
couÁ
);

44 
ssize_t
 
£cu»_wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

46 
£cu»_şo£
(
fd
);

48 
off_t
 
£cu»_l£ek
(
fd
, off_ˆ
off£t
, 
wh’û
);

51 
£cu»_f¡©
(
fd
, 
¡©
* 
¡
);

	@platform/storage/secure/enclave_storage_secure_test.cc

22 
	~<fú.h
>

23 
	~<İ’s¦/¿nd.h
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/ba£/maüos.h
"

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

30 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

31 
	~"asylo/¶©fÜm/¡Üage/£cu»/’şave_¡Üage_£cu».h
"

32 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
	~"asylo/‹¡/ut/‹¡_æags.h
"

35 
	~"asylo/ut/ş—nsšg_ty³s.h
"

36 
	~"asylo/ut/loggšg.h
"

37 
	~"asylo/ut/¡©us.h
"

39 
Çme¥aû
 
	gasylo
 {

40 
	gÇme¥aû
 {

42 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kKeyL’gth
;

43 
usšg
 
	g¶©fÜm
::
¡Üage
::
A—dHªdËr
;

44 
usšg
 
	g¶©fÜm
::
¡Üage
::
kBlockL’gth
;

45 
usšg
 
	g¶©fÜm
::
¡Üage
::
kCh”BlockL’gth
;

46 
usšg
 
	g¶©fÜm
::
¡Üage
::
kFeHashL’gth
;

47 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_şo£
;

48 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_f¡©
;

49 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_l£ek
;

50 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_İ’
;

51 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_»ad
;

52 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_wr™e
;

53 
	gusšg
 ::
‹¡šg
::
NÙ
;

55 
cÚ¡ex´
 
size_t
 
	gkMaxTe¡BufL’
 = 1000;

56 
cÚ¡ex´
 
	gkTam³rD©a
[] = "Exceedingly„are string";

58 
şass
 
	gEnşaveStÜageSecu»Te¡
 : 
public
 ::
‹¡šg
::
Te¡
,

59 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
size_t
> {

60 
´Ùeùed
:

61 
S‘Up
(è
ov”ride
 { 
P»·»Te¡
(); }

62 
P»·»Te¡
();

63 
Stus
 
O³nWr™eClo£
(
off_t
 
off£t
);

64 
Stus
 
O³nR—dV”ifyClo£
(
off_t
 
off£t
, 
size_t
 
by‹s_ex³ùed
);

66 cÚ¡ 
št64_t
 
	gkFeH—d”L’gth
 = 
kFeHashL’gth
 + (
size_t
);

67 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘P©h
(ècÚ¡ {  
·th_
; }

68 cÚ¡ *
G‘Wr™eBufãr
() const {

69  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gwr™e_bufãr_
);

71 *
G‘R—dBufãr
(è{  
	g»š‹½»t_ÿ¡
<*>(
	g»ad_bufãr_
); }

72 cÚ¡ *
G‘Z”oBufãr
() const {

73  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gz”o_bufãr_
);

75 
EmuÏ‹S‘KeyIoùl
(
fd
) const {

76  
	gA—dHªdËr
::
G‘In¡ªû
().
S‘Ma¡”Key
(
fd
, 
key_
.
d©a
(),

77 
key_
.
size
());

80 
size_t
 
	g‹¡_buf_Ën_
;

81 
	g¡d
::
¡ršg
 
·th_
;

82 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey_
;

83 
	gwr™e_bufãr_
[
kMaxTe¡BufL’
];

84 
	g»ad_bufãr_
[
kMaxTe¡BufL’
];

85 
	gz”o_bufãr_
[
kMaxTe¡BufL’
];

88 cÚ¡ 
size_t
 
	gbufãr_Ëngth_v®s
[] = {128, 160, 512, 544};

90 
INSTANTIATE_TEST_SUITE_P
(
In¡ªû1
, 
EnşaveStÜageSecu»Te¡
,

91 ::
‹¡šg
::
V®uesIn
(
bufãr_Ëngth_v®s
));

93 
	gEnşaveStÜageSecu»Te¡
::
P»·»Te¡
() {

94 
·th_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/EnclaveStorageSecureTest.txt");

98 
LOG
(
INFO
è<< "CËªšg u°‹¡ fià´e£Á,…©h = " << 
	g·th_
;

99 
»move
(
·th_
.
c_¡r
());

102 
	gkey_
.
»size
(
kKeyL’gth
);

103 
ASSERT_EQ
(
RAND_by‹s
(
key_
.
d©a
(), key_.
size
()), 1);

106 
	g‹¡_buf_Ën_
 = 
G‘P¬am
();

107 
cÚ¡ex´
 
size_t
 
	g·‰”n_Ëngth
 = 16;

108 
ASSERT_LE
(
‹¡_buf_Ën_
, 
kMaxTe¡BufL’
);

109 
ASSERT_EQ
(
‹¡_buf_Ën_
 % 
·‰”n_Ëngth
, 0);

111 
cÚ¡ex´
 
	g·‰”n
[
·‰”n_Ëngth
 + 1] = "qwerasdfzxcv1234";

112 
	gsÿn
 = 0; sÿÀ< 
	gkMaxTe¡BufL’
 / 
	g·‰”n_Ëngth
; scan++) {

113 
memıy
(
wr™e_bufãr_
 + 
sÿn
 * 
·‰”n_Ëngth
, 
·‰”n
,…attern_length);

115 
mem£t
(
z”o_bufãr_
, 0, 
kMaxTe¡BufL’
);

118 
Stus
 
	gEnşaveStÜageSecu»Te¡
::
O³nWr™eClo£
(
off_t
 
off£t
) {

120 
fd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

121 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

122 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

123 ià(
	gfd
 < 0) {

124  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

125 
ab¦
::
SŒC©
("Secu» o³À·th ", 
G‘P©h
(), " failed."));

128 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
, &
£cu»_şo£
);

130 ià(
EmuÏ‹S‘KeyIoùl
(
fd
) != 0) {

131  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set Master Key failed.");

134 ià(
	goff£t
 > 0) {

135 ià(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
) != offset) {

136  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure†seek failed.");

138 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

142 ià(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
) !=est_buf_len_) {

143  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure write failed.");

146 
	gfd_şo£r
.
»Ëa£
();

149 ià(
£cu»_şo£
(
fd
) != 0) {

150  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure close failed.");

154 ià(
£cu»_şo£
(
fd
) != -1) {

155  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

159  
	gStus
::
OkStus
();

162 
Stus
 
	gEnşaveStÜageSecu»Te¡
::
O³nR—dV”ifyClo£
(
off_t
 
off£t
,

163 
size_t
 
by‹s_ex³ùed
) {

165 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

166 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

167 ià(
	gfd
 < 0) {

168  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

169 
ab¦
::
SŒC©
("Secu» o³À·th ", 
G‘P©h
(), " failed."));

172 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
, &
£cu»_şo£
);

174 ià(
EmuÏ‹S‘KeyIoùl
(
fd
) != 0) {

175  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set master Key failed.");

178 ià(
	goff£t
 > 0) {

179 ià(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
) != offset) {

180  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure†seek failed.");

182 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

186 ià(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
è!ğ
by‹s_ex³ùed
) {

187  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure„ead failed.");

191 ià(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
by‹s_ex³ùed
) != 0) {

192  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

196 
	gfd_şo£r
.
»Ëa£
();

199 ià(
£cu»_şo£
(
fd
) != 0) {

200  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "secure close failed.");

204 ià(
£cu»_şo£
(
fd
) != -1) {

205  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

209  
	gStus
::
OkStus
();

216 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eSucûss
) {

217 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

218 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

221 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eIÁ”ÏûdSucûss
) {

222 cÚ¡ 
	g™”©iÚs
 = 10;

223 
	g™”
 = 0; i‹¸< 
	g™”©iÚs
; iter++) {

225 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDWR
 | 
O_CREAT
,

226 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

227 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d‡nd wr™e, fd = " << 
	gfd
;

228 
ASSERT_GE
(
fd
, 0);

230 
ASSERT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

232 
	gsÿn
 = 0; sÿÀ< 
	g™”
; scan++) {

234 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

235 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

236 
LOG
(
INFO
è<< "R—d chunk oàfe, i‹¸ğ" << 
	g™”
 << ", sÿÀğ" << 
	gsÿn
;

240 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

243 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

247 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
L£ekR—dWr™eIÁ”ÏûdSšgËFdSucûss
) {

248 cÚ¡ 
	gš‹¿tiÚs
 = 10;

249 
	g™”
 = 0; i‹¸< 
	gš‹¿tiÚs
; iter++) {

251 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDWR
 | 
O_CREAT
,

252 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

253 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d‡nd wr™e, fd = " << 
	gfd
;

254 
ASSERT_GE
(
fd
, 0);

256 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

258 ià(
	g™”
 > 0) {

260 
off_t
 
	goff£t
 = (
™”
 - 1è* 
‹¡_buf_Ën_
;

261 
EXPECT_EQ
(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
), offset);

262 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

265 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

266 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

267 
LOG
(
INFO
è<< "R—d chunk oàfaá”†£ek, i‹¸ğ" << 
	g™”
;

271 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

274 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

278 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
L£ekR—dWr™eIÁ”ÏûdMuÉiFdSucûss
) {

279 cÚ¡ 
	gš‹¿tiÚs
 = 10;

280 
	g¡d
::
veùÜ
<> 
fds
;

281 
	g™”
 = 0; i‹¸< 
	gš‹¿tiÚs
; iter++) {

283 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDWR
 | 
O_CREAT
,

284 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

285 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d‡nd wr™e, fd = " << 
	gfd
;

286 
ASSERT_GE
(
fd
, 0);

288 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

290 ià(
	g™”
 > 0) {

292 
off_t
 
	goff£t
 = (
™”
 - 1è* 
‹¡_buf_Ën_
;

293 
EXPECT_EQ
(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
), offset);

294 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

297 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

298 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

299 
LOG
(
INFO
è<< "R—d chunk oàfaá”†£ek, i‹¸ğ" << 
	g™”
;

303 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

306 
	gfds
.
push_back
(
fd
);

309 cÚ¡ &
	gfd
 : 
fds
) {

310 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

314 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
Reİ’R—dWr™eSucûss
) {

316 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

317 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

318 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

319 
ASSERT_GE
(
fd
, 0);

321 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

324 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

326 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

327 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

330 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
RedundªtIoùlSucûss
) {

332 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

333 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

334 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

335 
EXPECT_GE
(
fd
, 0);

337 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

339 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

342 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

345 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eW™hS·r£SucûssTe¡
) {

346 
boŞ
 
	g¥¬£_h—d
 : {
çl£
, 
	gŒue
}) {

347 
P»·»Te¡
();

348 
off_t
 
	gh—d_off£t
 = 0;

349 ià(
	g¥¬£_h—d
) {

351 
	gh—d_off£t
 = 
‹¡_buf_Ën_
;

354 
EXPECT_THAT
(
O³nWr™eClo£
(
h—d_off£t
), 
IsOk
());

357 
off_t
 
	goff£t
 = 
h—d_off£t
 + 2 * 
‹¡_buf_Ën_
;

359 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

362 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

363 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

364 
ASSERT_GE
(
fd
, 0);

366 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

368 ià(
	g¥¬£_h—d
) {

370 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

371 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

375 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

376 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

379 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

380 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

383 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

384 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

387 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

390 
	goff£t
 = 
h—d_off£t
 + 4 * 
‹¡_buf_Ën_
;

391 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

394 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

395 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

396 
ASSERT_GE
(
fd
, 0);

398 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

400 ià(
	g¥¬£_h—d
) {

402 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

403 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

407 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

408 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

411 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

412 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

415 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

416 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

419 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

420 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

423 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

424 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

427 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

431 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
ModifiÿtiÚWr™eSucûssTe¡
) {

432 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

433 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

436 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

437 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

439 ià(
	g‹¡_buf_Ën_
 / 
	gkBlockL’gth
 != 1) {

442 
off_t
 
off£t
 = 
‹¡_buf_Ën_
 / 2;

444 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

447 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

448 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

449 
EXPECT_GE
(
fd
, 0);

451 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

454 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
 / 2),

455 
‹¡_buf_Ën_
 / 2);

456 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
 / 2), 0);

460 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

461 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

464 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

468 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
Sim¶eMi§ligÃdWr™eSucûss
) {

469 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

471 
off_t
 
	goff£t
 = 
‹¡_buf_Ën_
 - 
kBlockL’gth
 / 2;

472 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

475 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
Sim¶eMi§ligÃdR—dSucûss
) {

476 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

478 
off_t
 
	goff£t
 = 
kBlockL’gth
 / 2;

479 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(
off£t
, 
‹¡_buf_Ën_
 - off£t), 
IsOk
());

482 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
StR‘uºLogiÿlFeSizeSucûss
) {

483 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

484 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

485 
ASSERT_GE
(
fd
, 0);

486 
ASSERT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

487 
¡©
 
	gfe_¡©
;

488 
EXPECT_EQ
(
£cu»_f¡©
(
fd
, &
fe_¡©
), 0);

489 
EXPECT_EQ
(
fe_¡©
.
¡_size
, 
‹¡_buf_Ën_
);

490 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

493 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
L£ekEndSucûss
) {

494 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

495 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

496 
ASSERT_GE
(
fd
, 0);

497 
ASSERT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

498 
off_t
 
	goff£t
 = 
£cu»_l£ek
(
fd
, 0, 
SEEK_END
);

499 
EXPECT_EQ
(
off£t
, 
‹¡_buf_Ën_
);

500 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

507 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eD©aModif›d
) {

508 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

510 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

511 
EXPECT_GE
(
fd
, 0);

512 
EXPECT_GT
(
’c_uÁru¡ed_l£ek
(
fd
, 
kFeH—d”L’gth
, 
SEEK_SET
), 0);

513 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

515 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

516 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

517 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

518 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure„ead failed."));

521 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eDige¡Modif›d
) {

522 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

524 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

525 
EXPECT_GE
(
fd
, 0);

526 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

528 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

529 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

530 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

531 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set master Key failed."));

534 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eAuthTagsModif›d
) {

535 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

538 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

539 
ASSERT_GE
(
fd
, 0);

540 
EXPECT_GT
(
’c_uÁru¡ed_l£ek
(
fd
, 
kFeH—d”L’gth
 + 
kBlockL’gth
, 
SEEK_SET
),

542 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

544 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

545 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

546 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

547 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set master Key failed."));

550 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eTok’sModif›d
) {

551 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

554 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

555 
ASSERT_GE
(
fd
, 0);

556 
EXPECT_GT
(

557 
’c_uÁru¡ed_l£ek
(
fd
, 
kFeH—d”L’gth
 + 
kCh”BlockL’gth
, 
SEEK_SET
),

559 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

561 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

562 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

563 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

564 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure„ead failed."));

567 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
FeTrunÿ‹A‰ack
) {

568 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

571 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_TRUNC
);

572 
’c_uÁru¡ed_şo£
(
fd
);

573 
EXPECT_THAT
(
O³nWr™eClo£
(0),

574 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set Master Key failed."));

577 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
KeyNÙS‘Fau»
) {

579 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

580 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

581 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

582 
ASSERT_GE
(
fd
, 0);

585 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
), -1);

588 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

591 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
RedundªtIoùlFau»
) {

593 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

594 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

595 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

596 
ASSERT_GE
(
fd
, 0);

598 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

599 
EXPECT_EQ
(
RAND_by‹s
(
key_
.
d©a
(), key_.
size
()), 1);

600 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), -1);

603 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

606 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
UnknownFdIoùlFau»
) {

608 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

609 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

610 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

611 
ASSERT_GE
(
fd
, 0);

614 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

615 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), -1);

616 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

619 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
UnsuµÜ‹dFeC»©iÚFÏgFau»
) {

621 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
 | 
O_APPEND
,

622 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

623 
EXPECT_EQ
(
fd
, -1);

626 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
,

627 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

628 
EXPECT_EQ
(
fd
, -1);

	@platform/storage/secure/enclave_storage_secure_test.cc

22 
	~<fú.h
>

23 
	~<İ’s¦/¿nd.h
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/ba£/maüos.h
"

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

30 
	~"asylo/¶©fÜm/¡Üage/£cu»/«ad_hªdËr.h
"

31 
	~"asylo/¶©fÜm/¡Üage/£cu»/’şave_¡Üage_£cu».h
"

32 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
	~"asylo/‹¡/ut/‹¡_æags.h
"

35 
	~"asylo/ut/ş—nsšg_ty³s.h
"

36 
	~"asylo/ut/loggšg.h
"

37 
	~"asylo/ut/¡©us.h
"

39 
Çme¥aû
 
	gasylo
 {

40 
	gÇme¥aû
 {

42 
usšg
 
	g¶©fÜm
::
üy±o
::
gcmlib
::
kKeyL’gth
;

43 
usšg
 
	g¶©fÜm
::
¡Üage
::
A—dHªdËr
;

44 
usšg
 
	g¶©fÜm
::
¡Üage
::
kBlockL’gth
;

45 
usšg
 
	g¶©fÜm
::
¡Üage
::
kCh”BlockL’gth
;

46 
usšg
 
	g¶©fÜm
::
¡Üage
::
kFeHashL’gth
;

47 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_şo£
;

48 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_f¡©
;

49 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_l£ek
;

50 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_İ’
;

51 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_»ad
;

52 
usšg
 
	g¶©fÜm
::
¡Üage
::
£cu»_wr™e
;

53 
	gusšg
 ::
‹¡šg
::
NÙ
;

55 
cÚ¡ex´
 
size_t
 
	gkMaxTe¡BufL’
 = 1000;

56 
cÚ¡ex´
 
	gkTam³rD©a
[] = "Exceedingly„are string";

58 
şass
 
	gEnşaveStÜageSecu»Te¡
 : 
public
 ::
‹¡šg
::
Te¡
,

59 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<
size_t
> {

60 
´Ùeùed
:

61 
S‘Up
(è
ov”ride
 { 
P»·»Te¡
(); }

62 
P»·»Te¡
();

63 
Stus
 
O³nWr™eClo£
(
off_t
 
off£t
);

64 
Stus
 
O³nR—dV”ifyClo£
(
off_t
 
off£t
, 
size_t
 
by‹s_ex³ùed
);

66 cÚ¡ 
št64_t
 
	gkFeH—d”L’gth
 = 
kFeHashL’gth
 + (
size_t
);

67 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘P©h
(ècÚ¡ {  
·th_
; }

68 cÚ¡ *
G‘Wr™eBufãr
() const {

69  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gwr™e_bufãr_
);

71 *
G‘R—dBufãr
(è{  
	g»š‹½»t_ÿ¡
<*>(
	g»ad_bufãr_
); }

72 cÚ¡ *
G‘Z”oBufãr
() const {

73  
	g»š‹½»t_ÿ¡
<cÚ¡ *>(
	gz”o_bufãr_
);

75 
EmuÏ‹S‘KeyIoùl
(
fd
) const {

76  
	gA—dHªdËr
::
G‘In¡ªû
().
S‘Ma¡”Key
(
fd
, 
key_
.
d©a
(),

77 
key_
.
size
());

80 
size_t
 
	g‹¡_buf_Ën_
;

81 
	g¡d
::
¡ršg
 
·th_
;

82 
	gCËªsšgVeùÜ
<
	gušt8_t
> 
	gkey_
;

83 
	gwr™e_bufãr_
[
kMaxTe¡BufL’
];

84 
	g»ad_bufãr_
[
kMaxTe¡BufL’
];

85 
	gz”o_bufãr_
[
kMaxTe¡BufL’
];

88 cÚ¡ 
size_t
 
	gbufãr_Ëngth_v®s
[] = {128, 160, 512, 544};

90 
INSTANTIATE_TEST_SUITE_P
(
In¡ªû1
, 
EnşaveStÜageSecu»Te¡
,

91 ::
‹¡šg
::
V®uesIn
(
bufãr_Ëngth_v®s
));

93 
	gEnşaveStÜageSecu»Te¡
::
P»·»Te¡
() {

94 
·th_
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/EnclaveStorageSecureTest.txt");

98 
LOG
(
INFO
è<< "CËªšg u°‹¡ fià´e£Á,…©h = " << 
	g·th_
;

99 
»move
(
·th_
.
c_¡r
());

102 
	gkey_
.
»size
(
kKeyL’gth
);

103 
ASSERT_EQ
(
RAND_by‹s
(
key_
.
d©a
(), key_.
size
()), 1);

106 
	g‹¡_buf_Ën_
 = 
G‘P¬am
();

107 
cÚ¡ex´
 
size_t
 
	g·‰”n_Ëngth
 = 16;

108 
ASSERT_LE
(
‹¡_buf_Ën_
, 
kMaxTe¡BufL’
);

109 
ASSERT_EQ
(
‹¡_buf_Ën_
 % 
·‰”n_Ëngth
, 0);

111 
cÚ¡ex´
 
	g·‰”n
[
·‰”n_Ëngth
 + 1] = "qwerasdfzxcv1234";

112 
	gsÿn
 = 0; sÿÀ< 
	gkMaxTe¡BufL’
 / 
	g·‰”n_Ëngth
; scan++) {

113 
memıy
(
wr™e_bufãr_
 + 
sÿn
 * 
·‰”n_Ëngth
, 
·‰”n
,…attern_length);

115 
mem£t
(
z”o_bufãr_
, 0, 
kMaxTe¡BufL’
);

118 
Stus
 
	gEnşaveStÜageSecu»Te¡
::
O³nWr™eClo£
(
off_t
 
off£t
) {

120 
fd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

121 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

122 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

123 ià(
	gfd
 < 0) {

124  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

125 
ab¦
::
SŒC©
("Secu» o³À·th ", 
G‘P©h
(), " failed."));

128 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
, &
£cu»_şo£
);

130 ià(
EmuÏ‹S‘KeyIoùl
(
fd
) != 0) {

131  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set Master Key failed.");

134 ià(
	goff£t
 > 0) {

135 ià(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
) != offset) {

136  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure†seek failed.");

138 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

142 ià(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
) !=est_buf_len_) {

143  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure write failed.");

146 
	gfd_şo£r
.
»Ëa£
();

149 ià(
£cu»_şo£
(
fd
) != 0) {

150  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure close failed.");

154 ià(
£cu»_şo£
(
fd
) != -1) {

155  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

159  
	gStus
::
OkStus
();

162 
Stus
 
	gEnşaveStÜageSecu»Te¡
::
O³nR—dV”ifyClo£
(
off_t
 
off£t
,

163 
size_t
 
by‹s_ex³ùed
) {

165 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

166 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

167 ià(
	gfd
 < 0) {

168  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

169 
ab¦
::
SŒC©
("Secu» o³À·th ", 
G‘P©h
(), " failed."));

172 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
fd_şo£r
(
fd
, &
£cu»_şo£
);

174 ià(
EmuÏ‹S‘KeyIoùl
(
fd
) != 0) {

175  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set master Key failed.");

178 ià(
	goff£t
 > 0) {

179 ià(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
) != offset) {

180  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure†seek failed.");

182 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

186 ià(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
è!ğ
by‹s_ex³ùed
) {

187  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure„ead failed.");

191 ià(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
by‹s_ex³ùed
) != 0) {

192  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

196 
	gfd_şo£r
.
»Ëa£
();

199 ià(
£cu»_şo£
(
fd
) != 0) {

200  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "secure close failed.");

204 ià(
£cu»_şo£
(
fd
) != -1) {

205  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

209  
	gStus
::
OkStus
();

216 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eSucûss
) {

217 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

218 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

221 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eIÁ”ÏûdSucûss
) {

222 cÚ¡ 
	g™”©iÚs
 = 10;

223 
	g™”
 = 0; i‹¸< 
	g™”©iÚs
; iter++) {

225 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDWR
 | 
O_CREAT
,

226 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

227 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d‡nd wr™e, fd = " << 
	gfd
;

228 
ASSERT_GE
(
fd
, 0);

230 
ASSERT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

232 
	gsÿn
 = 0; sÿÀ< 
	g™”
; scan++) {

234 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

235 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

236 
LOG
(
INFO
è<< "R—d chunk oàfe, i‹¸ğ" << 
	g™”
 << ", sÿÀğ" << 
	gsÿn
;

240 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

243 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

247 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
L£ekR—dWr™eIÁ”ÏûdSšgËFdSucûss
) {

248 cÚ¡ 
	gš‹¿tiÚs
 = 10;

249 
	g™”
 = 0; i‹¸< 
	gš‹¿tiÚs
; iter++) {

251 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDWR
 | 
O_CREAT
,

252 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

253 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d‡nd wr™e, fd = " << 
	gfd
;

254 
ASSERT_GE
(
fd
, 0);

256 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

258 ià(
	g™”
 > 0) {

260 
off_t
 
	goff£t
 = (
™”
 - 1è* 
‹¡_buf_Ën_
;

261 
EXPECT_EQ
(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
), offset);

262 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

265 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

266 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

267 
LOG
(
INFO
è<< "R—d chunk oàfaá”†£ek, i‹¸ğ" << 
	g™”
;

271 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

274 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

278 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
L£ekR—dWr™eIÁ”ÏûdMuÉiFdSucûss
) {

279 cÚ¡ 
	gš‹¿tiÚs
 = 10;

280 
	g¡d
::
veùÜ
<> 
fds
;

281 
	g™”
 = 0; i‹¸< 
	gš‹¿tiÚs
; iter++) {

283 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDWR
 | 
O_CREAT
,

284 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

285 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d‡nd wr™e, fd = " << 
	gfd
;

286 
ASSERT_GE
(
fd
, 0);

288 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

290 ià(
	g™”
 > 0) {

292 
off_t
 
	goff£t
 = (
™”
 - 1è* 
‹¡_buf_Ën_
;

293 
EXPECT_EQ
(
£cu»_l£ek
(
fd
, 
off£t
, 
SEEK_SET
), offset);

294 
LOG
(
INFO
è<< "P”fÜmed†£ekØoff£ˆğ" << 
	goff£t
;

297 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

298 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

299 
LOG
(
INFO
è<< "R—d chunk oàfaá”†£ek, i‹¸ğ" << 
	g™”
;

303 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

306 
	gfds
.
push_back
(
fd
);

309 cÚ¡ &
	gfd
 : 
fds
) {

310 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

314 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
Reİ’R—dWr™eSucûss
) {

316 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

317 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

318 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

319 
ASSERT_GE
(
fd
, 0);

321 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

324 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

326 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

327 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

330 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
RedundªtIoùlSucûss
) {

332 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

333 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

334 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

335 
EXPECT_GE
(
fd
, 0);

337 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

339 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

342 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

345 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eW™hS·r£SucûssTe¡
) {

346 
boŞ
 
	g¥¬£_h—d
 : {
çl£
, 
	gŒue
}) {

347 
P»·»Te¡
();

348 
off_t
 
	gh—d_off£t
 = 0;

349 ià(
	g¥¬£_h—d
) {

351 
	gh—d_off£t
 = 
‹¡_buf_Ën_
;

354 
EXPECT_THAT
(
O³nWr™eClo£
(
h—d_off£t
), 
IsOk
());

357 
off_t
 
	goff£t
 = 
h—d_off£t
 + 2 * 
‹¡_buf_Ën_
;

359 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

362 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

363 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

364 
ASSERT_GE
(
fd
, 0);

366 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

368 ià(
	g¥¬£_h—d
) {

370 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

371 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

375 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

376 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

379 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

380 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

383 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

384 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

387 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

390 
	goff£t
 = 
h—d_off£t
 + 4 * 
‹¡_buf_Ën_
;

391 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

394 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

395 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

396 
ASSERT_GE
(
fd
, 0);

398 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

400 ià(
	g¥¬£_h—d
) {

402 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

403 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

407 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

408 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

411 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

412 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

415 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

416 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

419 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

420 
EXPECT_EQ
(
memcmp
(
G‘Z”oBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

423 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

424 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

427 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

431 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
ModifiÿtiÚWr™eSucûssTe¡
) {

432 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

433 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

436 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

437 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
), 
IsOk
());

439 ià(
	g‹¡_buf_Ën_
 / 
	gkBlockL’gth
 != 1) {

442 
off_t
 
off£t
 = 
‹¡_buf_Ën_
 / 2;

444 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

447 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

448 
LOG
(
INFO
è<< "O³Ãd ffÜ„—d, fd = " << 
	gfd
;

449 
EXPECT_GE
(
fd
, 0);

451 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

454 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
 / 2),

455 
‹¡_buf_Ën_
 / 2);

456 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
 / 2), 0);

460 
EXPECT_EQ
(
£cu»_»ad
(
fd
, 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
),est_buf_len_);

461 
EXPECT_EQ
(
memcmp
(
G‘Wr™eBufãr
(), 
G‘R—dBufãr
(), 
‹¡_buf_Ën_
), 0);

464 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

468 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
Sim¶eMi§ligÃdWr™eSucûss
) {

469 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

471 
off_t
 
	goff£t
 = 
‹¡_buf_Ën_
 - 
kBlockL’gth
 / 2;

472 
EXPECT_THAT
(
O³nWr™eClo£
(
off£t
), 
IsOk
());

475 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
Sim¶eMi§ligÃdR—dSucûss
) {

476 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

478 
off_t
 
	goff£t
 = 
kBlockL’gth
 / 2;

479 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(
off£t
, 
‹¡_buf_Ën_
 - off£t), 
IsOk
());

482 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
StR‘uºLogiÿlFeSizeSucûss
) {

483 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

484 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

485 
ASSERT_GE
(
fd
, 0);

486 
ASSERT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

487 
¡©
 
	gfe_¡©
;

488 
EXPECT_EQ
(
£cu»_f¡©
(
fd
, &
fe_¡©
), 0);

489 
EXPECT_EQ
(
fe_¡©
.
¡_size
, 
‹¡_buf_Ën_
);

490 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

493 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
L£ekEndSucûss
) {

494 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

495 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_RDONLY
);

496 
ASSERT_GE
(
fd
, 0);

497 
ASSERT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

498 
off_t
 
	goff£t
 = 
£cu»_l£ek
(
fd
, 0, 
SEEK_END
);

499 
EXPECT_EQ
(
off£t
, 
‹¡_buf_Ën_
);

500 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

507 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eD©aModif›d
) {

508 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

510 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

511 
EXPECT_GE
(
fd
, 0);

512 
EXPECT_GT
(
’c_uÁru¡ed_l£ek
(
fd
, 
kFeH—d”L’gth
, 
SEEK_SET
), 0);

513 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

515 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

516 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

517 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

518 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure„ead failed."));

521 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eDige¡Modif›d
) {

522 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

524 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

525 
EXPECT_GE
(
fd
, 0);

526 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

528 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

529 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

530 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

531 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set master Key failed."));

534 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eAuthTagsModif›d
) {

535 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

538 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

539 
ASSERT_GE
(
fd
, 0);

540 
EXPECT_GT
(
’c_uÁru¡ed_l£ek
(
fd
, 
kFeH—d”L’gth
 + 
kBlockL’gth
, 
SEEK_SET
),

542 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

544 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

545 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

546 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

547 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set master Key failed."));

550 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
R—dWr™eTok’sModif›d
) {

551 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

554 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
);

555 
ASSERT_GE
(
fd
, 0);

556 
EXPECT_GT
(

557 
’c_uÁru¡ed_l£ek
(
fd
, 
kFeH—d”L’gth
 + 
kCh”BlockL’gth
, 
SEEK_SET
),

559 
EXPECT_GT
(
’c_uÁru¡ed_wr™e
(
fd
, 
kTam³rD©a
, 
ABSL_ARRAYSIZE
(kTamperData)),

561 
ASSERT_EQ
(
’c_uÁru¡ed_fsync
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

562 
ASSERT_EQ
(
’c_uÁru¡ed_şo£
(
fd
), 0è<< 
¡»¼Ü
(
”ºo
);

563 
EXPECT_THAT
(
O³nR—dV”ifyClo£
(0, 
‹¡_buf_Ën_
),

564 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Secure„ead failed."));

567 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
FeTrunÿ‹A‰ack
) {

568 
EXPECT_THAT
(
O³nWr™eClo£
(0), 
IsOk
());

571 
	gfd
 = 
’c_uÁru¡ed_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_TRUNC
);

572 
’c_uÁru¡ed_şo£
(
fd
);

573 
EXPECT_THAT
(
O³nWr™eClo£
(0),

574 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Set Master Key failed."));

577 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
KeyNÙS‘Fau»
) {

579 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

580 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

581 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

582 
ASSERT_GE
(
fd
, 0);

585 
EXPECT_EQ
(
£cu»_wr™e
(
fd
, 
G‘Wr™eBufãr
(), 
‹¡_buf_Ën_
), -1);

588 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

591 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
RedundªtIoùlFau»
) {

593 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

594 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

595 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

596 
ASSERT_GE
(
fd
, 0);

598 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), 0);

599 
EXPECT_EQ
(
RAND_by‹s
(
key_
.
d©a
(), key_.
size
()), 1);

600 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), -1);

603 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

606 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
UnknownFdIoùlFau»
) {

608 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
,

609 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

610 
LOG
(
INFO
è<< "O³Ãd ffÜ wr™e, fd = " << 
	gfd
;

611 
ASSERT_GE
(
fd
, 0);

614 
EXPECT_EQ
(
£cu»_şo£
(
fd
), 0);

615 
EXPECT_EQ
(
EmuÏ‹S‘KeyIoùl
(
fd
), -1);

616 
EXPECT_EQ
(
”ºo
, 
ENOENT
);

619 
TEST_P
(
EnşaveStÜageSecu»Te¡
, 
UnsuµÜ‹dFeC»©iÚFÏgFau»
) {

621 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
 | 
O_APPEND
,

622 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

623 
EXPECT_EQ
(
fd
, -1);

626 
	gfd
 = 
£cu»_İ’
(
G‘P©h
().
c_¡r
(), 
O_WRONLY
 | 
O_CREAT
 | 
O_TRUNC
,

627 
S_IRWXU
 | 
S_IRWXG
 | 
S_IRWXO
);

628 
EXPECT_EQ
(
fd
, -1);

	@platform/storage/utils/fd_closer.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

21 
	~<uni¡d.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	g¶©fÜm
 {

25 
Çme¥aû
 
	g¡Üage
 {

27 
	gFdClo£r
::
FdClo£r
(è: 
fd_
(-1), 
şo£_funùiÚ_
(&
şo£
) {}

29 
	gFdClo£r
::
FdClo£r
(
fd
è: 
fd_
(fd), 
şo£_funùiÚ_
(&
şo£
) {}

31 
	gFdClo£r
::
FdClo£r
(
fd
, 
Clo£FunùiÚ
 
şo£_funùiÚ
)

32 : 
fd_
(
fd
), 
şo£_funùiÚ_
(
şo£_funùiÚ
) {}

34 
	gFdClo£r
::
g‘
(ècÚ¡ {  
fd_
; }

36 
	gFdClo£r
::~
FdClo£r
(è{ 
»£t
(-1); }

38 
	gFdClo£r
::
»Ëa£
() {

39 
fd
 = 
fd_
;

40 
	gfd_
 = -1;

41  
	gfd
;

44 
boŞ
 
	gFdClo£r
::
»£t
(
Ãw_fd
) {

45 
boŞ
 
»suÉ
 = 
Œue
;

46 ià(
	gfd_
 >= 0)

47 
»suÉ
 =

48 
şo£_funùiÚ_
 ? (şo£_funùiÚ_(
fd_
è!ğ-1è: (
şo£
(fd_) != -1);

49 
	gfd_
 = 
Ãw_fd
;

50  
	g»suÉ
;

53 
boŞ
 
	gFdClo£r
::
»£t
() { „eset(-1); }

	@platform/storage/utils/fd_closer.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

21 
	~<uni¡d.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	g¶©fÜm
 {

25 
Çme¥aû
 
	g¡Üage
 {

27 
	gFdClo£r
::
FdClo£r
(è: 
fd_
(-1), 
şo£_funùiÚ_
(&
şo£
) {}

29 
	gFdClo£r
::
FdClo£r
(
fd
è: 
fd_
(fd), 
şo£_funùiÚ_
(&
şo£
) {}

31 
	gFdClo£r
::
FdClo£r
(
fd
, 
Clo£FunùiÚ
 
şo£_funùiÚ
)

32 : 
fd_
(
fd
), 
şo£_funùiÚ_
(
şo£_funùiÚ
) {}

34 
	gFdClo£r
::
g‘
(ècÚ¡ {  
fd_
; }

36 
	gFdClo£r
::~
FdClo£r
(è{ 
»£t
(-1); }

38 
	gFdClo£r
::
»Ëa£
() {

39 
fd
 = 
fd_
;

40 
	gfd_
 = -1;

41  
	gfd
;

44 
boŞ
 
	gFdClo£r
::
»£t
(
Ãw_fd
) {

45 
boŞ
 
»suÉ
 = 
Œue
;

46 ià(
	gfd_
 >= 0)

47 
»suÉ
 =

48 
şo£_funùiÚ_
 ? (şo£_funùiÚ_(
fd_
è!ğ-1è: (
şo£
(fd_) != -1);

49 
	gfd_
 = 
Ãw_fd
;

50  
	g»suÉ
;

53 
boŞ
 
	gFdClo£r
::
»£t
() { „eset(-1); }

	@platform/storage/utils/fd_closer.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_UTILS_FD_CLOSER_H_


20 
	#ASYLO_PLATFORM_STORAGE_UTILS_FD_CLOSER_H_


	)

22 
Çme¥aû
 
	gasylo
 {

23 
Çme¥aû
 
	g¶©fÜm
 {

24 
Çme¥aû
 
	g¡Üage
 {

26 (*
	gClo£FunùiÚ
)();

30 şas 
	cFdClo£r
 {

31 
	gpublic
:

32 
FdClo£r
();

33 
ex¶ic™
 
FdClo£r
(
fd
);

34 
FdClo£r
(
fd
, 
Clo£FunùiÚ
 
şo£_funùiÚ
);

35 
g‘
() const;

36 ~
FdClo£r
();

37 
»Ëa£
();

41 
boŞ
 
»£t
(
Ãw_fd
);

44 
boŞ
 
»£t
();

46 
	g´iv©e
:

47 
fd_
;

48 cÚ¡ 
Clo£FunùiÚ
 
	gşo£_funùiÚ_
;

49 
FdClo£r
(cÚ¡ FdClo£¸&èğ
d–‘e
;

50 
	gFdClo£r
 &
	gİ”©Ü
=(cÚ¡ 
FdClo£r
 &èğ
d–‘e
;

	@platform/storage/utils/fd_closer_test.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

21 
	~<g‹¡/g‹¡.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	g¶©fÜm
 {

25 
Çme¥aû
 
	g¡Üage
 {

27 
	gÇme¥aû
 {

29 
boŞ
 
	gşo£_was_ÿÎed
 = 
çl£
;

31 şas 
	cFdClo£rTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

32 
public
:

33 
FdClo£rTe¡
(è{ 
şo£_was_ÿÎed
 = 
çl£
; }

36 
şo£_‹¡
(
fd
) {

37 
	gşo£_was_ÿÎed
 = 
Œue
;

41 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rDe¡ruùÜTe¡
) {

42 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

44 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

45 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

47 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

50 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rR–—£Te¡
) {

51 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

53 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

54 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

55 
	gfd
 = 
fd_şo£r
.
»Ëa£
();

56 
EXPECT_EQ
(1, 
fd
);

57 
EXPECT_EQ
(-1, 
fd_şo£r
.
g‘
());

58 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

60 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

63 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rRe£tTe¡
) {

64 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

66 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

67 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

68 
EXPECT_TRUE
(
fd_şo£r
.
»£t
(2));

69 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

70 
EXPECT_EQ
(2, 
fd_şo£r
.
g‘
());

71 
	gşo£_was_ÿÎed
 = 
çl£
;

73 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

76 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rDeçuÉRe£tTe¡
) {

77 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

79 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

80 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

81 
EXPECT_TRUE
(
fd_şo£r
.
»£t
());

82 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

83 
EXPECT_EQ
(-1, 
fd_şo£r
.
g‘
());

84 
	gşo£_was_ÿÎed
 = 
çl£
;

86 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

	@platform/storage/utils/fd_closer_test.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

21 
	~<g‹¡/g‹¡.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
Çme¥aû
 
	g¶©fÜm
 {

25 
Çme¥aû
 
	g¡Üage
 {

27 
	gÇme¥aû
 {

29 
boŞ
 
	gşo£_was_ÿÎed
 = 
çl£
;

31 şas 
	cFdClo£rTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

32 
public
:

33 
FdClo£rTe¡
(è{ 
şo£_was_ÿÎed
 = 
çl£
; }

36 
şo£_‹¡
(
fd
) {

37 
	gşo£_was_ÿÎed
 = 
Œue
;

41 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rDe¡ruùÜTe¡
) {

42 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

44 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

45 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

47 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

50 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rR–—£Te¡
) {

51 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

53 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

54 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

55 
	gfd
 = 
fd_şo£r
.
»Ëa£
();

56 
EXPECT_EQ
(1, 
fd
);

57 
EXPECT_EQ
(-1, 
fd_şo£r
.
g‘
());

58 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

60 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

63 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rRe£tTe¡
) {

64 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

66 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

67 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

68 
EXPECT_TRUE
(
fd_şo£r
.
»£t
(2));

69 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

70 
EXPECT_EQ
(2, 
fd_şo£r
.
g‘
());

71 
	gşo£_was_ÿÎed
 = 
çl£
;

73 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

76 
TEST_F
(
FdClo£rTe¡
, 
FdClo£rDeçuÉRe£tTe¡
) {

77 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

79 
FdClo£r
 
fd_şo£r
(1, &
şo£_‹¡
);

80 
EXPECT_EQ
(1, 
fd_şo£r
.
g‘
());

81 
EXPECT_TRUE
(
fd_şo£r
.
»£t
());

82 
EXPECT_EQ
(
Œue
, 
şo£_was_ÿÎed
);

83 
EXPECT_EQ
(-1, 
fd_şo£r
.
g‘
());

84 
	gşo£_was_ÿÎed
 = 
çl£
;

86 
EXPECT_EQ
(
çl£
, 
şo£_was_ÿÎed
);

	@platform/storage/utils/offset_translator.cc

21 
	~"asylo/¶©fÜm/¡Üage/uts/off£t_Œª¦©Ü.h
"

23 
	~<sys/ty³s.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	g¶©fÜm
 {

29 
Çme¥aû
 
	g¡Üage
 {

31 
	g¡d
::
unique_±r
<
Off£tT¿n¦©Ü
> Off£tT¿n¦©Ü::
C»©e
(
size_t
 
h—d”_Ën
,

32 
size_t
 
·ylßd_Ën
,

33 
size_t
 
block_Ën
) {

36 ià(
	gh—d”_Ën
 =ğ0 || 
·ylßd_Ën
 =ğ0 || 
block_Ën
 == 0 ||

37 
·ylßd_Ën
 >ğ
block_Ën
) {

38  
nuÎ±r
;

41  
	gab¦
::
W¿pUnique
<
Off£tT¿n¦©Ü
>(

42 
Ãw
 
Off£tT¿n¦©Ü
(
h—d”_Ën
, 
·ylßd_Ën
, 
block_Ën
));

45 
	gOff£tT¿n¦©Ü
::
Off£tT¿n¦©Ü
(
size_t
 
h—d”_Ën
, size_ˆ
·ylßd_Ën
,

46 
size_t
 
block_Ën
)

47 : 
h—d”_Ëngth_
(
h—d”_Ën
),

48 
·ylßd_Ëngth_
(
·ylßd_Ën
),

49 
block_Ëngth_
(
block_Ën
) {}

51 
off_t
 
	gOff£tT¿n¦©Ü
::
PhysiÿlToLogiÿl
(off_ˆ
off£t
) const {

52 
off_t
 
h—d”_Ëngth_off£t
 = 
h—d”_Ëngth_
;

53 ià(
	goff£t
 < 
	gh—d”_Ëngth_off£t
) {

54  
	gkInv®idOff£t
;

57 
off_t
 
	g
 = (
off£t
 - 
h—d”_Ëngth_
è% 
block_Ëngth_
;

58 ià(
	g
 >ğ
·ylßd_Ëngth_
) {

59  
kInv®idOff£t
;

62  ((
	goff£t
 - 
	gh—d”_Ëngth_
è/ 
	gblock_Ëngth_
è* 
	g·ylßd_Ëngth_
 + 
	g
;

65 
off_t
 
	gOff£tT¿n¦©Ü
::
LogiÿlToPhysiÿl
(off_ˆ
off£t
) const {

66 ià(
off£t
 < 0) {

67  
kInv®idOff£t
;

70  
	gh—d”_Ëngth_
 + (
	goff£t
 / 
	g·ylßd_Ëngth_
è* 
	gblock_Ëngth_
 +

71 
	goff£t
 % 
	g·ylßd_Ëngth_
;

74 
	gOff£tT¿n¦©Ü
::
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

75 
off_t
 
logiÿl_off£t
, 
size_t
 
couÁ
, size_ˆ*
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

76 
size_t
 *
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

77 
size_t
 *
fuÎ_šşusive_blocks_by‹s_couÁ
) {

78 
off_t
 
	gš_block_off£t
 = 
logiÿl_off£t
 % 
·ylßd_Ëngth_
;

79 *
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 =

80 (
š_block_off£t
 > 0è? (
·ylßd_Ëngth_
 - in_block_offset) : 0;

81 *
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 = 0;

82 
size_t
 
	gfuÎ_blocks_by‹s_couÁ
 = 0;

83 ià(*
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 >ğ
couÁ
) {

84 *
fœ¡_·¹Ÿl_block_by‹s_couÁ
 = 
couÁ
;

86 *
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 =

87 (
couÁ
 - *
fœ¡_·¹Ÿl_block_by‹s_couÁ
è% 
·ylßd_Ëngth_
;

88 
	gfuÎ_blocks_by‹s_couÁ
 = 
couÁ
 - *
fœ¡_·¹Ÿl_block_by‹s_couÁ
 -

89 *
Ï¡_·¹Ÿl_block_by‹s_couÁ
;

91 *
	gfuÎ_šşusive_blocks_by‹s_couÁ
 = 
fuÎ_blocks_by‹s_couÁ
;

92 ià(*
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

93 *
	gfuÎ_šşusive_blocks_by‹s_couÁ
 +ğ
·ylßd_Ëngth_
;

95 ià(*
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

96 *
	gfuÎ_šşusive_blocks_by‹s_couÁ
 +ğ
·ylßd_Ëngth_
;

	@platform/storage/utils/offset_translator.cc

21 
	~"asylo/¶©fÜm/¡Üage/uts/off£t_Œª¦©Ü.h
"

23 
	~<sys/ty³s.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	g¶©fÜm
 {

29 
Çme¥aû
 
	g¡Üage
 {

31 
	g¡d
::
unique_±r
<
Off£tT¿n¦©Ü
> Off£tT¿n¦©Ü::
C»©e
(
size_t
 
h—d”_Ën
,

32 
size_t
 
·ylßd_Ën
,

33 
size_t
 
block_Ën
) {

36 ià(
	gh—d”_Ën
 =ğ0 || 
·ylßd_Ën
 =ğ0 || 
block_Ën
 == 0 ||

37 
·ylßd_Ën
 >ğ
block_Ën
) {

38  
nuÎ±r
;

41  
	gab¦
::
W¿pUnique
<
Off£tT¿n¦©Ü
>(

42 
Ãw
 
Off£tT¿n¦©Ü
(
h—d”_Ën
, 
·ylßd_Ën
, 
block_Ën
));

45 
	gOff£tT¿n¦©Ü
::
Off£tT¿n¦©Ü
(
size_t
 
h—d”_Ën
, size_ˆ
·ylßd_Ën
,

46 
size_t
 
block_Ën
)

47 : 
h—d”_Ëngth_
(
h—d”_Ën
),

48 
·ylßd_Ëngth_
(
·ylßd_Ën
),

49 
block_Ëngth_
(
block_Ën
) {}

51 
off_t
 
	gOff£tT¿n¦©Ü
::
PhysiÿlToLogiÿl
(off_ˆ
off£t
) const {

52 
off_t
 
h—d”_Ëngth_off£t
 = 
h—d”_Ëngth_
;

53 ià(
	goff£t
 < 
	gh—d”_Ëngth_off£t
) {

54  
	gkInv®idOff£t
;

57 
off_t
 
	g
 = (
off£t
 - 
h—d”_Ëngth_
è% 
block_Ëngth_
;

58 ià(
	g
 >ğ
·ylßd_Ëngth_
) {

59  
kInv®idOff£t
;

62  ((
	goff£t
 - 
	gh—d”_Ëngth_
è/ 
	gblock_Ëngth_
è* 
	g·ylßd_Ëngth_
 + 
	g
;

65 
off_t
 
	gOff£tT¿n¦©Ü
::
LogiÿlToPhysiÿl
(off_ˆ
off£t
) const {

66 ià(
off£t
 < 0) {

67  
kInv®idOff£t
;

70  
	gh—d”_Ëngth_
 + (
	goff£t
 / 
	g·ylßd_Ëngth_
è* 
	gblock_Ëngth_
 +

71 
	goff£t
 % 
	g·ylßd_Ëngth_
;

74 
	gOff£tT¿n¦©Ü
::
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

75 
off_t
 
logiÿl_off£t
, 
size_t
 
couÁ
, size_ˆ*
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

76 
size_t
 *
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

77 
size_t
 *
fuÎ_šşusive_blocks_by‹s_couÁ
) {

78 
off_t
 
	gš_block_off£t
 = 
logiÿl_off£t
 % 
·ylßd_Ëngth_
;

79 *
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 =

80 (
š_block_off£t
 > 0è? (
·ylßd_Ëngth_
 - in_block_offset) : 0;

81 *
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 = 0;

82 
size_t
 
	gfuÎ_blocks_by‹s_couÁ
 = 0;

83 ià(*
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 >ğ
couÁ
) {

84 *
fœ¡_·¹Ÿl_block_by‹s_couÁ
 = 
couÁ
;

86 *
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 =

87 (
couÁ
 - *
fœ¡_·¹Ÿl_block_by‹s_couÁ
è% 
·ylßd_Ëngth_
;

88 
	gfuÎ_blocks_by‹s_couÁ
 = 
couÁ
 - *
fœ¡_·¹Ÿl_block_by‹s_couÁ
 -

89 *
Ï¡_·¹Ÿl_block_by‹s_couÁ
;

91 *
	gfuÎ_šşusive_blocks_by‹s_couÁ
 = 
fuÎ_blocks_by‹s_couÁ
;

92 ià(*
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

93 *
	gfuÎ_šşusive_blocks_by‹s_couÁ
 +ğ
·ylßd_Ëngth_
;

95 ià(*
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
 > 0) {

96 *
	gfuÎ_šşusive_blocks_by‹s_couÁ
 +ğ
·ylßd_Ëngth_
;

	@platform/storage/utils/offset_translator.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_UTILS_OFFSET_TRANSLATOR_H_


20 
	#ASYLO_PLATFORM_STORAGE_UTILS_OFFSET_TRANSLATOR_H_


	)

22 
	~<sys/ty³s.h
>

23 
	~<memÜy
>

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	g¶©fÜm
 {

27 
Çme¥aû
 
	g¡Üage
 {

43 şas 
	cOff£tT¿n¦©Ü
 {

44 
	gpublic
:

46 
cÚ¡ex´
 
off_t
 
kInv®idOff£t
 = -1;

48 
	g¡d
::
unique_±r
<
Off£tT¿n¦©Ü
> 
C»©e
(
size_t
 
h—d”_Ën
,

49 
size_t
 
·ylßd_Ën
,

50 
size_t
 
block_Ën
);

55 
off_t
 
PhysiÿlToLogiÿl
(off_ˆ
off£t
) const;

60 
off_t
 
LogiÿlToPhysiÿl
(off_ˆ
off£t
) const;

65 
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

66 
off_t
 
logiÿl_off£t
, 
size_t
 
couÁ
,

67 
size_t
 *
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

68 
size_t
 *
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

69 
size_t
 *
fuÎ_šşusive_blocks_by‹s_couÁ
);

71 
	g´iv©e
:

72 
Off£tT¿n¦©Ü
(
size_t
 
h—d”_Ën
, size_ˆ
·ylßd_Ën
, size_ˆ
block_Ën
);

73 cÚ¡ 
size_t
 
	gh—d”_Ëngth_
;

74 cÚ¡ 
size_t
 
	g·ylßd_Ëngth_
;

75 cÚ¡ 
size_t
 
	gblock_Ëngth_
;

	@platform/storage/utils/offset_translator_test.cc

20 
	~"asylo/¶©fÜm/¡Üage/uts/off£t_Œª¦©Ü.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/ut/loggšg.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
usšg
 
	g¶©fÜm
::
¡Üage
::
Off£tT¿n¦©Ü
;

30 
şass
 
	gOff£tT¿n¦©ÜTe¡
 : 
public
 ::
‹¡šg
::
Te¡
,

31 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<

32 ::
‹¡šg
::
tu¶e
<
off_t
, 
	goff_t
, off_t>> {

33 
	g´Ùeùed
:

34 
FlUpP¬am‘”sAndC»©e
();

36 
	g¡d
::
unique_±r
<
Off£tT¿n¦©Ü
> 
Œª¦©Ü_
;

37 
size_t
 
	gh—d”_Ëngth_
;

38 
size_t
 
	g·ylßd_Ëngth_
;

39 
size_t
 
	gblock_Ëngth_
;

42 
cÚ¡ex´
 
off_t
 
	gkInv®idOff£t
 = 
Off£tT¿n¦©Ü
::
kInv®idOff£t
;

44 cÚ¡ 
off_t
 
	gh—d”_Ëngth_v®s
[] = {10, 40, 120};

45 cÚ¡ 
off_t
 
	g·ylßd_Ëngth_v®s
[] = {10, 40, 120};

46 cÚ¡ 
off_t
 
	gm‘a_Ëngth_v®s
[] = {10, 40, 120};

48 
INSTANTIATE_TEST_SUITE_P
(

49 
In¡ªû1
, 
Off£tT¿n¦©ÜTe¡
,

50 ::
‹¡šg
::
Combše
(::‹¡šg::
V®uesIn
(
h—d”_Ëngth_v®s
),

51 ::
‹¡šg
::
V®uesIn
(
·ylßd_Ëngth_v®s
),

52 ::
‹¡šg
::
V®uesIn
(
m‘a_Ëngth_v®s
)));

54 
	gOff£tT¿n¦©ÜTe¡
::
FlUpP¬am‘”sAndC»©e
() {

55 
h—d”_Ëngth_
 = ::
‹¡šg
::
g‘
<0>(
G‘P¬am
());

56 
	g·ylßd_Ëngth_
 = ::
‹¡šg
::
g‘
<1>(
G‘P¬am
());

57 
	gblock_Ëngth_
 = ::
‹¡šg
::
g‘
<1>(
G‘P¬am
()) + ::testing::get<2>(GetParam());

58 
	gŒª¦©Ü_
 =

59 
Off£tT¿n¦©Ü
::
C»©e
(
h—d”_Ëngth_
, 
·ylßd_Ëngth_
, 
block_Ëngth_
);

62 
TEST
(
C»©eFau»Te¡
, 
Off£tT¿n¦©ÜTe¡
) {

63 
EXPECT_EQ
(
Off£tT¿n¦©Ü
::
C»©e
(10, 100, 100), 
nuÎ±r
);

64 
EXPECT_EQ
(
Off£tT¿n¦©Ü
::
C»©e
(0, 100, 140), 
nuÎ±r
);

65 
EXPECT_EQ
(
Off£tT¿n¦©Ü
::
C»©e
(10, 0, 140), 
nuÎ±r
);

68 
TEST_P
(
Off£tT¿n¦©ÜTe¡
, 
PhysiÿlToLogiÿlTe¡
) {

69 
FlUpP¬am‘”sAndC»©e
();

70 
ASSERT_NE
(
Œª¦©Ü_
, 
nuÎ±r
);

71 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(-1), 
kInv®idOff£t
);

72 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(0), 
kInv®idOff£t
);

73 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(1), 
kInv®idOff£t
);

74 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 - 1), 
kInv®idOff£t
);

75 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
), 0);

76 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 1), 1);

77 
EXPECT_EQ
(

78 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
 - 1),

79 
·ylßd_Ëngth_
 - 1);

80 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
),

81 
kInv®idOff£t
);

82 
EXPECT_EQ
(

83 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
 + 1),

84 
kInv®idOff£t
);

85 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 - 1),

86 
kInv®idOff£t
);

87 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
),

88 
·ylßd_Ëngth_
);

89 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 + 1),

90 
·ylßd_Ëngth_
 + 1);

91 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 +

92 
·ylßd_Ëngth_
 - 1),

93 2 * 
·ylßd_Ëngth_
 - 1);

94 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 +

95 
·ylßd_Ëngth_
),

96 
kInv®idOff£t
);

97 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 +

98 
·ylßd_Ëngth_
 + 1),

99 
kInv®idOff£t
);

100 
EXPECT_EQ
(

101 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
 - 1),

102 
kInv®idOff£t
);

103 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
),

104 2 * 
·ylßd_Ëngth_
);

105 
EXPECT_EQ
(

106 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
 + 1),

107 2 * 
·ylßd_Ëngth_
 + 1);

110 
TEST_P
(
Off£tT¿n¦©ÜTe¡
, 
LogiÿlToPhysiÿlTe¡
) {

111 
FlUpP¬am‘”sAndC»©e
();

112 
ASSERT_NE
(
Œª¦©Ü_
, 
nuÎ±r
);

113 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(-1), 
kInv®idOff£t
);

114 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(0), 
h—d”_Ëngth_
);

115 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(1), 
h—d”_Ëngth_
 + 1);

116 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
·ylßd_Ëngth_
 - 1),

117 
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
 - 1);

118 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
·ylßd_Ëngth_
),

119 
h—d”_Ëngth_
 + 
block_Ëngth_
);

120 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
·ylßd_Ëngth_
 + 1),

121 
h—d”_Ëngth_
 + 
block_Ëngth_
 + 1);

122 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(2 * 
·ylßd_Ëngth_
 - 1),

123 
h—d”_Ëngth_
 + 
block_Ëngth_
 + 
·ylßd_Ëngth_
 - 1);

124 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(2 * 
·ylßd_Ëngth_
),

125 
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
);

126 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(2 * 
·ylßd_Ëngth_
 + 1),

127 
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
 + 1);

130 
TEST_P
(
Off£tT¿n¦©ÜTe¡
, 
ReduûLogiÿlRªgeToFuÎLogiÿlBlocksTe¡
) {

131 
	s¿nge_to_blocks_‹¡_–em’t
 {

132 
off_t
 
	glogiÿl_off£t
;

133 
size_t
 
	gcouÁ
;

134 
size_t
 
	gex³ùed_fœ¡_·¹Ÿl_block_by‹s_couÁ
;

135 
size_t
 
	gex³ùed_Ï¡_·¹Ÿl_block_by‹s_couÁ
;

136 
size_t
 
	gex³ùed_fuÎ_šşusive_blocks_by‹s_couÁ
;

139 
FlUpP¬am‘”sAndC»©e
();

140 
ASSERT_NE
(
Œª¦©Ü_
, 
nuÎ±r
);

142 
off_t
 
	g·ylßd_Ëngth_off£t
 = 
·ylßd_Ëngth_
;

143 cÚ¡ 
¿nge_to_blocks_‹¡_–em’t
 
	g¿nge_to_blocks_‹¡_–em’ts
[] = {

145 {
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2, 0, 0, 0, 0},

146 {0, 
·ylßd_Ëngth_
 / 2, 0,…ayload_length_ / 2,…ayload_length_},

147 {0, 
·ylßd_Ëngth_
, 0, 0,…ayload_length_},

148 {0, 2 * 
·ylßd_Ëngth_
 +…ayload_length_ / 2, 0,…ayload_length_ / 2,

149 3 * 
·ylßd_Ëngth_
},

150 {10 * 
·ylßd_Ëngth_off£t
, 
·ylßd_Ëngth_
 / 2, 0,…ayload_length_ / 2,

151 
·ylßd_Ëngth_
},

152 {10 * 
·ylßd_Ëngth_off£t
, 
·ylßd_Ëngth_
, 0, 0,…ayload_length_},

153 {10 * 
·ylßd_Ëngth_off£t
, 2 * 
·ylßd_Ëngth_
 +…ayload_length_ / 2, 0,

154 
·ylßd_Ëngth_
 / 2, 3 *…ayload_length_},

155 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

156 
·ylßd_Ëngth_
 / 4,…ayload_length_ / 4, 0,…ayload_length_},

157 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

158 
·ylßd_Ëngth_
 / 2,…ayload_length_ / 2, 0,…ayload_length_},

159 {10 * 
·ylßd_Ëngth_off£t
 +…aylßd_Ëngth_off£ˆ/ 2, 
·ylßd_Ëngth_
,

160 
·ylßd_Ëngth_
 / 2,…ayload_length_ / 2, 2 *…ayload_length_},

161 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

162 
·ylßd_Ëngth_
 +…ayload_length_ / 2,…ayload_length_ / 2, 0,

163 2 * 
·ylßd_Ëngth_
},

164 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

165 2 * 
·ylßd_Ëngth_
,…ayload_length_ / 2,…ayload_length_ / 2,

166 3 * 
·ylßd_Ëngth_
},

169 
size_t
 
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
;

170 
size_t
 
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
;

171 
size_t
 
	gfuÎ_šşusive_blocks_by‹s_couÁ
;

173 cÚ¡ 
	g‹¡s_couÁ
 = (
¿nge_to_blocks_‹¡_–em’ts
) /

174 (
¿nge_to_blocks_‹¡_–em’t
);

175 
	g‹¡_idx
 = 0;e¡_idx < 
	g‹¡s_couÁ
;est_idx++) {

176 
	gŒª¦©Ü_
->
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

177 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
].
logiÿl_off£t
,

178 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
].
couÁ
,

179 &
fœ¡_·¹Ÿl_block_by‹s_couÁ
, &
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

180 &
fuÎ_šşusive_blocks_by‹s_couÁ
);

182 
EXPECT_EQ
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

183 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
]

184 .
ex³ùed_fœ¡_·¹Ÿl_block_by‹s_couÁ
);

185 
EXPECT_EQ
(
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

186 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
]

187 .
ex³ùed_Ï¡_·¹Ÿl_block_by‹s_couÁ
);

188 
EXPECT_EQ
(
fuÎ_šşusive_blocks_by‹s_couÁ
,

189 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
]

190 .
ex³ùed_fuÎ_šşusive_blocks_by‹s_couÁ
);

	@platform/storage/utils/offset_translator_test.cc

20 
	~"asylo/¶©fÜm/¡Üage/uts/off£t_Œª¦©Ü.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/ut/loggšg.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
usšg
 
	g¶©fÜm
::
¡Üage
::
Off£tT¿n¦©Ü
;

30 
şass
 
	gOff£tT¿n¦©ÜTe¡
 : 
public
 ::
‹¡šg
::
Te¡
,

31 
	gpublic
 ::
‹¡šg
::
W™hP¬amIÁ”çû
<

32 ::
‹¡šg
::
tu¶e
<
off_t
, 
	goff_t
, off_t>> {

33 
	g´Ùeùed
:

34 
FlUpP¬am‘”sAndC»©e
();

36 
	g¡d
::
unique_±r
<
Off£tT¿n¦©Ü
> 
Œª¦©Ü_
;

37 
size_t
 
	gh—d”_Ëngth_
;

38 
size_t
 
	g·ylßd_Ëngth_
;

39 
size_t
 
	gblock_Ëngth_
;

42 
cÚ¡ex´
 
off_t
 
	gkInv®idOff£t
 = 
Off£tT¿n¦©Ü
::
kInv®idOff£t
;

44 cÚ¡ 
off_t
 
	gh—d”_Ëngth_v®s
[] = {10, 40, 120};

45 cÚ¡ 
off_t
 
	g·ylßd_Ëngth_v®s
[] = {10, 40, 120};

46 cÚ¡ 
off_t
 
	gm‘a_Ëngth_v®s
[] = {10, 40, 120};

48 
INSTANTIATE_TEST_SUITE_P
(

49 
In¡ªû1
, 
Off£tT¿n¦©ÜTe¡
,

50 ::
‹¡šg
::
Combše
(::‹¡šg::
V®uesIn
(
h—d”_Ëngth_v®s
),

51 ::
‹¡šg
::
V®uesIn
(
·ylßd_Ëngth_v®s
),

52 ::
‹¡šg
::
V®uesIn
(
m‘a_Ëngth_v®s
)));

54 
	gOff£tT¿n¦©ÜTe¡
::
FlUpP¬am‘”sAndC»©e
() {

55 
h—d”_Ëngth_
 = ::
‹¡šg
::
g‘
<0>(
G‘P¬am
());

56 
	g·ylßd_Ëngth_
 = ::
‹¡šg
::
g‘
<1>(
G‘P¬am
());

57 
	gblock_Ëngth_
 = ::
‹¡šg
::
g‘
<1>(
G‘P¬am
()) + ::testing::get<2>(GetParam());

58 
	gŒª¦©Ü_
 =

59 
Off£tT¿n¦©Ü
::
C»©e
(
h—d”_Ëngth_
, 
·ylßd_Ëngth_
, 
block_Ëngth_
);

62 
TEST
(
C»©eFau»Te¡
, 
Off£tT¿n¦©ÜTe¡
) {

63 
EXPECT_EQ
(
Off£tT¿n¦©Ü
::
C»©e
(10, 100, 100), 
nuÎ±r
);

64 
EXPECT_EQ
(
Off£tT¿n¦©Ü
::
C»©e
(0, 100, 140), 
nuÎ±r
);

65 
EXPECT_EQ
(
Off£tT¿n¦©Ü
::
C»©e
(10, 0, 140), 
nuÎ±r
);

68 
TEST_P
(
Off£tT¿n¦©ÜTe¡
, 
PhysiÿlToLogiÿlTe¡
) {

69 
FlUpP¬am‘”sAndC»©e
();

70 
ASSERT_NE
(
Œª¦©Ü_
, 
nuÎ±r
);

71 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(-1), 
kInv®idOff£t
);

72 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(0), 
kInv®idOff£t
);

73 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(1), 
kInv®idOff£t
);

74 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 - 1), 
kInv®idOff£t
);

75 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
), 0);

76 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 1), 1);

77 
EXPECT_EQ
(

78 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
 - 1),

79 
·ylßd_Ëngth_
 - 1);

80 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
),

81 
kInv®idOff£t
);

82 
EXPECT_EQ
(

83 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
 + 1),

84 
kInv®idOff£t
);

85 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 - 1),

86 
kInv®idOff£t
);

87 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
),

88 
·ylßd_Ëngth_
);

89 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 + 1),

90 
·ylßd_Ëngth_
 + 1);

91 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 +

92 
·ylßd_Ëngth_
 - 1),

93 2 * 
·ylßd_Ëngth_
 - 1);

94 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 +

95 
·ylßd_Ëngth_
),

96 
kInv®idOff£t
);

97 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 
block_Ëngth_
 +

98 
·ylßd_Ëngth_
 + 1),

99 
kInv®idOff£t
);

100 
EXPECT_EQ
(

101 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
 - 1),

102 
kInv®idOff£t
);

103 
EXPECT_EQ
(
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
),

104 2 * 
·ylßd_Ëngth_
);

105 
EXPECT_EQ
(

106 
Œª¦©Ü_
->
PhysiÿlToLogiÿl
(
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
 + 1),

107 2 * 
·ylßd_Ëngth_
 + 1);

110 
TEST_P
(
Off£tT¿n¦©ÜTe¡
, 
LogiÿlToPhysiÿlTe¡
) {

111 
FlUpP¬am‘”sAndC»©e
();

112 
ASSERT_NE
(
Œª¦©Ü_
, 
nuÎ±r
);

113 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(-1), 
kInv®idOff£t
);

114 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(0), 
h—d”_Ëngth_
);

115 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(1), 
h—d”_Ëngth_
 + 1);

116 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
·ylßd_Ëngth_
 - 1),

117 
h—d”_Ëngth_
 + 
·ylßd_Ëngth_
 - 1);

118 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
·ylßd_Ëngth_
),

119 
h—d”_Ëngth_
 + 
block_Ëngth_
);

120 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(
·ylßd_Ëngth_
 + 1),

121 
h—d”_Ëngth_
 + 
block_Ëngth_
 + 1);

122 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(2 * 
·ylßd_Ëngth_
 - 1),

123 
h—d”_Ëngth_
 + 
block_Ëngth_
 + 
·ylßd_Ëngth_
 - 1);

124 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(2 * 
·ylßd_Ëngth_
),

125 
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
);

126 
EXPECT_EQ
(
Œª¦©Ü_
->
LogiÿlToPhysiÿl
(2 * 
·ylßd_Ëngth_
 + 1),

127 
h—d”_Ëngth_
 + 2 * 
block_Ëngth_
 + 1);

130 
TEST_P
(
Off£tT¿n¦©ÜTe¡
, 
ReduûLogiÿlRªgeToFuÎLogiÿlBlocksTe¡
) {

131 
	s¿nge_to_blocks_‹¡_–em’t
 {

132 
off_t
 
	glogiÿl_off£t
;

133 
size_t
 
	gcouÁ
;

134 
size_t
 
	gex³ùed_fœ¡_·¹Ÿl_block_by‹s_couÁ
;

135 
size_t
 
	gex³ùed_Ï¡_·¹Ÿl_block_by‹s_couÁ
;

136 
size_t
 
	gex³ùed_fuÎ_šşusive_blocks_by‹s_couÁ
;

139 
FlUpP¬am‘”sAndC»©e
();

140 
ASSERT_NE
(
Œª¦©Ü_
, 
nuÎ±r
);

142 
off_t
 
	g·ylßd_Ëngth_off£t
 = 
·ylßd_Ëngth_
;

143 cÚ¡ 
¿nge_to_blocks_‹¡_–em’t
 
	g¿nge_to_blocks_‹¡_–em’ts
[] = {

145 {
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2, 0, 0, 0, 0},

146 {0, 
·ylßd_Ëngth_
 / 2, 0,…ayload_length_ / 2,…ayload_length_},

147 {0, 
·ylßd_Ëngth_
, 0, 0,…ayload_length_},

148 {0, 2 * 
·ylßd_Ëngth_
 +…ayload_length_ / 2, 0,…ayload_length_ / 2,

149 3 * 
·ylßd_Ëngth_
},

150 {10 * 
·ylßd_Ëngth_off£t
, 
·ylßd_Ëngth_
 / 2, 0,…ayload_length_ / 2,

151 
·ylßd_Ëngth_
},

152 {10 * 
·ylßd_Ëngth_off£t
, 
·ylßd_Ëngth_
, 0, 0,…ayload_length_},

153 {10 * 
·ylßd_Ëngth_off£t
, 2 * 
·ylßd_Ëngth_
 +…ayload_length_ / 2, 0,

154 
·ylßd_Ëngth_
 / 2, 3 *…ayload_length_},

155 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

156 
·ylßd_Ëngth_
 / 4,…ayload_length_ / 4, 0,…ayload_length_},

157 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

158 
·ylßd_Ëngth_
 / 2,…ayload_length_ / 2, 0,…ayload_length_},

159 {10 * 
·ylßd_Ëngth_off£t
 +…aylßd_Ëngth_off£ˆ/ 2, 
·ylßd_Ëngth_
,

160 
·ylßd_Ëngth_
 / 2,…ayload_length_ / 2, 2 *…ayload_length_},

161 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

162 
·ylßd_Ëngth_
 +…ayload_length_ / 2,…ayload_length_ / 2, 0,

163 2 * 
·ylßd_Ëngth_
},

164 {10 * 
·ylßd_Ëngth_off£t
 +…ayload_length_offset / 2,

165 2 * 
·ylßd_Ëngth_
,…ayload_length_ / 2,…ayload_length_ / 2,

166 3 * 
·ylßd_Ëngth_
},

169 
size_t
 
	gfœ¡_·¹Ÿl_block_by‹s_couÁ
;

170 
size_t
 
	gÏ¡_·¹Ÿl_block_by‹s_couÁ
;

171 
size_t
 
	gfuÎ_šşusive_blocks_by‹s_couÁ
;

173 cÚ¡ 
	g‹¡s_couÁ
 = (
¿nge_to_blocks_‹¡_–em’ts
) /

174 (
¿nge_to_blocks_‹¡_–em’t
);

175 
	g‹¡_idx
 = 0;e¡_idx < 
	g‹¡s_couÁ
;est_idx++) {

176 
	gŒª¦©Ü_
->
ReduûLogiÿlRªgeToFuÎLogiÿlBlocks
(

177 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
].
logiÿl_off£t
,

178 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
].
couÁ
,

179 &
fœ¡_·¹Ÿl_block_by‹s_couÁ
, &
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

180 &
fuÎ_šşusive_blocks_by‹s_couÁ
);

182 
EXPECT_EQ
(
fœ¡_·¹Ÿl_block_by‹s_couÁ
,

183 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
]

184 .
ex³ùed_fœ¡_·¹Ÿl_block_by‹s_couÁ
);

185 
EXPECT_EQ
(
Ï¡_·¹Ÿl_block_by‹s_couÁ
,

186 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
]

187 .
ex³ùed_Ï¡_·¹Ÿl_block_by‹s_couÁ
);

188 
EXPECT_EQ
(
fuÎ_šşusive_blocks_by‹s_couÁ
,

189 
¿nge_to_blocks_‹¡_–em’ts
[
‹¡_idx
]

190 .
ex³ùed_fuÎ_šşusive_blocks_by‹s_couÁ
);

	@platform/storage/utils/random_access_storage.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_UTILS_RANDOM_ACCESS_STORAGE_H_


20 
	#ASYLO_PLATFORM_STORAGE_UTILS_RANDOM_ACCESS_STORAGE_H_


	)

22 
	~<sys/ty³s.h
>

24 
	~<c¡ddef
>

26 
	~"asylo/ut/asylo_maüos.h
"

27 
	~"asylo/ut/¡©us.h
"

28 
	~"asylo/ut/¡©usÜ.h
"

30 
Çme¥aû
 
	gasylo
 {

36 şas 
	cRªdomAcûssStÜage
 {

37 
	gpublic
:

38 
vœtu®
 ~
RªdomAcûssStÜage
() = ;

42 
vœtu®
 
	gStusOr
<
	gsize_t
> 
Size
() const = 0;

45 
vœtu®
 
ASYLO_MUST_USE_RESULT
 
Stus
 
R—d
(*
bufãr
, 
off_t
 
off£t
,

46 
size_t
 
size
) = 0;

51 
vœtu®
 
ASYLO_MUST_USE_RESULT
 
Stus
 
Wr™e
(cÚ¡ *
bufãr
, 
off_t
 
off£t
,

52 
size_t
 
size
) = 0;

59 
vœtu®
 
ASYLO_MUST_USE_RESULT
 
Stus
 
Sync
() = 0;

64 
vœtu®
 
ASYLO_MUST_USE_RESULT
 
Stus
 
Trunÿ‹
(
size_t
 
size
) = 0;

	@platform/storage/utils/record_store.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_UTILS_RECORD_STORE_H_


20 
	#ASYLO_PLATFORM_STORAGE_UTILS_RECORD_STORE_H_


	)

22 
	~<®gÜ™hm
>

23 
	~<™”©Ü
>

24 
	~<li¡
>

25 
	~<ty³_Œa™s
>

27 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/¡Üage/uts/¿ndom_acûss_¡Üage.h
"

30 
	~"asylo/ut/asylo_maüos.h
"

31 
	~"asylo/ut/¡©us.h
"

32 
	~"asylo/ut/¡©us_maüos.h
"

33 
	~"asylo/ut/¡©usÜ.h
"

35 
Çme¥aû
 
	gasylo
 {

55 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

56 şas 
	cRecÜdStÜe
 {

57 
	gpublic
:

58 
usšg
 
v®ue_ty³
 = 
T
;

61 
¡©ic_as£¹
(
¡d
::
is_ŒivŸÎy_cİy_assigÇbË
<
T
>::
v®ue
,

68 
RecÜdStÜe
(
size_t
 
ÿ·c™y
, 
RªdomAcûssStÜage
 *
io
)

69 : 
ÿ·c™y_
(
¡d
::
max
<
size_t
>(
ÿ·c™y
, 1)), 
couÁ_
(0), 
io_
(
io
) {}

71 
RecÜdStÜe
(cÚ¡ RecÜdStÜe<
T
> &èğ
d–‘e
;

73 
RecÜdStÜe
(RecÜdStÜe<
T
> &&) = ;

75 
	gRecÜdStÜe
 &
	gİ”©Ü
=(cÚ¡ 
RecÜdStÜe
<
T
> &èğ
d–‘e
;

77 
	gRecÜdStÜe
 &
	gİ”©Ü
=(
RecÜdStÜe
<
T
> &&) = ;

80 ~
RecÜdStÜe
() {

81 
Stus
 
	g¡©us
 = 
Flush
();

82 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< "Could‚Ù flush cache: " << 
	g¡©us
;

83 
	g¡©us
 = 
io_
->
Sync
();

84 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< "Could‚Ù synchrÚizfe: " << 
	g¡©us
;

89 
ASYLO_MUST_USE_RESULT
 
Stus
 
Flush
() {

90 autØ
	g™
 = 
ÿche_
.
begš
(); iˆ!ğÿche_.
’d
(); it++) {

91 
ASYLO_RETURN_IF_ERROR
(
Comm™
(
™
));

93 
ASYLO_RETURN_IF_ERROR
(
io_
->
Sync
());

94  
	gStus
::
OkStus
();

102 
ASYLO_MUST_USE_RESULT
 
Stus
 
R—d
(
off_t
 
off£t
, 
T
 *
™em
) {

103 autØ
	g™
 = 
šdex_
.
fšd
(
off£t
);

104 ià(
	g™
 !ğ
šdex_
.
’d
()) {

105 
MoveToFrÚt
(
™
->
£cÚd
);

107 ià(
	gcouÁ_
 < 
	gÿ·c™y_
) {

108 
	gÿche_
.
em¶aû_äÚt
();

109 
	gcouÁ_
++;

111 
ASYLO_RETURN_IF_ERROR
(
Eviù
());

113 autØ
	gfœ¡
 = 
ÿche_
.
begš
();

114 
Stus
 
	g¡©us
 = 
io_
->
R—d
(&
fœ¡
->
v®ue
, 
off£t
, (
T
));

115 ià(!
	g¡©us
.
ok
()) {

119 
	gÿche_
.
pİ_äÚt
();

120 
	gcouÁ_
--;

121  
	g¡©us
;

123 
	gfœ¡
->
	goff£t
 = 
off£t
;

124 
	gfœ¡
->
	gdœty
 = 
çl£
;

125 
	gšdex_
[
off£t
] = 
fœ¡
;

127 *
	g™em
 = 
ÿche_
.
begš
()->
v®ue
;

128  
	gStus
::
OkStus
();

137 
ASYLO_MUST_USE_RESULT
 
Stus
 
Wr™e
(
off_t
 
off£t
, cÚ¡ 
T
 &
™em
) {

138 autØ
	g™
 = 
šdex_
.
fšd
(
off£t
);

139 ià(
	g™
 !ğ
šdex_
.
’d
()) {

140 
MoveToFrÚt
(
™
->
£cÚd
);

142 ià(
	gcouÁ_
 < 
	gÿ·c™y_
) {

145 
	gÿche_
.
em¶aû_äÚt
();

146 
	gcouÁ_
++;

148 
ASYLO_RETURN_IF_ERROR
(
Eviù
());

150 
	gÿche_
.
begš
()->
	goff£t
 = 
off£t
;

151 
	gšdex_
[
off£t
] = 
ÿche_
.
begš
();

153 autØ
	gfœ¡
 = 
ÿche_
.
begš
();

154 
	gfœ¡
->
	gv®ue
 = 
™em
;

155 
	gfœ¡
->
	gdœty
 = 
Œue
;

156  
	gStus
::
OkStus
();

161 
boŞ
 
IsCached
(
off_t
 
off£t
ècÚ¡ {  
	gšdex_
.
cÚšs
(offset); }

163 
	g´iv©e
:

164 
	sCacheEÁry
 {

165 
off_t
 
off£t
;

166 
T
 
	gv®ue
;

167 
boŞ
 
	gdœty
;

170 
usšg
 
	gNodeRef
 = 
ty³Çme
 
¡d
::
li¡
<
CacheEÁry
>::
™”©Ü
;

171 
usšg
 
	gCÚ¡NodeRef
 = 
ty³Çme
 
¡d
::
li¡
<
CacheEÁry
>::
cÚ¡_™”©Ü
;

174 
ASYLO_MUST_USE_RESULT
 
Stus
 
Comm™
(
NodeRef
 
’Œy
) {

175 
ASYLO_RETURN_IF_ERROR
(
io_
->
Wr™e
(&
’Œy
->
v®ue
,ƒÁry->
off£t
, (
T
)));

176 
	g’Œy
->
	gdœty
 = 
çl£
;

177  
	gStus
::
OkStus
();

182 
ASYLO_MUST_USE_RESULT
 
Stus
 
Eviù
() {

183 autØ
	gÏ¡
 = 
¡d
::
´ev
(
ÿche_
.
’d
());

184 
ASYLO_RETURN_IF_ERROR
(
Comm™
(
Ï¡
));

185 
	gšdex_
.
”a£
(
Ï¡
->
off£t
);

186 
MoveToFrÚt
(
Ï¡
);

187  
	gStus
::
OkStus
();

191 
MoveToFrÚt
(
CÚ¡NodeRef
 
node
) {

192 ià(
	gnode
 !ğ
ÿche_
.
begš
()) {

195 
ÿche_
.
¥liû
(ÿche_.
begš
(), cache_, 
node
);

199 
size_t
 
	gÿ·c™y_
;

205 
size_t
 
	gcouÁ_
;

207 
RªdomAcûssStÜage
 *
	gio_
;

214 
	g¡d
::
li¡
<
CacheEÁry
> 
ÿche_
;

216 
	gab¦
::
æ©_hash_m­
<
off_t
, 
	gCÚ¡NodeRef
> 
	gšdex_
;

	@platform/storage/utils/record_store_test.cc

20 
	~<c¡ddef
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

25 
	~"asylo/¶©fÜm/¡Üage/uts/»cÜd_¡Üe.h
"

26 
	~"asylo/¶©fÜm/¡Üage/uts/‹¡_uts.h
"

27 
	~"asylo/¶©fÜm/¡Üage/uts/uÁru¡ed_fe.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

35 
TEST
(
RecÜdStÜeTe¡
, 
Wr™eR—d
) {

36 
	gfd
 = 
C»©eEm±yTempFeOrD›
("write_read.tmp");

37 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

38 
UÁru¡edFe
 
fe
(
fd
);

40 
cÚ¡ex´
 
size_t
 
	gkC­ac™y
 = 16;

41 
cÚ¡ex´
 
size_t
 
	gkRecÜdCouÁ
 = 256;

42 
	gRecÜdStÜe
<
	gsize_t
> 
»cÜds
(
kC­ac™y
, &
fe
);

44 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

45 
size_t
 
	g»cÜd
;

46 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

47 
ASYLO_EXPECT_OK
(
»cÜds
.
Wr™e
(
off£t
, 
i
));

48 
ASYLO_EXPECT_OK
(
»cÜds
.
R—d
(
off£t
, &
»cÜd
));

49 
EXPECT_EQ
(
»cÜd
, 
i
);

52 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

53 
size_t
 
	g»cÜd
;

54 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

55 
ASYLO_EXPECT_OK
(
»cÜds
.
R—d
(
off£t
, &
»cÜd
));

56 
EXPECT_EQ
(
»cÜd
, 
i
);

61 
TEST
(
RecÜdStÜeTe¡
, 
EviùiÚ
) {

62 
	gfd
 = 
C»©eEm±yTempFeOrD›
("eviction.tmp");

63 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

64 
UÁru¡edFe
 
fe
(
fd
);

66 
cÚ¡ex´
 
size_t
 
	gkC­ac™y
 = 16;

67 
cÚ¡ex´
 
size_t
 
	gkRecÜdCouÁ
 = 256;

69 
	gRecÜdStÜe
<
	gsize_t
> 
wr™e_¡Üe
(
kC­ac™y
, &
fe
);

70 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

71 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

72 
ASYLO_EXPECT_OK
(
wr™e_¡Üe
.
Wr™e
(
off£t
, 
i
));

73 
size_t
 
	gfœ¡_ÿched
 = 
i
 >ğ
kC­ac™y
 ? i - kCapacity + 1 : 0;

74 
size_t
 
	gÏ¡_ÿched
 = 
i
;

75 
size_t
 
	gj
 = 0; j < 
	gkRecÜdCouÁ
; j++) {

76 
EXPECT_EQ
(
wr™e_¡Üe
.
IsCached
(
j
 * (
size_t
)),

77 
j
 >ğ
fœ¡_ÿched
 && j <ğ
Ï¡_ÿched
);

80 
ASYLO_ASSERT_OK
(
wr™e_¡Üe
.
Flush
());

82 
	gRecÜdStÜe
<
	gsize_t
> 
»ad_¡Üe
(
kC­ac™y
, &
fe
);

83 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

84 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

85 
size_t
 
	g»cÜd
;

86 
ASYLO_EXPECT_OK
(
»ad_¡Üe
.
R—d
(
off£t
, &
»cÜd
));

87 
EXPECT_TRUE
(
»ad_¡Üe
.
IsCached
(
off£t
));

88 
size_t
 
	gfœ¡_ÿched
 = 
i
 >ğ
kC­ac™y
 ? i - kCapacity + 1 : 0;

89 
size_t
 
	gÏ¡_ÿched
 = 
i
;

90 
size_t
 
	gj
 = 0; j < 
	gkRecÜdCouÁ
; j++) {

91 
EXPECT_EQ
(
»ad_¡Üe
.
IsCached
(
j
 * (
size_t
)),

92 
j
 >ğ
fœ¡_ÿched
 && j <ğ
Ï¡_ÿched
);

98 
TEST
(
RecÜdStÜeTe¡
, 
Flush
) {

99 
	gfd
 = 
C»©eEm±yTempFeOrD›
("flush.tmp");

100 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

101 
UÁru¡edFe
 
fe
(
fd
);

103 
cÚ¡ex´
 
size_t
 
	gkC­ac™y
 = 256;

104 
cÚ¡ex´
 
size_t
 
	gkRecÜdCouÁ
 = 256;

107 
	gRecÜdStÜe
<
	gsize_t
> 
»cÜds
(
kC­ac™y
, &
fe
);

108 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

109 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

110 
ASYLO_EXPECT_OK
(
»cÜds
.
Wr™e
(
off£t
, 
i
));

114 
EXPECT_THAT
(
fe
.
Size
(), 
IsOkAndHŞds
(
kRecÜdCouÁ
 * (
size_t
)));

115 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

116 
size_t
 
	g»cÜd
;

117 
ASYLO_EXPECT_OK
(
fe
.
R—d
(&
»cÜd
, 
i
 * (
size_t
), (size_t)));

118 
EXPECT_EQ
(
»cÜd
, 
i
);

	@platform/storage/utils/record_store_test.cc

20 
	~<c¡ddef
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

25 
	~"asylo/¶©fÜm/¡Üage/uts/»cÜd_¡Üe.h
"

26 
	~"asylo/¶©fÜm/¡Üage/uts/‹¡_uts.h
"

27 
	~"asylo/¶©fÜm/¡Üage/uts/uÁru¡ed_fe.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

35 
TEST
(
RecÜdStÜeTe¡
, 
Wr™eR—d
) {

36 
	gfd
 = 
C»©eEm±yTempFeOrD›
("write_read.tmp");

37 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

38 
UÁru¡edFe
 
fe
(
fd
);

40 
cÚ¡ex´
 
size_t
 
	gkC­ac™y
 = 16;

41 
cÚ¡ex´
 
size_t
 
	gkRecÜdCouÁ
 = 256;

42 
	gRecÜdStÜe
<
	gsize_t
> 
»cÜds
(
kC­ac™y
, &
fe
);

44 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

45 
size_t
 
	g»cÜd
;

46 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

47 
ASYLO_EXPECT_OK
(
»cÜds
.
Wr™e
(
off£t
, 
i
));

48 
ASYLO_EXPECT_OK
(
»cÜds
.
R—d
(
off£t
, &
»cÜd
));

49 
EXPECT_EQ
(
»cÜd
, 
i
);

52 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

53 
size_t
 
	g»cÜd
;

54 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

55 
ASYLO_EXPECT_OK
(
»cÜds
.
R—d
(
off£t
, &
»cÜd
));

56 
EXPECT_EQ
(
»cÜd
, 
i
);

61 
TEST
(
RecÜdStÜeTe¡
, 
EviùiÚ
) {

62 
	gfd
 = 
C»©eEm±yTempFeOrD›
("eviction.tmp");

63 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

64 
UÁru¡edFe
 
fe
(
fd
);

66 
cÚ¡ex´
 
size_t
 
	gkC­ac™y
 = 16;

67 
cÚ¡ex´
 
size_t
 
	gkRecÜdCouÁ
 = 256;

69 
	gRecÜdStÜe
<
	gsize_t
> 
wr™e_¡Üe
(
kC­ac™y
, &
fe
);

70 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

71 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

72 
ASYLO_EXPECT_OK
(
wr™e_¡Üe
.
Wr™e
(
off£t
, 
i
));

73 
size_t
 
	gfœ¡_ÿched
 = 
i
 >ğ
kC­ac™y
 ? i - kCapacity + 1 : 0;

74 
size_t
 
	gÏ¡_ÿched
 = 
i
;

75 
size_t
 
	gj
 = 0; j < 
	gkRecÜdCouÁ
; j++) {

76 
EXPECT_EQ
(
wr™e_¡Üe
.
IsCached
(
j
 * (
size_t
)),

77 
j
 >ğ
fœ¡_ÿched
 && j <ğ
Ï¡_ÿched
);

80 
ASYLO_ASSERT_OK
(
wr™e_¡Üe
.
Flush
());

82 
	gRecÜdStÜe
<
	gsize_t
> 
»ad_¡Üe
(
kC­ac™y
, &
fe
);

83 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

84 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

85 
size_t
 
	g»cÜd
;

86 
ASYLO_EXPECT_OK
(
»ad_¡Üe
.
R—d
(
off£t
, &
»cÜd
));

87 
EXPECT_TRUE
(
»ad_¡Üe
.
IsCached
(
off£t
));

88 
size_t
 
	gfœ¡_ÿched
 = 
i
 >ğ
kC­ac™y
 ? i - kCapacity + 1 : 0;

89 
size_t
 
	gÏ¡_ÿched
 = 
i
;

90 
size_t
 
	gj
 = 0; j < 
	gkRecÜdCouÁ
; j++) {

91 
EXPECT_EQ
(
»ad_¡Üe
.
IsCached
(
j
 * (
size_t
)),

92 
j
 >ğ
fœ¡_ÿched
 && j <ğ
Ï¡_ÿched
);

98 
TEST
(
RecÜdStÜeTe¡
, 
Flush
) {

99 
	gfd
 = 
C»©eEm±yTempFeOrD›
("flush.tmp");

100 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

101 
UÁru¡edFe
 
fe
(
fd
);

103 
cÚ¡ex´
 
size_t
 
	gkC­ac™y
 = 256;

104 
cÚ¡ex´
 
size_t
 
	gkRecÜdCouÁ
 = 256;

107 
	gRecÜdStÜe
<
	gsize_t
> 
»cÜds
(
kC­ac™y
, &
fe
);

108 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

109 
off_t
 
	goff£t
 = 
i
 * (
size_t
);

110 
ASYLO_EXPECT_OK
(
»cÜds
.
Wr™e
(
off£t
, 
i
));

114 
EXPECT_THAT
(
fe
.
Size
(), 
IsOkAndHŞds
(
kRecÜdCouÁ
 * (
size_t
)));

115 
size_t
 
	gi
 = 0; i < 
	gkRecÜdCouÁ
; i++) {

116 
size_t
 
	g»cÜd
;

117 
ASYLO_EXPECT_OK
(
fe
.
R—d
(&
»cÜd
, 
i
 * (
size_t
), (size_t)));

118 
EXPECT_EQ
(
»cÜd
, 
i
);

	@platform/storage/utils/test_utils.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<sys/¡©.h
>

22 
	~<sys/ty³s.h
>

23 
	~<uni¡d.h
>

25 
	~<c¡ršg
>

26 
	~<¡ršg
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/‹¡/ut/‹¡_æags.h
"

32 
Çme¥aû
 
	gasylo
 {

34 
C»©eEm±yTempFeOrD›
(
ab¦
::
¡ršg_v›w
 
ba£Çme
) {

35 
¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
ba£Çme
);

36 
	g”r
 = 
uÆšk
(
·th
.
c_¡r
());

37 
CHECK
(
”r
 =ğ0 || 
”ºo
 =ğ
ENOENT
è<< 
¡»¼Ü
(errno);

38 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_CREAT
 | 
O_EXCL
 | 
O_RDWR
, 
S_IRUSR
 | 
S_IWUSR
);

39 
CHECK_NE
(
fd
, -1è<< "Could‚Ù c»©‹mpÜ¬y f" << 
	g·th
 << ": "

40 << 
¡»¼Ü
(
”ºo
);

41  
	gfd
;

	@platform/storage/utils/test_utils.cc

19 
	~<”ºo.h
>

20 
	~<fú.h
>

21 
	~<sys/¡©.h
>

22 
	~<sys/ty³s.h
>

23 
	~<uni¡d.h
>

25 
	~<c¡ršg
>

26 
	~<¡ršg
>

28 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/‹¡/ut/‹¡_æags.h
"

32 
Çme¥aû
 
	gasylo
 {

34 
C»©eEm±yTempFeOrD›
(
ab¦
::
¡ršg_v›w
 
ba£Çme
) {

35 
¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/", 
ba£Çme
);

36 
	g”r
 = 
uÆšk
(
·th
.
c_¡r
());

37 
CHECK
(
”r
 =ğ0 || 
”ºo
 =ğ
ENOENT
è<< 
¡»¼Ü
(errno);

38 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_CREAT
 | 
O_EXCL
 | 
O_RDWR
, 
S_IRUSR
 | 
S_IWUSR
);

39 
CHECK_NE
(
fd
, -1è<< "Could‚Ù c»©‹mpÜ¬y f" << 
	g·th
 << ": "

40 << 
¡»¼Ü
(
”ºo
);

41  
	gfd
;

	@platform/storage/utils/test_utils.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_UTILS_TEST_UTILS_H_


20 
	#ASYLO_PLATFORM_STORAGE_UTILS_TEST_UTILS_H_


	)

22 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

25 
Çme¥aû
 
	gasylo
 {

28 
C»©eEm±yTempFeOrD›
(
ab¦
::
¡ršg_v›w
 
ba£Çme
);

	@platform/storage/utils/untrusted_file.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/uÁru¡ed_fe.h
"

21 
	~<sys/ty³s.h
>

22 
	~<uni¡d.h
>

24 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gUÁru¡edFe
::
UÁru¡edFe
(
fd
è: 
fd_
(fd) {}

30 
UÁru¡edFe
::~UntrustedFile() {

31 
Stus
 
»suÉ
 = 
Sync
();

32 ià(!
	g»suÉ
.
ok
()) {

33 
LOG
(
ERROR
) << "Unexpected failure in Sync() when closing‡n UntrustedFile: "

34 << 
	g»suÉ
;

38 
Stus
 
	gUÁru¡edFe
::
R—d
(*
bufãr
, 
off_t
 
off£t
, 
size_t
 
size
) {

39 
off_t
 
	g»suÉ
 = 
l£ek
(
fd_
, 
off£t
, 
SEEK_SET
);

40 ià(
	g»suÉ
 == -1) {

41  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

45 
size_t
 
	gcouÁ
 = 0;

46 
	gcouÁ
 < 
	gsize
) {

47 
ssize_t
 
	g»suÉ
 =

48 
»ad
(
fd_
, 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
bufãr
è+ 
couÁ
, 
size
 - count);

49 ià(
	g»suÉ
 == 0) {

50  
Stus
{
”rÜ
::
NOT_FOUND
, "read() failed in UntrustedFile::Read()"};

53 ià(
	g»suÉ
 < 0) {

54  
	gStus
{
	g¡©ic_ÿ¡
<
	g”rÜ
::
PosixE¼Ü
>(
”ºo
),

58 
	gcouÁ
 +ğ
»suÉ
;

61  
	gStus
::
OkStus
();

64 
	gStusOr
<
	gsize_t
> 
	gUÁru¡edFe
::
Size
() const {

65 
off_t
 
»suÉ
 = 
l£ek
(
fd_
, 0, 
SEEK_END
);

66 ià(
	g»suÉ
 == -1) {

67  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

70  
	g»suÉ
;

73 
Stus
 
	gUÁru¡edFe
::
Sync
() {

74 ià(
fsync
(
fd_
) != 0) {

75  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

78  
	gStus
::
OkStus
();

81 
Stus
 
	gUÁru¡edFe
::
Wr™e
(cÚ¡ *
bufãr
, 
off_t
 
off£t
, 
size_t
 
size
) {

82 
off_t
 
	g»suÉ
 = 
l£ek
(
fd_
, 
off£t
, 
SEEK_SET
);

83 ià(
	g»suÉ
 == -1) {

84  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

88 ià(
	g»suÉ
 < 
	goff£t
) {

89 ià(
árunÿ‹
(
fd_
, 
off£t
) != 0) {

90  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

93 
off_t
 
	g»suÉ
 = 
l£ek
(
fd_
, 
off£t
, 
SEEK_SET
);

94 ià(
	g»suÉ
 == -1) {

95  
Stus
{

96 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

101 
size_t
 
	gcouÁ
 = 0;

102 
	gcouÁ
 < 
	gsize
) {

103 
ssize_t
 
	g»suÉ
 = 
wr™e
(

104 
fd_
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
bufãr
è+ 
couÁ
, 
size
 - count);

106 ià(
	g»suÉ
 == 0) {

107  
Stus
{
”rÜ
::
RESOURCE_EXHAUSTED
,

111 ià(
	g»suÉ
 < 0) {

112  
	gStus
{
	g¡©ic_ÿ¡
<
	g”rÜ
::
PosixE¼Ü
>(
”ºo
),

115 
	gcouÁ
 +ğ
»suÉ
;

118  
	gStus
::
OkStus
();

121 
Stus
 
	gUÁru¡edFe
::
Trunÿ‹
(
size_t
 
size
) {

122 ià(
árunÿ‹
(
fd_
, 
size
) != 0) {

123  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

127  
	gStus
::
OkStus
();

	@platform/storage/utils/untrusted_file.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/uÁru¡ed_fe.h
"

21 
	~<sys/ty³s.h
>

22 
	~<uni¡d.h
>

24 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gUÁru¡edFe
::
UÁru¡edFe
(
fd
è: 
fd_
(fd) {}

30 
UÁru¡edFe
::~UntrustedFile() {

31 
Stus
 
»suÉ
 = 
Sync
();

32 ià(!
	g»suÉ
.
ok
()) {

33 
LOG
(
ERROR
) << "Unexpected failure in Sync() when closing‡n UntrustedFile: "

34 << 
	g»suÉ
;

38 
Stus
 
	gUÁru¡edFe
::
R—d
(*
bufãr
, 
off_t
 
off£t
, 
size_t
 
size
) {

39 
off_t
 
	g»suÉ
 = 
l£ek
(
fd_
, 
off£t
, 
SEEK_SET
);

40 ià(
	g»suÉ
 == -1) {

41  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

45 
size_t
 
	gcouÁ
 = 0;

46 
	gcouÁ
 < 
	gsize
) {

47 
ssize_t
 
	g»suÉ
 =

48 
»ad
(
fd_
, 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
bufãr
è+ 
couÁ
, 
size
 - count);

49 ià(
	g»suÉ
 == 0) {

50  
Stus
{
”rÜ
::
NOT_FOUND
, "read() failed in UntrustedFile::Read()"};

53 ià(
	g»suÉ
 < 0) {

54  
	gStus
{
	g¡©ic_ÿ¡
<
	g”rÜ
::
PosixE¼Ü
>(
”ºo
),

58 
	gcouÁ
 +ğ
»suÉ
;

61  
	gStus
::
OkStus
();

64 
	gStusOr
<
	gsize_t
> 
	gUÁru¡edFe
::
Size
() const {

65 
off_t
 
»suÉ
 = 
l£ek
(
fd_
, 0, 
SEEK_END
);

66 ià(
	g»suÉ
 == -1) {

67  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

70  
	g»suÉ
;

73 
Stus
 
	gUÁru¡edFe
::
Sync
() {

74 ià(
fsync
(
fd_
) != 0) {

75  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

78  
	gStus
::
OkStus
();

81 
Stus
 
	gUÁru¡edFe
::
Wr™e
(cÚ¡ *
bufãr
, 
off_t
 
off£t
, 
size_t
 
size
) {

82 
off_t
 
	g»suÉ
 = 
l£ek
(
fd_
, 
off£t
, 
SEEK_SET
);

83 ià(
	g»suÉ
 == -1) {

84  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

88 ià(
	g»suÉ
 < 
	goff£t
) {

89 ià(
árunÿ‹
(
fd_
, 
off£t
) != 0) {

90  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

93 
off_t
 
	g»suÉ
 = 
l£ek
(
fd_
, 
off£t
, 
SEEK_SET
);

94 ià(
	g»suÉ
 == -1) {

95  
Stus
{

96 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

101 
size_t
 
	gcouÁ
 = 0;

102 
	gcouÁ
 < 
	gsize
) {

103 
ssize_t
 
	g»suÉ
 = 
wr™e
(

104 
fd_
, 
»š‹½»t_ÿ¡
<cÚ¡ 
ušt8_t
 *>(
bufãr
è+ 
couÁ
, 
size
 - count);

106 ià(
	g»suÉ
 == 0) {

107  
Stus
{
”rÜ
::
RESOURCE_EXHAUSTED
,

111 ià(
	g»suÉ
 < 0) {

112  
	gStus
{
	g¡©ic_ÿ¡
<
	g”rÜ
::
PosixE¼Ü
>(
”ºo
),

115 
	gcouÁ
 +ğ
»suÉ
;

118  
	gStus
::
OkStus
();

121 
Stus
 
	gUÁru¡edFe
::
Trunÿ‹
(
size_t
 
size
) {

122 ià(
árunÿ‹
(
fd_
, 
size
) != 0) {

123  
Stus
{
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

127  
	gStus
::
OkStus
();

	@platform/storage/utils/untrusted_file.h

19 #iâdeà
ASYLO_PLATFORM_STORAGE_UTILS_UNTRUSTED_FILE_H_


20 
	#ASYLO_PLATFORM_STORAGE_UTILS_UNTRUSTED_FILE_H_


	)

22 
	~"asylo/¶©fÜm/¡Üage/uts/¿ndom_acûss_¡Üage.h
"

24 
Çme¥aû
 
	gasylo
 {

27 şas 
	cUÁru¡edFe
 : 
public
 
RªdomAcûssStÜage
 {

28 
public
:

33 
ex¶ic™
 
UÁru¡edFe
(
fd
);

35 ~
UÁru¡edFe
();

37 
	gStusOr
<
	gsize_t
> 
Size
(ècÚ¡ 
	gov”ride
;

39 
Stus
 
R—d
(*
bufãr
, 
off_t
 
off£t
, 
size_t
 
size
è
	gov”ride
;

41 
Stus
 
Wr™e
(cÚ¡ *
bufãr
, 
off_t
 
off£t
, 
size_t
 
size
è
	gov”ride
;

44 
Stus
 
Sync
(è
	gov”ride
;

46 
Stus
 
Trunÿ‹
(
size_t
 
size
è
	gov”ride
;

48 
	g´iv©e
:

49 
fd_
;

	@platform/storage/utils/untrusted_file_test.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/uÁru¡ed_fe.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

24 
	~"asylo/¶©fÜm/¡Üage/uts/‹¡_uts.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
TEST
(
UÁru¡edFeTe¡
, 
Wr™eR—d
) {

31 
	gfd
 = 
C»©eEm±yTempFeOrD›
("write_read.tmp");

32 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

34 
UÁru¡edFe
 
fe
(
fd
);

35 
EXPECT_THAT
(
fe
.
Size
(), 
IsOkAndHŞds
(0));

37 
cÚ¡ex´
 
	gkCouÁ
 = 1024;

38 
	gi
 = 0; i < 
	gkCouÁ
; i++) {

39 
ASYLO_EXPECT_OK
(
fe
.
Wr™e
(&
i
, i * (), ()));

42 
ASYLO_EXPECT_OK
(
fe
.
Sync
());

44 
	gi
 = 0; i < 
	gkCouÁ
; i++) {

45 
	g»cÜd
;

46 
ASYLO_EXPECT_OK
(
fe
.
R—d
(&
»cÜd
, 
i
 * (), ()));

47 
EXPECT_EQ
(
»cÜd
, 
i
);

50 
EXPECT_EQ
(
fe
.
Size
().
V®ueOrD›
(), 
kCouÁ
 * ());

53 
TEST
(
UÁru¡edFeTe¡
, 
Wr™eHŞes
) {

54 
	gfd
 = 
C»©eEm±yTempFeOrD›
("write_holes.tmp");

55 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

57 
UÁru¡edFe
 
fe
(
fd
);

58 
EXPECT_EQ
(
fe
.
Size
().
V®ueOrD›
(), 0);

59 
cÚ¡ex´
 
	gkCouÁ
 = 1024;

60 
cÚ¡ex´
 
	gkBlockSize
 = 256;

63 
	gi
 = 0; i < 
	gkCouÁ
; i++) {

64 
ušt8_t
 
	gch
 = 
i
 % 256;

65 
ASYLO_EXPECT_OK
(
fe
.
Wr™e
(&
ch
, 
i
 * 
kBlockSize
, (
ušt8_t
)));

68 
	gi
 = 0; i < 
	gkCouÁ
 - 1; i++) {

69 
ušt8_t
 
	gbuf
[
kBlockSize
];

71 
ASYLO_EXPECT_OK
(
fe
.
R—d
(
buf
, 
i
 * 
kBlockSize
, kBlockSize));

72 
EXPECT_EQ
(
buf
[0], 
i
 % 256);

74 
	gj
 = 1; j < 
	gkBlockSize
; j++) {

75 
EXPECT_EQ
(
buf
[
j
], 0);

	@platform/storage/utils/untrusted_file_test.cc

19 
	~"asylo/¶©fÜm/¡Üage/uts/uÁru¡ed_fe.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

24 
	~"asylo/¶©fÜm/¡Üage/uts/‹¡_uts.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
TEST
(
UÁru¡edFeTe¡
, 
Wr™eR—d
) {

31 
	gfd
 = 
C»©eEm±yTempFeOrD›
("write_read.tmp");

32 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

34 
UÁru¡edFe
 
fe
(
fd
);

35 
EXPECT_THAT
(
fe
.
Size
(), 
IsOkAndHŞds
(0));

37 
cÚ¡ex´
 
	gkCouÁ
 = 1024;

38 
	gi
 = 0; i < 
	gkCouÁ
; i++) {

39 
ASYLO_EXPECT_OK
(
fe
.
Wr™e
(&
i
, i * (), ()));

42 
ASYLO_EXPECT_OK
(
fe
.
Sync
());

44 
	gi
 = 0; i < 
	gkCouÁ
; i++) {

45 
	g»cÜd
;

46 
ASYLO_EXPECT_OK
(
fe
.
R—d
(&
»cÜd
, 
i
 * (), ()));

47 
EXPECT_EQ
(
»cÜd
, 
i
);

50 
EXPECT_EQ
(
fe
.
Size
().
V®ueOrD›
(), 
kCouÁ
 * ());

53 
TEST
(
UÁru¡edFeTe¡
, 
Wr™eHŞes
) {

54 
	gfd
 = 
C»©eEm±yTempFeOrD›
("write_holes.tmp");

55 
	gasylo
::
¶©fÜm
::
¡Üage
::
FdClo£r
 
şo£r
(
fd
);

57 
UÁru¡edFe
 
fe
(
fd
);

58 
EXPECT_EQ
(
fe
.
Size
().
V®ueOrD›
(), 0);

59 
cÚ¡ex´
 
	gkCouÁ
 = 1024;

60 
cÚ¡ex´
 
	gkBlockSize
 = 256;

63 
	gi
 = 0; i < 
	gkCouÁ
; i++) {

64 
ušt8_t
 
	gch
 = 
i
 % 256;

65 
ASYLO_EXPECT_OK
(
fe
.
Wr™e
(&
ch
, 
i
 * 
kBlockSize
, (
ušt8_t
)));

68 
	gi
 = 0; i < 
	gkCouÁ
 - 1; i++) {

69 
ušt8_t
 
	gbuf
[
kBlockSize
];

71 
ASYLO_EXPECT_OK
(
fe
.
R—d
(
buf
, 
i
 * 
kBlockSize
, kBlockSize));

72 
EXPECT_EQ
(
buf
[0], 
i
 % 256);

74 
	gj
 = 1; j < 
	gkBlockSize
; j++) {

75 
EXPECT_EQ
(
buf
[
j
], 0);

	@platform/system/cmath_test.cc

19 
	~<cm©h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/ba£/maüos.h
"

25 
	gÇme¥aû
 {

27 
	gusšg
 ::
‹¡šg
::
Eq
;

29 
TEST
(
Cm©hTe¡
, 
LÚgDoubËFunùiÚs
) {

30 
	glÚg_doubËs
[] = {

31 
¡d
::
hypÙl
(1.0, 2.0),

32 
¡d
::
sq¹l
(1.0),

34 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
lÚg_doubËs
), 
Eq
(2));

37 
TEST
(
Cm©hTe¡
, 
Tr1DoubËFunùiÚs
) {

38 
	gquo
;

39 
	gdoubËs
[] = {

40 
¡d
::
acosh
(1.0),

41 
¡d
::
asšh
(1.0),

42 
¡d
::
©ªh
(1.0),

43 
¡d
::
cb¹
(1.0),

44 
¡d
::
cİysign
(1.0, 2.0),

45 
¡d
::
”f
(1.0),

46 
¡d
::
”fc
(1.0),

47 
¡d
::
exp2
(1.0),

48 
¡d
::
expm1
(1.0),

49 
¡d
::
fdim
(1.0, 2.0),

50 
¡d
::
fma
(1.0, 2.0, 3.0),

51 
¡d
::
fmax
(1.0, 2.0),

52 
¡d
::
fmš
(1.0, 2.0),

53 
¡d
::
hypÙ
(1.0, 2.0),

54 
¡d
::
ogb
(1.0),

55 
¡d
::
lgamma
(1.0),

56 
¡d
::
log1p
(1.0),

57 
¡d
::
log2
(1.0),

58 
¡d
::
logb
(1.0),

59 
¡d
::
Çn
("NAN"),

60 
¡d
::
Ã¬byšt
(0.0),

61 
¡d
::
Ãxá”
(1.0, 
HUGE_VAL
),

62 
¡d
::
»mašd”
(1.0, 2.0),

63 
¡d
::
»mquo
(1.0, 1.0, &
quo
),

64 
¡d
::
ršt
(1.0),

65 
¡d
::
round
(1.0),

66 
¡d
::
sÿlbÊ
(1.0, 3),

67 
¡d
::
sÿlbn
(1.0, 3),

68 
¡d
::
tgamma
(1.0),

69 
¡d
::
Œunc
(1.0),

71 
	glv®ues
[] = {

72 
¡d
::
Ìšt
(1.0),

73 
¡d
::
Ìound
(1.0),

75 
	gÎv®ues
[] = {

76 
¡d
::
Îršt
(1.0),

77 
¡d
::
Îround
(1.0),

79 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
doubËs
), 
Eq
(30));

80 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
lv®ues
), 
Eq
(2));

81 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
Îv®ues
), 
Eq
(2));

84 
TEST
(
Cm©hTe¡
, 
Tr1FlßtFunùiÚs
) {

85 
	gquo
;

86 
	gæßts
[] = {

87 
¡d
::
acoshf
(1.0f),

88 
¡d
::
asšhf
(1.0f),

89 
¡d
::
©ªhf
(1.0f),

90 
¡d
::
cb¹f
(1.0f),

91 
¡d
::
cİysignf
(1.0f, 2.0f),

92 
¡d
::
”ff
(1.0f),

93 
¡d
::
”fcf
(1.0f),

94 
¡d
::
exp2f
(1.0f),

95 
¡d
::
expm1f
(1.0f),

96 
¡d
::
fdimf
(1.0f, 2.0f),

97 
¡d
::
fmaf
(1.0f, 2.0f, 3.0f),

98 
¡d
::
fmaxf
(1.0f, 2.0f),

99 
¡d
::
fmšf
(1.0f, 2.0f),

100 
¡d
::
hypÙf
(1.0f, 2.0f),

101 
¡d
::
ogbf
(1.0f),

102 
¡d
::
lgammaf
(1.0f),

103 
¡d
::
log1pf
(1.0f),

104 
¡d
::
log2f
(1.0f),

105 
¡d
::
logbf
(1.0f),

106 
¡d
::
Çnf
("NAN"),

107 
¡d
::
Ã¬byštf
(0.2f),

108 
¡d
::
Ãxá”f
(1.0f, 
HUGE_VALF
),

109 
¡d
::
»mašd”f
(1.0f, 2.0f),

110 
¡d
::
»mquof
(1.0f, 1.0f, &
quo
),

111 
¡d
::
rštf
(1.0f),

112 
¡d
::
roundf
(1.0f),

113 
¡d
::
sÿlbÊf
(1.0f, 3),

114 
¡d
::
sÿlbnf
(1.0f, 3),

115 
¡d
::
tgammaf
(1.0f),

116 
¡d
::
Œuncf
(1.0f),

118 
	glv®ues
[] = {

119 
¡d
::
Ìštf
(1.0f),

120 
¡d
::
Ìoundf
(1.0f),

122 
	gÎv®ues
[] = {

123 
¡d
::
Îrštf
(1.0f),

124 
¡d
::
Îroundf
(1.0f),

126 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
æßts
), 
Eq
(30));

127 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
lv®ues
), 
Eq
(2));

128 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
Îv®ues
), 
Eq
(2));

	@platform/system/cmath_test.cc

19 
	~<cm©h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/ba£/maüos.h
"

25 
	gÇme¥aû
 {

27 
	gusšg
 ::
‹¡šg
::
Eq
;

29 
TEST
(
Cm©hTe¡
, 
LÚgDoubËFunùiÚs
) {

30 
	glÚg_doubËs
[] = {

31 
¡d
::
hypÙl
(1.0, 2.0),

32 
¡d
::
sq¹l
(1.0),

34 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
lÚg_doubËs
), 
Eq
(2));

37 
TEST
(
Cm©hTe¡
, 
Tr1DoubËFunùiÚs
) {

38 
	gquo
;

39 
	gdoubËs
[] = {

40 
¡d
::
acosh
(1.0),

41 
¡d
::
asšh
(1.0),

42 
¡d
::
©ªh
(1.0),

43 
¡d
::
cb¹
(1.0),

44 
¡d
::
cİysign
(1.0, 2.0),

45 
¡d
::
”f
(1.0),

46 
¡d
::
”fc
(1.0),

47 
¡d
::
exp2
(1.0),

48 
¡d
::
expm1
(1.0),

49 
¡d
::
fdim
(1.0, 2.0),

50 
¡d
::
fma
(1.0, 2.0, 3.0),

51 
¡d
::
fmax
(1.0, 2.0),

52 
¡d
::
fmš
(1.0, 2.0),

53 
¡d
::
hypÙ
(1.0, 2.0),

54 
¡d
::
ogb
(1.0),

55 
¡d
::
lgamma
(1.0),

56 
¡d
::
log1p
(1.0),

57 
¡d
::
log2
(1.0),

58 
¡d
::
logb
(1.0),

59 
¡d
::
Çn
("NAN"),

60 
¡d
::
Ã¬byšt
(0.0),

61 
¡d
::
Ãxá”
(1.0, 
HUGE_VAL
),

62 
¡d
::
»mašd”
(1.0, 2.0),

63 
¡d
::
»mquo
(1.0, 1.0, &
quo
),

64 
¡d
::
ršt
(1.0),

65 
¡d
::
round
(1.0),

66 
¡d
::
sÿlbÊ
(1.0, 3),

67 
¡d
::
sÿlbn
(1.0, 3),

68 
¡d
::
tgamma
(1.0),

69 
¡d
::
Œunc
(1.0),

71 
	glv®ues
[] = {

72 
¡d
::
Ìšt
(1.0),

73 
¡d
::
Ìound
(1.0),

75 
	gÎv®ues
[] = {

76 
¡d
::
Îršt
(1.0),

77 
¡d
::
Îround
(1.0),

79 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
doubËs
), 
Eq
(30));

80 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
lv®ues
), 
Eq
(2));

81 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
Îv®ues
), 
Eq
(2));

84 
TEST
(
Cm©hTe¡
, 
Tr1FlßtFunùiÚs
) {

85 
	gquo
;

86 
	gæßts
[] = {

87 
¡d
::
acoshf
(1.0f),

88 
¡d
::
asšhf
(1.0f),

89 
¡d
::
©ªhf
(1.0f),

90 
¡d
::
cb¹f
(1.0f),

91 
¡d
::
cİysignf
(1.0f, 2.0f),

92 
¡d
::
”ff
(1.0f),

93 
¡d
::
”fcf
(1.0f),

94 
¡d
::
exp2f
(1.0f),

95 
¡d
::
expm1f
(1.0f),

96 
¡d
::
fdimf
(1.0f, 2.0f),

97 
¡d
::
fmaf
(1.0f, 2.0f, 3.0f),

98 
¡d
::
fmaxf
(1.0f, 2.0f),

99 
¡d
::
fmšf
(1.0f, 2.0f),

100 
¡d
::
hypÙf
(1.0f, 2.0f),

101 
¡d
::
ogbf
(1.0f),

102 
¡d
::
lgammaf
(1.0f),

103 
¡d
::
log1pf
(1.0f),

104 
¡d
::
log2f
(1.0f),

105 
¡d
::
logbf
(1.0f),

106 
¡d
::
Çnf
("NAN"),

107 
¡d
::
Ã¬byštf
(0.2f),

108 
¡d
::
Ãxá”f
(1.0f, 
HUGE_VALF
),

109 
¡d
::
»mašd”f
(1.0f, 2.0f),

110 
¡d
::
»mquof
(1.0f, 1.0f, &
quo
),

111 
¡d
::
rštf
(1.0f),

112 
¡d
::
roundf
(1.0f),

113 
¡d
::
sÿlbÊf
(1.0f, 3),

114 
¡d
::
sÿlbnf
(1.0f, 3),

115 
¡d
::
tgammaf
(1.0f),

116 
¡d
::
Œuncf
(1.0f),

118 
	glv®ues
[] = {

119 
¡d
::
Ìštf
(1.0f),

120 
¡d
::
Ìoundf
(1.0f),

122 
	gÎv®ues
[] = {

123 
¡d
::
Îrštf
(1.0f),

124 
¡d
::
Îroundf
(1.0f),

126 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
æßts
), 
Eq
(30));

127 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
lv®ues
), 
Eq
(2));

128 
EXPECT_THAT
(
ABSL_ARRAYSIZE
(
Îv®ues
), 
Eq
(2));

	@platform/system/include/arpa/nameser.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_INCLUDE_ARPA_NAMESER_H_


20 
	#ASYLO_PLATFORM_SYSTEM_INCLUDE_ARPA_NAMESER_H_


	)

22 
	#NS_HFIXEDSZ
 12

23 
	#NS_MAXCDNAME
 255

24 
	#NS_MAXLABEL
 63

25 
	#NS_QFIXEDSZ
 4

26 
	#NS_RRFIXEDSZ
 10

27 
	#NS_DEFAULTPORT
 53

28 
	#NS_PACKETSZ
 512

29 
	#NS_CMPRSFLGS
 0xc0

30 
	#NS_INADDRSZ
 4

31 
	#NS_IN6ADDRSZ
 16

32 

	)

34 
	e__ns_şass
 {

35 
	mns_c_šv®id
 = 0,

36 
	mns_c_š
 = 1,

37 } 
	tns_şass
;

40 
	e__ns_ty³
 {

41 
	mns_t_šv®id
 = 0,

42 
	mns_t_a
 = 1,

43 
	mns_t_ns
 = 2,

44 
	mns_t_úame
 = 5,

46 
	mns_t_±r
 = 12,

47 
	mns_t_mx
 = 15,

48 
	mns_t_txt
 = 16,

50 
	mns_t_¯¯
 = 28,

52 
	mns_t_max
 = 65536

53 } 
	tns_ty³
;

56 
	e__ns_İcode
 {

57 
	mns_o_qu”y
 = 0,

58 } 
	tns_İcode
;

61 
	e__ns_rcode
 {

62 
	mns_r_nÛ¼Ü
 = 0,

63 
	mns_r_fÜm”r
 = 1,

64 
	mns_r_£rvç
 = 2,

65 
	mns_r_nxdomaš
 = 3,

66 
	mns_r_nÙim¶
 = 4,

67 
	mns_r_»fu£d
 = 5,

68 } 
	tns_rcode
;

70 
	~<¬·/Çme£r_com·t.h
>

	@platform/system/include/arpa/nameser_compat.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_INCLUDE_ARPA_NAMESER_COMPAT_H_


20 
	#ASYLO_PLATFORM_SYSTEM_INCLUDE_ARPA_NAMESER_COMPAT_H_


	)

22 
	#HFIXEDSZ
 
NS_HFIXEDSZ


	)

23 
	#MAXCDNAME
 
NS_MAXCDNAME


	)

24 
	#MAXLABEL
 
NS_MAXLABEL


	)

25 
	#QFIXEDSZ
 
NS_QFIXEDSZ


	)

26 
	#RRFIXEDSZ
 
NS_RRFIXEDSZ


	)

28 
	#QUERY
 
ns_o_qu”y


	)

30 
	#NOERROR
 
ns_r_nÛ¼Ü


	)

31 
	#FORMERR
 
ns_r_fÜm”r


	)

32 
	#NXDOMAIN
 
ns_r_nxdomaš


	)

33 
	#NOTIMP
 
ns_r_nÙim¶


	)

34 
	#REFUSED
 
ns_r_»fu£d


	)

35 
	#SERVFAIL
 
ns_r_£rvç


	)

37 
	#T_A
 
ns_t_a


	)

38 
	#T_NS
 
ns_t_ns


	)

39 
	#T_CNAME
 
ns_t_úame


	)

40 
	#T_PTR
 
ns_t_±r


	)

41 
	#T_MX
 
ns_t_mx


	)

42 
	#T_TXT
 
ns_t_txt


	)

43 
	#T_AAAA
 
ns_t_¯¯


	)

45 
	#C_IN
 
ns_c_š


	)

47 
	#PACKETSZ
 
NS_PACKETSZ


	)

48 
	#NAMESERVER_PORT
 
NS_DEFAULTPORT


	)

49 
	#INDIR_MASK
 
NS_CMPRSFLGS


	)

	@platform/system/include/sys/sysmacros.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_INCLUDE_SYS_SYSMACROS_H_


20 
	#ASYLO_PLATFORM_SYSTEM_INCLUDE_SYS_SYSMACROS_H_


	)

22 
	~<sys/ty³s.h
>

25 
šlše
 
	$majÜ
(
dev_t
 
dev
) {

26  ((
dev
 >> 8) & 0xfff) | (()(dev >> 32) & ~0xfff);

27 
	}
}

30 
šlše
 
	$mšÜ
(
dev_t
 
dev
) {

31  (
dev
 & 0xff) | (()(dev >> 12) & ~0xff);

32 
	}
}

35 
šlše
 
dev_t
 
	$makedev
(
majÜ
, 
mšÜ
) {

36  ((
mšÜ
 & 0xffè| ((
majÜ
 & 0xfff) << 8) |

37 (((
ušt64_t
)(
mšÜ
 & ~0xff)) << 12) |

38 (((
ušt64_t
)(
majÜ
 & ~0xfff)) << 32));

39 
	}
}

	@platform/system_call/generate_sysno.cc

19 
	~<io¡»am
>

21 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

22 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

24 
cÚ¡ex´
 
	gkPrŞogue
[] = 
R
"(

27 #iâdeà
THIRD_PARTY_ASYLO_PLATFORM_SYSTEM_CALL_SYSNO_H_


28 
	#THIRD_PARTY_ASYLO_PLATFORM_SYSTEM_CALL_SYSNO_H_


	)

30 
Çme¥aû
 
asylo
 {

31 
Çme¥aû
 
sy¡em_ÿÎ
 {

35 
cÚ¡ex´
 
kEpogue
[] = 
R
"(

48 
	$maš
(
¬gc
, **
¬gv
) {

49 
¡d
::
cout
 << 
kPrŞogue
;

50 
i
 = 0; i <ğ
asylo
::
sy¡em_ÿÎ
::
	`La¡Sy¡emC®l
(); i++) {

51 
asylo
::
sy¡em_ÿÎ
::
Sy¡emC®lDesütÜ
 
	`sysÿÎ
(
i
);

52 ià(
sysÿÎ
.
	`is_v®id
()) {

53 
¡d
::
cout
 << 
ab¦
::
	`SŒ—mFÜm©
(" constexpr int kSYS_%s = %i;\n",

54 
sysÿÎ
.
	`Çme
(), 
i
);

57 
¡d
::
cout
 << 
kEpogue
;

59 
	}
}

	@platform/system_call/generate_sysno.cc

19 
	~<io¡»am
>

21 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

22 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

24 
cÚ¡ex´
 
	gkPrŞogue
[] = 
R
"(

27 #iâdeà
THIRD_PARTY_ASYLO_PLATFORM_SYSTEM_CALL_SYSNO_H_


28 
	#THIRD_PARTY_ASYLO_PLATFORM_SYSTEM_CALL_SYSNO_H_


	)

30 
Çme¥aû
 
asylo
 {

31 
Çme¥aû
 
sy¡em_ÿÎ
 {

35 
cÚ¡ex´
 
kEpogue
[] = 
R
"(

48 
	$maš
(
¬gc
, **
¬gv
) {

49 
¡d
::
cout
 << 
kPrŞogue
;

50 
i
 = 0; i <ğ
asylo
::
sy¡em_ÿÎ
::
	`La¡Sy¡emC®l
(); i++) {

51 
asylo
::
sy¡em_ÿÎ
::
Sy¡emC®lDesütÜ
 
	`sysÿÎ
(
i
);

52 ià(
sysÿÎ
.
	`is_v®id
()) {

53 
¡d
::
cout
 << 
ab¦
::
	`SŒ—mFÜm©
(" constexpr int kSYS_%s = %i;\n",

54 
sysÿÎ
.
	`Çme
(), 
i
);

57 
¡d
::
cout
 << 
kEpogue
;

59 
	}
}

	@platform/system_call/generate_tables.cc

19 
	~<io¡»am
>

20 
	~<m­
>

21 
	~<¡ršg
>

22 
	~<tu¶e
>

23 
	~<ty³_Œa™s
>

24 
	~<veùÜ
>

26 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

29 
	~"ab¦/¡ršgs/¡r_još.h
"

30 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sysÿÎs.šc
"

42 
	sSy¡emC®lDesütiÚ
 {

43 
	m¡d
::
¡ršg
 
Çme
;

44 
	m·¿m‘”_couÁ
;

45 
size_t
 
	m·¿m‘”_šdex
;

49 
	sP¬am‘”DesütiÚ
 {

50 
	m¡d
::
¡ršg
 
sysÿÎ
;

51 
	mšdex
;

52 
	m¡d
::
¡ršg
 
Çme
;

53 
	m¡d
::
¡ršg
 
æags
;

54 
	m¡d
::
¡ršg
 
ty³
;

55 
size_t
 
	msize
;

59 
	eCÚv’tiÚFÏg
 { 
	mkIn
 = 1, 
	mkOut
 = 2 };

63 
	gab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, 
	g¡d
::¡ršg>, > *
	$BoundsTabË
() {

64 autØ*
bounds_bË
 =

65 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, std::string>, >{

66 
PARAMETER_BOUNDS_INIT
};

67  
bounds_bË
;

68 
	}
}

72 
	gab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, 
	g¡d
::string>, >

73 *
	$CÚv’tiÚTabË
() {

74 autØ*
cÚv’tiÚ_bË
 =

75 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, std::string>, >{

76 
PARAMETER_CONVENTIONS_INIT
};

77  
cÚv’tiÚ_bË
;

78 
	}
}

82 
	gab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, 
	g¡d
::¡ršg>, > *
	$CouÁsTabË
() {

83 autØ*
couÁs_bË
 =

84 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, std::string>, >{

85 
PARAMETER_COUNTS_INIT
};

86  
couÁs_bË
;

87 
	}
}

90 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

91 
	g¡d
::
¡ršg
 
	$Ty³FÏgs
(cÚ¡ 
¡d
::
¡ršg
 &
sysÿÎ
, cÚ¡ std::¡ršg &
Çme
) {

92 
¡d
::
veùÜ
<¡d::
¡ršg
> 
æags
;

94 ià(
¡d
::
is_poš‹r
<
T
>()) {

95 
æags
.
	`push_back
("kPointer");

96 } ià(
¡d
::
is_š‹g¿l
<
T
>()) {

97 
æags
.
	`push_back
("kScalar");

99 ià(
¡d
::
is_sigÃd
<
T
>()) {

100 
æags
.
	`push_back
("kSigned");

101 } ià(
¡d
::
is_unsigÃd
<
T
>()) {

102 
æags
.
	`push_back
("kUnsigned");

108 autØ
™
 = 
	`CÚv’tiÚTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

109 ià(
™
 !ğ
	`CÚv’tiÚTabË
()->
	`’d
()) {

110 ià(
™
->
£cÚd
 & 
kIn
) {

111 
æags
.
	`push_back
("kIn");

113 ià(
™
->
£cÚd
 & 
kOut
) {

114 
æags
.
	`push_back
("kOut");

120 ià(
¡d
::
is_poš‹r
<
T
>()) {

121 
usšg
 
poš‹e_ty³
 = 
ty³Çme
 
¡d
::
»move_poš‹r
<
T
>::
ty³
;

123 ià(
¡d
::
is_void
<
poš‹e_ty³
>::
v®ue
) {

124 
æags
.
	`push_back
("kVoidPtr");

127 ià(
¡d
::
is_cÚ¡
<
poš‹e_ty³
>::
v®ue
) {

128 
æags
.
	`push_back
("kConst");

129 
æags
.
	`push_back
("kIn");

131 
æags
.
	`push_back
("kIn");

132 
æags
.
	`push_back
("kOut");

136 
æags
.
	`push_back
("kConst");

137 
æags
.
	`push_back
("kIn");

144 autØ
™
 = 
	`BoundsTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

145 ià(
™
 !ğ
	`BoundsTabË
()->
	`’d
()) {

146 
æags
.
	`push_back
("kBounded");

151 ià(
¡d
::
is_poš‹r
<
T
>()) {

152 ià(
¡d
::
is_§me
<
T
, const *>()) {

153 
æags
.
	`push_back
("kString");

154 } ià(
¡d
::
is_void
<
ty³Çme
 std::
»move_poš‹r
<
T
>::
ty³
>::
v®ue
) {

155 
æags
.
	`push_back
("kScalar");

157 
æags
.
	`push_back
("kFixed");

163  
ab¦
::
	`SŒJoš
(
æags
, " | ");

164 
	}
}

167 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

168 
cÚ¡ex´
 
size_t
 
	$Ty³Size
() {

169  (
T
);

170 
	}
}

172 
	g‹m¶©e
 <>

173 
cÚ¡ex´
 
size_t
 
	gTy³Size
<>() {

177 
	g‹m¶©e
 <>

178 
cÚ¡ex´
 
size_t
 
	gTy³Size
<const >() {

183 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

184 
size_t
 
	$EncodšgSize
(cÚ¡ 
¡d
::
¡ršg
 &
sysÿÎ
, cÚ¡ std::¡ršg &
Çme
) {

187 autØ
™
 = 
	`BoundsTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

188 ià(
™
 !ğ
	`BoundsTabË
()->
	`’d
()) {

189 ià(!
¡d
::
is_poš‹r
<
T
>()) {

190 
¡d
::
û¼
 << 
ab¦
::
	`SŒ—mFÜm©
(

193 
sysÿÎ
, 
Çme
)

194 << 
¡d
::
’dl
;

195 
	`ex™
(1);

197  
™
->
£cÚd
;

203 
size_t
 
couÁ
;

204 autØ
™
 = 
	`CouÁsTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

205 ià(
™
 !ğ
	`CouÁsTabË
()->
	`’d
()) {

206 ià(!
¡d
::
is_poš‹r
<
T
>()) {

207 
¡d
::
û¼
 << 
ab¦
::
	`SŒ—mFÜm©
(

210 
sysÿÎ
, 
Çme
)

211 << 
¡d
::
’dl
;

212 
	`ex™
(1);

214 
couÁ
 = 
™
->
£cÚd
;

216 
couÁ
 = 1;

219 ià(
¡d
::
is_poš‹r
<
T
>()) {

222 
usšg
 
U
 = 
ty³Çme
 
¡d
::
»move_poš‹r
<
T
>::
ty³
;

223  
Ty³Size
<
U
>(è* 
couÁ
;

228  
Ty³Size
<
T
>();

229 
	}
}

232 
	g¡d
::
m­
<, 
	gSy¡emC®lDesütiÚ
> *
	$Sy¡emC®lTabË
() {

233 autØ*
sy¡em_ÿÎs
 =

234 
Ãw
 
¡d
::
m­
<, 
Sy¡emC®lDesütiÚ
>{
SYSTEM_CALL_TABLE_INIT
};

235  
sy¡em_ÿÎs
;

236 
	}
}

239 
	gab¦
::
æ©_hash_m­
<, 
	gP¬am‘”DesütiÚ
> *
	$P¬am‘”TabË
() {

240 autØ*
·¿m‘”_bË
 =

241 
Ãw
 
ab¦
::
æ©_hash_m­
<, 
P¬am‘”DesütiÚ
>{
PARAMETER_TABLE_INIT
};

242  
·¿m‘”_bË
;

243 
	}
}

246 
	$Em™Sy¡emC®lTabË
(
¡d
::
o¡»am
 *
os
) {

249 ià(
	`Sy¡emC®lTabË
()->
	`em±y
()) {

250 
¡d
::
û¼
 << "Expected‡t†east one system callo be defined."

251 << 
¡d
::
’dl
;

252 
	`abÜt
();

255 
Ï¡
 = 
	`Sy¡emC®lTabË
()->
	`rbegš
()->
fœ¡
;

257 *
os
 << "cÚ¡ size_ˆkSy¡emC®lTabËSizğ" << 
Ï¡
 + 1 << ";\n";

258 *
os
 << "\n";

259 *
os
 << "const SystemCallTableEntry kSystemCallTable[] = {\n";

260 
i
 = 0; i <ğ
Ï¡
; i++) {

261 autØ
™
 = 
	`Sy¡emC®lTabË
()->
	`fšd
(
i
);

262 
¡d
::
¡ršg
 
Çme
;

263 
couÁ
;

264 
size_t
 
šdex
;

265 ià(
™
 =ğ
	`Sy¡emC®lTabË
()->
	`’d
()) {

266 
Çme
 = "nullptr";

267 
couÁ
 = 0;

268 
šdex
 = 0;

270 
Çme
 = 
ab¦
::
	`SŒC©
("\"", 
™
->
£cÚd
.name, "\"");

271 
couÁ
 = 
™
->
£cÚd
.
·¿m‘”_couÁ
;

272 
šdex
 = 
™
->
£cÚd
.
·¿m‘”_šdex
;

274 *
os
 << 
ab¦
::
	`SŒ—mFÜm©
(" /* %˜*/ {%s, %i, %i},\n", 
i
, 
Çme
, 
couÁ
,

275 
šdex
);

277 *
os
 << "};\n";

278 
	}
}

281 
	$Em™P¬am‘”TabË
(
¡d
::
o¡»am
 *
os
) {

282 *
os
 << "const ParameterTableEntry kParameterTable[] = {\n";

283 
size_t
 
i
 = 0; i < 
	`P¬am‘”TabË
()->
	`size
(); i++) {

284 cÚ¡ 
P¬am‘”DesütiÚ
 &
desc
 = (*
	`P¬am‘”TabË
())[
i
];

285 *
os
 << 
ab¦
::
	`SŒ—mFÜm©
(" /* %s:%i */ {\"%s\", \"%s\", %s, %llu},\n",

286 
desc
.
sysÿÎ
, desc.
šdex
, desc.
Çme
, desc.
ty³
,

287 
desc
.
æags
, desc.
size
);

289 *
os
 << "};\n";

290 
	}
}

292 
	$maš
(
¬gc
, **
¬gv
) {

293 
	`Em™Sy¡emC®lTabË
(&
¡d
::
cout
);

294 
¡d
::
cout
 << std::
’dl
;

295 
	`Em™P¬am‘”TabË
(&
¡d
::
cout
);

297 
	}
}

	@platform/system_call/generate_tables.cc

19 
	~<io¡»am
>

20 
	~<m­
>

21 
	~<¡ršg
>

22 
	~<tu¶e
>

23 
	~<ty³_Œa™s
>

24 
	~<veùÜ
>

26 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

29 
	~"ab¦/¡ršgs/¡r_još.h
"

30 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sysÿÎs.šc
"

42 
	sSy¡emC®lDesütiÚ
 {

43 
	m¡d
::
¡ršg
 
Çme
;

44 
	m·¿m‘”_couÁ
;

45 
size_t
 
	m·¿m‘”_šdex
;

49 
	sP¬am‘”DesütiÚ
 {

50 
	m¡d
::
¡ršg
 
sysÿÎ
;

51 
	mšdex
;

52 
	m¡d
::
¡ršg
 
Çme
;

53 
	m¡d
::
¡ršg
 
æags
;

54 
	m¡d
::
¡ršg
 
ty³
;

55 
size_t
 
	msize
;

59 
	eCÚv’tiÚFÏg
 { 
	mkIn
 = 1, 
	mkOut
 = 2 };

63 
	gab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, 
	g¡d
::¡ršg>, > *
	$BoundsTabË
() {

64 autØ*
bounds_bË
 =

65 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, std::string>, >{

66 
PARAMETER_BOUNDS_INIT
};

67  
bounds_bË
;

68 
	}
}

72 
	gab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, 
	g¡d
::string>, >

73 *
	$CÚv’tiÚTabË
() {

74 autØ*
cÚv’tiÚ_bË
 =

75 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, std::string>, >{

76 
PARAMETER_CONVENTIONS_INIT
};

77  
cÚv’tiÚ_bË
;

78 
	}
}

82 
	gab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, 
	g¡d
::¡ršg>, > *
	$CouÁsTabË
() {

83 autØ*
couÁs_bË
 =

84 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
·œ
<¡d::
¡ršg
, std::string>, >{

85 
PARAMETER_COUNTS_INIT
};

86  
couÁs_bË
;

87 
	}
}

90 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

91 
	g¡d
::
¡ršg
 
	$Ty³FÏgs
(cÚ¡ 
¡d
::
¡ršg
 &
sysÿÎ
, cÚ¡ std::¡ršg &
Çme
) {

92 
¡d
::
veùÜ
<¡d::
¡ršg
> 
æags
;

94 ià(
¡d
::
is_poš‹r
<
T
>()) {

95 
æags
.
	`push_back
("kPointer");

96 } ià(
¡d
::
is_š‹g¿l
<
T
>()) {

97 
æags
.
	`push_back
("kScalar");

99 ià(
¡d
::
is_sigÃd
<
T
>()) {

100 
æags
.
	`push_back
("kSigned");

101 } ià(
¡d
::
is_unsigÃd
<
T
>()) {

102 
æags
.
	`push_back
("kUnsigned");

108 autØ
™
 = 
	`CÚv’tiÚTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

109 ià(
™
 !ğ
	`CÚv’tiÚTabË
()->
	`’d
()) {

110 ià(
™
->
£cÚd
 & 
kIn
) {

111 
æags
.
	`push_back
("kIn");

113 ià(
™
->
£cÚd
 & 
kOut
) {

114 
æags
.
	`push_back
("kOut");

120 ià(
¡d
::
is_poš‹r
<
T
>()) {

121 
usšg
 
poš‹e_ty³
 = 
ty³Çme
 
¡d
::
»move_poš‹r
<
T
>::
ty³
;

123 ià(
¡d
::
is_void
<
poš‹e_ty³
>::
v®ue
) {

124 
æags
.
	`push_back
("kVoidPtr");

127 ià(
¡d
::
is_cÚ¡
<
poš‹e_ty³
>::
v®ue
) {

128 
æags
.
	`push_back
("kConst");

129 
æags
.
	`push_back
("kIn");

131 
æags
.
	`push_back
("kIn");

132 
æags
.
	`push_back
("kOut");

136 
æags
.
	`push_back
("kConst");

137 
æags
.
	`push_back
("kIn");

144 autØ
™
 = 
	`BoundsTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

145 ià(
™
 !ğ
	`BoundsTabË
()->
	`’d
()) {

146 
æags
.
	`push_back
("kBounded");

151 ià(
¡d
::
is_poš‹r
<
T
>()) {

152 ià(
¡d
::
is_§me
<
T
, const *>()) {

153 
æags
.
	`push_back
("kString");

154 } ià(
¡d
::
is_void
<
ty³Çme
 std::
»move_poš‹r
<
T
>::
ty³
>::
v®ue
) {

155 
æags
.
	`push_back
("kScalar");

157 
æags
.
	`push_back
("kFixed");

163  
ab¦
::
	`SŒJoš
(
æags
, " | ");

164 
	}
}

167 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

168 
cÚ¡ex´
 
size_t
 
	$Ty³Size
() {

169  (
T
);

170 
	}
}

172 
	g‹m¶©e
 <>

173 
cÚ¡ex´
 
size_t
 
	gTy³Size
<>() {

177 
	g‹m¶©e
 <>

178 
cÚ¡ex´
 
size_t
 
	gTy³Size
<const >() {

183 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

184 
size_t
 
	$EncodšgSize
(cÚ¡ 
¡d
::
¡ršg
 &
sysÿÎ
, cÚ¡ std::¡ršg &
Çme
) {

187 autØ
™
 = 
	`BoundsTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

188 ià(
™
 !ğ
	`BoundsTabË
()->
	`’d
()) {

189 ià(!
¡d
::
is_poš‹r
<
T
>()) {

190 
¡d
::
û¼
 << 
ab¦
::
	`SŒ—mFÜm©
(

193 
sysÿÎ
, 
Çme
)

194 << 
¡d
::
’dl
;

195 
	`ex™
(1);

197  
™
->
£cÚd
;

203 
size_t
 
couÁ
;

204 autØ
™
 = 
	`CouÁsTabË
()->
	`fšd
({
sysÿÎ
, 
Çme
});

205 ià(
™
 !ğ
	`CouÁsTabË
()->
	`’d
()) {

206 ià(!
¡d
::
is_poš‹r
<
T
>()) {

207 
¡d
::
û¼
 << 
ab¦
::
	`SŒ—mFÜm©
(

210 
sysÿÎ
, 
Çme
)

211 << 
¡d
::
’dl
;

212 
	`ex™
(1);

214 
couÁ
 = 
™
->
£cÚd
;

216 
couÁ
 = 1;

219 ià(
¡d
::
is_poš‹r
<
T
>()) {

222 
usšg
 
U
 = 
ty³Çme
 
¡d
::
»move_poš‹r
<
T
>::
ty³
;

223  
Ty³Size
<
U
>(è* 
couÁ
;

228  
Ty³Size
<
T
>();

229 
	}
}

232 
	g¡d
::
m­
<, 
	gSy¡emC®lDesütiÚ
> *
	$Sy¡emC®lTabË
() {

233 autØ*
sy¡em_ÿÎs
 =

234 
Ãw
 
¡d
::
m­
<, 
Sy¡emC®lDesütiÚ
>{
SYSTEM_CALL_TABLE_INIT
};

235  
sy¡em_ÿÎs
;

236 
	}
}

239 
	gab¦
::
æ©_hash_m­
<, 
	gP¬am‘”DesütiÚ
> *
	$P¬am‘”TabË
() {

240 autØ*
·¿m‘”_bË
 =

241 
Ãw
 
ab¦
::
æ©_hash_m­
<, 
P¬am‘”DesütiÚ
>{
PARAMETER_TABLE_INIT
};

242  
·¿m‘”_bË
;

243 
	}
}

246 
	$Em™Sy¡emC®lTabË
(
¡d
::
o¡»am
 *
os
) {

249 ià(
	`Sy¡emC®lTabË
()->
	`em±y
()) {

250 
¡d
::
û¼
 << "Expected‡t†east one system callo be defined."

251 << 
¡d
::
’dl
;

252 
	`abÜt
();

255 
Ï¡
 = 
	`Sy¡emC®lTabË
()->
	`rbegš
()->
fœ¡
;

257 *
os
 << "cÚ¡ size_ˆkSy¡emC®lTabËSizğ" << 
Ï¡
 + 1 << ";\n";

258 *
os
 << "\n";

259 *
os
 << "const SystemCallTableEntry kSystemCallTable[] = {\n";

260 
i
 = 0; i <ğ
Ï¡
; i++) {

261 autØ
™
 = 
	`Sy¡emC®lTabË
()->
	`fšd
(
i
);

262 
¡d
::
¡ršg
 
Çme
;

263 
couÁ
;

264 
size_t
 
šdex
;

265 ià(
™
 =ğ
	`Sy¡emC®lTabË
()->
	`’d
()) {

266 
Çme
 = "nullptr";

267 
couÁ
 = 0;

268 
šdex
 = 0;

270 
Çme
 = 
ab¦
::
	`SŒC©
("\"", 
™
->
£cÚd
.name, "\"");

271 
couÁ
 = 
™
->
£cÚd
.
·¿m‘”_couÁ
;

272 
šdex
 = 
™
->
£cÚd
.
·¿m‘”_šdex
;

274 *
os
 << 
ab¦
::
	`SŒ—mFÜm©
(" /* %˜*/ {%s, %i, %i},\n", 
i
, 
Çme
, 
couÁ
,

275 
šdex
);

277 *
os
 << "};\n";

278 
	}
}

281 
	$Em™P¬am‘”TabË
(
¡d
::
o¡»am
 *
os
) {

282 *
os
 << "const ParameterTableEntry kParameterTable[] = {\n";

283 
size_t
 
i
 = 0; i < 
	`P¬am‘”TabË
()->
	`size
(); i++) {

284 cÚ¡ 
P¬am‘”DesütiÚ
 &
desc
 = (*
	`P¬am‘”TabË
())[
i
];

285 *
os
 << 
ab¦
::
	`SŒ—mFÜm©
(" /* %s:%i */ {\"%s\", \"%s\", %s, %llu},\n",

286 
desc
.
sysÿÎ
, desc.
šdex
, desc.
Çme
, desc.
ty³
,

287 
desc
.
æags
, desc.
size
);

289 *
os
 << "};\n";

290 
	}
}

292 
	$maš
(
¬gc
, **
¬gv
) {

293 
	`Em™Sy¡emC®lTabË
(&
¡d
::
cout
);

294 
¡d
::
cout
 << std::
’dl
;

295 
	`Em™P¬am‘”TabË
(&
¡d
::
cout
);

297 
	}
}

	@platform/system_call/message.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

21 
	~<®gÜ™hm
>

22 
	~<c¡ddef
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/¡ršgs/¡r_još.h
"

28 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

34 
	gÇme¥aû
 {

38 
ušt64_t
 
RoundUpToMuÉËOf8
(ušt64_ˆ
v®ue
) {

39  
	gv®ue
 + (8 - value % 8) % 8;

43 
ušt64_t
 
RoundDownToMuÉËOf8
(ušt64_ˆ
v®ue
) {

44  (
	gv®ue
 / 8) * 8;

49 
boŞ
 
SumOv”æowOnRoundUpToMuÉËOf8
(
ušt64_t
 
v1
, ušt64_ˆ
v2
) {

50  
	gv2
 > 
RoundDownToMuÉËOf8
(
SIZE_MAX
) ||

51 
	gv1
 > 
RoundDownToMuÉËOf8
(
SIZE_MAX
è- 
	gv2
;

56 
	g¡d
::
¡ršg
 
FÜm©Mes§ge
(
´im™ives
::
Ex‹Á
 
ex‹Á
) {

57 
Mes§geR—d”
 
»ad”
(
ex‹Á
);

58 
	g¡d
::
¡ršg
 
»suÉ
;

60 
	gab¦
::
SŒAµ’d
(&
»suÉ
, 
»ad”
.
is_»que¡
() ? "request: " : "response: ");

62 
Sy¡emC®lDesütÜ
 
desütÜ
(
»ad”
.
sy¢o
());

63 
	gab¦
::
SŒAµ’d
(&
»suÉ
, 
desütÜ
.
Çme
());

64 ià(
	g»ad”
.
is_»¥Ú£
()) {

65 
	gab¦
::
SŒAµ’d
(&
»suÉ
, " [»tuºs: ", 
»ad”
.result(), "] ");

68 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
fÜm©‹d
;

69 
	gi
 = 0; i < 
	gdesütÜ
.
·¿m‘”_couÁ
(); i++) {

70 ià(!
	g»ad”
.
·¿m‘”_is_u£d
(
i
)) ;

71 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
desütÜ
.
·¿m‘”
(
i
);

72 
	g¡d
::
¡ršg
 
¡r
 = 
ab¦
::
SŒC©
(
i
, ": ", 
·¿m‘”
.
Çme
());

73 ià(
	g·¿m‘”
.
is_sÿÏr
()) {

74 
	gab¦
::
SŒAµ’d
(&
¡r
, " [sÿÏ¸", 
»ad”
.
·¿m‘”
<
ušt64_t
>(
i
), "]");

75 } ià(
	g»ad”
.
·¿m‘”_size
(
i
) == 0) {

76 
ab¦
::
SŒAµ’d
(&
¡r
, " [nullptr]");

77 } ià(
	g·¿m‘”
.
is_¡ršg
()) {

78 
	gab¦
::
SŒAµ’d
(&
¡r
, " [string \"",

79 
»ad”
.
·¿m‘”_add»ss
<cÚ¡ *>(
i
), "\"]");

80 } ià(
	g·¿m‘”
.
is_fixed
()) {

81 
	gab¦
::
SŒAµ’d
(&
¡r
, " [fixed ", 
»ad”
.
·¿m‘”_size
(
i
), "]");

82 } ià(
	g·¿m‘”
.
is_bounded
()) {

83 
	gab¦
::
SŒAµ’d
(&
¡r
, " [bounded ", 
»ad”
.
·¿m‘”_size
(
i
), "]");

85 
	g¡r
 = " <unexpected value>";

87 
	gfÜm©‹d
.
push_back
(
¡r
);

90 
	gab¦
::
SŒAµ’d
(&
»suÉ
, "(", 
ab¦
::
SŒJoš
(
fÜm©‹d
, ", "), ")");

91  
	g»suÉ
;

94 
boŞ
 
	gMes§geR—d”
::
IsV®idP¬am‘”Size
(
šdex
) const {

95 ià(!
·¿m‘”_is_u£d
(
šdex
)) {

96  
Œue
;

99 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

100 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
šdex
);

101 ià(
	g·¿m‘”
.
is_sÿÏr
()) {

102  
h—d”
()->
	gsize
[
šdex
] =ğ(
ušt64_t
);

105 ià(
	g·¿m‘”
.
is_fixed
()) {

106  
h—d”
()->
	gsize
[
šdex
] =ğ
·¿m‘”
.
size
();

109 ià(
h—d”
()->
	gsize
[
šdex
] == 0) {

110  
Œue
;

113 ià(
	g·¿m‘”
.
is_¡ršg
()) {

114 cÚ¡ *
	gv®ue
 = 
this
->
·¿m‘”_add»ss
<const *>(

115 
·¿m‘”
.
šdex
());

117 ià(
	gv®ue
[
h—d”
()->
size
[
šdex
] - 1] != '\0') {

118  
çl£
;

121  
h—d”
()->
	gsize
[
šdex
] =ğ
¡¾’
(
v®ue
) + 1;

127 ià(
	g·¿m‘”
.
is_bounded
()) {

128  
	gŒue
;

132 
abÜt
();

135 
	g´im™ives
::
Prim™iveStus
 
Mes§geR—d”
::
šv®id_¬gum’t_¡©us
(

136 cÚ¡ 
¡d
::
¡ršg
 &
»asÚ
) const {

137  
´im™ives
::
Prim™iveStus
{

138 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
	g»asÚ
};

141 
	g´im™ives
::
Prim™iveStus
 
Mes§geR—d”
::
V®id©eMes§geH—d”
() const {

142 
size_t
 
Ãxt_off£t
 = (
Mes§geH—d”
);

143 ià(
	gex‹Á_
.
size
(è< 
	gÃxt_off£t
) {

144  
šv®id_¬gum’t_¡©us
(

148 ià(
h—d”
()->
	gmagic
 !ğ
kMes§geMagic
) {

149  
šv®id_¬gum’t_¡©us
(

153 ià(
is_»que¡
(è=ğ
is_»¥Ú£
()) {

154  
šv®id_¬gum’t_¡©us
(

158 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

160 ià(!
	gsysÿÎ
.
is_v®id
()) {

161  
šv®id_¬gum’t_¡©us
(

162 
ab¦
::
SŒC©
("Mes§gm®fÜmed: sy¢Ø", 
sy¢o
(), " is invalid"));

165  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

168 
	g´im™ives
::
Prim™iveStus
 
Mes§geR—d”
::
V®id©e
() const {

169 
ASYLO_RETURN_IF_ERROR
(
V®id©eMes§geH—d”
());

171 
size_t
 
	gÃxt_off£t
 = (
Mes§geH—d”
);

172 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

174 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

175 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
i
);

176 ià(!
·¿m‘”_is_u£d
(
·¿m‘”
)) {

180 ià(
h—d”
()->
	goff£t
[
i
] !ğ
Ãxt_off£t
) {

181  
šv®id_¬gum’t_¡©us
(

182 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

186 ià(
SumOv”æowOnRoundUpToMuÉËOf8
(
h—d”
()->
size
[
i
], 
Ãxt_off£t
)) {

187  
šv®id_¬gum’t_¡©us
(

188 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

192 
	gÃxt_off£t
 = 
RoundUpToMuÉËOf8
(
Ãxt_off£t
 + 
h—d”
()->
size
[
i
]);

193 ià(
	gÃxt_off£t
 > 
	gex‹Á_
.
size
()) {

194  
šv®id_¬gum’t_¡©us
(

195 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

199 ià(!
IsV®idP¬am‘”Size
(
i
)) {

200  
šv®id_¬gum’t_¡©us
(

201 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

206  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

209 
boŞ
 
	gMes§geR—d”
::
·¿m‘”_is_u£d
(
P¬am‘”DesütÜ
 
·¿m‘”
) const {

210 ià(!
·¿m‘”
.
is_v®id
()) {

211  
çl£
;

215 ià(
is_»que¡
(è&& !
	g·¿m‘”
.
is_š
()) {

216  
	gçl£
;

220 ià(
is_»¥Ú£
(è&& !
	g·¿m‘”
.
is_out
()) {

221  
	gçl£
;

224  
	gŒue
;

227 
boŞ
 
	gMes§geR—d”
::
·¿m‘”_is_u£d
(
šdex
) const {

228 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

229 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
šdex
);

230  
·¿m‘”_is_u£d
(
·¿m‘”
);

233 
	gMes§geWr™”
::
Mes§geWr™”
(

234 
sy¢o
, 
ušt64_t
 
»suÉ
, 
boŞ
 
is_»que¡
,

235 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
)

236 : 
sy¢o_
(
sy¢o
),

237 
»suÉ_
(
»suÉ
),

238 
is_»que¡_
(
is_»que¡
),

239 
·¿m‘”s_
(
·¿m‘”s
) {

240 
Sy¡emC®lDesütÜ
 
	gsysÿÎ
{
	gsy¢o
};

241 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

242 
	g·¿m‘”_size_
[
i
] = 
P¬am‘”Size
(
sysÿÎ
.
·¿m‘”
(i));

246 
Mes§geWr™”
 
	gMes§geWr™”
::
Reque¡Wr™”
(

247 
sy¢o
, cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
) {

248  
Mes§geWr™”
(
sy¢o
, 0, 
Œue
, 
·¿m‘”s
);

251 
Mes§geWr™”
 
	gMes§geWr™”
::
Re¥Ú£Wr™”
(

252 
sy¢o
, 
ušt64_t
 
»suÉ
,

253 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
) {

254  
Mes§geWr™”
(
sy¢o
, 
»suÉ
, 
çl£
, 
·¿m‘”s
);

257 
size_t
 
	gMes§geWr™”
::
Mes§geSize
() const {

258 
size_t
 
»suÉ
 = (
Mes§geH—d”
);

259 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

260 
	g»suÉ
 +ğ
RoundUpToMuÉËOf8
(
·¿m‘”_size_
[
i
]);

262  
	g»suÉ
;

265 
boŞ
 
	gMes§geWr™”
::
·¿m‘”_is_u£d
(
P¬am‘”DesütÜ
 
·¿m‘”
) const {

266 ià(!
·¿m‘”
.
is_v®id
()) {

267  
çl£
;

271 ià(
is_»que¡
(è&& !
	g·¿m‘”
.
is_š
()) {

272  
	gçl£
;

276 ià(
is_»¥Ú£
(è&& !
	g·¿m‘”
.
is_out
()) {

277  
	gçl£
;

280  
	gŒue
;

283 
boŞ
 
	gMes§geWr™”
::
·¿m‘”_is_u£d
(
šdex
) const {

284 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o_
);

285 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
šdex
);

286  
·¿m‘”_is_u£d
(
·¿m‘”
);

289 
size_t
 
	gMes§geWr™”
::
P¬am‘”Size
(
P¬am‘”DesütÜ
 
·¿m‘”
) const {

290 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o_
);

293 ià(!
·¿m‘”_is_u£d
(
·¿m‘”
)) {

298 ià(
	g·¿m‘”
.
is_sÿÏr
()) {

299  (
	gušt64_t
);

302 
ušt64_t
 
	gv®ue
 = 
·¿m‘”s_
[
·¿m‘”
.
šdex
()];

305 ià(
	gv®ue
 == 0) {

309 ià(
	g·¿m‘”
.
is_fixed
()) {

310  
	g·¿m‘”
.
size
();

313 ià(
	g·¿m‘”
.
is_¡ršg
()) {

314  
¡¾’
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
v®ue
)) + 1;

317 ià(
	g·¿m‘”
.
is_bounded
()) {

318  
	g·¿m‘”s_
[
·¿m‘”
.
boundšg_·¿m‘”
().
šdex
()];

322 
abÜt
();

325 
boŞ
 
	gMes§geWr™”
::
Wr™e
(
´im™ives
::
Ex‹Á
 *
mes§ge
) const {

326 autØ*
h—d”
 = 
»š‹½»t_ÿ¡
<
Mes§geH—d”
 *>(
mes§ge
->
d©a
());

327 
	gh—d”
->
	gmagic
 = 
kMes§geMagic
;

328 
	gh—d”
->
	gæags
 = 
is_»que¡_
 ? 
kSy¡emC®lReque¡
 : 
kSy¡emC®lRe¥Ú£
;

329 
	gh—d”
->
	gsy¢o
 = 
sy¢o_
;

332 ià(
is_»¥Ú£
()) {

333 
	gh—d”
->
	g»suÉ
 = 
»suÉ_
;

337 
size_t
 
	gÃxt_off£t
 = (
Mes§geH—d”
);

339 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o_
);

340 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

341 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
i
);

342 ià(!
·¿m‘”_is_u£d
(
·¿m‘”
)) {

349 ià(
	g·¿m‘”
.
is_poš‹r
()) {

350 ià(*
	g¤c
 = 
»š‹½»t_ÿ¡
<*>(
·¿m‘”s_
[
i
])) {

351 
memıy
(
mes§ge
->
As
<
ušt8_t
>(è+ 
Ãxt_off£t
, 
¤c
, 
·¿m‘”_size_
[
i
]);

356 *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gmes§ge
->
	gAs
<
	gušt8_t
>(è+ 
	gÃxt_off£t
) =

357 
·¿m‘”s_
[
i
];

359 
	gh—d”
->
	goff£t
[
i
] = 
Ãxt_off£t
;

360 
	gh—d”
->
	gsize
[
i
] = 
·¿m‘”_size_
[i];

361 
	gÃxt_off£t
 = 
RoundUpToMuÉËOf8
(
Ãxt_off£t
 + 
·¿m‘”_size_
[
i
]);

364  
	gŒue
;

	@platform/system_call/message.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

21 
	~<®gÜ™hm
>

22 
	~<c¡ddef
>

23 
	~<¡ršg
>

24 
	~<veùÜ
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/¡ršgs/¡r_još.h
"

28 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

34 
	gÇme¥aû
 {

38 
ušt64_t
 
RoundUpToMuÉËOf8
(ušt64_ˆ
v®ue
) {

39  
	gv®ue
 + (8 - value % 8) % 8;

43 
ušt64_t
 
RoundDownToMuÉËOf8
(ušt64_ˆ
v®ue
) {

44  (
	gv®ue
 / 8) * 8;

49 
boŞ
 
SumOv”æowOnRoundUpToMuÉËOf8
(
ušt64_t
 
v1
, ušt64_ˆ
v2
) {

50  
	gv2
 > 
RoundDownToMuÉËOf8
(
SIZE_MAX
) ||

51 
	gv1
 > 
RoundDownToMuÉËOf8
(
SIZE_MAX
è- 
	gv2
;

56 
	g¡d
::
¡ršg
 
FÜm©Mes§ge
(
´im™ives
::
Ex‹Á
 
ex‹Á
) {

57 
Mes§geR—d”
 
»ad”
(
ex‹Á
);

58 
	g¡d
::
¡ršg
 
»suÉ
;

60 
	gab¦
::
SŒAµ’d
(&
»suÉ
, 
»ad”
.
is_»que¡
() ? "request: " : "response: ");

62 
Sy¡emC®lDesütÜ
 
desütÜ
(
»ad”
.
sy¢o
());

63 
	gab¦
::
SŒAµ’d
(&
»suÉ
, 
desütÜ
.
Çme
());

64 ià(
	g»ad”
.
is_»¥Ú£
()) {

65 
	gab¦
::
SŒAµ’d
(&
»suÉ
, " [»tuºs: ", 
»ad”
.result(), "] ");

68 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
fÜm©‹d
;

69 
	gi
 = 0; i < 
	gdesütÜ
.
·¿m‘”_couÁ
(); i++) {

70 ià(!
	g»ad”
.
·¿m‘”_is_u£d
(
i
)) ;

71 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
desütÜ
.
·¿m‘”
(
i
);

72 
	g¡d
::
¡ršg
 
¡r
 = 
ab¦
::
SŒC©
(
i
, ": ", 
·¿m‘”
.
Çme
());

73 ià(
	g·¿m‘”
.
is_sÿÏr
()) {

74 
	gab¦
::
SŒAµ’d
(&
¡r
, " [sÿÏ¸", 
»ad”
.
·¿m‘”
<
ušt64_t
>(
i
), "]");

75 } ià(
	g»ad”
.
·¿m‘”_size
(
i
) == 0) {

76 
ab¦
::
SŒAµ’d
(&
¡r
, " [nullptr]");

77 } ià(
	g·¿m‘”
.
is_¡ršg
()) {

78 
	gab¦
::
SŒAµ’d
(&
¡r
, " [string \"",

79 
»ad”
.
·¿m‘”_add»ss
<cÚ¡ *>(
i
), "\"]");

80 } ià(
	g·¿m‘”
.
is_fixed
()) {

81 
	gab¦
::
SŒAµ’d
(&
¡r
, " [fixed ", 
»ad”
.
·¿m‘”_size
(
i
), "]");

82 } ià(
	g·¿m‘”
.
is_bounded
()) {

83 
	gab¦
::
SŒAµ’d
(&
¡r
, " [bounded ", 
»ad”
.
·¿m‘”_size
(
i
), "]");

85 
	g¡r
 = " <unexpected value>";

87 
	gfÜm©‹d
.
push_back
(
¡r
);

90 
	gab¦
::
SŒAµ’d
(&
»suÉ
, "(", 
ab¦
::
SŒJoš
(
fÜm©‹d
, ", "), ")");

91  
	g»suÉ
;

94 
boŞ
 
	gMes§geR—d”
::
IsV®idP¬am‘”Size
(
šdex
) const {

95 ià(!
·¿m‘”_is_u£d
(
šdex
)) {

96  
Œue
;

99 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

100 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
šdex
);

101 ià(
	g·¿m‘”
.
is_sÿÏr
()) {

102  
h—d”
()->
	gsize
[
šdex
] =ğ(
ušt64_t
);

105 ià(
	g·¿m‘”
.
is_fixed
()) {

106  
h—d”
()->
	gsize
[
šdex
] =ğ
·¿m‘”
.
size
();

109 ià(
h—d”
()->
	gsize
[
šdex
] == 0) {

110  
Œue
;

113 ià(
	g·¿m‘”
.
is_¡ršg
()) {

114 cÚ¡ *
	gv®ue
 = 
this
->
·¿m‘”_add»ss
<const *>(

115 
·¿m‘”
.
šdex
());

117 ià(
	gv®ue
[
h—d”
()->
size
[
šdex
] - 1] != '\0') {

118  
çl£
;

121  
h—d”
()->
	gsize
[
šdex
] =ğ
¡¾’
(
v®ue
) + 1;

127 ià(
	g·¿m‘”
.
is_bounded
()) {

128  
	gŒue
;

132 
abÜt
();

135 
	g´im™ives
::
Prim™iveStus
 
Mes§geR—d”
::
šv®id_¬gum’t_¡©us
(

136 cÚ¡ 
¡d
::
¡ršg
 &
»asÚ
) const {

137  
´im™ives
::
Prim™iveStus
{

138 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
	g»asÚ
};

141 
	g´im™ives
::
Prim™iveStus
 
Mes§geR—d”
::
V®id©eMes§geH—d”
() const {

142 
size_t
 
Ãxt_off£t
 = (
Mes§geH—d”
);

143 ià(
	gex‹Á_
.
size
(è< 
	gÃxt_off£t
) {

144  
šv®id_¬gum’t_¡©us
(

148 ià(
h—d”
()->
	gmagic
 !ğ
kMes§geMagic
) {

149  
šv®id_¬gum’t_¡©us
(

153 ià(
is_»que¡
(è=ğ
is_»¥Ú£
()) {

154  
šv®id_¬gum’t_¡©us
(

158 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

160 ià(!
	gsysÿÎ
.
is_v®id
()) {

161  
šv®id_¬gum’t_¡©us
(

162 
ab¦
::
SŒC©
("Mes§gm®fÜmed: sy¢Ø", 
sy¢o
(), " is invalid"));

165  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

168 
	g´im™ives
::
Prim™iveStus
 
Mes§geR—d”
::
V®id©e
() const {

169 
ASYLO_RETURN_IF_ERROR
(
V®id©eMes§geH—d”
());

171 
size_t
 
	gÃxt_off£t
 = (
Mes§geH—d”
);

172 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

174 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

175 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
i
);

176 ià(!
·¿m‘”_is_u£d
(
·¿m‘”
)) {

180 ià(
h—d”
()->
	goff£t
[
i
] !ğ
Ãxt_off£t
) {

181  
šv®id_¬gum’t_¡©us
(

182 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

186 ià(
SumOv”æowOnRoundUpToMuÉËOf8
(
h—d”
()->
size
[
i
], 
Ãxt_off£t
)) {

187  
šv®id_¬gum’t_¡©us
(

188 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

192 
	gÃxt_off£t
 = 
RoundUpToMuÉËOf8
(
Ãxt_off£t
 + 
h—d”
()->
size
[
i
]);

193 ià(
	gÃxt_off£t
 > 
	gex‹Á_
.
size
()) {

194  
šv®id_¬gum’t_¡©us
(

195 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

199 ià(!
IsV®idP¬am‘”Size
(
i
)) {

200  
šv®id_¬gum’t_¡©us
(

201 
ab¦
::
SŒC©
("Mes§gm®fÜmed:…¬am‘” und” index ", 
i
,

206  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

209 
boŞ
 
	gMes§geR—d”
::
·¿m‘”_is_u£d
(
P¬am‘”DesütÜ
 
·¿m‘”
) const {

210 ià(!
·¿m‘”
.
is_v®id
()) {

211  
çl£
;

215 ià(
is_»que¡
(è&& !
	g·¿m‘”
.
is_š
()) {

216  
	gçl£
;

220 ià(
is_»¥Ú£
(è&& !
	g·¿m‘”
.
is_out
()) {

221  
	gçl£
;

224  
	gŒue
;

227 
boŞ
 
	gMes§geR—d”
::
·¿m‘”_is_u£d
(
šdex
) const {

228 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o
());

229 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
šdex
);

230  
·¿m‘”_is_u£d
(
·¿m‘”
);

233 
	gMes§geWr™”
::
Mes§geWr™”
(

234 
sy¢o
, 
ušt64_t
 
»suÉ
, 
boŞ
 
is_»que¡
,

235 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
)

236 : 
sy¢o_
(
sy¢o
),

237 
»suÉ_
(
»suÉ
),

238 
is_»que¡_
(
is_»que¡
),

239 
·¿m‘”s_
(
·¿m‘”s
) {

240 
Sy¡emC®lDesütÜ
 
	gsysÿÎ
{
	gsy¢o
};

241 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

242 
	g·¿m‘”_size_
[
i
] = 
P¬am‘”Size
(
sysÿÎ
.
·¿m‘”
(i));

246 
Mes§geWr™”
 
	gMes§geWr™”
::
Reque¡Wr™”
(

247 
sy¢o
, cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
) {

248  
Mes§geWr™”
(
sy¢o
, 0, 
Œue
, 
·¿m‘”s
);

251 
Mes§geWr™”
 
	gMes§geWr™”
::
Re¥Ú£Wr™”
(

252 
sy¢o
, 
ušt64_t
 
»suÉ
,

253 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
) {

254  
Mes§geWr™”
(
sy¢o
, 
»suÉ
, 
çl£
, 
·¿m‘”s
);

257 
size_t
 
	gMes§geWr™”
::
Mes§geSize
() const {

258 
size_t
 
»suÉ
 = (
Mes§geH—d”
);

259 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

260 
	g»suÉ
 +ğ
RoundUpToMuÉËOf8
(
·¿m‘”_size_
[
i
]);

262  
	g»suÉ
;

265 
boŞ
 
	gMes§geWr™”
::
·¿m‘”_is_u£d
(
P¬am‘”DesütÜ
 
·¿m‘”
) const {

266 ià(!
·¿m‘”
.
is_v®id
()) {

267  
çl£
;

271 ià(
is_»que¡
(è&& !
	g·¿m‘”
.
is_š
()) {

272  
	gçl£
;

276 ià(
is_»¥Ú£
(è&& !
	g·¿m‘”
.
is_out
()) {

277  
	gçl£
;

280  
	gŒue
;

283 
boŞ
 
	gMes§geWr™”
::
·¿m‘”_is_u£d
(
šdex
) const {

284 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o_
);

285 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
šdex
);

286  
·¿m‘”_is_u£d
(
·¿m‘”
);

289 
size_t
 
	gMes§geWr™”
::
P¬am‘”Size
(
P¬am‘”DesütÜ
 
·¿m‘”
) const {

290 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o_
);

293 ià(!
·¿m‘”_is_u£d
(
·¿m‘”
)) {

298 ià(
	g·¿m‘”
.
is_sÿÏr
()) {

299  (
	gušt64_t
);

302 
ušt64_t
 
	gv®ue
 = 
·¿m‘”s_
[
·¿m‘”
.
šdex
()];

305 ià(
	gv®ue
 == 0) {

309 ià(
	g·¿m‘”
.
is_fixed
()) {

310  
	g·¿m‘”
.
size
();

313 ià(
	g·¿m‘”
.
is_¡ršg
()) {

314  
¡¾’
(
»š‹½»t_ÿ¡
<cÚ¡ *>(
v®ue
)) + 1;

317 ià(
	g·¿m‘”
.
is_bounded
()) {

318  
	g·¿m‘”s_
[
·¿m‘”
.
boundšg_·¿m‘”
().
šdex
()];

322 
abÜt
();

325 
boŞ
 
	gMes§geWr™”
::
Wr™e
(
´im™ives
::
Ex‹Á
 *
mes§ge
) const {

326 autØ*
h—d”
 = 
»š‹½»t_ÿ¡
<
Mes§geH—d”
 *>(
mes§ge
->
d©a
());

327 
	gh—d”
->
	gmagic
 = 
kMes§geMagic
;

328 
	gh—d”
->
	gæags
 = 
is_»que¡_
 ? 
kSy¡emC®lReque¡
 : 
kSy¡emC®lRe¥Ú£
;

329 
	gh—d”
->
	gsy¢o
 = 
sy¢o_
;

332 ià(
is_»¥Ú£
()) {

333 
	gh—d”
->
	g»suÉ
 = 
»suÉ_
;

337 
size_t
 
	gÃxt_off£t
 = (
Mes§geH—d”
);

339 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
sy¢o_
);

340 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

341 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
i
);

342 ià(!
·¿m‘”_is_u£d
(
·¿m‘”
)) {

349 ià(
	g·¿m‘”
.
is_poš‹r
()) {

350 ià(*
	g¤c
 = 
»š‹½»t_ÿ¡
<*>(
·¿m‘”s_
[
i
])) {

351 
memıy
(
mes§ge
->
As
<
ušt8_t
>(è+ 
Ãxt_off£t
, 
¤c
, 
·¿m‘”_size_
[
i
]);

356 *
	g»š‹½»t_ÿ¡
<
	gušt64_t
 *>(
	gmes§ge
->
	gAs
<
	gušt8_t
>(è+ 
	gÃxt_off£t
) =

357 
·¿m‘”s_
[
i
];

359 
	gh—d”
->
	goff£t
[
i
] = 
Ãxt_off£t
;

360 
	gh—d”
->
	gsize
[
i
] = 
·¿m‘”_size_
[i];

361 
	gÃxt_off£t
 = 
RoundUpToMuÉËOf8
(
Ãxt_off£t
 + 
·¿m‘”_size_
[
i
]);

364  
	gŒue
;

	@platform/system_call/message.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_MESSAGE_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_MESSAGE_H_


	)

22 
	~<¬¿y
>

23 
	~<c¡ddef
>

24 
	~<¡ršg
>

26 
	~"ab¦/ba£/©Œibu‹s.h
"

27 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

28 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

29 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

35 
	gMes§geFÏgs
 : 
ušt32_t
 {

36 
kSy¡emC®lReque¡
 = 0x1,

37 
	gkSy¡emC®lRe¥Ú£
 = 0x2

41 
cÚ¡ex´
 
ušt64_t
 
	gkMes§geMagic
 = 0x1006c6163737973;

44 
	sMes§geH—d”
 {

45  
ušt64_t
 
	gmagic
;

46  
ušt32_t
 
	gæags
;

47  
ušt32_t
 
	gsy¢o
;

48  
ušt64_t
 
	g»suÉ
;

49  
ušt64_t
 
	goff£t
[
kP¬am‘”Max
];

50  
ušt64_t
 
	gsize
[
kP¬am‘”Max
];

51 } 
	gABSL_ATTRIBUTE_PACKED
;

53 
¡©ic_as£¹
(
off£tof
(
Mes§geH—d”
, 
magic
) == 0,

55 
¡©ic_as£¹
(
off£tof
(
Mes§geH—d”
, 
æags
) == 8,

57 
¡©ic_as£¹
(
off£tof
(
Mes§geH—d”
, 
sy¢o
) == 12,

59 
¡©ic_as£¹
(
off£tof
(
Mes§geH—d”
, 
»suÉ
) == 16,

61 
¡©ic_as£¹
(
off£tof
(
Mes§geH—d”
, 
off£t
) == 24,

63 
¡©ic_as£¹
(
off£tof
(
Mes§geH—d”
, 
size
) == 72,

65 
¡©ic_as£¹
((
Mes§geH—d”
) % 8 == 0,

70 şas 
	cMes§geR—d”
 {

71 
	gpublic
:

73 
ex¶ic™
 
Mes§geR—d”
(
´im™ives
::
Ex‹Á
 
ex‹Á
è: 
ex‹Á_
(extent) {}

76 cÚ¡ 
Mes§geH—d”
 *
h—d”
() const {

77  
»š‹½»t_ÿ¡
<cÚ¡ 
Mes§geH—d”
 *>(
ex‹Á_
.
d©a
());

81 
boŞ
 
is_»que¡
(ècÚ¡ {  
h—d”
()->
	gæags
 & 
	gkSy¡emC®lReque¡
; }

84 
boŞ
 
is_»¥Ú£
(ècÚ¡ {  
h—d”
()->
	gæags
 & 
	gkSy¡emC®lRe¥Ú£
; }

87 
sy¢o
(ècÚ¡ {  
h—d”
()->
	gsy¢o
; }

90 
ušt64_t
 
»suÉ
(ècÚ¡ {  
h—d”
()->
	g»suÉ
; }

93 
	g´im™ives
::
Prim™iveStus
 
V®id©e
() const;

97 
boŞ
 
·¿m‘”_is_u£d
(
šdex
) const;

101 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

102 
T
 
·¿m‘”
(
šdex
) const {

103  *
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gT
 *>(
	gex‹Á_
.
	gAs
<>(è+ 
off£t
(
šdex
));

108 
	g‹m¶©e
 <
ty³Çme
 
	gT
 = const *>

109 
T
 
·¿m‘”_add»ss
(
šdex
) const {

110  
·¿m‘”_size
(
šdex
) > 0

111 ? 
»š‹½»t_ÿ¡
<
T
>(
ex‹Á_
.
As
<>(è+ 
off£t
(
šdex
))

112 : 
T
(0);

117 
size_t
 
·¿m‘”_size
(
šdex
ècÚ¡ {  
h—d”
()->
	gsize
[index]; }

119 
	g´iv©e
:

123 
size_t
 
off£t
(
šdex
ècÚ¡ {  
h—d”
()->offset[index]; }

127 
	g´im™ives
::
Prim™iveStus
 
šv®id_¬gum’t_¡©us
(

128 cÚ¡ 
¡d
::
¡ršg
 &
»asÚ
) const;

132 
	g´im™ives
::
Prim™iveStus
 
V®id©eMes§geH—d”
() const;

136 
boŞ
 
·¿m‘”_is_u£d
(
P¬am‘”DesütÜ
 
·¿m‘”
) const;

139 
boŞ
 
IsV®idP¬am‘”Size
(
šdex
) const;

141 
	g´im™ives
::
Ex‹Á
 
ex‹Á_
;

145 şas 
	cMes§geWr™”
 {

146 
	gpublic
:

148 
Mes§geWr™”
 
Reque¡Wr™”
(

149 
sy¢o
, cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
);

152 
Mes§geWr™”
 
Re¥Ú£Wr™”
(

153 
sy¢o
, 
ušt64_t
 
»suÉ
,

154 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
);

157 
size_t
 
Mes§geSize
() const;

161 
boŞ
 
Wr™e
(
´im™ives
::
Ex‹Á
 *
mes§ge
) const;

163 
	g´iv©e
:

164 
Mes§geWr™”
(
sy¢o
, 
ušt64_t
 
»suÉ
, 
boŞ
 
is_»que¡
,

165 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
);

169 
boŞ
 
·¿m‘”_is_u£d
(
P¬am‘”DesütÜ
 
·¿m‘”
) const;

173 
boŞ
 
·¿m‘”_is_u£d
(
šdex
) const;

176 
size_t
 
P¬am‘”Size
(
P¬am‘”DesütÜ
 
·¿m‘”
) const;

178 
boŞ
 
is_»que¡
(ècÚ¡ {  
	gis_»que¡_
; }

180 
boŞ
 
is_»¥Ú£
(ècÚ¡ {  !
	gis_»que¡_
; }

182 
	gsy¢o_
;

183 
ušt64_t
 
	g»suÉ_
;

184 
boŞ
 
	gis_»que¡_
;

185 cÚ¡ 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
> 
	g·¿m‘”s_
;

186 
	g¡d
::
¬¿y
<
size_t
, 
	gkP¬am‘”Max
> 
	g·¿m‘”_size_
;

191 
	g¡d
::
¡ršg
 
FÜm©Mes§ge
(
´im™ives
::
Ex‹Á
 
ex‹Á
);

	@platform/system_call/message_test.cc

19 
	~<sys/sysÿÎ.h
>

20 
	~<sys/sock‘.h
>

22 
	~<¬¿y
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

25 
	~<ty³_Œa™s
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/ba£/ÿ¡s.h
"

33 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

37 
	gÇme¥aû
 {

39 
usšg
 
	g‹¡šg
::
SŒEq
;

40 
usšg
 
	g‹¡šg
::
Eq
;

43 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

44 
ušt64_t
 
Ca¡ToWÜd
(
T
 *
v®ue
) {

45  
	g»š‹½»t_ÿ¡
<
	gušt64_t
>(
	gv®ue
);

49 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

50 
ušt64_t
 
Ca¡ToWÜd
(
T
 
v®ue
) {

51  
	g¡©ic_ÿ¡
<
	gušt64_t
>(
	gv®ue
);

55 
ušt64_t
 
Ca¡ToWÜd
(
¡d
::
nuÎ±r_t
 
v®ue
) {  0; }

58 
CŞËùP¬am‘”s
(
ušt64_t
 *
·¿m‘”s
) {}

61 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

62 
CŞËùP¬am‘”s
(
ušt64_t
 *
·¿m‘”s
, 
T
 
fœ¡
, 
Args
 &&... 
»¡
) {

63 *
	g·¿m‘”s
 = 
Ca¡ToWÜd
(
fœ¡
);

64 
CŞËùP¬am‘”s
(
·¿m‘”s
 + 1, 
»¡
...);

68 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

69 
	g¡d
::
¡ršg
 
FÜm©Reque¡
(
sy¢o
, 
Args
 &&... 
¬gs
) {

70 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

71 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
¬gs
...);

72 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
sy¢o
, 
·¿m‘”s
);

73 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

74 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

75 
	gwr™”
.
Wr™e
(&
mes§ge
);

76  
FÜm©Mes§ge
(
mes§ge
);

80 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

81 
	g¡d
::
¡ršg
 
FÜm©Re¥Ú£
(
sy¢o
, 
ušt64_t
 
»suÉ
, 
Args
 &&... 
¬gs
) {

82 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

83 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
¬gs
...);

84 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
sy¢o
, 
»suÉ
, 
·¿m‘”s
);

85 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

86 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

87 
	gwr™”
.
Wr™e
(&
mes§ge
);

88  
FÜm©Mes§ge
(
mes§ge
);

91 
TEST
(
Mes§geTe¡
, 
Z”oP¬am‘”Te¡
) {

92 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_g‘pid
), 
SŒEq
("request: getpid()"));

93 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_g‘pid
, 1234),

94 
SŒEq
("response: getpid [returns: 1234] ()"));

97 
TEST
(
Mes§geTe¡
, 
SÿÏrInTe¡
) {

98 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_şo£
, 1234),

99 
SŒEq
("request: close(0: fd [scalar 1234])"));

100 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_şo£
, 1),

101 
SŒEq
("response: close [returns: 1] ()"));

104 
TEST
(
Mes§geTe¡
, 
SŒšgInTe¡
) {

105 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_İ’
, "foobar", 0, 0),

106 
SŒEq
("request: open(0: filename [string \"foobar\"], 1: flags "

110 
TEST
(
Mes§geTe¡
, 
NuÎPoš‹rTe¡
) {

111 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_İ’
, 
nuÎ±r
, 0, 0),

112 
SŒEq
("request: open(0: filename [nullptr], 1: flags "

114 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_g‘cwd
, 0, 
nuÎ±r
, 0),

115 
SŒEq
("response: getcwd [returns: 0] (0: buf [nullptr])"));

116 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_wr™e
, 0, 
nuÎ±r
, 0),

117 
SŒEq
("request: write(0: fd [scalar 0], 1: buf [nullptr], "

119 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_»ad
, 0, 0, 
nuÎ±r
, 0),

120 
SŒEq
("response:„ead [returns: 0] (1: buf [nullptr])"));

123 
TEST
(
Mes§geTe¡
, 
SŒšgOutTe¡
) {

124 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_g‘cwd
, 0, "foobar", 7),

125 
SŒEq
("response: getcwd [returns: 0] (0: buf [bounded 7])"));

128 
TEST
(
Mes§geTe¡
, 
FixedTe¡
) {

129 
¡©
 
	gbuf
;

130 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_¡©
, "/tmp/foo", &
buf
),

131 
SŒEq
("request: stat(0: filename [string \"/tmp/foo\"])"));

132 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_¡©
, 0, "/tmp/foo", &
buf
),

133 
SŒEq
("response: stat [returns: 0] (1: statbuf [fixed 144])"));

136 
TEST
(
Mes§geTe¡
, 
BoundedInTe¡
) {

137 
	gbuf
[1024];

138 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_wr™e
, 0, 
buf
, (buf)),

139 
SŒEq
("request: write(0: fd [scalar 0], 1: buf [bounded 1024], "

143 
TEST
(
Mes§geTe¡
, 
BoundedOutTe¡
) {

144 
	gbuf
[1024];

145 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_»ad
, 0, 0, 
buf
, (buf)),

146 
SŒEq
("response:„ead [returns: 0] (1: buf [bounded 1024])"));

149 
TEST
(
Mes§geTe¡
, 
Mes§geH—d”NÙCom¶‘eTe¡
) {

150 
ušt8_t
 *
	g»¥Ú£_bufãr
 = 
nuÎ±r
;

151 
Mes§geR—d”
 
»ad”
({
»¥Ú£_bufãr
, 0});

152 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

153 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

154 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

155 
SŒEq
("Message malformed:‚o completed header…resent"));

158 
TEST
(
Mes§geTe¡
, 
Mes§geMagicNumb”MissM©chTe¡
) {

159 
	gbuf
[1024] = "abc";

160 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

161 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

162 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

163 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

164 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

165 
	gwr™”
.
Wr™e
(&
mes§ge
);

166 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gmagic
 = -1;

167 
Mes§geR—d”
 
»ad”
(
mes§ge
);

168 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

169 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

170 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

171 
SŒEq
("Message malformed: magic‚umber mismatched"));

174 
TEST
(
Mes§geTe¡
, 
Mes§geFÏgBÙhReque¡Re¥Ú£Te¡
) {

175 
	gbuf
[1024] = "abc";

176 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

177 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

178 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

179 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

180 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

181 
	gwr™”
.
Wr™e
(&
mes§ge
);

182 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gæags
 = 0xFFFFFFFF;

183 
Mes§geR—d”
 
»ad”
(
mes§ge
);

184 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

185 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

186 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

187 
SŒEq
("Message malformed: should beƒither‡„equest or‡ "

191 
TEST
(
Mes§geTe¡
, 
Mes§geSy¡emC®lNumb”Inv®idTe¡
) {

192 
	gbuf
[1024] = "abc";

193 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

194 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

195 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

196 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

197 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

198 
	gwr™”
.
Wr™e
(&
mes§ge
);

199 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsy¢o
 = -1;

200 
Mes§geR—d”
 
»ad”
(
mes§ge
);

201 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

202 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

203 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

204 
SŒEq
(
ab¦
::
SŒC©
("Message malformed: sysno ",

208 
TEST
(
Mes§geTe¡
, 
FixedD©aSizeMissM©chTe¡
) {

209 
sockaddr
 *
	gusockaddr
 = 
nuÎ±r
;

210 
	gusockaddr_Ën
[1] = {0};

211 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

212 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
usockaddr
, 
usockaddr_Ën
);

213 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_g‘sockÇme
, 0, 
·¿m‘”s
);

214 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

215 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

216 
	gwr™”
.
Wr™e
(&
mes§ge
);

217 
Mes§geR—d”
 
»ad”
(
mes§ge
);

218 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

219 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

221 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

222 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

226 
TEST
(
Mes§geTe¡
, 
SÿÏrD©aSizeMissM©chTe¡
) {

227 *
	gbuff
 = 
nuÎ±r
;

228 
size_t
 
	gËn
 = 0;

229 
ušt32_t
 
	gæags
 = 0;

230 
sockaddr
 *
	gaddr
 = 
nuÎ±r
;

231 
	gaddr_Ën
 = 0;

232 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

233 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buff
, 
Ën
, 
æags
, 
addr
, 
addr_Ën
);

234 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_£ndto
, 0, 
·¿m‘”s
);

235 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

236 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

237 
	gwr™”
.
Wr™e
(&
mes§ge
);

238 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[1] = 1;

239 
Mes§geR—d”
 
»ad”
(
mes§ge
);

240 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

241 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

243 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

244 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

248 
TEST
(
Mes§geTe¡
, 
SŒšgD©aSizeMissM©chTe¡
) {

249 cÚ¡ *
	g·th
 = "abc\0";

250 
	gËngth
 = 3;

251 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

252 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
·th
, 
Ëngth
);

253 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
SYS_Œunÿ‹
, 
·¿m‘”s
);

254 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

255 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

256 
	gwr™”
.
Wr™e
(&
mes§ge
);

257 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[0] = 5;

258 
Mes§geR—d”
 
»ad”
(
mes§ge
);

259 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

260 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

262 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

263 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

267 
TEST
(
Mes§geTe¡
, 
NÚNuÎT”mš©edSŒšgP¬am‘”Te¡
) {

268 cÚ¡ *
	g·th
 = "abc";

269 
	gËngth
 = 3;

270 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

271 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
·th
, 
Ëngth
);

272 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
SYS_Œunÿ‹
, 
·¿m‘”s
);

273 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

274 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

275 
	gwr™”
.
Wr™e
(&
mes§ge
);

276 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[0] = 2;

277 
Mes§geR—d”
 
»ad”
(
mes§ge
);

278 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

279 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

281 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

282 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

286 
TEST
(
Mes§geTe¡
, 
Neg©iveSizeTe¡
) {

287 
	gbuf
[1024] = "abc";

288 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

289 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, 0);

290 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

291 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

292 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

293 
	gwr™”
.
Wr™e
(&
mes§ge
);

294 
Mes§geR—d”
 
»ad”
(
mes§ge
);

295 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

296 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
OK
));

299 
TEST
(
Mes§geTe¡
, 
Off£tDriáTe¡
) {

300 
	gbuf
[1024] = "abc";

301 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

302 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

303 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

304 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

305 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

306 
	gwr™”
.
Wr™e
(&
mes§ge
);

308 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	goff£t
[1] = 0;

309 
Mes§geR—d”
 
»ad”
(
mes§ge
);

310 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

311 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

312 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

313 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

317 
TEST
(
Mes§geTe¡
, 
Off£tOv”æowTe¡
) {

318 
	gbuf
[1024] = "abc";

319 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

320 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

321 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

322 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

323 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
() - 1};

324 
	gwr™”
.
Wr™e
(&
mes§ge
);

325 
Mes§geR—d”
 
»ad”
(
mes§ge
);

326 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

327 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

329 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

330 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

334 
TEST
(
Mes§geTe¡
, 
Off£tOv”æowFromUšt64Te¡
) {

335 
	gbuf
[1024] = "abc";

336 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

337 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

338 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

339 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

340 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

341 
	gwr™”
.
Wr™e
(&
mes§ge
);

343 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[1] = 
SIZE_MAX
;

344 
Mes§geR—d”
 
»ad”
(
mes§ge
);

345 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

346 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

347 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

348 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

	@platform/system_call/message_test.cc

19 
	~<sys/sysÿÎ.h
>

20 
	~<sys/sock‘.h
>

22 
	~<¬¿y
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

25 
	~<ty³_Œa™s
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/ba£/ÿ¡s.h
"

33 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

37 
	gÇme¥aû
 {

39 
usšg
 
	g‹¡šg
::
SŒEq
;

40 
usšg
 
	g‹¡šg
::
Eq
;

43 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

44 
ušt64_t
 
Ca¡ToWÜd
(
T
 *
v®ue
) {

45  
	g»š‹½»t_ÿ¡
<
	gušt64_t
>(
	gv®ue
);

49 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

50 
ušt64_t
 
Ca¡ToWÜd
(
T
 
v®ue
) {

51  
	g¡©ic_ÿ¡
<
	gušt64_t
>(
	gv®ue
);

55 
ušt64_t
 
Ca¡ToWÜd
(
¡d
::
nuÎ±r_t
 
v®ue
) {  0; }

58 
CŞËùP¬am‘”s
(
ušt64_t
 *
·¿m‘”s
) {}

61 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
	gty³Çme
... 
	gArgs
>

62 
CŞËùP¬am‘”s
(
ušt64_t
 *
·¿m‘”s
, 
T
 
fœ¡
, 
Args
 &&... 
»¡
) {

63 *
	g·¿m‘”s
 = 
Ca¡ToWÜd
(
fœ¡
);

64 
CŞËùP¬am‘”s
(
·¿m‘”s
 + 1, 
»¡
...);

68 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

69 
	g¡d
::
¡ršg
 
FÜm©Reque¡
(
sy¢o
, 
Args
 &&... 
¬gs
) {

70 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

71 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
¬gs
...);

72 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
sy¢o
, 
·¿m‘”s
);

73 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

74 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

75 
	gwr™”
.
Wr™e
(&
mes§ge
);

76  
FÜm©Mes§ge
(
mes§ge
);

80 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

81 
	g¡d
::
¡ršg
 
FÜm©Re¥Ú£
(
sy¢o
, 
ušt64_t
 
»suÉ
, 
Args
 &&... 
¬gs
) {

82 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

83 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
¬gs
...);

84 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
sy¢o
, 
»suÉ
, 
·¿m‘”s
);

85 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

86 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

87 
	gwr™”
.
Wr™e
(&
mes§ge
);

88  
FÜm©Mes§ge
(
mes§ge
);

91 
TEST
(
Mes§geTe¡
, 
Z”oP¬am‘”Te¡
) {

92 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_g‘pid
), 
SŒEq
("request: getpid()"));

93 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_g‘pid
, 1234),

94 
SŒEq
("response: getpid [returns: 1234] ()"));

97 
TEST
(
Mes§geTe¡
, 
SÿÏrInTe¡
) {

98 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_şo£
, 1234),

99 
SŒEq
("request: close(0: fd [scalar 1234])"));

100 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_şo£
, 1),

101 
SŒEq
("response: close [returns: 1] ()"));

104 
TEST
(
Mes§geTe¡
, 
SŒšgInTe¡
) {

105 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_İ’
, "foobar", 0, 0),

106 
SŒEq
("request: open(0: filename [string \"foobar\"], 1: flags "

110 
TEST
(
Mes§geTe¡
, 
NuÎPoš‹rTe¡
) {

111 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_İ’
, 
nuÎ±r
, 0, 0),

112 
SŒEq
("request: open(0: filename [nullptr], 1: flags "

114 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_g‘cwd
, 0, 
nuÎ±r
, 0),

115 
SŒEq
("response: getcwd [returns: 0] (0: buf [nullptr])"));

116 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_wr™e
, 0, 
nuÎ±r
, 0),

117 
SŒEq
("request: write(0: fd [scalar 0], 1: buf [nullptr], "

119 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_»ad
, 0, 0, 
nuÎ±r
, 0),

120 
SŒEq
("response:„ead [returns: 0] (1: buf [nullptr])"));

123 
TEST
(
Mes§geTe¡
, 
SŒšgOutTe¡
) {

124 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_g‘cwd
, 0, "foobar", 7),

125 
SŒEq
("response: getcwd [returns: 0] (0: buf [bounded 7])"));

128 
TEST
(
Mes§geTe¡
, 
FixedTe¡
) {

129 
¡©
 
	gbuf
;

130 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_¡©
, "/tmp/foo", &
buf
),

131 
SŒEq
("request: stat(0: filename [string \"/tmp/foo\"])"));

132 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_¡©
, 0, "/tmp/foo", &
buf
),

133 
SŒEq
("response: stat [returns: 0] (1: statbuf [fixed 144])"));

136 
TEST
(
Mes§geTe¡
, 
BoundedInTe¡
) {

137 
	gbuf
[1024];

138 
EXPECT_THAT
(
FÜm©Reque¡
(
SYS_wr™e
, 0, 
buf
, (buf)),

139 
SŒEq
("request: write(0: fd [scalar 0], 1: buf [bounded 1024], "

143 
TEST
(
Mes§geTe¡
, 
BoundedOutTe¡
) {

144 
	gbuf
[1024];

145 
EXPECT_THAT
(
FÜm©Re¥Ú£
(
SYS_»ad
, 0, 0, 
buf
, (buf)),

146 
SŒEq
("response:„ead [returns: 0] (1: buf [bounded 1024])"));

149 
TEST
(
Mes§geTe¡
, 
Mes§geH—d”NÙCom¶‘eTe¡
) {

150 
ušt8_t
 *
	g»¥Ú£_bufãr
 = 
nuÎ±r
;

151 
Mes§geR—d”
 
»ad”
({
»¥Ú£_bufãr
, 0});

152 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

153 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

154 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

155 
SŒEq
("Message malformed:‚o completed header…resent"));

158 
TEST
(
Mes§geTe¡
, 
Mes§geMagicNumb”MissM©chTe¡
) {

159 
	gbuf
[1024] = "abc";

160 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

161 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

162 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

163 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

164 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

165 
	gwr™”
.
Wr™e
(&
mes§ge
);

166 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gmagic
 = -1;

167 
Mes§geR—d”
 
»ad”
(
mes§ge
);

168 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

169 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

170 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

171 
SŒEq
("Message malformed: magic‚umber mismatched"));

174 
TEST
(
Mes§geTe¡
, 
Mes§geFÏgBÙhReque¡Re¥Ú£Te¡
) {

175 
	gbuf
[1024] = "abc";

176 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

177 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

178 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

179 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

180 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

181 
	gwr™”
.
Wr™e
(&
mes§ge
);

182 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gæags
 = 0xFFFFFFFF;

183 
Mes§geR—d”
 
»ad”
(
mes§ge
);

184 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

185 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

186 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

187 
SŒEq
("Message malformed: should beƒither‡„equest or‡ "

191 
TEST
(
Mes§geTe¡
, 
Mes§geSy¡emC®lNumb”Inv®idTe¡
) {

192 
	gbuf
[1024] = "abc";

193 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

194 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

195 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

196 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

197 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

198 
	gwr™”
.
Wr™e
(&
mes§ge
);

199 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsy¢o
 = -1;

200 
Mes§geR—d”
 
»ad”
(
mes§ge
);

201 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

202 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

203 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

204 
SŒEq
(
ab¦
::
SŒC©
("Message malformed: sysno ",

208 
TEST
(
Mes§geTe¡
, 
FixedD©aSizeMissM©chTe¡
) {

209 
sockaddr
 *
	gusockaddr
 = 
nuÎ±r
;

210 
	gusockaddr_Ën
[1] = {0};

211 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

212 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
usockaddr
, 
usockaddr_Ën
);

213 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_g‘sockÇme
, 0, 
·¿m‘”s
);

214 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

215 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

216 
	gwr™”
.
Wr™e
(&
mes§ge
);

217 
Mes§geR—d”
 
»ad”
(
mes§ge
);

218 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

219 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

221 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

222 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

226 
TEST
(
Mes§geTe¡
, 
SÿÏrD©aSizeMissM©chTe¡
) {

227 *
	gbuff
 = 
nuÎ±r
;

228 
size_t
 
	gËn
 = 0;

229 
ušt32_t
 
	gæags
 = 0;

230 
sockaddr
 *
	gaddr
 = 
nuÎ±r
;

231 
	gaddr_Ën
 = 0;

232 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

233 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buff
, 
Ën
, 
æags
, 
addr
, 
addr_Ën
);

234 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_£ndto
, 0, 
·¿m‘”s
);

235 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

236 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

237 
	gwr™”
.
Wr™e
(&
mes§ge
);

238 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[1] = 1;

239 
Mes§geR—d”
 
»ad”
(
mes§ge
);

240 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

241 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

243 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

244 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

248 
TEST
(
Mes§geTe¡
, 
SŒšgD©aSizeMissM©chTe¡
) {

249 cÚ¡ *
	g·th
 = "abc\0";

250 
	gËngth
 = 3;

251 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

252 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
·th
, 
Ëngth
);

253 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
SYS_Œunÿ‹
, 
·¿m‘”s
);

254 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

255 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

256 
	gwr™”
.
Wr™e
(&
mes§ge
);

257 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[0] = 5;

258 
Mes§geR—d”
 
»ad”
(
mes§ge
);

259 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

260 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

262 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

263 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

267 
TEST
(
Mes§geTe¡
, 
NÚNuÎT”mš©edSŒšgP¬am‘”Te¡
) {

268 cÚ¡ *
	g·th
 = "abc";

269 
	gËngth
 = 3;

270 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

271 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 
·th
, 
Ëngth
);

272 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
SYS_Œunÿ‹
, 
·¿m‘”s
);

273 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

274 
	g´im™ives
::
Ex‹Á
 
mes§ge
(
bufãr
.
d©a
(), bufãr.
size
());

275 
	gwr™”
.
Wr™e
(&
mes§ge
);

276 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[0] = 2;

277 
Mes§geR—d”
 
»ad”
(
mes§ge
);

278 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

279 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

281 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

282 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

286 
TEST
(
Mes§geTe¡
, 
Neg©iveSizeTe¡
) {

287 
	gbuf
[1024] = "abc";

288 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

289 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, 0);

290 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

291 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

292 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

293 
	gwr™”
.
Wr™e
(&
mes§ge
);

294 
Mes§geR—d”
 
»ad”
(
mes§ge
);

295 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

296 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
OK
));

299 
TEST
(
Mes§geTe¡
, 
Off£tDriáTe¡
) {

300 
	gbuf
[1024] = "abc";

301 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

302 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

303 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

304 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

305 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

306 
	gwr™”
.
Wr™e
(&
mes§ge
);

308 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	goff£t
[1] = 0;

309 
Mes§geR—d”
 
»ad”
(
mes§ge
);

310 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

311 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

312 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

313 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

317 
TEST
(
Mes§geTe¡
, 
Off£tOv”æowTe¡
) {

318 
	gbuf
[1024] = "abc";

319 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

320 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

321 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

322 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

323 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
() - 1};

324 
	gwr™”
.
Wr™e
(&
mes§ge
);

325 
Mes§geR—d”
 
»ad”
(
mes§ge
);

326 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

327 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

329 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

330 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

334 
TEST
(
Mes§geTe¡
, 
Off£tOv”æowFromUšt64Te¡
) {

335 
	gbuf
[1024] = "abc";

336 
	g¡d
::
¬¿y
<
ušt64_t
, 6> 
	g·¿m‘”s
;

337 
CŞËùP¬am‘”s
(&
·¿m‘”s
[0], 0, 
buf
, (buf));

338 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
SYS_»ad
, 0, 
·¿m‘”s
);

339 
	g¡d
::
veùÜ
<
ušt8_t
> 
bufãr
(
wr™”
.
Mes§geSize
());

340 
	g´im™ives
::
Ex‹Á
 
mes§ge
{
bufãr
.
d©a
(), 
	gbufãr
.
size
()};

341 
	gwr™”
.
Wr™e
(&
mes§ge
);

343 
	g»š‹½»t_ÿ¡
<
	gMes§geH—d”
 *>(
	gmes§ge
.
d©a
())->
	gsize
[1] = 
SIZE_MAX
;

344 
Mes§geR—d”
 
»ad”
(
mes§ge
);

345 
	g´im™ives
::
Prim™iveStus
 
¡©us
 = 
»ad”
.
V®id©e
();

346 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

347 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

348 
SŒEq
(
ab¦
::
SŒC©
("Message malformed:…arameter under index ",

	@platform/system_call/metadata.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

21 
	~<c¡ddef
>

22 
	~<c¡dšt
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

27 
	gÇme¥aû
 {

29 
	gP¬am‘”FÏg
 : 
ušt16_t
 {

30 
kIn
 = 1 << 0,

31 
	gkOut
 = 1 << 1,

32 
	gkUnsigÃd
 = 1 << 2,

33 
	gkSigÃd
 = 1 << 3,

34 
	gkPoš‹r
 = 1 << 4,

35 
	gkVoidPŒ
 = 1 << 5,

36 
	gkCÚ¡
 = 1 << 6,

37 
	gkSÿÏr
 = 1 << 7,

38 
	gkSŒšg
 = 1 << 8,

39 
	gkFixed
 = 1 << 9,

40 
	gkBounded
 = 1 << 10,

43 
	sSy¡emC®lTabËEÁry
 {

44 cÚ¡ *
	gÇme
;

45 cÚ¡ 
ušt8_t
 
	g·¿m‘”_couÁ
;

46 cÚ¡ 
size_t
 
	g·¿m‘”_šdex
;

49 
	sP¬am‘”TabËEÁry
 {

50 cÚ¡ *
	gÇme
;

51 cÚ¡ *
	gty³
;

52 cÚ¡ 
ušt16_t
 
	gæags
;

53 cÚ¡ 
ušt32_t
 
	gsize
;

57 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/g’”©ed_bËs.šc
"

62 
size_t
 
fšd_·¿m‘”_šdex
(
sy¢o
, 
šdex
) {

63  
	gkSy¡emC®lTabË
[
sy¢o
].
	g·¿m‘”_šdex
 + 
	gšdex
;

69 
size_t
 
fšd_·¿m‘”_æags
(
sy¢o
, 
šdex
) {

70  
	gkP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o
, 
šdex
)].
	gæags
;

75 
La¡Sy¡emC®l
(è{  
	gkSy¡emC®lTabËSize
 - 1; }

77 
boŞ
 
	gSy¡emC®lDesütÜ
::
is_v®id
() const {

78  
sy¢o_
 >ğ0 && sy¢o_ < 
kSy¡emC®lTabËSize
 &&

79 
kSy¡emC®lTabË
[
sy¢o_
].
Çme
 !ğ
nuÎ±r
;

82 
	gab¦
::
¡ršg_v›w
 
Sy¡emC®lDesütÜ
::
Çme
() const {

83  
is_v®id
(è? 
kSy¡emC®lTabË
[
sy¢o_
].
Çme
 : 
nuÎ±r
;

86 
	gSy¡emC®lDesütÜ
::
·¿m‘”_couÁ
() const {

87  
is_v®id
(è? 
kSy¡emC®lTabË
[
sy¢o_
].
·¿m‘”_couÁ
 : -1;

90 
P¬am‘”DesütÜ
 
	gSy¡emC®lDesütÜ
::
·¿m‘”
(
šdex
) const {

91  
P¬am‘”DesütÜ
{
sy¢o_
, 
	gšdex
};

94 
boŞ
 
	gP¬am‘”DesütÜ
::
is_v®id
() const {

95 
Sy¡emC®lDesütÜ
 
sysÿÎ
{
sy¢o_
};

96  
	gsysÿÎ
.
is_v®id
(è&& 
	gšdex_
 >= 0 &&

97 
šdex_
 < 
sysÿÎ
.
·¿m‘”_couÁ
();

100 
	gab¦
::
¡ršg_v›w
 
P¬am‘”DesütÜ
::
Çme
() const {

101  
is_v®id
(è? 
kP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o_
, 
šdex_
)].
	gÇme


102 : 
nuÎ±r
;

105 
	gab¦
::
¡ršg_v›w
 
P¬am‘”DesütÜ
::
ty³
() const {

106  
is_v®id
(è? 
kP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o_
, 
šdex_
)].
	gty³


107 : 
nuÎ±r
;

110 
boŞ
 
	gP¬am‘”DesütÜ
::
‹¡_æag
(
ušt32_t
 
æag
) const {

111  
is_v®id
(è&& 
fšd_·¿m‘”_æags
(
sy¢o_
, 
šdex_
è& 
	gæag
;

114 
boŞ
 
	gP¬am‘”DesütÜ
::
is_poš‹r
(ècÚ¡ {  
‹¡_æag
(
kPoš‹r
); }

116 
boŞ
 
	gP¬am‘”DesütÜ
::
is_sÿÏr
(ècÚ¡ {  
‹¡_æag
(
kSÿÏr
); }

118 
boŞ
 
	gP¬am‘”DesütÜ
::
is_sigÃd
(ècÚ¡ {  
‹¡_æag
(
kSigÃd
); }

120 
boŞ
 
	gP¬am‘”DesütÜ
::
is_unsigÃd
(ècÚ¡ {  
‹¡_æag
(
kUnsigÃd
); }

122 
boŞ
 
	gP¬am‘”DesütÜ
::
is_fixed
(ècÚ¡ {  
‹¡_æag
(
kFixed
); }

124 
boŞ
 
	gP¬am‘”DesütÜ
::
is_bounded
(ècÚ¡ {  
‹¡_æag
(
kBounded
); }

126 
boŞ
 
	gP¬am‘”DesütÜ
::
is_cÚ¡
(ècÚ¡ {  
‹¡_æag
(
kCÚ¡
); }

128 
boŞ
 
	gP¬am‘”DesütÜ
::
is_void_±r
(ècÚ¡ {  
‹¡_æag
(
kVoidPŒ
); }

130 
P¬am‘”DesütÜ
 
	gP¬am‘”DesütÜ
::
boundšg_·¿m‘”
() const {

131  
is_bounded
(è? 
P¬am‘”DesütÜ
(
sy¢o_
, 
size
())

132 : 
P¬am‘”DesütÜ
{};

135 
boŞ
 
	gP¬am‘”DesütÜ
::
is_¡ršg
(ècÚ¡ {  
‹¡_æag
(
kSŒšg
); }

137 
boŞ
 
	gP¬am‘”DesütÜ
::
is_š
(ècÚ¡ {  
‹¡_æag
(
kIn
); }

139 
boŞ
 
	gP¬am‘”DesütÜ
::
is_out
(ècÚ¡ {  
‹¡_æag
(
kOut
); }

141 
size_t
 
	gP¬am‘”DesütÜ
::
size
() const {

142  
is_v®id
(è? 
kP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o_
, 
šdex_
)].
	gsize


146 
boŞ
 
	gP¬am‘”DesütÜ
::
š_¡ršg
() const {

147  
is_š
(è&& 
fšd_·¿m‘”_æags
(
sy¢o_
, 
šdex_
è& 
	gkSŒšg
;

	@platform/system_call/metadata.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

21 
	~<c¡ddef
>

22 
	~<c¡dšt
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

27 
	gÇme¥aû
 {

29 
	gP¬am‘”FÏg
 : 
ušt16_t
 {

30 
kIn
 = 1 << 0,

31 
	gkOut
 = 1 << 1,

32 
	gkUnsigÃd
 = 1 << 2,

33 
	gkSigÃd
 = 1 << 3,

34 
	gkPoš‹r
 = 1 << 4,

35 
	gkVoidPŒ
 = 1 << 5,

36 
	gkCÚ¡
 = 1 << 6,

37 
	gkSÿÏr
 = 1 << 7,

38 
	gkSŒšg
 = 1 << 8,

39 
	gkFixed
 = 1 << 9,

40 
	gkBounded
 = 1 << 10,

43 
	sSy¡emC®lTabËEÁry
 {

44 cÚ¡ *
	gÇme
;

45 cÚ¡ 
ušt8_t
 
	g·¿m‘”_couÁ
;

46 cÚ¡ 
size_t
 
	g·¿m‘”_šdex
;

49 
	sP¬am‘”TabËEÁry
 {

50 cÚ¡ *
	gÇme
;

51 cÚ¡ *
	gty³
;

52 cÚ¡ 
ušt16_t
 
	gæags
;

53 cÚ¡ 
ušt32_t
 
	gsize
;

57 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/g’”©ed_bËs.šc
"

62 
size_t
 
fšd_·¿m‘”_šdex
(
sy¢o
, 
šdex
) {

63  
	gkSy¡emC®lTabË
[
sy¢o
].
	g·¿m‘”_šdex
 + 
	gšdex
;

69 
size_t
 
fšd_·¿m‘”_æags
(
sy¢o
, 
šdex
) {

70  
	gkP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o
, 
šdex
)].
	gæags
;

75 
La¡Sy¡emC®l
(è{  
	gkSy¡emC®lTabËSize
 - 1; }

77 
boŞ
 
	gSy¡emC®lDesütÜ
::
is_v®id
() const {

78  
sy¢o_
 >ğ0 && sy¢o_ < 
kSy¡emC®lTabËSize
 &&

79 
kSy¡emC®lTabË
[
sy¢o_
].
Çme
 !ğ
nuÎ±r
;

82 
	gab¦
::
¡ršg_v›w
 
Sy¡emC®lDesütÜ
::
Çme
() const {

83  
is_v®id
(è? 
kSy¡emC®lTabË
[
sy¢o_
].
Çme
 : 
nuÎ±r
;

86 
	gSy¡emC®lDesütÜ
::
·¿m‘”_couÁ
() const {

87  
is_v®id
(è? 
kSy¡emC®lTabË
[
sy¢o_
].
·¿m‘”_couÁ
 : -1;

90 
P¬am‘”DesütÜ
 
	gSy¡emC®lDesütÜ
::
·¿m‘”
(
šdex
) const {

91  
P¬am‘”DesütÜ
{
sy¢o_
, 
	gšdex
};

94 
boŞ
 
	gP¬am‘”DesütÜ
::
is_v®id
() const {

95 
Sy¡emC®lDesütÜ
 
sysÿÎ
{
sy¢o_
};

96  
	gsysÿÎ
.
is_v®id
(è&& 
	gšdex_
 >= 0 &&

97 
šdex_
 < 
sysÿÎ
.
·¿m‘”_couÁ
();

100 
	gab¦
::
¡ršg_v›w
 
P¬am‘”DesütÜ
::
Çme
() const {

101  
is_v®id
(è? 
kP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o_
, 
šdex_
)].
	gÇme


102 : 
nuÎ±r
;

105 
	gab¦
::
¡ršg_v›w
 
P¬am‘”DesütÜ
::
ty³
() const {

106  
is_v®id
(è? 
kP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o_
, 
šdex_
)].
	gty³


107 : 
nuÎ±r
;

110 
boŞ
 
	gP¬am‘”DesütÜ
::
‹¡_æag
(
ušt32_t
 
æag
) const {

111  
is_v®id
(è&& 
fšd_·¿m‘”_æags
(
sy¢o_
, 
šdex_
è& 
	gæag
;

114 
boŞ
 
	gP¬am‘”DesütÜ
::
is_poš‹r
(ècÚ¡ {  
‹¡_æag
(
kPoš‹r
); }

116 
boŞ
 
	gP¬am‘”DesütÜ
::
is_sÿÏr
(ècÚ¡ {  
‹¡_æag
(
kSÿÏr
); }

118 
boŞ
 
	gP¬am‘”DesütÜ
::
is_sigÃd
(ècÚ¡ {  
‹¡_æag
(
kSigÃd
); }

120 
boŞ
 
	gP¬am‘”DesütÜ
::
is_unsigÃd
(ècÚ¡ {  
‹¡_æag
(
kUnsigÃd
); }

122 
boŞ
 
	gP¬am‘”DesütÜ
::
is_fixed
(ècÚ¡ {  
‹¡_æag
(
kFixed
); }

124 
boŞ
 
	gP¬am‘”DesütÜ
::
is_bounded
(ècÚ¡ {  
‹¡_æag
(
kBounded
); }

126 
boŞ
 
	gP¬am‘”DesütÜ
::
is_cÚ¡
(ècÚ¡ {  
‹¡_æag
(
kCÚ¡
); }

128 
boŞ
 
	gP¬am‘”DesütÜ
::
is_void_±r
(ècÚ¡ {  
‹¡_æag
(
kVoidPŒ
); }

130 
P¬am‘”DesütÜ
 
	gP¬am‘”DesütÜ
::
boundšg_·¿m‘”
() const {

131  
is_bounded
(è? 
P¬am‘”DesütÜ
(
sy¢o_
, 
size
())

132 : 
P¬am‘”DesütÜ
{};

135 
boŞ
 
	gP¬am‘”DesütÜ
::
is_¡ršg
(ècÚ¡ {  
‹¡_æag
(
kSŒšg
); }

137 
boŞ
 
	gP¬am‘”DesütÜ
::
is_š
(ècÚ¡ {  
‹¡_æag
(
kIn
); }

139 
boŞ
 
	gP¬am‘”DesütÜ
::
is_out
(ècÚ¡ {  
‹¡_æag
(
kOut
); }

141 
size_t
 
	gP¬am‘”DesütÜ
::
size
() const {

142  
is_v®id
(è? 
kP¬am‘”TabË
[
fšd_·¿m‘”_šdex
(
sy¢o_
, 
šdex_
)].
	gsize


146 
boŞ
 
	gP¬am‘”DesütÜ
::
š_¡ršg
() const {

147  
is_š
(è&& 
fšd_·¿m‘”_æags
(
sy¢o_
, 
šdex_
è& 
	gkSŒšg
;

	@platform/system_call/metadata.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_METADATA_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_METADATA_H_


	)

22 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

31 
cÚ¡ex´
 
	gkP¬am‘”Max
 = 6;

34 şas 
	cP¬am‘”DesütÜ
 {

35 
	gpublic
:

37 
P¬am‘”DesütÜ
(è: 
sy¢o_
(-1), 
šdex_
(-1) {}

42 
P¬am‘”DesütÜ
(
sy¢o
, 
šdex
è: 
sy¢o_
(sy¢o), 
šdex_
(index) {}

46 
boŞ
 
is_v®id
() const;

49 
šdex
(ècÚ¡ {  
	gšdex_
; }

53 
	gab¦
::
¡ršg_v›w
 
Çme
() const;

57 
	gab¦
::
¡ršg_v›w
 
ty³
() const;

60 
boŞ
 
is_poš‹r
() const;

63 
boŞ
 
is_cÚ¡
() const;

66 
boŞ
 
is_void_±r
() const;

69 
boŞ
 
is_fixed
() const;

72 
boŞ
 
is_bounded
() const;

77 
P¬am‘”DesütÜ
 
boundšg_·¿m‘”
() const;

80 
boŞ
 
is_¡ršg
() const;

83 
boŞ
 
is_š
() const;

86 
boŞ
 
is_out
() const;

89 
boŞ
 
is_sÿÏr
() const;

92 
boŞ
 
is_sigÃd
() const;

95 
boŞ
 
is_unsigÃd
() const;

103 
size_t
 
size
() const;

106 
boŞ
 
š_¡ršg
() const;

108 
	g´iv©e
:

109 
boŞ
 
‹¡_æag
(
ušt32_t
 
æag
) const;

111 cÚ¡ 
	gsy¢o_
;

112 cÚ¡ 
	gšdex_
;

116 şas 
	cSy¡emC®lDesütÜ
 {

117 
	gpublic
:

121 
ex¶ic™
 
Sy¡emC®lDesütÜ
(
sy¢o
è: 
sy¢o_
(sysno) {}

125 
boŞ
 
is_v®id
() const;

129 
	gab¦
::
¡ršg_v›w
 
Çme
() const;

133 
·¿m‘”_couÁ
() const;

137 
P¬am‘”DesütÜ
 
·¿m‘”
(
šdex
) const;

139 
	g´iv©e
:

140 cÚ¡ 
sy¢o_
;

144 
La¡Sy¡emC®l
();

	@platform/system_call/metadata_test.cc

19 
	~<sys/sysÿÎ.h
>

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/¡ršgs/¡r_još.h
"

28 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

32 
	gÇme¥aû
 {

34 
usšg
 
	g‹¡šg
::
Eq
;

35 
usšg
 
	g‹¡šg
::
SŒEq
;

38 
	g¡d
::
¡ršg
 
Summ¬ize
(
sy¢o
) {

39 
¡d
::
¡ršg
 
»suÉ
;

40 
Sy¡emC®lDesütÜ
 
	gsysÿÎ
{
	gsy¢o
};

42 
	gab¦
::
SŒAµ’d
(&
»suÉ
, 
sysÿÎ
.
Çme
(), "/", sysÿÎ.
·¿m‘”_couÁ
());

43 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gs
(
sysÿÎ
.
·¿m‘”_couÁ
());

44 
	gi
 = 0; i < 
	gsysÿÎ
.
·¿m‘”_couÁ
(); i++) {

45 
P¬am‘”DesütÜ
 
	g·¿m
 = 
sysÿÎ
.
·¿m‘”
(
i
);

46 
	g¬gs
[
i
] = 
¡d
::
¡ršg
(
·¿m
.
Çme
());

49 ià(
	g·¿m
.
is_sÿÏr
()) {

50 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": ", 
·¿m
.
is_sigÃd
() ? "s" : "u",

51 8 * 
·¿m
.
size
());

52 } ià(
	g·¿m
.
is_poš‹r
()) {

54 ià(
	g·¿m
.
is_š
(è&&…¬am.
is_out
()) {

55 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": in/out");

56 } ià(
	g·¿m
.
is_š
()) {

57 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": in");

58 } ià(
	g·¿m
.
is_out
()) {

59 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": out");

62 ià(
	g·¿m
.
š_¡ršg
()) {

63 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], " string");

64 } ià(
	g·¿m
.
is_fixed
()) {

65 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], " fixed[", 
·¿m
.
size
(), "]");

66 } ià(
	g·¿m
.
is_bounded
()) {

67 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], " bounded[",

68 
sysÿÎ
.
·¿m‘”
(
·¿m
.
size
()).
Çme
(), "]");

73 
	gab¦
::
SŒAµ’d
(&
»suÉ
, "(", 
ab¦
::
SŒJoš
(
¬gs
, ", "), ")");

74  
	g»suÉ
;

77 
TEST
(
M‘aD©aTe¡
, 
Sª™yCheck
) {

78 
	gi
 = 0; i <ğ
La¡Sy¡emC®l
(); i++) {

79 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
i
);

80 
	gj
 = 0; j < 
	gsysÿÎ
.
·¿m‘”_couÁ
(); j++) {

81 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
j
);

84 ià(
	g·¿m‘”
.
is_bounded
()) {

85 
EXPECT_TRUE
(
·¿m‘”
.
boundšg_·¿m‘”
().
is_sÿÏr
());

89 ià(
	g·¿m‘”
.
is_cÚ¡
()) {

90 
EXPECT_FALSE
(
·¿m‘”
.
is_out
());

95 ià(
	g·¿m‘”
.
is_void_±r
()) {

96 
EXPECT_TRUE
(
·¿m‘”
.
is_bounded
(è||…¬am‘”.
is_sÿÏr
());

102 
TEST
(
M‘aD©aTe¡
, 
V®idSy¡emC®lDesütÜ
) {

103 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
is_v®id
());

104 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
Çme
().
d©a
(), 
SŒEq
("dup"));

105 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
·¿m‘”_couÁ
(), 
Eq
(1));

107 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_dup2
}.
is_v®id
());

108 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup2
}.
Çme
().
d©a
(), 
SŒEq
("dup2"));

109 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup2
}.
·¿m‘”_couÁ
(), 
Eq
(2));

111 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_dup3
}.
is_v®id
());

112 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup3
}.
Çme
().
d©a
(), 
SŒEq
("dup3"));

113 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup3
}.
·¿m‘”_couÁ
(), 
Eq
(3));

115 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_g‘uid
}.
is_v®id
());

116 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_g‘uid
}.
Çme
().
d©a
(), 
SŒEq
("getuid"));

117 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_g‘uid
}.
·¿m‘”_couÁ
(), 
Eq
(0));

119 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_»ad
}.
is_v®id
());

120 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_»ad
}.
Çme
().
d©a
(), 
SŒEq
("read"));

121 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_»ad
}.
·¿m‘”_couÁ
(), 
Eq
(3));

124 
TEST
(
M‘aD©aTe¡
, 
V®idP¬am‘”DesütÜ
) {

125 
Sy¡emC®lDesütÜ
 
	gdup
{
	gSYS_dup
};

126 
EXPECT_THAT
(
dup
.
·¿m‘”
(0).
Çme
().
d©a
(), 
SŒEq
("fildes"));

127 
EXPECT_THAT
(
dup
.
·¿m‘”
(0).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

128 
EXPECT_TRUE
(
dup
.
·¿m‘”
(0).
is_sÿÏr
());

129 
EXPECT_FALSE
(
dup
.
·¿m‘”
(0).
is_poš‹r
());

131 
Sy¡emC®lDesütÜ
 
	gdup2
{
	gSYS_dup2
};

132 
EXPECT_THAT
(
dup2
.
·¿m‘”
(0).
Çme
().
d©a
(), 
SŒEq
("oldfd"));

133 
EXPECT_THAT
(
dup2
.
·¿m‘”
(0).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

134 
EXPECT_TRUE
(
dup2
.
·¿m‘”
(0).
is_sÿÏr
());

135 
EXPECT_FALSE
(
dup2
.
·¿m‘”
(0).
is_poš‹r
());

136 
EXPECT_THAT
(
dup2
.
·¿m‘”
(1).
Çme
().
d©a
(), 
SŒEq
("newfd"));

137 
EXPECT_THAT
(
dup2
.
·¿m‘”
(1).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

138 
EXPECT_TRUE
(
dup2
.
·¿m‘”
(1).
is_sÿÏr
());

139 
EXPECT_FALSE
(
dup2
.
·¿m‘”
(1).
is_poš‹r
());

141 
Sy¡emC®lDesütÜ
 
	gdup3
{
	gSYS_dup3
};

142 
EXPECT_THAT
(
dup3
.
·¿m‘”
(0).
Çme
().
d©a
(), 
SŒEq
("oldfd"));

143 
EXPECT_THAT
(
dup3
.
·¿m‘”
(0).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

144 
EXPECT_TRUE
(
dup3
.
·¿m‘”
(0).
is_sÿÏr
());

145 
EXPECT_FALSE
(
dup3
.
·¿m‘”
(0).
is_poš‹r
());

146 
EXPECT_THAT
(
dup3
.
·¿m‘”
(1).
Çme
().
d©a
(), 
SŒEq
("newfd"));

147 
EXPECT_THAT
(
dup3
.
·¿m‘”
(1).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

148 
EXPECT_TRUE
(
dup3
.
·¿m‘”
(1).
is_sÿÏr
());

149 
EXPECT_FALSE
(
dup3
.
·¿m‘”
(1).
is_poš‹r
());

150 
EXPECT_THAT
(
dup3
.
·¿m‘”
(2).
Çme
().
d©a
(), 
SŒEq
("flags"));

151 
EXPECT_THAT
(
dup3
.
·¿m‘”
(2).
ty³
().
d©a
(), 
SŒEq
("int"));

152 
EXPECT_TRUE
(
dup3
.
·¿m‘”
(2).
is_sÿÏr
());

153 
EXPECT_FALSE
(
dup3
.
·¿m‘”
(2).
is_poš‹r
());

156 
TEST
(
M‘aD©aTe¡
, 
Inv®idSy¡emC®lDesütÜ
) {

157 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{-1}.
is_v®id
());

158 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{1000}.
is_v®id
());

159 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_»boÙ
}.
is_v®id
());

162 
TEST
(
M‘aD©aTe¡
, 
Inv®idSy¡emC®lP¬am‘”
) {

163 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{-1}.
·¿m‘”
(0).
is_v®id
());

164 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{1000}.
·¿m‘”
(0).
is_v®id
());

165 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_g‘pid
}.
·¿m‘”
(0).
is_v®id
());

166 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_»boÙ
}.
·¿m‘”
(0).
is_v®id
());

167 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
·¿m‘”
(-1).
is_v®id
());

168 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
·¿m‘”
(1).
is_v®id
());

171 
TEST
(
M‘aD©aTe¡
, 
Summ¬ize
) {

173 
EXPECT_THAT
(
Summ¬ize
(
SYS_dup
), 
SŒEq
("dup/1(fildes: u32)"));

176 
EXPECT_THAT
(
Summ¬ize
(
SYS_dup2
), 
SŒEq
("dup2/2(oldfd: u32,‚ewfd: u32)"));

179 
EXPECT_THAT
(
Summ¬ize
(
SYS_dup3
),

180 
SŒEq
("dup3/3(oldfd: u32,‚ewfd: u32, flags: s32)"));

183 
EXPECT_THAT
(
Summ¬ize
(
SYS_ü—t
),

184 
SŒEq
("creat/2(pathname: in string, mode: u16)"));

187 
EXPECT_THAT
(
Summ¬ize
(
SYS_lšk
),

188 
SŒEq
("link/2(oldname: in string,‚ewname: in string)"));

191 
EXPECT_THAT
(
Summ¬ize
(
SYS_mkdœ
),

192 
SŒEq
("mkdir/2(pathname: in string, mode: u16)"));

195 
EXPECT_THAT
(
Summ¬ize
(
SYS_»Çme
),

196 
SŒEq
("rename/2(oldname: in string,‚ewname: in string)"));

199 
EXPECT_THAT
(
Summ¬ize
(
SYS_rmdœ
), 
SŒEq
("rmdir/1(pathname: in string)"));

202 
EXPECT_THAT
(
Summ¬ize
(
SYS_symlšk
),

203 
SŒEq
("symlink/2(oldname: in string,‚ewname: in string)"));

206 
EXPECT_THAT
(
Summ¬ize
(
SYS_Œunÿ‹
),

207 
SŒEq
("truncate/2(path: in string,†ength: s64)"));

210 
EXPECT_THAT
(
Summ¬ize
(
SYS_uÆšk
), 
SŒEq
("unlink/1(pathname: in string)"));

213 
EXPECT_THAT
(

214 
Summ¬ize
(
SYS_pŞl
),

215 
SŒEq
("poll/3(ufds: in/out fixed[8],‚fds: u32,imeout_msecs: s32)"));

219 
EXPECT_THAT
(

220 
Summ¬ize
(
SYS_£Ëù
),

221 
SŒEq
("select/5(n: s32, inp: in/out fixed[128], outp: in/out fixed[128], "

225 
EXPECT_THAT
(
Summ¬ize
(
SYS_acûss
),

226 
SŒEq
("access/2(filename: in string, mode: s32)"));

229 
EXPECT_THAT
(
Summ¬ize
(
SYS_İ’
),

230 
SŒEq
("open/3(filename: in string, flags: s32, mode: u16)"));

233 
EXPECT_THAT
(
Summ¬ize
(
SYS_şo£
), 
SŒEq
("close/1(fd: u32)"));

236 
EXPECT_THAT
(
Summ¬ize
(
SYS_pe
), 
SŒEq
("pipe/1(fildes: out fixed[8])"));

239 
EXPECT_THAT
(
Summ¬ize
(
SYS_pe2
),

240 
SŒEq
("pipe2/2(fildes: out fixed[8], flags: s32)"));

243 
EXPECT_THAT
(
Summ¬ize
(
SYS_»ad
),

244 
SŒEq
("read/3(fd: u32, buf: out bounded[count], count: u64)"));

247 
EXPECT_THAT
(
Summ¬ize
(
SYS_»adlšk
),

248 
SŒEq
("readlink/3(path: in string, buf: out bounded[bufsiz], "

252 
EXPECT_THAT
(
Summ¬ize
(
SYS_chdœ
), 
SŒEq
("chdir/1(filename: in string)"));

255 
EXPECT_THAT
(
Summ¬ize
(
SYS_f¡©
),

256 
SŒEq
("fstat/2(fd: u32, statbuf: out fixed[144])"));

	@platform/system_call/metadata_test.cc

19 
	~<sys/sysÿÎ.h
>

21 
	~<¡ršg
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/¡ršgs/¡r_još.h
"

28 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

32 
	gÇme¥aû
 {

34 
usšg
 
	g‹¡šg
::
Eq
;

35 
usšg
 
	g‹¡šg
::
SŒEq
;

38 
	g¡d
::
¡ršg
 
Summ¬ize
(
sy¢o
) {

39 
¡d
::
¡ršg
 
»suÉ
;

40 
Sy¡emC®lDesütÜ
 
	gsysÿÎ
{
	gsy¢o
};

42 
	gab¦
::
SŒAµ’d
(&
»suÉ
, 
sysÿÎ
.
Çme
(), "/", sysÿÎ.
·¿m‘”_couÁ
());

43 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gs
(
sysÿÎ
.
·¿m‘”_couÁ
());

44 
	gi
 = 0; i < 
	gsysÿÎ
.
·¿m‘”_couÁ
(); i++) {

45 
P¬am‘”DesütÜ
 
	g·¿m
 = 
sysÿÎ
.
·¿m‘”
(
i
);

46 
	g¬gs
[
i
] = 
¡d
::
¡ršg
(
·¿m
.
Çme
());

49 ià(
	g·¿m
.
is_sÿÏr
()) {

50 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": ", 
·¿m
.
is_sigÃd
() ? "s" : "u",

51 8 * 
·¿m
.
size
());

52 } ià(
	g·¿m
.
is_poš‹r
()) {

54 ià(
	g·¿m
.
is_š
(è&&…¬am.
is_out
()) {

55 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": in/out");

56 } ià(
	g·¿m
.
is_š
()) {

57 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": in");

58 } ià(
	g·¿m
.
is_out
()) {

59 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], ": out");

62 ià(
	g·¿m
.
š_¡ršg
()) {

63 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], " string");

64 } ià(
	g·¿m
.
is_fixed
()) {

65 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], " fixed[", 
·¿m
.
size
(), "]");

66 } ià(
	g·¿m
.
is_bounded
()) {

67 
	gab¦
::
SŒAµ’d
(&
¬gs
[
i
], " bounded[",

68 
sysÿÎ
.
·¿m‘”
(
·¿m
.
size
()).
Çme
(), "]");

73 
	gab¦
::
SŒAµ’d
(&
»suÉ
, "(", 
ab¦
::
SŒJoš
(
¬gs
, ", "), ")");

74  
	g»suÉ
;

77 
TEST
(
M‘aD©aTe¡
, 
Sª™yCheck
) {

78 
	gi
 = 0; i <ğ
La¡Sy¡emC®l
(); i++) {

79 
Sy¡emC®lDesütÜ
 
sysÿÎ
(
i
);

80 
	gj
 = 0; j < 
	gsysÿÎ
.
·¿m‘”_couÁ
(); j++) {

81 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
sysÿÎ
.
·¿m‘”
(
j
);

84 ià(
	g·¿m‘”
.
is_bounded
()) {

85 
EXPECT_TRUE
(
·¿m‘”
.
boundšg_·¿m‘”
().
is_sÿÏr
());

89 ià(
	g·¿m‘”
.
is_cÚ¡
()) {

90 
EXPECT_FALSE
(
·¿m‘”
.
is_out
());

95 ià(
	g·¿m‘”
.
is_void_±r
()) {

96 
EXPECT_TRUE
(
·¿m‘”
.
is_bounded
(è||…¬am‘”.
is_sÿÏr
());

102 
TEST
(
M‘aD©aTe¡
, 
V®idSy¡emC®lDesütÜ
) {

103 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
is_v®id
());

104 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
Çme
().
d©a
(), 
SŒEq
("dup"));

105 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
·¿m‘”_couÁ
(), 
Eq
(1));

107 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_dup2
}.
is_v®id
());

108 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup2
}.
Çme
().
d©a
(), 
SŒEq
("dup2"));

109 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup2
}.
·¿m‘”_couÁ
(), 
Eq
(2));

111 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_dup3
}.
is_v®id
());

112 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup3
}.
Çme
().
d©a
(), 
SŒEq
("dup3"));

113 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_dup3
}.
·¿m‘”_couÁ
(), 
Eq
(3));

115 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_g‘uid
}.
is_v®id
());

116 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_g‘uid
}.
Çme
().
d©a
(), 
SŒEq
("getuid"));

117 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_g‘uid
}.
·¿m‘”_couÁ
(), 
Eq
(0));

119 
EXPECT_TRUE
(
Sy¡emC®lDesütÜ
{
SYS_»ad
}.
is_v®id
());

120 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_»ad
}.
Çme
().
d©a
(), 
SŒEq
("read"));

121 
EXPECT_THAT
(
Sy¡emC®lDesütÜ
{
SYS_»ad
}.
·¿m‘”_couÁ
(), 
Eq
(3));

124 
TEST
(
M‘aD©aTe¡
, 
V®idP¬am‘”DesütÜ
) {

125 
Sy¡emC®lDesütÜ
 
	gdup
{
	gSYS_dup
};

126 
EXPECT_THAT
(
dup
.
·¿m‘”
(0).
Çme
().
d©a
(), 
SŒEq
("fildes"));

127 
EXPECT_THAT
(
dup
.
·¿m‘”
(0).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

128 
EXPECT_TRUE
(
dup
.
·¿m‘”
(0).
is_sÿÏr
());

129 
EXPECT_FALSE
(
dup
.
·¿m‘”
(0).
is_poš‹r
());

131 
Sy¡emC®lDesütÜ
 
	gdup2
{
	gSYS_dup2
};

132 
EXPECT_THAT
(
dup2
.
·¿m‘”
(0).
Çme
().
d©a
(), 
SŒEq
("oldfd"));

133 
EXPECT_THAT
(
dup2
.
·¿m‘”
(0).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

134 
EXPECT_TRUE
(
dup2
.
·¿m‘”
(0).
is_sÿÏr
());

135 
EXPECT_FALSE
(
dup2
.
·¿m‘”
(0).
is_poš‹r
());

136 
EXPECT_THAT
(
dup2
.
·¿m‘”
(1).
Çme
().
d©a
(), 
SŒEq
("newfd"));

137 
EXPECT_THAT
(
dup2
.
·¿m‘”
(1).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

138 
EXPECT_TRUE
(
dup2
.
·¿m‘”
(1).
is_sÿÏr
());

139 
EXPECT_FALSE
(
dup2
.
·¿m‘”
(1).
is_poš‹r
());

141 
Sy¡emC®lDesütÜ
 
	gdup3
{
	gSYS_dup3
};

142 
EXPECT_THAT
(
dup3
.
·¿m‘”
(0).
Çme
().
d©a
(), 
SŒEq
("oldfd"));

143 
EXPECT_THAT
(
dup3
.
·¿m‘”
(0).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

144 
EXPECT_TRUE
(
dup3
.
·¿m‘”
(0).
is_sÿÏr
());

145 
EXPECT_FALSE
(
dup3
.
·¿m‘”
(0).
is_poš‹r
());

146 
EXPECT_THAT
(
dup3
.
·¿m‘”
(1).
Çme
().
d©a
(), 
SŒEq
("newfd"));

147 
EXPECT_THAT
(
dup3
.
·¿m‘”
(1).
ty³
().
d©a
(), 
SŒEq
("unsigned int"));

148 
EXPECT_TRUE
(
dup3
.
·¿m‘”
(1).
is_sÿÏr
());

149 
EXPECT_FALSE
(
dup3
.
·¿m‘”
(1).
is_poš‹r
());

150 
EXPECT_THAT
(
dup3
.
·¿m‘”
(2).
Çme
().
d©a
(), 
SŒEq
("flags"));

151 
EXPECT_THAT
(
dup3
.
·¿m‘”
(2).
ty³
().
d©a
(), 
SŒEq
("int"));

152 
EXPECT_TRUE
(
dup3
.
·¿m‘”
(2).
is_sÿÏr
());

153 
EXPECT_FALSE
(
dup3
.
·¿m‘”
(2).
is_poš‹r
());

156 
TEST
(
M‘aD©aTe¡
, 
Inv®idSy¡emC®lDesütÜ
) {

157 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{-1}.
is_v®id
());

158 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{1000}.
is_v®id
());

159 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_»boÙ
}.
is_v®id
());

162 
TEST
(
M‘aD©aTe¡
, 
Inv®idSy¡emC®lP¬am‘”
) {

163 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{-1}.
·¿m‘”
(0).
is_v®id
());

164 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{1000}.
·¿m‘”
(0).
is_v®id
());

165 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_g‘pid
}.
·¿m‘”
(0).
is_v®id
());

166 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_»boÙ
}.
·¿m‘”
(0).
is_v®id
());

167 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
·¿m‘”
(-1).
is_v®id
());

168 
EXPECT_FALSE
(
Sy¡emC®lDesütÜ
{
SYS_dup
}.
·¿m‘”
(1).
is_v®id
());

171 
TEST
(
M‘aD©aTe¡
, 
Summ¬ize
) {

173 
EXPECT_THAT
(
Summ¬ize
(
SYS_dup
), 
SŒEq
("dup/1(fildes: u32)"));

176 
EXPECT_THAT
(
Summ¬ize
(
SYS_dup2
), 
SŒEq
("dup2/2(oldfd: u32,‚ewfd: u32)"));

179 
EXPECT_THAT
(
Summ¬ize
(
SYS_dup3
),

180 
SŒEq
("dup3/3(oldfd: u32,‚ewfd: u32, flags: s32)"));

183 
EXPECT_THAT
(
Summ¬ize
(
SYS_ü—t
),

184 
SŒEq
("creat/2(pathname: in string, mode: u16)"));

187 
EXPECT_THAT
(
Summ¬ize
(
SYS_lšk
),

188 
SŒEq
("link/2(oldname: in string,‚ewname: in string)"));

191 
EXPECT_THAT
(
Summ¬ize
(
SYS_mkdœ
),

192 
SŒEq
("mkdir/2(pathname: in string, mode: u16)"));

195 
EXPECT_THAT
(
Summ¬ize
(
SYS_»Çme
),

196 
SŒEq
("rename/2(oldname: in string,‚ewname: in string)"));

199 
EXPECT_THAT
(
Summ¬ize
(
SYS_rmdœ
), 
SŒEq
("rmdir/1(pathname: in string)"));

202 
EXPECT_THAT
(
Summ¬ize
(
SYS_symlšk
),

203 
SŒEq
("symlink/2(oldname: in string,‚ewname: in string)"));

206 
EXPECT_THAT
(
Summ¬ize
(
SYS_Œunÿ‹
),

207 
SŒEq
("truncate/2(path: in string,†ength: s64)"));

210 
EXPECT_THAT
(
Summ¬ize
(
SYS_uÆšk
), 
SŒEq
("unlink/1(pathname: in string)"));

213 
EXPECT_THAT
(

214 
Summ¬ize
(
SYS_pŞl
),

215 
SŒEq
("poll/3(ufds: in/out fixed[8],‚fds: u32,imeout_msecs: s32)"));

219 
EXPECT_THAT
(

220 
Summ¬ize
(
SYS_£Ëù
),

221 
SŒEq
("select/5(n: s32, inp: in/out fixed[128], outp: in/out fixed[128], "

225 
EXPECT_THAT
(
Summ¬ize
(
SYS_acûss
),

226 
SŒEq
("access/2(filename: in string, mode: s32)"));

229 
EXPECT_THAT
(
Summ¬ize
(
SYS_İ’
),

230 
SŒEq
("open/3(filename: in string, flags: s32, mode: u16)"));

233 
EXPECT_THAT
(
Summ¬ize
(
SYS_şo£
), 
SŒEq
("close/1(fd: u32)"));

236 
EXPECT_THAT
(
Summ¬ize
(
SYS_pe
), 
SŒEq
("pipe/1(fildes: out fixed[8])"));

239 
EXPECT_THAT
(
Summ¬ize
(
SYS_pe2
),

240 
SŒEq
("pipe2/2(fildes: out fixed[8], flags: s32)"));

243 
EXPECT_THAT
(
Summ¬ize
(
SYS_»ad
),

244 
SŒEq
("read/3(fd: u32, buf: out bounded[count], count: u64)"));

247 
EXPECT_THAT
(
Summ¬ize
(
SYS_»adlšk
),

248 
SŒEq
("readlink/3(path: in string, buf: out bounded[bufsiz], "

252 
EXPECT_THAT
(
Summ¬ize
(
SYS_chdœ
), 
SŒEq
("chdir/1(filename: in string)"));

255 
EXPECT_THAT
(
Summ¬ize
(
SYS_f¡©
),

256 
SŒEq
("fstat/2(fd: u32, statbuf: out fixed[144])"));

	@platform/system_call/serialize.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

21 
	~<®gÜ™hm
>

22 
	~<c¡ddef
>

23 
	~<num”ic
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

27 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

31 
	gÇme¥aû
 {

34 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

35 
ty³Çme
 
	gT
::
v®ue_ty³
 
Sum
(cÚ¡ 
T
 &
v®ues
) {

36  
¡d
::
accumuÏ‹
(
v®ues
.
begš
(), v®ues.
’d
(),

37 
¡©ic_ÿ¡
<
ty³Çme
 
T
::
v®ue_ty³
>(0));

41 
	g´im™ives
::
Prim™iveStus
 
S”ŸlizeReque¡
(

42 
sy¢o
, cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
,

43 
´im™ives
::
Ex‹Á
 *
»que¡
,

44 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»que¡_®loÿtÜ
) {

45 
Sy¡emC®lDesütÜ
 
desütÜ
{
sy¢o
};

46 ià(!
	gdesütÜ
.
is_v®id
()) {

47  
	g´im™ives
::
Prim™iveStus
{

48 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

49 
	gab¦
::
SŒC©
("Could‚ot infer system call descriptor fromhe sysno (",

50 
sy¢o
, ")…rovided.")};

53 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
sy¢o
, 
·¿m‘”s
);

54 
size_t
 
	gsize
 = 
wr™”
.
Mes§geSize
();

56 ià(
	g»que¡_®loÿtÜ
 =ğ
nuÎ±r
) {

57 *
»que¡
 = {
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(
size
)), size};

59 *
	g»que¡
 = 
»que¡_®loÿtÜ
(
size
);

62 
	gwr™”
.
Wr™e
(
»que¡
);

63  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

66 
	g´im™ives
::
Prim™iveStus
 
S”ŸlizeRe¥Ú£
(

67 
sy¢o
, 
ušt64_t
 
»suÉ
,

68 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
,

69 
´im™ives
::
Ex‹Á
 *
»¥Ú£
,

70 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»¥Ú£_®loÿtÜ
) {

71 
Sy¡emC®lDesütÜ
 
desütÜ
{
sy¢o
};

73 ià(!
	gdesütÜ
.
is_v®id
()) {

74  
	g´im™ives
::
Prim™iveStus
{

75 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 
	gab¦
::
SŒC©
("Could‚ot infer system call descriptor fromhe sysno (",

77 
sy¢o
, ")…rovided.")};

80 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
sy¢o
, 
»suÉ
, 
·¿m‘”s
);

81 
size_t
 
	gsize
 = 
wr™”
.
Mes§geSize
();

83 ià(
	g»¥Ú£_®loÿtÜ
 =ğ
nuÎ±r
) {

84 *
»¥Ú£
 = {
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(
size
)), size};

86 *
	g»¥Ú£
 = 
»¥Ú£_®loÿtÜ
(
size
);

89 
	gwr™”
.
Wr™e
(
»¥Ú£
);

90  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

	@platform/system_call/serialize.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

21 
	~<®gÜ™hm
>

22 
	~<c¡ddef
>

23 
	~<num”ic
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

27 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

31 
	gÇme¥aû
 {

34 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

35 
ty³Çme
 
	gT
::
v®ue_ty³
 
Sum
(cÚ¡ 
T
 &
v®ues
) {

36  
¡d
::
accumuÏ‹
(
v®ues
.
begš
(), v®ues.
’d
(),

37 
¡©ic_ÿ¡
<
ty³Çme
 
T
::
v®ue_ty³
>(0));

41 
	g´im™ives
::
Prim™iveStus
 
S”ŸlizeReque¡
(

42 
sy¢o
, cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
,

43 
´im™ives
::
Ex‹Á
 *
»que¡
,

44 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»que¡_®loÿtÜ
) {

45 
Sy¡emC®lDesütÜ
 
desütÜ
{
sy¢o
};

46 ià(!
	gdesütÜ
.
is_v®id
()) {

47  
	g´im™ives
::
Prim™iveStus
{

48 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

49 
	gab¦
::
SŒC©
("Could‚ot infer system call descriptor fromhe sysno (",

50 
sy¢o
, ")…rovided.")};

53 autØ
	gwr™”
 = 
Mes§geWr™”
::
Reque¡Wr™”
(
sy¢o
, 
·¿m‘”s
);

54 
size_t
 
	gsize
 = 
wr™”
.
Mes§geSize
();

56 ià(
	g»que¡_®loÿtÜ
 =ğ
nuÎ±r
) {

57 *
»que¡
 = {
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(
size
)), size};

59 *
	g»que¡
 = 
»que¡_®loÿtÜ
(
size
);

62 
	gwr™”
.
Wr™e
(
»que¡
);

63  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

66 
	g´im™ives
::
Prim™iveStus
 
S”ŸlizeRe¥Ú£
(

67 
sy¢o
, 
ušt64_t
 
»suÉ
,

68 cÚ¡ 
¡d
::
¬¿y
<
ušt64_t
, 
kP¬am‘”Max
> &
·¿m‘”s
,

69 
´im™ives
::
Ex‹Á
 *
»¥Ú£
,

70 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»¥Ú£_®loÿtÜ
) {

71 
Sy¡emC®lDesütÜ
 
desütÜ
{
sy¢o
};

73 ià(!
	gdesütÜ
.
is_v®id
()) {

74  
	g´im™ives
::
Prim™iveStus
{

75 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 
	gab¦
::
SŒC©
("Could‚ot infer system call descriptor fromhe sysno (",

77 
sy¢o
, ")…rovided.")};

80 autØ
	gwr™”
 = 
Mes§geWr™”
::
Re¥Ú£Wr™”
(
sy¢o
, 
»suÉ
, 
·¿m‘”s
);

81 
size_t
 
	gsize
 = 
wr™”
.
Mes§geSize
();

83 ià(
	g»¥Ú£_®loÿtÜ
 =ğ
nuÎ±r
) {

84 *
»¥Ú£
 = {
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(
size
)), size};

86 *
	g»¥Ú£
 = 
»¥Ú£_®loÿtÜ
(
size
);

89 
	gwr™”
.
Wr™e
(
»¥Ú£
);

90  
	g´im™ives
::
Prim™iveStus
::
OkStus
();

	@platform/system_call/serialize.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_SERIALIZE_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_SERIALIZE_H_


	)

22 
	~<¬¿y
>

23 
	~<c¡dšt
>

25 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

32 
usšg
 
	gP¬am‘”Li¡
 = 
¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
>;

38 
	g´im™ives
::
Prim™iveStus
 
S”ŸlizeReque¡
(

39 
sy¢o
, cÚ¡ 
P¬am‘”Li¡
 &
·¿m‘”s
, 
´im™ives
::
Ex‹Á
 *
»que¡
,

40 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»que¡_®loÿtÜ
 = 
nuÎ±r
);

46 
	g´im™ives
::
Prim™iveStus
 
S”ŸlizeRe¥Ú£
(

47 
sy¢o
, 
ušt64_t
 
»suÉ
, cÚ¡ 
P¬am‘”Li¡
 &
·¿m‘”s
,

48 
´im™ives
::
Ex‹Á
 *
»¥Ú£
,

49 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»¥Ú£_®loÿtÜ
 = 
nuÎ±r
);

	@platform/system_call/serialize_test.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

26 
	gÇme¥aû
 {

28 
usšg
 
	g‹¡šg
::
Eq
;

29 
usšg
 
	g‹¡šg
::
SŒEq
;

31 
TEST
(
S”ŸlizeTe¡
, 
S”ŸlizeReque¡Inv®idSy¢oTe¡
) {

32 cÚ¡ 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
> 
	g·¿m‘”s
 =

33 
¡d
::
¬¿y
<
ušt64_t
, 6>();

34 
	g´im™ives
::
Prim™iveStus
 
¡©us
 =

35 
S”ŸlizeReque¡
(10000, 
·¿m‘”s
, 
nuÎ±r
);

37 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

38 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

39 
SŒEq
(
ab¦
::
SŒC©
(

44 
TEST
(
S”ŸlizeTe¡
, 
S”ŸlizeRe¥Ú£Inv®idSy¢oTe¡
) {

45 cÚ¡ 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
> 
	g·¿m‘”s
 =

46 
¡d
::
¬¿y
<
ušt64_t
, 6>();

47 
	g´im™ives
::
Prim™iveStus
 
¡©us
 =

48 
S”ŸlizeRe¥Ú£
(10000, 0, 
·¿m‘”s
, 
nuÎ±r
);

50 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

51 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

52 
SŒEq
(
ab¦
::
SŒC©
(

	@platform/system_call/serialize_test.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

26 
	gÇme¥aû
 {

28 
usšg
 
	g‹¡šg
::
Eq
;

29 
usšg
 
	g‹¡šg
::
SŒEq
;

31 
TEST
(
S”ŸlizeTe¡
, 
S”ŸlizeReque¡Inv®idSy¢oTe¡
) {

32 cÚ¡ 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
> 
	g·¿m‘”s
 =

33 
¡d
::
¬¿y
<
ušt64_t
, 6>();

34 
	g´im™ives
::
Prim™iveStus
 
¡©us
 =

35 
S”ŸlizeReque¡
(10000, 
·¿m‘”s
, 
nuÎ±r
);

37 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

38 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

39 
SŒEq
(
ab¦
::
SŒC©
(

44 
TEST
(
S”ŸlizeTe¡
, 
S”ŸlizeRe¥Ú£Inv®idSy¢oTe¡
) {

45 cÚ¡ 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
> 
	g·¿m‘”s
 =

46 
¡d
::
¬¿y
<
ušt64_t
, 6>();

47 
	g´im™ives
::
Prim™iveStus
 
¡©us
 =

48 
S”ŸlizeRe¥Ú£
(10000, 0, 
·¿m‘”s
, 
nuÎ±r
);

50 
EXPECT_THAT
(
¡©us
.
”rÜ_code
(), 
Eq
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

51 
EXPECT_THAT
(
¡©us
.
”rÜ_mes§ge
(),

52 
SŒEq
(
ab¦
::
SŒC©
(

	@platform/system_call/system_call.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¡em_ÿÎ.h
"

21 
	~<¬¿y
>

22 
	~<c¡d¬g
>

23 
	~<c¡dšt
>

24 
	~<memÜy
>

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

27 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

29 
	gÇme¥aû
 {

32 
	sM®locD–‘”
 {

33 
İ”©Ü
()(
ušt8_t
 *
	gbufãr
è{ 
ä“
(
bufãr
); }

36 
sysÿÎ_di¥©ch_ÿÎback
 
	gglob®_sysÿÎ_ÿÎback
 = 
nuÎ±r
;

40 "C" 
	$’c_£t_di¥©ch_sysÿÎ
(
sysÿÎ_di¥©ch_ÿÎback
 
ÿÎback
) {

41 
glob®_sysÿÎ_ÿÎback
 = 
ÿÎback
;

42 
	}
}

44 "C" 
št64_t
 
	$’c_uÁru¡ed_sysÿÎ
(
sy¢o
, ...) {

45 
asylo
::
sy¡em_ÿÎ
::
Sy¡emC®lDesütÜ
 
desütÜ
{
sy¢o
};

46 ià(!
desütÜ
.
	`is_v®id
()) {

47 
	`abÜt
();

51 
¡d
::
¬¿y
<
ušt64_t
, 
asylo
::
sy¡em_ÿÎ
::
kP¬am‘”Max
> 
·¿m‘”s
;

52 
va_li¡
 
¬gs
;

53 
	`va_¡¬t
(
¬gs
, 
sy¢o
);

54 
i
 = 0; i < 
desütÜ
.
	`·¿m‘”_couÁ
(); i++) {

55 
·¿m‘”s
[
i
] = 
	`va_¬g
(
¬gs
, 
ušt64_t
);

57 
	`va_’d
(
¬gs
);

60 
asylo
::
´im™ives
::
Ex‹Á
 
»que¡
;

61 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
;

62 
¡©us
 = 
asylo
::
sy¡em_ÿÎ
::
	`S”ŸlizeReque¡
(
sy¢o
, 
·¿m‘”s
, &
»que¡
);

63 ià(!
¡©us
.
	`ok
()) {

64 
	`abÜt
();

67 
¡d
::
unique_±r
<
ušt8_t
, 
M®locD–‘”
> 
	`»que¡_owÃr
(
»que¡
.
As
<uint8_t>());

70 
ušt8_t
 *
»¥Ú£_bufãr
;

71 
size_t
 
»¥Ú£_size
;

73 
¡©us
 = 
	`glob®_sysÿÎ_ÿÎback
(
»que¡
.
As
<
ušt8_t
>(),„eque¡.
	`size
(),

74 &
»¥Ú£_bufãr
, &
»¥Ú£_size
);

75 ià(!
¡©us
.
	`ok
()) {

76 
	`abÜt
();

79 
¡d
::
unique_±r
<
ušt8_t
, 
M®locD–‘”
> 
	`»¥Ú£_owÃr
(
»¥Ú£_bufãr
);

81 ià(!
»¥Ú£_bufãr
) {

82 
	`abÜt
();

86 autØ
»¥Ú£_»ad”
 =

87 
asylo
::
sy¡em_ÿÎ
::
	`Mes§geR—d”
({
»¥Ú£_bufãr
, 
»¥Ú£_size
});

88 cÚ¡ 
asylo
::
´im™ives
::
Prim™iveStus
 
»¥Ú£_¡©us
 =

89 
»¥Ú£_»ad”
.
	`V®id©e
();

90 ià(!
»¥Ú£_¡©us
.
	`ok
()) {

91 
	`abÜt
();

94 
i
 = 0; i < 
asylo
::
sy¡em_ÿÎ
::
kP¬am‘”Max
; i++) {

95 
asylo
::
sy¡em_ÿÎ
::
P¬am‘”DesütÜ
 
·¿m‘”
 = 
desütÜ
.
	`·¿m‘”
(
i
);

96 ià(
·¿m‘”
.
	`is_out
()) {

97 
size_t
 
size
;

98 ià(
·¿m‘”
.
	`is_fixed
()) {

99 
size
 = 
·¿m‘”
.
	`size
();

101 
size
 = 
·¿m‘”s
[
·¿m‘”
.
	`size
()];

103 cÚ¡ *
¤c
 = 
»¥Ú£_»ad”
.
	`·¿m‘”_add»ss
(
i
);

104 *
d¡
 = 
»š‹½»t_ÿ¡
<*>(
·¿m‘”s
[
i
]);

105 
	`memıy
(
d¡
, 
¤c
, 
size
);

109 
ušt64_t
 
»suÉ
 = 
»¥Ú£_»ad”
.
	`h—d”
()->result;

110  
»suÉ
;

111 
	}
}

	@platform/system_call/system_call.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¡em_ÿÎ.h
"

21 
	~<¬¿y
>

22 
	~<c¡d¬g
>

23 
	~<c¡dšt
>

24 
	~<memÜy
>

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

27 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

29 
	gÇme¥aû
 {

32 
	sM®locD–‘”
 {

33 
İ”©Ü
()(
ušt8_t
 *
	gbufãr
è{ 
ä“
(
bufãr
); }

36 
sysÿÎ_di¥©ch_ÿÎback
 
	gglob®_sysÿÎ_ÿÎback
 = 
nuÎ±r
;

40 "C" 
	$’c_£t_di¥©ch_sysÿÎ
(
sysÿÎ_di¥©ch_ÿÎback
 
ÿÎback
) {

41 
glob®_sysÿÎ_ÿÎback
 = 
ÿÎback
;

42 
	}
}

44 "C" 
št64_t
 
	$’c_uÁru¡ed_sysÿÎ
(
sy¢o
, ...) {

45 
asylo
::
sy¡em_ÿÎ
::
Sy¡emC®lDesütÜ
 
desütÜ
{
sy¢o
};

46 ià(!
desütÜ
.
	`is_v®id
()) {

47 
	`abÜt
();

51 
¡d
::
¬¿y
<
ušt64_t
, 
asylo
::
sy¡em_ÿÎ
::
kP¬am‘”Max
> 
·¿m‘”s
;

52 
va_li¡
 
¬gs
;

53 
	`va_¡¬t
(
¬gs
, 
sy¢o
);

54 
i
 = 0; i < 
desütÜ
.
	`·¿m‘”_couÁ
(); i++) {

55 
·¿m‘”s
[
i
] = 
	`va_¬g
(
¬gs
, 
ušt64_t
);

57 
	`va_’d
(
¬gs
);

60 
asylo
::
´im™ives
::
Ex‹Á
 
»que¡
;

61 
asylo
::
´im™ives
::
Prim™iveStus
 
¡©us
;

62 
¡©us
 = 
asylo
::
sy¡em_ÿÎ
::
	`S”ŸlizeReque¡
(
sy¢o
, 
·¿m‘”s
, &
»que¡
);

63 ià(!
¡©us
.
	`ok
()) {

64 
	`abÜt
();

67 
¡d
::
unique_±r
<
ušt8_t
, 
M®locD–‘”
> 
	`»que¡_owÃr
(
»que¡
.
As
<uint8_t>());

70 
ušt8_t
 *
»¥Ú£_bufãr
;

71 
size_t
 
»¥Ú£_size
;

73 
¡©us
 = 
	`glob®_sysÿÎ_ÿÎback
(
»que¡
.
As
<
ušt8_t
>(),„eque¡.
	`size
(),

74 &
»¥Ú£_bufãr
, &
»¥Ú£_size
);

75 ià(!
¡©us
.
	`ok
()) {

76 
	`abÜt
();

79 
¡d
::
unique_±r
<
ušt8_t
, 
M®locD–‘”
> 
	`»¥Ú£_owÃr
(
»¥Ú£_bufãr
);

81 ià(!
»¥Ú£_bufãr
) {

82 
	`abÜt
();

86 autØ
»¥Ú£_»ad”
 =

87 
asylo
::
sy¡em_ÿÎ
::
	`Mes§geR—d”
({
»¥Ú£_bufãr
, 
»¥Ú£_size
});

88 cÚ¡ 
asylo
::
´im™ives
::
Prim™iveStus
 
»¥Ú£_¡©us
 =

89 
»¥Ú£_»ad”
.
	`V®id©e
();

90 ià(!
»¥Ú£_¡©us
.
	`ok
()) {

91 
	`abÜt
();

94 
i
 = 0; i < 
asylo
::
sy¡em_ÿÎ
::
kP¬am‘”Max
; i++) {

95 
asylo
::
sy¡em_ÿÎ
::
P¬am‘”DesütÜ
 
·¿m‘”
 = 
desütÜ
.
	`·¿m‘”
(
i
);

96 ià(
·¿m‘”
.
	`is_out
()) {

97 
size_t
 
size
;

98 ià(
·¿m‘”
.
	`is_fixed
()) {

99 
size
 = 
·¿m‘”
.
	`size
();

101 
size
 = 
·¿m‘”s
[
·¿m‘”
.
	`size
()];

103 cÚ¡ *
¤c
 = 
»¥Ú£_»ad”
.
	`·¿m‘”_add»ss
(
i
);

104 *
d¡
 = 
»š‹½»t_ÿ¡
<*>(
·¿m‘”s
[
i
]);

105 
	`memıy
(
d¡
, 
¤c
, 
size
);

109 
ušt64_t
 
»suÉ
 = 
»¥Ú£_»ad”
.
	`h—d”
()->result;

110  
»suÉ
;

111 
	}
}

	@platform/system_call/system_call.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_SYSTEM_CALL_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_SYSTEM_CALL_H_


	)

22 
	~<c¡ddef
>

23 
	~<c¡dšt
>

24 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

26 #ifdeà
__ılu¥lus


35 
asylo
::
	t´im™ives
::
	tPrim™iveStus
 (*
	tsysÿÎ_di¥©ch_ÿÎback
)(

36 cÚ¡ 
	tušt8_t
 *
	t»que¡_bufãr
, 
	tsize_t
 
	t»que¡_size
,

37 
	tušt8_t
 **
	t»¥Ú£_bufãr
, 
	tsize_t
 *
	t»¥Ú£_size
);

40 
’c_£t_di¥©ch_sysÿÎ
(
sysÿÎ_di¥©ch_ÿÎback
 
ÿÎback
);

44 
št64_t
 
’c_uÁru¡ed_sysÿÎ
(
sy¢o
, ...);

46 #ifdeà
__ılu¥lus


	@platform/system_call/system_call_message_fuzzer.cc

19 
	~<¡ddef.h
>

20 
	~<¡dšt.h
>

22 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

26 
	gÇme¥aû
 {

31 "C" 
LLVMFuzz”Te¡OÃIÅut
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
size
) {

32 
Mes§geR—d”
 
»ad”
({
d©a
, 
size
});

33 ià(
»ad”
.
V®id©e
().
ok
()) {

34 
FÜm©Mes§ge
(
´im™ives
::
Ex‹Á
(
d©a
, 
size
));

	@platform/system_call/system_call_message_fuzzer.cc

19 
	~<¡ddef.h
>

20 
	~<¡dšt.h
>

22 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/mes§ge.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

26 
	gÇme¥aû
 {

31 "C" 
LLVMFuzz”Te¡OÃIÅut
(cÚ¡ 
ušt8_t
 *
d©a
, 
size_t
 
size
) {

32 
Mes§geR—d”
 
»ad”
({
d©a
, 
size
});

33 ià(
»ad”
.
V®id©e
().
ok
()) {

34 
FÜm©Mes§ge
(
´im™ives
::
Ex‹Á
(
d©a
, 
size
));

	@platform/system_call/system_call_test.cc

19 
	~<fú.h
>

20 
	~<sys/¡©.h
>

21 
	~<sys/sysÿÎ.h
>

22 
	~<sys/ty³s.h
>

23 
	~<uni¡d.h
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

32 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¢o.h
"

33 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¡em_ÿÎ.h
"

34 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/uÁru¡ed_švoke.h
"

35 
	~"asylo/‹¡/ut/‹¡_æags.h
"

36 
	~"asylo/ut/¡©us_maüos.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

40 
	gÇme¥aû
 {

42 
usšg
 
	g‹¡šg
::
Eq
;

43 
usšg
 
	g‹¡šg
::
SŒEq
;

46 
	gasylo
::
´im™ives
::
Prim™iveStus
 
Sy¡emC®lDi¥©ch”
(

47 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

48 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

49 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

51 
ASYLO_RETURN_IF_ERROR
(

52 
UÁru¡edInvoke
({
»que¡_bufãr
, 
»que¡_size
}, &
»¥Ú£
));

54 *
	g»¥Ú£_bufãr
 = 
»¥Ú£
.
As
<
ušt8_t
>();

55 *
	g»¥Ú£_size
 = 
»¥Ú£
.
size
();

57  
	gasylo
::
´im™ives
::
Prim™iveStus
::
OkStus
();

61 
	gasylo
::
´im™ives
::
Prim™iveStus
 
Inv®idRe¥Ú£Di¥©ch”
(

62 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

63 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

64 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

66 
ASYLO_RETURN_IF_ERROR
(

67 
UÁru¡edInvoke
({
»que¡_bufãr
, 
»que¡_size
}, &
»¥Ú£
));

69 *
	g»¥Ú£_bufãr
 = 
»¥Ú£
.
As
<
ušt8_t
>();

70 *
	g»¥Ú£_size
 = 1;

72  
	gasylo
::
´im™ives
::
Prim™iveStus
::
OkStus
();

76 
	gasylo
::
´im™ives
::
Prim™iveStus
 
AlwaysFašgDi¥©ch”
(

77 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

78 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

79  {
	gasylo
::
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "some„andom failure"};

84 
	gasylo
::
´im™ives
::
Prim™iveStus
 
Di¥©chW™hCu¡omAÎoÿtÜ
(

85 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

86 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

87 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

90 
	g´im™ives
::
N©iveP¬am‘”Sck
 
¡ack
;

92 autØ
	gcu¡om_»¥Ú£_®loÿtÜ
 = [&
¡ack
](
size_t
 
size
è-> 
´im™ives
::
Ex‹Á
 {

93  
¡ack
.
PushAÎoc
(
size
);

96 
ASYLO_RETURN_IF_ERROR
(
UÁru¡edInvoke
({
»que¡_bufãr
, 
»que¡_size
},

97 &
»¥Ú£
, 
cu¡om_»¥Ú£_®loÿtÜ
));

99 
EXPECT_EQ
(
¡ack
.
size
(), 1);

100 
EXPECT_EQ
(
»¥Ú£
.
d©a
(), 
¡ack
.
Tİ
().data());

101 
EXPECT_EQ
(
»¥Ú£
.
size
(), 
¡ack
.
Tİ
().size());

105 *
	g»¥Ú£_bufãr
 = 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(
»¥Ú£
.
size
()));

106 
memıy
(*
»¥Ú£_bufãr
, 
»¥Ú£
.
As
<
ušt8_t
>(),„e¥Ú£.
size
());

107 *
	g»¥Ú£_size
 = 
»¥Ú£
.
size
();

109  
	gasylo
::
´im™ives
::
Prim™iveStus
::
OkStus
();

113 
TEST
(
Sy¡emC®lTe¡
, 
Z”oP¬am‘”Te¡
) {

114 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

115 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
), 
Eq
(
g‘pid
()));

116 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘euid
), 
Eq
(
g‘euid
()));

117 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘gid
), 
Eq
(
g‘gid
()));

118 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘egid
), 
Eq
(
g‘egid
()));

123 
TEST
(
Sy¡emC®lTe¡
, 
Cu¡omEx‹ÁAÎoÿtÜTe¡
) {

124 
’c_£t_di¥©ch_sysÿÎ
(
Di¥©chW™hCu¡omAÎoÿtÜ
);

125 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
), 
Eq
(
g‘pid
()));

126 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘euid
), 
Eq
(
g‘euid
()));

130 
TEST
(
Sy¡emC®lTe¡
, 
BufãrOutTe¡
) {

131 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

132 
	gbufãr_ex³ùed
[2048];

133 
	gbufãr_aùu®
[2048];

134 
g‘cwd
(
bufãr_ex³ùed
, (buffer_expected));

135 
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘cwd
, 
bufãr_aùu®
, (buffer_actual));

136 
EXPECT_THAT
(&
bufãr_ex³ùed
[0], 
SŒEq
(
bufãr_aùu®
));

140 
TEST
(
Sy¡emC®lTe¡
, 
SÿÏrInTe¡
) {

141 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

142 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/scalar_in_test.tmp");

143 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

145 
EXPECT_GE
(
fd
, 0);

148 
EXPECT_NE
(
fú
(
fd
, 
F_GETFD
), -1);

150 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_şo£
, 
fd
), 
Eq
(0));

153 
EXPECT_THAT
(
fú
(
fd
, 
F_GETFD
), 
Eq
(-1));

157 
TEST
(
Sy¡emC®lTe¡
, 
SŒšgInTe¡
) {

158 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

159 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/string_in_test.tmp");

160 
	gfd
 = 
’c_uÁru¡ed_sysÿÎ
(
SYS_İ’
, 
·th
.
c_¡r
(),

161 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

164 
EXPECT_GE
(
fd
, 0);

167 
EXPECT_NE
(
fú
(
fd
, 
F_GETFD
), -1);

170 
EXPECT_THAT
(
acûss
(
·th
.
c_¡r
(), 
R_OK
 | 
W_OK
), 
Eq
(0));

172 
şo£
(
fd
);

177 
TEST
(
Sy¡emC®lTe¡
, 
NuÎBufãrTe¡
) {

178 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

179 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/null_buffer_test.tmp");

180 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

183 
EXPECT_GE
(
fd
, 0);

186 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_wr™e
, 
fd
, 
nuÎ±r
, 0), 
Eq
(0));

189 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_»ad
, 
fd
, 
nuÎ±r
, 0), 
Eq
(0));

193 
TEST
(
Sy¡emC®lTe¡
, 
FixedOutTe¡
) {

194 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

197 cÚ¡ *
	g·th
 = 
FLAGS_‹¡_tmpdœ
.
c_¡r
();

198 
¡©
 
	g¡©_ex³ùed
;

199 
¡©
 
	g¡©_aùu®
;

200 
	g»suÉ_ex³ùed
 = 
¡©
(
·th
, &
¡©_ex³ùed
);

201 
	g»suÉ_aùu®
 = 
’c_uÁru¡ed_sysÿÎ
(
SYS_¡©
, 
·th
, &
¡©_aùu®
);

203 
EXPECT_THAT
(
»suÉ_ex³ùed
, 
Eq
(
»suÉ_aùu®
));

204 
EXPECT_THAT
(
memcmp
(&
¡©_ex³ùed
, &
¡©_aùu®
, (
¡©
)), 
Eq
(0));

208 
TEST
(
Sy¡emC®lTe¡
, 
A¼ayOutTe¡
) {

209 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

210 
	gfd
[2];

211 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_pe
, &
fd
), 
Eq
(0));

212 cÚ¡ 
	gmes§ge
[] = "testing one,wo,hree...";

213 
wr™e
(
fd
[1], &
mes§ge
, 
¡¾’
(message) + 1);

214 
	gbuf
[1024];

215 
»ad
(
fd
[0], 
buf
, (buf));

216 
EXPECT_THAT
(
buf
, 
SŒEq
(
mes§ge
));

217 
şo£
(
fd
[0]);

218 
şo£
(
fd
[1]);

223 
TEST
(
Sy¡emC®lTe¡
, 
SysC®lNumb”s
) {

224 
EXPECT_EQ
(
kSYS_»ad
, 0);

225 
EXPECT_EQ
(
kSYS_g‘cwd
, 79);

229 
TEST
(
Sy¡emC®lTe¡
, 
AbÜtOnC®lbackFau»
) {

230 
’c_£t_di¥©ch_sysÿÎ
(
AlwaysFašgDi¥©ch”
);

231 
EXPECT_EXIT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
),

232 ::
‹¡šg
::
KËdBySigÇl
(
SIGABRT
), ".*");

236 
TEST
(
Sy¡emC®lTe¡
, 
AbÜtOnS”Ÿliz©iÚFau»
) {

237 
EXPECT_EXIT
(
’c_uÁru¡ed_sysÿÎ
(1000000),

238 ::
‹¡šg
::
KËdBySigÇl
(
SIGABRT
), ".*");

242 
TEST
(
Sy¡emC®lTe¡
, 
AbÜtOnRe¥Ú£Mes§geFau»
) {

243 
’c_£t_di¥©ch_sysÿÎ
(
Inv®idRe¥Ú£Di¥©ch”
);

244 
EXPECT_EXIT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
),

245 ::
‹¡šg
::
KËdBySigÇl
(
SIGABRT
), ".*");

	@platform/system_call/system_call_test.cc

19 
	~<fú.h
>

20 
	~<sys/¡©.h
>

21 
	~<sys/sysÿÎ.h
>

22 
	~<sys/ty³s.h
>

23 
	~<uni¡d.h
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~<gmock/gmock.h
>

29 
	~<g‹¡/g‹¡.h
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/¶©fÜm/´im™ives/uÁru¡ed_´im™ives.h
"

32 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¢o.h
"

33 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/sy¡em_ÿÎ.h
"

34 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/uÁru¡ed_švoke.h
"

35 
	~"asylo/‹¡/ut/‹¡_æags.h
"

36 
	~"asylo/ut/¡©us_maüos.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

40 
	gÇme¥aû
 {

42 
usšg
 
	g‹¡šg
::
Eq
;

43 
usšg
 
	g‹¡šg
::
SŒEq
;

46 
	gasylo
::
´im™ives
::
Prim™iveStus
 
Sy¡emC®lDi¥©ch”
(

47 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

48 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

49 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

51 
ASYLO_RETURN_IF_ERROR
(

52 
UÁru¡edInvoke
({
»que¡_bufãr
, 
»que¡_size
}, &
»¥Ú£
));

54 *
	g»¥Ú£_bufãr
 = 
»¥Ú£
.
As
<
ušt8_t
>();

55 *
	g»¥Ú£_size
 = 
»¥Ú£
.
size
();

57  
	gasylo
::
´im™ives
::
Prim™iveStus
::
OkStus
();

61 
	gasylo
::
´im™ives
::
Prim™iveStus
 
Inv®idRe¥Ú£Di¥©ch”
(

62 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

63 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

64 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

66 
ASYLO_RETURN_IF_ERROR
(

67 
UÁru¡edInvoke
({
»que¡_bufãr
, 
»que¡_size
}, &
»¥Ú£
));

69 *
	g»¥Ú£_bufãr
 = 
»¥Ú£
.
As
<
ušt8_t
>();

70 *
	g»¥Ú£_size
 = 1;

72  
	gasylo
::
´im™ives
::
Prim™iveStus
::
OkStus
();

76 
	gasylo
::
´im™ives
::
Prim™iveStus
 
AlwaysFašgDi¥©ch”
(

77 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

78 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

79  {
	gasylo
::
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "some„andom failure"};

84 
	gasylo
::
´im™ives
::
Prim™iveStus
 
Di¥©chW™hCu¡omAÎoÿtÜ
(

85 cÚ¡ 
ušt8_t
 *
»que¡_bufãr
, 
size_t
 
»que¡_size
,

86 
ušt8_t
 **
»¥Ú£_bufãr
, 
size_t
 *
»¥Ú£_size
) {

87 
	g´im™ives
::
Ex‹Á
 
»¥Ú£
;

90 
	g´im™ives
::
N©iveP¬am‘”Sck
 
¡ack
;

92 autØ
	gcu¡om_»¥Ú£_®loÿtÜ
 = [&
¡ack
](
size_t
 
size
è-> 
´im™ives
::
Ex‹Á
 {

93  
¡ack
.
PushAÎoc
(
size
);

96 
ASYLO_RETURN_IF_ERROR
(
UÁru¡edInvoke
({
»que¡_bufãr
, 
»que¡_size
},

97 &
»¥Ú£
, 
cu¡om_»¥Ú£_®loÿtÜ
));

99 
EXPECT_EQ
(
¡ack
.
size
(), 1);

100 
EXPECT_EQ
(
»¥Ú£
.
d©a
(), 
¡ack
.
Tİ
().data());

101 
EXPECT_EQ
(
»¥Ú£
.
size
(), 
¡ack
.
Tİ
().size());

105 *
	g»¥Ú£_bufãr
 = 
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
m®loc
(
»¥Ú£
.
size
()));

106 
memıy
(*
»¥Ú£_bufãr
, 
»¥Ú£
.
As
<
ušt8_t
>(),„e¥Ú£.
size
());

107 *
	g»¥Ú£_size
 = 
»¥Ú£
.
size
();

109  
	gasylo
::
´im™ives
::
Prim™iveStus
::
OkStus
();

113 
TEST
(
Sy¡emC®lTe¡
, 
Z”oP¬am‘”Te¡
) {

114 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

115 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
), 
Eq
(
g‘pid
()));

116 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘euid
), 
Eq
(
g‘euid
()));

117 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘gid
), 
Eq
(
g‘gid
()));

118 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘egid
), 
Eq
(
g‘egid
()));

123 
TEST
(
Sy¡emC®lTe¡
, 
Cu¡omEx‹ÁAÎoÿtÜTe¡
) {

124 
’c_£t_di¥©ch_sysÿÎ
(
Di¥©chW™hCu¡omAÎoÿtÜ
);

125 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
), 
Eq
(
g‘pid
()));

126 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘euid
), 
Eq
(
g‘euid
()));

130 
TEST
(
Sy¡emC®lTe¡
, 
BufãrOutTe¡
) {

131 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

132 
	gbufãr_ex³ùed
[2048];

133 
	gbufãr_aùu®
[2048];

134 
g‘cwd
(
bufãr_ex³ùed
, (buffer_expected));

135 
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘cwd
, 
bufãr_aùu®
, (buffer_actual));

136 
EXPECT_THAT
(&
bufãr_ex³ùed
[0], 
SŒEq
(
bufãr_aùu®
));

140 
TEST
(
Sy¡emC®lTe¡
, 
SÿÏrInTe¡
) {

141 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

142 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/scalar_in_test.tmp");

143 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

145 
EXPECT_GE
(
fd
, 0);

148 
EXPECT_NE
(
fú
(
fd
, 
F_GETFD
), -1);

150 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_şo£
, 
fd
), 
Eq
(0));

153 
EXPECT_THAT
(
fú
(
fd
, 
F_GETFD
), 
Eq
(-1));

157 
TEST
(
Sy¡emC®lTe¡
, 
SŒšgInTe¡
) {

158 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

159 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/string_in_test.tmp");

160 
	gfd
 = 
’c_uÁru¡ed_sysÿÎ
(
SYS_İ’
, 
·th
.
c_¡r
(),

161 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

164 
EXPECT_GE
(
fd
, 0);

167 
EXPECT_NE
(
fú
(
fd
, 
F_GETFD
), -1);

170 
EXPECT_THAT
(
acûss
(
·th
.
c_¡r
(), 
R_OK
 | 
W_OK
), 
Eq
(0));

172 
şo£
(
fd
);

177 
TEST
(
Sy¡emC®lTe¡
, 
NuÎBufãrTe¡
) {

178 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

179 
	g¡d
::
¡ršg
 
·th
 = 
ab¦
::
SŒC©
(
FLAGS_‹¡_tmpdœ
, "/null_buffer_test.tmp");

180 
	gfd
 = 
İ’
(
·th
.
c_¡r
(), 
O_RDWR
 | 
O_CREAT
 | 
O_TRUNC
, 
S_IRUSR
 | 
S_IWUSR
);

183 
EXPECT_GE
(
fd
, 0);

186 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_wr™e
, 
fd
, 
nuÎ±r
, 0), 
Eq
(0));

189 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_»ad
, 
fd
, 
nuÎ±r
, 0), 
Eq
(0));

193 
TEST
(
Sy¡emC®lTe¡
, 
FixedOutTe¡
) {

194 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

197 cÚ¡ *
	g·th
 = 
FLAGS_‹¡_tmpdœ
.
c_¡r
();

198 
¡©
 
	g¡©_ex³ùed
;

199 
¡©
 
	g¡©_aùu®
;

200 
	g»suÉ_ex³ùed
 = 
¡©
(
·th
, &
¡©_ex³ùed
);

201 
	g»suÉ_aùu®
 = 
’c_uÁru¡ed_sysÿÎ
(
SYS_¡©
, 
·th
, &
¡©_aùu®
);

203 
EXPECT_THAT
(
»suÉ_ex³ùed
, 
Eq
(
»suÉ_aùu®
));

204 
EXPECT_THAT
(
memcmp
(&
¡©_ex³ùed
, &
¡©_aùu®
, (
¡©
)), 
Eq
(0));

208 
TEST
(
Sy¡emC®lTe¡
, 
A¼ayOutTe¡
) {

209 
’c_£t_di¥©ch_sysÿÎ
(
Sy¡emC®lDi¥©ch”
);

210 
	gfd
[2];

211 
EXPECT_THAT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_pe
, &
fd
), 
Eq
(0));

212 cÚ¡ 
	gmes§ge
[] = "testing one,wo,hree...";

213 
wr™e
(
fd
[1], &
mes§ge
, 
¡¾’
(message) + 1);

214 
	gbuf
[1024];

215 
»ad
(
fd
[0], 
buf
, (buf));

216 
EXPECT_THAT
(
buf
, 
SŒEq
(
mes§ge
));

217 
şo£
(
fd
[0]);

218 
şo£
(
fd
[1]);

223 
TEST
(
Sy¡emC®lTe¡
, 
SysC®lNumb”s
) {

224 
EXPECT_EQ
(
kSYS_»ad
, 0);

225 
EXPECT_EQ
(
kSYS_g‘cwd
, 79);

229 
TEST
(
Sy¡emC®lTe¡
, 
AbÜtOnC®lbackFau»
) {

230 
’c_£t_di¥©ch_sysÿÎ
(
AlwaysFašgDi¥©ch”
);

231 
EXPECT_EXIT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
),

232 ::
‹¡šg
::
KËdBySigÇl
(
SIGABRT
), ".*");

236 
TEST
(
Sy¡emC®lTe¡
, 
AbÜtOnS”Ÿliz©iÚFau»
) {

237 
EXPECT_EXIT
(
’c_uÁru¡ed_sysÿÎ
(1000000),

238 ::
‹¡šg
::
KËdBySigÇl
(
SIGABRT
), ".*");

242 
TEST
(
Sy¡emC®lTe¡
, 
AbÜtOnRe¥Ú£Mes§geFau»
) {

243 
’c_£t_di¥©ch_sysÿÎ
(
Inv®idRe¥Ú£Di¥©ch”
);

244 
EXPECT_EXIT
(
’c_uÁru¡ed_sysÿÎ
(
SYS_g‘pid
),

245 ::
‹¡šg
::
KËdBySigÇl
(
SIGABRT
), ".*");

	@platform/system_call/type_conversions/generated_types_functions_test.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/g’”©ed_ty³s_funùiÚs.h
"

21 
	~<funùiÚ®
>

22 
	~<veùÜ
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/fš™e_domaš_fuzz.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
Eq
;

38 
cÚ¡ex´
 
	gkI‹¿tiÚCouÁ
 = 6000;

40 şas 
	cG’”©edTy³sFunùiÚsTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

41 
public
:

43 
Te¡MuÉiV®uedEnums
(

44 cÚ¡ 
¡d
::
veùÜ
<>& 
äom_b™s
, cÚ¡ std::veùÜ<>& 
to_b™s
,

45 cÚ¡ 
¡d
::
funùiÚ
<(cÚ¡ *, *)>& 
äom_funùiÚ
,

46 cÚ¡ 
¡d
::
funùiÚ
<(cÚ¡ *, *)>& 
to_funùiÚ
) {

47 autØ
	gäom_‹¡_funùiÚ
 = [&](
šput
) {

48 
ouut
;

49 
äom_funùiÚ
(&
šput
, &
ouut
);

50  
	gouut
;

52 autØ
	gto_‹¡_funùiÚ
 = [&](
šput
) {

53 
ouut
;

54 
to_funùiÚ
(&
šput
, &
ouut
);

55  
	gouut
;

58 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gäom_‹¡_funùiÚ
);

59 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gto_‹¡_funùiÚ
);

60 
EXPECT_THAT
(

61 
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
kI‹¿tiÚCouÁ
),

62 
äom_m©ch”
);

63 
EXPECT_THAT
(

64 
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
kI‹¿tiÚCouÁ
),

65 
to_m©ch”
);

69 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FeStusFÏgTe¡
) {

70 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {

71 
kLšux_O_RDONLY
, 
kLšux_O_WRONLY
, 
kLšux_O_RDWR
, 
kLšux_O_CREAT
,

72 
kLšux_O_APPEND
, 
kLšux_O_EXCL
, 
kLšux_O_TRUNC
, 
kLšux_O_NONBLOCK
,

73 
kLšux_O_DIRECT
, 
kLšux_O_CLOEXEC
};

74 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
O_RDONLY
, 
O_WRONLY
, 
O_RDWR
, 
O_CREAT
,

75 
O_APPEND
, 
O_EXCL
, 
O_TRUNC
, 
O_NONBLOCK
,

76 
O_DIRECT
, 
O_CLOEXEC
};

78 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxFeStusFÏg
,

79 
TokLšuxFeStusFÏg
);

82 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FúCommªdTe¡
) {

83 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {
kLšux_F_GETFD
, 
kLšux_F_SETFD
,

84 
kLšux_F_GETFL
, 
kLšux_F_SETFL
,

85 
kLšux_F_GETPIPE_SZ
, 
kLšux_F_SETPIPE_SZ
};

86 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {
F_GETFD
, 
F_SETFD
, 
F_GETFL
,

87 
F_SETFL
, 
F_GETPIPE_SZ
, 
F_SETPIPE_SZ
};

89 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

90 
	gouut
;

91 
FromkLšuxFúCommªd
(&
šput
, &
ouut
);

92  
	gouut
;

94 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

95 
kI‹¿tiÚCouÁ
),

96 
äom_m©ch”
);

97 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

98 
	gouut
;

99 
TokLšuxFúCommªd
(&
šput
, &
ouut
);

100  
	gouut
;

102 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

103 
kI‹¿tiÚCouÁ
),

104 
to_m©ch”
);

107 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
AfFamyTe¡
) {

108 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {

109 
kLšux_AF_UNIX
, 
kLšux_AF_LOCAL
, 
kLšux_AF_INET
,

110 
kLšux_AF_AX25
, 
kLšux_AF_IPX
, 
kLšux_AF_APPLETALK
,

111 
kLšux_AF_X25
, 
kLšux_AF_ATMPVC
, 
kLšux_AF_INET6
,

112 
kLšux_AF_DECÃt
, 
kLšux_AF_KEY
, 
kLšux_AF_NETLINK
,

113 
kLšux_AF_PACKET
, 
kLšux_AF_RDS
, 
kLšux_AF_PPPOX
,

114 
kLšux_AF_LLC
, 
kLšux_AF_CAN
, 
kLšux_AF_TIPC
,

115 
kLšux_AF_BLUETOOTH
, 
kLšux_AF_ALG
, 
kLšux_AF_VSOCK
,

116 
kLšux_AF_UNSPEC
};

117 
	g¡d
::
veùÜ
<> 
to_b™s
 = {

118 
AF_UNIX
, 
AF_LOCAL
, 
AF_INET
, 
AF_AX25
, 
AF_IPX
, 
AF_APPLETALK
,

119 
AF_X25
, 
AF_ATMPVC
, 
AF_INET6
, 
AF_DECÃt
, 
AF_KEY
, 
AF_NETLINK
,

120 
AF_PACKET
, 
AF_RDS
, 
AF_PPPOX
, 
AF_LLC
, 
AF_CAN
, 
AF_TIPC
,

121 
AF_BLUETOOTH
, 
AF_ALG
, 
AF_VSOCK
, 
AF_UNSPEC
};

126 
	gi
 = 0; i < 
	gäom_b™s
.
size
(); i++) {

127 
	g»suÉ
;

128 
TokLšuxAfFamy
(&
to_b™s
[
i
], &
»suÉ
);

129 
EXPECT_THAT
(
»suÉ
, 
Eq
(
äom_b™s
[
i
]));

130 
FromkLšuxAfFamy
(&
äom_b™s
[
i
], &
»suÉ
);

131 
EXPECT_THAT
(
»suÉ
, 
Eq
(
to_b™s
[
i
]));

135 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FDFÏgTe¡
) {

136 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_FD_CLOEXEC
};

137 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
FD_CLOEXEC
};

138 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxFDFÏg
, 
TokLšuxFDFÏg
);

141 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
TıO±iÚNameTe¡
) {

142 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {
kLšux_TCP_NODELAY
, 
kLšux_TCP_KEEPIDLE
,

143 
kLšux_TCP_KEEPINTVL
, 
kLšux_TCP_KEEPCNT
};

144 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {
TCP_NODELAY
, 
TCP_KEEPIDLE
, 
TCP_KEEPINTVL
,

145 
TCP_KEEPCNT
};

146 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

147 
	gouut
;

148 
FromkLšuxTıO±iÚName
(&
šput
, &
ouut
);

149  
	gouut
;

151 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

152 
kI‹¿tiÚCouÁ
),

153 
äom_m©ch”
);

154 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

155 
	gouut
;

156 
TokLšuxTıO±iÚName
(&
šput
, &
ouut
);

157  
	gouut
;

159 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1,

160 
kI‹¿tiÚCouÁ
),

161 
to_m©ch”
);

164 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
IpV6O±iÚNameTe¡
) {

165 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {

166 
kLšux_IPV6_V6ONLY
, 
kLšux_IPV6_RECVPKTINFO
,

167 
kLšux_IPV6_PKTINFO
, 
kLšux_IPV6_RECVHOPLIMIT
,

168 
kLšux_IPV6_HOPLIMIT
, 
kLšux_IPV6_RECVHOPOPTS
,

169 
kLšux_IPV6_HOPOPTS
, 
kLšux_IPV6_RTHDRDSTOPTS
,

170 
kLšux_IPV6_RECVRTHDR
, 
kLšux_IPV6_RTHDR
,

171 
kLšux_IPV6_RECVDSTOPTS
, 
kLšux_IPV6_DSTOPTS
};

172 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {

173 
IPV6_V6ONLY
, 
IPV6_RECVPKTINFO
, 
IPV6_PKTINFO
, 
IPV6_RECVHOPLIMIT
,

174 
IPV6_HOPLIMIT
, 
IPV6_RECVHOPOPTS
, 
IPV6_HOPOPTS
, 
IPV6_RTHDRDSTOPTS
,

175 
IPV6_RECVRTHDR
, 
IPV6_RTHDR
, 
IPV6_RECVDSTOPTS
, 
IPV6_DSTOPTS
};

176 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

177 
	gouut
;

178 
FromkLšuxIpV6O±iÚName
(&
šput
, &
ouut
);

179  
	gouut
;

181 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

182 
kI‹¿tiÚCouÁ
),

183 
äom_m©ch”
);

184 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

185 
	gouut
;

186 
TokLšuxIpV6O±iÚName
(&
šput
, &
ouut
);

187  
	gouut
;

189 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1,

190 
kI‹¿tiÚCouÁ
),

191 
to_m©ch”
);

194 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
Sock‘O±iÚNameTe¡
) {

195 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {

196 
kLšux_SO_DEBUG
, 
kLšux_SO_REUSEADDR
, 
kLšux_SO_TYPE
,

197 
kLšux_SO_ERROR
, 
kLšux_SO_DONTROUTE
, 
kLšux_SO_BROADCAST
,

198 
kLšux_SO_SNDBUF
, 
kLšux_SO_RCVBUF
, 
kLšux_SO_SNDBUFFORCE
,

199 
kLšux_SO_RCVBUFFORCE
, 
kLšux_SO_KEEPALIVE
, 
kLšux_SO_OOBINLINE
,

200 
kLšux_SO_NO_CHECK
, 
kLšux_SO_PRIORITY
, 
kLšux_SO_LINGER
,

201 
kLšux_SO_BSDCOMPAT
, 
kLšux_SO_REUSEPORT
, 
kLšux_SO_RCVTIMEO
,

202 
kLšux_SO_SNDTIMEO
};

203 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {

204 
SO_DEBUG
, 
SO_REUSEADDR
, 
SO_TYPE
, 
SO_ERROR
, 
SO_DONTROUTE
,

205 
SO_BROADCAST
, 
SO_SNDBUF
, 
SO_RCVBUF
, 
SO_SNDBUFFORCE
, 
SO_RCVBUFFORCE
,

206 
SO_KEEPALIVE
, 
SO_OOBINLINE
, 
SO_NO_CHECK
, 
SO_PRIORITY
, 
SO_LINGER
,

207 
SO_BSDCOMPAT
, 
SO_REUSEPORT
, 
SO_RCVTIMEO
, 
SO_SNDTIMEO
};

208 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

209 
	gouut
;

210 
FromkLšuxSock‘O±iÚName
(&
šput
, &
ouut
);

211  
	gouut
;

213 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

214 
kI‹¿tiÚCouÁ
),

215 
äom_m©ch”
);

216 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

217 
	gouut
;

218 
TokLšuxSock‘O±iÚName
(&
šput
, &
ouut
);

219  
	gouut
;

221 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1,

222 
kI‹¿tiÚCouÁ
),

223 
to_m©ch”
);

226 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FlockO³¿tiÚTe¡
) {

227 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_LOCK_SH
, 
kLšux_LOCK_EX
, 
kLšux_LOCK_NB
,

228 
kLšux_LOCK_UN
};

229 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
LOCK_SH
, 
LOCK_EX
, 
LOCK_NB
, 
LOCK_UN
};

230 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxFLockO³¿tiÚ
,

231 
TokLšuxFLockO³¿tiÚ
);

234 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
InÙifyFÏgsTe¡
) {

235 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_IN_NONBLOCK
, 
kLšux_IN_CLOEXEC
};

236 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
IN_NONBLOCK
, 
IN_CLOEXEC
};

237 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxInÙifyFÏg
,

238 
TokLšuxInÙifyFÏg
);

241 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
InÙifyEv’tMaskTe¡
) {

242 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {

243 
kLšux_IN_ACCESS
, 
kLšux_IN_MODIFY
, 
kLšux_IN_ATTRIB
,

244 
kLšux_IN_CLOSE_WRITE
, 
kLšux_IN_CLOSE_NOWRITE
, 
kLšux_IN_OPEN
,

245 
kLšux_IN_MOVED_FROM
, 
kLšux_IN_MOVED_TO
, 
kLšux_IN_CREATE
,

246 
kLšux_IN_DELETE
, 
kLšux_IN_DELETE_SELF
, 
kLšux_IN_MOVE_SELF
,

247 
kLšux_IN_UNMOUNT
, 
kLšux_IN_Q_OVERFLOW
, 
kLšux_IN_IGNORED
};

248 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
IN_ACCESS
, 
IN_MODIFY
, 
IN_ATTRIB
,

249 
IN_CLOSE_WRITE
, 
IN_CLOSE_NOWRITE
, 
IN_OPEN
,

250 
IN_MOVED_FROM
, 
IN_MOVED_TO
, 
IN_CREATE
,

251 
IN_DELETE
, 
IN_DELETE_SELF
, 
IN_MOVE_SELF
,

252 
IN_UNMOUNT
, 
IN_Q_OVERFLOW
, 
IN_IGNORED
};

253 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxInÙifyEv’tMask
,

254 
TokLšuxInÙifyEv’tMask
);

	@platform/system_call/type_conversions/generated_types_functions_test.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/g’”©ed_ty³s_funùiÚs.h
"

21 
	~<funùiÚ®
>

22 
	~<veùÜ
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/fš™e_domaš_fuzz.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

29 
	gÇme¥aû
 {

31 
	gusšg
 ::
‹¡šg
::
Eq
;

38 
cÚ¡ex´
 
	gkI‹¿tiÚCouÁ
 = 6000;

40 şas 
	cG’”©edTy³sFunùiÚsTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

41 
public
:

43 
Te¡MuÉiV®uedEnums
(

44 cÚ¡ 
¡d
::
veùÜ
<>& 
äom_b™s
, cÚ¡ std::veùÜ<>& 
to_b™s
,

45 cÚ¡ 
¡d
::
funùiÚ
<(cÚ¡ *, *)>& 
äom_funùiÚ
,

46 cÚ¡ 
¡d
::
funùiÚ
<(cÚ¡ *, *)>& 
to_funùiÚ
) {

47 autØ
	gäom_‹¡_funùiÚ
 = [&](
šput
) {

48 
ouut
;

49 
äom_funùiÚ
(&
šput
, &
ouut
);

50  
	gouut
;

52 autØ
	gto_‹¡_funùiÚ
 = [&](
šput
) {

53 
ouut
;

54 
to_funùiÚ
(&
šput
, &
ouut
);

55  
	gouut
;

58 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gäom_‹¡_funùiÚ
);

59 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >(
	gto_‹¡_funùiÚ
);

60 
EXPECT_THAT
(

61 
FuzzB™£tT¿n¦©iÚFunùiÚ
(
äom_b™s
, 
to_b™s
, 
kI‹¿tiÚCouÁ
),

62 
äom_m©ch”
);

63 
EXPECT_THAT
(

64 
FuzzB™£tT¿n¦©iÚFunùiÚ
(
to_b™s
, 
äom_b™s
, 
kI‹¿tiÚCouÁ
),

65 
to_m©ch”
);

69 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FeStusFÏgTe¡
) {

70 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {

71 
kLšux_O_RDONLY
, 
kLšux_O_WRONLY
, 
kLšux_O_RDWR
, 
kLšux_O_CREAT
,

72 
kLšux_O_APPEND
, 
kLšux_O_EXCL
, 
kLšux_O_TRUNC
, 
kLšux_O_NONBLOCK
,

73 
kLšux_O_DIRECT
, 
kLšux_O_CLOEXEC
};

74 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
O_RDONLY
, 
O_WRONLY
, 
O_RDWR
, 
O_CREAT
,

75 
O_APPEND
, 
O_EXCL
, 
O_TRUNC
, 
O_NONBLOCK
,

76 
O_DIRECT
, 
O_CLOEXEC
};

78 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxFeStusFÏg
,

79 
TokLšuxFeStusFÏg
);

82 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FúCommªdTe¡
) {

83 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {
kLšux_F_GETFD
, 
kLšux_F_SETFD
,

84 
kLšux_F_GETFL
, 
kLšux_F_SETFL
,

85 
kLšux_F_GETPIPE_SZ
, 
kLšux_F_SETPIPE_SZ
};

86 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {
F_GETFD
, 
F_SETFD
, 
F_GETFL
,

87 
F_SETFL
, 
F_GETPIPE_SZ
, 
F_SETPIPE_SZ
};

89 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

90 
	gouut
;

91 
FromkLšuxFúCommªd
(&
šput
, &
ouut
);

92  
	gouut
;

94 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

95 
kI‹¿tiÚCouÁ
),

96 
äom_m©ch”
);

97 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

98 
	gouut
;

99 
TokLšuxFúCommªd
(&
šput
, &
ouut
);

100  
	gouut
;

102 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

103 
kI‹¿tiÚCouÁ
),

104 
to_m©ch”
);

107 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
AfFamyTe¡
) {

108 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {

109 
kLšux_AF_UNIX
, 
kLšux_AF_LOCAL
, 
kLšux_AF_INET
,

110 
kLšux_AF_AX25
, 
kLšux_AF_IPX
, 
kLšux_AF_APPLETALK
,

111 
kLšux_AF_X25
, 
kLšux_AF_ATMPVC
, 
kLšux_AF_INET6
,

112 
kLšux_AF_DECÃt
, 
kLšux_AF_KEY
, 
kLšux_AF_NETLINK
,

113 
kLšux_AF_PACKET
, 
kLšux_AF_RDS
, 
kLšux_AF_PPPOX
,

114 
kLšux_AF_LLC
, 
kLšux_AF_CAN
, 
kLšux_AF_TIPC
,

115 
kLšux_AF_BLUETOOTH
, 
kLšux_AF_ALG
, 
kLšux_AF_VSOCK
,

116 
kLšux_AF_UNSPEC
};

117 
	g¡d
::
veùÜ
<> 
to_b™s
 = {

118 
AF_UNIX
, 
AF_LOCAL
, 
AF_INET
, 
AF_AX25
, 
AF_IPX
, 
AF_APPLETALK
,

119 
AF_X25
, 
AF_ATMPVC
, 
AF_INET6
, 
AF_DECÃt
, 
AF_KEY
, 
AF_NETLINK
,

120 
AF_PACKET
, 
AF_RDS
, 
AF_PPPOX
, 
AF_LLC
, 
AF_CAN
, 
AF_TIPC
,

121 
AF_BLUETOOTH
, 
AF_ALG
, 
AF_VSOCK
, 
AF_UNSPEC
};

126 
	gi
 = 0; i < 
	gäom_b™s
.
size
(); i++) {

127 
	g»suÉ
;

128 
TokLšuxAfFamy
(&
to_b™s
[
i
], &
»suÉ
);

129 
EXPECT_THAT
(
»suÉ
, 
Eq
(
äom_b™s
[
i
]));

130 
FromkLšuxAfFamy
(&
äom_b™s
[
i
], &
»suÉ
);

131 
EXPECT_THAT
(
»suÉ
, 
Eq
(
to_b™s
[
i
]));

135 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FDFÏgTe¡
) {

136 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_FD_CLOEXEC
};

137 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
FD_CLOEXEC
};

138 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxFDFÏg
, 
TokLšuxFDFÏg
);

141 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
TıO±iÚNameTe¡
) {

142 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {
kLšux_TCP_NODELAY
, 
kLšux_TCP_KEEPIDLE
,

143 
kLšux_TCP_KEEPINTVL
, 
kLšux_TCP_KEEPCNT
};

144 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {
TCP_NODELAY
, 
TCP_KEEPIDLE
, 
TCP_KEEPINTVL
,

145 
TCP_KEEPCNT
};

146 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

147 
	gouut
;

148 
FromkLšuxTıO±iÚName
(&
šput
, &
ouut
);

149  
	gouut
;

151 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

152 
kI‹¿tiÚCouÁ
),

153 
äom_m©ch”
);

154 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

155 
	gouut
;

156 
TokLšuxTıO±iÚName
(&
šput
, &
ouut
);

157  
	gouut
;

159 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1,

160 
kI‹¿tiÚCouÁ
),

161 
to_m©ch”
);

164 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
IpV6O±iÚNameTe¡
) {

165 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {

166 
kLšux_IPV6_V6ONLY
, 
kLšux_IPV6_RECVPKTINFO
,

167 
kLšux_IPV6_PKTINFO
, 
kLšux_IPV6_RECVHOPLIMIT
,

168 
kLšux_IPV6_HOPLIMIT
, 
kLšux_IPV6_RECVHOPOPTS
,

169 
kLšux_IPV6_HOPOPTS
, 
kLšux_IPV6_RTHDRDSTOPTS
,

170 
kLšux_IPV6_RECVRTHDR
, 
kLšux_IPV6_RTHDR
,

171 
kLšux_IPV6_RECVDSTOPTS
, 
kLšux_IPV6_DSTOPTS
};

172 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {

173 
IPV6_V6ONLY
, 
IPV6_RECVPKTINFO
, 
IPV6_PKTINFO
, 
IPV6_RECVHOPLIMIT
,

174 
IPV6_HOPLIMIT
, 
IPV6_RECVHOPOPTS
, 
IPV6_HOPOPTS
, 
IPV6_RTHDRDSTOPTS
,

175 
IPV6_RECVRTHDR
, 
IPV6_RTHDR
, 
IPV6_RECVDSTOPTS
, 
IPV6_DSTOPTS
};

176 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

177 
	gouut
;

178 
FromkLšuxIpV6O±iÚName
(&
šput
, &
ouut
);

179  
	gouut
;

181 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

182 
kI‹¿tiÚCouÁ
),

183 
äom_m©ch”
);

184 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

185 
	gouut
;

186 
TokLšuxIpV6O±iÚName
(&
šput
, &
ouut
);

187  
	gouut
;

189 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1,

190 
kI‹¿tiÚCouÁ
),

191 
to_m©ch”
);

194 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
Sock‘O±iÚNameTe¡
) {

195 
	g¡d
::
veùÜ
<> 
äom_cÚ¡s
 = {

196 
kLšux_SO_DEBUG
, 
kLšux_SO_REUSEADDR
, 
kLšux_SO_TYPE
,

197 
kLšux_SO_ERROR
, 
kLšux_SO_DONTROUTE
, 
kLšux_SO_BROADCAST
,

198 
kLšux_SO_SNDBUF
, 
kLšux_SO_RCVBUF
, 
kLšux_SO_SNDBUFFORCE
,

199 
kLšux_SO_RCVBUFFORCE
, 
kLšux_SO_KEEPALIVE
, 
kLšux_SO_OOBINLINE
,

200 
kLšux_SO_NO_CHECK
, 
kLšux_SO_PRIORITY
, 
kLšux_SO_LINGER
,

201 
kLšux_SO_BSDCOMPAT
, 
kLšux_SO_REUSEPORT
, 
kLšux_SO_RCVTIMEO
,

202 
kLšux_SO_SNDTIMEO
};

203 
	g¡d
::
veùÜ
<> 
to_cÚ¡s
 = {

204 
SO_DEBUG
, 
SO_REUSEADDR
, 
SO_TYPE
, 
SO_ERROR
, 
SO_DONTROUTE
,

205 
SO_BROADCAST
, 
SO_SNDBUF
, 
SO_RCVBUF
, 
SO_SNDBUFFORCE
, 
SO_RCVBUFFORCE
,

206 
SO_KEEPALIVE
, 
SO_OOBINLINE
, 
SO_NO_CHECK
, 
SO_PRIORITY
, 
SO_LINGER
,

207 
SO_BSDCOMPAT
, 
SO_REUSEPORT
, 
SO_RCVTIMEO
, 
SO_SNDTIMEO
};

208 autØ
	gäom_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

209 
	gouut
;

210 
FromkLšuxSock‘O±iÚName
(&
šput
, &
ouut
);

211  
	gouut
;

213 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
äom_cÚ¡s
, 
to_cÚ¡s
, -1,

214 
kI‹¿tiÚCouÁ
),

215 
äom_m©ch”
);

216 autØ
	gto_m©ch”
 = 
IsFš™eRe¡riùiÚOf
<, >([&](
	gšput
) {

217 
	gouut
;

218 
TokLšuxSock‘O±iÚName
(&
šput
, &
ouut
);

219  
	gouut
;

221 
EXPECT_THAT
(
FuzzFš™eFunùiÚW™hF®lback
(
to_cÚ¡s
, 
äom_cÚ¡s
, -1,

222 
kI‹¿tiÚCouÁ
),

223 
to_m©ch”
);

226 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
FlockO³¿tiÚTe¡
) {

227 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_LOCK_SH
, 
kLšux_LOCK_EX
, 
kLšux_LOCK_NB
,

228 
kLšux_LOCK_UN
};

229 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
LOCK_SH
, 
LOCK_EX
, 
LOCK_NB
, 
LOCK_UN
};

230 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxFLockO³¿tiÚ
,

231 
TokLšuxFLockO³¿tiÚ
);

234 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
InÙifyFÏgsTe¡
) {

235 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_IN_NONBLOCK
, 
kLšux_IN_CLOEXEC
};

236 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
IN_NONBLOCK
, 
IN_CLOEXEC
};

237 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxInÙifyFÏg
,

238 
TokLšuxInÙifyFÏg
);

241 
TEST_F
(
G’”©edTy³sFunùiÚsTe¡
, 
InÙifyEv’tMaskTe¡
) {

242 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {

243 
kLšux_IN_ACCESS
, 
kLšux_IN_MODIFY
, 
kLšux_IN_ATTRIB
,

244 
kLšux_IN_CLOSE_WRITE
, 
kLšux_IN_CLOSE_NOWRITE
, 
kLšux_IN_OPEN
,

245 
kLšux_IN_MOVED_FROM
, 
kLšux_IN_MOVED_TO
, 
kLšux_IN_CREATE
,

246 
kLšux_IN_DELETE
, 
kLšux_IN_DELETE_SELF
, 
kLšux_IN_MOVE_SELF
,

247 
kLšux_IN_UNMOUNT
, 
kLšux_IN_Q_OVERFLOW
, 
kLšux_IN_IGNORED
};

248 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
IN_ACCESS
, 
IN_MODIFY
, 
IN_ATTRIB
,

249 
IN_CLOSE_WRITE
, 
IN_CLOSE_NOWRITE
, 
IN_OPEN
,

250 
IN_MOVED_FROM
, 
IN_MOVED_TO
, 
IN_CREATE
,

251 
IN_DELETE
, 
IN_DELETE_SELF
, 
IN_MOVE_SELF
,

252 
IN_UNMOUNT
, 
IN_Q_OVERFLOW
, 
IN_IGNORED
};

253 
Te¡MuÉiV®uedEnums
(
äom_b™s
, 
to_b™s
, 
FromkLšuxInÙifyEv’tMask
,

254 
TokLšuxInÙifyEv’tMask
);

	@platform/system_call/type_conversions/manual_types_functions.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/mªu®_ty³s_funùiÚs.h
"

21 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/g’”©ed_ty³s_funùiÚs.h
"

23 
	$TokLšuxSock‘Ty³
(cÚ¡ *
šput
, *
ouut
) {

24 
sock_ty³
 = *
šput
;

25 *
ouut
 = 0;

27 ià(
sock_ty³
 & 
SOCK_NONBLOCK
) {

28 *
ouut
 |ğ
kLšux_SOCK_NONBLOCK
;

29 
sock_ty³
 &ğ~
SOCK_NONBLOCK
;

32 ià(
sock_ty³
 & 
SOCK_CLOEXEC
) {

33 *
ouut
 |ğ
kLšux_SOCK_CLOEXEC
;

34 
sock_ty³
 &ğ~
SOCK_CLOEXEC
;

37 ià(!
sock_ty³
) {

41 
sock_ty³
) {

42 
SOCK_STREAM
:

43 *
ouut
 |ğ
kLšux_SOCK_STREAM
;

45 
SOCK_DGRAM
:

46 *
ouut
 |ğ
kLšux_SOCK_DGRAM
;

48 
SOCK_SEQPACKET
:

49 *
ouut
 |ğ
kLšux_SOCK_SEQPACKET
;

51 
SOCK_RAW
:

52 *
ouut
 |ğ
kLšux_SOCK_RAW
;

54 
SOCK_RDM
:

55 *
ouut
 |ğ
kLšux_SOCK_RDM
;

57 
SOCK_PACKET
:

58 *
ouut
 |ğ
kLšux_SOCK_PACKET
;

61 *
ouut
 = -1;

63 
	}
}

65 
	$FromkLšuxSock‘Ty³
(cÚ¡ *
šput
, *
ouut
) {

66 
kLšux_sock_ty³
 = *
šput
;

67 *
ouut
 = 0;

69 ià(
kLšux_sock_ty³
 & 
kLšux_SOCK_NONBLOCK
) {

70 *
ouut
 |ğ
SOCK_NONBLOCK
;

71 
kLšux_sock_ty³
 &ğ~
kLšux_SOCK_NONBLOCK
;

74 ià(
kLšux_sock_ty³
 & 
kLšux_SOCK_CLOEXEC
) {

75 *
ouut
 |ğ
SOCK_CLOEXEC
;

76 
kLšux_sock_ty³
 &ğ~
kLšux_SOCK_CLOEXEC
;

79 ià(!
kLšux_sock_ty³
) {

84 
kLšux_sock_ty³
) {

85 
kLšux_SOCK_STREAM
:

86 *
ouut
 |ğ
SOCK_STREAM
;

88 
kLšux_SOCK_DGRAM
:

89 *
ouut
 |ğ
SOCK_DGRAM
;

91 
kLšux_SOCK_SEQPACKET
:

92 *
ouut
 |ğ
SOCK_SEQPACKET
;

94 
kLšux_SOCK_RAW
:

95 *
ouut
 |ğ
SOCK_RAW
;

97 
kLšux_SOCK_RDM
:

98 *
ouut
 |ğ
SOCK_RDM
;

100 
kLšux_SOCK_PACKET
:

101 *
ouut
 |ğ
SOCK_PACKET
;

104 *
ouut
 = -1;

106 
	}
}

108 
	$TokLšuxO±iÚName
(cÚ¡ *
Ëv–
, cÚ¡ *
İtiÚ_Çme
, *
ouut
) {

109 ià(*
Ëv–
 =ğ
IPPROTO_TCP
) {

110 
	`TokLšuxTıO±iÚName
(
İtiÚ_Çme
, 
ouut
);

111 } ià(*
Ëv–
 =ğ
IPPROTO_IPV6
) {

112 
	`TokLšuxIpV6O±iÚName
(
İtiÚ_Çme
, 
ouut
);

113 } ià(*
Ëv–
 =ğ
SOL_SOCKET
) {

114 
	`TokLšuxSock‘O±iÚName
(
İtiÚ_Çme
, 
ouut
);

116 *
ouut
 = -1;

118 
	}
}

120 
	$FromkLšuxO±iÚName
(cÚ¡ *
Ëv–
, cÚ¡ *
klšux_İtiÚ_Çme
,

121 *
ouut
) {

122 ià(*
Ëv–
 =ğ
IPPROTO_TCP
) {

123 
	`FromkLšuxTıO±iÚName
(
klšux_İtiÚ_Çme
, 
ouut
);

124 } ià(*
Ëv–
 =ğ
IPPROTO_IPV6
) {

125 
	`TokLšuxIpV6O±iÚName
(
klšux_İtiÚ_Çme
, 
ouut
);

126 } ià(*
Ëv–
 =ğ
SOL_SOCKET
) {

127 
	`FromkLšuxSock‘O±iÚName
(
klšux_İtiÚ_Çme
, 
ouut
);

129 *
ouut
 = -1;

131 
	}
}

	@platform/system_call/type_conversions/manual_types_functions.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/mªu®_ty³s_funùiÚs.h
"

21 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/g’”©ed_ty³s_funùiÚs.h
"

23 
	$TokLšuxSock‘Ty³
(cÚ¡ *
šput
, *
ouut
) {

24 
sock_ty³
 = *
šput
;

25 *
ouut
 = 0;

27 ià(
sock_ty³
 & 
SOCK_NONBLOCK
) {

28 *
ouut
 |ğ
kLšux_SOCK_NONBLOCK
;

29 
sock_ty³
 &ğ~
SOCK_NONBLOCK
;

32 ià(
sock_ty³
 & 
SOCK_CLOEXEC
) {

33 *
ouut
 |ğ
kLšux_SOCK_CLOEXEC
;

34 
sock_ty³
 &ğ~
SOCK_CLOEXEC
;

37 ià(!
sock_ty³
) {

41 
sock_ty³
) {

42 
SOCK_STREAM
:

43 *
ouut
 |ğ
kLšux_SOCK_STREAM
;

45 
SOCK_DGRAM
:

46 *
ouut
 |ğ
kLšux_SOCK_DGRAM
;

48 
SOCK_SEQPACKET
:

49 *
ouut
 |ğ
kLšux_SOCK_SEQPACKET
;

51 
SOCK_RAW
:

52 *
ouut
 |ğ
kLšux_SOCK_RAW
;

54 
SOCK_RDM
:

55 *
ouut
 |ğ
kLšux_SOCK_RDM
;

57 
SOCK_PACKET
:

58 *
ouut
 |ğ
kLšux_SOCK_PACKET
;

61 *
ouut
 = -1;

63 
	}
}

65 
	$FromkLšuxSock‘Ty³
(cÚ¡ *
šput
, *
ouut
) {

66 
kLšux_sock_ty³
 = *
šput
;

67 *
ouut
 = 0;

69 ià(
kLšux_sock_ty³
 & 
kLšux_SOCK_NONBLOCK
) {

70 *
ouut
 |ğ
SOCK_NONBLOCK
;

71 
kLšux_sock_ty³
 &ğ~
kLšux_SOCK_NONBLOCK
;

74 ià(
kLšux_sock_ty³
 & 
kLšux_SOCK_CLOEXEC
) {

75 *
ouut
 |ğ
SOCK_CLOEXEC
;

76 
kLšux_sock_ty³
 &ğ~
kLšux_SOCK_CLOEXEC
;

79 ià(!
kLšux_sock_ty³
) {

84 
kLšux_sock_ty³
) {

85 
kLšux_SOCK_STREAM
:

86 *
ouut
 |ğ
SOCK_STREAM
;

88 
kLšux_SOCK_DGRAM
:

89 *
ouut
 |ğ
SOCK_DGRAM
;

91 
kLšux_SOCK_SEQPACKET
:

92 *
ouut
 |ğ
SOCK_SEQPACKET
;

94 
kLšux_SOCK_RAW
:

95 *
ouut
 |ğ
SOCK_RAW
;

97 
kLšux_SOCK_RDM
:

98 *
ouut
 |ğ
SOCK_RDM
;

100 
kLšux_SOCK_PACKET
:

101 *
ouut
 |ğ
SOCK_PACKET
;

104 *
ouut
 = -1;

106 
	}
}

108 
	$TokLšuxO±iÚName
(cÚ¡ *
Ëv–
, cÚ¡ *
İtiÚ_Çme
, *
ouut
) {

109 ià(*
Ëv–
 =ğ
IPPROTO_TCP
) {

110 
	`TokLšuxTıO±iÚName
(
İtiÚ_Çme
, 
ouut
);

111 } ià(*
Ëv–
 =ğ
IPPROTO_IPV6
) {

112 
	`TokLšuxIpV6O±iÚName
(
İtiÚ_Çme
, 
ouut
);

113 } ià(*
Ëv–
 =ğ
SOL_SOCKET
) {

114 
	`TokLšuxSock‘O±iÚName
(
İtiÚ_Çme
, 
ouut
);

116 *
ouut
 = -1;

118 
	}
}

120 
	$FromkLšuxO±iÚName
(cÚ¡ *
Ëv–
, cÚ¡ *
klšux_İtiÚ_Çme
,

121 *
ouut
) {

122 ià(*
Ëv–
 =ğ
IPPROTO_TCP
) {

123 
	`FromkLšuxTıO±iÚName
(
klšux_İtiÚ_Çme
, 
ouut
);

124 } ià(*
Ëv–
 =ğ
IPPROTO_IPV6
) {

125 
	`TokLšuxIpV6O±iÚName
(
klšux_İtiÚ_Çme
, 
ouut
);

126 } ià(*
Ëv–
 =ğ
SOL_SOCKET
) {

127 
	`FromkLšuxSock‘O±iÚName
(
klšux_İtiÚ_Çme
, 
ouut
);

129 *
ouut
 = -1;

131 
	}
}

	@platform/system_call/type_conversions/manual_types_functions.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_TYPE_CONVERSIONS_MANUAL_TYPES_FUNCTIONS_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_TYPE_CONVERSIONS_MANUAL_TYPES_FUNCTIONS_H_


	)

25 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/g’”©ed_ty³s.h
"

29 
TokLšuxSock‘Ty³
(cÚ¡ *
šput
, *
ouut
);

33 
FromkLšuxSock‘Ty³
(cÚ¡ *
šput
, *
ouut
);

37 
TokLšuxO±iÚName
(cÚ¡ *
Ëv–
, cÚ¡ *
İtiÚ_Çme
, *
ouut
);

41 
FromkLšuxO±iÚName
(cÚ¡ *
Ëv–
, cÚ¡ *
klšux_İtiÚ_Çme
,

42 *
ouut
);

	@platform/system_call/type_conversions/manual_types_functions_test.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/mªu®_ty³s_funùiÚs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
	gusšg
 ::
‹¡šg
::
Eq
;

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

27 
	gÇme¥aû
 {

29 
TEST
(
Mªu®Ty³sFunùiÚsTe¡
, 
Sock‘Ty³Te¡
) {

30 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_SOCK_STREAM
, 
kLšux_SOCK_DGRAM
,

31 
kLšux_SOCK_SEQPACKET
, 
kLšux_SOCK_RAW
,

32 
kLšux_SOCK_RDM
, 
kLšux_SOCK_PACKET
,

33 
kLšux_SOCK_NONBLOCK
, 
kLšux_SOCK_CLOEXEC
};

35 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
SOCK_STREAM
, 
SOCK_DGRAM
, 
SOCK_SEQPACKET
,

36 
SOCK_RAW
, 
SOCK_RDM
, 
SOCK_PACKET
,

37 
SOCK_NONBLOCK
, 
SOCK_CLOEXEC
};

39 
	gi
 = 0; i < 
	gäom_b™s
.
size
(); i++) {

40 
	gouut
;

41 
TokLšuxSock‘Ty³
(&
to_b™s
[
i
], &
ouut
);

42 
EXPECT_THAT
(
ouut
, 
Eq
(
äom_b™s
[
i
]));

43 
FromkLšuxSock‘Ty³
(&
äom_b™s
[
i
], &
ouut
);

44 
EXPECT_THAT
(
ouut
, 
Eq
(
to_b™s
[
i
]));

46 
	gäom
 = 
kLšux_SOCK_CLOEXEC
 | 
kLšux_SOCK_NONBLOCK
 | 
äom_b™s
[
i
];

47 
	gto
 = 
SOCK_CLOEXEC
 | 
SOCK_NONBLOCK
 | 
to_b™s
[
i
];

48 
TokLšuxSock‘Ty³
(&
to
, &
ouut
);

49 
EXPECT_THAT
(
ouut
, 
Eq
(
äom
));

50 
FromkLšuxSock‘Ty³
(&
äom
, &
ouut
);

51 
EXPECT_THAT
(
ouut
, 
Eq
(
to
));

53 
	gäom
 = 
kLšux_SOCK_CLOEXEC
 | 
äom_b™s
[
i
];

54 
	gto
 = 
SOCK_CLOEXEC
 | 
to_b™s
[
i
];

55 
TokLšuxSock‘Ty³
(&
to
, &
ouut
);

56 
EXPECT_THAT
(
ouut
, 
Eq
(
äom
));

57 
FromkLšuxSock‘Ty³
(&
äom
, &
ouut
);

58 
EXPECT_THAT
(
ouut
, 
Eq
(
to
));

60 
	gäom
 = 
kLšux_SOCK_NONBLOCK
 | 
äom_b™s
[
i
];

61 
	gto
 = 
SOCK_NONBLOCK
 | 
to_b™s
[
i
];

62 
TokLšuxSock‘Ty³
(&
to
, &
ouut
);

63 
EXPECT_THAT
(
ouut
, 
Eq
(
äom
));

64 
FromkLšuxSock‘Ty³
(&
äom
, &
ouut
);

65 
EXPECT_THAT
(
ouut
, 
Eq
(
to
));

	@platform/system_call/type_conversions/manual_types_functions_test.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/mªu®_ty³s_funùiÚs.h
"

20 
	~<gmock/gmock.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
	gusšg
 ::
‹¡šg
::
Eq
;

25 
Çme¥aû
 
	gasylo
 {

26 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

27 
	gÇme¥aû
 {

29 
TEST
(
Mªu®Ty³sFunùiÚsTe¡
, 
Sock‘Ty³Te¡
) {

30 
	g¡d
::
veùÜ
<> 
äom_b™s
 = {
kLšux_SOCK_STREAM
, 
kLšux_SOCK_DGRAM
,

31 
kLšux_SOCK_SEQPACKET
, 
kLšux_SOCK_RAW
,

32 
kLšux_SOCK_RDM
, 
kLšux_SOCK_PACKET
,

33 
kLšux_SOCK_NONBLOCK
, 
kLšux_SOCK_CLOEXEC
};

35 
	g¡d
::
veùÜ
<> 
to_b™s
 = {
SOCK_STREAM
, 
SOCK_DGRAM
, 
SOCK_SEQPACKET
,

36 
SOCK_RAW
, 
SOCK_RDM
, 
SOCK_PACKET
,

37 
SOCK_NONBLOCK
, 
SOCK_CLOEXEC
};

39 
	gi
 = 0; i < 
	gäom_b™s
.
size
(); i++) {

40 
	gouut
;

41 
TokLšuxSock‘Ty³
(&
to_b™s
[
i
], &
ouut
);

42 
EXPECT_THAT
(
ouut
, 
Eq
(
äom_b™s
[
i
]));

43 
FromkLšuxSock‘Ty³
(&
äom_b™s
[
i
], &
ouut
);

44 
EXPECT_THAT
(
ouut
, 
Eq
(
to_b™s
[
i
]));

46 
	gäom
 = 
kLšux_SOCK_CLOEXEC
 | 
kLšux_SOCK_NONBLOCK
 | 
äom_b™s
[
i
];

47 
	gto
 = 
SOCK_CLOEXEC
 | 
SOCK_NONBLOCK
 | 
to_b™s
[
i
];

48 
TokLšuxSock‘Ty³
(&
to
, &
ouut
);

49 
EXPECT_THAT
(
ouut
, 
Eq
(
äom
));

50 
FromkLšuxSock‘Ty³
(&
äom
, &
ouut
);

51 
EXPECT_THAT
(
ouut
, 
Eq
(
to
));

53 
	gäom
 = 
kLšux_SOCK_CLOEXEC
 | 
äom_b™s
[
i
];

54 
	gto
 = 
SOCK_CLOEXEC
 | 
to_b™s
[
i
];

55 
TokLšuxSock‘Ty³
(&
to
, &
ouut
);

56 
EXPECT_THAT
(
ouut
, 
Eq
(
äom
));

57 
FromkLšuxSock‘Ty³
(&
äom
, &
ouut
);

58 
EXPECT_THAT
(
ouut
, 
Eq
(
to
));

60 
	gäom
 = 
kLšux_SOCK_NONBLOCK
 | 
äom_b™s
[
i
];

61 
	gto
 = 
SOCK_NONBLOCK
 | 
to_b™s
[
i
];

62 
TokLšuxSock‘Ty³
(&
to
, &
ouut
);

63 
EXPECT_THAT
(
ouut
, 
Eq
(
äom
));

64 
FromkLšuxSock‘Ty³
(&
äom
, &
ouut
);

65 
EXPECT_THAT
(
ouut
, 
Eq
(
to
));

	@platform/system_call/type_conversions/types.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_TYPE_CONVERSIONS_TYPES_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_TYPE_CONVERSIONS_TYPES_H_


	)

25 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/g’”©ed_ty³s.h
"

	@platform/system_call/type_conversions/types_conversions_generator.cc

19 
	~<f¡»am
>

20 
	~<¡ršg
>

21 
	~<veùÜ
>

23 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

26 
	~"ab¦/¡ršgs/¡r_»¶aû.h
"

27 
	~"gæags/gæags.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_maüos.šc
"

33 
	sEnumPrİ”t›s
 {

34 
	mdeçuÉ_v®ue_ho¡
;

35 
	mdeçuÉ_v®ue_Ãwlib
;

36 
boŞ
 
	mmuÉi_v®ued
;

37 
boŞ
 
	msk_cÚv”siÚs
;

44 
	m¡d
::
veùÜ
<
¡d
::
·œ
<¡d::
¡ršg
, >> 
	mv®ues
;

48 
	sSŒuùPrİ”t›s
 {

49 
boŞ
 
	m·ck_©Œibu‹s
;

50 
boŞ
 
	msk_cÚv”siÚs
;

54 
	m¡d
::
m­
<
¡d
::
¡ršg
, std::¡ršg> 
v®ues
;

57 
DEFINE_¡ršg
(
ouut_dœ
, "", "Path ofhe output dir for generatedypes.");

60 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gEnumPrİ”t›s
> *
	$G‘EnumPrİ”t›sTabË
() {

61 autØ
’um_m­
 =

62 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>{
ENUMS_INIT
};

63  
’um_m­
;

64 
	}
}

67 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gSŒuùPrİ”t›s
> *
	$G‘SŒuùPrİ”t›sTabË
() {

68 autØ
¡ruù_m­
 =

69 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>{
STRUCTS_INIT
};

70  
¡ruù_m­
;

71 
	}
}

76 
	$Wr™eMaüoProvidedInşudes
(
¡d
::
o¡»am
 *
os
) {

77 
¡d
::
veùÜ
<¡d::
¡ršg
> 
šşudes
 = {
INCLUDES
};

78 cÚ¡‡utØ&
šş
 : 
šşudes
) {

79 *
os
 << 
ab¦
::
	`SŒ—mFÜm©
("#šşud<%s>\n", 
šş
);

81 *
os
 << "\n";

82 
	}
}

86 
	g¡d
::
¡ršg
 
	$G‘OrBa£dEnumBody
(
boŞ
 
to_´efix
, cÚ¡ 
¡d
::
¡ršg
 &
’um_Çme
,

87 cÚ¡ 
EnumPrİ”t›s
 &
’um_´İ”t›s
) {

88 
¡d
::
o¡ršg¡»am
 
os
;

91 
os
 << " *output = "

92 << (
to_´efix
 ? 
’um_´İ”t›s
.
deçuÉ_v®ue_ho¡


93 : 
’um_´İ”t›s
.
deçuÉ_v®ue_Ãwlib
)

97 cÚ¡‡utØ&
’um_·œ
 : 
’um_´İ”t›s
.
v®ues
) {

98 
os
 << " if (*input & "

99 << (
to_´efix
 ? 
’um_·œ
.
fœ¡


100 : 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
))

102 << (
to_´efix
 ? 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
)

103 : 
’um_·œ
.
fœ¡
)

107  
os
.
	`¡r
();

108 
	}
}

114 
	g¡d
::
¡ršg
 
	$G‘IfBa£dEnumBody
(
boŞ
 
to_´efix
, cÚ¡ 
¡d
::
¡ršg
 &
’um_Çme
,

115 cÚ¡ 
EnumPrİ”t›s
 &
’um_´İ”t›s
) {

116 
¡d
::
o¡ršg¡»am
 
os
;

117 cÚ¡‡utØ&
’um_·œ
 : 
’um_´İ”t›s
.
v®ues
) {

118 
¡d
::
¡ršg
 
šput_v®
 =

119 
to_´efix
 ? 
’um_·œ
.
fœ¡


120 : 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
);

121 
¡d
::
¡ršg
 
ouut_v®
 =

122 
to_´efix
 ? 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
)

123 : 
’um_·œ
.
fœ¡
;

125 
os
 << 
ab¦
::
	`SŒR•ÏûAÎ
(

130 {{"$šput_v®", 
šput_v®
}, {"$ouut_v®", 
ouut_v®
}});

134 
os
 << " *output = "

135 << (
to_´efix
 ? 
’um_´İ”t›s
.
deçuÉ_v®ue_ho¡


136 : 
’um_´İ”t›s
.
deçuÉ_v®ue_Ãwlib
)

139  
os
.
	`¡r
();

140 
	}
}

145 
	g¡d
::
¡ršg
 
	$G‘SŒuùCÚv”siÚsFuncBody
(

146 
boŞ
 
to_bridge
, cÚ¡ 
¡d
::
¡ršg
 &
šput_¡ruù
,

147 cÚ¡ 
¡d
::
¡ršg
 &
ouut_¡ruù
,

148 cÚ¡ 
SŒuùPrİ”t›s
 &
¡ruù_´İ”t›s
) {

149 
¡d
::
o¡ršg¡»am
 
os
;

150 
os
 << " ià(!" << 
šput_¡ruù
 << " || !" << 
ouut_¡ruù
 << ")„eturn;\n";

152 cÚ¡‡utØ&
memb”_deş
 : 
¡ruù_´İ”t›s
.
v®ues
) {

153 
¡d
::
¡ršg
 
bridge_memb”
 =

154 
ab¦
::
	`SŒC©
(
bridge_´efix
, "_", 
memb”_deş
.
fœ¡
);

156 
¡d
::
¡ršg
 
ouut_memb”
 = 
to_bridge
 ? 
bridge_memb”
 : 
memb”_deş
.
fœ¡
;

157 
¡d
::
¡ršg
 
šput_memb”
 = 
to_bridge
 ? 
memb”_deş
.
fœ¡
 : 
bridge_memb”
;

158 
os
 << " " << 
ouut_¡ruù
 << "->" << 
ouut_memb”
 << " = "

159 << 
šput_¡ruù
 << "->" << 
šput_memb”
 << ";\n";

162 
os
 << "\n";

163  
os
.
	`¡r
();

164 
	}
}

168 
Wr™eEnumCÚv”siÚs
(cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>

169 *
’um_´İ”t›s_bË
,

170 
¡d
::
o¡»am
 *
os_h
, std::o¡»am *
os_cc
) {

171 cÚ¡‡utØ&
™
 : *
’um_´İ”t›s_bË
) {

172 ià(
™
.
£cÚd
.
sk_cÚv”siÚs
) {

176 
	g¡d
::
¡ršg
 
’um_Çme_low”
 = 
™
.
fœ¡
;

177 
	g¡d
::
ŒªsfÜm
(
’um_Çme_low”
.
begš
(),ƒnum_Çme_low”.
’d
(),

178 
’um_Çme_low”
.
begš
(), ::
tŞow”
);

180 
	g¡d
::
¡ršg
 
to_´efix_deş
 = 
ab¦
::
SŒR•ÏûAÎ
(

182 {{"$klšux_´efix", 
klšux_´efix
}, {"$’um_Çme", 
™
.
fœ¡
}});

183 
	g¡d
::
¡ršg
 
äom_´efix_deş
 = 
ab¦
::
SŒR•ÏûAÎ
(

185 {{"$klšux_´efix", 
klšux_´efix
}, {"$’um_Çme", 
™
.
fœ¡
}});

188 *
	gos_h
 << "\n" << 
	gto_´efix_deş
 << "; \n";

189 *
	gos_h
 << "\n" << 
	gäom_´efix_deş
 << "; \n";

192 ià(
	g™
.
	g£cÚd
.
	gmuÉi_v®ued
) {

193 *
	gos_cc
 << "\n"

194 << 
	gto_´efix_deş
 << " {\n"

195 << 
G‘OrBa£dEnumBody
(
Œue
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

196 *
	gos_cc
 << "\n"

197 << 
	gäom_´efix_deş
 << " {\n"

198 << 
G‘OrBa£dEnumBody
(
çl£
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

200 *
	gos_cc
 << "\n"

201 << 
	gto_´efix_deş
 << " {\n"

202 << 
G‘IfBa£dEnumBody
(
Œue
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

203 *
	gos_cc
 << "\n"

204 << 
	gäom_´efix_deş
 << " {\n"

205 << 
G‘IfBa£dEnumBody
(
çl£
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

212 
Wr™eSŒuùCÚv”siÚs
(

213 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>

214 *
¡ruù_´İ”t›s_bË
,

215 
¡d
::
o¡»am
 *
os_h
, std::o¡»am *
os_cc
) {

216 cÚ¡‡utØ&
™
 : *
¡ruù_´İ”t›s_bË
) {

217 ià(
™
.
£cÚd
.
sk_cÚv”siÚs
) {

221 
	g¡d
::
¡ršg
 
¡ruù_v¬
 = 
ab¦
::
SŒC©
("_", 
™
.
fœ¡
);

222 
	g¡d
::
¡ršg
 
bridge_¡ruù_v¬
 =

223 
ab¦
::
SŒC©
("_", 
bridge_´efix
, 
¡ruù_v¬
);

225 
	g¡d
::
¡ršg
 
to_bridge_deş¬©iÚ
 = 
ab¦
::
SŒR•ÏûAÎ
(

229 {{"$bridge_´efix", 
bridge_´efix
},

230 {"$Çme", 
™
.
fœ¡
},

231 {"$¡ruù_v¬", 
¡ruù_v¬
},

232 {"$bridge_¡ruù_v¬", 
bridge_¡ruù_v¬
}});

234 
	g¡d
::
¡ršg
 
äom_bridge_deş¬©iÚ
 = 
ab¦
::
SŒR•ÏûAÎ
(

237 {{"$bridge_´efix", 
bridge_´efix
},

238 {"$Çme", 
™
.
fœ¡
},

239 {"$¡ruù_v¬", 
¡ruù_v¬
},

240 {"$bridge_¡ruù_v¬", 
bridge_¡ruù_v¬
}});

243 *
	gos_h
 << "\n" << 
	gto_bridge_deş¬©iÚ
 << "; \n";

244 *
	gos_h
 << "\n" << 
	gäom_bridge_deş¬©iÚ
 << "; \n";

247 *
	gos_cc
 << "\n"

248 << 
	gto_bridge_deş¬©iÚ
 << " {\n"

249 << 
G‘SŒuùCÚv”siÚsFuncBody
(
Œue
, 
¡ruù_v¬
, 
bridge_¡ruù_v¬
,

250 
™
.
£cÚd
)

252 *
	gos_cc
 << "\n"

253 << 
	gäom_bridge_deş¬©iÚ
 << " {\n"

254 << 
G‘SŒuùCÚv”siÚsFuncBody
(
çl£
, 
bridge_¡ruù_v¬
, 
¡ruù_v¬
,

255 
™
.
£cÚd
)

262 
Wr™eEnumDefš™iÚs
(cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>

263 *
’um_´İ”t›s_bË
,

264 
¡d
::
o¡»am
 *
os
) {

265 cÚ¡‡utØ&
™
 : *
’um_´İ”t›s_bË
) {

266 *
os
 << 
ab¦
::
SŒ—mFÜm©
("\Ãnum % {\n", 
™
.
fœ¡
);

270 cÚ¡‡utØ&
	gcu¼’t
 : 
™
.
£cÚd
.
v®ues
) {

271 *
os
 << 
ab¦
::
SŒ—mFÜm©
(" %s_% ğ%d,\n", 
klšux_´efix
, 
cu¼’t
.
fœ¡
,

272 
cu¼’t
.
£cÚd
);

274 *
	gos
 << "};\n";

280 
Wr™eSŒuùDefš™iÚs
(

281 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>

282 *
¡ruù_´İ”t›s_bË
,

283 
¡d
::
o¡»am
 *
os
) {

284 cÚ¡‡utØ&
™
 : *
¡ruù_´İ”t›s_bË
) {

285 *
os
 << 
ab¦
::
SŒ—mFÜm©
("\n¡ruù %s_% {\n", 
bridge_´efix
, 
™
.
fœ¡
);

287 cÚ¡‡utØ&
	gcu¼’t
 : 
™
.
£cÚd
.
v®ues
) {

290 *
os
 << 
ab¦
::
SŒ—mFÜm©
(" % %s_%s;\n", 
cu¼’t
.
£cÚd
, 
bridge_´efix
,

291 
cu¼’t
.
fœ¡
);

293 *
	gos
 << "}" << (
	g™
.
	g£cÚd
.
	g·ck_©Œibu‹s
 ? " ABSL_ATTRIBUTE_PACKED" : "")

301 
Wr™eTy³Defš™iÚs
(

302 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>

303 *
’um_´İ”t›s_bË
,

304 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>

305 *
¡ruù_´İ”t›s_bË
,

306 
¡d
::
o¡»am
 *
os
) {

308 
¡d
::
¡ršg
 
h—d”_gu¬d
 =

311 *
	gos
 << "#iâdeà" << 
	gh—d”_gu¬d
 << "\n"

312 << "#defš" << 
	gh—d”_gu¬d
 << "\n\n";

317 
Wr™eMaüoProvidedInşudes
(
os
);

318 *
	gos
 << "#include \"absl/base/attributes.h\""

321 
Wr™eEnumDefš™iÚs
(
’um_´İ”t›s_bË
, 
os
);

322 
Wr™eSŒuùDefš™iÚs
(
¡ruù_´İ”t›s_bË
, 
os
);

325 *
	gos
 << "\n#’dià // " << 
	gh—d”_gu¬d
 << "\n";

332 
Wr™eTy³sCÚv”siÚs
(

333 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
> *
’um_´İ”t›s_bË
,

334 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
> *
¡ruù_´İ”t›s_bË
,

335 
¡d
::
o¡»am
 *
os_h
, std::o¡»am *
os_cc
) {

337 
¡d
::
¡ršg
 
h—d”_gu¬d
 =

340 *
	gos_h
 << "#iâdeà" << 
	gh—d”_gu¬d
 << "\n"

341 << "#defš" << 
	gh—d”_gu¬d
 << "\n\n";

344 
Wr™eMaüoProvidedInşudes
(
os_h
);

345 *
	gos_cc
 << "#include "

348 *
	gos_h
 << "#include "

352 
Wr™eEnumCÚv”siÚs
(
’um_´İ”t›s_bË
, 
os_h
, 
os_cc
);

353 
Wr™eSŒuùCÚv”siÚs
(
¡ruù_´İ”t›s_bË
, 
os_h
, 
os_cc
);

356 *
	gos_h
 << "\n#’dià // " << 
	gh—d”_gu¬d
 << "\n";

359 
	$maš
(
¬gc
, **
¬gv
) {

361 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

363 
	`CHECK
(!
FLAGS_ouut_dœ
.
	`em±y
()) << "Must…rovide output dir…ath.";

365 autØ
’um_´İ”t›s_bË
 = 
	`G‘EnumPrİ”t›sTabË
();

366 autØ
¡ruù_´İ”t›s_bË
 = 
	`G‘SŒuùPrİ”t›sTabË
();

367 
¡d
::
of¡»am
 
ty³s_h
, 
ty³s_funùiÚs_h
, 
ty³s_funùiÚs_cc
;

369 
ty³s_h
.
	`İ’
(
ab¦
::
	`SŒC©
(
FLAGS_ouut_dœ
, "/generated_types.h"));

370 
ty³s_funùiÚs_h
.
	`İ’
(

371 
ab¦
::
	`SŒC©
(
FLAGS_ouut_dœ
, "/generated_types_functions.h"));

372 
ty³s_funùiÚs_cc
.
	`İ’
(

373 
ab¦
::
	`SŒC©
(
FLAGS_ouut_dœ
, "/generated_types_functions.cc"));

375 
	`Wr™eTy³Defš™iÚs
(
’um_´İ”t›s_bË
, 
¡ruù_´İ”t›s_bË
,

376 &
ty³s_h
);

377 
	`Wr™eTy³sCÚv”siÚs
(
’um_´İ”t›s_bË
, 
¡ruù_´İ”t›s_bË
,

378 &
ty³s_funùiÚs_h
, &
ty³s_funùiÚs_cc
);

380 
ty³s_h
.
	`şo£
();

381 
ty³s_funùiÚs_h
.
	`şo£
();

382 
ty³s_funùiÚs_cc
.
	`şo£
();

385 
	}
}

	@platform/system_call/type_conversions/types_conversions_generator.cc

19 
	~<f¡»am
>

20 
	~<¡ršg
>

21 
	~<veùÜ
>

23 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"ab¦/¡ršgs/¡r_fÜm©.h
"

26 
	~"ab¦/¡ršgs/¡r_»¶aû.h
"

27 
	~"gæags/gæags.h
"

28 
	~"asylo/ut/loggšg.h
"

29 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/ty³s_maüos.šc
"

33 
	sEnumPrİ”t›s
 {

34 
	mdeçuÉ_v®ue_ho¡
;

35 
	mdeçuÉ_v®ue_Ãwlib
;

36 
boŞ
 
	mmuÉi_v®ued
;

37 
boŞ
 
	msk_cÚv”siÚs
;

44 
	m¡d
::
veùÜ
<
¡d
::
·œ
<¡d::
¡ršg
, >> 
	mv®ues
;

48 
	sSŒuùPrİ”t›s
 {

49 
boŞ
 
	m·ck_©Œibu‹s
;

50 
boŞ
 
	msk_cÚv”siÚs
;

54 
	m¡d
::
m­
<
¡d
::
¡ršg
, std::¡ršg> 
v®ues
;

57 
DEFINE_¡ršg
(
ouut_dœ
, "", "Path ofhe output dir for generatedypes.");

60 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gEnumPrİ”t›s
> *
	$G‘EnumPrİ”t›sTabË
() {

61 autØ
’um_m­
 =

62 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>{
ENUMS_INIT
};

63  
’um_m­
;

64 
	}
}

67 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
	gSŒuùPrİ”t›s
> *
	$G‘SŒuùPrİ”t›sTabË
() {

68 autØ
¡ruù_m­
 =

69 
Ãw
 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>{
STRUCTS_INIT
};

70  
¡ruù_m­
;

71 
	}
}

76 
	$Wr™eMaüoProvidedInşudes
(
¡d
::
o¡»am
 *
os
) {

77 
¡d
::
veùÜ
<¡d::
¡ršg
> 
šşudes
 = {
INCLUDES
};

78 cÚ¡‡utØ&
šş
 : 
šşudes
) {

79 *
os
 << 
ab¦
::
	`SŒ—mFÜm©
("#šşud<%s>\n", 
šş
);

81 *
os
 << "\n";

82 
	}
}

86 
	g¡d
::
¡ršg
 
	$G‘OrBa£dEnumBody
(
boŞ
 
to_´efix
, cÚ¡ 
¡d
::
¡ršg
 &
’um_Çme
,

87 cÚ¡ 
EnumPrİ”t›s
 &
’um_´İ”t›s
) {

88 
¡d
::
o¡ršg¡»am
 
os
;

91 
os
 << " *output = "

92 << (
to_´efix
 ? 
’um_´İ”t›s
.
deçuÉ_v®ue_ho¡


93 : 
’um_´İ”t›s
.
deçuÉ_v®ue_Ãwlib
)

97 cÚ¡‡utØ&
’um_·œ
 : 
’um_´İ”t›s
.
v®ues
) {

98 
os
 << " if (*input & "

99 << (
to_´efix
 ? 
’um_·œ
.
fœ¡


100 : 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
))

102 << (
to_´efix
 ? 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
)

103 : 
’um_·œ
.
fœ¡
)

107  
os
.
	`¡r
();

108 
	}
}

114 
	g¡d
::
¡ršg
 
	$G‘IfBa£dEnumBody
(
boŞ
 
to_´efix
, cÚ¡ 
¡d
::
¡ršg
 &
’um_Çme
,

115 cÚ¡ 
EnumPrİ”t›s
 &
’um_´İ”t›s
) {

116 
¡d
::
o¡ršg¡»am
 
os
;

117 cÚ¡‡utØ&
’um_·œ
 : 
’um_´İ”t›s
.
v®ues
) {

118 
¡d
::
¡ršg
 
šput_v®
 =

119 
to_´efix
 ? 
’um_·œ
.
fœ¡


120 : 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
);

121 
¡d
::
¡ršg
 
ouut_v®
 =

122 
to_´efix
 ? 
ab¦
::
	`SŒC©
(
klšux_´efix
, "_", 
’um_·œ
.
fœ¡
)

123 : 
’um_·œ
.
fœ¡
;

125 
os
 << 
ab¦
::
	`SŒR•ÏûAÎ
(

130 {{"$šput_v®", 
šput_v®
}, {"$ouut_v®", 
ouut_v®
}});

134 
os
 << " *output = "

135 << (
to_´efix
 ? 
’um_´İ”t›s
.
deçuÉ_v®ue_ho¡


136 : 
’um_´İ”t›s
.
deçuÉ_v®ue_Ãwlib
)

139  
os
.
	`¡r
();

140 
	}
}

145 
	g¡d
::
¡ršg
 
	$G‘SŒuùCÚv”siÚsFuncBody
(

146 
boŞ
 
to_bridge
, cÚ¡ 
¡d
::
¡ršg
 &
šput_¡ruù
,

147 cÚ¡ 
¡d
::
¡ršg
 &
ouut_¡ruù
,

148 cÚ¡ 
SŒuùPrİ”t›s
 &
¡ruù_´İ”t›s
) {

149 
¡d
::
o¡ršg¡»am
 
os
;

150 
os
 << " ià(!" << 
šput_¡ruù
 << " || !" << 
ouut_¡ruù
 << ")„eturn;\n";

152 cÚ¡‡utØ&
memb”_deş
 : 
¡ruù_´İ”t›s
.
v®ues
) {

153 
¡d
::
¡ršg
 
bridge_memb”
 =

154 
ab¦
::
	`SŒC©
(
bridge_´efix
, "_", 
memb”_deş
.
fœ¡
);

156 
¡d
::
¡ršg
 
ouut_memb”
 = 
to_bridge
 ? 
bridge_memb”
 : 
memb”_deş
.
fœ¡
;

157 
¡d
::
¡ršg
 
šput_memb”
 = 
to_bridge
 ? 
memb”_deş
.
fœ¡
 : 
bridge_memb”
;

158 
os
 << " " << 
ouut_¡ruù
 << "->" << 
ouut_memb”
 << " = "

159 << 
šput_¡ruù
 << "->" << 
šput_memb”
 << ";\n";

162 
os
 << "\n";

163  
os
.
	`¡r
();

164 
	}
}

168 
Wr™eEnumCÚv”siÚs
(cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>

169 *
’um_´İ”t›s_bË
,

170 
¡d
::
o¡»am
 *
os_h
, std::o¡»am *
os_cc
) {

171 cÚ¡‡utØ&
™
 : *
’um_´İ”t›s_bË
) {

172 ià(
™
.
£cÚd
.
sk_cÚv”siÚs
) {

176 
	g¡d
::
¡ršg
 
’um_Çme_low”
 = 
™
.
fœ¡
;

177 
	g¡d
::
ŒªsfÜm
(
’um_Çme_low”
.
begš
(),ƒnum_Çme_low”.
’d
(),

178 
’um_Çme_low”
.
begš
(), ::
tŞow”
);

180 
	g¡d
::
¡ršg
 
to_´efix_deş
 = 
ab¦
::
SŒR•ÏûAÎ
(

182 {{"$klšux_´efix", 
klšux_´efix
}, {"$’um_Çme", 
™
.
fœ¡
}});

183 
	g¡d
::
¡ršg
 
äom_´efix_deş
 = 
ab¦
::
SŒR•ÏûAÎ
(

185 {{"$klšux_´efix", 
klšux_´efix
}, {"$’um_Çme", 
™
.
fœ¡
}});

188 *
	gos_h
 << "\n" << 
	gto_´efix_deş
 << "; \n";

189 *
	gos_h
 << "\n" << 
	gäom_´efix_deş
 << "; \n";

192 ià(
	g™
.
	g£cÚd
.
	gmuÉi_v®ued
) {

193 *
	gos_cc
 << "\n"

194 << 
	gto_´efix_deş
 << " {\n"

195 << 
G‘OrBa£dEnumBody
(
Œue
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

196 *
	gos_cc
 << "\n"

197 << 
	gäom_´efix_deş
 << " {\n"

198 << 
G‘OrBa£dEnumBody
(
çl£
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

200 *
	gos_cc
 << "\n"

201 << 
	gto_´efix_deş
 << " {\n"

202 << 
G‘IfBa£dEnumBody
(
Œue
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

203 *
	gos_cc
 << "\n"

204 << 
	gäom_´efix_deş
 << " {\n"

205 << 
G‘IfBa£dEnumBody
(
çl£
, 
’um_Çme_low”
, 
™
.
£cÚd
) << "}\n";

212 
Wr™eSŒuùCÚv”siÚs
(

213 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>

214 *
¡ruù_´İ”t›s_bË
,

215 
¡d
::
o¡»am
 *
os_h
, std::o¡»am *
os_cc
) {

216 cÚ¡‡utØ&
™
 : *
¡ruù_´İ”t›s_bË
) {

217 ià(
™
.
£cÚd
.
sk_cÚv”siÚs
) {

221 
	g¡d
::
¡ršg
 
¡ruù_v¬
 = 
ab¦
::
SŒC©
("_", 
™
.
fœ¡
);

222 
	g¡d
::
¡ršg
 
bridge_¡ruù_v¬
 =

223 
ab¦
::
SŒC©
("_", 
bridge_´efix
, 
¡ruù_v¬
);

225 
	g¡d
::
¡ršg
 
to_bridge_deş¬©iÚ
 = 
ab¦
::
SŒR•ÏûAÎ
(

229 {{"$bridge_´efix", 
bridge_´efix
},

230 {"$Çme", 
™
.
fœ¡
},

231 {"$¡ruù_v¬", 
¡ruù_v¬
},

232 {"$bridge_¡ruù_v¬", 
bridge_¡ruù_v¬
}});

234 
	g¡d
::
¡ršg
 
äom_bridge_deş¬©iÚ
 = 
ab¦
::
SŒR•ÏûAÎ
(

237 {{"$bridge_´efix", 
bridge_´efix
},

238 {"$Çme", 
™
.
fœ¡
},

239 {"$¡ruù_v¬", 
¡ruù_v¬
},

240 {"$bridge_¡ruù_v¬", 
bridge_¡ruù_v¬
}});

243 *
	gos_h
 << "\n" << 
	gto_bridge_deş¬©iÚ
 << "; \n";

244 *
	gos_h
 << "\n" << 
	gäom_bridge_deş¬©iÚ
 << "; \n";

247 *
	gos_cc
 << "\n"

248 << 
	gto_bridge_deş¬©iÚ
 << " {\n"

249 << 
G‘SŒuùCÚv”siÚsFuncBody
(
Œue
, 
¡ruù_v¬
, 
bridge_¡ruù_v¬
,

250 
™
.
£cÚd
)

252 *
	gos_cc
 << "\n"

253 << 
	gäom_bridge_deş¬©iÚ
 << " {\n"

254 << 
G‘SŒuùCÚv”siÚsFuncBody
(
çl£
, 
bridge_¡ruù_v¬
, 
¡ruù_v¬
,

255 
™
.
£cÚd
)

262 
Wr™eEnumDefš™iÚs
(cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>

263 *
’um_´İ”t›s_bË
,

264 
¡d
::
o¡»am
 *
os
) {

265 cÚ¡‡utØ&
™
 : *
’um_´İ”t›s_bË
) {

266 *
os
 << 
ab¦
::
SŒ—mFÜm©
("\Ãnum % {\n", 
™
.
fœ¡
);

270 cÚ¡‡utØ&
	gcu¼’t
 : 
™
.
£cÚd
.
v®ues
) {

271 *
os
 << 
ab¦
::
SŒ—mFÜm©
(" %s_% ğ%d,\n", 
klšux_´efix
, 
cu¼’t
.
fœ¡
,

272 
cu¼’t
.
£cÚd
);

274 *
	gos
 << "};\n";

280 
Wr™eSŒuùDefš™iÚs
(

281 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>

282 *
¡ruù_´İ”t›s_bË
,

283 
¡d
::
o¡»am
 *
os
) {

284 cÚ¡‡utØ&
™
 : *
¡ruù_´İ”t›s_bË
) {

285 *
os
 << 
ab¦
::
SŒ—mFÜm©
("\n¡ruù %s_% {\n", 
bridge_´efix
, 
™
.
fœ¡
);

287 cÚ¡‡utØ&
	gcu¼’t
 : 
™
.
£cÚd
.
v®ues
) {

290 *
os
 << 
ab¦
::
SŒ—mFÜm©
(" % %s_%s;\n", 
cu¼’t
.
£cÚd
, 
bridge_´efix
,

291 
cu¼’t
.
fœ¡
);

293 *
	gos
 << "}" << (
	g™
.
	g£cÚd
.
	g·ck_©Œibu‹s
 ? " ABSL_ATTRIBUTE_PACKED" : "")

301 
Wr™eTy³Defš™iÚs
(

302 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
>

303 *
’um_´İ”t›s_bË
,

304 cÚ¡ 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
>

305 *
¡ruù_´İ”t›s_bË
,

306 
¡d
::
o¡»am
 *
os
) {

308 
¡d
::
¡ršg
 
h—d”_gu¬d
 =

311 *
	gos
 << "#iâdeà" << 
	gh—d”_gu¬d
 << "\n"

312 << "#defš" << 
	gh—d”_gu¬d
 << "\n\n";

317 
Wr™eMaüoProvidedInşudes
(
os
);

318 *
	gos
 << "#include \"absl/base/attributes.h\""

321 
Wr™eEnumDefš™iÚs
(
’um_´İ”t›s_bË
, 
os
);

322 
Wr™eSŒuùDefš™iÚs
(
¡ruù_´İ”t›s_bË
, 
os
);

325 *
	gos
 << "\n#’dià // " << 
	gh—d”_gu¬d
 << "\n";

332 
Wr™eTy³sCÚv”siÚs
(

333 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
EnumPrİ”t›s
> *
’um_´İ”t›s_bË
,

334 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, 
SŒuùPrİ”t›s
> *
¡ruù_´İ”t›s_bË
,

335 
¡d
::
o¡»am
 *
os_h
, std::o¡»am *
os_cc
) {

337 
¡d
::
¡ršg
 
h—d”_gu¬d
 =

340 *
	gos_h
 << "#iâdeà" << 
	gh—d”_gu¬d
 << "\n"

341 << "#defš" << 
	gh—d”_gu¬d
 << "\n\n";

344 
Wr™eMaüoProvidedInşudes
(
os_h
);

345 *
	gos_cc
 << "#include "

348 *
	gos_h
 << "#include "

352 
Wr™eEnumCÚv”siÚs
(
’um_´İ”t›s_bË
, 
os_h
, 
os_cc
);

353 
Wr™eSŒuùCÚv”siÚs
(
¡ruù_´İ”t›s_bË
, 
os_h
, 
os_cc
);

356 *
	gos_h
 << "\n#’dià // " << 
	gh—d”_gu¬d
 << "\n";

359 
	$maš
(
¬gc
, **
¬gv
) {

361 
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
, 
Œue
);

363 
	`CHECK
(!
FLAGS_ouut_dœ
.
	`em±y
()) << "Must…rovide output dir…ath.";

365 autØ
’um_´İ”t›s_bË
 = 
	`G‘EnumPrİ”t›sTabË
();

366 autØ
¡ruù_´İ”t›s_bË
 = 
	`G‘SŒuùPrİ”t›sTabË
();

367 
¡d
::
of¡»am
 
ty³s_h
, 
ty³s_funùiÚs_h
, 
ty³s_funùiÚs_cc
;

369 
ty³s_h
.
	`İ’
(
ab¦
::
	`SŒC©
(
FLAGS_ouut_dœ
, "/generated_types.h"));

370 
ty³s_funùiÚs_h
.
	`İ’
(

371 
ab¦
::
	`SŒC©
(
FLAGS_ouut_dœ
, "/generated_types_functions.h"));

372 
ty³s_funùiÚs_cc
.
	`İ’
(

373 
ab¦
::
	`SŒC©
(
FLAGS_ouut_dœ
, "/generated_types_functions.cc"));

375 
	`Wr™eTy³Defš™iÚs
(
’um_´İ”t›s_bË
, 
¡ruù_´İ”t›s_bË
,

376 &
ty³s_h
);

377 
	`Wr™eTy³sCÚv”siÚs
(
’um_´İ”t›s_bË
, 
¡ruù_´İ”t›s_bË
,

378 &
ty³s_funùiÚs_h
, &
ty³s_funùiÚs_cc
);

380 
ty³s_h
.
	`şo£
();

381 
ty³s_funùiÚs_h
.
	`şo£
();

382 
ty³s_funùiÚs_cc
.
	`şo£
();

385 
	}
}

	@platform/system_call/type_conversions/types_functions.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_TYPE_CONVERSIONS_TYPES_FUNCTIONS_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_TYPE_CONVERSIONS_TYPES_FUNCTIONS_H_


	)

25 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/g’”©ed_ty³s_funùiÚs.h
"

26 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/ty³_cÚv”siÚs/mªu®_ty³s_funùiÚs.h
"

	@platform/system_call/untrusted_invoke.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/uÁru¡ed_švoke.h
"

21 
	~<uni¡d.h
>

23 
	~<¬¿y
>

24 
	~<c¡dšt
>

25 
	~<memÜy
>

26 
	~<veùÜ
>

28 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

29 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

34 
	g´im™ives
::
Prim™iveStus
 
UÁru¡edInvoke
(

35 
´im™ives
::
Ex‹Á
 
»que¡
,…rim™ives::Ex‹Á *
»¥Ú£
,

36 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»¥Ú£_®loÿtÜ
) {

37 
Mes§geR—d”
 
»ad”
(
»que¡
);

38 
Sy¡emC®lDesütÜ
 
desütÜ
(
»ad”
.
sy¢o
());

41 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
> 
	g·¿ms
;

42 
	g·¿ms
.
fl
(0);

45 
	g¡d
::
veùÜ
<
¡d
::
unique_±r
<[]>> 
ouut_bufãrs
;

47 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

48 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
desütÜ
.
·¿m‘”
(
i
);

49 ià(
	g·¿m‘”
.
is_š
()) {

51 ià(
	g·¿m‘”
.
is_poš‹r
()) {

52 
	g·¿ms
[
i
] = 
»ad”
.
·¿m‘”_add»ss
<
ušt64_t
>(i);

54 
	g·¿ms
[
i
] = 
»ad”
.
·¿m‘”
<
ušt64_t
>(i);

56 } ià(
	g·¿m‘”
.
is_out
()) {

58 
size_t
 
	gsize
;

59 ià(
	g·¿m‘”
.
is_bounded
()) {

60 
	gboundšg_šdex
 = 
·¿m‘”
.
boundšg_·¿m‘”
().
šdex
();

61 
	gsize
 = 
»ad”
.
·¿m‘”
<
size_t
>(
boundšg_šdex
);

63 
	gsize
 = 
·¿m‘”
.
size
();

65 
	gouut_bufãrs
.
em¶aû_back
(
Ãw
 [
size
]);

66 
	g·¿ms
[
i
] = 
»š‹½»t_ÿ¡
<
ušt64_t
>(
ouut_bufãrs
.
back
().
g‘
());

71 
ušt64_t
 
	g»suÉ
 = 
sysÿÎ
(
»ad”
.
sy¢o
(), 
·¿ms
[0],…arams[1],…arams[2],

72 
·¿ms
[3],…arams[4],…arams[5]);

75  
S”ŸlizeRe¥Ú£
(
»ad”
.
sy¢o
(), 
»suÉ
, 
·¿ms
, 
»¥Ú£
,

76 
»¥Ú£_®loÿtÜ
);

	@platform/system_call/untrusted_invoke.cc

19 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/uÁru¡ed_švoke.h
"

21 
	~<uni¡d.h
>

23 
	~<¬¿y
>

24 
	~<c¡dšt
>

25 
	~<memÜy
>

26 
	~<veùÜ
>

28 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/m‘ad©a.h
"

29 
	~"asylo/¶©fÜm/sy¡em_ÿÎ/£rŸlize.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

34 
	g´im™ives
::
Prim™iveStus
 
UÁru¡edInvoke
(

35 
´im™ives
::
Ex‹Á
 
»que¡
,…rim™ives::Ex‹Á *
»¥Ú£
,

36 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»¥Ú£_®loÿtÜ
) {

37 
Mes§geR—d”
 
»ad”
(
»que¡
);

38 
Sy¡emC®lDesütÜ
 
desütÜ
(
»ad”
.
sy¢o
());

41 
	g¡d
::
¬¿y
<
ušt64_t
, 
	gkP¬am‘”Max
> 
	g·¿ms
;

42 
	g·¿ms
.
fl
(0);

45 
	g¡d
::
veùÜ
<
¡d
::
unique_±r
<[]>> 
ouut_bufãrs
;

47 
	gi
 = 0; i < 
	gkP¬am‘”Max
; i++) {

48 
P¬am‘”DesütÜ
 
	g·¿m‘”
 = 
desütÜ
.
·¿m‘”
(
i
);

49 ià(
	g·¿m‘”
.
is_š
()) {

51 ià(
	g·¿m‘”
.
is_poš‹r
()) {

52 
	g·¿ms
[
i
] = 
»ad”
.
·¿m‘”_add»ss
<
ušt64_t
>(i);

54 
	g·¿ms
[
i
] = 
»ad”
.
·¿m‘”
<
ušt64_t
>(i);

56 } ià(
	g·¿m‘”
.
is_out
()) {

58 
size_t
 
	gsize
;

59 ià(
	g·¿m‘”
.
is_bounded
()) {

60 
	gboundšg_šdex
 = 
·¿m‘”
.
boundšg_·¿m‘”
().
šdex
();

61 
	gsize
 = 
»ad”
.
·¿m‘”
<
size_t
>(
boundšg_šdex
);

63 
	gsize
 = 
·¿m‘”
.
size
();

65 
	gouut_bufãrs
.
em¶aû_back
(
Ãw
 [
size
]);

66 
	g·¿ms
[
i
] = 
»š‹½»t_ÿ¡
<
ušt64_t
>(
ouut_bufãrs
.
back
().
g‘
());

71 
ušt64_t
 
	g»suÉ
 = 
sysÿÎ
(
»ad”
.
sy¢o
(), 
·¿ms
[0],…arams[1],…arams[2],

72 
·¿ms
[3],…arams[4],…arams[5]);

75  
S”ŸlizeRe¥Ú£
(
»ad”
.
sy¢o
(), 
»suÉ
, 
·¿ms
, 
»¥Ú£
,

76 
»¥Ú£_®loÿtÜ
);

	@platform/system_call/untrusted_invoke.h

19 #iâdeà
ASYLO_PLATFORM_SYSTEM_CALL_UNTRUSTED_INVOKE_H_


20 
	#ASYLO_PLATFORM_SYSTEM_CALL_UNTRUSTED_INVOKE_H_


	)

22 
	~<veùÜ
>

24 
	~"asylo/¶©fÜm/´im™ives/ex‹Á.h
"

25 
	~"asylo/¶©fÜm/´im™ives/´im™ive_¡©us.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gsy¡em_ÿÎ
 {

33 
	g´im™ives
::
Prim™iveStus
 
UÁru¡edInvoke
(

34 
´im™ives
::
Ex‹Á
 
»que¡
,…rim™ives::Ex‹Á *
»¥Ú£
,

35 cÚ¡ 
´im™ives
::
Ex‹ÁAÎoÿtÜ
 &
»¥Ú£_®loÿtÜ
 = 
nuÎ±r
);

	@test/grpc/channel_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"ab¦/time/time.h
"

23 
	~"asylo/ut/loggšg.h
"

24 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

25 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

26 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/ut/g½c_£rv”_Ïunch”.h
"

28 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

29 
	~"asylo/id’t™y/š™.h
"

30 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

31 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

32 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
	gkIÅut
[] = "foobar";

39 
cÚ¡ex´
 
	gkAdd»ss
[] = "[::1]";

40 cÚ¡ 
št64_t
 
	gkD—dlšeMiüos
 = 
ab¦
::
SecÚds
(10è/‡b¦::
Miüo£cÚds
(1);

42 
	sC»d’tŸlsCÚfig
 {

43 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
chªÃl_üed’tŸls
;

44 
	g¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
£rv”_üed’tŸls
;

47 
	gIn£cu»C»d’tŸlsCÚfig
 : 
public
 
C»d’tŸlsCÚfig
 {

48 
In£cu»C»d’tŸlsCÚfig
() {

49 
chªÃl_üed’tŸls
 = ::
g½c
::
In£cu»ChªÃlC»d’tŸls
();

50 
	g£rv”_üed’tŸls
 = ::
g½c
::
In£cu»S”v”C»d’tŸls
();

54 
	gEnşaveC»d’tŸlsCÚfig
 : 
public
 
C»d’tŸlsCÚfig
 {

55 
EnşaveC»d’tŸlsCÚfig
() {

56 
chªÃl_üed’tŸls
 = 
EnşaveChªÃlC»d’tŸls
(

57 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
());

58 
	g£rv”_üed’tŸls
 = 
EnşaveS”v”C»d’tŸls
(

59 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
());

64 
	g‹m¶©e
 <
ty³Çme
 
	gCÚfigT
>

65 şas 
	cChªÃlTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

66 
public
:

67 
S‘Up
(è
ov”ride
 {

69 
¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
authÜ™y_cÚfigs
 = {

70 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
()

74 
ASSERT_THAT
(
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

75 
authÜ™y_cÚfigs
.
cbegš
(),‡uthÜ™y_cÚfigs.
ûnd
()),

76 
IsOk
());

80 
usšg
 
	gTe¡Ty³s
 =

81 ::
‹¡šg
::
Ty³s
<
In£cu»C»d’tŸlsCÚfig
, 
	gEnşaveC»d’tŸlsCÚfig
>;

82 
TYPED_TEST_SUITE
(
ChªÃlTe¡
, 
Te¡Ty³s
);

84 
TYPED_TEST
(
ChªÃlTe¡
, 
EndToEnd
) {

85 
G½cS”v”Launch”
 
Ïunch”
("ChannelTest");

86 
Ty³P¬am
 
	gcÚfig
 = TypeParam();

87 
	gpÜt
 = 0;

88 
	g¡d
::
¡ršg
 
£rv”_add»ss
 = 
ab¦
::
SŒC©
(
kAdd»ss
, ":", 
pÜt
);

91 
ASSERT_THAT
(

92 
Ïunch”
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>()),

93 
IsOk
());

94 
ASSERT_THAT
(
Ïunch”
.
AddLi¡’šgPÜt
(
£rv”_add»ss
,

95 
cÚfig
.
£rv”_üed’tŸls
, &
pÜt
),

96 
IsOk
());

97 
ASSERT_THAT
(
Ïunch”
.
S¹
(), 
IsOk
());

98 
ASSERT_NE
(
pÜt
, 0);

101 
	g£rv”_add»ss
 = 
ab¦
::
SŒC©
(
kAdd»ss
, ":", 
pÜt
);

104 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl
 =

105 ::
g½c
::
C»©eChªÃl
(
£rv”_add»ss
, 
cÚfig
.
chªÃl_üed’tŸls
);

106 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 =

107 
g´_time_add
(
g´_now
(
GPR_CLOCK_REALTIME
),

108 
g´_time_äom_miüos
(
kD—dlšeMiüos
, 
GPR_TIMESPAN
));

109 
ASSERT_TRUE
(
chªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
));

112 
	g‹¡
::
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

113 
	gStusOr
<
	g¡d
::
¡ršg
> 
»suÉ
 = 
ş›Á
.
H–lo
(
kIÅut
);

114 
ASSERT_THAT
(
»suÉ
, 
IsOk
());

115 
EXPECT_EQ
(
»suÉ
.
V®ueOrD›
(),

116 
‹¡
::
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kIÅut
));

119 
ASSERT_THAT
(
Ïunch”
.
Shutdown
(), 
IsOk
());

	@test/grpc/channel_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"ab¦/time/time.h
"

23 
	~"asylo/ut/loggšg.h
"

24 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

25 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

26 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/ut/g½c_£rv”_Ïunch”.h
"

28 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

29 
	~"asylo/id’t™y/š™.h
"

30 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

31 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

32 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

38 
cÚ¡ex´
 
	gkIÅut
[] = "foobar";

39 
cÚ¡ex´
 
	gkAdd»ss
[] = "[::1]";

40 cÚ¡ 
št64_t
 
	gkD—dlšeMiüos
 = 
ab¦
::
SecÚds
(10è/‡b¦::
Miüo£cÚds
(1);

42 
	sC»d’tŸlsCÚfig
 {

43 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
chªÃl_üed’tŸls
;

44 
	g¡d
::
sh¬ed_±r
<::
g½c
::
S”v”C»d’tŸls
> 
£rv”_üed’tŸls
;

47 
	gIn£cu»C»d’tŸlsCÚfig
 : 
public
 
C»d’tŸlsCÚfig
 {

48 
In£cu»C»d’tŸlsCÚfig
() {

49 
chªÃl_üed’tŸls
 = ::
g½c
::
In£cu»ChªÃlC»d’tŸls
();

50 
	g£rv”_üed’tŸls
 = ::
g½c
::
In£cu»S”v”C»d’tŸls
();

54 
	gEnşaveC»d’tŸlsCÚfig
 : 
public
 
C»d’tŸlsCÚfig
 {

55 
EnşaveC»d’tŸlsCÚfig
() {

56 
chªÃl_üed’tŸls
 = 
EnşaveChªÃlC»d’tŸls
(

57 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
());

58 
	g£rv”_üed’tŸls
 = 
EnşaveS”v”C»d’tŸls
(

59 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
());

64 
	g‹m¶©e
 <
ty³Çme
 
	gCÚfigT
>

65 şas 
	cChªÃlTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

66 
public
:

67 
S‘Up
(è
ov”ride
 {

69 
¡d
::
veùÜ
<
EnşaveAs£¹iÚAuthÜ™yCÚfig
> 
authÜ™y_cÚfigs
 = {

70 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
()

74 
ASSERT_THAT
(
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

75 
authÜ™y_cÚfigs
.
cbegš
(),‡uthÜ™y_cÚfigs.
ûnd
()),

76 
IsOk
());

80 
usšg
 
	gTe¡Ty³s
 =

81 ::
‹¡šg
::
Ty³s
<
In£cu»C»d’tŸlsCÚfig
, 
	gEnşaveC»d’tŸlsCÚfig
>;

82 
TYPED_TEST_SUITE
(
ChªÃlTe¡
, 
Te¡Ty³s
);

84 
TYPED_TEST
(
ChªÃlTe¡
, 
EndToEnd
) {

85 
G½cS”v”Launch”
 
Ïunch”
("ChannelTest");

86 
Ty³P¬am
 
	gcÚfig
 = TypeParam();

87 
	gpÜt
 = 0;

88 
	g¡d
::
¡ršg
 
£rv”_add»ss
 = 
ab¦
::
SŒC©
(
kAdd»ss
, ":", 
pÜt
);

91 
ASSERT_THAT
(

92 
Ïunch”
.
Regi¡”S”viû
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>()),

93 
IsOk
());

94 
ASSERT_THAT
(
Ïunch”
.
AddLi¡’šgPÜt
(
£rv”_add»ss
,

95 
cÚfig
.
£rv”_üed’tŸls
, &
pÜt
),

96 
IsOk
());

97 
ASSERT_THAT
(
Ïunch”
.
S¹
(), 
IsOk
());

98 
ASSERT_NE
(
pÜt
, 0);

101 
	g£rv”_add»ss
 = 
ab¦
::
SŒC©
(
kAdd»ss
, ":", 
pÜt
);

104 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl
 =

105 ::
g½c
::
C»©eChªÃl
(
£rv”_add»ss
, 
cÚfig
.
chªÃl_üed’tŸls
);

106 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 =

107 
g´_time_add
(
g´_now
(
GPR_CLOCK_REALTIME
),

108 
g´_time_äom_miüos
(
kD—dlšeMiüos
, 
GPR_TIMESPAN
));

109 
ASSERT_TRUE
(
chªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
));

112 
	g‹¡
::
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

113 
	gStusOr
<
	g¡d
::
¡ršg
> 
»suÉ
 = 
ş›Á
.
H–lo
(
kIÅut
);

114 
ASSERT_THAT
(
»suÉ
, 
IsOk
());

115 
EXPECT_EQ
(
»suÉ
.
V®ueOrD›
(),

116 
‹¡
::
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kIÅut
));

119 
ASSERT_THAT
(
Ïunch”
.
Shutdown
(), 
IsOk
());

	@test/grpc/client_enclave.cc

19 
	~"asylo/‹¡/g½c/ş›Á_’şave.h
"

21 
	~<memÜy
>

22 
	~<¡ršg
>

24 
	~"ab¦/time/time.h
"

25 
	~"asylo/’şave.pb.h
"

26 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

27 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

28 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

29 
	~"asylo/‹¡/g½c/ş›Á_’şave.pb.h
"

30 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

31 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

32 
	~"asylo/ut/¡©us.h
"

33 
	~"asylo/ut/¡©us_maüos.h
"

34 
	~"šşude/g½c/im¶/codeg’/g´_ty³s.h
"

35 
	~"šşude/g½c/suµÜt/time.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 cÚ¡ 
št64_t
 
	gkD—dlšeMiüos
 = 
ab¦
::
SecÚds
(10è/‡b¦::
Miüo£cÚds
(1);

45 
EnşaveC»d’tŸlsO±iÚs
 
G‘C»d’tŸlsO±iÚs
(

46 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> 
ty³s
, 
boŞ
 
£lf
) {

47 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

48 
	gty³
 : 
ty³s
) {

49 
¡©ic_ÿ¡
<
G½cC»d’tŸlsO±iÚsTy³
>(
ty³
)) {

50 
NULL_GRPC_CREDENTIALS_OPTIONS
:

51 
İtiÚs
.
Add
(
£lf
 ? 
S–fNuÎC»d’tŸlsO±iÚs
()

52 : 
P“rNuÎC»d’tŸlsO±iÚs
());

54 
	gSGX_LOCAL_GRPC_CREDENTIALS_OPTIONS
:

55 
İtiÚs
.
Add
(
£lf
 ? 
S–fSgxLoÿlC»d’tŸlsO±iÚs
()

56 : 
P“rSgxLoÿlC»d’tŸlsO±iÚs
());

58 
	gUNKNOWN_GRPC_CREDENTIALS_OPTIONS
:

63  
	gİtiÚs
;

68 
Stus
 
	gCl›ÁEnşave
::
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

69 ià(!
	gšput
.
HasEx‹nsiÚ
(
ş›Á_’şave_šput
)) {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 cÚ¡ 
	gCl›ÁEnşaveIÅut
 &
	gş›Á_šput
 =

74 
šput
.
G‘Ex‹nsiÚ
(
ş›Á_’şave_šput
);

76 cÚ¡ 
	g¡d
::
¡ršg
 &
add»ss
 = 
ş›Á_šput
.
£rv”_add»ss
();

77 ià(
	gadd»ss
.
em±y
()) {

78  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

81 cÚ¡ 
	g¡d
::
¡ršg
 &
½c_šput
 = 
ş›Á_šput
.rpc_input();

82 ià(
	g½c_šput
.
em±y
()) {

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

87 cÚ¡ 
št64_t
 
	gcÚÃùiÚ_d—dlše
 =

88 
ş›Á_šput
.
has_cÚÃùiÚ_d—dlše_mli£cÚds
()

89 ? 
ab¦
::
Mli£cÚds
(

90 
ş›Á_šput
.
cÚÃùiÚ_d—dlše_mli£cÚds
()) /

91 
ab¦
::
Miüo£cÚds
(1)

92 : 
kD—dlšeMiüos
;

94 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
chªÃl_üed’tŸls
 =

95 
EnşaveChªÃlC»d’tŸls
(

96 
G‘C»d’tŸlsO±iÚs
(
ş›Á_šput
.
£lf_g½c_üeds_İtiÚs
(),

97  
Œue
)

98 .
Add
(
G‘C»d’tŸlsO±iÚs
(
ş›Á_šput
.
³”_g½c_üeds_İtiÚs
(),

99  
çl£
)));

102 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl
 =

103 ::
g½c
::
C»©eChªÃl
(
add»ss
, 
chªÃl_üed’tŸls
);

104 
	g‹¡
::
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

105 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 =

106 
g´_time_add
(
g´_now
(
GPR_CLOCK_REALTIME
),

107 
g´_time_äom_miüos
(
cÚÃùiÚ_d—dlše
, 
GPR_TIMESPAN
));

108 ià(!
	gchªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
)) {

109  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo connecto server");

113 
	g¡d
::
¡ršg
 
»suÉ
;

114 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
ş›Á
.
H–lo
(
½c_šput
));

115 
	gouut
->
S‘Ex‹nsiÚ
(
½c_»suÉ
, 
»suÉ
);

116  
	gStus
::
OkStus
();

119 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Cl›ÁEnşave
(); }

	@test/grpc/client_enclave.cc

19 
	~"asylo/‹¡/g½c/ş›Á_’şave.h
"

21 
	~<memÜy
>

22 
	~<¡ršg
>

24 
	~"ab¦/time/time.h
"

25 
	~"asylo/’şave.pb.h
"

26 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

27 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

28 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

29 
	~"asylo/‹¡/g½c/ş›Á_’şave.pb.h
"

30 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

31 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

32 
	~"asylo/ut/¡©us.h
"

33 
	~"asylo/ut/¡©us_maüos.h
"

34 
	~"šşude/g½c/im¶/codeg’/g´_ty³s.h
"

35 
	~"šşude/g½c/suµÜt/time.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
	gÇme¥aû
 {

40 cÚ¡ 
št64_t
 
	gkD—dlšeMiüos
 = 
ab¦
::
SecÚds
(10è/‡b¦::
Miüo£cÚds
(1);

45 
EnşaveC»d’tŸlsO±iÚs
 
G‘C»d’tŸlsO±iÚs
(

46 cÚ¡ 
googË
::
´Ùobuf
::
R•—‹dF›ld
<> 
ty³s
, 
boŞ
 
£lf
) {

47 
EnşaveC»d’tŸlsO±iÚs
 
	gİtiÚs
;

48 
	gty³
 : 
ty³s
) {

49 
¡©ic_ÿ¡
<
G½cC»d’tŸlsO±iÚsTy³
>(
ty³
)) {

50 
NULL_GRPC_CREDENTIALS_OPTIONS
:

51 
İtiÚs
.
Add
(
£lf
 ? 
S–fNuÎC»d’tŸlsO±iÚs
()

52 : 
P“rNuÎC»d’tŸlsO±iÚs
());

54 
	gSGX_LOCAL_GRPC_CREDENTIALS_OPTIONS
:

55 
İtiÚs
.
Add
(
£lf
 ? 
S–fSgxLoÿlC»d’tŸlsO±iÚs
()

56 : 
P“rSgxLoÿlC»d’tŸlsO±iÚs
());

58 
	gUNKNOWN_GRPC_CREDENTIALS_OPTIONS
:

63  
	gİtiÚs
;

68 
Stus
 
	gCl›ÁEnşave
::
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

69 ià(!
	gšput
.
HasEx‹nsiÚ
(
ş›Á_’şave_šput
)) {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

73 cÚ¡ 
	gCl›ÁEnşaveIÅut
 &
	gş›Á_šput
 =

74 
šput
.
G‘Ex‹nsiÚ
(
ş›Á_’şave_šput
);

76 cÚ¡ 
	g¡d
::
¡ršg
 &
add»ss
 = 
ş›Á_šput
.
£rv”_add»ss
();

77 ià(
	gadd»ss
.
em±y
()) {

78  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

81 cÚ¡ 
	g¡d
::
¡ršg
 &
½c_šput
 = 
ş›Á_šput
.rpc_input();

82 ià(
	g½c_šput
.
em±y
()) {

83  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

87 cÚ¡ 
št64_t
 
	gcÚÃùiÚ_d—dlše
 =

88 
ş›Á_šput
.
has_cÚÃùiÚ_d—dlše_mli£cÚds
()

89 ? 
ab¦
::
Mli£cÚds
(

90 
ş›Á_šput
.
cÚÃùiÚ_d—dlše_mli£cÚds
()) /

91 
ab¦
::
Miüo£cÚds
(1)

92 : 
kD—dlšeMiüos
;

94 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
chªÃl_üed’tŸls
 =

95 
EnşaveChªÃlC»d’tŸls
(

96 
G‘C»d’tŸlsO±iÚs
(
ş›Á_šput
.
£lf_g½c_üeds_İtiÚs
(),

97  
Œue
)

98 .
Add
(
G‘C»d’tŸlsO±iÚs
(
ş›Á_šput
.
³”_g½c_üeds_İtiÚs
(),

99  
çl£
)));

102 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃl
> 
chªÃl
 =

103 ::
g½c
::
C»©eChªÃl
(
add»ss
, 
chªÃl_üed’tŸls
);

104 
	g‹¡
::
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

105 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 =

106 
g´_time_add
(
g´_now
(
GPR_CLOCK_REALTIME
),

107 
g´_time_äom_miüos
(
cÚÃùiÚ_d—dlše
, 
GPR_TIMESPAN
));

108 ià(!
	gchªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
)) {

109  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Failedo connecto server");

113 
	g¡d
::
¡ršg
 
»suÉ
;

114 
ASYLO_ASSIGN_OR_RETURN
(
»suÉ
, 
ş›Á
.
H–lo
(
½c_šput
));

115 
	gouut
->
S‘Ex‹nsiÚ
(
½c_»suÉ
, 
»suÉ
);

116  
	gStus
::
OkStus
();

119 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Cl›ÁEnşave
(); }

	@test/grpc/client_enclave.h

19 #iâdeà
ASYLO_TEST_GRPC_CLIENT_ENCLAVE_H_


20 
	#ASYLO_TEST_GRPC_CLIENT_ENCLAVE_H_


	)

22 
	~"asylo/’şave.pb.h
"

23 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

29 şas 
	cCl›ÁEnşave
 : 
public
 
Tru¡edAµliÿtiÚ
 {

30 
public
:

36 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gov”ride
;

	@test/grpc/enclave_communication_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"asylo/’şave.pb.h
"

23 
	~"asylo/g½c/ut/’şave_£rv”.pb.h
"

24 
	~"asylo/‹¡/g½c/ş›Á_’şave.pb.h
"

25 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

26 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡_Ïunch”.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
	~"asylo/‹¡/ut/‹¡_æags.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
DEFINE_¡ršg
(
ş›Á_’şave_·th
, "", "Patho clientƒnclave");

37 
DEFINE_¡ršg
(
£rv”_’şave_·th
, "", "Patho serverƒnclave");

39 
cÚ¡ex´
 
	gkName
[] = "Mellanie Rescorai";

45 şas 
	cEnşaveCommuniÿtiÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

46 
´Ùeùed
:

47 
S‘Up
(è
ov”ride
 {

49 
EnşaveCÚfig
 
cÚfig
;

50 ià(!
	gFLAGS_‹¡_tmpdœ
.
em±y
()) {

51 
	gcÚfig
.
mubË_loggšg_cÚfig
()->
£t_log_dœeùÜy
(
FLAGS_‹¡_tmpdœ
);

55 *
	gcÚfig
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

56 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
();

57 *
	gcÚfig
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

58 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
();

60 
ASSERT_THAT
(
S‘UpS”v”
(
cÚfig
), 
IsOk
());

61 
ASSERT_THAT
(
S‘UpCl›Á
(
cÚfig
), 
IsOk
());

64 
Stus
 
S‘UpS”v”
(
EnşaveCÚfig
 
cÚfig
) {

66 
S”v”CÚfig
 *
	g£rv”_cÚfig
 = 
cÚfig
.
MubËEx‹nsiÚ
(
£rv”_šput_cÚfig
);

67 
	g£rv”_cÚfig
->
£t_ho¡
("[::1]");

68 
	g£rv”_cÚfig
->
£t_pÜt
(0);

70 
ASYLO_RETURN_IF_ERROR
(
£rv”_Ïunch”_
.
S‘Up
(
FLAGS_£rv”_’şave_·th
,

71 
cÚfig
, "/grpc/server"));

74 
EnşaveOuut
 
	gouut
;

75 
ASYLO_RETURN_IF_ERROR
(

76 
£rv”_Ïunch”_
.
mubË_ş›Á
()->
EÁ”AndRun
Ğ{}, &
ouut
));

78 ià(!
	gouut
.
HasEx‹nsiÚ
(
£rv”_ouut_cÚfig
)) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

83 cÚ¡ 
	gS”v”CÚfig
 &
	gfš®_£rv”_cÚfig
 =

84 
ouut
.
G‘Ex‹nsiÚ
(
£rv”_ouut_cÚfig
);

85 
	g£rv”_add»ss_
 = 
ab¦
::
SŒC©
(
fš®_£rv”_cÚfig
.
ho¡
(), ":",

86 
fš®_£rv”_cÚfig
.
pÜt
());

88  
	gStus
::
OkStus
();

91 
Stus
 
S‘UpCl›Á
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

92 
ASYLO_RETURN_IF_ERROR
(
ş›Á_Ïunch”_
.
S‘Up
(
FLAGS_ş›Á_’şave_·th
,

93 
cÚfig
, "/grpc/client"));

94 
	gg½c_ş›Á_’şave_
 = 
ş›Á_Ïunch”_
.
mubË_ş›Á
();

95  
	gStus
::
OkStus
();

98 
T—rDown
(è
	gov”ride
 {

99 
EnşaveFš®
 
	g’şave_fš®
;

101 
EXPECT_THAT
(

102 
ş›Á_Ïunch”_
.
T—rDown
(
’şave_fš®
, 
çl£
),

103 
IsOk
());

104 
EXPECT_THAT
(

105 
£rv”_Ïunch”_
.
T—rDown
(
’şave_fš®
, 
çl£
),

106 
IsOk
());

109 
EnşaveTe¡Launch”
 
	gş›Á_Ïunch”_
;

110 
EnşaveTe¡Launch”
 
	g£rv”_Ïunch”_
;

111 
EnşaveCl›Á
 *
	gg½c_ş›Á_’şave_
;

112 
	g¡d
::
¡ršg
 
£rv”_add»ss_
;

115 
TEST_F
(
EnşaveCommuniÿtiÚTe¡
, 
Sim¶eSynchrÚousRpc
) {

116 
EnşaveIÅut
 
	gšput
;

117 
Cl›ÁEnşaveIÅut
 
	gş›Á_šput
;

118 
	gş›Á_šput
.
£t_£rv”_add»ss
(
£rv”_add»ss_
);

119 
	gş›Á_šput
.
£t_½c_šput
(
kName
);

121 
	gş›Á_šput
.
add_£lf_g½c_üeds_İtiÚs
(
SGX_LOCAL_GRPC_CREDENTIALS_OPTIONS
);

122 
	gş›Á_šput
.
add_³”_g½c_üeds_İtiÚs
(
SGX_LOCAL_GRPC_CREDENTIALS_OPTIONS
);

123 *
	gšput
.
MubËEx‹nsiÚ
(
ş›Á_’şave_šput
èğ
ş›Á_šput
;

124 
EnşaveOuut
 
	gouut
;

125 
ASSERT_THAT
(
g½c_ş›Á_’şave_
->
EÁ”AndRun
(
šput
, &
ouut
), 
IsOk
());

126 
EXPECT_EQ
(
ouut
.
G‘Ex‹nsiÚ
(
½c_»suÉ
),

127 
‹¡
::
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kName
));

	@test/grpc/enclave_communication_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"asylo/’şave.pb.h
"

23 
	~"asylo/g½c/ut/’şave_£rv”.pb.h
"

24 
	~"asylo/‹¡/g½c/ş›Á_’şave.pb.h
"

25 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

26 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡_Ïunch”.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
	~"asylo/‹¡/ut/‹¡_æags.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
DEFINE_¡ršg
(
ş›Á_’şave_·th
, "", "Patho clientƒnclave");

37 
DEFINE_¡ršg
(
£rv”_’şave_·th
, "", "Patho serverƒnclave");

39 
cÚ¡ex´
 
	gkName
[] = "Mellanie Rescorai";

45 şas 
	cEnşaveCommuniÿtiÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

46 
´Ùeùed
:

47 
S‘Up
(è
ov”ride
 {

49 
EnşaveCÚfig
 
cÚfig
;

50 ià(!
	gFLAGS_‹¡_tmpdœ
.
em±y
()) {

51 
	gcÚfig
.
mubË_loggšg_cÚfig
()->
£t_log_dœeùÜy
(
FLAGS_‹¡_tmpdœ
);

55 *
	gcÚfig
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

56 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
();

57 *
	gcÚfig
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

58 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
();

60 
ASSERT_THAT
(
S‘UpS”v”
(
cÚfig
), 
IsOk
());

61 
ASSERT_THAT
(
S‘UpCl›Á
(
cÚfig
), 
IsOk
());

64 
Stus
 
S‘UpS”v”
(
EnşaveCÚfig
 
cÚfig
) {

66 
S”v”CÚfig
 *
	g£rv”_cÚfig
 = 
cÚfig
.
MubËEx‹nsiÚ
(
£rv”_šput_cÚfig
);

67 
	g£rv”_cÚfig
->
£t_ho¡
("[::1]");

68 
	g£rv”_cÚfig
->
£t_pÜt
(0);

70 
ASYLO_RETURN_IF_ERROR
(
£rv”_Ïunch”_
.
S‘Up
(
FLAGS_£rv”_’şave_·th
,

71 
cÚfig
, "/grpc/server"));

74 
EnşaveOuut
 
	gouut
;

75 
ASYLO_RETURN_IF_ERROR
(

76 
£rv”_Ïunch”_
.
mubË_ş›Á
()->
EÁ”AndRun
Ğ{}, &
ouut
));

78 ià(!
	gouut
.
HasEx‹nsiÚ
(
£rv”_ouut_cÚfig
)) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

83 cÚ¡ 
	gS”v”CÚfig
 &
	gfš®_£rv”_cÚfig
 =

84 
ouut
.
G‘Ex‹nsiÚ
(
£rv”_ouut_cÚfig
);

85 
	g£rv”_add»ss_
 = 
ab¦
::
SŒC©
(
fš®_£rv”_cÚfig
.
ho¡
(), ":",

86 
fš®_£rv”_cÚfig
.
pÜt
());

88  
	gStus
::
OkStus
();

91 
Stus
 
S‘UpCl›Á
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

92 
ASYLO_RETURN_IF_ERROR
(
ş›Á_Ïunch”_
.
S‘Up
(
FLAGS_ş›Á_’şave_·th
,

93 
cÚfig
, "/grpc/client"));

94 
	gg½c_ş›Á_’şave_
 = 
ş›Á_Ïunch”_
.
mubË_ş›Á
();

95  
	gStus
::
OkStus
();

98 
T—rDown
(è
	gov”ride
 {

99 
EnşaveFš®
 
	g’şave_fš®
;

101 
EXPECT_THAT
(

102 
ş›Á_Ïunch”_
.
T—rDown
(
’şave_fš®
, 
çl£
),

103 
IsOk
());

104 
EXPECT_THAT
(

105 
£rv”_Ïunch”_
.
T—rDown
(
’şave_fš®
, 
çl£
),

106 
IsOk
());

109 
EnşaveTe¡Launch”
 
	gş›Á_Ïunch”_
;

110 
EnşaveTe¡Launch”
 
	g£rv”_Ïunch”_
;

111 
EnşaveCl›Á
 *
	gg½c_ş›Á_’şave_
;

112 
	g¡d
::
¡ršg
 
£rv”_add»ss_
;

115 
TEST_F
(
EnşaveCommuniÿtiÚTe¡
, 
Sim¶eSynchrÚousRpc
) {

116 
EnşaveIÅut
 
	gšput
;

117 
Cl›ÁEnşaveIÅut
 
	gş›Á_šput
;

118 
	gş›Á_šput
.
£t_£rv”_add»ss
(
£rv”_add»ss_
);

119 
	gş›Á_šput
.
£t_½c_šput
(
kName
);

121 
	gş›Á_šput
.
add_£lf_g½c_üeds_İtiÚs
(
SGX_LOCAL_GRPC_CREDENTIALS_OPTIONS
);

122 
	gş›Á_šput
.
add_³”_g½c_üeds_İtiÚs
(
SGX_LOCAL_GRPC_CREDENTIALS_OPTIONS
);

123 *
	gšput
.
MubËEx‹nsiÚ
(
ş›Á_’şave_šput
èğ
ş›Á_šput
;

124 
EnşaveOuut
 
	gouut
;

125 
ASSERT_THAT
(
g½c_ş›Á_’şave_
->
EÁ”AndRun
(
šput
, &
ouut
), 
IsOk
());

126 
EXPECT_EQ
(
ouut
.
G‘Ex‹nsiÚ
(
½c_»suÉ
),

127 
‹¡
::
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kName
));

	@test/grpc/enclave_insecure_server.cc

19 
	~<memÜy
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"asylo/g½c/ut/’şave_£rv”.h
"

23 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

24 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

26 
Çme¥aû
 
	gasylo
 {

30 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

31  
Ãw
 
EnşaveS”v”
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>(),

32 ::
g½c
::
In£cu»S”v”C»d’tŸls
());

	@test/grpc/enclave_insecure_server.cc

19 
	~<memÜy
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"asylo/g½c/ut/’şave_£rv”.h
"

23 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

24 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

26 
Çme¥aû
 
	gasylo
 {

30 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

31  
Ãw
 
EnşaveS”v”
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>(),

32 ::
g½c
::
In£cu»S”v”C»d’tŸls
());

	@test/grpc/enclave_insecure_server_test.cc

19 
	~<c¡dšt
>

20 
	~<th»ad
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"asylo/g½c/ut/’şave_£rv”.pb.h
"

25 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

26 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
	~"šşude/g½ıp/chªÃl.h
"

30 
	~"šşude/g½ıp/ü—‹_chªÃl.h
"

31 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	g‹¡
 {

35 
	gÇme¥aû
 {

37 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
cÚ¡ex´
 
	gkName
[] = "test";

41 
cÚ¡ex´
 cÚ¡ 
	gkAdd»ss
[] = "[::1]";

43 şas 
	cEnşaveS”v”Te¡
 : 
public
 
EnşaveTe¡
 {

44 
´Ùeùed
:

45 
S‘Up
(è
ov”ride
 {

46 
S”v”CÚfig
 *
cÚfig
 = 
cÚfig_
.
MubËEx‹nsiÚ
(
£rv”_šput_cÚfig
);

47 
	gcÚfig
->
£t_ho¡
(
kAdd»ss
);

49 
	gcÚfig
->
£t_pÜt
(0);

50 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
->
ho¡
(), ":", cÚfig->
pÜt
());

51 
	gEnşaveTe¡
::
S‘Up
();

54 
	g¡d
::
¡ršg
 
add»ss_
;

57 
TEST_F
(
EnşaveS”v”Te¡
, 
Sim¶eEnd2EndTe¡
) {

60 
EnşaveOuut
 
	gouut
;

61 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRun
Ğ{}, &
ouut
), 
IsOk
());

62 
ASSERT_TRUE
(
ouut
.
HasEx‹nsiÚ
(
£rv”_ouut_cÚfig
));

63 cÚ¡ 
	gS”v”CÚfig
 &
	gcÚfig
 = 
ouut
.
G‘Ex‹nsiÚ
(
£rv”_ouut_cÚfig
);

64 
ASSERT_NE
(
cÚfig
.
pÜt
(), 0);

65 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
.
ho¡
(), ":", cÚfig.
pÜt
());

69 autØ
	gchªÃl
 =

70 ::
g½c
::
C»©eChªÃl
(
add»ss_
, ::g½c::
In£cu»ChªÃlC»d’tŸls
());

71 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 = 
g´_time_add
(

72 
g´_now
(
GPR_CLOCK_REALTIME
),

73 
g´_time_äom_miüos
(
¡©ic_ÿ¡
<
št64_t
>(30 * 1e6), 
GPR_TIMESPAN
));

74 
EXPECT_TRUE
(
chªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
));

76 
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

78 
	gStusOr
<
	g¡d
::
¡ršg
> 
»¥Ú£
 = 
ş›Á
.
H–lo
(
kName
);

79 
ASSERT_THAT
(
»¥Ú£
, 
IsOk
());

80 
EXPECT_EQ
(
»¥Ú£
.
V®ueOrD›
(), 
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kName
));

82 
	g»¥Ú£
 = 
ş›Á
.
H–lo
("");

83 
EXPECT_THAT
(
»¥Ú£
, 
NÙ
(
IsOk
()));

	@test/grpc/enclave_insecure_server_test.cc

19 
	~<c¡dšt
>

20 
	~<th»ad
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"asylo/g½c/ut/’şave_£rv”.pb.h
"

25 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

26 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
	~"šşude/g½ıp/chªÃl.h
"

30 
	~"šşude/g½ıp/ü—‹_chªÃl.h
"

31 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	g‹¡
 {

35 
	gÇme¥aû
 {

37 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
cÚ¡ex´
 
	gkName
[] = "test";

41 
cÚ¡ex´
 cÚ¡ 
	gkAdd»ss
[] = "[::1]";

43 şas 
	cEnşaveS”v”Te¡
 : 
public
 
EnşaveTe¡
 {

44 
´Ùeùed
:

45 
S‘Up
(è
ov”ride
 {

46 
S”v”CÚfig
 *
cÚfig
 = 
cÚfig_
.
MubËEx‹nsiÚ
(
£rv”_šput_cÚfig
);

47 
	gcÚfig
->
£t_ho¡
(
kAdd»ss
);

49 
	gcÚfig
->
£t_pÜt
(0);

50 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
->
ho¡
(), ":", cÚfig->
pÜt
());

51 
	gEnşaveTe¡
::
S‘Up
();

54 
	g¡d
::
¡ršg
 
add»ss_
;

57 
TEST_F
(
EnşaveS”v”Te¡
, 
Sim¶eEnd2EndTe¡
) {

60 
EnşaveOuut
 
	gouut
;

61 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRun
Ğ{}, &
ouut
), 
IsOk
());

62 
ASSERT_TRUE
(
ouut
.
HasEx‹nsiÚ
(
£rv”_ouut_cÚfig
));

63 cÚ¡ 
	gS”v”CÚfig
 &
	gcÚfig
 = 
ouut
.
G‘Ex‹nsiÚ
(
£rv”_ouut_cÚfig
);

64 
ASSERT_NE
(
cÚfig
.
pÜt
(), 0);

65 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
.
ho¡
(), ":", cÚfig.
pÜt
());

69 autØ
	gchªÃl
 =

70 ::
g½c
::
C»©eChªÃl
(
add»ss_
, ::g½c::
In£cu»ChªÃlC»d’tŸls
());

71 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 = 
g´_time_add
(

72 
g´_now
(
GPR_CLOCK_REALTIME
),

73 
g´_time_äom_miüos
(
¡©ic_ÿ¡
<
št64_t
>(30 * 1e6), 
GPR_TIMESPAN
));

74 
EXPECT_TRUE
(
chªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
));

76 
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

78 
	gStusOr
<
	g¡d
::
¡ršg
> 
»¥Ú£
 = 
ş›Á
.
H–lo
(
kName
);

79 
ASSERT_THAT
(
»¥Ú£
, 
IsOk
());

80 
EXPECT_EQ
(
»¥Ú£
.
V®ueOrD›
(), 
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kName
));

82 
	g»¥Ú£
 = 
ş›Á
.
H–lo
("");

83 
EXPECT_THAT
(
»¥Ú£
, 
NÙ
(
IsOk
()));

	@test/grpc/enclave_secure_server.cc

19 
	~<”ºo.h
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

25 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

26 
	~"asylo/g½c/ut/’şave_£rv”.h
"

27 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

28 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

30 
Çme¥aû
 
	gasylo
 {

34 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

35  
Ãw
 
EnşaveS”v”
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>(),

36 
EnşaveS”v”C»d’tŸls
(

37 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
()));

	@test/grpc/enclave_secure_server.cc

19 
	~<”ºo.h
>

20 
	~<memÜy
>

21 
	~<¡ršg
>

23 
	~"ab¦/memÜy/memÜy.h
"

24 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

25 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

26 
	~"asylo/g½c/ut/’şave_£rv”.h
"

27 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

28 
	~"šşude/g½ıp/£cur™y/£rv”_üed’tŸls.h
"

30 
Çme¥aû
 
	gasylo
 {

34 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

35  
Ãw
 
EnşaveS”v”
(
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>(),

36 
EnşaveS”v”C»d’tŸls
(

37 
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
()));

	@test/grpc/enclave_secure_server_test.cc

19 
	~<c¡dšt
>

20 
	~<th»ad
>

21 
	~<veùÜ
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

26 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/ut/’şave_£rv”.pb.h
"

28 
	~"asylo/id’t™y/š™.h
"

29 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

30 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

31 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

32 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
	~"šşude/g½ıp/chªÃl.h
"

35 
	~"šşude/g½ıp/ü—‹_chªÃl.h
"

36 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	g‹¡
 {

40 
	gÇme¥aû
 {

42 
	gusšg
 ::
‹¡šg
::
NÙ
;

44 
cÚ¡ex´
 
	gkName
[] = "test";

46 
cÚ¡ex´
 cÚ¡ 
	gkAdd»ss
[] = "[::1]";

49 şas 
	cEnşaveSecu»G½cTe¡
 : 
public
 
EnşaveTe¡
 {

50 
´Ùeùed
:

51 
S‘Up
(è
ov”ride
 {

53 *
cÚfig_
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

54 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
();

58 
ASSERT_THAT
(
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

59 
cÚfig_
.
’şave_as£¹iÚ_authÜ™y_cÚfigs
().
cbegš
(),

60 
cÚfig_
.
’şave_as£¹iÚ_authÜ™y_cÚfigs
().
ûnd
()),

61 
IsOk
());

64 
S”v”CÚfig
 *
	gcÚfig
 = 
cÚfig_
.
MubËEx‹nsiÚ
(
£rv”_šput_cÚfig
);

65 
	gcÚfig
->
£t_ho¡
(
kAdd»ss
);

67 
	gcÚfig
->
£t_pÜt
(0);

68 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
->
ho¡
(), ":", cÚfig->
pÜt
());

70 
	gEnşaveTe¡
::
S‘Up
();

73 
	g¡d
::
¡ršg
 
add»ss_
;

78 
TEST_F
(
EnşaveSecu»G½cTe¡
, 
Sim¶eEnd2EndTe¡
) {

81 
EnşaveOuut
 
	gouut
;

82 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRun
Ğ{}, &
ouut
), 
IsOk
());

83 
ASSERT_TRUE
(
ouut
.
HasEx‹nsiÚ
(
£rv”_ouut_cÚfig
));

84 cÚ¡ 
	gS”v”CÚfig
 &
	gcÚfig
 = 
ouut
.
G‘Ex‹nsiÚ
(
£rv”_ouut_cÚfig
);

85 
ASSERT_NE
(
cÚfig
.
pÜt
(), 0);

86 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
.
ho¡
(), ":", cÚfig.
pÜt
());

90 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
chªÃl_üed’tŸls
 =

91 
EnşaveChªÃlC»d’tŸls
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
());

95 autØ
	gchªÃl
 = ::
g½c
::
C»©eChªÃl
(
add»ss_
, 
chªÃl_üed’tŸls
);

96 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 = 
g´_time_add
(

97 
g´_now
(
GPR_CLOCK_REALTIME
),

98 
g´_time_äom_miüos
(
¡©ic_ÿ¡
<
št64_t
>(30 * 1e6), 
GPR_TIMESPAN
));

99 
EXPECT_TRUE
(
chªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
));

101 
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

103 
	gStusOr
<
	g¡d
::
¡ršg
> 
»¥Ú£
 = 
ş›Á
.
H–lo
(
kName
);

104 
ASSERT_THAT
(
»¥Ú£
, 
IsOk
());

105 
EXPECT_EQ
(
»¥Ú£
.
V®ueOrD›
(), 
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kName
));

107 
	g»¥Ú£
 = 
ş›Á
.
H–lo
("");

108 
EXPECT_THAT
(
»¥Ú£
, 
NÙ
(
IsOk
()));

	@test/grpc/enclave_secure_server_test.cc

19 
	~<c¡dšt
>

20 
	~<th»ad
>

21 
	~<veùÜ
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"asylo/g½c/auth/’şave_chªÃl_üed’tŸls.h
"

26 
	~"asylo/g½c/auth/nuÎ_üed’tŸls_İtiÚs.h
"

27 
	~"asylo/g½c/ut/’şave_£rv”.pb.h
"

28 
	~"asylo/id’t™y/š™.h
"

29 
	~"asylo/‹¡/g½c/mes£ng”_ş›Á_im¶.h
"

30 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

31 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

32 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

33 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

34 
	~"šşude/g½ıp/chªÃl.h
"

35 
	~"šşude/g½ıp/ü—‹_chªÃl.h
"

36 
	~"šşude/g½ıp/£cur™y/üed’tŸls.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
Çme¥aû
 
	g‹¡
 {

40 
	gÇme¥aû
 {

42 
	gusšg
 ::
‹¡šg
::
NÙ
;

44 
cÚ¡ex´
 
	gkName
[] = "test";

46 
cÚ¡ex´
 cÚ¡ 
	gkAdd»ss
[] = "[::1]";

49 şas 
	cEnşaveSecu»G½cTe¡
 : 
public
 
EnşaveTe¡
 {

50 
´Ùeùed
:

51 
S‘Up
(è
ov”ride
 {

53 *
cÚfig_
.
add_’şave_as£¹iÚ_authÜ™y_cÚfigs
() =

54 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
();

58 
ASSERT_THAT
(
In™ŸlizeEnşaveAs£¹iÚAuthÜ™›s
(

59 
cÚfig_
.
’şave_as£¹iÚ_authÜ™y_cÚfigs
().
cbegš
(),

60 
cÚfig_
.
’şave_as£¹iÚ_authÜ™y_cÚfigs
().
ûnd
()),

61 
IsOk
());

64 
S”v”CÚfig
 *
	gcÚfig
 = 
cÚfig_
.
MubËEx‹nsiÚ
(
£rv”_šput_cÚfig
);

65 
	gcÚfig
->
£t_ho¡
(
kAdd»ss
);

67 
	gcÚfig
->
£t_pÜt
(0);

68 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
->
ho¡
(), ":", cÚfig->
pÜt
());

70 
	gEnşaveTe¡
::
S‘Up
();

73 
	g¡d
::
¡ršg
 
add»ss_
;

78 
TEST_F
(
EnşaveSecu»G½cTe¡
, 
Sim¶eEnd2EndTe¡
) {

81 
EnşaveOuut
 
	gouut
;

82 
ASSERT_THAT
(
ş›Á_
->
EÁ”AndRun
Ğ{}, &
ouut
), 
IsOk
());

83 
ASSERT_TRUE
(
ouut
.
HasEx‹nsiÚ
(
£rv”_ouut_cÚfig
));

84 cÚ¡ 
	gS”v”CÚfig
 &
	gcÚfig
 = 
ouut
.
G‘Ex‹nsiÚ
(
£rv”_ouut_cÚfig
);

85 
ASSERT_NE
(
cÚfig
.
pÜt
(), 0);

86 
	gadd»ss_
 = 
ab¦
::
SŒC©
(
cÚfig
.
ho¡
(), ":", cÚfig.
pÜt
());

90 
	g¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlC»d’tŸls
> 
chªÃl_üed’tŸls
 =

91 
EnşaveChªÃlC»d’tŸls
(
BidœeùiÚ®NuÎC»d’tŸlsO±iÚs
());

95 autØ
	gchªÃl
 = ::
g½c
::
C»©eChªÃl
(
add»ss_
, 
chªÃl_üed’tŸls
);

96 
g´_time¥ec
 
	gabsŞu‹_d—dlše
 = 
g´_time_add
(

97 
g´_now
(
GPR_CLOCK_REALTIME
),

98 
g´_time_äom_miüos
(
¡©ic_ÿ¡
<
št64_t
>(30 * 1e6), 
GPR_TIMESPAN
));

99 
EXPECT_TRUE
(
chªÃl
->
Wa™FÜCÚÃùed
(
absŞu‹_d—dlše
));

101 
Mes£ng”Cl›Á1
 
ş›Á
(
chªÃl
);

103 
	gStusOr
<
	g¡d
::
¡ršg
> 
»¥Ú£
 = 
ş›Á
.
H–lo
(
kName
);

104 
ASSERT_THAT
(
»¥Ú£
, 
IsOk
());

105 
EXPECT_EQ
(
»¥Ú£
.
V®ueOrD›
(), 
Mes£ng”S”v”1
::
Re¥Ú£SŒšg
(
kName
));

107 
	g»¥Ú£
 = 
ş›Á
.
H–lo
("");

108 
EXPECT_THAT
(
»¥Ú£
, 
NÙ
(
IsOk
()));

	@test/grpc/messenger_client_impl.h

19 #iâdeà
ASYLO_TEST_GRPC_MESSENGER_CLIENT_IMPL_H_


20 
	#ASYLO_TEST_GRPC_MESSENGER_CLIENT_IMPL_H_


	)

22 
	~<memÜy
>

23 
	~<¡ršg
>

24 
	~<ty³_Œa™s
>

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/‹¡/g½c/£rviû.g½c.pb.h
"

28 
	~"asylo/ut/¡©us.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

30 
	~"šşude/g½ıp/g½ıp.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	g‹¡
 {

35 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

36 şas 
	cMes£ng”Cl›Á
 {

37 
	gpublic
:

38 
¡©ic_as£¹
(

39 
¡d
::
is_§me
<
T
, 
Mes£ng”1
>::
v®ue
 ||

40 
¡d
::
is_§me
<
T
, 
Mes£ng”2
>::
v®ue
 ||

41 
¡d
::
is_§me
<
T
, 
Mes£ng”3
>::
v®ue
,

44 
Mes£ng”Cl›Á
(cÚ¡ 
¡d
::
sh¬ed_±r
<::
g½c
::
ChªÃlIÁ”çû
> &
chªÃl
)

45 : 
¡ub_
{
T
::
NewStub
(
chªÃl
, ::
g½c
::
StubO±iÚs
())} {}

47 
StusOr
<
¡d
::
¡ršg
> 
H–lo
(cÚ¡ std::¡ršg &
Çme
) {

48 ::
g½c
::
Cl›ÁCÚ‹xt
 
ş›Á_cÚ‹xt
;

50 
H–loReque¡
 
	g»que¡
;

51 
	g»que¡
.
£t_Çme
(
Çme
);

53 
H–loRe¥Ú£
 
	g»¥Ú£
;

56 ::
g½c
::
Stus
 
g½c_¡©us
 =

57 
¡ub_
->
H–lo
(&
ş›Á_cÚ‹xt
, 
»que¡
, &
»¥Ú£
);

58 ià(!
	gg½c_¡©us
.
ok
()) {

59  
Stus
(
g½c_¡©us
);

61 
LOG
(
INFO
è<< "Re¥Ú£ from s”v”: " << 
	g»¥Ú£
.
mes§ge
();

63  
	g»¥Ú£
.
mes§ge
();

66 
	g´iv©e
:

67 
¡d
::
unique_±r
<
ty³Çme
 
T
::
Stub
> 
¡ub_
;

70 
usšg
 
	gMes£ng”Cl›Á1
 = 
Mes£ng”Cl›Á
<
Mes£ng”1
>;

71 
usšg
 
	gMes£ng”Cl›Á2
 = 
Mes£ng”Cl›Á
<
Mes£ng”2
>;

72 
usšg
 
	gMes£ng”Cl›Á3
 = 
Mes£ng”Cl›Á
<
Mes£ng”3
>;

	@test/grpc/messenger_server_impl.h

19 #iâdeà
ASYLO_TEST_GRPC_MESSENGER_SERVER_IMPL_H_


20 
	#ASYLO_TEST_GRPC_MESSENGER_SERVER_IMPL_H_


	)

22 
	~<ty³_Œa™s
>

24 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

25 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

26 
	~"asylo/‹¡/g½c/£rviû.g½c.pb.h
"

27 
	~"šşude/g½ıp/g½ıp.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
Çme¥aû
 
	g‹¡
 {

32 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

33 şas 
	cMes£ng”S”v”
 : 
public
 
T
::
S”viû
 {

34 
public
:

35 
¡d
::
¡ršg
 
Re¥Ú£SŒšg
(
ab¦
::
¡ršg_v›w
 
Çme
) {

36  
ab¦
::
SŒC©
("H–lØ", 
Çme
, ", I‡m ", 
T
::
£rviû_fuÎ_Çme
());

39 
	g´iv©e
:

40 ::
g½c
::
Stus
 
H–lo
(::g½c::
S”v”CÚ‹xt
 *
cÚ‹xt
,

41 cÚ¡ 
H–loReque¡
 *
»que¡
,

42 
H–loRe¥Ú£
 *
»¥Ú£
è
	gov”ride
 {

43 
¡©ic_as£¹
(

44 
¡d
::
is_§me
<
T
, 
Mes£ng”1
>::
v®ue
 ||

45 
¡d
::
is_§me
<
T
, 
Mes£ng”2
>::
v®ue
 ||

46 
¡d
::
is_§me
<
T
, 
Mes£ng”3
>::
v®ue
,

49 ià(
	g»que¡
->
Çme
().
em±y
()) {

50  ::
g½c
::
Stus
(::g½c::
StusCode
::
INVALID_ARGUMENT
,

53 
	g»¥Ú£
->
£t_mes§ge
(
Re¥Ú£SŒšg
(
»que¡
->
Çme
()));

54  ::
g½c
::
Stus
::
OK
;

58 
usšg
 
	gMes£ng”S”v”1
 = 
Mes£ng”S”v”
<
Mes£ng”1
>;

59 
usšg
 
	gMes£ng”S”v”2
 = 
Mes£ng”S”v”
<
Mes£ng”2
>;

60 
usšg
 
	gMes£ng”S”v”3
 = 
Mes£ng”S”v”
<
Mes£ng”3
>;

	@test/grpc/server_enclave.cc

19 
	~<memÜy
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

23 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

24 
	~"asylo/g½c/ut/’şave_£rv”.h
"

25 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

27 
Çme¥aû
 
	gasylo
 {

30 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

32  
Ãw
 
EnşaveS”v”
(

33 
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>(),

34 
EnşaveS”v”C»d’tŸls
(
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
()));

	@test/grpc/server_enclave.cc

19 
	~<memÜy
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"asylo/g½c/auth/’şave_£rv”_üed’tŸls.h
"

23 
	~"asylo/g½c/auth/sgx_loÿl_üed’tŸls_İtiÚs.h
"

24 
	~"asylo/g½c/ut/’şave_£rv”.h
"

25 
	~"asylo/‹¡/g½c/mes£ng”_£rv”_im¶.h
"

27 
Çme¥aû
 
	gasylo
 {

30 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
() {

32  
Ãw
 
EnşaveS”v”
(

33 
ab¦
::
make_unique
<
‹¡
::
Mes£ng”S”v”1
>(),

34 
EnşaveS”v”C»d’tŸls
(
BidœeùiÚ®SgxLoÿlC»d’tŸlsO±iÚs
()));

	@test/loader/loader_test.cc

19 
	~<io¡»am
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/ş›Á.h
"

23 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
	~"asylo/ut/¡©us.h
"

25 
	~"asylo/ut/¡©usÜ.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
	gusšg
 ::
‹¡šg
::
NÙ
;

33 şas 
	cTe¡Cl›Á
 : 
public
 
EnşaveCl›Á
 {

34 
public
:

35 
Te¡Cl›Á
(è: 
EnşaveCl›Á
("test") {}

37 
Stus
 
EÁ”AndRun
(cÚ¡ 
EnşaveIÅut
 &
šput
,

38 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

39  
	gStus
::
OkStus
();

42 
	g´iv©e
:

43 
Stus
 
EÁ”AndIn™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
ov”ride
 {

44  
Stus
::
OkStus
();

47 
Stus
 
EÁ”AndFš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
è
	gov”ride
 {

48  
	gStus
::
OkStus
();

51 
Stus
 
EÁ”AndDÚ©eTh»ad
(è
	gov”ride
 {  
	gStus
::
OkStus
(); }

53 
Stus
 
EÁ”AndHªdËSigÇl
(cÚ¡ 
EnşaveSigÇl
 &
signum
è
	gov”ride
 {

54  
	gStus
::
OkStus
();

57 
Stus
 
De¡royEnşave
(è
	gov”ride
 {  
	gStus
::
OkStus
(); }

61 şas 
	cFašgLßd”
 : 
public
 
EnşaveLßd”
 {

62 
´Ùeùed
:

63 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

64 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

65 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
ècÚ¡ 
	gov”ride
 {

66  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

69 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
(ècÚ¡ 
ov”ride
 {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

77 şas 
	cFakeLßd”
 : 
public
 
EnşaveLßd”
 {

78 
public
:

79 ~
FakeLßd”
(è
ov”ride
 = ;

81 
FakeLßd”
() = ;

83 
	g´Ùeùed
:

84 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

85 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

86 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
ècÚ¡ 
	gov”ride
 {

87  
	g¡d
::
unique_±r
<
EnşaveCl›Á
>(
Ãw
 
T
());

90 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
(ècÚ¡ 
ov”ride
 {

91  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

96 şas 
	cLßd”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

97 
´Ùeùed
:

98 
S‘Up
(è
ov”ride
 {

99 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

100 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

101 ià(!
	gmªag”_»suÉ
.
ok
()) {

102 
LOG
(
FATAL
è<< 
	gmªag”_»suÉ
.
¡©us
();

104 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

107 
EnşaveMªag”
 *
	gmªag”_
;

108 
	gFakeLßd”
<
	gTe¡Cl›Á
> 
	glßd”_
;

112 
TEST_F
(
Lßd”Te¡
, 
Ov”®l
) {

113 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/çke", 
lßd”_
);

114 
ASSERT_THAT
(
¡©us
, 
IsOk
());

116 
EnşaveCl›Á
 *
	gş›Á
 = 
mªag”_
->
G‘Cl›Á
("/fake");

117 
ASSERT_NE
(
ş›Á
, 
nuÎ±r
);

119 
EnşaveIÅut
 
	gešput
;

120 
	g¡©us
 = 
ş›Á
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

121 
ASSERT_THAT
(
¡©us
, 
IsOk
());

123 
EnşaveFš®
 
	gefš®_šput
;

124 
	g¡©us
 = 
mªag”_
->
De¡royEnşave
(
ş›Á
, 
efš®_šput
);

125 
ASSERT_THAT
(
¡©us
, 
IsOk
());

129 
TEST_F
(
Lßd”Te¡
, 
Du¶iÿ‹NamesFa
) {

130 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/du¶iÿ‹_Çmes", 
lßd”_
);

131 
ASSERT_THAT
(
¡©us
, 
IsOk
());

134 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/du¶iÿ‹_Çmes", 
lßd”_
);

135 
ASSERT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

139 
TEST_F
(
Lßd”Te¡
, 
F‘chAá”De¡roy
) {

140 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/ãtch_aá”_de¡roy", 
lßd”_
);

141 
ASSERT_THAT
(
¡©us
, 
IsOk
());

143 autØ
	gş›Á
 = 
mªag”_
->
G‘Cl›Á
("/fetch_after_destroy");

144 
ASSERT_NE
(
ş›Á
, 
nuÎ±r
);

146 
EnşaveFš®
 
	gfš®_šput
;

147 
	g¡©us
 = 
mªag”_
->
De¡royEnşave
(
ş›Á
, 
fš®_šput
);

148 
ASSERT_THAT
(
¡©us
, 
IsOk
());

151 
	gş›Á
 = 
mªag”_
->
G‘Cl›Á
("/fetch_after_destroy");

152 
ASSERT_EQ
(
ş›Á
, 
nuÎ±r
);

156 
TEST_F
(
Lßd”Te¡
, 
Prİag©eLßd”Fau»
) {

157 
FašgLßd”
 
	glßd”
;

158 autØ
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/çke", 
lßd”
);

159 
ASSERT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

	@test/loader/loader_test.cc

19 
	~<io¡»am
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/ş›Á.h
"

23 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
	~"asylo/ut/¡©us.h
"

25 
	~"asylo/ut/¡©usÜ.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

30 
	gusšg
 ::
‹¡šg
::
NÙ
;

33 şas 
	cTe¡Cl›Á
 : 
public
 
EnşaveCl›Á
 {

34 
public
:

35 
Te¡Cl›Á
(è: 
EnşaveCl›Á
("test") {}

37 
Stus
 
EÁ”AndRun
(cÚ¡ 
EnşaveIÅut
 &
šput
,

38 
EnşaveOuut
 *
ouut
è
	gov”ride
 {

39  
	gStus
::
OkStus
();

42 
	g´iv©e
:

43 
Stus
 
EÁ”AndIn™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
ov”ride
 {

44  
Stus
::
OkStus
();

47 
Stus
 
EÁ”AndFš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
è
	gov”ride
 {

48  
	gStus
::
OkStus
();

51 
Stus
 
EÁ”AndDÚ©eTh»ad
(è
	gov”ride
 {  
	gStus
::
OkStus
(); }

53 
Stus
 
EÁ”AndHªdËSigÇl
(cÚ¡ 
EnşaveSigÇl
 &
signum
è
	gov”ride
 {

54  
	gStus
::
OkStus
();

57 
Stus
 
De¡royEnşave
(è
	gov”ride
 {  
	gStus
::
OkStus
(); }

61 şas 
	cFašgLßd”
 : 
public
 
EnşaveLßd”
 {

62 
´Ùeùed
:

63 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

64 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

65 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
ècÚ¡ 
	gov”ride
 {

66  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

69 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
(ècÚ¡ 
ov”ride
 {

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

76 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

77 şas 
	cFakeLßd”
 : 
public
 
EnşaveLßd”
 {

78 
public
:

79 ~
FakeLßd”
(è
ov”ride
 = ;

81 
FakeLßd”
() = ;

83 
	g´Ùeùed
:

84 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

85 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

86 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
ècÚ¡ 
	gov”ride
 {

87  
	g¡d
::
unique_±r
<
EnşaveCl›Á
>(
Ãw
 
T
());

90 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
(ècÚ¡ 
ov”ride
 {

91  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

96 şas 
	cLßd”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

97 
´Ùeùed
:

98 
S‘Up
(è
ov”ride
 {

99 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

100 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

101 ià(!
	gmªag”_»suÉ
.
ok
()) {

102 
LOG
(
FATAL
è<< 
	gmªag”_»suÉ
.
¡©us
();

104 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

107 
EnşaveMªag”
 *
	gmªag”_
;

108 
	gFakeLßd”
<
	gTe¡Cl›Á
> 
	glßd”_
;

112 
TEST_F
(
Lßd”Te¡
, 
Ov”®l
) {

113 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/çke", 
lßd”_
);

114 
ASSERT_THAT
(
¡©us
, 
IsOk
());

116 
EnşaveCl›Á
 *
	gş›Á
 = 
mªag”_
->
G‘Cl›Á
("/fake");

117 
ASSERT_NE
(
ş›Á
, 
nuÎ±r
);

119 
EnşaveIÅut
 
	gešput
;

120 
	g¡©us
 = 
ş›Á
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

121 
ASSERT_THAT
(
¡©us
, 
IsOk
());

123 
EnşaveFš®
 
	gefš®_šput
;

124 
	g¡©us
 = 
mªag”_
->
De¡royEnşave
(
ş›Á
, 
efš®_šput
);

125 
ASSERT_THAT
(
¡©us
, 
IsOk
());

129 
TEST_F
(
Lßd”Te¡
, 
Du¶iÿ‹NamesFa
) {

130 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/du¶iÿ‹_Çmes", 
lßd”_
);

131 
ASSERT_THAT
(
¡©us
, 
IsOk
());

134 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/du¶iÿ‹_Çmes", 
lßd”_
);

135 
ASSERT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

139 
TEST_F
(
Lßd”Te¡
, 
F‘chAá”De¡roy
) {

140 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/ãtch_aá”_de¡roy", 
lßd”_
);

141 
ASSERT_THAT
(
¡©us
, 
IsOk
());

143 autØ
	gş›Á
 = 
mªag”_
->
G‘Cl›Á
("/fetch_after_destroy");

144 
ASSERT_NE
(
ş›Á
, 
nuÎ±r
);

146 
EnşaveFš®
 
	gfš®_šput
;

147 
	g¡©us
 = 
mªag”_
->
De¡royEnşave
(
ş›Á
, 
fš®_šput
);

148 
ASSERT_THAT
(
¡©us
, 
IsOk
());

151 
	gş›Á
 = 
mªag”_
->
G‘Cl›Á
("/fetch_after_destroy");

152 
ASSERT_EQ
(
ş›Á
, 
nuÎ±r
);

156 
TEST_F
(
Lßd”Te¡
, 
Prİag©eLßd”Fau»
) {

157 
FašgLßd”
 
	glßd”
;

158 autØ
	g¡©us
 = 
mªag”_
->
LßdEnşave
("/çke", 
lßd”
);

159 
ASSERT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

	@test/misc/active_enclave_signal_test_driver.cc

19 
	~<”ºo.h
>

20 
	~<pŞl.h
>

21 
	~<±h»ad.h
>

22 
	~<sigÇl.h
>

23 
	~<¡dio.h
>

24 
	~<uni¡d.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

29 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

30 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

33 
	~"asylo/ut/¡©us.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

40 
	g·œ_¡dout
[2];

42 
	sRunEnşaveTh»adIÅut
 {

43 
EnşaveCl›Á
 *
	gş›Á
;

44 
EnşaveIÅut
 
	g’şave_šput
;

48 *
RunEnşave
(*
¬g
) {

49 
RunEnşaveTh»adIÅut
 *
	gšput
 = 
»š‹½»t_ÿ¡
<RunEnşaveTh»adIÅuˆ*>(
¬g
);

50 
EnşaveCl›Á
 *
	gş›Á
 = 
šput
->
ş›Á
;

51 
EnşaveIÅut
 
	g’şave_šput
 = 
šput
->
’şave_šput
;

52 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

53  
	gnuÎ±r
;

56 
	sS’dSigÇlTh»adIÅut
 {

57 
±h»ad_t
 
	g’şave_th»ad
;

58 
	gpŞl_fd
;

59 
	gSigÇlTe¡IÅut
::
SigÇlTe¡Ty³
 
sigÇl_‹¡_ty³
;

64 *
S’dSigÇl
(*
¬g
) {

65 
S’dSigÇlTh»adIÅut
 *
	gšput
 = 
»š‹½»t_ÿ¡
<S’dSigÇlTh»adIÅuˆ*>(
¬g
);

66 
±h»ad_t
 
	g’şave_th»ad
 = 
šput
->
’şave_th»ad
;

67 
pŞlfd
 
	gfds
[1];

68 
mem£t
(
fds
, 0, (fds));

69 
	gfds
[0].
	gfd
 = 
šput
->
pŞl_fd
;

70 
	gfds
[0].
	gev’ts
 = 
POLLIN
;

73 
EXPECT_NE
(
pŞl
(
fds
, 1, 30000), -1);

75 
±h»ad_kl
(
’şave_th»ad
, 
SIGUSR1
);

76 ià(
	gšput
->
	gsigÇl_‹¡_ty³
 =ğ
SigÇlTe¡IÅut
::
SIGACTIONMASK
) {

77 
±h»ad_kl
(
’şave_th»ad
, 
SIGUSR2
);

79  
	gnuÎ±r
;

82 şas 
	cAùiveEnşaveSigÇlTe¡
 : 
public
 
EnşaveTe¡
 {

83 
public
:

84 
S‘Up
(è
ov”ride
 {

86 
CHECK_EQ
(
pe
(
·œ_¡dout
), 0);

88 
£t_¡dout
(
·œ_¡dout
[1]);

89 
S‘UpBa£
();

97 
Stus
 
RunSigÇlTe¡
(cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

98 
±h»ad_t
 
	g’şave_th»ad
;

99 
RunEnşaveTh»adIÅut
 
	grun_’şave_th»ad_šput
;

100 
	grun_’şave_th»ad_šput
.
	gş›Á
 = 
ş›Á_
;

101 
	grun_’şave_th»ad_šput
.
	g’şave_šput
 = 
’şave_šput
;

102 ià(
±h»ad_ü—‹
(&
’şave_th»ad
, 
nuÎ±r
, 
RunEnşave
,

103 &
run_’şave_th»ad_šput
) != 0) {

104  
Stus
(

105 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

106 
ab¦
::
SŒC©
("FaedØü—‹ƒnşavth»ad: ", 
¡»¼Ü
(
”ºo
)));

108 
±h»ad_t
 
	gsigÇl_th»ad
;

109 
S’dSigÇlTh»adIÅut
 
	g£nd_sigÇl_th»ad_šput
;

110 
	g£nd_sigÇl_th»ad_šput
.
	g’şave_th»ad
 = 
’şave_th»ad
;

111 
	g£nd_sigÇl_th»ad_šput
.
	gpŞl_fd
 = 
·œ_¡dout
[0];

112 
	g£nd_sigÇl_th»ad_šput
.
	gsigÇl_‹¡_ty³
 =

113 
’şave_šput
.
G‘Ex‹nsiÚ
(
sigÇl_‹¡_šput
).
sigÇl_‹¡_ty³
();

114 ià(
±h»ad_ü—‹
(&
sigÇl_th»ad
, 
nuÎ±r
, 
S’dSigÇl
,

115 &
£nd_sigÇl_th»ad_šput
) != 0) {

116  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

117 
ab¦
::
SŒC©
("Failedo create send signalhread: ",

118 
¡»¼Ü
(
”ºo
)));

120 ià(
±h»ad_još
(
sigÇl_th»ad
, 
nuÎ±r
) != 0) {

121  
Stus
(

122 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

123 
ab¦
::
SŒC©
("FaedØjoš s’d sigÇÈth»ad: ", 
¡»¼Ü
(
”ºo
)));

125 ià(
±h»ad_još
(
’şave_th»ad
, 
nuÎ±r
) != 0) {

126  
Stus
(

127 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

128 
ab¦
::
SŒC©
("FaedØjošƒnşavth»ad: ", 
¡»¼Ü
(
”ºo
)));

130  
	gStus
::
OkStus
();

135 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
HªdËrTe¡
) {

136 
EnşaveIÅut
 
	g’şave_šput
;

137 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

138 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
HANDLER
);

139 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

143 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigÇlTe¡
) {

144 
EnşaveIÅut
 
	g’şave_šput
;

145 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

146 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGNAL
);

147 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

151 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigaùiÚTe¡
) {

152 
EnşaveIÅut
 
	g’şave_šput
;

153 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

154 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGACTION
);

155 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

163 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigÇlMaskTe¡
) {

164 
EnşaveIÅut
 
	g’şave_šput
;

165 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

166 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGMASK
);

167 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

176 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigaùiÚMaskTe¡
) {

177 
EnşaveIÅut
 
	g’şave_šput
;

178 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

179 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGACTIONMASK
);

180 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

186 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
Re£tHªdËrTe¡
) {

187 
EnşaveIÅut
 
	g’şave_šput
;

188 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

189 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
RESETHANDLER
);

190 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

192 
EXPECT_EXIT
(
¿i£
(
SIGUSR1
), ::
‹¡šg
::
KËdBySigÇl
(SIGUSR1), ".*");

	@test/misc/active_enclave_signal_test_driver.cc

19 
	~<”ºo.h
>

20 
	~<pŞl.h
>

21 
	~<±h»ad.h
>

22 
	~<sigÇl.h
>

23 
	~<¡dio.h
>

24 
	~<uni¡d.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

29 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

30 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

31 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

32 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

33 
	~"asylo/ut/¡©us.h
"

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

40 
	g·œ_¡dout
[2];

42 
	sRunEnşaveTh»adIÅut
 {

43 
EnşaveCl›Á
 *
	gş›Á
;

44 
EnşaveIÅut
 
	g’şave_šput
;

48 *
RunEnşave
(*
¬g
) {

49 
RunEnşaveTh»adIÅut
 *
	gšput
 = 
»š‹½»t_ÿ¡
<RunEnşaveTh»adIÅuˆ*>(
¬g
);

50 
EnşaveCl›Á
 *
	gş›Á
 = 
šput
->
ş›Á
;

51 
EnşaveIÅut
 
	g’şave_šput
 = 
šput
->
’şave_šput
;

52 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

53  
	gnuÎ±r
;

56 
	sS’dSigÇlTh»adIÅut
 {

57 
±h»ad_t
 
	g’şave_th»ad
;

58 
	gpŞl_fd
;

59 
	gSigÇlTe¡IÅut
::
SigÇlTe¡Ty³
 
sigÇl_‹¡_ty³
;

64 *
S’dSigÇl
(*
¬g
) {

65 
S’dSigÇlTh»adIÅut
 *
	gšput
 = 
»š‹½»t_ÿ¡
<S’dSigÇlTh»adIÅuˆ*>(
¬g
);

66 
±h»ad_t
 
	g’şave_th»ad
 = 
šput
->
’şave_th»ad
;

67 
pŞlfd
 
	gfds
[1];

68 
mem£t
(
fds
, 0, (fds));

69 
	gfds
[0].
	gfd
 = 
šput
->
pŞl_fd
;

70 
	gfds
[0].
	gev’ts
 = 
POLLIN
;

73 
EXPECT_NE
(
pŞl
(
fds
, 1, 30000), -1);

75 
±h»ad_kl
(
’şave_th»ad
, 
SIGUSR1
);

76 ià(
	gšput
->
	gsigÇl_‹¡_ty³
 =ğ
SigÇlTe¡IÅut
::
SIGACTIONMASK
) {

77 
±h»ad_kl
(
’şave_th»ad
, 
SIGUSR2
);

79  
	gnuÎ±r
;

82 şas 
	cAùiveEnşaveSigÇlTe¡
 : 
public
 
EnşaveTe¡
 {

83 
public
:

84 
S‘Up
(è
ov”ride
 {

86 
CHECK_EQ
(
pe
(
·œ_¡dout
), 0);

88 
£t_¡dout
(
·œ_¡dout
[1]);

89 
S‘UpBa£
();

97 
Stus
 
RunSigÇlTe¡
(cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

98 
±h»ad_t
 
	g’şave_th»ad
;

99 
RunEnşaveTh»adIÅut
 
	grun_’şave_th»ad_šput
;

100 
	grun_’şave_th»ad_šput
.
	gş›Á
 = 
ş›Á_
;

101 
	grun_’şave_th»ad_šput
.
	g’şave_šput
 = 
’şave_šput
;

102 ià(
±h»ad_ü—‹
(&
’şave_th»ad
, 
nuÎ±r
, 
RunEnşave
,

103 &
run_’şave_th»ad_šput
) != 0) {

104  
Stus
(

105 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

106 
ab¦
::
SŒC©
("FaedØü—‹ƒnşavth»ad: ", 
¡»¼Ü
(
”ºo
)));

108 
±h»ad_t
 
	gsigÇl_th»ad
;

109 
S’dSigÇlTh»adIÅut
 
	g£nd_sigÇl_th»ad_šput
;

110 
	g£nd_sigÇl_th»ad_šput
.
	g’şave_th»ad
 = 
’şave_th»ad
;

111 
	g£nd_sigÇl_th»ad_šput
.
	gpŞl_fd
 = 
·œ_¡dout
[0];

112 
	g£nd_sigÇl_th»ad_šput
.
	gsigÇl_‹¡_ty³
 =

113 
’şave_šput
.
G‘Ex‹nsiÚ
(
sigÇl_‹¡_šput
).
sigÇl_‹¡_ty³
();

114 ià(
±h»ad_ü—‹
(&
sigÇl_th»ad
, 
nuÎ±r
, 
S’dSigÇl
,

115 &
£nd_sigÇl_th»ad_šput
) != 0) {

116  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

117 
ab¦
::
SŒC©
("Failedo create send signalhread: ",

118 
¡»¼Ü
(
”ºo
)));

120 ià(
±h»ad_još
(
sigÇl_th»ad
, 
nuÎ±r
) != 0) {

121  
Stus
(

122 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

123 
ab¦
::
SŒC©
("FaedØjoš s’d sigÇÈth»ad: ", 
¡»¼Ü
(
”ºo
)));

125 ià(
±h»ad_još
(
’şave_th»ad
, 
nuÎ±r
) != 0) {

126  
Stus
(

127 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

128 
ab¦
::
SŒC©
("FaedØjošƒnşavth»ad: ", 
¡»¼Ü
(
”ºo
)));

130  
	gStus
::
OkStus
();

135 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
HªdËrTe¡
) {

136 
EnşaveIÅut
 
	g’şave_šput
;

137 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

138 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
HANDLER
);

139 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

143 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigÇlTe¡
) {

144 
EnşaveIÅut
 
	g’şave_šput
;

145 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

146 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGNAL
);

147 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

151 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigaùiÚTe¡
) {

152 
EnşaveIÅut
 
	g’şave_šput
;

153 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

154 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGACTION
);

155 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

163 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigÇlMaskTe¡
) {

164 
EnşaveIÅut
 
	g’şave_šput
;

165 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

166 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGMASK
);

167 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

176 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
SigaùiÚMaskTe¡
) {

177 
EnşaveIÅut
 
	g’şave_šput
;

178 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

179 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGACTIONMASK
);

180 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

186 
TEST_F
(
AùiveEnşaveSigÇlTe¡
, 
Re£tHªdËrTe¡
) {

187 
EnşaveIÅut
 
	g’şave_šput
;

188 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

189 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
RESETHANDLER
);

190 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

192 
EXPECT_EXIT
(
¿i£
(
SIGUSR1
), ::
‹¡šg
::
KËdBySigÇl
(SIGUSR1), ".*");

	@test/misc/active_enclave_signal_test_enclave.cc

19 
	~<sigÇl.h
>

20 
	~<¡dio.h
>

21 
	~<uni¡d.h
>

22 
	~<futu»
>

24 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
cÚ¡ex´
 
	gkTimeout
 = 10;

33 vŞ©
th»ad_loÿl
 
boŞ
 
	gsigÇl_hªdËd
 = 
çl£
;

34 vŞ©
th»ad_loÿl
 
boŞ
 
	gblocked_sigÇl_hªdËd
 = 
çl£
;

35 vŞ©
th»ad_loÿl
 
boŞ
 
	gsigÇl_hªdËr_š‹¼u±ed
 = 
çl£
;

37 
HªdËSigÇlW™hHªdËr
(
signum
) {

38 ià(
	gsignum
 =ğ
SIGUSR1
) {

39 
sigÇl_hªdËd
 = 
Œue
;

41 ià(
	gsignum
 =ğ
SIGUSR2
) {

42 
blocked_sigÇl_hªdËd
 = 
Œue
;

46 
HªdËSigÇlW™hSigAùiÚMask
(
signum
) {

47 ià(
	gsignum
 =ğ
SIGUSR1
) {

48 
sigÇl_hªdËd
 = 
Œue
;

50 ià(
	gblocked_sigÇl_hªdËd
) {

51 
	gsigÇl_hªdËr_š‹¼u±ed
 = 
Œue
;

55 
HªdËSigÇlW™hSigAùiÚ
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

56 ià(
	gsignum
 =ğ
SIGUSR1
) {

57 
sigÇl_hªdËd
 = 
Œue
;

61 şas 
	cAùiveEnşaveSigÇlTe¡
 : 
public
 
Tru¡edAµliÿtiÚ
 {

62 
public
:

63 
AùiveEnşaveSigÇlTe¡
() = ;

65 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

66 ià(!
	gšput
.
HasEx‹nsiÚ
(
sigÇl_‹¡_šput
)) {

67  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

70 
SigÇlTe¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sigÇl_‹¡_šput
);

71 ià(!
	g‹¡_šput
.
has_sigÇl_‹¡_ty³
()) {

72  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

75 
Stus
 
	g¡©us
;

76 
	g¡d
::
futu»
<
Stus
> 
mask_»suÉ
;

77 
	g‹¡_šput
.
sigÇl_‹¡_ty³
()) {

78 
	gSigÇlTe¡IÅut
::
HANDLER
:

79  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
HANDLER
);

80 
	gSigÇlTe¡IÅut
::
SIGNAL
:

81  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGNAL
);

82 
	gSigÇlTe¡IÅut
::
SIGACTION
:

83  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGACTION
);

84 
	gSigÇlTe¡IÅut
::
SIGMASK
:

85 
mask_»suÉ
 = 
¡d
::
async
(¡d::
Ïunch
::async,

86 &
AùiveEnşaveSigÇlTe¡
::
S‘SigÇlMask
, 
this
);

87 
	g¡©us
 = 
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGMASK
);

90 ià(!
	gmask_»suÉ
.
g‘
().
ok
()) {

91  
	gmask_»suÉ
.
g‘
();

93  
	g¡©us
;

94 
	gSigÇlTe¡IÅut
::
SIGACTIONMASK
:

95  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGACTIONMASK
);

96 
	gSigÇlTe¡IÅut
::
RESETHANDLER
:

97  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
RESETHANDLER
);

99  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

104 
	g´iv©e
:

105 
Stus
 
RunSigÇlTe¡
(cÚ¡ 
SigÇlTe¡IÅut
::
SigÇlTe¡Ty³
 &
‹¡_ty³
) {

106 
sig£t_t
 
£t
, 
	gŞd£t
;

107 
sigem±y£t
(&
£t
);

108 
sigadd£t
(&
£t
, 
SIGUSR1
);

109 ià(
	g‹¡_ty³
 =ğ
SigÇlTe¡IÅut
::
SIGMASK
) {

110 ià(
sig´ocmask
(
SIG_BLOCK
, &
£t
, &
Şd£t
) != 0) {

111  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

115 
sigaùiÚ
 
	gaù
, 
	gŞdaù
;

116 
sigem±y£t
(&
aù
.
§_mask
);

117 
	g‹¡_ty³
) {

118 
	gSigÇlTe¡IÅut
::
HANDLER
:

119 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

121 
	gSigÇlTe¡IÅut
::
SIGNAL
:

122 
sigÇl
(
SIGUSR1
, &
HªdËSigÇlW™hHªdËr
);

124 
	gSigÇlTe¡IÅut
::
SIGACTION
:

125 
aù
.
§_sigaùiÚ
 = &
HªdËSigÇlW™hSigAùiÚ
;

126 
	gaù
.
	g§_æags
 |ğ
SA_SIGINFO
;

128 
	gSigÇlTe¡IÅut
::
SIGMASK
:

129 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

131 
	gSigÇlTe¡IÅut
::
SIGACTIONMASK
:

133 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

134 
sig£t_t
 
	gmask
;

135 
sigem±y£t
(&
mask
);

136 
sigadd£t
(&
mask
, 
SIGUSR1
);

137 
	gaù
.
	g§_mask
 = 
mask
;

138 
sigaùiÚ
(
SIGUSR2
, &
aù
, &
Şdaù
);

140 
	gaù
.
	g§_hªdËr
 = &
HªdËSigÇlW™hSigAùiÚMask
;

141 
sigem±y£t
(&
mask
);

142 
sigadd£t
(&
mask
, 
SIGUSR2
);

143 
	gaù
.
	g§_mask
 = 
mask
;

145 
	gSigÇlTe¡IÅut
::
RESETHANDLER
:

146 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

147 
	gaù
.
	g§_æags
 |ğ
SA_RESETHAND
;

150  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

153 ià(
	g‹¡_ty³
 !ğ
SigÇlTe¡IÅut
::
SIGNAL
) {

154 
sigaùiÚ
(
SIGUSR1
, &
aù
, &
Şdaù
);

158 
´štf
("readyo„eceive signal!");

159 
fşo£
(
¡dout
);

161 
	gcouÁ
 = 0;

162 
boŞ
 
	g®l_sigÇls_hªdËd
 = 
çl£
;

165 !
	g®l_sigÇls_hªdËd
 && ++
	gcouÁ
 < 
	gkTimeout
) {

166 
	g‹¡_ty³
) {

167 
	gSigÇlTe¡IÅut
::
SIGACTIONMASK
:

168 
®l_sigÇls_hªdËd
 = 
sigÇl_hªdËd
 && 
blocked_sigÇl_hªdËd
;

171 
®l_sigÇls_hªdËd
 = 
sigÇl_hªdËd
;

173 
¦“p
(1);

175 ià(
	g‹¡_ty³
 =ğ
SigÇlTe¡IÅut
::
SIGACTIONMASK
 &&

176 
sigÇl_hªdËr_š‹¼u±ed
) {

177  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

182 ià(
	g‹¡_ty³
 !ğ
SigÇlTe¡IÅut
::
SIGMASK
) {

183  
®l_sigÇls_hªdËd


184 ? 
Stus
::
OkStus
()

185 : 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Signal‚ot„eceived");

189 ià(
	gsigÇl_hªdËd
) {

190  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

193 ià(
sig´ocmask
(
SIG_UNBLOCK
, &
£t
, &
Şd£t
) != 0) {

194  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

198  
	gsigÇl_hªdËd
 ? 
	gStus
::
OkStus
()

199 : 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

205 
Stus
 
S‘SigÇlMask
() {

206 
sig£t_t
 
	g£t
, 
	gŞd£t
;

207 
sigem±y£t
(&
£t
);

208 
sigadd£t
(&
£t
, 
SIGUSR1
);

209 
	gi
 = 0; i < 
	gkTimeout
; ++i) {

210 ià(
sig´ocmask
(
SIG_UNBLOCK
, &
£t
, &
Şd£t
) != 0) {

211  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

214 
¦“p
(1);

216  
	gStus
::
OkStus
();

220 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

221  
Ãw
 
AùiveEnşaveSigÇlTe¡
;

222 
	}
}

	@test/misc/active_enclave_signal_test_enclave.cc

19 
	~<sigÇl.h
>

20 
	~<¡dio.h
>

21 
	~<uni¡d.h
>

22 
	~<futu»
>

24 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

27 
	~"asylo/ut/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

31 
cÚ¡ex´
 
	gkTimeout
 = 10;

33 vŞ©
th»ad_loÿl
 
boŞ
 
	gsigÇl_hªdËd
 = 
çl£
;

34 vŞ©
th»ad_loÿl
 
boŞ
 
	gblocked_sigÇl_hªdËd
 = 
çl£
;

35 vŞ©
th»ad_loÿl
 
boŞ
 
	gsigÇl_hªdËr_š‹¼u±ed
 = 
çl£
;

37 
HªdËSigÇlW™hHªdËr
(
signum
) {

38 ià(
	gsignum
 =ğ
SIGUSR1
) {

39 
sigÇl_hªdËd
 = 
Œue
;

41 ià(
	gsignum
 =ğ
SIGUSR2
) {

42 
blocked_sigÇl_hªdËd
 = 
Œue
;

46 
HªdËSigÇlW™hSigAùiÚMask
(
signum
) {

47 ià(
	gsignum
 =ğ
SIGUSR1
) {

48 
sigÇl_hªdËd
 = 
Œue
;

50 ià(
	gblocked_sigÇl_hªdËd
) {

51 
	gsigÇl_hªdËr_š‹¼u±ed
 = 
Œue
;

55 
HªdËSigÇlW™hSigAùiÚ
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

56 ià(
	gsignum
 =ğ
SIGUSR1
) {

57 
sigÇl_hªdËd
 = 
Œue
;

61 şas 
	cAùiveEnşaveSigÇlTe¡
 : 
public
 
Tru¡edAµliÿtiÚ
 {

62 
public
:

63 
AùiveEnşaveSigÇlTe¡
() = ;

65 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

66 ià(!
	gšput
.
HasEx‹nsiÚ
(
sigÇl_‹¡_šput
)) {

67  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

70 
SigÇlTe¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sigÇl_‹¡_šput
);

71 ià(!
	g‹¡_šput
.
has_sigÇl_‹¡_ty³
()) {

72  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

75 
Stus
 
	g¡©us
;

76 
	g¡d
::
futu»
<
Stus
> 
mask_»suÉ
;

77 
	g‹¡_šput
.
sigÇl_‹¡_ty³
()) {

78 
	gSigÇlTe¡IÅut
::
HANDLER
:

79  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
HANDLER
);

80 
	gSigÇlTe¡IÅut
::
SIGNAL
:

81  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGNAL
);

82 
	gSigÇlTe¡IÅut
::
SIGACTION
:

83  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGACTION
);

84 
	gSigÇlTe¡IÅut
::
SIGMASK
:

85 
mask_»suÉ
 = 
¡d
::
async
(¡d::
Ïunch
::async,

86 &
AùiveEnşaveSigÇlTe¡
::
S‘SigÇlMask
, 
this
);

87 
	g¡©us
 = 
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGMASK
);

90 ià(!
	gmask_»suÉ
.
g‘
().
ok
()) {

91  
	gmask_»suÉ
.
g‘
();

93  
	g¡©us
;

94 
	gSigÇlTe¡IÅut
::
SIGACTIONMASK
:

95  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
SIGACTIONMASK
);

96 
	gSigÇlTe¡IÅut
::
RESETHANDLER
:

97  
RunSigÇlTe¡
(
SigÇlTe¡IÅut
::
RESETHANDLER
);

99  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

104 
	g´iv©e
:

105 
Stus
 
RunSigÇlTe¡
(cÚ¡ 
SigÇlTe¡IÅut
::
SigÇlTe¡Ty³
 &
‹¡_ty³
) {

106 
sig£t_t
 
£t
, 
	gŞd£t
;

107 
sigem±y£t
(&
£t
);

108 
sigadd£t
(&
£t
, 
SIGUSR1
);

109 ià(
	g‹¡_ty³
 =ğ
SigÇlTe¡IÅut
::
SIGMASK
) {

110 ià(
sig´ocmask
(
SIG_BLOCK
, &
£t
, &
Şd£t
) != 0) {

111  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

115 
sigaùiÚ
 
	gaù
, 
	gŞdaù
;

116 
sigem±y£t
(&
aù
.
§_mask
);

117 
	g‹¡_ty³
) {

118 
	gSigÇlTe¡IÅut
::
HANDLER
:

119 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

121 
	gSigÇlTe¡IÅut
::
SIGNAL
:

122 
sigÇl
(
SIGUSR1
, &
HªdËSigÇlW™hHªdËr
);

124 
	gSigÇlTe¡IÅut
::
SIGACTION
:

125 
aù
.
§_sigaùiÚ
 = &
HªdËSigÇlW™hSigAùiÚ
;

126 
	gaù
.
	g§_æags
 |ğ
SA_SIGINFO
;

128 
	gSigÇlTe¡IÅut
::
SIGMASK
:

129 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

131 
	gSigÇlTe¡IÅut
::
SIGACTIONMASK
:

133 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

134 
sig£t_t
 
	gmask
;

135 
sigem±y£t
(&
mask
);

136 
sigadd£t
(&
mask
, 
SIGUSR1
);

137 
	gaù
.
	g§_mask
 = 
mask
;

138 
sigaùiÚ
(
SIGUSR2
, &
aù
, &
Şdaù
);

140 
	gaù
.
	g§_hªdËr
 = &
HªdËSigÇlW™hSigAùiÚMask
;

141 
sigem±y£t
(&
mask
);

142 
sigadd£t
(&
mask
, 
SIGUSR2
);

143 
	gaù
.
	g§_mask
 = 
mask
;

145 
	gSigÇlTe¡IÅut
::
RESETHANDLER
:

146 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

147 
	gaù
.
	g§_æags
 |ğ
SA_RESETHAND
;

150  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

153 ià(
	g‹¡_ty³
 !ğ
SigÇlTe¡IÅut
::
SIGNAL
) {

154 
sigaùiÚ
(
SIGUSR1
, &
aù
, &
Şdaù
);

158 
´štf
("readyo„eceive signal!");

159 
fşo£
(
¡dout
);

161 
	gcouÁ
 = 0;

162 
boŞ
 
	g®l_sigÇls_hªdËd
 = 
çl£
;

165 !
	g®l_sigÇls_hªdËd
 && ++
	gcouÁ
 < 
	gkTimeout
) {

166 
	g‹¡_ty³
) {

167 
	gSigÇlTe¡IÅut
::
SIGACTIONMASK
:

168 
®l_sigÇls_hªdËd
 = 
sigÇl_hªdËd
 && 
blocked_sigÇl_hªdËd
;

171 
®l_sigÇls_hªdËd
 = 
sigÇl_hªdËd
;

173 
¦“p
(1);

175 ià(
	g‹¡_ty³
 =ğ
SigÇlTe¡IÅut
::
SIGACTIONMASK
 &&

176 
sigÇl_hªdËr_š‹¼u±ed
) {

177  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

182 ià(
	g‹¡_ty³
 !ğ
SigÇlTe¡IÅut
::
SIGMASK
) {

183  
®l_sigÇls_hªdËd


184 ? 
Stus
::
OkStus
()

185 : 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Signal‚ot„eceived");

189 ià(
	gsigÇl_hªdËd
) {

190  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

193 ià(
sig´ocmask
(
SIG_UNBLOCK
, &
£t
, &
Şd£t
) != 0) {

194  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

198  
	gsigÇl_hªdËd
 ? 
	gStus
::
OkStus
()

199 : 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

205 
Stus
 
S‘SigÇlMask
() {

206 
sig£t_t
 
	g£t
, 
	gŞd£t
;

207 
sigem±y£t
(&
£t
);

208 
sigadd£t
(&
£t
, 
SIGUSR1
);

209 
	gi
 = 0; i < 
	gkTimeout
; ++i) {

210 ià(
sig´ocmask
(
SIG_UNBLOCK
, &
£t
, &
Şd£t
) != 0) {

211  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

214 
¦“p
(1);

216  
	gStus
::
OkStus
();

220 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

221  
Ãw
 
AùiveEnşaveSigÇlTe¡
;

222 
	}
}

	@test/misc/block_enclave_entries_test_driver.cc

19 
	~<¡dio.h
>

20 
	~<sys/sock‘.h
>

22 
	~<¡ršg
>

23 
	~<th»ad
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

27 
	~"asylo/‹¡/misc/block_’şave_’Œ›s_‹¡.pb.h
"

28 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
EÁ”EnşaveToBlockEÁr›s
(
EnşaveCl›Á
 *
ş›Á
,

40 cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

41 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

44 şas 
	cBlockEnşaveEÁr›sTe¡
 : 
public
 
EnşaveTe¡
 {};

47 
TEST_F
(
BlockEnşaveEÁr›sTe¡
, 
BlockUnblock
) {

50 
	gsock‘_·œ
[2];

51 
ASSERT_EQ
(
sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
sock‘_·œ
), 0);

52 
	gblock_sock‘
 = 
sock‘_·œ
[0];

53 
	gcheck_sock‘
 = 
sock‘_·œ
[1];

55 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
block_sock‘_şo£r
(
block_sock‘
);

56 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
check_sock‘_şo£r
(
check_sock‘
);

58 
EnşaveIÅut
 
	g’şave_šput
;

59 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

60 ->
£t_th»ad_ty³
(
BlockEnşaveEÁr›sTe¡IÅut
::
BLOCK
);

61 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

62 ->
£t_sock‘
(
block_sock‘
);

66 
	g¡d
::
th»ad
 
block_th»ad
(
EÁ”EnşaveToBlockEÁr›s
, 
ş›Á_
, 
’şave_šput
);

69 
	gbuf
[64];

70 
	grc
 = 
»ad
(
check_sock‘
, 
buf
, (buf));

71 
ASSERT_GT
(
rc
, 0);

72 
	gbuf
[
rc
] = '\0';

73 
ASSERT_THAT
(
buf
, 
‹¡šg
::
SŒEq
("Enclaveƒntries blocked"));

76 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

77 ->
£t_th»ad_ty³
(
BlockEnşaveEÁr›sTe¡IÅut
::
CHECK
);

79 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
),

80 
NÙ
(
IsOk
()));

83 
	g¡d
::
¡ršg
 
mes§ge
 = "Readyo unblockƒnclaveƒntries";

84 
ASSERT_GT
(
wr™e
(
check_sock‘
, 
mes§ge
.
d©a
(), mes§ge.
size
()), 0);

87 
	grc
 = 
»ad
(
check_sock‘
, 
buf
, (buf));

88 
ASSERT_GT
(
rc
, 0);

89 
	gbuf
[
rc
] = '\0';

90 
ASSERT_THAT
(
buf
, 
‹¡šg
::
SŒEq
("Enclaveƒntries unblocked"));

93 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

94 ->
£t_th»ad_ty³
(
BlockEnşaveEÁr›sTe¡IÅut
::
CHECK
);

96 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

97 
	gblock_th»ad
.
još
();

	@test/misc/block_enclave_entries_test_driver.cc

19 
	~<¡dio.h
>

20 
	~<sys/sock‘.h
>

22 
	~<¡ršg
>

23 
	~<th»ad
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"asylo/¶©fÜm/¡Üage/uts/fd_şo£r.h
"

27 
	~"asylo/‹¡/misc/block_’şave_’Œ›s_‹¡.pb.h
"

28 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

29 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
	~"asylo/ut/¡©us.h
"

31 
	~"asylo/ut/¡©us_maüos.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
EÁ”EnşaveToBlockEÁr›s
(
EnşaveCl›Á
 *
ş›Á
,

40 cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

41 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

44 şas 
	cBlockEnşaveEÁr›sTe¡
 : 
public
 
EnşaveTe¡
 {};

47 
TEST_F
(
BlockEnşaveEÁr›sTe¡
, 
BlockUnblock
) {

50 
	gsock‘_·œ
[2];

51 
ASSERT_EQ
(
sock‘·œ
(
AF_LOCAL
, 
SOCK_STREAM
, 0, 
sock‘_·œ
), 0);

52 
	gblock_sock‘
 = 
sock‘_·œ
[0];

53 
	gcheck_sock‘
 = 
sock‘_·œ
[1];

55 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
block_sock‘_şo£r
(
block_sock‘
);

56 
	g¶©fÜm
::
¡Üage
::
FdClo£r
 
check_sock‘_şo£r
(
check_sock‘
);

58 
EnşaveIÅut
 
	g’şave_šput
;

59 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

60 ->
£t_th»ad_ty³
(
BlockEnşaveEÁr›sTe¡IÅut
::
BLOCK
);

61 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

62 ->
£t_sock‘
(
block_sock‘
);

66 
	g¡d
::
th»ad
 
block_th»ad
(
EÁ”EnşaveToBlockEÁr›s
, 
ş›Á_
, 
’şave_šput
);

69 
	gbuf
[64];

70 
	grc
 = 
»ad
(
check_sock‘
, 
buf
, (buf));

71 
ASSERT_GT
(
rc
, 0);

72 
	gbuf
[
rc
] = '\0';

73 
ASSERT_THAT
(
buf
, 
‹¡šg
::
SŒEq
("Enclaveƒntries blocked"));

76 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

77 ->
£t_th»ad_ty³
(
BlockEnşaveEÁr›sTe¡IÅut
::
CHECK
);

79 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
),

80 
NÙ
(
IsOk
()));

83 
	g¡d
::
¡ršg
 
mes§ge
 = "Readyo unblockƒnclaveƒntries";

84 
ASSERT_GT
(
wr™e
(
check_sock‘
, 
mes§ge
.
d©a
(), mes§ge.
size
()), 0);

87 
	grc
 = 
»ad
(
check_sock‘
, 
buf
, (buf));

88 
ASSERT_GT
(
rc
, 0);

89 
	gbuf
[
rc
] = '\0';

90 
ASSERT_THAT
(
buf
, 
‹¡šg
::
SŒEq
("Enclaveƒntries unblocked"));

93 
	g’şave_šput
.
MubËEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)

94 ->
£t_th»ad_ty³
(
BlockEnşaveEÁr›sTe¡IÅut
::
CHECK
);

96 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
), 
IsOk
());

97 
	gblock_th»ad
.
još
();

	@test/misc/block_enclave_entries_test_enclave.cc

19 
	~<”ºo.h
>

21 
	~<¡ršg
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

25 
	~"asylo/‹¡/misc/block_’şave_’Œ›s_‹¡.pb.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

27 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

32 şas 
	cBlockEnşaveEÁr›sTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

33 
public
:

34 
BlockEnşaveEÁr›sTe¡
() = ;

36 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

37 ià(!
	gšput
.
HasEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)) {

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

41 
BlockEnşaveEÁr›sTe¡IÅut
 
	g‹¡_šput
 =

42 
šput
.
G‘Ex‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
);

43 ià(!
	g‹¡_šput
.
has_th»ad_ty³
()) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

48 ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
BlockEnşaveEÁr›sTe¡IÅut
::
CHECK
) {

51  
Stus
::
OkStus
();

52 } ià(
	g‹¡_šput
.
th»ad_ty³
() ==

53 
BlockEnşaveEÁr›sTe¡IÅut
::
BLOCK
) {

54 ià(!
‹¡_šput
.
has_sock‘
()) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

58 
	gsock‘
 = 
‹¡_šput
.
sock‘
();

62 
’c_block_eÿÎs
();

63 
	g¡d
::
¡ršg
 
mes§ge
 = "Enclaveƒntries blocked";

64 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
mes§ge
.
d©a
(), mes§ge.
size
()) < 0) {

65  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

66 
ab¦
::
SŒC©
("Wr™çed: ", 
¡»¼Ü
(
”ºo
)));

71 
	gbuf
[64];

72 
	grc
 = 
’c_uÁru¡ed_»ad
(
sock‘
, 
buf
, (buf));

73 ià(
	grc
 <= 0) {

74  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

75 
ab¦
::
SŒC©
("R—d faed: ", 
¡»¼Ü
(
”ºo
)));

77 
	gbuf
[
rc
] = '\0';

78 ià(
¡ºcmp
(
buf
, "Readyo unblockƒnclaveƒntries", (buf)) != 0) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unexpected message");

84 
’c_unblock_eÿÎs
();

85 
	gmes§ge
 = "Enclaveƒntries unblocked";

86 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
mes§ge
.
d©a
(), mes§ge.
size
()) < 0) {

87  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

88 
ab¦
::
SŒC©
("Wr™çed: ", 
¡»¼Ü
(
”ºo
)));

91  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

95  
	gStus
::
OkStus
();

99 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

100  
Ãw
 
BlockEnşaveEÁr›sTe¡
;

101 
	}
}

	@test/misc/block_enclave_entries_test_enclave.cc

19 
	~<”ºo.h
>

21 
	~<¡ršg
>

23 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

24 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

25 
	~"asylo/‹¡/misc/block_’şave_’Œ›s_‹¡.pb.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

27 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

32 şas 
	cBlockEnşaveEÁr›sTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

33 
public
:

34 
BlockEnşaveEÁr›sTe¡
() = ;

36 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

37 ià(!
	gšput
.
HasEx‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
)) {

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

41 
BlockEnşaveEÁr›sTe¡IÅut
 
	g‹¡_šput
 =

42 
šput
.
G‘Ex‹nsiÚ
(
block_’şave_’Œ›s_‹¡_šput
);

43 ià(!
	g‹¡_šput
.
has_th»ad_ty³
()) {

44  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

48 ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
BlockEnşaveEÁr›sTe¡IÅut
::
CHECK
) {

51  
Stus
::
OkStus
();

52 } ià(
	g‹¡_šput
.
th»ad_ty³
() ==

53 
BlockEnşaveEÁr›sTe¡IÅut
::
BLOCK
) {

54 ià(!
‹¡_šput
.
has_sock‘
()) {

55  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

58 
	gsock‘
 = 
‹¡_šput
.
sock‘
();

62 
’c_block_eÿÎs
();

63 
	g¡d
::
¡ršg
 
mes§ge
 = "Enclaveƒntries blocked";

64 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
mes§ge
.
d©a
(), mes§ge.
size
()) < 0) {

65  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

66 
ab¦
::
SŒC©
("Wr™çed: ", 
¡»¼Ü
(
”ºo
)));

71 
	gbuf
[64];

72 
	grc
 = 
’c_uÁru¡ed_»ad
(
sock‘
, 
buf
, (buf));

73 ià(
	grc
 <= 0) {

74  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

75 
ab¦
::
SŒC©
("R—d faed: ", 
¡»¼Ü
(
”ºo
)));

77 
	gbuf
[
rc
] = '\0';

78 ià(
¡ºcmp
(
buf
, "Readyo unblockƒnclaveƒntries", (buf)) != 0) {

79  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unexpected message");

84 
’c_unblock_eÿÎs
();

85 
	gmes§ge
 = "Enclaveƒntries unblocked";

86 ià(
’c_uÁru¡ed_wr™e
(
sock‘
, 
mes§ge
.
d©a
(), mes§ge.
size
()) < 0) {

87  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

88 
ab¦
::
SŒC©
("Wr™çed: ", 
¡»¼Ü
(
”ºo
)));

91  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

95  
	gStus
::
OkStus
();

99 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

100  
Ãw
 
BlockEnşaveEÁr›sTe¡
;

101 
	}
}

	@test/misc/condvar_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

26 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
TEST
(
EnşaveCÚdV¬
, 
IÎeg®Poš‹r
) {

38 
EXPECT_EQ
(
±h»ad_cÚd_š™
(
nuÎ±r
,‚uÎ±r), 
EFAULT
);

41 
EXPECT_EQ
(
±h»ad_cÚd_de¡roy
(
nuÎ±r
), 
EFAULT
);

44 
±h»ad_mu‹x_t
 
	gmu
;

45 
EXPECT_EQ
(
±h»ad_cÚd_wa™
(
nuÎ±r
, &
mu
), 
EFAULT
);

46 
±h»ad_cÚd_t
 
	gcv
;

47 
EXPECT_EQ
(
±h»ad_cÚd_wa™
(&
cv
, 
nuÎ±r
), 
EFAULT
);

50 
EXPECT_EQ
(
±h»ad_cÚd_timedwa™
(
nuÎ±r
, &
mu
,‚uÎ±r), 
EFAULT
);

51 
EXPECT_EQ
(
±h»ad_cÚd_timedwa™
(&
cv
, 
nuÎ±r
,‚uÎ±r), 
EFAULT
);

54 
EXPECT_EQ
(
±h»ad_cÚd_sigÇl
(
nuÎ±r
), 
EFAULT
);

57 
EXPECT_EQ
(
±h»ad_cÚd_brßdÿ¡
(
nuÎ±r
), 
EFAULT
);

65 şas 
	cProduûrCÚsum”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

66 
´Ùeùed
:

68 
cÚ¡ex´
 
kNumProduûrTh»ads
 = 8;

71 
cÚ¡ex´
 
	gkCouÁsP”Th»ad
 = 5000;

74 
cÚ¡ex´
 
	gkMaxQueueL’gth
 = 50;

77 
cÚ¡ex´
 
	gkEx³ùedTÙ®CouÁs
 =

78 
kNumProduûrTh»ads
 * 
kCouÁsP”Th»ad
;

81 
Stus
 
CheckInv¬ŸÁs
() {

82  
CheckInRªge
(
couÁ”_
, "couÁ”_", 0, 
kMaxQueueL’gth
);

89 
ProduûrRoutše
() {

92 
±h»ad_mu‹x_lock
(&
mu_
);

93 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; ++i) {

94 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

95 
	gcouÁ”_
 =ğ
kMaxQueueL’gth
) {

96 
±h»ad_cÚd_wa™
(&
cv_
, &
mu_
);

97 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

99 vŞ©
	gcouÁ”_cİy
 = 
couÁ”_
;

100 
BusyWÜk
();

101 
	gcouÁ”_
 = 
couÁ”_cİy
 + 1;

102 
±h»ad_cÚd_brßdÿ¡
(&
cv_
);

104 
±h»ad_mu‹x_uÆock
(&
mu_
);

107 *
ProduûrT¿mpŞše
(*
¬g
) {

108 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

109 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Corruptest…ointer";

110 
	g‹¡
->
ProduûrRoutše
();

111  
	gnuÎ±r
;

117 
CÚsum”Routše
() {

118 
±h»ad_mu‹x_lock
(&
mu_
);

119 
	gi
 = 0; i < 
	gkEx³ùedTÙ®CouÁs
; i++) {

120 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

121 
	gcouÁ”_
 == 0) {

122 
±h»ad_cÚd_wa™
(&
cv_
, &
mu_
);

123 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

126 vŞ©
	gcouÁ”_cİy
 = 
couÁ”_
;

127 
BusyWÜk
();

128 
	gcouÁ”_
 = 
couÁ”_cİy
 - 1;

129 
±h»ad_cÚd_brßdÿ¡
(&
cv_
);

131 
±h»ad_mu‹x_uÆock
(&
mu_
);

134 *
CÚsum”T¿mpŞše
(*
¬g
) {

135 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

136 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Corruptest…ointer";

137 
	g‹¡
->
CÚsum”Routše
();

138  
	gnuÎ±r
;

142 vŞ©
	gcouÁ”_
 = 0;

146 
±h»ad_mu‹x_t
 
	gmu_
;

147 
±h»ad_cÚd_t
 
	gcv_
;

150 
TEST_F
(
ProduûrCÚsum”Te¡
, 
ProduûrCÚsum”
) {

151 
ASSERT_EQ
(
±h»ad_mu‹x_š™
(&
mu_
, 
nuÎ±r
), 0);

152 
ASSERT_EQ
(
±h»ad_cÚd_š™
(&
cv_
, 
nuÎ±r
), 0);

153 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

155 
ASYLO_ASSERT_OK
(

156 
LaunchTh»ads
(
kNumProduûrTh»ads
, 
ProduûrT¿mpŞše
, 
this
, &
th»ads
));

157 
LOG
(
INFO
) << "Producerhreads†aunched";

158 
ASYLO_ASSERT_OK
(
LaunchTh»ads
(1, 
CÚsum”T¿mpŞše
, 
this
, &
th»ads
));

159 
LOG
(
INFO
) << "Consumerhread†aunched";

160 
ASYLO_ASSERT_OK
(
JošTh»ads
(
th»ads
));

161 
LOG
(
INFO
) << "Threads joined";

162 
ASSERT_EQ
(
couÁ”_
, 0);

165 
ASSERT_EQ
(
±h»ad_mu‹x_de¡roy
(&
mu_
), 0);

166 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
cv_
), 0);

173 şas 
	cBrßdÿ¡Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

174 
´Ùeùed
:

175 
cÚ¡ex´
 
kNumTh»ads
 = 8;

177 
Wa™FÜSigÇl
() {

178 
CHECK_EQ
(
±h»ad_mu‹x_lock
(&
mu_
), 0);

179 
	gnum_blocked_
++;

180 
CHECK_EQ
(
±h»ad_cÚd_sigÇl
(&
couÁ”_cv_
), 0);

181 
CHECK_EQ
(
±h»ad_cÚd_wa™
(&
brßdÿ¡_cv_
, &
mu_
), 0);

182 
CHECK_EQ
(
±h»ad_mu‹x_uÆock
(&
mu_
), 0);

185 *
Wa™FÜSigÇlT¿mpŞše
(*
¬g
) {

186 
Brßdÿ¡Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<Brßdÿ¡Te¡ *>(
¬g
);

187 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Corruptest…ointer";

188 
	g‹¡
->
Wa™FÜSigÇl
();

189  
	gnuÎ±r
;

193 vŞ©
	gnum_blocked_
 = 0;

196 
±h»ad_mu‹x_t
 
	gmu_
 = 
PTHREAD_MUTEX_INITIALIZER
;

199 
±h»ad_cÚd_t
 
	gbrßdÿ¡_cv_
 = 
PTHREAD_COND_INITIALIZER
;

202 
±h»ad_cÚd_t
 
	gcouÁ”_cv_
 = 
PTHREAD_COND_INITIALIZER
;

205 
TEST_F
(
Brßdÿ¡Te¡
, 
Brßdÿ¡
) {

207 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

208 
ASYLO_ASSERT_OK
(

209 
LaunchTh»ads
(
kNumTh»ads
, 
Wa™FÜSigÇlT¿mpŞše
, 
this
, &
th»ads
));

212 
ASSERT_EQ
(
±h»ad_mu‹x_lock
(&
mu_
), 0);

213 
	gnum_blocked_
 !ğ
kNumTh»ads
) {

214 
ASSERT_EQ
(
±h»ad_cÚd_wa™
(&
couÁ”_cv_
, &
mu_
), 0);

216 
ASSERT_EQ
(
±h»ad_mu‹x_uÆock
(&
mu_
), 0);

219 
ASSERT_EQ
(
±h»ad_cÚd_brßdÿ¡
(&
brßdÿ¡_cv_
), 0);

223 
ASYLO_ASSERT_OK
(
JošTh»ads
(
th»ads
));

226 
ASSERT_EQ
(
±h»ad_mu‹x_de¡roy
(&
mu_
), 0);

227 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
couÁ”_cv_
), 0);

228 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
brßdÿ¡_cv_
), 0);

231 
TEST
(
EnşaveCÚdV¬
, 
Timeout
) {

232 
cÚ¡ex´
 
	gkD—dlšeSecÚds
 = 3;

235 
±h»ad_cÚd_t
 
	gcv
 = 
PTHREAD_COND_INITIALIZER
;

236 
±h»ad_mu‹x_t
 
	gmu
 = 
PTHREAD_MUTEX_INITIALIZER
;

238 
time¥ec
 
	gd—dlše
;

239 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
d—dlše
), 0);

240 
	gd—dlše
.
	gtv_£c
 +ğ
kD—dlšeSecÚds
;

241 
±h»ad_mu‹x_lock
(&
mu
);

242 
LOG
(
INFO
) << "Goingo sleep";

243 
ASSERT_EQ
(
±h»ad_cÚd_timedwa™
(&
cv
, &
mu
, &
d—dlše
), 
ETIMEDOUT
);

244 
LOG
(
INFO
) << "Waking up";

245 
±h»ad_mu‹x_uÆock
(&
mu
);

248 
time¥ec
 
	gcu¼_time
, 
	g»suÉ
;

249 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
cu¼_time
), 0);

250 
ASSERT_TRUE
(
asylo
::
TimeS³cSubŒaù
(
d—dlše
, 
cu¼_time
, &
»suÉ
));

253 
ASSERT_EQ
(
±h»ad_mu‹x_de¡roy
(&
mu
), 0);

254 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
cv
), 0);

	@test/misc/condvar_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

26 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
TEST
(
EnşaveCÚdV¬
, 
IÎeg®Poš‹r
) {

38 
EXPECT_EQ
(
±h»ad_cÚd_š™
(
nuÎ±r
,‚uÎ±r), 
EFAULT
);

41 
EXPECT_EQ
(
±h»ad_cÚd_de¡roy
(
nuÎ±r
), 
EFAULT
);

44 
±h»ad_mu‹x_t
 
	gmu
;

45 
EXPECT_EQ
(
±h»ad_cÚd_wa™
(
nuÎ±r
, &
mu
), 
EFAULT
);

46 
±h»ad_cÚd_t
 
	gcv
;

47 
EXPECT_EQ
(
±h»ad_cÚd_wa™
(&
cv
, 
nuÎ±r
), 
EFAULT
);

50 
EXPECT_EQ
(
±h»ad_cÚd_timedwa™
(
nuÎ±r
, &
mu
,‚uÎ±r), 
EFAULT
);

51 
EXPECT_EQ
(
±h»ad_cÚd_timedwa™
(&
cv
, 
nuÎ±r
,‚uÎ±r), 
EFAULT
);

54 
EXPECT_EQ
(
±h»ad_cÚd_sigÇl
(
nuÎ±r
), 
EFAULT
);

57 
EXPECT_EQ
(
±h»ad_cÚd_brßdÿ¡
(
nuÎ±r
), 
EFAULT
);

65 şas 
	cProduûrCÚsum”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

66 
´Ùeùed
:

68 
cÚ¡ex´
 
kNumProduûrTh»ads
 = 8;

71 
cÚ¡ex´
 
	gkCouÁsP”Th»ad
 = 5000;

74 
cÚ¡ex´
 
	gkMaxQueueL’gth
 = 50;

77 
cÚ¡ex´
 
	gkEx³ùedTÙ®CouÁs
 =

78 
kNumProduûrTh»ads
 * 
kCouÁsP”Th»ad
;

81 
Stus
 
CheckInv¬ŸÁs
() {

82  
CheckInRªge
(
couÁ”_
, "couÁ”_", 0, 
kMaxQueueL’gth
);

89 
ProduûrRoutše
() {

92 
±h»ad_mu‹x_lock
(&
mu_
);

93 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; ++i) {

94 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

95 
	gcouÁ”_
 =ğ
kMaxQueueL’gth
) {

96 
±h»ad_cÚd_wa™
(&
cv_
, &
mu_
);

97 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

99 vŞ©
	gcouÁ”_cİy
 = 
couÁ”_
;

100 
BusyWÜk
();

101 
	gcouÁ”_
 = 
couÁ”_cİy
 + 1;

102 
±h»ad_cÚd_brßdÿ¡
(&
cv_
);

104 
±h»ad_mu‹x_uÆock
(&
mu_
);

107 *
ProduûrT¿mpŞše
(*
¬g
) {

108 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

109 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Corruptest…ointer";

110 
	g‹¡
->
ProduûrRoutše
();

111  
	gnuÎ±r
;

117 
CÚsum”Routše
() {

118 
±h»ad_mu‹x_lock
(&
mu_
);

119 
	gi
 = 0; i < 
	gkEx³ùedTÙ®CouÁs
; i++) {

120 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

121 
	gcouÁ”_
 == 0) {

122 
±h»ad_cÚd_wa™
(&
cv_
, &
mu_
);

123 
ASYLO_ASSERT_OK
(
CheckInv¬ŸÁs
());

126 vŞ©
	gcouÁ”_cİy
 = 
couÁ”_
;

127 
BusyWÜk
();

128 
	gcouÁ”_
 = 
couÁ”_cİy
 - 1;

129 
±h»ad_cÚd_brßdÿ¡
(&
cv_
);

131 
±h»ad_mu‹x_uÆock
(&
mu_
);

134 *
CÚsum”T¿mpŞše
(*
¬g
) {

135 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

136 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Corruptest…ointer";

137 
	g‹¡
->
CÚsum”Routše
();

138  
	gnuÎ±r
;

142 vŞ©
	gcouÁ”_
 = 0;

146 
±h»ad_mu‹x_t
 
	gmu_
;

147 
±h»ad_cÚd_t
 
	gcv_
;

150 
TEST_F
(
ProduûrCÚsum”Te¡
, 
ProduûrCÚsum”
) {

151 
ASSERT_EQ
(
±h»ad_mu‹x_š™
(&
mu_
, 
nuÎ±r
), 0);

152 
ASSERT_EQ
(
±h»ad_cÚd_š™
(&
cv_
, 
nuÎ±r
), 0);

153 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

155 
ASYLO_ASSERT_OK
(

156 
LaunchTh»ads
(
kNumProduûrTh»ads
, 
ProduûrT¿mpŞše
, 
this
, &
th»ads
));

157 
LOG
(
INFO
) << "Producerhreads†aunched";

158 
ASYLO_ASSERT_OK
(
LaunchTh»ads
(1, 
CÚsum”T¿mpŞše
, 
this
, &
th»ads
));

159 
LOG
(
INFO
) << "Consumerhread†aunched";

160 
ASYLO_ASSERT_OK
(
JošTh»ads
(
th»ads
));

161 
LOG
(
INFO
) << "Threads joined";

162 
ASSERT_EQ
(
couÁ”_
, 0);

165 
ASSERT_EQ
(
±h»ad_mu‹x_de¡roy
(&
mu_
), 0);

166 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
cv_
), 0);

173 şas 
	cBrßdÿ¡Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

174 
´Ùeùed
:

175 
cÚ¡ex´
 
kNumTh»ads
 = 8;

177 
Wa™FÜSigÇl
() {

178 
CHECK_EQ
(
±h»ad_mu‹x_lock
(&
mu_
), 0);

179 
	gnum_blocked_
++;

180 
CHECK_EQ
(
±h»ad_cÚd_sigÇl
(&
couÁ”_cv_
), 0);

181 
CHECK_EQ
(
±h»ad_cÚd_wa™
(&
brßdÿ¡_cv_
, &
mu_
), 0);

182 
CHECK_EQ
(
±h»ad_mu‹x_uÆock
(&
mu_
), 0);

185 *
Wa™FÜSigÇlT¿mpŞše
(*
¬g
) {

186 
Brßdÿ¡Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<Brßdÿ¡Te¡ *>(
¬g
);

187 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Corruptest…ointer";

188 
	g‹¡
->
Wa™FÜSigÇl
();

189  
	gnuÎ±r
;

193 vŞ©
	gnum_blocked_
 = 0;

196 
±h»ad_mu‹x_t
 
	gmu_
 = 
PTHREAD_MUTEX_INITIALIZER
;

199 
±h»ad_cÚd_t
 
	gbrßdÿ¡_cv_
 = 
PTHREAD_COND_INITIALIZER
;

202 
±h»ad_cÚd_t
 
	gcouÁ”_cv_
 = 
PTHREAD_COND_INITIALIZER
;

205 
TEST_F
(
Brßdÿ¡Te¡
, 
Brßdÿ¡
) {

207 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

208 
ASYLO_ASSERT_OK
(

209 
LaunchTh»ads
(
kNumTh»ads
, 
Wa™FÜSigÇlT¿mpŞše
, 
this
, &
th»ads
));

212 
ASSERT_EQ
(
±h»ad_mu‹x_lock
(&
mu_
), 0);

213 
	gnum_blocked_
 !ğ
kNumTh»ads
) {

214 
ASSERT_EQ
(
±h»ad_cÚd_wa™
(&
couÁ”_cv_
, &
mu_
), 0);

216 
ASSERT_EQ
(
±h»ad_mu‹x_uÆock
(&
mu_
), 0);

219 
ASSERT_EQ
(
±h»ad_cÚd_brßdÿ¡
(&
brßdÿ¡_cv_
), 0);

223 
ASYLO_ASSERT_OK
(
JošTh»ads
(
th»ads
));

226 
ASSERT_EQ
(
±h»ad_mu‹x_de¡roy
(&
mu_
), 0);

227 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
couÁ”_cv_
), 0);

228 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
brßdÿ¡_cv_
), 0);

231 
TEST
(
EnşaveCÚdV¬
, 
Timeout
) {

232 
cÚ¡ex´
 
	gkD—dlšeSecÚds
 = 3;

235 
±h»ad_cÚd_t
 
	gcv
 = 
PTHREAD_COND_INITIALIZER
;

236 
±h»ad_mu‹x_t
 
	gmu
 = 
PTHREAD_MUTEX_INITIALIZER
;

238 
time¥ec
 
	gd—dlše
;

239 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
d—dlše
), 0);

240 
	gd—dlše
.
	gtv_£c
 +ğ
kD—dlšeSecÚds
;

241 
±h»ad_mu‹x_lock
(&
mu
);

242 
LOG
(
INFO
) << "Goingo sleep";

243 
ASSERT_EQ
(
±h»ad_cÚd_timedwa™
(&
cv
, &
mu
, &
d—dlše
), 
ETIMEDOUT
);

244 
LOG
(
INFO
) << "Waking up";

245 
±h»ad_mu‹x_uÆock
(&
mu
);

248 
time¥ec
 
	gcu¼_time
, 
	g»suÉ
;

249 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
cu¼_time
), 0);

250 
ASSERT_TRUE
(
asylo
::
TimeS³cSubŒaù
(
d—dlše
, 
cu¼_time
, &
»suÉ
));

253 
ASSERT_EQ
(
±h»ad_mu‹x_de¡roy
(&
mu
), 0);

254 
ASSERT_EQ
(
±h»ad_cÚd_de¡roy
(&
cv
), 0);

	@test/misc/die.cc

19 
	~<c¡dlib
>

21 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

22 
	~"šşude/sgx_Œts.h
"

24 
Çme¥aû
 
	gasylo
 {

26 şas 
	cTe¡D›
 : 
public
 
Tru¡edAµliÿtiÚ
 {

27 
public
:

28 
Te¡D›
() = ;

30 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *è
	gov”ride
 {

32 ià(
sgx_is_’şave_üashed
()) {

33  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Enclave is crashed");

36 
abÜt
();

40 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Te¡D›
; 
	}
}

	@test/misc/die.cc

19 
	~<c¡dlib
>

21 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

22 
	~"šşude/sgx_Œts.h
"

24 
Çme¥aû
 
	gasylo
 {

26 şas 
	cTe¡D›
 : 
public
 
Tru¡edAµliÿtiÚ
 {

27 
public
:

28 
Te¡D›
() = ;

30 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *è
	gov”ride
 {

32 ià(
sgx_is_’şave_üashed
()) {

33  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Enclave is crashed");

36 
abÜt
();

40 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Te¡D›
; 
	}
}

	@test/misc/die_test.cc

19 
	~<c¡dlib
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

23 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 şas 
	cD›Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

29 
public
:

30 
D›Te¡
()

31 : 
­p_
(
ex³rim’l
::
ExecTe¡”
::
BudSiblšgP©h
(

32 
FLAGS_’şave_·th
, "double_die_host_bin")) {}

34 
	g´Ùeùed
:

35 
¡d
::
¡ršg
 
­p_
;

38 
TEST_F
(
D›Te¡
, 
T¿pEx™s
) {

39 
EXPECT_EXIT
(
__butš_Œ­
(), ::
‹¡šg
::
KËdBySigÇl
(
SIGILL
), ".*");

42 
TEST_F
(
D›Te¡
, 
H®tEx™s
) {

43 
EXPECT_EXIT
(
asm
("hÉ"), ::
‹¡šg
::
KËdBySigÇl
(
SIGSEGV
), ".*");

46 
TEST_F
(
D›Te¡
, 
NoEÁryAá”D›
) {

47 
	gex³rim’l
::
ExecTe¡”
 
run
({
­p_
, 
FLAGS_’şave_·th
});

48 
	g¡©us
 = 0;

49 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

50 
EXPECT_FALSE
(
WIFSIGNALED
(
¡©us
)) << "Terminated by signal "

51 << 
WTERMSIG
(
¡©us
);

52 
ASSERT_TRUE
(
WIFEXITED
(
¡©us
));

53 
EXPECT_EQ
(
EXIT_FAILURE
, 
WEXITSTATUS
(
¡©us
));

56 
TEST_F
(
D›Te¡
, 
CheckSIGILL
) {

57 
	gex³rim’l
::
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--sigill")});

58 
	g¡©us
 = 0;

59 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

60 
EXPECT_FALSE
(
WIFEXITED
(
¡©us
)) << "Terminated byƒxit,‚ot signal: "

61 << 
WEXITSTATUS
(
¡©us
);

62 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

63 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

66 
TEST_F
(
D›Te¡
, 
D›Rai£sSIGILL
) {

67 
	gex³rim’l
::
ExecTe¡”
 
run
(

68 {
­p_
, 
FLAGS_’şave_·th
, 
¡d
::
¡ršg
("--die")});

69 
	g¡©us
 = 0;

70 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

71 
EXPECT_FALSE
(
WIFEXITED
(
¡©us
)) << "Terminated byƒxit,‚ot signal: "

72 << 
WEXITSTATUS
(
¡©us
);

73 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

74 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

	@test/misc/die_test.cc

19 
	~<c¡dlib
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

23 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 şas 
	cD›Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

29 
public
:

30 
D›Te¡
()

31 : 
­p_
(
ex³rim’l
::
ExecTe¡”
::
BudSiblšgP©h
(

32 
FLAGS_’şave_·th
, "double_die_host_bin")) {}

34 
	g´Ùeùed
:

35 
¡d
::
¡ršg
 
­p_
;

38 
TEST_F
(
D›Te¡
, 
T¿pEx™s
) {

39 
EXPECT_EXIT
(
__butš_Œ­
(), ::
‹¡šg
::
KËdBySigÇl
(
SIGILL
), ".*");

42 
TEST_F
(
D›Te¡
, 
H®tEx™s
) {

43 
EXPECT_EXIT
(
asm
("hÉ"), ::
‹¡šg
::
KËdBySigÇl
(
SIGSEGV
), ".*");

46 
TEST_F
(
D›Te¡
, 
NoEÁryAá”D›
) {

47 
	gex³rim’l
::
ExecTe¡”
 
run
({
­p_
, 
FLAGS_’şave_·th
});

48 
	g¡©us
 = 0;

49 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

50 
EXPECT_FALSE
(
WIFSIGNALED
(
¡©us
)) << "Terminated by signal "

51 << 
WTERMSIG
(
¡©us
);

52 
ASSERT_TRUE
(
WIFEXITED
(
¡©us
));

53 
EXPECT_EQ
(
EXIT_FAILURE
, 
WEXITSTATUS
(
¡©us
));

56 
TEST_F
(
D›Te¡
, 
CheckSIGILL
) {

57 
	gex³rim’l
::
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--sigill")});

58 
	g¡©us
 = 0;

59 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

60 
EXPECT_FALSE
(
WIFEXITED
(
¡©us
)) << "Terminated byƒxit,‚ot signal: "

61 << 
WEXITSTATUS
(
¡©us
);

62 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

63 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

66 
TEST_F
(
D›Te¡
, 
D›Rai£sSIGILL
) {

67 
	gex³rim’l
::
ExecTe¡”
 
run
(

68 {
­p_
, 
FLAGS_’şave_·th
, 
¡d
::
¡ršg
("--die")});

69 
	g¡©us
 = 0;

70 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

71 
EXPECT_FALSE
(
WIFEXITED
(
¡©us
)) << "Terminated byƒxit,‚ot signal: "

72 << 
WEXITSTATUS
(
¡©us
);

73 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

74 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

	@test/misc/double_die.cc

19 
	~<c£tjmp
>

20 
	~<csigÇl
>

21 
	~<c¡dlib
>

22 
	~<io¡»am
>

23 
	~<¡ršg
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/ş›Á.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
jmp_buf
 
	g’v
;

34 
Ú_SIGILL
(è{ 
lÚgjmp
(
’v
, 1); }

36 şas 
	cD›Te¡
 {

37 
	gpublic
:

38 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

39 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

40 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

41 ià(!
	gmªag”_»suÉ
.
ok
()) {

42 
	g¡d
::
û¼
 << 
mªag”_»suÉ
.
¡©us
(è<< 
¡d
::
’dl
;

43 
ex™
(1);

45 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

46 
	g¡d
::
û¼
 << "In™ " << 
’şave_·th
 << 
¡d
::
’dl
;

47 
	glßd”_
 = 
ab¦
::
make_unique
<
SgxLßd”
>(
’şave_·th
, 
	gŒue
);

49 
	g¡d
::
¡ršg
 
’şave_u¾
 = "/die";

50 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
(
’şave_u¾
, *
lßd”_
);

51 
ASSERT_TRUE
(
¡©us
.
ok
());

52 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
(
’şave_u¾
);

55 ~
D›Te¡
() {

57 
EnşaveFš®
 
	gefš®
;

58 
	gmªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
);

61 
Run
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

62 
In™Ÿlize
(
’şave_·th
);

64 
sigaùiÚ
 
	g§
;

65 
mem£t
(&
§
, '\0', (
sigaùiÚ
));

66 
	g§
.
	g§_hªdËr
 = &
Ú_SIGILL
;

67 
sigaùiÚ
(
SIGILL
, &
§
, 
nuÎ±r
);

69 ià(
£tjmp
(
’v
) == 0) {

70 
EnşaveIÅut
 
ešput
;

71 
	g¡d
::
û¼
 << "Round oÃ" << 
¡d
::
’dl
;

72 
	gş›Á_
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

73 
	g¡d
::
û¼
 << "UÄ—chabË?" << 
¡d
::
’dl
;

74 
	g¡d
::
û¼
 << "AbÜˆhªdË¸should‡ùiv©fœ¡." << 
¡d
::
’dl
;

75 
ex™
(1);

77 
EnşaveIÅut
 
	gešput
;

78 
	g¡d
::
û¼
 << "Gošg‡gaš" << 
¡d
::
’dl
;

80 
	gş›Á_
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

81 
	g¡d
::
û¼
 << "Cª'ˆ»’‹¸š incÚsi¡’ˆ¡©e." << 
¡d
::
’dl
;

82 
ex™
(1);

86 
Sim¶eRun
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

87 
In™Ÿlize
(
’şave_·th
);

88 
EnşaveIÅut
 
	gešput
;

89 
	gş›Á_
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

92 
	g´Ùeùed
:

93 
EnşaveMªag”
 *
mªag”_
;

94 
	g¡d
::
unique_±r
<
SgxLßd”
> 
lßd”_
;

95 
EnşaveCl›Á
 *
	gş›Á_
;

101 
	$maš
(
¬gc
, *
¬gv
[]) {

102 ià(
¬gc
 != 2 &&‡rgc != 3) {

103 
¡d
::
û¼
 << "Ex³ùed u§ge: " << 
¬gv
[0]

106 
i
 = 0; i < 
¬gc
; ++i) {

107 
¡d
::
û¼
 << 
¬gv
[
i
] << std::
’dl
;

109 
	`abÜt
();

112 
asylo
::
D›Te¡
 
‹¡
;

114 ià(
¬gc
 =ğ2 && 
	`¡rcmp
(
¬gv
[1], "--sigill") == 0) {

115 
	`__butš_Œ­
();

117 ià(
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[2], "--die") == 0) {

118 
‹¡
.
	`Sim¶eRun
(
¬gv
[1]);

120 
‹¡
.
	`Run
(
¬gv
[1]);

123 
	}
}

	@test/misc/double_die.cc

19 
	~<c£tjmp
>

20 
	~<csigÇl
>

21 
	~<c¡dlib
>

22 
	~<io¡»am
>

23 
	~<¡ršg
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/ş›Á.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
jmp_buf
 
	g’v
;

34 
Ú_SIGILL
(è{ 
lÚgjmp
(
’v
, 1); }

36 şas 
	cD›Te¡
 {

37 
	gpublic
:

38 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

39 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

40 
	gStusOr
<
	gEnşaveMªag”
 *> 
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

41 ià(!
	gmªag”_»suÉ
.
ok
()) {

42 
	g¡d
::
û¼
 << 
mªag”_»suÉ
.
¡©us
(è<< 
¡d
::
’dl
;

43 
ex™
(1);

45 
	gmªag”_
 = 
mªag”_»suÉ
.
V®ueOrD›
();

46 
	g¡d
::
û¼
 << "In™ " << 
’şave_·th
 << 
¡d
::
’dl
;

47 
	glßd”_
 = 
ab¦
::
make_unique
<
SgxLßd”
>(
’şave_·th
, 
	gŒue
);

49 
	g¡d
::
¡ršg
 
’şave_u¾
 = "/die";

50 
Stus
 
	g¡©us
 = 
mªag”_
->
LßdEnşave
(
’şave_u¾
, *
lßd”_
);

51 
ASSERT_TRUE
(
¡©us
.
ok
());

52 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
(
’şave_u¾
);

55 ~
D›Te¡
() {

57 
EnşaveFš®
 
	gefš®
;

58 
	gmªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
);

61 
Run
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

62 
In™Ÿlize
(
’şave_·th
);

64 
sigaùiÚ
 
	g§
;

65 
mem£t
(&
§
, '\0', (
sigaùiÚ
));

66 
	g§
.
	g§_hªdËr
 = &
Ú_SIGILL
;

67 
sigaùiÚ
(
SIGILL
, &
§
, 
nuÎ±r
);

69 ià(
£tjmp
(
’v
) == 0) {

70 
EnşaveIÅut
 
ešput
;

71 
	g¡d
::
û¼
 << "Round oÃ" << 
¡d
::
’dl
;

72 
	gş›Á_
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

73 
	g¡d
::
û¼
 << "UÄ—chabË?" << 
¡d
::
’dl
;

74 
	g¡d
::
û¼
 << "AbÜˆhªdË¸should‡ùiv©fœ¡." << 
¡d
::
’dl
;

75 
ex™
(1);

77 
EnşaveIÅut
 
	gešput
;

78 
	g¡d
::
û¼
 << "Gošg‡gaš" << 
¡d
::
’dl
;

80 
	gş›Á_
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

81 
	g¡d
::
û¼
 << "Cª'ˆ»’‹¸š incÚsi¡’ˆ¡©e." << 
¡d
::
’dl
;

82 
ex™
(1);

86 
Sim¶eRun
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

87 
In™Ÿlize
(
’şave_·th
);

88 
EnşaveIÅut
 
	gešput
;

89 
	gş›Á_
->
EÁ”AndRun
(
ešput
, 
nuÎ±r
);

92 
	g´Ùeùed
:

93 
EnşaveMªag”
 *
mªag”_
;

94 
	g¡d
::
unique_±r
<
SgxLßd”
> 
lßd”_
;

95 
EnşaveCl›Á
 *
	gş›Á_
;

101 
	$maš
(
¬gc
, *
¬gv
[]) {

102 ià(
¬gc
 != 2 &&‡rgc != 3) {

103 
¡d
::
û¼
 << "Ex³ùed u§ge: " << 
¬gv
[0]

106 
i
 = 0; i < 
¬gc
; ++i) {

107 
¡d
::
û¼
 << 
¬gv
[
i
] << std::
’dl
;

109 
	`abÜt
();

112 
asylo
::
D›Te¡
 
‹¡
;

114 ià(
¬gc
 =ğ2 && 
	`¡rcmp
(
¬gv
[1], "--sigill") == 0) {

115 
	`__butš_Œ­
();

117 ià(
¬gc
 =ğ3 && 
	`¡rcmp
(
¬gv
[2], "--die") == 0) {

118 
‹¡
.
	`Sim¶eRun
(
¬gv
[1]);

120 
‹¡
.
	`Run
(
¬gv
[1]);

123 
	}
}

	@test/misc/embedded_enclave_test_driver.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/ş›Á.h
"

21 
	~"asylo/’şave.pb.h
"

22 
	~"asylo/’şave_mªag”.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
DEFINE_¡ršg
(
’şave_£ùiÚ
, "", "The ELF sectionheƒnclave is†ocated in");

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
cÚ¡ex´
 
	gkEnşaveName
[] = "enclave";

33 
TEST
(
EmbeddedEnşaveTe¡
, 
EnşaveLßdsAndRuns
) {

35 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

36 autØ
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

37 
ASSERT_THAT
(
mªag”_»suÉ
, 
IsOk
());

38 
EnşaveMªag”
 *
	gmªag”
 = 
mªag”_»suÉ
.
V®ueOrD›
();

41 
SgxEmbeddedLßd”
 
lßd”
(
FLAGS_’şave_£ùiÚ
, 
Œue
);

42 
EnşaveCÚfig
 
	gcÚfig
;

43 
ASSERT_THAT
(
mªag”
->
LßdEnşave
(
kEnşaveName
, 
lßd”
, 
cÚfig
), 
IsOk
());

44 
EnşaveCl›Á
 *
	gş›Á
 = 
mªag”
->
G‘Cl›Á
(
kEnşaveName
);

47 
EnşaveIÅut
 
	gšput
;

48 
EnşaveOuut
 
	gouut
;

49 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
šput
, &
ouut
), 
IsOk
());

52 
EnşaveFš®
 
	gfš®_šput
;

53 
EXPECT_THAT
(
mªag”
->
De¡royEnşave
(
ş›Á
, 
fš®_šput
), 
IsOk
());

	@test/misc/embedded_enclave_test_driver.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/ş›Á.h
"

21 
	~"asylo/’şave.pb.h
"

22 
	~"asylo/’şave_mªag”.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
DEFINE_¡ršg
(
’şave_£ùiÚ
, "", "The ELF sectionheƒnclave is†ocated in");

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 
cÚ¡ex´
 
	gkEnşaveName
[] = "enclave";

33 
TEST
(
EmbeddedEnşaveTe¡
, 
EnşaveLßdsAndRuns
) {

35 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

36 autØ
	gmªag”_»suÉ
 = 
EnşaveMªag”
::
In¡ªû
();

37 
ASSERT_THAT
(
mªag”_»suÉ
, 
IsOk
());

38 
EnşaveMªag”
 *
	gmªag”
 = 
mªag”_»suÉ
.
V®ueOrD›
();

41 
SgxEmbeddedLßd”
 
lßd”
(
FLAGS_’şave_£ùiÚ
, 
Œue
);

42 
EnşaveCÚfig
 
	gcÚfig
;

43 
ASSERT_THAT
(
mªag”
->
LßdEnşave
(
kEnşaveName
, 
lßd”
, 
cÚfig
), 
IsOk
());

44 
EnşaveCl›Á
 *
	gş›Á
 = 
mªag”
->
G‘Cl›Á
(
kEnşaveName
);

47 
EnşaveIÅut
 
	gšput
;

48 
EnşaveOuut
 
	gouut
;

49 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
šput
, &
ouut
), 
IsOk
());

52 
EnşaveFš®
 
	gfš®_šput
;

53 
EXPECT_THAT
(
mªag”
->
De¡royEnşave
(
ş›Á
, 
fš®_šput
), 
IsOk
());

	@test/misc/enclave_entry_count_test_driver.cc

19 
	~<uni¡d.h
>

21 
	~<th»ad
>

22 
	~<veùÜ
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/misc/’şave_’Œy_couÁ_‹¡.pb.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

35 
EÁ”Enşave
(
EnşaveCl›Á
 *
ş›Á
, cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

36 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
),

37 
IsOk
());

40 şas 
	cEnşaveEÁryCouÁTe¡
 : 
public
 
EnşaveTe¡
 {

41 
´Ùeùed
:

42 
Stus
 
RunEnşaveEÁryCouÁTe¡
(
numb”_th»ads
) {

45 
EnşaveIÅut
 
’şave_šput
;

46 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

47 ->
£t_th»ad_ty³
(
EnşaveEÁryCouÁTe¡IÅut
::
DONOTHING
);

48 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
’Œy_befÜe_couÁ_th»ads
(
numb”_th»ads
);

49 
	gi
 = 0; i < 
	gnumb”_th»ads
; ++i) {

50 
	g’Œy_befÜe_couÁ_th»ads
[
i
] =

51 
¡d
::
th»ad
(
EÁ”Enşave
, 
ş›Á_
, 
’şave_šput
);

54 
	gi
 = 0; i < 
	gnumb”_th»ads
; ++i) {

55 
	g’Œy_befÜe_couÁ_th»ads
[
i
].
još
();

60 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

61 ->
£t_th»ad_ty³
(
EnşaveEÁryCouÁTe¡IÅut
::
WAIT
);

62 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
’Œy_th»ads
(
numb”_th»ads
 - 1);

63 
	gi
 = 0; i < 
	gnumb”_th»ads
 - 1; ++i) {

64 
	g’Œy_th»ads
[
i
] = 
¡d
::
th»ad
(
EÁ”Enşave
, 
ş›Á_
, 
’şave_šput
);

66 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

67 ->
£t_th»ad_ty³
(
EnşaveEÁryCouÁTe¡IÅut
::
COUNT
);

68 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

69 ->
£t_ex³ùed_’Œ›s
(
numb”_th»ads
);

71 
EnşaveOuut
 
	g’şave_ouut
;

72 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
);

73 ià(!
	g¡©us
.
ok
()) {

74  
	g¡©us
;

76 
	gi
 = 0; i < 
	gnumb”_th»ads
 - 1; ++i) {

77 
	g’Œy_th»ads
[
i
].
još
();

79 ià(
	g’şave_ouut
.
G‘Ex‹nsiÚ
(
numb”_’Œ›s
è!ğ
numb”_th»ads
) {

80  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

83  
	gStus
::
OkStus
();

88 
TEST_F
(
EnşaveEÁryCouÁTe¡
, 
SšgËTh»ad
) {

89 
cÚ¡ex´
 
	gnumb”_th»ads
 = 1;

90 
EXPECT_THAT
(
RunEnşaveEÁryCouÁTe¡
(
numb”_th»ads
), 
IsOk
());

94 
TEST_F
(
EnşaveEÁryCouÁTe¡
, 
MuÉiTh»ad
) {

95 
cÚ¡ex´
 
	gnumb”_th»ads
 = 8;

96 
EXPECT_THAT
(
RunEnşaveEÁryCouÁTe¡
(
numb”_th»ads
), 
IsOk
());

	@test/misc/enclave_entry_count_test_driver.cc

19 
	~<uni¡d.h
>

21 
	~<th»ad
>

22 
	~<veùÜ
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/misc/’şave_’Œy_couÁ_‹¡.pb.h
"

26 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

35 
EÁ”Enşave
(
EnşaveCl›Á
 *
ş›Á
, cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

36 
EXPECT_THAT
(
ş›Á
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
),

37 
IsOk
());

40 şas 
	cEnşaveEÁryCouÁTe¡
 : 
public
 
EnşaveTe¡
 {

41 
´Ùeùed
:

42 
Stus
 
RunEnşaveEÁryCouÁTe¡
(
numb”_th»ads
) {

45 
EnşaveIÅut
 
’şave_šput
;

46 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

47 ->
£t_th»ad_ty³
(
EnşaveEÁryCouÁTe¡IÅut
::
DONOTHING
);

48 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
’Œy_befÜe_couÁ_th»ads
(
numb”_th»ads
);

49 
	gi
 = 0; i < 
	gnumb”_th»ads
; ++i) {

50 
	g’Œy_befÜe_couÁ_th»ads
[
i
] =

51 
¡d
::
th»ad
(
EÁ”Enşave
, 
ş›Á_
, 
’şave_šput
);

54 
	gi
 = 0; i < 
	gnumb”_th»ads
; ++i) {

55 
	g’Œy_befÜe_couÁ_th»ads
[
i
].
još
();

60 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

61 ->
£t_th»ad_ty³
(
EnşaveEÁryCouÁTe¡IÅut
::
WAIT
);

62 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
’Œy_th»ads
(
numb”_th»ads
 - 1);

63 
	gi
 = 0; i < 
	gnumb”_th»ads
 - 1; ++i) {

64 
	g’Œy_th»ads
[
i
] = 
¡d
::
th»ad
(
EÁ”Enşave
, 
ş›Á_
, 
’şave_šput
);

66 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

67 ->
£t_th»ad_ty³
(
EnşaveEÁryCouÁTe¡IÅut
::
COUNT
);

68 
	g’şave_šput
.
MubËEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)

69 ->
£t_ex³ùed_’Œ›s
(
numb”_th»ads
);

71 
EnşaveOuut
 
	g’şave_ouut
;

72 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
);

73 ià(!
	g¡©us
.
ok
()) {

74  
	g¡©us
;

76 
	gi
 = 0; i < 
	gnumb”_th»ads
 - 1; ++i) {

77 
	g’Œy_th»ads
[
i
].
još
();

79 ià(
	g’şave_ouut
.
G‘Ex‹nsiÚ
(
numb”_’Œ›s
è!ğ
numb”_th»ads
) {

80  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

83  
	gStus
::
OkStus
();

88 
TEST_F
(
EnşaveEÁryCouÁTe¡
, 
SšgËTh»ad
) {

89 
cÚ¡ex´
 
	gnumb”_th»ads
 = 1;

90 
EXPECT_THAT
(
RunEnşaveEÁryCouÁTe¡
(
numb”_th»ads
), 
IsOk
());

94 
TEST_F
(
EnşaveEÁryCouÁTe¡
, 
MuÉiTh»ad
) {

95 
cÚ¡ex´
 
	gnumb”_th»ads
 = 8;

96 
EXPECT_THAT
(
RunEnşaveEÁryCouÁTe¡
(
numb”_th»ads
), 
IsOk
());

	@test/misc/enclave_entry_count_test_enclave.cc

19 
	~<uni¡d.h
>

21 
	~<©omic
>

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

26 
	~"asylo/‹¡/misc/’şave_’Œy_couÁ_‹¡.pb.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

32 
cÚ¡ex´
 
	gkTimeout
 = 5;

35 
	gab¦
::
Mu‹x
 
mu
;

37 
boŞ
 
	gcouÁ_fšished
 = 
çl£
;

38 vŞ©
	g¡d
::
©omic
<> 
aùive_’Œ›s
(0);

40 şas 
	cEnşaveEÁryCouÁTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

41 
public
:

42 
EnşaveEÁryCouÁTe¡
() = ;

44 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

45 ià(!
	gšput
.
HasEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

49 
EnşaveEÁryCouÁTe¡IÅut
 
	g‹¡_šput
 =

50 
šput
.
G‘Ex‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
);

51 ià(!
	g‹¡_šput
.
has_th»ad_ty³
()) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

56 ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
EnşaveEÁryCouÁTe¡IÅut
::
DONOTHING
) {

57  
Stus
::
OkStus
();

60 
	gaùive_’Œ›s
++;

61 ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
EnşaveEÁryCouÁTe¡IÅut
::
WAIT
) {

64 
ab¦
::
Mu‹xLock
 
lock
(&
mu
);

65 ià(!
	gmu
.
Awa™W™hTimeout
(
ab¦
::
CÚd™iÚ
(&
couÁ_fšished
),

66 
ab¦
::
SecÚds
(
kTimeout
))) {

67  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

71 } ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
EnşaveEÁryCouÁTe¡IÅut
::
COUNT
) {

72 ià(!
‹¡_šput
.
has_ex³ùed_’Œ›s
()) {

73  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

78 
	gab¦
::
Mu‹xLock
 
lock
(&
mu
);

79 ià(!
	gmu
.
Awa™W™hTimeout
(
ab¦
::
CÚd™iÚ
(

80 +[](
EnşaveEÁryCouÁTe¡IÅut
 *
šput
) {

81  
aùive_’Œ›s
 ==

82 
šput
->
ex³ùed_’Œ›s
();

84 &
‹¡_šput
),

85 
ab¦
::
SecÚds
(
kTimeout
))) {

86  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

91 
	gouut
->
S‘Ex‹nsiÚ
(
numb”_’Œ›s
, 
g‘_aùive_’şave_’Œ›s
());

92 
	gcouÁ_fšished
 = 
Œue
;

94  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

97  
	gStus
::
OkStus
();

101 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

102  
Ãw
 
EnşaveEÁryCouÁTe¡
;

103 
	}
}

	@test/misc/enclave_entry_count_test_enclave.cc

19 
	~<uni¡d.h
>

21 
	~<©omic
>

23 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

24 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

25 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

26 
	~"asylo/‹¡/misc/’şave_’Œy_couÁ_‹¡.pb.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

32 
cÚ¡ex´
 
	gkTimeout
 = 5;

35 
	gab¦
::
Mu‹x
 
mu
;

37 
boŞ
 
	gcouÁ_fšished
 = 
çl£
;

38 vŞ©
	g¡d
::
©omic
<> 
aùive_’Œ›s
(0);

40 şas 
	cEnşaveEÁryCouÁTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

41 
public
:

42 
EnşaveEÁryCouÁTe¡
() = ;

44 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

45 ià(!
	gšput
.
HasEx‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
)) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

49 
EnşaveEÁryCouÁTe¡IÅut
 
	g‹¡_šput
 =

50 
šput
.
G‘Ex‹nsiÚ
(
’şave_’Œy_couÁ_‹¡_šput
);

51 ià(!
	g‹¡_šput
.
has_th»ad_ty³
()) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

56 ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
EnşaveEÁryCouÁTe¡IÅut
::
DONOTHING
) {

57  
Stus
::
OkStus
();

60 
	gaùive_’Œ›s
++;

61 ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
EnşaveEÁryCouÁTe¡IÅut
::
WAIT
) {

64 
ab¦
::
Mu‹xLock
 
lock
(&
mu
);

65 ià(!
	gmu
.
Awa™W™hTimeout
(
ab¦
::
CÚd™iÚ
(&
couÁ_fšished
),

66 
ab¦
::
SecÚds
(
kTimeout
))) {

67  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

71 } ià(
	g‹¡_šput
.
th»ad_ty³
(è=ğ
EnşaveEÁryCouÁTe¡IÅut
::
COUNT
) {

72 ià(!
‹¡_šput
.
has_ex³ùed_’Œ›s
()) {

73  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

78 
	gab¦
::
Mu‹xLock
 
lock
(&
mu
);

79 ià(!
	gmu
.
Awa™W™hTimeout
(
ab¦
::
CÚd™iÚ
(

80 +[](
EnşaveEÁryCouÁTe¡IÅut
 *
šput
) {

81  
aùive_’Œ›s
 ==

82 
šput
->
ex³ùed_’Œ›s
();

84 &
‹¡_šput
),

85 
ab¦
::
SecÚds
(
kTimeout
))) {

86  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

91 
	gouut
->
S‘Ex‹nsiÚ
(
numb”_’Œ›s
, 
g‘_aùive_’şave_’Œ›s
());

92 
	gcouÁ_fšished
 = 
Œue
;

94  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

97  
	gStus
::
OkStus
();

101 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

102  
Ãw
 
EnşaveEÁryCouÁTe¡
;

103 
	}
}

	@test/misc/error_propagation_enclave.cc

19 
	~"asylo/ut/loggšg.h
"

20 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

21 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

22 
	~"asylo/ut/¡©us.h
"

24 
Çme¥aû
 
	gasylo
 {

26 
cÚ¡ex´
 
	gkE¼ÜSŒšg
[] = "Secretƒrror message";

29 şas 
	cE¼ÜPrİag©iÚEnşave
 : 
public
 
EnşaveTe¡Ca£
 {

30 
public
:

31 
E¼ÜPrİag©iÚEnşave
() = ;

33 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
	gfš®
 {

34  
	gStus
::
OkStus
();

37 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gfš®
 {

38 
	g¡d
::
¡ršg
 
‹¡_Çme
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

40 ià(
	g‹¡_Çme
 == "OK") {

41  
Stus
::
OkStus
();

42 } ià(
	g‹¡_Çme
 == "error::GoogleError::UNAUTHENTICATED") {

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNAUTHENTICATED
, 
kE¼ÜSŒšg
);

44 } ià(
	g‹¡_Çme
 == "error::PosixError::P_EINVAL") {

45  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜSŒšg
);

48 
LOG
(
ERROR
è<< "UÃx³ùede¡‚ame: '" << 
	g‹¡_Çme
 << "'";

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unknownest");

52 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
è
	gfš®
 {

53  
	gStus
::
OkStus
();

57 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

58  
Ãw
 
	`E¼ÜPrİag©iÚEnşave
();

59 
	}
}

	@test/misc/error_propagation_enclave.cc

19 
	~"asylo/ut/loggšg.h
"

20 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

21 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

22 
	~"asylo/ut/¡©us.h
"

24 
Çme¥aû
 
	gasylo
 {

26 
cÚ¡ex´
 
	gkE¼ÜSŒšg
[] = "Secretƒrror message";

29 şas 
	cE¼ÜPrİag©iÚEnşave
 : 
public
 
EnşaveTe¡Ca£
 {

30 
public
:

31 
E¼ÜPrİag©iÚEnşave
() = ;

33 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è
	gfš®
 {

34  
	gStus
::
OkStus
();

37 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
è
	gfš®
 {

38 
	g¡d
::
¡ršg
 
‹¡_Çme
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

40 ià(
	g‹¡_Çme
 == "OK") {

41  
Stus
::
OkStus
();

42 } ià(
	g‹¡_Çme
 == "error::GoogleError::UNAUTHENTICATED") {

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNAUTHENTICATED
, 
kE¼ÜSŒšg
);

44 } ià(
	g‹¡_Çme
 == "error::PosixError::P_EINVAL") {

45  
Stus
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜSŒšg
);

48 
LOG
(
ERROR
è<< "UÃx³ùede¡‚ame: '" << 
	g‹¡_Çme
 << "'";

49  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unknownest");

52 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
è
	gfš®
 {

53  
	gStus
::
OkStus
();

57 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

58  
Ãw
 
	`E¼ÜPrİag©iÚEnşave
();

59 
	}
}

	@test/misc/error_propagation_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

22 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

23 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkE¼ÜSŒšg
[] = "Secretƒrror message";

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

34 şas 
	cE¼ÜPrİag©iÚTe¡
 : 
public
 
EnşaveTe¡
 {

35 
´Ùeùed
:

36 
S‘Up
(è
ov”ride
 { 
S‘UpBa£
(); }

40 
TEST_F
(
E¼ÜPrİag©iÚTe¡
, 
NoE¼Ü
) {

41 
EnşaveIÅut
 
	g’şave_šput
;

42 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, "OK");

44 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

45 
EXPECT_THAT
(
¡©us
, 
IsOk
());

50 
TEST_F
(
E¼ÜPrİag©iÚTe¡
, 
E¼ÜCªÚiÿl
) {

51 
EnşaveIÅut
 
	g’şave_šput
;

52 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
,

55 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

56 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

57 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAUTHENTICATED
));

58 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
kE¼ÜSŒšg
);

63 
TEST_F
(
E¼ÜPrİag©iÚTe¡
, 
E¼ÜNÚCªÚiÿl
) {

64 
EnşaveIÅut
 
	g’şave_šput
;

65 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, "error::PosixError::P_EINVAL");

67 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

68 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

69 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
));

70 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
kE¼ÜSŒšg
);

	@test/misc/error_propagation_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

22 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

23 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
cÚ¡ex´
 
	gkE¼ÜSŒšg
[] = "Secretƒrror message";

31 
	gusšg
 ::
‹¡šg
::
NÙ
;

34 şas 
	cE¼ÜPrİag©iÚTe¡
 : 
public
 
EnşaveTe¡
 {

35 
´Ùeùed
:

36 
S‘Up
(è
ov”ride
 { 
S‘UpBa£
(); }

40 
TEST_F
(
E¼ÜPrİag©iÚTe¡
, 
NoE¼Ü
) {

41 
EnşaveIÅut
 
	g’şave_šput
;

42 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, "OK");

44 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

45 
EXPECT_THAT
(
¡©us
, 
IsOk
());

50 
TEST_F
(
E¼ÜPrİag©iÚTe¡
, 
E¼ÜCªÚiÿl
) {

51 
EnşaveIÅut
 
	g’şave_šput
;

52 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
,

55 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

56 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

57 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNAUTHENTICATED
));

58 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
kE¼ÜSŒšg
);

63 
TEST_F
(
E¼ÜPrİag©iÚTe¡
, 
E¼ÜNÚCªÚiÿl
) {

64 
EnşaveIÅut
 
	g’şave_šput
;

65 
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, "error::PosixError::P_EINVAL");

67 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

68 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

69 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
));

70 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
kE¼ÜSŒšg
);

	@test/misc/exception.cc

19 
	~"asylo/‹¡/misc/exû±iÚ.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gTe¡Exû±iÚ
::
Te¡Exû±iÚ
(
code
, cÚ¡ 
¡d
::
¡ršg
 &
mes§ge
)

24 : 
code_
(
code
), 
mes§ge_
(
mes§ge
) {}

26 
	gTe¡Exû±iÚ
::
Te¡Exû±iÚ
(cÚ¡ Te¡Exû±iÚ &
Ùh”
)

27 : 
code_
(
Ùh”
.code_), 
mes§ge_
(other.message_) {}

29 
	gTe¡Exû±iÚ
 &Te¡Exû±iÚ::
İ”©Ü
=(cÚ¡ 
Te¡Exû±iÚ
 &
Ùh”
) {

30 
code_
 = 
Ùh”
.code_;

31 
	gmes§ge_
 = 
Ùh”
.
mes§ge_
;

32  *
	gthis
;

	@test/misc/exception.cc

19 
	~"asylo/‹¡/misc/exû±iÚ.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gTe¡Exû±iÚ
::
Te¡Exû±iÚ
(
code
, cÚ¡ 
¡d
::
¡ršg
 &
mes§ge
)

24 : 
code_
(
code
), 
mes§ge_
(
mes§ge
) {}

26 
	gTe¡Exû±iÚ
::
Te¡Exû±iÚ
(cÚ¡ Te¡Exû±iÚ &
Ùh”
)

27 : 
code_
(
Ùh”
.code_), 
mes§ge_
(other.message_) {}

29 
	gTe¡Exû±iÚ
 &Te¡Exû±iÚ::
İ”©Ü
=(cÚ¡ 
Te¡Exû±iÚ
 &
Ùh”
) {

30 
code_
 = 
Ùh”
.code_;

31 
	gmes§ge_
 = 
Ùh”
.
mes§ge_
;

32  *
	gthis
;

	@test/misc/exception.h

19 #iâdeà
ASYLO_TEST_MISC_EXCEPTION_H_


20 
	#ASYLO_TEST_MISC_EXCEPTION_H_


	)

22 
	~<¡ršg
>

24 
Çme¥aû
 
	gasylo
 {

27 şas 
	cTe¡Exû±iÚ
 {

28 
	gpublic
:

29 
Te¡Exû±iÚ
(
code
, cÚ¡ 
¡d
::
¡ršg
 &
mes§ge
);

30 
Te¡Exû±iÚ
(cÚ¡ Te¡Exû±iÚ &
Ùh”
);

31 
	gTe¡Exû±iÚ
 &
	gİ”©Ü
=(cÚ¡ 
Te¡Exû±iÚ
 &
Ùh”
);

33 
Code
(ècÚ¡ {  
	gcode_
; }

35 
	g´Ùeùed
:

36 
code_
;

37 
	g¡d
::
¡ršg
 
mes§ge_
;

	@test/misc/exception_app.cc

19 
	~<c¡dlib
>

20 
	~<io¡»am
>

21 
	~<¡ršg
>

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡_Ïunch”.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 şas 
	cExû±iÚTe¡
 {

30 
	gpublic
:

31 
Exû±iÚTe¡
(è: 
ş›Á_
(
nuÎ±r
) {}

33 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

34 ::
asylo
::
Stus
 
¡©us
 = 
‹¡_Ïunch”_
.
S‘Up
(
’şave_·th
, {}, "");

35 ià(!
	g¡©us
.
ok
()) {

36 
	g¡d
::
û¼
 << "S‘u°çed: " << 
¡©us
 << 
¡d
::
’dl
;

37 
ex™
(
EXIT_FAILURE
);

39 
	gş›Á_
 = 
‹¡_Ïunch”_
.
mubË_ş›Á
();

42 ~
Exû±iÚTe¡
() {

43 ià(
	gş›Á_
) {

44 
	g‹¡_Ïunch”_
.
T—rDown
({});

48 
Run
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
, cÚ¡ std::¡ršg &
šput
) {

49 
In™Ÿlize
(
’şave_·th
);

51 
EnşaveIÅut
 
	g’şave_šput
;

52 
	gEnşaveTe¡Launch”
::
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
šput
);

53 ià((
	gšput
 == "caught") !=

54 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
).
ok
()) {

55 
ex™
(2);

59 
	g´Ùeùed
:

60 
EnşaveTe¡Launch”
 
‹¡_Ïunch”_
;

61 
EnşaveCl›Á
 *
	gş›Á_
;

67 
	$maš
(
¬gc
, *
¬gv
[]) {

68 ià(
¬gc
 != 3) {

69 
¡d
::
û¼
 << "Ex³ùed u§ge: " << 
¬gv
[0] << " <enclave-path>\nGiven: ";

70 
i
 = 0; i < 
¬gc
; ++i) {

71 
¡d
::
û¼
 << 
¬gv
[
i
] << std::
’dl
;

73 
	`abÜt
();

76 
asylo
::
Exû±iÚTe¡
 
‹¡
;

78 
‹¡
.
	`Run
(
¬gv
[1],‡rgv[2]);

80 
	}
}

	@test/misc/exception_app.cc

19 
	~<c¡dlib
>

20 
	~<io¡»am
>

21 
	~<¡ršg
>

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/‹¡/ut/’şave_‹¡_Ïunch”.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 şas 
	cExû±iÚTe¡
 {

30 
	gpublic
:

31 
Exû±iÚTe¡
(è: 
ş›Á_
(
nuÎ±r
) {}

33 
In™Ÿlize
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
) {

34 ::
asylo
::
Stus
 
¡©us
 = 
‹¡_Ïunch”_
.
S‘Up
(
’şave_·th
, {}, "");

35 ià(!
	g¡©us
.
ok
()) {

36 
	g¡d
::
û¼
 << "S‘u°çed: " << 
¡©us
 << 
¡d
::
’dl
;

37 
ex™
(
EXIT_FAILURE
);

39 
	gş›Á_
 = 
‹¡_Ïunch”_
.
mubË_ş›Á
();

42 ~
Exû±iÚTe¡
() {

43 ià(
	gş›Á_
) {

44 
	g‹¡_Ïunch”_
.
T—rDown
({});

48 
Run
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
, cÚ¡ std::¡ršg &
šput
) {

49 
In™Ÿlize
(
’şave_·th
);

51 
EnşaveIÅut
 
	g’şave_šput
;

52 
	gEnşaveTe¡Launch”
::
S‘EnşaveIÅutTe¡SŒšg
(&
’şave_šput
, 
šput
);

53 ià((
	gšput
 == "caught") !=

54 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
).
ok
()) {

55 
ex™
(2);

59 
	g´Ùeùed
:

60 
EnşaveTe¡Launch”
 
‹¡_Ïunch”_
;

61 
EnşaveCl›Á
 *
	gş›Á_
;

67 
	$maš
(
¬gc
, *
¬gv
[]) {

68 ià(
¬gc
 != 3) {

69 
¡d
::
û¼
 << "Ex³ùed u§ge: " << 
¬gv
[0] << " <enclave-path>\nGiven: ";

70 
i
 = 0; i < 
¬gc
; ++i) {

71 
¡d
::
û¼
 << 
¬gv
[
i
] << std::
’dl
;

73 
	`abÜt
();

76 
asylo
::
Exû±iÚTe¡
 
‹¡
;

78 
‹¡
.
	`Run
(
¬gv
[1],‡rgv[2]);

80 
	}
}

	@test/misc/exception_enclave.cc

19 
	~<¡ršg
>

21 
	~"ab¦/ba£/©Œibu‹s.h
"

22 
	~"asylo/‹¡/misc/exû±iÚ.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

28 şas 
	cExû±iÚ
 : 
public
 
EnşaveTe¡Ca£
 {

29 
public
:

30 
Exû±iÚ
() = ;

32 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *è
	gov”ride
 {

33 cÚ¡ 
	g¡d
::
¡ršg
 &
‹¡
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

34 ià(
	g‹¡
 == "uncaught") {

35 
Throw
();

36 } ià(
	g‹¡
 == "caught") {

37 
Œy
 {

38 
Throw
();

39 } 
ÿtch
 (
Te¡Exû±iÚ
 &
e
) {

40  (
	ge
.
Code
(è=ğ54è? 
Stus
::
OkStus
()

41 : 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

45  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

50 
	g´Ùeùed
:

51 
ABSL_ATTRIBUTE_NORETURN
 
Throw
(è{ 
throw
 
Te¡Exû±iÚ
(54, "Nope"); }

54 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Exû±iÚ
; 
	}
}

	@test/misc/exception_enclave.cc

19 
	~<¡ršg
>

21 
	~"ab¦/ba£/©Œibu‹s.h
"

22 
	~"asylo/‹¡/misc/exû±iÚ.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

28 şas 
	cExû±iÚ
 : 
public
 
EnşaveTe¡Ca£
 {

29 
public
:

30 
Exû±iÚ
() = ;

32 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *è
	gov”ride
 {

33 cÚ¡ 
	g¡d
::
¡ršg
 &
‹¡
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

34 ià(
	g‹¡
 == "uncaught") {

35 
Throw
();

36 } ià(
	g‹¡
 == "caught") {

37 
Œy
 {

38 
Throw
();

39 } 
ÿtch
 (
Te¡Exû±iÚ
 &
e
) {

40  (
	ge
.
Code
(è=ğ54è? 
Stus
::
OkStus
()

41 : 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

45  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

50 
	g´Ùeùed
:

51 
ABSL_ATTRIBUTE_NORETURN
 
Throw
(è{ 
throw
 
Te¡Exû±iÚ
(54, "Nope"); }

54 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Exû±iÚ
; 
	}
}

	@test/misc/exception_test.cc

19 
	~<sigÇl.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

24 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 şas 
	cExû±iÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

30 
´Ùeùed
:

32 
RunTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, *
¡©us
) {

33 
	gex³rim’l
::
ExecTe¡”
 
‹¡
(

34 {
ex³rim’l
::
ExecTe¡”
::
BudSiblšgP©h
(
FLAGS_’şave_·th
,

36 
FLAGS_’şave_·th
, 
šput
});

37 
ASSERT_TRUE
(
‹¡
.
Run
("", 
¡©us
));

41 
TEST_F
(
Exû±iÚTe¡
, 
Unÿught
) {

42 
	g¡©us
;

43 
ASSERT_NO_FATAL_FAILURE
(
RunTe¡
("unÿught", &
¡©us
));

44 
EXPECT_TRUE
(
WIFSIGNALED
(
¡©us
));

45 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

48 
TEST_F
(
Exû±iÚTe¡
, 
Caught
) {

49 
	g¡©us
;

50 
ASSERT_NO_FATAL_FAILURE
(
RunTe¡
("ÿught", &
¡©us
));

51 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

52 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

	@test/misc/exception_test.cc

19 
	~<sigÇl.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

24 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 şas 
	cExû±iÚTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

30 
´Ùeùed
:

32 
RunTe¡
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, *
¡©us
) {

33 
	gex³rim’l
::
ExecTe¡”
 
‹¡
(

34 {
ex³rim’l
::
ExecTe¡”
::
BudSiblšgP©h
(
FLAGS_’şave_·th
,

36 
FLAGS_’şave_·th
, 
šput
});

37 
ASSERT_TRUE
(
‹¡
.
Run
("", 
¡©us
));

41 
TEST_F
(
Exû±iÚTe¡
, 
Unÿught
) {

42 
	g¡©us
;

43 
ASSERT_NO_FATAL_FAILURE
(
RunTe¡
("unÿught", &
¡©us
));

44 
EXPECT_TRUE
(
WIFSIGNALED
(
¡©us
));

45 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

48 
TEST_F
(
Exû±iÚTe¡
, 
Caught
) {

49 
	g¡©us
;

50 
ASSERT_NO_FATAL_FAILURE
(
RunTe¡
("ÿught", &
¡©us
));

51 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

52 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

	@test/misc/exhaust_sgx_tcs.cc

19 
	~<xmmšŒš.h
>

21 
	~<c¡dio
>

22 
	~<memÜy
>

23 
	~<th»ad
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 vŞ©
	gcc11_wa™_couÁ
 = 0;

34 
	gab¦
::
Mu‹x
 
cc11_mu‹x
;

38 
cÚ¡ex´
 
	g¡İ_Ú_couÁ
 = 3;

40 
cc11_šüem’t_couÁ_ªd_wa™
() {

42 
	gab¦
::
Mu‹xLock
 
lock
(&
cc11_mu‹x
);

43 ++
	gcc11_wa™_couÁ
;

45 
	gcc11_wa™_couÁ
 < 
	g¡İ_Ú_couÁ
) {

46 
_mm_·u£
();

50 şas 
	cExhau¡TcsEnşave
 : 
public
 
Tru¡edAµliÿtiÚ
 {

51 
public
:

52 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &, 
EnşaveOuut
 *è
	gov”ride
 {

53 
	g¡d
::
veùÜ
<
¡d
::
unique_±r
<¡d::
th»ad
>> 
th»ads
;

54 
	gi
 = 0; i < 
	g¡İ_Ú_couÁ
; ++i) {

55 
	gth»ads
.
push_back
(

56 
ab¦
::
make_unique
<
¡d
::
th»ad
>(
cc11_šüem’t_couÁ_ªd_wa™
));

59 autØ&
	gth»ad
 : 
th»ads
) {

60 
th»ad
->
još
();

62  
	gStus
::
OkStus
();

68 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

69  
Ãw
 
asylo
::
Exhau¡TcsEnşave
;

70 
	}
}

	@test/misc/exhaust_sgx_tcs.cc

19 
	~<xmmšŒš.h
>

21 
	~<c¡dio
>

22 
	~<memÜy
>

23 
	~<th»ad
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 vŞ©
	gcc11_wa™_couÁ
 = 0;

34 
	gab¦
::
Mu‹x
 
cc11_mu‹x
;

38 
cÚ¡ex´
 
	g¡İ_Ú_couÁ
 = 3;

40 
cc11_šüem’t_couÁ_ªd_wa™
() {

42 
	gab¦
::
Mu‹xLock
 
lock
(&
cc11_mu‹x
);

43 ++
	gcc11_wa™_couÁ
;

45 
	gcc11_wa™_couÁ
 < 
	g¡İ_Ú_couÁ
) {

46 
_mm_·u£
();

50 şas 
	cExhau¡TcsEnşave
 : 
public
 
Tru¡edAµliÿtiÚ
 {

51 
public
:

52 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &, 
EnşaveOuut
 *è
	gov”ride
 {

53 
	g¡d
::
veùÜ
<
¡d
::
unique_±r
<¡d::
th»ad
>> 
th»ads
;

54 
	gi
 = 0; i < 
	g¡İ_Ú_couÁ
; ++i) {

55 
	gth»ads
.
push_back
(

56 
ab¦
::
make_unique
<
¡d
::
th»ad
>(
cc11_šüem’t_couÁ_ªd_wa™
));

59 autØ&
	gth»ad
 : 
th»ads
) {

60 
th»ad
->
još
();

62  
	gStus
::
OkStus
();

68 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

69  
Ãw
 
asylo
::
Exhau¡TcsEnşave
;

70 
	}
}

	@test/misc/exhaust_sgx_tcs_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

22 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 şas 
	cExhau¡SgxTcsTe¡
 : 
public
 
EnşaveTe¡
 {};

29 
TEST_F
(
Exhau¡SgxTcsTe¡
, 
StdTh»adResourûExhau¡ed
) {

30 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
({}, 
nuÎ±r
),

31 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
));

	@test/misc/exhaust_sgx_tcs_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

22 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 şas 
	cExhau¡SgxTcsTe¡
 : 
public
 
EnşaveTe¡
 {};

29 
TEST_F
(
Exhau¡SgxTcsTe¡
, 
StdTh»adResourûExhau¡ed
) {

30 
EXPECT_THAT
(
ş›Á_
->
EÁ”AndRun
({}, 
nuÎ±r
),

31 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
));

	@test/misc/fail_finalize_enclave.cc

19 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

21 
Çme¥aû
 
	gasylo
 {

23 şas 
	cFaFš®izeEnşave
 : 
public
 
asylo
::
Tru¡edAµliÿtiÚ
 {

24 
public
:

25 
asylo
::
Stus
 
Fš®ize
(cÚ¡‡sylo::
EnşaveFš®
& 
’şave_fš®
è
ov”ride
 {

27  
asylo
::
Stus
×sylo::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Non-ok status");

31 
Tru¡edAµliÿtiÚ
* 
	$BudTru¡edAµliÿtiÚ
() {

32  
Ãw
 
FaFš®izeEnşave
;

33 
	}
}

	@test/misc/fail_finalize_enclave.cc

19 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

21 
Çme¥aû
 
	gasylo
 {

23 şas 
	cFaFš®izeEnşave
 : 
public
 
asylo
::
Tru¡edAµliÿtiÚ
 {

24 
public
:

25 
asylo
::
Stus
 
Fš®ize
(cÚ¡‡sylo::
EnşaveFš®
& 
’şave_fš®
è
ov”ride
 {

27  
asylo
::
Stus
×sylo::
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Non-ok status");

31 
Tru¡edAµliÿtiÚ
* 
	$BudTru¡edAµliÿtiÚ
() {

32  
Ãw
 
FaFš®izeEnşave
;

33 
	}
}

	@test/misc/fail_finalize_enclave_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/ş›Á.h
"

22 
	~"asylo/’şave_mªag”.h
"

23 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
	gusšg
 ::
‹¡šg
::
NÙ
;

30 
cÚ¡ex´
 
	gkEnşaveName
[] = "enclave";

31 
cÚ¡ex´
 
	gkCl›ÁName
[] = "client";

33 
TEST
(
FaFš®izeEnşaveTe¡
, 
FaFš®ize
) {

34 
ASYLO_ASSERT_OK
(
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
()));

36 
EnşaveMªag”
 *
	gmªag”
;

37 
ASYLO_ASSERT_OK_AND_ASSIGN
(
mªag”
, 
EnşaveMªag”
::
In¡ªû
());

39 
SimEmbeddedLßd”
 
lßd”
(
kEnşaveName
, 
Œue
);

40 
EnşaveCÚfig
 
	gcÚfig
;

41 
ASYLO_ASSERT_OK
(
mªag”
->
LßdEnşave
(
kCl›ÁName
, 
lßd”
, 
cÚfig
));

43 autØ
	gş›Á
 = 
mªag”
->
G‘Cl›Á
(
kCl›ÁName
);

44 
EnşaveFš®
 
	gfš®_´Ùo
;

45 
EXPECT_THAT
(
mªag”
->
De¡royEnşave
(
ş›Á
, 
fš®_´Ùo
), 
NÙ
(
IsOk
()));

	@test/misc/fail_finalize_enclave_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"asylo/ş›Á.h
"

22 
	~"asylo/’şave_mªag”.h
"

23 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
	gusšg
 ::
‹¡šg
::
NÙ
;

30 
cÚ¡ex´
 
	gkEnşaveName
[] = "enclave";

31 
cÚ¡ex´
 
	gkCl›ÁName
[] = "client";

33 
TEST
(
FaFš®izeEnşaveTe¡
, 
FaFš®ize
) {

34 
ASYLO_ASSERT_OK
(
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
()));

36 
EnşaveMªag”
 *
	gmªag”
;

37 
ASYLO_ASSERT_OK_AND_ASSIGN
(
mªag”
, 
EnşaveMªag”
::
In¡ªû
());

39 
SimEmbeddedLßd”
 
lßd”
(
kEnşaveName
, 
Œue
);

40 
EnşaveCÚfig
 
	gcÚfig
;

41 
ASYLO_ASSERT_OK
(
mªag”
->
LßdEnşave
(
kCl›ÁName
, 
lßd”
, 
cÚfig
));

43 autØ
	gş›Á
 = 
mªag”
->
G‘Cl›Á
(
kCl›ÁName
);

44 
EnşaveFš®
 
	gfš®_´Ùo
;

45 
EXPECT_THAT
(
mªag”
->
De¡royEnşave
(
ş›Á
, 
fš®_´Ùo
), 
NÙ
(
IsOk
()));

	@test/misc/hello_world.cc

19 
	~<¡ršg
>

20 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

21 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

23 
Çme¥aû
 
	gasylo
 {

25 şas 
	cH–loWÜld
 : 
public
 
EnşaveTe¡Ca£
 {

26 
public
:

27 
H–loWÜld
() = ;

29 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

30 
	g¡d
::
¡ršg
 
¡r_cÚfig
 = 
G‘EnşaveCÚfigTe¡SŒšg
(
cÚfig
);

31 
’c_uÁru¡ed_puts
(
¡r_cÚfig
.
c_¡r
());

32  
	gStus
::
OkStus
();

35 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

36 
	g¡d
::
¡ršg
 
¡r_šput
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

37 
’c_uÁru¡ed_puts
(
¡r_šput
.
c_¡r
());

38  
	gStus
::
OkStus
();

41 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

42 
	g¡d
::
¡ršg
 
¡r_fš®
 = 
G‘EnşaveFš®Te¡SŒšg
(
fš®_šput
);

43 
’c_uÁru¡ed_puts
(
¡r_fš®
.
c_¡r
());

44  
	gStus
::
OkStus
();

48 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
H–loWÜld
; 
	}
}

	@test/misc/hello_world.cc

19 
	~<¡ršg
>

20 
	~"asylo/¶©fÜm/¬ch/šşude/Œu¡ed/ho¡_ÿÎs.h
"

21 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

23 
Çme¥aû
 
	gasylo
 {

25 şas 
	cH–loWÜld
 : 
public
 
EnşaveTe¡Ca£
 {

26 
public
:

27 
H–loWÜld
() = ;

29 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

30 
	g¡d
::
¡ršg
 
¡r_cÚfig
 = 
G‘EnşaveCÚfigTe¡SŒšg
(
cÚfig
);

31 
’c_uÁru¡ed_puts
(
¡r_cÚfig
.
c_¡r
());

32  
	gStus
::
OkStus
();

35 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

36 
	g¡d
::
¡ršg
 
¡r_šput
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

37 
’c_uÁru¡ed_puts
(
¡r_šput
.
c_¡r
());

38  
	gStus
::
OkStus
();

41 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

42 
	g¡d
::
¡ršg
 
¡r_fš®
 = 
G‘EnşaveFš®Te¡SŒšg
(
fš®_šput
);

43 
’c_uÁru¡ed_puts
(
¡r_fš®
.
c_¡r
());

44  
	gStus
::
OkStus
();

48 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
H–loWÜld
; 
	}
}

	@test/misc/hello_world_test.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

21 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

26 şas 
	cH–loWÜldTe¡
 : 
public
 
EnşaveTe¡
 {};

28 
TEST_F
(
H–loWÜldTe¡
, 
H–loTe¡
) {

29 
ASYLO_EXPECT_OK
(
ş›Á_
->
EÁ”AndRun
({}, 
nuÎ±r
));

	@test/misc/hello_world_test.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

21 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

26 şas 
	cH–loWÜldTe¡
 : 
public
 
EnşaveTe¡
 {};

28 
TEST_F
(
H–loWÜldTe¡
, 
H–loTe¡
) {

29 
ASYLO_EXPECT_OK
(
ş›Á_
->
EÁ”AndRun
({}, 
nuÎ±r
));

	@test/misc/inactive_enclave_signal_test_driver.cc

19 
	~<sigÇl.h
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
	~"asylo/ut/¡©us.h
"

26 
	~"asylo/ut/¡©us_maüos.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cIÇùiveEnşaveSigÇlTe¡
 : 
public
 
EnşaveTe¡
 {

32 
´Ùeùed
:

33 
Stus
 
RunSigÇlTe¡
(cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

34 
EnşaveOuut
 
’şave_ouut
;

37 
ASYLO_RETURN_IF_ERROR
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
));

38 ià(
	g’şave_ouut
.
G‘Ex‹nsiÚ
(
sigÇl_»ûived
)) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

42 
¿i£
(
SIGUSR1
);

45 
ASYLO_RETURN_IF_ERROR
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
));

46 ià(!
	g’şave_ouut
.
G‘Ex‹nsiÚ
(
sigÇl_»ûived
)) {

47  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

50  
	gStus
::
OkStus
();

54 
TEST_F
(
IÇùiveEnşaveSigÇlTe¡
, 
HªdËrTe¡
) {

56 
EnşaveIÅut
 
	g’şave_šput
;

57 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

58 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
HANDLER
);

59 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

62 
TEST_F
(
IÇùiveEnşaveSigÇlTe¡
, 
SigÇlTe¡
) {

64 
EnşaveIÅut
 
	g’şave_šput
;

65 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

66 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGNAL
);

67 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

70 
TEST_F
(
IÇùiveEnşaveSigÇlTe¡
, 
SigaùiÚTe¡
) {

72 
EnşaveIÅut
 
	g’şave_šput
;

73 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

74 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGACTION
);

75 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

	@test/misc/inactive_enclave_signal_test_driver.cc

19 
	~<sigÇl.h
>

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

23 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
	~"asylo/ut/¡©us.h
"

26 
	~"asylo/ut/¡©us_maüos.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
	gÇme¥aû
 {

31 şas 
	cIÇùiveEnşaveSigÇlTe¡
 : 
public
 
EnşaveTe¡
 {

32 
´Ùeùed
:

33 
Stus
 
RunSigÇlTe¡
(cÚ¡ 
EnşaveIÅut
 &
’şave_šput
) {

34 
EnşaveOuut
 
’şave_ouut
;

37 
ASYLO_RETURN_IF_ERROR
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
));

38 ià(
	g’şave_ouut
.
G‘Ex‹nsiÚ
(
sigÇl_»ûived
)) {

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

42 
¿i£
(
SIGUSR1
);

45 
ASYLO_RETURN_IF_ERROR
(
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, &
’şave_ouut
));

46 ià(!
	g’şave_ouut
.
G‘Ex‹nsiÚ
(
sigÇl_»ûived
)) {

47  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

50  
	gStus
::
OkStus
();

54 
TEST_F
(
IÇùiveEnşaveSigÇlTe¡
, 
HªdËrTe¡
) {

56 
EnşaveIÅut
 
	g’şave_šput
;

57 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

58 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
HANDLER
);

59 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

62 
TEST_F
(
IÇùiveEnşaveSigÇlTe¡
, 
SigÇlTe¡
) {

64 
EnşaveIÅut
 
	g’şave_šput
;

65 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

66 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGNAL
);

67 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

70 
TEST_F
(
IÇùiveEnşaveSigÇlTe¡
, 
SigaùiÚTe¡
) {

72 
EnşaveIÅut
 
	g’şave_šput
;

73 
	g’şave_šput
.
MubËEx‹nsiÚ
(
sigÇl_‹¡_šput
)

74 ->
£t_sigÇl_‹¡_ty³
(
SigÇlTe¡IÅut
::
SIGACTION
);

75 
EXPECT_THAT
(
RunSigÇlTe¡
(
’şave_šput
), 
IsOk
());

	@test/misc/inactive_enclave_signal_test_enclave.cc

19 
	~<sigÇl.h
>

21 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

22 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
boŞ
 
	gsigÇl_hªdËd
 = 
çl£
;

29 
HªdËSigÇlW™hHªdËr
(
signum
) {

30 ià(
	gsignum
 =ğ
SIGUSR1
) {

31 
sigÇl_hªdËd
 = 
Œue
;

35 
HªdËSigÇlW™hSigAùiÚ
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

36 ià(
	gsignum
 =ğ
SIGUSR1
) {

37 
sigÇl_hªdËd
 = 
Œue
;

41 şas 
	cIÇùiveEnşaveSigÇlTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

42 
public
:

43 
IÇùiveEnşaveSigÇlTe¡
() = ;

45 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

46 ià(!
	gšput
.
HasEx‹nsiÚ
(
sigÇl_‹¡_šput
)) {

47  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

50 
SigÇlTe¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sigÇl_‹¡_šput
);

51 ià(!
	g‹¡_šput
.
has_sigÇl_‹¡_ty³
()) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

55 
sigaùiÚ
 
	gaù
;

56 
	g‹¡_šput
.
sigÇl_‹¡_ty³
()) {

57 
	gSigÇlTe¡IÅut
::
HANDLER
:

58 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

60 
	gSigÇlTe¡IÅut
::
SIGACTION
:

61 
aù
.
§_sigaùiÚ
 = &
HªdËSigÇlW™hSigAùiÚ
;

62 
	gaù
.
	g§_æags
 |ğ
SA_SIGINFO
;

64 
	gSigÇlTe¡IÅut
::
SIGNAL
:

65 
sigÇl
(
SIGUSR1
, &
HªdËSigÇlW™hHªdËr
);

68  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

71 ià(
	g‹¡_šput
.
sigÇl_‹¡_ty³
(è!ğ
SigÇlTe¡IÅut
::
SIGNAL
) {

72 
sigaùiÚ
 
Şdaù
;

73 
sigaùiÚ
(
SIGUSR1
, &
aù
, &
Şdaù
);

75 
	gouut
->
S‘Ex‹nsiÚ
(
sigÇl_»ûived
, 
sigÇl_hªdËd
);

76  
	gStus
::
OkStus
();

80 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

81  
Ãw
 
IÇùiveEnşaveSigÇlTe¡
;

82 
	}
}

	@test/misc/inactive_enclave_signal_test_enclave.cc

19 
	~<sigÇl.h
>

21 
	~"asylo/‹¡/misc/sigÇl_‹¡.pb.h
"

22 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

23 
	~"asylo/ut/¡©us.h
"

25 
Çme¥aû
 
	gasylo
 {

27 
boŞ
 
	gsigÇl_hªdËd
 = 
çl£
;

29 
HªdËSigÇlW™hHªdËr
(
signum
) {

30 ià(
	gsignum
 =ğ
SIGUSR1
) {

31 
sigÇl_hªdËd
 = 
Œue
;

35 
HªdËSigÇlW™hSigAùiÚ
(
signum
, 
sigšfo_t
 *
šfo
, *
ucÚ‹xt
) {

36 ià(
	gsignum
 =ğ
SIGUSR1
) {

37 
sigÇl_hªdËd
 = 
Œue
;

41 şas 
	cIÇùiveEnşaveSigÇlTe¡
 : 
public
 
EnşaveTe¡Ca£
 {

42 
public
:

43 
IÇùiveEnşaveSigÇlTe¡
() = ;

45 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

46 ià(!
	gšput
.
HasEx‹nsiÚ
(
sigÇl_‹¡_šput
)) {

47  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

50 
SigÇlTe¡IÅut
 
	g‹¡_šput
 = 
šput
.
G‘Ex‹nsiÚ
(
sigÇl_‹¡_šput
);

51 ià(!
	g‹¡_šput
.
has_sigÇl_‹¡_ty³
()) {

52  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

55 
sigaùiÚ
 
	gaù
;

56 
	g‹¡_šput
.
sigÇl_‹¡_ty³
()) {

57 
	gSigÇlTe¡IÅut
::
HANDLER
:

58 
aù
.
§_hªdËr
 = &
HªdËSigÇlW™hHªdËr
;

60 
	gSigÇlTe¡IÅut
::
SIGACTION
:

61 
aù
.
§_sigaùiÚ
 = &
HªdËSigÇlW™hSigAùiÚ
;

62 
	gaù
.
	g§_æags
 |ğ
SA_SIGINFO
;

64 
	gSigÇlTe¡IÅut
::
SIGNAL
:

65 
sigÇl
(
SIGUSR1
, &
HªdËSigÇlW™hHªdËr
);

68  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

71 ià(
	g‹¡_šput
.
sigÇl_‹¡_ty³
(è!ğ
SigÇlTe¡IÅut
::
SIGNAL
) {

72 
sigaùiÚ
 
Şdaù
;

73 
sigaùiÚ
(
SIGUSR1
, &
aù
, &
Şdaù
);

75 
	gouut
->
S‘Ex‹nsiÚ
(
sigÇl_»ûived
, 
sigÇl_hªdËd
);

76  
	gStus
::
OkStus
();

80 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
() {

81  
Ãw
 
IÇùiveEnşaveSigÇlTe¡
;

82 
	}
}

	@test/misc/initfini.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

22 
	$¡¬t
(è
	`__©Œibu‹__
((
cÚ¡ruùÜ
));

23 
	$¡İ
(è
	`__©Œibu‹__
((
de¡ruùÜ
));

25 
	$¡¬t
(è{ ; 
	}
}

27 
	$¡İ
(è{ ; 
	}
}

29 
Çme¥aû
 
	gasylo
 {

31 şas 
	cIn™fši
 : 
public
 
EnşaveTe¡Ca£
 {

32 
public
:

33 
In™fši
() = ;

35 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è{  
	gStus
::
OkStus
(); }

37 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

38  
	gStus
::
OkStus
();

41 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

42  
	gStus
::
OkStus
();

46 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
In™fši
; 
	}
}

	@test/misc/initfini.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

22 
	$¡¬t
(è
	`__©Œibu‹__
((
cÚ¡ruùÜ
));

23 
	$¡İ
(è
	`__©Œibu‹__
((
de¡ruùÜ
));

25 
	$¡¬t
(è{ ; 
	}
}

27 
	$¡İ
(è{ ; 
	}
}

29 
Çme¥aû
 
	gasylo
 {

31 şas 
	cIn™fši
 : 
public
 
EnşaveTe¡Ca£
 {

32 
public
:

33 
In™fši
() = ;

35 
Stus
 
In™Ÿlize
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
è{  
	gStus
::
OkStus
(); }

37 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

38  
	gStus
::
OkStus
();

41 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

42  
	gStus
::
OkStus
();

46 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
In™fši
; 
	}
}

	@test/misc/logging_test_driver.cc

19 
	~<fú.h
>

20 
	~<libg’.h
>

22 
	~<c¡dlib
>

23 
	~<funùiÚ®
>

24 
	~<¡ršg
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

30 
	~"asylo/‹¡/ut/‹¡_æags.h
"

32 
usšg
 
	g‹¡šg
::
HasSub¡r
;

33 
usšg
 
	g‹¡šg
::
NÙ
;

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

38 şas 
	cEnşaveLoggšgTe¡
 : 
public
 
EnşaveTe¡
 {

39 
public
:

40 
usšg
 
check”_t
 = 
¡d
::
funùiÚ
<(const *)>;

42 
W™hLogCÚ‹Ás
(cÚ¡ 
check”_t
 &
check”
) {

43 
W™hLogCÚ‹ÁsFrom
(
FLAGS_‹¡_tmpdœ
, 
’şave_u¾_
, 
check”
);

46 
W™hLogCÚ‹ÁsFrom
(cÚ¡ 
¡d
::
¡ršg
 &
log_dœeùÜy
,

47 cÚ¡ 
¡d
::
¡ršg
 &
’şave_u¾
,

48 cÚ¡ 
check”_t
 &
check”
) {

49 
	g¡d
::
¡ršg
 
log_f’ame
 = "enclave_log";

50 ià(!
	g’şave_u¾
.
em±y
()) {

51 
	sF»eD–‘”
 {

52 
İ”©Ü
()(*
	g±r
è{ 
ä“
(
±r
); }

54 
	g¡d
::
unique_±r
<, 
	gF»eD–‘”
> 
u¾
(
¡rdup
(
’şave_u¾
.
c_¡r
()));

55 
	glog_f’ame
 = 
ba£Çme
(
u¾
.
g‘
());

57 cÚ¡ 
	g¡d
::
¡ršg
 
log_fe_·th
 = 
log_dœeùÜy
 + "/" + 
log_f’ame
;

58 
FILE
 *
	gfe
 = 
fİ’
(
log_fe_·th
.
c_¡r
(), "rb");

59 ià(!
	gfe
) {

60 
	g¡d
::
û¼
 << "NØlog f" << 
log_fe_·th
 << 
¡d
::
’dl
;

63 
check”
("");

66 cÚ¡ 
	gbufãr_size
 = 4096;

67 autØ
	gbufãr
 = 
ab¦
::
make_unique
<[]>(
bufãr_size
);

68 
	gby‹s_»ad
 = 
ä—d
(
bufãr
.
g‘
(), (), 
bufãr_size
, 
fe
);

69 ià(
	gby‹s_»ad
 < 0) {

70 
fşo£
(
fe
);

71 
uÆšk
(
log_fe_·th
.
c_¡r
());

73 
ASSERT_GE
(
by‹s_»ad
, 0);

75 
check”
(
bufãr
.
g‘
());

76 
fşo£
(
fe
);

77 
uÆšk
(
log_fe_·th
.
c_¡r
());

82 
TEST_F
(
EnşaveLoggšgTe¡
, 
R—dWr™eTe¡
) {

83 
EnşaveIÅut
 
	g’şave_šput
;

84 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

85 
EXPECT_TRUE
(
¡©us
.
ok
());

86 
W™hLogCÚ‹Ás
([&] (cÚ¡ *
buf
) {

87 
EXPECT_THAT
(
buf
, 
HasSub¡r
("INFO†ogging_test_enclave.cc"));

88 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Testƒmpty string"));

89 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging c"));

90 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging NULL"));

91 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging string"));

92 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging char‡rray"));

93 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging const char‡rray"));

94 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging int max 2147483647"));

95 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging int min -2147483648"));

96 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging†ong†ong max "

98 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging†ong†ong min "

100 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging float max 3.40282e+38"));

101 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging float min 1.17549e-38"));

102 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging double max 1.79769e+308"));

103 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging double min 2.22507e-308"));

104 
EXPECT_THAT
(
buf
, 
HasSub¡r
("WARNING†ogging_test_enclave.cc"));

105 
EXPECT_THAT
(
buf
, 
HasSub¡r
("ERROR†ogging_test_enclave.cc"));

106 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Testrue conditional†ogging"));

107 
EXPECT_THAT
(
buf
, 
NÙ
(
HasSub¡r
("Test false conditional†ogging")));

108 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test VLOG below†evel"));

109 
EXPECT_THAT
(
buf
, 
NÙ
(
HasSub¡r
("Test VLOG‡bove†evel")));

	@test/misc/logging_test_driver.cc

19 
	~<fú.h
>

20 
	~<libg’.h
>

22 
	~<c¡dlib
>

23 
	~<funùiÚ®
>

24 
	~<¡ršg
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

30 
	~"asylo/‹¡/ut/‹¡_æags.h
"

32 
usšg
 
	g‹¡šg
::
HasSub¡r
;

33 
usšg
 
	g‹¡šg
::
NÙ
;

35 
Çme¥aû
 
	gasylo
 {

36 
	gÇme¥aû
 {

38 şas 
	cEnşaveLoggšgTe¡
 : 
public
 
EnşaveTe¡
 {

39 
public
:

40 
usšg
 
check”_t
 = 
¡d
::
funùiÚ
<(const *)>;

42 
W™hLogCÚ‹Ás
(cÚ¡ 
check”_t
 &
check”
) {

43 
W™hLogCÚ‹ÁsFrom
(
FLAGS_‹¡_tmpdœ
, 
’şave_u¾_
, 
check”
);

46 
W™hLogCÚ‹ÁsFrom
(cÚ¡ 
¡d
::
¡ršg
 &
log_dœeùÜy
,

47 cÚ¡ 
¡d
::
¡ršg
 &
’şave_u¾
,

48 cÚ¡ 
check”_t
 &
check”
) {

49 
	g¡d
::
¡ršg
 
log_f’ame
 = "enclave_log";

50 ià(!
	g’şave_u¾
.
em±y
()) {

51 
	sF»eD–‘”
 {

52 
İ”©Ü
()(*
	g±r
è{ 
ä“
(
±r
); }

54 
	g¡d
::
unique_±r
<, 
	gF»eD–‘”
> 
u¾
(
¡rdup
(
’şave_u¾
.
c_¡r
()));

55 
	glog_f’ame
 = 
ba£Çme
(
u¾
.
g‘
());

57 cÚ¡ 
	g¡d
::
¡ršg
 
log_fe_·th
 = 
log_dœeùÜy
 + "/" + 
log_f’ame
;

58 
FILE
 *
	gfe
 = 
fİ’
(
log_fe_·th
.
c_¡r
(), "rb");

59 ià(!
	gfe
) {

60 
	g¡d
::
û¼
 << "NØlog f" << 
log_fe_·th
 << 
¡d
::
’dl
;

63 
check”
("");

66 cÚ¡ 
	gbufãr_size
 = 4096;

67 autØ
	gbufãr
 = 
ab¦
::
make_unique
<[]>(
bufãr_size
);

68 
	gby‹s_»ad
 = 
ä—d
(
bufãr
.
g‘
(), (), 
bufãr_size
, 
fe
);

69 ià(
	gby‹s_»ad
 < 0) {

70 
fşo£
(
fe
);

71 
uÆšk
(
log_fe_·th
.
c_¡r
());

73 
ASSERT_GE
(
by‹s_»ad
, 0);

75 
check”
(
bufãr
.
g‘
());

76 
fşo£
(
fe
);

77 
uÆšk
(
log_fe_·th
.
c_¡r
());

82 
TEST_F
(
EnşaveLoggšgTe¡
, 
R—dWr™eTe¡
) {

83 
EnşaveIÅut
 
	g’şave_šput
;

84 
Stus
 
	g¡©us
 = 
ş›Á_
->
EÁ”AndRun
(
’şave_šput
, 
nuÎ±r
);

85 
EXPECT_TRUE
(
¡©us
.
ok
());

86 
W™hLogCÚ‹Ás
([&] (cÚ¡ *
buf
) {

87 
EXPECT_THAT
(
buf
, 
HasSub¡r
("INFO†ogging_test_enclave.cc"));

88 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Testƒmpty string"));

89 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging c"));

90 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging NULL"));

91 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging string"));

92 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging char‡rray"));

93 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging const char‡rray"));

94 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging int max 2147483647"));

95 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging int min -2147483648"));

96 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging†ong†ong max "

98 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging†ong†ong min "

100 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging float max 3.40282e+38"));

101 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging float min 1.17549e-38"));

102 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging double max 1.79769e+308"));

103 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test†ogging double min 2.22507e-308"));

104 
EXPECT_THAT
(
buf
, 
HasSub¡r
("WARNING†ogging_test_enclave.cc"));

105 
EXPECT_THAT
(
buf
, 
HasSub¡r
("ERROR†ogging_test_enclave.cc"));

106 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Testrue conditional†ogging"));

107 
EXPECT_THAT
(
buf
, 
NÙ
(
HasSub¡r
("Test false conditional†ogging")));

108 
EXPECT_THAT
(
buf
, 
HasSub¡r
("Test VLOG below†evel"));

109 
EXPECT_THAT
(
buf
, 
NÙ
(
HasSub¡r
("Test VLOG‡bove†evel")));

	@test/misc/logging_test_enclave.cc

19 
	~<¡ršg.h
>

20 
	~<cæßt
>

21 
	~<şim™s
>

22 
	~<¡ršg
>

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cLoggšg
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Loggšg
() = ;

34 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

35 
	g¡d
::
¡ršg
 
which
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

36 
	g¡d
::
¡ršg
 
em±y_¡ršg
 = "";

37 
LOG
(
INFO
è<< "Te¡ƒm±y sŒšg" << 
	gem±y_¡ršg
;

38 
	g‹¡_ch¬
 = 'c';

39 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_ch¬
;

40 *
	g‹¡_nuÎ
 = 
nuÎ±r
;

41 
LOG
(
INFO
è<< "Te¡†oggšg NULL" << 
	g‹¡_nuÎ
;

42 
	g¡d
::
¡ršg
 
‹¡_¡ršg
 = "string";

43 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_¡ršg
;

44 
	g‹¡_ch¬_¬¿y
[] = "char‡rray";

45 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_ch¬_¬¿y
;

46 cÚ¡ 
	g‹¡_cÚ¡_ch¬_¬¿y
[] = "const char‡rray";

47 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_cÚ¡_ch¬_¬¿y
;

48 
LOG
(
INFO
è<< "Te¡†oggšg iÁ max " << 
	gINT_MAX
;

49 
LOG
(
INFO
è<< "Te¡†oggšg iÁ mš " << 
	gINT_MIN
;

50 
LOG
(
INFO
è<< "Te¡†oggšg†Úg†Úg max " << 
	gLLONG_MAX
;

51 
LOG
(
INFO
è<< "Te¡†oggšg†Úg†Úg mš " << 
	gLLONG_MIN
;

52 
LOG
(
INFO
è<< "Te¡†oggšg flßˆmax " << 
	gFLT_MAX
;

53 
LOG
(
INFO
è<< "Te¡†oggšg flßˆmš " << 
	gFLT_MIN
;

54 
LOG
(
INFO
è<< "Te¡†oggšg doubË max " << 
	gDBL_MAX
;

55 
LOG
(
INFO
è<< "Te¡†oggšg doubË mš " << 
	gDBL_MIN
;

56 
LOG
(
WARNING
) << "Test†ogging WARNING";

57 
LOG
(
ERROR
) << "Test†ogging ERROR";

58 
LOG_IF
(
INFO
, 
Œue
) << "Testrue conditional†ogging";

59 
LOG_IF
(
INFO
, 
çl£
) << "Test false conditional†ogging";

60 
VLOG
(0) << "Test VLOG below†evel";

61 
VLOG
(1) << "Test VLOG‡bove†evel";

62  
	gStus
::
OkStus
();

66 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Loggšg
; 
	}
}

	@test/misc/logging_test_enclave.cc

19 
	~<¡ršg.h
>

20 
	~<cæßt
>

21 
	~<şim™s
>

22 
	~<¡ršg
>

24 
	~"asylo/ut/loggšg.h
"

25 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

30 şas 
	cLoggšg
 : 
public
 
EnşaveTe¡Ca£
 {

31 
public
:

32 
Loggšg
() = ;

34 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
) {

35 
	g¡d
::
¡ršg
 
which
 = 
G‘EnşaveIÅutTe¡SŒšg
(
šput
);

36 
	g¡d
::
¡ršg
 
em±y_¡ršg
 = "";

37 
LOG
(
INFO
è<< "Te¡ƒm±y sŒšg" << 
	gem±y_¡ršg
;

38 
	g‹¡_ch¬
 = 'c';

39 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_ch¬
;

40 *
	g‹¡_nuÎ
 = 
nuÎ±r
;

41 
LOG
(
INFO
è<< "Te¡†oggšg NULL" << 
	g‹¡_nuÎ
;

42 
	g¡d
::
¡ršg
 
‹¡_¡ršg
 = "string";

43 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_¡ršg
;

44 
	g‹¡_ch¬_¬¿y
[] = "char‡rray";

45 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_ch¬_¬¿y
;

46 cÚ¡ 
	g‹¡_cÚ¡_ch¬_¬¿y
[] = "const char‡rray";

47 
LOG
(
INFO
è<< "Te¡†oggšg " << 
	g‹¡_cÚ¡_ch¬_¬¿y
;

48 
LOG
(
INFO
è<< "Te¡†oggšg iÁ max " << 
	gINT_MAX
;

49 
LOG
(
INFO
è<< "Te¡†oggšg iÁ mš " << 
	gINT_MIN
;

50 
LOG
(
INFO
è<< "Te¡†oggšg†Úg†Úg max " << 
	gLLONG_MAX
;

51 
LOG
(
INFO
è<< "Te¡†oggšg†Úg†Úg mš " << 
	gLLONG_MIN
;

52 
LOG
(
INFO
è<< "Te¡†oggšg flßˆmax " << 
	gFLT_MAX
;

53 
LOG
(
INFO
è<< "Te¡†oggšg flßˆmš " << 
	gFLT_MIN
;

54 
LOG
(
INFO
è<< "Te¡†oggšg doubË max " << 
	gDBL_MAX
;

55 
LOG
(
INFO
è<< "Te¡†oggšg doubË mš " << 
	gDBL_MIN
;

56 
LOG
(
WARNING
) << "Test†ogging WARNING";

57 
LOG
(
ERROR
) << "Test†ogging ERROR";

58 
LOG_IF
(
INFO
, 
Œue
) << "Testrue conditional†ogging";

59 
LOG_IF
(
INFO
, 
çl£
) << "Test false conditional†ogging";

60 
VLOG
(0) << "Test VLOG below†evel";

61 
VLOG
(1) << "Test VLOG‡bove†evel";

62  
	gStus
::
OkStus
();

66 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
Loggšg
; 
	}
}

	@test/misc/malloc_stress_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dlib.h
>

21 
	~<uni¡d.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/ut/bš¬y_£¬ch.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 
size_t
 
	gkNumTh»ads
 = 5;

33 
cÚ¡ex´
 
size_t
 
	gkAÎoÿtiÚs
 = 100;

34 
cÚ¡ex´
 
size_t
 
	gkAÎoÿtiÚSize
 = 10000;

37 
size_t
 
L¬ge¡SucûssfulM®loc
() {

38 autØ
	gm®loc_sucûeds
 = [](
size_t
 
size
) {

39 *
±r
 = 
m®loc
(
size
);

40 ià(
	g±r
 !ğ
NULL
) {

41 
ä“
(
±r
);

42  
	gŒue
;

44  
	gçl£
;

46  
Bš¬yS—rch
(
m®loc_sucûeds
);

49 *
M®locSŒess
(*) {

50 *
	gmem
[
kAÎoÿtiÚs
];

51 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; ++i) {

52 
	gmem
[
i
] = 
m®loc
(
kAÎoÿtiÚSize
);

54 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; ++i) {

55 
ä“
(
mem
[
i
]);

58  
	gnuÎ±r
;

61 
LogBadAÎoc
(cÚ¡ 
¡d
::
bad_®loc
 &
e
, *
brk_¡¬t
) {

62 
LOG
(
ERROR
è<< "FaedØ®loÿ‹ w™h m®loc: " << 
	ge
.
wh©
(è<< 
	g¡d
::
’dl


64 << (
size_t
)
sbrk
(0è- (size_t)
brk_¡¬t
 << " by‹s" << 
¡d
::
’dl


66 << 
L¬ge¡SucûssfulM®loc
() << " bytes";

71 
TEST
(
M®locTe¡
, 
EnşaveM®loc
) {

72 
LOG
(
INFO
) << "Largest mallochat succeeds‡test start is: "

73 << 
L¬ge¡SucûssfulM®loc
() << " bytes";

74 
±h»ad_t
 
	gth»ads
[
kNumTh»ads
];

77 *
	gbrk_¡¬t
 = 
sbrk
(0);

78 
	gŒy
 {

79 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

80 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ads
[
i
], 
nuÎ±r
, &
M®locSŒess
,‚ullptr),

83 } 
ÿtch
 (cÚ¡ 
¡d
::
bad_®loc
 &
e
) {

84 
LOG
(
ERROR
) << "Caught bad_alloc during…thread_create";

85 
LogBadAÎoc
(
e
, 
brk_¡¬t
);

86 
FAIL
();

88 
	gŒy
 {

89 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

90 
ASSERT_EQ
(
±h»ad_još
(
th»ads
[
i
], 
nuÎ±r
), 0);

92 } 
ÿtch
 (cÚ¡ 
¡d
::
bad_®loc
 &
e
) {

93 
LOG
(
ERROR
) << "Caught bad_alloc during…thread_join";

94 
LogBadAÎoc
(
e
, 
brk_¡¬t
);

95 
FAIL
();

	@test/misc/malloc_stress_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dlib.h
>

21 
	~<uni¡d.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/ut/bš¬y_£¬ch.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
cÚ¡ex´
 
size_t
 
	gkNumTh»ads
 = 5;

33 
cÚ¡ex´
 
size_t
 
	gkAÎoÿtiÚs
 = 100;

34 
cÚ¡ex´
 
size_t
 
	gkAÎoÿtiÚSize
 = 10000;

37 
size_t
 
L¬ge¡SucûssfulM®loc
() {

38 autØ
	gm®loc_sucûeds
 = [](
size_t
 
size
) {

39 *
±r
 = 
m®loc
(
size
);

40 ià(
	g±r
 !ğ
NULL
) {

41 
ä“
(
±r
);

42  
	gŒue
;

44  
	gçl£
;

46  
Bš¬yS—rch
(
m®loc_sucûeds
);

49 *
M®locSŒess
(*) {

50 *
	gmem
[
kAÎoÿtiÚs
];

51 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; ++i) {

52 
	gmem
[
i
] = 
m®loc
(
kAÎoÿtiÚSize
);

54 
	gi
 = 0; i < 
	gkAÎoÿtiÚs
; ++i) {

55 
ä“
(
mem
[
i
]);

58  
	gnuÎ±r
;

61 
LogBadAÎoc
(cÚ¡ 
¡d
::
bad_®loc
 &
e
, *
brk_¡¬t
) {

62 
LOG
(
ERROR
è<< "FaedØ®loÿ‹ w™h m®loc: " << 
	ge
.
wh©
(è<< 
	g¡d
::
’dl


64 << (
size_t
)
sbrk
(0è- (size_t)
brk_¡¬t
 << " by‹s" << 
¡d
::
’dl


66 << 
L¬ge¡SucûssfulM®loc
() << " bytes";

71 
TEST
(
M®locTe¡
, 
EnşaveM®loc
) {

72 
LOG
(
INFO
) << "Largest mallochat succeeds‡test start is: "

73 << 
L¬ge¡SucûssfulM®loc
() << " bytes";

74 
±h»ad_t
 
	gth»ads
[
kNumTh»ads
];

77 *
	gbrk_¡¬t
 = 
sbrk
(0);

78 
	gŒy
 {

79 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

80 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ads
[
i
], 
nuÎ±r
, &
M®locSŒess
,‚ullptr),

83 } 
ÿtch
 (cÚ¡ 
¡d
::
bad_®loc
 &
e
) {

84 
LOG
(
ERROR
) << "Caught bad_alloc during…thread_create";

85 
LogBadAÎoc
(
e
, 
brk_¡¬t
);

86 
FAIL
();

88 
	gŒy
 {

89 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

90 
ASSERT_EQ
(
±h»ad_još
(
th»ads
[
i
], 
nuÎ±r
), 0);

92 } 
ÿtch
 (cÚ¡ 
¡d
::
bad_®loc
 &
e
) {

93 
LOG
(
ERROR
) << "Caught bad_alloc during…thread_join";

94 
LogBadAÎoc
(
e
, 
brk_¡¬t
);

95 
FAIL
();

	@test/misc/memory_layout_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
	gv¬ŸbË_Ú_d©a
 = 1;

28 
	gv¬ŸbË_Ú_bss
;

30 
boŞ
 
IsAdd»ssInRªge
(*
addr
, *
ba£
, 
size_t
 
size
) {

31 
size_t
 
	g¡¬t
 = 
»š‹½»t_ÿ¡
<size_t>(
ba£
);

32 
size_t
 
	g’d
 = 
¡¬t
 + 
size
;

33 
size_t
 
	grg‘
 = 
»š‹½»t_ÿ¡
<size_t>(
addr
);

34  
	grg‘
 >ğ
¡¬t
 && 
rg‘
 < 
’d
;

37 
TEST
(
EnşaveMemÜyLayout
, 
MemÜyLayout
) {

38 
EnşaveMemÜyLayout
 
	g’şave_memÜy_Ïyout
;

39 
’c_g‘_memÜy_Ïyout
(&
’şave_memÜy_Ïyout
);

42 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
d©a_ba£
,

43 
’şave_memÜy_Ïyout
.
d©a_size
));

44 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
»š‹½»t_ÿ¡
<*>(&
v¬ŸbË_Ú_d©a
),

45 
’şave_memÜy_Ïyout
.
d©a_ba£
,

46 
’şave_memÜy_Ïyout
.
d©a_size
));

49 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
bss_ba£
,

50 
’şave_memÜy_Ïyout
.
bss_size
));

51 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
»š‹½»t_ÿ¡
<*>(&
v¬ŸbË_Ú_bss
),

52 
’şave_memÜy_Ïyout
.
bss_ba£
,

53 
’şave_memÜy_Ïyout
.
bss_size
));

56 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
h—p_ba£
,

57 
’şave_memÜy_Ïyout
.
h—p_size
));

58 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p
 = 
ab¦
::
make_unique
<>(0);

59 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p
.
g‘
(),

60 
’şave_memÜy_Ïyout
.
h—p_ba£
,

61 
’şave_memÜy_Ïyout
.
h—p_size
));

64 
size_t
 
	g¡ack_size
 =

65 
»š‹½»t_ÿ¡
<
size_t
>(
’şave_memÜy_Ïyout
.
¡ack_ba£
) -

66 
»š‹½»t_ÿ¡
<
size_t
>(
’şave_memÜy_Ïyout
.
¡ack_lim™
);

67 
EXPECT_TRUE
(

68 
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
¡ack_ba£
, 
¡ack_size
));

69 
	gv¬ŸbË_Ú_¡ack
 = 0;

70 
EXPECT_TRUE
(
IsAdd»ssInRªge
(&
v¬ŸbË_Ú_¡ack
,

71 
’şave_memÜy_Ïyout
.
¡ack_lim™
, 
¡ack_size
));

74 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
»£rved_d©a_ba£
,

75 
’şave_memÜy_Ïyout
.
»£rved_d©a_size
));

78 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
»£rved_bss_ba£
,

79 
’şave_memÜy_Ïyout
.
»£rved_bss_size
));

82 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
»£rved_h—p_ba£
,

83 
’şave_memÜy_Ïyout
.
»£rved_h—p_size
));

	@test/misc/memory_layout_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

21 
	~"ab¦/memÜy/memÜy.h
"

22 
	~"asylo/¶©fÜm/´im™ives/Œu¡ed_ruÁime.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
	gv¬ŸbË_Ú_d©a
 = 1;

28 
	gv¬ŸbË_Ú_bss
;

30 
boŞ
 
IsAdd»ssInRªge
(*
addr
, *
ba£
, 
size_t
 
size
) {

31 
size_t
 
	g¡¬t
 = 
»š‹½»t_ÿ¡
<size_t>(
ba£
);

32 
size_t
 
	g’d
 = 
¡¬t
 + 
size
;

33 
size_t
 
	grg‘
 = 
»š‹½»t_ÿ¡
<size_t>(
addr
);

34  
	grg‘
 >ğ
¡¬t
 && 
rg‘
 < 
’d
;

37 
TEST
(
EnşaveMemÜyLayout
, 
MemÜyLayout
) {

38 
EnşaveMemÜyLayout
 
	g’şave_memÜy_Ïyout
;

39 
’c_g‘_memÜy_Ïyout
(&
’şave_memÜy_Ïyout
);

42 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
d©a_ba£
,

43 
’şave_memÜy_Ïyout
.
d©a_size
));

44 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
»š‹½»t_ÿ¡
<*>(&
v¬ŸbË_Ú_d©a
),

45 
’şave_memÜy_Ïyout
.
d©a_ba£
,

46 
’şave_memÜy_Ïyout
.
d©a_size
));

49 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
bss_ba£
,

50 
’şave_memÜy_Ïyout
.
bss_size
));

51 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
»š‹½»t_ÿ¡
<*>(&
v¬ŸbË_Ú_bss
),

52 
’şave_memÜy_Ïyout
.
bss_ba£
,

53 
’şave_memÜy_Ïyout
.
bss_size
));

56 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
h—p_ba£
,

57 
’şave_memÜy_Ïyout
.
h—p_size
));

58 
	g¡d
::
unique_±r
<> 
v¬ŸbË_Ú_h—p
 = 
ab¦
::
make_unique
<>(0);

59 
EXPECT_TRUE
(
IsAdd»ssInRªge
(
v¬ŸbË_Ú_h—p
.
g‘
(),

60 
’şave_memÜy_Ïyout
.
h—p_ba£
,

61 
’şave_memÜy_Ïyout
.
h—p_size
));

64 
size_t
 
	g¡ack_size
 =

65 
»š‹½»t_ÿ¡
<
size_t
>(
’şave_memÜy_Ïyout
.
¡ack_ba£
) -

66 
»š‹½»t_ÿ¡
<
size_t
>(
’şave_memÜy_Ïyout
.
¡ack_lim™
);

67 
EXPECT_TRUE
(

68 
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
¡ack_ba£
, 
¡ack_size
));

69 
	gv¬ŸbË_Ú_¡ack
 = 0;

70 
EXPECT_TRUE
(
IsAdd»ssInRªge
(&
v¬ŸbË_Ú_¡ack
,

71 
’şave_memÜy_Ïyout
.
¡ack_lim™
, 
¡ack_size
));

74 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
»£rved_d©a_ba£
,

75 
’şave_memÜy_Ïyout
.
»£rved_d©a_size
));

78 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
»£rved_bss_ba£
,

79 
’şave_memÜy_Ïyout
.
»£rved_bss_size
));

82 
EXPECT_TRUE
(
’c_is_w™hš_’şave
(
’şave_memÜy_Ïyout
.
»£rved_h—p_ba£
,

83 
’şave_memÜy_Ïyout
.
»£rved_h—p_size
));

	@test/misc/mutex_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

25 
	~"asylo/ut/loggšg.h
"

26 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

34 cÚ¡ 
	gkNumTh»ads
 = 8;

37 cÚ¡ 
	gkNumLoİs
 = 50000;

40 cÚ¡ 
	gkBufãrSize
 = 4096;

43 cÚ¡ 
	gkEx³ùedResuÉ
 = 
kNumTh»ads
 * 
kNumLoİs
;

46 
	gab¦
::
Mu‹x
 
mu
;

49 
	gab¦
::
Mu‹x
 
mu2
;

52 
	gab¦
::
Mu‹x
 
mu3
;

55 vŞ©
	gcouÁ”
 = 0;

59 
S¹Routše
(vŞ©*
couÁ”
) {

60 ià(!
	gcouÁ”
) {

61 
LOG
(
FATAL
) << "Counter…ointer is unexpectedly‚ull";

66 
	gi
 = 0; i < 
	gkNumLoİs
; ++i) {

67 vŞ©
	gcouÁ”_cİy
 = *
couÁ”
;

68 
BusyWÜk
();

69 *
	gcouÁ”
 = 
couÁ”_cİy
 + 1;

75 
Stus
 
RunTh»ads
(*(*
¡¬t_routše
)(*)) {

76 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

77 
Stus
 
	g»t
 = 
LaunchTh»ads
(
kNumTh»ads
, 
¡¬t_routše
, 
nuÎ±r
, &
th»ads
);

78 ià(
	g»t
.
ok
()) {

79 
	g»t
 = 
JošTh»ads
(
th»ads
);

81  
	g»t
;

89 *
S¹RoutšeUngu¬ded
(*) {

91 
S¹Routše
(&
couÁ”
);

92  
	gnuÎ±r
;

98 *
S¹RoutšeMu‹x
(*) {

100 
	gmu
.
Lock
();

101 
S¹Routše
(&
couÁ”
);

102 
	gmu
.
UÆock
();

103  
	gnuÎ±r
;

109 *
S¹RoutšeMu‹xLock
(*) {

111 
	gab¦
::
Mu‹xLock
 
mu
(&
mu2
);

112 
S¹Routše
(&
couÁ”
);

113  
	gnuÎ±r
;

119 *
S¹RoutšeTryLock
(*) {

121 !
	gmu3
.
TryLock
()) {

123 
S¹Routše
(&
couÁ”
);

124 
	gmu3
.
UÆock
();

125  
	gnuÎ±r
;

128 
TEST
(
RunW™hUngu¬dedTe¡
, 
EnşaveMu‹x
) {

129 
	gcouÁ”
 = 0;

130 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeUngu¬ded
), 
IsOk
());

131 
LOG
(
INFO
è<< "ungu¬ded_couÁ”: " << 
	gcouÁ”
;

132 
ASSERT_LT
(
couÁ”
, 
kEx³ùedResuÉ
);

135 
TEST
(
RunW™hMu‹xTe¡
, 
EnşaveMu‹x
) {

136 
	gcouÁ”
 = 0;

137 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeMu‹x
), 
IsOk
());

138 
LOG
(
INFO
è<< "mu‹x_gu¬ded_couÁ”: " << 
	gcouÁ”
;

139 
ASSERT_EQ
(
couÁ”
, 
kEx³ùedResuÉ
);

142 
TEST
(
RunW™hMu‹xLockTe¡
, 
EnşaveMu‹x
) {

143 
	gcouÁ”
 = 0;

144 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeMu‹xLock
), 
IsOk
());

145 
LOG
(
INFO
è<< "lock_gu¬ded_couÁ”: " << 
	gcouÁ”
;

146 
ASSERT_EQ
(
couÁ”
, 
kEx³ùedResuÉ
);

149 
TEST
(
RunW™hTryLockTe¡
, 
EnşaveMu‹x
) {

150 
	gcouÁ”
 = 0;

151 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeTryLock
), 
IsOk
());

152 
LOG
(
INFO
è<< "Œy_lock_gu¬ded_couÁ”: " << 
	gcouÁ”
;

153 
ASSERT_EQ
(
couÁ”
, 
kEx³ùedResuÉ
);

	@test/misc/mutex_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

25 
	~"asylo/ut/loggšg.h
"

26 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

34 cÚ¡ 
	gkNumTh»ads
 = 8;

37 cÚ¡ 
	gkNumLoİs
 = 50000;

40 cÚ¡ 
	gkBufãrSize
 = 4096;

43 cÚ¡ 
	gkEx³ùedResuÉ
 = 
kNumTh»ads
 * 
kNumLoİs
;

46 
	gab¦
::
Mu‹x
 
mu
;

49 
	gab¦
::
Mu‹x
 
mu2
;

52 
	gab¦
::
Mu‹x
 
mu3
;

55 vŞ©
	gcouÁ”
 = 0;

59 
S¹Routše
(vŞ©*
couÁ”
) {

60 ià(!
	gcouÁ”
) {

61 
LOG
(
FATAL
) << "Counter…ointer is unexpectedly‚ull";

66 
	gi
 = 0; i < 
	gkNumLoİs
; ++i) {

67 vŞ©
	gcouÁ”_cİy
 = *
couÁ”
;

68 
BusyWÜk
();

69 *
	gcouÁ”
 = 
couÁ”_cİy
 + 1;

75 
Stus
 
RunTh»ads
(*(*
¡¬t_routše
)(*)) {

76 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

77 
Stus
 
	g»t
 = 
LaunchTh»ads
(
kNumTh»ads
, 
¡¬t_routše
, 
nuÎ±r
, &
th»ads
);

78 ià(
	g»t
.
ok
()) {

79 
	g»t
 = 
JošTh»ads
(
th»ads
);

81  
	g»t
;

89 *
S¹RoutšeUngu¬ded
(*) {

91 
S¹Routše
(&
couÁ”
);

92  
	gnuÎ±r
;

98 *
S¹RoutšeMu‹x
(*) {

100 
	gmu
.
Lock
();

101 
S¹Routše
(&
couÁ”
);

102 
	gmu
.
UÆock
();

103  
	gnuÎ±r
;

109 *
S¹RoutšeMu‹xLock
(*) {

111 
	gab¦
::
Mu‹xLock
 
mu
(&
mu2
);

112 
S¹Routše
(&
couÁ”
);

113  
	gnuÎ±r
;

119 *
S¹RoutšeTryLock
(*) {

121 !
	gmu3
.
TryLock
()) {

123 
S¹Routše
(&
couÁ”
);

124 
	gmu3
.
UÆock
();

125  
	gnuÎ±r
;

128 
TEST
(
RunW™hUngu¬dedTe¡
, 
EnşaveMu‹x
) {

129 
	gcouÁ”
 = 0;

130 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeUngu¬ded
), 
IsOk
());

131 
LOG
(
INFO
è<< "ungu¬ded_couÁ”: " << 
	gcouÁ”
;

132 
ASSERT_LT
(
couÁ”
, 
kEx³ùedResuÉ
);

135 
TEST
(
RunW™hMu‹xTe¡
, 
EnşaveMu‹x
) {

136 
	gcouÁ”
 = 0;

137 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeMu‹x
), 
IsOk
());

138 
LOG
(
INFO
è<< "mu‹x_gu¬ded_couÁ”: " << 
	gcouÁ”
;

139 
ASSERT_EQ
(
couÁ”
, 
kEx³ùedResuÉ
);

142 
TEST
(
RunW™hMu‹xLockTe¡
, 
EnşaveMu‹x
) {

143 
	gcouÁ”
 = 0;

144 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeMu‹xLock
), 
IsOk
());

145 
LOG
(
INFO
è<< "lock_gu¬ded_couÁ”: " << 
	gcouÁ”
;

146 
ASSERT_EQ
(
couÁ”
, 
kEx³ùedResuÉ
);

149 
TEST
(
RunW™hTryLockTe¡
, 
EnşaveMu‹x
) {

150 
	gcouÁ”
 = 0;

151 
ASSERT_THAT
(
RunTh»ads
(&
S¹RoutšeTryLock
), 
IsOk
());

152 
LOG
(
INFO
è<< "Œy_lock_gu¬ded_couÁ”: " << 
	gcouÁ”
;

153 
ASSERT_EQ
(
couÁ”
, 
kEx³ùedResuÉ
);

	@test/misc/nanosleep_test.cc

19 
	~<time.h
>

20 
	~<chrÚo
>

21 
	~<th»ad
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
TEST
(
Nªo¦“pTe¡
, 
Nªo¦“p
) {

30 
	g¡d
::
this_th»ad
::
¦“p_fÜ
(
¡d
::
chrÚo
::
£cÚds
(1));

31 
time¥ec
 
	g»q
;

32 
	g»q
.
	gtv_£c
 = 0;

33 
	g»q
.
	gtv_n£c
 = 1000000;

34 
EXPECT_FALSE
(
Çno¦“p
(&
»q
, 
nuÎ±r
));

	@test/misc/nanosleep_test.cc

19 
	~<time.h
>

20 
	~<chrÚo
>

21 
	~<th»ad
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
TEST
(
Nªo¦“pTe¡
, 
Nªo¦“p
) {

30 
	g¡d
::
this_th»ad
::
¦“p_fÜ
(
¡d
::
chrÚo
::
£cÚds
(1));

31 
time¥ec
 
	g»q
;

32 
	g»q
.
	gtv_£c
 = 0;

33 
	g»q
.
	gtv_n£c
 = 1000000;

34 
EXPECT_FALSE
(
Çno¦“p
(&
»q
, 
nuÎ±r
));

	@test/misc/pthread_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

21 
	~<funùiÚ®
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/¶©fÜm/posix/±h»ad_im¶.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g±h»ad_im¶
 {

32 
	gÇme¥aû
 {

34 
	gusšg
 ::
‹¡šg
::
Te¡
;

36 
±h»ad_t
 
Te¡Th»ad
(
ušt64_t
 
num
è{  
	g¡©ic_ÿ¡
<
	g±h»ad_t
>(
	gnum
); }

39 şas 
	cQueueO³¿tiÚsTe¡
 : 
public
 
Te¡
 {

40 
´Ùeùed
:

41 
QueueO³¿tiÚsTe¡
(è: 
li¡_
(&
¿w_li¡_
) {}

46 
V”ifyLi¡CÚ‹ÁsAndD–‘e
(cÚ¡ 
¡d
::
veùÜ
<> &
ex³ùed_li¡
) {

47 cÚ¡ 
ex³ùed_™em
 : 
ex³ùed_li¡
) {

48 
±h»ad_t
 
aùu®_™em
 = 
li¡_
.
FrÚt
();

49 
	gli¡_
.
Dequeue
();

51 
EXPECT_EQ
(
Te¡Th»ad
(
ex³ùed_™em
), 
aùu®_™em
);

55 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
PTHREAD_T_NULL
);

59 
__±h»ad_li¡_t
 
	g¿w_li¡_
 = {};

60 
QueueO³¿tiÚs
 
	gli¡_
;

63 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
CÚšs
) {

65 
EXPECT_FALSE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

68 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

69 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

70 
EXPECT_FALSE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

73 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

74 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

77 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

78 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(5));

79 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

82 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
CÚšsFœ¡
) {

85 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

86 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

87 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

88 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

89 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

92 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
In£¹La¡
) {

94 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

95 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

96 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

97 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

99 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 2, 3, 4});

102 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
Fœ¡
) {

104 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
PTHREAD_T_NULL
);

107 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

108 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(1));

111 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

112 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

113 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

114 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(1));

117 
	gli¡_
.
Dequeue
();

118 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(2));

119 
	gli¡_
.
Dequeue
();

120 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(3));

121 
	gli¡_
.
Dequeue
();

122 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(4));

123 
	gli¡_
.
Dequeue
();

124 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
PTHREAD_T_NULL
);

127 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
Dequeue
) {

130 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

131 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

132 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

133 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

135 
	gli¡_
.
Dequeue
();

136 
	gli¡_
.
Dequeue
();

138 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({3, 4});

141 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
DequeueEm±y
) {

142 
	gli¡_
.
Dequeue
();

143 
	gli¡_
.
Dequeue
();

144 
	gli¡_
.
Dequeue
();

147 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
Remove
) {

149 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

150 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

151 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

152 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

153 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(1)));

154 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({2, 3, 4});

157 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

158 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

159 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

160 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

161 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(2)));

162 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 3, 4});

165 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

166 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

167 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

168 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

169 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(4)));

170 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 2, 3});

173 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

174 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(1)));

175 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({});

178 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

179 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

180 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

181 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

182 
EXPECT_FALSE
(
li¡_
.
Remove
(
Te¡Th»ad
(5)));

183 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 2, 3, 4});

186 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
CË¬
) {

188 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

189 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

190 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

191 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

193 
	gli¡_
.
CË¬
();

195 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({});

198 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
EndToEnd
) {

201 
EXPECT_TRUE
(
li¡_
.
Em±y
());

202 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

203 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(1));

204 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

205 
EXPECT_FALSE
(
li¡_
.
Em±y
());

206 
	gli¡_
.
Dequeue
();

207 
EXPECT_FALSE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

208 
EXPECT_TRUE
(
li¡_
.
Em±y
());

209 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({});

217 şas 
	cPth»adCËªupTe¡
 : 
public
 
Te¡
 {

218 
´Ùeùed
:

220 
¡d
::
veùÜ
<¡d::
¡ršg
> 
run_log_
;

224 
CËªupFunc
(*
¬g
è{ 
	grun_log_
.
em¶aû_back
((*)arg); }

228 
Ex³ùResuÉ
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
ex³ùed_run_log
,

229 *(*
‹¡_func
)(*)) {

230 
±h»ad_t
 
	g±h»ad
;

231 
	grun_log_
.
ş—r
();

232 
ASSERT_EQ
(
±h»ad_ü—‹
(&
±h»ad
, 
nuÎ±r
, 
‹¡_func
,‚ullptr), 0);

233 
ASSERT_EQ
(
±h»ad_još
(
±h»ad
, 
nuÎ±r
), 0);

234 
EXPECT_EQ
(
run_log_
, 
ex³ùed_run_log
);

238 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Pth»adCËªupTe¡
::
run_log_
;

240 
TEST_F
(
Pth»adCËªupTe¡
, 
CËªupExecu‹dIm¶ic™ly
) {

243 
Ex³ùResuÉ
({"c", "b", "a"}, [](*) -> * {

244 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

245 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

246 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

247  
nuÎ±r
;

248 
±h»ad_ş—nup_pİ
(0);

249 
±h»ad_ş—nup_pİ
(0);

250 
±h»ad_ş—nup_pİ
(0);

254 
TEST_F
(
Pth»adCËªupTe¡
, 
CËªupExecu‹dEx¶ic™ly
) {

257 
Ex³ùResuÉ
({"c", "b", "a"}, [](*) -> * {

258 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

259 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

260 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

261 
±h»ad_ş—nup_pİ
(1);

262 
±h»ad_ş—nup_pİ
(1);

263 
±h»ad_ş—nup_pİ
(1);

264  
nuÎ±r
;

268 
TEST_F
(
Pth»adCËªupTe¡
, 
P¬tŸlPİW™houtExecutiÚ
) {

270 
Ex³ùResuÉ
({"b", "a"}, [](*) -> * {

271 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

272 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

273 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

274 
±h»ad_ş—nup_pİ
(0);

275  
nuÎ±r
;

276 
±h»ad_ş—nup_pİ
(0);

277 
±h»ad_ş—nup_pİ
(0);

281 
TEST_F
(
Pth»adCËªupTe¡
, 
P¬tŸlPİW™hExecutiÚ
) {

284 
Ex³ùResuÉ
({"d", "c", "b", "a"}, [](*) -> * {

285 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

286 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

287 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

288 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"d");

289 
±h»ad_ş—nup_pİ
(1);

290 
±h»ad_ş—nup_pİ
(1);

291  
nuÎ±r
;

292 
±h»ad_ş—nup_pİ
(0);

293 
±h»ad_ş—nup_pİ
(0);

297 
TEST_F
(
Pth»adCËªupTe¡
, 
Pİ³dW™houtExecutšg
) {

300 
Ex³ùResuÉ
({}, [](*) -> * {

301 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

302 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

303 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

304 
±h»ad_ş—nup_pİ
(0);

305 
±h»ad_ş—nup_pİ
(0);

306 
±h»ad_ş—nup_pİ
(0);

307  
nuÎ±r
;

311 
TEST_F
(
Pth»adCËªupTe¡
, 
PİAÎExecu‹Some
) {

314 
Ex³ùResuÉ
({"c", "b"}, [](*) -> * {

315 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

316 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

317 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

318 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"d");

319 
±h»ad_ş—nup_pİ
(0);

320 
±h»ad_ş—nup_pİ
(1);

321 
±h»ad_ş—nup_pİ
(1);

322 
±h»ad_ş—nup_pİ
(0);

323  
nuÎ±r
;

327 
TEST_F
(
Pth»adCËªupTe¡
, 
Ne¡edCËªup
) {

329 
Ex³ùResuÉ
({"e", "b", "a"}, [](*) -> * {

330 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

331 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

332 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

334 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"d");

335 
±h»ad_ş—nup_pİ
(0);

337 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"e");

338 
±h»ad_ş—nup_pİ
(1);

340 
±h»ad_ş—nup_pİ
(0);

341  
nuÎ±r
;

342 
±h»ad_ş—nup_pİ
(0);

343 
±h»ad_ş—nup_pİ
(0);

	@test/misc/pthread_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

21 
	~<funùiÚ®
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/¶©fÜm/posix/±h»ad_im¶.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	g±h»ad_im¶
 {

32 
	gÇme¥aû
 {

34 
	gusšg
 ::
‹¡šg
::
Te¡
;

36 
±h»ad_t
 
Te¡Th»ad
(
ušt64_t
 
num
è{  
	g¡©ic_ÿ¡
<
	g±h»ad_t
>(
	gnum
); }

39 şas 
	cQueueO³¿tiÚsTe¡
 : 
public
 
Te¡
 {

40 
´Ùeùed
:

41 
QueueO³¿tiÚsTe¡
(è: 
li¡_
(&
¿w_li¡_
) {}

46 
V”ifyLi¡CÚ‹ÁsAndD–‘e
(cÚ¡ 
¡d
::
veùÜ
<> &
ex³ùed_li¡
) {

47 cÚ¡ 
ex³ùed_™em
 : 
ex³ùed_li¡
) {

48 
±h»ad_t
 
aùu®_™em
 = 
li¡_
.
FrÚt
();

49 
	gli¡_
.
Dequeue
();

51 
EXPECT_EQ
(
Te¡Th»ad
(
ex³ùed_™em
), 
aùu®_™em
);

55 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
PTHREAD_T_NULL
);

59 
__±h»ad_li¡_t
 
	g¿w_li¡_
 = {};

60 
QueueO³¿tiÚs
 
	gli¡_
;

63 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
CÚšs
) {

65 
EXPECT_FALSE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

68 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

69 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

70 
EXPECT_FALSE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

73 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

74 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

77 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

78 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(5));

79 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

82 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
CÚšsFœ¡
) {

85 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

86 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

87 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

88 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

89 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

92 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
In£¹La¡
) {

94 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

95 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

96 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

97 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

99 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 2, 3, 4});

102 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
Fœ¡
) {

104 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
PTHREAD_T_NULL
);

107 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

108 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(1));

111 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

112 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

113 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

114 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(1));

117 
	gli¡_
.
Dequeue
();

118 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(2));

119 
	gli¡_
.
Dequeue
();

120 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(3));

121 
	gli¡_
.
Dequeue
();

122 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(4));

123 
	gli¡_
.
Dequeue
();

124 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
PTHREAD_T_NULL
);

127 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
Dequeue
) {

130 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

131 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

132 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

133 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

135 
	gli¡_
.
Dequeue
();

136 
	gli¡_
.
Dequeue
();

138 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({3, 4});

141 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
DequeueEm±y
) {

142 
	gli¡_
.
Dequeue
();

143 
	gli¡_
.
Dequeue
();

144 
	gli¡_
.
Dequeue
();

147 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
Remove
) {

149 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

150 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

151 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

152 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

153 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(1)));

154 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({2, 3, 4});

157 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

158 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

159 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

160 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

161 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(2)));

162 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 3, 4});

165 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

166 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

167 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

168 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

169 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(4)));

170 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 2, 3});

173 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

174 
EXPECT_TRUE
(
li¡_
.
Remove
(
Te¡Th»ad
(1)));

175 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({});

178 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

179 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

180 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

181 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

182 
EXPECT_FALSE
(
li¡_
.
Remove
(
Te¡Th»ad
(5)));

183 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({1, 2, 3, 4});

186 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
CË¬
) {

188 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

189 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(2));

190 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(3));

191 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(4));

193 
	gli¡_
.
CË¬
();

195 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({});

198 
TEST_F
(
QueueO³¿tiÚsTe¡
, 
EndToEnd
) {

201 
EXPECT_TRUE
(
li¡_
.
Em±y
());

202 
	gli¡_
.
Enqueue
(
Te¡Th»ad
(1));

203 
EXPECT_EQ
(
li¡_
.
FrÚt
(), 
Te¡Th»ad
(1));

204 
EXPECT_TRUE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

205 
EXPECT_FALSE
(
li¡_
.
Em±y
());

206 
	gli¡_
.
Dequeue
();

207 
EXPECT_FALSE
(
li¡_
.
CÚšs
(
Te¡Th»ad
(1)));

208 
EXPECT_TRUE
(
li¡_
.
Em±y
());

209 
V”ifyLi¡CÚ‹ÁsAndD–‘e
({});

217 şas 
	cPth»adCËªupTe¡
 : 
public
 
Te¡
 {

218 
´Ùeùed
:

220 
¡d
::
veùÜ
<¡d::
¡ršg
> 
run_log_
;

224 
CËªupFunc
(*
¬g
è{ 
	grun_log_
.
em¶aû_back
((*)arg); }

228 
Ex³ùResuÉ
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
ex³ùed_run_log
,

229 *(*
‹¡_func
)(*)) {

230 
±h»ad_t
 
	g±h»ad
;

231 
	grun_log_
.
ş—r
();

232 
ASSERT_EQ
(
±h»ad_ü—‹
(&
±h»ad
, 
nuÎ±r
, 
‹¡_func
,‚ullptr), 0);

233 
ASSERT_EQ
(
±h»ad_još
(
±h»ad
, 
nuÎ±r
), 0);

234 
EXPECT_EQ
(
run_log_
, 
ex³ùed_run_log
);

238 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
Pth»adCËªupTe¡
::
run_log_
;

240 
TEST_F
(
Pth»adCËªupTe¡
, 
CËªupExecu‹dIm¶ic™ly
) {

243 
Ex³ùResuÉ
({"c", "b", "a"}, [](*) -> * {

244 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

245 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

246 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

247  
nuÎ±r
;

248 
±h»ad_ş—nup_pİ
(0);

249 
±h»ad_ş—nup_pİ
(0);

250 
±h»ad_ş—nup_pİ
(0);

254 
TEST_F
(
Pth»adCËªupTe¡
, 
CËªupExecu‹dEx¶ic™ly
) {

257 
Ex³ùResuÉ
({"c", "b", "a"}, [](*) -> * {

258 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

259 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

260 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

261 
±h»ad_ş—nup_pİ
(1);

262 
±h»ad_ş—nup_pİ
(1);

263 
±h»ad_ş—nup_pİ
(1);

264  
nuÎ±r
;

268 
TEST_F
(
Pth»adCËªupTe¡
, 
P¬tŸlPİW™houtExecutiÚ
) {

270 
Ex³ùResuÉ
({"b", "a"}, [](*) -> * {

271 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

272 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

273 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

274 
±h»ad_ş—nup_pİ
(0);

275  
nuÎ±r
;

276 
±h»ad_ş—nup_pİ
(0);

277 
±h»ad_ş—nup_pİ
(0);

281 
TEST_F
(
Pth»adCËªupTe¡
, 
P¬tŸlPİW™hExecutiÚ
) {

284 
Ex³ùResuÉ
({"d", "c", "b", "a"}, [](*) -> * {

285 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

286 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

287 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

288 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"d");

289 
±h»ad_ş—nup_pİ
(1);

290 
±h»ad_ş—nup_pİ
(1);

291  
nuÎ±r
;

292 
±h»ad_ş—nup_pİ
(0);

293 
±h»ad_ş—nup_pİ
(0);

297 
TEST_F
(
Pth»adCËªupTe¡
, 
Pİ³dW™houtExecutšg
) {

300 
Ex³ùResuÉ
({}, [](*) -> * {

301 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

302 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

303 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

304 
±h»ad_ş—nup_pİ
(0);

305 
±h»ad_ş—nup_pİ
(0);

306 
±h»ad_ş—nup_pİ
(0);

307  
nuÎ±r
;

311 
TEST_F
(
Pth»adCËªupTe¡
, 
PİAÎExecu‹Some
) {

314 
Ex³ùResuÉ
({"c", "b"}, [](*) -> * {

315 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

316 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

317 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

318 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"d");

319 
±h»ad_ş—nup_pİ
(0);

320 
±h»ad_ş—nup_pİ
(1);

321 
±h»ad_ş—nup_pİ
(1);

322 
±h»ad_ş—nup_pİ
(0);

323  
nuÎ±r
;

327 
TEST_F
(
Pth»adCËªupTe¡
, 
Ne¡edCËªup
) {

329 
Ex³ùResuÉ
({"e", "b", "a"}, [](*) -> * {

330 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"a");

331 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"b");

332 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"c");

334 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"d");

335 
±h»ad_ş—nup_pİ
(0);

337 
±h»ad_ş—nup_push
(
CËªupFunc
, (*)"e");

338 
±h»ad_ş—nup_pİ
(1);

340 
±h»ad_ş—nup_pİ
(0);

341  
nuÎ±r
;

342 
±h»ad_ş—nup_pİ
(0);

343 
±h»ad_ş—nup_pİ
(0);

	@test/misc/raise_signal_test.cc

19 
	~<sigÇl.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
boŞ
 
	gsigÇl_hªdËd
 = 
çl£
;

29 
HªdËSigÇl
(
signum
) {

30 ià(
	gsignum
 =ğ
SIGUSR1
) {

31 
sigÇl_hªdËd
 = 
Œue
;

37 
TEST
(
SigÇlTe¡
, 
Rai£SigÇl
) {

38 
sigaùiÚ
 
	gaù
;

39 
mem£t
(&
aù
, 0, (
sigaùiÚ
));

40 
	gaù
.
	g§_hªdËr
 = &
HªdËSigÇl
;

41 
sigaùiÚ
 
	gŞdaù
;

42 
sigaùiÚ
(
SIGUSR1
, &
aù
, &
Şdaù
);

43 
¿i£
(
SIGUSR1
);

44 
EXPECT_TRUE
(
sigÇl_hªdËd
);

	@test/misc/raise_signal_test.cc

19 
	~<sigÇl.h
>

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
	gÇme¥aû
 {

27 
boŞ
 
	gsigÇl_hªdËd
 = 
çl£
;

29 
HªdËSigÇl
(
signum
) {

30 ià(
	gsignum
 =ğ
SIGUSR1
) {

31 
sigÇl_hªdËd
 = 
Œue
;

37 
TEST
(
SigÇlTe¡
, 
Rai£SigÇl
) {

38 
sigaùiÚ
 
	gaù
;

39 
mem£t
(&
aù
, 0, (
sigaùiÚ
));

40 
	gaù
.
	g§_hªdËr
 = &
HªdËSigÇl
;

41 
sigaùiÚ
 
	gŞdaù
;

42 
sigaùiÚ
(
SIGUSR1
, &
aù
, &
Şdaù
);

43 
¿i£
(
SIGUSR1
);

44 
EXPECT_TRUE
(
sigÇl_hªdËd
);

	@test/misc/rdrand_test.cc

19 
	~<ıuid.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
	gÇme¥aû
 {

25 şas 
	cRd¿ndTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

27 
	$TEST_F
(
Rd¿ndTe¡
, 
HasRDRAND
) {

28 
—x
, 
ebx
, 
ecx
, 
edx
;

30 
	`__ıuid
(0, 
—x
, 
ebx
, 
ecx
, 
edx
);

32 
	`EXPECT_TRUE
(
ecx
 & (1 << 30));

33 
	}
}

	@test/misc/rdrand_test.cc

19 
	~<ıuid.h
>

21 
	~<g‹¡/g‹¡.h
>

23 
	gÇme¥aû
 {

25 şas 
	cRd¿ndTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

27 
	$TEST_F
(
Rd¿ndTe¡
, 
HasRDRAND
) {

28 
—x
, 
ebx
, 
ecx
, 
edx
;

30 
	`__ıuid
(0, 
—x
, 
ebx
, 
ecx
, 
edx
);

32 
	`EXPECT_TRUE
(
ecx
 & (1 << 30));

33 
	}
}

	@test/misc/rwlock_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

21 
	~<c¡ršg
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/synchrÚiz©iÚ/b¬r›r.h
"

27 
	~"asylo/ut/loggšg.h
"

28 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

29 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/¡©us.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
cÚ¡ex´
 
	gkNumTh»ads
 = 5;

38 
cÚ¡ex´
 
	gkCouÁsP”Th»ad
 = 500;

40 şas 
	cRwLockTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

41 
´Ùeùed
:

43 
CheckCouÁ”
() {

44 
ASSERT_GE
(
couÁ_
, 0) << "counter value out of bounds!";

45 
ASSERT_LE
(
couÁ_
, 
kCouÁsP”Th»ad
 * 
kNumTh»ads
)

49 
Th»adRoutše
() {

50 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; ++i) {

51 
EXPECT_EQ
(
±h»ad_rwlock_w¾ock
(&
rwlock_
), 0);

52 
CheckCouÁ”
();

53 
	gcouÁ”_cİy
 = 
couÁ_
;

54 
BusyWÜk
();

55 
	gcouÁ_
 = 
couÁ”_cİy
 + 1;

56 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

58 
EXPECT_EQ
(
±h»ad_rwlock_rdlock
(&
rwlock_
), 0);

59 
CheckCouÁ”
();

60 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

64 *
Th»adT¿mpŞše
(*
¬g
) {

65 
RwLockTe¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<RwLockTe¡ *>(
¬g
);

66 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Test…ointer is unexpectedly‚ull";

67 
	g‹¡
->
Th»adRoutše
();

68  
	gnuÎ±r
;

72 
±h»ad_rwlock_t
 
	grwlock_
 = 
PTHREAD_RWLOCK_INITIALIZER
;

74 vŞ©
ušt
 
	gcouÁ_
 = 0;

77 
TEST_F
(
RwLockTe¡
, 
Inv®idPoš‹rs
) {

81 
ASSERT_EQ
(
±h»ad_rwlock_š™
(
nuÎ±r
,‚ullptr), -1);

82 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

84 
ASSERT_EQ
(
±h»ad_rwlock_de¡roy
(
nuÎ±r
), -1);

85 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

87 
ASSERT_EQ
(
±h»ad_rwlock_Œyw¾ock
(
nuÎ±r
), -1);

88 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

90 
ASSERT_EQ
(
±h»ad_rwlock_w¾ock
(
nuÎ±r
), -1);

91 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

93 
ASSERT_EQ
(
±h»ad_rwlock_Œyrdlock
(
nuÎ±r
), -1);

94 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

96 
ASSERT_EQ
(
±h»ad_rwlock_rdlock
(
nuÎ±r
), -1);

97 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

99 
ASSERT_EQ
(
±h»ad_rwlock_uÆock
(
nuÎ±r
), -1);

100 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

103 
TEST_F
(
RwLockTe¡
, 
In™
) {

105 
±h»ad_rwlock_t
 
	grwlock
;

106 
ASSERT_EQ
(
±h»ad_rwlock_š™
(&
rwlock
, 
nuÎ±r
), 0);

108 
ASSERT_EQ
(
rwlock
.
_wr™e_owÃr
, 
rwlock_
._write_owner);

109 
ASSERT_EQ
(
rwlock
.
_queue
.
_fœ¡
, 
rwlock_
._queue._first);

110 
ASSERT_EQ
(
rwlock
.
_lock
, 
rwlock_
._lock);

111 
ASSERT_EQ
(
rwlock
.
_»ad”_couÁ
, 
rwlock_
._reader_count);

114 
TEST_F
(
RwLockTe¡
, 
MªyTh»ads
) {

115 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

116 
ASYLO_ASSERT_OK
(
LaunchTh»ads
(
kNumTh»ads
, 
Th»adT¿mpŞše
, 
this
, &
th»ads
));

117 
LOG
(
INFO
) << "Threads†aunched";

119 
ASYLO_ASSERT_OK
(
JošTh»ads
(
th»ads
));

121 
LOG
(
INFO
) << "Threads joined";

123 
ASSERT_EQ
(
couÁ_
, 
kNumTh»ads
 * 
kCouÁsP”Th»ad
);

126 
TEST_F
(
RwLockTe¡
, 
MuÉËR—d”s
) {

128 
cÚ¡ex´
 
	gkNumR—d”s
 = 3;

129 
	gab¦
::
B¬r›r
 
»ad_b¬r›r
(
kNumR—d”s
);

131 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

132 
	gi
 = 0; i < 
	gkNumR—d”s
; ++i) {

133 
	gth»ads
.
em¶aû_back
([&]() {

134 
EXPECT_EQ
(
±h»ad_rwlock_rdlock
(&
rwlock_
), 0);

135 
»ad_b¬r›r
.
Block
();

136 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

140 autØ&
	gth»ad
 : 
th»ads
) {

141 
th»ad
.
još
();

144 
EXPECT_EQ
(
±h»ad_rwlock_w¾ock
(&
rwlock_
), 0);

145 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

146 
EXPECT_EQ
(
±h»ad_rwlock_de¡roy
(&
rwlock_
), 0);

	@test/misc/rwlock_test.cc

19 
	~<±h»ad.h
>

20 
	~<¡dio.h
>

21 
	~<c¡ršg
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/synchrÚiz©iÚ/b¬r›r.h
"

27 
	~"asylo/ut/loggšg.h
"

28 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

29 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

30 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

31 
	~"asylo/ut/¡©us.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
cÚ¡ex´
 
	gkNumTh»ads
 = 5;

38 
cÚ¡ex´
 
	gkCouÁsP”Th»ad
 = 500;

40 şas 
	cRwLockTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

41 
´Ùeùed
:

43 
CheckCouÁ”
() {

44 
ASSERT_GE
(
couÁ_
, 0) << "counter value out of bounds!";

45 
ASSERT_LE
(
couÁ_
, 
kCouÁsP”Th»ad
 * 
kNumTh»ads
)

49 
Th»adRoutše
() {

50 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; ++i) {

51 
EXPECT_EQ
(
±h»ad_rwlock_w¾ock
(&
rwlock_
), 0);

52 
CheckCouÁ”
();

53 
	gcouÁ”_cİy
 = 
couÁ_
;

54 
BusyWÜk
();

55 
	gcouÁ_
 = 
couÁ”_cİy
 + 1;

56 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

58 
EXPECT_EQ
(
±h»ad_rwlock_rdlock
(&
rwlock_
), 0);

59 
CheckCouÁ”
();

60 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

64 *
Th»adT¿mpŞše
(*
¬g
) {

65 
RwLockTe¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<RwLockTe¡ *>(
¬g
);

66 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Test…ointer is unexpectedly‚ull";

67 
	g‹¡
->
Th»adRoutše
();

68  
	gnuÎ±r
;

72 
±h»ad_rwlock_t
 
	grwlock_
 = 
PTHREAD_RWLOCK_INITIALIZER
;

74 vŞ©
ušt
 
	gcouÁ_
 = 0;

77 
TEST_F
(
RwLockTe¡
, 
Inv®idPoš‹rs
) {

81 
ASSERT_EQ
(
±h»ad_rwlock_š™
(
nuÎ±r
,‚ullptr), -1);

82 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

84 
ASSERT_EQ
(
±h»ad_rwlock_de¡roy
(
nuÎ±r
), -1);

85 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

87 
ASSERT_EQ
(
±h»ad_rwlock_Œyw¾ock
(
nuÎ±r
), -1);

88 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

90 
ASSERT_EQ
(
±h»ad_rwlock_w¾ock
(
nuÎ±r
), -1);

91 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

93 
ASSERT_EQ
(
±h»ad_rwlock_Œyrdlock
(
nuÎ±r
), -1);

94 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

96 
ASSERT_EQ
(
±h»ad_rwlock_rdlock
(
nuÎ±r
), -1);

97 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

99 
ASSERT_EQ
(
±h»ad_rwlock_uÆock
(
nuÎ±r
), -1);

100 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

103 
TEST_F
(
RwLockTe¡
, 
In™
) {

105 
±h»ad_rwlock_t
 
	grwlock
;

106 
ASSERT_EQ
(
±h»ad_rwlock_š™
(&
rwlock
, 
nuÎ±r
), 0);

108 
ASSERT_EQ
(
rwlock
.
_wr™e_owÃr
, 
rwlock_
._write_owner);

109 
ASSERT_EQ
(
rwlock
.
_queue
.
_fœ¡
, 
rwlock_
._queue._first);

110 
ASSERT_EQ
(
rwlock
.
_lock
, 
rwlock_
._lock);

111 
ASSERT_EQ
(
rwlock
.
_»ad”_couÁ
, 
rwlock_
._reader_count);

114 
TEST_F
(
RwLockTe¡
, 
MªyTh»ads
) {

115 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

116 
ASYLO_ASSERT_OK
(
LaunchTh»ads
(
kNumTh»ads
, 
Th»adT¿mpŞše
, 
this
, &
th»ads
));

117 
LOG
(
INFO
) << "Threads†aunched";

119 
ASYLO_ASSERT_OK
(
JošTh»ads
(
th»ads
));

121 
LOG
(
INFO
) << "Threads joined";

123 
ASSERT_EQ
(
couÁ_
, 
kNumTh»ads
 * 
kCouÁsP”Th»ad
);

126 
TEST_F
(
RwLockTe¡
, 
MuÉËR—d”s
) {

128 
cÚ¡ex´
 
	gkNumR—d”s
 = 3;

129 
	gab¦
::
B¬r›r
 
»ad_b¬r›r
(
kNumR—d”s
);

131 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

132 
	gi
 = 0; i < 
	gkNumR—d”s
; ++i) {

133 
	gth»ads
.
em¶aû_back
([&]() {

134 
EXPECT_EQ
(
±h»ad_rwlock_rdlock
(&
rwlock_
), 0);

135 
»ad_b¬r›r
.
Block
();

136 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

140 autØ&
	gth»ad
 : 
th»ads
) {

141 
th»ad
.
još
();

144 
EXPECT_EQ
(
±h»ad_rwlock_w¾ock
(&
rwlock_
), 0);

145 
EXPECT_EQ
(
±h»ad_rwlock_uÆock
(&
rwlock_
), 0);

146 
EXPECT_EQ
(
±h»ad_rwlock_de¡roy
(&
rwlock_
), 0);

	@test/misc/sem_test.cc

19 
	~<±h»ad.h
>

20 
	~<£m­hÜe.h
>

21 
	~<¡dio.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/ut/loggšg.h
"

26 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

27 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
	~"asylo/ut/¡©us.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
TEST
(
EnşaveSem
, 
Inv®idSemPoš‹r
) {

39 
ASSERT_EQ
(
£m_š™
(
nuÎ±r
, 0, 0), -1);

40 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

43 
ASSERT_EQ
(
£m_de¡roy
(
nuÎ±r
), -1);

44 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

47 
ASSERT_EQ
(
£m_po¡
(
nuÎ±r
), -1);

48 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

51 
ASSERT_EQ
(
£m_wa™
(
nuÎ±r
), -1);

52 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

55 
ASSERT_EQ
(
£m_wa™
(
nuÎ±r
), -1);

56 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

59 
time¥ec
 
	gts
;

60 
ASSERT_EQ
(
£m_timedwa™
(
nuÎ±r
, &
ts
), -1);

61 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

64 
	gv®ue
;

65 
ASSERT_EQ
(
£m_g‘v®ue
(
nuÎ±r
, &
v®ue
), -1);

66 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

67 
£m_t
 
	g£m
;

68 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, 
nuÎ±r
), -1);

69 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

72 
TEST
(
EnşaveSem
, 
Sh¬edNÙAÎowed
) {

74 
£m_t
 
	g£m
;

75 
ASSERT_EQ
(
£m_š™
(&
£m
, 1, 0), -1);

76 
ASSERT_EQ
(
”ºo
, 
ENOSYS
);

79 
TEST
(
EnşaveSem
, 
In™ŸlV®ue
) {

82 
£m_t
 
	g£m
;

83 
cÚ¡ex´
 
	gkIn™ŸlV®ue
 = 10;

84 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 
kIn™ŸlV®ue
), 0);

85 
	gv®ue
;

86 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

87 
ASSERT_EQ
(
v®ue
, 
kIn™ŸlV®ue
);

88 
	gi
 = 0; i < 
	gkIn™ŸlV®ue
; i++) {

89 
ASSERT_EQ
(
£m_wa™
(&
£m
), 0);

93 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

94 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

96 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

99 
TEST
(
EnşaveSem
, 
Po¡AndWa™
) {

101 
£m_t
 
	g£m
;

102 
£m_š™
(&
£m
, 0, 0);

104 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

105 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

106 
ASSERT_EQ
(
£m_wa™
(&
£m
), 0);

107 
ASSERT_EQ
(
£m_wa™
(&
£m
), 0);

110 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

111 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

114 
TEST
(
EnşaveSem
, 
TryWa™
) {

117 
£m_t
 
	g£m
;

118 
£m_š™
(&
£m
, 0, 0);

121 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

122 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

125 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

128 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), 0);

131 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

132 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

134 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

137 
TEST
(
EnşaveSem
, 
G‘V®ue
) {

139 
£m_t
 
	g£m
;

140 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 0), 0);

141 
	gv®ue
;

142 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

143 
ASSERT_EQ
(
v®ue
, 0);

146 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

147 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

148 
ASSERT_EQ
(
v®ue
, 1);

151 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), 0);

152 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

153 
ASSERT_EQ
(
v®ue
, 0);

155 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

162 
TimeoutTe¡
(
£m_t
 *
£m
) {

163 
cÚ¡ex´
 
	gkD—dlšeSecÚds
 = 3;

165 
time¥ec
 
	gd—dlše
;

166 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
d—dlše
), 0);

167 
	gd—dlše
.
	gtv_£c
 +ğ
kD—dlšeSecÚds
;

168 
LOG
(
INFO
) << "Goingo sleep";

169 
ASSERT_EQ
(
£m_timedwa™
(
£m
, &
d—dlše
), -1);

170 
ASSERT_EQ
(
”ºo
, 
ETIMEDOUT
);

171 
LOG
(
INFO
) << "Waking up";

174 
time¥ec
 
	gcu¼_time
, 
	g»suÉ
;

175 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
cu¼_time
), 0);

176 
ASSERT_TRUE
(
asylo
::
TimeS³cSubŒaù
(
d—dlše
, 
cu¼_time
, &
»suÉ
));

179 
TEST
(
EnşaveSem
, 
Timeout
) {

181 
£m_t
 
	g£m
;

182 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 0), 0);

183 
TimeoutTe¡
(&
£m
);

184 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

187 
TEST
(
EnşaveSem
, 
TimeoutW™hR—dySem·hÜe
) {

192 
£m_t
 
	g£m
;

193 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 1), 0);

197 
time¥ec
 
	gd—dlše
;

198 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
d—dlše
), 0);

199 
	gd—dlše
.
	gtv_£c
 -= 1;

200 
ASSERT_EQ
(
£m_timedwa™
(&
£m
, &
d—dlše
), 0);

204 
TimeoutTe¡
(&
£m
);

207 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

210 şas 
	cProduûrCÚsum”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

211 
´Ùeùed
:

213 
£m_t
 
£m
;

216 
cÚ¡ex´
 
	gkNumTh»ads
 = 4;

219 
cÚ¡ex´
 
	gkCouÁsP”Th»ad
 = 5000;

222 
CheckInv¬ŸÁs
() {

223 
	gcouÁ
;

224 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
couÁ
), 0);

225 
ASSERT_GE
(
couÁ
, 0) << "Sem value out of bounds!";

226 
ASSERT_LE
(
couÁ
, 
kCouÁsP”Th»ad
 * 
kNumTh»ads
)

233 
ProduûrRoutše
() {

234 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; ++i) {

235 
CheckInv¬ŸÁs
();

236 
£m_po¡
(&
£m
);

237 
BusyWÜk
();

241 *
ProduûrT¿mpŞše
(*
¬g
) {

242 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

243 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Test…ointer is unexpectedly‚ull";

244 
	g‹¡
->
ProduûrRoutše
();

245  
	gnuÎ±r
;

251 
CÚsum”Routše
() {

252 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; i++) {

253 
CheckInv¬ŸÁs
();

254 
£m_wa™
(&
£m
);

255 
BusyWÜk
();

259 *
CÚsum”T¿mpŞše
(*
¬g
) {

260 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

261 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Test…ointer is unexpectedly‚ull";

262 
	g‹¡
->
CÚsum”Routše
();

263  
	gnuÎ±r
;

267 
TEST_F
(
ProduûrCÚsum”Te¡
, 
ProduûrCÚsum”
) {

270 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 0), 0);

272 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

273 
ASSERT_THAT
(
LaunchTh»ads
(
kNumTh»ads
, 
ProduûrT¿mpŞše
, 
this
, &
th»ads
),

274 
IsOk
());

275 
LOG
(
INFO
) << "Producerhreads†aunched";

276 
ASSERT_THAT
(
LaunchTh»ads
(
kNumTh»ads
, 
CÚsum”T¿mpŞše
, 
this
, &
th»ads
),

277 
IsOk
());

278 
LOG
(
INFO
) << "Consumerhreads†aunched";

279 
ASSERT_THAT
(
JošTh»ads
(
th»ads
), 
IsOk
());

280 
LOG
(
INFO
) << "Threads joined";

282 
	gcouÁ
;

283 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
couÁ
), 0);

284 
ASSERT_EQ
(
couÁ
, 0);

	@test/misc/sem_test.cc

19 
	~<±h»ad.h
>

20 
	~<£m­hÜe.h
>

21 
	~<¡dio.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/ut/loggšg.h
"

26 
	~"asylo/¶©fÜm/commÚ/time_ut.h
"

27 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

28 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

29 
	~"asylo/ut/¡©us.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
TEST
(
EnşaveSem
, 
Inv®idSemPoš‹r
) {

39 
ASSERT_EQ
(
£m_š™
(
nuÎ±r
, 0, 0), -1);

40 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

43 
ASSERT_EQ
(
£m_de¡roy
(
nuÎ±r
), -1);

44 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

47 
ASSERT_EQ
(
£m_po¡
(
nuÎ±r
), -1);

48 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

51 
ASSERT_EQ
(
£m_wa™
(
nuÎ±r
), -1);

52 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

55 
ASSERT_EQ
(
£m_wa™
(
nuÎ±r
), -1);

56 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

59 
time¥ec
 
	gts
;

60 
ASSERT_EQ
(
£m_timedwa™
(
nuÎ±r
, &
ts
), -1);

61 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

64 
	gv®ue
;

65 
ASSERT_EQ
(
£m_g‘v®ue
(
nuÎ±r
, &
v®ue
), -1);

66 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

67 
£m_t
 
	g£m
;

68 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, 
nuÎ±r
), -1);

69 
ASSERT_EQ
(
”ºo
, 
EFAULT
);

72 
TEST
(
EnşaveSem
, 
Sh¬edNÙAÎowed
) {

74 
£m_t
 
	g£m
;

75 
ASSERT_EQ
(
£m_š™
(&
£m
, 1, 0), -1);

76 
ASSERT_EQ
(
”ºo
, 
ENOSYS
);

79 
TEST
(
EnşaveSem
, 
In™ŸlV®ue
) {

82 
£m_t
 
	g£m
;

83 
cÚ¡ex´
 
	gkIn™ŸlV®ue
 = 10;

84 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 
kIn™ŸlV®ue
), 0);

85 
	gv®ue
;

86 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

87 
ASSERT_EQ
(
v®ue
, 
kIn™ŸlV®ue
);

88 
	gi
 = 0; i < 
	gkIn™ŸlV®ue
; i++) {

89 
ASSERT_EQ
(
£m_wa™
(&
£m
), 0);

93 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

94 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

96 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

99 
TEST
(
EnşaveSem
, 
Po¡AndWa™
) {

101 
£m_t
 
	g£m
;

102 
£m_š™
(&
£m
, 0, 0);

104 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

105 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

106 
ASSERT_EQ
(
£m_wa™
(&
£m
), 0);

107 
ASSERT_EQ
(
£m_wa™
(&
£m
), 0);

110 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

111 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

114 
TEST
(
EnşaveSem
, 
TryWa™
) {

117 
£m_t
 
	g£m
;

118 
£m_š™
(&
£m
, 0, 0);

121 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

122 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

125 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

128 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), 0);

131 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), -1);

132 
ASSERT_EQ
(
”ºo
, 
EAGAIN
);

134 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

137 
TEST
(
EnşaveSem
, 
G‘V®ue
) {

139 
£m_t
 
	g£m
;

140 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 0), 0);

141 
	gv®ue
;

142 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

143 
ASSERT_EQ
(
v®ue
, 0);

146 
ASSERT_EQ
(
£m_po¡
(&
£m
), 0);

147 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

148 
ASSERT_EQ
(
v®ue
, 1);

151 
ASSERT_EQ
(
£m_Œywa™
(&
£m
), 0);

152 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
v®ue
), 0);

153 
ASSERT_EQ
(
v®ue
, 0);

155 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

162 
TimeoutTe¡
(
£m_t
 *
£m
) {

163 
cÚ¡ex´
 
	gkD—dlšeSecÚds
 = 3;

165 
time¥ec
 
	gd—dlše
;

166 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
d—dlše
), 0);

167 
	gd—dlše
.
	gtv_£c
 +ğ
kD—dlšeSecÚds
;

168 
LOG
(
INFO
) << "Goingo sleep";

169 
ASSERT_EQ
(
£m_timedwa™
(
£m
, &
d—dlše
), -1);

170 
ASSERT_EQ
(
”ºo
, 
ETIMEDOUT
);

171 
LOG
(
INFO
) << "Waking up";

174 
time¥ec
 
	gcu¼_time
, 
	g»suÉ
;

175 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
cu¼_time
), 0);

176 
ASSERT_TRUE
(
asylo
::
TimeS³cSubŒaù
(
d—dlše
, 
cu¼_time
, &
»suÉ
));

179 
TEST
(
EnşaveSem
, 
Timeout
) {

181 
£m_t
 
	g£m
;

182 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 0), 0);

183 
TimeoutTe¡
(&
£m
);

184 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

187 
TEST
(
EnşaveSem
, 
TimeoutW™hR—dySem·hÜe
) {

192 
£m_t
 
	g£m
;

193 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 1), 0);

197 
time¥ec
 
	gd—dlše
;

198 
ASSERT_EQ
(
şock_g‘time
(
CLOCK_REALTIME
, &
d—dlše
), 0);

199 
	gd—dlše
.
	gtv_£c
 -= 1;

200 
ASSERT_EQ
(
£m_timedwa™
(&
£m
, &
d—dlše
), 0);

204 
TimeoutTe¡
(&
£m
);

207 
ASSERT_EQ
(
£m_de¡roy
(&
£m
), 0);

210 şas 
	cProduûrCÚsum”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

211 
´Ùeùed
:

213 
£m_t
 
£m
;

216 
cÚ¡ex´
 
	gkNumTh»ads
 = 4;

219 
cÚ¡ex´
 
	gkCouÁsP”Th»ad
 = 5000;

222 
CheckInv¬ŸÁs
() {

223 
	gcouÁ
;

224 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
couÁ
), 0);

225 
ASSERT_GE
(
couÁ
, 0) << "Sem value out of bounds!";

226 
ASSERT_LE
(
couÁ
, 
kCouÁsP”Th»ad
 * 
kNumTh»ads
)

233 
ProduûrRoutše
() {

234 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; ++i) {

235 
CheckInv¬ŸÁs
();

236 
£m_po¡
(&
£m
);

237 
BusyWÜk
();

241 *
ProduûrT¿mpŞše
(*
¬g
) {

242 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

243 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Test…ointer is unexpectedly‚ull";

244 
	g‹¡
->
ProduûrRoutše
();

245  
	gnuÎ±r
;

251 
CÚsum”Routše
() {

252 
	gi
 = 0; i < 
	gkCouÁsP”Th»ad
; i++) {

253 
CheckInv¬ŸÁs
();

254 
£m_wa™
(&
£m
);

255 
BusyWÜk
();

259 *
CÚsum”T¿mpŞše
(*
¬g
) {

260 
ProduûrCÚsum”Te¡
 *
	g‹¡
 = 
¡©ic_ÿ¡
<ProduûrCÚsum”Te¡ *>(
¬g
);

261 
CHECK
(
‹¡
 !ğ
nuÎ±r
) << "Test…ointer is unexpectedly‚ull";

262 
	g‹¡
->
CÚsum”Routše
();

263  
	gnuÎ±r
;

267 
TEST_F
(
ProduûrCÚsum”Te¡
, 
ProduûrCÚsum”
) {

270 
ASSERT_EQ
(
£m_š™
(&
£m
, 0, 0), 0);

272 
	g¡d
::
veùÜ
<
±h»ad_t
> 
th»ads
;

273 
ASSERT_THAT
(
LaunchTh»ads
(
kNumTh»ads
, 
ProduûrT¿mpŞše
, 
this
, &
th»ads
),

274 
IsOk
());

275 
LOG
(
INFO
) << "Producerhreads†aunched";

276 
ASSERT_THAT
(
LaunchTh»ads
(
kNumTh»ads
, 
CÚsum”T¿mpŞše
, 
this
, &
th»ads
),

277 
IsOk
());

278 
LOG
(
INFO
) << "Consumerhreads†aunched";

279 
ASSERT_THAT
(
JošTh»ads
(
th»ads
), 
IsOk
());

280 
LOG
(
INFO
) << "Threads joined";

282 
	gcouÁ
;

283 
ASSERT_EQ
(
£m_g‘v®ue
(&
£m
, &
couÁ
), 0);

284 
ASSERT_EQ
(
couÁ
, 0);

	@test/misc/threaded_finalize.cc

19 
	~<±h»ad.h
>

20 
	~<uni¡d.h
>

22 
	~"asylo/’şave.pb.h
"

23 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

28 *
fš®iz”_funùiÚ
(*
¬g
è{  
	g¬g
; }

30 *
¦“pšg_fš®iz”_funùiÚ
(*
¬g
) {

31 
cÚ¡ex´
 
ušt
 
	gkSË•SecÚds
 = 5;

32 
¦“p
(
kSË•SecÚds
);

33  
	g¬g
;

37 şas 
	cTh»adedFš®ize
 : 
public
 
Tru¡edAµliÿtiÚ
 {

38 
public
:

39 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
šput
è
ov”ride
 {

40 
±h»ad_t
 
th»ad
;

41 
	g»t
 = 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
fš®iz”_funùiÚ
,‚ullptr);

42 ià(
	g»t
 != 0) {

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_create");

46 
	g»t
 = 
±h»ad_još
(
th»ad
, 
nuÎ±r
);

47 ià(
	g»t
 != 0) {

48  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_join");

51 
	g»t
 =

52 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
¦“pšg_fš®iz”_funùiÚ
,‚ullptr);

53 ià(
	g»t
 != 0) {

54  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_create");

57 
	g»t
 = 
±h»ad_d‘ach
(
th»ad
);

58 ià(
	g»t
 != 0) {

59  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_detach");

62  
	gStus
::
OkStus
();

66 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
	`Th»adedFš®ize
(); 
	}
}

	@test/misc/threaded_finalize.cc

19 
	~<±h»ad.h
>

20 
	~<uni¡d.h
>

22 
	~"asylo/’şave.pb.h
"

23 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

28 *
fš®iz”_funùiÚ
(*
¬g
è{  
	g¬g
; }

30 *
¦“pšg_fš®iz”_funùiÚ
(*
¬g
) {

31 
cÚ¡ex´
 
ušt
 
	gkSË•SecÚds
 = 5;

32 
¦“p
(
kSË•SecÚds
);

33  
	g¬g
;

37 şas 
	cTh»adedFš®ize
 : 
public
 
Tru¡edAµliÿtiÚ
 {

38 
public
:

39 
Stus
 
Fš®ize
(cÚ¡ 
EnşaveFš®
 &
šput
è
ov”ride
 {

40 
±h»ad_t
 
th»ad
;

41 
	g»t
 = 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
fš®iz”_funùiÚ
,‚ullptr);

42 ià(
	g»t
 != 0) {

43  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_create");

46 
	g»t
 = 
±h»ad_još
(
th»ad
, 
nuÎ±r
);

47 ià(
	g»t
 != 0) {

48  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_join");

51 
	g»t
 =

52 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
¦“pšg_fš®iz”_funùiÚ
,‚ullptr);

53 ià(
	g»t
 != 0) {

54  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_create");

57 
	g»t
 = 
±h»ad_d‘ach
(
th»ad
);

58 ià(
	g»t
 != 0) {

59  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "Unableo…thread_detach");

62  
	gStus
::
OkStus
();

66 
Tru¡edAµliÿtiÚ
 *
	$BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
	`Th»adedFš®ize
(); 
	}
}

	@test/misc/threaded_test.cc

19 
	~<±h»ad.h
>

21 
	~<c¡dio
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
±h»ad_mu‹x_t
 
	gcouÁ_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

34 vŞ©
	gcouÁ
 = 0;

35 
	gglob®_¬g
 = 1;

37 
±h»ad_Úû_t
 
	gÚû
 = 
PTHREAD_ONCE_INIT
;

38 vŞ©
	gÚû_couÁ
 = 0;

40 
Úû_funùiÚ
(è{ ++
	gÚû_couÁ
; }

42 *
šüem’t_couÁ
(*
¬g
) {

43 
´štf
("£lf: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
±h»ad_£lf
()));

44 ià(!
	g¬g
 ||‡rg !ğ&
glob®_¬g
) {

45 
´štf
("arg ==‚ullptr ||‡rg != &global_arg\n");

46  
	gnuÎ±r
;

49 
	g»t
 = 
±h»ad_Úû
(&
Úû
, &
Úû_funùiÚ
);

50 ià(
	g»t
) {

51 
´štf
("±h»ad_Úû: %u\n", 
»t
);

52  
	gnuÎ±r
;

55 
´štf
("increment_count\n");

56 
±h»ad_mu‹x_lock
(&
couÁ_lock
);

57 ++
	gcouÁ
;

58 
±h»ad_mu‹x_uÆock
(&
couÁ_lock
);

59  
	g¬g
;

62 *
d‘achabË_funùiÚ
(*
¬g
) {

63 
´štf
("£lf: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
±h»ad_£lf
()));

64 ià(!
	g¬g
 ||‡rg !ğ&
glob®_¬g
) {

65 
´štf
("arg ==‚ullptr ||‡rg != &global_arg\n");

66  
	gnuÎ±r
;

68  
	g¬g
;

71 *
th»ad_¥ecific_funùiÚ
(*
¬g
) {

74 
±h»ad_key_t
 
	gs_key
;

75 ià(
	g¬g
 !ğ
nuÎ±r
) {

76 
s_key
 = *
¡©ic_ÿ¡
<
±h»ad_key_t
 *>(
¬g
);

78 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key
, 
nuÎ±r
), 0);

80 
	gab¦
::
Mu‹x
 
u£d_key_mu‹x
;

81 
	gab¦
::
æ©_hash_£t
<
±h»ad_key_t
> 
u£d_keys
;

82 
	gab¦
::
Mu‹xLock
 
u£d_key_lock
(&
u£d_key_mu‹x
);

83 
EXPECT_EQ
(
u£d_keys
.
fšd
(
s_key
), u£d_keys.
’d
());

84 
	gu£d_keys
.
š£¹
(
s_key
);

88 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), 
nuÎ±r
);

90 
	gu£d_fÜ_add»ss
;

91 
±h»ad_£t¥ecific
(
s_key
, &
u£d_fÜ_add»ss
);

92 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), &
u£d_fÜ_add»ss
);

95 vŞ©
	gcc11_couÁ
 = 0;

96 
	gab¦
::
Mu‹x
 
cc11_mu‹x
;

98 
cc11_šüem’t_couÁ
() {

99 
	gab¦
::
Mu‹xLock
 
lock
(&
cc11_mu‹x
);

100 ++
	gcc11_couÁ
;

103 
TEST
(
Th»adedTe¡
, 
Th»adKeys
) {

104 
±h»ad_key_t
 
	gs_key
, 
	gs_key2
;

107 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key
, 
nuÎ±r
), 0);

108 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key2
, 
nuÎ±r
), 0);

111 
EXPECT_NE
(
s_key
, 
s_key2
);

114 
EXPECT_EQ
(
±h»ad_key_d–‘e
(
s_key
), 0);

115 
EXPECT_EQ
(
±h»ad_key_d–‘e
(
s_key2
), 0);

118 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key2
, 
nuÎ±r
), 0);

119 
EXPECT_EQ
(
s_key2
, 
s_key
);

122 
EXPECT_EQ
(
±h»ad_key_d–‘e
(
s_key2
), 0);

127 
TEST
(
Th»adedTe¡
, 
EnşaveTh»ad
) {

128 
´štf
("Initialize: begin\n");

130 
´štf
("£lf: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
±h»ad_£lf
()));

132 
±h»ad_t
 
	gth»ad
;

133 
´štf
("abouto createhread\n");

134 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
šüem’t_couÁ
, &
glob®_¬g
), 0);

135 
´štf
("chd: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
th»ad
));

137 
ASSERT_EQ
(
±h»ad_Úû
(&
Úû
, &
Úû_funùiÚ
), 0);

139 *
	g»t_v®
;

140 
ASSERT_EQ
(
±h»ad_još
(
th»ad
, &
»t_v®
), 0);

141 
ASSERT_NE
(
»t_v®
, 
nuÎ±r
);

142 
ASSERT_EQ
(
»t_v®
, &
glob®_¬g
);

144 
±h»ad_mu‹x_lock
(&
couÁ_lock
);

145 
ASSERT_EQ
(
couÁ
, 1);

147 
±h»ad_mu‹x_uÆock
(&
couÁ_lock
);

148 
ASSERT_EQ
(
Úû_couÁ
, 1);

150 
	g¡d
::
th»ad
 
t
(
cc11_šüem’t_couÁ
);

151 
	gt
.
još
();

153 
	gab¦
::
Mu‹xLock
 
lock
(&
cc11_mu‹x
);

154 ià(
	gcc11_couÁ
 != 1) {

155 
´štf
("cc11_couÁ =ğ%i, wª‹d %i\n", 
Úû_couÁ
, 1);

160 
TEST
(
Th»adedTe¡
, 
D‘achedTh»ad
) {

161 
±h»ad_t
 
	gth»ad
;

162 
±h»ad_©Œ_t
 
	g©Œ
;

163 
ASSERT_EQ
(
±h»ad_©Œ_š™
(&
©Œ
), 0);

164 
ASSERT_EQ
(
±h»ad_©Œ_£td‘ach¡©e
(&
©Œ
, 
PTHREAD_CREATE_DETACHED
), 0);

165 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ad
, &
©Œ
, 
d‘achabË_funùiÚ
, &
glob®_¬g
),

168 
EXPECT_EQ
(
±h»ad_©Œ_de¡roy
(&
©Œ
), 0);

170 
EXPECT_NE
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

171 
EXPECT_NE
(
±h»ad_d‘ach
(
th»ad
), 0);

174 
TEST
(
Th»adedTe¡
, 
D‘achTh»ad
) {

175 
±h»ad_t
 
	gth»ad
;

176 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
d‘achabË_funùiÚ
, &
glob®_¬g
),

179 
EXPECT_EQ
(
±h»ad_d‘ach
(
th»ad
), 0);

180 
EXPECT_NE
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

183 
TEST
(
Th»adedTe¡
, 
Th»adS³cific
) {

184 
±h»ad_key_t
 
	gs_key
;

185 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key
, 
nuÎ±r
), 0);

188 
	gu£d_fÜ_add»ss
;

189 
±h»ad_£t¥ecific
(
s_key
, &
u£d_fÜ_add»ss
);

190 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), &
u£d_fÜ_add»ss
);

193 
±h»ad_t
 
	gth»ad
;

194 
ASSERT_EQ
(

195 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
th»ad_¥ecific_funùiÚ
, &
s_key
), 0);

196 
EXPECT_EQ
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

199 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), &
u£d_fÜ_add»ss
);

202 
cÚ¡ex´
 
	gkNumTh»ads
 = 10;

203 
	gab¦
::
æ©_hash_£t
<
±h»ad_t
> 
¥awÃd_th»ads
;

204 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

205 
±h»ad_t
 
	gth»ad
;

206 
ASSERT_EQ
(

207 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
th»ad_¥ecific_funùiÚ
,‚ullptr), 0);

208 
	g¥awÃd_th»ads
.
š£¹
(
th»ad
);

212 
±h»ad_t
 
	gth»ad
 : 
¥awÃd_th»ads
) {

213 
EXPECT_EQ
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

	@test/misc/threaded_test.cc

19 
	~<±h»ad.h
>

21 
	~<c¡dio
>

22 
	~<th»ad
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
±h»ad_mu‹x_t
 
	gcouÁ_lock
 = 
PTHREAD_MUTEX_INITIALIZER
;

34 vŞ©
	gcouÁ
 = 0;

35 
	gglob®_¬g
 = 1;

37 
±h»ad_Úû_t
 
	gÚû
 = 
PTHREAD_ONCE_INIT
;

38 vŞ©
	gÚû_couÁ
 = 0;

40 
Úû_funùiÚ
(è{ ++
	gÚû_couÁ
; }

42 *
šüem’t_couÁ
(*
¬g
) {

43 
´štf
("£lf: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
±h»ad_£lf
()));

44 ià(!
	g¬g
 ||‡rg !ğ&
glob®_¬g
) {

45 
´štf
("arg ==‚ullptr ||‡rg != &global_arg\n");

46  
	gnuÎ±r
;

49 
	g»t
 = 
±h»ad_Úû
(&
Úû
, &
Úû_funùiÚ
);

50 ià(
	g»t
) {

51 
´štf
("±h»ad_Úû: %u\n", 
»t
);

52  
	gnuÎ±r
;

55 
´štf
("increment_count\n");

56 
±h»ad_mu‹x_lock
(&
couÁ_lock
);

57 ++
	gcouÁ
;

58 
±h»ad_mu‹x_uÆock
(&
couÁ_lock
);

59  
	g¬g
;

62 *
d‘achabË_funùiÚ
(*
¬g
) {

63 
´štf
("£lf: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
±h»ad_£lf
()));

64 ià(!
	g¬g
 ||‡rg !ğ&
glob®_¬g
) {

65 
´štf
("arg ==‚ullptr ||‡rg != &global_arg\n");

66  
	gnuÎ±r
;

68  
	g¬g
;

71 *
th»ad_¥ecific_funùiÚ
(*
¬g
) {

74 
±h»ad_key_t
 
	gs_key
;

75 ià(
	g¬g
 !ğ
nuÎ±r
) {

76 
s_key
 = *
¡©ic_ÿ¡
<
±h»ad_key_t
 *>(
¬g
);

78 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key
, 
nuÎ±r
), 0);

80 
	gab¦
::
Mu‹x
 
u£d_key_mu‹x
;

81 
	gab¦
::
æ©_hash_£t
<
±h»ad_key_t
> 
u£d_keys
;

82 
	gab¦
::
Mu‹xLock
 
u£d_key_lock
(&
u£d_key_mu‹x
);

83 
EXPECT_EQ
(
u£d_keys
.
fšd
(
s_key
), u£d_keys.
’d
());

84 
	gu£d_keys
.
š£¹
(
s_key
);

88 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), 
nuÎ±r
);

90 
	gu£d_fÜ_add»ss
;

91 
±h»ad_£t¥ecific
(
s_key
, &
u£d_fÜ_add»ss
);

92 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), &
u£d_fÜ_add»ss
);

95 vŞ©
	gcc11_couÁ
 = 0;

96 
	gab¦
::
Mu‹x
 
cc11_mu‹x
;

98 
cc11_šüem’t_couÁ
() {

99 
	gab¦
::
Mu‹xLock
 
lock
(&
cc11_mu‹x
);

100 ++
	gcc11_couÁ
;

103 
TEST
(
Th»adedTe¡
, 
Th»adKeys
) {

104 
±h»ad_key_t
 
	gs_key
, 
	gs_key2
;

107 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key
, 
nuÎ±r
), 0);

108 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key2
, 
nuÎ±r
), 0);

111 
EXPECT_NE
(
s_key
, 
s_key2
);

114 
EXPECT_EQ
(
±h»ad_key_d–‘e
(
s_key
), 0);

115 
EXPECT_EQ
(
±h»ad_key_d–‘e
(
s_key2
), 0);

118 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key2
, 
nuÎ±r
), 0);

119 
EXPECT_EQ
(
s_key2
, 
s_key
);

122 
EXPECT_EQ
(
±h»ad_key_d–‘e
(
s_key2
), 0);

127 
TEST
(
Th»adedTe¡
, 
EnşaveTh»ad
) {

128 
´štf
("Initialize: begin\n");

130 
´štf
("£lf: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
±h»ad_£lf
()));

132 
±h»ad_t
 
	gth»ad
;

133 
´štf
("abouto createhread\n");

134 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
šüem’t_couÁ
, &
glob®_¬g
), 0);

135 
´štf
("chd: %lu\n", 
»š‹½»t_ÿ¡
<
ušt64_t
>(
th»ad
));

137 
ASSERT_EQ
(
±h»ad_Úû
(&
Úû
, &
Úû_funùiÚ
), 0);

139 *
	g»t_v®
;

140 
ASSERT_EQ
(
±h»ad_još
(
th»ad
, &
»t_v®
), 0);

141 
ASSERT_NE
(
»t_v®
, 
nuÎ±r
);

142 
ASSERT_EQ
(
»t_v®
, &
glob®_¬g
);

144 
±h»ad_mu‹x_lock
(&
couÁ_lock
);

145 
ASSERT_EQ
(
couÁ
, 1);

147 
±h»ad_mu‹x_uÆock
(&
couÁ_lock
);

148 
ASSERT_EQ
(
Úû_couÁ
, 1);

150 
	g¡d
::
th»ad
 
t
(
cc11_šüem’t_couÁ
);

151 
	gt
.
još
();

153 
	gab¦
::
Mu‹xLock
 
lock
(&
cc11_mu‹x
);

154 ià(
	gcc11_couÁ
 != 1) {

155 
´štf
("cc11_couÁ =ğ%i, wª‹d %i\n", 
Úû_couÁ
, 1);

160 
TEST
(
Th»adedTe¡
, 
D‘achedTh»ad
) {

161 
±h»ad_t
 
	gth»ad
;

162 
±h»ad_©Œ_t
 
	g©Œ
;

163 
ASSERT_EQ
(
±h»ad_©Œ_š™
(&
©Œ
), 0);

164 
ASSERT_EQ
(
±h»ad_©Œ_£td‘ach¡©e
(&
©Œ
, 
PTHREAD_CREATE_DETACHED
), 0);

165 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ad
, &
©Œ
, 
d‘achabË_funùiÚ
, &
glob®_¬g
),

168 
EXPECT_EQ
(
±h»ad_©Œ_de¡roy
(&
©Œ
), 0);

170 
EXPECT_NE
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

171 
EXPECT_NE
(
±h»ad_d‘ach
(
th»ad
), 0);

174 
TEST
(
Th»adedTe¡
, 
D‘achTh»ad
) {

175 
±h»ad_t
 
	gth»ad
;

176 
ASSERT_EQ
(
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
d‘achabË_funùiÚ
, &
glob®_¬g
),

179 
EXPECT_EQ
(
±h»ad_d‘ach
(
th»ad
), 0);

180 
EXPECT_NE
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

183 
TEST
(
Th»adedTe¡
, 
Th»adS³cific
) {

184 
±h»ad_key_t
 
	gs_key
;

185 
EXPECT_EQ
(
±h»ad_key_ü—‹
(&
s_key
, 
nuÎ±r
), 0);

188 
	gu£d_fÜ_add»ss
;

189 
±h»ad_£t¥ecific
(
s_key
, &
u£d_fÜ_add»ss
);

190 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), &
u£d_fÜ_add»ss
);

193 
±h»ad_t
 
	gth»ad
;

194 
ASSERT_EQ
(

195 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
th»ad_¥ecific_funùiÚ
, &
s_key
), 0);

196 
EXPECT_EQ
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

199 
EXPECT_EQ
(
±h»ad_g‘¥ecific
(
s_key
), &
u£d_fÜ_add»ss
);

202 
cÚ¡ex´
 
	gkNumTh»ads
 = 10;

203 
	gab¦
::
æ©_hash_£t
<
±h»ad_t
> 
¥awÃd_th»ads
;

204 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

205 
±h»ad_t
 
	gth»ad
;

206 
ASSERT_EQ
(

207 
±h»ad_ü—‹
(&
th»ad
, 
nuÎ±r
, 
th»ad_¥ecific_funùiÚ
,‚ullptr), 0);

208 
	g¥awÃd_th»ads
.
š£¹
(
th»ad
);

212 
±h»ad_t
 
	gth»ad
 : 
¥awÃd_th»ads
) {

213 
EXPECT_EQ
(
±h»ad_još
(
th»ad
, 
nuÎ±r
), 0);

	@test/util/do_nothing_enclave.cc

19 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
	gTru¡edAµliÿtiÚ
; }

	@test/util/do_nothing_enclave.cc

19 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
Tru¡edAµliÿtiÚ
 *
BudTru¡edAµliÿtiÚ
(è{  
Ãw
 
	gTru¡edAµliÿtiÚ
; }

	@test/util/enclave_assertion_authority_configs.cc

19 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/id’t™y/desütiÚs.h
"

23 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

24 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
Çme¥aû
 
	gasylo
 {

29 cÚ¡ 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

31 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
() {

32 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
	g‹¡_cÚfig
;

33 
S‘NuÎAs£¹iÚDesütiÚ
(
‹¡_cÚfig
.
mubË_desütiÚ
());

35  
	g‹¡_cÚfig
;

38 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
() {

39 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
	g‹¡_cÚfig
;

40 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(
‹¡_cÚfig
.
mubË_desütiÚ
());

42 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gcÚfig
;

43 
	gcÚfig
.
£t_©‹¡©iÚ_domaš
(
kA‰e¡©iÚDomaš
);

44 
CHECK
(
cÚfig
.
S”ŸlizeToSŒšg
(
‹¡_cÚfig
.
mubË_cÚfig
()));

46  
	g‹¡_cÚfig
;

	@test/util/enclave_assertion_authority_configs.cc

19 
	~"asylo/‹¡/ut/’şave_as£¹iÚ_authÜ™y_cÚfigs.h
"

21 
	~"asylo/ut/loggšg.h
"

22 
	~"asylo/id’t™y/desütiÚs.h
"

23 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

24 
	~"asylo/id’t™y/sgx/sgx_loÿl_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

26 
Çme¥aû
 
	gasylo
 {

29 cÚ¡ 
	gkA‰e¡©iÚDomaš
[] = "A 16-byte string";

31 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
() {

32 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
	g‹¡_cÚfig
;

33 
S‘NuÎAs£¹iÚDesütiÚ
(
‹¡_cÚfig
.
mubË_desütiÚ
());

35  
	g‹¡_cÚfig
;

38 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
() {

39 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
	g‹¡_cÚfig
;

40 
S‘SgxLoÿlAs£¹iÚDesütiÚ
(
‹¡_cÚfig
.
mubË_desütiÚ
());

42 
SgxLoÿlAs£¹iÚAuthÜ™yCÚfig
 
	gcÚfig
;

43 
	gcÚfig
.
£t_©‹¡©iÚ_domaš
(
kA‰e¡©iÚDomaš
);

44 
CHECK
(
cÚfig
.
S”ŸlizeToSŒšg
(
‹¡_cÚfig
.
mubË_cÚfig
()));

46  
	g‹¡_cÚfig
;

	@test/util/enclave_assertion_authority_configs.h

19 #iâdeà
ASYLO_TEST_UTIL_ENCLAVE_ASSERTION_AUTHORITY_CONFIGS_H_


20 
	#ASYLO_TEST_UTIL_ENCLAVE_ASSERTION_AUTHORITY_CONFIGS_H_


	)

22 
	~"asylo/id’t™y/’şave_as£¹iÚ_authÜ™y_cÚfig.pb.h
"

24 
Çme¥aû
 
	gasylo
 {

49 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
G‘NuÎAs£¹iÚAuthÜ™yTe¡CÚfig
();

52 
EnşaveAs£¹iÚAuthÜ™yCÚfig
 
G‘SgxLoÿlAs£¹iÚAuthÜ™yTe¡CÚfig
();

	@test/util/enclave_test.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/’şave.pb.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
	~"asylo/‹¡/ut/‹¡_æags.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclave");

29 
Çme¥aû
 
	gasylo
 {

31 
	gEnşaveTe¡
::
S‘UpBa£
() {

32 ià(!
FLAGS_‹¡_tmpdœ
.
em±y
()) {

33 
LoggšgCÚfig
 *
loggšg_cÚfig
 = 
cÚfig_
.
mubË_loggšg_cÚfig
();

34 
	gloggšg_cÚfig
->
£t_log_dœeùÜy
(
FLAGS_‹¡_tmpdœ
);

36 
ASYLO_ASSERT_OK
(

37 
‹¡_Ïunch”_
.
S‘Up
(
FLAGS_’şave_·th
, 
cÚfig_
, 
’şave_u¾_
));

38 
	gş›Á_
 = 
‹¡_Ïunch”_
.
mubË_ş›Á
();

41 
	gEnşaveTe¡
::
T—rDownBa£
(
boŞ
 
sk_fš®ize
) {

42 
EnşaveFš®
 
efš®
;

43 
ASYLO_ASSERT_OK
(
‹¡_Ïunch”_
.
T—rDown
(
efš®
, 
sk_fš®ize
));

46 
	gEnşaveTe¡
::
»dœeù_¡dš
() {

47 
fds
[2];

48 
CHECK_EQ
(
pe
(
fds
), 0);

49 
£t_¡dš
(
fds
[0]);

50  
	gfds
[1];

53 
	gEnşaveTe¡
::
»dœeù_¡dout
() {

54 
fds
[2];

55 
CHECK_EQ
(
pe
(
fds
), 0);

56 
£t_¡dout
(
fds
[1]);

57  
	gfds
[0];

60 
	gEnşaveTe¡
::
»dœeù_¡d”r
() {

61 
fds
[2];

62 
CHECK_EQ
(
pe
(
fds
), 0);

63 
£t_¡d”r
(
fds
[1]);

64  
	gfds
[0];

	@test/util/enclave_test.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡.h
"

21 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/’şave.pb.h
"

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

25 
	~"asylo/‹¡/ut/‹¡_æags.h
"

27 
DEFINE_¡ršg
(
’şave_·th
, "", "Pathoƒnclave");

29 
Çme¥aû
 
	gasylo
 {

31 
	gEnşaveTe¡
::
S‘UpBa£
() {

32 ià(!
FLAGS_‹¡_tmpdœ
.
em±y
()) {

33 
LoggšgCÚfig
 *
loggšg_cÚfig
 = 
cÚfig_
.
mubË_loggšg_cÚfig
();

34 
	gloggšg_cÚfig
->
£t_log_dœeùÜy
(
FLAGS_‹¡_tmpdœ
);

36 
ASYLO_ASSERT_OK
(

37 
‹¡_Ïunch”_
.
S‘Up
(
FLAGS_’şave_·th
, 
cÚfig_
, 
’şave_u¾_
));

38 
	gş›Á_
 = 
‹¡_Ïunch”_
.
mubË_ş›Á
();

41 
	gEnşaveTe¡
::
T—rDownBa£
(
boŞ
 
sk_fš®ize
) {

42 
EnşaveFš®
 
efš®
;

43 
ASYLO_ASSERT_OK
(
‹¡_Ïunch”_
.
T—rDown
(
efš®
, 
sk_fš®ize
));

46 
	gEnşaveTe¡
::
»dœeù_¡dš
() {

47 
fds
[2];

48 
CHECK_EQ
(
pe
(
fds
), 0);

49 
£t_¡dš
(
fds
[0]);

50  
	gfds
[1];

53 
	gEnşaveTe¡
::
»dœeù_¡dout
() {

54 
fds
[2];

55 
CHECK_EQ
(
pe
(
fds
), 0);

56 
£t_¡dout
(
fds
[1]);

57  
	gfds
[0];

60 
	gEnşaveTe¡
::
»dœeù_¡d”r
() {

61 
fds
[2];

62 
CHECK_EQ
(
pe
(
fds
), 0);

63 
£t_¡d”r
(
fds
[1]);

64  
	gfds
[0];

	@test/util/enclave_test.h

19 #iâdeà
ASYLO_TEST_UTIL_ENCLAVE_TEST_H_


20 
	#ASYLO_TEST_UTIL_ENCLAVE_TEST_H_


	)

22 
	~<memÜy
>

23 
	~<¡ršg
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"gæags/gæags.h
"

27 
	~"asylo/‹¡/ut/’şave_‹¡_Ïunch”.h
"

28 
	~"asylo/‹¡/ut/‹¡_æags.h
"

29 
	~"asylo/ut/¡©us.h
"

31 
DECLARE_¡ršg
(
’şave_·th
);

33 
Çme¥aû
 
	gasylo
 {

37 şas 
	cEnşaveTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

38 
public
:

39 
S‘Up
(è
ov”ride
 { 
S‘UpBa£
(); }

41 
T—rDown
(è
	gov”ride
 { 
T—rDownBa£
(); }

43 
	g´Ùeùed
:

46 
S‘UpBa£
();

50 
T—rDownBa£
(
boŞ
 
sk_fš®ize
 = 
çl£
);

53 
£t_¡dš
(
fd
è{ 
	gcÚfig_
.
£t_¡dš_fd
(fd); }

56 
£t_¡dout
(
fd
è{ 
	gcÚfig_
.
£t_¡dout_fd
(fd); }

59 
£t_¡d”r
(
fd
è{ 
	gcÚfig_
.
£t_¡d”r_fd
(fd); }

63 
»dœeù_¡dš
();

67 
»dœeù_¡dout
();

71 
»dœeù_¡d”r
();

74 
S‘EnşaveIÅutTe¡SŒšg
(
EnşaveIÅut
 *
’şave_šput
,

75 cÚ¡ 
¡d
::
¡ršg
 &
¡r_‹¡
) {

76 
EnşaveTe¡Launch”
::
S‘EnşaveIÅutTe¡SŒšg
(
’şave_šput
, 
¡r_‹¡
);

80 cÚ¡ 
	g¡d
::
¡ršg
 
G‘EnşaveOuutTe¡SŒšg
(cÚ¡ 
EnşaveOuut
 &
ouut
) {

81  
EnşaveTe¡Launch”
::
G‘EnşaveOuutTe¡SŒšg
(
ouut
);

84 
	g´Ùeùed
:

85 
¡d
::
¡ršg
 
’şave_u¾_
;

87 
EnşaveCl›Á
 *
	gş›Á_
;

88 
EnşaveCÚfig
 
	gcÚfig_
;

89 
EnşaveTe¡Launch”
 
	g‹¡_Ïunch”_
;

	@test/util/enclave_test_application.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

20 
	~"asylo/‹¡/ut/‹¡_¡ršg.pb.h
"

22 
Çme¥aû
 
	gasylo
 {

24 
	gEnşaveTe¡Ca£
::
S‘EnşaveOuutTe¡SŒšg
(
EnşaveOuut
 *
’şave_ouut
,

25 cÚ¡ 
¡d
::
¡ršg
 &
¡r_‹¡
) {

26 
’şave_ouut
->
MubËEx‹nsiÚ
(
’şave_ouut_‹¡_¡ršg
)

27 ->
£t_‹¡_¡ršg
(
¡r_‹¡
);

30 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Ca£
::
G‘EnşaveCÚfigTe¡SŒšg
(

31 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

32  
cÚfig
.
G‘Ex‹nsiÚ
(
’şave_cÚfig_‹¡_¡ršg
).
‹¡_¡ršg
();

35 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Ca£
::
G‘EnşaveIÅutTe¡SŒšg
(

36 cÚ¡ 
EnşaveIÅut
 &
šput
) {

37  
šput
.
G‘Ex‹nsiÚ
(
’şave_šput_‹¡_¡ršg
).
‹¡_¡ršg
();

40 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Ca£
::
G‘EnşaveFš®Te¡SŒšg
(

41 cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

42  
fš®_šput
.
G‘Ex‹nsiÚ
(
’şave_fš®_‹¡_¡ršg
).
‹¡_¡ršg
();

	@test/util/enclave_test_application.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡_­¶iÿtiÚ.h
"

20 
	~"asylo/‹¡/ut/‹¡_¡ršg.pb.h
"

22 
Çme¥aû
 
	gasylo
 {

24 
	gEnşaveTe¡Ca£
::
S‘EnşaveOuutTe¡SŒšg
(
EnşaveOuut
 *
’şave_ouut
,

25 cÚ¡ 
¡d
::
¡ršg
 &
¡r_‹¡
) {

26 
’şave_ouut
->
MubËEx‹nsiÚ
(
’şave_ouut_‹¡_¡ršg
)

27 ->
£t_‹¡_¡ršg
(
¡r_‹¡
);

30 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Ca£
::
G‘EnşaveCÚfigTe¡SŒšg
(

31 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) {

32  
cÚfig
.
G‘Ex‹nsiÚ
(
’şave_cÚfig_‹¡_¡ršg
).
‹¡_¡ršg
();

35 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Ca£
::
G‘EnşaveIÅutTe¡SŒšg
(

36 cÚ¡ 
EnşaveIÅut
 &
šput
) {

37  
šput
.
G‘Ex‹nsiÚ
(
’şave_šput_‹¡_¡ršg
).
‹¡_¡ršg
();

40 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Ca£
::
G‘EnşaveFš®Te¡SŒšg
(

41 cÚ¡ 
EnşaveFš®
 &
fš®_šput
) {

42  
fš®_šput
.
G‘Ex‹nsiÚ
(
’şave_fš®_‹¡_¡ršg
).
‹¡_¡ršg
();

	@test/util/enclave_test_application.h

19 #iâdeà
ASYLO_TEST_UTIL_ENCLAVE_TEST_APPLICATION_H_


20 
	#ASYLO_TEST_UTIL_ENCLAVE_TEST_APPLICATION_H_


	)

22 
	~"asylo/’şave.pb.h
"

23 
	~"asylo/Œu¡ed_­¶iÿtiÚ.h
"

25 
Çme¥aû
 
	gasylo
 {

27 şas 
	cEnşaveTe¡Ca£
 : 
public
 
Tru¡edAµliÿtiÚ
 {

28 
public
:

30 
S‘EnşaveOuutTe¡SŒšg
(
EnşaveOuut
 *
’şave_ouut
,

31 cÚ¡ 
¡d
::
¡ršg
 &
¡r_‹¡
);

34 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveCÚfigTe¡SŒšg
(cÚ¡ 
EnşaveCÚfig
 &
cÚfig
);

37 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveIÅutTe¡SŒšg
(cÚ¡ 
EnşaveIÅut
 &
šput
);

40 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveFš®Te¡SŒšg
(cÚ¡ 
EnşaveFš®
 &
fš®_šput
);

	@test/util/enclave_test_launcher.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡_Ïunch”.h
"

21 
	~<sys/¡©.h
>

22 
	~<sys/ty³s.h
>

23 
	~<uni¡d.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/‹¡/ut/‹¡_¡ršg.pb.h
"

28 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

33 
	gEnşaveTe¡Launch”
::
EnşaveTe¡Launch”
()

34 : 
mªag”_
(
nuÎ±r
), 
ş›Á_
ÒuÎ±r), 
lßd”_
(nullptr) {}

36 
Stus
 
	gEnşaveTe¡Launch”
::
S‘Up
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
,

37 cÚ¡ 
EnşaveCÚfig
 &
ecÚfig
,

38 cÚ¡ 
¡d
::
¡ršg
 &
’şave_u¾
) {

39 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

40 
ASYLO_ASSIGN_OR_RETURN
(
mªag”_
, 
EnşaveMªag”
::
In¡ªû
());

42 
	glßd”_
 = 
ab¦
::
make_unique
<
SgxLßd”
>(
’şave_·th
, 
	gŒue
);

43 
ASYLO_RETURN_IF_ERROR
(
mªag”_
->
LßdEnşave
(
’şave_u¾
, *
lßd”_
, 
ecÚfig
));

45 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
(
’şave_u¾
);

46 ià(!
	gş›Á_
) {

47 
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_ENOENT
, "Client is‚ull");

48 
LOG
(
ERROR
è<< "S‘U°çed:" << 
	g¡©us
;

49  
	g¡©us
;

51  
	gStus
::
OkStus
();

54 
Stus
 
	gEnşaveTe¡Launch”
::
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
,

55 
EnşaveOuut
 *
ouut
) {

56 ià(!
	gş›Á_
) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

60  
	gş›Á_
->
EÁ”AndRun
(
šput
, 
ouut
);

63 
Stus
 
	gEnşaveTe¡Launch”
::
T—rDown
(cÚ¡ 
EnşaveFš®
 &
efš®
,

64 
boŞ
 
skT—rDown
) {

65 ià(!
	gş›Á_
) {

66  
	gStus
::
OkStus
();

68 ià(!
	gmªag”_
) {

69 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

70 
ASYLO_ASSIGN_OR_RETURN
(
mªag”_
, 
EnşaveMªag”
::
In¡ªû
());

72  
	gmªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
, 
skT—rDown
);

75 
	gEnşaveTe¡Launch”
::
S‘EnşaveIÅutTe¡SŒšg
(

76 
EnşaveIÅut
 *
’şave_šput
, cÚ¡ 
¡d
::
¡ršg
 &
¡r_‹¡
) {

77 
’şave_šput
->
MubËEx‹nsiÚ
(
’şave_šput_‹¡_¡ršg
)

78 ->
£t_‹¡_¡ršg
(
¡r_‹¡
);

81 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Launch”
::
G‘EnşaveOuutTe¡SŒšg
(

82 cÚ¡ 
EnşaveOuut
 &
ouut
) {

83  
ouut
.
G‘Ex‹nsiÚ
(
’şave_ouut_‹¡_¡ršg
).
‹¡_¡ršg
();

	@test/util/enclave_test_launcher.cc

19 
	~"asylo/‹¡/ut/’şave_‹¡_Ïunch”.h
"

21 
	~<sys/¡©.h
>

22 
	~<sys/ty³s.h
>

23 
	~<uni¡d.h
>

25 
	~"ab¦/memÜy/memÜy.h
"

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/‹¡/ut/‹¡_¡ršg.pb.h
"

28 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

29 
	~"asylo/ut/¡©us_maüos.h
"

31 
Çme¥aû
 
	gasylo
 {

33 
	gEnşaveTe¡Launch”
::
EnşaveTe¡Launch”
()

34 : 
mªag”_
(
nuÎ±r
), 
ş›Á_
ÒuÎ±r), 
lßd”_
(nullptr) {}

36 
Stus
 
	gEnşaveTe¡Launch”
::
S‘Up
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
,

37 cÚ¡ 
EnşaveCÚfig
 &
ecÚfig
,

38 cÚ¡ 
¡d
::
¡ršg
 &
’şave_u¾
) {

39 
EnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

40 
ASYLO_ASSIGN_OR_RETURN
(
mªag”_
, 
EnşaveMªag”
::
In¡ªû
());

42 
	glßd”_
 = 
ab¦
::
make_unique
<
SgxLßd”
>(
’şave_·th
, 
	gŒue
);

43 
ASYLO_RETURN_IF_ERROR
(
mªag”_
->
LßdEnşave
(
’şave_u¾
, *
lßd”_
, 
ecÚfig
));

45 
	gş›Á_
 = 
mªag”_
->
G‘Cl›Á
(
’şave_u¾
);

46 ià(!
	gş›Á_
) {

47 
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_ENOENT
, "Client is‚ull");

48 
LOG
(
ERROR
è<< "S‘U°çed:" << 
	g¡©us
;

49  
	g¡©us
;

51  
	gStus
::
OkStus
();

54 
Stus
 
	gEnşaveTe¡Launch”
::
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
,

55 
EnşaveOuut
 *
ouut
) {

56 ià(!
	gş›Á_
) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

60  
	gş›Á_
->
EÁ”AndRun
(
šput
, 
ouut
);

63 
Stus
 
	gEnşaveTe¡Launch”
::
T—rDown
(cÚ¡ 
EnşaveFš®
 &
efš®
,

64 
boŞ
 
skT—rDown
) {

65 ià(!
	gş›Á_
) {

66  
	gStus
::
OkStus
();

68 ià(!
	gmªag”_
) {

69 
	gEnşaveMªag”
::
CÚfigu»
(
EnşaveMªag”O±iÚs
());

70 
ASYLO_ASSIGN_OR_RETURN
(
mªag”_
, 
EnşaveMªag”
::
In¡ªû
());

72  
	gmªag”_
->
De¡royEnşave
(
ş›Á_
, 
efš®
, 
skT—rDown
);

75 
	gEnşaveTe¡Launch”
::
S‘EnşaveIÅutTe¡SŒšg
(

76 
EnşaveIÅut
 *
’şave_šput
, cÚ¡ 
¡d
::
¡ršg
 &
¡r_‹¡
) {

77 
’şave_šput
->
MubËEx‹nsiÚ
(
’şave_šput_‹¡_¡ršg
)

78 ->
£t_‹¡_¡ršg
(
¡r_‹¡
);

81 cÚ¡ 
	g¡d
::
¡ršg
 &
EnşaveTe¡Launch”
::
G‘EnşaveOuutTe¡SŒšg
(

82 cÚ¡ 
EnşaveOuut
 &
ouut
) {

83  
ouut
.
G‘Ex‹nsiÚ
(
’şave_ouut_‹¡_¡ršg
).
‹¡_¡ršg
();

	@test/util/enclave_test_launcher.h

19 #iâdeà
ASYLO_TEST_UTIL_ENCLAVE_TEST_LAUNCHER_H_


20 
	#ASYLO_TEST_UTIL_ENCLAVE_TEST_LAUNCHER_H_


	)

22 
	~"ab¦/memÜy/memÜy.h
"

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/’şave.pb.h
"

25 
	~"asylo/ut/¡©us.h
"

27 
Çme¥aû
 
	gasylo
 {

30 şas 
	cEnşaveTe¡Launch”
 {

31 
	gpublic
:

32 
EnşaveTe¡Launch”
();

36 
Stus
 
S‘Up
(cÚ¡ 
¡d
::
¡ršg
 &
’şave_·th
, cÚ¡ 
EnşaveCÚfig
 &
ecÚfig
,

37 cÚ¡ 
¡d
::
¡ršg
 &
’şave_u¾
);

42 
Stus
 
Run
(cÚ¡ 
EnşaveIÅut
 &
šput
, 
EnşaveOuut
 *
ouut
);

47 
Stus
 
T—rDown
(cÚ¡ 
EnşaveFš®
 &
efš®
, 
boŞ
 
skT—rDown
 = 
çl£
);

50 
EnşaveCl›Á
 *
mubË_ş›Á
(è{  
	gş›Á_
; }

54 
S‘EnşaveIÅutTe¡SŒšg
(
EnşaveIÅut
 *
’şave_šput
,

55 cÚ¡ 
¡d
::
¡ršg
 &
¡r_‹¡
);

58 cÚ¡ 
	g¡d
::
¡ršg
 &
G‘EnşaveOuutTe¡SŒšg
(

59 cÚ¡ 
EnşaveOuut
 &
ouut
);

61 
	g´iv©e
:

62 
EnşaveMªag”
 *
mªag”_
;

63 
EnşaveCl›Á
 *
	gş›Á_
;

64 
	g¡d
::
unique_±r
<
SgxLßd”
> 
lßd”_
;

	@test/util/exec_tester.cc

19 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

21 
	~<fú.h
>

22 
	~<libg’.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/ty³s.h
>

25 
	~<sys/wa™.h
>

26 
	~<uni¡d.h
>

27 
	~<c¡dlib
>

28 
	~<c¡ršg
>

29 
	~<s¡»am
>

30 
	~<th»ad
>

32 
	~<g‹¡/g‹¡.h
>

33 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

34 
	~"ab¦/¡ršgs/¡r_¥l™.h
"

35 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
Çme¥aû
 
	gex³rim’l
 {

40 
	gExecTe¡”
::
ExecTe¡”
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gs
, 
fd_to_check
)

41 : 
¬gs_
(
¬gs
), 
fd_to_check_
(
fd_to_check
) {

43 ià(::
acûss
(
¬gs
[0].
c_¡r
(), 
X_OK
)) {

44 
	g¡d
::
û¼
 << "CªnÙ‡cûs fe: " << 
¬gs
[0] << "\nE¼Ü (" << 
”ºo


45 << "): " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

46 
abÜt
();

50 
	g¡d
::
¡ršg
 
ExecTe¡”
::
BudSiblšgP©h
(cÚ¡ 
¡d
::¡ršg &
·th
,

51 cÚ¡ 
¡d
::
¡ršg
 &
fe_Çme
) {

52 *
·th_dup
 = 
¡rdup
(
·th
.
c_¡r
());

53 
	gab¦
::
¡ršg_v›w
 
·th_dœÇme
(
dœÇme
(
·th_dup
));

57 
	g¡d
::
¡ršg
 
»suÉ
 =

58 
ab¦
::
SŒC©
(
·th_dœÇme
, (·th_dœÇm=ğ"/" ? "" : "/"), 
fe_Çme
);

60 
ä“
(
·th_dup
);

61  
	g»suÉ
;

64 
boŞ
 
	gExecTe¡”
::
Run
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, *
¡©us
) {

65 
boŞ
 
	g»suÉ
 = 
çl£
;

66 
RunW™hAs£¹s
(
šput
, &
»suÉ
, 
¡©us
);

67  
Fš®Check
(
»suÉ
);

70 
	gExecTe¡”
::
DoExec
(
»ad_¡dš
, 
wr™e_¡dš
, 
»ad_fd_to_check
,

71 
wr™e_fd_to_check
) {

72 ià(
	g»ad_¡dš
 >= 0) {

73 
ASSERT_NE
(-1, 
dup2
(
»ad_¡dš
, 
STDIN_FILENO
)è<< 
¡»¼Ü
(
”ºo
);

74 
şo£
(
wr™e_¡dš
);

77 
ASSERT_NE
(-1, 
dup2
(
wr™e_fd_to_check
, 
fd_to_check_
)è<< 
¡»¼Ü
(
”ºo
);

79 
şo£
(
»ad_fd_to_check
);

82 **
	g¬gv
 =

83 
¡©ic_ÿ¡
<**>(
®loÿ
((*è* (
¬gs_
.
size
() + 1)));

84 
	gi
 = 0; i < 
	g¬gs_
.
size
(); ++i) {

85 
	g¬gv
[
i
] = 
cÚ¡_ÿ¡
<*>(
¬gs_
[i].
c_¡r
());

87 
	g¬gv
[
¬gs_
.
size
()] = 
nuÎ±r
;

89 
	g»s
 = 
execve
(
¬gv
[0],‡rgv, 
nuÎ±r
);

90 
ASSERT_NE
(-1, 
»s
è<< "Exeøçed: " << 
	g¬gv
[0] << " " << 
¡»¼Ü
(
”ºo
);

93 
	gExecTe¡”
::
RunW™hAs£¹s
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, 
boŞ
 *
»suÉ
,

94 *
¡©us
) {

95 
ASSERT_NE
(
nuÎ±r
, 
»suÉ
);

96 
ASSERT_NE
(
nuÎ±r
, 
¡©us
);

99 
	g¡dš_pe
[2] = {-1, 
STDIN_FILENO
};

100 
	gfd_to_check_pe
[2];

101 
ASSERT_EQ
(0, 
pe
(
fd_to_check_pe
))

102 << "Could‚Ùƒ¡ablish…fÜ sub´oûs ouut: " << 
¡»¼Ü
(
”ºo
);

103 
ASSERT_TRUE
(
šput
.
em±y
(è|| !
pe
(
¡dš_pe
))

104 << "Could‚Ùƒ¡ablish…fÜ sub´oûs šput: " << 
¡»¼Ü
(
”ºo
);

105 
cÚ¡ex´
 
	gkR—dEnd
 = 0;

106 
cÚ¡ex´
 
	gkWr™eEnd
 = 1;

107 
	g»ad_¡dš
 = 
¡dš_pe
[
kR—dEnd
];

108 
	gwr™e_¡dš
 = 
¡dš_pe
[
kWr™eEnd
];

109 
	g»ad_fd_to_check
 = 
fd_to_check_pe
[
kR—dEnd
];

110 
	gwr™e_fd_to_check
 = 
fd_to_check_pe
[
kWr™eEnd
];

112 
pid_t
 
	gpid
 = 
fÜk
();

114 
ASSERT_NE
(-1, 
pid
);

115 ià(
	gpid
 == 0) {

116 
DoExec
(
»ad_¡dš
, 
wr™e_¡dš
, 
»ad_fd_to_check
, 
wr™e_fd_to_check
);

118 
şo£
(
wr™e_fd_to_check
);

119 
şo£
(
»ad_¡dš
);

122 ià(!
	gšput
.
em±y
()) {

123 
ASSERT_NE
(
wr™e
(
wr™e_¡dš
, 
šput
.
c_¡r
(), iÅut.
size
()), -1);

124 
fsync
(
wr™e_¡dš
);

128 
	gæags
 = 
fú
(
»ad_fd_to_check
, 
F_GETFL
, 0);

129 
fú
(
»ad_fd_to_check
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

131 
R—dCheckLoİ
(
pid
, 
»ad_fd_to_check
, 
»suÉ
, 
¡©us
);

135 
	gExecTe¡”
::
R—dCheckLoİ
(
pid_t
 
pid
, 
fd
, 
boŞ
 *
»suÉ
, *
¡©us
) {

136 
ASSERT_NE
(
nuÎ±r
, 
¡©us
);

138 
boŞ
 
	gcÚjunùiÚ
 = 
Œue
;

139 
	gbufãr
[1024];

140 
	g¡d
::
¡ršg¡»am
 
lšebuf
;

144 
	gŒue
) {

145 
	g¡d
::
this_th»ad
::
y›ld
();

146 
	gchªged_pid
 = 
wa™pid
(
pid
, 
¡©us
, 
WNOHANG
);

147 
ASSERT_NE
(-1, 
chªged_pid
)

148 << "Wa™ oÀsub´oûs ¡©u çed: " << 
¡»¼Ü
(
”ºo
);

150 
CheckFD
(
fd
, 
bufãr
, &
lšebuf
, &
cÚjunùiÚ
);

152 ià(
	gchªged_pid
 && (
WIFEXITED
(*
¡©us
è|| 
WIFSIGNALED
(*status))) {

153 *
	g»suÉ
 = 
cÚjunùiÚ
;

159 
	gExecTe¡”
::
CheckFD
(
fd
, 
ab¦
::
S·n
<> 
bufãr
,

160 
¡d
::
¡ršg¡»am
 *
lšebuf
, 
boŞ
 *
»suÉ
) {

161 
ASSERT_FALSE
(
bufãr
.
em±y
());

162 
ASSERT_NE
(
nuÎ±r
, 
lšebuf
);

164 
ssize_t
 
	gnum»ad
 = 
»ad
(
fd
, 
bufãr
.
d©a
(), bufãr.
size
());

166 ià(
	gnum»ad
 == -1) {

168 
ASSERT_EQ
(
”ºo
, 
EAGAIN
è<< "R—d from fd " << 
fd
 << " failed (" <<ƒrrno

169 << "): " << 
¡»¼Ü
(
”ºo
);

171 } ià(
	gnum»ad
 == 0) {

172 
¡d
::
¡ršg
 
lše
 = 
lšebuf
->
¡r
();

173 ià(!
	glše
.
em±y
()) {

174 
	glšebuf
->
¡r
("");

175 *
	g»suÉ
 &ğ
CheckLše
(
lše
);

181 
	g¡d
::
veùÜ
<
ab¦
::
¡ršg_v›w
> 
lšes
 =

182 
ab¦
::
SŒS¶™
×b¦::
¡ršg_v›w
(
bufãr
.
d©a
(), 
num»ad
), '\n');

183 
	gi
 = 0; i < 
	glšes
.
size
() - 1; ++i) {

184 
	glšebuf
->
wr™e
(
lšes
[
i
].
d©a
(),†šes[i].
size
());

185 *
	g»suÉ
 &ğ
CheckLše
(
lšebuf
->
¡r
());

186 
	glšebuf
->
¡r
("");

188 
ASSERT_GT
(
lšes
.
size
(), 0);

189 
	glšebuf
->
wr™e
(
lšes
.
back
().
d©a
(),†šes.back().
size
());

	@test/util/exec_tester.cc

19 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

21 
	~<fú.h
>

22 
	~<libg’.h
>

23 
	~<sys/¡©.h
>

24 
	~<sys/ty³s.h
>

25 
	~<sys/wa™.h
>

26 
	~<uni¡d.h
>

27 
	~<c¡dlib
>

28 
	~<c¡ršg
>

29 
	~<s¡»am
>

30 
	~<th»ad
>

32 
	~<g‹¡/g‹¡.h
>

33 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

34 
	~"ab¦/¡ršgs/¡r_¥l™.h
"

35 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

37 
Çme¥aû
 
	gasylo
 {

38 
Çme¥aû
 
	gex³rim’l
 {

40 
	gExecTe¡”
::
ExecTe¡”
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gs
, 
fd_to_check
)

41 : 
¬gs_
(
¬gs
), 
fd_to_check_
(
fd_to_check
) {

43 ià(::
acûss
(
¬gs
[0].
c_¡r
(), 
X_OK
)) {

44 
	g¡d
::
û¼
 << "CªnÙ‡cûs fe: " << 
¬gs
[0] << "\nE¼Ü (" << 
”ºo


45 << "): " << 
¡»¼Ü
(
”ºo
è<< 
¡d
::
’dl
;

46 
abÜt
();

50 
	g¡d
::
¡ršg
 
ExecTe¡”
::
BudSiblšgP©h
(cÚ¡ 
¡d
::¡ršg &
·th
,

51 cÚ¡ 
¡d
::
¡ršg
 &
fe_Çme
) {

52 *
·th_dup
 = 
¡rdup
(
·th
.
c_¡r
());

53 
	gab¦
::
¡ršg_v›w
 
·th_dœÇme
(
dœÇme
(
·th_dup
));

57 
	g¡d
::
¡ršg
 
»suÉ
 =

58 
ab¦
::
SŒC©
(
·th_dœÇme
, (·th_dœÇm=ğ"/" ? "" : "/"), 
fe_Çme
);

60 
ä“
(
·th_dup
);

61  
	g»suÉ
;

64 
boŞ
 
	gExecTe¡”
::
Run
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, *
¡©us
) {

65 
boŞ
 
	g»suÉ
 = 
çl£
;

66 
RunW™hAs£¹s
(
šput
, &
»suÉ
, 
¡©us
);

67  
Fš®Check
(
»suÉ
);

70 
	gExecTe¡”
::
DoExec
(
»ad_¡dš
, 
wr™e_¡dš
, 
»ad_fd_to_check
,

71 
wr™e_fd_to_check
) {

72 ià(
	g»ad_¡dš
 >= 0) {

73 
ASSERT_NE
(-1, 
dup2
(
»ad_¡dš
, 
STDIN_FILENO
)è<< 
¡»¼Ü
(
”ºo
);

74 
şo£
(
wr™e_¡dš
);

77 
ASSERT_NE
(-1, 
dup2
(
wr™e_fd_to_check
, 
fd_to_check_
)è<< 
¡»¼Ü
(
”ºo
);

79 
şo£
(
»ad_fd_to_check
);

82 **
	g¬gv
 =

83 
¡©ic_ÿ¡
<**>(
®loÿ
((*è* (
¬gs_
.
size
() + 1)));

84 
	gi
 = 0; i < 
	g¬gs_
.
size
(); ++i) {

85 
	g¬gv
[
i
] = 
cÚ¡_ÿ¡
<*>(
¬gs_
[i].
c_¡r
());

87 
	g¬gv
[
¬gs_
.
size
()] = 
nuÎ±r
;

89 
	g»s
 = 
execve
(
¬gv
[0],‡rgv, 
nuÎ±r
);

90 
ASSERT_NE
(-1, 
»s
è<< "Exeøçed: " << 
	g¬gv
[0] << " " << 
¡»¼Ü
(
”ºo
);

93 
	gExecTe¡”
::
RunW™hAs£¹s
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, 
boŞ
 *
»suÉ
,

94 *
¡©us
) {

95 
ASSERT_NE
(
nuÎ±r
, 
»suÉ
);

96 
ASSERT_NE
(
nuÎ±r
, 
¡©us
);

99 
	g¡dš_pe
[2] = {-1, 
STDIN_FILENO
};

100 
	gfd_to_check_pe
[2];

101 
ASSERT_EQ
(0, 
pe
(
fd_to_check_pe
))

102 << "Could‚Ùƒ¡ablish…fÜ sub´oûs ouut: " << 
¡»¼Ü
(
”ºo
);

103 
ASSERT_TRUE
(
šput
.
em±y
(è|| !
pe
(
¡dš_pe
))

104 << "Could‚Ùƒ¡ablish…fÜ sub´oûs šput: " << 
¡»¼Ü
(
”ºo
);

105 
cÚ¡ex´
 
	gkR—dEnd
 = 0;

106 
cÚ¡ex´
 
	gkWr™eEnd
 = 1;

107 
	g»ad_¡dš
 = 
¡dš_pe
[
kR—dEnd
];

108 
	gwr™e_¡dš
 = 
¡dš_pe
[
kWr™eEnd
];

109 
	g»ad_fd_to_check
 = 
fd_to_check_pe
[
kR—dEnd
];

110 
	gwr™e_fd_to_check
 = 
fd_to_check_pe
[
kWr™eEnd
];

112 
pid_t
 
	gpid
 = 
fÜk
();

114 
ASSERT_NE
(-1, 
pid
);

115 ià(
	gpid
 == 0) {

116 
DoExec
(
»ad_¡dš
, 
wr™e_¡dš
, 
»ad_fd_to_check
, 
wr™e_fd_to_check
);

118 
şo£
(
wr™e_fd_to_check
);

119 
şo£
(
»ad_¡dš
);

122 ià(!
	gšput
.
em±y
()) {

123 
ASSERT_NE
(
wr™e
(
wr™e_¡dš
, 
šput
.
c_¡r
(), iÅut.
size
()), -1);

124 
fsync
(
wr™e_¡dš
);

128 
	gæags
 = 
fú
(
»ad_fd_to_check
, 
F_GETFL
, 0);

129 
fú
(
»ad_fd_to_check
, 
F_SETFL
, 
æags
 | 
O_NONBLOCK
);

131 
R—dCheckLoİ
(
pid
, 
»ad_fd_to_check
, 
»suÉ
, 
¡©us
);

135 
	gExecTe¡”
::
R—dCheckLoİ
(
pid_t
 
pid
, 
fd
, 
boŞ
 *
»suÉ
, *
¡©us
) {

136 
ASSERT_NE
(
nuÎ±r
, 
¡©us
);

138 
boŞ
 
	gcÚjunùiÚ
 = 
Œue
;

139 
	gbufãr
[1024];

140 
	g¡d
::
¡ršg¡»am
 
lšebuf
;

144 
	gŒue
) {

145 
	g¡d
::
this_th»ad
::
y›ld
();

146 
	gchªged_pid
 = 
wa™pid
(
pid
, 
¡©us
, 
WNOHANG
);

147 
ASSERT_NE
(-1, 
chªged_pid
)

148 << "Wa™ oÀsub´oûs ¡©u çed: " << 
¡»¼Ü
(
”ºo
);

150 
CheckFD
(
fd
, 
bufãr
, &
lšebuf
, &
cÚjunùiÚ
);

152 ià(
	gchªged_pid
 && (
WIFEXITED
(*
¡©us
è|| 
WIFSIGNALED
(*status))) {

153 *
	g»suÉ
 = 
cÚjunùiÚ
;

159 
	gExecTe¡”
::
CheckFD
(
fd
, 
ab¦
::
S·n
<> 
bufãr
,

160 
¡d
::
¡ršg¡»am
 *
lšebuf
, 
boŞ
 *
»suÉ
) {

161 
ASSERT_FALSE
(
bufãr
.
em±y
());

162 
ASSERT_NE
(
nuÎ±r
, 
lšebuf
);

164 
ssize_t
 
	gnum»ad
 = 
»ad
(
fd
, 
bufãr
.
d©a
(), bufãr.
size
());

166 ià(
	gnum»ad
 == -1) {

168 
ASSERT_EQ
(
”ºo
, 
EAGAIN
è<< "R—d from fd " << 
fd
 << " failed (" <<ƒrrno

169 << "): " << 
¡»¼Ü
(
”ºo
);

171 } ià(
	gnum»ad
 == 0) {

172 
¡d
::
¡ršg
 
lše
 = 
lšebuf
->
¡r
();

173 ià(!
	glše
.
em±y
()) {

174 
	glšebuf
->
¡r
("");

175 *
	g»suÉ
 &ğ
CheckLše
(
lše
);

181 
	g¡d
::
veùÜ
<
ab¦
::
¡ršg_v›w
> 
lšes
 =

182 
ab¦
::
SŒS¶™
×b¦::
¡ršg_v›w
(
bufãr
.
d©a
(), 
num»ad
), '\n');

183 
	gi
 = 0; i < 
	glšes
.
size
() - 1; ++i) {

184 
	glšebuf
->
wr™e
(
lšes
[
i
].
d©a
(),†šes[i].
size
());

185 *
	g»suÉ
 &ğ
CheckLše
(
lšebuf
->
¡r
());

186 
	glšebuf
->
¡r
("");

188 
ASSERT_GT
(
lšes
.
size
(), 0);

189 
	glšebuf
->
wr™e
(
lšes
.
back
().
d©a
(),†šes.back().
size
());

	@test/util/exec_tester.h

19 #iâdeà
ASYLO_TEST_UTIL_EXEC_TESTER_H_


20 
	#ASYLO_TEST_UTIL_EXEC_TESTER_H_


	)

22 
	~<uni¡d.h
>

23 
	~<io¡»am
>

24 
	~<s¡»am
>

25 
	~<¡ršg
>

26 
	~<veùÜ
>

28 
	~"ab¦/ty³s/¥ª.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
Çme¥aû
 
	gex³rim’l
 {

35 şas 
	cExecTe¡”
 {

36 
	gpublic
:

43 
ExecTe¡”
(cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gs
,

44 
fd_to_check
 = 
STDOUT_FILENO
);

45 
	gvœtu®
 ~
ExecTe¡”
() = ;

58 
boŞ
 
Run
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, *
¡©us
);

71 
	g¡d
::
¡ršg
 
BudSiblšgP©h
(cÚ¡ 
¡d
::¡ršg &
·th
,

72 cÚ¡ 
¡d
::
¡ršg
 &
fe_Çme
);

74 
	g´Ùeùed
:

80 
vœtu®
 
boŞ
 
CheckLše
(cÚ¡ 
¡d
::
¡ršg
 &
lše
è{  
Œue
; }

89 
vœtu®
 
boŞ
 
Fš®Check
(boŞ 
accumuÏ‹d
è{  
	gaccumuÏ‹d
; }

91 
	g´iv©e
:

93 
RunW™hAs£¹s
(cÚ¡ 
¡d
::
¡ršg
 &
šput
, 
boŞ
 *
»suÉ
, *
¡©us
);

97 
DoExec
(
»ad_¡dš
, 
wr™e_¡dš
, 
»ad_fd_to_check
,

98 
wr™e_fd_to_check
);

105 
CheckFD
(
fd
, 
ab¦
::
S·n
<> 
bufãr
, 
¡d
::
¡ršg¡»am
 *
lšebuf
,

106 
boŞ
 *
»suÉ
);

110 
R—dCheckLoİ
(
pid_t
 
pid
, 
fd
, 
boŞ
 *
»suÉ
, *
¡©us
);

112 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
¬gs_
;

113 
	gfd_to_check_
;

	@test/util/exec_tester_test.cc

19 
	~<uni¡d.h
>

20 
	~<c¡dlib
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

26 
DEFINE_¡ršg
(
bš¬y_·th
, "", "Path ofhe binaryoƒxecute");

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gex³rim’l
 {

30 
	gÇme¥aû
 {

32 şas 
	cExecTe¡”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

33 
public
:

34 
S‘Up
(è
ov”ride
 { 
­p_
 = 
FLAGS_bš¬y_·th
; }

36 
	g´Ùeùed
:

37 şas 
	cUnifÜmOuutCheck”
 : 
public
 
ExecTe¡”
 {

38 
public
:

39 
UnifÜmOuutCheck”
(cÚ¡ 
¡d
::
¡ršg
 &
lše
,

40 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gs
, 
mšimum
 = 0,

41 
boŞ
 
h¬d_lim™
 = 
Œue
,

42 
fd_to_check
 = 
STDOUT_FILENO
)

43 : 
ExecTe¡”
(
¬gs
, 
fd_to_check
),

44 
lše_
(
lše
),

45 
couÁ_
(0),

46 
mšimum_
(
mšimum
),

47 
h¬d_lim™_
(
h¬d_lim™
) {}

49 
	g´Ùeùed
:

50 
boŞ
 
CheckLše
(cÚ¡ 
¡d
::
¡ršg
 &
lše
è
ov”ride
 {

51 
boŞ
 
check
 = (
lše
 =ğ
lše_
);

52 ià(
	gcheck
è++
	gcouÁ_
;

53  (
	gcouÁ_
 >ğ
mšimum_
è|| 
check
;

56 
boŞ
 
Fš®Check
(boŞ 
accumuÏ‹d
è
	gov”ride
 {

59 ià(!
	gaccumuÏ‹d
 || !
	gh¬d_lim™_
)

60  
	gaccumuÏ‹d
 && 
	gcouÁ_
 >ğ
mšimum_
;

61  
	gcouÁ_
 =ğ
mšimum_
;

64 
	g´Ùeùed
:

65 
¡d
::
¡ršg
 
lše_
;

66 
	gcouÁ_
;

67 
	gmšimum_
;

68 
boŞ
 
	gh¬d_lim™_
;

71 
	g´Ùeùed
:

72 
¡d
::
¡ršg
 
­p_
;

75 
TEST_F
(
ExecTe¡”Te¡
, 
CheckEx™3
) {

76 
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--exit3")});

77 
	g¡©us
 = 0;

78 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

79 
ASSERT_TRUE
(
WIFEXITED
(
¡©us
));

80 
EXPECT_EQ
(3, 
WEXITSTATUS
(
¡©us
));

83 
TEST_F
(
ExecTe¡”Te¡
, 
CheckPrštA
) {

84 
UnifÜmOuutCheck”
 
run
("A", {
­p_
, 
¡d
::
¡ršg
("--printA")}, 1);

85 
	g¡©us
 = 0;

86 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

87 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

88 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

91 
TEST_F
(
ExecTe¡”Te¡
, 
CheckNoPrštB
) {

92 
UnifÜmOuutCheck”
 
run
("B", {
­p_
, 
¡d
::
¡ršg
("--´štA")}, 1, 
çl£
);

93 
	g¡©us
 = 0;

94 
EXPECT_FALSE
(
run
.
Run
("", &
¡©us
));

95 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

96 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

99 
TEST_F
(
ExecTe¡”Te¡
, 
CheckPrštB5
) {

100 
UnifÜmOuutCheck”
 
run
("B", {
­p_
, 
¡d
::
¡ršg
("--printB5")}, 5);

101 
	g¡©us
 = 0;

102 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

103 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

104 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

107 
TEST_F
(
ExecTe¡”Te¡
, 
CheckPrštB5NÙ3Times
) {

108 
UnifÜmOuutCheck”
 
run
("B", {
­p_
, 
¡d
::
¡ršg
("--´štB5")}, 3, 
çl£
);

109 
	g¡©us
 = 0;

110 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

111 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

112 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

115 
TEST_F
(
ExecTe¡”Te¡
, 
CheckSIGSEGV
) {

116 
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--segfault")});

117 
	g¡©us
 = 0;

118 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

119 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

120 
EXPECT_EQ
(
SIGSEGV
, 
WTERMSIG
(
¡©us
));

123 
TEST_F
(
ExecTe¡”Te¡
, 
CheckSIGILL
) {

124 
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--sigill")});

125 
	g¡©us
 = 0;

126 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

127 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

128 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

131 
TEST_F
(
ExecTe¡”Te¡
, 
CheckStd”rFoo
) {

132 
UnifÜmOuutCheck”
 
run
("Foo", {
­p_
, 
¡d
::
¡ršg
("--stderrFoo")},

134  
Œue
, 
STDERR_FILENO
);

135 
	g¡©us
 = 0;

136 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

137 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

138 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

141 
TEST_F
(
ExecTe¡”Te¡
, 
CheckStdš
) {

142 
UnifÜmOuutCheck”
 
run
("Lucky!", {
­p_
, 
¡d
::
¡ršg
("--stdin")}, 1);

143 
	g¡©us
 = 0;

144 
EXPECT_TRUE
(
run
.
Run
("13\n", &
¡©us
));

145 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

146 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

	@test/util/exec_tester_test.cc

19 
	~<uni¡d.h
>

20 
	~<c¡dlib
>

22 
	~<g‹¡/g‹¡.h
>

23 
	~"gæags/gæags.h
"

24 
	~"asylo/‹¡/ut/exec_‹¡”.h
"

26 
DEFINE_¡ršg
(
bš¬y_·th
, "", "Path ofhe binaryoƒxecute");

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gex³rim’l
 {

30 
	gÇme¥aû
 {

32 şas 
	cExecTe¡”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

33 
public
:

34 
S‘Up
(è
ov”ride
 { 
­p_
 = 
FLAGS_bš¬y_·th
; }

36 
	g´Ùeùed
:

37 şas 
	cUnifÜmOuutCheck”
 : 
public
 
ExecTe¡”
 {

38 
public
:

39 
UnifÜmOuutCheck”
(cÚ¡ 
¡d
::
¡ršg
 &
lše
,

40 cÚ¡ 
¡d
::
veùÜ
<¡d::
¡ršg
> &
¬gs
, 
mšimum
 = 0,

41 
boŞ
 
h¬d_lim™
 = 
Œue
,

42 
fd_to_check
 = 
STDOUT_FILENO
)

43 : 
ExecTe¡”
(
¬gs
, 
fd_to_check
),

44 
lše_
(
lše
),

45 
couÁ_
(0),

46 
mšimum_
(
mšimum
),

47 
h¬d_lim™_
(
h¬d_lim™
) {}

49 
	g´Ùeùed
:

50 
boŞ
 
CheckLše
(cÚ¡ 
¡d
::
¡ršg
 &
lše
è
ov”ride
 {

51 
boŞ
 
check
 = (
lše
 =ğ
lše_
);

52 ià(
	gcheck
è++
	gcouÁ_
;

53  (
	gcouÁ_
 >ğ
mšimum_
è|| 
check
;

56 
boŞ
 
Fš®Check
(boŞ 
accumuÏ‹d
è
	gov”ride
 {

59 ià(!
	gaccumuÏ‹d
 || !
	gh¬d_lim™_
)

60  
	gaccumuÏ‹d
 && 
	gcouÁ_
 >ğ
mšimum_
;

61  
	gcouÁ_
 =ğ
mšimum_
;

64 
	g´Ùeùed
:

65 
¡d
::
¡ršg
 
lše_
;

66 
	gcouÁ_
;

67 
	gmšimum_
;

68 
boŞ
 
	gh¬d_lim™_
;

71 
	g´Ùeùed
:

72 
¡d
::
¡ršg
 
­p_
;

75 
TEST_F
(
ExecTe¡”Te¡
, 
CheckEx™3
) {

76 
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--exit3")});

77 
	g¡©us
 = 0;

78 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

79 
ASSERT_TRUE
(
WIFEXITED
(
¡©us
));

80 
EXPECT_EQ
(3, 
WEXITSTATUS
(
¡©us
));

83 
TEST_F
(
ExecTe¡”Te¡
, 
CheckPrštA
) {

84 
UnifÜmOuutCheck”
 
run
("A", {
­p_
, 
¡d
::
¡ršg
("--printA")}, 1);

85 
	g¡©us
 = 0;

86 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

87 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

88 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

91 
TEST_F
(
ExecTe¡”Te¡
, 
CheckNoPrštB
) {

92 
UnifÜmOuutCheck”
 
run
("B", {
­p_
, 
¡d
::
¡ršg
("--´štA")}, 1, 
çl£
);

93 
	g¡©us
 = 0;

94 
EXPECT_FALSE
(
run
.
Run
("", &
¡©us
));

95 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

96 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

99 
TEST_F
(
ExecTe¡”Te¡
, 
CheckPrštB5
) {

100 
UnifÜmOuutCheck”
 
run
("B", {
­p_
, 
¡d
::
¡ršg
("--printB5")}, 5);

101 
	g¡©us
 = 0;

102 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

103 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

104 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

107 
TEST_F
(
ExecTe¡”Te¡
, 
CheckPrštB5NÙ3Times
) {

108 
UnifÜmOuutCheck”
 
run
("B", {
­p_
, 
¡d
::
¡ršg
("--´štB5")}, 3, 
çl£
);

109 
	g¡©us
 = 0;

110 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

111 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

112 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

115 
TEST_F
(
ExecTe¡”Te¡
, 
CheckSIGSEGV
) {

116 
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--segfault")});

117 
	g¡©us
 = 0;

118 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

119 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

120 
EXPECT_EQ
(
SIGSEGV
, 
WTERMSIG
(
¡©us
));

123 
TEST_F
(
ExecTe¡”Te¡
, 
CheckSIGILL
) {

124 
ExecTe¡”
 
run
({
­p_
, 
¡d
::
¡ršg
("--sigill")});

125 
	g¡©us
 = 0;

126 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

127 
ASSERT_TRUE
(
WIFSIGNALED
(
¡©us
));

128 
EXPECT_EQ
(
SIGILL
, 
WTERMSIG
(
¡©us
));

131 
TEST_F
(
ExecTe¡”Te¡
, 
CheckStd”rFoo
) {

132 
UnifÜmOuutCheck”
 
run
("Foo", {
­p_
, 
¡d
::
¡ršg
("--stderrFoo")},

134  
Œue
, 
STDERR_FILENO
);

135 
	g¡©us
 = 0;

136 
EXPECT_TRUE
(
run
.
Run
("", &
¡©us
));

137 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

138 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

141 
TEST_F
(
ExecTe¡”Te¡
, 
CheckStdš
) {

142 
UnifÜmOuutCheck”
 
run
("Lucky!", {
­p_
, 
¡d
::
¡ršg
("--stdin")}, 1);

143 
	g¡©us
 = 0;

144 
EXPECT_TRUE
(
run
.
Run
("13\n", &
¡©us
));

145 
EXPECT_TRUE
(
WIFEXITED
(
¡©us
));

146 
EXPECT_EQ
(0, 
WEXITSTATUS
(
¡©us
));

	@test/util/exit_app.cc

19 
	~<csigÇl
>

20 
	~<c¡dlib
>

21 
	~<c¡ršg
>

22 
	~<io¡»am
>

24 
	$u§ge
(
¬gc
, *
¬gv
[]) {

25 
¡d
::
û¼
 << "Ex³ùed u§ge: " << 
¬gv
[0]

36 
i
 = 0; i < 
¬gc
; ++i) {

37 
¡d
::
û¼
 << 
¬gv
[
i
] << std::
’dl
;

39 
	`abÜt
();

40 
	}
}

42 
	$maš
(
¬gc
, *
¬gv
[]) {

43 ià(
¬gc
 != 2) {

44 
	`u§ge
(
¬gc
, 
¬gv
);

47 ià(
	`¡rcmp
(
¬gv
[1], "--exit3") == 0) {

48 
	`ex™
(3);

49 } ià(
	`¡rcmp
(
¬gv
[1], "--printA") == 0) {

50 
¡d
::
cout
 << "A" << std::
’dl
;

51 } ià(
	`¡rcmp
(
¬gv
[1], "--printB5") == 0) {

52 
i
 = 0; i < 5; ++i) {

53 
¡d
::
cout
 << "B" << std::
’dl
;

55 } ià(
	`¡rcmp
(
¬gv
[1], "--segfault") == 0) {

56 
	`¿i£
(
SIGSEGV
);

57 } ià(
	`¡rcmp
(
¬gv
[1], "--sigill") == 0) {

58 
	`¿i£
(
SIGILL
);

59 } ià(
	`¡rcmp
(
¬gv
[1], "--stdin") == 0) {

60 
numb”
 = 0;

61 
¡d
::
cš
 >> 
numb”
;

62 ià(
numb”
 == 13) {

63 
¡d
::
cout
 << "Lucky!" << std::
’dl
;

65 
¡d
::
cout
 << "Fa." << std::
’dl
;

67 } ià(
	`¡rcmp
(
¬gv
[1], "--stderrFoo") == 0) {

68 
¡d
::
û¼
 << "Foo" << std::
’dl
;

70 
	`u§ge
(
¬gc
, 
¬gv
);

73 
	}
}

	@test/util/exit_app.cc

19 
	~<csigÇl
>

20 
	~<c¡dlib
>

21 
	~<c¡ršg
>

22 
	~<io¡»am
>

24 
	$u§ge
(
¬gc
, *
¬gv
[]) {

25 
¡d
::
û¼
 << "Ex³ùed u§ge: " << 
¬gv
[0]

36 
i
 = 0; i < 
¬gc
; ++i) {

37 
¡d
::
û¼
 << 
¬gv
[
i
] << std::
’dl
;

39 
	`abÜt
();

40 
	}
}

42 
	$maš
(
¬gc
, *
¬gv
[]) {

43 ià(
¬gc
 != 2) {

44 
	`u§ge
(
¬gc
, 
¬gv
);

47 ià(
	`¡rcmp
(
¬gv
[1], "--exit3") == 0) {

48 
	`ex™
(3);

49 } ià(
	`¡rcmp
(
¬gv
[1], "--printA") == 0) {

50 
¡d
::
cout
 << "A" << std::
’dl
;

51 } ià(
	`¡rcmp
(
¬gv
[1], "--printB5") == 0) {

52 
i
 = 0; i < 5; ++i) {

53 
¡d
::
cout
 << "B" << std::
’dl
;

55 } ià(
	`¡rcmp
(
¬gv
[1], "--segfault") == 0) {

56 
	`¿i£
(
SIGSEGV
);

57 } ià(
	`¡rcmp
(
¬gv
[1], "--sigill") == 0) {

58 
	`¿i£
(
SIGILL
);

59 } ià(
	`¡rcmp
(
¬gv
[1], "--stdin") == 0) {

60 
numb”
 = 0;

61 
¡d
::
cš
 >> 
numb”
;

62 ià(
numb”
 == 13) {

63 
¡d
::
cout
 << "Lucky!" << std::
’dl
;

65 
¡d
::
cout
 << "Fa." << std::
’dl
;

67 } ià(
	`¡rcmp
(
¬gv
[1], "--stderrFoo") == 0) {

68 
¡d
::
û¼
 << "Foo" << std::
’dl
;

70 
	`u§ge
(
¬gc
, 
¬gv
);

73 
	}
}

	@test/util/fake_enclave_loader.cc

19 
	~"asylo/‹¡/ut/çke_’şave_lßd”.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gFakeEnşaveLßd”
::
FakeEnşaveLßd”
(

24 
¡d
::
unique_±r
<
EnşaveCl›Á
> 
de¡š©iÚ_ş›Á
)

25 : 
ş›Á_
(
¡d
::
move
(
de¡š©iÚ_ş›Á
)) {}

27 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
FakeEnşaveLßd”
::
LßdEnşave
(

28 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

29 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) const {

30  
	g¡d
::
move
(
ş›Á_
);

33 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
FakeEnşaveLßd”
::
Cİy
() const {

34  
nuÎ±r
;

	@test/util/fake_enclave_loader.cc

19 
	~"asylo/‹¡/ut/çke_’şave_lßd”.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
	gFakeEnşaveLßd”
::
FakeEnşaveLßd”
(

24 
¡d
::
unique_±r
<
EnşaveCl›Á
> 
de¡š©iÚ_ş›Á
)

25 : 
ş›Á_
(
¡d
::
move
(
de¡š©iÚ_ş›Á
)) {}

27 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
FakeEnşaveLßd”
::
LßdEnşave
(

28 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

29 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
) const {

30  
	g¡d
::
move
(
ş›Á_
);

33 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
FakeEnşaveLßd”
::
Cİy
() const {

34  
nuÎ±r
;

	@test/util/fake_enclave_loader.h

19 #iâdeà
ASYLO_TEST_UTIL_FAKE_ENCLAVE_LOADER_H_


20 
	#ASYLO_TEST_UTIL_FAKE_ENCLAVE_LOADER_H_


	)

22 
	~<memÜy
>

24 
	~"asylo/ş›Á.h
"

25 
	~"asylo/’şave_mªag”.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

28 
Çme¥aû
 
	gasylo
 {

31 şas 
	cFakeEnşaveLßd”
 : 
public
 
EnşaveLßd”
 {

32 
public
:

36 
ex¶ic™
 
FakeEnşaveLßd”
(
¡d
::
unique_±r
<
EnşaveCl›Á
> 
ş›Á
);

38 
	g´iv©e
:

40 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>> 
LßdEnşave
(

41 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
, cÚ¡ 
size_t
 
’şave_size
,

42 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
ècÚ¡ 
	gov”ride
;

45 
	gStusOr
<
	g¡d
::
unique_±r
<
EnşaveLßd”
>> 
Cİy
() const;

48 
mubË
 
	g¡d
::
unique_±r
<
EnşaveCl›Á
> 
ş›Á_
;

	@test/util/finite_domain_fuzz.cc

19 
	~"asylo/‹¡/ut/fš™e_domaš_fuzz.h
"

21 
	~<gmock/gmock.h
>

22 
	~"ab¦/ty³s/İtiÚ®.h
"

24 
Çme¥aû
 
	gasylo
 {

35 
¿ndom_æag
() {

37 
	gšdex
 = 
¿nd
()%(() * 8 - 1);

38  1 << 
	gšdex
;

41 
	gab¦
::
İtiÚ®
<
¡d
::
veùÜ
<¡d::
·œ
<, >>> 
FuzzB™£tT¿n¦©iÚFunùiÚ
(

42 cÚ¡ 
¡d
::
veùÜ
<>& 
šput
, cÚ¡ std::veùÜ<>& 
ouut
,

43 
™”_bound
) {

44 autØ
	g®l_ÿ£s
 = 
z
(
šput
, 
ouut
);

45 ià(!
	g®l_ÿ£s
) {

46  
	g®l_ÿ£s
;

48 
	g®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(0, 0));

51 
size_t
 
	gsize
 = 
šput
.
size
();

52 autØ
	gbegš
 = 
šput
.
begš
();

53 autØ
	g’d
 = 
šput
.
’d
();

54 
	gi
 = 0; i < 
	g™”_bound
; i++) {

56 
	gš
 = 0;

57 
	gout
 = 0;

58 
	gj
 = 0; j < 
	gsize
; j++) {

59 ià(
¿nd
()%2) {

60 
	gš
 |ğ
šput
[
j
];

61 
	gout
 |ğ
ouut
[
j
];

63 
	g®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(
š
, 
out
));

67 
	gš
 = 0;

68 
	gout
 = 0;

69 
	gi
 = 0; i < () * 8; i++) {

70 
	gæag
 = 
¿ndom_æag
();

71 autØ
	gfound
 = 
fšd
(
begš
, 
’d
, 
æag
);

72 
size_t
 
	gšdex
 = 
found
 - 
begš
;

75 ià(
	gfound
 =ğ
’d
) {

76 
š
 |ğ
æag
;

78 
	gš
 |ğ
šput
[
šdex
];

79 
	gout
 |ğ
ouut
[
šdex
];

82 
	g®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(
š
, 
out
));

84  
	g®l_ÿ£s
;

	@test/util/finite_domain_fuzz.cc

19 
	~"asylo/‹¡/ut/fš™e_domaš_fuzz.h
"

21 
	~<gmock/gmock.h
>

22 
	~"ab¦/ty³s/İtiÚ®.h
"

24 
Çme¥aû
 
	gasylo
 {

35 
¿ndom_æag
() {

37 
	gšdex
 = 
¿nd
()%(() * 8 - 1);

38  1 << 
	gšdex
;

41 
	gab¦
::
İtiÚ®
<
¡d
::
veùÜ
<¡d::
·œ
<, >>> 
FuzzB™£tT¿n¦©iÚFunùiÚ
(

42 cÚ¡ 
¡d
::
veùÜ
<>& 
šput
, cÚ¡ std::veùÜ<>& 
ouut
,

43 
™”_bound
) {

44 autØ
	g®l_ÿ£s
 = 
z
(
šput
, 
ouut
);

45 ià(!
	g®l_ÿ£s
) {

46  
	g®l_ÿ£s
;

48 
	g®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(0, 0));

51 
size_t
 
	gsize
 = 
šput
.
size
();

52 autØ
	gbegš
 = 
šput
.
begš
();

53 autØ
	g’d
 = 
šput
.
’d
();

54 
	gi
 = 0; i < 
	g™”_bound
; i++) {

56 
	gš
 = 0;

57 
	gout
 = 0;

58 
	gj
 = 0; j < 
	gsize
; j++) {

59 ià(
¿nd
()%2) {

60 
	gš
 |ğ
šput
[
j
];

61 
	gout
 |ğ
ouut
[
j
];

63 
	g®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(
š
, 
out
));

67 
	gš
 = 0;

68 
	gout
 = 0;

69 
	gi
 = 0; i < () * 8; i++) {

70 
	gæag
 = 
¿ndom_æag
();

71 autØ
	gfound
 = 
fšd
(
begš
, 
’d
, 
æag
);

72 
size_t
 
	gšdex
 = 
found
 - 
begš
;

75 ià(
	gfound
 =ğ
’d
) {

76 
š
 |ğ
æag
;

78 
	gš
 |ğ
šput
[
šdex
];

79 
	gout
 |ğ
ouut
[
šdex
];

82 
	g®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(
š
, 
out
));

84  
	g®l_ÿ£s
;

	@test/util/finite_domain_fuzz.h

19 #iâdeà
ASYLO_TEST_UTIL_FINITE_DOMAIN_FUZZ_H_


20 
	#ASYLO_TEST_UTIL_FINITE_DOMAIN_FUZZ_H_


	)

22 
	~<gmock/gmock.h
>

24 
	~"ab¦/ty³s/İtiÚ®.h
"

26 
Çme¥aû
 
	gasylo
 {

28 
	gusšg
 ::
‹¡šg
::
MakePŞymÜphicM©ch”
;

29 
	gusšg
 ::
‹¡šg
::
PŞymÜphicM©ch”
;

33 
	g‹m¶©e
 <
ty³Çme
 
	gDomaš
,y³Çm
	gRªge
>

34 şas 
	cFš™eDomašM©ch”
 {

35 
	gpublic
:

36 
DesüibeTo
(
¡d
::
o¡»am
* 
os
) const {

37 *
os
 << "function maps given inputo output";

39 
DesüibeNeg©iÚTo
(
¡d
::
o¡»am
* 
os
) const {

40 *
os
 << "function mapsƒvery given inputo something otherhanhe "

43 
boŞ
 
M©chAndEx¶aš
(

44 cÚ¡ 
ab¦
::
İtiÚ®
<
¡d
::
veùÜ
<¡d::
·œ
<
Domaš
, 
Rªge
>>>& 
šput
,

45 ::
‹¡šg
::
M©chResuÉLi¡’”
* 
»suÉ_li¡’”
) const {

46 ià(!
šput
) {

47 *
»suÉ_li¡’”
 << "No input given";

48  
	gçl£
;

50 
boŞ
 
sucûss
(
Œue
);

51 autØ
	g·œ
 : *
šput
) {

52 autØ
š
 = 
·œ
.
fœ¡
;

53 autØ
	gout
 = 
·œ
.
£cÚd
;

54 autØ
	gaùu®
 = 
f_
(
š
);

55 ià(
	gaùu®
 !ğ
out
) {

56 *
»suÉ_li¡’”
 << "IÅuˆwas: " << 
š
 << ", Ex³ùed" << 
out


57 << ", Aùu®" << 
aùu®
;

58 
	gsucûss
 = 
çl£
;

62  
	gsucûss
;

64 
ex¶ic™
 
Fš™eDomašM©ch”
(cÚ¡ 
¡d
::
funùiÚ
<
Rªge
(
Domaš
)>& 
f
è: 
f_
(f) {}

66 
´iv©e
:

67 cÚ¡ 
¡d
::
funùiÚ
<
Rªge
(
Domaš
)> 
f_
;

70 
	g‹m¶©e
 <
ty³Çme
 
	gDomaš
,y³Çm
	gRªge
>

71 
	gPŞymÜphicM©ch”
<
	gFš™eDomašM©ch”
<
	gDomaš
, 
	gRªge
>> 
IsFš™eRe¡riùiÚOf
(

72 cÚ¡ 
¡d
::
funùiÚ
<
Rªge
(
Domaš
)>& 
f
) {

73  
MakePŞymÜphicM©ch”
(
Fš™eDomašM©ch”
<
Domaš
, 
Rªge
>(
f
));

76 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

77 
	gab¦
::
İtiÚ®
<
¡d
::
veùÜ
<¡d::
·œ
<
T
, 
	gU
>>> 
z
(¡d::veùÜ<T> 
ts
,

78 
¡d
::
veùÜ
<
U
> 
us
) {

79 ià(
ts
.
size
(è!ğ
us
.size()) {

80  
ab¦
::
nuÎİt
;

82 
	g¡d
::
veùÜ
<
¡d
::
·œ
<
T
, 
	gU
>> 
	g·œs
;

83 
	g»suÉ_size
 = 
us
.
size
();

84 
	gi
 = 0; i < 
	g»suÉ_size
; i++) {

85 
	g·œs
.
push_back
(
¡d
::
make_·œ
(
ts
[
i
], 
us
[i]));

87  
	g·œs
;

90 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

91 
	gab¦
::
İtiÚ®
<
¡d
::
veùÜ
<¡d::
·œ
<, 
	gT
>>> 
FuzzFš™eFunùiÚW™hF®lback
(

92 
¡d
::
veùÜ
<>& 
šput
, std::veùÜ<
T
>& 
ouut
, T 
çÎback
,

93 
™”_bound
) {

94 autØ
	g®l_ÿ£s
 = 
z
(
šput
, 
ouut
);

95 ià(!
	g®l_ÿ£s
) {

96  
	g®l_ÿ£s
;

99 autØ
	gbegš
 = 
šput
.
begš
();

100 autØ
	g’d
 = 
šput
.
’d
();

103 
	gi
 = 0; i < 
	g™”_bound
; i++) {

104 ià(
fšd
(
begš
, 
’d
, 
i
) ==ƒnd) {

105 
®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(
i
, 
çÎback
));

107 
	g¿nd_št
 = 
¿nd
();

108 ià(
fšd
(
begš
, 
’d
, 
¿nd_št
) ==ƒnd) {

109 
®l_ÿ£s
->
push_back
(
¡d
::
make_·œ
(
¿nd_št
, 
çÎback
));

112  
	g®l_ÿ£s
;

115 
	gab¦
::
İtiÚ®
<
¡d
::
veùÜ
<¡d::
·œ
<, >>> 
FuzzB™£tT¿n¦©iÚFunùiÚ
(

116 cÚ¡ 
¡d
::
veùÜ
<>& 
šput
, cÚ¡ std::veùÜ<>& 
ouut
,

117 
™”_bound
);

	@test/util/grpc_debug_config.cc

19 
	~"asylo/‹¡/ut/g½c_debug_cÚfig.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
S‘EnşaveG½cT¿û
(
ab¦
::
¡ršg_v›w
 
Œaû_Ëv–
,

24 
EnşaveCÚfig
 *
cÚfig
) {

25 
EnvœÚm’tV¬ŸbË
 *
	gŒaû
 = 
cÚfig
->
add_’vœÚm’t_v¬ŸbËs
();

26 
	gŒaû
->
£t_Çme
("GRPC_TRACE");

27 
	gŒaû
->
£t_v®ue
(
Œaû_Ëv–
);

30 
S‘EnşaveG½cV”bos™y
(
ab¦
::
¡ršg_v›w
 
v”bos™y_Ëv–
,

31 
EnşaveCÚfig
 *
cÚfig
) {

32 
EnvœÚm’tV¬ŸbË
 *
	gv”bos™y
 = 
cÚfig
->
add_’vœÚm’t_v¬ŸbËs
();

33 
	gv”bos™y
->
£t_Çme
("GRPC_VERBOSITY");

34 
	gv”bos™y
->
£t_v®ue
(
v”bos™y_Ëv–
);

37 
S‘EnşaveG½cDebugCÚfig
(
EnşaveCÚfig
 *
cÚfig
) {

38 
S‘EnşaveG½cT¿û
("®l", 
cÚfig
);

39 
S‘EnşaveG½cV”bos™y
("debug", 
cÚfig
);

	@test/util/grpc_debug_config.cc

19 
	~"asylo/‹¡/ut/g½c_debug_cÚfig.h
"

21 
Çme¥aû
 
	gasylo
 {

23 
S‘EnşaveG½cT¿û
(
ab¦
::
¡ršg_v›w
 
Œaû_Ëv–
,

24 
EnşaveCÚfig
 *
cÚfig
) {

25 
EnvœÚm’tV¬ŸbË
 *
	gŒaû
 = 
cÚfig
->
add_’vœÚm’t_v¬ŸbËs
();

26 
	gŒaû
->
£t_Çme
("GRPC_TRACE");

27 
	gŒaû
->
£t_v®ue
(
Œaû_Ëv–
);

30 
S‘EnşaveG½cV”bos™y
(
ab¦
::
¡ršg_v›w
 
v”bos™y_Ëv–
,

31 
EnşaveCÚfig
 *
cÚfig
) {

32 
EnvœÚm’tV¬ŸbË
 *
	gv”bos™y
 = 
cÚfig
->
add_’vœÚm’t_v¬ŸbËs
();

33 
	gv”bos™y
->
£t_Çme
("GRPC_VERBOSITY");

34 
	gv”bos™y
->
£t_v®ue
(
v”bos™y_Ëv–
);

37 
S‘EnşaveG½cDebugCÚfig
(
EnşaveCÚfig
 *
cÚfig
) {

38 
S‘EnşaveG½cT¿û
("®l", 
cÚfig
);

39 
S‘EnşaveG½cV”bos™y
("debug", 
cÚfig
);

	@test/util/grpc_debug_config.h

19 #iâdeà
ASYLO_TEST_UTIL_GRPC_DEBUG_CONFIG_H_


20 
	#ASYLO_TEST_UTIL_GRPC_DEBUG_CONFIG_H_


	)

22 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

23 
	~"asylo/’şave.pb.h
"

25 
Çme¥aû
 
	gasylo
 {

33 
S‘EnşaveG½cT¿û
(
ab¦
::
¡ršg_v›w
 
Œaû_Ëv–
, 
EnşaveCÚfig
 *
cÚfig
);

42 
S‘EnşaveG½cV”bos™y
(
ab¦
::
¡ršg_v›w
 
v”bos™y_Ëv–
,

43 
EnşaveCÚfig
 *
cÚfig
);

47 
S‘EnşaveG½cDebugCÚfig
(
EnşaveCÚfig
 *
cÚfig
);

	@test/util/mock_enclave_client.h

19 #iâdeà
ASYLO_TEST_UTIL_MOCK_ENCLAVE_CLIENT_H_


20 
	#ASYLO_TEST_UTIL_MOCK_ENCLAVE_CLIENT_H_


	)

22 
	~<gmock/gmock.h
>

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

30 şas 
	cMockEnşaveCl›Á
 : 
public
 
EnşaveCl›Á
 {

31 
public
:

32 
MockEnşaveCl›Á
(è: 
EnşaveCl›Á
("mock") {}

34 
MOCK_METHOD2
(
EÁ”AndRun
, 
Stus
(cÚ¡ 
EnşaveIÅut
 &, 
EnşaveOuut
 *));

35 
MOCK_CONST_METHOD0
(
g‘_Çme
, cÚ¡ 
¡d
::
¡ršg
 &());

36 
MOCK_METHOD1
(
EÁ”AndIn™Ÿlize
, 
Stus
(cÚ¡ 
EnşaveCÚfig
 &));

37 
MOCK_METHOD1
(
EÁ”AndFš®ize
, 
Stus
(cÚ¡ 
EnşaveFš®
 &));

38 
MOCK_METHOD0
(
EÁ”AndDÚ©eTh»ad
, 
Stus
());

39 
MOCK_METHOD1
(
EÁ”AndHªdËSigÇl
, 
Stus
(cÚ¡ 
EnşaveSigÇl
 &));

40 
MOCK_METHOD0
(
De¡royEnşave
, 
Stus
());

	@test/util/mock_enclave_loader.h

19 #iâdeà
ASYLO_TEST_UTIL_MOCK_ENCLAVE_LOADER_H_


20 
	#ASYLO_TEST_UTIL_MOCK_ENCLAVE_LOADER_H_


	)

22 
	~<gmock/gmock.h
>

23 
	~"asylo/ş›Á.h
"

24 
	~"asylo/ut/¡©us.h
"

26 
Çme¥aû
 
	gasylo
 {

29 şas 
	cMockEnşaveLßd”
 : 
public
 
EnşaveLßd”
 {

30 
public
:

31 
MOCK_CONST_METHOD4
(
LßdEnşave
,

32 
StusOr
<
¡d
::
unique_±r
<
EnşaveCl›Á
>>(

33 cÚ¡ 
¡d
::
¡ršg
 &
Çme
, *
ba£_add»ss
,

34 cÚ¡ 
size_t
 
’şave_size
,

35 cÚ¡ 
EnşaveCÚfig
 &
cÚfig
));

37 
MOCK_CONST_METHOD0
(
Cİy
, 
StusOr
<
¡d
::
unique_±r
<
EnşaveLßd”
>>());

	@test/util/mock_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/‹¡/ut/mock_’şave_ş›Á.h
"

23 
	~"asylo/‹¡/ut/mock_’şave_lßd”.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

30 
TEST
(
MockTe¡
, 
MockEnşaveLßd”
è{ MockEnşaveLßd” 
	glßd”
; }

32 
TEST
(
MockTe¡
, 
MockEnşaveCl›Á
è{ MockEnşaveCl›Á 
	glßd”
; }

	@test/util/mock_test.cc

19 
	~<gmock/gmock.h
>

20 
	~<g‹¡/g‹¡.h
>

22 
	~"asylo/‹¡/ut/mock_’şave_ş›Á.h
"

23 
	~"asylo/‹¡/ut/mock_’şave_lßd”.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

30 
TEST
(
MockTe¡
, 
MockEnşaveLßd”
è{ MockEnşaveLßd” 
	glßd”
; }

32 
TEST
(
MockTe¡
, 
MockEnşaveCl›Á
è{ MockEnşaveCl›Á 
	glßd”
; }

	@test/util/output_collector.cc

19 
	~"asylo/‹¡/ut/ouut_cŞËùÜ.h
"

21 
	~<fú.h
>

22 
	~<uni¡d.h
>

23 
	~<û¼no
>

24 
	~<c¡ršg
>

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/ut/fd_uts.h
"

28 
	~"asylo/ut/¡©us_maüos.h
"

30 
Çme¥aû
 
	gasylo
 {

32 
	gOuutCŞËùÜ
::
OuutCŞËùÜ
(
š‹º®
::
FromStdoutTag
)

33 : 
OuutCŞËùÜ
(
STDOUT_FILENO
) {}

35 
OuutCŞËùÜ
::OuutCŞËùÜ(
š‹º®
::
FromStd”rTag
)

36 : 
OuutCŞËùÜ
(
STDERR_FILENO
) {}

38 
OuutCŞËùÜ
::OuutCŞËùÜ(
fd
)

39 : 
is_aùive_
(
Œue
), 
rg‘_fd_
(
fd
), 
fd_cİy_
(
dup
(fd)) {

40 
CHECK_NE
(
fd_cİy_
, -1è<< 
¡»¼Ü
(
”ºo
);

41 
	gpe_fds
[2];

42 
CHECK_NE
(
pe
(
pe_fds
), -1è<< 
¡»¼Ü
(
”ºo
);

46 autØ
	gg‘_æags_»suÉ
 = 
G‘FdFÏgs
(
rg‘_fd_
);

47 
ASYLO_CHECK_OK
(
g‘_æags_»suÉ
.
¡©us
());

48 
ASYLO_CHECK_OK
(
S‘FdFÏgs
(
pe_fds
[1], 
g‘_æags_»suÉ
.
V®ueOrD›
()));

50 
CHECK_NE
(
dup2
(
pe_fds
[1], 
rg‘_fd_
), -1è<< 
¡»¼Ü
(
”ºo
);

51 
CHECK_NE
(
şo£
(
pe_fds
[1]), -1è<< 
¡»¼Ü
(
”ºo
);

52 
	g»ad_fd_
 = 
pe_fds
[0];

56 
ASYLO_CHECK_OK
(
AddFdFÏgs
(
»ad_fd_
, 
O_NONBLOCK
));

59 
	gOuutCŞËùÜ
::~
OuutCŞËùÜ
() {

60 
Re¡Üe
();

61 
CHECK_NE
(
şo£
(
»ad_fd_
), -1è<< 
¡»¼Ü
(
”ºo
);

64 
	gStusOr
<
	g¡d
::
¡ršg
> 
OuutCŞËùÜ
::
CŞËùOuutSoF¬
() const {

65 
¡d
::
¡ršg
 
cŞËùed_wr™es
;

66 
ASYLO_ASSIGN_OR_RETURN
(
cŞËùed_wr™es
, 
R—dAÎNoBlock
(
»ad_fd_
));

67 
ASYLO_RETURN_IF_ERROR
(
Wr™eAÎ
(
fd_cİy_
, 
cŞËùed_wr™es
));

68  
	gcŞËùed_wr™es
;

71 
	gStusOr
<
	g¡d
::
¡ršg
> 
OuutCŞËùÜ
::
CŞËùAÎOuutAndRe¡Üe
() {

72 
Re¡Üe
();

75 
ASYLO_RETURN_IF_ERROR
(
RemoveFdFÏgs
(
»ad_fd_
, 
O_NONBLOCK
));

77 
	g¡d
::
¡ršg
 
cŞËùed_wr™es
;

78 
ASYLO_ASSIGN_OR_RETURN
(
cŞËùed_wr™es
, 
R—dAÎ
(
»ad_fd_
));

79 
ASYLO_RETURN_IF_ERROR
(
Wr™eAÎ
(
rg‘_fd_
, 
cŞËùed_wr™es
));

80  
	gcŞËùed_wr™es
;

83 
	gOuutCŞËùÜ
::
Re¡Üe
() {

84 ià(
is_aùive_
) {

85 
is_aùive_
 = 
çl£
;

86 
CHECK_NE
(
dup2
(
fd_cİy_
, 
rg‘_fd_
), -1è<< 
¡»¼Ü
(
”ºo
);

87 
CHECK_NE
(
şo£
(
fd_cİy_
), -1è<< 
¡»¼Ü
(
”ºo
);

	@test/util/output_collector.cc

19 
	~"asylo/‹¡/ut/ouut_cŞËùÜ.h
"

21 
	~<fú.h
>

22 
	~<uni¡d.h
>

23 
	~<û¼no
>

24 
	~<c¡ršg
>

26 
	~"asylo/ut/loggšg.h
"

27 
	~"asylo/ut/fd_uts.h
"

28 
	~"asylo/ut/¡©us_maüos.h
"

30 
Çme¥aû
 
	gasylo
 {

32 
	gOuutCŞËùÜ
::
OuutCŞËùÜ
(
š‹º®
::
FromStdoutTag
)

33 : 
OuutCŞËùÜ
(
STDOUT_FILENO
) {}

35 
OuutCŞËùÜ
::OuutCŞËùÜ(
š‹º®
::
FromStd”rTag
)

36 : 
OuutCŞËùÜ
(
STDERR_FILENO
) {}

38 
OuutCŞËùÜ
::OuutCŞËùÜ(
fd
)

39 : 
is_aùive_
(
Œue
), 
rg‘_fd_
(
fd
), 
fd_cİy_
(
dup
(fd)) {

40 
CHECK_NE
(
fd_cİy_
, -1è<< 
¡»¼Ü
(
”ºo
);

41 
	gpe_fds
[2];

42 
CHECK_NE
(
pe
(
pe_fds
), -1è<< 
¡»¼Ü
(
”ºo
);

46 autØ
	gg‘_æags_»suÉ
 = 
G‘FdFÏgs
(
rg‘_fd_
);

47 
ASYLO_CHECK_OK
(
g‘_æags_»suÉ
.
¡©us
());

48 
ASYLO_CHECK_OK
(
S‘FdFÏgs
(
pe_fds
[1], 
g‘_æags_»suÉ
.
V®ueOrD›
()));

50 
CHECK_NE
(
dup2
(
pe_fds
[1], 
rg‘_fd_
), -1è<< 
¡»¼Ü
(
”ºo
);

51 
CHECK_NE
(
şo£
(
pe_fds
[1]), -1è<< 
¡»¼Ü
(
”ºo
);

52 
	g»ad_fd_
 = 
pe_fds
[0];

56 
ASYLO_CHECK_OK
(
AddFdFÏgs
(
»ad_fd_
, 
O_NONBLOCK
));

59 
	gOuutCŞËùÜ
::~
OuutCŞËùÜ
() {

60 
Re¡Üe
();

61 
CHECK_NE
(
şo£
(
»ad_fd_
), -1è<< 
¡»¼Ü
(
”ºo
);

64 
	gStusOr
<
	g¡d
::
¡ršg
> 
OuutCŞËùÜ
::
CŞËùOuutSoF¬
() const {

65 
¡d
::
¡ršg
 
cŞËùed_wr™es
;

66 
ASYLO_ASSIGN_OR_RETURN
(
cŞËùed_wr™es
, 
R—dAÎNoBlock
(
»ad_fd_
));

67 
ASYLO_RETURN_IF_ERROR
(
Wr™eAÎ
(
fd_cİy_
, 
cŞËùed_wr™es
));

68  
	gcŞËùed_wr™es
;

71 
	gStusOr
<
	g¡d
::
¡ršg
> 
OuutCŞËùÜ
::
CŞËùAÎOuutAndRe¡Üe
() {

72 
Re¡Üe
();

75 
ASYLO_RETURN_IF_ERROR
(
RemoveFdFÏgs
(
»ad_fd_
, 
O_NONBLOCK
));

77 
	g¡d
::
¡ršg
 
cŞËùed_wr™es
;

78 
ASYLO_ASSIGN_OR_RETURN
(
cŞËùed_wr™es
, 
R—dAÎ
(
»ad_fd_
));

79 
ASYLO_RETURN_IF_ERROR
(
Wr™eAÎ
(
rg‘_fd_
, 
cŞËùed_wr™es
));

80  
	gcŞËùed_wr™es
;

83 
	gOuutCŞËùÜ
::
Re¡Üe
() {

84 ià(
is_aùive_
) {

85 
is_aùive_
 = 
çl£
;

86 
CHECK_NE
(
dup2
(
fd_cİy_
, 
rg‘_fd_
), -1è<< 
¡»¼Ü
(
”ºo
);

87 
CHECK_NE
(
şo£
(
fd_cİy_
), -1è<< 
¡»¼Ü
(
”ºo
);

	@test/util/output_collector.h

19 #iâdeà
ASYLO_TEST_UTIL_OUTPUT_COLLECTOR_H_


20 
	#ASYLO_TEST_UTIL_OUTPUT_COLLECTOR_H_


	)

22 
	~<¡ršg
>

24 
	~"asylo/ut/¡©usÜ.h
"

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	gš‹º®
 {

29 
	sFromStdoutTag
 {};

30 
	sFromStd”rTag
 {};

35 
cÚ¡ex´
 
	gš‹º®
::
FromStdoutTag
 
kCŞËùStdout
;

38 
cÚ¡ex´
 
	gš‹º®
::
FromStd”rTag
 
kCŞËùStd”r
;

41 şas 
	cOuutCŞËùÜ
 {

42 
	gpublic
:

44 
ex¶ic™
 
OuutCŞËùÜ
(
š‹º®
::
FromStdoutTag
);

47 
ex¶ic™
 
OuutCŞËùÜ
(
š‹º®
::
FromStd”rTag
);

49 
OuutCŞËùÜ
(cÚ¡ OuutCŞËùÜ &
Ùh”
èğ
d–‘e
;

50 
	gOuutCŞËùÜ
 &
	gİ”©Ü
=(cÚ¡ 
OuutCŞËùÜ
 &
Ùh”
èğ
d–‘e
;

52 ~
OuutCŞËùÜ
();

57 
	gStusOr
<
	g¡d
::
¡ršg
> 
CŞËùOuutSoF¬
() const;

67 
	gStusOr
<
	g¡d
::
¡ršg
> 
CŞËùAÎOuutAndRe¡Üe
();

69 
	g´iv©e
:

77 
ex¶ic™
 
OuutCŞËùÜ
(
fd
);

80 
Re¡Üe
();

82 
boŞ
 
	gis_aùive_
;

85 
	grg‘_fd_
;

88 
	g»ad_fd_
;

92 
	gfd_cİy_
;

	@test/util/proto_matchers.h

19 #iâdeà
ASYLO_TEST_UTIL_PROTO_MATCHERS_H_


20 
	#ASYLO_TEST_UTIL_PROTO_MATCHERS_H_


	)

22 
	~<googË/´Ùobuf/ut/mes§ge_difã»nûr.h
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
Çme¥aû
 
	gasylo
 {

28 
Çme¥aû
 
	gš‹º®
 {

29 
	g‹m¶©e
 <
ty³Çme
 
	gMes§geT
>

30 şas 
	cPrÙoM©ch”
 {

31 
	gpublic
:

32 
PrÙoM©ch”
(cÚ¡ 
Mes§geT
 &
mes§ge
,

33 
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
Mes§geT
 &, const MessageT &)>

34 
mes§ge_com·¿tÜ
)

35 : 
mes§ge_
(
mes§ge
), 
mes§ge_com·¿tÜ_
(
¡d
::
move
(
mes§ge_com·¿tÜ
)) {}

37 
DesüibeTo
(
¡d
::
o¡»am
 *
os
) const { *os << "matches"; }

39 
DesüibeNeg©iÚTo
(
¡d
::
o¡»am
 *
os
) const { *os << "does‚ot match"; }

41 
boŞ
 
M©chAndEx¶aš
(cÚ¡ 
Mes§geT
 &
mes§ge
,

42 ::
‹¡šg
::
M©chResuÉLi¡’”
 *
li¡’”
) const {

43 ià(!
mes§ge_com·¿tÜ_
(
mes§ge
, 
mes§ge_
)) {

44 *
	gli¡’”
 << "which doesn't match";

45  
	gçl£
;

47  
	gŒue
;

50 
	g´iv©e
:

51 cÚ¡ 
Mes§geT
 &
mes§ge_
;

52 
	g¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
Mes§geT
 &, cÚ¡ Mes§geT &)> 
	gmes§ge_com·¿tÜ_
;

59 
	g‹m¶©e
 <
ty³Çme
 
	gMes§geT
>

60 ::
‹¡šg
::
PŞymÜphicM©ch”
<
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>> 
	$Equ®sPrÙo
(

61 cÚ¡ 
Mes§geT
 &
mes§ge
) {

62 
¡d
::
funùiÚ
<
	`boŞ
(cÚ¡ 
Mes§geT
 &, cÚ¡ Mes§geT &)> 
com·¿tÜ
 =

63 ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equ®s
;

64  ::
‹¡šg
::
	`MakePŞymÜphicM©ch”
(

65 
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>(
mes§ge
, 
¡d
::
	`move
(
com·¿tÜ
)));

66 
	}
}

72 
	g‹m¶©e
 <
ty³Çme
 
	gMes§geT
>

73 ::
‹¡šg
::
PŞymÜphicM©ch”
<
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>> 
	$Equiv®’tPrÙo
(

74 cÚ¡ 
Mes§geT
 &
mes§ge
) {

75 
¡d
::
funùiÚ
<
	`boŞ
(cÚ¡ 
Mes§geT
 &, cÚ¡ Mes§geT &)> 
com·¿tÜ
 =

76 ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Equiv®’t
;

77  ::
‹¡šg
::
	`MakePŞymÜphicM©ch”
(

78 
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>(
mes§ge
, 
¡d
::
	`move
(
com·¿tÜ
)));

79 
	}
}

84 
	g‹m¶©e
 <
ty³Çme
 
	gMes§geT
>

85 ::
‹¡šg
::
PŞymÜphicM©ch”
<
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>>

86 
	$Aµroxim©–yEqu®sPrÙo
(cÚ¡ 
Mes§geT
 &
mes§ge
) {

87 
¡d
::
funùiÚ
<
	`boŞ
(cÚ¡ 
Mes§geT
 &, cÚ¡ Mes§geT &)> 
com·¿tÜ
 =

88 ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Aµroxim©–yEqu®s
;

89  ::
‹¡šg
::
	`MakePŞymÜphicM©ch”
(

90 
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>(
mes§ge
, 
¡d
::
	`move
(
com·¿tÜ
)));

91 
	}
}

96 
	g‹m¶©e
 <
ty³Çme
 
	gMes§geT
>

97 ::
‹¡šg
::
PŞymÜphicM©ch”
<
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>>

98 
	$Aµroxim©–yEquiv®’tPrÙo
(cÚ¡ 
Mes§geT
 &
mes§ge
) {

99 
¡d
::
funùiÚ
<
	`boŞ
(cÚ¡ 
Mes§geT
 &, cÚ¡ Mes§geT &)> 
com·¿tÜ
 =

100 ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
Aµroxim©–yEquiv®’t
;

101  ::
‹¡šg
::
	`MakePŞymÜphicM©ch”
(

102 
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>(
mes§ge
, 
¡d
::
	`move
(
com·¿tÜ
)));

103 
	}
}

107 
	g‹m¶©e
 <
ty³Çme
 
	gMes§geT
>

108 ::
‹¡šg
::
PŞymÜphicM©ch”
<
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>> 
	$P¬tŸÎy
(

109 cÚ¡ 
Mes§geT
 &
mes§ge
) {

110 
¡d
::
funùiÚ
<
	`boŞ
(cÚ¡ 
Mes§geT
 &, cÚ¡ Mes§geT &)> 
com·¿tÜ
 =

111 [](cÚ¡ ::
googË
::
´Ùobuf
::
Mes§ge
 &
¬g
, cÚ¡ ::googË::´Ùobuf::Mes§g&
Ùh”
) {

112 ::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
 
difãr
;

113 
difãr
.
	`£t_scİe
(::
googË
::
´Ùobuf
::
ut
::
Mes§geDifã»nûr
::
PARTIAL
);

114  
difãr
.
	`Com·»
(
Ùh”
, 
¬g
);

116  ::
‹¡šg
::
	`MakePŞymÜphicM©ch”
(

117 
š‹º®
::
PrÙoM©ch”
<
Mes§geT
>(
mes§ge
, 
¡d
::
	`move
(
com·¿tÜ
)));

118 
	}
}

	@test/util/pthread_test_util.cc

19 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

21 
	~<İ’s¦/mem.h
>

22 
	~<±h»ad.h
>

23 
	~<c¡dšt
>

24 
	~<c¡dio
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
Çme¥aû
 
	gasylo
 {

30 
BusyWÜk
() {

31 
cÚ¡ex´
 
	gkBufãrSize
 = 4096;

36 
ušt8_t
 
	gbuf
[
kBufãrSize
];

37 
OPENSSL_ş—n£
(
buf
, 
kBufãrSize
);

40 
Stus
 
LaunchTh»ads
(cÚ¡ 
numTh»ads
, *(*
¡¬t_routše
)(*),

41 *
¬g
, 
¡d
::
veùÜ
<
±h»ad_t
> *
th»ads
) {

42 
i
 = 0; 
	gi
 < 
	gnumTh»ads
; ++i) {

43 
±h»ad_t
 
	gÃw_th»ad
;

44 
	g»t
 = 
±h»ad_ü—‹
(&
Ãw_th»ad
, 
nuÎ±r
, 
¡¬t_routše
, 
¬g
);

45 ià(
	g»t
 != 0) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

47 
ab¦
::
SŒC©
("FaedØü—‹h»ad: ", 
»t
));

49 
	gth»ads
->
em¶aû_back
(
Ãw_th»ad
);

52  
	gStus
::
OkStus
();

55 
Stus
 
JošTh»ads
(cÚ¡ 
¡d
::
veùÜ
<
±h»ad_t
> &
th»ads
) {

56 
i
 = 0; 
	gi
 < 
	gth»ads
.
size
(); ++i) {

57 
	g»t
 = 
±h»ad_još
(
th»ads
[
i
], 
nuÎ±r
);

58 ià(
	g»t
 != 0) {

59  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

60 
ab¦
::
SŒC©
("FaedØjošh»ad: ", 
»t
));

64  
	gStus
::
OkStus
();

67 
Stus
 
CheckInRªge
(cÚ¡ 
v®ue
, 
ab¦
::
¡ršg_v›w
 
debug_Çme
,

68 cÚ¡ 
mš_®lowed
, cÚ¡ 
max_®lowed
) {

69 ià(
	gv®ue
 < 
	gmš_®lowed
 || v®u> 
	gmax_®lowed
) {

70  
Stus
(

71 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

72 
ab¦
::
SŒC©
("Ëg® v®uoà", 
debug_Çme
, ": cu¼’y ", 
v®ue
,

73 "; mu¡ bš„ªg", 
mš_®lowed
, "-", 
max_®lowed
));

75  
	gStus
::
OkStus
();

	@test/util/pthread_test_util.cc

19 
	~"asylo/‹¡/ut/±h»ad_‹¡_ut.h
"

21 
	~<İ’s¦/mem.h
>

22 
	~<±h»ad.h
>

23 
	~<c¡dšt
>

24 
	~<c¡dio
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
Çme¥aû
 
	gasylo
 {

30 
BusyWÜk
() {

31 
cÚ¡ex´
 
	gkBufãrSize
 = 4096;

36 
ušt8_t
 
	gbuf
[
kBufãrSize
];

37 
OPENSSL_ş—n£
(
buf
, 
kBufãrSize
);

40 
Stus
 
LaunchTh»ads
(cÚ¡ 
numTh»ads
, *(*
¡¬t_routše
)(*),

41 *
¬g
, 
¡d
::
veùÜ
<
±h»ad_t
> *
th»ads
) {

42 
i
 = 0; 
	gi
 < 
	gnumTh»ads
; ++i) {

43 
±h»ad_t
 
	gÃw_th»ad
;

44 
	g»t
 = 
±h»ad_ü—‹
(&
Ãw_th»ad
, 
nuÎ±r
, 
¡¬t_routše
, 
¬g
);

45 ià(
	g»t
 != 0) {

46  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

47 
ab¦
::
SŒC©
("FaedØü—‹h»ad: ", 
»t
));

49 
	gth»ads
->
em¶aû_back
(
Ãw_th»ad
);

52  
	gStus
::
OkStus
();

55 
Stus
 
JošTh»ads
(cÚ¡ 
¡d
::
veùÜ
<
±h»ad_t
> &
th»ads
) {

56 
i
 = 0; 
	gi
 < 
	gth»ads
.
size
(); ++i) {

57 
	g»t
 = 
±h»ad_još
(
th»ads
[
i
], 
nuÎ±r
);

58 ià(
	g»t
 != 0) {

59  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

60 
ab¦
::
SŒC©
("FaedØjošh»ad: ", 
»t
));

64  
	gStus
::
OkStus
();

67 
Stus
 
CheckInRªge
(cÚ¡ 
v®ue
, 
ab¦
::
¡ršg_v›w
 
debug_Çme
,

68 cÚ¡ 
mš_®lowed
, cÚ¡ 
max_®lowed
) {

69 ià(
	gv®ue
 < 
	gmš_®lowed
 || v®u> 
	gmax_®lowed
) {

70  
Stus
(

71 
”rÜ
::
GoogËE¼Ü
::
FAILED_PRECONDITION
,

72 
ab¦
::
SŒC©
("Ëg® v®uoà", 
debug_Çme
, ": cu¼’y ", 
v®ue
,

73 "; mu¡ bš„ªg", 
mš_®lowed
, "-", 
max_®lowed
));

75  
	gStus
::
OkStus
();

	@test/util/pthread_test_util.h

19 #iâdeà
ASYLO_TEST_UTIL_PTHREAD_TEST_UTIL_H_


20 
	#ASYLO_TEST_UTIL_PTHREAD_TEST_UTIL_H_


	)

22 
	~<±h»ad.h
>

23 
	~<veùÜ
>

25 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

31 
BusyWÜk
();

35 
Stus
 
LaunchTh»ads
(cÚ¡ 
numTh»ads
, *(*
¡¬t_routše
)(*),

36 *
¬g
, 
¡d
::
veùÜ
<
±h»ad_t
> *
th»ads
);

39 
Stus
 
JošTh»ads
(cÚ¡ 
¡d
::
veùÜ
<
±h»ad_t
> &
th»ads
);

43 
Stus
 
CheckInRªge
(cÚ¡ 
v®ue
, 
ab¦
::
¡ršg_v›w
 
debug_Çme
,

44 cÚ¡ 
mš_®lowed
, cÚ¡ 
max_®lowed
);

	@test/util/status_matchers.h

19 #iâdeà
ASYLO_TEST_UTIL_STATUS_MATCHERS_H_


20 
	#ASYLO_TEST_UTIL_STATUS_MATCHERS_H_


	)

22 
	~<memÜy
>

24 
	~<gmock/gmock-m©ch”s.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"ab¦/ty³s/İtiÚ®.h
"

28 
	~"asylo/ut/¡©us.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
Çme¥aû
 
	gš‹º®
 {

36 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

37 
şass
 
	gIsOkAndHŞdsM©ch”


38 : 
public
 ::
‹¡šg
::
M©ch”IÁ”çû
<cÚ¡ 
StusOr
<
T
> &> {

39 
public
:

40 
‹m¶©e
 <
ty³Çme
 
M©ch”T
>

41 
IsOkAndHŞdsM©ch”
(
M©ch”T
 &&
v®ue_m©ch”
)

42 : 
v®ue_m©ch”_
(::
‹¡šg
::
SaãM©ch”Ca¡
<cÚ¡ 
T
 &>(
v®ue_m©ch”
)) {}

45 
DesüibeTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

46 *
os
 << "is OK‡nd contains‡ valuehat ";

47 
	gv®ue_m©ch”_
.
DesüibeTo
(
os
);

51 
DesüibeNeg©iÚTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

52 *
os
 << "is‚ot OK or contains‡ valuehat ";

53 
	gv®ue_m©ch”_
.
DesüibeNeg©iÚTo
(
os
);

57 
boŞ
 
M©chAndEx¶aš
(

58 cÚ¡ 
StusOr
<
T
> &
¡©us_Ü
,

59 ::
‹¡šg
::
M©chResuÉLi¡’”
 *
li¡’”
ècÚ¡ 
ov”ride
 {

60 ià(!
¡©us_Ü
.
ok
()) {

61 *
li¡’”
 << "which is‚ot OK";

62  
	gçl£
;

65 ::
‹¡šg
::
SŒšgM©chResuÉLi¡’”
 
v®ue_li¡’”
;

66 
boŞ
 
	gis_a_m©ch
 =

67 
v®ue_m©ch”_
.
M©chAndEx¶aš
(
¡©us_Ü
.
V®ueOrD›
(), &
v®ue_li¡’”
);

68 
	g¡d
::
¡ršg
 
v®ue_ex¶ª©iÚ
 = 
v®ue_li¡’”
.
¡r
();

69 ià(!
	gv®ue_ex¶ª©iÚ
.
em±y
()) {

70 *
	gli¡’”
 << 
	gab¦
::
SŒC©
("which cÚš ¨v®u", 
v®ue_ex¶ª©iÚ
);

73  
	gis_a_m©ch
;

76 
	g´iv©e
:

77 cÚ¡ ::
‹¡šg
::
M©ch”
<cÚ¡ 
T
 &> 
v®ue_m©ch”_
;

89 
	g‹m¶©e
 <
ty³Çme
 
	gV®ueM©ch”T
>

90 şas 
	cIsOkAndHŞdsG’”©Ü
 {

91 
	gpublic
:

92 
ex¶ic™
 
IsOkAndHŞdsG’”©Ü
(
V®ueM©ch”T
 
v®ue_m©ch”
)

93 : 
v®ue_m©ch”_
(
¡d
::
move
(
v®ue_m©ch”
)) {}

95 
‹m¶©e
 <
ty³Çme
 
T
>

96 
İ”©Ü
 ::
‹¡šg
::
M©ch”
<cÚ¡ 
StusOr
<
T
> &>() const {

97  ::
‹¡šg
::
MakeM©ch”
(
Ãw
 
IsOkAndHŞdsM©ch”
<
T
>(
v®ue_m©ch”_
));

100 
	g´iv©e
:

101 cÚ¡ 
V®ueM©ch”T
 
v®ue_m©ch”_
;

106 
	g‹m¶©e
 <
ty³Çme
 
	gEnum
>

107 
şass
 
	gStusM©ch”
 : 
public
 ::
‹¡šg
::
M©ch”IÁ”çû
<cÚ¡ 
Stus
 &> {

108 
public
:

109 
StusM©ch”
(
Enum
 
code
, 
ab¦
::
İtiÚ®
<ab¦::
¡ršg_v›w
> 
mes§ge
)

110 : 
code_
(
code
),

111 
mes§ge_
(
mes§ge
),

112 
”rÜ_¥aû_
(
”rÜ
::
”rÜ_’um_Œa™s
<
Enum
>::
g‘_”rÜ_¥aû
()) {}

117 
DesüibeTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

118 *
os
 << "”rÜ cod" << 
”rÜ_¥aû_
->
S·ûName
()

119 << "::" << 
”rÜ_¥aû_
->
SŒšg
(
¡©ic_ÿ¡
<>(
code_
));

120 ià(
	gmes§ge_
.
has_v®ue
()) {

121 *
	gos
 << "::'" << 
	gmes§ge_
.
v®ue
() << "'";

131 
boŞ
 
M©chAndEx¶aš
(

132 cÚ¡ 
Stus
 &
¡©us
,

133 ::
‹¡šg
::
M©chResuÉLi¡’”
 *
li¡’”
ècÚ¡ 
ov”ride
 {

134 ià(!
¡©us
.
Is
(
code_
)) {

135 *
li¡’”
 << "who£ƒ¼Ü codi " << 
¡©us
.
”rÜ_¥aû
()->
S·ûName
()

136 << "::" << 
¡©us
.
”rÜ_¥aû
()->
SŒšg
(¡©us.
”rÜ_code
());

137  
	gçl£
;

139 ià(
	gmes§ge_
.
has_v®ue
(è&& 
	g¡©us
.
”rÜ_mes§ge
(è!ğ
mes§ge_
.
v®ue
()) {

140 *
li¡’”
 << "who£ƒ¼Ü mes§gi '" << 
¡©us
.
”rÜ_mes§ge
() << "'";

141  
	gçl£
;

143  
	gŒue
;

146 
	g´iv©e
:

148 cÚ¡ 
Enum
 
code_
;

151 cÚ¡ 
	gab¦
::
İtiÚ®
<
¡d
::
¡ršg
> 
mes§ge_
;

154 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *cÚ¡ 
”rÜ_¥aû_
;

159 
	g‹m¶©e
 <
şass
 
	gT
>

160 
şass
 
	gIsOkM©ch”Im¶
 : 
public
 ::
‹¡šg
::
M©ch”IÁ”çû
<
T
> {

161 
public
:

162 
IsOkM©ch”Im¶
() = ;

167 
DesüibeTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 { *os << "is OK"; }

172 
DesüibeNeg©iÚTo
(
¡d
::
o¡»am
 *
os
ècÚ¡ 
ov”ride
 {

173 *
os
 << "is‚ot OK";

180 
boŞ
 
M©chAndEx¶aš
(

181 cÚ¡ 
T
 &
¡©us_cÚš”
,

182 ::
‹¡šg
::
M©chResuÉLi¡’”
 *
li¡’”
ècÚ¡ 
ov”ride
 {

183 ià(!
¡©us_cÚš”
.
ok
()) {

184 *
li¡’”
 << "which is‚ot OK";

185  
	gçl£
;

187  
	gŒue
;

196 şas 
	cIsOkM©ch”G’”©Ü
 {

197 
	gpublic
:

199 
İ”©Ü
 ::
‹¡šg
::
M©ch”
<cÚ¡ 
Stus
 &>() const {

200  ::
‹¡šg
::
MakeM©ch”
(

201 
Ãw
 
š‹º®
::
IsOkM©ch”Im¶
<cÚ¡ 
Stus
 &>());

205 
	g‹m¶©e
 <
şass
 
	gT
>

206 
	gİ”©Ü
 ::
‹¡šg
::
M©ch”
<cÚ¡ 
StusOr
<
T
> &>() const {

207  ::
‹¡šg
::
MakeM©ch”
(

208 
Ãw
 
š‹º®
::
IsOkM©ch”Im¶
<cÚ¡ 
StusOr
<
T
> &>());

230 
	g‹m¶©e
 <
ty³Çme
 
	gV®ueM©ch”T
>

231 
	gš‹º®
::
IsOkAndHŞdsG’”©Ü
<
V®ueM©ch”T
> 
	$IsOkAndHŞds
(

232 
V®ueM©ch”T
 
v®ue_m©ch”
) {

233  
š‹º®
::
IsOkAndHŞdsG’”©Ü
<
V®ueM©ch”T
>(
v®ue_m©ch”
);

234 
	}
}

238 
	g‹m¶©e
 <
ty³Çme
 
	gEnum
>

239 ::
‹¡šg
::
M©ch”
<cÚ¡ 
Stus
 &> 
	$StusIs
(
Enum
 
code
) {

240  ::
‹¡šg
::
	`MakeM©ch”
(

241 
Ãw
 
š‹º®
::
StusM©ch”
<
Enum
>(
code
, 
ab¦
::
nuÎİt
));

242 
	}
}

246 
	g‹m¶©e
 <
ty³Çme
 
	gEnum
>

247 ::
‹¡šg
::
M©ch”
<cÚ¡ 
Stus
 &> 
	$StusIs
(
Enum
 
code
,

248 
ab¦
::
¡ršg_v›w
 
mes§ge
) {

249  ::
‹¡šg
::
	`MakeM©ch”
(

250 
Ãw
 
š‹º®
::
StusM©ch”
<
Enum
>(
code
, 
mes§ge
));

251 
	}
}

256 
šlše
 
	gš‹º®
::
IsOkM©ch”G’”©Ü
 
	$IsOk
() {

257  
š‹º®
::
	`IsOkM©ch”G’”©Ü
();

258 
	}
}

262 
	#ASYLO_EXPECT_OK
(
»x´
è
	`EXPECT_THAT
Ôex´, ::
asylo
::
	$IsOk
())

	)

263 
	#ASYLO_ASSERT_OK
(
»x´
è
	`ASSERT_THAT
Ôex´, ::
asylo
::
	$IsOk
())

	)

278 
	#ASYLO_ASSERT_OK_AND_ASSIGN
(
lhs
, 
»x´
) \

280 autØ
_asylo_¡©us_to_v”ify
 = 
»x´
; \

281 ià(!
_asylo_¡©us_to_v”ify
.
	`ok
()) { \

282 
	`FAIL
() << #rexpr \

283 << "„‘uºedƒ¼Ü: " << 
_asylo_¡©us_to_v”ify
.
	`¡©us
(); \

285 
lhs
 = 
¡d
::
	`move
(
_asylo_¡©us_to_v”ify
).
	`V®ueOrD›
(); \

286 
	}
} 
çl£
)

	)

292 
‹m¶©e
 <
ty³Çme
 
T
>

293 
	`PrštTo
(cÚ¡ 
StusOr
<
T
> &
¡©usÜ
, 
¡d
::
o¡»am
 *
os
) {

294 ià(!
¡©usÜ
.
	`ok
()) {

295 *
os
 << 
¡©usÜ
.
	`¡©us
();

297 *
os
 << 
ab¦
::
	`SŒC©
("OK: ",

298 ::
‹¡šg
::
	`PrštToSŒšg
(
¡©usÜ
.
	`V®ueOrD›
()));

300 
	}
}

	@test/util/status_matchers_test.cc

19 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

21 
	~<s¡»am
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

33 
	gusšg
 ::
‹¡šg
::
Gt
;

34 
	gusšg
 ::
‹¡šg
::
HasSub¡r
;

35 
	gusšg
 ::
‹¡šg
::
IsEm±y
;

36 
	gusšg
 ::
‹¡šg
::
Lt
;

37 
	gusšg
 ::
‹¡šg
::
M©ch”
;

38 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
	gusšg
 ::
‹¡šg
::
SaãM©ch”Ca¡
;

40 
	gusšg
 ::
‹¡šg
::
SŒšgM©chResuÉLi¡’”
;

43 
	g‹m¶©e
 <
ty³Çme
 
	gM©ch“T
,y³Çm
	gM©ch”T
>

44 
	g¡d
::
¡ršg
 
M©ch”DesütiÚ
(cÚ¡ 
M©ch”T
 &
m©ch”
) {

45 
M©ch”
<cÚ¡ 
M©ch“T
 &> 
cÚv”‹d_m©ch”
 =

46 
SaãM©ch”Ca¡
<cÚ¡ 
M©ch“T
 &>(
m©ch”
);

48 
	g¡d
::
¡ršg¡»am
 
desütiÚ_¡»am
;

49 
	gcÚv”‹d_m©ch”
.
DesüibeTo
(&
desütiÚ_¡»am
);

50  
	gdesütiÚ_¡»am
.
¡r
();

55 
	g‹m¶©e
 <
ty³Çme
 
	gM©ch“T
,y³Çm
	gM©ch”T
>

56 
	g¡d
::
¡ršg
 
M©chEx¶ª©iÚ
(cÚ¡ 
M©ch”T
 &
m©ch”
, cÚ¡ 
M©ch“T
 &
v®ue
) {

57 
	gM©ch”
<cÚ¡ 
	gM©ch“T
 &> 
	gcÚv”‹d_m©ch”
 =

58 
SaãM©ch”Ca¡
<cÚ¡ 
M©ch“T
 &>(
m©ch”
);

60 
SŒšgM©chResuÉLi¡’”
 
	gli¡’”
;

61 
	gcÚv”‹d_m©ch”
.
M©chAndEx¶aš
(
v®ue
, &
li¡’”
);

62  
	gli¡’”
.
¡r
();

67 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsM©chesOkStusW™hM©chšgV®ue
) {

68 cÚ¡ 
	gStusOr
<> 
	gšt_¡©usÜ
 = 5;

69 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡ršg_¡©usÜ
 = 
¡d
::string("foobar");

71 
EXPECT_THAT
(
št_¡©usÜ
, 
IsOkAndHŞds
(
Eq
(5)));

72 
EXPECT_THAT
(
št_¡©usÜ
, 
IsOkAndHŞds
(
Gt
(2)));

73 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
IsOkAndHŞds
(
HasSub¡r
("oba")));

78 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsCÚv”tsNÚM©ch”ArgsToEqM©ch”s
) {

79 cÚ¡ 
	gStusOr
<> 
	gšt_¡©usÜ
 = 5;

80 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡ršg_¡©usÜ
 = 
¡d
::string("foobar");

82 
EXPECT_THAT
(
št_¡©usÜ
, 
IsOkAndHŞds
(5));

83 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
IsOkAndHŞds
("foobar"));

88 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsDÛsNÙM©chNÚOkStus
) {

89 cÚ¡ 
	gStusOr
<> 
	gnÚ_ok_¡©usÜ
 =

90 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "some_error");

92 
EXPECT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Lt
(3))));

93 
EXPECT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Eq
(3))));

94 
EXPECT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Gt
(3))));

99 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsDÛsNÙM©chIfV®ueM©ch”Fas
) {

100 cÚ¡ 
	gStusOr
<> 
	gšt_¡©usÜ
 = 5;

101 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡ršg_¡©usÜ
 = 
¡d
::string("foobar");

103 
EXPECT_THAT
(
št_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Lt
(4))));

104 
EXPECT_THAT
(
št_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Eq
(7))));

105 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
HasSub¡r
("baz"))));

106 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
IsEm±y
())));

111 
TEST
(
StusM©ch”sTe¡
,

112 
IsOkAndHŞdsDesüibesM©chAsOkAndM©chšgV®ueM©ch”
) {

113 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
IsOkAndHŞds
(
Eq
(5))),

114 
ab¦
::
SŒC©
("is OK‡nd contains‡ valuehat ",

115 
M©ch”DesütiÚ
<>(
Eq
(5))));

116 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
IsOkAndHŞds
(
Lt
(7))),

117 
ab¦
::
SŒC©
("is OK‡nd contains‡ valuehat ",

118 
M©ch”DesütiÚ
<>(
Lt
(7))));

119 
EXPECT_EQ
(

120 
M©ch”DesütiÚ
<
StusOr
<
¡d
::
¡ršg
>>(
IsOkAndHŞds
(
HasSub¡r
("foo"))),

121 
ab¦
::
SŒC©
("is OK‡nd contains‡ valuehat ",

122 
M©ch”DesütiÚ
<
¡d
::
¡ršg
>(
HasSub¡r
("foo"))));

127 
TEST
(
StusM©ch”sTe¡
,

128 
IsOkAndHŞdsDesüibesNÚM©chAsNÚOkOrNÙM©chšgV®ueM©ch”
) {

129 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
NÙ
(
IsOkAndHŞds
(
Eq
(5)))),

130 
ab¦
::
SŒC©
("is‚ot OK or contains‡ valuehat ",

131 
M©ch”DesütiÚ
<>(
NÙ
(
Eq
(5)))));

132 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
NÙ
(
IsOkAndHŞds
(
Lt
(7)))),

133 
ab¦
::
SŒC©
("is‚ot OK or contains‡ valuehat ",

134 
M©ch”DesütiÚ
<>(
NÙ
(
Lt
(7)))));

135 
EXPECT_EQ
(

136 
M©ch”DesütiÚ
<
StusOr
<
¡d
::
¡ršg
>>(

137 
NÙ
(
IsOkAndHŞds
(
HasSub¡r
("foo")))),

138 
ab¦
::
SŒC©
("is‚ot OK or contains‡ valuehat ",

139 
M©ch”DesütiÚ
<
¡d
::
¡ršg
>(
NÙ
(
HasSub¡r
("foo")))));

143 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsDÛsNÙEx¶ašSucûssfulM©ch
) {

144 cÚ¡ 
	g¡d
::
veùÜ
<> 
em±y_veùÜ
;

145 cÚ¡ 
	gStusOr
<
	g¡d
::
veùÜ
<>> 
m©chšg_¡©usÜ
 = 
em±y_veùÜ
;

147 
ASSERT_THAT
(
m©chšg_¡©usÜ
, 
IsOkAndHŞds
(
IsEm±y
()));

148 
EXPECT_EQ
(
M©chEx¶ª©iÚ
(
IsOkAndHŞds
(
IsEm±y
()), 
m©chšg_¡©usÜ
), "");

152 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsEx¶ašsNÚM©chCÜ»ùly
) {

153 cÚ¡ 
	g¡d
::
veùÜ
<> 
nÚ_em±y_veùÜ
 = {8, 6, 7, 5, 3, 0, 9};

154 cÚ¡ 
	gStusOr
<
	g¡d
::
veùÜ
<>> 
nÚ_ok_¡©usÜ
 =

155 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "some_error");

156 cÚ¡ 
	gStusOr
<
	g¡d
::
veùÜ
<>> 
nÚ_m©chšg_¡©usÜ
 = 
nÚ_em±y_veùÜ
;

158 
ASSERT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
IsEm±y
())));

159 
EXPECT_EQ
(
M©chEx¶ª©iÚ
(
IsOkAndHŞds
(
IsEm±y
()), 
nÚ_ok_¡©usÜ
),

162 
ASSERT_THAT
(
nÚ_m©chšg_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
IsEm±y
())));

163 
EXPECT_EQ
(
M©chEx¶ª©iÚ
(
IsOkAndHŞds
(
IsEm±y
()), 
nÚ_m©chšg_¡©usÜ
),

164 
ab¦
::
SŒC©
("which contains‡ value ",

165 
M©chEx¶ª©iÚ
(
IsEm±y
(), 
nÚ_em±y_veùÜ
)));

	@test/util/status_matchers_test.cc

19 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

21 
	~<s¡»am
>

22 
	~<¡ršg
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Eq
;

33 
	gusšg
 ::
‹¡šg
::
Gt
;

34 
	gusšg
 ::
‹¡šg
::
HasSub¡r
;

35 
	gusšg
 ::
‹¡šg
::
IsEm±y
;

36 
	gusšg
 ::
‹¡šg
::
Lt
;

37 
	gusšg
 ::
‹¡šg
::
M©ch”
;

38 
	gusšg
 ::
‹¡šg
::
NÙ
;

39 
	gusšg
 ::
‹¡šg
::
SaãM©ch”Ca¡
;

40 
	gusšg
 ::
‹¡šg
::
SŒšgM©chResuÉLi¡’”
;

43 
	g‹m¶©e
 <
ty³Çme
 
	gM©ch“T
,y³Çm
	gM©ch”T
>

44 
	g¡d
::
¡ršg
 
M©ch”DesütiÚ
(cÚ¡ 
M©ch”T
 &
m©ch”
) {

45 
M©ch”
<cÚ¡ 
M©ch“T
 &> 
cÚv”‹d_m©ch”
 =

46 
SaãM©ch”Ca¡
<cÚ¡ 
M©ch“T
 &>(
m©ch”
);

48 
	g¡d
::
¡ršg¡»am
 
desütiÚ_¡»am
;

49 
	gcÚv”‹d_m©ch”
.
DesüibeTo
(&
desütiÚ_¡»am
);

50  
	gdesütiÚ_¡»am
.
¡r
();

55 
	g‹m¶©e
 <
ty³Çme
 
	gM©ch“T
,y³Çm
	gM©ch”T
>

56 
	g¡d
::
¡ršg
 
M©chEx¶ª©iÚ
(cÚ¡ 
M©ch”T
 &
m©ch”
, cÚ¡ 
M©ch“T
 &
v®ue
) {

57 
	gM©ch”
<cÚ¡ 
	gM©ch“T
 &> 
	gcÚv”‹d_m©ch”
 =

58 
SaãM©ch”Ca¡
<cÚ¡ 
M©ch“T
 &>(
m©ch”
);

60 
SŒšgM©chResuÉLi¡’”
 
	gli¡’”
;

61 
	gcÚv”‹d_m©ch”
.
M©chAndEx¶aš
(
v®ue
, &
li¡’”
);

62  
	gli¡’”
.
¡r
();

67 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsM©chesOkStusW™hM©chšgV®ue
) {

68 cÚ¡ 
	gStusOr
<> 
	gšt_¡©usÜ
 = 5;

69 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡ršg_¡©usÜ
 = 
¡d
::string("foobar");

71 
EXPECT_THAT
(
št_¡©usÜ
, 
IsOkAndHŞds
(
Eq
(5)));

72 
EXPECT_THAT
(
št_¡©usÜ
, 
IsOkAndHŞds
(
Gt
(2)));

73 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
IsOkAndHŞds
(
HasSub¡r
("oba")));

78 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsCÚv”tsNÚM©ch”ArgsToEqM©ch”s
) {

79 cÚ¡ 
	gStusOr
<> 
	gšt_¡©usÜ
 = 5;

80 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡ršg_¡©usÜ
 = 
¡d
::string("foobar");

82 
EXPECT_THAT
(
št_¡©usÜ
, 
IsOkAndHŞds
(5));

83 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
IsOkAndHŞds
("foobar"));

88 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsDÛsNÙM©chNÚOkStus
) {

89 cÚ¡ 
	gStusOr
<> 
	gnÚ_ok_¡©usÜ
 =

90 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "some_error");

92 
EXPECT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Lt
(3))));

93 
EXPECT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Eq
(3))));

94 
EXPECT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Gt
(3))));

99 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsDÛsNÙM©chIfV®ueM©ch”Fas
) {

100 cÚ¡ 
	gStusOr
<> 
	gšt_¡©usÜ
 = 5;

101 cÚ¡ 
	gStusOr
<
	g¡d
::
¡ršg
> 
¡ršg_¡©usÜ
 = 
¡d
::string("foobar");

103 
EXPECT_THAT
(
št_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Lt
(4))));

104 
EXPECT_THAT
(
št_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
Eq
(7))));

105 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
HasSub¡r
("baz"))));

106 
EXPECT_THAT
(
¡ršg_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
IsEm±y
())));

111 
TEST
(
StusM©ch”sTe¡
,

112 
IsOkAndHŞdsDesüibesM©chAsOkAndM©chšgV®ueM©ch”
) {

113 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
IsOkAndHŞds
(
Eq
(5))),

114 
ab¦
::
SŒC©
("is OK‡nd contains‡ valuehat ",

115 
M©ch”DesütiÚ
<>(
Eq
(5))));

116 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
IsOkAndHŞds
(
Lt
(7))),

117 
ab¦
::
SŒC©
("is OK‡nd contains‡ valuehat ",

118 
M©ch”DesütiÚ
<>(
Lt
(7))));

119 
EXPECT_EQ
(

120 
M©ch”DesütiÚ
<
StusOr
<
¡d
::
¡ršg
>>(
IsOkAndHŞds
(
HasSub¡r
("foo"))),

121 
ab¦
::
SŒC©
("is OK‡nd contains‡ valuehat ",

122 
M©ch”DesütiÚ
<
¡d
::
¡ršg
>(
HasSub¡r
("foo"))));

127 
TEST
(
StusM©ch”sTe¡
,

128 
IsOkAndHŞdsDesüibesNÚM©chAsNÚOkOrNÙM©chšgV®ueM©ch”
) {

129 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
NÙ
(
IsOkAndHŞds
(
Eq
(5)))),

130 
ab¦
::
SŒC©
("is‚ot OK or contains‡ valuehat ",

131 
M©ch”DesütiÚ
<>(
NÙ
(
Eq
(5)))));

132 
EXPECT_EQ
(
M©ch”DesütiÚ
<
StusOr
<>>(
NÙ
(
IsOkAndHŞds
(
Lt
(7)))),

133 
ab¦
::
SŒC©
("is‚ot OK or contains‡ valuehat ",

134 
M©ch”DesütiÚ
<>(
NÙ
(
Lt
(7)))));

135 
EXPECT_EQ
(

136 
M©ch”DesütiÚ
<
StusOr
<
¡d
::
¡ršg
>>(

137 
NÙ
(
IsOkAndHŞds
(
HasSub¡r
("foo")))),

138 
ab¦
::
SŒC©
("is‚ot OK or contains‡ valuehat ",

139 
M©ch”DesütiÚ
<
¡d
::
¡ršg
>(
NÙ
(
HasSub¡r
("foo")))));

143 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsDÛsNÙEx¶ašSucûssfulM©ch
) {

144 cÚ¡ 
	g¡d
::
veùÜ
<> 
em±y_veùÜ
;

145 cÚ¡ 
	gStusOr
<
	g¡d
::
veùÜ
<>> 
m©chšg_¡©usÜ
 = 
em±y_veùÜ
;

147 
ASSERT_THAT
(
m©chšg_¡©usÜ
, 
IsOkAndHŞds
(
IsEm±y
()));

148 
EXPECT_EQ
(
M©chEx¶ª©iÚ
(
IsOkAndHŞds
(
IsEm±y
()), 
m©chšg_¡©usÜ
), "");

152 
TEST
(
StusM©ch”sTe¡
, 
IsOkAndHŞdsEx¶ašsNÚM©chCÜ»ùly
) {

153 cÚ¡ 
	g¡d
::
veùÜ
<> 
nÚ_em±y_veùÜ
 = {8, 6, 7, 5, 3, 0, 9};

154 cÚ¡ 
	gStusOr
<
	g¡d
::
veùÜ
<>> 
nÚ_ok_¡©usÜ
 =

155 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, "some_error");

156 cÚ¡ 
	gStusOr
<
	g¡d
::
veùÜ
<>> 
nÚ_m©chšg_¡©usÜ
 = 
nÚ_em±y_veùÜ
;

158 
ASSERT_THAT
(
nÚ_ok_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
IsEm±y
())));

159 
EXPECT_EQ
(
M©chEx¶ª©iÚ
(
IsOkAndHŞds
(
IsEm±y
()), 
nÚ_ok_¡©usÜ
),

162 
ASSERT_THAT
(
nÚ_m©chšg_¡©usÜ
, 
NÙ
(
IsOkAndHŞds
(
IsEm±y
())));

163 
EXPECT_EQ
(
M©chEx¶ª©iÚ
(
IsOkAndHŞds
(
IsEm±y
()), 
nÚ_m©chšg_¡©usÜ
),

164 
ab¦
::
SŒC©
("which contains‡ value ",

165 
M©chEx¶ª©iÚ
(
IsEm±y
(), 
nÚ_em±y_veùÜ
)));

	@test/util/test_binary.cc

29 
	~<c¡dšt
>

30 
	~<io¡»am
>

31 
	~<lim™s
>

33 
	gÇme¥aû
 {

37 
cÚ¡ex´
 
ušt64_t
 
	gkMaxOddBefÜeOv”æow
 =

38 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
() / 3;

42 
ušt64_t
 
NextHa¡ÚeNumb”
(ušt64_ˆ
numb”
) {

43 ià(
	gnumb”
 % 2 == 1) {

44 ià(
numb”
 <ğ
kMaxOddBefÜeOv”æow
) {

45  3 * 
numb”
 + 1;

50  
	gnumb”
 / 2;

56 
	$maš
() {

57 
ušt64_t
 
¡¬t_numb”
;

58 
ušt64_t
 
cu¼’t_numb”
;

59 
ušt64_t
 
num_¡•s_to_Úe
;

61 
¡¬t_numb”
 = 1; start_number != 0; ++start_number) {

62 
num_¡•s_to_Úe
 = 0;

64 
cu¼’t_numb”
 = 
¡¬t_numb”
; current_number > 1;

65 
cu¼’t_numb”
 = 
	`NextHa¡ÚeNumb”
(current_number)) {

66 ++
num_¡•s_to_Úe
;

69 ià(
cu¼’t_numb”
 == 1) {

70 
¡d
::
cout
 << 
¡¬t_numb”
 << "ake " << 
num_¡•s_to_Úe


71 << " i‹¿tiÚ tØ»ach 1" << 
¡d
::
’dl
;

73 
¡d
::
û¼
 << "Overflow would have occurred in iterating from "

74 << 
¡¬t_numb”
 << 
¡d
::
’dl
;

79 
	}
}

	@test/util/test_binary.cc

29 
	~<c¡dšt
>

30 
	~<io¡»am
>

31 
	~<lim™s
>

33 
	gÇme¥aû
 {

37 
cÚ¡ex´
 
ušt64_t
 
	gkMaxOddBefÜeOv”æow
 =

38 
¡d
::
num”ic_lim™s
<
ušt64_t
>::
max
() / 3;

42 
ušt64_t
 
NextHa¡ÚeNumb”
(ušt64_ˆ
numb”
) {

43 ià(
	gnumb”
 % 2 == 1) {

44 ià(
numb”
 <ğ
kMaxOddBefÜeOv”æow
) {

45  3 * 
numb”
 + 1;

50  
	gnumb”
 / 2;

56 
	$maš
() {

57 
ušt64_t
 
¡¬t_numb”
;

58 
ušt64_t
 
cu¼’t_numb”
;

59 
ušt64_t
 
num_¡•s_to_Úe
;

61 
¡¬t_numb”
 = 1; start_number != 0; ++start_number) {

62 
num_¡•s_to_Úe
 = 0;

64 
cu¼’t_numb”
 = 
¡¬t_numb”
; current_number > 1;

65 
cu¼’t_numb”
 = 
	`NextHa¡ÚeNumb”
(current_number)) {

66 ++
num_¡•s_to_Úe
;

69 ià(
cu¼’t_numb”
 == 1) {

70 
¡d
::
cout
 << 
¡¬t_numb”
 << "ake " << 
num_¡•s_to_Úe


71 << " i‹¿tiÚ tØ»ach 1" << 
¡d
::
’dl
;

73 
¡d
::
û¼
 << "Overflow would have occurred in iterating from "

74 << 
¡¬t_numb”
 << 
¡d
::
’dl
;

79 
	}
}

	@test/util/test_flags.cc

19 
	~"asylo/‹¡/ut/‹¡_æags.h
"

21 
	~<c¡dlib
>

23 
	~"gæags/gæags.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
	g¡d
::
¡ršg
 
G‘Te¡TempDœEnvœÚm’t
() {

29 *
’v_dœ
 = 
¡d
::
g‘’v
("TEST_TMPDIR");

30 ià(
	g’v_dœ
 !ğ
nuÎ±r
 && 
’v_dœ
[0] != '\0') {

31  
’v_dœ
;

40 
DEFINE_¡ršg
(
‹¡_tmpdœ
, 
asylo
::
G‘Te¡TempDœEnvœÚm’t
(),

	@test/util/test_flags.cc

19 
	~"asylo/‹¡/ut/‹¡_æags.h
"

21 
	~<c¡dlib
>

23 
	~"gæags/gæags.h
"

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
	g¡d
::
¡ršg
 
G‘Te¡TempDœEnvœÚm’t
() {

29 *
’v_dœ
 = 
¡d
::
g‘’v
("TEST_TMPDIR");

30 ià(
	g’v_dœ
 !ğ
nuÎ±r
 && 
’v_dœ
[0] != '\0') {

31  
’v_dœ
;

40 
DEFINE_¡ršg
(
‹¡_tmpdœ
, 
asylo
::
G‘Te¡TempDœEnvœÚm’t
(),

	@test/util/test_flags.h

19 #iâdeà
ASYLO_TEST_UTIL_TEST_FLAGS_H_


20 
	#ASYLO_TEST_UTIL_TEST_FLAGS_H_


	)

22 
	~"gæags/gæags.h
"

25 
DECLARE_¡ršg
(
‹¡_tmpdœ
);

	@test/util/test_main.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"gæags/gæags.h
"

22 
	$maš
(
¬gc
, *
¬gv
[]) {

23 ::
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

24 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

25  
Œue
);

27  
	`RUN_ALL_TESTS
();

28 
	}
}

	@test/util/test_main.cc

19 
	~<g‹¡/g‹¡.h
>

20 
	~"gæags/gæags.h
"

22 
	$maš
(
¬gc
, *
¬gv
[]) {

23 ::
‹¡šg
::
	`In™GoogËTe¡
(&
¬gc
, 
¬gv
);

24 ::
googË
::
	`P¬£CommªdLšeFÏgs
(&
¬gc
, &
¬gv
,

25  
Œue
);

27  
	`RUN_ALL_TESTS
();

28 
	}
}

	@third_party/intel/posix/sgx_defs.h

32 #iâdeà
_SGX_DEFS_H_


33 
	#_SGX_DEFS_H_


	)

37 
	#SGXAPI


	)

39 #ifdeà
lšux


40 #undeà
lšux


42 
	#SGX_CXX_NATIVE_HEADER
(
h—d”
è<
¡dc
++/
lšux
/h—d”>

	)

44 
	#SGX_CDECL


	)

45 
	#SGX_STDCALL


	)

46 
	#SGX_FASTCALL


	)

48 
	#SGX_DLLIMPORT


	)

49 
	#SGX_UBRIDGE
(
©Œ
, 
âame
, 
¬gs
...è©Œ fÇm
	)
¬gs

51 
	#SGX_DEPRECATED
 
	`__©Œibu‹__
((
d•»ÿ‹d
))

	)

54 
	#SGX_NOCONVENTION


	)

	@third_party/intel/posix/sgx_thread.h

32 #iâdeà
_SGX_THREAD_H_


33 
	#_SGX_THREAD_H_


	)

35 
	~<¡dšt.h
>

36 
	~<¡ddef.h
>

37 
	~"sgx_defs.h
"

39 
ušŒ_t
 
	tsgx_th»ad_t
;

41 
	s_sgx_th»ad_queue_t


43 
sgx_th»ad_t
 
	mm_fœ¡
;

44 
sgx_th»ad_t
 
	mm_Ï¡
;

45 } 
	tsgx_th»ad_queue_t
;

48 
	s_sgx_th»ad_mu‹x_t


50 
size_t
 
	mm_»fcouÁ
;

51 
ušt32_t
 
	mm_cÚŒŞ
;

52 vŞ©
ušt32_t
 
	mm_lock
;

53 
sgx_th»ad_t
 
	mm_owÃr
;

54 
sgx_th»ad_queue_t
 
	mm_queue
;

55 } 
	tsgx_th»ad_mu‹x_t
;

57 
	#SGX_THREAD_T_NULL
 ((
sgx_th»ad_t
)(
NULL
))

	)

59 
	#SGX_THREAD_MUTEX_NONRECURSIVE
 0x01

	)

60 
	#SGX_THREAD_MUTEX_RECURSIVE
 0x02

	)

61 
	#SGX_THREAD_NONRECURSIVE_MUTEX_INITIALIZER
 \

62 {0, 
SGX_THREAD_MUTEX_NONRECURSIVE
, 0, 
SGX_THREAD_T_NULL
, {SGX_THREAD_T_NULL, SGX_THREAD_T_NULL}}

	)

63 
	#SGX_THREAD_RECURSIVE_MUTEX_INITIALIZER
 \

64 {0, 
SGX_THREAD_MUTEX_RECURSIVE
, 0, 
SGX_THREAD_T_NULL
, {SGX_THREAD_T_NULL, SGX_THREAD_T_NULL}}

	)

65 
	#SGX_THREAD_MUTEX_INITIALIZER
 \

66 
SGX_THREAD_NONRECURSIVE_MUTEX_INITIALIZER


	)

68 
	s_sgx_th»ad_mu‹x_©Œ_t


70 
	mm_dummy
;

71 } 
	tsgx_th»ad_mu‹x©Œ_t
;

74 
	s_sgx_th»ad_cÚd_t


76 vŞ©
ušt32_t
 
	mm_lock
;

77 
sgx_th»ad_queue_t
 
	mm_queue
;

78 } 
	tsgx_th»ad_cÚd_t
;

80 
	#SGX_THREAD_COND_INITIALIZER
 {0, {
SGX_THREAD_T_NULL
, SGX_THREAD_T_NULL}}

	)

82 
	s_sgx_th»ad_cÚd_©Œ_t


84 
	mm_dummy
;

85 } 
	tsgx_th»ad_cÚd©Œ_t
;

87 #ifdeà
__ılu¥lus


92 
SGXAPI
 
sgx_th»ad_mu‹x_š™
(
sgx_th»ad_mu‹x_t
 *
mu‹x
, cÚ¡ 
sgx_th»ad_mu‹x©Œ_t
 *
unu£d
);

93 
SGXAPI
 
sgx_th»ad_mu‹x_de¡roy
(
sgx_th»ad_mu‹x_t
 *
mu‹x
);

95 
SGXAPI
 
sgx_th»ad_mu‹x_lock
(
sgx_th»ad_mu‹x_t
 *
mu‹x
);

96 
SGXAPI
 
sgx_th»ad_mu‹x_Œylock
(
sgx_th»ad_mu‹x_t
 *
mu‹x
);

97 
SGXAPI
 
sgx_th»ad_mu‹x_uÆock
(
sgx_th»ad_mu‹x_t
 *
mu‹x
);

100 
SGXAPI
 
sgx_th»ad_cÚd_š™
(
sgx_th»ad_cÚd_t
 *
cÚd
, cÚ¡ 
sgx_th»ad_cÚd©Œ_t
 *
unu£d
);

101 
SGXAPI
 
sgx_th»ad_cÚd_de¡roy
(
sgx_th»ad_cÚd_t
 *
cÚd
);

103 
SGXAPI
 
sgx_th»ad_cÚd_wa™
(
sgx_th»ad_cÚd_t
 *
cÚd
, 
sgx_th»ad_mu‹x_t
 *
mu‹x
);

104 
SGXAPI
 
sgx_th»ad_cÚd_sigÇl
(
sgx_th»ad_cÚd_t
 *
cÚd
);

105 
SGXAPI
 
sgx_th»ad_cÚd_brßdÿ¡
(
sgx_th»ad_cÚd_t
 *
cÚd
);

107 
sgx_th»ad_t
 
SGXAPI
 
sgx_th»ad_£lf
();

108 
sgx_th»ad_equ®
(
sgx_th»ad_t
 
a
, sgx_th»ad_ˆ
b
);

110 #ifdeà
__ılu¥lus


	@trusted_application.h

19 #iâdeà
ASYLO_TRUSTED_APPLICATION_H_


20 
	#ASYLO_TRUSTED_APPLICATION_H_


	)

22 
	~"asylo/¶©fÜm/cÜe/Œu¡ed_­¶iÿtiÚ.h
"

	@util/asylo_macros.h

19 #iâdeà
ASYLO_UTIL_ASYLO_MACROS_H_


20 
	#ASYLO_UTIL_ASYLO_MACROS_H_


	)

26 #ià(
defšed
(
__şªg__
è|| defšed(
__GNUC__
)è&& !defšed(
ASYLO_MUST_USE_RESULT
)

27 
	#ASYLO_MUST_USE_RESULT
 
	`__©Œibu‹__
((
w¬n_unu£d_»suÉ
))

	)

29 
	#ASYLO_MUST_USE_RESULT


	)

	@util/binary_search.h

19 #iâdeà
ASYLO_UTIL_BINARY_SEARCH_H_


20 
	#ASYLO_UTIL_BINARY_SEARCH_H_


	)

22 
	~<c¡ddef
>

23 
	~<funùiÚ®
>

24 
	~<lim™s
>

25 
	~<ty³_Œa™s
>

27 
Çme¥aû
 
	gasylo
 {

33 
	g‹m¶©e
 <
şass
 
	gFunc
>

34 
size_t
 
Bš¬yS—rch
(
Func
 
f
) {

36 
¡©ic_as£¹
(
¡d
::
is_cÚv”tibË
<
Func
, std::
funùiÚ
<
boŞ
(
size_t
)>>::
v®ue
,

40 ià(!
f
(0) || !f(1)) {

44 
size_t
 
	glow”_bound
 = 1;

45 
size_t
 
	guµ”_bound
 = 2;

46 
size_t
 
	gmax_b™s
 = (size_t) * 8;

51 
	gi
 = 1; i < 
	gmax_b™s
 && 
f
(
uµ”_bound
); i++) {

52 
	glow”_bound
 = 1 << 
i
;

53 ià(
	gi
 !ğ
max_b™s
 - 1) {

54 
uµ”_bound
 = 
low”_bound
 << 1;

56 
	guµ”_bound
 = 
¡d
::
num”ic_lim™s
<¡d::
±rdiff_t
>::
max
();

57 ià(
f
(
uµ”_bound
)) {

58  
	guµ”_bound
;

64 
	guµ”_bound
 - 
	glow”_bound
 > 1) {

66 
size_t
 
	g‹¡_v®ue
 = (
low”_bound
 / 2è+ (
uµ”_bound
 / 2);

68 ià(
	g‹¡_v®ue
 =ğ
low”_bound
) {

69 
‹¡_v®ue
 += 1;

71 ià(
f
(
‹¡_v®ue
)) {

72 
	glow”_bound
 = 
‹¡_v®ue
;

74 
	guµ”_bound
 = 
‹¡_v®ue
;

78  
	glow”_bound
;

	@util/binary_search_test.cc

18 
	~"asylo/ut/bš¬y_£¬ch.h
"

20 
	~<lim™s
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
TEST
(
Bš¬yS—rchTe¡
, 
CÚ¡ªtsS—rchTe¡
) {

29 autØ
	gËss_thª_£v’‹’
 = [](
size_t
 
x
) {  x < 17; };

30 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_£v’‹’
), 16);

31 autØ
	g®ways_çl£
 = [](
size_t
 
x
è{  
çl£
; };

32 
EXPECT_EQ
(
Bš¬yS—rch
(
®ways_çl£
), 0);

33 autØ
	gËss_thª_Úe
 = [](
size_t
 
x
) {  x < 1; };

34 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_Úe
), 0);

35 autØ
	gËss_thª_sixty_four
 = [](
size_t
 
x
) {  x < 64; };

36 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_sixty_four
), 63);

37 autØ
	gËss_thª_a_lÙ
 = [](
size_t
 
x
) {  x < 99999; };

38 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_a_lÙ
), 99998);

39 autØ
	g®ways_Œue
 = [](
size_t
 
x
è{  
Œue
; };

40 
EXPECT_EQ
(
Bš¬yS—rch
(
®ways_Œue
),

41 
¡d
::
num”ic_lim™s
<¡d::
±rdiff_t
>::
max
());

	@util/binary_search_test.cc

18 
	~"asylo/ut/bš¬y_£¬ch.h
"

20 
	~<lim™s
>

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

25 
Çme¥aû
 
	gasylo
 {

26 
	gÇme¥aû
 {

28 
TEST
(
Bš¬yS—rchTe¡
, 
CÚ¡ªtsS—rchTe¡
) {

29 autØ
	gËss_thª_£v’‹’
 = [](
size_t
 
x
) {  x < 17; };

30 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_£v’‹’
), 16);

31 autØ
	g®ways_çl£
 = [](
size_t
 
x
è{  
çl£
; };

32 
EXPECT_EQ
(
Bš¬yS—rch
(
®ways_çl£
), 0);

33 autØ
	gËss_thª_Úe
 = [](
size_t
 
x
) {  x < 1; };

34 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_Úe
), 0);

35 autØ
	gËss_thª_sixty_four
 = [](
size_t
 
x
) {  x < 64; };

36 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_sixty_four
), 63);

37 autØ
	gËss_thª_a_lÙ
 = [](
size_t
 
x
) {  x < 99999; };

38 
EXPECT_EQ
(
Bš¬yS—rch
(
Ëss_thª_a_lÙ
), 99998);

39 autØ
	g®ways_Œue
 = [](
size_t
 
x
è{  
Œue
; };

40 
EXPECT_EQ
(
Bš¬yS—rch
(
®ways_Œue
),

41 
¡d
::
num”ic_lim™s
<¡d::
±rdiff_t
>::
max
());

	@util/cleansing_allocator.h

19 #iâdeà
ASYLO_UTIL_CLEANSING_ALLOCATOR_H_


20 
	#ASYLO_UTIL_CLEANSING_ALLOCATOR_H_


	)

22 
	~<İ’s¦/mem.h
>

23 
	~<c¡dlib
>

24 
	~<lim™s
>

25 
	~<memÜy
>

26 
	~<ty³_Œa™s
>

28 
Çme¥aû
 
	gasylo
 {

41 
	g‹m¶©e
 <
ty³Çme
 
	gT
, 
şass
 
	gA
 = 
¡d
::
®loÿtÜ
<
T
>>

42 şas 
	cCËªsšgAÎoÿtÜ
 {

43 
public
:

44 
usšg
 
v®ue_ty³
 = 
ty³Çme
 
¡d
::
®loÿtÜ_Œa™s
<
A
>::value_type;

45 
usšg
 
	gpoš‹r
 = 
ty³Çme
 
¡d
::
®loÿtÜ_Œa™s
<
A
>::
poš‹r
;

46 
usšg
 
	gcÚ¡_poš‹r
 = 
ty³Çme
 
¡d
::
®loÿtÜ_Œa™s
<
A
>::
cÚ¡_poš‹r
;

52 
usšg
 
	g»ã»nû
 = 
ty³Çme
 
A
::
»ã»nû
;

53 
usšg
 
	gcÚ¡_»ã»nû
 = 
ty³Çme
 
A
::
cÚ¡_»ã»nû
;

55 
usšg
 
	gsize_ty³
 = 
ty³Çme
 
¡d
::
®loÿtÜ_Œa™s
<
A
>::
size_ty³
;

56 
usšg
 
	gdifã»nû_ty³
 = 
ty³Çme
 
¡d
::
®loÿtÜ_Œa™s
<
A
>::
difã»nû_ty³
;

58 
CËªsšgAÎoÿtÜ
(cÚ¡ 
A
 &
®loc
 = A()è: 
®loc_
{alloc} {};

59 
	g‹m¶©e
 <
ty³Çme
 
	gU
, 
şass
 
	gB
>

60 
ex¶ic™
 
CËªsšgAÎoÿtÜ
(cÚ¡ CËªsšgAÎoÿtÜ<
U
, 
B
> &
a
)

61 : 
®loc_
{
a
.alloc_} {}

62 ~
CËªsšgAÎoÿtÜ
() = ;

64 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

65 
	s»bšd
 {

66 
usšg
 
	gÙh”
 = 
CËªsšgAÎoÿtÜ
<

67 
U
, 
ty³Çme
 
	g¡d
::
®loÿtÜ_Œa™s
<
A
>::
‹m¶©e
 
»bšd_®loc
<U>>;

70 
poš‹r
 
add»ss
(
T
 &
r
) {

71  
	g¡d
::
®loÿtÜ_Œa™s
<
A
>::
add»ss
(
®loc_
, 
r
);

73 
cÚ¡_poš‹r
 
add»ss
(cÚ¡ 
T
 &
r
) {

74  
	g¡d
::
®loÿtÜ_Œa™s
<
A
>::
add»ss
(
®loc_
, 
r
);

77 
poš‹r
 
®loÿ‹
(
size_ty³
 
n
) {

78  
	g¡d
::
®loÿtÜ_Œa™s
<
A
>::
®loÿ‹
(
®loc_
, 
n
);

81 
d—Îoÿ‹
(
poš‹r
 
±r
, 
size_ty³
 
n
) {

82 
OPENSSL_ş—n£
(
±r
, 
n
 * (
T
));

83 
	g¡d
::
®loÿtÜ_Œa™s
<
A
>::
d—Îoÿ‹
(
®loc_
, 
±r
, 
n
);

86 
	g¡d
::
size_t
 
max_size
() const {

87  
¡d
::
®loÿtÜ_Œa™s
<
A
>::
max_size
(
®loc_
);

90 
cÚ¡ruù
(
T
 *
±r
, cÚ¡ T &
t
) {

91 
	g¡d
::
®loÿtÜ_Œa™s
<
A
>::
cÚ¡ruù
(
®loc_
, 
±r
, 
t
);

93 
de¡roy
(
T
 *
±r
è{ 
	g¡d
::
®loÿtÜ_Œa™s
<
A
>::de¡roy(
®loc_
,…tr); }

97 
	g‹m¶©e
 <
ty³Çme
 
	gU
, 
şass
 
	gB
>

98 
ä›nd
 
şass
 
	gCËªsšgAÎoÿtÜ
;

102 
	g‹m¶©e
 <
ty³Çme
 
	gU
,y³Çm
	gV
, 
şass
 
	gB
, cÏs 
	gC
>

103 
ä›nd
 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
CËªsšgAÎoÿtÜ
<
U
, 
	gB
> &
	glhs
,

104 cÚ¡ 
	gCËªsšgAÎoÿtÜ
<
	gV
, 
	gC
> &
	grhs
);

106 
	g´iv©e
:

107 
A
 
®loc_
;

110 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
, 
şass
 
	gA
, cÏs 
	gB
>

111 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
CËªsšgAÎoÿtÜ
<
T
, 
	gA
> &
	glhs
,

112 cÚ¡ 
	gCËªsšgAÎoÿtÜ
<
	gU
, 
	gB
> &
	grhs
) {

113  
	glhs
.
	g®loc_
 =ğ
rhs
.
®loc_
;

116 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
, 
şass
 
	gA
, cÏs 
	gB
>

117 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
CËªsšgAÎoÿtÜ
<
T
, 
	gA
> &
	glhs
,

118 cÚ¡ 
	gCËªsšgAÎoÿtÜ
<
	gU
, 
	gB
> &
	grhs
) {

119  !(
	glhs
 =ğ
rhs
);

	@util/cleansing_allocator_test.cc

19 
	~"asylo/ut/ş—nsšg_®loÿtÜ.h
"

21 
	~<c¡dlib
>

22 
	~<io¡»am
>

23 
	~<li¡
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"asylo/üy±o/ut/by‹s.h
"

29 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 cÚ¡ 
size_t
 
	gkNumI‹¿tiÚs
 = 1000;

45 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

46 
şass
 
	gTe¡AÎoÿtÜ
 : 
public
 
¡d
::
®loÿtÜ
<
T
> {

47 
public
:

48 
Te¡AÎoÿtÜ
() = ;

49 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

50 
ex¶ic™
 
Te¡AÎoÿtÜ
(cÚ¡ Te¡AÎoÿtÜ<
U
> &
a
)

51 : 
¡d
::
®loÿtÜ
<
T
>::®loÿtÜ(
a
) {}

52 ~
Te¡AÎoÿtÜ
() = ;

53 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

54 
	s»bšd
 {

55 
usšg
 
	gÙh”
 = 
Te¡AÎoÿtÜ
<
U
>;

57 
d—Îoÿ‹
(
ty³Çme
 
¡d
::
®loÿtÜ
<
T
>::
poš‹r
 
±r
,

58 
ty³Çme
 
¡d
::
®loÿtÜ
<
T
>::
size_ty³
 
n
) {

59 
ušt8_t
 *
bufãr
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
±r
);

60 
	gi
 = 0; i < 
n
 * (
	gT
); i++) {

61 
ASSERT_EQ
(
bufãr
[
i
], 0);

63 
	g¡d
::
®loÿtÜ_Œa™s
<
¡d
::
®loÿtÜ
<
T
>>::
d—Îoÿ‹
(*
this
, 
±r
, 
n
);

67 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

68 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Te¡AÎoÿtÜ
<
T
> &
lhs
, cÚ¡ 
	gTe¡AÎoÿtÜ
<
	gU
> &
	grhs
) {

69  
	gŒue
;

72 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

73 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Te¡AÎoÿtÜ
<
T
> &
lhs
, cÚ¡ 
	gTe¡AÎoÿtÜ
<
	gU
> &
	grhs
) {

74  !(
	glhs
 =ğ
rhs
);

78 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

79 şas 
	cTy³dCËªsšgAÎoÿtÜTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

83 ::
‹¡šg
::
	tTy³s
<
	tSaãBy‹s
<8>, 
	tUn§ãBy‹s
<15>, SafeBytes<235>,

84 
	tUn§ãBy‹s
<519>, 
	tušt8_t
, 
	tušt16_t
, 
	tušt32_t
,

85 
	tušt64_t
>

86 
	tMyTy³s
;

87 
TYPED_TEST_SUITE
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
MyTy³s
);

89 
TYPED_TEST
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
VeùÜTe¡
) {

90 
usšg
 
	gTe¡VeùÜ
 =

91 
¡d
::
veùÜ
<
Ty³P¬am
,

92 
	gCËªsšgAÎoÿtÜ
<
	gTy³P¬am
, 
	gTe¡AÎoÿtÜ
<TypeParam>>>;

93 
	g¡d
::
unique_±r
<
Te¡VeùÜ
> 
v
(
Ãw
 TestVector);

95 
	gi
 = 0; i < 
	gkNumI‹¿tiÚs
; i++) {

96 
	gv
->
push_back
(
TrivŸlRªdomObjeù
<
Ty³P¬am
>());

101 
	gv
.
»£t
(
nuÎ±r
);

107 
TYPED_TEST
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
Li¡Te¡
) {

108 
usšg
 
	gTe¡Li¡
 =

109 
¡d
::
li¡
<
Ty³P¬am
,

110 
	gCËªsšgAÎoÿtÜ
<
	gTy³P¬am
, 
	gTe¡AÎoÿtÜ
<TypeParam>>>;

111 
	g¡d
::
unique_±r
<
Te¡Li¡
> 
l
(
Ãw
 TestList);

113 
	gi
 = 0; i < 
	gkNumI‹¿tiÚs
; i++) {

114 
	gl
->
push_back
(
TrivŸlRªdomObjeù
<
Ty³P¬am
>());

119 
	gl
.
»£t
(
nuÎ±r
);

125 
TYPED_TEST
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
SŒšgTe¡
) {

126 
usšg
 
	gCËªsšgSŒšg
 =

127 
¡d
::
basic_¡ršg
<
ušt8_t
, 
	g¡d
::
ch¬_Œa™s
<uint8_t>,

128 
	gCËªsšgAÎoÿtÜ
<
	gušt8_t
, 
	gTe¡AÎoÿtÜ
<uint8_t>>>;

129 
usšg
 
	gTe¡Li¡
 = 
¡d
::
li¡
<

130 
CËªsšgSŒšg
,

131 
	gCËªsšgAÎoÿtÜ
<
	gCËªsšgSŒšg
, 
	gTe¡AÎoÿtÜ
<CleansingString>>>;

132 
	g¡d
::
unique_±r
<
Te¡Li¡
> 
l
(
Ãw
 TestList);

134 
	gi
 = 0; i < 
	gkNumI‹¿tiÚs
; i++) {

135 
Ty³P¬am
 
	gobj
 = 
TrivŸlRªdomObjeù
<TypeParam>();

136 
	gl
->
push_back
(

137 
CËªsšgSŒšg
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
obj
), (obj)));

142 
	gl
.
»£t
(
nuÎ±r
);

	@util/cleansing_allocator_test.cc

19 
	~"asylo/ut/ş—nsšg_®loÿtÜ.h
"

21 
	~<c¡dlib
>

22 
	~<io¡»am
>

23 
	~<li¡
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"asylo/üy±o/ut/by‹s.h
"

29 
	~"asylo/üy±o/ut/ŒivŸl_objeù_ut.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 cÚ¡ 
size_t
 
	gkNumI‹¿tiÚs
 = 1000;

45 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

46 
şass
 
	gTe¡AÎoÿtÜ
 : 
public
 
¡d
::
®loÿtÜ
<
T
> {

47 
public
:

48 
Te¡AÎoÿtÜ
() = ;

49 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

50 
ex¶ic™
 
Te¡AÎoÿtÜ
(cÚ¡ Te¡AÎoÿtÜ<
U
> &
a
)

51 : 
¡d
::
®loÿtÜ
<
T
>::®loÿtÜ(
a
) {}

52 ~
Te¡AÎoÿtÜ
() = ;

53 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

54 
	s»bšd
 {

55 
usšg
 
	gÙh”
 = 
Te¡AÎoÿtÜ
<
U
>;

57 
d—Îoÿ‹
(
ty³Çme
 
¡d
::
®loÿtÜ
<
T
>::
poš‹r
 
±r
,

58 
ty³Çme
 
¡d
::
®loÿtÜ
<
T
>::
size_ty³
 
n
) {

59 
ušt8_t
 *
bufãr
 = 
»š‹½»t_ÿ¡
<ušt8_ˆ*>(
±r
);

60 
	gi
 = 0; i < 
n
 * (
	gT
); i++) {

61 
ASSERT_EQ
(
bufãr
[
i
], 0);

63 
	g¡d
::
®loÿtÜ_Œa™s
<
¡d
::
®loÿtÜ
<
T
>>::
d—Îoÿ‹
(*
this
, 
±r
, 
n
);

67 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

68 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Te¡AÎoÿtÜ
<
T
> &
lhs
, cÚ¡ 
	gTe¡AÎoÿtÜ
<
	gU
> &
	grhs
) {

69  
	gŒue
;

72 
	g‹m¶©e
 <
ty³Çme
 
	gT
,y³Çm
	gU
>

73 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Te¡AÎoÿtÜ
<
T
> &
lhs
, cÚ¡ 
	gTe¡AÎoÿtÜ
<
	gU
> &
	grhs
) {

74  !(
	glhs
 =ğ
rhs
);

78 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

79 şas 
	cTy³dCËªsšgAÎoÿtÜTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

83 ::
‹¡šg
::
	tTy³s
<
	tSaãBy‹s
<8>, 
	tUn§ãBy‹s
<15>, SafeBytes<235>,

84 
	tUn§ãBy‹s
<519>, 
	tušt8_t
, 
	tušt16_t
, 
	tušt32_t
,

85 
	tušt64_t
>

86 
	tMyTy³s
;

87 
TYPED_TEST_SUITE
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
MyTy³s
);

89 
TYPED_TEST
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
VeùÜTe¡
) {

90 
usšg
 
	gTe¡VeùÜ
 =

91 
¡d
::
veùÜ
<
Ty³P¬am
,

92 
	gCËªsšgAÎoÿtÜ
<
	gTy³P¬am
, 
	gTe¡AÎoÿtÜ
<TypeParam>>>;

93 
	g¡d
::
unique_±r
<
Te¡VeùÜ
> 
v
(
Ãw
 TestVector);

95 
	gi
 = 0; i < 
	gkNumI‹¿tiÚs
; i++) {

96 
	gv
->
push_back
(
TrivŸlRªdomObjeù
<
Ty³P¬am
>());

101 
	gv
.
»£t
(
nuÎ±r
);

107 
TYPED_TEST
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
Li¡Te¡
) {

108 
usšg
 
	gTe¡Li¡
 =

109 
¡d
::
li¡
<
Ty³P¬am
,

110 
	gCËªsšgAÎoÿtÜ
<
	gTy³P¬am
, 
	gTe¡AÎoÿtÜ
<TypeParam>>>;

111 
	g¡d
::
unique_±r
<
Te¡Li¡
> 
l
(
Ãw
 TestList);

113 
	gi
 = 0; i < 
	gkNumI‹¿tiÚs
; i++) {

114 
	gl
->
push_back
(
TrivŸlRªdomObjeù
<
Ty³P¬am
>());

119 
	gl
.
»£t
(
nuÎ±r
);

125 
TYPED_TEST
(
Ty³dCËªsšgAÎoÿtÜTe¡
, 
SŒšgTe¡
) {

126 
usšg
 
	gCËªsšgSŒšg
 =

127 
¡d
::
basic_¡ršg
<
ušt8_t
, 
	g¡d
::
ch¬_Œa™s
<uint8_t>,

128 
	gCËªsšgAÎoÿtÜ
<
	gušt8_t
, 
	gTe¡AÎoÿtÜ
<uint8_t>>>;

129 
usšg
 
	gTe¡Li¡
 = 
¡d
::
li¡
<

130 
CËªsšgSŒšg
,

131 
	gCËªsšgAÎoÿtÜ
<
	gCËªsšgSŒšg
, 
	gTe¡AÎoÿtÜ
<CleansingString>>>;

132 
	g¡d
::
unique_±r
<
Te¡Li¡
> 
l
(
Ãw
 TestList);

134 
	gi
 = 0; i < 
	gkNumI‹¿tiÚs
; i++) {

135 
Ty³P¬am
 
	gobj
 = 
TrivŸlRªdomObjeù
<TypeParam>();

136 
	gl
->
push_back
(

137 
CËªsšgSŒšg
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(&
obj
), (obj)));

142 
	gl
.
»£t
(
nuÎ±r
);

	@util/cleansing_types.h

19 #iâdeà
ASYLO_UTIL_CLEANSING_TYPES_H_


20 
	#ASYLO_UTIL_CLEANSING_TYPES_H_


	)

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~"asylo/ut/ş—nsšg_®loÿtÜ.h
"

27 
Çme¥aû
 
	gasylo
 {

30 
usšg
 
	gCËªsšgSŒšg
 =

31 
¡d
::
basic_¡ršg
<, 
	g¡d
::
ch¬_Œa™s
<>, 
	gCËªsšgAÎoÿtÜ
<>>;

34 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

35 
usšg
 
	gCËªsšgVeùÜ
 = 
¡d
::
veùÜ
<
T
, 
	gCËªsšgAÎoÿtÜ
<
	gT
>>;

	@util/cleanup.h

19 #iâdeà
ASYLO_UTIL_CLEANUP_H_


20 
	#ASYLO_UTIL_CLEANUP_H_


	)

22 
	~<funùiÚ®
>

23 
	~<ut™y
>

25 
Çme¥aû
 
	gasylo
 {

60 şas 
	cCËªup
 {

61 
	gpublic
:

62 
CËªup
(è: 
ş—nup_funùiÚ_
() {}

64 
ex¶ic™
 
CËªup
(
¡d
::
funùiÚ
<()> 
ş—nup_funùiÚ
)

65 : 
ş—nup_funùiÚ_
(
¡d
::
move
(
ş—nup_funùiÚ
)) {}

67 
CËªup
(cÚ¡ CËªu°&
Ùh”
èğ
d–‘e
;

68 
	gCËªup
 &
	gİ”©Ü
=(cÚ¡ 
CËªup
 &
Ùh”
èğ
d–‘e
;

70 
CËªup
(CËªu°&&
Ùh”
èğ
d–‘e
;

71 
	gCËªup
 &
	gİ”©Ü
=(
CËªup
 &&
Ùh”
èğ
d–‘e
;

73 ~
CËªup
() {

74 ià(
	gş—nup_funùiÚ_
) {

75 
ş—nup_funùiÚ_
();

81 
	g¡d
::
funùiÚ
<()> 
»Ëa£
() {

82 autØ
»t
 = 
¡d
::
move
(
ş—nup_funùiÚ_
);

83 
	gş—nup_funùiÚ_
 = 
nuÎ±r
;

84  
	g»t
;

87 
	g´iv©e
:

88 
¡d
::
funùiÚ
<()> 
ş—nup_funùiÚ_
;

	@util/cleanup_test.cc

19 
	~"asylo/ut/ş—nup.h
"

21 
	~<funùiÚ®
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
TEST
(
CËªupTe¡
, 
Em±yCËªupDÛsNÙThrowExû±iÚs
è{ 
CËªup
 
	gdo_nÙhšg
; }

31 
TEST
(
CËªupTe¡
, 
De¡ruùÜC®lsCËªupFunùiÚ
) {

32 
	gcouÁ”
 = 0;

35 
CËªup
 
šüem’t_couÁ”
([&
couÁ”
]() { ++counter; });

36 
EXPECT_EQ
(
couÁ”
, 0);

39 
EXPECT_EQ
(
couÁ”
, 1);

42 
TEST
(
CËªupTe¡
, 
R–—£P»v’tsDe¡ruùÜCËªupFunùiÚC®l
) {

43 
	gcouÁ”
 = 0;

44 
	g¡d
::
funùiÚ
<()> 
ş—nup_hŞd”
;

47 
CËªup
 
šüem’t_couÁ”
([&
couÁ”
]() { ++counter; });

48 
EXPECT_EQ
(
couÁ”
, 0);

50 
	gş—nup_hŞd”
 = 
šüem’t_couÁ”
.
»Ëa£
();

53 
EXPECT_EQ
(
couÁ”
, 0);

55 
ş—nup_hŞd”
();

56 
EXPECT_EQ
(
couÁ”
, 1);

	@util/cleanup_test.cc

19 
	~"asylo/ut/ş—nup.h
"

21 
	~<funùiÚ®
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
Çme¥aû
 
	gasylo
 {

27 
	gÇme¥aû
 {

29 
TEST
(
CËªupTe¡
, 
Em±yCËªupDÛsNÙThrowExû±iÚs
è{ 
CËªup
 
	gdo_nÙhšg
; }

31 
TEST
(
CËªupTe¡
, 
De¡ruùÜC®lsCËªupFunùiÚ
) {

32 
	gcouÁ”
 = 0;

35 
CËªup
 
šüem’t_couÁ”
([&
couÁ”
]() { ++counter; });

36 
EXPECT_EQ
(
couÁ”
, 0);

39 
EXPECT_EQ
(
couÁ”
, 1);

42 
TEST
(
CËªupTe¡
, 
R–—£P»v’tsDe¡ruùÜCËªupFunùiÚC®l
) {

43 
	gcouÁ”
 = 0;

44 
	g¡d
::
funùiÚ
<()> 
ş—nup_hŞd”
;

47 
CËªup
 
šüem’t_couÁ”
([&
couÁ”
]() { ++counter; });

48 
EXPECT_EQ
(
couÁ”
, 0);

50 
	gş—nup_hŞd”
 = 
šüem’t_couÁ”
.
»Ëa£
();

53 
EXPECT_EQ
(
couÁ”
, 0);

55 
ş—nup_hŞd”
();

56 
EXPECT_EQ
(
couÁ”
, 1);

	@util/elf_reader.cc

19 
	~"asylo/ut/–f_»ad”.h
"

21 
	~<c¡ršg
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"ab¦/ty³s/İtiÚ®.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

33 
	gab¦
::
İtiÚ®
<
ab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
G‘Sub¥ª
(

34 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
, 
size_t
 
off£t
, size_ˆ
size
) {

35 ià(
	goff£t
 + 
	gsize
 > 
	gbufãr
.
size
()) {

36  
	gab¦
::
nuÎİt
;

39  
	gbufãr
.
sub¥ª
(
off£t
, 
size
);

45 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

46 
	gab¦
::
İtiÚ®
<cÚ¡ 
T
 *> 
G‘Sub¥ªAs
(
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
,

47 
size_t
 
off£t
) {

48 autØ
	gex‹Á_Ü_nÚe
 = 
G‘Sub¥ª
(
bufãr
, 
off£t
, (
T
));

50 ià(!
	gex‹Á_Ü_nÚe
.
has_v®ue
()) {

51  
	gab¦
::
nuÎİt
;

54  
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gT
 *>(
	gex‹Á_Ü_nÚe
.
v®ue
().
d©a
());

59 
	gab¦
::
İtiÚ®
<
ab¦
::
¡ršg_v›w
> 
G‘SŒšgAtOff£t
(

60 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
, 
size_t
 
off£t
) {

61 ià(
	goff£t
 > 
	gbufãr
.
size
()) {

62  
	gab¦
::
nuÎİt
;

65 cÚ¡ *
	gc_¡ršg
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(&
bufãr
[
off£t
]);

66 cÚ¡ 
size_t
 
	gmax_Ëngth
 = 
bufãr
.
size
(è- 
off£t
;

67 cÚ¡ 
size_t
 
	gËngth
 = 
¡ºËn
(
c_¡ršg
, 
max_Ëngth
);

69  
	gab¦
::
¡ršg_v›w
(
c_¡ršg
, 
Ëngth
);

76 şas 
	cElfR—d”C»©Ü
 {

77 
	gpublic
:

78 
ex¶ic™
 
ElfR—d”C»©Ü
(
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe
)

79 : 
–f_fe_
(
–f_fe
) {}

83 
StusOr
<
ElfR—d”
> 
C»©e
();

85 
	g´iv©e
:

91 
Stus
 
In™ŸlizeSeùiÚM­s
();

95 
	gStusOr
<cÚ¡ 
	gElf64_Ehdr
 *> 
ElfH—d”
() const;

99 
	gStusOr
<
	gElf64_Off
> 
SeùiÚTabËS¹
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

103 
	gStusOr
<
	gušt16_t
> 
NumSeùiÚs
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

107 
	gStusOr
<
	gušt16_t
> 
EÁrySize
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

112 
	gStusOr
<
	gušt16_t
> 
NameTabËIndex
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

116 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
SeùiÚH—d”TabË
(

117 
Elf64_Off
 
£ùiÚ_bË_¡¬t
, 
ušt16_t
 
num_£ùiÚs
,

118 
ušt16_t
 
’Œy_size
) const;

123 
	gStusOr
<cÚ¡ 
	gElf64_Shdr
 *> 
NameTabËH—d”
(

124 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_h—d”_bË
, 
ušt16_t
 
’Œy_size
,

125 
ušt16_t
 
Çme_bË_šdex
) const;

129 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
NameTabË
(

130 cÚ¡ 
Elf64_Shdr
 *
Çme_bË_h—d”
) const;

133 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe_
;

137 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, cÚ¡ 
	gElf64_Shdr
 *> 
	g£ùiÚ_h—d”s_
;

141 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
,‡b¦::
S·n
<cÚ¡ 
ušt8_t
>> 
£ùiÚ_d©a_
;

144 
	gStusOr
<
	gElfR—d”
> ElfR—d”::
C»©eFromS·n
(

145 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe
) {

146  
ElfR—d”C»©Ü
(
–f_fe
).
C»©e
();

149 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
ElfR—d”
::
	$G‘SeùiÚD©a
(

150 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
) const {

151 
¡d
::
¡ršg
 
£ùiÚ_Çme_¡ršg
 = std::
	`¡ršg
(
£ùiÚ_Çme
);

152 autØ
£ùiÚ_h—d”_lookup
 = 
£ùiÚ_h—d”s_
.
	`fšd
(
£ùiÚ_Çme_¡ršg
);

154 ià(
£ùiÚ_h—d”_lookup
 =ğ
£ùiÚ_h—d”s_
.
	`ûnd
()) {

155  
	`Stus
(

156 
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
,

157 
ab¦
::
	`SŒC©
("FdÛ nÙ cÚš‡ seùiÚ c®Ëd ", 
£ùiÚ_Çme
));

160 ià(
£ùiÚ_h—d”_lookup
->
£cÚd
->
sh_ty³
 =ğ
SHT_NOBITS
) {

161  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

162 
ab¦
::
	`SŒC©
("SeùiÚ ", 
£ùiÚ_Çme
, " has‚o data"));

165 autØ
£ùiÚ_d©a_lookup
 = 
£ùiÚ_d©a_
.
	`fšd
(
£ùiÚ_Çme_¡ršg
);

166 ià(
£ùiÚ_d©a_lookup
 =ğ
£ùiÚ_d©a_
.
	`ûnd
()) {

167  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

168 
ab¦
::
	`SŒC©
("Could‚ot†ocate data‡ssociated with section ",

169 
£ùiÚ_Çme
));

172  
£ùiÚ_d©a_lookup
->
£cÚd
;

173 
	}
}

175 
	gStusOr
<
	gElfR—d”
> 
	gElfR—d”C»©Ü
::
	$C»©e
() {

176 
	`ASYLO_RETURN_IF_ERROR
(
	`In™ŸlizeSeùiÚM­s
());

177  
	`ElfR—d”
(
–f_fe_
, 
¡d
::
	`move
(
£ùiÚ_h—d”s_
),

178 
¡d
::
	`move
(
£ùiÚ_d©a_
));

179 
	}
}

181 
Stus
 
	gElfR—d”C»©Ü
::
	$In™ŸlizeSeùiÚM­s
() {

182 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
;

184 
	`ASYLO_ASSIGN_OR_RETURN
(
–f_h—d”
, 
	`ElfH—d”
());

186 
Elf64_Off
 
£ùiÚ_bË_¡¬t
;

187 
ušt16_t
 
num_£ùiÚs
;

188 
ušt16_t
 
’Œy_size
;

189 
ušt16_t
 
Çme_bË_šdex
;

191 
	`ASYLO_ASSIGN_OR_RETURN
(
£ùiÚ_bË_¡¬t
, 
	`SeùiÚTabËS¹
(
–f_h—d”
));

192 
	`ASYLO_ASSIGN_OR_RETURN
(
num_£ùiÚs
, 
	`NumSeùiÚs
(
–f_h—d”
));

193 
	`ASYLO_ASSIGN_OR_RETURN
(
’Œy_size
, 
	`EÁrySize
(
–f_h—d”
));

194 
	`ASYLO_ASSIGN_OR_RETURN
(
Çme_bË_šdex
, 
	`NameTabËIndex
(
–f_h—d”
));

196 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_h—d”_bË
;

197 cÚ¡ 
Elf64_Shdr
 *
Çme_bË_h—d”
;

199 
	`ASYLO_ASSIGN_OR_RETURN
(

200 
£ùiÚ_h—d”_bË
,

201 
	`SeùiÚH—d”TabË
(
£ùiÚ_bË_¡¬t
, 
num_£ùiÚs
, 
’Œy_size
));

202 
	`ASYLO_ASSIGN_OR_RETURN
(

203 
Çme_bË_h—d”
,

204 
	`NameTabËH—d”
(
£ùiÚ_h—d”_bË
, 
’Œy_size
, 
Çme_bË_šdex
));

206 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
Çme_bË
;

208 
	`ASYLO_ASSIGN_OR_RETURN
(
Çme_bË
, 
	`NameTabË
(
Çme_bË_h—d”
));

212 
ušt16_t
 
i
 = 0; i < 
num_£ùiÚs
; ++i) {

213 cÚ¡ 
Elf64_Shdr
 *
£ùiÚ_h—d”
 = 
»š‹½»t_ÿ¡
<const Elf64_Shdr *>(

214 &
£ùiÚ_h—d”_bË
[
i
 * 
’Œy_size
]);

217 cÚ¡ 
ušt32_t
 
Çme_šdex
 = 
£ùiÚ_h—d”
->
sh_Çme
;

218 autØ
£ùiÚ_Çme_Ü_nÚe
 = 
	`G‘SŒšgAtOff£t
(
Çme_bË
, 
Çme_šdex
);

220 ià(!
£ùiÚ_Çme_Ü_nÚe
.
	`has_v®ue
()) {

221  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

222 
ab¦
::
	`SŒC©
("M®fÜmed ELF fe: seùiÚ ", 
i
,

226 cÚ¡ 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
 = 
£ùiÚ_Çme_Ü_nÚe
.
	`v®ue
();

229 autØ
h—d”_š£¹iÚ_»suÉ
 =

230 
£ùiÚ_h—d”s_
.
	`š£¹
({
¡d
::
	`¡ršg
(
£ùiÚ_Çme
), 
£ùiÚ_h—d”
});

231 ià(!
h—d”_š£¹iÚ_»suÉ
.
£cÚd
) {

232  
	`Stus
(

233 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

234 
ab¦
::
	`SŒC©
("Malformed ELF file: duplicated section‚ame: ",

235 
£ùiÚ_Çme
));

241 ià(
£ùiÚ_h—d”
->
sh_ty³
 !ğ
SHT_NOBITS
) {

243 cÚ¡ 
Elf64_Off
 
£ùiÚ_¡¬t
 = 
£ùiÚ_h—d”
->
sh_off£t
;

244 cÚ¡ 
ušt64_t
 
£ùiÚ_size
 = 
£ùiÚ_h—d”
->
sh_size
;

245 autØ
d©a_v›w_Ü_nÚe
 =

246 
	`G‘Sub¥ª
(
–f_fe_
, 
£ùiÚ_¡¬t
, 
£ùiÚ_size
);

248 ià(!
d©a_v›w_Ü_nÚe
.
	`has_v®ue
()) {

249  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

250 
ab¦
::
	`SŒC©
("M®fÜmed ELF fe: seùiÚ ", 
£ùiÚ_Çme
,

254 cÚ¡ 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
d©a_v›w
 = 
d©a_v›w_Ü_nÚe
.
	`v®ue
();

257 autØ
d©a_š£¹iÚ_»suÉ
 =

258 
£ùiÚ_d©a_
.
	`š£¹
({
¡d
::
	`¡ršg
(
£ùiÚ_Çme
), 
d©a_v›w
});

259 ià(!
d©a_š£¹iÚ_»suÉ
.
£cÚd
) {

260  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

261 
ab¦
::
	`SŒC©
("Failedo„ecord data of section ",

262 
£ùiÚ_Çme
, " in section dataable"));

267  
Stus
::
	`OkStus
();

268 
	}
}

270 
	gStusOr
<cÚ¡ 
	gElf64_Ehdr
 *> 
	gElfR—d”C»©Ü
::
	$ElfH—d”
() const {

271 autØ
–f_h—d”_Ü_nÚe
 = 
G‘Sub¥ªAs
<
Elf64_Ehdr
>(
–f_fe_
, 0);

273 ià(!
–f_h—d”_Ü_nÚe
.
	`has_v®ue
()) {

274  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

278 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
 = 
–f_h—d”_Ü_nÚe
.
	`v®ue
();

280 ià(
–f_h—d”
->
e_id’t
[
EI_MAG0
] !ğ
ELFMAG0
 ||

281 
–f_h—d”
->
e_id’t
[
EI_MAG1
] !ğ
ELFMAG1
 ||

282 
–f_h—d”
->
e_id’t
[
EI_MAG2
] !ğ
ELFMAG2
 ||

283 
–f_h—d”
->
e_id’t
[
EI_MAG3
] !ğ
ELFMAG3
) {

284  
	`Stus
(

285 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

289 ià(
–f_h—d”
->
e_id’t
[
EI_CLASS
] !ğ
ELFCLASS64
) {

290  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

294 ià(
–f_h—d”
->
e_id’t
[
EI_DATA
] !ğ
ELFDATA2LSB
) {

295  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

300 ià(
–f_h—d”
->
e_id’t
[
EI_VERSION
] !ğ
EV_CURRENT
 ||

301 
–f_h—d”
->
e_v”siÚ
 !ğ
EV_CURRENT
) {

302  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

306  
–f_h—d”
;

307 
	}
}

309 
	gStusOr
<
	gElf64_Off
> 
	gElfR—d”C»©Ü
::
	$SeùiÚTabËS¹
(

310 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

311 ià(
–f_h—d”
->
e_shoff
 == 0) {

312  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

316  
–f_h—d”
->
e_shoff
;

317 
	}
}

319 
	gStusOr
<
	gušt16_t
> 
	gElfR—d”C»©Ü
::
	$NumSeùiÚs
(

320 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

324 ià(
–f_h—d”
->
e_shnum
 == 0) {

325  
	`Stus
(

326 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

330  
–f_h—d”
->
e_shnum
;

331 
	}
}

333 
	gStusOr
<
	gušt16_t
> 
	gElfR—d”C»©Ü
::
	$EÁrySize
(

334 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

335 ià(
–f_h—d”
->
e_sh’tsize
 < (
Elf64_Shdr
)) {

336  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

340  
–f_h—d”
->
e_sh’tsize
;

341 
	}
}

343 
	gStusOr
<
	gušt16_t
> 
	gElfR—d”C»©Ü
::
	$NameTabËIndex
(

344 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

345 ià(
–f_h—d”
->
e_sh¡ºdx
 =ğ
SHN_UNDEF
) {

346  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

350  
–f_h—d”
->
e_sh¡ºdx
;

351 
	}
}

353 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
ElfR—d”C»©Ü
::
	$SeùiÚH—d”TabË
(

354 
Elf64_Off
 
£ùiÚ_bË_¡¬t
, 
ušt16_t
 
num_£ùiÚs
,

355 
ušt16_t
 
’Œy_size
) const {

356 autØ
£ùiÚ_h—d”_bË_Ü_nÚe
 =

357 
	`G‘Sub¥ª
(
–f_fe_
, 
£ùiÚ_bË_¡¬t
, 
num_£ùiÚs
 * 
’Œy_size
);

359 ià(!
£ùiÚ_h—d”_bË_Ü_nÚe
.
	`has_v®ue
()) {

360  
	`Stus
(

361 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

365  
£ùiÚ_h—d”_bË_Ü_nÚe
.
	`v®ue
();

366 
	}
}

368 
	gStusOr
<cÚ¡ 
	gElf64_Shdr
 *> 
	gElfR—d”C»©Ü
::
NameTabËH—d”
(

369 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_h—d”_bË
, 
ušt16_t
 
’Œy_size
,

370 
ušt16_t
 
Çme_bË_šdex
) const {

371 autØ
	gÇme_bË_h—d”_Ü_nÚe
 = 
G‘Sub¥ªAs
<
Elf64_Shdr
>(

372 
£ùiÚ_h—d”_bË
, 
Çme_bË_šdex
 * 
	g’Œy_size
);

374 ià(!
	gÇme_bË_h—d”_Ü_nÚe
.
has_v®ue
()) {

375  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

381 cÚ¡ 
Elf64_Shdr
 *
	gÇme_bË_h—d”
 = 
Çme_bË_h—d”_Ü_nÚe
.
v®ue
();

383 ià(
	gÇme_bË_h—d”
->
	gsh_ty³
 !ğ
SHT_STRTAB
) {

384  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

390  
	gÇme_bË_h—d”
;

393 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
ElfR—d”C»©Ü
::
	$NameTabË
(

394 cÚ¡ 
Elf64_Shdr
 *
Çme_bË_h—d”
) const {

395 cÚ¡ 
Elf64_Off
 
Çme_bË_¡¬t
 = 
Çme_bË_h—d”
->
sh_off£t
;

396 cÚ¡ 
ušt64_t
 
Çme_bË_size
 = 
Çme_bË_h—d”
->
sh_size
;

397 autØ
Çme_bË_Ü_nÚe
 =

398 
	`G‘Sub¥ª
(
–f_fe_
, 
Çme_bË_¡¬t
, 
Çme_bË_size
);

400 ià(!
Çme_bË_Ü_nÚe
.
	`has_v®ue
()) {

401  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

407  
Çme_bË_Ü_nÚe
.
	`v®ue
();

408 
	}
}

	@util/elf_reader.cc

19 
	~"asylo/ut/–f_»ad”.h
"

21 
	~<c¡ršg
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~"ab¦/ty³s/İtiÚ®.h
"

25 
	~"asylo/ut/¡©us_maüos.h
"

27 
Çme¥aû
 
	gasylo
 {

28 
	gÇme¥aû
 {

33 
	gab¦
::
İtiÚ®
<
ab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
G‘Sub¥ª
(

34 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
, 
size_t
 
off£t
, size_ˆ
size
) {

35 ià(
	goff£t
 + 
	gsize
 > 
	gbufãr
.
size
()) {

36  
	gab¦
::
nuÎİt
;

39  
	gbufãr
.
sub¥ª
(
off£t
, 
size
);

45 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

46 
	gab¦
::
İtiÚ®
<cÚ¡ 
T
 *> 
G‘Sub¥ªAs
(
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
,

47 
size_t
 
off£t
) {

48 autØ
	gex‹Á_Ü_nÚe
 = 
G‘Sub¥ª
(
bufãr
, 
off£t
, (
T
));

50 ià(!
	gex‹Á_Ü_nÚe
.
has_v®ue
()) {

51  
	gab¦
::
nuÎİt
;

54  
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gT
 *>(
	gex‹Á_Ü_nÚe
.
v®ue
().
d©a
());

59 
	gab¦
::
İtiÚ®
<
ab¦
::
¡ršg_v›w
> 
G‘SŒšgAtOff£t
(

60 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
bufãr
, 
size_t
 
off£t
) {

61 ià(
	goff£t
 > 
	gbufãr
.
size
()) {

62  
	gab¦
::
nuÎİt
;

65 cÚ¡ *
	gc_¡ršg
 = 
»š‹½»t_ÿ¡
<cÚ¡ *>(&
bufãr
[
off£t
]);

66 cÚ¡ 
size_t
 
	gmax_Ëngth
 = 
bufãr
.
size
(è- 
off£t
;

67 cÚ¡ 
size_t
 
	gËngth
 = 
¡ºËn
(
c_¡ršg
, 
max_Ëngth
);

69  
	gab¦
::
¡ršg_v›w
(
c_¡ršg
, 
Ëngth
);

76 şas 
	cElfR—d”C»©Ü
 {

77 
	gpublic
:

78 
ex¶ic™
 
ElfR—d”C»©Ü
(
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe
)

79 : 
–f_fe_
(
–f_fe
) {}

83 
StusOr
<
ElfR—d”
> 
C»©e
();

85 
	g´iv©e
:

91 
Stus
 
In™ŸlizeSeùiÚM­s
();

95 
	gStusOr
<cÚ¡ 
	gElf64_Ehdr
 *> 
ElfH—d”
() const;

99 
	gStusOr
<
	gElf64_Off
> 
SeùiÚTabËS¹
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

103 
	gStusOr
<
	gušt16_t
> 
NumSeùiÚs
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

107 
	gStusOr
<
	gušt16_t
> 
EÁrySize
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

112 
	gStusOr
<
	gušt16_t
> 
NameTabËIndex
(cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const;

116 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
SeùiÚH—d”TabË
(

117 
Elf64_Off
 
£ùiÚ_bË_¡¬t
, 
ušt16_t
 
num_£ùiÚs
,

118 
ušt16_t
 
’Œy_size
) const;

123 
	gStusOr
<cÚ¡ 
	gElf64_Shdr
 *> 
NameTabËH—d”
(

124 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_h—d”_bË
, 
ušt16_t
 
’Œy_size
,

125 
ušt16_t
 
Çme_bË_šdex
) const;

129 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
NameTabË
(

130 cÚ¡ 
Elf64_Shdr
 *
Çme_bË_h—d”
) const;

133 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe_
;

137 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, cÚ¡ 
	gElf64_Shdr
 *> 
	g£ùiÚ_h—d”s_
;

141 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
,‡b¦::
S·n
<cÚ¡ 
ušt8_t
>> 
£ùiÚ_d©a_
;

144 
	gStusOr
<
	gElfR—d”
> ElfR—d”::
C»©eFromS·n
(

145 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe
) {

146  
ElfR—d”C»©Ü
(
–f_fe
).
C»©e
();

149 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
ElfR—d”
::
	$G‘SeùiÚD©a
(

150 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
) const {

151 
¡d
::
¡ršg
 
£ùiÚ_Çme_¡ršg
 = std::
	`¡ršg
(
£ùiÚ_Çme
);

152 autØ
£ùiÚ_h—d”_lookup
 = 
£ùiÚ_h—d”s_
.
	`fšd
(
£ùiÚ_Çme_¡ršg
);

154 ià(
£ùiÚ_h—d”_lookup
 =ğ
£ùiÚ_h—d”s_
.
	`ûnd
()) {

155  
	`Stus
(

156 
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
,

157 
ab¦
::
	`SŒC©
("FdÛ nÙ cÚš‡ seùiÚ c®Ëd ", 
£ùiÚ_Çme
));

160 ià(
£ùiÚ_h—d”_lookup
->
£cÚd
->
sh_ty³
 =ğ
SHT_NOBITS
) {

161  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

162 
ab¦
::
	`SŒC©
("SeùiÚ ", 
£ùiÚ_Çme
, " has‚o data"));

165 autØ
£ùiÚ_d©a_lookup
 = 
£ùiÚ_d©a_
.
	`fšd
(
£ùiÚ_Çme_¡ršg
);

166 ià(
£ùiÚ_d©a_lookup
 =ğ
£ùiÚ_d©a_
.
	`ûnd
()) {

167  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

168 
ab¦
::
	`SŒC©
("Could‚ot†ocate data‡ssociated with section ",

169 
£ùiÚ_Çme
));

172  
£ùiÚ_d©a_lookup
->
£cÚd
;

173 
	}
}

175 
	gStusOr
<
	gElfR—d”
> 
	gElfR—d”C»©Ü
::
	$C»©e
() {

176 
	`ASYLO_RETURN_IF_ERROR
(
	`In™ŸlizeSeùiÚM­s
());

177  
	`ElfR—d”
(
–f_fe_
, 
¡d
::
	`move
(
£ùiÚ_h—d”s_
),

178 
¡d
::
	`move
(
£ùiÚ_d©a_
));

179 
	}
}

181 
Stus
 
	gElfR—d”C»©Ü
::
	$In™ŸlizeSeùiÚM­s
() {

182 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
;

184 
	`ASYLO_ASSIGN_OR_RETURN
(
–f_h—d”
, 
	`ElfH—d”
());

186 
Elf64_Off
 
£ùiÚ_bË_¡¬t
;

187 
ušt16_t
 
num_£ùiÚs
;

188 
ušt16_t
 
’Œy_size
;

189 
ušt16_t
 
Çme_bË_šdex
;

191 
	`ASYLO_ASSIGN_OR_RETURN
(
£ùiÚ_bË_¡¬t
, 
	`SeùiÚTabËS¹
(
–f_h—d”
));

192 
	`ASYLO_ASSIGN_OR_RETURN
(
num_£ùiÚs
, 
	`NumSeùiÚs
(
–f_h—d”
));

193 
	`ASYLO_ASSIGN_OR_RETURN
(
’Œy_size
, 
	`EÁrySize
(
–f_h—d”
));

194 
	`ASYLO_ASSIGN_OR_RETURN
(
Çme_bË_šdex
, 
	`NameTabËIndex
(
–f_h—d”
));

196 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_h—d”_bË
;

197 cÚ¡ 
Elf64_Shdr
 *
Çme_bË_h—d”
;

199 
	`ASYLO_ASSIGN_OR_RETURN
(

200 
£ùiÚ_h—d”_bË
,

201 
	`SeùiÚH—d”TabË
(
£ùiÚ_bË_¡¬t
, 
num_£ùiÚs
, 
’Œy_size
));

202 
	`ASYLO_ASSIGN_OR_RETURN
(

203 
Çme_bË_h—d”
,

204 
	`NameTabËH—d”
(
£ùiÚ_h—d”_bË
, 
’Œy_size
, 
Çme_bË_šdex
));

206 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
Çme_bË
;

208 
	`ASYLO_ASSIGN_OR_RETURN
(
Çme_bË
, 
	`NameTabË
(
Çme_bË_h—d”
));

212 
ušt16_t
 
i
 = 0; i < 
num_£ùiÚs
; ++i) {

213 cÚ¡ 
Elf64_Shdr
 *
£ùiÚ_h—d”
 = 
»š‹½»t_ÿ¡
<const Elf64_Shdr *>(

214 &
£ùiÚ_h—d”_bË
[
i
 * 
’Œy_size
]);

217 cÚ¡ 
ušt32_t
 
Çme_šdex
 = 
£ùiÚ_h—d”
->
sh_Çme
;

218 autØ
£ùiÚ_Çme_Ü_nÚe
 = 
	`G‘SŒšgAtOff£t
(
Çme_bË
, 
Çme_šdex
);

220 ià(!
£ùiÚ_Çme_Ü_nÚe
.
	`has_v®ue
()) {

221  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

222 
ab¦
::
	`SŒC©
("M®fÜmed ELF fe: seùiÚ ", 
i
,

226 cÚ¡ 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
 = 
£ùiÚ_Çme_Ü_nÚe
.
	`v®ue
();

229 autØ
h—d”_š£¹iÚ_»suÉ
 =

230 
£ùiÚ_h—d”s_
.
	`š£¹
({
¡d
::
	`¡ršg
(
£ùiÚ_Çme
), 
£ùiÚ_h—d”
});

231 ià(!
h—d”_š£¹iÚ_»suÉ
.
£cÚd
) {

232  
	`Stus
(

233 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

234 
ab¦
::
	`SŒC©
("Malformed ELF file: duplicated section‚ame: ",

235 
£ùiÚ_Çme
));

241 ià(
£ùiÚ_h—d”
->
sh_ty³
 !ğ
SHT_NOBITS
) {

243 cÚ¡ 
Elf64_Off
 
£ùiÚ_¡¬t
 = 
£ùiÚ_h—d”
->
sh_off£t
;

244 cÚ¡ 
ušt64_t
 
£ùiÚ_size
 = 
£ùiÚ_h—d”
->
sh_size
;

245 autØ
d©a_v›w_Ü_nÚe
 =

246 
	`G‘Sub¥ª
(
–f_fe_
, 
£ùiÚ_¡¬t
, 
£ùiÚ_size
);

248 ià(!
d©a_v›w_Ü_nÚe
.
	`has_v®ue
()) {

249  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

250 
ab¦
::
	`SŒC©
("M®fÜmed ELF fe: seùiÚ ", 
£ùiÚ_Çme
,

254 cÚ¡ 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
d©a_v›w
 = 
d©a_v›w_Ü_nÚe
.
	`v®ue
();

257 autØ
d©a_š£¹iÚ_»suÉ
 =

258 
£ùiÚ_d©a_
.
	`š£¹
({
¡d
::
	`¡ršg
(
£ùiÚ_Çme
), 
d©a_v›w
});

259 ià(!
d©a_š£¹iÚ_»suÉ
.
£cÚd
) {

260  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
,

261 
ab¦
::
	`SŒC©
("Failedo„ecord data of section ",

262 
£ùiÚ_Çme
, " in section dataable"));

267  
Stus
::
	`OkStus
();

268 
	}
}

270 
	gStusOr
<cÚ¡ 
	gElf64_Ehdr
 *> 
	gElfR—d”C»©Ü
::
	$ElfH—d”
() const {

271 autØ
–f_h—d”_Ü_nÚe
 = 
G‘Sub¥ªAs
<
Elf64_Ehdr
>(
–f_fe_
, 0);

273 ià(!
–f_h—d”_Ü_nÚe
.
	`has_v®ue
()) {

274  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

278 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
 = 
–f_h—d”_Ü_nÚe
.
	`v®ue
();

280 ià(
–f_h—d”
->
e_id’t
[
EI_MAG0
] !ğ
ELFMAG0
 ||

281 
–f_h—d”
->
e_id’t
[
EI_MAG1
] !ğ
ELFMAG1
 ||

282 
–f_h—d”
->
e_id’t
[
EI_MAG2
] !ğ
ELFMAG2
 ||

283 
–f_h—d”
->
e_id’t
[
EI_MAG3
] !ğ
ELFMAG3
) {

284  
	`Stus
(

285 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

289 ià(
–f_h—d”
->
e_id’t
[
EI_CLASS
] !ğ
ELFCLASS64
) {

290  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

294 ià(
–f_h—d”
->
e_id’t
[
EI_DATA
] !ğ
ELFDATA2LSB
) {

295  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

300 ià(
–f_h—d”
->
e_id’t
[
EI_VERSION
] !ğ
EV_CURRENT
 ||

301 
–f_h—d”
->
e_v”siÚ
 !ğ
EV_CURRENT
) {

302  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

306  
–f_h—d”
;

307 
	}
}

309 
	gStusOr
<
	gElf64_Off
> 
	gElfR—d”C»©Ü
::
	$SeùiÚTabËS¹
(

310 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

311 ià(
–f_h—d”
->
e_shoff
 == 0) {

312  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

316  
–f_h—d”
->
e_shoff
;

317 
	}
}

319 
	gStusOr
<
	gušt16_t
> 
	gElfR—d”C»©Ü
::
	$NumSeùiÚs
(

320 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

324 ià(
–f_h—d”
->
e_shnum
 == 0) {

325  
	`Stus
(

326 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

330  
–f_h—d”
->
e_shnum
;

331 
	}
}

333 
	gStusOr
<
	gušt16_t
> 
	gElfR—d”C»©Ü
::
	$EÁrySize
(

334 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

335 ià(
–f_h—d”
->
e_sh’tsize
 < (
Elf64_Shdr
)) {

336  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

340  
–f_h—d”
->
e_sh’tsize
;

341 
	}
}

343 
	gStusOr
<
	gušt16_t
> 
	gElfR—d”C»©Ü
::
	$NameTabËIndex
(

344 cÚ¡ 
Elf64_Ehdr
 *
–f_h—d”
) const {

345 ià(
–f_h—d”
->
e_sh¡ºdx
 =ğ
SHN_UNDEF
) {

346  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

350  
–f_h—d”
->
e_sh¡ºdx
;

351 
	}
}

353 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
ElfR—d”C»©Ü
::
	$SeùiÚH—d”TabË
(

354 
Elf64_Off
 
£ùiÚ_bË_¡¬t
, 
ušt16_t
 
num_£ùiÚs
,

355 
ušt16_t
 
’Œy_size
) const {

356 autØ
£ùiÚ_h—d”_bË_Ü_nÚe
 =

357 
	`G‘Sub¥ª
(
–f_fe_
, 
£ùiÚ_bË_¡¬t
, 
num_£ùiÚs
 * 
’Œy_size
);

359 ià(!
£ùiÚ_h—d”_bË_Ü_nÚe
.
	`has_v®ue
()) {

360  
	`Stus
(

361 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

365  
£ùiÚ_h—d”_bË_Ü_nÚe
.
	`v®ue
();

366 
	}
}

368 
	gStusOr
<cÚ¡ 
	gElf64_Shdr
 *> 
	gElfR—d”C»©Ü
::
NameTabËH—d”
(

369 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_h—d”_bË
, 
ušt16_t
 
’Œy_size
,

370 
ušt16_t
 
Çme_bË_šdex
) const {

371 autØ
	gÇme_bË_h—d”_Ü_nÚe
 = 
G‘Sub¥ªAs
<
Elf64_Shdr
>(

372 
£ùiÚ_h—d”_bË
, 
Çme_bË_šdex
 * 
	g’Œy_size
);

374 ià(!
	gÇme_bË_h—d”_Ü_nÚe
.
has_v®ue
()) {

375  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

381 cÚ¡ 
Elf64_Shdr
 *
	gÇme_bË_h—d”
 = 
Çme_bË_h—d”_Ü_nÚe
.
v®ue
();

383 ià(
	gÇme_bË_h—d”
->
	gsh_ty³
 !ğ
SHT_STRTAB
) {

384  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

390  
	gÇme_bË_h—d”
;

393 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
ElfR—d”C»©Ü
::
	$NameTabË
(

394 cÚ¡ 
Elf64_Shdr
 *
Çme_bË_h—d”
) const {

395 cÚ¡ 
Elf64_Off
 
Çme_bË_¡¬t
 = 
Çme_bË_h—d”
->
sh_off£t
;

396 cÚ¡ 
ušt64_t
 
Çme_bË_size
 = 
Çme_bË_h—d”
->
sh_size
;

397 autØ
Çme_bË_Ü_nÚe
 =

398 
	`G‘Sub¥ª
(
–f_fe_
, 
Çme_bË_¡¬t
, 
Çme_bË_size
);

400 ià(!
Çme_bË_Ü_nÚe
.
	`has_v®ue
()) {

401  
	`Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

407  
Çme_bË_Ü_nÚe
.
	`v®ue
();

408 
	}
}

	@util/elf_reader.h

19 #iâdeà
ASYLO_UTIL_ELF_READER_H_


20 
	#ASYLO_UTIL_ELF_READER_H_


	)

22 
	~<–f.h
>

23 
	~<c¡dšt
>

24 
	~<¡ršg
>

25 
	~<ut™y
>

27 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"ab¦/ty³s/¥ª.h
"

30 
	~"asylo/ut/¡©usÜ.h
"

32 
Çme¥aû
 
	gasylo
 {

35 şas 
	cElfR—d”
 {

36 
	gpublic
:

43 
StusOr
<
ElfR—d”
> 
C»©eFromS·n
(
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe
);

45 
ElfR—d”
() = ;

47 
ElfR—d”
(cÚ¡ ElfR—d” &
Ùh”
) = ;

48 
	gElfR—d”
 &
	gİ”©Ü
=(cÚ¡ 
ElfR—d”
 &
Ùh”
) = ;

52 
	gStusOr
<
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
>> 
G‘SeùiÚD©a
(

53 
ab¦
::
¡ršg_v›w
 
£ùiÚ_Çme
) const;

55 
	g´iv©e
:

57 
ä›nd
 
şass
 
ElfR—d”C»©Ü
;

59 
ElfR—d”
(

60 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe
,

61 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, cÚ¡ 
Elf64_Shdr
 *> &&
£ùiÚ_h—d”s
,

62 
ab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
,‡b¦::
S·n
<cÚ¡ 
ušt8_t
>>

63 &&
£ùiÚ_d©a
)

64 : 
–f_fe_
(
–f_fe
),

65 
£ùiÚ_h—d”s_
(
¡d
::
move
(
£ùiÚ_h—d”s
)),

66 
£ùiÚ_d©a_
(
¡d
::
move
(
£ùiÚ_d©a
)) {}

69 
ab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
–f_fe_
;

72 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
, cÚ¡ 
	gElf64_Shdr
 *> 
	g£ùiÚ_h—d”s_
;

75 
	gab¦
::
æ©_hash_m­
<
¡d
::
¡ršg
,‡b¦::
S·n
<cÚ¡ 
ušt8_t
>> 
£ùiÚ_d©a_
;

	@util/elf_reader_test.cc

19 
	~"asylo/ut/–f_»ad”.h
"

21 
	~<–f.h
>

22 
	~<c¡ršg
>

23 
	~<lim™s
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"ab¦/ty³s/¥ª.h
"

30 
	~"gæags/gæags.h
"

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/ut/fe_m­pšg.h
"

35 
DEFINE_¡ršg
(
–f_fe
, "", "The ELF fileo use foresting");

36 
DEFINE_¡ršg
(
£ùiÚ_Çme
, "", "The‚ame ofhe sectiono use foresting");

37 
DEFINE_¡ršg
(
ex³ùed_cÚ‹Ás
, "",

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

43 
	gusšg
 ::
‹¡šg
::
NÙ
;

46 
cÚ¡ex´
 
	gkAb£ÁSeùiÚName
[] = "\r%";

48 şas 
	cElfR—d”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

49 
public
:

50 
ElfR—d”Te¡
(è: ElfR—d”Te¡(
ElfR—d”Te¡Memb”s
()) {}

52 
´Ùeùed
:

53 
	sElfR—d”Te¡Memb”s
 {

54 
FeM­pšg
 
–f_fe_m­pšg
;

55 
Elf64_Ehdr
 *
	g–f_h—d”
;

56 
Elf64_Shdr
 *
	gÇme_bË_h—d”
;

57 
	gab¦
::
¡ršg_v›w
 
Çme_bË_Çme
;

58 
ušt16_t
 
	grg‘_£ùiÚ_šdex
;

59 
Elf64_Shdr
 *
	grg‘_£ùiÚ_h—d”
;

61 
ElfR—d”Te¡Memb”s
() {

63 autØ
	gäom_–f_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_–f_fe
);

64 
CHECK
(
äom_–f_fe_»suÉ
.
ok
());

65 
	g–f_fe_m­pšg
 = 
¡d
::
move
(
äom_–f_fe_»suÉ
.
V®ueOrD›
());

68 
	gab¦
::
S·n
<
ušt8_t
> 
–f_fe
 = 
–f_fe_m­pšg
.
bufãr
();

69 
CHECK_GT
(
–f_fe
.
size
(), (
Elf64_Ehdr
));

70 
	g–f_h—d”
 = 
»š‹½»t_ÿ¡
<
Elf64_Ehdr
 *>(
–f_fe
.
d©a
());

73 
Elf64_Off
 
	g£ùiÚ_h—d”_bË_¡¬t
 = 
–f_h—d”
->
e_shoff
;

74 
ušt16_t
 
	gnum_£ùiÚs
 = 
–f_h—d”
->
e_shnum
;

75 
ušt64_t
 
	g’Œy_size
 = 
–f_h—d”
->
e_sh’tsize
;

76 
Elf64_Off
 
	g£ùiÚ_h—d”_bË_’d
 =

77 
£ùiÚ_h—d”_bË_¡¬t
 + 
num_£ùiÚs
 * 
’Œy_size
;

79 
CHECK_LE
(
£ùiÚ_h—d”_bË_’d
, 
–f_fe
.
size
());

82 
ušt16_t
 
	gÇme_bË_šdex
 = 
–f_h—d”
->
e_sh¡ºdx
;

84 
CHECK_LT
(
Çme_bË_šdex
, 
num_£ùiÚs
);

86 
	gÇme_bË_h—d”
 = 
»š‹½»t_ÿ¡
<
Elf64_Shdr
 *>(

87 &
–f_fe
[
£ùiÚ_h—d”_bË_¡¬t
 +

88 
Çme_bË_šdex
 * 
’Œy_size
]);

89 
Elf64_Off
 
	g£ùiÚ_Çmes_¡¬t
 = 
Çme_bË_h—d”
->
sh_off£t
;

90 
ušt64_t
 
	g£ùiÚ_Çmes_size
 = 
Çme_bË_h—d”
->
sh_size
;

92 
CHECK_LT
(
£ùiÚ_Çmes_¡¬t
 + 
£ùiÚ_Çmes_size
, 
–f_fe
.
size
());

95 
ušt32_t
 
	gÇme_bË_Çme_šdex
 = 
Çme_bË_h—d”
->
sh_Çme
;

97 
CHECK_LT
(
Çme_bË_Çme_šdex
, 
£ùiÚ_Çmes_size
);

99 *
	gÇme_bË_Çme_¡¬t
 = 
»š‹½»t_ÿ¡
<*>(

100 &
–f_fe
[
£ùiÚ_Çmes_¡¬t
 + 
Çme_bË_Çme_šdex
]);

101 
size_t
 
	gÇme_bË_Çme_Ëngth
 = 
¡ºËn
(

102 
Çme_bË_Çme_¡¬t
, 
£ùiÚ_Çmes_size
 - 
Çme_bË_Çme_šdex
);

104 
	gÇme_bË_Çme
 =

105 
ab¦
::
¡ršg_v›w
(
Çme_bË_Çme_¡¬t
, 
Çme_bË_Çme_Ëngth
);

108 
ušt16_t
 
	gi
 = 0; i < 
	gnum_£ùiÚs
; ++i) {

110 
Elf64_Shdr
 *
	g£ùiÚ_h—d”
 = 
»š‹½»t_ÿ¡
<Elf64_Shdr *>(

111 &
–f_fe
[
£ùiÚ_h—d”_bË_¡¬t
 + 
i
 * 
’Œy_size
]);

112 
ušt32_t
 
	g£ùiÚ_i_Çme_šdex
 = 
£ùiÚ_h—d”
->
sh_Çme
;

114 
CHECK_LE
(
£ùiÚ_i_Çme_šdex
, 
£ùiÚ_Çmes_size
);

116 *
	g£ùiÚ_i_Çme
 = 
»š‹½»t_ÿ¡
<*>(

117 &
–f_fe
[
£ùiÚ_Çmes_¡¬t
 + 
£ùiÚ_i_Çme_šdex
]);

120 ià(
¡ºcmp
(
£ùiÚ_i_Çme
, 
FLAGS_£ùiÚ_Çme
.
d©a
(),

121 
FLAGS_£ùiÚ_Çme
.
size
()) == 0 &&

122 
£ùiÚ_i_Çme
[
FLAGS_£ùiÚ_Çme
.
size
()] == '\0') {

123 
rg‘_£ùiÚ_šdex
 = 
i
;

124 
	grg‘_£ùiÚ_h—d”
 = 
£ùiÚ_h—d”
;

131 
ex¶ic™
 
ElfR—d”Te¡
(
ElfR—d”Te¡Memb”s
 
memb”s
)

132 : 
–f_fe_m­pšg_
(
¡d
::
move
(
memb”s
.
–f_fe_m­pšg
)),

133 
–f_h—d”_
(
memb”s
.
–f_h—d”
),

134 
Çme_bË_h—d”_
(
memb”s
.
Çme_bË_h—d”
),

135 
Çme_bË_Çme_
(
memb”s
.
Çme_bË_Çme
),

136 
rg‘_£ùiÚ_šdex_
(
memb”s
.
rg‘_£ùiÚ_šdex
),

137 
rg‘_£ùiÚ_h—d”_
(
memb”s
.
rg‘_£ùiÚ_h—d”
) {}

142 
Ex³ùBadR—d”IÅut
(
ab¦
::
¡ršg_v›w
 
”rÜ_mes§ge
) {

143 autØ
ü—‹_äom_¥ª_»suÉ
 =

144 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

145 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
NÙ
(
IsOk
()));

146 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
(),

147 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

148 
EXPECT_EQ
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),ƒrror_message);

152 
FeM­pšg
 
	g–f_fe_m­pšg_
;

155 
Elf64_Ehdr
 *cÚ¡ 
	g–f_h—d”_
;

159 
Elf64_Shdr
 *cÚ¡ 
	gÇme_bË_h—d”_
;

162 cÚ¡ 
	gab¦
::
¡ršg_v›w
 
Çme_bË_Çme_
;

166 cÚ¡ 
ušt16_t
 
	grg‘_£ùiÚ_šdex_
;

169 
Elf64_Shdr
 *cÚ¡ 
	grg‘_£ùiÚ_h—d”_
;

173 
TEST_F
(
ElfR—d”Te¡
, 
WÜksOnV®idIÅuts
) {

174 autØ
	gäom_d©a_fe_»suÉ
 =

175 
FeM­pšg
::
C»©eFromFe
(
FLAGS_ex³ùed_cÚ‹Ás
);

176 
ASSERT_THAT
(
äom_d©a_fe_»suÉ
, 
IsOk
());

177 
FeM­pšg
 
	gex³ùed_cÚ‹Ás_m­pšg
 =

178 
¡d
::
move
(
äom_d©a_fe_»suÉ
.
V®ueOrD›
());

180 
ASSERT_GE
(
–f_fe_m­pšg_
.
bufãr
().
size
(), (
Elf64_Ehdr
));

182 autØ
	gü—‹_äom_¥ª_»suÉ
 =

183 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

184 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
IsOk
());

185 
ElfR—d”
 
	g»ad”
 = 
ü—‹_äom_¥ª_»suÉ
.
V®ueOrD›
();

187 autØ
	gg‘_£ùiÚ_d©a_»suÉ
 = 
»ad”
.
G‘SeùiÚD©a
(
FLAGS_£ùiÚ_Çme
);

188 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
, 
IsOk
());

189 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_d©a
 = 
g‘_£ùiÚ_d©a_»suÉ
.
V®ueOrD›
();

191 
EXPECT_EQ
(
£ùiÚ_d©a
.
size
(), 
ex³ùed_cÚ‹Ás_m­pšg
.
bufãr
().size());

192 
EXPECT_EQ
(

193 
memcmp
(
£ùiÚ_d©a
.
d©a
(), 
ex³ùed_cÚ‹Ás_m­pšg
.
bufãr
().data(),

194 
ex³ùed_cÚ‹Ás_m­pšg
.
bufãr
().
size
()),

200 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadMagicNumb”
) {

201 
	g–f_h—d”_
->
	ge_id’t
[
EI_MAG0
] = ~
ELFMAG0
;

203 
Ex³ùBadR—d”IÅut
(

209 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIf32B™Elf
) {

210 
	g–f_h—d”_
->
	ge_id’t
[
EI_CLASS
] = 
ELFCLASS32
;

212 
Ex³ùBadR—d”IÅut
("Unsupported file format: only 64-bit ELF is supported");

217 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBigEndŸn
) {

218 
	g–f_h—d”_
->
	ge_id’t
[
EI_DATA
] = 
ELFDATA2MSB
;

220 
Ex³ùBadR—d”IÅut
(

226 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfWrÚgV”siÚ
) {

227 
	g–f_h—d”_
->
	ge_id’t
[
EI_VERSION
] = 
EV_NONE
;

229 
Ex³ùBadR—d”IÅut
("Unsupported file format: unknown ELF version");

234 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfNoSeùiÚH—d”TabË
) {

235 
	g–f_h—d”_
->
	ge_shoff
 = 0;

237 
Ex³ùBadR—d”IÅut
("ELF file contains‚o section headerable");

242 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfTooMªySeùiÚs
) {

243 
	g–f_h—d”_
->
	ge_shnum
 = 0;

245 
Ex³ùBadR—d”IÅut
(

251 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadSh’tsize
) {

252 
	g–f_h—d”_
->
	ge_sh’tsize
 = 0;

254 
Ex³ùBadR—d”IÅut
("Malformed ELF file: malformed section header size");

259 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfNoSeùiÚNameSŒšgTabË
) {

260 
	g–f_h—d”_
->
	ge_sh¡ºdx
 = 
SHN_UNDEF
;

262 
Ex³ùBadR—d”IÅut
(

268 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚH—d”TabËOv”æow
) {

269 
	g–f_h—d”_
->
	ge_shoff
 = 
¡d
::
num”ic_lim™s
<
Elf64_Off
>::
max
() / 2;

271 
Ex³ùBadR—d”IÅut
(

277 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadSh¡ºdx
) {

278 
	g–f_h—d”_
->
	ge_sh¡ºdx
 = 
–f_h—d”_
->
e_shnum
 + 1;

280 
Ex³ùBadR—d”IÅut
(

287 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadNameTabËTy³
) {

288 
	gÇme_bË_h—d”_
->
	gsh_ty³
 = 
SHT_PROGBITS
;

290 
Ex³ùBadR—d”IÅut
(

298 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfNameTabËTooBig
) {

299 
	gÇme_bË_h—d”_
->
	gsh_off£t
 = 
¡d
::
num”ic_lim™s
<
Elf64_Off
>::
max
() / 2;

301 
Ex³ùBadR—d”IÅut
(

308 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚNameOutsideTabË
) {

309 
	grg‘_£ùiÚ_h—d”_
->
	gsh_Çme
 = 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
() / 2;

311 
Ex³ùBadR—d”IÅut
(
ab¦
::
SŒC©
("Malformed ELF file: section ",

312 
rg‘_£ùiÚ_šdex_
,

318 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfDu¶iÿ‹SeùiÚNames
) {

319 
	grg‘_£ùiÚ_h—d”_
->
	gsh_Çme
 = 
Çme_bË_h—d”_
->
sh_Çme
;

321 
Ex³ùBadR—d”IÅut
(
ab¦
::
SŒC©
(

322 "M®fÜmed ELF fe: du¶iÿ‹d seùiÚ‚ame: ", 
Çme_bË_Çme_
));

327 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚTooBig
) {

328 
	grg‘_£ùiÚ_h—d”_
->
	gsh_off£t
 = 
¡d
::
num”ic_lim™s
<
Elf64_Off
>::
max
() / 2;

330 
Ex³ùBadR—d”IÅut
(
ab¦
::
SŒC©
("Malformed ELF file: section ",

331 
FLAGS_£ùiÚ_Çme
,

337 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚNÙFound
) {

338 autØ
	gü—‹_äom_¥ª_»suÉ
 =

339 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

340 
ASSERT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
IsOk
());

341 
ElfR—d”
 
	g»ad”
 = 
ü—‹_äom_¥ª_»suÉ
.
V®ueOrD›
();

343 autØ
	gg‘_£ùiÚ_d©a_»suÉ
 = 
»ad”
.
G‘SeùiÚD©a
(
kAb£ÁSeùiÚName
);

344 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
, 
NÙ
(
IsOk
()));

345 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
(),

346 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
));

347 
EXPECT_EQ
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),

348 
ab¦
::
SŒC©
("File does‚ot contain‡ section called ",

349 
kAb£ÁSeùiÚName
));

354 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfT¬g‘SeùiÚHasNoD©a
) {

355 
	grg‘_£ùiÚ_h—d”_
->
	gsh_ty³
 = 
SHT_NOBITS
;

357 autØ
	gü—‹_äom_¥ª_»suÉ
 =

358 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

359 
ASSERT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
IsOk
());

360 
ElfR—d”
 
	g»ad”
 = 
ü—‹_äom_¥ª_»suÉ
.
V®ueOrD›
();

362 autØ
	gg‘_£ùiÚ_d©a_»suÉ
 = 
»ad”
.
G‘SeùiÚD©a
(
FLAGS_£ùiÚ_Çme
);

363 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
, 
NÙ
(
IsOk
()));

364 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
(),

365 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

366 
EXPECT_EQ
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),

367 
ab¦
::
SŒC©
("SeùiÚ ", 
FLAGS_£ùiÚ_Çme
, " has‚o data"));

372 
TEST
(
ElfR—d”Fixtu»ËssTe¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfFeTooSm®l
) {

373 
ušt8_t
 
	gtoo_sm®l_bufãr
[(
Elf64_Ehdr
) - 1];

375 autØ
	gü—‹_äom_¥ª_»suÉ
 = 
ElfR—d”
::
C»©eFromS·n
(

376 
ab¦
::
S·n
<
ušt8_t
>(
too_sm®l_bufãr
, (too_small_buffer)));

377 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
NÙ
(
IsOk
()));

378 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
(),

379 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

380 
EXPECT_EQ
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),

	@util/elf_reader_test.cc

19 
	~"asylo/ut/–f_»ad”.h
"

21 
	~<–f.h
>

22 
	~<c¡ršg
>

23 
	~<lim™s
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"ab¦/ty³s/¥ª.h
"

30 
	~"gæags/gæags.h
"

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

33 
	~"asylo/ut/fe_m­pšg.h
"

35 
DEFINE_¡ršg
(
–f_fe
, "", "The ELF fileo use foresting");

36 
DEFINE_¡ršg
(
£ùiÚ_Çme
, "", "The‚ame ofhe sectiono use foresting");

37 
DEFINE_¡ršg
(
ex³ùed_cÚ‹Ás
, "",

40 
Çme¥aû
 
	gasylo
 {

41 
	gÇme¥aû
 {

43 
	gusšg
 ::
‹¡šg
::
NÙ
;

46 
cÚ¡ex´
 
	gkAb£ÁSeùiÚName
[] = "\r%";

48 şas 
	cElfR—d”Te¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

49 
public
:

50 
ElfR—d”Te¡
(è: ElfR—d”Te¡(
ElfR—d”Te¡Memb”s
()) {}

52 
´Ùeùed
:

53 
	sElfR—d”Te¡Memb”s
 {

54 
FeM­pšg
 
–f_fe_m­pšg
;

55 
Elf64_Ehdr
 *
	g–f_h—d”
;

56 
Elf64_Shdr
 *
	gÇme_bË_h—d”
;

57 
	gab¦
::
¡ršg_v›w
 
Çme_bË_Çme
;

58 
ušt16_t
 
	grg‘_£ùiÚ_šdex
;

59 
Elf64_Shdr
 *
	grg‘_£ùiÚ_h—d”
;

61 
ElfR—d”Te¡Memb”s
() {

63 autØ
	gäom_–f_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_–f_fe
);

64 
CHECK
(
äom_–f_fe_»suÉ
.
ok
());

65 
	g–f_fe_m­pšg
 = 
¡d
::
move
(
äom_–f_fe_»suÉ
.
V®ueOrD›
());

68 
	gab¦
::
S·n
<
ušt8_t
> 
–f_fe
 = 
–f_fe_m­pšg
.
bufãr
();

69 
CHECK_GT
(
–f_fe
.
size
(), (
Elf64_Ehdr
));

70 
	g–f_h—d”
 = 
»š‹½»t_ÿ¡
<
Elf64_Ehdr
 *>(
–f_fe
.
d©a
());

73 
Elf64_Off
 
	g£ùiÚ_h—d”_bË_¡¬t
 = 
–f_h—d”
->
e_shoff
;

74 
ušt16_t
 
	gnum_£ùiÚs
 = 
–f_h—d”
->
e_shnum
;

75 
ušt64_t
 
	g’Œy_size
 = 
–f_h—d”
->
e_sh’tsize
;

76 
Elf64_Off
 
	g£ùiÚ_h—d”_bË_’d
 =

77 
£ùiÚ_h—d”_bË_¡¬t
 + 
num_£ùiÚs
 * 
’Œy_size
;

79 
CHECK_LE
(
£ùiÚ_h—d”_bË_’d
, 
–f_fe
.
size
());

82 
ušt16_t
 
	gÇme_bË_šdex
 = 
–f_h—d”
->
e_sh¡ºdx
;

84 
CHECK_LT
(
Çme_bË_šdex
, 
num_£ùiÚs
);

86 
	gÇme_bË_h—d”
 = 
»š‹½»t_ÿ¡
<
Elf64_Shdr
 *>(

87 &
–f_fe
[
£ùiÚ_h—d”_bË_¡¬t
 +

88 
Çme_bË_šdex
 * 
’Œy_size
]);

89 
Elf64_Off
 
	g£ùiÚ_Çmes_¡¬t
 = 
Çme_bË_h—d”
->
sh_off£t
;

90 
ušt64_t
 
	g£ùiÚ_Çmes_size
 = 
Çme_bË_h—d”
->
sh_size
;

92 
CHECK_LT
(
£ùiÚ_Çmes_¡¬t
 + 
£ùiÚ_Çmes_size
, 
–f_fe
.
size
());

95 
ušt32_t
 
	gÇme_bË_Çme_šdex
 = 
Çme_bË_h—d”
->
sh_Çme
;

97 
CHECK_LT
(
Çme_bË_Çme_šdex
, 
£ùiÚ_Çmes_size
);

99 *
	gÇme_bË_Çme_¡¬t
 = 
»š‹½»t_ÿ¡
<*>(

100 &
–f_fe
[
£ùiÚ_Çmes_¡¬t
 + 
Çme_bË_Çme_šdex
]);

101 
size_t
 
	gÇme_bË_Çme_Ëngth
 = 
¡ºËn
(

102 
Çme_bË_Çme_¡¬t
, 
£ùiÚ_Çmes_size
 - 
Çme_bË_Çme_šdex
);

104 
	gÇme_bË_Çme
 =

105 
ab¦
::
¡ršg_v›w
(
Çme_bË_Çme_¡¬t
, 
Çme_bË_Çme_Ëngth
);

108 
ušt16_t
 
	gi
 = 0; i < 
	gnum_£ùiÚs
; ++i) {

110 
Elf64_Shdr
 *
	g£ùiÚ_h—d”
 = 
»š‹½»t_ÿ¡
<Elf64_Shdr *>(

111 &
–f_fe
[
£ùiÚ_h—d”_bË_¡¬t
 + 
i
 * 
’Œy_size
]);

112 
ušt32_t
 
	g£ùiÚ_i_Çme_šdex
 = 
£ùiÚ_h—d”
->
sh_Çme
;

114 
CHECK_LE
(
£ùiÚ_i_Çme_šdex
, 
£ùiÚ_Çmes_size
);

116 *
	g£ùiÚ_i_Çme
 = 
»š‹½»t_ÿ¡
<*>(

117 &
–f_fe
[
£ùiÚ_Çmes_¡¬t
 + 
£ùiÚ_i_Çme_šdex
]);

120 ià(
¡ºcmp
(
£ùiÚ_i_Çme
, 
FLAGS_£ùiÚ_Çme
.
d©a
(),

121 
FLAGS_£ùiÚ_Çme
.
size
()) == 0 &&

122 
£ùiÚ_i_Çme
[
FLAGS_£ùiÚ_Çme
.
size
()] == '\0') {

123 
rg‘_£ùiÚ_šdex
 = 
i
;

124 
	grg‘_£ùiÚ_h—d”
 = 
£ùiÚ_h—d”
;

131 
ex¶ic™
 
ElfR—d”Te¡
(
ElfR—d”Te¡Memb”s
 
memb”s
)

132 : 
–f_fe_m­pšg_
(
¡d
::
move
(
memb”s
.
–f_fe_m­pšg
)),

133 
–f_h—d”_
(
memb”s
.
–f_h—d”
),

134 
Çme_bË_h—d”_
(
memb”s
.
Çme_bË_h—d”
),

135 
Çme_bË_Çme_
(
memb”s
.
Çme_bË_Çme
),

136 
rg‘_£ùiÚ_šdex_
(
memb”s
.
rg‘_£ùiÚ_šdex
),

137 
rg‘_£ùiÚ_h—d”_
(
memb”s
.
rg‘_£ùiÚ_h—d”
) {}

142 
Ex³ùBadR—d”IÅut
(
ab¦
::
¡ršg_v›w
 
”rÜ_mes§ge
) {

143 autØ
ü—‹_äom_¥ª_»suÉ
 =

144 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

145 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
NÙ
(
IsOk
()));

146 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
(),

147 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

148 
EXPECT_EQ
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),ƒrror_message);

152 
FeM­pšg
 
	g–f_fe_m­pšg_
;

155 
Elf64_Ehdr
 *cÚ¡ 
	g–f_h—d”_
;

159 
Elf64_Shdr
 *cÚ¡ 
	gÇme_bË_h—d”_
;

162 cÚ¡ 
	gab¦
::
¡ršg_v›w
 
Çme_bË_Çme_
;

166 cÚ¡ 
ušt16_t
 
	grg‘_£ùiÚ_šdex_
;

169 
Elf64_Shdr
 *cÚ¡ 
	grg‘_£ùiÚ_h—d”_
;

173 
TEST_F
(
ElfR—d”Te¡
, 
WÜksOnV®idIÅuts
) {

174 autØ
	gäom_d©a_fe_»suÉ
 =

175 
FeM­pšg
::
C»©eFromFe
(
FLAGS_ex³ùed_cÚ‹Ás
);

176 
ASSERT_THAT
(
äom_d©a_fe_»suÉ
, 
IsOk
());

177 
FeM­pšg
 
	gex³ùed_cÚ‹Ás_m­pšg
 =

178 
¡d
::
move
(
äom_d©a_fe_»suÉ
.
V®ueOrD›
());

180 
ASSERT_GE
(
–f_fe_m­pšg_
.
bufãr
().
size
(), (
Elf64_Ehdr
));

182 autØ
	gü—‹_äom_¥ª_»suÉ
 =

183 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

184 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
IsOk
());

185 
ElfR—d”
 
	g»ad”
 = 
ü—‹_äom_¥ª_»suÉ
.
V®ueOrD›
();

187 autØ
	gg‘_£ùiÚ_d©a_»suÉ
 = 
»ad”
.
G‘SeùiÚD©a
(
FLAGS_£ùiÚ_Çme
);

188 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
, 
IsOk
());

189 
	gab¦
::
S·n
<cÚ¡ 
ušt8_t
> 
£ùiÚ_d©a
 = 
g‘_£ùiÚ_d©a_»suÉ
.
V®ueOrD›
();

191 
EXPECT_EQ
(
£ùiÚ_d©a
.
size
(), 
ex³ùed_cÚ‹Ás_m­pšg
.
bufãr
().size());

192 
EXPECT_EQ
(

193 
memcmp
(
£ùiÚ_d©a
.
d©a
(), 
ex³ùed_cÚ‹Ás_m­pšg
.
bufãr
().data(),

194 
ex³ùed_cÚ‹Ás_m­pšg
.
bufãr
().
size
()),

200 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadMagicNumb”
) {

201 
	g–f_h—d”_
->
	ge_id’t
[
EI_MAG0
] = ~
ELFMAG0
;

203 
Ex³ùBadR—d”IÅut
(

209 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIf32B™Elf
) {

210 
	g–f_h—d”_
->
	ge_id’t
[
EI_CLASS
] = 
ELFCLASS32
;

212 
Ex³ùBadR—d”IÅut
("Unsupported file format: only 64-bit ELF is supported");

217 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBigEndŸn
) {

218 
	g–f_h—d”_
->
	ge_id’t
[
EI_DATA
] = 
ELFDATA2MSB
;

220 
Ex³ùBadR—d”IÅut
(

226 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfWrÚgV”siÚ
) {

227 
	g–f_h—d”_
->
	ge_id’t
[
EI_VERSION
] = 
EV_NONE
;

229 
Ex³ùBadR—d”IÅut
("Unsupported file format: unknown ELF version");

234 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfNoSeùiÚH—d”TabË
) {

235 
	g–f_h—d”_
->
	ge_shoff
 = 0;

237 
Ex³ùBadR—d”IÅut
("ELF file contains‚o section headerable");

242 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfTooMªySeùiÚs
) {

243 
	g–f_h—d”_
->
	ge_shnum
 = 0;

245 
Ex³ùBadR—d”IÅut
(

251 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadSh’tsize
) {

252 
	g–f_h—d”_
->
	ge_sh’tsize
 = 0;

254 
Ex³ùBadR—d”IÅut
("Malformed ELF file: malformed section header size");

259 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfNoSeùiÚNameSŒšgTabË
) {

260 
	g–f_h—d”_
->
	ge_sh¡ºdx
 = 
SHN_UNDEF
;

262 
Ex³ùBadR—d”IÅut
(

268 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚH—d”TabËOv”æow
) {

269 
	g–f_h—d”_
->
	ge_shoff
 = 
¡d
::
num”ic_lim™s
<
Elf64_Off
>::
max
() / 2;

271 
Ex³ùBadR—d”IÅut
(

277 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadSh¡ºdx
) {

278 
	g–f_h—d”_
->
	ge_sh¡ºdx
 = 
–f_h—d”_
->
e_shnum
 + 1;

280 
Ex³ùBadR—d”IÅut
(

287 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfBadNameTabËTy³
) {

288 
	gÇme_bË_h—d”_
->
	gsh_ty³
 = 
SHT_PROGBITS
;

290 
Ex³ùBadR—d”IÅut
(

298 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfNameTabËTooBig
) {

299 
	gÇme_bË_h—d”_
->
	gsh_off£t
 = 
¡d
::
num”ic_lim™s
<
Elf64_Off
>::
max
() / 2;

301 
Ex³ùBadR—d”IÅut
(

308 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚNameOutsideTabË
) {

309 
	grg‘_£ùiÚ_h—d”_
->
	gsh_Çme
 = 
¡d
::
num”ic_lim™s
<
ušt32_t
>::
max
() / 2;

311 
Ex³ùBadR—d”IÅut
(
ab¦
::
SŒC©
("Malformed ELF file: section ",

312 
rg‘_£ùiÚ_šdex_
,

318 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfDu¶iÿ‹SeùiÚNames
) {

319 
	grg‘_£ùiÚ_h—d”_
->
	gsh_Çme
 = 
Çme_bË_h—d”_
->
sh_Çme
;

321 
Ex³ùBadR—d”IÅut
(
ab¦
::
SŒC©
(

322 "M®fÜmed ELF fe: du¶iÿ‹d seùiÚ‚ame: ", 
Çme_bË_Çme_
));

327 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚTooBig
) {

328 
	grg‘_£ùiÚ_h—d”_
->
	gsh_off£t
 = 
¡d
::
num”ic_lim™s
<
Elf64_Off
>::
max
() / 2;

330 
Ex³ùBadR—d”IÅut
(
ab¦
::
SŒC©
("Malformed ELF file: section ",

331 
FLAGS_£ùiÚ_Çme
,

337 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfSeùiÚNÙFound
) {

338 autØ
	gü—‹_äom_¥ª_»suÉ
 =

339 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

340 
ASSERT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
IsOk
());

341 
ElfR—d”
 
	g»ad”
 = 
ü—‹_äom_¥ª_»suÉ
.
V®ueOrD›
();

343 autØ
	gg‘_£ùiÚ_d©a_»suÉ
 = 
»ad”
.
G‘SeùiÚD©a
(
kAb£ÁSeùiÚName
);

344 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
, 
NÙ
(
IsOk
()));

345 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
(),

346 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
NOT_FOUND
));

347 
EXPECT_EQ
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),

348 
ab¦
::
SŒC©
("File does‚ot contain‡ section called ",

349 
kAb£ÁSeùiÚName
));

354 
TEST_F
(
ElfR—d”Te¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfT¬g‘SeùiÚHasNoD©a
) {

355 
	grg‘_£ùiÚ_h—d”_
->
	gsh_ty³
 = 
SHT_NOBITS
;

357 autØ
	gü—‹_äom_¥ª_»suÉ
 =

358 
ElfR—d”
::
C»©eFromS·n
(
–f_fe_m­pšg_
.
bufãr
());

359 
ASSERT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
IsOk
());

360 
ElfR—d”
 
	g»ad”
 = 
ü—‹_äom_¥ª_»suÉ
.
V®ueOrD›
();

362 autØ
	gg‘_£ùiÚ_d©a_»suÉ
 = 
»ad”
.
G‘SeùiÚD©a
(
FLAGS_£ùiÚ_Çme
);

363 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
, 
NÙ
(
IsOk
()));

364 
EXPECT_THAT
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
(),

365 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

366 
EXPECT_EQ
(
g‘_£ùiÚ_d©a_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),

367 
ab¦
::
SŒC©
("SeùiÚ ", 
FLAGS_£ùiÚ_Çme
, " has‚o data"));

372 
TEST
(
ElfR—d”Fixtu»ËssTe¡
, 
R‘uºsAµrİrŸ‹E¼ÜIfFeTooSm®l
) {

373 
ušt8_t
 
	gtoo_sm®l_bufãr
[(
Elf64_Ehdr
) - 1];

375 autØ
	gü—‹_äom_¥ª_»suÉ
 = 
ElfR—d”
::
C»©eFromS·n
(

376 
ab¦
::
S·n
<
ušt8_t
>(
too_sm®l_bufãr
, (too_small_buffer)));

377 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
, 
NÙ
(
IsOk
()));

378 
EXPECT_THAT
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
(),

379 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

380 
EXPECT_EQ
(
ü—‹_äom_¥ª_»suÉ
.
¡©us
().
”rÜ_mes§ge
(),

	@util/error_codes.h

19 #iâdeà
ASYLO_UTIL_ERROR_CODES_H_


20 
	#ASYLO_UTIL_ERROR_CODES_H_


	)

22 
Çme¥aû
 
	gasylo
 {

23 
Çme¥aû
 
	g”rÜ
 {

30 
	gGoogËE¼Ü
 : {

31 
OK
 = 0,

32 
	gCANCELLED
 = 1,

33 
	gUNKNOWN
 = 2,

34 
	gINVALID_ARGUMENT
 = 3,

35 
	gDEADLINE_EXCEEDED
 = 4,

36 
	gNOT_FOUND
 = 5,

37 
	gALREADY_EXISTS
 = 6,

38 
	gPERMISSION_DENIED
 = 7,

39 
	gRESOURCE_EXHAUSTED
 = 8,

40 
	gFAILED_PRECONDITION
 = 9,

41 
	gABORTED
 = 10,

42 
	gOUT_OF_RANGE
 = 11,

43 
	gUNIMPLEMENTED
 = 12,

44 
	gINTERNAL
 = 13,

45 
	gUNAVAILABLE
 = 14,

46 
	gDATA_LOSS
 = 15,

47 
	gUNAUTHENTICATED
 = 16

	@util/error_space.cc

19 
	~"asylo/ut/”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
	gE¼ÜS·û
::
Fšd
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

25 autØ
™”
 = 
”rÜ_š‹º®
::
AsyloE¼ÜS·ûSticM­
::
G‘V®ue
(
Çme
);

26  (
	g™”
 =ğ
”rÜ_š‹º®
::
AsyloE¼ÜS·ûSticM­
::
v®ue_’d
())

27 ? 
nuÎ±r


28 : &*
™”
;

31 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(

32 
E¼ÜS·ûAdlTag
<::
asylo
::
”rÜ
::
GoogËE¼Ü
> 
g
) {

33  
GoogËE¼ÜS·û
::
G‘In¡ªû
();

36 
	gGoogËE¼ÜS·û
::
GoogËE¼ÜS·û
()

37 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
GoogËE¼ÜS·û
>(

38 
kCªÚiÿlE¼ÜS·ûName
) {

39 
AddT¿n¦©iÚM­EÁry
(
OK
, "OK", OK);

40 
AddT¿n¦©iÚM­EÁry
(
CANCELLED
, "CANCELLED", CANCELLED);

41 
AddT¿n¦©iÚM­EÁry
(
UNKNOWN
, "UNKNOWN", UNKNOWN);

42 
AddT¿n¦©iÚM­EÁry
(
INVALID_ARGUMENT
, "INVALID_ARGUMENT",

43 
INVALID_ARGUMENT
);

44 
AddT¿n¦©iÚM­EÁry
(
DEADLINE_EXCEEDED
, "DEADLINE_EXCEEDED",

45 
DEADLINE_EXCEEDED
);

46 
AddT¿n¦©iÚM­EÁry
(
NOT_FOUND
, "NOT_FOUND", NOT_FOUND);

47 
AddT¿n¦©iÚM­EÁry
(
ALREADY_EXISTS
, "ALREADY_EXISTS", ALREADY_EXISTS);

48 
AddT¿n¦©iÚM­EÁry
(
PERMISSION_DENIED
, "PERMISSION_DENIED",

49 
PERMISSION_DENIED
);

50 
AddT¿n¦©iÚM­EÁry
(
RESOURCE_EXHAUSTED
, "RESOURCE_EXHAUSTED",

51 
RESOURCE_EXHAUSTED
);

52 
AddT¿n¦©iÚM­EÁry
(
FAILED_PRECONDITION
, "FAILED_PRECONDITION",

53 
FAILED_PRECONDITION
);

54 
AddT¿n¦©iÚM­EÁry
(
ABORTED
, "ABORTED", ABORTED);

55 
AddT¿n¦©iÚM­EÁry
(
OUT_OF_RANGE
, "OUT_OF_RANGE", OUT_OF_RANGE);

56 
AddT¿n¦©iÚM­EÁry
(
UNIMPLEMENTED
, "UNIMPLEMENTED", UNIMPLEMENTED);

57 
AddT¿n¦©iÚM­EÁry
(
INTERNAL
, "INTERNAL", INTERNAL);

58 
AddT¿n¦©iÚM­EÁry
(
UNAVAILABLE
, "UNAVAILABLE", UNAVAILABLE);

59 
AddT¿n¦©iÚM­EÁry
(
DATA_LOSS
, "DATA_LOSS", DATA_LOSS);

60 
AddT¿n¦©iÚM­EÁry
(
UNAUTHENTICATED
, "UNAUTHENTICATED", UNAUTHENTICATED);

	@util/error_space.cc

19 
	~"asylo/ut/”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
	gE¼ÜS·û
::
Fšd
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
) {

25 autØ
™”
 = 
”rÜ_š‹º®
::
AsyloE¼ÜS·ûSticM­
::
G‘V®ue
(
Çme
);

26  (
	g™”
 =ğ
”rÜ_š‹º®
::
AsyloE¼ÜS·ûSticM­
::
v®ue_’d
())

27 ? 
nuÎ±r


28 : &*
™”
;

31 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(

32 
E¼ÜS·ûAdlTag
<::
asylo
::
”rÜ
::
GoogËE¼Ü
> 
g
) {

33  
GoogËE¼ÜS·û
::
G‘In¡ªû
();

36 
	gGoogËE¼ÜS·û
::
GoogËE¼ÜS·û
()

37 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
GoogËE¼ÜS·û
>(

38 
kCªÚiÿlE¼ÜS·ûName
) {

39 
AddT¿n¦©iÚM­EÁry
(
OK
, "OK", OK);

40 
AddT¿n¦©iÚM­EÁry
(
CANCELLED
, "CANCELLED", CANCELLED);

41 
AddT¿n¦©iÚM­EÁry
(
UNKNOWN
, "UNKNOWN", UNKNOWN);

42 
AddT¿n¦©iÚM­EÁry
(
INVALID_ARGUMENT
, "INVALID_ARGUMENT",

43 
INVALID_ARGUMENT
);

44 
AddT¿n¦©iÚM­EÁry
(
DEADLINE_EXCEEDED
, "DEADLINE_EXCEEDED",

45 
DEADLINE_EXCEEDED
);

46 
AddT¿n¦©iÚM­EÁry
(
NOT_FOUND
, "NOT_FOUND", NOT_FOUND);

47 
AddT¿n¦©iÚM­EÁry
(
ALREADY_EXISTS
, "ALREADY_EXISTS", ALREADY_EXISTS);

48 
AddT¿n¦©iÚM­EÁry
(
PERMISSION_DENIED
, "PERMISSION_DENIED",

49 
PERMISSION_DENIED
);

50 
AddT¿n¦©iÚM­EÁry
(
RESOURCE_EXHAUSTED
, "RESOURCE_EXHAUSTED",

51 
RESOURCE_EXHAUSTED
);

52 
AddT¿n¦©iÚM­EÁry
(
FAILED_PRECONDITION
, "FAILED_PRECONDITION",

53 
FAILED_PRECONDITION
);

54 
AddT¿n¦©iÚM­EÁry
(
ABORTED
, "ABORTED", ABORTED);

55 
AddT¿n¦©iÚM­EÁry
(
OUT_OF_RANGE
, "OUT_OF_RANGE", OUT_OF_RANGE);

56 
AddT¿n¦©iÚM­EÁry
(
UNIMPLEMENTED
, "UNIMPLEMENTED", UNIMPLEMENTED);

57 
AddT¿n¦©iÚM­EÁry
(
INTERNAL
, "INTERNAL", INTERNAL);

58 
AddT¿n¦©iÚM­EÁry
(
UNAVAILABLE
, "UNAVAILABLE", UNAVAILABLE);

59 
AddT¿n¦©iÚM­EÁry
(
DATA_LOSS
, "DATA_LOSS", DATA_LOSS);

60 
AddT¿n¦©iÚM­EÁry
(
UNAUTHENTICATED
, "UNAUTHENTICATED", UNAUTHENTICATED);

	@util/error_space.h

19 #iâdeà
ASYLO_UTIL_ERROR_SPACE_H_


20 
	#ASYLO_UTIL_ERROR_SPACE_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/cÚš”/æ©_hash_m­.h
"

25 
	~"asylo/¶©fÜm/commÚ/¡©ic_m­.h
"

26 
	~"asylo/ut/”rÜ_codes.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
Çme¥aû
 
	g”rÜ
 {

37 
cÚ¡ex´
 
	gkCªÚiÿlE¼ÜS·ûName
[] =

42 
şass
 
	gE¼ÜS·û
;

47 
	g‹m¶©e
 <
ty³Çme
 
	gEnumT
>

48 
	sE¼ÜS·ûAdlTag
 {

50 
¡©ic_as£¹
(
¡d
::
is_’um
<
EnumT
>::
v®ue
,

61 
	g‹m¶©e
 <
ty³Çme
 
	gEnumT
>

62 
	s”rÜ_’um_Œa™s
 {

63 
	g´iv©e
:

79 
‹m¶©e
 <
ty³Çme
 
EnumU
>

80 autØ
Te¡E¼ÜS·ûBšdšg
(
E¼ÜS·û
 cÚ¡ *
¥aû
)

81 -> 
deşty³
(
¥aû
 = 
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
EnumU
>()),

82 
¡d
::
Œue_ty³
());

85 
	g‹m¶©e
 <
ty³Çme
 
	gEnumU
>

86 autØ
Te¡E¼ÜS·ûBšdšg
(...è-> 
	g¡d
::
çl£_ty³
;

90 
	g‹m¶©e
 <
ty³Çme
 
	gTag
>

91 
E¼ÜS·û
 cÚ¡ *
g‘_”rÜ_¥aû
(
Tag
 
g
, 
¡d
::
Œue_ty³
 
t
) {

92  
G‘E¼ÜS·û
(
g
);

101 
	g‹m¶©e
 <
ty³Çme
 
	gTag
,y³Çm
	gTruthTy³
>

102 
E¼ÜS·û
 cÚ¡ *
g‘_”rÜ_¥aû
(
Tag
 
g
, 
TruthTy³
 
Œuth_ty³
) {

103 
¡©ic_as£¹
(
TruthTy³
::
v®ue
,

107  
	gnuÎ±r
;

110 
	gpublic
:

111 
usšg
 
”rÜ_¥aû_bšdšg_ty³
 = 
deşty³
(
Te¡E¼ÜS·ûBšdšg
<
EnumT
>(0));

113 
E¼ÜS·û
 cÚ¡ *
g‘_”rÜ_¥aû
() {

114  
g‘_”rÜ_¥aû
(
E¼ÜS·ûAdlTag
<
EnumT
>(),

115 
”rÜ_¥aû_bšdšg_ty³
());

201 şas 
	cE¼ÜS·û
 {

202 
	gpublic
:

203 
E¼ÜS·û
() = ;

204 
E¼ÜS·û
(cÚ¡ E¼ÜS·û &
Ùh”
èğ
d–‘e
;

205 
	gvœtu®
 ~
E¼ÜS·û
() = ;

206 
	gE¼ÜS·û
 &
	gİ”©Ü
=(cÚ¡ 
E¼ÜS·û
 &
Ùh”
èğ
d–‘e
;

210 
vœtu®
 
	g¡d
::
¡ršg
 
S·ûName
() const = 0;

215 
vœtu®
 
	g¡d
::
¡ršg
 
SŒšg
(
code
) const = 0;

220 
vœtu®
 
GoogËE¼Ü
 
GoogËE¼ÜCode
(
code
) const = 0;

227 
E¼ÜS·û
 cÚ¡ *
Fšd
(cÚ¡ 
¡d
::
¡ršg
 &
Çme
);

231 
Çme¥aû
 
	g”rÜ_š‹º®
 {

235 
	sE¼ÜS·ûNam”
 {

236 
	g¡d
::
¡ršg
 
İ”©Ü
()(cÚ¡ 
E¼ÜS·û
 &
¥aû
è{  s·û.
S·ûName
(); }

241 
şass
 
	gAsyloE¼ÜS·ûSticM­


242 : 
public
 ::
asylo
::
SticM­
<
AsyloE¼ÜS·ûSticM­
, cÚ¡ 
	gE¼ÜS·û
,

243 
	gE¼ÜS·ûNam”
> {};

254 
	g‹m¶©e
 <
ty³Çme
 
	gE¼ÜS·ûT
>

255 şas 
	cE¼ÜS·ûIm¶em’tiÚH–³r
 : 
public
 
E¼ÜS·û
 {

256 
´Ùeùed
:

264 
E¼ÜS·ûIm¶em’tiÚH–³r
(

265 cÚ¡ 
¡d
::
¡ršg
 &
¥aû_Çme
,

266 cÚ¡ 
¡d
::
¡ršg
 &
deçuÉ_”rÜ_¡ršg
 = "Unrecognized Code")

267 : 
¥aû_Çme_
{
¥aû_Çme
}, 
	gdeçuÉ_”rÜ_¡ršg_
{
	gdeçuÉ_”rÜ_¡ršg
} {

270 
DoNÙO±imize
(&
š£¹”_
);

278 
AddT¿n¦©iÚM­EÁry
(
code
, cÚ¡ 
¡d
::
¡ršg
 &
”rÜ_¡ršg
,

279 
GoogËE¼Ü
 
googË_”rÜ_code
) {

280 
CHECK
(
code_Œª¦©iÚ_m­_


281 .
em¶aû
(
code
, 
¡d
::
·œ
<¡d::
¡ršg
, 
GoogËE¼Ü
>(

282 
”rÜ_¡ršg
, 
googË_”rÜ_code
))

283 .
£cÚd
)

284 << "Du¶iÿ‹ m­ key: " << 
	gcode
;

287 
	g¡d
::
¡ršg
 
S·ûName
(ècÚ¡ 
ov”ride
 {  
¥aû_Çme_
; }

289 
	g¡d
::
¡ršg
 
SŒšg
(
code
ècÚ¡ 
ov”ride
 {

290 cÚ¡‡utØ&
™
 = 
code_Œª¦©iÚ_m­_
.
fšd
(
code
);

291 ià(
	g™
 =ğ
code_Œª¦©iÚ_m­_
.
ûnd
()) {

292 ià(
code
 == 0) {

295  
	gdeçuÉ_”rÜ_¡ršg_
;

297  
	g™
->
	g£cÚd
.
	gfœ¡
;

300 
GoogËE¼Ü
 
GoogËE¼ÜCode
(
code
ècÚ¡ 
	gov”ride
 {

301 ià(
	gcode
 == 0) {

303  
GoogËE¼Ü
::
OK
;

305 cÚ¡‡utØ&
	g™
 = 
code_Œª¦©iÚ_m­_
.
fšd
(
code
);

306 ià(
	g™
 =ğ
code_Œª¦©iÚ_m­_
.
ûnd
()) {

307  
GoogËE¼Ü
::
UNKNOWN
;

309  
	g™
->
	g£cÚd
.second;

312 
	g´iv©e
:

313 
usšg
 
In£¹”Ty³
 = 
”rÜ_š‹º®
::
AsyloE¼ÜS·ûSticM­
::
V®ueIn£¹”
;

314 
In£¹”Ty³
 *
DoNÙO±imize
(In£¹”Ty³ *
š£¹”
è{  
	gš£¹”
; }

315 
In£¹”Ty³
 
	gš£¹”_
;

316 
	gab¦
::
æ©_hash_m­
<, 
	g¡d
::
·œ
<
¡d
::
¡ršg
, 
	gGoogËE¼Ü
>>

317 
	gcode_Œª¦©iÚ_m­_
;

318 cÚ¡ 
	g¡d
::
¡ršg
 
¥aû_Çme_
;

319 cÚ¡ 
	g¡d
::
¡ršg
 
deçuÉ_”rÜ_¡ršg_
;

325 
	g‹m¶©e
 <
ty³Çme
 
	gE¼ÜS·ûT
>

326 
	g”rÜ_š‹º®
::
AsyloE¼ÜS·ûSticM­
::
V®ueIn£¹”


327 
E¼ÜS·ûIm¶em’tiÚH–³r
<
E¼ÜS·ûT
>::
š£¹”_
(

328 
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
ty³Çme
 
E¼ÜS·ûT
::
code_ty³
>()));

332 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(

333 
E¼ÜS·ûAdlTag
<::
asylo
::
”rÜ
::
GoogËE¼Ü
> 
g
);

337 
şass
 
	gGoogËE¼ÜS·û


338 : 
public
 
E¼ÜS·ûIm¶em’tiÚH–³r
<
GoogËE¼ÜS·û
> {

339 
public
:

340 
usšg
 
code_ty³
 = 
GoogËE¼Ü
;

342 
GoogËE¼ÜS·û
(cÚ¡ GoogËE¼ÜS·û &
Ùh”
èğ
d–‘e
;

343 
	gvœtu®
 ~
GoogËE¼ÜS·û
() = ;

344 
	gGoogËE¼ÜS·û
 &
	gİ”©Ü
=(cÚ¡ 
GoogËE¼ÜS·û
 &
Ùh”
èğ
d–‘e
;

348 
E¼ÜS·û
 cÚ¡ *
G‘In¡ªû
() {

349 
E¼ÜS·û
 cÚ¡ *
	gš¡ªû
 = 
Ãw
 
GoogËE¼ÜS·û
();

350  
	gš¡ªû
;

353 
	g´iv©e
:

354 
GoogËE¼ÜS·û
();

	@util/error_space_test.cc

19 
	~"asylo/ut/”rÜ_¥aû.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g”rÜ
 {

26 
	gÇme¥aû
 {

29 şas 
	cE¼ÜS·ûTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

33 
TEST_F
(
E¼ÜS·ûTe¡
, 
GoogËE¼ÜS·ûSšgËtÚ
) {

34 
E¼ÜS·û
 cÚ¡ *
	g¥aû1
 = E¼ÜS·û::
Fšd
(
kCªÚiÿlE¼ÜS·ûName
);

35 
EXPECT_NE
(
¥aû1
, 
nuÎ±r
);

36 
E¼ÜS·û
 cÚ¡ *
	g¥aû2
 = 
”rÜ_’um_Œa™s
<
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
();

37 
EXPECT_NE
(
¥aû2
, 
nuÎ±r
);

38 
EXPECT_EQ
(
¥aû1
, 
¥aû2
);

42 
TEST_F
(
E¼ÜS·ûTe¡
, 
GoogËE¼ÜS·ûIÁ”çû
) {

43 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
();

44 
EXPECT_EQ
(
¥aû
->
S·ûName
(), 
kCªÚiÿlE¼ÜS·ûName
);

46 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
OK
), "OK");

47 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
CANCELLED
), "CANCELLED");

48 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNKNOWN
), "UNKNOWN");

49 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
INVALID_ARGUMENT
), "INVALID_ARGUMENT");

50 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
DEADLINE_EXCEEDED
), "DEADLINE_EXCEEDED");

51 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
NOT_FOUND
), "NOT_FOUND");

52 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
ALREADY_EXISTS
), "ALREADY_EXISTS");

53 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
PERMISSION_DENIED
), "PERMISSION_DENIED");

54 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
),

56 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
FAILED_PRECONDITION
),

58 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
ABORTED
), "ABORTED");

59 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
OUT_OF_RANGE
), "OUT_OF_RANGE");

60 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNIMPLEMENTED
), "UNIMPLEMENTED");

61 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
INTERNAL
), "INTERNAL");

62 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNAVAILABLE
), "UNAVAILABLE");

63 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
DATA_LOSS
), "DATA_LOSS");

64 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNAUTHENTICATED
), "UNAUTHENTICATED");

65 
EXPECT_EQ
(
¥aû
->
SŒšg
(100), "Unrecognized Code");

67 
	gi
 = 0; i <ğ
GoogËE¼Ü
::
UNAUTHENTICATED
; i++) {

68 
EXPECT_EQ
(
¥aû
->
GoogËE¼ÜCode
(
i
), i);

	@util/error_space_test.cc

19 
	~"asylo/ut/”rÜ_¥aû.h
"

21 
	~<gmock/gmock.h
>

22 
	~<g‹¡/g‹¡.h
>

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g”rÜ
 {

26 
	gÇme¥aû
 {

29 şas 
	cE¼ÜS·ûTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

33 
TEST_F
(
E¼ÜS·ûTe¡
, 
GoogËE¼ÜS·ûSšgËtÚ
) {

34 
E¼ÜS·û
 cÚ¡ *
	g¥aû1
 = E¼ÜS·û::
Fšd
(
kCªÚiÿlE¼ÜS·ûName
);

35 
EXPECT_NE
(
¥aû1
, 
nuÎ±r
);

36 
E¼ÜS·û
 cÚ¡ *
	g¥aû2
 = 
”rÜ_’um_Œa™s
<
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
();

37 
EXPECT_NE
(
¥aû2
, 
nuÎ±r
);

38 
EXPECT_EQ
(
¥aû1
, 
¥aû2
);

42 
TEST_F
(
E¼ÜS·ûTe¡
, 
GoogËE¼ÜS·ûIÁ”çû
) {

43 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
();

44 
EXPECT_EQ
(
¥aû
->
S·ûName
(), 
kCªÚiÿlE¼ÜS·ûName
);

46 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
OK
), "OK");

47 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
CANCELLED
), "CANCELLED");

48 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNKNOWN
), "UNKNOWN");

49 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
INVALID_ARGUMENT
), "INVALID_ARGUMENT");

50 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
DEADLINE_EXCEEDED
), "DEADLINE_EXCEEDED");

51 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
NOT_FOUND
), "NOT_FOUND");

52 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
ALREADY_EXISTS
), "ALREADY_EXISTS");

53 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
PERMISSION_DENIED
), "PERMISSION_DENIED");

54 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
),

56 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
FAILED_PRECONDITION
),

58 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
ABORTED
), "ABORTED");

59 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
OUT_OF_RANGE
), "OUT_OF_RANGE");

60 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNIMPLEMENTED
), "UNIMPLEMENTED");

61 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
INTERNAL
), "INTERNAL");

62 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNAVAILABLE
), "UNAVAILABLE");

63 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
DATA_LOSS
), "DATA_LOSS");

64 
EXPECT_EQ
(
¥aû
->
SŒšg
(
GoogËE¼Ü
::
UNAUTHENTICATED
), "UNAUTHENTICATED");

65 
EXPECT_EQ
(
¥aû
->
SŒšg
(100), "Unrecognized Code");

67 
	gi
 = 0; i <ğ
GoogËE¼Ü
::
UNAUTHENTICATED
; i++) {

68 
EXPECT_EQ
(
¥aû
->
GoogËE¼ÜCode
(
i
), i);

	@util/fd_utils.cc

20 #iâdeà
_GNU_SOURCE


21 
	#_GNU_SOURCE


	)

25 #iâdeà
_XOPEN_SOURCE


26 
	#_XOPEN_SOURCE


	)

29 
	~"asylo/ut/fd_uts.h
"

31 
	~<fú.h
>

32 
	~<pŞl.h
>

33 
	~<uni¡d.h
>

34 
	~<c¡ddef
>

35 
	~<s¡»am
>

37 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

38 
	~"ab¦/time/time.h
"

39 
	~"asylo/ut/loggšg.h
"

40 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

41 
	~"asylo/ut/¡©us_maüos.h
"

43 
Çme¥aû
 
	gasylo
 {

44 
	gÇme¥aû
 {

49 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dIÁ”Çl
(
fd
, 
boŞ
 
»tuº_Ú_—gaš
) {

50 
cÚ¡ex´
 
size_t
 
	gkR—dBufSize
 = 256;

52 
	g¡d
::
¡ršg¡»am
 
fd_cÚ‹Ás
;

53 
	g»ad_buf
[
kR—dBufSize
];

54 
ssize_t
 
	g»ad_»suÉ
;

56 
	g»ad_»suÉ
 = 
»ad
(
fd
, 
»ad_buf
, 
kR—dBufSize
);

57 ià(
	g»ad_»suÉ
 == -1) {

58 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

59 ià(
»tuº_Ú_—gaš
) {

62 
ASYLO_RETURN_IF_ERROR
(

63 
Wa™FÜEv’ts
(
fd
, 
POLLIN
 | 
POLLHUP
 | 
POLLRDHUP
, 0).
¡©us
());

68  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

69 
ab¦
::
SŒC©
("FaedØ»ad from fd ", 
fd
));

71 
	gfd_cÚ‹Ás
.
wr™e
(
»ad_buf
, 
»ad_»suÉ
);

72 } 
	g»ad_»suÉ
 != 0);

74  
	gfd_cÚ‹Ás
.
¡r
();

83 
	gStusOr
<
	gsize_t
> 
Wr™eIÁ”Çl
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
,

84 
boŞ
 
»tuº_Ú_—gaš
) {

85 
size_t
 
	gby‹s_wr™‹n
 = 0;

86 
ssize_t
 
	gwr™e_»suÉ
;

88 
	gwr™e_»suÉ
 = 
wr™e
(
fd
, &
d©a
[
by‹s_wr™‹n
], d©a.
size
() - bytes_written);

89 ià(
	gwr™e_»suÉ
 == -1) {

90 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

91 ià(
»tuº_Ú_—gaš
) {

94 
ASYLO_RETURN_IF_ERROR
(
Wa™FÜEv’ts
(
fd
, 
POLLIN
, 0).
¡©us
());

99  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

100 
ab¦
::
SŒC©
("FaedØwr™tØfd ", 
fd
));

103 
	gby‹s_wr™‹n
 +ğ
wr™e_»suÉ
;

104 } 
	gwr™e_»suÉ
 != 0);

106  
	gby‹s_wr™‹n
;

111 
	gPe
::
Pe
()

112 : 
»ad_fd_
(-1), 
wr™e_fd_
(-1), 
»ad_şo£d_
(
Œue
), 
wr™e_şo£d_
(true) {}

114 
	gPe
::
Pe
(P&&
Ùh”
)

115 : 
»ad_fd_
(
Ùh”
.read_fd_),

116 
wr™e_fd_
(
Ùh”
.write_fd_),

117 
»ad_şo£d_
(
Ùh”
.»ad_şo£d_.
exchªge
(
Œue
)),

118 
wr™e_şo£d_
(
Ùh”
.wr™e_şo£d_.
exchªge
(
Œue
)) {}

120 
	gPe
 &Pe::
İ”©Ü
=(
Pe
 &&
Ùh”
) {

121 
Clo£R—dFd
();

122 
Clo£Wr™eFd
();

124 
	g»ad_fd_
 = 
Ùh”
.
»ad_fd_
;

125 
	gwr™e_fd_
 = 
Ùh”
.
wr™e_fd_
;

126 
	g»ad_şo£d_
.
¡Üe
(
Ùh”
.
»ad_şo£d_
.
exchªge
(
Œue
));

127 
	gwr™e_şo£d_
.
¡Üe
(
Ùh”
.
wr™e_şo£d_
.
exchªge
(
Œue
));

129  *
	gthis
;

132 
	gPe
::~
Pe
() {

133 
Stus
 
¡©us
 = 
Clo£R—dFd
();

134 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< 
	g¡©us
;

136 
	g¡©us
 = 
Clo£Wr™eFd
();

137 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< 
	g¡©us
;

140 
	gStusOr
<
	gPe
> Pe::
C»©ePe
(
æags
) {

141 
pe_fds
[2];

143 ià(
pe2
(
pe_fds
, 
æags
) == -1) {

144  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

148  
Pe
(
pe_fds
[0],…ipe_fds[1]);

151 
Stus
 
	gPe
::
Clo£R—dFd
() {

152 ià(!
»ad_şo£d_
.
exchªge
(
Œue
è&& 
şo£
(
»ad_fd_
) == -1) {

153  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

154 
ab¦
::
SŒC©
("FaedØşo£…»ad fd ", 
»ad_fd_
));

157  
	gStus
::
OkStus
();

160 
Stus
 
	gPe
::
Clo£Wr™eFd
() {

161 ià(!
wr™e_şo£d_
.
exchªge
(
Œue
è&& 
şo£
(
wr™e_fd_
) == -1) {

162  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

163 
ab¦
::
SŒC©
("FaedØşo£…wr™fd ", 
wr™e_fd_
));

166  
	gStus
::
OkStus
();

169 
	gPe
::
Pe
(
»ad_fd
, 
wr™e_fd
)

170 : 
»ad_fd_
(
»ad_fd
),

171 
wr™e_fd_
(
wr™e_fd
),

172 
»ad_şo£d_
(
çl£
),

173 
wr™e_şo£d_
(
çl£
) {}

175 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dAÎ
(
fd
è{  
R—dIÁ”Çl
(fd, 
çl£
); }

177 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dAÎNoBlock
(
fd
) {

178 
æags
;

179 
ASYLO_ASSIGN_OR_RETURN
(
æags
, 
G‘FdFÏgs
(
fd
));

180 ià(!(
	gæags
 & 
	gO_NONBLOCK
)) {

181  
Stus
(

182 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

183 
ab¦
::
SŒC©
("CªnÙ„—d from fd ", 
fd
, " without blocking because ",

184 
fd
, " is‡ blocking file descriptor"));

186  
R—dIÁ”Çl
(
fd
, 
Œue
);

189 
Stus
 
Wr™eAÎ
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
) {

190  
Wr™eIÁ”Çl
(
fd
, 
d©a
, 
çl£
).
¡©us
();

193 
	gStusOr
<
	gsize_t
> 
Wr™eAÎNoBlock
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
) {

194 
æags
;

195 
ASYLO_ASSIGN_OR_RETURN
(
æags
, 
G‘FdFÏgs
(
fd
));

196 ià(~
	gæags
 & 
	gO_NONBLOCK
) {

197  
Stus
(

198 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

199 
ab¦
::
SŒC©
("CªnÙ wr™tØfd ", 
fd
, " without blocking because ",

200 
fd
, " is‡ blocking file descriptor"));

202  
Wr™eIÁ”Çl
(
fd
, 
d©a
, 
Œue
);

205 
	gStusOr
<> 
G‘FdFÏgs
(
fd
) {

206 
	gæags
 = 
fú
(
fd
, 
F_GETFL
, 0);

207 ià(
	gæags
 == -1) {

208  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

209 
ab¦
::
SŒC©
("FaedØ»ad f¡©u æag Ú fd ", 
fd
));

211  
	gæags
;

214 
Stus
 
S‘FdFÏgs
(
fd
, 
æags
) {

215 ià(
fú
(
fd
, 
F_SETFL
, 
æags
) == -1) {

216  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

217 
ab¦
::
SŒC©
("FaedØ£ˆf¡©u æag Ú fd ", 
fd
));

219  
	gStus
::
OkStus
();

222 
Stus
 
AddFdFÏgs
(
fd
, 
æags
) {

223 
	gcu¼’t_æags
;

224 
ASYLO_ASSIGN_OR_RETURN
(
cu¼’t_æags
, 
G‘FdFÏgs
(
fd
));

225  
S‘FdFÏgs
(
fd
, 
cu¼’t_æags
 | 
æags
);

228 
Stus
 
RemoveFdFÏgs
(
fd
, 
æags
) {

229 
	gcu¼’t_æags
;

230 
ASYLO_ASSIGN_OR_RETURN
(
cu¼’t_æags
, 
G‘FdFÏgs
(
fd
));

231  
S‘FdFÏgs
(
fd
, 
cu¼’t_æags
 & ~
æags
);

234 
	gStusOr
<> 
Wa™FÜEv’ts
(
fd
, 
rg‘_ev’ts
, 
ok_ev’ts
) {

235 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kPŞlTimeout
 = 
ab¦
::
SecÚds
(1);

237 
	gok_ev’ts
 &ğ~
rg‘_ev’ts
;

238 
pŞlfd
 
	gwa™_fÜ_ev’ts
 = {

239 .
fd
 = fd, .
	gev’ts
 = 
rg‘_ev’ts
, .
	g»v’ts
 = 0};

241 
	gpŞl_»suÉ
;

243 
	gpŞl_»suÉ
 =

244 
pŞl
(&
wa™_fÜ_ev’ts
, 1, 
kPŞlTimeout
 / 
ab¦
::
Mli£cÚds
(1));

246 ià(
	gpŞl_»suÉ
 == -1) {

247  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

248 
ab¦
::
SŒC©
("FaedØpŞÈfd ", 
fd
));

250 ià(
	gpŞl_»suÉ
 == 1 &&

251 (
wa™_fÜ_ev’ts
.
»v’ts
 & ~(
rg‘_ev’ts
 | 
ok_ev’ts
))) {

252  
Stus
(

253 
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
,

254 
ab¦
::
SŒC©
(

256 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLIN
 ? " POLLIN" : ""),

257 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLPRI
 ? " POLLPRI" : ""),

258 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLOUT
 ? " POLLOUT" : ""),

259 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLRDHUP
 ? " POLLRDHUP" : ""),

260 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLERR
 ? " POLLERR" : ""),

261 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLHUP
 ? " POLLHUP" : ""),

262 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLNVAL
 ? " POLLNVAL" : ""),

263 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLRDNORM
 ? " POLLRDNORM" : ""),

264 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLRDBAND
 ? " POLLRDBAND" : ""),

265 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLWRNORM
 ? " POLLWRNORM" : ""),

266 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLWRBAND
 ? " POLLWRBAND" : "")));

268 } 
	gpŞl_»suÉ
 == 0 ||

269 ((
wa™_fÜ_ev’ts
.
»v’ts
 | 
ok_ev’ts
) == ok_events));

271  
	gwa™_fÜ_ev’ts
.
	g»v’ts
;

	@util/fd_utils.cc

20 #iâdeà
_GNU_SOURCE


21 
	#_GNU_SOURCE


	)

25 #iâdeà
_XOPEN_SOURCE


26 
	#_XOPEN_SOURCE


	)

29 
	~"asylo/ut/fd_uts.h
"

31 
	~<fú.h
>

32 
	~<pŞl.h
>

33 
	~<uni¡d.h
>

34 
	~<c¡ddef
>

35 
	~<s¡»am
>

37 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

38 
	~"ab¦/time/time.h
"

39 
	~"asylo/ut/loggšg.h
"

40 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

41 
	~"asylo/ut/¡©us_maüos.h
"

43 
Çme¥aû
 
	gasylo
 {

44 
	gÇme¥aû
 {

49 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dIÁ”Çl
(
fd
, 
boŞ
 
»tuº_Ú_—gaš
) {

50 
cÚ¡ex´
 
size_t
 
	gkR—dBufSize
 = 256;

52 
	g¡d
::
¡ršg¡»am
 
fd_cÚ‹Ás
;

53 
	g»ad_buf
[
kR—dBufSize
];

54 
ssize_t
 
	g»ad_»suÉ
;

56 
	g»ad_»suÉ
 = 
»ad
(
fd
, 
»ad_buf
, 
kR—dBufSize
);

57 ià(
	g»ad_»suÉ
 == -1) {

58 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

59 ià(
»tuº_Ú_—gaš
) {

62 
ASYLO_RETURN_IF_ERROR
(

63 
Wa™FÜEv’ts
(
fd
, 
POLLIN
 | 
POLLHUP
 | 
POLLRDHUP
, 0).
¡©us
());

68  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

69 
ab¦
::
SŒC©
("FaedØ»ad from fd ", 
fd
));

71 
	gfd_cÚ‹Ás
.
wr™e
(
»ad_buf
, 
»ad_»suÉ
);

72 } 
	g»ad_»suÉ
 != 0);

74  
	gfd_cÚ‹Ás
.
¡r
();

83 
	gStusOr
<
	gsize_t
> 
Wr™eIÁ”Çl
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
,

84 
boŞ
 
»tuº_Ú_—gaš
) {

85 
size_t
 
	gby‹s_wr™‹n
 = 0;

86 
ssize_t
 
	gwr™e_»suÉ
;

88 
	gwr™e_»suÉ
 = 
wr™e
(
fd
, &
d©a
[
by‹s_wr™‹n
], d©a.
size
() - bytes_written);

89 ià(
	gwr™e_»suÉ
 == -1) {

90 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EWOULDBLOCK
) {

91 ià(
»tuº_Ú_—gaš
) {

94 
ASYLO_RETURN_IF_ERROR
(
Wa™FÜEv’ts
(
fd
, 
POLLIN
, 0).
¡©us
());

99  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

100 
ab¦
::
SŒC©
("FaedØwr™tØfd ", 
fd
));

103 
	gby‹s_wr™‹n
 +ğ
wr™e_»suÉ
;

104 } 
	gwr™e_»suÉ
 != 0);

106  
	gby‹s_wr™‹n
;

111 
	gPe
::
Pe
()

112 : 
»ad_fd_
(-1), 
wr™e_fd_
(-1), 
»ad_şo£d_
(
Œue
), 
wr™e_şo£d_
(true) {}

114 
	gPe
::
Pe
(P&&
Ùh”
)

115 : 
»ad_fd_
(
Ùh”
.read_fd_),

116 
wr™e_fd_
(
Ùh”
.write_fd_),

117 
»ad_şo£d_
(
Ùh”
.»ad_şo£d_.
exchªge
(
Œue
)),

118 
wr™e_şo£d_
(
Ùh”
.wr™e_şo£d_.
exchªge
(
Œue
)) {}

120 
	gPe
 &Pe::
İ”©Ü
=(
Pe
 &&
Ùh”
) {

121 
Clo£R—dFd
();

122 
Clo£Wr™eFd
();

124 
	g»ad_fd_
 = 
Ùh”
.
»ad_fd_
;

125 
	gwr™e_fd_
 = 
Ùh”
.
wr™e_fd_
;

126 
	g»ad_şo£d_
.
¡Üe
(
Ùh”
.
»ad_şo£d_
.
exchªge
(
Œue
));

127 
	gwr™e_şo£d_
.
¡Üe
(
Ùh”
.
wr™e_şo£d_
.
exchªge
(
Œue
));

129  *
	gthis
;

132 
	gPe
::~
Pe
() {

133 
Stus
 
¡©us
 = 
Clo£R—dFd
();

134 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< 
	g¡©us
;

136 
	g¡©us
 = 
Clo£Wr™eFd
();

137 
LOG_IF
(
ERROR
, !
¡©us
.
ok
()è<< 
	g¡©us
;

140 
	gStusOr
<
	gPe
> Pe::
C»©ePe
(
æags
) {

141 
pe_fds
[2];

143 ià(
pe2
(
pe_fds
, 
æags
) == -1) {

144  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

148  
Pe
(
pe_fds
[0],…ipe_fds[1]);

151 
Stus
 
	gPe
::
Clo£R—dFd
() {

152 ià(!
»ad_şo£d_
.
exchªge
(
Œue
è&& 
şo£
(
»ad_fd_
) == -1) {

153  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

154 
ab¦
::
SŒC©
("FaedØşo£…»ad fd ", 
»ad_fd_
));

157  
	gStus
::
OkStus
();

160 
Stus
 
	gPe
::
Clo£Wr™eFd
() {

161 ià(!
wr™e_şo£d_
.
exchªge
(
Œue
è&& 
şo£
(
wr™e_fd_
) == -1) {

162  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

163 
ab¦
::
SŒC©
("FaedØşo£…wr™fd ", 
wr™e_fd_
));

166  
	gStus
::
OkStus
();

169 
	gPe
::
Pe
(
»ad_fd
, 
wr™e_fd
)

170 : 
»ad_fd_
(
»ad_fd
),

171 
wr™e_fd_
(
wr™e_fd
),

172 
»ad_şo£d_
(
çl£
),

173 
wr™e_şo£d_
(
çl£
) {}

175 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dAÎ
(
fd
è{  
R—dIÁ”Çl
(fd, 
çl£
); }

177 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dAÎNoBlock
(
fd
) {

178 
æags
;

179 
ASYLO_ASSIGN_OR_RETURN
(
æags
, 
G‘FdFÏgs
(
fd
));

180 ià(!(
	gæags
 & 
	gO_NONBLOCK
)) {

181  
Stus
(

182 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

183 
ab¦
::
SŒC©
("CªnÙ„—d from fd ", 
fd
, " without blocking because ",

184 
fd
, " is‡ blocking file descriptor"));

186  
R—dIÁ”Çl
(
fd
, 
Œue
);

189 
Stus
 
Wr™eAÎ
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
) {

190  
Wr™eIÁ”Çl
(
fd
, 
d©a
, 
çl£
).
¡©us
();

193 
	gStusOr
<
	gsize_t
> 
Wr™eAÎNoBlock
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
) {

194 
æags
;

195 
ASYLO_ASSIGN_OR_RETURN
(
æags
, 
G‘FdFÏgs
(
fd
));

196 ià(~
	gæags
 & 
	gO_NONBLOCK
) {

197  
Stus
(

198 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

199 
ab¦
::
SŒC©
("CªnÙ wr™tØfd ", 
fd
, " without blocking because ",

200 
fd
, " is‡ blocking file descriptor"));

202  
Wr™eIÁ”Çl
(
fd
, 
d©a
, 
Œue
);

205 
	gStusOr
<> 
G‘FdFÏgs
(
fd
) {

206 
	gæags
 = 
fú
(
fd
, 
F_GETFL
, 0);

207 ià(
	gæags
 == -1) {

208  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

209 
ab¦
::
SŒC©
("FaedØ»ad f¡©u æag Ú fd ", 
fd
));

211  
	gæags
;

214 
Stus
 
S‘FdFÏgs
(
fd
, 
æags
) {

215 ià(
fú
(
fd
, 
F_SETFL
, 
æags
) == -1) {

216  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

217 
ab¦
::
SŒC©
("FaedØ£ˆf¡©u æag Ú fd ", 
fd
));

219  
	gStus
::
OkStus
();

222 
Stus
 
AddFdFÏgs
(
fd
, 
æags
) {

223 
	gcu¼’t_æags
;

224 
ASYLO_ASSIGN_OR_RETURN
(
cu¼’t_æags
, 
G‘FdFÏgs
(
fd
));

225  
S‘FdFÏgs
(
fd
, 
cu¼’t_æags
 | 
æags
);

228 
Stus
 
RemoveFdFÏgs
(
fd
, 
æags
) {

229 
	gcu¼’t_æags
;

230 
ASYLO_ASSIGN_OR_RETURN
(
cu¼’t_æags
, 
G‘FdFÏgs
(
fd
));

231  
S‘FdFÏgs
(
fd
, 
cu¼’t_æags
 & ~
æags
);

234 
	gStusOr
<> 
Wa™FÜEv’ts
(
fd
, 
rg‘_ev’ts
, 
ok_ev’ts
) {

235 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kPŞlTimeout
 = 
ab¦
::
SecÚds
(1);

237 
	gok_ev’ts
 &ğ~
rg‘_ev’ts
;

238 
pŞlfd
 
	gwa™_fÜ_ev’ts
 = {

239 .
fd
 = fd, .
	gev’ts
 = 
rg‘_ev’ts
, .
	g»v’ts
 = 0};

241 
	gpŞl_»suÉ
;

243 
	gpŞl_»suÉ
 =

244 
pŞl
(&
wa™_fÜ_ev’ts
, 1, 
kPŞlTimeout
 / 
ab¦
::
Mli£cÚds
(1));

246 ià(
	gpŞl_»suÉ
 == -1) {

247  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

248 
ab¦
::
SŒC©
("FaedØpŞÈfd ", 
fd
));

250 ià(
	gpŞl_»suÉ
 == 1 &&

251 (
wa™_fÜ_ev’ts
.
»v’ts
 & ~(
rg‘_ev’ts
 | 
ok_ev’ts
))) {

252  
Stus
(

253 
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
,

254 
ab¦
::
SŒC©
(

256 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLIN
 ? " POLLIN" : ""),

257 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLPRI
 ? " POLLPRI" : ""),

258 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLOUT
 ? " POLLOUT" : ""),

259 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLRDHUP
 ? " POLLRDHUP" : ""),

260 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLERR
 ? " POLLERR" : ""),

261 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLHUP
 ? " POLLHUP" : ""),

262 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLNVAL
 ? " POLLNVAL" : ""),

263 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLRDNORM
 ? " POLLRDNORM" : ""),

264 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLRDBAND
 ? " POLLRDBAND" : ""),

265 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLWRNORM
 ? " POLLWRNORM" : ""),

266 (
wa™_fÜ_ev’ts
.
»v’ts
 & 
POLLWRBAND
 ? " POLLWRBAND" : "")));

268 } 
	gpŞl_»suÉ
 == 0 ||

269 ((
wa™_fÜ_ev’ts
.
»v’ts
 | 
ok_ev’ts
) == ok_events));

271  
	gwa™_fÜ_ev’ts
.
	g»v’ts
;

	@util/fd_utils.h

19 #iâdeà
ASYLO_UTIL_FD_UTILS_H_


20 
	#ASYLO_UTIL_FD_UTILS_H_


	)

22 
	~<¡ršg
>

23 
	~<ut™y
>

25 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©usÜ.h
"

29 
Çme¥aû
 
	gasylo
 {

40 şas 
	cPe
 {

41 
	gpublic
:

44 
Pe
();

46 
Pe
(cÚ¡ P&
Ùh”
èğ
d–‘e
;

47 
	gPe
 &
	gİ”©Ü
=(cÚ¡ 
Pe
 &
Ùh”
èğ
d–‘e
;

49 
Pe
(P&&
Ùh”
);

50 
	gPe
 &
	gİ”©Ü
=(
Pe
 &&
Ùh”
);

52 ~
Pe
();

57 
	gStusOr
<
	gPe
> 
C»©ePe
(
æags
 = 0);

59 
šlše
 
»ad_fd
(ècÚ¡ {  
	g»ad_fd_
; }

60 
šlše
 
wr™e_fd
(ècÚ¡ {  
	gwr™e_fd_
; }

64 
Stus
 
Clo£Wr™eFd
();

68 
Stus
 
Clo£R—dFd
();

70 
	g´iv©e
:

72 
Pe
(
»ad_fd
, 
wr™e_fd
);

74 
	g»ad_fd_
;

75 
	gwr™e_fd_
;

76 
	g¡d
::
©omic
<
boŞ
> 
»ad_şo£d_
;

77 
	g¡d
::
©omic
<
boŞ
> 
wr™e_şo£d_
;

81 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dAÎ
(
fd
);

85 
	gStusOr
<
	g¡d
::
¡ršg
> 
R—dAÎNoBlock
(
fd
);

88 
Stus
 
Wr™eAÎ
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
);

92 
	gStusOr
<
	gsize_t
> 
Wr™eAÎNoBlock
(
fd
, 
ab¦
::
¡ršg_v›w
 
d©a
);

95 
	gStusOr
<> 
G‘FdFÏgs
(
fd
);

99 
Stus
 
S‘FdFÏgs
(
fd
, 
æags
);

104 
Stus
 
AddFdFÏgs
(
fd
, 
æags
);

109 
Stus
 
RemoveFdFÏgs
(
fd
, 
æags
);

120 
	gStusOr
<> 
Wa™FÜEv’ts
(
fd
, 
rg‘_ev’ts
, 
ok_ev’ts
);

	@util/fd_utils_test.cc

19 
	~"asylo/ut/fd_uts.h
"

21 
	~<fú.h
>

22 
	~<pŞl.h
>

23 
	~<uni¡d.h
>

24 
	~<û¼no
>

25 
	~<c¡ršg
>

26 
	~<th»ad
>

27 
	~<ut™y
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

33 
	~"ab¦/synchrÚiz©iÚ/b¬r›r.h
"

34 
	~"ab¦/time/şock.h
"

35 
	~"ab¦/time/time.h
"

36 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 
	gusšg
 ::
‹¡šg
::
NÙ
;

42 
	gusšg
 ::
‹¡šg
::
SŒEq
;

45 
MATCHER_P
(
HasFÏgs
, 
æags
,

46 
ab¦
::
SŒC©
("dÛs", 
Ãg©iÚ
 ? "‚ot" : "", " havehe bits in ",

47 
æags
, " set")) {

48  (
	g¬g
 & 
	gæags
è=ğ
æags
;

53 
TEST
(
FdUtsTe¡
, 
R—dAÎNoBlockWr™eAÎNoBlockBlockšgPe
) {

54 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

56 
Pe
 
	gpe
;

57 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

59 
EXPECT_THAT
(

60 
Wr™eAÎNoBlock
(
pe
.
wr™e_fd
(), 
kD©a
).
¡©us
(),

61 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("CªnÙ wr™tØfd ", 
pe
.
wr™e_fd
(),

63 " w™houˆblockšg beÿu£ ", 
pe
.
wr™e_fd
(),

65 
EXPECT_THAT
(

66 
R—dAÎNoBlock
(
pe
.
»ad_fd
()).
¡©us
(),

67 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

68 
ab¦
::
SŒC©
("CªnÙ„—d from fd ", 
pe
.
»ad_fd
(),

69 " w™houˆblockšg beÿu£ ", 
pe
.
»ad_fd
(),

75 
TEST
(
FdUtsTe¡
, 
R—dAÎNoBlockWr™eAÎNoBlockNÚBlockšgPe
) {

76 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

78 
Pe
 
	gpe
;

79 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

81 autØ
	gwr™e_»suÉ
 = 
Wr™eAÎNoBlock
(
pe
.
wr™e_fd
(), 
kD©a
);

82 
ASYLO_EXPECT_OK
(
wr™e_»suÉ
);

83 
EXPECT_THAT
(
R—dAÎNoBlock
(
pe
.
»ad_fd
()),

84 
IsOkAndHŞds
(
SŒEq
({
kD©a
, 
wr™e_»suÉ
.
V®ueOrD›
()})));

89 
TEST
(
FdUtsTe¡
, 
R—dAÎNoBlockWr™eAÎNoBlockNÚBlockšgPeMuÉ™h»aded
) {

90 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

92 
Pe
 
	gpe
;

93 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

95 
	gab¦
::
B¬r›r
 
b¬r›r
(2);

96 
	g¡d
::
¡ršg
 
»ad_¡ršg
;

97 
	g¡d
::
th»ad
 
»ad_th»ad
([&
b¬r›r
, &
pe
, &
»ad_¡ršg
] {

98 
b¬r›r
.
Block
();

99 autØ
»ad_»suÉ
 = 
R—dAÎNoBlock
(
pe
.
»ad_fd
());

100 
EXPECT_THAT
(
»ad_»suÉ
, 
IsOk
());

101 
»ad_¡ršg
 = 
¡d
::
move
(
»ad_»suÉ
).
V®ueOrD›
();

104 autØ
	gwr™e_»suÉ
 = 
Wr™eAÎNoBlock
(
pe
.
wr™e_fd
(), 
kD©a
);

105 
ASYLO_EXPECT_OK
(
wr™e_»suÉ
);

106 
	gb¬r›r
.
Block
();

108 
	g»ad_th»ad
.
još
();

109 
EXPECT_THAT
(
»ad_¡ršg
, 
SŒEq
({
kD©a
, 
wr™e_»suÉ
.
V®ueOrD›
()}));

114 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎBlockšgPe
) {

115 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

117 
Pe
 
	gpe
;

118 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

120 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

121 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

122 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

127 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎNÚBlockšgPe
) {

128 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

130 
Pe
 
	gpe
;

131 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

133 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

134 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

135 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

140 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎBlockšgPeMuÉ™h»aded
) {

141 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

143 
Pe
 
	gpe
;

144 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

146 
	g¡d
::
th»ad
 
»ad_th»ad
([
kD©a
, &
pe
] {

147 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

149 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

150 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

151 
	g»ad_th»ad
.
još
();

156 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎNÚBlockšgPeMuÉ™h»aded
) {

157 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

159 
Pe
 
	gpe
;

160 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

162 
	g¡d
::
th»ad
 
»ad_th»ad
([
kD©a
, &
pe
] {

163 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

165 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

166 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

167 
	g»ad_th»ad
.
još
();

172 
TEST
(
FdUtsTe¡
, 
G‘FdFÏgsReæeùsS‘FdFÏgsChªges
) {

173 
Pe
 
	gpe
;

174 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

176 
	gæags
;

177 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

178 
EXPECT_THAT
(
æags
, 
NÙ
(
HasFÏgs
(
O_NONBLOCK
)));

180 
ASYLO_EXPECT_OK
(
S‘FdFÏgs
(
pe
.
»ad_fd
(), 
æags
 | 
O_NONBLOCK
));

182 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

183 
EXPECT_THAT
(
æags
, 
HasFÏgs
(
O_NONBLOCK
));

188 
TEST
(
FdUtsTe¡
, 
G‘FdFÏgsReæeùsAddFdFÏgsAndRemoveFdFÏgsChªges
) {

189 
Pe
 
	gpe
;

190 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

192 
	gæags
;

193 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

194 
EXPECT_THAT
(
æags
, 
NÙ
(
HasFÏgs
(
O_NONBLOCK
)));

196 
ASYLO_EXPECT_OK
(
AddFdFÏgs
(
pe
.
»ad_fd
(), 
O_NONBLOCK
));

198 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

199 
EXPECT_THAT
(
æags
, 
HasFÏgs
(
O_NONBLOCK
));

201 
ASYLO_EXPECT_OK
(
RemoveFdFÏgs
(
pe
.
»ad_fd
(), 
O_NONBLOCK
));

203 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

204 
EXPECT_THAT
(
æags
, 
NÙ
(
HasFÏgs
(
O_NONBLOCK
)));

208 
TEST
(
FdUtsTe¡
, 
Wa™FÜEv’tsBlocksUÁEv’tsOccur
) {

209 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kWa™Time
 = 
ab¦
::
Mli£cÚds
(2500);

210 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

212 
Pe
 
	gpe
;

213 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

215 
	g¡d
::
th»ad
 
wr™e_th»ad
([
kWa™Time
, 
kD©a
, &
pe
] {

216 
ab¦
::
SË•FÜ
(
kWa™Time
);

217 
ASYLO_ASSERT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

220 
EXPECT_THAT
(
Wa™FÜEv’ts
(
pe
.
»ad_fd
(), 
POLLIN
, 0),

221 
IsOkAndHŞds
(
HasFÏgs
(
POLLIN
)));

222 
	gwr™e_th»ad
.
još
();

	@util/fd_utils_test.cc

19 
	~"asylo/ut/fd_uts.h
"

21 
	~<fú.h
>

22 
	~<pŞl.h
>

23 
	~<uni¡d.h
>

24 
	~<û¼no
>

25 
	~<c¡ršg
>

26 
	~<th»ad
>

27 
	~<ut™y
>

29 
	~<gmock/gmock.h
>

30 
	~<g‹¡/g‹¡.h
>

31 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

32 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

33 
	~"ab¦/synchrÚiz©iÚ/b¬r›r.h
"

34 
	~"ab¦/time/şock.h
"

35 
	~"ab¦/time/time.h
"

36 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 
	gusšg
 ::
‹¡šg
::
NÙ
;

42 
	gusšg
 ::
‹¡šg
::
SŒEq
;

45 
MATCHER_P
(
HasFÏgs
, 
æags
,

46 
ab¦
::
SŒC©
("dÛs", 
Ãg©iÚ
 ? "‚ot" : "", " havehe bits in ",

47 
æags
, " set")) {

48  (
	g¬g
 & 
	gæags
è=ğ
æags
;

53 
TEST
(
FdUtsTe¡
, 
R—dAÎNoBlockWr™eAÎNoBlockBlockšgPe
) {

54 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

56 
Pe
 
	gpe
;

57 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

59 
EXPECT_THAT
(

60 
Wr™eAÎNoBlock
(
pe
.
wr™e_fd
(), 
kD©a
).
¡©us
(),

61 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

62 
ab¦
::
SŒC©
("CªnÙ wr™tØfd ", 
pe
.
wr™e_fd
(),

63 " w™houˆblockšg beÿu£ ", 
pe
.
wr™e_fd
(),

65 
EXPECT_THAT
(

66 
R—dAÎNoBlock
(
pe
.
»ad_fd
()).
¡©us
(),

67 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

68 
ab¦
::
SŒC©
("CªnÙ„—d from fd ", 
pe
.
»ad_fd
(),

69 " w™houˆblockšg beÿu£ ", 
pe
.
»ad_fd
(),

75 
TEST
(
FdUtsTe¡
, 
R—dAÎNoBlockWr™eAÎNoBlockNÚBlockšgPe
) {

76 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

78 
Pe
 
	gpe
;

79 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

81 autØ
	gwr™e_»suÉ
 = 
Wr™eAÎNoBlock
(
pe
.
wr™e_fd
(), 
kD©a
);

82 
ASYLO_EXPECT_OK
(
wr™e_»suÉ
);

83 
EXPECT_THAT
(
R—dAÎNoBlock
(
pe
.
»ad_fd
()),

84 
IsOkAndHŞds
(
SŒEq
({
kD©a
, 
wr™e_»suÉ
.
V®ueOrD›
()})));

89 
TEST
(
FdUtsTe¡
, 
R—dAÎNoBlockWr™eAÎNoBlockNÚBlockšgPeMuÉ™h»aded
) {

90 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

92 
Pe
 
	gpe
;

93 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

95 
	gab¦
::
B¬r›r
 
b¬r›r
(2);

96 
	g¡d
::
¡ršg
 
»ad_¡ršg
;

97 
	g¡d
::
th»ad
 
»ad_th»ad
([&
b¬r›r
, &
pe
, &
»ad_¡ršg
] {

98 
b¬r›r
.
Block
();

99 autØ
»ad_»suÉ
 = 
R—dAÎNoBlock
(
pe
.
»ad_fd
());

100 
EXPECT_THAT
(
»ad_»suÉ
, 
IsOk
());

101 
»ad_¡ršg
 = 
¡d
::
move
(
»ad_»suÉ
).
V®ueOrD›
();

104 autØ
	gwr™e_»suÉ
 = 
Wr™eAÎNoBlock
(
pe
.
wr™e_fd
(), 
kD©a
);

105 
ASYLO_EXPECT_OK
(
wr™e_»suÉ
);

106 
	gb¬r›r
.
Block
();

108 
	g»ad_th»ad
.
još
();

109 
EXPECT_THAT
(
»ad_¡ršg
, 
SŒEq
({
kD©a
, 
wr™e_»suÉ
.
V®ueOrD›
()}));

114 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎBlockšgPe
) {

115 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

117 
Pe
 
	gpe
;

118 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

120 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

121 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

122 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

127 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎNÚBlockšgPe
) {

128 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

130 
Pe
 
	gpe
;

131 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

133 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

134 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

135 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

140 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎBlockšgPeMuÉ™h»aded
) {

141 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

143 
Pe
 
	gpe
;

144 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

146 
	g¡d
::
th»ad
 
»ad_th»ad
([
kD©a
, &
pe
] {

147 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

149 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

150 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

151 
	g»ad_th»ad
.
još
();

156 
TEST
(
FdUtsTe¡
, 
R—dAÎWr™eAÎNÚBlockšgPeMuÉ™h»aded
) {

157 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

159 
Pe
 
	gpe
;

160 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
(
O_NONBLOCK
));

162 
	g¡d
::
th»ad
 
»ad_th»ad
([
kD©a
, &
pe
] {

163 
EXPECT_THAT
(
R—dAÎ
(
pe
.
»ad_fd
()), 
IsOkAndHŞds
(
kD©a
));

165 
ASYLO_EXPECT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

166 
ASYLO_ASSERT_OK
(
pe
.
Clo£Wr™eFd
());

167 
	g»ad_th»ad
.
još
();

172 
TEST
(
FdUtsTe¡
, 
G‘FdFÏgsReæeùsS‘FdFÏgsChªges
) {

173 
Pe
 
	gpe
;

174 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

176 
	gæags
;

177 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

178 
EXPECT_THAT
(
æags
, 
NÙ
(
HasFÏgs
(
O_NONBLOCK
)));

180 
ASYLO_EXPECT_OK
(
S‘FdFÏgs
(
pe
.
»ad_fd
(), 
æags
 | 
O_NONBLOCK
));

182 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

183 
EXPECT_THAT
(
æags
, 
HasFÏgs
(
O_NONBLOCK
));

188 
TEST
(
FdUtsTe¡
, 
G‘FdFÏgsReæeùsAddFdFÏgsAndRemoveFdFÏgsChªges
) {

189 
Pe
 
	gpe
;

190 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

192 
	gæags
;

193 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

194 
EXPECT_THAT
(
æags
, 
NÙ
(
HasFÏgs
(
O_NONBLOCK
)));

196 
ASYLO_EXPECT_OK
(
AddFdFÏgs
(
pe
.
»ad_fd
(), 
O_NONBLOCK
));

198 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

199 
EXPECT_THAT
(
æags
, 
HasFÏgs
(
O_NONBLOCK
));

201 
ASYLO_EXPECT_OK
(
RemoveFdFÏgs
(
pe
.
»ad_fd
(), 
O_NONBLOCK
));

203 
ASYLO_ASSERT_OK_AND_ASSIGN
(
æags
, 
G‘FdFÏgs
(
pe
.
»ad_fd
()));

204 
EXPECT_THAT
(
æags
, 
NÙ
(
HasFÏgs
(
O_NONBLOCK
)));

208 
TEST
(
FdUtsTe¡
, 
Wa™FÜEv’tsBlocksUÁEv’tsOccur
) {

209 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kWa™Time
 = 
ab¦
::
Mli£cÚds
(2500);

210 
cÚ¡ex´
 
	gkD©a
[] = "The quick brown fox jumps overhe†azy dog!";

212 
Pe
 
	gpe
;

213 
ASYLO_ASSERT_OK_AND_ASSIGN
(
pe
, 
Pe
::
C»©ePe
());

215 
	g¡d
::
th»ad
 
wr™e_th»ad
([
kWa™Time
, 
kD©a
, &
pe
] {

216 
ab¦
::
SË•FÜ
(
kWa™Time
);

217 
ASYLO_ASSERT_OK
(
Wr™eAÎ
(
pe
.
wr™e_fd
(), 
kD©a
));

220 
EXPECT_THAT
(
Wa™FÜEv’ts
(
pe
.
»ad_fd
(), 
POLLIN
, 0),

221 
IsOkAndHŞds
(
HasFÏgs
(
POLLIN
)));

222 
	gwr™e_th»ad
.
još
();

	@util/file_mapping.cc

19 
	~"asylo/ut/fe_m­pšg.h
"

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<sys/mmª.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/ty³s.h
>

26 
	~<uni¡d.h
>

27 
	~<c¡ddef
>

28 
	~<c¡ršg
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/ut/ş—nup.h
"

33 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

34 
	~"asylo/ut/¡©us.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

37 
Çme¥aû
 
	gasylo
 {

39 
	gStusOr
<
	gFeM­pšg
> FeM­pšg::
C»©eFromFe
(
ab¦
::
¡ršg_v›w
 
fe_Çme
) {

44 
¡d
::
¡ršg
 
fe_Çme_¡ršg
(
fe_Çme
.
d©a
(), fe_Çme.
size
());

45 *
	gbufãr_±r
;

46 
size_t
 
	gfe_size
;

49 
	gfd
 = 
İ’
(
fe_Çme_¡ršg
.
d©a
(), 
O_RDONLY
);

50 ià(
	gfd
 == -1) {

51  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

52 
ab¦
::
SŒC©
("FaedØİ’ ", 
fe_Çme
));

56 
Stus
 
	gşo£_¡©us
;

58 
CËªup
 
şo£_fd
([
fd
, 
fe_Çme
, &
şo£_¡©us
]() {

59 ià(
şo£
(
fd
) == -1) {

60 
şo£_¡©us
 = 
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

61 
ab¦
::
SŒC©
("FaedØşo£ ", 
fe_Çme
));

66 
¡©
 
	gfe_¡©
;

67 ià(
f¡©
(
fd
, &
fe_¡©
) == -1) {

68  
Stus
(

69 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

70 
ab¦
::
SŒC©
("FaedØd‘”mšthsizoà", 
fe_Çme
));

72 
	gfe_size
 = 
¡©ic_ÿ¡
<
size_t
>(
fe_¡©
.
¡_size
);

75 
	gbufãr_±r
 =

76 
mm­
(
nuÎ±r
, 
fe_size
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_PRIVATE
, 
fd
, 0);

77 ià(
	gbufãr_±r
 =ğ
MAP_FAILED
) {

78  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

79 
ab¦
::
SŒC©
("FaedØmm­ ", 
fe_Çme
));

83 
ASYLO_RETURN_IF_ERROR
(
şo£_¡©us
);

85  
FeM­pšg
(

86 
¡d
::
move
(
fe_Çme_¡ršg
),

87 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
bufãr_±r
), 
fe_size
));

90 
	gFeM­pšg
::~
FeM­pšg
() {

91 ià(
m­³d_»giÚ_
.
d©a
() &&

92 
munm­
(
m­³d_»giÚ_
.
d©a
(), m­³d_»giÚ_.
size
()) == -1) {

93 
LOG
(
FATAL
è<< 
ab¦
::
SŒC©
("FaedØunm­ ", 
fe_Çme_
, ": ",

94 
¡»¼Ü
(
”ºo
));

98 
	gFeM­pšg
::
MoveFrom
(
FeM­pšg
 *
Ùh”
) {

99 
¡d
::
sw­
(
fe_Çme_
, 
Ùh”
->file_name_);

100 
	g¡d
::
sw­
(
m­³d_»giÚ_
, 
Ùh”
->mapped_region_);

	@util/file_mapping.cc

19 
	~"asylo/ut/fe_m­pšg.h
"

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<sys/mmª.h
>

24 
	~<sys/¡©.h
>

25 
	~<sys/ty³s.h
>

26 
	~<uni¡d.h
>

27 
	~<c¡ddef
>

28 
	~<c¡ršg
>

30 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

31 
	~"asylo/ut/loggšg.h
"

32 
	~"asylo/ut/ş—nup.h
"

33 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

34 
	~"asylo/ut/¡©us.h
"

35 
	~"asylo/ut/¡©us_maüos.h
"

37 
Çme¥aû
 
	gasylo
 {

39 
	gStusOr
<
	gFeM­pšg
> FeM­pšg::
C»©eFromFe
(
ab¦
::
¡ršg_v›w
 
fe_Çme
) {

44 
¡d
::
¡ršg
 
fe_Çme_¡ršg
(
fe_Çme
.
d©a
(), fe_Çme.
size
());

45 *
	gbufãr_±r
;

46 
size_t
 
	gfe_size
;

49 
	gfd
 = 
İ’
(
fe_Çme_¡ršg
.
d©a
(), 
O_RDONLY
);

50 ià(
	gfd
 == -1) {

51  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

52 
ab¦
::
SŒC©
("FaedØİ’ ", 
fe_Çme
));

56 
Stus
 
	gşo£_¡©us
;

58 
CËªup
 
şo£_fd
([
fd
, 
fe_Çme
, &
şo£_¡©us
]() {

59 ià(
şo£
(
fd
) == -1) {

60 
şo£_¡©us
 = 
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

61 
ab¦
::
SŒC©
("FaedØşo£ ", 
fe_Çme
));

66 
¡©
 
	gfe_¡©
;

67 ià(
f¡©
(
fd
, &
fe_¡©
) == -1) {

68  
Stus
(

69 
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

70 
ab¦
::
SŒC©
("FaedØd‘”mšthsizoà", 
fe_Çme
));

72 
	gfe_size
 = 
¡©ic_ÿ¡
<
size_t
>(
fe_¡©
.
¡_size
);

75 
	gbufãr_±r
 =

76 
mm­
(
nuÎ±r
, 
fe_size
, 
PROT_READ
 | 
PROT_WRITE
, 
MAP_PRIVATE
, 
fd
, 0);

77 ià(
	gbufãr_±r
 =ğ
MAP_FAILED
) {

78  
Stus
(
¡©ic_ÿ¡
<
”rÜ
::
PosixE¼Ü
>(
”ºo
),

79 
ab¦
::
SŒC©
("FaedØmm­ ", 
fe_Çme
));

83 
ASYLO_RETURN_IF_ERROR
(
şo£_¡©us
);

85  
FeM­pšg
(

86 
¡d
::
move
(
fe_Çme_¡ršg
),

87 
ab¦
::
MakeS·n
(
»š‹½»t_ÿ¡
<
ušt8_t
 *>(
bufãr_±r
), 
fe_size
));

90 
	gFeM­pšg
::~
FeM­pšg
() {

91 ià(
m­³d_»giÚ_
.
d©a
() &&

92 
munm­
(
m­³d_»giÚ_
.
d©a
(), m­³d_»giÚ_.
size
()) == -1) {

93 
LOG
(
FATAL
è<< 
ab¦
::
SŒC©
("FaedØunm­ ", 
fe_Çme_
, ": ",

94 
¡»¼Ü
(
”ºo
));

98 
	gFeM­pšg
::
MoveFrom
(
FeM­pšg
 *
Ùh”
) {

99 
¡d
::
sw­
(
fe_Çme_
, 
Ùh”
->file_name_);

100 
	g¡d
::
sw­
(
m­³d_»giÚ_
, 
Ùh”
->mapped_region_);

	@util/file_mapping.h

19 #iâdeà
ASYLO_UTIL_FILE_MAPPING_H_


20 
	#ASYLO_UTIL_FILE_MAPPING_H_


	)

22 
	~<c¡dšt
>

24 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

25 
	~"ab¦/ty³s/¥ª.h
"

26 
	~"asylo/ut/¡©usÜ.h
"

28 
Çme¥aû
 
	gasylo
 {

34 şas 
	cFeM­pšg
 {

35 
	gpublic
:

38 
StusOr
<
FeM­pšg
> 
C»©eFromFe
(
ab¦
::
¡ršg_v›w
 
fe_Çme
);

40 
FeM­pšg
() = ;

42 
FeM­pšg
(cÚ¡ FeM­pšg &
Ùh”
èğ
d–‘e
;

43 
	gFeM­pšg
 &
	gİ”©Ü
=(cÚ¡ 
FeM­pšg
 &
Ùh”
èğ
d–‘e
;

45 
FeM­pšg
(FeM­pšg &&
Ùh”
è{ 
MoveFrom
(&other); }

46 
	gFeM­pšg
 &
	gİ”©Ü
=(
FeM­pšg
 &&
Ùh”
) {

47 
MoveFrom
(&
Ùh”
);

48  *
	gthis
;

51 ~
FeM­pšg
();

54 
	gab¦
::
S·n
<
ušt8_t
> 
bufãr
(ècÚ¡ {  
m­³d_»giÚ_
; }

56 
	g´iv©e
:

58 
FeM­pšg
(
¡d
::
¡ršg
 &&
fe_Çme
, 
ab¦
::
S·n
<
ušt8_t
> 
m­³d_»giÚ
)

59 : 
fe_Çme_
(
¡d
::
move
(
fe_Çme
)), 
m­³d_»giÚ_
(
m­³d_»giÚ
) {}

63 
MoveFrom
(
FeM­pšg
 *
Ùh”
);

66 
	g¡d
::
¡ršg
 
fe_Çme_
;

69 
	gab¦
::
S·n
<
ušt8_t
> 
m­³d_»giÚ_
;

	@util/file_mapping_test.cc

19 
	~"asylo/ut/fe_m­pšg.h
"

21 
	~<sys/mmª.h
>

22 
	~<sys/¡©.h
>

23 
	~<sys/ty³s.h
>

24 
	~<uni¡d.h
>

25 
	~<®gÜ™hm
>

26 
	~<c¡ddef
>

27 
	~<c¡ršg
>

28 
	~<f¡»am
>

29 
	~<memÜy
>

30 
	~<s¡»am
>

31 
	~<¡ršg
>

33 
	~<gmock/gmock.h
>

34 
	~<g‹¡/g‹¡.h
>

35 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

36 
	~"gæags/gæags.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

38 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

39 
	~"asylo/ut/¡©us.h
"

41 
DEFINE_¡ršg
(
‹¡_fe
, "", "Location ofest data file");

43 
Çme¥aû
 
	gasylo
 {

44 
	gÇme¥aû
 {

48 
cÚ¡ex´
 
	gkR•ÏûText
[] = "Merol";

50 şas 
	cFeM­pšgTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

51 
public
:

52 
S‘Up
(è
ov”ride
 {

53 
¡d
::
if¡»am
 
‹¡_fe_¡»am
(
FLAGS_‹¡_fe
);

54 
	g¡d
::
¡ršg¡»am
 
fe_¡ršg_¡»am
;

55 
	gfe_¡ršg_¡»am
 << 
	g‹¡_fe_¡»am
.
rdbuf
();

56 
	gex³ùed_fe_cÚ‹Ás_
 = 
fe_¡ršg_¡»am
.
¡r
();

59 
	g´Ùeùed
:

60 
¡d
::
¡ršg
 
ex³ùed_fe_cÚ‹Ás_
;

64 
TEST
(
FeM­pšgFixtu»ËssTe¡
, 
DeçuÉCÚ¡ruùedM­pšgDÛ¢tC¿sh
) {

65 
FeM­pšg
 
	gem±y
;

70 
TEST_F
(
FeM­pšgTe¡
, 
M­sFeSucûssfuÎy
) {

71 autØ
	gäom_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_‹¡_fe
);

72 
ASSERT_THAT
(
äom_fe_»suÉ
, 
IsOk
());

74 
FeM­pšg
 
	gm­pšg
 = 
¡d
::
move
(
äom_fe_»suÉ
.
V®ueOrD›
());

75 
EXPECT_EQ
(
m­pšg
.
bufãr
().
size
(), 
ex³ùed_fe_cÚ‹Ás_
.size());

76 
EXPECT_EQ
(
memcmp
(
m­pšg
.
bufãr
().
d©a
(), 
ex³ùed_fe_cÚ‹Ás_
.data(),

77 
m­pšg
.
bufãr
().
size
()),

83 
TEST_F
(
FeM­pšgTe¡
, 
M­Exhib™sCİyOnWr™eSemªtics
) {

85 autØ
	gou‹r_äom_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_‹¡_fe
);

86 
ASSERT_THAT
(
ou‹r_äom_fe_»suÉ
, 
IsOk
());

88 
FeM­pšg
 
	gou‹r_m­pšg
 = 
¡d
::
move
(
ou‹r_äom_fe_»suÉ
.
V®ueOrD›
());

89 
ASSERT_EQ
(
ou‹r_m­pšg
.
bufãr
().
size
(), 
ex³ùed_fe_cÚ‹Ás_
.size());

90 
ASSERT_EQ
(

91 
memcmp
(
ou‹r_m­pšg
.
bufãr
().
d©a
(), 
ex³ùed_fe_cÚ‹Ás_
.data(),

92 
ou‹r_m­pšg
.
bufãr
().
size
()),

96 
	g¡d
::
cİy
(
kR•ÏûText
, kR•ÏûTexˆ+ 
¡¾’
(kReplaceText),

97 
ou‹r_m­pšg
.
bufãr
().
d©a
());

101 autØ
	gšÃr_äom_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_‹¡_fe
);

102 
ASSERT_THAT
(
šÃr_äom_fe_»suÉ
, 
IsOk
());

105 
FeM­pšg
 
	gšÃr_m­pšg
 = 
¡d
::
move
(
šÃr_äom_fe_»suÉ
.
V®ueOrD›
());

106 
EXPECT_EQ
(
šÃr_m­pšg
.
bufãr
().
size
(), 
ex³ùed_fe_cÚ‹Ás_
.size());

107 
EXPECT_EQ
(

108 
memcmp
(
šÃr_m­pšg
.
bufãr
().
d©a
(), 
ex³ùed_fe_cÚ‹Ás_
.data(),

109 
šÃr_m­pšg
.
bufãr
().
size
()),

114 
EXPECT_EQ
(
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
ou‹r_m­pšg
.
bufãr
().
d©a
()),

115 
kR•ÏûText
, 
¡¾’
(kReplaceText)),

	@util/file_mapping_test.cc

19 
	~"asylo/ut/fe_m­pšg.h
"

21 
	~<sys/mmª.h
>

22 
	~<sys/¡©.h
>

23 
	~<sys/ty³s.h
>

24 
	~<uni¡d.h
>

25 
	~<®gÜ™hm
>

26 
	~<c¡ddef
>

27 
	~<c¡ršg
>

28 
	~<f¡»am
>

29 
	~<memÜy
>

30 
	~<s¡»am
>

31 
	~<¡ršg
>

33 
	~<gmock/gmock.h
>

34 
	~<g‹¡/g‹¡.h
>

35 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

36 
	~"gæags/gæags.h
"

37 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

38 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

39 
	~"asylo/ut/¡©us.h
"

41 
DEFINE_¡ršg
(
‹¡_fe
, "", "Location ofest data file");

43 
Çme¥aû
 
	gasylo
 {

44 
	gÇme¥aû
 {

48 
cÚ¡ex´
 
	gkR•ÏûText
[] = "Merol";

50 şas 
	cFeM­pšgTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

51 
public
:

52 
S‘Up
(è
ov”ride
 {

53 
¡d
::
if¡»am
 
‹¡_fe_¡»am
(
FLAGS_‹¡_fe
);

54 
	g¡d
::
¡ršg¡»am
 
fe_¡ršg_¡»am
;

55 
	gfe_¡ršg_¡»am
 << 
	g‹¡_fe_¡»am
.
rdbuf
();

56 
	gex³ùed_fe_cÚ‹Ás_
 = 
fe_¡ršg_¡»am
.
¡r
();

59 
	g´Ùeùed
:

60 
¡d
::
¡ršg
 
ex³ùed_fe_cÚ‹Ás_
;

64 
TEST
(
FeM­pšgFixtu»ËssTe¡
, 
DeçuÉCÚ¡ruùedM­pšgDÛ¢tC¿sh
) {

65 
FeM­pšg
 
	gem±y
;

70 
TEST_F
(
FeM­pšgTe¡
, 
M­sFeSucûssfuÎy
) {

71 autØ
	gäom_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_‹¡_fe
);

72 
ASSERT_THAT
(
äom_fe_»suÉ
, 
IsOk
());

74 
FeM­pšg
 
	gm­pšg
 = 
¡d
::
move
(
äom_fe_»suÉ
.
V®ueOrD›
());

75 
EXPECT_EQ
(
m­pšg
.
bufãr
().
size
(), 
ex³ùed_fe_cÚ‹Ás_
.size());

76 
EXPECT_EQ
(
memcmp
(
m­pšg
.
bufãr
().
d©a
(), 
ex³ùed_fe_cÚ‹Ás_
.data(),

77 
m­pšg
.
bufãr
().
size
()),

83 
TEST_F
(
FeM­pšgTe¡
, 
M­Exhib™sCİyOnWr™eSemªtics
) {

85 autØ
	gou‹r_äom_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_‹¡_fe
);

86 
ASSERT_THAT
(
ou‹r_äom_fe_»suÉ
, 
IsOk
());

88 
FeM­pšg
 
	gou‹r_m­pšg
 = 
¡d
::
move
(
ou‹r_äom_fe_»suÉ
.
V®ueOrD›
());

89 
ASSERT_EQ
(
ou‹r_m­pšg
.
bufãr
().
size
(), 
ex³ùed_fe_cÚ‹Ás_
.size());

90 
ASSERT_EQ
(

91 
memcmp
(
ou‹r_m­pšg
.
bufãr
().
d©a
(), 
ex³ùed_fe_cÚ‹Ás_
.data(),

92 
ou‹r_m­pšg
.
bufãr
().
size
()),

96 
	g¡d
::
cİy
(
kR•ÏûText
, kR•ÏûTexˆ+ 
¡¾’
(kReplaceText),

97 
ou‹r_m­pšg
.
bufãr
().
d©a
());

101 autØ
	gšÃr_äom_fe_»suÉ
 = 
FeM­pšg
::
C»©eFromFe
(
FLAGS_‹¡_fe
);

102 
ASSERT_THAT
(
šÃr_äom_fe_»suÉ
, 
IsOk
());

105 
FeM­pšg
 
	gšÃr_m­pšg
 = 
¡d
::
move
(
šÃr_äom_fe_»suÉ
.
V®ueOrD›
());

106 
EXPECT_EQ
(
šÃr_m­pšg
.
bufãr
().
size
(), 
ex³ùed_fe_cÚ‹Ás_
.size());

107 
EXPECT_EQ
(

108 
memcmp
(
šÃr_m­pšg
.
bufãr
().
d©a
(), 
ex³ùed_fe_cÚ‹Ás_
.data(),

109 
šÃr_m­pšg
.
bufãr
().
size
()),

114 
EXPECT_EQ
(
¡ºcmp
(
»š‹½»t_ÿ¡
<*>(
ou‹r_m­pšg
.
bufãr
().
d©a
()),

115 
kR•ÏûText
, 
¡¾’
(kReplaceText)),

	@util/logging.cc

19 
	~"asylo/ut/loggšg.h
"

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<libg’.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/¡©.h
>

26 
	~<sys/ty³s.h
>

27 
	~<uni¡d.h
>

28 
	~<cùy³
>

29 
	~<c¡dio
>

30 
	~<c¡dlib
>

31 
	~<ùime
>

32 
	~<s¡»am
>

33 
	~<¡ršg
>

35 
Çme¥aû
 
	gasylo
 {

37 #ifdeà
__ASYLO__


38 
cÚ¡ex´
 
boŞ
 
	gkInsideEnşave
 = 
Œue
;

40 
cÚ¡ex´
 
boŞ
 
	gkInsideEnşave
 = 
çl£
;

43 
cÚ¡ex´
 
	gkDeçuÉDœeùÜy
[] = "/tmp/";

45 
	gÇme¥aû
 {

48 
	g¡d
::
¡ršg
 *
log_fe_dœeùÜy
 = 
nuÎ±r
;

52 
	g¡d
::
¡ršg
 *
log_ba£Çme
 = 
nuÎ±r
;

56 
	gvlog_Ëv–
 = 0;

60 
th»ad_loÿl
 
boŞ
 
	glog_·nic
 = 
çl£
;

62 cÚ¡ *
G‘Ba£Çme
(cÚ¡ *
fe_·th
) {

63 cÚ¡ *
	g¦ash
 = 
¡¼chr
(
fe_·th
, '/');

64  
	g¦ash
 ? sÏsh + 1 : 
fe_·th
;

68 cÚ¡ 
	g¡d
::
¡ršg
 
BudF’ame
(
¡d
::¡ršg 
f’ame
) {

69 
size_t
 
i
 = 0; 
	gi
 < 
	gf’ame
.
size
(); ++i) {

70 ià(
i§Êum
(
f’ame
[
i
]) == 0 && filename[i] != '-') {

71 
f’ame
[
i
] = '_';

74  
	gf’ame
;

77 
boŞ
 
£t_log_ba£Çme
(cÚ¡ 
¡d
::
¡ršg
 &
f’ame
) {

78 ià(
log_ba£Çme
 || 
f’ame
.
em±y
()) {

79  
çl£
;

81 
	glog_ba£Çme
 = 
Ãw
 
¡d
::
¡ršg
(
f’ame
);

82  
	gŒue
;

85 cÚ¡ 
	g¡d
::
¡ršg
 
g‘_log_ba£Çme
() {

86 ià(!
log_ba£Çme
 ||†og_ba£Çme->
em±y
()) {

87  
kInsideEnşave
 ? "enclave_log" : "untrusted_log";

89  *
	glog_ba£Çme
;

94 
boŞ
 
£t_log_dœeùÜy
(cÚ¡ 
¡d
::
¡ršg
 &
log_dœeùÜy
) {

95 
¡d
::
¡ršg
 
tmp_dœeùÜy
 = 
log_dœeùÜy
;

96 ià(
	gtmp_dœeùÜy
.
em±y
()) {

97 
	gtmp_dœeùÜy
 = 
kDeçuÉDœeùÜy
;

99 ià(
	glog_fe_dœeùÜy
 || !
Ensu»DœeùÜy
(
tmp_dœeùÜy
.
c_¡r
())) {

100  
	gçl£
;

102 ià(
	gtmp_dœeùÜy
.
back
() == '/') {

103 
log_fe_dœeùÜy
 = 
Ãw
 
¡d
::
¡ršg
(
tmp_dœeùÜy
);

105 
	glog_fe_dœeùÜy
 = 
Ãw
 
¡d
::
¡ršg
(
tmp_dœeùÜy
 + "/");

107  
	gŒue
;

110 cÚ¡ 
	g¡d
::
¡ršg
 
g‘_log_dœeùÜy
() {

111 ià(!
log_fe_dœeùÜy
) {

112  
kDeçuÉDœeùÜy
;

114  *
	glog_fe_dœeùÜy
;

117 
£t_vlog_Ëv–
(
Ëv–
è{ 
	gvlog_Ëv–
 =†evel; }

119 
g‘_vlog_Ëv–
(è{  
	gvlog_Ëv–
; }

121 
boŞ
 
Ensu»DœeùÜy
(cÚ¡ *
·th
) {

122 
¡©
 
	gdœSt
;

123 ià(
¡©
(
·th
, &
dœSt
)) {

124 ià(
	g”ºo
 !ğ
ENOENT
) {

125  
çl£
;

127 ià(
mkdœ
(
·th
, 0766)) {

128  
	gçl£
;

130 } ià(!
S_ISDIR
(
dœSt
.
¡_mode
)) {

131  
	gçl£
;

133  
	gŒue
;

136 
boŞ
 
In™Loggšg
(cÚ¡ *
dœeùÜy
, cÚ¡ *
fe_Çme
, 
Ëv–
) {

137 
£t_vlog_Ëv–
(
Ëv–
);

138 
	g¡d
::
¡ršg
 
log_dœeùÜy
 = 
dœeùÜy
 ? 
¡d
::string(directory) : "";

139 ià(!
£t_log_dœeùÜy
(
log_dœeùÜy
)) {

140  
	gçl£
;

142 cÚ¡ *
	gbš¬y_Çme
 = 
G‘Ba£Çme
(
fe_Çme
);

143 
	g¡d
::
¡ršg
 
f’ame
 = 
bš¬y_Çme
;

144 ià(
	gkInsideEnşave
) {

145 
	gf’ame
 = 
BudF’ame
(
f’ame
);

147 ià(!
	gf’ame
.
em±y
(è&& !
£t_log_ba£Çme
(
f’ame
)) {

148  
	gçl£
;

150 
	g¡d
::
¡ršg
 
log_·th
 = 
g‘_log_dœeùÜy
(è+ 
g‘_log_ba£Çme
();

151 ià(
acûss
(
log_·th
.
c_¡r
(), 
F_OK
) == 0 &&

152 
acûss
(
log_·th
.
c_¡r
(), 
W_OK
) != 0) {

153  
çl£
;

155  
	gŒue
;

158 
	gLogMes§ge
::
LogMes§ge
(cÚ¡ *
fe
, 
lše
è{ 
In™
(fe,†še, 
INFO
); }

160 
	gLogMes§ge
::
LogMes§ge
(cÚ¡ *
fe
, 
lše
, 
LogSev”™y
 
£v”™y
) {

161 
In™
(
fe
, 
lše
, 
£v”™y
);

164 
	gLogMes§ge
::
LogMes§ge
(cÚ¡ *
fe
, 
lše
, cÚ¡ 
¡d
::
¡ršg
 &
»suÉ
) {

165 
In™
(
fe
, 
lše
, 
FATAL
);

166 
¡»am
(è<< "Check faed: " << 
	g»suÉ
 << " ";

169 
cÚ¡ex´
 cÚ¡ *
	gLogSev”™yNames
[5] = {"INFO", "WARNING", "ERROR",

172 
	gLogMes§ge
::
In™
(cÚ¡ *
fe
, 
lše
, 
LogSev”™y
 
£v”™y
) {

174 ià(
	glog_·nic
) {

175 
abÜt
();

177 
	g£v”™y_
 = 
£v”™y
;

178 ià(
	g£v”™y_
 =ğ
FATAL
 || 
£v”™y_
 =ğ
QFATAL
) {

179 
log_·nic
 = 
Œue
;

182 cÚ¡ *
	gf’ame
 = 
G‘Ba£Çme
(
fe
);

186 
time¥ec
 
	gtime_¡amp
;

187 
şock_g‘time
(
CLOCK_REALTIME
, &
time_¡amp
);

189 
cÚ¡ex´
 
	gkTimeMes§geSize
 = 22;

190 
	gbufãr
[
kTimeMes§geSize
];

191 
¡ráime
(
bufãr
, 
kTimeMes§geSize
, "%Y-%m-%d %H:%M:%S ",

192 
loÿÉime
(&
time_¡amp
.
tv_£c
));

193 
¡»am
(è<< 
	gbufãr
;

194 
¡»am
(è<< 
	gLogSev”™yNames
[
£v”™y_
] << " " << 
	gf’ame
 << " : " << 
	glše


198 
	gLogMes§ge
::~
LogMes§ge
() {

199 
¡d
::
¡ršg
 
mes§ge_‹xt
 = 
¡»am_
.
¡r
();

200 
S’dToLog
(
mes§ge_‹xt
);

203 
	gLogMes§ge
::
S’dToLog
(cÚ¡ 
¡d
::
¡ršg
 &
mes§ge_‹xt
) {

204 
¡d
::
¡ršg
 
log_·th
 = 
g‘_log_dœeùÜy
(è+ 
g‘_log_ba£Çme
();

206 
FILE
 *
	gfe
 = 
fİ’
(
log_·th
.
c_¡r
(), "ab");

207 ià(
	gfe
) {

208 ià(
årštf
(
fe
, "%s", 
mes§ge_‹xt
.
c_¡r
()) > 0) {

209 ià(
	gmes§ge_‹xt
.
back
() != '\n') {

210 
årštf
(
fe
, "\n");

213 
årštf
(
¡d”r
, "FaedØwr™tØlog f: %s!\n", 
log_·th
.
c_¡r
());

215 
fşo£
(
fe
);

217 
årštf
(
¡d”r
, "FaedØİ’†og f: %s!\n", 
log_·th
.
c_¡r
());

219 ià(
	g£v”™y_
 >ğ
ERROR
) {

220 
årštf
(
¡d”r
, "%s\n", 
mes§ge_‹xt
.
c_¡r
());

221 
fæush
(
¡d”r
);

223 
´štf
("%s\n", 
mes§ge_‹xt
.
c_¡r
());

224 
fæush
(
¡dout
);

227 ià(
	g£v”™y_
 =ğ
FATAL
) {

228 
abÜt
();

230 ià(
	g£v”™y_
 =ğ
QFATAL
) {

231 
_ex™
(1);

235 
	gCheckOpMes§geBud”
::
CheckOpMes§geBud”
(cÚ¡ *
ex´‹xt
)

236 : 
¡»am_
(
Ãw
 
¡d
::
o¡ršg¡»am
) {

237 *
¡»am_
 << 
ex´‹xt
 << " (";

240 
	gCheckOpMes§geBud”
::~
CheckOpMes§geBud”
(è{ 
d–‘e
 
¡»am_
; }

242 
	g¡d
::
o¡»am
 *
CheckOpMes§geBud”
::
FÜV¬2
() {

243 *
¡»am_
 << " vs. ";

244  
	g¡»am_
;

247 
	g¡d
::
¡ršg
 *
CheckOpMes§geBud”
::
NewSŒšg
() {

248 *
¡»am_
 << ")";

249  
Ãw
 
	g¡d
::
¡ršg
(
¡»am_
->
¡r
());

252 
	g‹m¶©e
 <>

253 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ &
v
) {

254 ià(
	gv
 >ğ32 && 
v
 <= 126) {

255 (*
os
è<< "'" << 
v
 << "'";

257 (*
	gos
è<< "ch¬ v®u" << 
	g¡©ic_ÿ¡
<
	gšt16_t
>(
	gv
);

261 
	g‹m¶©e
 <>

262 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ sigÃd &
v
) {

263 ià(
	gv
 >ğ32 && 
v
 <= 126) {

264 (*
os
è<< "'" << 
v
 << "'";

266 (*
	gos
è<< "sigÃd ch¬ v®u" << 
	g¡©ic_ÿ¡
<
	gšt16_t
>(
	gv
);

270 
	g‹m¶©e
 <>

271 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ &
v
) {

272 ià(
	gv
 >ğ32 && 
v
 <= 126) {

273 (*
os
è<< "'" << 
v
 << "'";

275 (*
	gos
è<< "unsigÃd ch¬ v®u" << 
	g¡©ic_ÿ¡
<
	gušt16_t
>(
	gv
);

279 
	g‹m¶©e
 <>

280 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ std::
nuÎ±r_t
 &
v
) {

281 (*
os
) << "nullptr";

	@util/logging.cc

19 
	~"asylo/ut/loggšg.h
"

21 
	~<”ºo.h
>

22 
	~<fú.h
>

23 
	~<libg’.h
>

24 
	~<¡ršg.h
>

25 
	~<sys/¡©.h
>

26 
	~<sys/ty³s.h
>

27 
	~<uni¡d.h
>

28 
	~<cùy³
>

29 
	~<c¡dio
>

30 
	~<c¡dlib
>

31 
	~<ùime
>

32 
	~<s¡»am
>

33 
	~<¡ršg
>

35 
Çme¥aû
 
	gasylo
 {

37 #ifdeà
__ASYLO__


38 
cÚ¡ex´
 
boŞ
 
	gkInsideEnşave
 = 
Œue
;

40 
cÚ¡ex´
 
boŞ
 
	gkInsideEnşave
 = 
çl£
;

43 
cÚ¡ex´
 
	gkDeçuÉDœeùÜy
[] = "/tmp/";

45 
	gÇme¥aû
 {

48 
	g¡d
::
¡ršg
 *
log_fe_dœeùÜy
 = 
nuÎ±r
;

52 
	g¡d
::
¡ršg
 *
log_ba£Çme
 = 
nuÎ±r
;

56 
	gvlog_Ëv–
 = 0;

60 
th»ad_loÿl
 
boŞ
 
	glog_·nic
 = 
çl£
;

62 cÚ¡ *
G‘Ba£Çme
(cÚ¡ *
fe_·th
) {

63 cÚ¡ *
	g¦ash
 = 
¡¼chr
(
fe_·th
, '/');

64  
	g¦ash
 ? sÏsh + 1 : 
fe_·th
;

68 cÚ¡ 
	g¡d
::
¡ršg
 
BudF’ame
(
¡d
::¡ršg 
f’ame
) {

69 
size_t
 
i
 = 0; 
	gi
 < 
	gf’ame
.
size
(); ++i) {

70 ià(
i§Êum
(
f’ame
[
i
]) == 0 && filename[i] != '-') {

71 
f’ame
[
i
] = '_';

74  
	gf’ame
;

77 
boŞ
 
£t_log_ba£Çme
(cÚ¡ 
¡d
::
¡ršg
 &
f’ame
) {

78 ià(
log_ba£Çme
 || 
f’ame
.
em±y
()) {

79  
çl£
;

81 
	glog_ba£Çme
 = 
Ãw
 
¡d
::
¡ršg
(
f’ame
);

82  
	gŒue
;

85 cÚ¡ 
	g¡d
::
¡ršg
 
g‘_log_ba£Çme
() {

86 ià(!
log_ba£Çme
 ||†og_ba£Çme->
em±y
()) {

87  
kInsideEnşave
 ? "enclave_log" : "untrusted_log";

89  *
	glog_ba£Çme
;

94 
boŞ
 
£t_log_dœeùÜy
(cÚ¡ 
¡d
::
¡ršg
 &
log_dœeùÜy
) {

95 
¡d
::
¡ršg
 
tmp_dœeùÜy
 = 
log_dœeùÜy
;

96 ià(
	gtmp_dœeùÜy
.
em±y
()) {

97 
	gtmp_dœeùÜy
 = 
kDeçuÉDœeùÜy
;

99 ià(
	glog_fe_dœeùÜy
 || !
Ensu»DœeùÜy
(
tmp_dœeùÜy
.
c_¡r
())) {

100  
	gçl£
;

102 ià(
	gtmp_dœeùÜy
.
back
() == '/') {

103 
log_fe_dœeùÜy
 = 
Ãw
 
¡d
::
¡ršg
(
tmp_dœeùÜy
);

105 
	glog_fe_dœeùÜy
 = 
Ãw
 
¡d
::
¡ršg
(
tmp_dœeùÜy
 + "/");

107  
	gŒue
;

110 cÚ¡ 
	g¡d
::
¡ršg
 
g‘_log_dœeùÜy
() {

111 ià(!
log_fe_dœeùÜy
) {

112  
kDeçuÉDœeùÜy
;

114  *
	glog_fe_dœeùÜy
;

117 
£t_vlog_Ëv–
(
Ëv–
è{ 
	gvlog_Ëv–
 =†evel; }

119 
g‘_vlog_Ëv–
(è{  
	gvlog_Ëv–
; }

121 
boŞ
 
Ensu»DœeùÜy
(cÚ¡ *
·th
) {

122 
¡©
 
	gdœSt
;

123 ià(
¡©
(
·th
, &
dœSt
)) {

124 ià(
	g”ºo
 !ğ
ENOENT
) {

125  
çl£
;

127 ià(
mkdœ
(
·th
, 0766)) {

128  
	gçl£
;

130 } ià(!
S_ISDIR
(
dœSt
.
¡_mode
)) {

131  
	gçl£
;

133  
	gŒue
;

136 
boŞ
 
In™Loggšg
(cÚ¡ *
dœeùÜy
, cÚ¡ *
fe_Çme
, 
Ëv–
) {

137 
£t_vlog_Ëv–
(
Ëv–
);

138 
	g¡d
::
¡ršg
 
log_dœeùÜy
 = 
dœeùÜy
 ? 
¡d
::string(directory) : "";

139 ià(!
£t_log_dœeùÜy
(
log_dœeùÜy
)) {

140  
	gçl£
;

142 cÚ¡ *
	gbš¬y_Çme
 = 
G‘Ba£Çme
(
fe_Çme
);

143 
	g¡d
::
¡ršg
 
f’ame
 = 
bš¬y_Çme
;

144 ià(
	gkInsideEnşave
) {

145 
	gf’ame
 = 
BudF’ame
(
f’ame
);

147 ià(!
	gf’ame
.
em±y
(è&& !
£t_log_ba£Çme
(
f’ame
)) {

148  
	gçl£
;

150 
	g¡d
::
¡ršg
 
log_·th
 = 
g‘_log_dœeùÜy
(è+ 
g‘_log_ba£Çme
();

151 ià(
acûss
(
log_·th
.
c_¡r
(), 
F_OK
) == 0 &&

152 
acûss
(
log_·th
.
c_¡r
(), 
W_OK
) != 0) {

153  
çl£
;

155  
	gŒue
;

158 
	gLogMes§ge
::
LogMes§ge
(cÚ¡ *
fe
, 
lše
è{ 
In™
(fe,†še, 
INFO
); }

160 
	gLogMes§ge
::
LogMes§ge
(cÚ¡ *
fe
, 
lše
, 
LogSev”™y
 
£v”™y
) {

161 
In™
(
fe
, 
lše
, 
£v”™y
);

164 
	gLogMes§ge
::
LogMes§ge
(cÚ¡ *
fe
, 
lše
, cÚ¡ 
¡d
::
¡ršg
 &
»suÉ
) {

165 
In™
(
fe
, 
lše
, 
FATAL
);

166 
¡»am
(è<< "Check faed: " << 
	g»suÉ
 << " ";

169 
cÚ¡ex´
 cÚ¡ *
	gLogSev”™yNames
[5] = {"INFO", "WARNING", "ERROR",

172 
	gLogMes§ge
::
In™
(cÚ¡ *
fe
, 
lše
, 
LogSev”™y
 
£v”™y
) {

174 ià(
	glog_·nic
) {

175 
abÜt
();

177 
	g£v”™y_
 = 
£v”™y
;

178 ià(
	g£v”™y_
 =ğ
FATAL
 || 
£v”™y_
 =ğ
QFATAL
) {

179 
log_·nic
 = 
Œue
;

182 cÚ¡ *
	gf’ame
 = 
G‘Ba£Çme
(
fe
);

186 
time¥ec
 
	gtime_¡amp
;

187 
şock_g‘time
(
CLOCK_REALTIME
, &
time_¡amp
);

189 
cÚ¡ex´
 
	gkTimeMes§geSize
 = 22;

190 
	gbufãr
[
kTimeMes§geSize
];

191 
¡ráime
(
bufãr
, 
kTimeMes§geSize
, "%Y-%m-%d %H:%M:%S ",

192 
loÿÉime
(&
time_¡amp
.
tv_£c
));

193 
¡»am
(è<< 
	gbufãr
;

194 
¡»am
(è<< 
	gLogSev”™yNames
[
£v”™y_
] << " " << 
	gf’ame
 << " : " << 
	glše


198 
	gLogMes§ge
::~
LogMes§ge
() {

199 
¡d
::
¡ršg
 
mes§ge_‹xt
 = 
¡»am_
.
¡r
();

200 
S’dToLog
(
mes§ge_‹xt
);

203 
	gLogMes§ge
::
S’dToLog
(cÚ¡ 
¡d
::
¡ršg
 &
mes§ge_‹xt
) {

204 
¡d
::
¡ršg
 
log_·th
 = 
g‘_log_dœeùÜy
(è+ 
g‘_log_ba£Çme
();

206 
FILE
 *
	gfe
 = 
fİ’
(
log_·th
.
c_¡r
(), "ab");

207 ià(
	gfe
) {

208 ià(
årštf
(
fe
, "%s", 
mes§ge_‹xt
.
c_¡r
()) > 0) {

209 ià(
	gmes§ge_‹xt
.
back
() != '\n') {

210 
årštf
(
fe
, "\n");

213 
årštf
(
¡d”r
, "FaedØwr™tØlog f: %s!\n", 
log_·th
.
c_¡r
());

215 
fşo£
(
fe
);

217 
årštf
(
¡d”r
, "FaedØİ’†og f: %s!\n", 
log_·th
.
c_¡r
());

219 ià(
	g£v”™y_
 >ğ
ERROR
) {

220 
årštf
(
¡d”r
, "%s\n", 
mes§ge_‹xt
.
c_¡r
());

221 
fæush
(
¡d”r
);

223 
´štf
("%s\n", 
mes§ge_‹xt
.
c_¡r
());

224 
fæush
(
¡dout
);

227 ià(
	g£v”™y_
 =ğ
FATAL
) {

228 
abÜt
();

230 ià(
	g£v”™y_
 =ğ
QFATAL
) {

231 
_ex™
(1);

235 
	gCheckOpMes§geBud”
::
CheckOpMes§geBud”
(cÚ¡ *
ex´‹xt
)

236 : 
¡»am_
(
Ãw
 
¡d
::
o¡ršg¡»am
) {

237 *
¡»am_
 << 
ex´‹xt
 << " (";

240 
	gCheckOpMes§geBud”
::~
CheckOpMes§geBud”
(è{ 
d–‘e
 
¡»am_
; }

242 
	g¡d
::
o¡»am
 *
CheckOpMes§geBud”
::
FÜV¬2
() {

243 *
¡»am_
 << " vs. ";

244  
	g¡»am_
;

247 
	g¡d
::
¡ršg
 *
CheckOpMes§geBud”
::
NewSŒšg
() {

248 *
¡»am_
 << ")";

249  
Ãw
 
	g¡d
::
¡ršg
(
¡»am_
->
¡r
());

252 
	g‹m¶©e
 <>

253 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ &
v
) {

254 ià(
	gv
 >ğ32 && 
v
 <= 126) {

255 (*
os
è<< "'" << 
v
 << "'";

257 (*
	gos
è<< "ch¬ v®u" << 
	g¡©ic_ÿ¡
<
	gšt16_t
>(
	gv
);

261 
	g‹m¶©e
 <>

262 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ sigÃd &
v
) {

263 ià(
	gv
 >ğ32 && 
v
 <= 126) {

264 (*
os
è<< "'" << 
v
 << "'";

266 (*
	gos
è<< "sigÃd ch¬ v®u" << 
	g¡©ic_ÿ¡
<
	gšt16_t
>(
	gv
);

270 
	g‹m¶©e
 <>

271 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ &
v
) {

272 ià(
	gv
 >ğ32 && 
v
 <= 126) {

273 (*
os
è<< "'" << 
v
 << "'";

275 (*
	gos
è<< "unsigÃd ch¬ v®u" << 
	g¡©ic_ÿ¡
<
	gušt16_t
>(
	gv
);

279 
	g‹m¶©e
 <>

280 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ std::
nuÎ±r_t
 &
v
) {

281 (*
os
) << "nullptr";

	@util/logging.h

19 #iâdeà
ASYLO_UTIL_LOGGING_H_


20 
	#ASYLO_UTIL_LOGGING_H_


	)

22 
	~<c¡dšt
>

23 
	~<c¡dlib
>

24 
	~<memÜy
>

25 
	~<s¡»am
>

26 
	~<¡ršg
>

28 
	~"ab¦/ba£/İtimiz©iÚ.h
"

31 
	#COMPACT_ASYLO_LOG_INFO
 ::
asylo
::
	`LogMes§ge
(
__FILE__
, 
__LINE__
)

	)

32 
	#COMPACT_ASYLO_LOG_WARNING
 \

33 ::
asylo
::
	`LogMes§ge
(
__FILE__
, 
__LINE__
, 
WARNING
)

	)

34 
	#COMPACT_ASYLO_LOG_ERROR
 ::
asylo
::
	`LogMes§ge
(
__FILE__
, 
__LINE__
, 
ERROR
)

	)

35 
	#COMPACT_ASYLO_LOG_FATAL
 ::
asylo
::
	`LogMes§ge
(
__FILE__
, 
__LINE__
, 
FATAL
)

	)

36 
	#COMPACT_ASYLO_LOG_QFATAL
 ::
asylo
::
	`LogMes§ge
(
__FILE__
, 
__LINE__
, 
QFATAL
)

	)

38 #ifdeà
NDEBUG


39 
	#COMPACT_ASYLO_LOG_DFATAL
 
COMPACT_ASYLO_LOG_ERROR


	)

41 
	#COMPACT_ASYLO_LOG_DFATAL
 
COMPACT_ASYLO_LOG_FATAL


	)

57 
	#LOG
(
£v”™y
è
COMPACT_ASYLO_LOG_
##£v”™y.
	`¡»am
()

	)

70 
	#LOG_IF
(
£v”™y
, 
cÚd™iÚ
) \

71 !(
cÚd™iÚ
è? ()0 : 
asylo
::
	`LogMes§geVoidify
(è& 
	`LOG
(
£v”™y
)

	)

85 
	#VLOG
(
Ëv–
è
	`LOG_IF
(
INFO
, (Ëv–è<ğ
	`g‘_vlog_Ëv–
())

	)

99 
	#CHECK
(
cÚd™iÚ
) \

100 
	`LOG_IF
(
FATAL
, !(
cÚd™iÚ
)è<< "Check faed: " #cÚd™iÚ " "

	)

104 
	eLogSev”™y
 { 
	mINFO
, 
	mWARNING
, 
	mERROR
, 
	mFATAL
, 
	mQFATAL
 };

106 
Çme¥aû
 
	gasylo
 {

111 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

112 
šlše
 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ 
T
 &
v
) {

113 (*
	gos
è<< 
	gv
;

118 
	g‹m¶©e
 <>

119 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ &
v
);

120 
	g‹m¶©e
 <>

121 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ sigÃd &
v
);

122 
	g‹m¶©e
 <>

123 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ &
v
);

127 
	g‹m¶©e
 <>

128 
MakeCheckOpV®ueSŒšg
(
¡d
::
o¡»am
 *
os
, cÚ¡ std::
nuÎ±r_t
 &
p
);

132 şas 
	cCheckOpMes§geBud”
 {

133 
	gpublic
:

138 
ex¶ic™
 
CheckOpMes§geBud”
(cÚ¡ *
ex´‹xt
);

141 ~
CheckOpMes§geBud”
();

146 
	g¡d
::
o¡»am
 *
FÜV¬1
(è{  
¡»am_
; }

152 
	g¡d
::
o¡»am
 *
FÜV¬2
();

157 
	g¡d
::
¡ršg
 *
NewSŒšg
();

159 
	g´iv©e
:

160 
¡d
::
o¡ršg¡»am
 *
¡»am_
;

164 
	g‹m¶©e
 <
ty³Çme
 
	gT1
,y³Çm
	gT2
>

165 
	g¡d
::
¡ršg
 *
	$MakeCheckOpSŒšg
(cÚ¡ 
T1
 &
v1
, cÚ¡ 
T2
 &
v2
,

166 cÚ¡ *
ex´‹xt
) {

167 
CheckOpMes§geBud”
 
	`comb
(
ex´‹xt
);

168 
	`MakeCheckOpV®ueSŒšg
(
comb
.
	`FÜV¬1
(), 
v1
);

169 
	`MakeCheckOpV®ueSŒšg
(
comb
.
	`FÜV¬2
(), 
v2
);

170  
comb
.
	`NewSŒšg
();

171 
	}
}

181 
	#DEFINE_CHECK_OP_IMPL
(
Çme
, 
İ
) \

182 
‹m¶©e
 <
ty³Çme
 
T1
,y³Çm
T2
> \

183 
šlše
 
¡d
::
¡ršg
 *
Çme
##
	`Im¶
(cÚ¡ 
T1
 &
v1
, cÚ¡ 
T2
 &
v2
, \

184 cÚ¡ *
ex´‹xt
) { \

185 ià(
	`ABSL_PREDICT_TRUE
(
v1
 
İ
 
v2
)è 
nuÎ±r
; \

186  
	`MakeCheckOpSŒšg
(
v1
, 
v2
, 
ex´‹xt
); \

188 
šlše
 
¡d
::
¡ršg
 *
Çme
##
	$Im¶
(
v1
, 
v2
, cÚ¡ *
ex´‹xt
) { \

189  
Çme
##
Im¶
<, >(
v1
, 
v2
, 
ex´‹xt
); \

190 
	}

	)
}

197 
	$DEFINE_CHECK_OP_IMPL
(
Check_EQ
, ==)

198 
	`DEFINE_CHECK_OP_IMPL
(
Check_NE
, !=)

199 
	`DEFINE_CHECK_OP_IMPL
(
Check_LE
, <=)

200 
	`DEFINE_CHECK_OP_IMPL
(
Check_LT
, <)

201 
	`DEFINE_CHECK_OP_IMPL
(
Check_GE
, >=)

202 
	`DEFINE_CHECK_OP_IMPL
(
Check_GT
, >)

203 #undeà
DEFINE_CHECK_OP_IMPL


210 
‹m¶©e
 <
ty³Çme
 
T
>

211 
šlše
 cÚ¡ 
T
 &
	$G‘Reã»nûabËV®ue
(cÚ¡ 
T
 &
t
) {

212  
t
;

213 
	}
}

214 
šlše
 
	$G‘Reã»nûabËV®ue
(
t
è{ ; 
	}
}

215 
šlše
 
ušt8_t
 
	$G‘Reã»nûabËV®ue
(
ušt8_t
 
t
è{ ; 
	}
}

216 
šlše
 
št8_t
 
	$G‘Reã»nûabËV®ue
(
št8_t
 
t
è{ ; 
	}
}

217 
šlše
 
št16_t
 
	$G‘Reã»nûabËV®ue
(
št16_t
 
t
è{ ; 
	}
}

218 
šlše
 
ušt16_t
 
	$G‘Reã»nûabËV®ue
(
ušt16_t
 
t
è{ ; 
	}
}

219 
šlše
 
št32_t
 
	$G‘Reã»nûabËV®ue
(
št32_t
 
t
è{ ; 
	}
}

220 
šlše
 
ušt32_t
 
	$G‘Reã»nûabËV®ue
(
ušt32_t
 
t
è{ ; 
	}
}

221 
šlše
 
št64_t
 
	$G‘Reã»nûabËV®ue
(
št64_t
 
t
è{ ; 
	}
}

222 
šlše
 
ušt64_t
 
	$G‘Reã»nûabËV®ue
(
ušt64_t
 
t
è{ ; 
	}
}

233 
	#CHECK_OP_LOG
(
Çme
, 
İ
, 
v®1
, 
v®2
, 
log
) \

234 
¡d
::
unique_±r
<¡d::
¡ršg
> 
_»suÉ
 = std::unique_ptr<std::string>( \

235 
asylo
::
Çme
##
	`Im¶
×sylo::
	`G‘Reã»nûabËV®ue
(
v®1
), \

236 
asylo
::
	`G‘Reã»nûabËV®ue
(
v®2
), \

238 
	`log
(
__FILE__
, 
__LINE__
, *
_»suÉ
).
	$¡»am
()

	)

247 
	#CHECK_OP
(
Çme
, 
İ
, 
v®1
, 
v®2
) \

248 
	$CHECK_OP_LOG
(
Çme
, 
İ
, 
v®1
, 
v®2
, 
asylo
::
LogMes§geF©®
)

	)

251 
	#CHECK_EQ
(
v®1
, 
v®2
è
	$CHECK_OP
(
Check_EQ
, ==, 
v®1
, 
v®2
)

	)

253 
	#CHECK_NE
(
v®1
, 
v®2
è
	`CHECK_OP
(
Check_NE
, !=, v®1, v®2)

	)

255 
	#CHECK_LE
(
v®1
, 
v®2
è
	`CHECK_OP
(
Check_LE
, <=, v®1, v®2)

	)

257 
	#CHECK_LT
(
v®1
, 
v®2
è
	`CHECK_OP
(
Check_LT
, <, v®1, v®2)

	)

259 
	#CHECK_GE
(
v®1
, 
v®2
è
	`CHECK_OP
(
Check_GE
, >=, v®1, v®2)

	)

261 
	#CHECK_GT
(
v®1
, 
v®2
è
	`CHECK_OP
(
Check_GT
, >, v®1, v®2)

	)

278 
	#CHECK_NOTNULL
(
v®
) \

279 
asylo
::
	`CheckNÙNuÎ
(
__FILE__
, 
__LINE__
, "'" #v® "' Mu¡ bnÚ NULL", (
v®
))

	)

286 
	`£t_vlog_Ëv–
(
Ëv–
);

292 
	`g‘_vlog_Ëv–
();

299 
boŞ
 
	`£t_log_dœeùÜy
(cÚ¡ 
¡d
::
¡ršg
 &
log_dœeùÜy
);

304 cÚ¡ 
¡d
::
¡ršg
 
	`g‘_log_dœeùÜy
();

310 
boŞ
 
	`Ensu»DœeùÜy
(cÚ¡ *
·th
);

324 
boŞ
 
	`In™Loggšg
(cÚ¡ *
dœeùÜy
, cÚ¡ *
fe_Çme
, 
Ëv–
);

327 şas 
	cLogMes§ge
 {

328 
public
:

333 
	`LogMes§ge
(cÚ¡ *
fe
, 
lše
);

340 
	`LogMes§ge
(cÚ¡ *
fe
, 
lše
, 
LogSev”™y
 
£v”™y
);

348 
	`LogMes§ge
(cÚ¡ *
fe
, 
lše
, cÚ¡ 
¡d
::
¡ršg
 &
»suÉ
);

351 ~
	`LogMes§ge
();

356 
¡d
::
o¡ršg¡»am
 &
	`¡»am
(è{  
¡»am_
; }

358 
´iv©e
:

359 
	`In™
(cÚ¡ *
fe
, 
lše
, 
LogSev”™y
 
£v”™y
);

362 
	`S’dToLog
(cÚ¡ 
¡d
::
¡ršg
 &
mes§ge_‹xt
);

366 
¡d
::
o¡ršg¡»am
 
¡»am_
;

367 
LogSev”™y
 
£v”™y_
;

369 
	`LogMes§ge
(cÚ¡ 
LogMes§ge
 &èğ
d–‘e
;

370 
İ”©Ü
=(cÚ¡ 
LogMes§ge
 &èğ
d–‘e
;

371 
	}
};

377 şas 
	cLogMes§geVoidify
 {

378 
	gpublic
:

379 
İ”©Ü
&(cÚ¡ 
¡d
::
o¡»am
 &) {}

383 şas 
	cLogMes§geF©®
 : 
public
 
LogMes§ge
 {

384 
public
:

389 
LogMes§geF©®
(cÚ¡ *
fe
, 
lše
è: 
LogMes§ge
(fe,†še, 
FATAL
) {}

395 
LogMes§geF©®
(cÚ¡ *
fe
, 
lše
, cÚ¡ 
¡d
::
¡ršg
 &
»suÉ
)

396 : 
LogMes§ge
(
fe
, 
lše
, 
»suÉ
) {}

415 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

416 
T
 
	$CheckNÙNuÎ
(cÚ¡ *
fe
, 
lše
, cÚ¡ *
ex´‹xt
, 
T
 &&
t
) {

417 ià(
	`ABSL_PREDICT_FALSE
(!
t
)) {

418 
	`LogMes§ge
(
fe
, 
lše
, 
¡d
::
	`¡ršg
(
ex´‹xt
));

420  
¡d
::
fÜw¬d
<
T
>(
t
);

421 
	}
}

	@util/mutex_guarded.h

19 #iâdeà
ASYLO_UTIL_MUTEX_GUARDED_H_


20 
	#ASYLO_UTIL_MUTEX_GUARDED_H_


	)

22 
	~<ÿs£¹
>

23 
	~<funùiÚ®
>

24 
	~<ty³_Œa™s
>

25 
	~<ut™y
>

27 
	~"ab¦/ba£/cÚ¡_š™.h
"

28 
	~"ab¦/ba£/th»ad_ªnÙ©iÚs.h
"

29 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

30 
	~"ab¦/time/time.h
"

31 
	~"ab¦/ty³s/İtiÚ®.h
"

33 
Çme¥aû
 
	gasylo
 {

35 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

36 
şass
 
	gLockV›w
;

38 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

39 
şass
 
	gR—d”LockV›w
;

157 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

158 şas 
	cMu‹xGu¬ded
 {

159 
¡©ic_as£¹
(
¡d
::
is_move_cÚ¡ruùibË
<
T
>::
v®ue
,

162 
	gpublic
:

163 
Mu‹xGu¬ded
(èğ
d–‘e
;

166 
ex¶ic™
 
Mu‹xGu¬ded
(
T
 
v®ue
è: 
v®ue_
(
¡d
::
fÜw¬d
<T>(value)) {}

170 
Mu‹xGu¬ded
(
T
 
v®ue
, 
ab¦
::
CÚ¡In™Ty³
 
cÚ¡_š™
)

171 : 
mu_
(
cÚ¡_š™
), 
v®ue_
(
¡d
::
fÜw¬d
<
T
>(
v®ue
)) {}

173 
Mu‹xGu¬ded
(cÚ¡ Mu‹xGu¬ded &
Ùh”
èğ
d–‘e
;

174 
	gMu‹xGu¬ded
 &
	gİ”©Ü
=(cÚ¡ 
Mu‹xGu¬ded
 &
Ùh”
èğ
d–‘e
;

182 
Mu‹xGu¬ded
(Mu‹xGu¬ded &&
Ùh”
è: 
v®ue_
(Ùh”.
R–—£
()) {}

186 
Mu‹xGu¬ded
 &
İ”©Ü
=(Mu‹xGu¬ded &&
Ùh”
è
LOCKS_EXCLUDED
(
mu_
) {

187 
ab¦
::
Mu‹xLock
 
lock
(&
mu_
);

188 
	gv®ue_
 = 
Ùh”
.
R–—£
();

189  *
	gthis
;

194 
	gT
 &&
R–—£
(è
LOCKS_EXCLUDED
(
mu_
) {

195 
	gab¦
::
Mu‹xLock
 
lock
(&
mu_
);

196  
	g¡d
::
move
(
v®ue_
);

201 
	gLockV›w
<
	gT
> 
Lock
(è
LOCKS_EXCLUDED
(
mu_
) {

202 
	gmu_
.
Lock
();

203  
	gLockV›w
<
	gT
>(&
	gmu_
, &
	gv®ue_
);

208 
	gR—d”LockV›w
<
	gT
> 
R—d”Lock
(ècÚ¡ 
LOCKS_EXCLUDED
(
mu_
) {

209 
	gmu_
.
R—d”Lock
();

210  
	gR—d”LockV›w
<
	gT
>(&
	gmu_
, &
	gv®ue_
);

215 
	gab¦
::
İtiÚ®
<
LockV›w
<
T
>> 
TryLock
(è
LOCKS_EXCLUDED
(
mu_
) {

216 ià(
mu_
.
TryLock
()) {

217  
LockV›w
<
T
>(&
mu_
, &
	gv®ue_
);

219  
	gab¦
::
nuÎİt
;

225 
	gab¦
::
İtiÚ®
<
R—d”LockV›w
<
T
>> 
R—d”TryLock
(ècÚ¡ 
LOCKS_EXCLUDED
(
mu_
) {

226 ià(
mu_
.
R—d”TryLock
()) {

227  
R—d”LockV›w
<
T
>(&
mu_
, &
	gv®ue_
);

229  
	gab¦
::
nuÎİt
;

235 
As£¹H–d
(ècÚ¡ { 
	gmu_
.AssertHeld(); }

240 
As£¹R—d”H–d
(ècÚ¡ { 
	gmu_
.AssertReaderHeld(); }

245 
	gLockV›w
<
	gT
> 
LockWh’
(
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
)

246 
LOCKS_EXCLUDED
(
mu_
) {

247 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(
v®ue_
); };

248 
	gmu_
.
LockWh’
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
));

249  
	gLockV›w
<
	gT
>(&
	gmu_
, &
	gv®ue_
);

255 
	gR—d”LockV›w
<
	gT
> 
R—d”LockWh’
(
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
) const

256 
LOCKS_EXCLUDED
(
mu_
) {

257 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(
v®ue_
); };

258 
	gmu_
.
R—d”LockWh’
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
));

259  
	gR—d”LockV›w
<
	gT
>(&
	gmu_
, &
	gv®ue_
);

273 
	g¡d
::
·œ
<
boŞ
, 
	gLockV›w
<
	gT
>> 
LockWh’W™hTimeout
(

274 
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
, 
ab¦
::
Du¿tiÚ
 
timeout
)

275 
LOCKS_EXCLUDED
(
mu_
) {

276 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(
v®ue_
); };

277 
boŞ
 
	gcÚd_is_Œue
 =

278 
mu_
.
LockWh’W™hTimeout
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
), 
timeout
);

279  
	g¡d
::
make_·œ
(
cÚd_is_Œue
, 
LockV›w
<
T
>(&
mu_
, &
v®ue_
));

293 
	g¡d
::
·œ
<
boŞ
, 
	gR—d”LockV›w
<
	gT
>> 
R—d”LockWh’W™hTimeout
(

294 
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
, 
ab¦
::
Du¿tiÚ
 
timeout
) const

295 
LOCKS_EXCLUDED
(
mu_
) {

296 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(
v®ue_
); };

297 
boŞ
 
	gcÚd_is_Œue
 = 
mu_
.
R—d”LockWh’W™hTimeout
(

298 
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
), 
timeout
);

299  
	g¡d
::
make_·œ
(
cÚd_is_Œue
, 
R—d”LockV›w
<
T
>(&
mu_
, &
v®ue_
));

303 
	g¡d
::
·œ
<
boŞ
, 
	gLockV›w
<
	gT
>> 
LockWh’W™hD—dlše
(

304 
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
, 
ab¦
::
Time
 
d—dlše
)

305 
LOCKS_EXCLUDED
(
mu_
) {

306 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(
v®ue_
); };

307 
boŞ
 
	gcÚd_is_Œue
 = 
mu_
.
LockWh’W™hD—dlše
(

308 
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
), 
d—dlše
);

309  
	g¡d
::
make_·œ
(
cÚd_is_Œue
, 
LockV›w
<
T
>(&
mu_
, &
v®ue_
));

313 
	g¡d
::
·œ
<
boŞ
, 
	gR—d”LockV›w
<
	gT
>> 
R—d”LockWh’W™hD—dlše
(

314 
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
, 
ab¦
::
Time
 
d—dlše
) const

315 
LOCKS_EXCLUDED
(
mu_
) {

316 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(
v®ue_
); };

317 
boŞ
 
	gcÚd_is_Œue
 = 
mu_
.
R—d”LockWh’W™hD—dlše
(

318 
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
), 
d—dlše
);

319  
	g¡d
::
make_·œ
(
cÚd_is_Œue
, 
R—d”LockV›w
<
T
>(&
mu_
, &
v®ue_
));

322 
	g´iv©e
:

323 
mubË
 
ab¦
::
Mu‹x
 
mu_
;

324 
T
 
v®ue_
 
GUARDED_BY
(
mu_
);

330 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

331 şas 
	cLockV›w
 {

332 
	gpublic
:

333 
LockV›w
(èğ
d–‘e
;

335 
LockV›w
(cÚ¡ LockV›w &
Ùh”
èğ
d–‘e
;

336 
	gLockV›w
 &
	gİ”©Ü
=(cÚ¡ 
LockV›w
 &
Ùh”
èğ
d–‘e
;

343 
LockV›w
(LockV›w &&
Ùh”
è: 
mu_
(Ùh”.mu_), 
v®ue_
(other.value_) {

344 
	gÙh”
.
CË¬
();

347 
	gLockV›w
 &
	gİ”©Ü
=(
LockV›w
 &&
Ùh”
) {

348 ià(&
Ùh”
 !ğ
this
) {

350 ià(
mu_
 !ğ
nuÎ±r
) {

351 
mu_
->
Wr™”UÆock
();

354 
	gmu_
 = 
Ùh”
.
mu_
;

355 
	gv®ue_
 = 
Ùh”
.
v®ue_
;

357 
	gÙh”
.
CË¬
();

359  *
	gthis
;

362 ~
LockV›w
() {

363 ià(
	gmu_
 !ğ
nuÎ±r
) {

364 
mu_
->
Wr™”UÆock
();

368 
	gT
 &
	gİ”©Ü
*(è{  *
	gv®ue_
; }

370 
T
 *
	gİ”©Ü
->(è{  
	gv®ue_
; }

374 
Awa™
(
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
) {

375 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(*
v®ue_
); };

376 
	gmu_
->
Awa™
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
));

387 
boŞ
 
Awa™W™hTimeout
(
¡d
::
funùiÚ
<boŞ(cÚ¡ 
T
 &)> 
cÚd
,

388 
ab¦
::
Du¿tiÚ
 
timeout
) {

389 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(*
v®ue_
); };

390  
	gmu_
->
Awa™W™hTimeout
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
), 
timeout
);

394 
boŞ
 
Awa™W™hD—dlše
(
¡d
::
funùiÚ
<boŞ(cÚ¡ 
T
 &)> 
cÚd
,

395 
ab¦
::
Time
 
d—dlše
) {

396 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(*
v®ue_
); };

397  
	gmu_
->
Awa™W™hD—dlše
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
),

398 
d—dlše
);

401 
	g´Ùeùed
:

402 
‹m¶©e
 <
ty³Çme
 
U
>

403 
ä›nd
 
şass
 
Mu‹xGu¬ded
;

405 
LockV›w
(
ab¦
::
Mu‹x
 *
mu
, 
T
 *
v®ue
è: 
mu_
(mu), 
v®ue_
(value) {}

407 
	g´iv©e
:

409 
CË¬
() {

410 
mu_
 = 
nuÎ±r
;

411 
	gv®ue_
 = 
nuÎ±r
;

414 
	gab¦
::
Mu‹x
 *
mu_
;

415 
T
 *
	gv®ue_
;

421 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

422 şas 
	cR—d”LockV›w
 {

423 
	gpublic
:

424 
R—d”LockV›w
(èğ
d–‘e
;

426 
R—d”LockV›w
(cÚ¡ R—d”LockV›w &
Ùh”
èğ
d–‘e
;

427 
	gR—d”LockV›w
 &
	gİ”©Ü
=(cÚ¡ 
R—d”LockV›w
 &
Ùh”
èğ
d–‘e
;

434 
R—d”LockV›w
(R—d”LockV›w &&
Ùh”
)

435 : 
mu_
(
Ùh”
.mu_), 
v®ue_
(other.value_) {

436 
	gÙh”
.
CË¬
();

439 
	gR—d”LockV›w
 &
	gİ”©Ü
=(
R—d”LockV›w
 &&
Ùh”
) {

440 ià(&
Ùh”
 !ğ
this
) {

442 ià(
mu_
 !ğ
nuÎ±r
) {

443 
mu_
->
R—d”UÆock
();

446 
	gmu_
 = 
Ùh”
.
mu_
;

447 
	gv®ue_
 = 
Ùh”
.
v®ue_
;

449 
	gÙh”
.
CË¬
();

451  *
	gthis
;

454 ~
R—d”LockV›w
() {

455 ià(
	gmu_
 !ğ
nuÎ±r
) {

456 
mu_
->
R—d”UÆock
();

460 cÚ¡ 
	gT
 &
	gİ”©Ü
*(ècÚ¡ {  *
	gv®ue_
; }

462 cÚ¡ 
T
 *
	gİ”©Ü
->(ècÚ¡ {  
	gv®ue_
; }

466 
Awa™
(
¡d
::
funùiÚ
<
boŞ
(cÚ¡ 
T
 &)> 
cÚd
) {

467 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(*
v®ue_
); };

468 
	gmu_
->
Awa™
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
));

479 
boŞ
 
Awa™W™hTimeout
(
¡d
::
funùiÚ
<boŞ(cÚ¡ 
T
 &)> 
cÚd
,

480 
ab¦
::
Du¿tiÚ
 
timeout
) {

481 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(*
v®ue_
); };

482  
	gmu_
->
Awa™W™hTimeout
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
), 
timeout
);

486 
boŞ
 
Awa™W™hD—dlše
(
¡d
::
funùiÚ
<boŞ(cÚ¡ 
T
 &)> 
cÚd
,

487 
ab¦
::
Time
 
d—dlše
) {

488 autØ
cÚd™iÚ_funùiÚ
 = [
this
, 
cÚd
] {  cÚd(*
v®ue_
); };

489  
	gmu_
->
Awa™W™hD—dlše
(
ab¦
::
CÚd™iÚ
(&
cÚd™iÚ_funùiÚ
),

490 
d—dlše
);

493 
	g´Ùeùed
:

494 
‹m¶©e
 <
ty³Çme
 
U
>

495 
ä›nd
 
şass
 
Mu‹xGu¬ded
;

497 
R—d”LockV›w
(
ab¦
::
Mu‹x
 *
mu
, cÚ¡ 
T
 *
v®ue
è: 
mu_
(mu), 
v®ue_
(value) {}

499 
	g´iv©e
:

501 
CË¬
() {

502 
mu_
 = 
nuÎ±r
;

503 
	gv®ue_
 = 
nuÎ±r
;

506 
	gab¦
::
Mu‹x
 *
mu_
;

507 cÚ¡ 
T
 *
	gv®ue_
;

	@util/mutex_guarded_test.cc

19 
	~"asylo/ut/mu‹x_gu¬ded.h
"

21 
	~<memÜy
>

22 
	~<th»ad
>

23 
	~<ut™y
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"ab¦/synchrÚiz©iÚ/b¬r›r.h
"

30 
	~"ab¦/synchrÚiz©iÚ/nÙifiÿtiÚ.h
"

31 
	~"ab¦/time/time.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gusšg
 ::
‹¡šg
::
Eq
;

37 
	gusšg
 ::
‹¡šg
::
Gt
;

38 
	gusšg
 ::
‹¡šg
::
Ne
;

40 
cÚ¡ex´
 
	gkNumTh»ads
 = 100;

41 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kLÚgEnoughFÜTh»adSw™ch
 = 
ab¦
::
Mli£cÚds
(500);

43 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dR—d”LocksDoNÙP»v’tAcquœšgOth”R—d”Locks
) {

44 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

45 
	gab¦
::
B¬r›r
 
b¬r›r
(
kNumTh»ads
);

47 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

48 
	gth»ads
.
»£rve
(
kNumTh»ads
);

49 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

50 
	gth»ads
.
em¶aû_back
([&
b¬r›r
, &
§ã_št
] {

51 autØ
maybe_»adabË_v›w
 = 
§ã_št
.
R—d”TryLock
();

52 
ASSERT_THAT
(
maybe_»adabË_v›w
, 
Ne
(
ab¦
::
nuÎİt
));

53 
b¬r›r
.
Block
();

57 autØ&
	gth»ad
 : 
th»ads
) {

58 
th»ad
.
još
();

62 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dWr™”LocksP»v’tAcquœšgOth”Wr™”Locks
) {

63 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kWa™FÜSomeTh»adToAcquœeLock
 =

64 
ab¦
::
SecÚds
(10);

66 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

67 
	gab¦
::
B¬r›r
 
b¬r›r
(
kNumTh»ads
);

68 
	gab¦
::
NÙifiÿtiÚ
 
some_th»ad_acquœed_lock
;

70 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

71 
	gth»ads
.
»£rve
(
kNumTh»ads
);

72 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

73 
	gth»ads
.
em¶aû_back
([&
b¬r›r
, &
§ã_št
, &
some_th»ad_acquœed_lock
] {

74 autØ
maybe_wr™”_v›w
 = 
§ã_št
.
TryLock
();

75 ià(
maybe_wr™”_v›w
.
has_v®ue
()) {

76 
some_th»ad_acquœed_lock
.
NÙify
();

78 
ASSERT_TRUE
(
some_th»ad_acquœed_lock
.
Wa™FÜNÙifiÿtiÚW™hTimeout
(

79 
kWa™FÜSomeTh»adToAcquœeLock
));

81 
b¬r›r
.
Block
();

85 autØ&
	gth»ad
 : 
th»ads
) {

86 
th»ad
.
još
();

90 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dR—d”LocksP»v’tAcquœšgWr™”Locks
) {

91 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

93 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

95 
	g¡d
::
th»ad
 
Œy_wr™”_lock_th»ad
(

96 [&
§ã_št
] { 
EXPECT_THAT
(§ã_št.
TryLock
(), 
Eq
(
ab¦
::
nuÎİt
)); });

97 
	gŒy_wr™”_lock_th»ad
.
još
();

100 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dWr™”LocksP»v’tAcquœšgR—d”Locks
) {

101 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

103 autØ
	gwr™—bË_v›w
 = 
§ã_št
.
Lock
();

105 
	g¡d
::
th»ad
 
Œy_»ad”_lock_th»ad
([&
§ã_št
] {

106 
EXPECT_THAT
(
§ã_št
.
R—d”TryLock
(), 
Eq
(
ab¦
::
nuÎİt
));

108 
	gŒy_»ad”_lock_th»ad
.
još
();

111 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esFromAÎTh»adsA»VisibËFromL©”R—ds
) {

112 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

114 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

115 
	gth»ads
.
»£rve
(
kNumTh»ads
);

116 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

117 
	gth»ads
.
em¶aû_back
([&
§ã_št
](è{ ++*§ã_št.
Lock
(); });

120 autØ&
	gth»ad
 : 
th»ads
) {

121 
th»ad
.
još
();

124 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(
kNumTh»ads
));

127 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esFromAÎTh»adsA»VisibËFromAL©”R–—£
) {

128 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

130 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

131 
	gth»ads
.
»£rve
(
kNumTh»ads
);

132 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

133 
	gth»ads
.
em¶aû_back
([&
§ã_št
](è{ ++*§ã_št.
Lock
(); });

136 autØ&
	gth»ad
 : 
th»ads
) {

137 
th»ad
.
još
();

140 
EXPECT_THAT
(
§ã_št
.
R–—£
(), 
Eq
(
kNumTh»ads
));

143 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esA»VisibËToR—dsAá”MoveCÚ¡ruùiÚ
) {

144 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št
(
ab¦
::
make_unique
<>(0));

145 **
	g§ã_št
.
Lock
() = 5;

147 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št_move
(
¡d
::
move
(
§ã_št
));

148 
EXPECT_THAT
(**
§ã_št_move
.
R—d”Lock
(), 
Eq
(5));

151 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esA»VisibËToR—dsAá”MoveAssignm’t
) {

152 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št
(
ab¦
::
make_unique
<>(0));

153 **
	g§ã_št
.
Lock
() = 5;

155 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št_move
 = 
¡d
::
move
(
§ã_št
);

156 
EXPECT_THAT
(**
§ã_št_move
.
R—d”Lock
(), 
Eq
(5));

159 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockedV›wObjeùsCªBeMoveCÚ¡ruùedSaãly
) {

160 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

163 autØ
	gwr™—bË_v›w
 = 
§ã_št
.
Lock
();

164 autØ
wr™—bË_v›w_move
(
¡d
::
move
(
wr™—bË_v›w
));

165 *
	gwr™—bË_v›w_move
 = 5;

168 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(5));

171 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockedV›wObjeùsCªBeMoveAssigÃdSaãly
) {

172 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

175 autØ
	gwr™—bË_v›w
 = 
§ã_št
.
Lock
();

176 autØ
	gwr™—bË_v›w_move
 = 
¡d
::
move
(
wr™—bË_v›w
);

177 *
	gwr™—bË_v›w_move
 = 5;

180 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(5));

183 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockedV›wObjeùsCªBeMoveCÚ¡ruùedSaãly
) {

184 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

185 *
	g§ã_št
.
Lock
() = 5;

187 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

188 autØ
»adabË_v›w_move
(
¡d
::
move
(
»adabË_v›w
));

189 
EXPECT_THAT
(*
»adabË_v›w_move
, 
Eq
(5));

192 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockedV›wObjeùsCªBeMoveAssigÃdSaãly
) {

193 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

194 *
	g§ã_št
.
Lock
() = 5;

196 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

197 autØ
	g»adabË_v›w_move
 = 
¡d
::
move
(
»adabË_v›w
);

198 
EXPECT_THAT
(*
»adabË_v›w_move
, 
Eq
(5));

201 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockWh’LocksAá”CÚd™iÚIsTrue
) {

202 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

204 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

205 
	gth»ads
.
»£rve
(
kNumTh»ads
);

206 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

207 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

208 ++*
§ã_št
.
LockWh’
([
i
](
v®ue
) {  value == i; });

212 autØ&
	gth»ad
 : 
th»ads
) {

213 
th»ad
.
još
();

216 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(
kNumTh»ads
));

219 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockWh’LocksAá”CÚd™iÚIsTrue
) {

220 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

222 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

223 
	gth»ads
.
»£rve
(
kNumTh»ads
);

224 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

225 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

226 
EXPECT_THAT
(

227 *
§ã_št
.
R—d”LockWh’
([
i
](
v®ue
) {  value > i; }),

228 
Gt
(
i
));

232 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

233 ++*
	g§ã_št
.
Lock
();

236 autØ&
	gth»ad
 : 
th»ads
) {

237 
th»ad
.
još
();

241 
TEST
(
Mu‹xGu¬dedTe¡
,

242 
LockWh’W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

243 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

245 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

246 autØ
lock_wh’_·œ
 = 
§ã_št
.
LockWh’W™hTimeout
(

247 [](
v®ue
è{  v®u=ğ0; }, 
kLÚgEnoughFÜTh»adSw™ch
);

248 
EXPECT_TRUE
(
lock_wh’_·œ
.
fœ¡
);

249 ++*
lock_wh’_·œ
.
£cÚd
;

252 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

253 autØ
lock_wh’_·œ
 = 
§ã_št
.
LockWh’W™hTimeout
(

254 [](
v®ue
è{  v®u=ğ50; }, 
kLÚgEnoughFÜTh»adSw™ch
);

255 
EXPECT_FALSE
(
lock_wh’_·œ
.
fœ¡
);

256 ++*
lock_wh’_·œ
.
£cÚd
;

259 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

260 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

262 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

265 
TEST
(
Mu‹xGu¬dedTe¡
,

266 
R—d”LockWh’W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

267 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

269 
EXPECT_FALSE
(

270 
§ã_št


271 .
R—d”LockWh’W™hTimeout
([](
v®ue
) {  value > 0; },

272 
kLÚgEnoughFÜTh»adSw™ch
)

273 .
fœ¡
);

274 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(0));

276 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

277 
EXPECT_TRUE
(

278 
§ã_št


279 .
R—d”LockWh’W™hTimeout
([](
v®ue
) {  value > 0; },

280 
kLÚgEnoughFÜTh»adSw™ch
)

281 .
fœ¡
);

282 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(1));

284 
	gšüem’t_§ã_št
.
još
();

287 
TEST
(
Mu‹xGu¬dedTe¡
,

288 
LockWh’W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

289 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

291 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

292 autØ
lock_wh’_·œ
 =

293 
§ã_št
.
LockWh’W™hD—dlše
([](
v®ue
) {  value == 0; },

294 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
);

295 
EXPECT_TRUE
(
lock_wh’_·œ
.
fœ¡
);

296 ++*
lock_wh’_·œ
.
£cÚd
;

299 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

300 autØ
lock_wh’_·œ
 =

301 
§ã_št
.
LockWh’W™hD—dlše
([](
v®ue
) {  value == 50; },

302 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
);

303 
EXPECT_FALSE
(
lock_wh’_·œ
.
fœ¡
);

304 ++*
lock_wh’_·œ
.
£cÚd
;

307 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

308 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

310 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

313 
TEST
(
Mu‹xGu¬dedTe¡
,

314 
R—d”LockWh’W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

315 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

317 
EXPECT_FALSE
(

318 
§ã_št


319 .
R—d”LockWh’W™hD—dlše
([](
v®ue
) {  value > 0; },

320 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
)

321 .
fœ¡
);

322 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(0));

324 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

325 
EXPECT_TRUE
(

326 
§ã_št


327 .
R—d”LockWh’W™hD—dlše
([](
v®ue
) {  value > 0; },

328 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
)

329 .
fœ¡
);

330 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(1));

332 
	gšüem’t_§ã_št
.
još
();

335 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockV›wAwa™LocksAá”CÚd™iÚIsTrue
) {

336 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

338 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

339 
	gth»ads
.
»£rve
(
kNumTh»ads
);

340 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

341 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

342 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

343 
wr™—bË_v›w
.
Awa™
([
i
](
v®ue
) {  value == i; });

344 ++*
wr™—bË_v›w
;

348 autØ&
	gth»ad
 : 
th»ads
) {

349 
th»ad
.
još
();

352 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(
kNumTh»ads
));

355 
TEST
(
Mu‹xGu¬dedTe¡
,

356 
LockV›wAwa™W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

357 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

359 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

360 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

361 
EXPECT_TRUE
(
wr™—bË_v›w
.
Awa™W™hTimeout
(

362 [](
v®ue
è{  v®u=ğ0; }, 
kLÚgEnoughFÜTh»adSw™ch
));

363 ++*
wr™—bË_v›w
;

366 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

367 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

368 
EXPECT_FALSE
(
wr™—bË_v›w
.
Awa™W™hTimeout
(

369 [](
v®ue
è{  v®u=ğ50; }, 
kLÚgEnoughFÜTh»adSw™ch
));

370 ++*
wr™—bË_v›w
;

373 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

374 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

376 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

379 
TEST
(
Mu‹xGu¬dedTe¡
,

380 
LockV›wAwa™W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

381 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

383 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

384 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

385 
EXPECT_TRUE
(
wr™—bË_v›w
.
Awa™W™hD—dlše
(

386 [](
v®ue
) {  value == 0; },

387 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

388 ++*
wr™—bË_v›w
;

391 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

392 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

393 
EXPECT_FALSE
(
wr™—bË_v›w
.
Awa™W™hD—dlše
(

394 [](
v®ue
) {  value == 50; },

395 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

396 ++*
wr™—bË_v›w
;

399 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

400 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

402 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

405 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockV›wAwa™LocksAá”CÚd™iÚIsTrue
) {

406 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

408 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

409 
	gth»ads
.
»£rve
(
kNumTh»ads
);

410 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

411 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

412 autØ
»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

413 
»adabË_v›w
.
Awa™
([
i
](
v®ue
) {  value > i; });

414 
EXPECT_THAT
(*
»adabË_v›w
, 
Gt
(
i
));

418 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

419 ++*
	g§ã_št
.
Lock
();

422 autØ&
	gth»ad
 : 
th»ads
) {

423 
th»ad
.
još
();

427 
TEST
(
Mu‹xGu¬dedTe¡
,

428 
R—d”LockV›wAwa™W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

429 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

432 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

433 
EXPECT_FALSE
(
»adabË_v›w
.
Awa™W™hTimeout
(

434 [](
v®ue
è{  v®u> 0; }, 
kLÚgEnoughFÜTh»adSw™ch
));

435 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(0));

438 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

441 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

442 
EXPECT_TRUE
(
»adabË_v›w
.
Awa™W™hTimeout
(

443 [](
v®ue
è{  v®u> 0; }, 
kLÚgEnoughFÜTh»adSw™ch
));

444 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(1));

447 
	gšüem’t_§ã_št
.
još
();

450 
TEST
(
Mu‹xGu¬dedTe¡
,

451 
R—d”LockV›wAwa™W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

452 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

455 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

456 
EXPECT_FALSE
(
»adabË_v›w
.
Awa™W™hD—dlše
(

457 [](
v®ue
) {  value > 0; },

458 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

459 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(0));

462 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

465 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

466 
EXPECT_TRUE
(
»adabË_v›w
.
Awa™W™hD—dlše
(

467 [](
v®ue
) {  value > 0; },

468 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

469 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(1));

472 
	gšüem’t_§ã_št
.
još
();

475 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockšgSŒessTe¡
) {

476 
cÚ¡ex´
 
	gkNumInüem’tsP”Th»ad
 = 10000;

478 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

480 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

481 
	gth»ads
.
»£rve
(
kNumTh»ads
);

482 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

483 
	gth»ads
.
em¶aû_back
([&
§ã_št
] {

484 
j
 = 0; j < 
kNumInüem’tsP”Th»ad
; j++) {

485 ++*
§ã_št
.
Lock
();

490 autØ&
	gth»ad
 : 
th»ads
) {

491 
th»ad
.
još
();

494 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(),

495 
Eq
(
kNumTh»ads
 * 
kNumInüem’tsP”Th»ad
));

	@util/mutex_guarded_test.cc

19 
	~"asylo/ut/mu‹x_gu¬ded.h
"

21 
	~<memÜy
>

22 
	~<th»ad
>

23 
	~<ut™y
>

24 
	~<veùÜ
>

26 
	~<gmock/gmock.h
>

27 
	~<g‹¡/g‹¡.h
>

28 
	~"ab¦/memÜy/memÜy.h
"

29 
	~"ab¦/synchrÚiz©iÚ/b¬r›r.h
"

30 
	~"ab¦/synchrÚiz©iÚ/nÙifiÿtiÚ.h
"

31 
	~"ab¦/time/time.h
"

33 
Çme¥aû
 
	gasylo
 {

34 
	gÇme¥aû
 {

36 
	gusšg
 ::
‹¡šg
::
Eq
;

37 
	gusšg
 ::
‹¡šg
::
Gt
;

38 
	gusšg
 ::
‹¡šg
::
Ne
;

40 
cÚ¡ex´
 
	gkNumTh»ads
 = 100;

41 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kLÚgEnoughFÜTh»adSw™ch
 = 
ab¦
::
Mli£cÚds
(500);

43 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dR—d”LocksDoNÙP»v’tAcquœšgOth”R—d”Locks
) {

44 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

45 
	gab¦
::
B¬r›r
 
b¬r›r
(
kNumTh»ads
);

47 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

48 
	gth»ads
.
»£rve
(
kNumTh»ads
);

49 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

50 
	gth»ads
.
em¶aû_back
([&
b¬r›r
, &
§ã_št
] {

51 autØ
maybe_»adabË_v›w
 = 
§ã_št
.
R—d”TryLock
();

52 
ASSERT_THAT
(
maybe_»adabË_v›w
, 
Ne
(
ab¦
::
nuÎİt
));

53 
b¬r›r
.
Block
();

57 autØ&
	gth»ad
 : 
th»ads
) {

58 
th»ad
.
još
();

62 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dWr™”LocksP»v’tAcquœšgOth”Wr™”Locks
) {

63 
cÚ¡ex´
 
	gab¦
::
Du¿tiÚ
 
kWa™FÜSomeTh»adToAcquœeLock
 =

64 
ab¦
::
SecÚds
(10);

66 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

67 
	gab¦
::
B¬r›r
 
b¬r›r
(
kNumTh»ads
);

68 
	gab¦
::
NÙifiÿtiÚ
 
some_th»ad_acquœed_lock
;

70 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

71 
	gth»ads
.
»£rve
(
kNumTh»ads
);

72 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

73 
	gth»ads
.
em¶aû_back
([&
b¬r›r
, &
§ã_št
, &
some_th»ad_acquœed_lock
] {

74 autØ
maybe_wr™”_v›w
 = 
§ã_št
.
TryLock
();

75 ià(
maybe_wr™”_v›w
.
has_v®ue
()) {

76 
some_th»ad_acquœed_lock
.
NÙify
();

78 
ASSERT_TRUE
(
some_th»ad_acquœed_lock
.
Wa™FÜNÙifiÿtiÚW™hTimeout
(

79 
kWa™FÜSomeTh»adToAcquœeLock
));

81 
b¬r›r
.
Block
();

85 autØ&
	gth»ad
 : 
th»ads
) {

86 
th»ad
.
još
();

90 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dR—d”LocksP»v’tAcquœšgWr™”Locks
) {

91 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

93 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

95 
	g¡d
::
th»ad
 
Œy_wr™”_lock_th»ad
(

96 [&
§ã_št
] { 
EXPECT_THAT
(§ã_št.
TryLock
(), 
Eq
(
ab¦
::
nuÎİt
)); });

97 
	gŒy_wr™”_lock_th»ad
.
još
();

100 
TEST
(
Mu‹xGu¬dedTe¡
, 
H–dWr™”LocksP»v’tAcquœšgR—d”Locks
) {

101 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

103 autØ
	gwr™—bË_v›w
 = 
§ã_št
.
Lock
();

105 
	g¡d
::
th»ad
 
Œy_»ad”_lock_th»ad
([&
§ã_št
] {

106 
EXPECT_THAT
(
§ã_št
.
R—d”TryLock
(), 
Eq
(
ab¦
::
nuÎİt
));

108 
	gŒy_»ad”_lock_th»ad
.
još
();

111 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esFromAÎTh»adsA»VisibËFromL©”R—ds
) {

112 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

114 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

115 
	gth»ads
.
»£rve
(
kNumTh»ads
);

116 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

117 
	gth»ads
.
em¶aû_back
([&
§ã_št
](è{ ++*§ã_št.
Lock
(); });

120 autØ&
	gth»ad
 : 
th»ads
) {

121 
th»ad
.
još
();

124 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(
kNumTh»ads
));

127 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esFromAÎTh»adsA»VisibËFromAL©”R–—£
) {

128 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

130 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

131 
	gth»ads
.
»£rve
(
kNumTh»ads
);

132 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

133 
	gth»ads
.
em¶aû_back
([&
§ã_št
](è{ ++*§ã_št.
Lock
(); });

136 autØ&
	gth»ad
 : 
th»ads
) {

137 
th»ad
.
još
();

140 
EXPECT_THAT
(
§ã_št
.
R–—£
(), 
Eq
(
kNumTh»ads
));

143 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esA»VisibËToR—dsAá”MoveCÚ¡ruùiÚ
) {

144 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št
(
ab¦
::
make_unique
<>(0));

145 **
	g§ã_št
.
Lock
() = 5;

147 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št_move
(
¡d
::
move
(
§ã_št
));

148 
EXPECT_THAT
(**
§ã_št_move
.
R—d”Lock
(), 
Eq
(5));

151 
TEST
(
Mu‹xGu¬dedTe¡
, 
Wr™esA»VisibËToR—dsAá”MoveAssignm’t
) {

152 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št
(
ab¦
::
make_unique
<>(0));

153 **
	g§ã_št
.
Lock
() = 5;

155 
	gMu‹xGu¬ded
<
	g¡d
::
unique_±r
<>> 
§ã_št_move
 = 
¡d
::
move
(
§ã_št
);

156 
EXPECT_THAT
(**
§ã_št_move
.
R—d”Lock
(), 
Eq
(5));

159 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockedV›wObjeùsCªBeMoveCÚ¡ruùedSaãly
) {

160 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

163 autØ
	gwr™—bË_v›w
 = 
§ã_št
.
Lock
();

164 autØ
wr™—bË_v›w_move
(
¡d
::
move
(
wr™—bË_v›w
));

165 *
	gwr™—bË_v›w_move
 = 5;

168 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(5));

171 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockedV›wObjeùsCªBeMoveAssigÃdSaãly
) {

172 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

175 autØ
	gwr™—bË_v›w
 = 
§ã_št
.
Lock
();

176 autØ
	gwr™—bË_v›w_move
 = 
¡d
::
move
(
wr™—bË_v›w
);

177 *
	gwr™—bË_v›w_move
 = 5;

180 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(5));

183 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockedV›wObjeùsCªBeMoveCÚ¡ruùedSaãly
) {

184 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

185 *
	g§ã_št
.
Lock
() = 5;

187 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

188 autØ
»adabË_v›w_move
(
¡d
::
move
(
»adabË_v›w
));

189 
EXPECT_THAT
(*
»adabË_v›w_move
, 
Eq
(5));

192 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockedV›wObjeùsCªBeMoveAssigÃdSaãly
) {

193 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

194 *
	g§ã_št
.
Lock
() = 5;

196 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

197 autØ
	g»adabË_v›w_move
 = 
¡d
::
move
(
»adabË_v›w
);

198 
EXPECT_THAT
(*
»adabË_v›w_move
, 
Eq
(5));

201 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockWh’LocksAá”CÚd™iÚIsTrue
) {

202 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

204 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

205 
	gth»ads
.
»£rve
(
kNumTh»ads
);

206 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

207 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

208 ++*
§ã_št
.
LockWh’
([
i
](
v®ue
) {  value == i; });

212 autØ&
	gth»ad
 : 
th»ads
) {

213 
th»ad
.
još
();

216 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(
kNumTh»ads
));

219 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockWh’LocksAá”CÚd™iÚIsTrue
) {

220 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

222 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

223 
	gth»ads
.
»£rve
(
kNumTh»ads
);

224 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

225 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

226 
EXPECT_THAT
(

227 *
§ã_št
.
R—d”LockWh’
([
i
](
v®ue
) {  value > i; }),

228 
Gt
(
i
));

232 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

233 ++*
	g§ã_št
.
Lock
();

236 autØ&
	gth»ad
 : 
th»ads
) {

237 
th»ad
.
još
();

241 
TEST
(
Mu‹xGu¬dedTe¡
,

242 
LockWh’W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

243 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

245 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

246 autØ
lock_wh’_·œ
 = 
§ã_št
.
LockWh’W™hTimeout
(

247 [](
v®ue
è{  v®u=ğ0; }, 
kLÚgEnoughFÜTh»adSw™ch
);

248 
EXPECT_TRUE
(
lock_wh’_·œ
.
fœ¡
);

249 ++*
lock_wh’_·œ
.
£cÚd
;

252 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

253 autØ
lock_wh’_·œ
 = 
§ã_št
.
LockWh’W™hTimeout
(

254 [](
v®ue
è{  v®u=ğ50; }, 
kLÚgEnoughFÜTh»adSw™ch
);

255 
EXPECT_FALSE
(
lock_wh’_·œ
.
fœ¡
);

256 ++*
lock_wh’_·œ
.
£cÚd
;

259 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

260 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

262 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

265 
TEST
(
Mu‹xGu¬dedTe¡
,

266 
R—d”LockWh’W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

267 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

269 
EXPECT_FALSE
(

270 
§ã_št


271 .
R—d”LockWh’W™hTimeout
([](
v®ue
) {  value > 0; },

272 
kLÚgEnoughFÜTh»adSw™ch
)

273 .
fœ¡
);

274 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(0));

276 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

277 
EXPECT_TRUE
(

278 
§ã_št


279 .
R—d”LockWh’W™hTimeout
([](
v®ue
) {  value > 0; },

280 
kLÚgEnoughFÜTh»adSw™ch
)

281 .
fœ¡
);

282 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(1));

284 
	gšüem’t_§ã_št
.
još
();

287 
TEST
(
Mu‹xGu¬dedTe¡
,

288 
LockWh’W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

289 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

291 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

292 autØ
lock_wh’_·œ
 =

293 
§ã_št
.
LockWh’W™hD—dlše
([](
v®ue
) {  value == 0; },

294 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
);

295 
EXPECT_TRUE
(
lock_wh’_·œ
.
fœ¡
);

296 ++*
lock_wh’_·œ
.
£cÚd
;

299 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

300 autØ
lock_wh’_·œ
 =

301 
§ã_št
.
LockWh’W™hD—dlše
([](
v®ue
) {  value == 50; },

302 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
);

303 
EXPECT_FALSE
(
lock_wh’_·œ
.
fœ¡
);

304 ++*
lock_wh’_·œ
.
£cÚd
;

307 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

308 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

310 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

313 
TEST
(
Mu‹xGu¬dedTe¡
,

314 
R—d”LockWh’W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

315 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

317 
EXPECT_FALSE
(

318 
§ã_št


319 .
R—d”LockWh’W™hD—dlše
([](
v®ue
) {  value > 0; },

320 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
)

321 .
fœ¡
);

322 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(0));

324 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

325 
EXPECT_TRUE
(

326 
§ã_št


327 .
R—d”LockWh’W™hD—dlše
([](
v®ue
) {  value > 0; },

328 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
)

329 .
fœ¡
);

330 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(1));

332 
	gšüem’t_§ã_št
.
još
();

335 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockV›wAwa™LocksAá”CÚd™iÚIsTrue
) {

336 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

338 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

339 
	gth»ads
.
»£rve
(
kNumTh»ads
);

340 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

341 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

342 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

343 
wr™—bË_v›w
.
Awa™
([
i
](
v®ue
) {  value == i; });

344 ++*
wr™—bË_v›w
;

348 autØ&
	gth»ad
 : 
th»ads
) {

349 
th»ad
.
još
();

352 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(
kNumTh»ads
));

355 
TEST
(
Mu‹xGu¬dedTe¡
,

356 
LockV›wAwa™W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

357 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

359 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

360 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

361 
EXPECT_TRUE
(
wr™—bË_v›w
.
Awa™W™hTimeout
(

362 [](
v®ue
è{  v®u=ğ0; }, 
kLÚgEnoughFÜTh»adSw™ch
));

363 ++*
wr™—bË_v›w
;

366 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

367 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

368 
EXPECT_FALSE
(
wr™—bË_v›w
.
Awa™W™hTimeout
(

369 [](
v®ue
è{  v®u=ğ50; }, 
kLÚgEnoughFÜTh»adSw™ch
));

370 ++*
wr™—bË_v›w
;

373 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

374 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

376 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

379 
TEST
(
Mu‹xGu¬dedTe¡
,

380 
LockV›wAwa™W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

381 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

383 
	g¡d
::
th»ad
 
wa™_uÁ_z”o_th’_šüem’t
([&
§ã_št
] {

384 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

385 
EXPECT_TRUE
(
wr™—bË_v›w
.
Awa™W™hD—dlše
(

386 [](
v®ue
) {  value == 0; },

387 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

388 ++*
wr™—bË_v›w
;

391 
	g¡d
::
th»ad
 
wa™_uÁ_fiáy_th’_šüem’t
([&
§ã_št
] {

392 autØ
wr™—bË_v›w
 = 
§ã_št
.
Lock
();

393 
EXPECT_FALSE
(
wr™—bË_v›w
.
Awa™W™hD—dlše
(

394 [](
v®ue
) {  value == 50; },

395 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

396 ++*
wr™—bË_v›w
;

399 
	gwa™_uÁ_z”o_th’_šüem’t
.
još
();

400 
	gwa™_uÁ_fiáy_th’_šüem’t
.
još
();

402 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(), 
Eq
(2));

405 
TEST
(
Mu‹xGu¬dedTe¡
, 
R—d”LockV›wAwa™LocksAá”CÚd™iÚIsTrue
) {

406 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

408 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

409 
	gth»ads
.
»£rve
(
kNumTh»ads
);

410 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

411 
	gth»ads
.
em¶aû_back
([
i
, &
§ã_št
] {

412 autØ
»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

413 
»adabË_v›w
.
Awa™
([
i
](
v®ue
) {  value > i; });

414 
EXPECT_THAT
(*
»adabË_v›w
, 
Gt
(
i
));

418 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

419 ++*
	g§ã_št
.
Lock
();

422 autØ&
	gth»ad
 : 
th»ads
) {

423 
th»ad
.
još
();

427 
TEST
(
Mu‹xGu¬dedTe¡
,

428 
R—d”LockV›wAwa™W™hTimeoutLocksAá”CÚd™iÚIsTrueOrTimeoutExpœes
) {

429 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

432 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

433 
EXPECT_FALSE
(
»adabË_v›w
.
Awa™W™hTimeout
(

434 [](
v®ue
è{  v®u> 0; }, 
kLÚgEnoughFÜTh»adSw™ch
));

435 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(0));

438 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

441 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

442 
EXPECT_TRUE
(
»adabË_v›w
.
Awa™W™hTimeout
(

443 [](
v®ue
è{  v®u> 0; }, 
kLÚgEnoughFÜTh»adSw™ch
));

444 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(1));

447 
	gšüem’t_§ã_št
.
još
();

450 
TEST
(
Mu‹xGu¬dedTe¡
,

451 
R—d”LockV›wAwa™W™hD—dlšeLocksAá”CÚd™iÚIsTrueOrD—dlšePas£s
) {

452 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

455 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

456 
EXPECT_FALSE
(
»adabË_v›w
.
Awa™W™hD—dlše
(

457 [](
v®ue
) {  value > 0; },

458 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

459 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(0));

462 
	g¡d
::
th»ad
 
šüem’t_§ã_št
([&
§ã_št
] { ++*§ã_št.
Lock
(); });

465 autØ
	g»adabË_v›w
 = 
§ã_št
.
R—d”Lock
();

466 
EXPECT_TRUE
(
»adabË_v›w
.
Awa™W™hD—dlše
(

467 [](
v®ue
) {  value > 0; },

468 
ab¦
::
Now
(è+ 
kLÚgEnoughFÜTh»adSw™ch
));

469 
EXPECT_THAT
(*
»adabË_v›w
, 
Eq
(1));

472 
	gšüem’t_§ã_št
.
još
();

475 
TEST
(
Mu‹xGu¬dedTe¡
, 
LockšgSŒessTe¡
) {

476 
cÚ¡ex´
 
	gkNumInüem’tsP”Th»ad
 = 10000;

478 
	gMu‹xGu¬ded
<> 
§ã_št
(0);

480 
	g¡d
::
veùÜ
<
¡d
::
th»ad
> 
th»ads
;

481 
	gth»ads
.
»£rve
(
kNumTh»ads
);

482 
	gi
 = 0; i < 
	gkNumTh»ads
; ++i) {

483 
	gth»ads
.
em¶aû_back
([&
§ã_št
] {

484 
j
 = 0; j < 
kNumInüem’tsP”Th»ad
; j++) {

485 ++*
§ã_št
.
Lock
();

490 autØ&
	gth»ad
 : 
th»ads
) {

491 
th»ad
.
još
();

494 
EXPECT_THAT
(*
§ã_št
.
R—d”Lock
(),

495 
Eq
(
kNumTh»ads
 * 
kNumInüem’tsP”Th»ad
));

	@util/path.cc

19 
	~"asylo/ut/·th.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
	g¡d
::
¡ršg
 
JošP©h
(è{  
¡d
::string(); }

27 
	g¡d
::
¡ršg
 
JošP©h
(
ab¦
::
¡ršg_v›w
 
·th
) {

28  
¡d
::
¡ršg
(
·th
.
d©a
(),…©h.
size
());

31 
	g¡d
::
¡ršg
 
JošP©h
(
ab¦
::
¡ršg_v›w
 
·th1
,‡b¦::¡ršg_v›w 
·th2
) {

32 ià(
·th1
.
em±y
()) {

33  
JošP©h
(
·th2
);

35 ià(
	g·th2
.
em±y
()) {

36  
JošP©h
(
·th1
);

38 ià(
	g·th1
.
back
() == '/') {

39  
JošP©h
(
·th1
.
sub¡r
(0,…©h1.
size
(è- 1), 
·th2
);

41 ià(
	g·th2
.
äÚt
() == '/') {

42  
JošP©h
(
·th1
, 
·th2
.
sub¡r
(1,…©h2.
size
() - 1));

44  
	gab¦
::
SŒC©
(
·th1
, "/", 
·th2
);

	@util/path.cc

19 
	~"asylo/ut/·th.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
	g¡d
::
¡ršg
 
JošP©h
(è{  
¡d
::string(); }

27 
	g¡d
::
¡ršg
 
JošP©h
(
ab¦
::
¡ršg_v›w
 
·th
) {

28  
¡d
::
¡ršg
(
·th
.
d©a
(),…©h.
size
());

31 
	g¡d
::
¡ršg
 
JošP©h
(
ab¦
::
¡ršg_v›w
 
·th1
,‡b¦::¡ršg_v›w 
·th2
) {

32 ià(
·th1
.
em±y
()) {

33  
JošP©h
(
·th2
);

35 ià(
	g·th2
.
em±y
()) {

36  
JošP©h
(
·th1
);

38 ià(
	g·th1
.
back
() == '/') {

39  
JošP©h
(
·th1
.
sub¡r
(0,…©h1.
size
(è- 1), 
·th2
);

41 ià(
	g·th2
.
äÚt
() == '/') {

42  
JošP©h
(
·th1
, 
·th2
.
sub¡r
(1,…©h2.
size
() - 1));

44  
	gab¦
::
SŒC©
(
·th1
, "/", 
·th2
);

	@util/path.h

19 #iâdeà
ASYLO_UTIL_PATH_H_


20 
	#ASYLO_UTIL_PATH_H_


	)

22 
	~<¡ršg
>

24 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

26 
Çme¥aû
 
	gasylo
 {

40 
	g¡d
::
¡ršg
 
JošP©h
();

43 
	g¡d
::
¡ršg
 
JošP©h
(
ab¦
::
¡ršg_v›w
 
·th
);

48 
	g¡d
::
¡ršg
 
JošP©h
(
ab¦
::
¡ršg_v›w
 
·th1
,‡b¦::¡ršg_v›w 
·th2
);

51 
	g‹m¶©e
 <
	gty³Çme
... 
	gArgs
>

52 
	g¡d
::
¡ršg
 
JošP©h
(
ab¦
::
¡ršg_v›w
 
·th1
,‡b¦::¡ršg_v›w 
·th2
,

53 
ab¦
::
¡ršg_v›w
 
·th3
, 
Args
... 
¬gs
) {

54  
JošP©h
(JošP©h(JošP©h(
·th1
, 
·th2
), 
·th3
),

55 
¡d
::
fÜw¬d
<
Args
>(
¬gs
)...);

	@util/path_test.cc

19 
	~"asylo/ut/·th.h
"

21 
	~<g‹¡/g‹¡.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

26 
TEST
(
P©hTe¡
, 
JošP©hNoArgs
è{ 
EXPECT_EQ
(
JošP©h
(), ""); }

28 
TEST
(
P©hTe¡
, 
JošP©hOÃArg
è{ 
EXPECT_EQ
(
JošP©h
("foo"), "foo"); }

30 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsNoSÏsh
) {

31 
EXPECT_EQ
(
JošP©h
("foo", "bar"), "foo/bar");

34 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsW™hFœ¡SÏsh
) {

35 
EXPECT_EQ
(
JošP©h
("foo/", "bar"), "foo/bar");

38 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsW™hSecÚdSÏsh
) {

39 
EXPECT_EQ
(
JošP©h
("foo", "/bar"), "foo/bar");

42 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsW™hW™hTwoSÏshes
) {

43 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/"), "/foo/bar/");

46 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsFœ¡Em±y
) {

47 
EXPECT_EQ
(
JošP©h
("foo", ""), "foo");

50 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsSecÚdEm±y
) {

51 
EXPECT_EQ
(
JošP©h
("", "bar"), "bar");

54 
TEST
(
P©hTe¡
, 
JošP©hTh»eArgsNoSÏsh
) {

55 
EXPECT_EQ
(
JošP©h
("foo", "bar", "baz"), "foo/bar/baz");

58 
TEST
(
P©hTe¡
, 
JošP©hTh»eArgsW™hSÏsh
) {

59 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/", "/baz/"), "/foo/bar/baz/");

62 
TEST
(
P©hTe¡
, 
JošP©hMªyArgs1
) {

63 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/", "/baz/", "", "aa", "", "", "/ba/"),

67 
TEST
(
P©hTe¡
, 
JošP©hMªyArgs2
) {

68 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/", "/baz/", "/", "aa", "/", "/", "/ba/"),

	@util/path_test.cc

19 
	~"asylo/ut/·th.h
"

21 
	~<g‹¡/g‹¡.h
>

23 
Çme¥aû
 
	gasylo
 {

24 
	gÇme¥aû
 {

26 
TEST
(
P©hTe¡
, 
JošP©hNoArgs
è{ 
EXPECT_EQ
(
JošP©h
(), ""); }

28 
TEST
(
P©hTe¡
, 
JošP©hOÃArg
è{ 
EXPECT_EQ
(
JošP©h
("foo"), "foo"); }

30 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsNoSÏsh
) {

31 
EXPECT_EQ
(
JošP©h
("foo", "bar"), "foo/bar");

34 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsW™hFœ¡SÏsh
) {

35 
EXPECT_EQ
(
JošP©h
("foo/", "bar"), "foo/bar");

38 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsW™hSecÚdSÏsh
) {

39 
EXPECT_EQ
(
JošP©h
("foo", "/bar"), "foo/bar");

42 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsW™hW™hTwoSÏshes
) {

43 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/"), "/foo/bar/");

46 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsFœ¡Em±y
) {

47 
EXPECT_EQ
(
JošP©h
("foo", ""), "foo");

50 
TEST
(
P©hTe¡
, 
JošP©hTwoArgsSecÚdEm±y
) {

51 
EXPECT_EQ
(
JošP©h
("", "bar"), "bar");

54 
TEST
(
P©hTe¡
, 
JošP©hTh»eArgsNoSÏsh
) {

55 
EXPECT_EQ
(
JošP©h
("foo", "bar", "baz"), "foo/bar/baz");

58 
TEST
(
P©hTe¡
, 
JošP©hTh»eArgsW™hSÏsh
) {

59 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/", "/baz/"), "/foo/bar/baz/");

62 
TEST
(
P©hTe¡
, 
JošP©hMªyArgs1
) {

63 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/", "/baz/", "", "aa", "", "", "/ba/"),

67 
TEST
(
P©hTe¡
, 
JošP©hMªyArgs2
) {

68 
EXPECT_EQ
(
JošP©h
("/foo/", "/bar/", "/baz/", "/", "aa", "/", "/", "/ba/"),

	@util/posix_error_space.cc

19 
	~<c¡ršg
>

21 
	~"asylo/ut/”rÜ_¥aû.h
"

22 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g”rÜ
 {

27 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(

28 
E¼ÜS·ûAdlTag
<::
asylo
::
”rÜ
::
PosixE¼Ü
> 
g
) {

29  
PosixE¼ÜS·û
::
G‘In¡ªû
();

32 
E¼ÜS·û
 cÚ¡ *
	gPosixE¼ÜS·û
::
G‘In¡ªû
() {

33 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
PosixE¼ÜS·û
();

34  
	gš¡ªû
;

37 
	gPosixE¼ÜS·û
::
PosixE¼ÜS·û
()

38 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
PosixE¼ÜS·û
>(

40 
AddT¿n¦©iÚM­EÁry
(
P_E2BIG
, 
¡d
::
¡»¼Ü
(P_E2BIG),

41 
PosixToGoogË
(
P_E2BIG
));

42 
AddT¿n¦©iÚM­EÁry
(
P_EACCES
, 
¡d
::
¡»¼Ü
(P_EACCES),

43 
PosixToGoogË
(
P_EACCES
));

44 
AddT¿n¦©iÚM­EÁry
(
P_EADDRINUSE
, 
¡d
::
¡»¼Ü
(P_EADDRINUSE),

45 
PosixToGoogË
(
P_EADDRINUSE
));

46 
AddT¿n¦©iÚM­EÁry
(
P_EADDRNOTAVAIL
, 
¡d
::
¡»¼Ü
(P_EADDRNOTAVAIL),

47 
PosixToGoogË
(
P_EADDRNOTAVAIL
));

48 
AddT¿n¦©iÚM­EÁry
(
P_EAFNOSUPPORT
, 
¡d
::
¡»¼Ü
(P_EAFNOSUPPORT),

49 
PosixToGoogË
(
P_EAFNOSUPPORT
));

50 
AddT¿n¦©iÚM­EÁry
(
P_EAGAIN
, 
¡d
::
¡»¼Ü
(P_EAGAIN),

51 
PosixToGoogË
(
P_EAGAIN
));

52 
AddT¿n¦©iÚM­EÁry
(
P_EALREADY
, 
¡d
::
¡»¼Ü
(P_EALREADY),

53 
PosixToGoogË
(
P_EALREADY
));

54 
AddT¿n¦©iÚM­EÁry
(
P_EBADF
, 
¡d
::
¡»¼Ü
(P_EBADF),

55 
PosixToGoogË
(
P_EBADF
));

56 
AddT¿n¦©iÚM­EÁry
(
P_EBADMSG
, 
¡d
::
¡»¼Ü
(P_EBADMSG),

57 
PosixToGoogË
(
P_EBADMSG
));

58 
AddT¿n¦©iÚM­EÁry
(
P_EBUSY
, 
¡d
::
¡»¼Ü
(P_EBUSY),

59 
PosixToGoogË
(
P_EBUSY
));

60 
AddT¿n¦©iÚM­EÁry
(
P_ECANCELED
, 
¡d
::
¡»¼Ü
(P_ECANCELED),

61 
PosixToGoogË
(
P_ECANCELED
));

62 
AddT¿n¦©iÚM­EÁry
(
P_ECHILD
, 
¡d
::
¡»¼Ü
(P_ECHILD),

63 
PosixToGoogË
(
P_ECHILD
));

64 
AddT¿n¦©iÚM­EÁry
(
P_ECONNABORTED
, 
¡d
::
¡»¼Ü
(P_ECONNABORTED),

65 
PosixToGoogË
(
P_ECONNABORTED
));

66 
AddT¿n¦©iÚM­EÁry
(
P_ECONNREFUSED
, 
¡d
::
¡»¼Ü
(P_ECONNREFUSED),

67 
PosixToGoogË
(
P_ECONNREFUSED
));

68 
AddT¿n¦©iÚM­EÁry
(
P_ECONNRESET
, 
¡d
::
¡»¼Ü
(P_ECONNRESET),

69 
PosixToGoogË
(
P_ECONNRESET
));

70 
AddT¿n¦©iÚM­EÁry
(
P_EDEADLK
, 
¡d
::
¡»¼Ü
(P_EDEADLK),

71 
PosixToGoogË
(
P_EDEADLK
));

72 
AddT¿n¦©iÚM­EÁry
(
P_EDESTADDRREQ
, 
¡d
::
¡»¼Ü
(P_EDESTADDRREQ),

73 
PosixToGoogË
(
P_EDESTADDRREQ
));

74 
AddT¿n¦©iÚM­EÁry
(
P_EDOM
, 
¡d
::
¡»¼Ü
(P_EDOM), 
PosixToGoogË
(P_EDOM));

75 
AddT¿n¦©iÚM­EÁry
(
P_EDQUOT
, 
¡d
::
¡»¼Ü
(P_EDQUOT),

76 
PosixToGoogË
(
P_EDQUOT
));

77 
AddT¿n¦©iÚM­EÁry
(
P_EEXIST
, 
¡d
::
¡»¼Ü
(P_EEXIST),

78 
PosixToGoogË
(
P_EEXIST
));

79 
AddT¿n¦©iÚM­EÁry
(
P_EFAULT
, 
¡d
::
¡»¼Ü
(P_EFAULT),

80 
PosixToGoogË
(
P_EFAULT
));

81 
AddT¿n¦©iÚM­EÁry
(
P_EFBIG
, 
¡d
::
¡»¼Ü
(P_EFBIG),

82 
PosixToGoogË
(
P_EFBIG
));

83 
AddT¿n¦©iÚM­EÁry
(
P_EHOSTUNREACH
, 
¡d
::
¡»¼Ü
(P_EHOSTUNREACH),

84 
PosixToGoogË
(
P_EHOSTUNREACH
));

85 
AddT¿n¦©iÚM­EÁry
(
P_EIDRM
, 
¡d
::
¡»¼Ü
(P_EIDRM),

86 
PosixToGoogË
(
P_EIDRM
));

87 
AddT¿n¦©iÚM­EÁry
(
P_EILSEQ
, 
¡d
::
¡»¼Ü
(P_EILSEQ),

88 
PosixToGoogË
(
P_EILSEQ
));

89 
AddT¿n¦©iÚM­EÁry
(
P_EINPROGRESS
, 
¡d
::
¡»¼Ü
(P_EINPROGRESS),

90 
PosixToGoogË
(
P_EINPROGRESS
));

91 
AddT¿n¦©iÚM­EÁry
(
P_EINTR
, 
¡d
::
¡»¼Ü
(P_EINTR),

92 
PosixToGoogË
(
P_EINTR
));

93 
AddT¿n¦©iÚM­EÁry
(
P_EINVAL
, 
¡d
::
¡»¼Ü
(P_EINVAL),

94 
PosixToGoogË
(
P_EINVAL
));

95 
AddT¿n¦©iÚM­EÁry
(
P_EIO
, 
¡d
::
¡»¼Ü
(P_EIO), 
PosixToGoogË
(P_EIO));

96 
AddT¿n¦©iÚM­EÁry
(
P_EISCONN
, 
¡d
::
¡»¼Ü
(P_EISCONN),

97 
PosixToGoogË
(
P_EISCONN
));

98 
AddT¿n¦©iÚM­EÁry
(
P_EISDIR
, 
¡d
::
¡»¼Ü
(P_EISDIR),

99 
PosixToGoogË
(
P_EISDIR
));

100 
AddT¿n¦©iÚM­EÁry
(
P_ELOOP
, 
¡d
::
¡»¼Ü
(P_ELOOP),

101 
PosixToGoogË
(
P_ELOOP
));

102 
AddT¿n¦©iÚM­EÁry
(
P_EMFILE
, 
¡d
::
¡»¼Ü
(P_EMFILE),

103 
PosixToGoogË
(
P_EMFILE
));

104 
AddT¿n¦©iÚM­EÁry
(
P_EMLINK
, 
¡d
::
¡»¼Ü
(P_EMLINK),

105 
PosixToGoogË
(
P_EMLINK
));

106 
AddT¿n¦©iÚM­EÁry
(
P_EMSGSIZE
, 
¡d
::
¡»¼Ü
(P_EMSGSIZE),

107 
PosixToGoogË
(
P_EMSGSIZE
));

108 
AddT¿n¦©iÚM­EÁry
(
P_EMULTIHOP
, 
¡d
::
¡»¼Ü
(P_EMULTIHOP),

109 
PosixToGoogË
(
P_EMULTIHOP
));

110 
AddT¿n¦©iÚM­EÁry
(
P_ENAMETOOLONG
, 
¡d
::
¡»¼Ü
(P_ENAMETOOLONG),

111 
PosixToGoogË
(
P_ENAMETOOLONG
));

112 
AddT¿n¦©iÚM­EÁry
(
P_ENETDOWN
, 
¡d
::
¡»¼Ü
(P_ENETDOWN),

113 
PosixToGoogË
(
P_ENETDOWN
));

114 
AddT¿n¦©iÚM­EÁry
(
P_ENETRESET
, 
¡d
::
¡»¼Ü
(P_ENETRESET),

115 
PosixToGoogË
(
P_ENETRESET
));

116 
AddT¿n¦©iÚM­EÁry
(
P_ENETUNREACH
, 
¡d
::
¡»¼Ü
(P_ENETUNREACH),

117 
PosixToGoogË
(
P_ENETUNREACH
));

118 
AddT¿n¦©iÚM­EÁry
(
P_ENFILE
, 
¡d
::
¡»¼Ü
(P_ENFILE),

119 
PosixToGoogË
(
P_ENFILE
));

120 
AddT¿n¦©iÚM­EÁry
(
P_ENOBUFS
, 
¡d
::
¡»¼Ü
(P_ENOBUFS),

121 
PosixToGoogË
(
P_ENOBUFS
));

122 
AddT¿n¦©iÚM­EÁry
(
P_ENODATA
, 
¡d
::
¡»¼Ü
(P_ENODATA),

123 
PosixToGoogË
(
P_ENODATA
));

124 
AddT¿n¦©iÚM­EÁry
(
P_ENODEV
, 
¡d
::
¡»¼Ü
(P_ENODEV),

125 
PosixToGoogË
(
P_ENODEV
));

126 
AddT¿n¦©iÚM­EÁry
(
P_ENOENT
, 
¡d
::
¡»¼Ü
(P_ENOENT),

127 
PosixToGoogË
(
P_ENOENT
));

128 
AddT¿n¦©iÚM­EÁry
(
P_ENOEXEC
, 
¡d
::
¡»¼Ü
(P_ENOEXEC),

129 
PosixToGoogË
(
P_ENOEXEC
));

130 
AddT¿n¦©iÚM­EÁry
(
P_ENOLCK
, 
¡d
::
¡»¼Ü
(P_ENOLCK),

131 
PosixToGoogË
(
P_ENOLCK
));

132 
AddT¿n¦©iÚM­EÁry
(
P_ENOLINK
, 
¡d
::
¡»¼Ü
(P_ENOLINK),

133 
PosixToGoogË
(
P_ENOLINK
));

134 
AddT¿n¦©iÚM­EÁry
(
P_ENOMEM
, 
¡d
::
¡»¼Ü
(P_ENOMEM),

135 
PosixToGoogË
(
P_ENOMEM
));

136 
AddT¿n¦©iÚM­EÁry
(
P_ENOMSG
, 
¡d
::
¡»¼Ü
(P_ENOMSG),

137 
PosixToGoogË
(
P_ENOMSG
));

138 
AddT¿n¦©iÚM­EÁry
(
P_ENOPROTOOPT
, 
¡d
::
¡»¼Ü
(P_ENOPROTOOPT),

139 
PosixToGoogË
(
P_ENOPROTOOPT
));

140 
AddT¿n¦©iÚM­EÁry
(
P_ENOSPC
, 
¡d
::
¡»¼Ü
(P_ENOSPC),

141 
PosixToGoogË
(
P_ENOSPC
));

142 
AddT¿n¦©iÚM­EÁry
(
P_ENOSR
, 
¡d
::
¡»¼Ü
(P_ENOSR),

143 
PosixToGoogË
(
P_ENOSR
));

144 
AddT¿n¦©iÚM­EÁry
(
P_ENOSTR
, 
¡d
::
¡»¼Ü
(P_ENOSTR),

145 
PosixToGoogË
(
P_ENOSTR
));

146 
AddT¿n¦©iÚM­EÁry
(
P_ENOSYS
, 
¡d
::
¡»¼Ü
(P_ENOSYS),

147 
PosixToGoogË
(
P_ENOSYS
));

148 
AddT¿n¦©iÚM­EÁry
(
P_ENOTCONN
, 
¡d
::
¡»¼Ü
(P_ENOTCONN),

149 
PosixToGoogË
(
P_ENOTCONN
));

150 
AddT¿n¦©iÚM­EÁry
(
P_ENOTDIR
, 
¡d
::
¡»¼Ü
(P_ENOTDIR),

151 
PosixToGoogË
(
P_ENOTDIR
));

152 
AddT¿n¦©iÚM­EÁry
(
P_ENOTEMPTY
, 
¡d
::
¡»¼Ü
(P_ENOTEMPTY),

153 
PosixToGoogË
(
P_ENOTEMPTY
));

154 
AddT¿n¦©iÚM­EÁry
(
P_ENOTRECOVERABLE
, 
¡d
::
¡»¼Ü
(P_ENOTRECOVERABLE),

155 
PosixToGoogË
(
P_ENOTRECOVERABLE
));

156 
AddT¿n¦©iÚM­EÁry
(
P_ENOTSOCK
, 
¡d
::
¡»¼Ü
(P_ENOTSOCK),

157 
PosixToGoogË
(
P_ENOTSOCK
));

158 
AddT¿n¦©iÚM­EÁry
(
P_ENOTSUP
, 
¡d
::
¡»¼Ü
(P_ENOTSUP),

159 
PosixToGoogË
(
P_ENOTSUP
));

160 
AddT¿n¦©iÚM­EÁry
(
P_ENOTTY
, 
¡d
::
¡»¼Ü
(P_ENOTTY),

161 
PosixToGoogË
(
P_ENOTTY
));

162 
AddT¿n¦©iÚM­EÁry
(
P_ENXIO
, 
¡d
::
¡»¼Ü
(P_ENXIO),

163 
PosixToGoogË
(
P_ENXIO
));

164 
AddT¿n¦©iÚM­EÁry
(
P_EOVERFLOW
, 
¡d
::
¡»¼Ü
(P_EOVERFLOW),

165 
PosixToGoogË
(
P_EOVERFLOW
));

166 
AddT¿n¦©iÚM­EÁry
(
P_EOWNERDEAD
, 
¡d
::
¡»¼Ü
(P_EOWNERDEAD),

167 
PosixToGoogË
(
P_EOWNERDEAD
));

168 
AddT¿n¦©iÚM­EÁry
(
P_EPERM
, 
¡d
::
¡»¼Ü
(P_EPERM),

169 
PosixToGoogË
(
P_EPERM
));

170 
AddT¿n¦©iÚM­EÁry
(
P_EPIPE
, 
¡d
::
¡»¼Ü
(P_EPIPE),

171 
PosixToGoogË
(
P_EPIPE
));

172 
AddT¿n¦©iÚM­EÁry
(
P_EPROTO
, 
¡d
::
¡»¼Ü
(P_EPROTO),

173 
PosixToGoogË
(
P_EPROTO
));

174 
AddT¿n¦©iÚM­EÁry
(
P_EPROTONOSUPPORT
, 
¡d
::
¡»¼Ü
(P_EPROTONOSUPPORT),

175 
PosixToGoogË
(
P_EPROTONOSUPPORT
));

176 
AddT¿n¦©iÚM­EÁry
(
P_EPROTOTYPE
, 
¡d
::
¡»¼Ü
(P_EPROTOTYPE),

177 
PosixToGoogË
(
P_EPROTOTYPE
));

178 
AddT¿n¦©iÚM­EÁry
(
P_ERANGE
, 
¡d
::
¡»¼Ü
(P_ERANGE),

179 
PosixToGoogË
(
P_ERANGE
));

180 
AddT¿n¦©iÚM­EÁry
(
P_EROFS
, 
¡d
::
¡»¼Ü
(P_EROFS),

181 
PosixToGoogË
(
P_EROFS
));

182 
AddT¿n¦©iÚM­EÁry
(
P_ESPIPE
, 
¡d
::
¡»¼Ü
(P_ESPIPE),

183 
PosixToGoogË
(
P_ESPIPE
));

184 
AddT¿n¦©iÚM­EÁry
(
P_ESRCH
, 
¡d
::
¡»¼Ü
(P_ESRCH),

185 
PosixToGoogË
(
P_ESRCH
));

186 
AddT¿n¦©iÚM­EÁry
(
P_ESTALE
, 
¡d
::
¡»¼Ü
(P_ESTALE),

187 
PosixToGoogË
(
P_ESTALE
));

188 
AddT¿n¦©iÚM­EÁry
(
P_ETIME
, 
¡d
::
¡»¼Ü
(P_ETIME),

189 
PosixToGoogË
(
P_ETIME
));

190 
AddT¿n¦©iÚM­EÁry
(
P_ETIMEDOUT
, 
¡d
::
¡»¼Ü
(P_ETIMEDOUT),

191 
PosixToGoogË
(
P_ETIMEDOUT
));

192 
AddT¿n¦©iÚM­EÁry
(
P_ETXTBSY
, 
¡d
::
¡»¼Ü
(P_ETXTBSY),

193 
PosixToGoogË
(
P_ETXTBSY
));

194 
AddT¿n¦©iÚM­EÁry
(
P_EXDEV
, 
¡d
::
¡»¼Ü
(P_EXDEV),

195 
PosixToGoogË
(
P_EXDEV
));

198 
GoogËE¼Ü
 
	gPosixE¼ÜS·û
::
PosixToGoogË
(
PosixE¼Ü
 
code
) const {

199 ià(
¡©ic_ÿ¡
<>(
code
) == 0) {

200  
GoogËE¼Ü
::
OK
;

203 
	gcode
) {

204 
	gPosixE¼Ü
::
P_EINVAL
:

205 
PosixE¼Ü
::
P_ENAMETOOLONG
:

206 
PosixE¼Ü
::
P_E2BIG
:

207 
PosixE¼Ü
::
P_EMSGSIZE
:

208 
PosixE¼Ü
::
P_EDESTADDRREQ
:

209 
PosixE¼Ü
::
P_EDOM
:

210 
PosixE¼Ü
::
P_EFAULT
:

211 
PosixE¼Ü
::
P_EILSEQ
:

212 
PosixE¼Ü
::
P_ENOPROTOOPT
:

213 
PosixE¼Ü
::
P_ENOSTR
:

214 
PosixE¼Ü
::
P_ENOTSOCK
:

215 
PosixE¼Ü
::
P_ENOTTY
:

216 
PosixE¼Ü
::
P_EPROTOTYPE
:

217 
PosixE¼Ü
::
P_ESPIPE
:

218  
GoogËE¼Ü
::
INVALID_ARGUMENT
;

220 
	gPosixE¼Ü
::
P_ETIME
:

221 
PosixE¼Ü
::
P_ETIMEDOUT
:

222  
GoogËE¼Ü
::
DEADLINE_EXCEEDED
;

224 
	gPosixE¼Ü
::
P_ENODEV
:

225 
PosixE¼Ü
::
P_ENOENT
:

226 
PosixE¼Ü
::
P_ENXIO
:

227 
PosixE¼Ü
::
P_ESRCH
:

228  
GoogËE¼Ü
::
NOT_FOUND
;

230 
	gPosixE¼Ü
::
P_EEXIST
:

231 
PosixE¼Ü
::
P_EADDRNOTAVAIL
:

232 
PosixE¼Ü
::
P_EALREADY
:

233  
GoogËE¼Ü
::
ALREADY_EXISTS
;

235 
	gPosixE¼Ü
::
P_EACCES
:

236 
PosixE¼Ü
::
P_EPERM
:

237 
PosixE¼Ü
::
P_EROFS
:

238  
GoogËE¼Ü
::
PERMISSION_DENIED
;

240 
	gPosixE¼Ü
::
P_ENOTEMPTY
:

241 
PosixE¼Ü
::
P_EISDIR
:

242 
PosixE¼Ü
::
P_ENOTDIR
:

243 
PosixE¼Ü
::
P_EADDRINUSE
:

244 
PosixE¼Ü
::
P_EBADF
:

245 
PosixE¼Ü
::
P_EBUSY
:

246 
PosixE¼Ü
::
P_ECHILD
:

247 
PosixE¼Ü
::
P_EISCONN
:

248 
PosixE¼Ü
::
P_ENOTCONN
:

249 
PosixE¼Ü
::
P_EPIPE
:

250 
PosixE¼Ü
::
P_ETXTBSY
:

251  
GoogËE¼Ü
::
FAILED_PRECONDITION
;

253 
	gPosixE¼Ü
::
P_ENOSPC
:

254 
PosixE¼Ü
::
P_EDQUOT
:

255 
PosixE¼Ü
::
P_EMFILE
:

256 
PosixE¼Ü
::
P_EMLINK
:

257 
PosixE¼Ü
::
P_ENFILE
:

258 
PosixE¼Ü
::
P_ENOBUFS
:

259 
PosixE¼Ü
::
P_ENODATA
:

260 
PosixE¼Ü
::
P_ENOMEM
:

261 
PosixE¼Ü
::
P_ENOSR
:

262  
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
;

264 
	gPosixE¼Ü
::
P_EFBIG
:

265 
PosixE¼Ü
::
P_EOVERFLOW
:

266 
PosixE¼Ü
::
P_ERANGE
:

267  
GoogËE¼Ü
::
OUT_OF_RANGE
;

269 
	gPosixE¼Ü
::
P_ENOSYS
:

270 
PosixE¼Ü
::
P_ENOTSUP
:

271 
PosixE¼Ü
::
P_EAFNOSUPPORT
:

272 
PosixE¼Ü
::
P_EPROTONOSUPPORT
:

273 
PosixE¼Ü
::
P_EXDEV
:

274  
GoogËE¼Ü
::
UNIMPLEMENTED
;

276 
	gPosixE¼Ü
::
P_EAGAIN
:

277 
PosixE¼Ü
::
P_ECONNABORTED
:

278 
PosixE¼Ü
::
P_ECONNREFUSED
:

279 
PosixE¼Ü
::
P_ECONNRESET
:

280 
PosixE¼Ü
::
P_EINTR
:

281 
PosixE¼Ü
::
P_EHOSTUNREACH
:

282 
PosixE¼Ü
::
P_ENETDOWN
:

283 
PosixE¼Ü
::
P_ENETRESET
:

284 
PosixE¼Ü
::
P_ENETUNREACH
:

285 
PosixE¼Ü
::
P_ENOLCK
:

286 
PosixE¼Ü
::
P_ENOLINK
:

287  
GoogËE¼Ü
::
UNAVAILABLE
;

289 
	gPosixE¼Ü
::
P_EDEADLK
:

290 
PosixE¼Ü
::
P_ESTALE
:

291  
GoogËE¼Ü
::
ABORTED
;

293 
	gPosixE¼Ü
::
P_ECANCELED
:

294  
GoogËE¼Ü
::
CANCELLED
;

296 
	gPosixE¼Ü
::
P_EBADMSG
:

297 
PosixE¼Ü
::
P_EIDRM
:

298 
PosixE¼Ü
::
P_EINPROGRESS
:

299 
PosixE¼Ü
::
P_EIO
:

300 
PosixE¼Ü
::
P_ELOOP
:

301 
PosixE¼Ü
::
P_ENOEXEC
:

302 
PosixE¼Ü
::
P_ENOMSG
:

303 
PosixE¼Ü
::
P_EPROTO
:

304 
PosixE¼Ü
::
P_EMULTIHOP
:

305  
GoogËE¼Ü
::
UNKNOWN
;

308  
GoogËE¼Ü
::
UNKNOWN
;

	@util/posix_error_space.cc

19 
	~<c¡ršg
>

21 
	~"asylo/ut/”rÜ_¥aû.h
"

22 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g”rÜ
 {

27 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(

28 
E¼ÜS·ûAdlTag
<::
asylo
::
”rÜ
::
PosixE¼Ü
> 
g
) {

29  
PosixE¼ÜS·û
::
G‘In¡ªû
();

32 
E¼ÜS·û
 cÚ¡ *
	gPosixE¼ÜS·û
::
G‘In¡ªû
() {

33 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
PosixE¼ÜS·û
();

34  
	gš¡ªû
;

37 
	gPosixE¼ÜS·û
::
PosixE¼ÜS·û
()

38 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
PosixE¼ÜS·û
>(

40 
AddT¿n¦©iÚM­EÁry
(
P_E2BIG
, 
¡d
::
¡»¼Ü
(P_E2BIG),

41 
PosixToGoogË
(
P_E2BIG
));

42 
AddT¿n¦©iÚM­EÁry
(
P_EACCES
, 
¡d
::
¡»¼Ü
(P_EACCES),

43 
PosixToGoogË
(
P_EACCES
));

44 
AddT¿n¦©iÚM­EÁry
(
P_EADDRINUSE
, 
¡d
::
¡»¼Ü
(P_EADDRINUSE),

45 
PosixToGoogË
(
P_EADDRINUSE
));

46 
AddT¿n¦©iÚM­EÁry
(
P_EADDRNOTAVAIL
, 
¡d
::
¡»¼Ü
(P_EADDRNOTAVAIL),

47 
PosixToGoogË
(
P_EADDRNOTAVAIL
));

48 
AddT¿n¦©iÚM­EÁry
(
P_EAFNOSUPPORT
, 
¡d
::
¡»¼Ü
(P_EAFNOSUPPORT),

49 
PosixToGoogË
(
P_EAFNOSUPPORT
));

50 
AddT¿n¦©iÚM­EÁry
(
P_EAGAIN
, 
¡d
::
¡»¼Ü
(P_EAGAIN),

51 
PosixToGoogË
(
P_EAGAIN
));

52 
AddT¿n¦©iÚM­EÁry
(
P_EALREADY
, 
¡d
::
¡»¼Ü
(P_EALREADY),

53 
PosixToGoogË
(
P_EALREADY
));

54 
AddT¿n¦©iÚM­EÁry
(
P_EBADF
, 
¡d
::
¡»¼Ü
(P_EBADF),

55 
PosixToGoogË
(
P_EBADF
));

56 
AddT¿n¦©iÚM­EÁry
(
P_EBADMSG
, 
¡d
::
¡»¼Ü
(P_EBADMSG),

57 
PosixToGoogË
(
P_EBADMSG
));

58 
AddT¿n¦©iÚM­EÁry
(
P_EBUSY
, 
¡d
::
¡»¼Ü
(P_EBUSY),

59 
PosixToGoogË
(
P_EBUSY
));

60 
AddT¿n¦©iÚM­EÁry
(
P_ECANCELED
, 
¡d
::
¡»¼Ü
(P_ECANCELED),

61 
PosixToGoogË
(
P_ECANCELED
));

62 
AddT¿n¦©iÚM­EÁry
(
P_ECHILD
, 
¡d
::
¡»¼Ü
(P_ECHILD),

63 
PosixToGoogË
(
P_ECHILD
));

64 
AddT¿n¦©iÚM­EÁry
(
P_ECONNABORTED
, 
¡d
::
¡»¼Ü
(P_ECONNABORTED),

65 
PosixToGoogË
(
P_ECONNABORTED
));

66 
AddT¿n¦©iÚM­EÁry
(
P_ECONNREFUSED
, 
¡d
::
¡»¼Ü
(P_ECONNREFUSED),

67 
PosixToGoogË
(
P_ECONNREFUSED
));

68 
AddT¿n¦©iÚM­EÁry
(
P_ECONNRESET
, 
¡d
::
¡»¼Ü
(P_ECONNRESET),

69 
PosixToGoogË
(
P_ECONNRESET
));

70 
AddT¿n¦©iÚM­EÁry
(
P_EDEADLK
, 
¡d
::
¡»¼Ü
(P_EDEADLK),

71 
PosixToGoogË
(
P_EDEADLK
));

72 
AddT¿n¦©iÚM­EÁry
(
P_EDESTADDRREQ
, 
¡d
::
¡»¼Ü
(P_EDESTADDRREQ),

73 
PosixToGoogË
(
P_EDESTADDRREQ
));

74 
AddT¿n¦©iÚM­EÁry
(
P_EDOM
, 
¡d
::
¡»¼Ü
(P_EDOM), 
PosixToGoogË
(P_EDOM));

75 
AddT¿n¦©iÚM­EÁry
(
P_EDQUOT
, 
¡d
::
¡»¼Ü
(P_EDQUOT),

76 
PosixToGoogË
(
P_EDQUOT
));

77 
AddT¿n¦©iÚM­EÁry
(
P_EEXIST
, 
¡d
::
¡»¼Ü
(P_EEXIST),

78 
PosixToGoogË
(
P_EEXIST
));

79 
AddT¿n¦©iÚM­EÁry
(
P_EFAULT
, 
¡d
::
¡»¼Ü
(P_EFAULT),

80 
PosixToGoogË
(
P_EFAULT
));

81 
AddT¿n¦©iÚM­EÁry
(
P_EFBIG
, 
¡d
::
¡»¼Ü
(P_EFBIG),

82 
PosixToGoogË
(
P_EFBIG
));

83 
AddT¿n¦©iÚM­EÁry
(
P_EHOSTUNREACH
, 
¡d
::
¡»¼Ü
(P_EHOSTUNREACH),

84 
PosixToGoogË
(
P_EHOSTUNREACH
));

85 
AddT¿n¦©iÚM­EÁry
(
P_EIDRM
, 
¡d
::
¡»¼Ü
(P_EIDRM),

86 
PosixToGoogË
(
P_EIDRM
));

87 
AddT¿n¦©iÚM­EÁry
(
P_EILSEQ
, 
¡d
::
¡»¼Ü
(P_EILSEQ),

88 
PosixToGoogË
(
P_EILSEQ
));

89 
AddT¿n¦©iÚM­EÁry
(
P_EINPROGRESS
, 
¡d
::
¡»¼Ü
(P_EINPROGRESS),

90 
PosixToGoogË
(
P_EINPROGRESS
));

91 
AddT¿n¦©iÚM­EÁry
(
P_EINTR
, 
¡d
::
¡»¼Ü
(P_EINTR),

92 
PosixToGoogË
(
P_EINTR
));

93 
AddT¿n¦©iÚM­EÁry
(
P_EINVAL
, 
¡d
::
¡»¼Ü
(P_EINVAL),

94 
PosixToGoogË
(
P_EINVAL
));

95 
AddT¿n¦©iÚM­EÁry
(
P_EIO
, 
¡d
::
¡»¼Ü
(P_EIO), 
PosixToGoogË
(P_EIO));

96 
AddT¿n¦©iÚM­EÁry
(
P_EISCONN
, 
¡d
::
¡»¼Ü
(P_EISCONN),

97 
PosixToGoogË
(
P_EISCONN
));

98 
AddT¿n¦©iÚM­EÁry
(
P_EISDIR
, 
¡d
::
¡»¼Ü
(P_EISDIR),

99 
PosixToGoogË
(
P_EISDIR
));

100 
AddT¿n¦©iÚM­EÁry
(
P_ELOOP
, 
¡d
::
¡»¼Ü
(P_ELOOP),

101 
PosixToGoogË
(
P_ELOOP
));

102 
AddT¿n¦©iÚM­EÁry
(
P_EMFILE
, 
¡d
::
¡»¼Ü
(P_EMFILE),

103 
PosixToGoogË
(
P_EMFILE
));

104 
AddT¿n¦©iÚM­EÁry
(
P_EMLINK
, 
¡d
::
¡»¼Ü
(P_EMLINK),

105 
PosixToGoogË
(
P_EMLINK
));

106 
AddT¿n¦©iÚM­EÁry
(
P_EMSGSIZE
, 
¡d
::
¡»¼Ü
(P_EMSGSIZE),

107 
PosixToGoogË
(
P_EMSGSIZE
));

108 
AddT¿n¦©iÚM­EÁry
(
P_EMULTIHOP
, 
¡d
::
¡»¼Ü
(P_EMULTIHOP),

109 
PosixToGoogË
(
P_EMULTIHOP
));

110 
AddT¿n¦©iÚM­EÁry
(
P_ENAMETOOLONG
, 
¡d
::
¡»¼Ü
(P_ENAMETOOLONG),

111 
PosixToGoogË
(
P_ENAMETOOLONG
));

112 
AddT¿n¦©iÚM­EÁry
(
P_ENETDOWN
, 
¡d
::
¡»¼Ü
(P_ENETDOWN),

113 
PosixToGoogË
(
P_ENETDOWN
));

114 
AddT¿n¦©iÚM­EÁry
(
P_ENETRESET
, 
¡d
::
¡»¼Ü
(P_ENETRESET),

115 
PosixToGoogË
(
P_ENETRESET
));

116 
AddT¿n¦©iÚM­EÁry
(
P_ENETUNREACH
, 
¡d
::
¡»¼Ü
(P_ENETUNREACH),

117 
PosixToGoogË
(
P_ENETUNREACH
));

118 
AddT¿n¦©iÚM­EÁry
(
P_ENFILE
, 
¡d
::
¡»¼Ü
(P_ENFILE),

119 
PosixToGoogË
(
P_ENFILE
));

120 
AddT¿n¦©iÚM­EÁry
(
P_ENOBUFS
, 
¡d
::
¡»¼Ü
(P_ENOBUFS),

121 
PosixToGoogË
(
P_ENOBUFS
));

122 
AddT¿n¦©iÚM­EÁry
(
P_ENODATA
, 
¡d
::
¡»¼Ü
(P_ENODATA),

123 
PosixToGoogË
(
P_ENODATA
));

124 
AddT¿n¦©iÚM­EÁry
(
P_ENODEV
, 
¡d
::
¡»¼Ü
(P_ENODEV),

125 
PosixToGoogË
(
P_ENODEV
));

126 
AddT¿n¦©iÚM­EÁry
(
P_ENOENT
, 
¡d
::
¡»¼Ü
(P_ENOENT),

127 
PosixToGoogË
(
P_ENOENT
));

128 
AddT¿n¦©iÚM­EÁry
(
P_ENOEXEC
, 
¡d
::
¡»¼Ü
(P_ENOEXEC),

129 
PosixToGoogË
(
P_ENOEXEC
));

130 
AddT¿n¦©iÚM­EÁry
(
P_ENOLCK
, 
¡d
::
¡»¼Ü
(P_ENOLCK),

131 
PosixToGoogË
(
P_ENOLCK
));

132 
AddT¿n¦©iÚM­EÁry
(
P_ENOLINK
, 
¡d
::
¡»¼Ü
(P_ENOLINK),

133 
PosixToGoogË
(
P_ENOLINK
));

134 
AddT¿n¦©iÚM­EÁry
(
P_ENOMEM
, 
¡d
::
¡»¼Ü
(P_ENOMEM),

135 
PosixToGoogË
(
P_ENOMEM
));

136 
AddT¿n¦©iÚM­EÁry
(
P_ENOMSG
, 
¡d
::
¡»¼Ü
(P_ENOMSG),

137 
PosixToGoogË
(
P_ENOMSG
));

138 
AddT¿n¦©iÚM­EÁry
(
P_ENOPROTOOPT
, 
¡d
::
¡»¼Ü
(P_ENOPROTOOPT),

139 
PosixToGoogË
(
P_ENOPROTOOPT
));

140 
AddT¿n¦©iÚM­EÁry
(
P_ENOSPC
, 
¡d
::
¡»¼Ü
(P_ENOSPC),

141 
PosixToGoogË
(
P_ENOSPC
));

142 
AddT¿n¦©iÚM­EÁry
(
P_ENOSR
, 
¡d
::
¡»¼Ü
(P_ENOSR),

143 
PosixToGoogË
(
P_ENOSR
));

144 
AddT¿n¦©iÚM­EÁry
(
P_ENOSTR
, 
¡d
::
¡»¼Ü
(P_ENOSTR),

145 
PosixToGoogË
(
P_ENOSTR
));

146 
AddT¿n¦©iÚM­EÁry
(
P_ENOSYS
, 
¡d
::
¡»¼Ü
(P_ENOSYS),

147 
PosixToGoogË
(
P_ENOSYS
));

148 
AddT¿n¦©iÚM­EÁry
(
P_ENOTCONN
, 
¡d
::
¡»¼Ü
(P_ENOTCONN),

149 
PosixToGoogË
(
P_ENOTCONN
));

150 
AddT¿n¦©iÚM­EÁry
(
P_ENOTDIR
, 
¡d
::
¡»¼Ü
(P_ENOTDIR),

151 
PosixToGoogË
(
P_ENOTDIR
));

152 
AddT¿n¦©iÚM­EÁry
(
P_ENOTEMPTY
, 
¡d
::
¡»¼Ü
(P_ENOTEMPTY),

153 
PosixToGoogË
(
P_ENOTEMPTY
));

154 
AddT¿n¦©iÚM­EÁry
(
P_ENOTRECOVERABLE
, 
¡d
::
¡»¼Ü
(P_ENOTRECOVERABLE),

155 
PosixToGoogË
(
P_ENOTRECOVERABLE
));

156 
AddT¿n¦©iÚM­EÁry
(
P_ENOTSOCK
, 
¡d
::
¡»¼Ü
(P_ENOTSOCK),

157 
PosixToGoogË
(
P_ENOTSOCK
));

158 
AddT¿n¦©iÚM­EÁry
(
P_ENOTSUP
, 
¡d
::
¡»¼Ü
(P_ENOTSUP),

159 
PosixToGoogË
(
P_ENOTSUP
));

160 
AddT¿n¦©iÚM­EÁry
(
P_ENOTTY
, 
¡d
::
¡»¼Ü
(P_ENOTTY),

161 
PosixToGoogË
(
P_ENOTTY
));

162 
AddT¿n¦©iÚM­EÁry
(
P_ENXIO
, 
¡d
::
¡»¼Ü
(P_ENXIO),

163 
PosixToGoogË
(
P_ENXIO
));

164 
AddT¿n¦©iÚM­EÁry
(
P_EOVERFLOW
, 
¡d
::
¡»¼Ü
(P_EOVERFLOW),

165 
PosixToGoogË
(
P_EOVERFLOW
));

166 
AddT¿n¦©iÚM­EÁry
(
P_EOWNERDEAD
, 
¡d
::
¡»¼Ü
(P_EOWNERDEAD),

167 
PosixToGoogË
(
P_EOWNERDEAD
));

168 
AddT¿n¦©iÚM­EÁry
(
P_EPERM
, 
¡d
::
¡»¼Ü
(P_EPERM),

169 
PosixToGoogË
(
P_EPERM
));

170 
AddT¿n¦©iÚM­EÁry
(
P_EPIPE
, 
¡d
::
¡»¼Ü
(P_EPIPE),

171 
PosixToGoogË
(
P_EPIPE
));

172 
AddT¿n¦©iÚM­EÁry
(
P_EPROTO
, 
¡d
::
¡»¼Ü
(P_EPROTO),

173 
PosixToGoogË
(
P_EPROTO
));

174 
AddT¿n¦©iÚM­EÁry
(
P_EPROTONOSUPPORT
, 
¡d
::
¡»¼Ü
(P_EPROTONOSUPPORT),

175 
PosixToGoogË
(
P_EPROTONOSUPPORT
));

176 
AddT¿n¦©iÚM­EÁry
(
P_EPROTOTYPE
, 
¡d
::
¡»¼Ü
(P_EPROTOTYPE),

177 
PosixToGoogË
(
P_EPROTOTYPE
));

178 
AddT¿n¦©iÚM­EÁry
(
P_ERANGE
, 
¡d
::
¡»¼Ü
(P_ERANGE),

179 
PosixToGoogË
(
P_ERANGE
));

180 
AddT¿n¦©iÚM­EÁry
(
P_EROFS
, 
¡d
::
¡»¼Ü
(P_EROFS),

181 
PosixToGoogË
(
P_EROFS
));

182 
AddT¿n¦©iÚM­EÁry
(
P_ESPIPE
, 
¡d
::
¡»¼Ü
(P_ESPIPE),

183 
PosixToGoogË
(
P_ESPIPE
));

184 
AddT¿n¦©iÚM­EÁry
(
P_ESRCH
, 
¡d
::
¡»¼Ü
(P_ESRCH),

185 
PosixToGoogË
(
P_ESRCH
));

186 
AddT¿n¦©iÚM­EÁry
(
P_ESTALE
, 
¡d
::
¡»¼Ü
(P_ESTALE),

187 
PosixToGoogË
(
P_ESTALE
));

188 
AddT¿n¦©iÚM­EÁry
(
P_ETIME
, 
¡d
::
¡»¼Ü
(P_ETIME),

189 
PosixToGoogË
(
P_ETIME
));

190 
AddT¿n¦©iÚM­EÁry
(
P_ETIMEDOUT
, 
¡d
::
¡»¼Ü
(P_ETIMEDOUT),

191 
PosixToGoogË
(
P_ETIMEDOUT
));

192 
AddT¿n¦©iÚM­EÁry
(
P_ETXTBSY
, 
¡d
::
¡»¼Ü
(P_ETXTBSY),

193 
PosixToGoogË
(
P_ETXTBSY
));

194 
AddT¿n¦©iÚM­EÁry
(
P_EXDEV
, 
¡d
::
¡»¼Ü
(P_EXDEV),

195 
PosixToGoogË
(
P_EXDEV
));

198 
GoogËE¼Ü
 
	gPosixE¼ÜS·û
::
PosixToGoogË
(
PosixE¼Ü
 
code
) const {

199 ià(
¡©ic_ÿ¡
<>(
code
) == 0) {

200  
GoogËE¼Ü
::
OK
;

203 
	gcode
) {

204 
	gPosixE¼Ü
::
P_EINVAL
:

205 
PosixE¼Ü
::
P_ENAMETOOLONG
:

206 
PosixE¼Ü
::
P_E2BIG
:

207 
PosixE¼Ü
::
P_EMSGSIZE
:

208 
PosixE¼Ü
::
P_EDESTADDRREQ
:

209 
PosixE¼Ü
::
P_EDOM
:

210 
PosixE¼Ü
::
P_EFAULT
:

211 
PosixE¼Ü
::
P_EILSEQ
:

212 
PosixE¼Ü
::
P_ENOPROTOOPT
:

213 
PosixE¼Ü
::
P_ENOSTR
:

214 
PosixE¼Ü
::
P_ENOTSOCK
:

215 
PosixE¼Ü
::
P_ENOTTY
:

216 
PosixE¼Ü
::
P_EPROTOTYPE
:

217 
PosixE¼Ü
::
P_ESPIPE
:

218  
GoogËE¼Ü
::
INVALID_ARGUMENT
;

220 
	gPosixE¼Ü
::
P_ETIME
:

221 
PosixE¼Ü
::
P_ETIMEDOUT
:

222  
GoogËE¼Ü
::
DEADLINE_EXCEEDED
;

224 
	gPosixE¼Ü
::
P_ENODEV
:

225 
PosixE¼Ü
::
P_ENOENT
:

226 
PosixE¼Ü
::
P_ENXIO
:

227 
PosixE¼Ü
::
P_ESRCH
:

228  
GoogËE¼Ü
::
NOT_FOUND
;

230 
	gPosixE¼Ü
::
P_EEXIST
:

231 
PosixE¼Ü
::
P_EADDRNOTAVAIL
:

232 
PosixE¼Ü
::
P_EALREADY
:

233  
GoogËE¼Ü
::
ALREADY_EXISTS
;

235 
	gPosixE¼Ü
::
P_EACCES
:

236 
PosixE¼Ü
::
P_EPERM
:

237 
PosixE¼Ü
::
P_EROFS
:

238  
GoogËE¼Ü
::
PERMISSION_DENIED
;

240 
	gPosixE¼Ü
::
P_ENOTEMPTY
:

241 
PosixE¼Ü
::
P_EISDIR
:

242 
PosixE¼Ü
::
P_ENOTDIR
:

243 
PosixE¼Ü
::
P_EADDRINUSE
:

244 
PosixE¼Ü
::
P_EBADF
:

245 
PosixE¼Ü
::
P_EBUSY
:

246 
PosixE¼Ü
::
P_ECHILD
:

247 
PosixE¼Ü
::
P_EISCONN
:

248 
PosixE¼Ü
::
P_ENOTCONN
:

249 
PosixE¼Ü
::
P_EPIPE
:

250 
PosixE¼Ü
::
P_ETXTBSY
:

251  
GoogËE¼Ü
::
FAILED_PRECONDITION
;

253 
	gPosixE¼Ü
::
P_ENOSPC
:

254 
PosixE¼Ü
::
P_EDQUOT
:

255 
PosixE¼Ü
::
P_EMFILE
:

256 
PosixE¼Ü
::
P_EMLINK
:

257 
PosixE¼Ü
::
P_ENFILE
:

258 
PosixE¼Ü
::
P_ENOBUFS
:

259 
PosixE¼Ü
::
P_ENODATA
:

260 
PosixE¼Ü
::
P_ENOMEM
:

261 
PosixE¼Ü
::
P_ENOSR
:

262  
GoogËE¼Ü
::
RESOURCE_EXHAUSTED
;

264 
	gPosixE¼Ü
::
P_EFBIG
:

265 
PosixE¼Ü
::
P_EOVERFLOW
:

266 
PosixE¼Ü
::
P_ERANGE
:

267  
GoogËE¼Ü
::
OUT_OF_RANGE
;

269 
	gPosixE¼Ü
::
P_ENOSYS
:

270 
PosixE¼Ü
::
P_ENOTSUP
:

271 
PosixE¼Ü
::
P_EAFNOSUPPORT
:

272 
PosixE¼Ü
::
P_EPROTONOSUPPORT
:

273 
PosixE¼Ü
::
P_EXDEV
:

274  
GoogËE¼Ü
::
UNIMPLEMENTED
;

276 
	gPosixE¼Ü
::
P_EAGAIN
:

277 
PosixE¼Ü
::
P_ECONNABORTED
:

278 
PosixE¼Ü
::
P_ECONNREFUSED
:

279 
PosixE¼Ü
::
P_ECONNRESET
:

280 
PosixE¼Ü
::
P_EINTR
:

281 
PosixE¼Ü
::
P_EHOSTUNREACH
:

282 
PosixE¼Ü
::
P_ENETDOWN
:

283 
PosixE¼Ü
::
P_ENETRESET
:

284 
PosixE¼Ü
::
P_ENETUNREACH
:

285 
PosixE¼Ü
::
P_ENOLCK
:

286 
PosixE¼Ü
::
P_ENOLINK
:

287  
GoogËE¼Ü
::
UNAVAILABLE
;

289 
	gPosixE¼Ü
::
P_EDEADLK
:

290 
PosixE¼Ü
::
P_ESTALE
:

291  
GoogËE¼Ü
::
ABORTED
;

293 
	gPosixE¼Ü
::
P_ECANCELED
:

294  
GoogËE¼Ü
::
CANCELLED
;

296 
	gPosixE¼Ü
::
P_EBADMSG
:

297 
PosixE¼Ü
::
P_EIDRM
:

298 
PosixE¼Ü
::
P_EINPROGRESS
:

299 
PosixE¼Ü
::
P_EIO
:

300 
PosixE¼Ü
::
P_ELOOP
:

301 
PosixE¼Ü
::
P_ENOEXEC
:

302 
PosixE¼Ü
::
P_ENOMSG
:

303 
PosixE¼Ü
::
P_EPROTO
:

304 
PosixE¼Ü
::
P_EMULTIHOP
:

305  
GoogËE¼Ü
::
UNKNOWN
;

308  
GoogËE¼Ü
::
UNKNOWN
;

	@util/posix_error_space.h

19 #iâdeà
ASYLO_UTIL_POSIX_ERROR_SPACE_H_


20 
	#ASYLO_UTIL_POSIX_ERROR_SPACE_H_


	)

22 
	~<”ºo.h
>

23 
	~<û¼no
>

24 
	~<¡ršg
>

26 
	~"asylo/ut/”rÜ_¥aû.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	g”rÜ
 {

34 
	ePosixE¼Ü
 {

35 
	gP_E2BIG
 = 
E2BIG
,

36 
	gP_EACCES
 = 
EACCES
,

37 
	gP_EADDRINUSE
 = 
EADDRINUSE
,

38 
	gP_EADDRNOTAVAIL
 = 
EADDRNOTAVAIL
,

39 
	gP_EAFNOSUPPORT
 = 
EAFNOSUPPORT
,

40 
	gP_EAGAIN
 = 
EAGAIN
,

41 
	gP_EALREADY
 = 
EALREADY
,

42 
	gP_EBADF
 = 
EBADF
,

43 
	gP_EBADMSG
 = 
EBADMSG
,

44 
	gP_EBUSY
 = 
EBUSY
,

45 
	gP_ECANCELED
 = 
ECANCELED
,

46 
	gP_ECHILD
 = 
ECHILD
,

47 
	gP_ECONNABORTED
 = 
ECONNABORTED
,

48 
	gP_ECONNREFUSED
 = 
ECONNREFUSED
,

49 
	gP_ECONNRESET
 = 
ECONNRESET
,

50 
	gP_EDEADLK
 = 
EDEADLK
,

51 
	gP_EDESTADDRREQ
 = 
EDESTADDRREQ
,

52 
	gP_EDOM
 = 
EDOM
,

53 
	gP_EDQUOT
 = 
EDQUOT
,

54 
	gP_EEXIST
 = 
EEXIST
,

55 
	gP_EFAULT
 = 
EFAULT
,

56 
	gP_EFBIG
 = 
EFBIG
,

57 
	gP_EHOSTUNREACH
 = 
EHOSTUNREACH
,

58 
	gP_EIDRM
 = 
EIDRM
,

59 
	gP_EILSEQ
 = 
EILSEQ
,

60 
	gP_EINPROGRESS
 = 
EINPROGRESS
,

61 
	gP_EINTR
 = 
EINTR
,

62 
	gP_EINVAL
 = 
EINVAL
,

63 
	gP_EIO
 = 
EIO
,

64 
	gP_EISCONN
 = 
EISCONN
,

65 
	gP_EISDIR
 = 
EISDIR
,

66 
	gP_ELOOP
 = 
ELOOP
,

67 
	gP_EMFILE
 = 
EMFILE
,

68 
	gP_EMLINK
 = 
EMLINK
,

69 
	gP_EMSGSIZE
 = 
EMSGSIZE
,

70 
	gP_EMULTIHOP
 = 
EMULTIHOP
,

71 
	gP_ENAMETOOLONG
 = 
ENAMETOOLONG
,

72 
	gP_ENETDOWN
 = 
ENETDOWN
,

73 
	gP_ENETRESET
 = 
ENETRESET
,

74 
	gP_ENETUNREACH
 = 
ENETUNREACH
,

75 
	gP_ENFILE
 = 
ENFILE
,

76 
	gP_ENOBUFS
 = 
ENOBUFS
,

77 
	gP_ENODATA
 = 
ENODATA
,

78 
	gP_ENODEV
 = 
ENODEV
,

79 
	gP_ENOENT
 = 
ENOENT
,

80 
	gP_ENOEXEC
 = 
ENOEXEC
,

81 
	gP_ENOLCK
 = 
ENOLCK
,

82 
	gP_ENOLINK
 = 
ENOLINK
,

83 
	gP_ENOMEM
 = 
ENOMEM
,

84 
	gP_ENOMSG
 = 
ENOMSG
,

85 
	gP_ENOPROTOOPT
 = 
ENOPROTOOPT
,

86 
	gP_ENOSPC
 = 
ENOSPC
,

87 
	gP_ENOSR
 = 
ENOSR
,

88 
	gP_ENOSTR
 = 
ENOSTR
,

89 
	gP_ENOSYS
 = 
ENOSYS
,

90 
	gP_ENOTCONN
 = 
ENOTCONN
,

91 
	gP_ENOTDIR
 = 
ENOTDIR
,

92 
	gP_ENOTEMPTY
 = 
ENOTEMPTY
,

93 
	gP_ENOTRECOVERABLE
 = 
ENOTRECOVERABLE
,

94 
	gP_ENOTSOCK
 = 
ENOTSOCK
,

95 
	gP_ENOTSUP
 = 
ENOTSUP
,

96 
	gP_ENOTTY
 = 
ENOTTY
,

97 
	gP_ENXIO
 = 
ENXIO
,

99 
	gP_EOVERFLOW
 = 
EOVERFLOW
,

100 
	gP_EOWNERDEAD
 = 
EOWNERDEAD
,

101 
	gP_EPERM
 = 
EPERM
,

102 
	gP_EPIPE
 = 
EPIPE
,

103 
	gP_EPROTO
 = 
EPROTO
,

104 
	gP_EPROTONOSUPPORT
 = 
EPROTONOSUPPORT
,

105 
	gP_EPROTOTYPE
 = 
EPROTOTYPE
,

106 
	gP_ERANGE
 = 
ERANGE
,

107 
	gP_EROFS
 = 
EROFS
,

108 
	gP_ESPIPE
 = 
ESPIPE
,

109 
	gP_ESRCH
 = 
ESRCH
,

110 
	gP_ESTALE
 = 
ESTALE
,

111 
	gP_ETIME
 = 
ETIME
,

112 
	gP_ETIMEDOUT
 = 
ETIMEDOUT
,

113 
	gP_ETXTBSY
 = 
ETXTBSY
,

115 
	gP_EXDEV
 = 
EXDEV


119 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
PosixE¼Ü
> 
g
);

122 
şass
 
	gPosixE¼ÜS·û
 : 
public
 
E¼ÜS·ûIm¶em’tiÚH–³r
<
PosixE¼ÜS·û
> {

123 
public
:

124 
usšg
 
code_ty³
 = 
PosixE¼Ü
;

126 
PosixE¼ÜS·û
(cÚ¡ PosixE¼ÜS·û &
Ùh”
èğ
d–‘e
;

127 
	gvœtu®
 ~
PosixE¼ÜS·û
() = ;

128 
	gPosixE¼ÜS·û
 &
	gİ”©Ü
=(cÚ¡ 
PosixE¼ÜS·û
 &
Ùh”
èğ
d–‘e
;

132 
E¼ÜS·û
 cÚ¡ *
G‘In¡ªû
();

134 
	g´iv©e
:

135 
PosixE¼ÜS·û
();

136 
GoogËE¼Ü
 
PosixToGoogË
(
PosixE¼Ü
 
code
) const;

	@util/posix_error_space_test.cc

19 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

21 
	~<£t
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g”rÜ
 {

28 
	gÇme¥aû
 {

30 
cÚ¡ex´
 
	gkMšE¼ÜCode
 = 1;

31 
cÚ¡ex´
 
	gkMaxE¼ÜCode
 = 1000;

34 şas 
	cPosixE¼ÜS·ûTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

35 
´Ùeùed
:

36 
PosixE¼ÜS·ûTe¡
()

37 : 
codes_
{
PosixE¼Ü
::
P_E2BIG
,

38 
	gPosixE¼Ü
::
P_EACCES
,

39 
	gPosixE¼Ü
::
P_EADDRINUSE
,

40 
	gPosixE¼Ü
::
P_EADDRNOTAVAIL
,

41 
	gPosixE¼Ü
::
P_EAFNOSUPPORT
,

42 
	gPosixE¼Ü
::
P_EAGAIN
,

43 
	gPosixE¼Ü
::
P_EALREADY
,

44 
	gPosixE¼Ü
::
P_EBADF
,

45 
	gPosixE¼Ü
::
P_EBADMSG
,

46 
	gPosixE¼Ü
::
P_EBUSY
,

47 
	gPosixE¼Ü
::
P_ECANCELED
,

48 
	gPosixE¼Ü
::
P_ECHILD
,

49 
	gPosixE¼Ü
::
P_ECONNABORTED
,

50 
	gPosixE¼Ü
::
P_ECONNREFUSED
,

51 
	gPosixE¼Ü
::
P_ECONNRESET
,

52 
	gPosixE¼Ü
::
P_EDEADLK
,

53 
	gPosixE¼Ü
::
P_EDESTADDRREQ
,

54 
	gPosixE¼Ü
::
P_EDOM
,

55 
	gPosixE¼Ü
::
P_EDQUOT
,

56 
	gPosixE¼Ü
::
P_EEXIST
,

57 
	gPosixE¼Ü
::
P_EFAULT
,

58 
	gPosixE¼Ü
::
P_EFBIG
,

59 
	gPosixE¼Ü
::
P_EHOSTUNREACH
,

60 
	gPosixE¼Ü
::
P_EIDRM
,

61 
	gPosixE¼Ü
::
P_EILSEQ
,

62 
	gPosixE¼Ü
::
P_EINPROGRESS
,

63 
	gPosixE¼Ü
::
P_EINTR
,

64 
	gPosixE¼Ü
::
P_EINVAL
,

65 
	gPosixE¼Ü
::
P_EIO
,

66 
	gPosixE¼Ü
::
P_EISCONN
,

67 
	gPosixE¼Ü
::
P_EISDIR
,

68 
	gPosixE¼Ü
::
P_ELOOP
,

69 
	gPosixE¼Ü
::
P_EMFILE
,

70 
	gPosixE¼Ü
::
P_EMLINK
,

71 
	gPosixE¼Ü
::
P_EMSGSIZE
,

72 
	gPosixE¼Ü
::
P_EMULTIHOP
,

73 
	gPosixE¼Ü
::
P_ENAMETOOLONG
,

74 
	gPosixE¼Ü
::
P_ENETDOWN
,

75 
	gPosixE¼Ü
::
P_ENETRESET
,

76 
	gPosixE¼Ü
::
P_ENETUNREACH
,

77 
	gPosixE¼Ü
::
P_ENFILE
,

78 
	gPosixE¼Ü
::
P_ENOBUFS
,

79 
	gPosixE¼Ü
::
P_ENODATA
,

80 
	gPosixE¼Ü
::
P_ENODEV
,

81 
	gPosixE¼Ü
::
P_ENOENT
,

82 
	gPosixE¼Ü
::
P_ENOEXEC
,

83 
	gPosixE¼Ü
::
P_ENOLCK
,

84 
	gPosixE¼Ü
::
P_ENOLINK
,

85 
	gPosixE¼Ü
::
P_ENOMEM
,

86 
	gPosixE¼Ü
::
P_ENOMSG
,

87 
	gPosixE¼Ü
::
P_ENOPROTOOPT
,

88 
	gPosixE¼Ü
::
P_ENOSPC
,

89 
	gPosixE¼Ü
::
P_ENOSR
,

90 
	gPosixE¼Ü
::
P_ENOSTR
,

91 
	gPosixE¼Ü
::
P_ENOSYS
,

92 
	gPosixE¼Ü
::
P_ENOTCONN
,

93 
	gPosixE¼Ü
::
P_ENOTDIR
,

94 
	gPosixE¼Ü
::
P_ENOTEMPTY
,

95 
	gPosixE¼Ü
::
P_ENOTRECOVERABLE
,

96 
	gPosixE¼Ü
::
P_ENOTSOCK
,

97 
	gPosixE¼Ü
::
P_ENOTSUP
,

98 
	gPosixE¼Ü
::
P_ENOTTY
,

99 
	gPosixE¼Ü
::
P_ENXIO
,

100 
	gPosixE¼Ü
::
P_EOVERFLOW
,

101 
	gPosixE¼Ü
::
P_EOWNERDEAD
,

102 
	gPosixE¼Ü
::
P_EPERM
,

103 
	gPosixE¼Ü
::
P_EPIPE
,

104 
	gPosixE¼Ü
::
P_EPROTO
,

105 
	gPosixE¼Ü
::
P_EPROTONOSUPPORT
,

106 
	gPosixE¼Ü
::
P_EPROTOTYPE
,

107 
	gPosixE¼Ü
::
P_ERANGE
,

108 
	gPosixE¼Ü
::
P_EROFS
,

109 
	gPosixE¼Ü
::
P_ESPIPE
,

110 
	gPosixE¼Ü
::
P_ESRCH
,

111 
	gPosixE¼Ü
::
P_ESTALE
,

112 
	gPosixE¼Ü
::
P_ETIME
,

113 
	gPosixE¼Ü
::
P_ETIMEDOUT
,

114 
	gPosixE¼Ü
::
P_ETXTBSY
,

115 
	gPosixE¼Ü
::
P_EXDEV
} {}

117 
¡d
::
£t
<
PosixE¼Ü
> 
codes_
;

122 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûSšgËtÚCÜ»ùÃss
) {

123 
E¼ÜS·û
 cÚ¡ *
	g¥aû1
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

124 
EXPECT_NE
(
¥aû1
, 
nuÎ±r
);

125 
E¼ÜS·û
 cÚ¡ *
	g¥aû2
 =

126 
E¼ÜS·û
::
Fšd
("::asylo::error::PosixErrorSpace");

127 
EXPECT_NE
(
¥aû2
, 
nuÎ±r
);

128 
EXPECT_EQ
(
¥aû1
, 
¥aû2
);

131 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûS·ûName
) {

132 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

133 
EXPECT_EQ
(
¥aû
->
S·ûName
(), "::asylo::error::PosixErrorSpace");

139 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûSŒšg
) {

140 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

141 cÚ¡‡utØ&
	gcode
 : 
codes_
) {

144 
EXPECT_NE
(
¥aû
->
SŒšg
(
code
), "Unrecognized Code");

147 
	gi
 = 
kMšE¼ÜCode
; i < 
	gkMaxE¼ÜCode
; i++) {

148 
PosixE¼Ü
 
	gcode
 = 
¡©ic_ÿ¡
<PosixE¼Ü>(
i
);

149 ià(
	gcodes_
.
fšd
(
code
è=ğ
codes_
.
’d
()) {

150 
EXPECT_EQ
(
¥aû
->
SŒšg
(
code
), "Unrecognized Code");

158 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûGoogËE¼ÜCode
) {

159 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

160 cÚ¡‡utØ&
	gcode
 : 
codes_
) {

162 
GoogËE¼Ü
 
googË_code
 = 
¥aû
->
GoogËE¼ÜCode
(
code
);

163 
EXPECT_GE
(
googË_code
, 
GoogËE¼Ü
::
OK
);

164 
EXPECT_LE
(
googË_code
, 
GoogËE¼Ü
::
UNAUTHENTICATED
);

167 
	gi
 = 
kMšE¼ÜCode
; i < 
	gkMaxE¼ÜCode
; i++) {

168 
PosixE¼Ü
 
	gcode
 = 
¡©ic_ÿ¡
<PosixE¼Ü>(
i
);

169 ià(
	gcodes_
.
fšd
(
code
è=ğ
codes_
.
’d
()) {

170 
EXPECT_EQ
(
¥aû
->
GoogËE¼ÜCode
(
code
), 
GoogËE¼Ü
::
UNKNOWN
);

	@util/posix_error_space_test.cc

19 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

21 
	~<£t
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

26 
Çme¥aû
 
	gasylo
 {

27 
Çme¥aû
 
	g”rÜ
 {

28 
	gÇme¥aû
 {

30 
cÚ¡ex´
 
	gkMšE¼ÜCode
 = 1;

31 
cÚ¡ex´
 
	gkMaxE¼ÜCode
 = 1000;

34 şas 
	cPosixE¼ÜS·ûTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

35 
´Ùeùed
:

36 
PosixE¼ÜS·ûTe¡
()

37 : 
codes_
{
PosixE¼Ü
::
P_E2BIG
,

38 
	gPosixE¼Ü
::
P_EACCES
,

39 
	gPosixE¼Ü
::
P_EADDRINUSE
,

40 
	gPosixE¼Ü
::
P_EADDRNOTAVAIL
,

41 
	gPosixE¼Ü
::
P_EAFNOSUPPORT
,

42 
	gPosixE¼Ü
::
P_EAGAIN
,

43 
	gPosixE¼Ü
::
P_EALREADY
,

44 
	gPosixE¼Ü
::
P_EBADF
,

45 
	gPosixE¼Ü
::
P_EBADMSG
,

46 
	gPosixE¼Ü
::
P_EBUSY
,

47 
	gPosixE¼Ü
::
P_ECANCELED
,

48 
	gPosixE¼Ü
::
P_ECHILD
,

49 
	gPosixE¼Ü
::
P_ECONNABORTED
,

50 
	gPosixE¼Ü
::
P_ECONNREFUSED
,

51 
	gPosixE¼Ü
::
P_ECONNRESET
,

52 
	gPosixE¼Ü
::
P_EDEADLK
,

53 
	gPosixE¼Ü
::
P_EDESTADDRREQ
,

54 
	gPosixE¼Ü
::
P_EDOM
,

55 
	gPosixE¼Ü
::
P_EDQUOT
,

56 
	gPosixE¼Ü
::
P_EEXIST
,

57 
	gPosixE¼Ü
::
P_EFAULT
,

58 
	gPosixE¼Ü
::
P_EFBIG
,

59 
	gPosixE¼Ü
::
P_EHOSTUNREACH
,

60 
	gPosixE¼Ü
::
P_EIDRM
,

61 
	gPosixE¼Ü
::
P_EILSEQ
,

62 
	gPosixE¼Ü
::
P_EINPROGRESS
,

63 
	gPosixE¼Ü
::
P_EINTR
,

64 
	gPosixE¼Ü
::
P_EINVAL
,

65 
	gPosixE¼Ü
::
P_EIO
,

66 
	gPosixE¼Ü
::
P_EISCONN
,

67 
	gPosixE¼Ü
::
P_EISDIR
,

68 
	gPosixE¼Ü
::
P_ELOOP
,

69 
	gPosixE¼Ü
::
P_EMFILE
,

70 
	gPosixE¼Ü
::
P_EMLINK
,

71 
	gPosixE¼Ü
::
P_EMSGSIZE
,

72 
	gPosixE¼Ü
::
P_EMULTIHOP
,

73 
	gPosixE¼Ü
::
P_ENAMETOOLONG
,

74 
	gPosixE¼Ü
::
P_ENETDOWN
,

75 
	gPosixE¼Ü
::
P_ENETRESET
,

76 
	gPosixE¼Ü
::
P_ENETUNREACH
,

77 
	gPosixE¼Ü
::
P_ENFILE
,

78 
	gPosixE¼Ü
::
P_ENOBUFS
,

79 
	gPosixE¼Ü
::
P_ENODATA
,

80 
	gPosixE¼Ü
::
P_ENODEV
,

81 
	gPosixE¼Ü
::
P_ENOENT
,

82 
	gPosixE¼Ü
::
P_ENOEXEC
,

83 
	gPosixE¼Ü
::
P_ENOLCK
,

84 
	gPosixE¼Ü
::
P_ENOLINK
,

85 
	gPosixE¼Ü
::
P_ENOMEM
,

86 
	gPosixE¼Ü
::
P_ENOMSG
,

87 
	gPosixE¼Ü
::
P_ENOPROTOOPT
,

88 
	gPosixE¼Ü
::
P_ENOSPC
,

89 
	gPosixE¼Ü
::
P_ENOSR
,

90 
	gPosixE¼Ü
::
P_ENOSTR
,

91 
	gPosixE¼Ü
::
P_ENOSYS
,

92 
	gPosixE¼Ü
::
P_ENOTCONN
,

93 
	gPosixE¼Ü
::
P_ENOTDIR
,

94 
	gPosixE¼Ü
::
P_ENOTEMPTY
,

95 
	gPosixE¼Ü
::
P_ENOTRECOVERABLE
,

96 
	gPosixE¼Ü
::
P_ENOTSOCK
,

97 
	gPosixE¼Ü
::
P_ENOTSUP
,

98 
	gPosixE¼Ü
::
P_ENOTTY
,

99 
	gPosixE¼Ü
::
P_ENXIO
,

100 
	gPosixE¼Ü
::
P_EOVERFLOW
,

101 
	gPosixE¼Ü
::
P_EOWNERDEAD
,

102 
	gPosixE¼Ü
::
P_EPERM
,

103 
	gPosixE¼Ü
::
P_EPIPE
,

104 
	gPosixE¼Ü
::
P_EPROTO
,

105 
	gPosixE¼Ü
::
P_EPROTONOSUPPORT
,

106 
	gPosixE¼Ü
::
P_EPROTOTYPE
,

107 
	gPosixE¼Ü
::
P_ERANGE
,

108 
	gPosixE¼Ü
::
P_EROFS
,

109 
	gPosixE¼Ü
::
P_ESPIPE
,

110 
	gPosixE¼Ü
::
P_ESRCH
,

111 
	gPosixE¼Ü
::
P_ESTALE
,

112 
	gPosixE¼Ü
::
P_ETIME
,

113 
	gPosixE¼Ü
::
P_ETIMEDOUT
,

114 
	gPosixE¼Ü
::
P_ETXTBSY
,

115 
	gPosixE¼Ü
::
P_EXDEV
} {}

117 
¡d
::
£t
<
PosixE¼Ü
> 
codes_
;

122 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûSšgËtÚCÜ»ùÃss
) {

123 
E¼ÜS·û
 cÚ¡ *
	g¥aû1
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

124 
EXPECT_NE
(
¥aû1
, 
nuÎ±r
);

125 
E¼ÜS·û
 cÚ¡ *
	g¥aû2
 =

126 
E¼ÜS·û
::
Fšd
("::asylo::error::PosixErrorSpace");

127 
EXPECT_NE
(
¥aû2
, 
nuÎ±r
);

128 
EXPECT_EQ
(
¥aû1
, 
¥aû2
);

131 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûS·ûName
) {

132 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

133 
EXPECT_EQ
(
¥aû
->
S·ûName
(), "::asylo::error::PosixErrorSpace");

139 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûSŒšg
) {

140 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

141 cÚ¡‡utØ&
	gcode
 : 
codes_
) {

144 
EXPECT_NE
(
¥aû
->
SŒšg
(
code
), "Unrecognized Code");

147 
	gi
 = 
kMšE¼ÜCode
; i < 
	gkMaxE¼ÜCode
; i++) {

148 
PosixE¼Ü
 
	gcode
 = 
¡©ic_ÿ¡
<PosixE¼Ü>(
i
);

149 ià(
	gcodes_
.
fšd
(
code
è=ğ
codes_
.
’d
()) {

150 
EXPECT_EQ
(
¥aû
->
SŒšg
(
code
), "Unrecognized Code");

158 
TEST_F
(
PosixE¼ÜS·ûTe¡
, 
PosixE¼ÜS·ûGoogËE¼ÜCode
) {

159 
E¼ÜS·û
 cÚ¡ *
	g¥aû
 = 
”rÜ_’um_Œa™s
<
PosixE¼Ü
>::
g‘_”rÜ_¥aû
();

160 cÚ¡‡utØ&
	gcode
 : 
codes_
) {

162 
GoogËE¼Ü
 
googË_code
 = 
¥aû
->
GoogËE¼ÜCode
(
code
);

163 
EXPECT_GE
(
googË_code
, 
GoogËE¼Ü
::
OK
);

164 
EXPECT_LE
(
googË_code
, 
GoogËE¼Ü
::
UNAUTHENTICATED
);

167 
	gi
 = 
kMšE¼ÜCode
; i < 
	gkMaxE¼ÜCode
; i++) {

168 
PosixE¼Ü
 
	gcode
 = 
¡©ic_ÿ¡
<PosixE¼Ü>(
i
);

169 ià(
	gcodes_
.
fšd
(
code
è=ğ
codes_
.
’d
()) {

170 
EXPECT_EQ
(
¥aû
->
GoogËE¼ÜCode
(
code
), 
GoogËE¼Ü
::
UNKNOWN
);

	@util/proto_struct_util.cc

19 
	~"asylo/ut/´Ùo_¡ruù_ut.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
SŒuù
 *> 
JsÚG‘Objeù
(

26 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

27 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kSŒuùV®ue
) {

28  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

32  &
	gv®ue
.
¡ruù_v®ue
();

35 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
Li¡V®ue
 *> 
JsÚG‘A¼ay
(

36 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

37 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kLi¡V®ue
) {

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42  &
	gv®ue
.
li¡_v®ue
();

45 
	gStusOr
<cÚ¡ 
	g¡d
::
¡ršg
 *> 
JsÚG‘SŒšg
(

46 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

47 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kSŒšgV®ue
) {

48  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

52  &
	gv®ue
.
¡ršg_v®ue
();

55 
	gStusOr
<> 
JsÚG‘Numb”
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

56 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kNumb”V®ue
) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61  
	gv®ue
.
numb”_v®ue
();

64 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *> 
JsÚObjeùG‘F›ld
(

65 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 &
objeù
, cÚ¡ 
¡d
::
¡ršg
 &
f›ld_Çme
) {

66 ià(!
objeù
.
f›lds
().
cÚšs
(
f›ld_Çme
)) {

67  
Stus
(

68 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

69 
ab¦
::
SŒC©
("JSON objeù dÛ nÙ hav¨", 
f›ld_Çme
, " field"));

72  &
	gobjeù
.
f›lds
().
©
(
f›ld_Çme
);

	@util/proto_struct_util.cc

19 
	~"asylo/ut/´Ùo_¡ruù_ut.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

23 
Çme¥aû
 
	gasylo
 {

25 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
SŒuù
 *> 
JsÚG‘Objeù
(

26 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

27 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kSŒuùV®ue
) {

28  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

32  &
	gv®ue
.
¡ruù_v®ue
();

35 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
Li¡V®ue
 *> 
JsÚG‘A¼ay
(

36 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

37 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kLi¡V®ue
) {

38  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

42  &
	gv®ue
.
li¡_v®ue
();

45 
	gStusOr
<cÚ¡ 
	g¡d
::
¡ršg
 *> 
JsÚG‘SŒšg
(

46 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

47 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kSŒšgV®ue
) {

48  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

52  &
	gv®ue
.
¡ršg_v®ue
();

55 
	gStusOr
<> 
JsÚG‘Numb”
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
) {

56 ià(
v®ue
.
kšd_ÿ£
(è!ğ
googË
::
´Ùobuf
::
V®ue
::
kNumb”V®ue
) {

57  
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

61  
	gv®ue
.
numb”_v®ue
();

64 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *> 
JsÚObjeùG‘F›ld
(

65 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 &
objeù
, cÚ¡ 
¡d
::
¡ršg
 &
f›ld_Çme
) {

66 ià(!
objeù
.
f›lds
().
cÚšs
(
f›ld_Çme
)) {

67  
Stus
(

68 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

69 
ab¦
::
SŒC©
("JSON objeù dÛ nÙ hav¨", 
f›ld_Çme
, " field"));

72  &
	gobjeù
.
f›lds
().
©
(
f›ld_Çme
);

	@util/proto_struct_util.h

19 #iâdeà
ASYLO_UTIL_PROTO_STRUCT_UTIL_H_


20 
	#ASYLO_UTIL_PROTO_STRUCT_UTIL_H_


	)

22 
	~<¡ršg
>

24 
	~"googË/´Ùobuf/¡ruù.pb.h
"

25 
	~"asylo/ut/¡©usÜ.h
"

27 
Çme¥aû
 
	gasylo
 {

39 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
SŒuù
 *> 
JsÚG‘Objeù
(

40 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
);

44 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
Li¡V®ue
 *> 
JsÚG‘A¼ay
(

45 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
);

49 
	gStusOr
<cÚ¡ 
	g¡d
::
¡ršg
 *> 
JsÚG‘SŒšg
(

50 cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
);

54 
	gStusOr
<> 
JsÚG‘Numb”
(cÚ¡ 
googË
::
´Ùobuf
::
V®ue
 &
v®ue
);

60 
	gStusOr
<cÚ¡ 
	ggoogË
::
´Ùobuf
::
V®ue
 *> 
JsÚObjeùG‘F›ld
(

61 cÚ¡ 
googË
::
´Ùobuf
::
SŒuù
 &
objeù
, cÚ¡ 
¡d
::
¡ršg
 &
f›ld_Çme
);

	@util/proto_struct_util_test.cc

19 
	~"asylo/ut/´Ùo_¡ruù_ut.h
"

21 
	~"googË/´Ùobuf/¡ruù.pb.h
"

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gsgx
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Poš‹e
;

33 
	gusšg
 ::
‹¡šg
::
SŒEq
;

35 
TEST
(
JsÚUtTe¡
, 
JsÚG‘ObjeùFasOnNÚObjeùs
) {

36 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

37 
	gv®ue
.
£t_numb”_v®ue
(0.);

38 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
).
¡©us
(),

39 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

41 
	gv®ue
.
£t_¡ršg_v®ue
("");

42 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
).
¡©us
(),

43 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

45 
	gv®ue
.
mubË_li¡_v®ue
();

46 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
).
¡©us
(),

47 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

50 
TEST
(
JsÚUtTe¡
, 
JsÚG‘ObjeùSucûedsOnObjeùs
) {

51 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

52 
	gv®ue
.
mubË_¡ruù_v®ue
();

53 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
),

54 
IsOkAndHŞds
(
Poš‹e
(
Equ®sPrÙo
(
googË
::
´Ùobuf
::
SŒuù
()))));

57 
TEST
(
JsÚUtTe¡
, 
JsÚG‘A¼ayFasOnNÚA¼ays
) {

58 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

59 
	gv®ue
.
£t_numb”_v®ue
(0.);

60 
EXPECT_THAT
(
JsÚG‘A¼ay
(
v®ue
).
¡©us
(),

61 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

63 
	gv®ue
.
£t_¡ršg_v®ue
("");

64 
EXPECT_THAT
(
JsÚG‘A¼ay
(
v®ue
).
¡©us
(),

65 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

67 
	gv®ue
.
mubË_¡ruù_v®ue
();

68 
EXPECT_THAT
(
JsÚG‘A¼ay
(
v®ue
).
¡©us
(),

69 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

72 
TEST
(
JsÚUtTe¡
, 
JsÚG‘A¼aySucûedsOnA¼ays
) {

73 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

74 
	gv®ue
.
mubË_li¡_v®ue
();

75 
EXPECT_THAT
(

76 
JsÚG‘A¼ay
(
v®ue
),

77 
IsOkAndHŞds
(
Poš‹e
(
Equ®sPrÙo
(
googË
::
´Ùobuf
::
Li¡V®ue
()))));

80 
TEST
(
JsÚUtTe¡
, 
JsÚG‘SŒšgFasOnNÚSŒšgs
) {

81 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

82 
	gv®ue
.
£t_numb”_v®ue
(0.);

83 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
).
¡©us
(),

84 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

86 
	gv®ue
.
mubË_li¡_v®ue
();

87 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
).
¡©us
(),

88 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

90 
	gv®ue
.
mubË_¡ruù_v®ue
();

91 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
).
¡©us
(),

92 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

95 
TEST
(
JsÚUtTe¡
, 
JsÚG‘SŒšgSucûedsOnSŒšgs
) {

96 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

97 
	gv®ue
.
£t_¡ršg_v®ue
("");

98 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
), 
IsOkAndHŞds
(
Poš‹e
(
SŒEq
(""))));

100 
	gv®ue
.
£t_¡ršg_v®ue
("foobar");

101 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
), 
IsOkAndHŞds
(
Poš‹e
(
SŒEq
("foobar"))));

104 
TEST
(
JsÚUtTe¡
, 
JsÚG‘Numb”FasOnNÚNumb”s
) {

105 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

106 
	gv®ue
.
£t_¡ršg_v®ue
("");

107 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
).
¡©us
(),

108 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

110 
	gv®ue
.
mubË_li¡_v®ue
();

111 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
).
¡©us
(),

112 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

114 
	gv®ue
.
mubË_¡ruù_v®ue
();

115 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
).
¡©us
(),

116 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

119 
TEST
(
JsÚUtTe¡
, 
JsÚG‘Numb”SucûedsOnNumb”s
) {

120 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

121 
	gv®ue
.
£t_numb”_v®ue
(0.);

122 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
), 
IsOkAndHŞds
(0.));

124 
	gv®ue
.
£t_numb”_v®ue
(12.);

125 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
), 
IsOkAndHŞds
(12.));

127 
	gv®ue
.
£t_numb”_v®ue
(-3.14);

128 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
), 
IsOkAndHŞds
(-3.14));

131 
TEST
(
JsÚUtTe¡
, 
JsÚObjeùG‘F›ldFasIfTheF›ldIsAb£Á
) {

132 
	ggoogË
::
´Ùobuf
::
SŒuù
 
objeù
;

133 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

134 
	gv®ue
.
£t_numb”_v®ue
(0.);

135 
	gobjeù
.
mubË_f›lds
()->
š£¹
({"b¬", 
v®ue
});

136 
EXPECT_THAT
(
JsÚObjeùG‘F›ld
(
objeù
, "foo").
¡©us
(),

137 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

140 
TEST
(
JsÚUtTe¡
, 
JsÚObjeùG‘F›ldSucûedsIfTheF›ldIsP»£Á
) {

141 
	ggoogË
::
´Ùobuf
::
SŒuù
 
objeù
;

142 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

143 
	gv®ue
.
£t_numb”_v®ue
(0.);

144 
	gobjeù
.
mubË_f›lds
()->
š£¹
({"foo", 
v®ue
});

145 
EXPECT_THAT
(
JsÚObjeùG‘F›ld
(
objeù
, "foo"),

146 
IsOkAndHŞds
(
Poš‹e
(
Equ®sPrÙo
(
objeù
.
f›lds
().
©
("foo")))));

	@util/proto_struct_util_test.cc

19 
	~"asylo/ut/´Ùo_¡ruù_ut.h
"

21 
	~"googË/´Ùobuf/¡ruù.pb.h
"

22 
	~<gmock/gmock.h
>

23 
	~<g‹¡/g‹¡.h
>

24 
	~"asylo/‹¡/ut/´Ùo_m©ch”s.h
"

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/¡©us.h
"

28 
Çme¥aû
 
	gasylo
 {

29 
Çme¥aû
 
	gsgx
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
Poš‹e
;

33 
	gusšg
 ::
‹¡šg
::
SŒEq
;

35 
TEST
(
JsÚUtTe¡
, 
JsÚG‘ObjeùFasOnNÚObjeùs
) {

36 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

37 
	gv®ue
.
£t_numb”_v®ue
(0.);

38 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
).
¡©us
(),

39 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

41 
	gv®ue
.
£t_¡ršg_v®ue
("");

42 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
).
¡©us
(),

43 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

45 
	gv®ue
.
mubË_li¡_v®ue
();

46 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
).
¡©us
(),

47 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

50 
TEST
(
JsÚUtTe¡
, 
JsÚG‘ObjeùSucûedsOnObjeùs
) {

51 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

52 
	gv®ue
.
mubË_¡ruù_v®ue
();

53 
EXPECT_THAT
(
JsÚG‘Objeù
(
v®ue
),

54 
IsOkAndHŞds
(
Poš‹e
(
Equ®sPrÙo
(
googË
::
´Ùobuf
::
SŒuù
()))));

57 
TEST
(
JsÚUtTe¡
, 
JsÚG‘A¼ayFasOnNÚA¼ays
) {

58 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

59 
	gv®ue
.
£t_numb”_v®ue
(0.);

60 
EXPECT_THAT
(
JsÚG‘A¼ay
(
v®ue
).
¡©us
(),

61 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

63 
	gv®ue
.
£t_¡ršg_v®ue
("");

64 
EXPECT_THAT
(
JsÚG‘A¼ay
(
v®ue
).
¡©us
(),

65 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

67 
	gv®ue
.
mubË_¡ruù_v®ue
();

68 
EXPECT_THAT
(
JsÚG‘A¼ay
(
v®ue
).
¡©us
(),

69 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

72 
TEST
(
JsÚUtTe¡
, 
JsÚG‘A¼aySucûedsOnA¼ays
) {

73 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

74 
	gv®ue
.
mubË_li¡_v®ue
();

75 
EXPECT_THAT
(

76 
JsÚG‘A¼ay
(
v®ue
),

77 
IsOkAndHŞds
(
Poš‹e
(
Equ®sPrÙo
(
googË
::
´Ùobuf
::
Li¡V®ue
()))));

80 
TEST
(
JsÚUtTe¡
, 
JsÚG‘SŒšgFasOnNÚSŒšgs
) {

81 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

82 
	gv®ue
.
£t_numb”_v®ue
(0.);

83 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
).
¡©us
(),

84 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

86 
	gv®ue
.
mubË_li¡_v®ue
();

87 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
).
¡©us
(),

88 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

90 
	gv®ue
.
mubË_¡ruù_v®ue
();

91 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
).
¡©us
(),

92 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

95 
TEST
(
JsÚUtTe¡
, 
JsÚG‘SŒšgSucûedsOnSŒšgs
) {

96 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

97 
	gv®ue
.
£t_¡ršg_v®ue
("");

98 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
), 
IsOkAndHŞds
(
Poš‹e
(
SŒEq
(""))));

100 
	gv®ue
.
£t_¡ršg_v®ue
("foobar");

101 
EXPECT_THAT
(
JsÚG‘SŒšg
(
v®ue
), 
IsOkAndHŞds
(
Poš‹e
(
SŒEq
("foobar"))));

104 
TEST
(
JsÚUtTe¡
, 
JsÚG‘Numb”FasOnNÚNumb”s
) {

105 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

106 
	gv®ue
.
£t_¡ršg_v®ue
("");

107 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
).
¡©us
(),

108 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

110 
	gv®ue
.
mubË_li¡_v®ue
();

111 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
).
¡©us
(),

112 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

114 
	gv®ue
.
mubË_¡ruù_v®ue
();

115 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
).
¡©us
(),

116 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

119 
TEST
(
JsÚUtTe¡
, 
JsÚG‘Numb”SucûedsOnNumb”s
) {

120 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

121 
	gv®ue
.
£t_numb”_v®ue
(0.);

122 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
), 
IsOkAndHŞds
(0.));

124 
	gv®ue
.
£t_numb”_v®ue
(12.);

125 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
), 
IsOkAndHŞds
(12.));

127 
	gv®ue
.
£t_numb”_v®ue
(-3.14);

128 
EXPECT_THAT
(
JsÚG‘Numb”
(
v®ue
), 
IsOkAndHŞds
(-3.14));

131 
TEST
(
JsÚUtTe¡
, 
JsÚObjeùG‘F›ldFasIfTheF›ldIsAb£Á
) {

132 
	ggoogË
::
´Ùobuf
::
SŒuù
 
objeù
;

133 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

134 
	gv®ue
.
£t_numb”_v®ue
(0.);

135 
	gobjeù
.
mubË_f›lds
()->
š£¹
({"b¬", 
v®ue
});

136 
EXPECT_THAT
(
JsÚObjeùG‘F›ld
(
objeù
, "foo").
¡©us
(),

137 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

140 
TEST
(
JsÚUtTe¡
, 
JsÚObjeùG‘F›ldSucûedsIfTheF›ldIsP»£Á
) {

141 
	ggoogË
::
´Ùobuf
::
SŒuù
 
objeù
;

142 
	ggoogË
::
´Ùobuf
::
V®ue
 
v®ue
;

143 
	gv®ue
.
£t_numb”_v®ue
(0.);

144 
	gobjeù
.
mubË_f›lds
()->
š£¹
({"foo", 
v®ue
});

145 
EXPECT_THAT
(
JsÚObjeùG‘F›ld
(
objeù
, "foo"),

146 
IsOkAndHŞds
(
Poš‹e
(
Equ®sPrÙo
(
objeù
.
f›lds
().
©
("foo")))));

	@util/status.cc

19 
	~"asylo/ut/¡©us.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

24 
Çme¥aû
 
	gasylo
 {

26 #ifdeà
NDEBUG


27 
cÚ¡ex´
 
	gkMovedByCÚ¡ruùÜE¼ÜMsg
[] = "";

28 
cÚ¡ex´
 
	gkMovedByAssignm’tE¼ÜMsg
[] = "";

29 
cÚ¡ex´
 
	gkStusPrÙoE¼ÜS·ûMsg
[] = "";

30 
cÚ¡ex´
 
	gkStusPrÙoOkMism©chMsg
[] = "";

32 
cÚ¡ex´
 
	gkMovedByCÚ¡ruùÜE¼ÜMsg
[] =

34 
cÚ¡ex´
 
	gkMovedByAssignm’tE¼ÜMsg
[] = "Invalidated by move-assignment";

35 
cÚ¡ex´
 
	gkStusPrÙoE¼ÜS·ûMsg
[] =

37 
cÚ¡ex´
 
	gkStusPrÙoOkMism©chMsg
[] =

41 
	gStus
::
Stus
()

42 : 
”rÜ_¥aû_
(

43 
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
()),

44 
”rÜ_code_
(
”rÜ
::
GoogËE¼Ü
::
OK
) {}

46 
Stus
::Stus(cÚ¡ 
”rÜ
::
E¼ÜS·û
 *
¥aû
, 
code
,

47 
ab¦
::
¡ršg_v›w
 
mes§ge
)

48 : 
”rÜ_¥aû_
(
¥aû
), 
”rÜ_code_
(
code
) {

49 ià(
	gcode
 != 0) {

50 
mes§ge_
 = 
¡d
::
¡ršg
(
mes§ge
);

54 
	gStus
::
Stus
(Stu &&
Ùh”
)

55 : 
”rÜ_¥aû_
(
Ùh”
.error_space_),

56 
”rÜ_code_
(
Ùh”
.error_code_),

57 
mes§ge_
(
¡d
::
move
(
Ùh”
.message_)) {

58 
Ùh”
.
S‘
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kMovedByCÚ¡ruùÜE¼ÜMsg
);

61 
	gStus
 &Stus::
İ”©Ü
=(
Stus
 &&
Ùh”
) {

62 
”rÜ_¥aû_
 = 
Ùh”
.error_space_;

63 
	g”rÜ_code_
 = 
Ùh”
.
”rÜ_code_
;

64 
	gmes§ge_
 = 
¡d
::
move
(
Ùh”
.
mes§ge_
);

65 
	gÙh”
.
S‘
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kMovedByAssignm’tE¼ÜMsg
);

66  *
	gthis
;

69 
Stus
 
	gStus
::
OkStus
() {  Status(); }

71 
	gStus
::
”rÜ_code
(ècÚ¡ {  
”rÜ_code_
; }

73 
	gab¦
::
¡ršg_v›w
 
Stus
::
”rÜ_mes§ge
(ècÚ¡ {  
mes§ge_
; }

75 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
Stus
::
”rÜ_¥aû
(ècÚ¡ {  
”rÜ_¥aû_
; }

77 
boŞ
 
	gStus
::
ok
(ècÚ¡ {  
”rÜ_code_
 == 0; }

79 
	g¡d
::
¡ršg
 
Stus
::
ToSŒšg
() const {

80  
ok
(è? 
”rÜ_¥aû_
->
SŒšg
(
”rÜ_code_
)

81 : 
ab¦
::
SŒC©
(
”rÜ_¥aû_
->
S·ûName
(),

82 "::", 
”rÜ_¥aû_
->
SŒšg
(
”rÜ_code_
), ": ",

83 
mes§ge_
);

86 
Stus
 
	gStus
::
ToCªÚiÿl
() const {

88  
IsCªÚiÿl
(è? *
this
 : 
Stus
(
CªÚiÿlCode
(), 
ToSŒšg
());

91 
	g”rÜ
::
GoogËE¼Ü
 
Stus
::
CªÚiÿlCode
() const {

92  
”rÜ_¥aû_
->
GoogËE¼ÜCode
(
”rÜ_code_
);

95 
	gStus
::
SaveTo
(
StusPrÙo
 *
¡©us_´Ùo
) const {

96 
¡©us_´Ùo
->
£t_code
(
”rÜ_code_
);

97 
	g¡©us_´Ùo
->
£t_”rÜ_mes§ge
(
mes§ge_
);

98 
	g¡©us_´Ùo
->
£t_¥aû
(
”rÜ_¥aû_
->
S·ûName
());

99 
	g¡©us_´Ùo
->
£t_ÿnÚiÿl_code
(
CªÚiÿlCode
());

102 
	gStus
::
Re¡ÜeFrom
(cÚ¡ 
StusPrÙo
 &
¡©us_´Ùo
) {

104 
”rÜ_¥aû_
 = 
”rÜ
::
E¼ÜS·û
::
Fšd
(
¡©us_´Ùo
.
¥aû
());

105 ià(
	g”rÜ_¥aû_
) {

108 ià(
	g¡©us_´Ùo
.
has_ÿnÚiÿl_code
() &&

109 (
	g”rÜ_¥aû_
->
GoogËE¼ÜCode
(
¡©us_´Ùo
.
code
()) !=

110 
¡©us_´Ùo
.
ÿnÚiÿl_code
())) {

111 
S‘
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
, 
kStusPrÙoE¼ÜS·ûMsg
);

114 
	g”rÜ_code_
 = 
¡©us_´Ùo
.
code
();

118 
	g”rÜ_¥aû_
 =

119 
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
();

122 ià(
	g¡©us_´Ùo
.
has_ÿnÚiÿl_code
() &&

123 ((
	g¡©us_´Ùo
.
code
(è=ğ0è!ğ(
¡©us_´Ùo
.
ÿnÚiÿl_code
() == 0))) {

124 
S‘
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
, 
kStusPrÙoOkMism©chMsg
);

127 ià(
	g¡©us_´Ùo
.
has_ÿnÚiÿl_code
()) {

128 
	g”rÜ_code_
 = 
¡©us_´Ùo
.
ÿnÚiÿl_code
();

131 
	g”rÜ_code_
 = 
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
;

134 ià(
	g”rÜ_code_
 != 0) {

135 
mes§ge_
 = 
¡©us_´Ùo
.
”rÜ_mes§ge
();

137 
	gmes§ge_
.
ş—r
();

141 
boŞ
 
	gStus
::
IsCªÚiÿl
() const {

142  
”rÜ_¥aû_
->
S·ûName
(è=ğ
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
;

145 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Stus
 &
lhs
, cÚ¡ 
	gStus
 &
	grhs
) {

146  (
	glhs
.
”rÜ_code
(è=ğ
rhs
.error_code()) &&

147 (
lhs
.
”rÜ_mes§ge
(è=ğ
rhs
.error_message()) &&

148 (
lhs
.
”rÜ_¥aû
(è=ğ
rhs
.error_space());

151 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Stus
 &
lhs
, cÚ¡ 
	gStus
 &
	grhs
è{  !(
	glhs
 =ğ
rhs
); }

153 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
os
, cÚ¡ 
	gStus
 &
	g¡©us
) {

154  
	gos
 << 
	g¡©us
.
ToSŒšg
();

	@util/status.cc

19 
	~"asylo/ut/¡©us.h
"

21 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

22 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

24 
Çme¥aû
 
	gasylo
 {

26 #ifdeà
NDEBUG


27 
cÚ¡ex´
 
	gkMovedByCÚ¡ruùÜE¼ÜMsg
[] = "";

28 
cÚ¡ex´
 
	gkMovedByAssignm’tE¼ÜMsg
[] = "";

29 
cÚ¡ex´
 
	gkStusPrÙoE¼ÜS·ûMsg
[] = "";

30 
cÚ¡ex´
 
	gkStusPrÙoOkMism©chMsg
[] = "";

32 
cÚ¡ex´
 
	gkMovedByCÚ¡ruùÜE¼ÜMsg
[] =

34 
cÚ¡ex´
 
	gkMovedByAssignm’tE¼ÜMsg
[] = "Invalidated by move-assignment";

35 
cÚ¡ex´
 
	gkStusPrÙoE¼ÜS·ûMsg
[] =

37 
cÚ¡ex´
 
	gkStusPrÙoOkMism©chMsg
[] =

41 
	gStus
::
Stus
()

42 : 
”rÜ_¥aû_
(

43 
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
()),

44 
”rÜ_code_
(
”rÜ
::
GoogËE¼Ü
::
OK
) {}

46 
Stus
::Stus(cÚ¡ 
”rÜ
::
E¼ÜS·û
 *
¥aû
, 
code
,

47 
ab¦
::
¡ršg_v›w
 
mes§ge
)

48 : 
”rÜ_¥aû_
(
¥aû
), 
”rÜ_code_
(
code
) {

49 ià(
	gcode
 != 0) {

50 
mes§ge_
 = 
¡d
::
¡ršg
(
mes§ge
);

54 
	gStus
::
Stus
(Stu &&
Ùh”
)

55 : 
”rÜ_¥aû_
(
Ùh”
.error_space_),

56 
”rÜ_code_
(
Ùh”
.error_code_),

57 
mes§ge_
(
¡d
::
move
(
Ùh”
.message_)) {

58 
Ùh”
.
S‘
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kMovedByCÚ¡ruùÜE¼ÜMsg
);

61 
	gStus
 &Stus::
İ”©Ü
=(
Stus
 &&
Ùh”
) {

62 
”rÜ_¥aû_
 = 
Ùh”
.error_space_;

63 
	g”rÜ_code_
 = 
Ùh”
.
”rÜ_code_
;

64 
	gmes§ge_
 = 
¡d
::
move
(
Ùh”
.
mes§ge_
);

65 
	gÙh”
.
S‘
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kMovedByAssignm’tE¼ÜMsg
);

66  *
	gthis
;

69 
Stus
 
	gStus
::
OkStus
() {  Status(); }

71 
	gStus
::
”rÜ_code
(ècÚ¡ {  
”rÜ_code_
; }

73 
	gab¦
::
¡ršg_v›w
 
Stus
::
”rÜ_mes§ge
(ècÚ¡ {  
mes§ge_
; }

75 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
Stus
::
”rÜ_¥aû
(ècÚ¡ {  
”rÜ_¥aû_
; }

77 
boŞ
 
	gStus
::
ok
(ècÚ¡ {  
”rÜ_code_
 == 0; }

79 
	g¡d
::
¡ršg
 
Stus
::
ToSŒšg
() const {

80  
ok
(è? 
”rÜ_¥aû_
->
SŒšg
(
”rÜ_code_
)

81 : 
ab¦
::
SŒC©
(
”rÜ_¥aû_
->
S·ûName
(),

82 "::", 
”rÜ_¥aû_
->
SŒšg
(
”rÜ_code_
), ": ",

83 
mes§ge_
);

86 
Stus
 
	gStus
::
ToCªÚiÿl
() const {

88  
IsCªÚiÿl
(è? *
this
 : 
Stus
(
CªÚiÿlCode
(), 
ToSŒšg
());

91 
	g”rÜ
::
GoogËE¼Ü
 
Stus
::
CªÚiÿlCode
() const {

92  
”rÜ_¥aû_
->
GoogËE¼ÜCode
(
”rÜ_code_
);

95 
	gStus
::
SaveTo
(
StusPrÙo
 *
¡©us_´Ùo
) const {

96 
¡©us_´Ùo
->
£t_code
(
”rÜ_code_
);

97 
	g¡©us_´Ùo
->
£t_”rÜ_mes§ge
(
mes§ge_
);

98 
	g¡©us_´Ùo
->
£t_¥aû
(
”rÜ_¥aû_
->
S·ûName
());

99 
	g¡©us_´Ùo
->
£t_ÿnÚiÿl_code
(
CªÚiÿlCode
());

102 
	gStus
::
Re¡ÜeFrom
(cÚ¡ 
StusPrÙo
 &
¡©us_´Ùo
) {

104 
”rÜ_¥aû_
 = 
”rÜ
::
E¼ÜS·û
::
Fšd
(
¡©us_´Ùo
.
¥aû
());

105 ià(
	g”rÜ_¥aû_
) {

108 ià(
	g¡©us_´Ùo
.
has_ÿnÚiÿl_code
() &&

109 (
	g”rÜ_¥aû_
->
GoogËE¼ÜCode
(
¡©us_´Ùo
.
code
()) !=

110 
¡©us_´Ùo
.
ÿnÚiÿl_code
())) {

111 
S‘
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
, 
kStusPrÙoE¼ÜS·ûMsg
);

114 
	g”rÜ_code_
 = 
¡©us_´Ùo
.
code
();

118 
	g”rÜ_¥aû_
 =

119 
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
();

122 ià(
	g¡©us_´Ùo
.
has_ÿnÚiÿl_code
() &&

123 ((
	g¡©us_´Ùo
.
code
(è=ğ0è!ğ(
¡©us_´Ùo
.
ÿnÚiÿl_code
() == 0))) {

124 
S‘
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
, 
kStusPrÙoOkMism©chMsg
);

127 ià(
	g¡©us_´Ùo
.
has_ÿnÚiÿl_code
()) {

128 
	g”rÜ_code_
 = 
¡©us_´Ùo
.
ÿnÚiÿl_code
();

131 
	g”rÜ_code_
 = 
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
;

134 ià(
	g”rÜ_code_
 != 0) {

135 
mes§ge_
 = 
¡©us_´Ùo
.
”rÜ_mes§ge
();

137 
	gmes§ge_
.
ş—r
();

141 
boŞ
 
	gStus
::
IsCªÚiÿl
() const {

142  
”rÜ_¥aû_
->
S·ûName
(è=ğ
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
;

145 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Stus
 &
lhs
, cÚ¡ 
	gStus
 &
	grhs
) {

146  (
	glhs
.
”rÜ_code
(è=ğ
rhs
.error_code()) &&

147 (
lhs
.
”rÜ_mes§ge
(è=ğ
rhs
.error_message()) &&

148 (
lhs
.
”rÜ_¥aû
(è=ğ
rhs
.error_space());

151 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Stus
 &
lhs
, cÚ¡ 
	gStus
 &
	grhs
è{  !(
	glhs
 =ğ
rhs
); }

153 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
os
, cÚ¡ 
	gStus
 &
	g¡©us
) {

154  
	gos
 << 
	g¡©us
.
ToSŒšg
();

	@util/status.h

19 #iâdeà
ASYLO_UTIL_STATUS_H_


20 
	#ASYLO_UTIL_STATUS_H_


	)

22 
	~<o¡»am
>

23 
	~<¡ršg
>

24 
	~<ty³_Œa™s
>

25 
	~<ut™y
>

27 
	~"ab¦/m‘a/ty³_Œa™s.h
"

28 
	~"ab¦/¡ršgs/¡ršg_v›w.h
"

29 
	~"asylo/ut/loggšg.h
"

30 
	~"asylo/ut/”rÜ_codes.h
"

31 
	~"asylo/ut/”rÜ_¥aû.h
"

32 
	~"asylo/ut/¡©us.pb.h
"

33 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

34 
	~"asylo/ut/¡©us_š‹º®.h
"

36 
Çme¥aû
 
	gasylo
 {

41 şas 
	cStus
 {

42 
	gpublic
:

44 
Stus
();

51 
Stus
(cÚ¡ 
”rÜ
::
E¼ÜS·û
 *
¥aû
, 
code
, 
ab¦
::
¡ršg_v›w
 
mes§ge
);

58 
	g‹m¶©e
 <
ty³Çme
 
	gEnum
>

59 
Stus
(
Enum
 
code
, 
ab¦
::
¡ršg_v›w
 
mes§ge
) {

60 
S‘
(
code
, 
mes§ge
);

63 
Stus
(cÚ¡ Stu &
Ùh”
) = ;

67 
Stus
(Stu &&
Ùh”
);

81 
	g‹m¶©e
 <
ty³Çme
 
	gStusT
,

82 
ty³Çme
 
	gE
 =y³Çm
ab¦
::
’abË_if_t
<

83 
¡©us_š‹º®
::
¡©us_ty³_Œa™s
<
StusT
>::
is_¡©us
>>

84 
ex¶ic™
 
Stus
(cÚ¡ 
StusT
 &
Ùh”
) {

85 
S‘
(
¡©us_š‹º®
::
¡©us_ty³_Œa™s
<
StusT
>::
CªÚiÿlCode
(
Ùh”
),

86 
Ùh”
.
”rÜ_mes§ge
());

89 
	gStus
 &
	gİ”©Ü
=(cÚ¡ 
Stus
 &
Ùh”
) = ;

93 
	gStus
 &
	gİ”©Ü
=(
Stus
 &&
Ùh”
);

98 
Stus
 
OkStus
();

114 
	g‹m¶©e
 <
ty³Çme
 
	gStusT
,

115 
ty³Çme
 
	gE
 =y³Çm
ab¦
::
’abË_if_t
<

116 
¡©us_š‹º®
::
¡©us_ty³_Œa™s
<
StusT
>::
is_¡©us
>>

117 
StusT
 
ToOth”Stus
() {

118 
Stus
 
¡©us
 = 
ToCªÚiÿl
();

119  
StusT
(
¡©us_š‹º®
::
E¼ÜCodeHŞd”
(
¡©us
.
”rÜ_code_
),

120 
¡©us
.
mes§ge_
);

126 
”rÜ_code
() const;

131 
	gab¦
::
¡ršg_v›w
 
”rÜ_mes§ge
() const;

136 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
”rÜ_¥aû
() const;

141 
boŞ
 
ok
() const;

150 
	g¡d
::
¡ršg
 
ToSŒšg
() const;

162 
Stus
 
ToCªÚiÿl
() const;

167 
	g”rÜ
::
GoogËE¼Ü
 
CªÚiÿlCode
() const;

173 
SaveTo
(
StusPrÙo
 *
¡©us_´Ùo
) const;

194 
Re¡ÜeFrom
(cÚ¡ 
StusPrÙo
 &
¡©us_´Ùo
);

202 
	g‹m¶©e
 <
ty³Çme
 
	gEnum
>

203 
boŞ
 
Is
(
Enum
 
code
) const {

204  (
	g¡©ic_ÿ¡
<>(
	gcode
è=ğ
”rÜ_code_
) &&

205 (
”rÜ
::
”rÜ_’um_Œa™s
<
Enum
>::
g‘_”rÜ_¥aû
(è=ğ
”rÜ_¥aû_
);

208 
	g´iv©e
:

210 
‹m¶©e
 <
ty³Çme
 
Enum
,y³Çm
	gSŒšgT
>

211 
S‘
(
Enum
 
code
, 
SŒšgT
 &&
mes§ge
) {

212 
	g”rÜ_¥aû_
 = 
”rÜ
::
”rÜ_’um_Œa™s
<
Enum
>::
g‘_”rÜ_¥aû
();

213 
	g”rÜ_code_
 = 
¡©ic_ÿ¡
<>(
code
);

214 ià(
	g”rÜ_code_
 != 0) {

215 
mes§ge_
 = 
¡d
::
¡ršg
(¡d::
fÜw¬d
<
SŒšgT
>(
mes§ge
));

217 
	gmes§ge_
.
ş—r
();

223 
boŞ
 
IsCªÚiÿl
() const;

225 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
”rÜ_¥aû_
;

226 
	g”rÜ_code_
;

230 
	g¡d
::
¡ršg
 
mes§ge_
;

233 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Stus
 &
lhs
, cÚ¡ 
	gStus
 &
	grhs
);

235 
boŞ
 
	gİ”©Ü
!=(cÚ¡ 
Stus
 &
lhs
, cÚ¡ 
	gStus
 &
	grhs
);

237 
	g¡d
::
o¡»am
 &
İ”©Ü
<<(
¡d
::o¡»am &
os
, cÚ¡ 
	gStus
 &
	g¡©us
);

240 
	#ASYLO_CHECK_OK
(
v®
è
	`CHECK_EQ
(::
asylo
::
Stus
::
	`OkStus
(), (v®))

	)

	@util/status_error_space.cc

19 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
	gStusE¼ÜS·û
::
G‘In¡ªû
() {

25 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
StusE¼ÜS·û
();

26  
	gš¡ªû
;

29 
	gStusE¼ÜS·û
::
StusE¼ÜS·û
()

30 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
StusE¼ÜS·û
>(

32 
AddT¿n¦©iÚM­EÁry
(
¡©ic_ÿ¡
<>(
StusE¼Ü
::
MOVED
), "MOVED",

33 
GoogËE¼Ü
::
INTERNAL
);

34 
AddT¿n¦©iÚM­EÁry
(
¡©ic_ÿ¡
<>(
StusE¼Ü
::
RESTORE_ERROR
),

35 "RESTORE_ERROR", 
GoogËE¼Ü
::
INTERNAL
);

38 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
StusE¼Ü
> 
g
) {

39  
	gStusE¼ÜS·û
::
G‘In¡ªû
();

	@util/status_error_space.cc

19 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

21 
Çme¥aû
 
	gasylo
 {

22 
Çme¥aû
 
	g”rÜ
 {

24 
E¼ÜS·û
 cÚ¡ *
	gStusE¼ÜS·û
::
G‘In¡ªû
() {

25 
E¼ÜS·û
 cÚ¡ *
š¡ªû
 = 
Ãw
 
StusE¼ÜS·û
();

26  
	gš¡ªû
;

29 
	gStusE¼ÜS·û
::
StusE¼ÜS·û
()

30 : 
E¼ÜS·ûIm¶em’tiÚH–³r
<
StusE¼ÜS·û
>(

32 
AddT¿n¦©iÚM­EÁry
(
¡©ic_ÿ¡
<>(
StusE¼Ü
::
MOVED
), "MOVED",

33 
GoogËE¼Ü
::
INTERNAL
);

34 
AddT¿n¦©iÚM­EÁry
(
¡©ic_ÿ¡
<>(
StusE¼Ü
::
RESTORE_ERROR
),

35 "RESTORE_ERROR", 
GoogËE¼Ü
::
INTERNAL
);

38 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
StusE¼Ü
> 
g
) {

39  
	gStusE¼ÜS·û
::
G‘In¡ªû
();

	@util/status_error_space.h

19 #iâdeà
ASYLO_UTIL_STATUS_ERROR_SPACE_H_


20 
	#ASYLO_UTIL_STATUS_ERROR_SPACE_H_


	)

22 
	~"asylo/ut/”rÜ_¥aû.h
"

24 
Çme¥aû
 
	gasylo
 {

25 
Çme¥aû
 
	g”rÜ
 {

31 şas 
	cStusE¼Ü
 : {

32 
OK
 = 0,

35 
	gMOVED
 = 1,

39 
	gRESTORE_ERROR
 = 2,

43 
şass
 
	gStusE¼ÜS·û


44 : 
public
 
E¼ÜS·ûIm¶em’tiÚH–³r
<
StusE¼ÜS·û
> {

45 
public
:

46 
usšg
 
code_ty³
 = 
StusE¼Ü
;

48 
StusE¼ÜS·û
(cÚ¡ StusE¼ÜS·û &èğ
d–‘e
;

49 
	gStusE¼ÜS·û
 &
	gİ”©Ü
=(cÚ¡ 
StusE¼ÜS·û
 &èğ
d–‘e
;

52 
E¼ÜS·û
 cÚ¡ *
G‘In¡ªû
();

54 
	g´iv©e
:

55 
StusE¼ÜS·û
();

60 
E¼ÜS·û
 cÚ¡ *
G‘E¼ÜS·û
(
E¼ÜS·ûAdlTag
<
StusE¼Ü
> 
g
);

	@util/status_internal.h

19 #iâdeà
ASYLO_UTIL_STATUS_INTERNAL_H_


20 
	#ASYLO_UTIL_STATUS_INTERNAL_H_


	)

26 
	~<¡ršg
>

27 
	~<ty³_Œa™s
>

29 
	~"ab¦/m‘a/ty³_Œa™s.h
"

30 
	~"asylo/ut/”rÜ_¥aû.h
"

32 
Çme¥aû
 
	gasylo
 {

33 
Çme¥aû
 
	g¡©us_š‹º®
 {

40 
	sE¼ÜCodeHŞd”
 {

42 
ex¶ic™
 
E¼ÜCodeHŞd”
(
code
è: 
”rÜ_code
(code) {}

46 
‹m¶©e
 <
ty³Çme
 
EnumT
,

47 
ty³Çme
 
	gE
 =y³Çm
ab¦
::
’abË_if_t
<
¡d
::
is_’um
<
EnumT
>::
v®ue
>>

48 
İ”©Ü
 
EnumT
() {

49  
¡©ic_ÿ¡
<
EnumT
>(
”rÜ_code
);

51 
	g”rÜ_code
;

70 
	g‹m¶©e
 <
ty³Çme
 
	gStusT
>

71 
	s¡©us_ty³_Œa™s
 {

72 
	g´iv©e
:

78 
‹m¶©e
 <
ty³Çme
 
StusU
>

79 autØ
CheckMšim®Api
(
StusU
 *
s
, *
i
, 
¡d
::
¡ršg
 *
¡r
, 
boŞ
 *
b
)

80 -> 
deşty³
(
StusU
(
E¼ÜCodeHŞd”
(0), ""), *
i
 = 
s
->
”rÜ_code
(),

81 *
¡r
 = 
s
->
”rÜ_mes§ge
(), *
b
 = s->
ok
(), 
¡d
::
Œue_ty³
());

85 
	g‹m¶©e
 <
ty³Çme
 
	gStusU
>

86 autØ
CheckMšim®Api
(...è-> 
deşty³
(
¡d
::
çl£_ty³
());

87 
usšg
 
	gmšim®_­i_ty³
 = 
deşty³
(
CheckMšim®Api
<
StusT
>(

88 
¡©ic_ÿ¡
<
StusT
 *>(0), static_cast<*>(0),

89 
¡©ic_ÿ¡
<
¡d
::
¡ršg
 *>(0), stic_ÿ¡<
boŞ
 *>(0)));

95 
	g‹m¶©e
 <
ty³Çme
 
	gStusU
>

96 autØ
CheckEx‹ndedApi
(
StusU
 *
s
, *
i
)

97 -> 
deşty³
(*
i
 = 
s
->
CªÚiÿl
());

101 
	g‹m¶©e
 <
ty³Çme
 
	gStusU
>

102 autØ
CheckEx‹ndedApi
(...è-> 
deşty³
(
¡d
::
çl£_ty³
());

103 
usšg
 
	gex‹nded_­i_ty³
 = 
deşty³
(
CheckEx‹ndedApi
<
StusT
>(

104 
¡©ic_ÿ¡
<
StusT
 *>(0), static_cast<*>(0)));

108 
	g”rÜ
::
GoogËE¼Ü
 
CªÚiÿlCode
(cÚ¡ 
StusT
 &
¡©us
,

109 
¡d
::
Œue_ty³
 
t
) {

110  
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
¡©us
.
CªÚiÿlCode
());

115 
	g”rÜ
::
GoogËE¼Ü
 
CªÚiÿlCode
(cÚ¡ 
StusT
 &
¡©us
,

116 
¡d
::
çl£_ty³
 
t
) {

117  
¡©ic_ÿ¡
<
”rÜ
::
GoogËE¼Ü
>(
¡©us
.
”rÜ_code
());

120 
	gpublic
:

121 
cÚ¡ex´
 
boŞ
 
is_¡©us
 = 
mšim®_­i_ty³
::
v®ue
;

125 
	g”rÜ
::
GoogËE¼Ü
 
CªÚiÿlCode
(cÚ¡ 
StusT
 &
¡©us
) {

126 
¡©ic_as£¹
(

127 
is_¡©us
,

129  
CªÚiÿlCode
(
¡©us
, 
ex‹nded_­i_ty³
());

	@util/status_macros.h

19 #iâdeà
ASYLO_UTIL_STATUS_MACROS_H_


20 
	#ASYLO_UTIL_STATUS_MACROS_H_


	)

22 
	~"ab¦/ba£/İtimiz©iÚ.h
"

36 
	#ASYLO_RETURN_IF_ERROR
(
ex´
) \

38 cÚ¡‡utØ
_asylo_¡©us_to_v”ify
 = (
ex´
); \

39 ià(
	`ABSL_PREDICT_FALSE
(!
_asylo_¡©us_to_v”ify
.
	`ok
())) { \

40  
_asylo_¡©us_to_v”ify
; \

42 } 
çl£
)

	)

76 
	#ASYLO_ASSIGN_OR_RETURN
(
lhs
, 
»x´
) \

78 autØ
_asylo_¡©us_Ü_v®ue
 = (
»x´
); \

79 ià(
	`ABSL_PREDICT_FALSE
(!
_asylo_¡©us_Ü_v®ue
.
	`ok
())) { \

80  
_asylo_¡©us_Ü_v®ue
.
	`¡©us
(); \

82 
lhs
 = 
¡d
::
	`move
(
_asylo_¡©us_Ü_v®ue
).
	`V®ueOrD›
(); \

83 } 
çl£
)

	)

	@util/status_macros_test.cc

19 
	~"asylo/ut/¡©us_maüos.h
"

21 
	~<¡ršg
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
TEST
(
R‘uºIfE¼Ü
, 
R‘uºsOnE¼ÜStus
) {

35 autØ
	gfunc
 = [](è-> 
Stus
 {

36 
ASYLO_RETURN_IF_ERROR
(
Stus
::
OkStus
());

37 
ASYLO_RETURN_IF_ERROR
(
Stus
::
OkStus
());

38 
ASYLO_RETURN_IF_ERROR
(
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "ERROR");

42 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

45 
TEST
(
R‘uºIfE¼Ü
, 
R‘uºsOnE¼ÜFromLambda
) {

46 autØ
	gfunc
 = [](è-> 
Stus
 {

47 
ASYLO_RETURN_IF_ERROR
([] {  
Stus
::
OkStus
(); }());

48 
ASYLO_RETURN_IF_ERROR
(

49 [] {  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"); }());

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "ERROR");

53 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

56 
TEST
(
AssignOrR‘uº
, 
AssignsMuÉËV¬ŸbËsInSequ’û
) {

57 autØ
	gfunc
 = [](è-> 
Stus
 {

58 
v®ue1
;

59 
ASYLO_ASSIGN_OR_RETURN
(
v®ue1
, 
StusOr
<>(1));

60 
EXPECT_EQ
(1, 
v®ue1
);

61 
	gv®ue2
;

62 
ASYLO_ASSIGN_OR_RETURN
(
v®ue2
, 
StusOr
<>(2));

63 
EXPECT_EQ
(2, 
v®ue2
);

64 
	gv®ue3
;

65 
ASYLO_ASSIGN_OR_RETURN
(
v®ue3
, 
StusOr
<>(3));

66 
EXPECT_EQ
(3, 
v®ue3
);

67 
	gv®ue4
;

68 
ASYLO_ASSIGN_OR_RETURN
(

69 
v®ue4
, 
StusOr
<>(
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED")));

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
,

71 
ab¦
::
SŒC©
("ERROR:‡ssigÃd v®u", 
v®ue4
));

74 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

77 
TEST
(
AssignOrR‘uº
, 
AssignsR•—‹dlyToSšgËV¬ŸbË
) {

78 autØ
	gfunc
 = [](è-> 
Stus
 {

79 
v®ue
 = 1;

80 
ASYLO_ASSIGN_OR_RETURN
(
v®ue
, 
StusOr
<>(2));

81 
EXPECT_EQ
(2, 
v®ue
);

82 
ASYLO_ASSIGN_OR_RETURN
(
v®ue
, 
StusOr
<>(3));

83 
EXPECT_EQ
(3, 
v®ue
);

84 
ASYLO_ASSIGN_OR_RETURN
(

85 
v®ue
, 
StusOr
<>(
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED")));

86  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "ERROR");

89 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

92 
TEST
(
AssignOrR‘uº
, 
MovesUniquePŒ
) {

93 autØ
	gfunc
 = [](è-> 
Stus
 {

94 
¡d
::
unique_±r
<> 
±r
;

95 
ASYLO_ASSIGN_OR_RETURN
(

96 
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
ab¦
::
make_unique
<>(1)));

97 
EXPECT_EQ
(*
±r
, 1);

98  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED");

101 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

104 
TEST
(
AssignOrR‘uº
, 
DÛsNÙAssignUniquePŒOnE¼ÜStus
) {

105 autØ
	gfunc
 = [](è-> 
Stus
 {

106 
¡d
::
unique_±r
<> 
±r
;

107 
ASYLO_ASSIGN_OR_RETURN
(
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
Stus
(

108 
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED")));

109 
EXPECT_EQ
(
±r
, 
nuÎ±r
);

110  
	gStus
::
OkStus
();

113 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

116 
TEST
(
AssignOrR‘uº
, 
MovesUniquePŒR•—‹dlyToSšgËV¬ŸbË
) {

117 autØ
	gfunc
 = [](è-> 
Stus
 {

118 
¡d
::
unique_±r
<> 
±r
;

119 
ASYLO_ASSIGN_OR_RETURN
(

120 
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
ab¦
::
make_unique
<>(1)));

121 
EXPECT_EQ
(*
±r
, 1);

122 
ASYLO_ASSIGN_OR_RETURN
(

123 
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
ab¦
::
make_unique
<>(2)));

124 
EXPECT_EQ
(*
±r
, 2);

125  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED");

128 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

	@util/status_macros_test.cc

19 
	~"asylo/ut/¡©us_maüos.h
"

21 
	~<¡ršg
>

23 
	~"ab¦/¡ršgs/¡r_ÿt.h
"

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/memÜy/memÜy.h
"

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us.h
"

29 
	~"asylo/ut/¡©usÜ.h
"

31 
Çme¥aû
 
	gasylo
 {

32 
	gÇme¥aû
 {

34 
TEST
(
R‘uºIfE¼Ü
, 
R‘uºsOnE¼ÜStus
) {

35 autØ
	gfunc
 = [](è-> 
Stus
 {

36 
ASYLO_RETURN_IF_ERROR
(
Stus
::
OkStus
());

37 
ASYLO_RETURN_IF_ERROR
(
Stus
::
OkStus
());

38 
ASYLO_RETURN_IF_ERROR
(
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

39  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "ERROR");

42 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

45 
TEST
(
R‘uºIfE¼Ü
, 
R‘uºsOnE¼ÜFromLambda
) {

46 autØ
	gfunc
 = [](è-> 
Stus
 {

47 
ASYLO_RETURN_IF_ERROR
([] {  
Stus
::
OkStus
(); }());

48 
ASYLO_RETURN_IF_ERROR
(

49 [] {  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"); }());

50  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "ERROR");

53 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

56 
TEST
(
AssignOrR‘uº
, 
AssignsMuÉËV¬ŸbËsInSequ’û
) {

57 autØ
	gfunc
 = [](è-> 
Stus
 {

58 
v®ue1
;

59 
ASYLO_ASSIGN_OR_RETURN
(
v®ue1
, 
StusOr
<>(1));

60 
EXPECT_EQ
(1, 
v®ue1
);

61 
	gv®ue2
;

62 
ASYLO_ASSIGN_OR_RETURN
(
v®ue2
, 
StusOr
<>(2));

63 
EXPECT_EQ
(2, 
v®ue2
);

64 
	gv®ue3
;

65 
ASYLO_ASSIGN_OR_RETURN
(
v®ue3
, 
StusOr
<>(3));

66 
EXPECT_EQ
(3, 
v®ue3
);

67 
	gv®ue4
;

68 
ASYLO_ASSIGN_OR_RETURN
(

69 
v®ue4
, 
StusOr
<>(
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED")));

70  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
,

71 
ab¦
::
SŒC©
("ERROR:‡ssigÃd v®u", 
v®ue4
));

74 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

77 
TEST
(
AssignOrR‘uº
, 
AssignsR•—‹dlyToSšgËV¬ŸbË
) {

78 autØ
	gfunc
 = [](è-> 
Stus
 {

79 
v®ue
 = 1;

80 
ASYLO_ASSIGN_OR_RETURN
(
v®ue
, 
StusOr
<>(2));

81 
EXPECT_EQ
(2, 
v®ue
);

82 
ASYLO_ASSIGN_OR_RETURN
(
v®ue
, 
StusOr
<>(3));

83 
EXPECT_EQ
(3, 
v®ue
);

84 
ASYLO_ASSIGN_OR_RETURN
(

85 
v®ue
, 
StusOr
<>(
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED")));

86  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "ERROR");

89 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

92 
TEST
(
AssignOrR‘uº
, 
MovesUniquePŒ
) {

93 autØ
	gfunc
 = [](è-> 
Stus
 {

94 
¡d
::
unique_±r
<> 
±r
;

95 
ASYLO_ASSIGN_OR_RETURN
(

96 
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
ab¦
::
make_unique
<>(1)));

97 
EXPECT_EQ
(*
±r
, 1);

98  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED");

101 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

104 
TEST
(
AssignOrR‘uº
, 
DÛsNÙAssignUniquePŒOnE¼ÜStus
) {

105 autØ
	gfunc
 = [](è-> 
Stus
 {

106 
¡d
::
unique_±r
<> 
±r
;

107 
ASYLO_ASSIGN_OR_RETURN
(
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
Stus
(

108 
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED")));

109 
EXPECT_EQ
(
±r
, 
nuÎ±r
);

110  
	gStus
::
OkStus
();

113 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

116 
TEST
(
AssignOrR‘uº
, 
MovesUniquePŒR•—‹dlyToSšgËV¬ŸbË
) {

117 autØ
	gfunc
 = [](è-> 
Stus
 {

118 
¡d
::
unique_±r
<> 
±r
;

119 
ASYLO_ASSIGN_OR_RETURN
(

120 
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
ab¦
::
make_unique
<>(1)));

121 
EXPECT_EQ
(*
±r
, 1);

122 
ASYLO_ASSIGN_OR_RETURN
(

123 
±r
, 
StusOr
<
¡d
::
unique_±r
<>>(
ab¦
::
make_unique
<>(2)));

124 
EXPECT_EQ
(*
±r
, 2);

125  
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED");

128 
EXPECT_THAT
(
func
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "EXPECTED"));

	@util/status_test.cc

19 
	~"asylo/ut/¡©us.h
"

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

27 
	~"šşude/g½ıp/suµÜt/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
NÙ
;

34 
cÚ¡ex´
 
	gkE¼ÜMes§ge1
[] = "Bad foo‡rgument";

35 
cÚ¡ex´
 
	gkE¼ÜMes§ge2
[] = "Internal foobarƒrror";

37 
cÚ¡ex´
 
	gkBadE¼ÜS·û
[] = "Foo barƒrror space";

39 
TEST
(
StusTe¡
, 
OkSucûss
è{ 
EXPECT_TRUE
(::
asylo
::
Stus
::
OkStus
().
ok
()); }

41 
TEST
(
StusTe¡
, 
OkFau»
) {

42 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

43 
EXPECT_FALSE
(
¡©us
.
ok
());

46 
TEST
(
StusTe¡
, 
G‘E¼ÜCodeOkStus
) {

47 
EXPECT_EQ
(::
asylo
::
Stus
::
OkStus
().
”rÜ_code
(), 
”rÜ
::
GoogËE¼Ü
::
OK
);

50 
TEST
(
StusTe¡
, 
G‘E¼ÜCodeNÚOkStus
) {

51 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

52 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

55 
TEST
(
StusTe¡
, 
G‘E¼ÜMes§geOkStus
) {

56 
EXPECT_TRUE
(
Stus
::
OkStus
().
”rÜ_mes§ge
().
em±y
());

59 
TEST
(
StusTe¡
, 
G‘E¼ÜMes§geNÚOkStus
) {

60 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

61 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
kE¼ÜMes§ge1
);

64 
TEST
(
StusTe¡
, 
G‘E¼ÜS·ûOkStus
) {

65 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
”rÜ_¥aû
 = 
Stus
::
OkStus
().error_space();

66 
EXPECT_EQ
(
”rÜ_¥aû
->
S·ûName
(), 
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

69 
TEST
(
StusTe¡
, 
G‘E¼ÜS·ûNÚOkStus
) {

70 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

71 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
”rÜ_¥aû
 = 
¡©us
.error_space();

72 
EXPECT_EQ
(
”rÜ_¥aû
->
S·ûName
(), 
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

75 
TEST
(
StusTe¡
, 
ToSŒšgOkStus
) {

76 ::
asylo
::
Stus
 
¡©us
 = Stus::
OkStus
();

77 
	g¡d
::
¡ršg
 
”rÜ_code_Çme
 =

78 
¡©us
.
”rÜ_¥aû
()->
SŒšg
(¡©us.
”rÜ_code
());

82 
	g¡d
::
¡ršg
 
¡©us_»p
 = 
¡©us
.
ToSŒšg
();

83 
EXPECT_NE
(
¡©us_»p
.
fšd
(
”rÜ_code_Çme
), 
¡d
::
¡ršg
::
Åos
);

86 
TEST
(
StusTe¡
, 
ToSŒšgNÚOkStus
) {

87 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

88 
	g¡d
::
¡ršg
 
”rÜ_code_Çme
 =

89 
¡©us
.
”rÜ_¥aû
()->
SŒšg
(¡©us.
”rÜ_code
());

90 
	g¡d
::
¡ršg
 
”rÜ_¥aû_Çme
 = 
¡©us
.
”rÜ_¥aû
()->
S·ûName
();

94 
	g¡d
::
¡ršg
 
¡©us_»p
 = 
¡©us
.
ToSŒšg
();

95 
EXPECT_NE
(
¡©us_»p
.
fšd
(
”rÜ_¥aû_Çme
), 
¡d
::
¡ršg
::
Åos
);

96 
EXPECT_NE
(
¡©us_»p
.
fšd
(
”rÜ_code_Çme
), 
¡d
::
¡ršg
::
Åos
);

97 
EXPECT_NE
(
¡©us_»p
.
fšd
(
¡d
::
¡ršg
(
¡©us
.
”rÜ_mes§ge
())),

98 
¡d
::
¡ršg
::
Åos
);

101 
TEST
(
StusTe¡
, 
Equ®™y
) {

102 ::
asylo
::
Stus
 
ok_¡©us
 = Stus::
OkStus
();

103 
Stus
 
”rÜ_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

105 
EXPECT_TRUE
(
ok_¡©us
 == ok_status);

106 
EXPECT_TRUE
(
”rÜ_¡©us
 ==ƒrror_status);

107 
EXPECT_FALSE
(
ok_¡©us
 =ğ
”rÜ_¡©us
);

110 
TEST
(
StusTe¡
, 
IÃqu®™y
) {

111 
	gasylo
::
Stus
 
ok_¡©us
 = Stus::
OkStus
();

112 
	gasylo
::
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

113 
kE¼ÜMes§ge1
);

114 
	gasylo
::
Stus
 
š‹º®_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
kE¼ÜMes§ge2
);

116 
EXPECT_FALSE
(
ok_¡©us
 != ok_status);

117 
EXPECT_FALSE
(
šv®id_¬g_¡©us
 != invalid_arg_status);

119 
EXPECT_TRUE
(
ok_¡©us
 !ğ
šv®id_¬g_¡©us
);

120 
EXPECT_TRUE
(
šv®id_¬g_¡©us
 !ğ
ok_¡©us
);

122 
EXPECT_TRUE
(
šv®id_¬g_¡©us
 !ğ
š‹º®_¡©us
);

123 
EXPECT_TRUE
(
š‹º®_¡©us
 !ğ
šv®id_¬g_¡©us
);

126 
TEST
(
StusTe¡
, 
ToCªÚiÿlOk
) {

127 
EXPECT_EQ
(
Stus
::
OkStus
().
ToCªÚiÿl
(), Status::OkStatus());

130 
TEST
(
StusTe¡
, 
ToCªÚiÿlNÚOk
) {

131 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

132 
EXPECT_EQ
(
¡©us
.
ToCªÚiÿl
(), status);

135 
TEST
(
StusTe¡
, 
ToCªÚiÿlNÚOkNÚCªÚiÿl
) {

136 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

137 
Stus
 
	gÿnÚiÿl
 = 
¡©us
.
ToCªÚiÿl
();

143 
EXPECT_EQ
(
ÿnÚiÿl
,

144 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
¡©us
.
ToSŒšg
()));

147 
TEST
(
StusTe¡
, 
CªÚiÿlCodeOk
) {

148 
EXPECT_EQ
(
Stus
::
OkStus
().
CªÚiÿlCode
(), 
”rÜ
::
GoogËE¼Ü
::
OK
);

151 
TEST
(
StusTe¡
, 
CªÚiÿlCodeNÚOk
) {

152 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

153 
EXPECT_EQ
(
¡©us
.
CªÚiÿlCode
(), stus.
”rÜ_code
());

156 
TEST
(
StusTe¡
, 
CªÚiÿlCodeNÚOkNÚCªÚiÿl
) {

157 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

158 
EXPECT_EQ
(
¡©us
.
CªÚiÿlCode
(), 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

161 
TEST
(
StusTe¡
, 
SaveTo
) {

162 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

163 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

164 
	g¡©us
.
SaveTo
(&
¡©us_´Ùo
);

166 
EXPECT_EQ
(
¡©us_´Ùo
.
code
(), 
¡©us
.
”rÜ_code
());

167 
EXPECT_EQ
(
¡©us_´Ùo
.
”rÜ_mes§ge
(), 
¡©us
.error_message());

168 
EXPECT_EQ
(
¡©us_´Ùo
.
¥aû
(), 
¡©us
.
”rÜ_¥aû
()->
S·ûName
());

171 
TEST
(
StusTe¡
, 
Re¡ÜeFromOk
) {

172 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

173 
	g¡©us_´Ùo
.
£t_code
(
”rÜ
::
GoogËE¼Ü
::
OK
);

174 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

175 
	g¡©us_´Ùo
.
£t_¥aû
(
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

177 ::
asylo
::
Stus
 
¡©us
;

178 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

180 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
¡©us_´Ùo
.
code
());

182 
EXPECT_TRUE
(
¡©us
.
”rÜ_mes§ge
().
em±y
());

183 
EXPECT_EQ
(
¡©us
.
”rÜ_¥aû
()->
S·ûName
(), 
¡©us_´Ùo
.
¥aû
());

186 
TEST
(
StusTe¡
, 
Re¡ÜeFromNÚOk
) {

187 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

188 
	g¡©us_´Ùo
.
£t_code
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

189 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

190 
	g¡©us_´Ùo
.
£t_¥aû
(
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

192 ::
asylo
::
Stus
 
¡©us
;

193 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

195 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

196 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
¡©us_´Ùo
.error_message());

199 
TEST
(
StusTe¡
, 
Re¡ÜeFromNÚOkInv®idCªÚiÿlCode
) {

202 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

203 
	g¡©us_´Ùo
.
£t_code
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
);

204 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

205 
	g¡©us_´Ùo
.
£t_¥aû
(
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

206 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(
”rÜ
::
GoogËE¼Ü
::
UNAUTHENTICATED
);

208 ::
asylo
::
Stus
 
¡©us
;

209 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

211 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
));

214 
TEST
(
StusTe¡
, 
Re¡ÜeFromUnknownE¼ÜS·û
) {

216 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

217 
	g¡©us_´Ùo
.
£t_code
(42);

218 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

219 
	g¡©us_´Ùo
.
£t_¥aû
(
kBadE¼ÜS·û
);

220 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

222 ::
asylo
::
Stus
 
¡©us
;

223 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

225 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

226 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
¡©us_´Ùo
.error_message());

229 
TEST
(
StusTe¡
, 
Re¡ÜeFromUnknownE¼ÜS·ûMissšgCªÚiÿlCode
) {

231 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

232 
	g¡©us_´Ùo
.
£t_code
(42);

233 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

234 
	g¡©us_´Ùo
.
£t_¥aû
(
kBadE¼ÜS·û
);

236 ::
asylo
::
Stus
 
¡©us
;

237 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

239 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
));

240 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
¡©us_´Ùo
.error_message());

243 
TEST
(
StusTe¡
, 
Re¡ÜeFromUnknownE¼ÜS·ûInv®id
) {

246 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

247 
	g¡©us_´Ùo
.
£t_code
(0);

248 
	g¡©us_´Ùo
.
£t_¥aû
(
kBadE¼ÜS·û
);

249 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

251 
	gasylo
::
Stus
 
¡©us
;

252 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

254 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
));

258 
	g¡©us_´Ùo
.
CË¬
();

259 
	g¡©us_´Ùo
.
£t_code
(42);

260 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(0);

262 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

264 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
));

267 
TEST
(
StusTe¡
, 
SaveToRe¡ÜeFromEndToEnd
) {

268 ::
asylo
::
Stus
 
¡©us1
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

270 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

271 
	g¡©us1
.
SaveTo
(&
¡©us_´Ùo
);

273 ::
asylo
::
Stus
 
¡©us2
;

274 
	g¡©us2
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

276 
EXPECT_EQ
(
¡©us1
, 
¡©us2
);

279 
TEST
(
StusTe¡
, 
CÚ¡ruùFromG½cStusOk
) {

281 ::
g½c
::
Stus
 
g½c_¡©us
;

282 ::
asylo
::
Stus
 
¡©us
(
g½c_¡©us
);

284 
EXPECT_THAT
(
¡©us
, 
IsOk
());

287 
TEST
(
StusTe¡
, 
CÚ¡ruùFromG½cStusNÚOk
) {

288 ::
g½c
::
Stus
 
g½c_¡©us
(::g½c::
StusCode
::
INVALID_ARGUMENT
,

289 
kE¼ÜMes§ge1
);

290 ::
asylo
::
Stus
 
¡©us
(
g½c_¡©us
);

292 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

295 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
g½c_¡©us
.error_code());

296 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
g½c_¡©us
.error_message());

299 
TEST
(
StusTe¡
, 
CÚv”tToG½cStusOk
) {

300 ::
asylo
::
Stus
 
¡©us
 = ::asylo::Stus::
OkStus
();

301 ::
g½c
::
Stus
 
g½c_¡©us
 = 
¡©us
.
ToOth”Stus
<::grpc::Status>();

303 
EXPECT_EQ
(
¡©us
.
ok
(), 
g½c_¡©us
.ok());

304 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
g½c_¡©us
.error_code());

305 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
g½c_¡©us
.error_message());

308 
TEST
(
StusTe¡
, 
CÚv”tToG½cStusNÚOk
) {

309 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

310 ::
g½c
::
Stus
 
g½c_¡©us
 = 
¡©us
.
ToOth”Stus
<::grpc::Status>();

312 
EXPECT_EQ
(
¡©us
.
ok
(), 
g½c_¡©us
.ok());

313 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
g½c_¡©us
.error_code());

314 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
g½c_¡©us
.error_message());

317 
TEST
(
StusTe¡
, 
CÚv”tToG½cStusNÚOkNÚCªÚiÿl
) {

318 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

319 ::
g½c
::
Stus
 
g½c_¡©us
 = 
¡©us
.
ToOth”Stus
<::grpc::Status>();

326 
EXPECT_EQ
(
g½c_¡©us
.
ok
(), 
¡©us
.ok());

327 
EXPECT_EQ
(
g½c_¡©us
.
”rÜ_code
(), ::
g½c
::
StusCode
::
INVALID_ARGUMENT
);

328 
EXPECT_EQ
(
g½c_¡©us
.
”rÜ_mes§ge
(), 
¡©us
.
ToSŒšg
());

331 
TEST
(
StusTe¡
, 
IsPos™iveTe¡
) {

332 
EXPECT_TRUE
(
Stus
::
OkStus
().
Is
(
”rÜ
::
GoogËE¼Ü
::
OK
));

334 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

335 
kE¼ÜMes§ge1
);

336 
EXPECT_TRUE
(
šv®id_¬g_¡©us
.
Is
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

338 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

339 
EXPECT_TRUE
(
ešv®_¡©us
.
Is
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
));

342 
TEST
(
StusTe¡
, 
IsNeg©iveTe¡
) {

344 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

345 
kE¼ÜMes§ge1
);

346 
EXPECT_FALSE
(
šv®id_¬g_¡©us
.
Is
(
”rÜ
::
GoogËE¼Ü
::
OK
));

349 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

350 
EXPECT_FALSE
(
ešv®_¡©us
.
Is
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

353 
TEST
(
StusTe¡
, 
StusIsM©ch”
) {

354 
EXPECT_THAT
(
Stus
::
OkStus
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

356 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

357 
kE¼ÜMes§ge1
);

358 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

359 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

361 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

362 
EXPECT_THAT
(
ešv®_¡©us
, 
StusIs
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
));

365 
TEST
(
StusTe¡
, 
IsOkM©ch”
) {

366 
EXPECT_THAT
(
Stus
::
OkStus
(), 
IsOk
());

369 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

370 
EXPECT_THAT
(
ešv®_¡©us
, 
NÙ
(
IsOk
()));

373 
TEST
(
StusTe¡
, 
MoveCÚ¡ruùÜTe¡
) {

374 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

375 
kE¼ÜMes§ge1
);

376 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

377 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

379 
Stus
 
th©
(
¡d
::
move
(
šv®id_¬g_¡©us
));

381 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

382 
EXPECT_THAT
(
šv®id_¬g_¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
));

385 
TEST
(
StusTe¡
, 
MoveAssignm’tTe¡NÚOk
) {

386 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

387 
kE¼ÜMes§ge1
);

388 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

389 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

391 
Stus
 
th©
(
”rÜ
::
GoogËE¼Ü
::
CANCELLED
, 
kE¼ÜMes§ge2
);

392 
	gth©
 = 
¡d
::
move
(
šv®id_¬g_¡©us
);

394 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

395 
EXPECT_THAT
(
šv®id_¬g_¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
));

398 
TEST
(
StusTe¡
, 
MoveAssignm’tTe¡Ok
) {

399 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

400 
kE¼ÜMes§ge1
);

401 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

402 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

404 
Stus
 
	gok
 = Stus::
OkStus
();

405 
	gšv®id_¬g_¡©us
 = 
¡d
::
move
(
ok
);

407 
EXPECT_THAT
(
šv®id_¬g_¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
, ""));

408 
EXPECT_THAT
(
ok
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
));

411 
TEST
(
StusTe¡
, 
CİyCÚ¡ruùÜTe¡Ok
) {

412 
Stus
 
th©
(Stus::
OkStus
());

414 
EXPECT_THAT
(
th©
, 
IsOk
());

415 
EXPECT_TRUE
(
th©
.
”rÜ_mes§ge
().
em±y
());

418 
TEST
(
StusTe¡
, 
CİyCÚ¡ruùÜTe¡NÚOk
) {

419 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

420 
kE¼ÜMes§ge1
);

421 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

422 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

424 
Stus
 
th©
(
šv®id_¬g_¡©us
);

426 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

429 
TEST
(
StusTe¡
, 
CÚ¡ruùÜW™hE¼ÜS·ûOk
) {

430 
Stus
 
th©
(
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
(),

431 
”rÜ
::
GoogËE¼Ü
::
OK
, "This message is‚ot copied");

432 
EXPECT_TRUE
(
th©
.
”rÜ_mes§ge
().
em±y
());

433 
EXPECT_THAT
(
th©
, 
IsOk
());

436 
TEST
(
StusTe¡
, 
CÚ¡ruùÜW™hE¼ÜS·ûNÙOk
) {

437 
Stus
 
th©
(
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
(),

438 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "This message is copied");

439 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

	@util/status_test.cc

19 
	~"asylo/ut/¡©us.h
"

21 
	~<¡ršg
>

23 
	~<gmock/gmock.h
>

24 
	~<g‹¡/g‹¡.h
>

25 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

26 
	~"asylo/ut/posix_”rÜ_¥aû.h
"

27 
	~"šşude/g½ıp/suµÜt/¡©us.h
"

29 
Çme¥aû
 
	gasylo
 {

30 
	gÇme¥aû
 {

32 
	gusšg
 ::
‹¡šg
::
NÙ
;

34 
cÚ¡ex´
 
	gkE¼ÜMes§ge1
[] = "Bad foo‡rgument";

35 
cÚ¡ex´
 
	gkE¼ÜMes§ge2
[] = "Internal foobarƒrror";

37 
cÚ¡ex´
 
	gkBadE¼ÜS·û
[] = "Foo barƒrror space";

39 
TEST
(
StusTe¡
, 
OkSucûss
è{ 
EXPECT_TRUE
(::
asylo
::
Stus
::
OkStus
().
ok
()); }

41 
TEST
(
StusTe¡
, 
OkFau»
) {

42 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

43 
EXPECT_FALSE
(
¡©us
.
ok
());

46 
TEST
(
StusTe¡
, 
G‘E¼ÜCodeOkStus
) {

47 
EXPECT_EQ
(::
asylo
::
Stus
::
OkStus
().
”rÜ_code
(), 
”rÜ
::
GoogËE¼Ü
::
OK
);

50 
TEST
(
StusTe¡
, 
G‘E¼ÜCodeNÚOkStus
) {

51 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

52 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

55 
TEST
(
StusTe¡
, 
G‘E¼ÜMes§geOkStus
) {

56 
EXPECT_TRUE
(
Stus
::
OkStus
().
”rÜ_mes§ge
().
em±y
());

59 
TEST
(
StusTe¡
, 
G‘E¼ÜMes§geNÚOkStus
) {

60 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

61 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
kE¼ÜMes§ge1
);

64 
TEST
(
StusTe¡
, 
G‘E¼ÜS·ûOkStus
) {

65 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
”rÜ_¥aû
 = 
Stus
::
OkStus
().error_space();

66 
EXPECT_EQ
(
”rÜ_¥aû
->
S·ûName
(), 
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

69 
TEST
(
StusTe¡
, 
G‘E¼ÜS·ûNÚOkStus
) {

70 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

71 cÚ¡ 
	g”rÜ
::
E¼ÜS·û
 *
”rÜ_¥aû
 = 
¡©us
.error_space();

72 
EXPECT_EQ
(
”rÜ_¥aû
->
S·ûName
(), 
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

75 
TEST
(
StusTe¡
, 
ToSŒšgOkStus
) {

76 ::
asylo
::
Stus
 
¡©us
 = Stus::
OkStus
();

77 
	g¡d
::
¡ršg
 
”rÜ_code_Çme
 =

78 
¡©us
.
”rÜ_¥aû
()->
SŒšg
(¡©us.
”rÜ_code
());

82 
	g¡d
::
¡ršg
 
¡©us_»p
 = 
¡©us
.
ToSŒšg
();

83 
EXPECT_NE
(
¡©us_»p
.
fšd
(
”rÜ_code_Çme
), 
¡d
::
¡ršg
::
Åos
);

86 
TEST
(
StusTe¡
, 
ToSŒšgNÚOkStus
) {

87 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

88 
	g¡d
::
¡ršg
 
”rÜ_code_Çme
 =

89 
¡©us
.
”rÜ_¥aû
()->
SŒšg
(¡©us.
”rÜ_code
());

90 
	g¡d
::
¡ršg
 
”rÜ_¥aû_Çme
 = 
¡©us
.
”rÜ_¥aû
()->
S·ûName
();

94 
	g¡d
::
¡ršg
 
¡©us_»p
 = 
¡©us
.
ToSŒšg
();

95 
EXPECT_NE
(
¡©us_»p
.
fšd
(
”rÜ_¥aû_Çme
), 
¡d
::
¡ršg
::
Åos
);

96 
EXPECT_NE
(
¡©us_»p
.
fšd
(
”rÜ_code_Çme
), 
¡d
::
¡ršg
::
Åos
);

97 
EXPECT_NE
(
¡©us_»p
.
fšd
(
¡d
::
¡ršg
(
¡©us
.
”rÜ_mes§ge
())),

98 
¡d
::
¡ršg
::
Åos
);

101 
TEST
(
StusTe¡
, 
Equ®™y
) {

102 ::
asylo
::
Stus
 
ok_¡©us
 = Stus::
OkStus
();

103 
Stus
 
”rÜ_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

105 
EXPECT_TRUE
(
ok_¡©us
 == ok_status);

106 
EXPECT_TRUE
(
”rÜ_¡©us
 ==ƒrror_status);

107 
EXPECT_FALSE
(
ok_¡©us
 =ğ
”rÜ_¡©us
);

110 
TEST
(
StusTe¡
, 
IÃqu®™y
) {

111 
	gasylo
::
Stus
 
ok_¡©us
 = Stus::
OkStus
();

112 
	gasylo
::
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

113 
kE¼ÜMes§ge1
);

114 
	gasylo
::
Stus
 
š‹º®_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INTERNAL
, 
kE¼ÜMes§ge2
);

116 
EXPECT_FALSE
(
ok_¡©us
 != ok_status);

117 
EXPECT_FALSE
(
šv®id_¬g_¡©us
 != invalid_arg_status);

119 
EXPECT_TRUE
(
ok_¡©us
 !ğ
šv®id_¬g_¡©us
);

120 
EXPECT_TRUE
(
šv®id_¬g_¡©us
 !ğ
ok_¡©us
);

122 
EXPECT_TRUE
(
šv®id_¬g_¡©us
 !ğ
š‹º®_¡©us
);

123 
EXPECT_TRUE
(
š‹º®_¡©us
 !ğ
šv®id_¬g_¡©us
);

126 
TEST
(
StusTe¡
, 
ToCªÚiÿlOk
) {

127 
EXPECT_EQ
(
Stus
::
OkStus
().
ToCªÚiÿl
(), Status::OkStatus());

130 
TEST
(
StusTe¡
, 
ToCªÚiÿlNÚOk
) {

131 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

132 
EXPECT_EQ
(
¡©us
.
ToCªÚiÿl
(), status);

135 
TEST
(
StusTe¡
, 
ToCªÚiÿlNÚOkNÚCªÚiÿl
) {

136 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

137 
Stus
 
	gÿnÚiÿl
 = 
¡©us
.
ToCªÚiÿl
();

143 
EXPECT_EQ
(
ÿnÚiÿl
,

144 
Stus
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
¡©us
.
ToSŒšg
()));

147 
TEST
(
StusTe¡
, 
CªÚiÿlCodeOk
) {

148 
EXPECT_EQ
(
Stus
::
OkStus
().
CªÚiÿlCode
(), 
”rÜ
::
GoogËE¼Ü
::
OK
);

151 
TEST
(
StusTe¡
, 
CªÚiÿlCodeNÚOk
) {

152 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

153 
EXPECT_EQ
(
¡©us
.
CªÚiÿlCode
(), stus.
”rÜ_code
());

156 
TEST
(
StusTe¡
, 
CªÚiÿlCodeNÚOkNÚCªÚiÿl
) {

157 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

158 
EXPECT_EQ
(
¡©us
.
CªÚiÿlCode
(), 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

161 
TEST
(
StusTe¡
, 
SaveTo
) {

162 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

163 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

164 
	g¡©us
.
SaveTo
(&
¡©us_´Ùo
);

166 
EXPECT_EQ
(
¡©us_´Ùo
.
code
(), 
¡©us
.
”rÜ_code
());

167 
EXPECT_EQ
(
¡©us_´Ùo
.
”rÜ_mes§ge
(), 
¡©us
.error_message());

168 
EXPECT_EQ
(
¡©us_´Ùo
.
¥aû
(), 
¡©us
.
”rÜ_¥aû
()->
S·ûName
());

171 
TEST
(
StusTe¡
, 
Re¡ÜeFromOk
) {

172 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

173 
	g¡©us_´Ùo
.
£t_code
(
”rÜ
::
GoogËE¼Ü
::
OK
);

174 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

175 
	g¡©us_´Ùo
.
£t_¥aû
(
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

177 ::
asylo
::
Stus
 
¡©us
;

178 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

180 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
¡©us_´Ùo
.
code
());

182 
EXPECT_TRUE
(
¡©us
.
”rÜ_mes§ge
().
em±y
());

183 
EXPECT_EQ
(
¡©us
.
”rÜ_¥aû
()->
S·ûName
(), 
¡©us_´Ùo
.
¥aû
());

186 
TEST
(
StusTe¡
, 
Re¡ÜeFromNÚOk
) {

187 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

188 
	g¡©us_´Ùo
.
£t_code
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

189 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

190 
	g¡©us_´Ùo
.
£t_¥aû
(
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

192 ::
asylo
::
Stus
 
¡©us
;

193 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

195 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

196 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
¡©us_´Ùo
.error_message());

199 
TEST
(
StusTe¡
, 
Re¡ÜeFromNÚOkInv®idCªÚiÿlCode
) {

202 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

203 
	g¡©us_´Ùo
.
£t_code
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
);

204 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

205 
	g¡©us_´Ùo
.
£t_¥aû
(
”rÜ
::
kCªÚiÿlE¼ÜS·ûName
);

206 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(
”rÜ
::
GoogËE¼Ü
::
UNAUTHENTICATED
);

208 ::
asylo
::
Stus
 
¡©us
;

209 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

211 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
));

214 
TEST
(
StusTe¡
, 
Re¡ÜeFromUnknownE¼ÜS·û
) {

216 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

217 
	g¡©us_´Ùo
.
£t_code
(42);

218 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

219 
	g¡©us_´Ùo
.
£t_¥aû
(
kBadE¼ÜS·û
);

220 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

222 ::
asylo
::
Stus
 
¡©us
;

223 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

225 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

226 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
¡©us_´Ùo
.error_message());

229 
TEST
(
StusTe¡
, 
Re¡ÜeFromUnknownE¼ÜS·ûMissšgCªÚiÿlCode
) {

231 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

232 
	g¡©us_´Ùo
.
£t_code
(42);

233 
	g¡©us_´Ùo
.
£t_”rÜ_mes§ge
(
kE¼ÜMes§ge1
);

234 
	g¡©us_´Ùo
.
£t_¥aû
(
kBadE¼ÜS·û
);

236 ::
asylo
::
Stus
 
¡©us
;

237 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

239 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
));

240 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
¡©us_´Ùo
.error_message());

243 
TEST
(
StusTe¡
, 
Re¡ÜeFromUnknownE¼ÜS·ûInv®id
) {

246 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

247 
	g¡©us_´Ùo
.
£t_code
(0);

248 
	g¡©us_´Ùo
.
£t_¥aû
(
kBadE¼ÜS·û
);

249 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
);

251 
	gasylo
::
Stus
 
¡©us
;

252 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

254 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
));

258 
	g¡©us_´Ùo
.
CË¬
();

259 
	g¡©us_´Ùo
.
£t_code
(42);

260 
	g¡©us_´Ùo
.
£t_ÿnÚiÿl_code
(0);

262 
	g¡©us
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

264 
EXPECT_THAT
(
¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
RESTORE_ERROR
));

267 
TEST
(
StusTe¡
, 
SaveToRe¡ÜeFromEndToEnd
) {

268 ::
asylo
::
Stus
 
¡©us1
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

270 ::
asylo
::
StusPrÙo
 
¡©us_´Ùo
;

271 
	g¡©us1
.
SaveTo
(&
¡©us_´Ùo
);

273 ::
asylo
::
Stus
 
¡©us2
;

274 
	g¡©us2
.
Re¡ÜeFrom
(
¡©us_´Ùo
);

276 
EXPECT_EQ
(
¡©us1
, 
¡©us2
);

279 
TEST
(
StusTe¡
, 
CÚ¡ruùFromG½cStusOk
) {

281 ::
g½c
::
Stus
 
g½c_¡©us
;

282 ::
asylo
::
Stus
 
¡©us
(
g½c_¡©us
);

284 
EXPECT_THAT
(
¡©us
, 
IsOk
());

287 
TEST
(
StusTe¡
, 
CÚ¡ruùFromG½cStusNÚOk
) {

288 ::
g½c
::
Stus
 
g½c_¡©us
(::g½c::
StusCode
::
INVALID_ARGUMENT
,

289 
kE¼ÜMes§ge1
);

290 ::
asylo
::
Stus
 
¡©us
(
g½c_¡©us
);

292 
EXPECT_THAT
(
¡©us
, 
NÙ
(
IsOk
()));

295 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
g½c_¡©us
.error_code());

296 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
g½c_¡©us
.error_message());

299 
TEST
(
StusTe¡
, 
CÚv”tToG½cStusOk
) {

300 ::
asylo
::
Stus
 
¡©us
 = ::asylo::Stus::
OkStus
();

301 ::
g½c
::
Stus
 
g½c_¡©us
 = 
¡©us
.
ToOth”Stus
<::grpc::Status>();

303 
EXPECT_EQ
(
¡©us
.
ok
(), 
g½c_¡©us
.ok());

304 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
g½c_¡©us
.error_code());

305 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
g½c_¡©us
.error_message());

308 
TEST
(
StusTe¡
, 
CÚv”tToG½cStusNÚOk
) {

309 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, 
kE¼ÜMes§ge1
);

310 ::
g½c
::
Stus
 
g½c_¡©us
 = 
¡©us
.
ToOth”Stus
<::grpc::Status>();

312 
EXPECT_EQ
(
¡©us
.
ok
(), 
g½c_¡©us
.ok());

313 
EXPECT_EQ
(
¡©us
.
”rÜ_code
(), 
g½c_¡©us
.error_code());

314 
EXPECT_EQ
(
¡©us
.
”rÜ_mes§ge
(), 
g½c_¡©us
.error_message());

317 
TEST
(
StusTe¡
, 
CÚv”tToG½cStusNÚOkNÚCªÚiÿl
) {

318 ::
asylo
::
Stus
 
¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

319 ::
g½c
::
Stus
 
g½c_¡©us
 = 
¡©us
.
ToOth”Stus
<::grpc::Status>();

326 
EXPECT_EQ
(
g½c_¡©us
.
ok
(), 
¡©us
.ok());

327 
EXPECT_EQ
(
g½c_¡©us
.
”rÜ_code
(), ::
g½c
::
StusCode
::
INVALID_ARGUMENT
);

328 
EXPECT_EQ
(
g½c_¡©us
.
”rÜ_mes§ge
(), 
¡©us
.
ToSŒšg
());

331 
TEST
(
StusTe¡
, 
IsPos™iveTe¡
) {

332 
EXPECT_TRUE
(
Stus
::
OkStus
().
Is
(
”rÜ
::
GoogËE¼Ü
::
OK
));

334 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

335 
kE¼ÜMes§ge1
);

336 
EXPECT_TRUE
(
šv®id_¬g_¡©us
.
Is
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

338 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

339 
EXPECT_TRUE
(
ešv®_¡©us
.
Is
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
));

342 
TEST
(
StusTe¡
, 
IsNeg©iveTe¡
) {

344 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

345 
kE¼ÜMes§ge1
);

346 
EXPECT_FALSE
(
šv®id_¬g_¡©us
.
Is
(
”rÜ
::
GoogËE¼Ü
::
OK
));

349 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

350 
EXPECT_FALSE
(
ešv®_¡©us
.
Is
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

353 
TEST
(
StusTe¡
, 
StusIsM©ch”
) {

354 
EXPECT_THAT
(
Stus
::
OkStus
(), 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
));

356 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

357 
kE¼ÜMes§ge1
);

358 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

359 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

361 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

362 
EXPECT_THAT
(
ešv®_¡©us
, 
StusIs
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
));

365 
TEST
(
StusTe¡
, 
IsOkM©ch”
) {

366 
EXPECT_THAT
(
Stus
::
OkStus
(), 
IsOk
());

369 
Stus
 
ešv®_¡©us
(
”rÜ
::
PosixE¼Ü
::
P_EINVAL
, 
kE¼ÜMes§ge1
);

370 
EXPECT_THAT
(
ešv®_¡©us
, 
NÙ
(
IsOk
()));

373 
TEST
(
StusTe¡
, 
MoveCÚ¡ruùÜTe¡
) {

374 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

375 
kE¼ÜMes§ge1
);

376 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

377 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

379 
Stus
 
th©
(
¡d
::
move
(
šv®id_¬g_¡©us
));

381 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

382 
EXPECT_THAT
(
šv®id_¬g_¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
));

385 
TEST
(
StusTe¡
, 
MoveAssignm’tTe¡NÚOk
) {

386 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

387 
kE¼ÜMes§ge1
);

388 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

389 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

391 
Stus
 
th©
(
”rÜ
::
GoogËE¼Ü
::
CANCELLED
, 
kE¼ÜMes§ge2
);

392 
	gth©
 = 
¡d
::
move
(
šv®id_¬g_¡©us
);

394 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

395 
EXPECT_THAT
(
šv®id_¬g_¡©us
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
));

398 
TEST
(
StusTe¡
, 
MoveAssignm’tTe¡Ok
) {

399 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

400 
kE¼ÜMes§ge1
);

401 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

402 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

404 
Stus
 
	gok
 = Stus::
OkStus
();

405 
	gšv®id_¬g_¡©us
 = 
¡d
::
move
(
ok
);

407 
EXPECT_THAT
(
šv®id_¬g_¡©us
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
OK
, ""));

408 
EXPECT_THAT
(
ok
, 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
));

411 
TEST
(
StusTe¡
, 
CİyCÚ¡ruùÜTe¡Ok
) {

412 
Stus
 
th©
(Stus::
OkStus
());

414 
EXPECT_THAT
(
th©
, 
IsOk
());

415 
EXPECT_TRUE
(
th©
.
”rÜ_mes§ge
().
em±y
());

418 
TEST
(
StusTe¡
, 
CİyCÚ¡ruùÜTe¡NÚOk
) {

419 
Stus
 
šv®id_¬g_¡©us
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

420 
kE¼ÜMes§ge1
);

421 
EXPECT_THAT
(
šv®id_¬g_¡©us
,

422 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

424 
Stus
 
th©
(
šv®id_¬g_¡©us
);

426 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
));

429 
TEST
(
StusTe¡
, 
CÚ¡ruùÜW™hE¼ÜS·ûOk
) {

430 
Stus
 
th©
(
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
(),

431 
”rÜ
::
GoogËE¼Ü
::
OK
, "This message is‚ot copied");

432 
EXPECT_TRUE
(
th©
.
”rÜ_mes§ge
().
em±y
());

433 
EXPECT_THAT
(
th©
, 
IsOk
());

436 
TEST
(
StusTe¡
, 
CÚ¡ruùÜW™hE¼ÜS·ûNÙOk
) {

437 
Stus
 
th©
(
”rÜ
::
”rÜ_’um_Œa™s
<”rÜ::
GoogËE¼Ü
>::
g‘_”rÜ_¥aû
(),

438 
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
, "This message is copied");

439 
EXPECT_THAT
(
th©
, 
StusIs
(
”rÜ
::
GoogËE¼Ü
::
INVALID_ARGUMENT
,

	@util/statusor.h

19 #iâdeà
ASYLO_UTIL_STATUSOR_H_


20 
	#ASYLO_UTIL_STATUSOR_H_


	)

22 
	~<ty³_Œa™s
>

24 
	~"ab¦/m‘a/ty³_Œa™s.h
"

25 
	~"asylo/ut/loggšg.h
"

26 
	~"asylo/ut/¡©us.h
"

27 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

29 
Çme¥aû
 
	gasylo
 {

31 #ifdeà
NDEBUG


32 
cÚ¡ex´
 
	gkV®ueMoveCÚ¡ruùÜMsg
[] = "";

33 
cÚ¡ex´
 
	gkV®ueMoveAssignm’tMsg
[] = "";

34 
cÚ¡ex´
 
	gkV®ueOrD›MovedMsg
[] = "";

35 
cÚ¡ex´
 
	gkStusMoveCÚ¡ruùÜMsg
[] = "";

36 
cÚ¡ex´
 
	gkStusMoveAssignm’tMsg
[] = "";

38 
cÚ¡ex´
 
	gkV®ueMoveCÚ¡ruùÜMsg
[] =

40 
cÚ¡ex´
 
	gkV®ueMoveAssignm’tMsg
[] =

42 
cÚ¡ex´
 
	gkStusMoveCÚ¡ruùÜMsg
[] =

44 
cÚ¡ex´
 
	gkV®ueOrD›MovedMsg
[] = "Value moved by StatusOr::ValueOrDie";

45 
cÚ¡ex´
 
	gkStusMoveAssignm’tMsg
[] =

101 
	g‹m¶©e
 <
şass
 
	gT
>

102 şas 
	cStusOr
 {

103 
	g‹m¶©e
 <
ty³Çme
 
	gU
>

104 
ä›nd
 
şass
 
	gStusOr
;

109 
	g‹m¶©e
 <
şass
 
	gU
, 
ty³Çme
 
	gV
>

110 
	gis_im¶ic™ly_cÚ¡ruùibË


111 : 
ab¦
::
cÚjunùiÚ
<
¡d
::
is_cÚ¡ruùibË
<
U
, 
	gV
>,

112 
	g¡d
::
is_cÚv”tibË
<
V
, 
	gU
> > {};

114 
	gpublic
:

124 
ex¶ic™
 
StusOr
()

125 : 
v¬ŸÁ_
(
Stus
(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
, "Unknownƒrror")),

126 
has_v®ue_
(
çl£
) {}

128 ~
StusOr
() {

129 ià(
	ghas_v®ue_
) {

130 
	gv¬ŸÁ_
.
	gv®ue_
.~
T
();

132 
	gv¬ŸÁ_
.
	g¡©us_
.~
Stus
();

146 
StusOr
(cÚ¡ 
Stus
 &
¡©us
è: 
v¬ŸÁ_
(¡©us), 
has_v®ue_
(
çl£
) {

147 ià(
	g¡©us
.
ok
()) {

148 
LOG
(
FATAL
) << "Cannot instantiate StatusOr with Status::OkStatus()";

171 
	g‹m¶©e
 <
ty³Çme
 
	gU
,

172 
ty³Çme
 
	gE
 =y³Çm
¡d
::
’abË_if
<

173 
is_im¶ic™ly_cÚ¡ruùibË
<
T
, 
	gU
>::
v®ue
 &&

174 !
¡d
::
is_§me
<
ty³Çme
 std::
»move_»ã»nû
<

175 
ty³Çme
 
¡d
::
»move_cv
<
U
>::
ty³
>::type,

176 
	gStus
>::
v®ue
>::
ty³
>

177 
StusOr
(
U
 &&
v®ue
è: 
v¬ŸÁ_
(
¡d
::
fÜw¬d
<U>(v®ue)), 
has_v®ue_
(
Œue
) {}

189 
StusOr
(cÚ¡ StusO¸&
Ùh”
è: 
has_v®ue_
(other.has_value_) {

190 ià(
has_v®ue_
) {

191 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
Ùh”
.v¬ŸÁ_.
v®ue_
);

193 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
Ùh”
.v¬ŸÁ_.
¡©us_
);

203 
	g‹m¶©e
 <
ty³Çme
 
	gU
,

204 
ty³Çme
 
	gE
 =y³Çm
¡d
::
’abË_if
<

205 
is_im¶ic™ly_cÚ¡ruùibË
<
T
, cÚ¡ 
	gU
 &>::
v®ue
>::
ty³
>

206 
StusOr
(cÚ¡ StusOr<
U
> &
Ùh”
è: 
has_v®ue_
(other.has_value_) {

207 ià(
has_v®ue_
) {

208 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
Ùh”
.v¬ŸÁ_.
v®ue_
);

210 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
Ùh”
.v¬ŸÁ_.
¡©us_
);

217 
	gStusOr
 &
	gİ”©Ü
=(cÚ¡ 
StusOr
 &
Ùh”
) {

219 ià(
this
 =ğ&
Ùh”
) {

220  *
this
;

224 ià(
	gÙh”
.
	ghas_v®ue_
) {

225 
AssignV®ue
(
Ùh”
.
v¬ŸÁ_
.
v®ue_
);

227 
AssignStus
(
Ùh”
.
v¬ŸÁ_
.
¡©us_
);

229  *
	gthis
;

240 
	g‹m¶©e
 <
ty³Çme
 
	gU
,y³Çm
	gE
 =y³Çm
¡d
::
’abË_if
<

241 
is_im¶ic™ly_cÚ¡ruùibË
<
T
, 
	gU
 &&>::
v®ue
>::
ty³
>

242 
StusOr
(StusOr<
U
> &&
Ùh”
è: 
has_v®ue_
(other.has_value_) {

243 ià(
has_v®ue_
) {

244 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
¡d
::
move
(
Ùh”
.v¬ŸÁ_.
v®ue_
));

245 
	gÙh”
.
Ov”wr™eV®ueW™hStus
(

246 
Stus
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

248 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
¡d
::
move
(
Ùh”
.v¬ŸÁ_.
¡©us_
));

249 #iâdeà
NDEBUG


253 
	gÙh”
.
	gv¬ŸÁ_
.
	g¡©us_
 =

254 
Stus
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kStusMoveCÚ¡ruùÜMsg
);

266 
	gStusOr
 &
	gİ”©Ü
=(
StusOr
 &&
Ùh”
) {

268 ià(
this
 =ğ&
Ùh”
) {

269  *
this
;

273 ià(
	gÙh”
.
	ghas_v®ue_
) {

274 
AssignV®ue
(
¡d
::
move
(
Ùh”
.
v¬ŸÁ_
.
v®ue_
));

275 
	gÙh”
.
Ov”wr™eV®ueW™hStus
(

276 
Stus
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveAssignm’tMsg
));

278 
AssignStus
(
¡d
::
move
(
Ùh”
.
v¬ŸÁ_
.
¡©us_
));

279 #iâdeà
NDEBUG


283 
	gÙh”
.
	gv¬ŸÁ_
.
	g¡©us_
 =

284 
Stus
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kStusMoveAssignm’tMsg
);

288  *
	gthis
;

296 
boŞ
 
ok
(ècÚ¡ {  
	ghas_v®ue_
; }

302 
Stus
 
¡©us
(ècÚ¡ {  
ok
(è? 
	gStus
::
OkStus
(è: 
v¬ŸÁ_
.
¡©us_
; }

310 cÚ¡ 
	gT
 &
V®ueOrD›
() const & {

311 ià(!
ok
()) {

312 
LOG
(
FATAL
) << "Object does‚ot have‡ usable value";

314  
	gv¬ŸÁ_
.
	gv®ue_
;

323 
	gT
 &
V®ueOrD›
() & {

324 ià(!
ok
()) {

325 
LOG
(
FATAL
) << "Object does‚ot have‡ usable value";

327  
	gv¬ŸÁ_
.
	gv®ue_
;

338 
T
 
V®ueOrD›
() && {

339 ià(!
ok
()) {

340 
LOG
(
FATAL
) << "Object does‚ot have‡ usable value";

342 
T
 
tmp
(
¡d
::
move
(
v¬ŸÁ_
.
v®ue_
));

345 
Ov”wr™eV®ueW™hStus
(

346 
Stus
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueOrD›MovedMsg
));

347  
	g¡d
::
move
(
tmp
);

350 
	g´iv©e
:

352 
‹m¶©e
 <
şass
 
U
>

353 
AssignStus
(
U
 &&
¡©us
) {

354 ià(
ok
()) {

355 
Ov”wr™eV®ueW™hStus
(
¡d
::
fÜw¬d
<
U
>(
¡©us
));

358 
	gv¬ŸÁ_
.
	g¡©us_
 = 
¡d
::
fÜw¬d
<
U
>(
¡©us
);

365 
	g‹m¶©e
 <
şass
 
	gU
>

366 
Ov”wr™eV®ueW™hStus
(
U
 &&
¡©us
) {

367 #iâdeà
NDEBUG


368 ià(!
ok
()) {

369 
LOG
(
FATAL
) << "Object does‚ot have‡ valueo change from";

372 
	gv¬ŸÁ_
.
	gv®ue_
.~
T
();

373 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
¡d
::
fÜw¬d
<
U
>(
¡©us
));

374 
	ghas_v®ue_
 = 
çl£
;

380 
	g‹m¶©e
 <
şass
 
	gU
>

381 
AssignV®ue
(
U
 &&
v®ue
) {

382 ià(
ok
()) {

384 
	gv¬ŸÁ_
.
	gv®ue_
.~
T
();

386 
	gv¬ŸÁ_
.
	g¡©us_
.~
Stus
();

388 
Ãw
 (&
v¬ŸÁ_
è
v¬ŸÁ
(
¡d
::
fÜw¬d
<
U
>(
v®ue
));

389 
	ghas_v®ue_
 = 
Œue
;

392 
	uv¬ŸÁ
 {

394 
Stus
 
	g¡©us_
;

397 
T
 
	gv®ue_
;

399 
v¬ŸÁ
() {}

401 
v¬ŸÁ
(cÚ¡ 
Stus
 &
¡©us
è: 
¡©us_
(status) {}

403 
v¬ŸÁ
(
Stus
 &&
¡©us
è: 
¡©us_
(
¡d
::
move
(status)) {}

405 
‹m¶©e
 <
ty³Çme
 
U
,y³Çm
	gE
 =y³Çm
¡d
::
’abË_if
<

406 
is_im¶ic™ly_cÚ¡ruùibË
<
T
, 
	gU
>::
v®ue
>::
ty³
>

407 
v¬ŸÁ
(
U
 &&
v®ue
è: 
v®ue_
(
¡d
::
fÜw¬d
<U>(value)) {}

412 ~
v¬ŸÁ
() {}

416 
v¬ŸÁ
 
	gv¬ŸÁ_
;

423 
boŞ
 
	ghas_v®ue_
;

	@util/statusor_test.cc

19 
	~"asylo/ut/¡©usÜ.h
"

21 
	~<memÜy
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

35 
	g”rÜ
::
GoogËE¼Ü
 
kE¼ÜCode
 = 
”rÜ
::GoogËE¼Ü::
INVALID_ARGUMENT
;

36 
cÚ¡ex´
 
	gkE¼ÜMes§ge
[] = "Invalid‡rgument";

38 cÚ¡ 
	gkIÁEËm’t
 = 42;

39 
cÚ¡ex´
 
	gkSŒšgEËm’t
[] =

43 
	sFoo
 {

44 
	gb¬
;

45 
	g¡d
::
¡ršg
 
baz
;

47 
ex¶ic™
 
Foo
(
v®ue
è: 
b¬
(v®ue), 
baz
(
kSŒšgEËm’t
) {}

51 
	sCİyOÆyD©aTy³
 {

52 
ex¶ic™
 
CİyOÆyD©aTy³
(
x
è: 
d©a
(x) {}

54 
CİyOÆyD©aTy³
(cÚ¡ CİyOÆyD©aTy³ &
Ùh”
) = ;

55 
	gCİyOÆyD©aTy³
 &
	gİ”©Ü
=(cÚ¡ 
CİyOÆyD©aTy³
 &
Ùh”
) = ;

57 
	gd©a
;

60 
	sIm¶ic™lyCİyCÚv”tibË
 {

61 
Im¶ic™lyCİyCÚv”tibË
(cÚ¡ 
CİyOÆyD©aTy³
 &
co
è: 
cİy_Úly
(co) {}

63 
CİyOÆyD©aTy³
 
cİy_Úly
;

67 
	sMoveOÆyD©aTy³
 {

68 
ex¶ic™
 
MoveOÆyD©aTy³
(
x
è: 
d©a
(
Ãw
 (x)) {}

70 
MoveOÆyD©aTy³
(MoveOÆyD©aTy³ &&
Ùh”
è: 
d©a
(other.data) {

71 
Ùh”
.
d©a
 = 
nuÎ±r
;

74 
	gMoveOÆyD©aTy³
 &
	gİ”©Ü
=(
MoveOÆyD©aTy³
 &&
Ùh”
) {

75 ià(&
Ùh”
 =ğ
this
) {

76  *
this
;

78 ià(
	gd©a
) {

79 
d–‘e
 
	gd©a
;

81 
	gd©a
 = 
Ùh”
.
d©a
;

82 
	gÙh”
.
	gd©a
 = 
nuÎ±r
;

83  *
	gthis
;

86 
MoveOÆyD©aTy³
(cÚ¡ MoveOÆyD©aTy³ &
Ùh”
èğ
d–‘e
;

87 
	gMoveOÆyD©aTy³
 &
	gİ”©Ü
=(cÚ¡ 
MoveOÆyD©aTy³
 &
Ùh”
èğ
d–‘e
;

89 ~
MoveOÆyD©aTy³
() {

90 
d–‘e
 
	gd©a
;

91 
	gd©a
 = 
nuÎ±r
;

94 *
	gd©a
;

97 
	sIm¶ic™lyMoveCÚv”tibË
 {

98 
Im¶ic™lyMoveCÚv”tibË
(
MoveOÆyD©aTy³
 &&
mo
è: 
move_Úly
(
¡d
::
move
(mo)) {}

100 
MoveOÆyD©aTy³
 
move_Úly
;

104 
	sH—pAÎoÿ‹dObjeù
 {

105 *
	gv®ue
;

107 
H—pAÎoÿ‹dObjeù
() {

108 
	gv®ue
 = 
Ãw
 ;

109 *
	gv®ue
 = 
kIÁEËm’t
;

112 
H—pAÎoÿ‹dObjeù
(cÚ¡ H—pAÎoÿ‹dObjeù &
Ùh”
) {

113 
	gv®ue
 = 
Ãw
 ;

114 *
	gv®ue
 = *
Ùh”
.
v®ue
;

117 
H—pAÎoÿ‹dObjeù
(H—pAÎoÿ‹dObjeù &&
Ùh”
) {

118 
	gv®ue
 = 
Ùh”
.
v®ue
;

119 
	gÙh”
.
	gv®ue
 = 
nuÎ±r
;

122 ~
H—pAÎoÿ‹dObjeù
(è{ 
d–‘e
 
	gv®ue
; }

126 
	sFooCtÜ
 {

127 
usšg
 
	gv®ue_ty³
 = 
Foo
;

129 
Foo
 
İ”©Ü
()(è{  Foo(
kIÁEËm’t
); }

133 
	sH—pAÎoÿ‹dObjeùCtÜ
 {

134 
usšg
 
	gv®ue_ty³
 = 
H—pAÎoÿ‹dObjeù
;

136 
H—pAÎoÿ‹dObjeù
 
İ”©Ü
()() {  HeapAllocatedObject(); }

140 
	sIÁCtÜ
 {

141 
usšg
 
	gv®ue_ty³
 = ;

143 
İ”©Ü
()(è{  
	gkIÁEËm’t
; }

147 
	sSŒšgCtÜ
 {

148 
usšg
 
	gv®ue_ty³
 = 
¡d
::
¡ršg
;

150 
	g¡d
::
¡ršg
 
İ”©Ü
()(è{  
¡d
::¡ršg(
kSŒšgEËm’t
); }

154 
	sSŒšgVeùÜCtÜ
 {

155 
usšg
 
	gv®ue_ty³
 = 
¡d
::
veùÜ
<¡d::
¡ršg
>;

157 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
İ”©Ü
()() {

158  {
kSŒšgEËm’t
, 
	gkE¼ÜMes§ge
};

162 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Foo
 &
lhs
, cÚ¡ 
	gFoo
 &
	grhs
) {

163  (
	glhs
.
	gb¬
 =ğ
rhs
.
b¬
è&& (
lhs
.
baz
 ==„hs.baz);

166 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
H—pAÎoÿ‹dObjeù
 &
lhs
,

167 cÚ¡ 
	gH—pAÎoÿ‹dObjeù
 &
	grhs
) {

168  *
	glhs
.
	gv®ue
 =ğ*
rhs
.
v®ue
;

173 
	g‹m¶©e
 <
şass
 
	gT
>

174 
	gStusOr
<
	gT
> &&
MoveStusOr
(
StusOr
<
T
> *
¡©usÜ
) {

175  
	g¡d
::
move
(*
¡©usÜ
);

179 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

180 şas 
	cStusOrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

182 ::
‹¡šg
::
	tTy³s
<
	tIÁCtÜ
, 
	tFooCtÜ
, 
	tSŒšgCtÜ
, 
	tSŒšgVeùÜCtÜ
,

183 
	tH—pAÎoÿ‹dObjeùCtÜ
>

184 
	tTe¡Ty³s
;

186 
TYPED_TEST_SUITE
(
StusOrTe¡
, 
Te¡Ty³s
);

190 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜDeçuÉ
) {

191 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
;

192 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

193 
EXPECT_EQ
(
¡©usÜ
.
¡©us
().
”rÜ_code
(),

194 
¡©ic_ÿ¡
<>(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
));

198 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜStus
) {

199 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(

200 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

202 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

203 
EXPECT_FALSE
(
¡©usÜ
.
¡©us
().
ok
());

204 
EXPECT_EQ
(
¡©usÜ
.
¡©us
(), 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

208 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜEËm’tCÚ¡Reã»nû
) {

209 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

210 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

212 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

213 
ASSERT_THAT
(
¡©usÜ
.
¡©us
(), 
IsOk
());

214 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue
);

219 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜEËm’tRV®ue
) {

220 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

221 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue_cİy
(
v®ue
);

222 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
¡d
::
move
(
v®ue
));

224 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

225 
ASSERT_THAT
(
¡©usÜ
.
¡©us
(), 
IsOk
());

228 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue_cİy
);

233 
TYPED_TEST
(
StusOrTe¡
, 
CİyCÚ¡ruùÜNÚOkStus
) {

234 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
 =

235 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

236 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡©usÜ1
);

238 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

239 
EXPECT_EQ
(
¡©usÜ1
.
¡©us
(), 
¡©usÜ2
.status());

244 
TYPED_TEST
(
StusOrTe¡
, 
CİyCÚ¡ruùÜOkStus
) {

245 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
((
Ty³P¬am
()()));

246 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡©usÜ1
);

248 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

249 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

250 
EXPECT_EQ
(
¡©usÜ1
.
V®ueOrD›
(), 
¡©usÜ2
.ValueOrDie());

255 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tNÚOkStus
) {

256 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(

257 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

258 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
((
Ty³P¬am
()()));

261 
	g¡©usÜ2
 = 
¡©usÜ1
;

262 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

263 
EXPECT_EQ
(
¡©usÜ1
.
¡©us
(), 
¡©usÜ2
.status());

268 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tOkStus
) {

269 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
((
Ty³P¬am
()()));

270 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(

271 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

274 
	g¡©usÜ2
 = 
¡©usÜ1
;

275 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

276 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

277 
EXPECT_EQ
(
¡©usÜ1
.
V®ueOrD›
(), 
¡©usÜ2
.ValueOrDie());

282 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tS–fNÚOkStus
) {

283 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

284 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
¡©us
);

285 
	g¡©usÜ
 = *&
¡©usÜ
;

287 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

288 
EXPECT_EQ
(
¡©usÜ
.
¡©us
(), status);

293 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tS–fOkStus
) {

294 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

295 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

296 
	g¡©usÜ
 = *&
¡©usÜ
;

298 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

299 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue
);

304 
TYPED_TEST
(
StusOrTe¡
, 
MoveCÚ¡ruùÜNÚOkStus
) {

305 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

306 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
¡©us
);

307 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡d
::
move
(
¡©usÜ1
));

310 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

311 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

312 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kStusMoveCÚ¡ruùÜMsg
));

316 
EXPECT_FALSE
(
¡©usÜ2
.
ok
());

317 
EXPECT_EQ
(
¡©usÜ2
.
¡©us
(), status);

322 
TYPED_TEST
(
StusOrTe¡
, 
MoveCÚ¡ruùÜOkStus
) {

323 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

324 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
v®ue
);

325 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡d
::
move
(
¡©usÜ1
));

328 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

329 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

330 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

334 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

335 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
(), 
v®ue
);

340 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tO³¿tÜNÚOkStus
) {

341 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

342 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
¡©us
);

343 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
((
Ty³P¬am
()()));

346 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ1
);

349 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

350 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

351 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kStusMoveAssignm’tMsg
));

355 
EXPECT_FALSE
(
¡©usÜ2
.
ok
());

356 
EXPECT_EQ
(
¡©usÜ2
.
¡©us
(), status);

361 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tO³¿tÜOkStus
) {

362 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

363 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
v®ue
);

364 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(

365 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

368 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ1
);

371 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

372 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

373 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveAssignm’tMsg
));

377 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

378 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
(), 
v®ue
);

383 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tS–fNÚOkStus
) {

384 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

385 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
¡©us
);

387 
	g¡©usÜ
 = 
MoveStusOr
(&
¡©usÜ
);

389 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

390 
EXPECT_EQ
(
¡©usÜ
.
¡©us
(), status);

395 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tS–fOkStus
) {

396 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

397 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

399 
	g¡©usÜ
 = 
MoveStusOr
(&
¡©usÜ
);

401 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

402 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue
);

406 
TYPED_TEST
(
StusOrTe¡
, 
IsOkM©ch”
) {

407 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

408 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

410 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

412 
	g¡©usÜ
 = 
StusOr
<
ty³Çme
 
Ty³P¬am
::
v®ue_ty³
>(

413 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

414 
EXPECT_THAT
(
¡©usÜ
, 
NÙ
(
IsOk
()));

427 
TEST
(
StusOrTe¡
, 
In™Ÿliz©iÚMoveOÆyTy³
) {

428 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

429 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

430 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ
(¡d::
move
(
v®ue
));

432 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

433 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
g‘
(), 
¡r
);

437 
TEST
(
StusOrTe¡
, 
MoveCÚ¡ruùÜMoveOÆyTy³
) {

438 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

439 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

440 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ1
(¡d::
move
(
v®ue
));

441 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ2
(¡d::
move
(
¡©usÜ1
));

444 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

445 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

446 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

450 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

451 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
g‘
(), 
¡r
);

456 
TEST
(
StusOrTe¡
, 
MoveAssignm’tMoveOÆyTy³
) {

457 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

458 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

459 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ1
(¡d::
move
(
v®ue
));

460 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ2
(

461 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

464 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ1
);

467 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

468 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

469 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveAssignm’tMsg
));

473 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

474 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
g‘
(), 
¡r
);

478 
TEST
(
StusOrTe¡
, 
V®ueOrD›MovedV®ue
) {

479 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

480 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

481 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ
(¡d::
move
(
v®ue
));

483 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
moved_v®ue
 = std::
move
(
¡©usÜ
).
V®ueOrD›
();

484 
EXPECT_EQ
(
moved_v®ue
.
g‘
(), 
¡r
);

485 
EXPECT_EQ
(*
moved_v®ue
, 
kSŒšgEËm’t
);

488 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

489 
EXPECT_THAT
(
¡©usÜ
.
¡©us
(),

490 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueOrD›MovedMsg
));

495 
TEST
(
StusOrTe¡
, 
Tem¶©eV®ueCİyCÚ¡ruùiÚ
) {

496 
CİyOÆyD©aTy³
 
cİy_Úly
(
kIÁEËm’t
);

497 
	gStusOr
<
	gIm¶ic™lyCİyCÚv”tibË
> 
¡©usÜ
(
cİy_Úly
);

499 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

500 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
cİy_Úly
.
d©a
, 
kIÁEËm’t
);

505 
TEST
(
StusOrTe¡
, 
Tem¶©eV®ueMoveCÚ¡ruùiÚ
) {

506 
MoveOÆyD©aTy³
 
move_Úly
(
kIÁEËm’t
);

507 
	gStusOr
<
	gIm¶ic™lyMoveCÚv”tibË
> 
¡©usÜ
(
¡d
::
move
(
move_Úly
));

509 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

510 
EXPECT_EQ
(*
¡©usÜ
.
V®ueOrD›
().
move_Úly
.
d©a
, 
kIÁEËm’t
);

515 
TEST
(
StusOrTe¡
, 
Tem¶©eCİyAssign
) {

516 
CİyOÆyD©aTy³
 
cİy_Úly
(
kIÁEËm’t
);

517 
	gStusOr
<
	gCİyOÆyD©aTy³
> 
¡©usÜ
(
cİy_Úly
);

519 
	gStusOr
<
	gIm¶ic™lyCİyCÚv”tibË
> 
	g¡©usÜ2
 = 
¡©usÜ
;

521 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

522 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
d©a
, 
kIÁEËm’t
);

523 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

524 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
cİy_Úly
.
d©a
, 
kIÁEËm’t
);

529 
TEST
(
StusOrTe¡
, 
Tem¶©eMoveAssign
) {

530 
MoveOÆyD©aTy³
 
move_Úly
(
kIÁEËm’t
);

531 
	gStusOr
<
	gMoveOÆyD©aTy³
> 
¡©usÜ
(
¡d
::
move
(
move_Úly
));

533 
	gStusOr
<
	gIm¶ic™lyMoveCÚv”tibË
> 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ
);

535 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

536 
EXPECT_EQ
(*
¡©usÜ2
.
V®ueOrD›
().
move_Úly
.
d©a
, 
kIÁEËm’t
);

539 
EXPECT_THAT
(
¡©usÜ
, 
NÙ
(
IsOk
()));

541 
EXPECT_THAT
(
¡©usÜ
.
¡©us
(),

542 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

547 
TEST
(
StusOrTe¡
, 
Tem¶©eCİyCÚ¡ruù
) {

548 
CİyOÆyD©aTy³
 
cİy_Úly
(
kIÁEËm’t
);

549 
	gStusOr
<
	gCİyOÆyD©aTy³
> 
¡©usÜ
(
cİy_Úly
);

550 
	gStusOr
<
	gIm¶ic™lyCİyCÚv”tibË
> 
¡©usÜ2
(
¡©usÜ
);

552 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

553 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
d©a
, 
kIÁEËm’t
);

554 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

555 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
cİy_Úly
.
d©a
, 
kIÁEËm’t
);

560 
TEST
(
StusOrTe¡
, 
Tem¶©eMoveCÚ¡ruù
) {

561 
MoveOÆyD©aTy³
 
move_Úly
(
kIÁEËm’t
);

562 
	gStusOr
<
	gMoveOÆyD©aTy³
> 
¡©usÜ
(
¡d
::
move
(
move_Úly
));

563 
	gStusOr
<
	gIm¶ic™lyMoveCÚv”tibË
> 
¡©usÜ2
(
¡d
::
move
(
¡©usÜ
));

565 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

566 
EXPECT_EQ
(*
¡©usÜ2
.
V®ueOrD›
().
move_Úly
.
d©a
, 
kIÁEËm’t
);

569 
EXPECT_THAT
(
¡©usÜ
, 
NÙ
(
IsOk
()));

571 
EXPECT_THAT
(
¡©usÜ
.
¡©us
(),

572 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

	@util/statusor_test.cc

19 
	~"asylo/ut/¡©usÜ.h
"

21 
	~<memÜy
>

22 
	~<¡ršg
>

23 
	~<veùÜ
>

25 
	~<gmock/gmock.h
>

26 
	~<g‹¡/g‹¡.h
>

27 
	~"asylo/‹¡/ut/¡©us_m©ch”s.h
"

28 
	~"asylo/ut/¡©us_”rÜ_¥aû.h
"

30 
Çme¥aû
 
	gasylo
 {

31 
	gÇme¥aû
 {

33 
	gusšg
 ::
‹¡šg
::
NÙ
;

35 
	g”rÜ
::
GoogËE¼Ü
 
kE¼ÜCode
 = 
”rÜ
::GoogËE¼Ü::
INVALID_ARGUMENT
;

36 
cÚ¡ex´
 
	gkE¼ÜMes§ge
[] = "Invalid‡rgument";

38 cÚ¡ 
	gkIÁEËm’t
 = 42;

39 
cÚ¡ex´
 
	gkSŒšgEËm’t
[] =

43 
	sFoo
 {

44 
	gb¬
;

45 
	g¡d
::
¡ršg
 
baz
;

47 
ex¶ic™
 
Foo
(
v®ue
è: 
b¬
(v®ue), 
baz
(
kSŒšgEËm’t
) {}

51 
	sCİyOÆyD©aTy³
 {

52 
ex¶ic™
 
CİyOÆyD©aTy³
(
x
è: 
d©a
(x) {}

54 
CİyOÆyD©aTy³
(cÚ¡ CİyOÆyD©aTy³ &
Ùh”
) = ;

55 
	gCİyOÆyD©aTy³
 &
	gİ”©Ü
=(cÚ¡ 
CİyOÆyD©aTy³
 &
Ùh”
) = ;

57 
	gd©a
;

60 
	sIm¶ic™lyCİyCÚv”tibË
 {

61 
Im¶ic™lyCİyCÚv”tibË
(cÚ¡ 
CİyOÆyD©aTy³
 &
co
è: 
cİy_Úly
(co) {}

63 
CİyOÆyD©aTy³
 
cİy_Úly
;

67 
	sMoveOÆyD©aTy³
 {

68 
ex¶ic™
 
MoveOÆyD©aTy³
(
x
è: 
d©a
(
Ãw
 (x)) {}

70 
MoveOÆyD©aTy³
(MoveOÆyD©aTy³ &&
Ùh”
è: 
d©a
(other.data) {

71 
Ùh”
.
d©a
 = 
nuÎ±r
;

74 
	gMoveOÆyD©aTy³
 &
	gİ”©Ü
=(
MoveOÆyD©aTy³
 &&
Ùh”
) {

75 ià(&
Ùh”
 =ğ
this
) {

76  *
this
;

78 ià(
	gd©a
) {

79 
d–‘e
 
	gd©a
;

81 
	gd©a
 = 
Ùh”
.
d©a
;

82 
	gÙh”
.
	gd©a
 = 
nuÎ±r
;

83  *
	gthis
;

86 
MoveOÆyD©aTy³
(cÚ¡ MoveOÆyD©aTy³ &
Ùh”
èğ
d–‘e
;

87 
	gMoveOÆyD©aTy³
 &
	gİ”©Ü
=(cÚ¡ 
MoveOÆyD©aTy³
 &
Ùh”
èğ
d–‘e
;

89 ~
MoveOÆyD©aTy³
() {

90 
d–‘e
 
	gd©a
;

91 
	gd©a
 = 
nuÎ±r
;

94 *
	gd©a
;

97 
	sIm¶ic™lyMoveCÚv”tibË
 {

98 
Im¶ic™lyMoveCÚv”tibË
(
MoveOÆyD©aTy³
 &&
mo
è: 
move_Úly
(
¡d
::
move
(mo)) {}

100 
MoveOÆyD©aTy³
 
move_Úly
;

104 
	sH—pAÎoÿ‹dObjeù
 {

105 *
	gv®ue
;

107 
H—pAÎoÿ‹dObjeù
() {

108 
	gv®ue
 = 
Ãw
 ;

109 *
	gv®ue
 = 
kIÁEËm’t
;

112 
H—pAÎoÿ‹dObjeù
(cÚ¡ H—pAÎoÿ‹dObjeù &
Ùh”
) {

113 
	gv®ue
 = 
Ãw
 ;

114 *
	gv®ue
 = *
Ùh”
.
v®ue
;

117 
H—pAÎoÿ‹dObjeù
(H—pAÎoÿ‹dObjeù &&
Ùh”
) {

118 
	gv®ue
 = 
Ùh”
.
v®ue
;

119 
	gÙh”
.
	gv®ue
 = 
nuÎ±r
;

122 ~
H—pAÎoÿ‹dObjeù
(è{ 
d–‘e
 
	gv®ue
; }

126 
	sFooCtÜ
 {

127 
usšg
 
	gv®ue_ty³
 = 
Foo
;

129 
Foo
 
İ”©Ü
()(è{  Foo(
kIÁEËm’t
); }

133 
	sH—pAÎoÿ‹dObjeùCtÜ
 {

134 
usšg
 
	gv®ue_ty³
 = 
H—pAÎoÿ‹dObjeù
;

136 
H—pAÎoÿ‹dObjeù
 
İ”©Ü
()() {  HeapAllocatedObject(); }

140 
	sIÁCtÜ
 {

141 
usšg
 
	gv®ue_ty³
 = ;

143 
İ”©Ü
()(è{  
	gkIÁEËm’t
; }

147 
	sSŒšgCtÜ
 {

148 
usšg
 
	gv®ue_ty³
 = 
¡d
::
¡ršg
;

150 
	g¡d
::
¡ršg
 
İ”©Ü
()(è{  
¡d
::¡ršg(
kSŒšgEËm’t
); }

154 
	sSŒšgVeùÜCtÜ
 {

155 
usšg
 
	gv®ue_ty³
 = 
¡d
::
veùÜ
<¡d::
¡ršg
>;

157 
	g¡d
::
veùÜ
<
¡d
::
¡ršg
> 
İ”©Ü
()() {

158  {
kSŒšgEËm’t
, 
	gkE¼ÜMes§ge
};

162 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
Foo
 &
lhs
, cÚ¡ 
	gFoo
 &
	grhs
) {

163  (
	glhs
.
	gb¬
 =ğ
rhs
.
b¬
è&& (
lhs
.
baz
 ==„hs.baz);

166 
boŞ
 
	gİ”©Ü
==(cÚ¡ 
H—pAÎoÿ‹dObjeù
 &
lhs
,

167 cÚ¡ 
	gH—pAÎoÿ‹dObjeù
 &
	grhs
) {

168  *
	glhs
.
	gv®ue
 =ğ*
rhs
.
v®ue
;

173 
	g‹m¶©e
 <
şass
 
	gT
>

174 
	gStusOr
<
	gT
> &&
MoveStusOr
(
StusOr
<
T
> *
¡©usÜ
) {

175  
	g¡d
::
move
(*
¡©usÜ
);

179 
	g‹m¶©e
 <
ty³Çme
 
	gT
>

180 şas 
	cStusOrTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {};

182 ::
‹¡šg
::
	tTy³s
<
	tIÁCtÜ
, 
	tFooCtÜ
, 
	tSŒšgCtÜ
, 
	tSŒšgVeùÜCtÜ
,

183 
	tH—pAÎoÿ‹dObjeùCtÜ
>

184 
	tTe¡Ty³s
;

186 
TYPED_TEST_SUITE
(
StusOrTe¡
, 
Te¡Ty³s
);

190 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜDeçuÉ
) {

191 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
;

192 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

193 
EXPECT_EQ
(
¡©usÜ
.
¡©us
().
”rÜ_code
(),

194 
¡©ic_ÿ¡
<>(
”rÜ
::
GoogËE¼Ü
::
UNKNOWN
));

198 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜStus
) {

199 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(

200 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

202 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

203 
EXPECT_FALSE
(
¡©usÜ
.
¡©us
().
ok
());

204 
EXPECT_EQ
(
¡©usÜ
.
¡©us
(), 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

208 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜEËm’tCÚ¡Reã»nû
) {

209 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

210 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

212 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

213 
ASSERT_THAT
(
¡©usÜ
.
¡©us
(), 
IsOk
());

214 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue
);

219 
TYPED_TEST
(
StusOrTe¡
, 
CÚ¡ruùÜEËm’tRV®ue
) {

220 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

221 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue_cİy
(
v®ue
);

222 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
¡d
::
move
(
v®ue
));

224 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

225 
ASSERT_THAT
(
¡©usÜ
.
¡©us
(), 
IsOk
());

228 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue_cİy
);

233 
TYPED_TEST
(
StusOrTe¡
, 
CİyCÚ¡ruùÜNÚOkStus
) {

234 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
 =

235 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

236 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡©usÜ1
);

238 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

239 
EXPECT_EQ
(
¡©usÜ1
.
¡©us
(), 
¡©usÜ2
.status());

244 
TYPED_TEST
(
StusOrTe¡
, 
CİyCÚ¡ruùÜOkStus
) {

245 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
((
Ty³P¬am
()()));

246 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡©usÜ1
);

248 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

249 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

250 
EXPECT_EQ
(
¡©usÜ1
.
V®ueOrD›
(), 
¡©usÜ2
.ValueOrDie());

255 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tNÚOkStus
) {

256 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(

257 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

258 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
((
Ty³P¬am
()()));

261 
	g¡©usÜ2
 = 
¡©usÜ1
;

262 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

263 
EXPECT_EQ
(
¡©usÜ1
.
¡©us
(), 
¡©usÜ2
.status());

268 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tOkStus
) {

269 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
((
Ty³P¬am
()()));

270 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(

271 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

274 
	g¡©usÜ2
 = 
¡©usÜ1
;

275 
EXPECT_EQ
(
¡©usÜ1
.
ok
(), 
¡©usÜ2
.ok());

276 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

277 
EXPECT_EQ
(
¡©usÜ1
.
V®ueOrD›
(), 
¡©usÜ2
.ValueOrDie());

282 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tS–fNÚOkStus
) {

283 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

284 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
¡©us
);

285 
	g¡©usÜ
 = *&
¡©usÜ
;

287 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

288 
EXPECT_EQ
(
¡©usÜ
.
¡©us
(), status);

293 
TYPED_TEST
(
StusOrTe¡
, 
CİyAssignm’tS–fOkStus
) {

294 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

295 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

296 
	g¡©usÜ
 = *&
¡©usÜ
;

298 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

299 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue
);

304 
TYPED_TEST
(
StusOrTe¡
, 
MoveCÚ¡ruùÜNÚOkStus
) {

305 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

306 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
¡©us
);

307 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡d
::
move
(
¡©usÜ1
));

310 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

311 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

312 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kStusMoveCÚ¡ruùÜMsg
));

316 
EXPECT_FALSE
(
¡©usÜ2
.
ok
());

317 
EXPECT_EQ
(
¡©usÜ2
.
¡©us
(), status);

322 
TYPED_TEST
(
StusOrTe¡
, 
MoveCÚ¡ruùÜOkStus
) {

323 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

324 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
v®ue
);

325 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(
¡d
::
move
(
¡©usÜ1
));

328 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

329 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

330 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

334 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

335 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
(), 
v®ue
);

340 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tO³¿tÜNÚOkStus
) {

341 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

342 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
¡©us
);

343 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
((
Ty³P¬am
()()));

346 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ1
);

349 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

350 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

351 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kStusMoveAssignm’tMsg
));

355 
EXPECT_FALSE
(
¡©usÜ2
.
ok
());

356 
EXPECT_EQ
(
¡©usÜ2
.
¡©us
(), status);

361 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tO³¿tÜOkStus
) {

362 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

363 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ1
(
v®ue
);

364 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ2
(

365 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

368 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ1
);

371 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

372 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

373 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveAssignm’tMsg
));

377 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

378 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
(), 
v®ue
);

383 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tS–fNÚOkStus
) {

384 
Stus
 
¡©us
(
kE¼ÜCode
, 
kE¼ÜMes§ge
);

385 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
¡©us
);

387 
	g¡©usÜ
 = 
MoveStusOr
(&
¡©usÜ
);

389 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

390 
EXPECT_EQ
(
¡©usÜ
.
¡©us
(), status);

395 
TYPED_TEST
(
StusOrTe¡
, 
MoveAssignm’tS–fOkStus
) {

396 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

397 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

399 
	g¡©usÜ
 = 
MoveStusOr
(&
¡©usÜ
);

401 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

402 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
(), 
v®ue
);

406 
TYPED_TEST
(
StusOrTe¡
, 
IsOkM©ch”
) {

407 
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
 
v®ue
 = 
Ty³P¬am
()();

408 
	gStusOr
<
ty³Çme
 
	gTy³P¬am
::
v®ue_ty³
> 
¡©usÜ
(
v®ue
);

410 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

412 
	g¡©usÜ
 = 
StusOr
<
ty³Çme
 
Ty³P¬am
::
v®ue_ty³
>(

413 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

414 
EXPECT_THAT
(
¡©usÜ
, 
NÙ
(
IsOk
()));

427 
TEST
(
StusOrTe¡
, 
In™Ÿliz©iÚMoveOÆyTy³
) {

428 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

429 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

430 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ
(¡d::
move
(
v®ue
));

432 
ASSERT_THAT
(
¡©usÜ
, 
IsOk
());

433 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
g‘
(), 
¡r
);

437 
TEST
(
StusOrTe¡
, 
MoveCÚ¡ruùÜMoveOÆyTy³
) {

438 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

439 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

440 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ1
(¡d::
move
(
v®ue
));

441 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ2
(¡d::
move
(
¡©usÜ1
));

444 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

445 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

446 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

450 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

451 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
g‘
(), 
¡r
);

456 
TEST
(
StusOrTe¡
, 
MoveAssignm’tMoveOÆyTy³
) {

457 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

458 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

459 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ1
(¡d::
move
(
v®ue
));

460 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ2
(

461 
Stus
(
kE¼ÜCode
, 
kE¼ÜMes§ge
));

464 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ1
);

467 
EXPECT_FALSE
(
¡©usÜ1
.
ok
());

468 
EXPECT_THAT
(
¡©usÜ1
.
¡©us
(),

469 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveAssignm’tMsg
));

473 
ASSERT_THAT
(
¡©usÜ2
, 
IsOk
());

474 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
g‘
(), 
¡r
);

478 
TEST
(
StusOrTe¡
, 
V®ueOrD›MovedV®ue
) {

479 
	g¡d
::
¡ršg
 *
¡r
 = 
Ãw
 
¡d
::¡ršg(
kSŒšgEËm’t
);

480 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
v®ue
(
¡r
);

481 
	gStusOr
<
	g¡d
::
unique_±r
<
¡d
::
¡ršg
>> 
¡©usÜ
(¡d::
move
(
v®ue
));

483 
	g¡d
::
unique_±r
<
¡d
::
¡ršg
> 
moved_v®ue
 = std::
move
(
¡©usÜ
).
V®ueOrD›
();

484 
EXPECT_EQ
(
moved_v®ue
.
g‘
(), 
¡r
);

485 
EXPECT_EQ
(*
moved_v®ue
, 
kSŒšgEËm’t
);

488 
EXPECT_FALSE
(
¡©usÜ
.
ok
());

489 
EXPECT_THAT
(
¡©usÜ
.
¡©us
(),

490 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueOrD›MovedMsg
));

495 
TEST
(
StusOrTe¡
, 
Tem¶©eV®ueCİyCÚ¡ruùiÚ
) {

496 
CİyOÆyD©aTy³
 
cİy_Úly
(
kIÁEËm’t
);

497 
	gStusOr
<
	gIm¶ic™lyCİyCÚv”tibË
> 
¡©usÜ
(
cİy_Úly
);

499 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

500 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
cİy_Úly
.
d©a
, 
kIÁEËm’t
);

505 
TEST
(
StusOrTe¡
, 
Tem¶©eV®ueMoveCÚ¡ruùiÚ
) {

506 
MoveOÆyD©aTy³
 
move_Úly
(
kIÁEËm’t
);

507 
	gStusOr
<
	gIm¶ic™lyMoveCÚv”tibË
> 
¡©usÜ
(
¡d
::
move
(
move_Úly
));

509 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

510 
EXPECT_EQ
(*
¡©usÜ
.
V®ueOrD›
().
move_Úly
.
d©a
, 
kIÁEËm’t
);

515 
TEST
(
StusOrTe¡
, 
Tem¶©eCİyAssign
) {

516 
CİyOÆyD©aTy³
 
cİy_Úly
(
kIÁEËm’t
);

517 
	gStusOr
<
	gCİyOÆyD©aTy³
> 
¡©usÜ
(
cİy_Úly
);

519 
	gStusOr
<
	gIm¶ic™lyCİyCÚv”tibË
> 
	g¡©usÜ2
 = 
¡©usÜ
;

521 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

522 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
d©a
, 
kIÁEËm’t
);

523 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

524 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
cİy_Úly
.
d©a
, 
kIÁEËm’t
);

529 
TEST
(
StusOrTe¡
, 
Tem¶©eMoveAssign
) {

530 
MoveOÆyD©aTy³
 
move_Úly
(
kIÁEËm’t
);

531 
	gStusOr
<
	gMoveOÆyD©aTy³
> 
¡©usÜ
(
¡d
::
move
(
move_Úly
));

533 
	gStusOr
<
	gIm¶ic™lyMoveCÚv”tibË
> 
	g¡©usÜ2
 = 
¡d
::
move
(
¡©usÜ
);

535 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

536 
EXPECT_EQ
(*
¡©usÜ2
.
V®ueOrD›
().
move_Úly
.
d©a
, 
kIÁEËm’t
);

539 
EXPECT_THAT
(
¡©usÜ
, 
NÙ
(
IsOk
()));

541 
EXPECT_THAT
(
¡©usÜ
.
¡©us
(),

542 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

547 
TEST
(
StusOrTe¡
, 
Tem¶©eCİyCÚ¡ruù
) {

548 
CİyOÆyD©aTy³
 
cİy_Úly
(
kIÁEËm’t
);

549 
	gStusOr
<
	gCİyOÆyD©aTy³
> 
¡©usÜ
(
cİy_Úly
);

550 
	gStusOr
<
	gIm¶ic™lyCİyCÚv”tibË
> 
¡©usÜ2
(
¡©usÜ
);

552 
EXPECT_THAT
(
¡©usÜ
, 
IsOk
());

553 
EXPECT_EQ
(
¡©usÜ
.
V®ueOrD›
().
d©a
, 
kIÁEËm’t
);

554 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

555 
EXPECT_EQ
(
¡©usÜ2
.
V®ueOrD›
().
cİy_Úly
.
d©a
, 
kIÁEËm’t
);

560 
TEST
(
StusOrTe¡
, 
Tem¶©eMoveCÚ¡ruù
) {

561 
MoveOÆyD©aTy³
 
move_Úly
(
kIÁEËm’t
);

562 
	gStusOr
<
	gMoveOÆyD©aTy³
> 
¡©usÜ
(
¡d
::
move
(
move_Úly
));

563 
	gStusOr
<
	gIm¶ic™lyMoveCÚv”tibË
> 
¡©usÜ2
(
¡d
::
move
(
¡©usÜ
));

565 
EXPECT_THAT
(
¡©usÜ2
, 
IsOk
());

566 
EXPECT_EQ
(*
¡©usÜ2
.
V®ueOrD›
().
move_Úly
.
d©a
, 
kIÁEËm’t
);

569 
EXPECT_THAT
(
¡©usÜ
, 
NÙ
(
IsOk
()));

571 
EXPECT_THAT
(
¡©usÜ
.
¡©us
(),

572 
StusIs
(
”rÜ
::
StusE¼Ü
::
MOVED
, 
kV®ueMoveCÚ¡ruùÜMsg
));

	@util/std_thread.h

19 #iâdeà
ASYLO_UTIL_STD_THREAD_H_


20 
	#ASYLO_UTIL_STD_THREAD_H_


	)

22 
	~<c¡dšt
>

23 
	~<funùiÚ®
>

24 
	~<th»ad
>

26 
	~"asylo/ut/loggšg.h
"

28 
Çme¥aû
 
	gasylo
 {

37 şas 
	cTh»ad
 {

38 
	gpublic
:

39 
usšg
 
Id
 = 
ušt64_t
;

43 
	g‹m¶©e
 <
şass
 
	gFunùiÚ
, 
	gşass
... 
	gArgs
>

44 
ex¶ic™
 
Th»ad
(
FunùiÚ
 &&
f
, 
Args
 &&... 
¬gs
)

45 : 
Th»ad
Ğ
çl£
, 
f
, 
¬gs
...) {}

48 
Th»ad
(Th»ad &&
Ùh”
è
	gnÛxû±
 = ;

49 
	gTh»ad
 &
	gİ”©Ü
=(
Th»ad
 &&
Ùh”
) = ;

52 
Th»ad
(cÚ¡ Th»ad &
Ùh”
èğ
d–‘e
;

53 
	gTh»ad
 &
	gİ”©Ü
=(cÚ¡ 
Th»ad
 &
Ùh”
èğ
d–‘e
;

59 
	g‹m¶©e
 <
şass
 
	gFunùiÚ
, 
	gşass
... 
	gArgs
>

60 
S¹D‘ached
(
FunùiÚ
 &&
f
, 
Args
 &&... 
¬gs
) {

61 
Th»ad
Ğ
Œue
, 
f
, 
¬gs
...);

64 ~
Th»ad
(è{ 
CHECK
(!
th»ad_
.
jošabË
()); }

69 
Još
() {

70 
CHECK_NE
(
¡d
::
this_th»ad
::
g‘_id
(), 
th»ad_
.get_id());

71 
	gth»ad_
.
još
();

75 
Id
 
g‘_id
(ècÚ¡ {  
CÚv”tToId
(
th»ad_
.get_id()); }

79 
Id
 
this_th»ad_id
(è{  
CÚv”tToId
(
¡d
::
this_th»ad
::
g‘_id
()); }

81 
	g´iv©e
:

85 
‹m¶©e
 <
şass
 
FunùiÚ
, 
	gşass
... 
	gArgs
>

86 
Th»ad
(
boŞ
 
is_d‘ached
, 
FunùiÚ
 &&
f
, 
Args
 &&... 
¬gs
)

87 : 
th»ad_
(

88 
¡d
::
bšd
(¡d::
fÜw¬d
<
FunùiÚ
>(
f
), std::fÜw¬d<
Args
>(
¬gs
)...)) {

89 ià(
is_d‘ached
) {

90 
th»ad_
.
d‘ach
();

94 
Id
 
CÚv”tToId
(
¡d
::
th»ad
::
id
 id) {

95 
¡©ic_as£¹
((
Id
è=ğ(
id
),

97  *
	g»š‹½»t_ÿ¡
<cÚ¡ 
	gId
 *>(&
	gid
);

100 
	g¡d
::
th»ad
 
th»ad_
;

	@util/thread.h

19 #iâdeà
ASYLO_UTIL_THREAD_H_


20 
	#ASYLO_UTIL_THREAD_H_


	)

22 
	~<c¡dšt
>

23 
	~<funùiÚ®
>

25 
	~"asylo/ut/¡d_th»ad.h
"

	@util/thread_test.cc

19 
	~"asylo/ut/th»ad.h
"

21 
	~<c¡ddef
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

28 
	~"ab¦/synchrÚiz©iÚ/nÙifiÿtiÚ.h
"

29 
	~"ab¦/time/şock.h
"

30 
	~"ab¦/time/time.h
"

31 
	~"asylo/ut/mu‹x_gu¬ded.h
"

33 
	gusšg
 ::
‹¡šg
::
AÎOf
;

34 
	gusšg
 ::
‹¡šg
::
Eq
;

35 
	gusšg
 ::
‹¡šg
::
Ge
;

36 
	gusšg
 ::
‹¡šg
::
Lt
;

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 şas 
	cTh»adTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

42 
´Ùeùed
:

43 
cÚ¡ex´
 
size_t
 
kTh»ads
 = 4;

44 
cÚ¡ex´
 
size_t
 
	gkI‹¿tiÚs
 = 64;

47 
usšg
 
	gTh»adD—thTe¡
 = 
Th»adTe¡
;

49 
TEST_F
(
Th»adTe¡
, 
Sim¶eTh»ad
) {

50 
boŞ
 
	gexecu‹d
 = 
çl£
;

51 
Th»ad
 
th»ad
([&
execu‹d
] {ƒxecu‹d = 
Œue
; });

52 
	gth»ad
.
Još
();

53 
EXPECT_TRUE
(
execu‹d
);

56 
TEST_F
(
Th»adTe¡
, 
MovedTh»ad
) {

57 
boŞ
 
	gexecu‹d
 = 
çl£
;

58 
Th»ad
 
th»ad
([&
execu‹d
] {ƒxecu‹d = 
Œue
; });

59 autØ
	gmoved
 = 
¡d
::
move
(
th»ad
);

60 
	gmoved
.
Još
();

61 
EXPECT_TRUE
(
execu‹d
);

64 
TEST_F
(
Th»adTe¡
, 
D‘achedTh»ad
) {

65 
boŞ
 
	gexecu‹d
 = 
çl£
;

66 
	gTh»ad
::
S¹D‘ached
([&
execu‹d
] {

67 
ab¦
::
SË•FÜ
×b¦::
SecÚds
(3));

68 
execu‹d
 = 
Œue
;

70 
EXPECT_FALSE
(
execu‹d
);

71 
	gab¦
::
SË•FÜ
(
ab¦
::
SecÚds
(6));

72 
EXPECT_TRUE
(
execu‹d
);

75 
TEST_F
(
Th»adTe¡
, 
MuÉËTh»ads
) {

76 
	gMu‹xGu¬ded
<
	gab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>> 
ids
(

77 (
ab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>()));

78 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

79 
size_t
 
	gt
 = 0; < 
	gkTh»ads
; ++t) {

80 
	gth»ads
.
em¶aû_back
(

81 [&
ids
] { ids.
Lock
()->
š£¹
(
Th»ad
::
this_th»ad_id
()); });

83 auto& 
	gth»ad
 : 
th»ads
) {

84 
th»ad
.
Još
();

86 
EXPECT_THAT
(
ids
.
R—d”Lock
()->
size
(), 
Eq
(
kTh»ads
));

89 
TEST_F
(
Th»adTe¡
, 
MuÉËTh»adsMuÉËTimes
) {

90 
	gMu‹xGu¬ded
<
	gab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>> 
ids
(

91 (
ab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>()));

92 
size_t
 
	gi
 = 0; i < 
	gkI‹¿tiÚs
; ++i) {

93 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

94 
size_t
 
	gt
 = 0; < 
	gkTh»ads
; ++t) {

95 
	gth»ads
.
em¶aû_back
(

96 [&
ids
] { ids.
Lock
()->
š£¹
(
Th»ad
::
this_th»ad_id
()); });

98 auto& 
	gth»ad
 : 
th»ads
) {

99 
th»ad
.
Još
();

103 
EXPECT_THAT
(
ids
.
R—d”Lock
()->
size
(),

104 
AÎOf
(
Ge
(
kTh»ads
), 
Lt
(kTh»ad * 
kI‹¿tiÚs
)));

107 
CStyËBody
(
boŞ
* 
execu‹d
è{ *
	gexecu‹d
 = 
Œue
; }

109 
TEST_F
(
Th»adTe¡
, 
CStyËTh»ad
) {

110 
boŞ
 
	gexecu‹d
 = 
çl£
;

111 
Th»ad
 
th»ad
(
CStyËBody
, &
execu‹d
);

112 
	gth»ad
.
Još
();

113 
EXPECT_TRUE
(
execu‹d
);

116 
CStyËD‘achedBody
(
boŞ
* 
execu‹d
) {

117 
	gab¦
::
SË•FÜ
(
ab¦
::
SecÚds
(3));

118 *
	gexecu‹d
 = 
Œue
;

121 
TEST_F
(
Th»adTe¡
, 
CStyËD‘achedTh»ad
) {

122 
boŞ
 
	gexecu‹d
 = 
çl£
;

123 
	gTh»ad
::
S¹D‘ached
(
CStyËD‘achedBody
, &
execu‹d
);

124 
EXPECT_FALSE
(
execu‹d
);

125 
	gab¦
::
SË•FÜ
(
ab¦
::
SecÚds
(6));

126 
EXPECT_TRUE
(
execu‹d
);

	@util/thread_test.cc

19 
	~"asylo/ut/th»ad.h
"

21 
	~<c¡ddef
>

22 
	~<veùÜ
>

24 
	~<gmock/gmock.h
>

25 
	~<g‹¡/g‹¡.h
>

26 
	~"ab¦/cÚš”/æ©_hash_£t.h
"

27 
	~"ab¦/synchrÚiz©iÚ/mu‹x.h
"

28 
	~"ab¦/synchrÚiz©iÚ/nÙifiÿtiÚ.h
"

29 
	~"ab¦/time/şock.h
"

30 
	~"ab¦/time/time.h
"

31 
	~"asylo/ut/mu‹x_gu¬ded.h
"

33 
	gusšg
 ::
‹¡šg
::
AÎOf
;

34 
	gusšg
 ::
‹¡šg
::
Eq
;

35 
	gusšg
 ::
‹¡šg
::
Ge
;

36 
	gusšg
 ::
‹¡šg
::
Lt
;

38 
Çme¥aû
 
	gasylo
 {

39 
	gÇme¥aû
 {

41 şas 
	cTh»adTe¡
 : 
public
 ::
‹¡šg
::
Te¡
 {

42 
´Ùeùed
:

43 
cÚ¡ex´
 
size_t
 
kTh»ads
 = 4;

44 
cÚ¡ex´
 
size_t
 
	gkI‹¿tiÚs
 = 64;

47 
usšg
 
	gTh»adD—thTe¡
 = 
Th»adTe¡
;

49 
TEST_F
(
Th»adTe¡
, 
Sim¶eTh»ad
) {

50 
boŞ
 
	gexecu‹d
 = 
çl£
;

51 
Th»ad
 
th»ad
([&
execu‹d
] {ƒxecu‹d = 
Œue
; });

52 
	gth»ad
.
Još
();

53 
EXPECT_TRUE
(
execu‹d
);

56 
TEST_F
(
Th»adTe¡
, 
MovedTh»ad
) {

57 
boŞ
 
	gexecu‹d
 = 
çl£
;

58 
Th»ad
 
th»ad
([&
execu‹d
] {ƒxecu‹d = 
Œue
; });

59 autØ
	gmoved
 = 
¡d
::
move
(
th»ad
);

60 
	gmoved
.
Još
();

61 
EXPECT_TRUE
(
execu‹d
);

64 
TEST_F
(
Th»adTe¡
, 
D‘achedTh»ad
) {

65 
boŞ
 
	gexecu‹d
 = 
çl£
;

66 
	gTh»ad
::
S¹D‘ached
([&
execu‹d
] {

67 
ab¦
::
SË•FÜ
×b¦::
SecÚds
(3));

68 
execu‹d
 = 
Œue
;

70 
EXPECT_FALSE
(
execu‹d
);

71 
	gab¦
::
SË•FÜ
(
ab¦
::
SecÚds
(6));

72 
EXPECT_TRUE
(
execu‹d
);

75 
TEST_F
(
Th»adTe¡
, 
MuÉËTh»ads
) {

76 
	gMu‹xGu¬ded
<
	gab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>> 
ids
(

77 (
ab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>()));

78 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

79 
size_t
 
	gt
 = 0; < 
	gkTh»ads
; ++t) {

80 
	gth»ads
.
em¶aû_back
(

81 [&
ids
] { ids.
Lock
()->
š£¹
(
Th»ad
::
this_th»ad_id
()); });

83 auto& 
	gth»ad
 : 
th»ads
) {

84 
th»ad
.
Još
();

86 
EXPECT_THAT
(
ids
.
R—d”Lock
()->
size
(), 
Eq
(
kTh»ads
));

89 
TEST_F
(
Th»adTe¡
, 
MuÉËTh»adsMuÉËTimes
) {

90 
	gMu‹xGu¬ded
<
	gab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>> 
ids
(

91 (
ab¦
::
æ©_hash_£t
<
Th»ad
::
Id
>()));

92 
size_t
 
	gi
 = 0; i < 
	gkI‹¿tiÚs
; ++i) {

93 
	g¡d
::
veùÜ
<
Th»ad
> 
th»ads
;

94 
size_t
 
	gt
 = 0; < 
	gkTh»ads
; ++t) {

95 
	gth»ads
.
em¶aû_back
(

96 [&
ids
] { ids.
Lock
()->
š£¹
(
Th»ad
::
this_th»ad_id
()); });

98 auto& 
	gth»ad
 : 
th»ads
) {

99 
th»ad
.
Još
();

103 
EXPECT_THAT
(
ids
.
R—d”Lock
()->
size
(),

104 
AÎOf
(
Ge
(
kTh»ads
), 
Lt
(kTh»ad * 
kI‹¿tiÚs
)));

107 
CStyËBody
(
boŞ
* 
execu‹d
è{ *
	gexecu‹d
 = 
Œue
; }

109 
TEST_F
(
Th»adTe¡
, 
CStyËTh»ad
) {

110 
boŞ
 
	gexecu‹d
 = 
çl£
;

111 
Th»ad
 
th»ad
(
CStyËBody
, &
execu‹d
);

112 
	gth»ad
.
Još
();

113 
EXPECT_TRUE
(
execu‹d
);

116 
CStyËD‘achedBody
(
boŞ
* 
execu‹d
) {

117 
	gab¦
::
SË•FÜ
(
ab¦
::
SecÚds
(3));

118 *
	gexecu‹d
 = 
Œue
;

121 
TEST_F
(
Th»adTe¡
, 
CStyËD‘achedTh»ad
) {

122 
boŞ
 
	gexecu‹d
 = 
çl£
;

123 
	gTh»ad
::
S¹D‘ached
(
CStyËD‘achedBody
, &
execu‹d
);

124 
EXPECT_FALSE
(
execu‹d
);

125 
	gab¦
::
SË•FÜ
(
ab¦
::
SecÚds
(6));

126 
EXPECT_TRUE
(
execu‹d
);

	@
1
.
0
1208
44431
../asylo/bazel/application_wrapper/application_wrapper.proto
../asylo/bazel/test_shim_enclave.proto
../asylo/crypto/algorithms.proto
../asylo/crypto/certificate.proto
../asylo/crypto/keys.proto
../asylo/daemon/identity/attestation_domain_service.proto
../asylo/enclave.proto
../asylo/examples/grpc_server/grpc_server_config.proto
../asylo/examples/grpc_server/translator_server.proto
../asylo/examples/hello_world/hello.proto
../asylo/examples/quickstart/demo.proto
../asylo/examples/quickstart/solution/demo.proto
../asylo/grpc/auth/core/handshake.proto
../asylo/grpc/util/enclave_server.proto
../asylo/identity/enclave_assertion_authority_config.proto
../asylo/identity/identity.proto
../asylo/identity/identity_acl.proto
../asylo/identity/null_identity/null_assertion.proto
../asylo/identity/sealed_secret.proto
../asylo/identity/sgx/attestation_key.proto
../asylo/identity/sgx/attributes.proto
../asylo/identity/sgx/code_identity.proto
../asylo/identity/sgx/local_assertion.proto
../asylo/identity/sgx/local_sealed_secret.proto
../asylo/identity/sgx/miscselect.proto
../asylo/identity/sgx/platform_provisioning.proto
../asylo/identity/sgx/remote_assertion.proto
../asylo/identity/sgx/sgx_local_assertion_authority_config.proto
../asylo/identity/sgx/tcb.proto
../asylo/identity/util/sha256_hash.proto
../asylo/platform/arch/fork.proto
../asylo/platform/arch/sgx/host_calls_generator/host_calls.proto
../asylo/platform/common/bridge_proto_types.proto
../asylo/platform/core/test/proto_test.proto
../asylo/platform/posix/fork_security_test.proto
../asylo/platform/posix/sockets/socket_test.proto
../asylo/platform/posix/syscalls_test.proto
../asylo/test/grpc/client_enclave.proto
../asylo/test/grpc/service.proto
../asylo/test/misc/block_enclave_entries_test.proto
../asylo/test/misc/enclave_entry_count_test.proto
../asylo/test/misc/signal_test.proto
../asylo/test/util/test_string.proto
../asylo/util/status.proto
bazel/application_wrapper/application_wrapper_driver.cc
bazel/application_wrapper/application_wrapper_driver.cc
bazel/application_wrapper/application_wrapper_driver_main.cc
bazel/application_wrapper/application_wrapper_driver_main.cc
bazel/application_wrapper/application_wrapper_driver_main.h
bazel/application_wrapper/application_wrapper_driver_main_test.cc
bazel/application_wrapper/application_wrapper_driver_main_test.cc
bazel/application_wrapper/application_wrapper_enclave.cc
bazel/application_wrapper/application_wrapper_enclave.cc
bazel/application_wrapper/application_wrapper_enclave_test.cc
bazel/application_wrapper/application_wrapper_enclave_test.cc
bazel/application_wrapper/argv.cc
bazel/application_wrapper/argv.cc
bazel/application_wrapper/argv.h
bazel/application_wrapper/argv_test.cc
bazel/application_wrapper/argv_test.cc
bazel/application_wrapper/default_config.cc
bazel/application_wrapper/default_config.cc
bazel/application_wrapper/test_application.cc
bazel/application_wrapper/test_application.cc
bazel/application_wrapper/test_config.cc
bazel/application_wrapper/test_config.cc
bazel/gtest_test.cc
bazel/gtest_test.cc
bazel/test_shim_enclave.cc
bazel/test_shim_enclave.cc
bazel/test_shim_loader.cc
bazel/test_shim_loader.cc
client.h
crypto/aead_cryptor.cc
crypto/aead_cryptor.cc
crypto/aead_cryptor.h
crypto/aead_cryptor_test.cc
crypto/aead_cryptor_test.cc
crypto/aead_key.cc
crypto/aead_key.cc
crypto/aead_key.h
crypto/aead_key_test.cc
crypto/aead_key_test.cc
crypto/aead_test_vector.cc
crypto/aead_test_vector.cc
crypto/aead_test_vector.h
crypto/aes_gcm_siv.cc
crypto/aes_gcm_siv.cc
crypto/aes_gcm_siv.h
crypto/aes_gcm_siv_test.cc
crypto/aes_gcm_siv_test.cc
crypto/asymmetric_encryption_key.h
crypto/certificate_util.cc
crypto/certificate_util.cc
crypto/certificate_util.h
crypto/certificate_util_test.cc
crypto/certificate_util_test.cc
crypto/ecdsa_p256_sha256_signing_key.cc
crypto/ecdsa_p256_sha256_signing_key.cc
crypto/ecdsa_p256_sha256_signing_key.h
crypto/ecdsa_p256_sha256_signing_key_test.cc
crypto/ecdsa_p256_sha256_signing_key_test.cc
crypto/hash_interface.h
crypto/nonce_generator.h
crypto/nonce_generator_interface.h
crypto/random_nonce_generator.cc
crypto/random_nonce_generator.cc
crypto/random_nonce_generator.h
crypto/random_nonce_generator_test.cc
crypto/random_nonce_generator_test.cc
crypto/rsa_oaep_encryption_key.cc
crypto/rsa_oaep_encryption_key.cc
crypto/rsa_oaep_encryption_key.h
crypto/rsa_oaep_encryption_key_test.cc
crypto/rsa_oaep_encryption_key_test.cc
crypto/sha256_hash.cc
crypto/sha256_hash.cc
crypto/sha256_hash.h
crypto/sha256_hash_test.cc
crypto/sha256_hash_test.cc
crypto/signing_key.h
crypto/util/bssl_util.cc
crypto/util/bssl_util.cc
crypto/util/bssl_util.h
crypto/util/byte_container_util.h
crypto/util/byte_container_util_internal.h
crypto/util/byte_container_util_test.cc
crypto/util/byte_container_util_test.cc
crypto/util/byte_container_view.h
crypto/util/byte_container_view_internal.h
crypto/util/byte_container_view_test.cc
crypto/util/byte_container_view_test.cc
crypto/util/bytes.h
crypto/util/bytes_test.cc
crypto/util/bytes_test.cc
crypto/util/trivial_object_util.h
crypto/util/trivial_object_util_test.cc
crypto/util/trivial_object_util_test.cc
daemon/identity/attestation_domain.cc
daemon/identity/attestation_domain.cc
daemon/identity/attestation_domain.h
daemon/identity/attestation_domain_client.cc
daemon/identity/attestation_domain_client.cc
daemon/identity/attestation_domain_client.h
daemon/identity/attestation_domain_client_test.cc
daemon/identity/attestation_domain_client_test.cc
daemon/identity/attestation_domain_service_impl.cc
daemon/identity/attestation_domain_service_impl.cc
daemon/identity/attestation_domain_service_impl.h
daemon/identity/attestation_domain_service_impl_test.cc
daemon/identity/attestation_domain_service_impl_test.cc
daemon/identity/attestation_domain_test.cc
daemon/identity/attestation_domain_test.cc
enclave.proto
enclave_manager.h
examples/grpc_server/grpc_server_driver.cc
examples/grpc_server/grpc_server_driver.cc
examples/grpc_server/grpc_server_enclave.cc
examples/grpc_server/grpc_server_enclave.cc
examples/grpc_server/grpc_server_test.cc
examples/grpc_server/grpc_server_test.cc
examples/grpc_server/translator_server_impl.cc
examples/grpc_server/translator_server_impl.cc
examples/grpc_server/translator_server_impl.h
examples/hello_world/enclave_config.cc
examples/hello_world/enclave_config.cc
examples/hello_world/hello_driver.cc
examples/hello_world/hello_driver.cc
examples/hello_world/hello_enclave.cc
examples/hello_world/hello_enclave.cc
examples/quickstart/demo_driver.cc
examples/quickstart/demo_driver.cc
examples/quickstart/demo_enclave.cc
examples/quickstart/demo_enclave.cc
examples/quickstart/solution/demo_driver.cc
examples/quickstart/solution/demo_driver.cc
examples/quickstart/solution/demo_enclave.cc
examples/quickstart/solution/demo_enclave.cc
examples/redis/redis_enclave_config.cc
examples/redis/redis_enclave_config.cc
grpc/auth/core/assertion_description.cc
grpc/auth/core/assertion_description.cc
grpc/auth/core/assertion_description.h
grpc/auth/core/assertion_description_test.cc
grpc/auth/core/assertion_description_test.cc
grpc/auth/core/client_ekep_handshaker.cc
grpc/auth/core/client_ekep_handshaker.cc
grpc/auth/core/client_ekep_handshaker.h
grpc/auth/core/ekep_crypto.cc
grpc/auth/core/ekep_crypto.cc
grpc/auth/core/ekep_crypto.h
grpc/auth/core/ekep_crypto_test.cc
grpc/auth/core/ekep_crypto_test.cc
grpc/auth/core/ekep_error_space.cc
grpc/auth/core/ekep_error_space.cc
grpc/auth/core/ekep_error_space.h
grpc/auth/core/ekep_handshaker.cc
grpc/auth/core/ekep_handshaker.cc
grpc/auth/core/ekep_handshaker.h
grpc/auth/core/ekep_handshaker_util.cc
grpc/auth/core/ekep_handshaker_util.cc
grpc/auth/core/ekep_handshaker_util.h
grpc/auth/core/ekep_handshaker_util_test.cc
grpc/auth/core/ekep_handshaker_util_test.cc
grpc/auth/core/enclave_credentials.cc
grpc/auth/core/enclave_credentials.cc
grpc/auth/core/enclave_credentials.h
grpc/auth/core/enclave_credentials_options.cc
grpc/auth/core/enclave_credentials_options.cc
grpc/auth/core/enclave_credentials_options.h
grpc/auth/core/enclave_grpc_security_constants.h
grpc/auth/core/enclave_security_connector.cc
grpc/auth/core/enclave_security_connector.cc
grpc/auth/core/enclave_security_connector.h
grpc/auth/core/enclave_transport_security.cc
grpc/auth/core/enclave_transport_security.cc
grpc/auth/core/enclave_transport_security.h
grpc/auth/core/server_ekep_handshaker.cc
grpc/auth/core/server_ekep_handshaker.cc
grpc/auth/core/server_ekep_handshaker.h
grpc/auth/core/transcript.cc
grpc/auth/core/transcript.cc
grpc/auth/core/transcript.h
grpc/auth/core/transcript_test.cc
grpc/auth/core/transcript_test.cc
grpc/auth/enclave_auth_context.cc
grpc/auth/enclave_auth_context.cc
grpc/auth/enclave_auth_context.h
grpc/auth/enclave_auth_context_test.cc
grpc/auth/enclave_auth_context_test.cc
grpc/auth/enclave_channel_credentials.cc
grpc/auth/enclave_channel_credentials.cc
grpc/auth/enclave_channel_credentials.h
grpc/auth/enclave_credentials_options.cc
grpc/auth/enclave_credentials_options.cc
grpc/auth/enclave_credentials_options.h
grpc/auth/enclave_credentials_options_test.cc
grpc/auth/enclave_credentials_options_test.cc
grpc/auth/enclave_server_credentials.cc
grpc/auth/enclave_server_credentials.cc
grpc/auth/enclave_server_credentials.h
grpc/auth/null_credentials_options.cc
grpc/auth/null_credentials_options.cc
grpc/auth/null_credentials_options.h
grpc/auth/peer_identity_util.cc
grpc/auth/peer_identity_util.cc
grpc/auth/peer_identity_util.h
grpc/auth/peer_identity_util_test.cc
grpc/auth/peer_identity_util_test.cc
grpc/auth/sgx_local_credentials_options.cc
grpc/auth/sgx_local_credentials_options.cc
grpc/auth/sgx_local_credentials_options.h
grpc/auth/test/h2_enclave_security_test.cc
grpc/auth/test/h2_enclave_security_test.cc
grpc/auth/test/mock_enclave_auth_context.h
grpc/auth/util/bridge_cpp_to_c.cc
grpc/auth/util/bridge_cpp_to_c.cc
grpc/auth/util/bridge_cpp_to_c.h
grpc/auth/util/bridge_cpp_to_c_test.cc
grpc/auth/util/bridge_cpp_to_c_test.cc
grpc/auth/util/multi_buffer_input_stream.cc
grpc/auth/util/multi_buffer_input_stream.cc
grpc/auth/util/multi_buffer_input_stream.h
grpc/auth/util/safe_string.cc
grpc/auth/util/safe_string.cc
grpc/auth/util/safe_string.h
grpc/auth/util/safe_string_test.cc
grpc/auth/util/safe_string_test.cc
grpc/util/enclave_server.h
grpc/util/grpc_server_launcher.cc
grpc/util/grpc_server_launcher.cc
grpc/util/grpc_server_launcher.h
grpc/util/grpc_server_launcher_test.cc
grpc/util/grpc_server_launcher_test.cc
identity/additional_authenticated_data_generator.cc
identity/additional_authenticated_data_generator.cc
identity/additional_authenticated_data_generator.h
identity/additional_authenticated_data_generator_test.cc
identity/additional_authenticated_data_generator_test.cc
identity/assertion_description_util.cc
identity/assertion_description_util.cc
identity/assertion_description_util.h
identity/assertion_description_util_test.cc
identity/assertion_description_util_test.cc
identity/delegating_identity_expectation_matcher.cc
identity/delegating_identity_expectation_matcher.cc
identity/delegating_identity_expectation_matcher.h
identity/descriptions.h
identity/enclave_assertion_authority.h
identity/enclave_assertion_generator.h
identity/enclave_assertion_verifier.h
identity/identity_acl_evaluator.cc
identity/identity_acl_evaluator.cc
identity/identity_acl_evaluator.h
identity/identity_expectation_matcher.h
identity/identity_expectation_matcher_test.cc
identity/identity_expectation_matcher_test.cc
identity/init.h
identity/init_internal.h
identity/init_test.cc
identity/init_test.cc
identity/named_identity_expectation_matcher.cc
identity/named_identity_expectation_matcher.cc
identity/named_identity_expectation_matcher.h
identity/null_identity/null_assertion_authority_test.cc
identity/null_identity/null_assertion_authority_test.cc
identity/null_identity/null_assertion_generator.cc
identity/null_identity/null_assertion_generator.cc
identity/null_identity/null_assertion_generator.h
identity/null_identity/null_assertion_verifier.cc
identity/null_identity/null_assertion_verifier.cc
identity/null_identity/null_assertion_verifier.h
identity/null_identity/null_identity_constants.cc
identity/null_identity/null_identity_constants.cc
identity/null_identity/null_identity_constants.h
identity/null_identity/null_identity_expectation_matcher.cc
identity/null_identity/null_identity_expectation_matcher.cc
identity/null_identity/null_identity_expectation_matcher.h
identity/null_identity/null_identity_expectation_matcher_test.cc
identity/null_identity/null_identity_expectation_matcher_test.cc
identity/null_identity/null_identity_util.h
identity/null_identity/null_identity_util_test.cc
identity/null_identity/null_identity_util_test.cc
identity/secret_sealer.cc
identity/secret_sealer.cc
identity/secret_sealer.h
identity/sgx/attributes_util.cc
identity/sgx/attributes_util.cc
identity/sgx/attributes_util.h
identity/sgx/attributes_util_test.cc
identity/sgx/attributes_util_test.cc
identity/sgx/code_identity_constants.cc
identity/sgx/code_identity_constants.cc
identity/sgx/code_identity_constants.h
identity/sgx/code_identity_test_util.cc
identity/sgx/code_identity_test_util.cc
identity/sgx/code_identity_test_util.h
identity/sgx/code_identity_util.cc
identity/sgx/code_identity_util.cc
identity/sgx/code_identity_util.h
identity/sgx/code_identity_util_test.cc
identity/sgx/code_identity_util_test.cc
identity/sgx/dcap_intel_architectural_enclave_interface.cc
identity/sgx/dcap_intel_architectural_enclave_interface.cc
identity/sgx/dcap_intel_architectural_enclave_interface.h
identity/sgx/fake_enclave.cc
identity/sgx/fake_enclave.cc
identity/sgx/fake_enclave.h
identity/sgx/fake_hardware_interface.cc
identity/sgx/fake_hardware_interface.cc
identity/sgx/fake_hardware_interface_test.cc
identity/sgx/fake_hardware_interface_test.cc
identity/sgx/fake_self_identity.cc
identity/sgx/fake_self_identity.cc
identity/sgx/hardware_interface.cc
identity/sgx/hardware_interface.cc
identity/sgx/hardware_interface.h
identity/sgx/identity_key_management_structs.h
identity/sgx/intel_architectural_enclave_interface.h
identity/sgx/intel_certs/intel_sgx_root_ca_cert.cc
identity/sgx/intel_certs/intel_sgx_root_ca_cert.cc
identity/sgx/intel_certs/intel_sgx_root_ca_cert.h
identity/sgx/local_secret_sealer_helpers.cc
identity/sgx/local_secret_sealer_helpers.cc
identity/sgx/local_secret_sealer_helpers.h
identity/sgx/pce_util.cc
identity/sgx/pce_util.cc
identity/sgx/pce_util.h
identity/sgx/pce_util_test.cc
identity/sgx/pce_util_test.cc
identity/sgx/platform_provisioning.cc
identity/sgx/platform_provisioning.cc
identity/sgx/platform_provisioning.h
identity/sgx/platform_provisioning_test.cc
identity/sgx/platform_provisioning_test.cc
identity/sgx/proto_format.cc
identity/sgx/proto_format.cc
identity/sgx/proto_format.h
identity/sgx/proto_format_test.cc
identity/sgx/proto_format_test.cc
identity/sgx/remote_assertion_util.cc
identity/sgx/remote_assertion_util.cc
identity/sgx/remote_assertion_util.h
identity/sgx/remote_assertion_util_test.cc
identity/sgx/remote_assertion_util_test.cc
identity/sgx/secs_attributes.cc
identity/sgx/secs_attributes.cc
identity/sgx/secs_attributes.h
identity/sgx/secs_attributes_test.cc
identity/sgx/secs_attributes_test.cc
identity/sgx/secs_miscselect.cc
identity/sgx/secs_miscselect.cc
identity/sgx/secs_miscselect.h
identity/sgx/secs_miscselect_test.cc
identity/sgx/secs_miscselect_test.cc
identity/sgx/self_identity.cc
identity/sgx/self_identity.cc
identity/sgx/self_identity.h
identity/sgx/self_identity_internal.h
identity/sgx/sgx_code_identity_expectation_matcher.cc
identity/sgx/sgx_code_identity_expectation_matcher.cc
identity/sgx/sgx_code_identity_expectation_matcher.h
identity/sgx/sgx_code_identity_expectation_matcher_test.cc
identity/sgx/sgx_code_identity_expectation_matcher_test.cc
identity/sgx/sgx_local_assertion_authority_test.cc
identity/sgx/sgx_local_assertion_authority_test.cc
identity/sgx/sgx_local_assertion_generator.cc
identity/sgx/sgx_local_assertion_generator.cc
identity/sgx/sgx_local_assertion_generator.h
identity/sgx/sgx_local_assertion_generator_test.cc
identity/sgx/sgx_local_assertion_generator_test.cc
identity/sgx/sgx_local_assertion_verifier.cc
identity/sgx/sgx_local_assertion_verifier.cc
identity/sgx/sgx_local_assertion_verifier.h
identity/sgx/sgx_local_assertion_verifier_test.cc
identity/sgx/sgx_local_assertion_verifier_test.cc
identity/sgx/sgx_local_secret_sealer.cc
identity/sgx/sgx_local_secret_sealer.cc
identity/sgx/sgx_local_secret_sealer.h
identity/sgx/sgx_local_secret_sealer_test.cc
identity/sgx/sgx_local_secret_sealer_test.cc
identity/sgx/tcb.cc
identity/sgx/tcb.cc
identity/sgx/tcb.h
identity/sgx/tcb_info_from_json.cc
identity/sgx/tcb_info_from_json.cc
identity/sgx/tcb_info_from_json.h
identity/sgx/tcb_info_from_json_test.cc
identity/sgx/tcb_info_from_json_test.cc
identity/sgx/tcb_test.cc
identity/sgx/tcb_test.cc
identity/sgx/verify_hardware_report_test.cc
identity/sgx/verify_hardware_report_test.cc
identity/test/mock_identity_expectation_matcher.h
identity/util/aligned_object_ptr.h
identity/util/aligned_object_ptr_test.cc
identity/util/aligned_object_ptr_test.cc
identity/util/sha256_hash_util.cc
identity/util/sha256_hash_util.cc
identity/util/sha256_hash_util.h
identity/util/sha256_hash_util_test.cc
identity/util/sha256_hash_util_test.cc
platform/arch/common/trusted/fork.cc
platform/arch/common/trusted/fork.cc
platform/arch/include/trusted/fork.h
platform/arch/include/trusted/hardware_random.h
platform/arch/include/trusted/host_calls.h
platform/arch/include/trusted/register_signal.h
platform/arch/include/trusted/time.h
platform/arch/sgx/trusted/ecalls.cc
platform/arch/sgx/trusted/ecalls.cc
platform/arch/sgx/trusted/enclave_syscalls.cc
platform/arch/sgx/trusted/enclave_syscalls.cc
platform/arch/sgx/trusted/exceptions.cc
platform/arch/sgx/trusted/exceptions.cc
platform/arch/sgx/trusted/fork.cc
platform/arch/sgx/trusted/fork.cc
platform/arch/sgx/trusted/hardware_random.cc
platform/arch/sgx/trusted/hardware_random.cc
platform/arch/sgx/trusted/host_calls.cc
platform/arch/sgx/trusted/host_calls.cc
platform/arch/sgx/trusted/register_signal.cc
platform/arch/sgx/trusted/register_signal.cc
platform/arch/sgx/untrusted/ocalls.cc
platform/arch/sgx/untrusted/ocalls.cc
platform/arch/sgx/untrusted/sgx_client.cc
platform/arch/sgx/untrusted/sgx_client.cc
platform/arch/sgx/untrusted/sgx_client.h
platform/arch/sgx_sim/trusted/hardware_random.cc
platform/arch/sgx_sim/trusted/hardware_random.cc
platform/arch/sgx_sim/trusted/register_signal.cc
platform/arch/sgx_sim/trusted/register_signal.cc
platform/common/bridge_functions.cc
platform/common/bridge_functions.cc
platform/common/bridge_functions.h
platform/common/bridge_functions_test.cc
platform/common/bridge_functions_test.cc
platform/common/bridge_proto_serializer.cc
platform/common/bridge_proto_serializer.cc
platform/common/bridge_proto_serializer.h
platform/common/bridge_types.h
platform/common/debug_strings.cc
platform/common/debug_strings.cc
platform/common/debug_strings.h
platform/common/debug_strings_test.cc
platform/common/debug_strings_test.cc
platform/common/futex.cc
platform/common/futex.cc
platform/common/futex.h
platform/common/hash_combine.h
platform/common/memory.h
platform/common/ring_buffer.h
platform/common/ring_buffer_test.cc
platform/common/ring_buffer_test.cc
platform/common/singleton.h
platform/common/singleton_test.cc
platform/common/singleton_test.cc
platform/common/spin_lock.h
platform/common/spin_lock_test.cc
platform/common/spin_lock_test.cc
platform/common/static_map.h
platform/common/static_map_internal.h
platform/common/static_map_test.cc
platform/common/static_map_test.cc
platform/common/test/bridge_types_test_data.cc
platform/common/test/bridge_types_test_data.cc
platform/common/test/bridge_types_test_data.h
platform/common/test/bridge_types_test_driver.cc
platform/common/test/bridge_types_test_driver.cc
platform/common/test/bridge_types_test_enclave.cc
platform/common/test/bridge_types_test_enclave.cc
platform/common/time_util.cc
platform/common/time_util.cc
platform/common/time_util.h
platform/common/time_util_test.cc
platform/common/time_util_test.cc
platform/core/atomic.h
platform/core/bridge_msghdr_wrapper.cc
platform/core/bridge_msghdr_wrapper.cc
platform/core/bridge_msghdr_wrapper.h
platform/core/enclave_client.h
platform/core/enclave_clock_test.cc
platform/core/enclave_clock_test.cc
platform/core/enclave_config_util.cc
platform/core/enclave_config_util.cc
platform/core/enclave_config_util.h
platform/core/enclave_manager.cc
platform/core/enclave_manager.cc
platform/core/enclave_manager.h
platform/core/entry_points.h
platform/core/fake_trusted_global_state.cc
platform/core/fake_trusted_global_state.cc
platform/core/shared_name.h
platform/core/shared_name_kind.h
platform/core/shared_resource_manager.cc
platform/core/shared_resource_manager.cc
platform/core/shared_resource_manager.h
platform/core/test/enclave_api_test_driver.cc
platform/core/test/enclave_api_test_driver.cc
platform/core/test/enclave_api_test_enclave.cc
platform/core/test/enclave_api_test_enclave.cc
platform/core/test/getenv_test_driver.cc
platform/core/test/getenv_test_driver.cc
platform/core/test/getenv_test_enclave.cc
platform/core/test/getenv_test_enclave.cc
platform/core/test/lock_test.cc
platform/core/test/lock_test.cc
platform/core/test/proto_test_driver.cc
platform/core/test/proto_test_driver.cc
platform/core/test/proto_test_enclave.cc
platform/core/test/proto_test_enclave.cc
platform/core/test/random_test.cc
platform/core/test/random_test.cc
platform/core/test/shared_resource_test.cc
platform/core/test/shared_resource_test.cc
platform/core/trusted_application.cc
platform/core/trusted_application.cc
platform/core/trusted_application.h
platform/core/trusted_global_state.cc
platform/core/trusted_global_state.cc
platform/core/trusted_global_state.h
platform/core/trusted_mutex.cc
platform/core/trusted_mutex.cc
platform/core/trusted_mutex.h
platform/core/trusted_spin_lock.cc
platform/core/trusted_spin_lock.cc
platform/core/trusted_spin_lock.h
platform/core/untrusted_cache_malloc.cc
platform/core/untrusted_cache_malloc.cc
platform/core/untrusted_cache_malloc.h
platform/core/untrusted_cache_malloc_test.cc
platform/core/untrusted_cache_malloc_test.cc
platform/core/untrusted_mutex.cc
platform/core/untrusted_mutex.cc
platform/core/untrusted_mutex.h
platform/crypto/gcmlib/gcm_cryptor.cc
platform/crypto/gcmlib/gcm_cryptor.cc
platform/crypto/gcmlib/gcm_cryptor.h
platform/crypto/gcmlib/gcm_cryptor_test.cc
platform/crypto/gcmlib/gcm_cryptor_test.cc
platform/host_call/exit_handler_constants.h
platform/host_call/test/enclave_test_selectors.h
platform/host_call/test/host_call_test.cc
platform/host_call/test/host_call_test.cc
platform/host_call/test/test_enclave.cc
platform/host_call/test/test_enclave.cc
platform/host_call/trusted/host_call_dispatcher.cc
platform/host_call/trusted/host_call_dispatcher.cc
platform/host_call/trusted/host_call_dispatcher.h
platform/host_call/trusted/host_calls.cc
platform/host_call/trusted/host_calls.cc
platform/host_call/trusted/host_calls.h
platform/host_call/untrusted/host_call_handlers.cc
platform/host_call/untrusted/host_call_handlers.cc
platform/host_call/untrusted/host_call_handlers.h
platform/host_call/untrusted/host_call_handlers_initializer.cc
platform/host_call/untrusted/host_call_handlers_initializer.cc
platform/host_call/untrusted/host_call_handlers_initializer.h
platform/host_call/untrusted/host_call_handlers_initializer_test.cc
platform/host_call/untrusted/host_call_handlers_initializer_test.cc
platform/host_call/untrusted/host_call_handlers_test.cc
platform/host_call/untrusted/host_call_handlers_test.cc
platform/posix/bswap_test.cc
platform/posix/bswap_test.cc
platform/posix/dirent.cc
platform/posix/dirent.cc
platform/posix/dlfcn.cc
platform/posix/dlfcn.cc
platform/posix/endian.cc
platform/posix/endian.cc
platform/posix/endian_test.cc
platform/posix/endian_test.cc
platform/posix/epoll.cc
platform/posix/epoll.cc
platform/posix/errno.cc
platform/posix/errno.cc
platform/posix/errno_test.cc
platform/posix/errno_test.cc
platform/posix/eventfd.cc
platform/posix/eventfd.cc
platform/posix/file.cc
platform/posix/file.cc
platform/posix/fnmatch.cc
platform/posix/fnmatch.cc
platform/posix/fork_security_test_driver.cc
platform/posix/fork_security_test_driver.cc
platform/posix/fork_security_test_enclave.cc
platform/posix/fork_security_test_enclave.cc
platform/posix/fork_test_driver.cc
platform/posix/fork_test_driver.cc
platform/posix/fork_test_enclave.cc
platform/posix/fork_test_enclave.cc
platform/posix/grp.cc
platform/posix/grp.cc
platform/posix/ifaddrs.cc
platform/posix/ifaddrs.cc
platform/posix/include/arpa/inet.h
platform/posix/include/arpa/nameser.h
platform/posix/include/byteswap.h
platform/posix/include/dlfcn.h
platform/posix/include/endian.h
platform/posix/include/errno.h
platform/posix/include/fcntl.h
platform/posix/include/ifaddrs.h
platform/posix/include/internal/sched.h
platform/posix/include/math.h
platform/posix/include/net/if.h
platform/posix/include/netdb.h
platform/posix/include/netinet/in.h
platform/posix/include/netinet/tcp.h
platform/posix/include/netinet/udp.h
platform/posix/include/poll.h
platform/posix/include/sched.h
platform/posix/include/semaphore.h
platform/posix/include/signal.h
platform/posix/include/sys/epoll.h
platform/posix/include/sys/eventfd.h
platform/posix/include/sys/inotify.h
platform/posix/include/sys/ioctl.h
platform/posix/include/sys/mman.h
platform/posix/include/sys/poll.h
platform/posix/include/sys/resource.h
platform/posix/include/sys/socket.h
platform/posix/include/sys/stat.h
platform/posix/include/sys/syslog.h
platform/posix/include/sys/termios.h
platform/posix/include/sys/ucontext.h
platform/posix/include/sys/uio.h
platform/posix/include/sys/un.h
platform/posix/include/sys/utsname.h
platform/posix/include/sys/wait.h
platform/posix/include/syslog.h
platform/posix/include/time.h
platform/posix/include/ucontext.h
platform/posix/include/utime.h
platform/posix/inotify.cc
platform/posix/inotify.cc
platform/posix/io/cwd_test.cc
platform/posix/io/cwd_test.cc
platform/posix/io/epoll_test.cc
platform/posix/io/epoll_test.cc
platform/posix/io/eventfd_test.cc
platform/posix/io/eventfd_test.cc
platform/posix/io/inotify_test.cc
platform/posix/io/inotify_test.cc
platform/posix/io/io_context_epoll.cc
platform/posix/io/io_context_epoll.cc
platform/posix/io/io_context_epoll.h
platform/posix/io/io_context_eventfd.cc
platform/posix/io/io_context_eventfd.cc
platform/posix/io/io_context_eventfd.h
platform/posix/io/io_context_inotify.cc
platform/posix/io/io_context_inotify.cc
platform/posix/io/io_context_inotify.h
platform/posix/io/io_manager.cc
platform/posix/io/io_manager.cc
platform/posix/io/io_manager.h
platform/posix/io/io_syscalls.cc
platform/posix/io/io_syscalls.cc
platform/posix/io/native_paths.cc
platform/posix/io/native_paths.cc
platform/posix/io/native_paths.h
platform/posix/io/path_normalization_test.cc
platform/posix/io/path_normalization_test.cc
platform/posix/io/pipe_test_driver.cc
platform/posix/io/pipe_test_driver.cc
platform/posix/io/pipe_test_enclave.cc
platform/posix/io/pipe_test_enclave.cc
platform/posix/io/random_devices.cc
platform/posix/io/random_devices.cc
platform/posix/io/random_devices.h
platform/posix/io/read_write_multithread_test.cc
platform/posix/io/read_write_multithread_test.cc
platform/posix/io/read_write_test.cc
platform/posix/io/read_write_test.cc
platform/posix/io/realpath_test.cc
platform/posix/io/realpath_test.cc
platform/posix/io/secure_paths.cc
platform/posix/io/secure_paths.cc
platform/posix/io/secure_paths.h
platform/posix/io/util.cc
platform/posix/io/util.cc
platform/posix/io/util.h
platform/posix/io/virtual_test.cc
platform/posix/io/virtual_test.cc
platform/posix/ioctl.cc
platform/posix/ioctl.cc
platform/posix/malloc_lock.cc
platform/posix/malloc_lock.cc
platform/posix/memory/heap_switch_test.cc
platform/posix/memory/heap_switch_test.cc
platform/posix/memory/memory.cc
platform/posix/memory/memory.cc
platform/posix/memory/memory.h
platform/posix/mman.cc
platform/posix/mman.cc
platform/posix/pipe_test.cc
platform/posix/pipe_test.cc
platform/posix/poll.cc
platform/posix/poll.cc
platform/posix/pthread.cc
platform/posix/pthread.cc
platform/posix/pthread_impl.h
platform/posix/pwd.cc
platform/posix/pwd.cc
platform/posix/resource.cc
platform/posix/resource.cc
platform/posix/sched.cc
platform/posix/sched.cc
platform/posix/select.cc
platform/posix/select.cc
platform/posix/select_test.cc
platform/posix/select_test.cc
platform/posix/signal.cc
platform/posix/signal.cc
platform/posix/signal/signal_manager.cc
platform/posix/signal/signal_manager.cc
platform/posix/signal/signal_manager.h
platform/posix/sockets/addrinfo_test_driver.cc
platform/posix/sockets/addrinfo_test_driver.cc
platform/posix/sockets/addrinfo_test_enclave.cc
platform/posix/sockets/addrinfo_test_enclave.cc
platform/posix/sockets/domain_socket_test_driver.cc
platform/posix/sockets/domain_socket_test_driver.cc
platform/posix/sockets/domain_socket_test_enclave.cc
platform/posix/sockets/domain_socket_test_enclave.cc
platform/posix/sockets/in.cc
platform/posix/sockets/in.cc
platform/posix/sockets/inet.cc
platform/posix/sockets/inet.cc
platform/posix/sockets/inet6_socket_test_driver.cc
platform/posix/sockets/inet6_socket_test_driver.cc
platform/posix/sockets/inet6_socket_test_enclave.cc
platform/posix/sockets/inet6_socket_test_enclave.cc
platform/posix/sockets/inet_aton_test.cc
platform/posix/sockets/inet_aton_test.cc
platform/posix/sockets/inet_pton_test.cc
platform/posix/sockets/inet_pton_test.cc
platform/posix/sockets/netdb.cc
platform/posix/sockets/netdb.cc
platform/posix/sockets/socket.cc
platform/posix/sockets/socket.cc
platform/posix/sockets/socket_client.cc
platform/posix/sockets/socket_client.cc
platform/posix/sockets/socket_client.h
platform/posix/sockets/socket_server.cc
platform/posix/sockets/socket_server.cc
platform/posix/sockets/socket_server.h
platform/posix/sockets/socket_test_transmit.cc
platform/posix/sockets/socket_test_transmit.cc
platform/posix/sockets/socket_test_transmit.h
platform/posix/sockets/socket_transmit.cc
platform/posix/sockets/socket_transmit.cc
platform/posix/sockets/socket_transmit.h
platform/posix/stat.cc
platform/posix/stat.cc
platform/posix/stdlib.cc
platform/posix/stdlib.cc
platform/posix/syscalls_test_driver.cc
platform/posix/syscalls_test_driver.cc
platform/posix/syscalls_test_enclave.cc
platform/posix/syscalls_test_enclave.cc
platform/posix/syslog.cc
platform/posix/syslog.cc
platform/posix/syslog_test.cc
platform/posix/syslog_test.cc
platform/posix/termios.cc
platform/posix/termios.cc
platform/posix/threading/thread_manager.cc
platform/posix/threading/thread_manager.cc
platform/posix/threading/thread_manager.h
platform/posix/time.cc
platform/posix/time.cc
platform/posix/times_test.cc
platform/posix/times_test.cc
platform/posix/uio.cc
platform/posix/uio.cc
platform/posix/unistd.cc
platform/posix/unistd.cc
platform/posix/utime.cc
platform/posix/utime.cc
platform/posix/utsname.cc
platform/posix/utsname.cc
platform/posix/wait.cc
platform/posix/wait.cc
platform/primitives/examples/hello_driver.cc
platform/primitives/examples/hello_driver.cc
platform/primitives/examples/hello_enclave.cc
platform/primitives/examples/hello_enclave.cc
platform/primitives/examples/hello_enclave.h
platform/primitives/examples/hello_test.cc
platform/primitives/examples/hello_test.cc
platform/primitives/extent.h
platform/primitives/extent_test.cc
platform/primitives/extent_test.cc
platform/primitives/parameter_stack.h
platform/primitives/parameter_stack_test.cc
platform/primitives/parameter_stack_test.cc
platform/primitives/primitive_status.h
platform/primitives/primitive_status_test.cc
platform/primitives/primitive_status_test.cc
platform/primitives/primitives.h
platform/primitives/sgx/sgx_error_space.cc
platform/primitives/sgx/sgx_error_space.cc
platform/primitives/sgx/sgx_error_space.h
platform/primitives/sgx/trusted_runtime.cc
platform/primitives/sgx/trusted_runtime.cc
platform/primitives/sgx/trusted_sgx.cc
platform/primitives/sgx/trusted_sgx.cc
platform/primitives/sgx/trusted_sgx.h
platform/primitives/sgx/untrusted_sgx.cc
platform/primitives/sgx/untrusted_sgx.cc
platform/primitives/sgx/untrusted_sgx.h
platform/primitives/sim/malloc_lock.cc
platform/primitives/sim/malloc_lock.cc
platform/primitives/sim/runtime_stubs.c
platform/primitives/sim/runtime_syscalls.c
platform/primitives/sim/shared_sim.h
platform/primitives/sim/trusted_runtime.cc
platform/primitives/sim/trusted_runtime.cc
platform/primitives/sim/trusted_sim.cc
platform/primitives/sim/trusted_sim.cc
platform/primitives/sim/untrusted_sim.cc
platform/primitives/sim/untrusted_sim.cc
platform/primitives/sim/untrusted_sim.h
platform/primitives/test/primitives_test.cc
platform/primitives/test/primitives_test.cc
platform/primitives/test/sgx_test_backend.cc
platform/primitives/test/sgx_test_backend.cc
platform/primitives/test/sgx_test_backend.h
platform/primitives/test/sim_test_backend.cc
platform/primitives/test/sim_test_backend.cc
platform/primitives/test/sim_test_backend.h
platform/primitives/test/test_backend.h
platform/primitives/test/test_enclave.cc
platform/primitives/test/test_enclave.cc
platform/primitives/test/test_selectors.h
platform/primitives/trusted_primitives.h
platform/primitives/trusted_runtime.h
platform/primitives/untrusted_primitives.cc
platform/primitives/untrusted_primitives.cc
platform/primitives/untrusted_primitives.h
platform/primitives/util/dispatch_table.cc
platform/primitives/util/dispatch_table.cc
platform/primitives/util/dispatch_table.h
platform/primitives/util/dispatch_table_test.cc
platform/primitives/util/dispatch_table_test.cc
platform/primitives/util/message.h
platform/primitives/util/message_test.cc
platform/primitives/util/message_test.cc
platform/primitives/util/primitive_locks.h
platform/primitives/util/status_conversions.cc
platform/primitives/util/status_conversions.cc
platform/primitives/util/status_conversions.h
platform/primitives/util/status_conversions_test.cc
platform/primitives/util/status_conversions_test.cc
platform/primitives/util/trusted_memory.h
platform/primitives/util/trusted_runtime_helper.cc
platform/primitives/util/trusted_runtime_helper.cc
platform/primitives/util/trusted_runtime_helper.h
platform/primitives/x86/spin_lock.h
platform/primitives/x86/spin_lock_test.cc
platform/primitives/x86/spin_lock_test.cc
platform/storage/secure/aead_handler.cc
platform/storage/secure/aead_handler.cc
platform/storage/secure/aead_handler.h
platform/storage/secure/authenticated_dictionary.h
platform/storage/secure/ctmmt_authenticated_dictionary.cc
platform/storage/secure/ctmmt_authenticated_dictionary.cc
platform/storage/secure/ctmmt_authenticated_dictionary.h
platform/storage/secure/enclave_storage_secure.cc
platform/storage/secure/enclave_storage_secure.cc
platform/storage/secure/enclave_storage_secure.h
platform/storage/secure/enclave_storage_secure_test.cc
platform/storage/secure/enclave_storage_secure_test.cc
platform/storage/utils/fd_closer.cc
platform/storage/utils/fd_closer.cc
platform/storage/utils/fd_closer.h
platform/storage/utils/fd_closer_test.cc
platform/storage/utils/fd_closer_test.cc
platform/storage/utils/offset_translator.cc
platform/storage/utils/offset_translator.cc
platform/storage/utils/offset_translator.h
platform/storage/utils/offset_translator_test.cc
platform/storage/utils/offset_translator_test.cc
platform/storage/utils/random_access_storage.h
platform/storage/utils/record_store.h
platform/storage/utils/record_store_test.cc
platform/storage/utils/record_store_test.cc
platform/storage/utils/test_utils.cc
platform/storage/utils/test_utils.cc
platform/storage/utils/test_utils.h
platform/storage/utils/untrusted_file.cc
platform/storage/utils/untrusted_file.cc
platform/storage/utils/untrusted_file.h
platform/storage/utils/untrusted_file_test.cc
platform/storage/utils/untrusted_file_test.cc
platform/system/cmath_test.cc
platform/system/cmath_test.cc
platform/system/include/arpa/nameser.h
platform/system/include/arpa/nameser_compat.h
platform/system/include/sys/sysmacros.h
platform/system_call/generate_sysno.cc
platform/system_call/generate_sysno.cc
platform/system_call/generate_tables.cc
platform/system_call/generate_tables.cc
platform/system_call/message.cc
platform/system_call/message.cc
platform/system_call/message.h
platform/system_call/message_test.cc
platform/system_call/message_test.cc
platform/system_call/metadata.cc
platform/system_call/metadata.cc
platform/system_call/metadata.h
platform/system_call/metadata_test.cc
platform/system_call/metadata_test.cc
platform/system_call/serialize.cc
platform/system_call/serialize.cc
platform/system_call/serialize.h
platform/system_call/serialize_test.cc
platform/system_call/serialize_test.cc
platform/system_call/system_call.cc
platform/system_call/system_call.cc
platform/system_call/system_call.h
platform/system_call/system_call_message_fuzzer.cc
platform/system_call/system_call_message_fuzzer.cc
platform/system_call/system_call_test.cc
platform/system_call/system_call_test.cc
platform/system_call/type_conversions/generated_types_functions_test.cc
platform/system_call/type_conversions/generated_types_functions_test.cc
platform/system_call/type_conversions/manual_types_functions.cc
platform/system_call/type_conversions/manual_types_functions.cc
platform/system_call/type_conversions/manual_types_functions.h
platform/system_call/type_conversions/manual_types_functions_test.cc
platform/system_call/type_conversions/manual_types_functions_test.cc
platform/system_call/type_conversions/types.h
platform/system_call/type_conversions/types_conversions_generator.cc
platform/system_call/type_conversions/types_conversions_generator.cc
platform/system_call/type_conversions/types_functions.h
platform/system_call/untrusted_invoke.cc
platform/system_call/untrusted_invoke.cc
platform/system_call/untrusted_invoke.h
test/grpc/channel_test.cc
test/grpc/channel_test.cc
test/grpc/client_enclave.cc
test/grpc/client_enclave.cc
test/grpc/client_enclave.h
test/grpc/enclave_communication_test.cc
test/grpc/enclave_communication_test.cc
test/grpc/enclave_insecure_server.cc
test/grpc/enclave_insecure_server.cc
test/grpc/enclave_insecure_server_test.cc
test/grpc/enclave_insecure_server_test.cc
test/grpc/enclave_secure_server.cc
test/grpc/enclave_secure_server.cc
test/grpc/enclave_secure_server_test.cc
test/grpc/enclave_secure_server_test.cc
test/grpc/messenger_client_impl.h
test/grpc/messenger_server_impl.h
test/grpc/server_enclave.cc
test/grpc/server_enclave.cc
test/loader/loader_test.cc
test/loader/loader_test.cc
test/misc/active_enclave_signal_test_driver.cc
test/misc/active_enclave_signal_test_driver.cc
test/misc/active_enclave_signal_test_enclave.cc
test/misc/active_enclave_signal_test_enclave.cc
test/misc/block_enclave_entries_test_driver.cc
test/misc/block_enclave_entries_test_driver.cc
test/misc/block_enclave_entries_test_enclave.cc
test/misc/block_enclave_entries_test_enclave.cc
test/misc/condvar_test.cc
test/misc/condvar_test.cc
test/misc/die.cc
test/misc/die.cc
test/misc/die_test.cc
test/misc/die_test.cc
test/misc/double_die.cc
test/misc/double_die.cc
test/misc/embedded_enclave_test_driver.cc
test/misc/embedded_enclave_test_driver.cc
test/misc/enclave_entry_count_test_driver.cc
test/misc/enclave_entry_count_test_driver.cc
test/misc/enclave_entry_count_test_enclave.cc
test/misc/enclave_entry_count_test_enclave.cc
test/misc/error_propagation_enclave.cc
test/misc/error_propagation_enclave.cc
test/misc/error_propagation_test.cc
test/misc/error_propagation_test.cc
test/misc/exception.cc
test/misc/exception.cc
test/misc/exception.h
test/misc/exception_app.cc
test/misc/exception_app.cc
test/misc/exception_enclave.cc
test/misc/exception_enclave.cc
test/misc/exception_test.cc
test/misc/exception_test.cc
test/misc/exhaust_sgx_tcs.cc
test/misc/exhaust_sgx_tcs.cc
test/misc/exhaust_sgx_tcs_test.cc
test/misc/exhaust_sgx_tcs_test.cc
test/misc/fail_finalize_enclave.cc
test/misc/fail_finalize_enclave.cc
test/misc/fail_finalize_enclave_test.cc
test/misc/fail_finalize_enclave_test.cc
test/misc/hello_world.cc
test/misc/hello_world.cc
test/misc/hello_world_test.cc
test/misc/hello_world_test.cc
test/misc/inactive_enclave_signal_test_driver.cc
test/misc/inactive_enclave_signal_test_driver.cc
test/misc/inactive_enclave_signal_test_enclave.cc
test/misc/inactive_enclave_signal_test_enclave.cc
test/misc/initfini.cc
test/misc/initfini.cc
test/misc/logging_test_driver.cc
test/misc/logging_test_driver.cc
test/misc/logging_test_enclave.cc
test/misc/logging_test_enclave.cc
test/misc/malloc_stress_test.cc
test/misc/malloc_stress_test.cc
test/misc/memory_layout_test.cc
test/misc/memory_layout_test.cc
test/misc/mutex_test.cc
test/misc/mutex_test.cc
test/misc/nanosleep_test.cc
test/misc/nanosleep_test.cc
test/misc/pthread_test.cc
test/misc/pthread_test.cc
test/misc/raise_signal_test.cc
test/misc/raise_signal_test.cc
test/misc/rdrand_test.cc
test/misc/rdrand_test.cc
test/misc/rwlock_test.cc
test/misc/rwlock_test.cc
test/misc/sem_test.cc
test/misc/sem_test.cc
test/misc/threaded_finalize.cc
test/misc/threaded_finalize.cc
test/misc/threaded_test.cc
test/misc/threaded_test.cc
test/util/do_nothing_enclave.cc
test/util/do_nothing_enclave.cc
test/util/enclave_assertion_authority_configs.cc
test/util/enclave_assertion_authority_configs.cc
test/util/enclave_assertion_authority_configs.h
test/util/enclave_test.cc
test/util/enclave_test.cc
test/util/enclave_test.h
test/util/enclave_test_application.cc
test/util/enclave_test_application.cc
test/util/enclave_test_application.h
test/util/enclave_test_launcher.cc
test/util/enclave_test_launcher.cc
test/util/enclave_test_launcher.h
test/util/exec_tester.cc
test/util/exec_tester.cc
test/util/exec_tester.h
test/util/exec_tester_test.cc
test/util/exec_tester_test.cc
test/util/exit_app.cc
test/util/exit_app.cc
test/util/fake_enclave_loader.cc
test/util/fake_enclave_loader.cc
test/util/fake_enclave_loader.h
test/util/finite_domain_fuzz.cc
test/util/finite_domain_fuzz.cc
test/util/finite_domain_fuzz.h
test/util/grpc_debug_config.cc
test/util/grpc_debug_config.cc
test/util/grpc_debug_config.h
test/util/mock_enclave_client.h
test/util/mock_enclave_loader.h
test/util/mock_test.cc
test/util/mock_test.cc
test/util/output_collector.cc
test/util/output_collector.cc
test/util/output_collector.h
test/util/proto_matchers.h
test/util/pthread_test_util.cc
test/util/pthread_test_util.cc
test/util/pthread_test_util.h
test/util/status_matchers.h
test/util/status_matchers_test.cc
test/util/status_matchers_test.cc
test/util/test_binary.cc
test/util/test_binary.cc
test/util/test_flags.cc
test/util/test_flags.cc
test/util/test_flags.h
test/util/test_main.cc
test/util/test_main.cc
third_party/intel/posix/sgx_defs.h
third_party/intel/posix/sgx_thread.h
trusted_application.h
util/asylo_macros.h
util/binary_search.h
util/binary_search_test.cc
util/binary_search_test.cc
util/cleansing_allocator.h
util/cleansing_allocator_test.cc
util/cleansing_allocator_test.cc
util/cleansing_types.h
util/cleanup.h
util/cleanup_test.cc
util/cleanup_test.cc
util/elf_reader.cc
util/elf_reader.cc
util/elf_reader.h
util/elf_reader_test.cc
util/elf_reader_test.cc
util/error_codes.h
util/error_space.cc
util/error_space.cc
util/error_space.h
util/error_space_test.cc
util/error_space_test.cc
util/fd_utils.cc
util/fd_utils.cc
util/fd_utils.h
util/fd_utils_test.cc
util/fd_utils_test.cc
util/file_mapping.cc
util/file_mapping.cc
util/file_mapping.h
util/file_mapping_test.cc
util/file_mapping_test.cc
util/logging.cc
util/logging.cc
util/logging.h
util/mutex_guarded.h
util/mutex_guarded_test.cc
util/mutex_guarded_test.cc
util/path.cc
util/path.cc
util/path.h
util/path_test.cc
util/path_test.cc
util/posix_error_space.cc
util/posix_error_space.cc
util/posix_error_space.h
util/posix_error_space_test.cc
util/posix_error_space_test.cc
util/proto_struct_util.cc
util/proto_struct_util.cc
util/proto_struct_util.h
util/proto_struct_util_test.cc
util/proto_struct_util_test.cc
util/status.cc
util/status.cc
util/status.h
util/status_error_space.cc
util/status_error_space.cc
util/status_error_space.h
util/status_internal.h
util/status_macros.h
util/status_macros_test.cc
util/status_macros_test.cc
util/status_test.cc
util/status_test.cc
util/statusor.h
util/statusor_test.cc
util/statusor_test.cc
util/std_thread.h
util/thread.h
util/thread_test.cc
util/thread_test.cc
